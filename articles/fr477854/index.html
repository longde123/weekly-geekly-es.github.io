<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôâ üë©‚Äçüíº üåµ Que se passe-t-il lors de la connexion √† l'int√©rieur et √† l'ext√©rieur d'un tunnel VPN üëÇüèº üë®üèæ üë®üèº‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Des lettres au support technique de Tucha, ces articles sont n√©s. Ainsi, r√©cemment, un client nous a contact√© pour nous demander de clarifier ce qui s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Que se passe-t-il lors de la connexion √† l'int√©rieur et √† l'ext√©rieur d'un tunnel VPN</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477854/"> Des lettres au support technique de Tucha, ces articles sont n√©s.  Ainsi, r√©cemment, un client nous a contact√© pour nous demander de clarifier ce qui se passe lors de la connexion √† l'int√©rieur d'un tunnel VPN entre le bureau de l'utilisateur et l'environnement dans le cloud, ainsi que lors de la connexion √† l'ext√©rieur du tunnel VPN.  Par cons√©quent, l'int√©gralit√© du texte ci-dessous est une vraie lettre que nous avons envoy√©e √† l'un des clients en r√©ponse √† sa question.  Bien s√ªr, nous avons chang√© les adresses IP afin de ne pas anonymiser le client.  Mais, oui, le support technique de Tucha est vraiment c√©l√®bre pour ses r√©ponses compl√®tes et ses lettres d'information.  :-) <br><br>  Bien s√ªr, nous comprenons que pour beaucoup, cet article ne sera pas une r√©v√©lation.  Mais, puisque les articles pour les administrateurs d√©butants apparaissent de temps en temps sur Habr, et aussi parce que cet article est apparu d'une vraie lettre √† un vrai client, nous partagerons toujours cette information ici.  Il y a une forte probabilit√© qu'il soit utile √† quelqu'un. <br>  Par cons√©quent, nous expliquons en d√©tail ce qui se passe entre le serveur dans le cloud et le bureau s'ils sont connect√©s par un r√©seau de site √† site.  Notez que dans ce cas, une partie des services n'est disponible qu'au bureau, et une partie - de n'importe o√π sur Internet. <br><br>  Nous expliquerons imm√©diatement que notre client souhaitait pouvoir venir au serveur <b>192.168.A.1</b> de n'importe o√π via RDP, se connecter √† <b>AAA2: 13389</b> et √† d'autres services - uniquement depuis le bureau <b>(192.168.B.0 / 24)</b> connect√© via VPN  En outre, le client a √©t√© initialement configur√© pour que la machine <b>192.168.B.2</b> du bureau soit √©galement accessible via RDP de n'importe o√π, se connectant √† <b>BBB1: 11111</b> .  Nous avons aid√© √† organiser les connexions IPSec entre le cloud et le bureau, et le sp√©cialiste informatique du client a commenc√© √† poser des questions sur ce qui se passerait dans tel ou tel cas.  Pour r√©pondre √† toutes ces questions, nous lui avons en fait √©crit tout ce que vous pouvez lire ci-dessous. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/yi/h8/nm/yih8nmxyw3h1kvhvrv8grwlqt14.jpeg"><br><p>  Examinons maintenant ces processus plus en d√©tail. </p><br><h3>  Premi√®re position </h3><br>  Quand quelque chose est envoy√© de <b>192.168.B.0 / 24</b> √† <b>192.168.A.0 / 24</b> ou de <b>192.168.A.0 / 24</b> √† <b>192.168.B.0 / 24</b> , il entre dans le VPN.  Autrement dit, ce paquet est en outre chiffr√© et transmis entre <b>BBB1</b> et <b>AAA1</b> , mais <b>192.168.A.1</b> voit exactement le paquet de <b>192.168.B.1</b> .  Ils peuvent communiquer entre eux via n'importe quel protocole.  Les r√©ponses de retour sont transmises de la m√™me mani√®re via VPN, ce qui signifie que le paquet de <b>192.168.A.1</b> pour <b>192.168.B.1</b> sera envoy√© en tant que datagramme ESP d' <b>AAA1</b> √† <b>BBB1</b> , que le routeur d√©ploiera de l'autre c√¥t√©, enl√®ve ce paquet et l'envoie √† <b>192.168.B.1 en</b> tant que paquet de <b>192.168.A.1</b> . <br><br>  Exemple concret: <br><br>  1) <b>192.168.B.1</b> acc√®de √† <b>192.168.A.1</b> , souhaite √©tablir une connexion TCP avec <b>192.168.A.1: 3389</b> ; <br><br>  2) <b>192.168.B.1</b> envoie une demande pour √©tablir une connexion √† partir de <b>192.168.B.1: 55555</b> (il s√©lectionne le port pour la r√©troaction, ci-apr√®s nous utiliserons le num√©ro 55555 comme exemple du num√©ro de port que le syst√®me s√©lectionne lors de la g√©n√©ration de TCP- connexions) √† <b>192.168.A.1: 3389</b> ; <br><br>  3) le syst√®me d'exploitation qui s'ex√©cute sur l'ordinateur avec l'adresse <b>192.168.B.1</b> d√©cide de transf√©rer ce paquet vers l'adresse de passerelle du routeur ( <b>192.168.B.254</b> dans notre cas), car il existe d'autres itin√©raires plus sp√©cifiques pour <b>192.168.A.1</b> , il ne fait donc pas passer le paquet le long de la route par d√©faut (0.0.0.0/0); <br><br>  4) pour cela, elle essaie de trouver l'adresse MAC pour l'adresse IP <b>192.168.B.254</b> dans la table de cache du protocole ARP.  S'il n'est pas trouv√©, il envoie √† partir de l'adresse <b>192.168.B.1 une</b> demande de diffusion qui-a au r√©seau <b>192.168.B.0 / 24</b> .  Lorsque <b>192.168.B.254 lui</b> renvoie son adresse MAC, le syst√®me lui envoie un paquet Ethernet et stocke ces informations dans sa table de cache; <br><br>  5) le routeur re√ßoit ce paquet et d√©cide o√π l'envoyer: il a pour politique de transmettre tous les paquets entre <b>192.168.B.0 / 24</b> et <b>192.168.A.0 / 24</b> sur une connexion VPN entre <b>BBB1</b> et <b>AAA1</b> ; <br><br>  6) le routeur g√©n√®re un datagramme ESP de <b>BBB1</b> √† <b>AAA1</b> ; <br><br>  7) le routeur d√©cide √† qui envoyer ce paquet, il l'envoie, disons, √† <b>BBB254</b> (passerelle du fournisseur d'acc√®s Internet), car il n'a pas de routes plus sp√©cifiques vers <b>AAA1</b> que 0.0.0.0/0; <br><br>  8) de la m√™me mani√®re que d√©j√† mentionn√©, il trouve l'adresse MAC pour <b>BBB254</b> et envoie le paquet √† la passerelle du fournisseur Internet; <br><br>  9) Les fournisseurs d'acc√®s Internet transmettent via leurs r√©seaux le datagramme ESP de <b>BBB1</b> √† <b>AAA1</b> ; <br><br>  10) le routeur virtuel sur <b>AAA1</b> re√ßoit ce datagramme, le d√©chiffre et re√ßoit un paquet de <b>192.168.B.1: 55555</b> pour <b>192.168.A.1: 3389</b> ; <br><br>  11) le routeur virtuel v√©rifie √† qui il doit √™tre envoy√©, trouve le r√©seau <b>192.168.A.0 / 24</b> dans la table de routage et l'envoie directement √† <b>192.168.A.1</b> , car il poss√®de une interface <b>192.168.A.254 / 24</b> ; <br><br>  12) pour cela, le routeur virtuel trouve l'adresse MAC pour <b>192.168.A.1</b> et lui transmet ce paquet via le r√©seau Ethernet virtuel; <br><br>  13) <b>192.168.A.1</b> re√ßoit ce paquet sur le port 3389, accepte d'√©tablir une connexion et forme un paquet en r√©ponse de <b>192.168.A.1: 3389</b> √† <b>192.168.B.1: 55555</b> ; <br><br>  14) son syst√®me envoie ce paquet √† l'adresse de passerelle du routeur virtuel ( <b>192.168.A.254</b> dans notre cas), car il n'a pas d'autres routes plus sp√©cifiques pour <b>192.168.B.1</b> , par cons√©quent, il doit transmettre le paquet le long de la route par d√©faut (0.0.0.0/0); <br><br>  15) de la m√™me mani√®re que dans les cas pr√©c√©dents, le syst√®me qui s'ex√©cute sur le serveur avec l'adresse <b>192.168.A.1</b> trouve l'adresse MAC <b>192.168.A.254</b> , car il est sur le m√™me r√©seau avec son interface <b>192.168.A.1 / 24</b> ; <br><br>  16) le routeur virtuel re√ßoit ce paquet et d√©cide o√π le transf√©rer: il a pour politique de transmettre tous les paquets entre <b>192.168.A.0 / 24</b> et <b>192.168.B.0 / 24</b> via une connexion VPN entre <b>AAA1</b> et <b>BBB1</b> ; <br><br>  17) le routeur virtuel g√©n√®re un datagramme ESP de <b>AAA1</b> √† <b>BBB1</b> ; <br><br>  18) le routeur virtuel d√©cide √† qui ce paquet doit √™tre envoy√©, l'envoie √† <b>AAA254</b> (la passerelle du fournisseur Internet, dans ce cas, c'est nous aussi), car il n'a pas de routes plus sp√©cifiques vers <b>BBB1</b> que 0.0.0.0/0; <br><br>  19) Les fournisseurs d'acc√®s Internet transmettent via leurs r√©seaux un datagramme ESP de <b>AAA1</b> √† <b>BBB1</b> ; <br><br>  20) le routeur sur <b>BBB1</b> re√ßoit ce datagramme, le d√©chiffre et re√ßoit un paquet de <b>192.168.A.1: 3389</b> pour <b>192.168.B.1: 55555</b> ; <br><br>  21) il comprend qu'il doit √™tre transmis √† <b>192.168.B.1</b> , car il est sur le m√™me r√©seau que lui, donc, il a une entr√©e correspondante dans la table de routage qui l'oblige √† envoyer des paquets pour l'ensemble <b>192.168.B.0 / 24</b> directement; <br><br>  22) le routeur trouve l'adresse MAC pour <b>192.168.B.1</b> et lui envoie ce paquet; <br><br>  23) le syst√®me d'exploitation sur l'ordinateur avec l'adresse <b>192.168.B.1</b> re√ßoit un paquet de <b>192.168.A.1: 3389</b> pour <b>192.168.B.1: 55555</b> et lance les √©tapes suivantes pour √©tablir une connexion TCP. <br><br>  Cet exemple est assez concis et simpliste (et ici vous pouvez vous rappeler un tas de d√©tails) d√©crit ce qui se passe aux niveaux 2 √† 4.  Les niveaux 1, 5-7 ne sont pas pris en compte. <br><br><h3>  Deuxi√®me position </h3><br>  Si quelque chose est envoy√© sp√©cifiquement √† <b>AAA2 √†</b> partir de <b>192.168.B.0 / 24</b> , il ne va pas au VPN, mais directement.  Autrement dit, si un utilisateur de l'adresse <b>192.168.B.1</b> acc√®de √† <b>AAA2: 13389</b> , ce paquet est <b>effac√©</b> de l'adresse <b>BBB1</b> , passe √† <b>AAA2</b> , et l√† le routeur le re√ßoit et l'envoie √† <b>192.168.A.1</b> .  <b>192.168.A.1</b> ne sait rien de <b>192.168.B.1</b> , il voit un paquet de <b>BBB1</b> , car il l'a compris.  Par cons√©quent, la r√©ponse √† cette demande suit la route g√©n√©rale, il en va exactement de m√™me de l'adresse <b>AAA2</b> et va √† <b>BBB1</b> , et ce routeur donne cette r√©ponse √† <b>192.168.B.1</b> , il voit la r√©ponse de <b>AAA2</b> , √† laquelle il s'est adress√©. <br><br>  Exemple concret: <br><br>  1) <b>192.168.B.1</b> adresse <b>AAA2</b> , souhaite √©tablir une connexion TCP avec <b>AAA2: 13389</b> ; <br><br>  2) <b>192.168.B.1</b> envoie une demande d'√©tablissement d'une connexion √† partir de <b>192.168.B.1: 55555</b> (ce num√©ro, comme dans l'exemple pr√©c√©dent, peut √™tre diff√©rent) vers <b>AAA2: 13389</b> ; <br><br>  3) le syst√®me d'exploitation qui s'ex√©cute sur l'ordinateur avec l'adresse <b>192.168.B.1</b> d√©cide de transf√©rer ce paquet vers l'adresse de passerelle du routeur ( <b>192.168.B.254</b> dans notre cas), car il n'a pas d'autres itin√©raires plus sp√©cifiques pour <b>AAA2</b> , ce qui signifie qu'il envoie le paquet le long de la route par d√©faut (0.0.0.0/0); <br><br>  4) pour cela, elle, comme nous l'avons mentionn√© dans l'exemple pr√©c√©dent, essaie de trouver l'adresse MAC pour l'adresse IP <b>192.168.B.254</b> dans la table de cache du protocole ARP.  S'il n'est pas trouv√©, il envoie √† partir de l'adresse <b>192.168.B.1 une</b> demande de diffusion qui-a au r√©seau <b>192.168.B.0 / 24</b> .  Lorsque <b>192.168.B.254 lui</b> renvoie son adresse MAC, le syst√®me lui envoie un paquet Ethernet et stocke ces informations dans sa table de cache; <br><br>  5) le routeur re√ßoit ce paquet et d√©cide o√π l'envoyer: il a pour politique de transmettre (en rempla√ßant l'adresse de retour) tous les paquets de <b>192.168.B.0 / 24</b> √† d'autres n≈ìuds Internet; <br><br>  6) puisque cette politique implique que l'adresse de retour doit co√Øncider avec l'adresse la plus basse sur l'interface par laquelle ce paquet sera transmis, le routeur d√©cide d'abord √† qui exactement ce paquet doit √™tre transmis, et lui, comme dans l'exemple pr√©c√©dent, doit l'envoyer √† <b>BBB254</b> (passerelle de fournisseur de services Internet), car il n'a pas de routes plus sp√©cifiques vers <b>AAA2</b> que 0.0.0.0/0; <br><br>  7) par cons√©quent, le routeur remplace l'adresse de retour du paquet, d√©sormais le paquet de <b>BBB1: 44444</b> (le num√©ro de port, bien s√ªr, peut √™tre diff√©rent) √† <b>AAA2: 13389</b> ; <br><br>  8) le routeur se souvient de ce qu'il a fait, ce qui signifie que lorsqu'une <b>r√©ponse est re√ßue</b> de <b>AAA2: 13389</b> √† <b>BBB1: 44444</b> , il saura qu'il doit changer l'adresse et le port du destinataire en <b>192.168.B.1: 55555</b> . <br><br>  9) maintenant le routeur doit le transf√©rer au r√©seau du fournisseur Internet via <b>BBB254</b> , donc, de la m√™me mani√®re que nous l'avons d√©j√† mentionn√©, il trouve l'adresse MAC pour <b>BBB254</b> et envoie le paquet √† la passerelle du fournisseur Internet; <br><br>  10) Les fournisseurs d'acc√®s Internet transf√®rent un paquet de <b>BBB1</b> √† <b>AAA2</b> sur leurs r√©seaux; <br><br>  11) le routeur virtuel sur <b>AAA2</b> re√ßoit ce paquet sur le port 13389; <br><br>  12) il existe une r√®gle sur le routeur virtuel qui stipule que les paquets provenant de n'importe quel exp√©diteur vers ce port doivent √™tre envoy√©s √† <b>192.168.A.1: 3389</b> ; <br><br>  13) le routeur virtuel trouve le r√©seau <b>192.168.A.0 / 24</b> dans la table de routage et l'envoie directement √† <b>192.168.A.</b>  1, car il poss√®de une interface <b>192.168.A.254 / 24</b> ; <br><br>  14) pour cela, le routeur virtuel trouve l'adresse MAC pour <b>192.168.A.1</b> et lui transmet ce paquet via le r√©seau Ethernet virtuel; <br><br>  15) <b>192.168.A.1</b> re√ßoit ce paquet sur le port 3389, accepte d'√©tablir une connexion et forme un paquet en r√©ponse de <b>192.168.A.1: 3389</b> sur <b>BBB1: 44444</b> ; <br><br>  16) son syst√®me envoie ce paquet √† l'adresse de passerelle du routeur virtuel ( <b>192.168.A.254</b> dans notre cas), car il n'a pas d'autres routes plus sp√©cifiques pour <b>BBB1</b> , par cons√©quent, il doit transmettre le paquet le long de la route par d√©faut (0.0. 0,0 / 0); <br><br>  17) de la m√™me mani√®re que dans les cas pr√©c√©dents, le syst√®me qui s'ex√©cute sur le serveur avec l'adresse <b>192.168.A.1</b> trouve l'adresse MAC <b>192.168.A.254</b> , car il est sur le m√™me r√©seau avec son interface <b>192.168.A.1 / 24</b> ; <br><br>  18) Le routeur virtuel accepte ce paquet.  Il convient de noter qu'il se souvient qu'il a re√ßu un paquet de <b>BBB1: 44444</b> sur <b>AAA2: 13389</b> et a chang√© l'adresse et le port du destinataire en <b>192.168.A.1: 3389</b> , par cons√©quent, il change le paquet de <b>192.168.A.1: 3389</b> en <b>BBB1: 44444</b> adresse de l'exp√©diteur sur <b>AAA2: 13389</b> ; <br><br>  19) le routeur virtuel d√©cide √† qui ce paquet doit √™tre envoy√©, il l'envoie √† <b>AAA254</b> (la passerelle du fournisseur Internet, dans ce cas, c'est nous aussi), car il n'a pas de routes plus sp√©cifiques vers <b>BBB1</b> que 0.0.0.0/0; <br><br>  20) Les fournisseurs d'acc√®s Internet transf√®rent un paquet de <b>AAA2</b> √† <b>BBB1</b> sur leurs r√©seaux; <br><br>  21) le routeur sur <b>BBB1</b> re√ßoit ce paquet et rappelle que lorsqu'il a envoy√© le paquet de <b>192.168.B.1: 55555</b> √† <b>AAA2: 13389</b> , il a chang√© son adresse et son port d'exp√©diteur en <b>BBB1: 44444</b> , ce qui signifie que c'est la r√©ponse qui doit √™tre transmise sur <b>192.168.B.1: 55555</b> (en fait, il y a plusieurs autres contr√¥les, mais nous n'y allons pas); <br><br>  22) il comprend qu'ils doivent √™tre envoy√©s directement √† <b>192.168.B.1</b> , car il est sur le m√™me r√©seau que lui, donc, il a une entr√©e correspondante dans la table de routage qui l'oblige √† envoyer des paquets pour l'ensemble <b>192.168.B.0 / 24</b> directement; <br><br>  23) le routeur trouve l'adresse MAC pour <b>192.168.B.1</b> et lui envoie ce paquet; <br><br>  24) le syst√®me d'exploitation sur l'ordinateur avec l'adresse <b>192.168.B.1</b> re√ßoit un paquet de <b>AAA2: 13389</b> pour <b>192.168.B.1: 55555</b> et lance les √©tapes suivantes pour √©tablir une connexion TCP. <br><br>  Il convient de noter que dans ce cas, l'ordinateur avec l'adresse <b>192.168.B.1</b> ne sait rien du serveur avec l'adresse <b>192.168.A.1</b> , il ne communique qu'avec <b>AAA2</b> .  De m√™me, le serveur avec l'adresse <b>192.168.A.1</b> ne sait rien de l'ordinateur avec l'adresse <b>192.168.B.1</b> .  Il pense qu'ils se sont connect√©s √† lui depuis l'adresse <b>BBB1</b> , et il n'en sait rien de plus, pour ainsi dire. <br><br>  Il convient √©galement de noter que si cet ordinateur acc√®de √† <b>AAA2: 1540</b> , la connexion ne sera pas √©tablie, car la redirection de connexion vers le port 1540 n'est pas configur√©e sur le routeur virtuel, m√™me si sur un serveur du r√©seau virtuel <b>192.168.A.0 / 24</b> (par exemple, sur un serveur avec l'adresse <b>192.168.A.1</b> ) et certains services attendent une connexion sur ce port.  Si l'utilisateur de l'ordinateur avec l'adresse <b>192.168.B.1 est</b> absolument n√©cessaire pour √©tablir une connexion avec ce service, il doit utiliser un VPN, c'est-√†-dire  contacter directement au <b>192.168.A.1: 1540</b> . <br><br>  Il convient de souligner que toute tentative d'√©tablir une connexion avec <b>AAA1</b> (√† l'exception de la connexion IPSec de <b>BBB1</b> ne r√©ussira pas. Toute tentative d'√©tablir une connexion avec <b>AAA2</b> , √† l'exception des connexions au port 13389, √©chouera √©galement. <br>  Notez √©galement que si quelqu'un d'autre fait <b>appel</b> √† <b>AAA2</b> (par exemple, UDP), tout ce qui est indiqu√© dans les paragraphes 10-20 s'appliquera √©galement √† lui.  Ce qui se passe avant et apr√®s cela d√©pend de ce qui se cache exactement derri√®re cela. Nous ne sommes pas propri√©taires de ces informations, nous vous conseillons donc de consulter les administrateurs du site avec l'adresse de l'adresse. <br><br><h3>  Troisi√®me position </h3><br>  Et vice versa, si quelque chose est envoy√© de <b>192.168.A.1</b> vers un port configur√© pour √™tre transf√©r√© √† l'int√©rieur vers BBB1 (par exemple, 11111), il n'entre pas non plus dans le VPN, mais se contente de <b>AAA1</b> et se retrouve dans <b>BBB1</b> , et que l'on est d√©j√† en train de le transf√©rer quelque part dans, disons, <b>192.168.B.2: 3389</b> .  Il voit ce paquet non pas depuis <b>192.168.A.1</b> , mais depuis <b>AAA1</b> .  Et, lorsque <b>192.168.B.2</b> r√©pond, le paquet passe de <b>BBB1</b> √† <b>AAA1,</b> puis parvient √† l'initiateur de connexion - <b>192.168.A.1</b> . <br><br>  Exemple concret: <br><br>  1) <b>192.168.A.1</b> adresse <b>BBB1</b> , souhaite √©tablir une connexion TCP avec <b>BBB1: 11111</b> ; <br><br>  2) <b>192.168.A.1</b> envoie une demande d'√©tablissement d'une connexion √† partir de <b>192.168.A.1: 55555</b> (ce num√©ro, comme dans l'exemple pr√©c√©dent, peut √™tre diff√©rent) sur <b>BBB1: 11111</b> ; <br><br>  3) le syst√®me d'exploitation qui s'ex√©cute sur le serveur avec l'adresse <b>192.168.A.1</b> d√©cide de transf√©rer ce paquet vers l'adresse de passerelle du routeur ( <b>192.168.A.254</b> dans notre cas), car il n'a pas d'autres itin√©raires plus sp√©cifiques pour <b>BBB1</b> , par cons√©quent, il envoie le paquet le long de la route par d√©faut (0.0.0.0/0); <br><br>  4) pour cela, elle, comme nous l'avons mentionn√© dans les exemples pr√©c√©dents, essaie de trouver l'adresse MAC pour l'adresse IP <b>192.168.A.254</b> dans la table de cache du protocole ARP.  S'il n'est pas trouv√©, il envoie √† partir de l'adresse <b>192.168.A.1 une</b> demande de diffusion qui-a au r√©seau <b>192.168.A.0 / 24</b> .  Lorsque <b>192.168.A.254 lui</b> renvoie son adresse MAC, le syst√®me lui transmet un paquet Ethernet et entre ces informations dans sa table de cache; <br><br>  5) le routeur virtuel re√ßoit ce paquet et d√©cide o√π le transf√©rer: il a pour politique de transmettre (en rempla√ßant l'adresse de retour) tous les paquets de <b>192.168.A.0 / 24</b> √† d'autres n≈ìuds Internet; <br><br>  6) puisque cette politique suppose que l'adresse de retour doit co√Øncider avec l'adresse la plus basse sur l'interface par laquelle ce paquet sera transmis, le routeur virtuel d√©cide d'abord √† qui exactement ce paquet doit √™tre transmis, et lui, comme dans l'exemple pr√©c√©dent, doit l'envoyer sur <b>AAA254</b> (la passerelle du fournisseur Internet, dans ce cas, c'est nous aussi), car il n'a pas de routes plus sp√©cifiques vers <b>BBB1</b> que 0.0.0.0/0; <br><br>  7) cela signifie que le routeur virtuel remplace l'adresse de retour du paquet, il s'agit d√©sormais d'un paquet de <b>AAA1: 44444</b> (le num√©ro de port, bien s√ªr, peut √™tre diff√©rent) √† <b>BBB1: 11111</b> ; <br><br>  8) le routeur virtuel se souvient de ce qu'il a fait, par cons√©quent, quand une <b>r√©ponse est re√ßue</b> de <b>BBB1: 11111</b> pour <b>AAA1: 44444</b> , il saura qu'il doit changer l'adresse et le port du destinataire en <b>192.168.A.1: 55555</b> . <br><br>  9) maintenant, le routeur virtuel doit le transf√©rer vers le r√©seau du fournisseur Internet via <b>AAA254</b> , ce qui signifie que, comme nous l'avons d√©j√† mentionn√©, il trouve l'adresse MAC pour <b>AAA254</b> et envoie le paquet √† la passerelle du fournisseur Internet; <br><br>  10) Les fournisseurs d'acc√®s Internet transf√®rent sur leurs r√©seaux un paquet de <b>AAA1 √† BBB1</b> ; <br><br>  11) le routeur sur <b>BBB1</b> re√ßoit ce paquet sur le port 11111; <br><br>  12) il existe une r√®gle sur le routeur virtuel, qui stipule que les paquets re√ßus de tout exp√©diteur vers ce port doivent √™tre transmis √† <b>192.168.B.2: 3389</b> ; <br><br>  13) le routeur trouve le r√©seau <b>192.168.B.0 / 24</b> dans la table de routage et l'envoie directement √† <b>192.168.B.2</b> , car il poss√®de une interface <b>192.168.B.254 / 24</b> ; <br><br>  14) pour cela, le routeur virtuel trouve l'adresse MAC pour <b>192.168.B.2</b> et lui transmet ce paquet via le r√©seau Ethernet virtuel; <br><br>  15) <b>192.168.B.2</b> re√ßoit ce paquet sur le port 3389, accepte d'√©tablir une connexion et forme un paquet en r√©ponse de <b>192.168.B.2: 3389</b> √† <b>AAA1: 44444</b> ; <br><br>  16) son syst√®me envoie ce paquet √† l'adresse de passerelle du routeur ( <b>192.168.B.254</b> dans notre cas), car il n'a pas d'autres routes plus sp√©cifiques pour <b>AAA1</b> , par cons√©quent, il doit passer le paquet le long de la route par d√©faut (0.0.0.0 / 0); <br><br>  17) de la m√™me mani√®re que dans les cas pr√©c√©dents, le syst√®me qui s'ex√©cute sur l'ordinateur avec l'adresse <b>192.168.B.2</b> trouve l'adresse MAC <b>192.168.B.254</b> , car il est sur le m√™me r√©seau avec son interface <b>192.168.B.2 / 24</b> ; <br><br>  18) Le routeur accepte ce paquet.  Il convient de noter qu'il se souvient avoir re√ßu un paquet de <b>AAA1</b> sur <b>BBB1: 11111</b> et chang√© l'adresse et le port du destinataire en <b>192.168.B.2: 3389.Par</b> cons√©quent, il change l'adresse de l'exp√©diteur en un paquet de <b>192.168.B.2: 3389</b> pour <b>AAA1: 44444</b> sur <b>BBB1: 11111</b> ; <br><br>  19) Le routeur d√©cide √† qui transf√©rer ce paquet.  Il l'envoie, disons, √† <b>BBB254</b> (la passerelle du fournisseur Internet, dont nous ne connaissons pas l'adresse exacte), car il n'a pas de routes plus sp√©cifiques vers <b>AAA1</b> que 0.0.0.0/0; <br><br>  20) Les fournisseurs d'acc√®s Internet transf√®rent un paquet de <b>BBB1</b> √† <b>AAA1</b> sur leurs r√©seaux; <br><br>  21) le routeur virtuel sur <b>AAA1</b> re√ßoit ce paquet et rappelle que lorsqu'il a envoy√© le paquet de <b>192.168.A.1: 55555</b> √† <b>BBB1: 11111</b> , il a chang√© son adresse et son port d'exp√©diteur en <b>AAA1: 44444</b> .  Donc, c'est la r√©ponse qui doit √™tre transmise √† <b>192.168.A.1: 55555</b> (en fait, comme nous l'avons mentionn√© dans l'exemple pr√©c√©dent, il y a aussi quelques v√©rifications suppl√©mentaires, mais cette fois nous n'y allons pas trop); <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22) il comprend qu'il doit √™tre envoy√© directement √† </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car il est sur le m√™me r√©seau que lui, ce qui signifie qu'il a une entr√©e correspondante dans la table de routage qui l'oblige √† envoyer des paquets pour l'ensemble de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.0 / 24</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directement; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23) le routeur trouve l'adresse MAC pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et lui envoie ce paquet; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">24) le syst√®me d'exploitation sur le serveur avec l'adresse </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> re√ßoit un paquet de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BBB1: 1111</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1: 55555</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et lance les √©tapes suivantes pour √©tablir une connexion TCP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De la m√™me mani√®re que dans le cas pr√©c√©dent, dans ce cas le serveur avec l'adresse </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne sait rien de l'ordinateur avec l'adresse </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.B.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , il ne communique qu'avec </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BBB1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'ordinateur avec l'adresse </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.B.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ne sait rien non plus sur le serveur avec l'adresse </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il pense qu'ils se sont connect√©s √† lui depuis l'adresse </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AAA1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et le reste lui est cach√©.</font></font><br><br><h3>  Conclusion </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici comment cela se produit lors de la connexion √† l'int√©rieur d'un tunnel VPN entre le bureau du client et l'environnement dans le cloud, ainsi que lors de la connexion √† l'ext√©rieur du tunnel VPN. </font><font style="vertical-align: inherit;">Et si vous avez encore des questions ou avez besoin de notre aide pour r√©soudre les probl√®mes de cloud, </font></font><a href="https://tucha.ua/ru/contacts"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">veuillez contacter 24h / 24 et 7j / 7.</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr477854/">https://habr.com/ru/post/fr477854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr477844/index.html">5 √©tapes de l'id√©e √† l'application pratique de l'apprentissage automatique avec SAP Data Intelligence</a></li>
<li><a href="../fr477846/index.html">Le condens√© des √©v√©nements pour les professionnels des RH en informatique pour d√©cembre 2019</a></li>
<li><a href="../fr477848/index.html">Le petit secret d'un grand c≈ìur: le premier cardiogramme de la baleine bleue de l'histoire</a></li>
<li><a href="../fr477850/index.html">React Native - une solution miracle pour tous les probl√®mes? Comment nous avons choisi un outil multiplateforme pour Profi.ru</a></li>
<li><a href="../fr477852/index.html">Hypocrisie non toxique</a></li>
<li><a href="../fr477856/index.html">Acc√©l√©rateurs flash PCI-E de 800 Go √† 6,4 To: de l'aube √† la vie sur un PC / serveur classique</a></li>
<li><a href="../fr477858/index.html">Travail hors table: quels projets sont vraiment apparus apr√®s la pr√©-acc√©l√©ration?</a></li>
<li><a href="../fr477860/index.html">Comment les services de base de donn√©es g√©r√©s sont-ils organis√©s dans Yandex?</a></li>
<li><a href="../fr477864/index.html">TabPy pour travailler avec des donn√©es dans ClickHouse de Tableau</a></li>
<li><a href="../fr477870/index.html">Tableau de bord Grafana pour syst√®me de bi√®re BeerTender</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>