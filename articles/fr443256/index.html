<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüéì üíà üóΩ PowerShell, vidage de mon exp√©rience ü•£ ‚úäüèΩ üë®üèº‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 


 Cet article s'adresse √† ceux qui se sont d√©j√† familiaris√©s avec les bases de PowerShell, ex√©cutent certains scripts avec stackexchang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PowerShell, vidage de mon exp√©rience</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443256/"><h2 id="vvedenie">  Pr√©sentation </h2><br><p>  Cet article s'adresse √† ceux qui se sont d√©j√† familiaris√©s avec les bases de PowerShell, ex√©cutent certains scripts avec stackexchange et ont probablement leur propre fichier texte avec divers extraits pour faciliter le travail quotidien.  Le but de l'√©crire est de r√©duire l'entropie, d'augmenter la lisibilit√© et la maintenabilit√© du code PowerShell utilis√© dans votre entreprise et, par cons√©quent, d'augmenter la productivit√© de l'administrateur travaillant avec lui. </p><br><p><img src="https://habrastorage.org/webt/go/9u/yw/go9uywfoytxpgrxmggcvf2bfi8e.png" alt="kdpv"></p><br><p>  Dans mon ancien lieu de travail, en raison des sp√©cificit√©s des t√¢ches et de l'imperfection du monde, j'ai consid√©rablement am√©lior√© les comp√©tences de travail avec PowerShell.  Apr√®s un changement de travail, les charges de ce genre ont diminu√© de fa√ßon spectaculaire et tout ce qui √©tait juste au coin des doigts a commenc√© √† couler de plus en plus profond√©ment sous l'exp√©rience de la r√©solution de nouveaux probl√®mes avec les nouvelles technologies.  √Ä partir de l√†, cet article pr√©tend √™tre seulement ce qu'il se d√©clare, r√©v√©lant une liste de sujets qui, √† mon avis, me seraient utiles il y a environ 7 ans, lorsque ma connaissance de cet outil ne faisait que commencer. </p><a name="habracut"></a><br><p>  Si vous ne comprenez pas pourquoi PowerShell est un shell orient√© objet, quels bonus en d√©coulent et pourquoi il est n√©cessaire du tout, je vous conseillerai un bon livre qui pr√©sente rapidement l'essence de cet environnement malgr√© les ennemis haineux - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Andrey Vladimirovich Popov, Introduction √† Windows PowerShell</a> .  Oui, il s'agit de l'ancienne version de PS, oui, le langage a gagn√© quelques extensions et am√©liorations, mais ce livre est bon car en d√©crivant les premiers stades de d√©veloppement de cet environnement, il met involontairement l'accent uniquement sur les choses fondamentales.  Le sucre syntaxique avec lequel l'environnement a envahi, je pense, vous le percevez rapidement sans comprendre comment fonctionne le concept.  La lecture de ce livre ne vous prendra que quelques soir√©es, revenez apr√®s la lecture. </p><br><p><img src="https://habrastorage.org/webt/g9/ea/h9/g9eah9nfoao7gukeochjqasi2ne.jpeg" alt="popov"></p><br><p>  Le livre est √©galement disponible sur le site Web de l'auteur, bien que je ne sais pas dans quelle mesure cette utilisation est autoris√©e: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://andpop.ru/courses/winscript/books/posh_popov.pdf</a> </p><br><h2 id="stayl-gaydy">  Guides de style </h2><br><p>  Concevoir des scripts selon des guides de style est une bonne pratique dans tous les cas d'application, il ne peut gu√®re y avoir deux avis.  Certains √©cosyst√®mes ont pris soin de cela au niveau du r√©glage natif, pep8 dans la communaut√© Python et aller fmt √† Golang vient √† l'√©vidence.  Ce sont des outils de gain de temps inestimables, qui, malheureusement, sont absents du package PowerShell standard, et transf√®rent donc le probl√®me dans notre t√™te.  Actuellement, la seule fa√ßon de r√©soudre le probl√®me de la mise en forme uniforme du code est de d√©velopper des r√©flexes en √©crivant √† plusieurs reprises du code qui satisfait les guides de style (en fait, non). </p><br><p>  Les guides de style en raison de l'absence de documents officiellement approuv√©s et d√©crits en d√©tail par Microsoft sont n√©s dans la communaut√© √† l'√©poque de PowerShell v3 et depuis lors, ils se d√©veloppent sous forme ouverte sur le github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PowerShellPracticeAndStyle</a> .  Il s'agit d'un r√©f√©rentiel remarquable pour tous ceux qui ont d√©j√† utilis√© le bouton "Enregistrer" dans PowerShell ise. </p><br><p>  Si vous essayez de faire une compression, cela se r√©sumera probablement aux points suivants: </p><br><ul><li>  PowerShell utilise PascalCase pour nommer les variables, les applets de commande, les noms de module et √† peu pr√®s tout sauf les op√©rateurs; </li><li> Les op√©rateurs de langage tels que <code>if</code> , <code>switch</code> , <code>break</code> , <code>process</code> , <code>-match</code> sont √©crits en tr√®s petites lettres; </li><li>  Les accolades sont plac√©es de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">seule vraie mani√®re</a> , autrement appel√©e aussi le style de Kernigan et Richie, menant son histoire du livre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">The C Programming Language</a> ; </li><li>  N'utilisez pas d'alias ailleurs qu'une session de console interactive, n'√©crivez aucun <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> fichier de script <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code>  <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> ; </li><li>  Indiquez des noms de param√®tres explicites, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comportement des applets de commande et leur signature peuvent changer</a> , plus cela ajoute un contexte √† une personne qui ne conna√Æt pas une applet de commande particuli√®re; </li><li>  Concevez les param√®tres pour appeler des scripts et n'√©crivez pas de fonction √† l'int√©rieur du script et la derni√®re ligne appelle cette fonction avec la n√©cessit√© de changer les valeurs des variables globales au lieu de sp√©cifier des param√®tres; </li><li>  Sp√©cifiez [CmdletBinding ()] - cela donnera √† vos <code>-Verbose</code> <code>-Debug</code> <code>-Verbose</code> et <code>-Debug</code> indicateurs et de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nombreuses autres fonctionnalit√©s utiles</a> .  Malgr√© la position ferme de certains puristes dans la communaut√©, je ne suis pas partisan d'indiquer cet attribut dans des fonctions en ligne simples et des filtres compos√©s de plusieurs lignes litt√©rales; </li><li>  √âcrivez une aide bas√©e sur des commentaires: une phrase, lien de ticket, exemple d'appel; </li><li>  Sp√©cifiez la version requise de PowerShell dans la section <code>#requires</code> ; </li><li>  Utilisez <code>Set-StrictMode -Version Latest</code> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cela vous aidera √† √©viter les probl√®mes d√©crits ci-dessous</a> ; </li><li>  G√©rer les erreurs; </li><li>  Ne vous pr√©cipitez pas pour tout r√©√©crire dans PowerShell.  PowerShell est principalement un shell et appeler des binaires est sa t√¢che directe.  Il n'y a rien de mal √† utiliser robocopy dans un script, bien s√ªr ce n'est pas rsync, mais c'est aussi tr√®s bon. </li></ul><br><h2 id="comment-based-help">  Aide bas√©e sur les commentaires </h2><br><p>  Voici un exemple de la fa√ßon d'obtenir un script d'aide.  Le script encadre l'image, l'amenant √† un carr√© et redimensionnant, je pense que vous avez la t√¢che de faire des avatars pour les utilisateurs (sauf peut-√™tre la rotation en fonction des donn√©es exif).  Il existe un exemple d'utilisation dans la section <code>.EXAMPLE</code> , essayez-le.  Du fait que PowerShell est ex√©cut√© par le Common Language Runtime, le m√™me que les autres langages dotnet, il a la capacit√© d'utiliser toute la puissance des biblioth√®ques dotnet: </p><br><pre> <code class="plaintext hljs">&lt;# .SYNOPSIS Resize-Image resizes an image file .DESCRIPTION This function uses the native .NET API to crop a square and resize an image file .PARAMETER InputFile Specify the path to the image .PARAMETER OutputFile Specify the path to the resized image .PARAMETER SquareHeight Define the size of the side of the square of the cropped image. .PARAMETER Quality Jpeg compression ratio .EXAMPLE Resize the image to a specific size: .\Resize-Image.ps1 -InputFile "C:\userpic.jpg" -OutputFile "C:\userpic-400.jpg"-SquareHeight 400 #&gt; # requires -version 3 [CmdletBinding()] Param( [Parameter( Mandatory )] [string]$InputFile, [Parameter( Mandatory )] [string]$OutputFile, [Parameter( Mandatory )] [int32]$SquareHeight, [ValidateRange( 1, 100 )] [int]$Quality = 85 ) # Add System.Drawing assembly Add-Type -AssemblyName System.Drawing # Open image file $Image = [System.Drawing.Image]::FromFile( $InputFile ) # Calculate the offset for centering the image $SquareSide = if ( $Image.Height -lt $Image.Width ) { $Image.Height $Offset = 0 } else { $Image.Width $Offset = ( $Image.Height - $Image.Width ) / 2 } # Create empty square canvas for the new image $SquareImage = New-Object System.Drawing.Bitmap( $SquareSide, $SquareSide ) $SquareImage.SetResolution( $Image.HorizontalResolution, $Image.VerticalResolution ) # Draw new image on the empty canvas $Canvas = [System.Drawing.Graphics]::FromImage( $SquareImage ) $Canvas.DrawImage( $Image, 0, -$Offset ) # Resize image $ResultImage = New-Object System.Drawing.Bitmap( $SquareHeight, $SquareHeight ) $Canvas = [System.Drawing.Graphics]::FromImage( $ResultImage ) $Canvas.DrawImage( $SquareImage, 0, 0, $SquareHeight, $SquareHeight ) $ImageCodecInfo = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object MimeType -eq 'image/jpeg' # https://msdn.microsoft.com/ru-ru/library/hwkztaft(v=vs.110).aspx $EncoderQuality = [System.Drawing.Imaging.Encoder]::Quality $EncoderParameters = New-Object System.Drawing.Imaging.EncoderParameters( 1 ) $EncoderParameters.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter( $EncoderQuality, $Quality ) # Save the image $ResultImage.Save( $OutputFile, $ImageCodecInfo, $EncoderParameters )</code> </pre> <br><p>  Le script ci-dessus commence par un commentaire sur plusieurs lignes <code>&lt;# ... #&gt;</code> , si ce commentaire vient en premier et contient certains mots cl√©s, PowerShell cr√©era automatiquement de l'aide pour le script.  Ce type d'aide est litt√©ralement appel√© - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aide bas√©e sur le commentaire</a> : </p><br><p><img src="https://habrastorage.org/webt/9y/tw/d3/9ytwd3hlr6yb5nsobqqor_bjshw.png" alt="aider"></p><br><p>  De plus, lorsque le script est appel√©, les info-bulles des param√®tres fonctionnent, que ce soit la console PowerShell ou l'√©diteur de code: </p><br><p><img src="https://habrastorage.org/webt/tr/ha/qg/trhaqga49fwvjphbl6i_cporowa.png" alt="aide en ligne"></p><br><p>  Encore une fois, j'attire l'attention sur le fait qu'elle ne doit pas √™tre n√©glig√©e.  Si vous ne savez pas quoi √©crire l√†-bas, √©crivez quelque chose, allez √† la glaci√®re et √† votre retour, vous aurez certainement une compr√©hension de ce qui doit √™tre chang√© par √©crit.  √áa marche.  Ne remplissez pas tous les mots-cl√©s de mani√®re fanatique, PowerShell est con√ßu pour √™tre auto-document√© et si vous avez donn√© des noms significatifs et complets aux param√®tres, une courte phrase dans la section <code>.SYNOPIS</code> et un exemple suffisent. </p><br><h2 id="strict-mode">  Mode strict </h2><br><p>  PowerShell, comme beaucoup d'autres langages de script, a un typage dynamique.  Ce type de frappe a de nombreux partisans: √©crire une logique de haut niveau simple mais puissante est une question de quelques minutes, mais lorsque votre d√©cision commencera √† atteindre mille lignes, vous rencontrerez certainement la fragilit√© de cette approche. </p><br><p>  L'autotype des types invariablement au stade du test, formant un tableau √† l'endroit o√π vous avez toujours re√ßu un ensemble d'√©l√©ments, mettra certainement un cochon au cas o√π vous obtenez un √©l√©ment et dans la condition suivante, au lieu de v√©rifier le nombre d'√©l√©ments, vous obtiendrez le nombre de caract√®res ou un autre attribut, selon type d'article.  La logique du script se brisera et le runtime pr√©tendra que tout va bien. </p><br><p>  La d√©finition du mode strict permet d'√©viter certains de ce type de probl√®mes, mais cela n√©cessite √©galement un peu plus de code de votre part, comme l'initialisation des variables et la conversion explicite. </p><br><p>  Ce mode est activ√© par l'applet de commande <code>Set-StrictMode -Version Latest</code> , bien qu'il existe d'autres options de "rigueur", mon choix est d'utiliser cette derni√®re. </p><br><p>  Dans l'exemple ci-dessous, le mode strict intercepte un appel vers une propri√©t√© inexistante.  Puisqu'il n'y a qu'un seul √©l√©ment √† l'int√©rieur du dossier, le type de la variable <code>$Input</code> r√©sultant de l'ex√©cution sera <code>FileInfo</code> , et non le tableau attendu des √©l√©ments correspondants: </p><br><p><img src="https://habrastorage.org/webt/fk/q-/jk/fkq-jkrdldogwcwyiwkwspskseq.png" alt="strict"></p><br><p>  Pour √©viter un tel probl√®me, vous devez explicitement convertir le r√©sultat de l'applet de commande dans un tableau: </p><br><pre> <code class="plaintext hljs">$Items = @( Get-ChildItem C:\Users\snd3r\Nextcloud )</code> </pre> <br><p>  Faites-en une r√®gle pour toujours d√©finir un mode strict, cela vous permettra d'√©viter des r√©sultats inattendus lors de l'ex√©cution de vos scripts. </p><br><h2 id="obrabotka-oshibok">  Gestion des erreurs </h2><br><h3 id="erroractionpreference">  ErrorActionPreference </h3><br><p>  Lorsque je regarde les scripts d'autres personnes, par exemple, sur un github, je vois souvent soit ignorer compl√®tement le m√©canisme de gestion des erreurs, soit activer explicitement le mode continu silencieux en cas d'erreur.  Le probl√®me de gestion des erreurs n'est certainement pas le plus facile √† programmer en g√©n√©ral et dans les scripts en particulier, mais il ne m√©rite certainement pas d'√™tre ignor√©.  Par d√©faut, PowerShell en cas d'erreur l'affiche et continue de fonctionner (j'ai un peu simplifi√© le concept, mais ci-dessous se trouve un lien vers un git book sur ce sujet).  Ceci est pratique si vous avez un besoin urgent de distribuer la mise √† jour d'un programme largement utilis√© dans le domaine sur toutes les machines, sans attendre qu'il se propage √† tous les points de d√©ploiement sccm ou se propage d'une autre mani√®re que vous utilisez.  Il est d√©sagr√©able d'interrompre et de red√©marrer le processus si l'une des machines est √©teinte, c'est vrai. </p><br><p>  D'un autre c√¥t√©, si vous effectuez une sauvegarde complexe d'un syst√®me compos√© de plusieurs fichiers de donn√©es de plusieurs parties du syst√®me d'information, vous devez vous assurer que votre sauvegarde est coh√©rente et que tous les ensembles de donn√©es n√©cessaires ont √©t√© copi√©s sans erreur. </p><br><p>  Pour modifier le comportement des applets de commande en cas d'erreur, il existe une variable globale <code>$ErrorActionPreference</code> , avec la liste suivante de valeurs possibles: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Stop, Inquire, Continue, Suspend, SilentlyContinue</a> . </p><br><p>  Je recommande que vous utilisiez toujours la valeur <code>Stop</code> lorsque le nombre de scripts ou leur complexit√© cesse d'√™tre stock√© dans la pile dans votre t√™te, il est pr√©f√©rable de vous assurer que dans toute situation impr√©vue, le script arr√™tera son travail et ne cassera pas le bois de chauffage ¬´tranquillement¬ª, compl√©tant l'ex√©cution ¬´avec succ√®s¬ª. </p><br><p>  En plus d'arr√™ter le script en cas de probl√®me, il existe une autre condition pr√©alable √† son utilisation: la gestion des situations exceptionnelles.  Il existe une construction <code>try/catch</code> pour cela, mais cela ne fonctionne que si l'erreur provoque l'arr√™t de l'ex√©cution.  Il n'est pas n√©cessaire que l'arr√™t soit activ√© au niveau de l'ensemble du script, <code>ErrorAction</code> peut <code>ErrorAction</code> √™tre d√©fini au niveau de l'applet de commande avec le param√®tre: </p><br><pre> <code class="plaintext hljs">Get-ChildItem 'C:\System Volume Information\' -ErrorAction 'Stop'</code> </pre> <br><p>  En fait, cette possibilit√© d√©finit deux strat√©gies logiques: r√©soudre toutes les erreurs "par d√©faut" et d√©finir <code>ErrorAction</code> uniquement pour les endroits critiques o√π les g√©rer;  soit activer au niveau de l'ensemble du script en d√©finissant la valeur de la variable globale et en d√©finissant <code>-ErrorAction 'Continue'</code> sur les op√©rations non critiques.  Je choisis toujours la deuxi√®me option, je ne suis pas press√© de vous l'imposer, je ne recommande qu'une seule fois pour comprendre ce probl√®me et utiliser cet outil utile. </p><br><h3 id="trycatch">  essayer / attraper </h3><br><p>  Dans le gestionnaire d'erreurs, vous pouvez faire correspondre le type d'exception et op√©rer avec un thread d'ex√©cution ou, par exemple, ajouter un peu plus d'informations.  Malgr√© le fait qu'en utilisant les op√©rateurs <code>try/catch/throw/trap</code> , vous pouvez cr√©er l'int√©gralit√© du flux d'ex√©cution de script, vous devez cat√©goriquement √©viter cela, car une telle m√©thode de fonctionnement avec ex√©cution n'est pas seulement consid√©r√©e comme un antipater extr√™me de la cat√©gorie "goto-noodle", donc r√©duit √©galement consid√©rablement les performances. </p><br><pre> <code class="plaintext hljs">#requires -version 3 $ErrorActionPreference = 'Stop' #   ,    , #          $Logger = Get-Logger "$PSScriptRoot\Log.txt" #    trap { $Logger.AddErrorRecord( $_ ) exit 1 } #    $count = 1; while ( $true ) { try { #   $StorageServers = @( Get-ADGroupMember -Identity StorageServers | Select-Object -Expand Name ) } catch [System.Management.Automation.CommandNotFoundException] { #      ,         throw " Get-ADGroupMember ,    Active Directory module for PowerShell; $( $_.Exception.Message )" } catch [System.TimeoutException] { #             if ( $count -le 3 ) { $count++; Start-Sleep -S 10; continue } #             throw "     -   ,   $count ; $( $_.Exception.Message )" } #         break }</code> </pre> <br><p>  Il convient de noter que l'op√©rateur de <code>trap</code> est un d√©routement d'erreur global.  Il intercepte tout ce qui n'a pas √©t√© trait√© √† des niveaux inf√©rieurs ou est rejet√© du gestionnaire d'exceptions en raison de l'impossibilit√© de corriger ind√©pendamment la situation. </p><br><p>  En plus de l'approche orient√©e objet des exceptions d√©crite ci-dessus, PowerShell fournit √©galement des concepts plus familiers compatibles avec d'autres shells "classiques", par exemple, les flux d'erreurs, les codes de retour et les variables d'accumulation d'erreurs.  Tout cela est certainement pratique, parfois sans alternative, mais d√©passe le cadre de ce sujet, dans l'ensemble, un aper√ßu.  Heureusement, il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bon livre ouvert sur github</a> √† ce sujet. </p><br><p>  Le code de l'enregistreur que j'utilise lorsqu'il n'y a aucune certitude que le syst√®me aura PowerShell 5 (o√π vous pouvez d√©crire la classe de l'enregistreur plus facilement), essayez-le, il peut vous √™tre utile en raison de sa simplicit√© et de sa bri√®vet√©, vous √™tes s√ªr d'ajouter des m√©thodes suppl√©mentaires sans difficult√©. : </p><br><pre> <code class="plaintext hljs">#   " ",   PowerShell v3 function Get-Logger { [CmdletBinding()] param ( [Parameter( Mandatory = $true )] [string] $LogPath, [string] $TimeFormat = 'yyyy-MM-dd HH:mm:ss' ) $LogsDir = [System.IO.Path]::GetDirectoryName( $LogPath ) New-Item $LogsDir -ItemType Directory -Force | Out-Null New-Item $LogPath -ItemType File -Force | Out-Null $Logger = [PSCustomObject]@{ LogPath = $LogPath TimeFormat = $TimeFormat } Add-Member -InputObject $Logger -MemberType ScriptMethod AddErrorRecord -Value { param( [Parameter( Mandatory = $true )] [string]$String ) "$( Get-Date -Format 'yyyy-MM-dd HH:mm:ss' ) [Error] $String" | Out-File $this.LogPath -Append } return $Logger }</code> </pre> <br><p>  Je r√©p√®te l'id√©e - n'ignorez pas la gestion des erreurs.  Cela vous fera √©conomiser du temps et des nerfs √† long terme. <br>  Ne pensez pas que l'ex√©cution du script, peu importe ce qui est bon.  Bon - il est temps de tomber sans casser du bois de chauffage. </p><br><h2 id="instrumenty">  Les outils </h2><br><p>  Il vaut la peine de commencer √† am√©liorer les outils pour travailler avec PowerShell √† partir de l'√©mulateur de console.  J'ai souvent entendu des partisans de gu√™pes alternatives que la console dans Windows est mauvaise et que ce n'est pas du tout une console, mais des dos et ainsi de suite.  Rares sont ceux qui peuvent formuler correctement leurs affirmations √† ce sujet, mais si quelqu'un r√©ussit, il s'av√®re en r√©alit√© que tous les probl√®mes peuvent √™tre r√©solus.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Il y</a> avait d√©j√† plus d'informations sur les terminaux et la nouvelle console dans les fen√™tres du hub; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tout y est plus que correct</a> . </p><br><p>  La premi√®re √©tape consiste √† installer Conemu ou son assemblage Cmder, ce qui n'est pas particuli√®rement important, car √† mon avis, cela vaut la peine de parcourir les param√®tres de toute fa√ßon.  Je choisis g√©n√©ralement cmder dans la configuration minimale, sans gita et autres binaires, que je me suis fix√©, m√™me si pendant plusieurs ann√©es j'ai r√©gl√© ma config pour du Conemu pur.  C'est vraiment le meilleur √©mulateur de terminal pour Windows, vous permettant de diviser l'√©cran (pour les amateurs de tmux / √©cran), de cr√©er des onglets et d'activer le mode console de style tremblement de terre: </p><br><h3 id="conemu">  Conemu </h3><br><p><img src="https://habrastorage.org/webt/ag/2w/hy/ag2whyp2okkhyroygpuzjkdamis.png" alt="cmder"></p><br><p>  La prochaine √©tape, je recommande de mettre les modules: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">oh-my-posh</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">posh-git</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PSReadLine</a> .  Les deux premiers rendront le bal plus agr√©able en ajoutant des informations sur la session en cours, l'√©tat de la derni√®re commande ex√©cut√©e, l'indicateur de privil√®ge et l'√©tat du r√©f√©rentiel git √† l'emplacement actuel.  PSReadLine stimule consid√©rablement promt, en ajoutant par exemple une recherche sur l'historique des commandes entr√©es (CRTL + R) et des conseils pratiques pour les applets de commande sur CRTL + Space: </p><br><p><img src="https://habrastorage.org/webt/eg/w6/f2/egw6f2sa43hgi3dhwn_hhgxbesa.gif" alt="readline"></p><br><p>  Et oui, maintenant la console peut √™tre effac√©e avec CTRL + L, et oublier les <code>cls</code> . </p><br><h3 id="visual-studio-code">  Code Visual Studio </h3><br><p>  L'√©diteur.  Tout ce que je peux dire de pire sur PowerShell est purement PowerShell ISE, ceux qui ont vu la premi√®re version avec trois panneaux ont peu de chances d'oublier cette exp√©rience.  L'encodage diff√©rent du terminal, le manque de fonctionnalit√©s de base de l'√©diteur, telles que l'indentation automatique, les crochets √† fermeture automatique, le formatage du code et tout un ensemble d'antipatterns g√©n√©r√©s par celui-ci dont je ne vous dirai pas (juste au cas o√π) - tout cela concerne ISE. </p><br><p>  Ne l'utilisez pas, utilisez Visual Studio Code avec l'extension PowerShell - il y a tout ce que vous ne voudriez pas (dans des limites raisonnables, bien s√ªr).  Et n'oubliez pas que dans PoweShell jusqu'√† la sixi√®me version (PowerShell Core 6.0), l'encodage des scripts est UTF8 BOM, sinon la langue russe se brisera. </p><br><p><img src="https://habrastorage.org/webt/dd/c0/pa/ddc0paj-xbx5tysllsrmzlxnugi.png" alt="vscode"></p><br><p>  En plus de la mise en √©vidence de la syntaxe, des info-bulles et des capacit√©s de d√©bogage de script, le plugin installe un linter qui vous aidera √©galement √† suivre les pratiques √©tablies dans la communaut√©, par exemple, en d√©veloppant les raccourcis en un seul clic (sur l'ampoule).  En fait, il s'agit d'un module standard qui peut √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">install√©</a> ind√©pendamment, par exemple, ajoutez-le √† vos scripts de signature de pipeline: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PSScriptAnalyzer</a> </p><br><p><img src="https://habrastorage.org/webt/mj/x7/ov/mjx7ovrtephqcdctuiptdu_tff4.png" alt="PSScriptAnalyzer"></p><br><p>  Vous pouvez d√©finir les param√®tres de formatage du code dans les param√®tres d'extension, pour tous les param√®tres (√† la fois l'√©diteur et les extensions), il y a une recherche: <code>File - Preferences - Settings</code> : </p><br><p><img src="https://habrastorage.org/webt/ia/xr/km/iaxrkmgjcpcf4wck1ocb7kfp9ym.png" alt="Otbs"></p><br><p>  Afin d'obtenir une nouvelle console vide, vous devez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©finir le drapeau dans les param√®tres</a> , plus tard, probablement, ce conseil ne sera pas pertinent. </p><br><p>  Il convient de se rappeler que toute action dans VS Code peut √™tre effectu√©e √† partir du centre de contr√¥le, appel√© par CTRL + Maj + P. Formatez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> morceau de code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ins√©r√© √† partir du chat</a> , triez l'ordre alphab√©tique, changez le retrait des espaces en onglets, etc., tous dans le centre de contr√¥le. </p><br><p>  Par exemple, activez le plein √©cran et centrez l'√©diteur: </p><br><p><img src="https://habrastorage.org/webt/3z/w9/-a/3zw9-avzniwjgooxfa1dvzi9kfc.png" alt="mise en page"></p><br><h3 id="source-control-git-svn">  Contr√¥le de source  Git, SVN </h3><br><p>  Souvent, les administrateurs syst√®me Windows ont une phobie de r√©solution de conflits dans les syst√®mes de contr√¥le de version, probablement parce que si un repr√©sentant de cet ensemble utilise git, alors souvent on ne rencontre aucun probl√®me de ce type.  Avec vscode, la r√©solution des conflits se r√©duit litt√©ralement √† des clics de souris sur les parties du code qui doivent √™tre laiss√©es ou remplac√©es. </p><br><p><img src="https://habrastorage.org/webt/ft/fd/8f/ftfd8f1ylxofsckzu6v1uujok1e.png" alt="fusionner"></p><br><p>  Ces √©tiquettes entre les lignes 303 et 304 sont cliquables, cela vaut la peine de cliquer sur toutes celles qui apparaissent dans le document en cas de conflit, de valider les modifications et de les envoyer au serveur.  U - Commodit√©. </p><br><p>  Sur la fa√ßon de travailler avec les syst√®mes de contr√¥le de version est disponible et avec des images, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">il est √©crit dans le dock vscode</a> , passez-y bri√®vement les yeux. </p><br><h3 id="snippets">  Extraits </h3><br><p>  <a href="">Les extraits de</a> code sont une sorte de macro / mod√®le qui vous permet d'acc√©l√©rer l'√©criture de code.  Certainement un must. </p><br><p>  Cr√©ation rapide d'objets: </p><br><p><img src="https://habrastorage.org/webt/yi/wp/om/yiwpomlohxird5oovnutj4hc7ec.gif" alt="objet personnalis√©"></p><br><p>  P√™cher pour une aide bas√©e sur des commentaires: </p><br><p><img src="https://habrastorage.org/webt/ol/jn/37/oljn37jxzabxa9h4yqquuh98s9i.gif" alt="aider"></p><br><p>  Si l'applet de commande doit passer un grand nombre de param√®tres, il est judicieux d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utiliser l'√©claboussure</a> . <br>  Voici un extrait pour lui: </p><br><p><img src="https://habrastorage.org/webt/lx/y_/ek/lxy_ekyxsjsuiad66yzqqfoxzta.gif" alt="√©claboussures"></p><br><p>  Afficher tous les extraits disponibles disponibles par Ctrl + Alt + J: </p><br><p><img src="https://habrastorage.org/webt/0p/jm/k_/0pjmk_nms2ejlugtcsxvp1vjhea.gif" alt="extraits"></p><br><p>  Si apr√®s cela, vous aviez envie de continuer √† am√©liorer votre environnement, mais que vous n'aviez pas encore entendu parler des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">feuilles de gu√™pe, alors vous y √™tes</a> .  De plus, si vous avez votre propre ensemble d'extensions utiles pour l'√©criture de scripts PowerShell, je serai heureux de voir leur liste dans les commentaires. </p><br><h2 id="proizvoditelnost">  Performances </h2><br><p>  Le sujet de la performance n'est pas aussi simple qu'il y para√Æt √† premi√®re vue.  D'une part, les optimisations pr√©matur√©es peuvent r√©duire consid√©rablement la lisibilit√© et la maintenabilit√© du code, √©conomisant 300 ms de temps d'ex√©cution de script, dont le temps d'ex√©cution habituel peut √™tre de dix minutes, leur utilisation dans ce cas est d√©finitivement destructrice.  D'un autre c√¥t√©, il existe plusieurs astuces assez simples qui augmentent √† la fois la lisibilit√© du code et sa vitesse, qui sont tout √† fait appropri√©es √† utiliser de mani√®re continue.  Ci-dessous, je parlerai de certains d'entre eux, si les performances sont tout pour vous et que la lisibilit√© passe √† c√¥t√© en raison des limites de temps strictes des temps d'arr√™t du service pendant la maintenance, je vous recommande de vous r√©f√©rer √† la litt√©rature <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pertinente</a> . </p><br><h3 id="pipeline-i-foreach">  Pipeline et foreach </h3><br><p>  La fa√ßon la plus simple et toujours efficace d'augmenter la productivit√© est d'√©viter d'utiliser des tuyaux.  En raison de la s√©curit√© et de la commodit√© du type pour des raisons de puissance, les √©l√©ments PowerShell passant √† travers un tuyau enveloppent chacun d'eux dans un objet.  Dans les langages dotnet, ce comportement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est appel√© boxe</a> .  La boxe est bonne, elle garantit la s√©curit√©, mais elle a son propre prix, ce qui n'a parfois aucun sens √† payer. </p><br><p>  La premi√®re √©tape consiste √† augmenter les performances et, √† mon avis, √† am√©liorer la lisibilit√© en supprimant toutes les applications de l' <code>Foreach-Object</code> et en la rempla√ßant par l'instruction foreach.  Vous pouvez √™tre confondu par le fait qu'il s'agit en fait de deux entit√©s diff√©rentes, car <code>foreach</code> est un alias de <code>Foreach-Object</code> - en pratique, la principale diff√©rence est que <code>foreach</code> n'accepte pas les valeurs d'un pipeline, et en m√™me temps, il fonctionne par exp√©rience jusqu'√† trois fois plus rapidement. </p><br><p>  :        -  , ,          : </p><br><pre> <code class="plaintext hljs">Get-Content D:\temp\SomeHeavy.log | Select-String '328117'</code> </pre> <br><p>        ‚Äî       ,      .         ‚Äî ,        ,    <code>Get-Content</code> .                  <code>string</code>  ,    ,            .    ‚Äî      ,         : </p><br><blockquote> When reading from and writing to binary files, use the AsByteStream parameter and a value of 0 for the ReadCount parameter. A ReadCount value of 0 reads the entire file in a single read operation. The default ReadCount value, 1, reads one byte in each read operation and converts each byte into a separate object, which causes errors when you use the Set-Content cmdlet to write the bytes to a file unless you use AsByteStream <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-content</a> </blockquote><br><pre> <code class="plaintext hljs">Get-Content D:\temp\SomeHeavy.log -ReadCount 0 | Select-String '328117'</code> </pre> <br><p>                : </p><br><p><img src="https://habrastorage.org/webt/t2/bg/hw/t2bghwyeop1gofgu_tapyqimp3o.png" alt="recomptage"></p><br><p>        ,          .    <code>Select-String</code>          ‚Äî       .                ,          <code>Select-String</code> .      ,      <code>Select-String</code>       ,        ,             : </p><br><pre> <code class="plaintext hljs">foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { $line } }</code> </pre> <br><p>        30 , -   30%,           ,         ,        , - ,   (     ;-).      ,     .         ,    <code>-match</code> ;   ‚Äî     .                ,      ‚Äî               ‚Äî   -   ,    . </p><br><p>   ‚Äî -   ,   " "              : </p><br><pre> <code class="plaintext hljs">foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" | Out-File D:\temp\Result.log -Append } }</code> </pre> <br><p>     <code>Measure-Command</code> : </p><br><pre> <code class="plaintext hljs">Hours : 2 Minutes : 20 Seconds : 9 Milliseconds : 101</code> </pre> <br><p>   .   ,           ,          ,      .    ,    PowerShell           ,    ,       ‚Äî        .         ,    ,            ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StringBuilder</a> .                 ,            ,           .          ,                     . </p><br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } Out-File -InputObject $StringBuilder.ToString() -FilePath D:\temp\Result.log -Append -Encoding UTF8</code> </pre> <br><p>      5 ,      : </p><br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 37 Milliseconds : 150</code> </pre> <br><p>    <code>Out-File -InputObject</code> ,    ,       .          ‚Äî        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a>    .              ‚Äî  <code>Get-Help</code>     <code>-Full</code> ,         <code>Accept pipeline input? true (ByValue)</code> : </p><br><pre> <code class="plaintext hljs">-InputObject &lt;psobject&gt; Required? false Position? Named Accept pipeline input? true (ByValue) Parameter set name (All) Aliases None Dynamic? false</code> </pre> <br><p>    PowerShell     : </p><br><p><img src="https://habrastorage.org/webt/8d/zl/r-/8dzlr-yjpt13avpi_wjibzdpnxs.png" alt="taskmgr"></p><br><p>    <code>StringBuilder</code>                           : </p><br><p><img src="https://habrastorage.org/webt/lc/4j/1c/lc4j1c3-um9jozjohlauurwzo3a.png" alt="attribut de constructeur de cordes"></p><br><p>    ,    ,  3  3.        dotnet-      ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StreamReader</a> . </p><br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder $StreamReader = New-Object System.IO.StreamReader 'D:\temp\SomeHeavy.log' while ( $line = $StreamReader.ReadLine()) { if ( $line -match '328117' ) { $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } $StreamReader.Dispose() Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 33 Milliseconds : 657</code> </pre> <br><p>      ,       .               ,     ,       ,    ,          2.        ,          : </p><br><p><img src="https://habrastorage.org/webt/wr/ka/_w/wrka_wcvj1idodxx_37ka8wnhmm.png" alt="streamreader"></p><br><p>        ‚Äî      "",   ‚Äî  <code>StringBuilder</code> ‚Äî ""       .   ,      (  100)           .       ‚Äî       90%    (        ,     ): </p><br><pre> <code class="plaintext hljs">$BufferSize = 104857600 $StringBuilder = New-Object System.Text.StringBuilder $BufferSize $StreamReader = New-Object System.IO.StreamReader 'C:\temp\SomeHeavy.log' while ( $line = $StreamReader.ReadLine()) { if ( $line -match '1443' ) { #      if ( $StringBuilder.Length -gt ( $BufferSize - ( $BufferSize * 0.1 ))) { Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8 $StringBuilder.Clear() } $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8 $StreamReader.Dispose()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 53 Milliseconds : 417</code> </pre> <br><p>     1      : </p><br><p><img src="https://habrastorage.org/webt/rg/ro/f6/rgrof6lxdcrx96urvmxuflcbdbc.png" alt="streamreader with dump"></p><br><p>              ,                 .     ,      ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StreamWriter</a> ,   ,   ;-)      ,        ,    . </p><br><p> -     ‚Äî     ,        .    ,     ‚Äî  .  <code>Select-String</code>  <code>Out-File</code>    ,        <code>OutOfMemoryException</code> ,    ‚Äî    . </p><br><h3 id="nativnye-binarniki">   </h3><br><p> ,      PowerShell         ,         ‚Äî ,  : PowerShell ‚Äî          ,     . </p><br><p>  ,       <code>StringBuilder</code>     <code>dir</code> ‚Äî          (  ).          : </p><br><pre> <code class="plaintext hljs">$CurrentPath = ( Get-Location ).Path + '\' $StringBuilder = New-Object System.Text.StringBuilder foreach ( $Line in ( &amp;cmd /c dir /b /s /ad )) { $null = $StringBuilder.AppendLine( $Line.Replace( $CurrentPath, '.' )) } $StringBuilder.ToString()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 0 Seconds : 3 Milliseconds : 9</code> </pre> <br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder foreach ( $Line in ( Get-ChildItem -File -Recurse | Resolve-Path -Relative )) { $null = $StringBuilder.AppendLine( $Line ) } $StringBuilder.ToString()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 0 Seconds : 16 Milliseconds : 337</code> </pre> <br><p>     $null ‚Äî     .  ,    ‚Äî    <code>Out-Null</code> ;  ,    (   <code>$null</code> )     ,   . </p><br><pre> <code class="plaintext hljs"># : $null = $StringBuilder.AppendLine( $Line ) # : $StringBuilder.AppendLine( $Line ) | Out-Null</code> </pre> <br><p>           ,          ,  .      <code>Compare-Object</code> ,      ,      ,       .            robocopy.exe,      (   PowerShell 5),      : </p><br><pre> <code class="plaintext hljs">class Robocopy { [String]$RobocopyPath Robocopy () { $this.RobocopyPath = Join-Path $env:SystemRoot 'System32\Robocopy.exe' if ( -not ( Test-Path $this.RobocopyPath -PathType Leaf )) { throw '    ' } } [void]CopyFile ( [String]$SourceFile, [String]$DestinationFolder ) { $this.CopyFile( $SourceFile, $DestinationFolder, $false ) } [void]CopyFile ( [String]$SourceFile, [String]$DestinationFolder, [bool]$Archive ) { $FileName = [IO.Path]::GetFileName( $SourceFile ) $FolderName = [IO.Path]::GetDirectoryName( $SourceFile ) $Arguments = @( '/R:0', '/NP', '/NC', '/NS', '/NJH', '/NJS', '/NDL' ) if ( $Archive ) { $Arguments += $( '/A+:a' ) } $ErrorFlag = $false &amp;$this.RobocopyPath $FolderName $DestinationFolder $FileName $Arguments | Foreach-Object { if ( $ErrorFlag ) { $ErrorFlag = $false throw "$_ $ErrorString" } else { if ( $_ -match '(?&lt;=\(0x[\da-f]{8}\))(?&lt;text&gt;(.+$))' ) { $ErrorFlag = $true $ErrorString = $matches.text } else { $Logger.AddRecord( $_.Trim()) } } } if ( $LASTEXITCODE -eq 8 ) { throw 'Some files or directories could not be copied' } if ( $LASTEXITCODE -eq 16 ) { throw 'Robocopy did not copy any files. Check the command line parameters and verify that Robocopy has enough rights to write to the destination folder.' } } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, '*.*', '', $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [Bool]$Archive ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, '*.*', '', $Archive ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, '', $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [Bool]$Archive ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, '', $Archive ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [String]$Exclude ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, $Exclude, $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [String]$Exclude, [Bool]$Archive ) { $Arguments = @( '/MIR', '/R:0', '/NP', '/NC', '/NS', '/NJH', '/NJS', '/NDL' ) if ( $Exclude ) { $Arguments += $( '/XF' ) $Arguments += $Exclude.Split(' ') } if ( $Archive ) { $Arguments += $( '/A+:a' ) } $ErrorFlag = $false &amp;$this.RobocopyPath $SourceFolder $DestinationFolder $Include $Arguments | Foreach-Object { if ( $ErrorFlag ) { $ErrorFlag = $false throw "$_ $ErrorString" } else { if ( $_ -match '(?&lt;=\(0x[\da-f]{8}\))(?&lt;text&gt;(.+$))' ) { $ErrorFlag = $true $ErrorString = $matches.text } else { $Logger.AddRecord( $_.Trim()) } } } if ( $LASTEXITCODE -eq 8 ) { throw 'Some files or directories could not be copied' } if ( $LASTEXITCODE -eq 16 ) { throw 'Robocopy did not copy any files. Check the command line parameters and verify that Robocopy has enough rights to write to the destination folder.' } } }</code> </pre> <br><p>                ,             (      ),         ‚Äî    . </p><br><p>   ,   :        <code>Foreach-Object</code> !?  ,             :    <code>foreach</code> ,  <code>Foreach-Object</code>          ‚Äî   ,   , ,   ,      .       . </p><br><p>       ,     : </p><br><pre> <code class="plaintext hljs">$Robocopy = New-Object Robocopy #    $Robocopy.CopyFile( $Source, $Dest ) #   $Robocopy.SyncFolders( $SourceDir, $DestDir ) #    .xml     $Robocopy.SyncFolders( $SourceDir, $DestDir , '*.xml', $true ) #     *.zip *.tmp *.log     $Robocopy.SyncFolders( $SourceDir, $DestDir, '*.*', '*.zip *.tmp *.log', $true )</code> </pre> <br><h3 id="poslevkusie">  </h3><br><p>        ‚Äî           ,       ,            ;   ,        ,   ,     : </p><br><ul><li><p>   <code>foreach</code>   <code>Foreach-Object</code>  ; </p><br></li><li><p>   ; </p><br></li><li><p> /  ,   ; </p><br></li><li><p>  <code>StringBuilder</code>    ; </p><br></li><li><p>      ,   - ; </p><br></li><li><p>      ( ""    ); </p><br></li></ul><br><p>     :    -   ,     . </p><br><h2 id="jobs">  Emplois </h2><br><p>  ,     ,        ,    ,      ,        ,     .            .      ,      IO,               . </p><br><div class="spoiler"> <b class="spoiler_title">    ssd</b> <div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voici comment se d√©roule le premier d√©marrage de Windows Server 2019 fra√Æchement install√© dans Hyper-V vers ssd (il a √©t√© d√©cid√© par la migration de la machine virtuelle vers hdd): </font></font></p><br><p><img src="https://habrastorage.org/webt/mo/eu/jf/moeujfnupkxphhi7uso_hjbzsys.jpeg" alt="2019ssd"></p></div></div><br><p>    PowerShell       ( <code>Get-Command *-Job</code> ),    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> . </p><br><p>      ,  ,  ,     : </p><br><pre> <code class="plaintext hljs">$Job = Start-Job -ScriptBlock { Write-Output 'Good night' Start-Sleep -S 10 Write-Output 'Good morning' } $Job | Wait-Job | Receive-Job Remove-Job $Job</code> </pre> <br><p>          ,         ‚Äî       ,    .             <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">     </a> . </p><br><p>      ,      : </p><br><p><img src="https://habrastorage.org/webt/gc/um/r-/gcumr-9xsk2fh5c5m7epk1eozqg.png" alt="emplois"><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://xaegr.wordpress.com/2011/07/12/threadping/</a> </p><br><p> ,      ,   ‚Äî     ,                 .  , ,     (50  ‚Äî  50 ): </p><br><p><img src="https://habrastorage.org/webt/3f/pg/xg/3fpgxg51u9augjj9iua05wm6fgi.png" alt="le travail meurt"></p><br><p>           .    ,  ‚Äî            ,        .     ‚Äî           ,    . </p><br><p>   ,           , ,              - . </p><br><h2 id="runspaces"> Runspaces </h2><br><p>                  ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Beginning Use of PowerShell Runspaces: Part 1</a> . ,  ‚Äî    PowerShell        ,        .             (,    PowerShell ),       :      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">       (  )</a>       .        ,            . </p><br><p>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WPF </a> ,              PowerShell,     .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> ‚Äî      ,   .    ‚Äî            ,         "" .     . </p><br><p>       ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">           </a> . </p><br><p><img src="https://habrastorage.org/webt/cx/pp/7v/cxpp7vozkcxdsl_ibdyva0_z3wi.gif" alt="wpf"></p><br><pre> <code class="plaintext hljs">#     $GUISyncHash = [hashtable]::Synchronized(@{}) &lt;# WPF  #&gt; $GUISyncHash.FormXAML = [xml](@" &lt;Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" Title="Sample WPF Form" Height="510" Width="410" ResizeMode="NoResize"&gt; &lt;Grid&gt; &lt;Label Content=" " HorizontalAlignment="Left" Margin="10,10,0,0" VerticalAlignment="Top" Height="37" Width="374" FontSize="18"/&gt; &lt;Label Content="" HorizontalAlignment="Left" Margin="16,64,0,0" VerticalAlignment="Top" Height="26" Width="48"/&gt; &lt;TextBox x:Name="BackupPath" HorizontalAlignment="Left" Height="23" Margin="69,68,0,0" TextWrapping="Wrap" Text="" VerticalAlignment="Top" Width="300"/&gt; &lt;Label Content="" HorizontalAlignment="Left" Margin="16,103,0,0" VerticalAlignment="Top" Height="26" Width="35"/&gt; &lt;TextBox x:Name="RestorePath" HorizontalAlignment="Left" Height="23" Margin="69,107,0,0" TextWrapping="Wrap" Text="" VerticalAlignment="Top" Width="300"/&gt; &lt;Button x:Name="FirstButton" Content="‚àö" HorizontalAlignment="Left" Margin="357,68,0,0" VerticalAlignment="Top" Width="23" Height="23"/&gt; &lt;Button x:Name="SecondButton" Content="‚àö" HorizontalAlignment="Left" Margin="357,107,0,0" VerticalAlignment="Top" Width="23" Height="23"/&gt; &lt;CheckBox x:Name="Check" Content="  " HorizontalAlignment="Left" Margin="16,146,0,0" VerticalAlignment="Top" RenderTransformOrigin="-0.113,-0.267" Width="172"/&gt; &lt;Button x:Name="Go" Content="Go" HorizontalAlignment="Left" Margin="298,173,0,0" VerticalAlignment="Top" Width="82" Height="26"/&gt; &lt;ComboBox x:Name="Droplist" HorizontalAlignment="Left" Margin="16,173,0,0" VerticalAlignment="Top" Width="172" Height="26"/&gt; &lt;ListBox x:Name="ListBox" HorizontalAlignment="Left" Height="250" Margin="16,210,0,0" VerticalAlignment="Top" Width="364"/&gt; &lt;/Grid&gt; &lt;/Window&gt; "@) &lt;#   #&gt; $GUISyncHash.GUIThread = { $GUISyncHash.Window = [Windows.Markup.XamlReader]::Load(( New-Object System.Xml.XmlNodeReader $GUISyncHash.FormXAML )) $GUISyncHash.Check = $GUISyncHash.Window.FindName( "Check" ) $GUISyncHash.GO = $GUISyncHash.Window.FindName( "Go" ) $GUISyncHash.ListBox = $GUISyncHash.Window.FindName( "ListBox" ) $GUISyncHash.BackupPath = $GUISyncHash.Window.FindName( "BackupPath" ) $GUISyncHash.RestorePath = $GUISyncHash.Window.FindName( "RestorePath" ) $GUISyncHash.FirstButton = $GUISyncHash.Window.FindName( "FirstButton" ) $GUISyncHash.SecondButton = $GUISyncHash.Window.FindName( "SecondButton" ) $GUISyncHash.Droplist = $GUISyncHash.Window.FindName( "Droplist" ) $GUISyncHash.Window.Add_SourceInitialized({ $GUISyncHash.GO.IsEnabled = $true }) $GUISyncHash.FirstButton.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click FirstButton' ) }) $GUISyncHash.SecondButton.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click SecondButton' ) }) $GUISyncHash.GO.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click GO' ) }) $GUISyncHash.Window.Add_Closed( { Stop-Process -Id $PID -Force }) $null = $GUISyncHash.Window.ShowDialog() } $Runspace = @{} $Runspace.Runspace = [RunspaceFactory]::CreateRunspace() $Runspace.Runspace.ApartmentState = "STA" $Runspace.Runspace.ThreadOptions = "ReuseThread" $Runspace.Runspace.Open() $Runspace.psCmd = { Add-Type -AssemblyName PresentationCore, PresentationFramework, WindowsBase }.GetPowerShell() $Runspace.Runspace.SessionStateProxy.SetVariable( 'GUISyncHash', $GUISyncHash ) $Runspace.psCmd.Runspace = $Runspace.Runspace $Runspace.Handle = $Runspace.psCmd.AddScript( $GUISyncHash.GUIThread ).BeginInvoke() Start-Sleep -S 1 $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( '' ) }) $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( '  ' ) }) foreach ( $item in 1..5 ) { $GUISyncHash.Droplist.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.Droplist.Items.Add( $item ) $GUISyncHash.Droplist.SelectedIndex = 0 }) } $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( 'While ( $true ) { Start-Sleep -S 10 }' ) }) while ( $true ) { Start-Sleep -S 10 }</code> </pre> <br><p>      WPF       github,       ,       smart : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/snd3r/GetDiskSmart/</a> .          ,    MVVM: </p><br><p><img src="https://habrastorage.org/webt/ke/-1/mb/ke-1mbcf2zuyg6crqt70zx4aoqw.png" alt="cinglant"></p><br><p>        Visual Studio,            Community Edition                 ,          xaml-  wpf ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/punker76/kaxaml</a> </p><br><p><img src="https://habrastorage.org/webt/wf/wd/j1/wfwdj1mhk_f8bml8clv3n6sv02a.png" alt="kaxaml"></p><br><h2 id="vmesto-zaklyucheniya">  Au lieu d'une conclusion </h2><br><p> PowerShell ‚Äî        Windows-.   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> ,           ,            . </p><br><p>      ,                ,   "PowerShell,  ",   .           ,        ‚Äî     ,      .                 .          ,  -    , -                . </p><br><p>          ‚Äî    . </p><br><p><img src="https://habrastorage.org/webt/fd/qg/_1/fdqg_1uamuh8rc66ahep2utydeo.png" alt="calme"></p><br><p> PS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Boomburum</a> ,    2019   powershell ‚Äî  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443256/">https://habr.com/ru/post/fr443256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443246/index.html">Comment nous avons r√©invent√© le PBX IP Askozia apr√®s la vente et la cl√¥ture du projet par le d√©veloppeur</a></li>
<li><a href="../fr443248/index.html">Protocoles de r√©servation transparente de PRP et HSR</a></li>
<li><a href="../fr443250/index.html">Collecteur de d√©chets fait maison pour OpenJDK</a></li>
<li><a href="../fr443252/index.html">Bots de fourmis modulaires avec m√©moire</a></li>
<li><a href="../fr443254/index.html">Triton est le virus le plus mortel</a></li>
<li><a href="../fr443258/index.html">Gotify - un projet open source pour d√©livrer des notifications et envoyer des messages au serveur</a></li>
<li><a href="../fr443260/index.html">Migrez vers Zimbra sans risquer une entreprise avec un domaine commun</a></li>
<li><a href="../fr443262/index.html">Mauvais conseil: comment r√©diger la documentation technique? Troisi√®me partie et derni√®re</a></li>
<li><a href="../fr443264/index.html">Il parle et montre: la rh√©torique des politiciens ukrainiens populaires est-elle diff√©rente?</a></li>
<li><a href="../fr443266/index.html">Comment nous avons contribu√© √† transformer le travail de comptabilit√© dans une grande entreprise √©nerg√©tique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>