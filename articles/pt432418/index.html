<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ¨ üí¢ üë©üèæ‚Äçüéì Analisando Express√µes Lambda em Java üë©üèæ üëäüèø üõÄüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De um tradutor: O LambdaMetafactory √© provavelmente um dos mecanismos mais subestimados do Java 8. N√≥s o descobrimos recentemente, mas j√° apreciamos s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analisando Express√µes Lambda em Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/432418/"><p><img src="https://habrastorage.org/webt/nh/bc/r2/nhbcr2a_t-abgnja2uip1sl-uki.jpeg" alt="imagem"></p><br><p>  <em>De um tradutor: O LambdaMetafactory √© provavelmente um dos mecanismos mais subestimados do Java 8. N√≥s o descobrimos recentemente, mas j√° apreciamos suas capacidades.</em>  <em>A vers√£o 7.0 da estrutura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CUBA</a> aprimora o desempenho, evitando chamadas reflexivas em favor da gera√ß√£o de express√µes lambda.</em>  <em>Uma das aplica√ß√µes desse mecanismo em nossa estrutura √© a liga√ß√£o de manipuladores de eventos de aplicativos por anota√ß√µes, uma tarefa comum, um an√°logo do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">EventListener</a> da Spring.</em>  <em>Acreditamos que o conhecimento dos princ√≠pios do LambdaFactory pode ser √∫til em muitos aplicativos Java, e nos apressamos em compartilhar esta tradu√ß√£o com voc√™.</em> </p><br><p> Neste artigo, mostraremos alguns truques pouco conhecidos ao trabalhar com express√µes lambda no Java 8 e as limita√ß√µes dessas express√µes.  O p√∫blico-alvo do artigo s√£o desenvolvedores seniores de Java, pesquisadores e desenvolvedores de kits de ferramentas.  Somente a API Java p√∫blica ser√° usada sem <code>com.sun.*</code> E outras classes internas, portanto, o c√≥digo √© port√°til entre diferentes implementa√ß√µes da JVM. </p><a name="habracut"></a><br><h3 id="korotkoe-predislovie">  Pref√°cio curto </h3><br><p>  As express√µes Lambda apareceram no Java 8 como uma maneira de implementar m√©todos an√¥nimos e, <br>  em alguns casos, como uma alternativa √†s classes an√¥nimas.  No n√≠vel do bytecode, a express√£o lambda √© substitu√≠da pela <code>invokedynamic</code> .  Esta instru√ß√£o √© usada para criar uma implementa√ß√£o de interface funcional e seu √∫nico m√©todo delega a chamada para o m√©todo real, que cont√©m o c√≥digo definido no corpo da express√£o lambda. </p><br><p>  Por exemplo, temos o seguinte c√≥digo: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printElements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;String&gt; strings)</span></span></span></span>{ strings.forEach(item -&gt; System.out.println(<span class="hljs-string"><span class="hljs-string">"Item = %s"</span></span>, item)); }</code> </pre> <br><p>  Este c√≥digo ser√° convertido pelo compilador Java em algo semelhante a: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lambda_forEach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String item)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Java  System.out.println("Item = %s", item); } private static CallSite bootstrapLambda(Lookup lookup, String name, MethodType type) { // //lookup =  VM //name = "lambda_forEach",  VM //type = String -&gt; void MethodHandle lambdaImplementation = lookup.findStatic(lookup.lookupClass(), name, type); return LambdaMetafactory.metafactory(lookup, "accept", MethodType.methodType(Consumer.class), //  - MethodType.methodType(void.class, Object.class), //  Consumer.accept    lambdaImplementation, //     - type); } void printElements(List&lt;String&gt; strings) { Consumer&lt;String&gt; lambda = invokedynamic# bootstrapLambda, #lambda_forEach strings.forEach(lambda); }</span></span></code> </pre> <br><p>  A instru√ß√£o <code>invokedynamic</code> pode ser representada aproximadamente como esse c√≥digo Java: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> CallSite cs; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printElements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;String&gt; strings)</span></span></span><span class="hljs-function"> </span></span>{ Consumer&lt;String&gt; lambda; <span class="hljs-comment"><span class="hljs-comment">//begin invokedynamic if (cs == null) cs = bootstrapLambda(MethodHandles.lookup(), "lambda_forEach", MethodType.methodType(void.class, String.class)); lambda = (Consumer&lt;String&gt;)cs.getTarget().invokeExact(); //end invokedynamic strings.forEach(lambda); }</span></span></code> </pre> <br><p>  Como voc√™ pode ver, o <code>LambdaMetafactory</code> √© usado para criar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CallSite</a> que fornece um m√©todo de f√°brica que retorna um manipulador para o m√©todo de destino.  Este m√©todo retorna a implementa√ß√£o da interface funcional usando <code>invokeExact</code> .  Se houver vari√°veis ‚Äã‚Äãcapturadas na express√£o lambda, <code>invokeExact</code> aceitar√° essas vari√°veis ‚Äã‚Äãcomo par√¢metros reais. </p><br><p>  No Oracle JRE 8, o metafactory gera dinamicamente uma classe Java usando o ObjectWeb Asm, que cria uma classe que implementa uma interface funcional.  Campos adicionais podem ser adicionados √† classe criada se a express√£o lambda capturar vari√°veis ‚Äã‚Äãexternas.  Este se parece com classes an√¥nimas Java, mas existem as seguintes diferen√ßas: </p><br><ul><li>  Uma classe an√¥nima √© gerada pelo compilador Java. </li><li>  A classe para implementar a express√£o lambda √© criada pela JVM em tempo de execu√ß√£o. </li></ul><br><hr><br><p>  <strong>A implementa√ß√£o meta-f√°brica depende do fornecedor e da vers√£o da JVM</strong> </p><br><hr><br><p>  Obviamente, a <code>invokedynamic</code> n√£o √© usada apenas para express√µes lambda em Java.  √â usado principalmente ao executar linguagens din√¢micas no ambiente da JVM.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O mecanismo</a> JavaScript <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nashorn</a> , que √© incorporado ao Java, faz uso pesado dessas instru√ß√µes. </p><br><p>  A seguir, focaremos a classe <code>LambdaMetafactory</code> e seus recursos.  Seguinte <br>  A se√ß√£o deste artigo pressup√µe que voc√™ entenda muito bem como funcionam os m√©todos metaf√°bricas e o que <code>MethodHandle</code> </p><br><h2 id="tryuki-s-lyambda-vyrazheniyami">  Truques com express√µes lambda </h2><br><p>  Nesta se√ß√£o, mostraremos como criar lambdas din√¢micas para uso em tarefas di√°rias. </p><br><h3 id="proveryaemye-isklyucheniya-i-lyambdy">  Exce√ß√µes verificadas e lambdas </h3><br><p>  N√£o √© segredo que todas as interfaces funcionais existentes em Java n√£o suportam exce√ß√µes verificadas.  As vantagens das exce√ß√µes verificadas em rela√ß√£o √†s regulares s√£o um debate de longa data (e ainda quente). </p><br><p>  Mas e se voc√™ precisar usar c√≥digo com exce√ß√µes verificadas nas express√µes lambda em combina√ß√£o com o Java Streams?  Por exemplo, voc√™ precisa converter uma lista de cadeias de caracteres em uma lista de URLs como este: </p><br><pre> <code class="java hljs">Arrays.asList(<span class="hljs-string"><span class="hljs-string">"http://localhost/"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://github.com"</span></span>).stream() .map(URL::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>) .collect(Collectors.toList())</code> </pre> <br><p>  Uma exce√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lan√ß√°vel</a> √© declarada no construtor da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">URL (String)</a> , portanto, n√£o pode ser usada diretamente como refer√™ncia de m√©todo na classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Functiion</a> . </p><br><p>  Voc√™ dir√°: "N√£o, talvez se voc√™ usar esse truque aqui": </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uncheckCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Callable&lt;T&gt; callable)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callable.call(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sneakyThrow(e); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;E extends Throwable, T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sneakyThrow0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Throwable t)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> E </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> (E)t; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sneakyThrow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Throwable e)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Util.&lt;RuntimeException, T&gt;sneakyThrow0(e); } <span class="hljs-comment"><span class="hljs-comment">//   //return s.filter(a -&gt; uncheckCall(a::isActive)) // .map(Account::getNumber) // .collect(toSet());</span></span></code> </pre> <br><p>  Este √© um truque sujo.  E aqui est√° o porqu√™: </p><br><ul><li>  O bloco try-catch √© usado. </li><li>  A exce√ß√£o √© lan√ßada novamente. </li><li>  O uso sujo do tipo apagamento em Java. </li></ul><br><p>  O problema pode ser resolvido de maneira mais "legal", usando o conhecimento dos seguintes fatos: </p><br><ul><li>  As exce√ß√µes verificadas s√£o reconhecidas apenas no n√≠vel do compilador Java. </li><li>  A se√ß√£o <code>throws</code> s√£o apenas metadados para um m√©todo sem um valor sem√¢ntico no n√≠vel da JVM. </li><li>  As exce√ß√µes verificadas e normais s√£o indistingu√≠veis no n√≠vel de bytecode na JVM. </li></ul><br><p>  A solu√ß√£o √© <code>Callable.call</code> m√©todo <code>Callable.call</code> em um m√©todo sem uma se√ß√£o de <code>throws</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;V&gt; <span class="hljs-function"><span class="hljs-function">V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callUnchecked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Callable&lt;V&gt; callable)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> callable.call(); }</code> </pre> <br><p>  Esse c√≥digo n√£o √© compilado porque o m√©todo <code>Callable.call</code> declarou exce√ß√µes verificadas na se√ß√£o <code>throws</code> .  Mas podemos remover esta se√ß√£o usando uma express√£o lambda constru√≠da dinamicamente. </p><br><p>  Primeiro, precisamos declarar uma interface funcional que n√£o possui uma se√ß√£o de <code>throws</code> . <br>  mas quem poder√° delegar a chamada para <code>Callable.call</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@FunctionalInterface</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SilentInvoker</span></span></span><span class="hljs-class"> </span></span>{ MethodType SIGNATURE = MethodType.methodType(Object.class, Callable.class);<span class="hljs-comment"><span class="hljs-comment">//  INVOKE &lt;V&gt; V invoke(final Callable&lt;V&gt; callable); }</span></span></code> </pre> <br><p>  A segunda etapa √© criar uma implementa√ß√£o dessa interface usando o <code>LambdaMetafactory</code> e delegar a chamada do m√©todo <code>SilentInvoker.invoke</code> ao m√©todo <code>Callable.call</code> .  Como mencionado anteriormente, a se√ß√£o <code>throws</code> √© ignorada no n√≠vel do bytecode, portanto, o m√©todo <code>SilentInvoker.invoke</code> pode chamar o m√©todo <code>Callable.call</code> sem declarar exce√ß√µes: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SilentInvoker SILENT_INVOKER; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodHandles.Lookup lookup = MethodHandles.lookup(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CallSite site = LambdaMetafactory.metafactory(lookup, <span class="hljs-string"><span class="hljs-string">"invoke"</span></span>, MethodType.methodType(SilentInvoker.class), SilentInvoker.SIGNATURE, lookup.findVirtual(Callable.class, <span class="hljs-string"><span class="hljs-string">"call"</span></span>, MethodType.methodType(Object.class)), SilentInvoker.SIGNATURE); SILENT_INVOKER = (SilentInvoker) site.getTarget().invokeExact();</code> </pre> <br><p>  Terceiro, escrevemos um m√©todo auxiliar que chama <code>Callable.call</code> sem declarar exce√ß√µes: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;V&gt; <span class="hljs-function"><span class="hljs-function">V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callUnchecked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Callable&lt;V&gt; callable)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/*no throws*/</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SILENT_INVOKER.invoke(callable); }</code> </pre> <br><p>  Agora voc√™ pode reescrever o fluxo sem problemas com exce√ß√µes verificadas: </p><br><pre> <code class="java hljs">Arrays.asList(<span class="hljs-string"><span class="hljs-string">"http://localhost/"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://dzone.com"</span></span>).stream() .map(url -&gt; callUnchecked(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(url))) .collect(Collectors.toList());</code> </pre> <br><p>  Esse c√≥digo √© compilado sem problemas porque <code>callUnchecked</code> n√£o declara exce√ß√µes verificadas.  Al√©m disso, a chamada desse m√©todo pode ser incorporada usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">armazenamento em cache monom√≥rfico</a> , porque √© apenas uma classe em toda a JVM que implementa a interface <code>SilentOnvoker</code> </p><br><p>  Se a implementa√ß√£o de <code>Callable.call</code> lan√ßar uma exce√ß√£o em tempo de execu√ß√£o, ela ser√° <code>Callable.call</code> pela fun√ß√£o de chamada sem problemas: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ callUnchecked(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(<span class="hljs-string"><span class="hljs-string">"Invalid URL"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Exception e){ System.out.println(e); }</code> </pre> <br><p>  Apesar das possibilidades desse m√©todo, lembre-se sempre da seguinte recomenda√ß√£o: </p><br><hr><br><p>  <strong>Ocultar exce√ß√µes marcadas com callUnchecked apenas se voc√™ tiver certeza de que o c√≥digo chamado n√£o lan√ßar√° nenhuma exce√ß√£o</strong> </p><br><hr><br><p>  O exemplo a seguir mostra um exemplo dessa abordagem: </p><br><pre> <code class="java hljs">callUnchecked(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(<span class="hljs-string"><span class="hljs-string">"https://dzone.com"</span></span>)); <span class="hljs-comment"><span class="hljs-comment">// URL        MalformedURLException</span></span></code> </pre> <br><p>  A implementa√ß√£o completa deste m√©todo est√° <a href="">aqui</a> , faz parte do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto de</a> c√≥digo aberto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SNAMP</a> . </p><br><h3 id="rabotaem-s-getters-i-setters">  Trabalhando com getters e setters </h3><br><p>  Esta se√ß√£o ser√° √∫til para quem escreve serializa√ß√£o / desserializa√ß√£o para v√°rios formatos de dados, como JSON, Thrift, etc.  Al√©m disso, pode ser bastante √∫til se o seu c√≥digo depender muito da reflex√£o de Getters e Setters no JavaBeans. </p><br><p>  Um getter declarado no JavaBean √© um m√©todo chamado <code>getXXX</code> sem par√¢metros e um tipo de dados de retorno diferente de <code>void</code> .  Um setter declarado no JavaBean √© um m√©todo chamado <code>setXXX</code> , com um par√¢metro e retornando <code>void</code> .  Essas duas nota√ß√µes podem ser representadas como interfaces funcionais: </p><br><ul><li>  Getter pode ser representado pela classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Function</a> , na qual o argumento √© o valor <code>this</code> . </li><li>  Setter pode ser representado pela classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BiConsumer</a> , na qual o primeiro argumento √© <code>this</code> e o segundo √© o valor que √© passado para o Setter. </li></ul><br><p>  Agora, criaremos dois m√©todos que podem converter qualquer getter ou setter nesses <br>  interfaces funcionais.  E n√£o importa que ambas as interfaces sejam gen√©ricas.  Ap√≥s apagar os tipos <br>  o tipo de dados real ser√° <code>Object</code> .  A convers√£o autom√°tica do tipo e argumentos de retorno pode ser feita usando o <code>LambdaMetafactory</code> .  Al√©m disso, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a biblioteca Guava</a> ajudar√° no cache de express√µes lambda para os mesmos getters e setters. </p><br><p>  Primeiro passo: crie um cache para getters e setters.  A classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Method</a> da API de reflex√£o representa um getter ou setter real e √© usada como uma chave. <br>  O valor do cache √© uma interface funcional constru√≠da dinamicamente para um getter ou setter espec√≠fico. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Cache&lt;Method, Function&gt; GETTERS = CacheBuilder.newBuilder().weakValues().build(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Cache&lt;Method, BiConsumer&gt; SETTERS = CacheBuilder.newBuilder().weakValues().build();</code> </pre> <br><p>  Em segundo lugar, criaremos m√©todos de f√°brica que criam uma inst√¢ncia da interface funcional com base em refer√™ncias ao getter ou setter. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createGetter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodHandles.Lookup lookup, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodHandle getter)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CallSite site = LambdaMetafactory.metafactory(lookup, <span class="hljs-string"><span class="hljs-string">"apply"</span></span>, MethodType.methodType(Function.class), MethodType.methodType(Object.class, Object.class), <span class="hljs-comment"><span class="hljs-comment">//signature of method Function.apply after type erasure getter, getter.type()); //actual signature of getter try { return (Function) site.getTarget().invokeExact(); } catch (final Exception e) { throw e; } catch (final Throwable e) { throw new Error(e); } } private static BiConsumer createSetter(final MethodHandles.Lookup lookup, final MethodHandle setter) throws Exception { final CallSite site = LambdaMetafactory.metafactory(lookup, "accept", MethodType.methodType(BiConsumer.class), MethodType.methodType(void.class, Object.class, Object.class), //signature of method BiConsumer.accept after type erasure setter, setter.type()); //actual signature of setter try { return (BiConsumer) site.getTarget().invokeExact(); } catch (final Exception e) { throw e; } catch (final Throwable e) { throw new Error(e); } }</span></span></code> </pre> <br><p>  A convers√£o autom√°tica de tipo entre argumentos do tipo <code>Object</code> em interfaces funcionais (ap√≥s apagamento do tipo) e tipos reais de argumentos e valor de retorno √© alcan√ßada usando a diferen√ßa entre <code>samMethodType</code> e <code>instantiatedMethodType</code> (o terceiro e o quinto argumentos do m√©todo metafactory, respectivamente).  O tipo do m√©todo instanciado √© a especializa√ß√£o do m√©todo que fornece a implementa√ß√£o da express√£o lambda. </p><br><p>  Em terceiro lugar, criaremos uma fachada para essas f√°bricas com suporte para armazenamento em cache: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reflectGetter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodHandles.Lookup lookup, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Method getter)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ReflectiveOperationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GETTERS.get(getter, () -&gt; createGetter(lookup, lookup.unreflect(getter))); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ExecutionException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReflectiveOperationException(e.getCause()); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BiConsumer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reflectSetter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodHandles.Lookup lookup, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Method setter)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ReflectiveOperationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SETTERS.get(setter, () -&gt; createSetter(lookup, lookup.unreflect(setter))); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ExecutionException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReflectiveOperationException(e.getCause()); } }</code> </pre> <br><p>  As informa√ß√µes de m√©todo obtidas de uma inst√¢ncia da classe <code>Method</code> usando a API Java Reflection podem ser facilmente convertidas em <code>MethodHandle</code> .  Lembre-se de que os m√©todos de inst√¢ncia de classe sempre t√™m um primeiro argumento oculto usado para passar <code>this</code> para esse m√©todo.  M√©todos est√°ticos n√£o possuem esse par√¢metro.  Por exemplo, a assinatura real do m√©todo <code>Integer.intValue()</code> parece com <code>int intValue(Integer this)</code> .  Esse truque √© usado em nossa implementa√ß√£o de wrappers funcionais para getters e setters. </p><br><p>  E agora √© hora de testar o c√≥digo: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Date d = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BiConsumer&lt;Date, Long&gt; timeSetter = reflectSetter(MethodHandles.lookup(), Date.class.getDeclaredMethod(<span class="hljs-string"><span class="hljs-string">"setTime"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>.class)); timeSetter.accept(d, <span class="hljs-number"><span class="hljs-number">42L</span></span>); <span class="hljs-comment"><span class="hljs-comment">//the same as d.setTime(42L); final Function&lt;Date, Long&gt; timeGetter = reflectGetter(MethodHandles.lookup(), Date.class.getDeclaredMethod("getTime")); System.out.println(timeGetter.apply(d)); //the same as d.getTime() //output is 42</span></span></code> </pre> <br><p>  Essa abordagem com getters e setters em cache pode ser efetivamente usada em bibliotecas de serializa√ß√£o / desserializa√ß√£o (como Jackson) que usam getters e setters durante a serializa√ß√£o e desserializa√ß√£o. </p><br><hr><br><p>  <strong>Chamar interfaces funcionais com implementa√ß√µes geradas dinamicamente usando <code>LambdaMetaFactory</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">significativamente mais r√°pido do</a> que chamar pela API Java Reflection</strong> </p><br><hr><br><p>  A vers√£o completa do c√≥digo pode ser encontrada <a href="">aqui</a> , faz parte da biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SNAMP</a> . </p><br><h2 id="ogranicheniya-i-bagi">  Limita√ß√µes e bugs </h2><br><p>  Nesta se√ß√£o, examinaremos alguns erros e limita√ß√µes associados √†s express√µes lambda no compilador Java e na JVM.  Todas essas limita√ß√µes podem ser reproduzidas no OpenJDK e Oracle JDK com o <code>javac</code> vers√£o 1.8.0_131 para Windows e Linux. </p><br><h3 id="sozdanie-lyambda-vyrazheniy-iz-obrabotchikov-metodov">  Criando express√µes lambda a partir de manipuladores de m√©todos </h3><br><p>  Como voc√™ sabe, uma express√£o lambda pode ser constru√≠da dinamicamente usando o <code>LambdaMetaFactory</code> .  Para fazer isso, voc√™ precisa definir um manipulador - a classe <code>MethodHandle</code> , que indica a implementa√ß√£o do √∫nico m√©todo definido na interface funcional.  Vamos dar uma olhada neste exemplo simples: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestClass</span></span></span><span class="hljs-class"> </span></span>{ String value = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value = value; } } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TestClass obj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestClass(); obj.setValue(<span class="hljs-string"><span class="hljs-string">"Hello, world!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MethodHandles.Lookup lookup = MethodHandles.lookup(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CallSite site = LambdaMetafactory.metafactory(lookup, <span class="hljs-string"><span class="hljs-string">"get"</span></span>, MethodType.methodType(Supplier.class, TestClass.class), MethodType.methodType(Object.class), lookup.findVirtual(TestClass.class, <span class="hljs-string"><span class="hljs-string">"getValue"</span></span>, MethodType.methodType(String.class)), MethodType.methodType(String.class)); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Supplier&lt;String&gt; getter = (Supplier&lt;String&gt;) site.getTarget().invokeExact(obj); System.out.println(getter.get());</code> </pre> <br><p>  Este c√≥digo √© equivalente a: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TestClass obj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestClass(); obj.setValue(<span class="hljs-string"><span class="hljs-string">"Hello, world!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Supplier&lt;String&gt; elementGetter = () -&gt; obj.getValue(); System.out.println(elementGetter.get());</code> </pre> <br><p>  Mas e se substituirmos o manipulador de m√©todo que aponta para <code>getValue</code> pelo manipulador que os campos getter representam: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CallSite site = LambdaMetafactory.metafactory(lookup, <span class="hljs-string"><span class="hljs-string">"get"</span></span>, MethodType.methodType(Supplier.class, TestClass.class), MethodType.methodType(Object.class), lookup.findGetter(TestClass.class, <span class="hljs-string"><span class="hljs-string">"value"</span></span>, String.class), <span class="hljs-comment"><span class="hljs-comment">//field getter instead of method handle to getValue MethodType.methodType(String.class));</span></span></code> </pre> <br><p>  Esse c√≥digo deve, como esperado, funcionar porque <code>findGetter</code> retorna um manipulador que aponta para os campos getter e tem a assinatura correta.  Mas, se voc√™ executar esse c√≥digo, ver√° a seguinte exce√ß√£o: </p><br><pre> <code class="plaintext hljs">java.lang.invoke.LambdaConversionException: Unsupported MethodHandle kind: getField</code> </pre> <br><p>  Curiosamente, o getter para o campo funciona bem se usarmos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MethodHandleProxies</a> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Supplier&lt;String&gt; getter = MethodHandleProxies .asInterfaceInstance(Supplier.class, lookup.findGetter(TestClass.class, <span class="hljs-string"><span class="hljs-string">"value"</span></span>, String.class) .bindTo(obj));</code> </pre> <br><p>  Deve-se observar que <code>MethodHandleProxies</code> n√£o √© uma boa maneira de criar express√µes lambda dinamicamente, porque essa classe simplesmente <code>MethodHandle</code> em uma classe proxy e delega invocationHandler.invoke para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MethodHandle.invokeWithArguments</a> .  Essa abordagem usa o Java Reflection e √© muito lenta. </p><br><p>  Como mostrado anteriormente, nem todos os manipuladores de m√©todos podem ser usados ‚Äã‚Äãpara criar express√µes lambda em tempo de execu√ß√£o. </p><br><hr><br><p>  <strong>Apenas alguns tipos de manipuladores de m√©todos podem ser usados ‚Äã‚Äãpara criar dinamicamente express√µes lambda.</strong> </p><br><hr><br><p>  Aqui est√£o elas: </p><br><ul><li>  REF_invokeInterface: pode ser criado usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lookup.findVirtual</a> para m√©todos de interface </li><li>  REF_invokeVirtual: pode ser criado usando Lookup.findVirtual para m√©todos virtuais de classe </li><li>  REF_invokeStatic: criado usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lookup.findStatic</a> para m√©todos est√°ticos </li><li>  REF_newInvokeSpecial: pode ser criado usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lookup.findConstructor</a> para construtores </li><li>  REF_invokeSpecial: pode ser criado usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lookup.findSpecial</a> <br>  para m√©todos particulares e liga√ß√£o antecipada com m√©todos virtuais de classe </li></ul><br><p>  Outros tipos de manipuladores <code>LambdaConversionException</code> erro <code>LambdaConversionException</code> . </p><br><h3 id="generic-isklyucheniya">  Exce√ß√µes gen√©ricas </h3><br><p>  Esse bug est√° relacionado ao compilador Java e √† capacidade de declarar exce√ß√µes gen√©ricas na se√ß√£o <code>throws</code> .  O exemplo de c√≥digo a seguir demonstra esse comportamento: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExtendedCallable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Exception</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Callable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">&gt;</span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">V </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> E</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ExtendedCallable&lt;URL, MalformedURLException&gt; urlFactory = () -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(<span class="hljs-string"><span class="hljs-string">"http://localhost"</span></span>); urlFactory.call();</code> </pre> <br><p>  Esse c√≥digo deve ser compilado porque o construtor da classe <code>URL</code> lan√ßa uma <code>MalformedURLException</code> .  Mas n√£o compila.  A seguinte mensagem de erro √© exibida: </p><br><pre> <code class="plaintext hljs">Error:(46, 73) java: call() in &lt;anonymous Test$CODEgt; cannot implement call() in ExtendedCallable overridden method does not throw java.lang.Exception</code> </pre> <br><p>  Mas, se substituirmos a express√£o lambda por uma classe an√¥nima, o c√≥digo compila: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ExtendedCallable&lt;URL, MalformedURLException&gt; urlFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExtendedCallable&lt;URL, MalformedURLException&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> URL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> MalformedURLException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(<span class="hljs-string"><span class="hljs-string">"http://localhost"</span></span>); } }; urlFactory.call();</code> </pre> <br><p>  Segue-se disso: </p><br><hr><br><p>  <strong>Infer√™ncia de tipo para exce√ß√µes gen√©ricas n√£o funciona corretamente em combina√ß√£o com express√µes lambda</strong> </p><br><hr><br><h3 id="ogranicheniya-tipov-parametrizacii">  Limita√ß√µes do tipo de parametriza√ß√£o </h3><br><p>  Voc√™ pode construir um objeto gen√©rico com v√°rias restri√ß√µes de tipo usando o sinal <code>&amp;</code> : <code>&lt;T extends A &amp; B &amp; C &amp; ... Z&gt;</code> . <br>  Esse m√©todo de determina√ß√£o de par√¢metros gen√©ricos raramente √© usado, mas de certa maneira afeta express√µes lambda em Java devido a algumas restri√ß√µes: </p><br><ul><li>  Cada restri√ß√£o de tipo, exceto a primeira, deve ser uma interface. </li><li>  Uma vers√£o pura de uma classe com esse gen√©rico leva em considera√ß√£o apenas a primeira restri√ß√£o de tipo da lista. </li></ul><br><p>  A segunda limita√ß√£o leva a diferentes comportamentos do c√≥digo no tempo de compila√ß√£o e no tempo de execu√ß√£o, quando ocorre a liga√ß√£o √† express√£o lambda.  Essa diferen√ßa pode ser demonstrada usando o seguinte c√≥digo: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MutableInteger</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Number</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntSupplier</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntConsumer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//mutable container of int value private int value; public MutableInteger(final int v) { value = v; } @Override public int intValue() { return value; } @Override public long longValue() { return value; } @Override public float floatValue() { return value; } @Override public double doubleValue() { return value; } @Override public int getAsInt() { return intValue(); } @Override public void accept(final int value) { this.value = value; } } static &lt;T extends Number &amp; IntSupplier&gt; OptionalInt findMinValue(final Collection &lt;T&gt; values) { return values.stream().mapToInt(IntSupplier::getAsInt).min(); } final List &lt;MutableInteger&gt; values = Arrays.asList(new MutableInteger(10), new MutableInteger(20)); final int mv = findMinValue(values).orElse(Integer.MIN_VALUE); System.out.println(mv);</span></span></code> </pre> <br><p>  Este c√≥digo est√° absolutamente correto e compila com sucesso.  A classe <code>MutableInteger</code> atende √†s restri√ß√µes do tipo gen√©rico T: </p><br><ul><li>  <code>MutableInteger</code> herda de <code>Number</code> . </li><li>  <code>MutableInteger</code> implementa <code>IntSupplier</code> . </li></ul><br><p>  Mas o c√≥digo falhar√° com uma exce√ß√£o no tempo de execu√ß√£o: </p><br><pre> <code class="java hljs">java.lang.BootstrapMethodError: call site initialization exception at java.lang.invoke.CallSite.makeSite(CallSite.java:<span class="hljs-number"><span class="hljs-number">341</span></span>) at java.lang.invoke.MethodHandleNatives.linkCallSiteImpl(MethodHandleNatives.java:<span class="hljs-number"><span class="hljs-number">307</span></span>) at java.lang.invoke.MethodHandleNatives.linkCallSite(MethodHandleNatives.java:<span class="hljs-number"><span class="hljs-number">297</span></span>) at Test.minValue(Test.java:<span class="hljs-number"><span class="hljs-number">77</span></span>) Caused by: java.lang.invoke.LambdaConversionException: Invalid receiver type <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lang</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Number</span></span></span></span>; not a subtype of implementation type <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">util</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">function</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntSupplier</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">at</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lang</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoke</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractValidatingLambdaMetafactory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validateMetafactoryArgs</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractValidatingLambdaMetafactory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">:233) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">at</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lang</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoke</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LambdaMetafactory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">metafactory</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LambdaMetafactory</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">:303) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">at</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lang</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoke</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CallSite</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">makeSite</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CallSite</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">:302)</span></span></code> </pre> <br><p>  Isso acontece porque o pipeline JavaStream captura apenas um tipo puro, que, no nosso caso, √© a classe <code>Number</code> e n√£o implementa a interface <code>IntSupplier</code> .  Esse problema pode ser corrigido declarando explicitamente o tipo de par√¢metro em um m√©todo separado, usado como refer√™ncia ao m√©todo: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IntSupplier i)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i.getAsInt(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T extends Number &amp; IntSupplier&gt; <span class="hljs-function"><span class="hljs-function">OptionalInt </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findMinValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Collection&lt;T&gt; values)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> values.stream().mapToInt(UtilsTest::getInt).min(); }</code> </pre> <br><p>  Este exemplo demonstra infer√™ncia de tipo incorreta no compilador e no tempo de execu√ß√£o. </p><br><hr><br><p>  <strong>O tratamento de v√°rias restri√ß√µes de tipo de par√¢metro gen√©rico em conjunto com o uso de express√µes lambda no tempo de compila√ß√£o e no tempo de execu√ß√£o n√£o √© consistente</strong> </p><br><hr></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt432418/">https://habr.com/ru/post/pt432418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt432408/index.html">Resumo da Fintech: prepara√ß√£o para desconectar pequenos bancos da Visa e Mastercard, uma calculadora de pens√µes e n√£o apenas</a></li>
<li><a href="../pt432410/index.html">Entidades no estilo DDD com Entity Framework Core</a></li>
<li><a href="../pt432412/index.html">Highload ++: Como ajudar o sistema ERP a lidar com 500.000 solicita√ß√µes por segundo</a></li>
<li><a href="../pt432414/index.html">Segredos antigos para depura√ß√£o r√°pida: Animando c√≥digo fonte</a></li>
<li><a href="../pt432416/index.html">Tipos dependentes - o futuro das linguagens de programa√ß√£o</a></li>
<li><a href="../pt432420/index.html">Introdu√ß√£o ao Git Merge e Git Rebase: Por que e quando us√°-los</a></li>
<li><a href="../pt432422/index.html">Modo offline no iOS e recursos de sua implementa√ß√£o no Realm</a></li>
<li><a href="../pt432424/index.html">Infraestrutura certificada HyperFlex para SAP HANA</a></li>
<li><a href="../pt432426/index.html">Depurando um bug que n√£o √© reproduzido</a></li>
<li><a href="../pt432428/index.html">√înibus centralizado vs Service Mesh: como transformar um mitap em uma batalha</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>