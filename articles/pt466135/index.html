<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÉüèΩ üñêÔ∏è üç∂ Megapack: como os desenvolvedores do Factorio conseguiram resolver o problema com o multiplayer de 200 jogadores ‚òîÔ∏è üèØ üåä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em maio deste ano, participei como jogador do evento MMO KatherineOfSky . Percebi que quando o n√∫mero de jogadores atinge um certo n√∫mero, a cada pouc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Megapack: como os desenvolvedores do Factorio conseguiram resolver o problema com o multiplayer de 200 jogadores</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466135/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b7/35a/156/0b735a15617cf15740ddb733b0cff066.jpg" alt="imagem"></div><br>  Em maio deste ano, participei como jogador do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">evento MMO KatherineOfSky</a> .  Percebi que quando o n√∫mero de jogadores atinge um certo n√∫mero, a cada poucos minutos alguns deles "caem".  Felizmente para voc√™ (mas n√£o para mim), eu fui um daqueles jogadores que se desconectavam <b>todas as vezes</b> , mesmo com uma boa conex√£o.  Tomei isso como um desafio pessoal e comecei a procurar as causas do problema.  Ap√≥s tr√™s semanas de depura√ß√£o, teste e corre√ß√£o, o erro foi finalmente corrigido, mas essa jornada n√£o era t√£o simples. <br><br>  Os problemas dos jogos multiplayer s√£o muito dif√≠ceis de localizar.  Geralmente eles surgem em condi√ß√µes muito espec√≠ficas de par√¢metros de rede e em condi√ß√µes muito espec√≠ficas do jogo (neste caso, a presen√ßa de mais de 200 jogadores).  E mesmo quando √© poss√≠vel reproduzir o problema, ele n√£o pode ser depurado adequadamente, porque a inser√ß√£o de pontos de controle interrompe o jogo, confunde os temporizadores e geralmente leva ao encerramento da conex√£o devido ao excesso de tempo de espera.  Mas, gra√ßas √† teimosia e √† maravilhosa ferramenta chamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">desajeitada,</a> consegui descobrir o que estava acontecendo. <br><br>  Resumindo: devido a um erro e √† implementa√ß√£o incompleta da simula√ß√£o do estado de atraso, o cliente √†s vezes se encontra em uma situa√ß√£o em que ele precisa enviar um pacote de rede em um ciclo de clock, consistindo nas a√ß√µes do jogador para selecionar cerca de 400 entidades do jogo (chamamos de "megapackage").  Depois disso, o servidor n√£o deve apenas receber corretamente todas essas a√ß√µes de entrada, mas tamb√©m envi√°-las a todos os outros clientes.  Se voc√™ tem 200 clientes, isso rapidamente se torna um problema.  O canal para o servidor √© rapidamente entupido, o que leva √† perda de pacotes e a uma cascata de pacotes solicitados novamente.  Adiar as a√ß√µes de entrada leva ao fato de que ainda mais clientes come√ßam a enviar megafones, e sua avalanche se torna ainda mais forte.  Clientes bem-sucedidos conseguem se recuperar, todo o resto "cai". <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f21/a49/50e/f21a4950e42bd555a91ad923e5067ea6.jpg" alt="imagem"></div><br>  O problema era bastante fundamental e levei duas semanas para corrigi-lo.  √â bastante t√©cnico, ent√£o, a seguir, explicarei os detalhes t√©cnicos.  Mas primeiro voc√™ precisa saber que desde a vers√£o 0.17.54, lan√ßada em 4 de junho, diante de problemas tempor√°rios de conex√£o, o multiplayer se tornou mais est√°vel e a oculta√ß√£o de atrasos √© muito menos complicada (menos frenagem e teletransporte).  Al√©m disso, mudei a maneira de ocultar os atrasos nos combates e espero que, gra√ßas a isso, eles sejam um pouco mais suaves. <br><br><h3>  Megapack para m√∫ltiplos usu√°rios - Detalhes t√©cnicos </h3><br>  Em termos simples, o multiplayer no jogo funciona da seguinte maneira: todos os clientes simulam o estado do jogo, recebendo e enviando apenas a entrada do jogador (chamada "A√ß√µes de entrada", <i>A√ß√µes de entrada</i> ).  A principal tarefa do servidor √© transmitir <i>a√ß√µes de entrada</i> e controlar que todos os clientes executem as mesmas a√ß√µes em um ciclo.  Leia mais sobre isso no post <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FFF-149</a> . <br><br>  Como o servidor deve tomar decis√µes sobre quais a√ß√µes executar, as a√ß√µes do jogador se movem por esse caminho: a√ß√£o do jogador -&gt; cliente do jogo -&gt; rede -&gt; servidor -&gt; rede -&gt; cliente do jogo.  Isso significa que a a√ß√£o de cada jogador √© executada somente depois que ele faz um caminho de ida e volta pela rede.  Por causa disso, o jogo pareceria terrivelmente lento, ent√£o quase imediatamente ap√≥s o multiplayer aparecer no jogo, um mecanismo para ocultar atrasos foi introduzido.  Ocultar um atraso imita a contribui√ß√£o de um jogador sem levar em considera√ß√£o as a√ß√µes de outros jogadores e as decis√µes do servidor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8u/2f/ui/8u2fuieagsu2fokkbdny-hxi1cc.png"></div><br>  O Factorio possui um estado de jogo chamado <i>Game State</i> - este √© o estado completo do mapa, jogador, entidades e tudo mais.  √â simulado de forma determin√≠stica em todos os clientes com base nas a√ß√µes recebidas do servidor.  O estado do jogo √© sagrado e, se algum dia come√ßar a diferir do servidor ou de qualquer outro cliente, ocorrer√° a dessincroniza√ß√£o. <br><br>  Al√©m do <i>estado do jogo</i> , temos um <i>estado de</i> lat√™ncia do <i>estado de</i> lat√™ncia.  Ele cont√©m um pequeno subconjunto do estado fundamental.  <i>O estado de lat√™ncia</i> n√£o <i>√©</i> sagrado e simplesmente apresenta uma imagem de como o estado do jogo ser√° no futuro, com base nas <i>a√ß√µes de entrada</i> introduzidas pelo jogador. <br><br>  Para fazer isso, armazenamos uma c√≥pia das <i>a√ß√µes de entrada</i> criadas na fila de atraso. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gf/m4/bo/gfm4bo81-iluah40eus3cxjxvjm.png"></div><br>  Ou seja, no final do processo no lado do cliente, a imagem se parece com isso: <br><br><ol><li>  Aplique as <i>a√ß√µes de entrada de</i> todos os jogadores ao estado do <i>jogo,</i> pois essas a√ß√µes de entrada foram recebidas do servidor. </li><li>  Removemos da fila de atrasos todas as <i>a√ß√µes de entrada</i> que, de acordo com o servidor, j√° foram aplicadas ao <i>estado do jogo</i> . </li><li>  Exclua o <i>estado de lat√™ncia</i> e redefina-o para que fique exatamente igual ao <i>estado</i> do <i>jogo</i> . </li><li>  Aplique todas as a√ß√µes da fila de atraso ao <i>estado de lat√™ncia</i> . </li><li>  Com base nos dados do <i>estado</i> do <i>jogo</i> e do <i>estado da lat√™ncia,</i> renderizamos o jogo para o jogador. </li></ol><br>  Tudo isso se repete em todas as medidas. <br><br>  Muito complicado?  N√£o relaxe, isso n√£o √© tudo.  Para compensar as conex√µes n√£o confi√°veis ‚Äã‚Äãda Internet, criamos dois mecanismos: <br><br><ul><li>  Carrapatos perdidos: quando o servidor decide que as <i>a√ß√µes de entrada</i> ser√£o executadas no ritmo do jogo, se n√£o receber as <i>a√ß√µes de entrada de</i> um jogador (por exemplo, devido ao aumento no atraso), n√£o esperar√°, mas dir√° a esse cliente: "N√£o levei em conta suas <i>a√ß√µes de entrada</i> , tentarei adicion√°-las √† pr√≥xima medida. "  Isso √© feito para que, devido a problemas com a conex√£o (ou com o computador) de um jogador, a atualiza√ß√£o do mapa n√£o diminua a velocidade para todos os outros.  Vale ressaltar que as <i>a√ß√µes de entrada</i> n√£o <i>s√£o</i> ignoradas, mas simplesmente adiadas. </li><li>  Atraso de ida e volta: o servidor est√° tentando adivinhar qual √© o atraso de ida e volta entre o cliente e o servidor para cada cliente.  A cada 5 segundos, se necess√°rio, ele discute com o cliente um novo atraso (dependendo de como a conex√£o se comportou no passado) e aumenta ou diminui o atraso na transfer√™ncia de dados. </li></ul><br>  Por si mesmos, esses mecanismos s√£o bastante simples, mas quando s√£o usados ‚Äã‚Äãjuntos (o que geralmente acontece com problemas de conex√£o), a l√≥gica do c√≥digo se torna dif√≠cil de gerenciar e com v√°rios casos lim√≠trofes.  Al√©m disso, quando esses mecanismos entram em <i>a√ß√£o</i> , o servidor e a fila de atraso devem implementar corretamente uma <i>A√ß√£o de Entrada</i> especial chamada <i>StopMovementInTheNextTick</i> .  Devido a isso, com problemas na conex√£o, o personagem n√£o corre sozinho (por exemplo, sob o trem). <br><br>  Agora voc√™ precisa explicar como a sele√ß√£o de entidades funciona.  Um dos tipos de <i>a√ß√£o</i> de <i>entrada</i> passados ‚Äã‚Äã√© a altera√ß√£o no estado da sele√ß√£o da entidade.  Diz a todos que entidade o jogador passou o mouse.  Como voc√™ pode entender, essa √© uma das a√ß√µes de entrada mais frequentes enviadas pelos clientes; portanto, para economizar largura de banda, a otimizamos para ocupar o m√≠nimo de espa√ßo poss√≠vel.  Isso √© implementado da seguinte maneira: ao escolher cada entidade, em vez de preservar as coordenadas absolutas e de alta precis√£o do mapa, o jogo ret√©m um deslocamento relativo de baixa corrente da escolha anterior.  Isso funciona bem porque a sele√ß√£o do mouse geralmente acontece muito perto da sele√ß√£o anterior.  Por esse motivo, surgem dois requisitos importantes: as <i>a√ß√µes de entrada</i> nunca devem ser ignoradas e devem ser executadas na ordem correta.  Esses requisitos s√£o atendidos para o <i>estado do jogo</i> .  Mas como a tarefa do <i>estado Latency</i> √© "parecer bom o suficiente" para o player, ele n√£o fica satisfeito com o atraso.  <i>O estado de lat√™ncia</i> n√£o leva em considera√ß√£o <a href="">muitos casos fronteiri√ßos</a> associados a pular ciclos e alterar atrasos de ida e volta. <br><br>  Voc√™ j√° pode adivinhar para onde est√° indo tudo.  Por fim, come√ßamos a ver as causas do problema de megapackage.  A raiz do problema √© que, ao decidir se deve passar a a√ß√£o da altera√ß√£o de sele√ß√£o, a l√≥gica de sele√ß√£o da entidade depende do <i>Estado de Lat√™ncia</i> , e esse estado nem sempre cont√©m as informa√ß√µes corretas.  Portanto, um megapackage √© gerado assim: <br><br><ol><li>  O player tem um problema de conex√£o. </li><li>  Os mecanismos para pular os rel√≥gios e regular o atraso de ida e volta entram em a√ß√£o. </li><li>  Atrasos no estado da fila n√£o levam em considera√ß√£o esses mecanismos.  Isso faz com que algumas a√ß√µes sejam exclu√≠das prematuramente ou executadas na ordem errada, resultando em um <i>estado de lat√™ncia</i> incorreto. </li><li>  O jogador tem um problema com a conex√£o e ele, para conversar com o servidor, simula at√© 400 ciclos de clock. </li><li>  Em cada ciclo do rel√≥gio, uma nova a√ß√£o, alterando a sele√ß√£o de uma entidade, √© gerada e preparada para o envio ao servidor. </li><li>  O cliente envia ao servidor um megafone de mais de 400 altera√ß√µes na escolha de entidades (e com outras a√ß√µes: o estado de tiro, caminhada, etc., tamb√©m sofreram com esse problema). </li><li>  O servidor recebe 400 a√ß√µes de entrada.  Como ele n√£o tem permiss√£o para pular uma √∫nica a√ß√£o de entrada, ele ordena a todos os clientes que executem essas a√ß√µes e as envia pela rede. </li></ol><br>  A ironia √© que um mecanismo projetado para economizar largura de banda do canal criou enormes pacotes de rede como resultado. <br><br>  Resolvemos esse problema corrigindo todos os casos lim√≠trofes de atualiza√ß√£o e suporte √† fila de atrasos.  Embora demorasse um pouco, no final valia a pena implementar tudo corretamente e n√£o depender de hacks r√°pidos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt466135/">https://habr.com/ru/post/pt466135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt466113/index.html">Definindo codifica√ß√£o de texto no PHP em vez de mb_detect_encoding</a></li>
<li><a href="../pt466121/index.html">Gera√ß√£o de som em microcontroladores AVR usando o m√©todo de tabela de ondas com suporte a polifonia</a></li>
<li><a href="../pt466123/index.html">Crescimento. Peso. Tr√™s vizinhos</a></li>
<li><a href="../pt466127/index.html">Kola NPP ou em p√© no reator</a></li>
<li><a href="../pt466129/index.html">Efici√™ncia do transporte em gasolina, baterias e hidrog√™nio</a></li>
<li><a href="../pt466137/index.html">System.IO. Pipelines - uma ferramenta pouco conhecida para os amantes de alto desempenho</a></li>
<li><a href="../pt466139/index.html">Tecnologia aplicada nas ru√≠nas da febre do blockchain ou nos benef√≠cios pr√°ticos da aloca√ß√£o de recursos</a></li>
<li><a href="../pt466143/index.html">Como criamos c√≥digo de papel√£o ou a vers√£o Scratch do jogo de tabuleiro Golem Battle</a></li>
<li><a href="../pt466147/index.html">Gerenciador de exibi√ß√£o de dados reativa. 1. Introdu√ß√£o</a></li>
<li><a href="../pt466149/index.html">Criando um s√≠mbolo de conector com texto "din√¢mico" no OrCAD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>