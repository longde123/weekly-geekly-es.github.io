<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê∑ üÜî üçä Tutoriel d'arri√®re-plan Android. Partie 5: Coroutines √† Kotlin üöù üêº ü¶ï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√éle Kotlin 

 Textes pr√©c√©dents de cette s√©rie: sur AsyncTask , sur Loaders , sur Executors et EventBus , sur RxJava . 

 Cette heure est donc venue. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tutoriel d'arri√®re-plan Android. Partie 5: Coroutines √† Kotlin</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/415335/"><img src="https://habrastorage.org/webt/r3/h-/kd/r3h-kdmudutyx6g2zcisi4vly7c.png"><br>  <sup>√éle Kotlin</sup> <br><br>  <i>Textes pr√©c√©dents de cette s√©rie: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur AsyncTask</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur Loaders</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur Executors et EventBus</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur RxJava</a> .</i> <br><br>  Cette heure est donc venue.  C'est l'article pour lequel toute la s√©rie a √©t√© √©crite: une explication du fonctionnement de la nouvelle approche ¬´sous le capot¬ª.  Si vous ne savez pas encore comment l‚Äôutiliser, voici quelques liens utiles pour vous aider √† d√©marrer: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Page sur le site officiel</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Article de blog sur les recettes Coroutine Android</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rapport de Roman Elizarov</a> </li></ul><br>  Et apr√®s avoir ma√Ætris√© les coroutines, vous pouvez vous demander ce qui a permis √† Kotlin de fournir cette opportunit√© et comment cela fonctionne.  Veuillez noter qu'ici, nous nous concentrerons uniquement sur l'√©tape de compilation: vous pouvez √©crire un article s√©par√© sur l'ex√©cution. <br><a name="habracut"></a><br>  La premi√®re chose que nous devons comprendre, c'est que dans le corpus, il n'existe en fait aucune coroutine.  Le compilateur transforme la fonction avec le modificateur de suspension en fonction avec le param√®tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Continuation</a> .  Cette interface a deux m√©thodes: <br><br><pre><code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(value: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resumeWithException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(exception: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Throwable</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br>  Le type T est le type de retour de votre fonction de suspension d'origine.  Et voici ce qui se passe r√©ellement: cette fonction est ex√©cut√©e dans un certain thread (patience, nous y arrivons √©galement), et le r√©sultat est pass√© √† la fonction de reprise de cette suite, dans le contexte de laquelle la fonction de suspension a √©t√© appel√©e.  Si la fonction ne re√ßoit pas le r√©sultat et l√®ve une exception, resumeWithException est lev√©e, lan√ßant une erreur au code appelant. <br><br>  D'accord, mais d'o√π vient la suite?  Bien s√ªr, du constructeur Corutin!  Regardons le code qui cr√©e une coroutine, par exemple, lancez: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">actual</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">launch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineContext</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = DefaultDispatcher, start: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineStart</span></span></span></span><span class="hljs-function"><span class="hljs-params"> = CoroutineStart.DEFAULT, parent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Job</span></span></span></span><span class="hljs-function"><span class="hljs-params">? = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, block: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">suspend</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CoroutineScope</span></span></span></span><span class="hljs-function"><span class="hljs-params">.()</span></span></span></span> -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span> ): Job { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newContext = newCoroutineContext(context, parent) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> coroutine = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (start.isLazy) LazyStandaloneCoroutine(newContext, block) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> StandaloneCoroutine(newContext, active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>) coroutine.start(start, coroutine, block) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> coroutine }</code> </pre><br>  Ici, le g√©n√©rateur cr√©e une coroutine - une instance de la classe AbstractCoroutine, qui, √† son tour, impl√©mente l'interface Continuation.  La m√©thode de d√©marrage appartient √† l'interface Job.  Mais trouver la d√©finition de la m√©thode de d√©marrage est tr√®s difficile.  Mais nous pouvons venir ici de l'autre c√¥t√©.  Un lecteur attentif a d√©j√† remarqu√© que le premier argument de la fonction de lancement est le CoroutineContext, et il est d√©fini sur DefaultDispatcher par d√©faut.  Les r√©partiteurs sont des classes qui contr√¥lent l'ex√©cution des coroutines, ils sont donc tr√®s importants pour comprendre ce qui se passe.  Regardons la d√©claration DefaultDispatcher: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">actual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> DefaultDispatcher: CoroutineDispatcher = CommonPool</code> </pre><br>  Donc, en fait, c'est CommonPool, bien que les docks java nous disent que cela peut changer.  Qu'est-ce que CommonPool? <br><br>  Il s'agit d'un gestionnaire de coroutine utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ForkJoinPool</a> comme impl√©mentation d'ExecutorService.  Oui, c'est le cas: au final, toutes vos coroutines lambda ne sont que Runnable, pi√©g√©es dans Executor avec un tas de transformations d√©licates.  Mais le diable, comme toujours, est dans les d√©tails. <br><br><img src="https://habrastorage.org/webt/jh/yg/wr/jhygwrz-zofdvbpe11tbvvatsqi.jpeg"><br>  <sup>Fourchette?</sup>  <sup>Ou rejoindre?</sup> <br><br>  √Ä en juger par les r√©sultats de l'enqu√™te sur mon twitter, je dois ici expliquer bri√®vement ce qu'est le FJP :) <br><br><div class="oembed"><twitter-widget class="twitter-tweet twitter-tweet-rendered" id="twitter-widget-0" style="position: static; visibility: visible; display: block; transform: rotate(0deg); width: 500px; margin: 10px auto; max-width: 100%; min-width: 220px;" data-tweet-id="991950848996597760"></twitter-widget><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></div><br>  Tout d'abord, ForkJoinPool est un ex√©cuteur moderne cr√©√© pour √™tre utilis√© avec les flux parall√®les Java 8. La t√¢che d'origine √©tait un parall√©lisme efficace lors de l'utilisation de l'API Stream, ce qui signifie essentiellement de diviser les flux pour traiter une partie des donn√©es, puis de les combiner lorsque toutes les donn√©es ont √©t√© trait√©es.  Pour simplifier, imaginez que vous disposez du code suivant: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">IntStream</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.range</span></span>(1, 1_000_000) <span class="hljs-selector-class"><span class="hljs-selector-class">.parallel</span></span>() <span class="hljs-selector-class"><span class="hljs-selector-class">.sum</span></span>()</code> </pre><br>  La quantit√© d'un tel flux ne sera pas calcul√©e dans un flux, √† la place, ForkJoinPool divisera r√©cursivement la plage en parties (d'abord en deux parties de 500 000, puis chacune en 250 000, etc.), calculera la somme de chaque partie et combinera les r√©sultats en un seul montant.  Voici une visualisation d'un tel processus: <br><br><img src="https://habrastorage.org/webt/15/yb/uk/15ybukvbskzmzddp9lytwarsbvy.jpeg"><br>  <sup>Les threads sont divis√©s pour diff√©rentes t√¢ches et fusionn√©s √† nouveau apr√®s l'ach√®vement</sup> <br><br>  L'efficacit√© de FJP est bas√©e sur l'algorithme de ¬´vol de travail¬ª: lorsqu'un thread particulier manque de t√¢ches, il va dans les files d'attente d'autres threads de pool et vole leurs t√¢ches.  Pour une meilleure compr√©hension, vous pouvez voir le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport d'</a> Alexei Shipilev ou regarder une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©sentation</a> . <br><br>  Eh bien, nous avons r√©alis√© ce que font nos coroutines!  Mais comment finissent-ils l√†-bas? <br><br>  Cela se produit dans la m√©thode de r√©partition CommonPool #: <br><br><pre> <code class="hljs css">_<span class="hljs-selector-tag"><span class="hljs-selector-tag">pool</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.execute</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">timeSource</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.trackTask</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">block</span></span>))</code> </pre><br>  La m√©thode d'exp√©dition est appel√©e √† partir de la m√©thode resume (Value: T) dans DispatchedContinuation.  Cela semble familier!  Nous nous souvenons que Continuation est une interface impl√©ment√©e dans AbstractCoroutine.  Mais comment sont-ils li√©s? <br><br>  L'astuce est √† l'int√©rieur de la classe CoroutineDispatcher.  Il impl√©mente l'interface ContinuationInterceptor comme suit: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> actual <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> fun &lt;T&gt; interceptContinuation(continuation: Continuation&lt;T&gt;): Continuation&lt;T&gt; = DispatchedContinuation(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, continuation)</code> </pre><br>  Tu vois?  Vous fournissez un bloc simple √† la corutine du g√©n√©rateur.  Vous n'avez pas besoin d'impl√©menter d'interfaces dont vous ne voulez rien savoir.  La biblioth√®que coroutine s'occupe de tout cela.  Elle est <br>  intercepte l'ex√©cution, remplace la continuation par DispatchedContinuation et l'envoie √† l'ex√©cuteur, ce qui garantit l'ex√©cution la plus efficace de votre code. <br><br>  Maintenant, la seule chose dont nous avons besoin est de savoir comment la r√©partition est appel√©e √† partir de la m√©thode start.  Comblons cette lacune.  La m√©thode de reprise est appel√©e depuis startCoroutine dans la fonction d'extension du bloc: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;R, T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">suspend</span></span></span></span><span class="hljs-function"><span class="hljs-params"> R.()</span></span></span></span> -&gt; T).startCoroutine( receiver: R, completion: Continuation&lt;T&gt; ) { createCoroutineUnchecked(receiver, completion).resume(<span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span>) }</code> </pre><br>  Et startCoroutine, √† son tour, est appel√© par l'op√©rateur "()" dans l'√©num√©ration CoroutineStart.  Votre g√©n√©rateur l'accepte comme deuxi√®me param√®tre, et la valeur par d√©faut est CoroutineStart.DEFAULT.  C'est tout! <br><br>  C'est la raison pour laquelle j'admire l'approche de la corutine: ce n'est pas seulement une syntaxe spectaculaire, mais aussi une impl√©mentation brillante. <br><br><blockquote>  Et pour ceux qui ont lu jusqu'au bout, ils obtiennent en exclusivit√©: une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o de</a> mon reportage ¬´Le violoniste n'est pas n√©cessaire: on refuse RxJava en faveur de la coroutine √† Kotlin¬ª de la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mobius</a> .  Profitez :) <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415335/">https://habr.com/ru/post/fr415335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415323/index.html">Projets de fin d'√©tudes des dipl√¥m√©s du Technoprojet, printemps 2018</a></li>
<li><a href="../fr415327/index.html">Le th√©or√®me de Pythagore a √©t√© utilis√© par les constructeurs de Stonehenge 2000 ans avant la naissance de Pythagore lui-m√™me</a></li>
<li><a href="../fr415329/index.html">Toute la v√©rit√© sur RTOS de Colin Walls. Article # 3. T√¢ches et planification</a></li>
<li><a href="../fr415331/index.html">Des imprimantes de construction pour imprimeries de 5-6 √©tages sont produites √† Yaroslavl</a></li>
<li><a href="../fr415333/index.html">Arduino - √©metteur de diffusion AM micropuissant</a></li>
<li><a href="../fr415337/index.html">Comment les canaux Pusher ont d√©j√† livr√© 10 000 000 000 000 de messages</a></li>
<li><a href="../fr415341/index.html">Cours d'administration PostgreSQL</a></li>
<li><a href="../fr415343/index.html"># 2HACKATON pour les jeunes professionnels √† Perm</a></li>
<li><a href="../fr415345/index.html">Conseils pour d√©cider de devenir d√©veloppeur iOS</a></li>
<li><a href="../fr415347/index.html">2. Bas√© sur Meyers ¬´C ++ efficace et moderne¬ª - d√©tails de l'inf√©rence de type de mod√®le pour les tableaux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>