<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍧 🏵️ 👩🏽‍🤝‍👨🏾 Python3. Otomatisasi konfigurasi peralatan jaringan multi-vendor 👩🏽‍🚒 👨‍👩‍👦‍👦 🛀🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kata Pengantar 
 Hari baik untuk semua! 

 Saya bekerja sebagai insinyur jaringan untuk operator telekomunikasi besar, dan di bawah kendali saya ada b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python3. Otomatisasi konfigurasi peralatan jaringan multi-vendor</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415453/"><h4>  Kata Pengantar </h4><br>  Hari baik untuk semua! <br><br>  Saya bekerja sebagai insinyur jaringan untuk operator telekomunikasi besar, dan di bawah kendali saya ada banyak kebun binatang dari berbagai peralatan jaringan, tetapi kita akan berbicara tentang sakelar akses. <br><br>  Artikel ini bukan panduan untuk bertindak, ini bukan satu-satunya solusi dan jelas tidak berpura-pura menjadi skrip nominasi tahun ini, tapi saya ingin membagikan kreasi ini, dan mungkin itu akan bermanfaat bagi seseorang. <br><br>  Artikel ini akan memberikan blok kode di bawah spoiler, dan di bawahnya akan ada deskripsi dengan kliping dan penjelasan mengapa begitu dan untuk apa. <br><br><h4>  Tantangan </h4><br>  Gunakan python3 secara khusus.  Script harus bisa masuk ke switch dari daftar, menentukan jenis vendor, memberikan perintah yang diperlukan, log. <br><br><h4>  Sebenarnya bagaimana saya sampai pada ini </h4><br>  Dihadapkan dengan masalah kecil mengubah konfigurasi pada sejumlah besar switch, saya akan segera melakukan reservasi tentang sistem administrasi terpusat untuk peralatan jaringan yang kami miliki, banyak perkembangan rekan-rekan saya dalam bentuk skrip untuk memfasilitasi pekerjaan manual juga tersedia, terutama bash, perl. <br><br>  Tetapi bagi saya itu penting untuk melakukan sesuatu yang berbeda, karena  Saya mulai belajar python baru-baru ini dan saya perlu meningkatkan keterampilan saya dalam pemrograman, dan alat saya akan terlihat seperti palu (mudah digunakan, dan mudah dirawat).  Jika minat masih ada maka saya minta kucing. <br><a name="habracut"></a><br>  Googling dan tidak menemukan solusi yang tepat (seolah-olah di forum pertanyaan ini dimunculkan, tetapi semuanya salah di sana), saya memutuskan untuk mulai menulis skrip saya sendiri. <br><br>  Kami memiliki sakelar berikut: <br><br><ul><li>  Raisecom </li><li>  Qtech rev.  1.0 </li><li>  Qtech rev.  2.0 (perbedaan dalam sintaks) </li><li>  Eltex </li><li>  D-link </li><li>  Spawn Frankenstein beralih dengan moncong dari Qtech rev 1.0, dan besi dari Raisecom kita akan menyebutnya ROS </li></ul><br>  Pertama, impor perpustakaan yang diperlukan: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> telnetlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> getpass <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pexpect <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telnetlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Telnet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess</code> </pre> <br>  Awalnya, kami menjelaskan fungsi definisi vendor, karena  memutuskan untuk menggunakan dua metode: <br><br>  1) Anggap vendor seperti apa (atas undangan untuk memasukkan login) seperti yang saya perhatikan berbeda untuk semua orang: Qtech (login :), Raisecom dan ROS (Login :), Eltex (Nama Pengguna :), D-link (Nama Pengguna)). <br><br>  2) setelah masuk - pastikan bahwa item pertama selesai tanpa kesalahan, dan untuk identifikasi yang lebih baik dari switch mana kita berada. <br><br><div class="spoiler">  <b class="spoiler_title">Fungsi</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">who_is</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#   global ver_status global sab_versus global versus sab_versus='' ver_status='' versus='' #  a = 'Serial No.:1405' # #qtech rev1 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0 parser=open('servers_&amp;_log/ver.txt', 'r') #  for line in parser.readlines(): line1 = line.find(a) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0' if line4 != -1: ver_status='d-link' if line5 != -1: ver_status='raisecom' if line6 != -1: ver_status='raisecom-qtech' sab_versus=1 if line7 !=-1: ver_status='eltex' if line8 !=-1: ver_status='eltex' if line10 != -1: ver_status = 'qtech_rev_2.0' time.sleep(0.1) parser.close() os.remove('servers_&amp;_log/ver.txt') return ver_status,sab_versus</span></span></code> </pre> <br></div></div><br>  Seluruh fungsi berada di bawah spoiler.  Kami mendeklarasikan variabel global yang akan terlihat oleh seluruh skrip: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> ver_status <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> sab_versus <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> versus</code> </pre> <br>  variabel a, d, f, h, j, k, n menyimpan kata kunci yang dengannya kita selanjutnya akan menentukan model switch. <br><br><pre> <code class="python hljs">a = <span class="hljs-string"><span class="hljs-string">'Serial No.:1405'</span></span> <span class="hljs-comment"><span class="hljs-comment"># #qtech rev1 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0</span></span></code> </pre> <br>  Setelah membuka file ver.txt, kami membacanya baris demi baris dan memeriksa entri dengan kata kunci, karena  fungsi find () mengembalikan -1 jika hasil ini negatif, dan kami akan membangun cabang. <br><br><pre> <code class="python hljs">parser=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/ver.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#  for line in parser.readlines(): line1 = line.find(a) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0'</span></span></code> </pre> <br>  ... <br><br>  Saya memberikan contoh bagian dari kode, sisanya di bawah spoiler di atas. <br><br>  Isi file ini akan dijelaskan di bawah ini.  Setelah semua manipulasi dan mendefinisikan vendor, hapus file ver.txt. <br><br><div class="spoiler">  <b class="spoiler_title">Deklarasi variabel utama, badan loop utama</b> <div class="spoiler_text"><pre> <code class="python hljs">user=<span class="hljs-string"><span class="hljs-string">'user'</span></span> password=<span class="hljs-string"><span class="hljs-string">'password'</span></span> komm=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komm.txt'</span></span>) log=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>,<span class="hljs-string"><span class="hljs-string">'a'</span></span>) <span class="hljs-comment"><span class="hljs-comment">######### counter_komm=0 counter_dlink=0 counter_qtech=0 counter_eltex=0 counter_raisecom=0 counter_ROS=0 counter_qtech1_0=0 counter_qtech2_0=0 ########## for host in komm.readlines(): print('connect....',host) vend = '' response = os.system('ping -c 1 ' + host) verinfo = open('servers_&amp;_log/ver.txt', 'w') ver_status = '' sab_versus = '' if response == 0: telnet = pexpect.spawn('telnet ' + host,timeout=40) vend = telnet.expect(['login:', 'Login:', 'User Name:', 'Username']) telnet.close() tn = Telnet(host.replace('\n', ''), 23,30) try: print('Ok'+'\n') tn.read_until(b':') tn.write((user +'\n').encode('ascii')) tn.read_until(b':') tn.write((password + '\n').encode('ascii')) time.sleep(3) tn.read_until(b'#',timeout=20) except: print('connection refused' + '\n') f = open('servers_&amp;_log/log.txt', 'a') print(host, 'connection refused', file=log) print('#' * 100, host, file=log) ###   ######################################################### if vend == 0:#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ...</span></span></code> </pre> <br></div></div><br>  Saya memutuskan untuk tidak repot dan mengatur variabel dengan login dan kata sandi di dalam tubuh, saya tahu itu bukan keamanan, saya sedang mengusahakannya. <br><br>  Buka file untuk log dan daftar sakelar <br><br><pre> <code class="python hljs">komm=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komm.txt'</span></span>) log=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>,<span class="hljs-string"><span class="hljs-string">'a'</span></span>)</code> </pre> <br>  Setelah kita menggunakan for loop, bacalah baris dengan alamat ip switch <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> host <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komm.readlines(): print(<span class="hljs-string"><span class="hljs-string">'connect....'</span></span>,host) vend = <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre><br>  Kami memeriksa ketersediaannya <br><br><pre> <code class="python hljs">response = os.system(<span class="hljs-string"><span class="hljs-string">'ping -c 1 '</span></span> + host)</code> </pre> <br>  Jika dapat diakses menggunakan pexpect library, kami berusaha untuk terhubung melalui telnet di sini pada iterasi ini dan cek pertama pada undangan terjadi, yang saya tulis di awal. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> response == <span class="hljs-number"><span class="hljs-number">0</span></span>: telnet = pexpect.spawn(<span class="hljs-string"><span class="hljs-string">'telnet '</span></span> + host,timeout=<span class="hljs-number"><span class="hljs-number">40</span></span>) vend = telnet.expect([<span class="hljs-string"><span class="hljs-string">'login:'</span></span>, <span class="hljs-string"><span class="hljs-string">'Login:'</span></span>, <span class="hljs-string"><span class="hljs-string">'User Name:'</span></span>, <span class="hljs-string"><span class="hljs-string">'Username'</span></span>]) telnet.close() tn = Telnet(host.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">30</span></span>)</code> </pre><br>  Variabel vend akan mendapatkan nilai dari 0 hingga 3 inklusif, dan tergantung pada prompt login yang dilihatnya, cabang selanjutnya akan dibentuk. <br><br>  Dari kode ini, pembaca yang memperhatikan dapat melihat bahwa saya membuat koneksi ke sakelar dan segera menutup koneksi, dan ini tidak biasa.  Saya mencoba menggunakan hanya perpustakaan telnetlib, tetapi pada tes pertama, skrip secara berkala macet dan jatuh karena batas waktu, dan kruk ini sangat membantu. <br><br>  Setelah menutup koneksi, kami melakukan koneksi ulang hanya menggunakan telnetlib library. <br><br>  Untuk menghindari kesalahan, kami telah memeriksa di atas bahwa sakelar dapat diakses, dan mengecualikan gangguan skrip selama operasi karena satu sakelar idle, bungkus semuanya dalam percobaan kecuali blok. <br><br>  Ada kasus berulang ketika dari 100 switch satu tidak membiarkan dirinya masuk. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(<span class="hljs-string"><span class="hljs-string">'Ok'</span></span>+<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>) tn.write((user +<span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>) tn.write((password + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>,timeout=<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: print(<span class="hljs-string"><span class="hljs-string">'connection refused'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) f = open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/log.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>) print(host, <span class="hljs-string"><span class="hljs-string">'connection refused'</span></span>, file=log) print(<span class="hljs-string"><span class="hljs-string">'#'</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span>, host, file=log)</code> </pre> <br>  ... <br>  Jika semuanya baik-baik saja dan kita terhubung, maka kita perlu memasukkan nama pengguna dan kata sandi, <br>  kami tahu pasti bahwa setiap tanda titik dua menggunakan titik dua. <br><br>  Jadi kami menunggunya <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>)</code> </pre> <br>  Setelah kita masuk login <br><br><pre> <code class="python hljs">tn.write((user +<span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br>  Menunggu titik dua dari kata sandi <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b':'</span></span>)</code> </pre> <br>  Masukkan kata sandi <br><br><pre> <code class="python hljs">tn.write((password + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br>  Dan kita menunggu 3 detik (jeda, kalau tidak kita telah melakukan begitu banyak pekerjaan) <br><br><pre> <code class="python hljs">time.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>)</code> </pre> <br>  Setelah menunggu undangan <br><br><pre> <code class="python hljs">tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>,timeout=<span class="hljs-number"><span class="hljs-number">20</span></span>)</code> </pre> <br>  Di sini, pada tahap ini, kita beralih ke tingkat kedua untuk memeriksa vendor. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vend == <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-comment"><span class="hljs-comment">#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is()</span></span></code> </pre> <br>  Karena  kami berasumsi bahwa kami sampai di Qtech, dan jika Anda membaca dengan seksama, maka di kebun binatang kami ada dua versi qtech yang berbeda dalam sintaksisnya, kami masih perlu berdamai. <br><br>  Oleh karena itu, kami memberikan perintah show ver, taruh semua output di file ver.txt <br>  dan panggil prosedur who_is (), yang saya jelaskan di atas.  Tim acara ver bersifat universal untuk semua Qtech, Raisecom, Eltex, <br><br>  Sayangnya, D-link tidak mengerti dan dia perlu mengatakan show swich, tapi kami pintar dan tidak sia-sia memperkenalkan iterasi dengan definisi yang seharusnya dari vendor. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> vend == <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-comment"><span class="hljs-comment">#   D-link tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is()</span></span></code> </pre><br>  Jadi segera, sebuah komentar kecil setelah memasuki show swich, switch menampilkan informasi yang tidak lengkap dan menunggu pengguna untuk menekan tombol apa saja untuk output lebih lanjut, dan oleh karena itu kami kemudian mengirim karakter "a" untuk menampilkan informasi lengkap. <br><br><pre> <code class="python hljs">tn.write((<span class="hljs-string"><span class="hljs-string">'a'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br>  Untuk menghindari ini, Anda dapat mematikan clipadding <br><br>  Di sinilah verifikasi vendor berakhir dan dengan probabilitas 99% kami dapat mengasumsikan bahwa kami telah mengidentifikasi model switch dengan benar dan kami dapat melanjutkan dengan konfigurasi. <br><br>  Untuk setiap sakelar, kami memiliki file terpisah dengan sekumpulan perintah. <br><br><div class="spoiler">  <b class="spoiler_title">Blok konfigurasi</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span><span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> ver_status == <span class="hljs-string"><span class="hljs-string">'qtech_rev_1.0'</span></span>: tn.write((<span class="hljs-string"><span class="hljs-string">'show ver'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print((tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>).decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)), file=log) counter_qtech1_0+=<span class="hljs-number"><span class="hljs-number">1</span></span> komand_qtech1_0=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komand_qtech_ver1.0.txt'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> kommand <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komand_qtech1_0.readlines(): tn.write((kommand.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) tn.write((<span class="hljs-string"><span class="hljs-string">'exit'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print(tn.read_all().decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>), file=log) print(<span class="hljs-string"><span class="hljs-string">'   qtech1.0'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Qtech rev1.0 '</span></span> + host, file=log) print(<span class="hljs-string"><span class="hljs-string">'#'</span></span> * <span class="hljs-number"><span class="hljs-number">100</span></span>, file=log) <span class="hljs-comment"><span class="hljs-comment">################################################################################ elif ver_status == 'qtech_rev_2.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech2_0+=1 komand_qtech2_0=open('servers_&amp;_log/komand_qtech_ver2.0.txt') print('   qtech2.0') for kommand in komand_qtech2_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('Qtech rev2.0 ' + host, file=log) print('#' * 100, file=log) ...</span></span></code> </pre><br></div></div><br>  Setelah fungsi berhasil dan mengembalikan variabel ver_status, kita dapat melanjutkan bekerja dengan percabangan, karena  kami tahu persis saklar mana yang saat ini ada di telepon. <br>  Pertama-tama, kita berikan perintah switch show ver dan tulis outputnya ke log (tentang d-link, ingat kita berikan itu perintah sh sw) <br><br><pre> <code class="python hljs">tn.write((<span class="hljs-string"><span class="hljs-string">'show ver'</span></span> + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)) print((tn.read_until(<span class="hljs-string"><span class="hljs-string">b'#'</span></span>).decode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>)), file=log)</code> </pre> <br>  Pastikan untuk menyimpan penghitung untuk mengidentifikasi ketidaksesuaian. <br><pre> <code class="python hljs">counter_qtech1_0+=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Kami membuka file dengan perintah <br><pre> <code class="python hljs">komand_qtech1_0=open(<span class="hljs-string"><span class="hljs-string">'servers_&amp;_log/komand_qtech_ver1.0.txt'</span></span>)</code> </pre> <br>  Urutan perintah dalam file harus sama dengan yang dimasukkan oleh administrator secara manual <br><br>  Contoh: <br><br> <code>conf <br> vlan 2525 <br> name SPD <br> int ethe 1/1 <br> sw mode access <br> sw acc vl 2525 <br> exit <br> exit <br> save <br> y <br></code> <br>  Kemudian semuanya sesuai dengan skenario - kita membaca file sampai garis berakhir dan kita jalankan <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> kommand <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> komand_qtech1_0.readlines(): tn.write((kommand.replace(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>))</code> </pre> <br>  Setelah keluar dari loop, kami memberi tahu switch untuk keluar dan membaca semua output ke file, dan kami hanya melakukannya dengan qtech1.0, karena  kadang-kadang skrip bertahan untuk mengantisipasi sesuatu dan dengan saklar ini, agar tidak membuat keributan, solusi ini bagi saya tampak lebih elegan. <br><br>  Setelah sakelar dikonfigurasi, kami menambah penghitung total dengan satu. <br><br><pre> <code class="python hljs">counter_komm+=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Dan kita mulai dari awal, baca baris berikutnya dari file dengan sakelar, tentukan modelnya, dan buat konfigurasi. <br><br>  Setelah keluar dari siklus utama, Anda perlu membuat ringkasan dari pekerjaan yang dilakukan, <br>  di akhir log, kami memasukkan semua model yang kami proses dan tanggal wajib, yah, bagaimana bisa tanpa itu. <br><br><pre> <code class="python hljs">print(<span class="hljs-string"><span class="hljs-string">'\n\n\n : '</span></span>, counter_komm,file=log) print(<span class="hljs-string"><span class="hljs-string">'\n\nD-link:'</span></span>, counter_dlink,<span class="hljs-string"><span class="hljs-string">'\nQtech ver1.0:'</span></span>, counter_qtech1_0,<span class="hljs-string"><span class="hljs-string">'\nROS:'</span></span>, counter_ROS,<span class="hljs-string"><span class="hljs-string">'\nRaisecom:'</span></span>,counter_raisecom,<span class="hljs-string"><span class="hljs-string">'\nEltex:'</span></span>, counter_eltex,<span class="hljs-string"><span class="hljs-string">'\nQtech ver2.0 :'</span></span>, counter_qtech2_0,file=log) print(<span class="hljs-string"><span class="hljs-string">'\n: '</span></span>, datetime.datetime.now().isoformat(),<span class="hljs-string"><span class="hljs-string">'\n'</span></span>, <span class="hljs-string"><span class="hljs-string">'#'</span></span>*<span class="hljs-number"><span class="hljs-number">100</span></span>,<span class="hljs-string"><span class="hljs-string">'\n\n\n\n\n'</span></span>,file=log) verinfo.close() log.close()</code> </pre> <br>  Script ini telah berulang kali diproses dan prosesnya tidak akan berhenti di situ. <br>  Terima kasih atas perhatiannya.  Kritik konstruktif dipersilahkan. <br><br>  Semua kode di bawah spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">Kode sumber</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 #22/06/2017 17:17 import telnetlib import time import os import sys import getpass import pexpect from telnetlib import Telnet import datetime import subprocess def who_is(): #     ,      . global ver_status global sab_versus global versus sab_versus='' ver_status='' versus='' a = 'Serial No.:1405' # #qtech rev1 #b = 'Serial No.:3922' # #qtech rev2 #c = 'Serial No.:5436' # #qtech rev2 #l = 'Serial No.:16101' # #qtech rev2 d = 'Command: show switch' # #d-link f = 'Raisecom Operating System Software' # #raisecom h = 'QOS' # #raisecom-qtech j = 'MES1124M' # #eltex k = 'eltex' # #eltex n = 'Build245' #qtech2.0 parser=open('servers_&amp;_log/ver.txt', 'r') for line in parser.readlines(): line1 = line.find(a) #line2 = line.find(b) #line3 = line.find(c) line4 = line.find(d) line5 = line.find(f) line6 = line.find(h) line7 = line.find(j) line8 = line.find(k) #line9 = line.find(l) line10 = line.find(n) if line1 != -1: ver_status='qtech_rev_1.0' #if line2 != -1 or line3 != -1 or line9 !=-1: #ver_status='qtech_rev_2.0' if line4 != -1: ver_status='d-link' if line5 != -1: ver_status='raisecom' if line6 != -1: ver_status='raisecom-qtech' sab_versus=1 if line7 !=-1: ver_status='eltex' if line8 !=-1: ver_status='eltex' if line10 != -1: ver_status = 'qtech_rev_2.0' time.sleep(0.1) parser.close() os.remove('servers_&amp;_log/ver.txt') return ver_status,sab_versus user='user' password='password' komm=open('servers_&amp;_log/komm.txt') log=open('servers_&amp;_log/log.txt','a') counter_komm=0 counter_dlink=0 counter_qtech=0 counter_eltex=0 counter_raisecom=0 counter_ROS=0 # counter_qtech1_0=0 counter_qtech2_0=0 for host in komm.readlines(): print('connect....',host) vend = '' #tn = Telnet(host.replace('\n', ''), 23, 20) response = os.system('ping -c 1 ' + host) verinfo = open('servers_&amp;_log/ver.txt', 'w') ver_status = '' sab_versus = '' if response == 0: telnet = pexpect.spawn('telnet ' + host,timeout=40) vend = telnet.expect(['login:', 'Login:', 'User Name:', 'Username']) telnet.close() tn = Telnet(host.replace('\n', ''), 23,30) try: print('Ok'+'\n') tn.read_until(b':') tn.write((user +'\n').encode('ascii')) tn.read_until(b':') tn.write((password + '\n').encode('ascii')) time.sleep(3) tn.read_until(b'#',timeout=20) except: print('connection refused' + '\n') f = open('servers_&amp;_log/log.txt', 'a') print(host, 'connection refused', file=log) print('#' * 100, host, file=log) ###   ################################################################################ if vend == 0:#    Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 1: #   Raisecom,Raisecom-Qtech tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 2:#   Eltex tn.write(('show system' + '\n').encode('ascii')) tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() ################################################################################ if vend == 3:#   D-link tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=verinfo) verinfo.close() who_is() # ###  # ################################################################################ if ver_status == 'd-link': tn.read_until(b'#', timeout=20) tn.write(('show sw' + '\n').encode('ascii')) tn.write(('a' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('D-link ' + host,file=log) print('#'*100,file=log) counter_dlink+=1 ################################################################################ elif ver_status == 'qtech_rev_1.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech1_0+=1 komand_qtech1_0=open('servers_&amp;_log/komand_qtech_ver1.0.txt') for kommand in komand_qtech1_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) #print((tn.read_until(b'#').decode('ascii')), file=log) tn.write(('exit' + '\n').encode('ascii')) print(tn.read_all().decode('ascii'), file=log) print('Qtech rev1.0 ' + host, file=log) print('#' * 100, file=log) ################################################################################ elif ver_status == 'qtech_rev_2.0': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_qtech2_0+=1 komand_qtech2_0=open('servers_&amp;_log/komand_qtech_ver2.0.txt') for kommand in komand_qtech2_0.readlines(): tn.write((kommand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) time.sleep(1) print('Qtech rev2.0 ' + host, file=log) print('#' * 100, file=log) ################################################################################ elif ver_status == 'raisecom-qtech': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) raisecom_command = open('servers_&amp;_log/komand_raisecom.txt') for komand in raisecom_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('ROS '+ host,file=log) print('#'*100,file=log) counter_ROS+=1 ################################################################################ elif ver_status == 'raisecom': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) counter_raisecom+=1 raisecom_command = open('servers_&amp;_log/komand_raisecom.txt') for komand in raisecom_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print(host, ':', 'RAISECOM', file=log) print('#' * 100, host, file=log) ################################################################################ elif ver_status == 'eltex': tn.write(('show ver' + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) eltex_command=open('servers_&amp;_log/komand_eltex.txt') for komand in eltex_command.readlines(): tn.write((komand.replace('\n', '') + '\n').encode('ascii')) print((tn.read_until(b'#').decode('ascii')), file=log) print('Eltex ' + host, file=log) print('#' * 100, file=log) counter_eltex+=1 else: print('no ping') counter_komm+=1 print('\n\n\n : ', counter_komm,file=log) print('\n\nD-link:', counter_dlink,'\nQtech ver1.0:', counter_qtech1_0,'\nROS:', counter_ROS,'\nRaisecom:',counter_raisecom,'\nEltex:', counter_eltex,'\nQtech ver2.0 :', counter_qtech2_0,file=log) print('\n: ', datetime.datetime.now().isoformat(),'\n', '#'*100,'\n\n\n\n\n',file=log) verinfo.close() log.close()</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id415453/">https://habr.com/ru/post/id415453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id415441/index.html">Serangan Ransomware terhadap badan-badan pemerintah berkembang di AS</a></li>
<li><a href="../id415443/index.html">MDG dan ITMO University mengundang ke Machine Learning Summer School</a></li>
<li><a href="../id415445/index.html">Intisari acara untuk profesional SDM di bidang TI untuk Juli 2018</a></li>
<li><a href="../id415447/index.html">Rilis Token Utilitas adalah Jalan Buntu</a></li>
<li><a href="../id415451/index.html">Biostar Racing P1: Dari Mudah ke Kompleks</a></li>
<li><a href="../id415455/index.html">Tanyakan Ethan: Bisakah Kita Membuat Layar Surya Untuk Memerangi Perubahan Iklim?</a></li>
<li><a href="../id415457/index.html">Ditemukan bukti keberadaan partikel fundamental baru</a></li>
<li><a href="../id415459/index.html">Apakah orang Cina punya takhayul?</a></li>
<li><a href="../id415461/index.html">OpenAI membuat kemajuan dalam Dota 2: tim semi-profesional dikalahkan</a></li>
<li><a href="../id415463/index.html">HPE Superdome Flex: Tingkat Kinerja dan Penskalaan Baru</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>