<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≥üèΩ üò≥ ü§æ Comment impl√©menter l'analytique et ne pas casser l'application? üíÉüèΩ üçº üôéüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Je m'appelle Sosnin Ilya. Je travaille chez Lamoda d√©veloppeur Android. Je peins des boutons, saute des listes et, malheureusement, j'√©cris des ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment impl√©menter l'analytique et ne pas casser l'application?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/469761/"> Salut  Je m'appelle Sosnin Ilya.  Je travaille chez Lamoda d√©veloppeur Android.  Je peins des boutons, saute des listes et, malheureusement, j'√©cris des analyses ... <br><br>  Lamoda est une entreprise pilot√©e par les donn√©es dans laquelle toutes les d√©cisions sont prises en fonction du comportement des utilisateurs.  Nous observons d'abord et ensuite nous tirons des conclusions.  Par cons√©quent, il est facile de deviner que nous avons des analyses et nous en avons vraiment besoin. <br><br>  En d√©chiffrant mon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport par mitap Mosdroid # 18 Argon,</a> je vais vous dire comment fonctionne notre SDK et pourquoi la r√©flexion n'est pas toujours mauvaise.  Et aussi je r√©pondrai √† la question principale de ce sujet: "Comment impl√©menter l'analytique et ne pas casser l'application?". <br><img src="https://habrastorage.org/webt/l9/c8/yd/l9c8ydu-xkfvholrwahstcndmg0.png" alt="image"><br>  Pour commencer, je vais vous poser une question simple: "Comment pensez-vous, combien d'installations avons-nous sur Google Play?" <br><a name="habracut"></a><br>  10 millions d'installations! <br><img src="https://habrastorage.org/webt/ta/vl/z8/tavlz80t36oelmjkxtmamhpbwwg.png" alt="image"><br>  <i>Indicateur d√©but juillet 2019.</i> <i><br></i> <br>  En plus du fait que nous tirons des conclusions sur la base des utilisateurs, nous avons √©galement des clients internes qui sont √©galement int√©ress√©s par l'analyse. <br><img src="https://habrastorage.org/webt/u6/tk/st/u6tkstig2dyvpjlh3g3w44s305y.png" alt="image"><br><br>  Tout d'abord, le marketing a besoin d'analyses pour ses propres besoins de recherche.  La R&amp;D contr√¥le nos requ√™tes de recherche au d√©triment de celle-ci, et les produits fonctionnent sur de nouvelles fonctionnalit√©s. <br><br>  Par exemple, nous avions une fonctionnalit√© qui nous permettait de collecter l'image enti√®re dans son ensemble.  Autrement dit, vous pouvez acheter non seulement la chemise que vous avez aim√©e sur le mod√®le, mais aussi un pantalon de la m√™me image.  Nous avons d√©cid√© que, pour commencer, nous l'√©cririons pour IOS, puis nous r√©fl√©chirions √† la question de savoir si nous en avions besoin.  Ils ont √©crit, regard√© et veill√© √† ce que les utilisateurs ne l'aiment pas. <br><br><img src="https://habrastorage.org/webt/87/r6/rm/87r6rmysut2j8_r5lfdotrvufbu.png" alt="image"><br><br>  Selon vous, que devrait-on faire avec les fonctionnalit√©s dont les utilisateurs n'ont pas besoin? <br><br>  <b>Bon, jetez-les!</b>  Cela vaut particuli√®rement la peine lorsque la fonctionnalit√© est li√©e √† des services externes, car ils ont tendance √† recevoir des probl√®mes ou √† √™tre pay√©s.  C'est arriv√© avec cette fonctionnalit√©.  Nous n'avons impl√©ment√© ni Android ni Desktop, mais avons plut√¥t d√©cid√© de le faire √©voluer.  (peut-√™tre qu'un jour elle ira au prod sous une forme plus parfaite). <br><br><h2>  Quelle est la difficult√©? </h2><br>  Peu importe √† quel point cela peut sembler dr√¥le, lors de l'introduction de l'analyse, il peut √™tre <b>difficile de travailler avec les analystes eux-m√™mes</b> .  Le plus souvent, des conflits surviennent parce qu'ils demandent des donn√©es que vous ne poss√©dez pas.  Et cela se termine toujours par le fait que vous devez toujours faire glisser un tas de param√®tres √† travers 10 √©crans pour leur envoyer un petit √©v√©nement.  Et cela arrive assez souvent. <br><br>  Le deuxi√®me d√©fi consiste √† <b>collecter des analyses</b> .  Nous avons ce processus effectu√© dans 7 syst√®mes. <br><br><img src="https://habrastorage.org/webt/7m/j2/ua/7mj2ua32vv5afydoioxpifcgi7o.png" alt="image"><br><br>  Certains √©v√©nements vont dans un seul syst√®me, d'autres en plusieurs √† la fois ... De plus, il y a une telle fonctionnalit√© que les √©v√©nements avec diff√©rents param√®tres et dans diff√©rents formats peuvent aller vers diff√©rents syst√®mes.  Bien s√ªr, nous ne voulons pas vraiment r√©soudre toutes ces d√©pendances. <br><br><blockquote>  <i>LStat est notre propre SDK (statistiques Lamoda).</i>  <i>Il s'agit d'un syst√®me massif, qui prend plus de 60% des √©v√©nements divers.</i>  <i>Ces √©v√©nements qui vont plus loin dans Google, Adjust, ont souvent √©t√© initialement collect√©s uniquement dans LStat.</i> <br></blockquote><br><h2>  SDK </h2><br>  Notre SDK est le suivant. <br><img src="https://habrastorage.org/webt/ne/ew/ah/neewahjaa6gb3tux9c0io9uyhe8.png" alt="image"><br><br>  Un LStat propre sort, qui √† l'int√©rieur se compose de deux parties: le stockage et l'exp√©dition.  Lorsque nous collectons un √©v√©nement, nous ne l'envoyons pas imm√©diatement.  Sinon, il y aurait trop d'√©v√©nements et de demandes, ce qui n'est pas tr√®s pratique.  Par cons√©quent, nous mettons tout dans notre petite base de donn√©es SQLite, o√π nous stockons tout.  Ensuite, √† certains intervalles, notre couche r√©seau extrait les donn√©es de la base de donn√©es et les envoie. <br><br>  Apr√®s avoir re√ßu la confirmation du serveur que les √©v√©nements sont arriv√©s, nous effa√ßons notre base de donn√©es.  Ce processus se produit r√©guli√®rement.  Gr√¢ce √† cela, notre base ne grandit pas et nous garantissons la livraison de tous les √©v√©nements.  Si, pour une raison quelconque, l'√©v√©nement n'est pas arriv√©, il sera stock√© dans notre base de donn√©es jusqu'√† ce qu'une r√©ponse soit re√ßue du serveur. <br><br><h2>  Collectionneurs </h2><br>  Comme je l'ai dit plus t√¥t, nous avons 7 collectionneurs.  Ils se composent de ces m√©thodes: annotation personnalis√©e, EventHandler et AppStartEvent.  Que pensez-vous de cet √©v√©nement? <br><img src="https://habrastorage.org/webt/_d/tw/lo/_dtwloqivw9wcguv-egiwjznvje.png" alt="image"><br><br>  Bien s√ªr, c'est un d√©marrage √† froid de l'application.  Et l'essentiel ici est que nous avons une classe AppStartEvent qui h√©rite d'une interface Event.  Et pourquoi en avons-nous besoin, je le dirai un peu plus tard. <br><br>  Comment √ßa se passe?  C'est l√† que le thrash, la br√ªlure et la r√©flexion commencent. <br><img src="https://habrastorage.org/webt/2t/cl/4y/2tcl4yjenftx0thk3plkagyrh4k.png" alt="image"><br><br>  Nous passons d'abord par nos 7 collecteurs.  Ensuite, nous retirons la classe Java et collectorName, dont nous avons besoin plus tard pour le stockage. <br><br>  De plus, √† partir de cette classe Java, nous retirons toutes nos m√©thodes qui sont dans ce code.  Maintenant, nous devons v√©rifier et nous assurer que notre m√©thode est une m√©thode de suivi des √©v√©nements qui sera responsable du stockage.  Pour ce faire, nous avons plusieurs param√®tres: le premier est que nous avons l'annotation @EventHandler, nous n'avons pas de liste de param√®tres vide et un √©v√©nement arrive √† l'entr√©e. <br><br>  Toutes les conditions sont remplies, nous pouvons donc supposer que cette fonction sera un √©v√©nement avec nous.  Je viens de l'envelopper dans un emballage et de l'envoyer √† notre collection. <br><br><h2>  La r√©flexion n'est pas toujours mauvaise </h2><br>  Oui, beaucoup d'entre vous diront que la r√©flexion est mauvaise, lente, terrible. <br><img src="https://habrastorage.org/webt/cm/zz/k4/cmzzk4pcnh35oztvvtj7iglwc5a.png" alt="image"><br>  Pour commencer, cela peut √™tre lent ou rapide.  Il existe des m√©thodes comme getFields, getConstructors qui fonctionnent tr√®s rapidement par rapport au reste de la r√©flexion.  Et il y a, par exemple, Constructor newInstance, qui fonctionne tr√®s lentement.  Par le mot ¬´lent¬ª, je veux dire la diff√©rence entre les colonnes gauche et droite dans le tableau ci-dessus de plusieurs ordres de grandeur (environ une centuple de diff√©rence).  Par cons√©quent, si vous comprenez ce que vous faites et savez √† l'avance √† quoi vous devez vous pr√©parer, tout n'est pas si effrayant. <br><br>  <b>Nous tirons plus de 500 m√©thodes de 7 classes</b> .  Et nous ne le faisons qu'une fois par session.  Le temps n√©cessaire pour terminer un passage est de 40 millisecondes.  C'est moins de 3 images (au stade de l'√©cran de d√©marrage).  Et c'√©tait loin d'√™tre un appareil haut de gamme, mais un simple NTC sur Android 6, qui existe depuis de nombreuses ann√©es. <br><br>  Bien s√ªr, sur un appareil haut de gamme, tout fonctionnera plus rapidement.  Et si nous parlons de vieux t√©l√©phones chinois, le temps pass√© sera de 100 millisecondes conditionnel.  Les utilisateurs de ces t√©l√©phones sont d√©j√† habitu√©s au fait que tout fonctionne lentement pour eux, ils sont donc profond√©ment indiff√©rents √† 40 millisecondes ou 100. Quelle est la diff√©rence?  Ils ralentissent encore :) <br><br>  Et maintenant la question principale: comment impl√©menter l'analytique pour ne pas casser l'architecture? <br><br><h2>  Architecte </h2><br>  Notre application utilise MVP. <br><img src="https://habrastorage.org/webt/pi/dm/ft/pidmft4pgrgukv_lirindko4qu4.png" alt="image"><br><br>  C'est notre genre d'essence divine, qui ¬´vit¬ª sur ApplicationScope et est inject√© exactement l√† o√π nous en avons besoin.  Par exemple, nous devons d√©poser surClick ().  Afin de ne pas casser l'architecture, nous ne transmettrons pas l'√©v√©nement de la couche View √† Presenter, afin que plus tard, il aille quelque part.  Au lieu de cela, nous faisons tout directement depuis la vue et passons la piste √† AnalyticsManager. <br><br>  Et maintenant un peu sur l'envoi.  Chez AnalyticsManager, une m√©thode ressort - c'est la m√©thode de suivi, qui accepte n'importe quelle classe d'√©v√©nement comme entr√©e.  Et puis la magie noire se produit. <br><br><img src="https://habrastorage.org/webt/em/pi/kj/empikjusbjqotluav-_aclnwx94.png" alt="image"><br><br>  Cette m√©thode est capable de r√©soudre tous nos probl√®mes. <br><br>  Premi√®rement, cela aidera √† <b>d√©poser dans plusieurs syst√®mes diff√©rents</b> .  Les gestionnaires sont tous nos √©v√©nements qui seront collect√©s.  Ensuite, nous recherchons ici la m√©thode souhait√©e.  Par cons√©quent, si nous avons un √©v√©nement de piste √©crit, par exemple, dans 4 collecteurs, il sera stock√© en 4 exemplaires.  Autrement dit, en 4 passes du cycle, nous le trouverons et l'enverrons aux 4 syst√®mes avec les param√®tres correspondants. <br><br>  Deuxi√®mement, cela <b>aide √† r√©soudre le probl√®me avec des √©v√©nements ponctuels</b> .  Ce sont de tels √©v√©nements qui doivent √™tre promis strictement 1 fois pour tout le cycle de la demande.  Mark e.once, la variable bool√©enne habituelle.  Si nous disons qu'il s'agit d'un √©v√©nement ponctuel, nous le supprimons simplement de la collection.  Que se passe-t-il ensuite si nous essayons de le mettre en gage √† nouveau?  √âvidemment, nous ne le trouverons tout simplement pas dans cette collection.  Vous pouvez essayer de vous tirer une balle dans le pied autant que vous le souhaitez tout en continuant √† √©crire analyticsManager.track (AppStartEvent ()), cela continuera quand m√™me une fois et il n'y en aura plus. <br><br><h2>  Quel est le profit? </h2><br>  1. <b>Nous ne cassons pas l'architecture de notre application</b> , car AnalyticsManager se trouve et fonctionne en dehors de l'architecture.  Cela nous permet de l'int√©grer dans n'importe quelle partie de l'application. <br><br>  2. <b>Vous permet de collecter tous les √©v√©nements sur une seule ligne</b> dans n'importe quel nombre de syst√®mes d'analyse.  Pour ce faire, nous √©crivons simplement: analyticsManager.track (Event ()).  Parce qu'alors il d√©cide lui-m√™me o√π, en quelle quantit√©, avec quels param√®tres, quand, etc. <br><br>  3. <b>R√©sout le probl√®me des ¬´√©v√©nements ponctuels¬ª</b> .  Maintenant, nous n'avons plus besoin de faire diff√©rents types de contr√¥les.  Une fois envoy√©, retir√©, et nous ne le rencontrerons plus. <br><br>  4. <b>R√©sout le probl√®me de la collecte du m√™me √©l√©ment dans diff√©rents syst√®mes</b> .  √âtant donn√© que nous avons tout √©crit dans diff√©rents collectionneurs, cela est all√© √† diff√©rents collectionneurs.  Ainsi, vous n'avez pas √† recourir √† des gestes inutiles.  √Ä mon avis, c'est merveilleux. <br><br><h2>  Test ... </h2><br>  Nous testons manuellement.  Pourquoi ne pas automatiser, demandez-vous?  Et puis une chose triste se r√©v√®le. <br><br>  Tout d'abord, malheureusement, vous ne couvrirez pas normalement cela avec un test unitaire.  Parce que la plupart des probl√®mes li√©s aux √©v√©nements dans l'analyse ne se posent pas en raison du fait que certains des param√®tres que vous n'avez pas rassembl√©s.  D'apr√®s mon exp√©rience personnelle, 90% des probl√®mes surviennent parce que vous n'avez pas envoy√© l'√©v√©nement o√π il √©tait cens√© aller.  De tels cas ne peuvent √™tre d√©tect√©s qu'avec des tests d'interface utilisateur, que nous n'avons pas encore √©crits pour tout cela. <br><br>  Et deuxi√®mement, pour l'instant, nous nous reposons un peu sur le fait que les analystes d√©crivent les √©v√©nements dans un format assez strict (en confluence), mais ce format n'est pas un format de sp√©cification strict, comme Swagger.  En cons√©quence, il y a de l√©g√®res diff√©rences, il y a des doublons (bien que dans ce cas, un simple lien vers une autre page soit souvent cr√©√©).  Jusqu'√† pr√©sent, cela nous limite dans les possibilit√©s d'automatisation des tests d'analyse.  Mais nous y travaillons. <br><br><h2>  Conclusions </h2><br>  Que peut-on faire de plus avec cette d√©cision? <br><br>  1. <b>√âcrivez des autotests pour l'analyse</b> .  Cela n√©cessitera beaucoup de travail pr√©paratoire.  Mais on ne peut pas dire que cela soit impossible. <br><br>  2. Les m√©thodes de suivi plus-moins sont assez similaires.  Dans chacun, nous g√©n√©rons des param√®tres ¬´universels¬ª dont tout le monde a besoin.  Et rassemblez simplement la carte des valeurs.  En g√©n√©ral, on pourrait <b>√©crire un plug-in ou un utilitaire</b> .  Peu importe.  L'essentiel est qu'elle g√©n√®re un √©v√©nement de piste pour les classes respectives. <br><br>  Mais ici, un petit probl√®me peut survenir si les √©v√©nements commencent √† dispara√Ætre un peu diff√©remment (par exemple, pour diff√©rents syst√®mes d'analyse).  Pour cette raison, tout ne peut pas √™tre r√©solu de mani√®re ad√©quate.  Et d'ailleurs, je ne veux pas produire de g√©n√©ration de code inutile dans un projet, il y en a tellement dans de nombreux projets sur Android (bonjour Dagger, Moksi et d'autres qui travaillent sur codegen). <br><br>  3. <b>Int√©gration de l'application avec les sp√©cifications des analystes</b> .  C'est probablement un r√™ve trop transcendantal, mais quand m√™me ... Nous aimerions vraiment que nos analystes √©crivent dans un format strict, et nous pourrions analyser leurs ≈ìuvres d'art et les int√©grer.  Alors la paix et l'harmonie viendraient.  Tout le monde serait content :) <br><br>  Alors qu'est-ce que je veux dire avec tout √ßa? <br><br>  Premi√®rement, l'analyse est toujours n√©cessaire.  Parce qu'il vous permet d'√©conomiser de l'argent, des ressources et des efforts.  Cela vous √©vite d'√©crire du code inutile ou de supprimer du code qui ne semble pas vieux, mais qui n'est toujours pas n√©cessaire ici.  Moins d'h√©ritage est toujours bon. <br><br>  Deuxi√®mement, la r√©flexion n'est pas toujours mauvaise.  Oui, c'est lent.  Mais parfois, nous perdons tr√®s peu de performances, mais nous obtenons beaucoup, par exemple, dans le domaine du d√©veloppement et de la gestion des erreurs. <br><br>  Et troisi√®mement, nous pla√ßons l'analyse au stade de la planification des fonctionnalit√©s.  Pour cette raison, nous pouvons n√©gocier avec les analystes beaucoup plus t√¥t, pour parvenir √† un compromis.  Et cela nous donne √©galement la possibilit√© d'estimer √† l'avance le temps n√©cessaire pour √©crire des analyses. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469761/">https://habr.com/ru/post/fr469761/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469747/index.html">R√©sum√© des √©v√©nements informatiques d'octobre (premi√®re partie)</a></li>
<li><a href="../fr469749/index.html">Am√©lioration de l'UX avec la touche Tab</a></li>
<li><a href="../fr469753/index.html">Les 9 meilleures trouvailles open source pour septembre 2019</a></li>
<li><a href="../fr469755/index.html">Comment √™tre un bon programmeur</a></li>
<li><a href="../fr469757/index.html">La technologie AR au service de la peinture</a></li>
<li><a href="../fr469765/index.html">L'√©loge se d√©tend et la critique est offensante - comment √©valuer le travail de quelqu'un d'autre, pour que tout le monde soit bien</a></li>
<li><a href="../fr469767/index.html">Comment nous avons choisi ServiceDesk. Partie 1</a></li>
<li><a href="../fr469771/index.html">Cr√©ez une application Android. T√¢che avec un ast√©risque</a></li>
<li><a href="../fr469775/index.html">Dessinez un son</a></li>
<li><a href="../fr469779/index.html">Meetup Outdoor Future London Academy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>