<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚦 💃🏾 🧙🏼 Konfigurasikan Pengelompokan Nomad dengan Konsul dan Integrasikan dengan Gitlab 🌏 👩‍⚕️ 🧜🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendahuluan 

 Baru-baru ini, popularitas Kubernetes berkembang pesat - semakin banyak proyek yang mengimplementasikannya di rumah. Saya ingin menyent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Konfigurasikan Pengelompokan Nomad dengan Konsul dan Integrasikan dengan Gitlab</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453322/"><h2>  Pendahuluan </h2><br><br>  Baru-baru ini, popularitas Kubernetes berkembang pesat - semakin banyak proyek yang mengimplementasikannya di rumah.  Saya ingin menyentuh orkestra seperti Nomad: sangat cocok untuk proyek yang sudah menggunakan solusi lain dari HashiCorp, misalnya, Vault dan Konsul, dan proyek itu sendiri tidak rumit dalam hal infrastruktur.  Artikel ini akan memberikan instruksi untuk menginstal Nomad, menggabungkan dua node ke dalam cluster, dan mengintegrasikan Nomad dengan Gitlab. <br><br><img src="https://habrastorage.org/webt/bu/yn/4v/buyn4vqshurhgc9kavloja-fzsm.png"><br><br><a name="habracut"></a><br><br><h2>  Test stand </h2><br><br>  Sedikit tentang bangku tes: tiga server virtual digunakan dengan karakteristik 2 CPU, 4 RAM, 50 Gb SSD, disatukan dalam jaringan lokal umum.  Nama dan alamat IP mereka: <br><br><ol><li>  <b>nomad-livelinux-01</b> : 172.30.0.5 </li><li>  <b>nomad-livelinux-02</b> : 172.30.0.10 </li><li>  <b>consul-livelinux-01</b> : 172.30.0.15 </li></ol><br><br><h2>  Pemasangan Nomad, Konsul.  Membuat Kelompok Nomad </h2><br><br>  Mari kita lanjutkan ke instalasi dasar.  Terlepas dari kemudahan instalasi, saya akan menjelaskannya untuk integritas artikel: sebenarnya, ia dibuat dari konsep dan catatan untuk akses cepat jika perlu. <br><br>  Sebelum memulai praktik, kita akan membahas bagian teoretis, karena pada tahap ini penting untuk memahami struktur masa depan. <br><br>  Kami memiliki dua nomad node dan kami ingin menggabungkan mereka ke dalam sebuah cluster, dan untuk masa depan kita akan membutuhkan penskalaan otomatis dari cluster - untuk ini kita perlu Consul.  Menggunakan alat ini, pengelompokan dan penambahan node baru menjadi tugas yang sangat sederhana: simpul Nomad yang dibuat terhubung ke agen Konsul, dan kemudian terhubung ke cluster Nomad yang ada.  Oleh karena itu, pada awalnya kita akan menginstal server Konsul, mengkonfigurasi otorisasi http dasar untuk panel web (ini secara default tanpa otorisasi dan dapat diakses oleh alamat eksternal), serta agen Konsul sendiri di server Nomad, setelah itu kita baru saja memulai Nomad. <br><br>  Menginstal alat HashiCorp sangat sederhana: pada kenyataannya, kami hanya memindahkan file biner ke direktori bin, mengkonfigurasi file konfigurasi alat, dan membuat file layanannya. <br><br>  Unduh file biner Konsul dan buka di direktori home pengguna: <br><br><pre><code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># wget https://releases.hashicorp.com/consul/1.5.0/consul_1.5.0_linux_amd64.zip root@consul-livelinux-01:~# unzip consul_1.5.0_linux_amd64.zip root@consul-livelinux-01:~# mv consul /usr/local/bin/</span></span></code> </pre> <br><br>  Sekarang kami memiliki file konsul biner siap pakai untuk konfigurasi lebih lanjut. <br><br>  Untuk bekerja dengan Konsul, kita perlu membuat kunci unik menggunakan perintah keygen: <br><br><pre> <code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># consul keygen</span></span></code> </pre><br><br>  Mari kita lanjutkan untuk mengkonfigurasi konfigurasi Konsul, buat direktori /etc/consul.d/ dengan struktur berikut: <br><br><pre> <code class="bash hljs">/etc/consul.d/ ├── bootstrap │ └── config.json</code> </pre> <br><br>  Direktori bootstrap akan berisi file konfigurasi config.json - di dalamnya kita akan mengatur pengaturan Konsul.  Isinya: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"bootstrap"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"dc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/var/consul"</span></span>, <span class="hljs-string"><span class="hljs-string">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">"your-key"</span></span>, <span class="hljs-string"><span class="hljs-string">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"INFO"</span></span>, <span class="hljs-string"><span class="hljs-string">"enable_syslog"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"start_join"</span></span>: [<span class="hljs-string"><span class="hljs-string">"172.30.0.15"</span></span>] }</code> </pre> <br><br>  Mari kita periksa secara terpisah arahan utama dan artinya: <br><br><ul><li>  <b>bootstrap</b> : true.  Kami mengaktifkan penambahan otomatis dari simpul baru jika terhubung.  Saya perhatikan bahwa kami tidak mengindikasikan jumlah pasti dari simpul yang diharapkan di sini. </li><li>  <b>server</b> : benar.  Aktifkan mode server.  Konsul di mesin virtual ini akan menjadi satu-satunya server dan master saat ini, VM Nomad akan menjadi klien. </li><li>  <b>pusat data</b> : dc1.  Tentukan nama pusat data untuk membuat cluster.  Itu harus identik pada klien dan server. </li><li>  <b>mengenkripsi</b> : kunci Anda.  Kunci yang juga harus unik dan cocok dengan semua klien dan server.  Dihasilkan menggunakan perintah consul keygen. </li><li>  <b>start_join</b> .  Dalam daftar ini, kami menunjukkan daftar alamat IP yang akan digunakan sambungannya.  Saat ini, kami hanya meninggalkan alamat kami sendiri. </li></ul><br><br>  Pada titik ini, kita dapat mulai konsul menggunakan baris perintah: <br><br><pre> <code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># /usr/local/bin/consul agent -config-dir /etc/consul.d/bootstrap -ui</span></span></code> </pre> <br><br>  Ini adalah cara yang baik untuk melakukan debug sekarang, namun, secara berkelanjutan, menggunakan metode ini tidak akan berfungsi karena alasan yang jelas.  Buat file layanan untuk mengelola Konsul melalui systemd: <br><br><pre> <code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># nano /etc/systemd/system/consul.service</span></span></code> </pre><br><br>  Isi file consul.service: <br><br><pre> <code class="bash hljs">[Unit] Description=Consul Startup process After=network.target [Service] Type=simple ExecStart=/bin/bash -c <span class="hljs-string"><span class="hljs-string">'/usr/local/bin/consul agent -config-dir /etc/consul.d/bootstrap -ui'</span></span> TimeoutStartSec=0 [Install] WantedBy=default.target</code> </pre> <br><br>  Jalankan Konsul melalui systemctl: <br><br><pre> <code class="bash hljs">root@consul-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># systemctl start consul</span></span></code> </pre><br><br>  Kami memeriksa: layanan kami harus dimulai, dan dengan menjalankan perintah anggota konsul kita harus melihat server kami: <br><br><pre> <code class="bash hljs">root@consul-livelinux:/etc/consul.d<span class="hljs-comment"><span class="hljs-comment"># consul members consul-livelinux 172.30.0.15:8301 alive server 1.5.0 2 dc1 &lt;all&gt;</span></span></code> </pre> <br><br>  Langkah selanjutnya: menginstal Nginx dan mengatur proxy, otorisasi http.  Instal nginx melalui manajer paket dan buat file konfigurasi consul.conf di direktori / etc / nginx / sites-enabled dengan konten berikut: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> consul-auth { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> localhost:<span class="hljs-number"><span class="hljs-number">8500</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> consul.doman.name; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://consul-auth; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">auth_basic_user_file</span></span> /etc/nginx/.htpasswd; <span class="hljs-attribute"><span class="hljs-attribute">auth_basic</span></span> <span class="hljs-string"><span class="hljs-string">"Password-protected Area"</span></span>; } }</code> </pre> <br><br>  Jangan lupa untuk membuat file .htpasswd dan menghasilkan nama pengguna dan kata sandi untuknya.  Item ini diperlukan agar panel web tidak dapat diakses oleh semua orang yang mengetahui domain kami.  Namun, ketika mengonfigurasi Gitlab, kita harus meninggalkan ini - jika tidak kita tidak akan bisa menggunakan aplikasi kita ke Nomad.  Dalam proyek saya, baik Gitlab dan Nomad hanya ada di jaringan abu-abu, jadi tidak ada masalah seperti itu. <br><br>  Di dua server lain, instal agen Konsul sesuai dengan instruksi berikut.  Ulangi langkah-langkah dengan file biner: <br><br><pre> <code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># wget https://releases.hashicorp.com/consul/1.5.0/consul_1.5.0_linux_amd64.zip root@nomad-livelinux-01:~# unzip consul_1.5.0_linux_amd64.zip root@nomad-livelinux-01:~# mv consul /usr/local/bin/</span></span></code> </pre> <br><br>  Dengan analogi dengan server sebelumnya, kami membuat direktori untuk file konfigurasi /etc/consul.d dengan struktur berikut: <br><br><pre> <code class="bash hljs">/etc/consul.d/ ├── client │ └── config.json</code> </pre> <br><br>  Isi file config.json: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"datacenter"</span></span>: <span class="hljs-string"><span class="hljs-string">"dc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"data_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/consul"</span></span>, <span class="hljs-string"><span class="hljs-string">"log_level"</span></span>: <span class="hljs-string"><span class="hljs-string">"DEBUG"</span></span>, <span class="hljs-string"><span class="hljs-string">"node_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nomad-livelinux-01"</span></span>, <span class="hljs-string"><span class="hljs-string">"server"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"encrypt"</span></span>: <span class="hljs-string"><span class="hljs-string">"your-private-key"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain"</span></span>: <span class="hljs-string"><span class="hljs-string">"livelinux"</span></span>, <span class="hljs-string"><span class="hljs-string">"addresses"</span></span>: { <span class="hljs-string"><span class="hljs-string">"dns"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"https"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"grpc"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"http"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span> }, <span class="hljs-string"><span class="hljs-string">"bind_addr"</span></span>: <span class="hljs-string"><span class="hljs-string">"172.30.0.5"</span></span>, #    <span class="hljs-string"><span class="hljs-string">"start_join"</span></span>: [<span class="hljs-string"><span class="hljs-string">"172.30.0.15"</span></span>], #     <span class="hljs-string"><span class="hljs-string">"ports"</span></span>: { <span class="hljs-string"><span class="hljs-string">"dns"</span></span>: <span class="hljs-number"><span class="hljs-number">53</span></span> } }</code> </pre><br><br>  Kami menyimpan perubahan dan melanjutkan ke konfigurasi file layanan, isinya: <br><br>  /etc/systemd/system/consul.service: <br><br><pre> <code class="bash hljs">[Unit] Description=<span class="hljs-string"><span class="hljs-string">"HashiCorp Consul - A service mesh solution"</span></span> Documentation=https://www.consul.io/ Requires=network-online.target After=network-online.target [Service] User=root Group=root ExecStart=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/consul agent -config-dir=/etc/consul.d/client ExecReload=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/consul reload KillMode=process Restart=on-failure [Install] WantedBy=multi-user.target</code> </pre> <br><br>  Kami mulai konsul di server.  Sekarang, setelah memulai, kita akan melihat layanan yang dikonfigurasi di anggota nsul.  Ini berarti bahwa ia berhasil terhubung ke cluster sebagai klien.  Ulangi hal yang sama pada server kedua dan setelah itu kami akan dapat mulai menginstal dan mengkonfigurasi Nomad. <br><br>  Instalasi Nomad yang lebih rinci dijelaskan dalam dokumentasi resminya.  Ada dua metode instalasi tradisional: mengunduh file biner dan kompilasi dari sumber.  Saya akan memilih metode pertama. <br><br>  <b>Catatan</b> : proyek ini berkembang sangat cepat, pembaruan baru sering keluar.  Mungkin versi baru akan dirilis pada saat artikel ini selesai.  Karena itu, saya sarankan sebelum membaca periksa versi Nomad saat ini dan unduh. <br><br><pre> <code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># wget https://releases.hashicorp.com/nomad/0.9.1/nomad_0.9.1_linux_amd64.zip root@nomad-livelinux-01:~# unzip nomad_0.9.1_linux_amd64.zip root@nomad-livelinux-01:~# mv nomad /usr/local/bin/ root@nomad-livelinux-01:~# nomad -autocomplete-install root@nomad-livelinux-01:~# complete -C /usr/local/bin/nomad nomad root@nomad-livelinux-01:~# mkdir /etc/nomad.d</span></span></code> </pre> <br><br>  Setelah membongkar, kita akan mendapatkan file biner Nomad'a dengan berat 65 MB - harus dipindahkan ke / usr / local / bin. <br><br>  Buat direktori data untuk Nomad dan edit file layanannya (kemungkinan besar tidak akan ada di awal): <br><br><pre> <code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># mkdir --parents /opt/nomad root@nomad-livelinux-01:~# nano /etc/systemd/system/nomad.service</span></span></code> </pre> <br><br>  Masukkan baris berikut di sana: <br><br><pre> <code class="bash hljs">[Unit] Description=Nomad Documentation=https://nomadproject.io/docs/ Wants=network-online.target After=network-online.target [Service] ExecReload=/bin/<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -HUP <span class="hljs-variable"><span class="hljs-variable">$MAINPID</span></span> ExecStart=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/nomad agent -config /etc/nomad.d KillMode=process KillSignal=SIGINT LimitNOFILE=infinity LimitNPROC=infinity Restart=on-failure RestartSec=2 StartLimitBurst=3 StartLimitIntervalSec=10 TasksMax=infinity [Install] WantedBy=multi-user.target</code> </pre> <br><br>  Namun, kami tidak terburu-buru menjalankan nomad - kami belum membuat file konfigurasinya: <br><br><pre> <code class="bash hljs">root@nomad-livelinux-01:~<span class="hljs-comment"><span class="hljs-comment"># mkdir --parents /etc/nomad.d root@nomad-livelinux-01:~# chmod 700 /etc/nomad.d root@nomad-livelinux-01:~# nano /etc/nomad.d/nomad.hcl root@nomad-livelinux-01:~# nano /etc/nomad.d/server.hcl</span></span></code> </pre><br><br>  Struktur direktori terakhir adalah sebagai berikut: <br><br><pre> <code class="bash hljs">/etc/nomad.d/ ├── nomad.hcl └── server.hcl</code> </pre> <br><br>  File nomad.hcl harus berisi konfigurasi berikut: <br><br><pre> <code class="bash hljs">datacenter = <span class="hljs-string"><span class="hljs-string">"dc1"</span></span> data_dir = <span class="hljs-string"><span class="hljs-string">"/opt/nomad"</span></span></code> </pre> <br><br>  Isi file server.hcl: <br><br><pre> <code class="bash hljs">server { enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> bootstrap_expect = 1 } consul { address = <span class="hljs-string"><span class="hljs-string">"127.0.0.1:8500"</span></span> server_service_name = <span class="hljs-string"><span class="hljs-string">"nomad"</span></span> client_service_name = <span class="hljs-string"><span class="hljs-string">"nomad-client"</span></span> auto_advertise = <span class="hljs-literal"><span class="hljs-literal">true</span></span> server_auto_join = <span class="hljs-literal"><span class="hljs-literal">true</span></span> client_auto_join = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } bind_addr = <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span> advertise { http = <span class="hljs-string"><span class="hljs-string">"172.30.0.5"</span></span> } client { enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br><br>  Jangan lupa untuk mengubah file konfigurasi pada server kedua - di sana Anda harus mengubah nilai direktif http. <br><br>  Yang terakhir pada tahap ini adalah konfigurasi Nginx untuk proxy dan pengaturan otorisasi http.  Isi file nomad.conf: <br><br><pre> <code class="bash hljs">upstream nomad-auth { server 172.30.0.5:4646; } server { server_name nomad.domain.name; location / { proxy_pass http://nomad-auth; proxy_set_header Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; auth_basic_user_file /etc/nginx/.htpasswd; auth_basic <span class="hljs-string"><span class="hljs-string">"Password-protected Area"</span></span>; } }</code> </pre> <br><br>  Sekarang kita dapat mengakses panel web melalui jaringan eksternal.  Kami terhubung dan pergi ke halaman server: <br><br><img src="https://habrastorage.org/webt/en/uq/ck/enuqck8krqstsbt8b6uwbytoy0e.png"><br>  <b>Gambar 1.</b> Daftar server dalam cluster Nomad <br><br>  Kedua server berhasil ditampilkan di panel, hal yang sama akan kita lihat di output perintah status node nomad: <br><br><img src="https://habrastorage.org/webt/c1/gv/82/c1gv82tjvwtw0onqxqv3huchv1w.png"><br>  <b>Gambar 2.</b> Output dari perintah status node nomad <br><br>  Bagaimana dengan Konsul?  Ayo lihat.  Pergi ke panel kontrol Konsul, ke halaman node: <br><img src="https://habrastorage.org/webt/m5/6w/tj/m56wtjjgkos9ed5e_jy9lidmutg.png"><br>  <b>Gambar 3.</b> Daftar node dalam cluster Konsul <br><br>  Sekarang kami telah menyiapkan Nomad, bekerja bersama dengan Konsul.  Pada tahap akhir, kita akan memulai bagian yang paling menarik: kita akan mengkonfigurasi pengiriman kontainer Docker dari Gitlab ke Nomad, dan juga berbicara tentang beberapa fitur khas lainnya. <br><br><h2>  Buat Gitlab Runner <br></h2><br><br>  Untuk menyebarkan gambar buruh pelabuhan ke Nomad, kami akan menggunakan pelari terpisah dengan file biner Nomad di dalamnya (di sini, omong-omong, satu lagi fitur aplikasi Hashicorp dapat dicatat - secara individual mereka adalah satu-satunya file biner).  Unduh ke direktori pelari.  Baginya, buat Dockerfile paling sederhana dengan konten berikut: <br><br><pre> <code class="bash hljs">FROM alpine:3.9 RUN apk add --update --no-cache libc6-compat gettext COPY nomad /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/nomad</code> </pre><br><br>  Dalam proyek yang sama, buat .gitlab-ci.yml: <br><br><pre> <code class="bash hljs">variables: DOCKER_IMAGE: nomad/nomad-deploy DOCKER_REGISTRY: registry.domain.name stages: - build build: stage: build image: <span class="hljs-variable"><span class="hljs-variable">${DOCKER_REGISTRY}</span></span>/nomad/alpine:3 script: - tag=<span class="hljs-variable"><span class="hljs-variable">${DOCKER_REGISTRY}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${DOCKER_IMAGE}</span></span>:latest - docker build --pull -t <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span> -f Dockerfile . - docker push <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span></code> </pre> <br><br>  Sebagai hasilnya, kita akan memiliki gambar pelari Nomad yang dapat diakses di Gitlab Registry, sekarang kita dapat langsung menuju repositori proyek, membuat Pipeline, dan mengonfigurasi nomad pekerjaan Nomad. <br><br><h2>  Penyiapan proyek <br></h2><br><br>  Mari kita mulai dengan file pekerjaan untuk Nomad.  Proyek saya di artikel ini akan sangat primitif: itu akan terdiri dari satu tugas.  Isi .gitlab-ci adalah sebagai berikut: <br><br><pre> <code class="bash hljs">variables: NOMAD_ADDR: http://nomad.address.service:4646 DOCKER_REGISTRY: registry.domain.name DOCKER_IMAGE: example/project stages: - build - deploy build: stage: build image: <span class="hljs-variable"><span class="hljs-variable">${DOCKER_REGISTRY}</span></span>/nomad-runner/alpine:3 script: - tag=<span class="hljs-variable"><span class="hljs-variable">${DOCKER_REGISTRY}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${DOCKER_IMAGE}</span></span>:<span class="hljs-variable"><span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span></span> - docker build --pull -t <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span> -f Dockerfile . - docker push <span class="hljs-variable"><span class="hljs-variable">${tag}</span></span> deploy: stage: deploy image: registry.example.com/nomad/nomad-runner:latest script: - envsubst <span class="hljs-string"><span class="hljs-string">'${CI_COMMIT_SHORT_SHA}'</span></span> &lt; project.nomad &gt; job.nomad - cat job.nomad - nomad validate job.nomad - nomad plan job.nomad || <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ $? -eq 255 ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 255; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"success"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> - nomad run job.nomad environment: name: production allow_failure: <span class="hljs-literal"><span class="hljs-literal">false</span></span> when: manual</code> </pre> <br><br>  Di sini penyebaran terjadi dalam mode manual, tetapi Anda dapat mengonfigurasinya untuk mengubah konten direktori proyek.  Pipeline terdiri dari dua tahap: dari perakitan gambar dan penyebarannya ke nomad.  Pada tahap pertama, kami mengumpulkan gambar buruh pelabuhan dan mendorongnya ke dalam Registry kami, pada tahap kedua, kami meluncurkan pekerjaan kami di Nomad. <br><br><pre> <code class="bash hljs">job <span class="hljs-string"><span class="hljs-string">"monitoring-status"</span></span> { datacenters = [<span class="hljs-string"><span class="hljs-string">"dc1"</span></span>] migrate { max_parallel = 3 health_check = <span class="hljs-string"><span class="hljs-string">"checks"</span></span> min_healthy_time = <span class="hljs-string"><span class="hljs-string">"15s"</span></span> healthy_deadline = <span class="hljs-string"><span class="hljs-string">"5m"</span></span> } group <span class="hljs-string"><span class="hljs-string">"zhadan.ltd"</span></span> { count = 1 update { max_parallel = 1 min_healthy_time = <span class="hljs-string"><span class="hljs-string">"30s"</span></span> healthy_deadline = <span class="hljs-string"><span class="hljs-string">"5m"</span></span> progress_deadline = <span class="hljs-string"><span class="hljs-string">"10m"</span></span> auto_revert = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } task <span class="hljs-string"><span class="hljs-string">"service-monitoring"</span></span> { driver = <span class="hljs-string"><span class="hljs-string">"docker"</span></span> config { image = <span class="hljs-string"><span class="hljs-string">"registry.domain.name/example/project:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CI_COMMIT_SHORT_SHA}</span></span></span><span class="hljs-string">"</span></span> force_pull = <span class="hljs-literal"><span class="hljs-literal">true</span></span> auth { username = <span class="hljs-string"><span class="hljs-string">"gitlab_user"</span></span> password = <span class="hljs-string"><span class="hljs-string">"gitlab_password"</span></span> } port_map { http = 8000 } } resources { network { port <span class="hljs-string"><span class="hljs-string">"http"</span></span> {} } } } } }</code> </pre> <br><br>  Harap dicatat bahwa saya memiliki Registry pribadi dan untuk kumpulan gambar buruh pelabuhan yang berhasil, saya harus masuk ke sana.  Solusi terbaik dalam hal ini adalah memasukkan login dan kata sandi di Vault dengan integrasi selanjutnya dengan Nomad.  Secara nominal mendukung Vault.  Tetapi pertama-tama, di Vault itu sendiri, kami akan menginstal kebijakan yang diperlukan untuk Nomad, Anda dapat mengunduhnya: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Download the policy and token role $ curl https://nomadproject.io/data/vault/nomad-server-policy.hcl -O -s -L $ curl https://nomadproject.io/data/vault/nomad-cluster-role.json -O -s -L # Write the policy to Vault $ vault policy write nomad-server nomad-server-policy.hcl # Create the token role with Vault $ vault write /auth/token/roles/nomad-cluster @nomad-cluster-role.json</span></span></code> </pre> <br><br>  Sekarang, setelah membuat kebijakan yang diperlukan, kami akan menambahkan integrasi dengan Vault di blok tugas di file job.nomad: <br><br><pre> <code class="bash hljs">vault { enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> address = <span class="hljs-string"><span class="hljs-string">"https://vault.domain.name:8200"</span></span> token = <span class="hljs-string"><span class="hljs-string">"token"</span></span> }</code> </pre> <br><br>  Saya menggunakan otorisasi oleh token dan menulisnya langsung di sini, ada juga opsi untuk menentukan token sebagai variabel saat menjalankan agen nomad: <br><br><pre> <code class="bash hljs">$ VAULT_TOKEN=&lt;token&gt; nomad agent -config /path/to/config</code> </pre><br><br>  Sekarang kita bisa menggunakan kunci dengan Vault.  Prinsip operasi sederhana: kami membuat file dalam pekerjaan Nomad, yang akan menyimpan nilai-nilai variabel, misalnya: <br><br><pre> <code class="bash hljs">template { data = &lt;&lt;EOH {{with secret <span class="hljs-string"><span class="hljs-string">"secrets/pipeline-keys"</span></span>}} REGISTRY_LOGIN=<span class="hljs-string"><span class="hljs-string">"{{ .Data.REGISTRY_LOGIN }}"</span></span> REGISTRY_PASSWORD=<span class="hljs-string"><span class="hljs-string">"{{ .Data.REGISTRY_LOGIN }}{{ end }}"</span></span> EOH destination = <span class="hljs-string"><span class="hljs-string">"secrets/service-name.env"</span></span> env = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br><br>  Dengan pendekatan sederhana ini, Anda dapat mengonfigurasi pengiriman kontainer ke cluster Nomad dan bekerja dengannya di masa mendatang.  Saya akan mengatakan bahwa sampai batas tertentu saya bersimpati dengan Nomad - itu lebih cocok untuk proyek-proyek kecil di mana Kubernetes dapat menyebabkan kesulitan tambahan dan tidak akan menyadari potensinya sampai akhir.  Selain itu, Nomad sangat cocok untuk pemula - mudah untuk menginstal dan mengkonfigurasi.  Namun, ketika menguji pada beberapa proyek, saya menemukan masalah pada versi sebelumnya - banyak fungsi dasar tidak ada atau tidak berfungsi dengan benar.  Namun demikian, saya percaya bahwa Nomad akan terus berkembang dan di masa depan akan memperoleh semua fungsi yang diperlukan. <br><br>  <i>Diposting oleh Ilya Andreev, diedit oleh Alexei Zhadan dan Tim Live Linux</i> <i><br></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id453322/">https://habr.com/ru/post/id453322/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id453310/index.html">Pertukaran data antara komponen Bereaksi menggunakan perpustakaan RxJS</a></li>
<li><a href="../id453312/index.html">Generator email bisnis PDF berdasarkan data XML</a></li>
<li><a href="../id453314/index.html">DIY Black Mirror - mengajarkan bot berdasarkan riwayat obrolannya</a></li>
<li><a href="../id453316/index.html">Pembuat chip Inggris ARM menghentikan kerja sama dengan Huawei</a></li>
<li><a href="../id453318/index.html">5 kesalahan dalam penerapan pemberitahuan push untuk aplikasi seluler</a></li>
<li><a href="../id453324/index.html">Diode sebagai penyearah</a></li>
<li><a href="../id453326/index.html">Cara mengotomatisasi manajemen infrastruktur TI - bahas tiga tren</a></li>
<li><a href="../id453328/index.html">Sepuluh tahun di situs terpencil</a></li>
<li><a href="../id453330/index.html">Apa yang harus dilakukan jika RAM rusak. Anamnesis dan metode perawatan</a></li>
<li><a href="../id453332/index.html">Tentang metode aneh menghemat ruang hard disk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>