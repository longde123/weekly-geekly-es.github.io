<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Salas de reuniones basadas en asterisco  大Ⅲ丑ｓ大 </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr贸logo 
 Buenas tardes 

 Hubo 2 cosas que me llevaron a escribir este art铆culo: un peque帽o n煤mero o la falta de ejemplos de trabajo modernos de "chi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Salas de reuniones basadas en asterisco</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427117/"><h3>  Pr贸logo </h3><br>  Buenas tardes <br><br>  Hubo 2 cosas que me llevaron a escribir este art铆culo: un peque帽o n煤mero o la falta de ejemplos de trabajo modernos de "chips" de Asterisk, as铆 como la reticencia de los especialistas a compartir estos mismos "chips" con el resto.  Este soy yo ahora sobre la comunidad RU.  Es m谩s probable que todo tipo de "abuelos" en los foros lo llene de descuidos y lo env铆e a leer libros de hace diez a帽os en lugar de darle poca o m谩s informaci贸n 煤til.  Los propios temas del foro, creados en 2005-2010, est谩n muy desactualizados y, a veces, ya se ha eliminado algo de la versi贸n actual del asterisco, y hay que rehacer mucho para que funcione. <br><a name="habracut"></a><br>  Entonces aqu铆. <br>  Como resultado del abandono de CUCM en favor de Asterisk, la administraci贸n se encarg贸 de preservar los servicios m谩s populares entre los usuarios en su forma m谩s original, para no frustrar a las personas.  Una de ellas fue la creaci贸n de conferencias.  En ese momento, ya estaba familiarizado con Asterisk, pero no tan profundamente, as铆 que me tom贸 alrededor de una semana y media ordenar todo tipo de opciones de conferencia, y una tarea diferente surgi贸 con una decisi贸n final. <br><br>  El problema es que a partir de una soluci贸n similar a la que hay, hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art铆culo</a> con un encuentro desactualizado, as铆 como alg煤n tipo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">monstruo</a> que todav铆a no pude poner a trabajar.  Sugiero algo no tan voluminoso. <br><cut></cut><br><h3>  Pulpa </h3><br>  No describir茅 qu茅 es confbridge, de qu茅 secciones de una configuraci贸n en particular son responsables y de qu茅 es esta opci贸n, solo tendr茅 esta informaci贸n y est谩 actualizada.  Ahora sobre la decisi贸n en su conjunto. <br><br>  Objetivo: hacer posible la conferencia para crear durante una conversaci贸n, y luego invitar a m谩s suscriptores all铆.  El principal problema es que la funci贸n channelredirect no funciona como nos gustar铆a.  Es decir, si lo ejecuta desde el plan de marcado durante una conversaci贸n, entonces uno de los canales saldr谩 volando cuando sea necesario, y el segundo colapsar谩, y subir todo el plan de marcado a 2 l铆neas y registrar la opci贸n g en Diales fue flojo.  Y no entiendo por qu茅 en la mayor铆a de los manuales todos intentan resolver el problema solo a trav茅s del plan de marcado, ignorando la capacidad del asterisco para trabajar con scripts externos y ami. <br><cut></cut><br>  Entonces  Asterisco 14.4.0 <br><br>  Script de conferencia para 2 opciones (con comentarios): <br><br><div class="spoiler">  <b class="spoiler_title">conferencia.php</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//    $host = "192.168.1.1"; $port = "5038"; $timeout = "10"; $user = "conference"; $pass = "1111"; // ,    1   2  $kusok = $argv[1]; //       if ($kusok == 1){ //  $channel = $argv[2]; $bridgepeer = $argv[3]; $confnum = $argv[4]; print_r($bridgepeer); print_r($confnum); // $sconn = fsockopen ($host, $port, $timeout) or die ("Connection to $host:$port failed!"); fputs ($sconn, "Action: Login\r\n"); fputs ($sconn, "Username: $user\r\n"); fputs ($sconn, "Secret: $pass\r\n\r\n"); //   fputs ($sconn, "Action: Setvar\r\n"); fputs ($sconn, "Channel: $channel\r\n"); fputs ($sconn, "Variable: CONFNUM\r\n"); fputs ($sconn, "Value: $confnum\r\n\r\n"); fputs ($sconn, "Action: Setvar\r\n"); fputs ($sconn, "Channel: $bridgepeer\r\n"); fputs ($sconn, "Variable: CONFNUM\r\n"); fputs ($sconn, "Value: $confnum\r\n\r\n"); // fputs ($sconn, "Action: Redirect\r\n"); fputs ($sconn, "Channel: $bridgepeer\r\n"); fputs ($sconn, "ExtraChannel: $channel\r\n"); fputs ($sconn, "Context: service_code-ael\r\n"); fputs ($sconn, "Exten: conference\r\n"); fputs ($sconn, "Priority: 1\r\n\r\n"); fputs($sconn, "Action: Logoff\r\n\r\n"); sleep(2); fclose ($sconn); } //     if ($kusok == 2) { //  $confnum = $argv[2]; $inviten = $argv[3]; $sconn = fsockopen ($host, $port, $errno, $errstr, $timeout) or die ("Connection to $host:$port failed!"); // fputs ($sconn, "Action: Login\r\n"); fputs ($sconn, "Username: $user\r\n"); fputs ($sconn, "Secret: $pass\r\n\r\n"); //     fputs ($sconn, "Action: Originate\r\n"); fputs ($sconn, "Channel: Local/".$inviten."@out-ael\r\n"); fputs ($sconn, "Context: service_code-ael\r\n"); fputs ($sconn, "Exten: conference\r\n"); fputs ($sconn, "Priority: 1\r\n"); fputs ($sconn, "Variable: CONFNUM=".$confnum."\r\n\r\n"); fputs($sconn, "Action: Logoff\r\n\r\n"); sleep(2); fclose ($sconn); } }</span></span></code> </pre> <br></div></div><br>  Los gur煤s de la programaci贸n pueden arreglar el c贸digo haciendo dulces, escrib铆 lo mejor que pude. <br>  A continuaci贸n, comenzamos a usar este script directamente en el propio Asterisk. <br><br>  Para crear una conferencia, eleg铆 la combinaci贸n * 1.  Brevemente y no se cruza con la numeraci贸n principal. <br><br>  Agregue una llamada de script a features.conf con las variables requeridas que se le pasen <br><br><pre> <code class="hljs ruby">[applicationmap] conference =&gt; *<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>,System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/script/conference</span></span>.php <span class="hljs-number"><span class="hljs-number">1</span></span> ${CHANNEL} ${BRIDGEPEER} ${CALLERID(num)})</code> </pre><br>  Luego, para que esto funcione, cree una variable en el plan de marcado en la secci贸n [globales] y agregue nuestra funci贸n <br><br><pre> <code class="hljs">DYNAMIC_FEATURES=conference</code> </pre> <br>  Para agregar nuevos participantes a una conferencia ya creada, deber谩 registrar el c贸digo en confbridge.conf <br><br><pre> <code class="hljs haskell">[default_menu] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> = menu *1=dialplan_exec(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">service_code</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ael</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conference_add</span></span></span><span class="hljs-class">,1)</span></span></code> </pre><br>  Bueno, ahora la mejor parte son las extensiones. <br><br>  Para crear una conferencia (el script php aborda ambos canales de conversaci贸n aqu铆): <br><br><pre> <code class="hljs perl"> <span class="hljs-string"><span class="hljs-string">conference =&gt;</span></span> { ConfBridge(${CONFNUM},,,default_menu); }</code> </pre><br>  Para agregar un nuevo usuario (direcciones de dialplan_exec aqu铆): <br><br><pre> <code class="hljs ruby">conference_add =&gt; { Read(INVITEN,dial,<span class="hljs-number"><span class="hljs-number">11</span></span>,i); System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/script/conference</span></span>.php <span class="hljs-number"><span class="hljs-number">2</span></span> ${CALLERID(num)} ${INVITEN}); }</code> </pre><br>  Eso es todo.  No hay kilotones de c贸digo en el plan de marcado.  Todo es espacioso.  * 1 en una conversaci贸n y est谩 en una conf, de nuevo * 1 pitido y marcando, a qui茅n agregar. <br><br><h3>  Crecimientos </h3><br>  Confundido por los deseos de los usuarios, comenc茅 a desarrollar esta funci贸n. <br><br>  La siguiente fue la oportunidad de crear conferencias desde cero (no desde una conversaci贸n), as铆 como ir a conferencias ya creadas por su n煤mero y no esperar una llamada de invitaci贸n. <br><br>  Agregar al plan de marcado: <br><br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">_</span></span>*<span class="hljs-number"><span class="hljs-number">1</span></span>XXXX =&gt; { NoOp(${CONFCHAN}); Set(__CONFNUM=${<span class="hljs-symbol"><span class="hljs-symbol">EXTEN:</span></span><span class="hljs-number"><span class="hljs-number">2</span></span>}); System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/script/conference</span></span>.php <span class="hljs-number"><span class="hljs-number">3</span></span> ${CONFCHAN} ${CONFNUM} ); }</code> </pre><br>  A帽adir al gui贸n: <br><br><div class="spoiler">  <b class="spoiler_title">conferencia.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     if ($kusok == 3){ //  $channel = $argv[2]; $confnum = $argv[3]; // $sconn = fsockopen ($host, $port, $timeout) or die ("Connection to $host:$port failed!"); fputs ($sconn, "Action: Login\r\n"); fputs ($sconn, "Username: $user\r\n"); fputs ($sconn, "Secret: $pass\r\n\r\n"); //   fputs ($sconn, "Action: Setvar\r\n"); fputs ($sconn, "Channel: $channel\r\n"); fputs ($sconn, "Variable: CONFNUM\r\n"); fputs ($sconn, "Value: $confnum\r\n\r\n"); // fputs ($sconn, "Action: Redirect\r\n"); fputs ($sconn, "Channel: $channel\r\n"); fputs ($sconn, "Context: service_code-ael\r\n"); fputs ($sconn, "Exten: conference\r\n"); fputs ($sconn, "Priority: 1\r\n\r\n"); fputs($sconn, "Action: Logoff\r\n\r\n"); sleep(2); fclose ($sconn);</span></span></code> </pre> <br></div></div><br>  Tambi茅n tuve que modificar la l铆nea _ * X. <br><br><pre> <code class="hljs perl"> <span class="hljs-number"><span class="hljs-number">_</span></span>*X. =&gt; { set(__CONFCHAN=${CHANNEL}); Dial(Local/${EXTEN}@service_code-ael);</code> </pre><br>  Ahora, para ingresar a la conferencia o crearla desde cero, simplemente llame al * 1 y a un n煤mero, por ejemplo * 15234. <br><br>  La mutaci贸n final de este servicio es la llamada "conferencia grupal".  Esto es cuando los grandes jefes son demasiado vagos para agregar a todos manualmente, pero quiero presionar un bot贸n y todo est谩 ensamblado.  Para hacer esto, decid铆 crear c贸digos de servicio separados (* XXX) para que las personas no se confundan.  Para nuestra organizaci贸n, es poco probable que se necesiten m谩s de 1000 grupos de conferencia en los pr贸ximos 100 a帽os, por lo que deber铆a haber suficiente stock de numeraci贸n.  En casa, puede agregar como un prefijo diferente, as铆 que asigne una capacidad de numeraci贸n diferente. <br><br>  Dialplan: <br><br><pre> <code class="hljs ruby"> <span class="hljs-number"><span class="hljs-number">_</span></span>*XXX=&gt; { Set(CONFNUM=${CALLERID(num)}); System(<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/script/groups</span></span>.php ${<span class="hljs-symbol"><span class="hljs-symbol">EXTEN:</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>} ${CONFNUM}); ConfBridge(${CONFNUM},,,default_menu); }</code> </pre><br>  El crujido de los propios participantes: <br><br><div class="spoiler">  <b class="spoiler_title">groups.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  function call ($group, $confnum) { $many = count($group); //       for ($i=0; $many&gt;$i; $i++) { //    $num = trim(array_shift($group[$i])); // system("asterisk -rx \"channel originate Local/$num@out-ael application ConfBridge $confnum\""); } } //    function conf_group ($groupid) { //   $opt = array( PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION, PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC ); $pdo = new PDO("odbc:mssql_asterisk, "asterisk, "121212", $opt); //   $sql = "SELECT extension FROM [asterisk].[dbo].[conf_groups] where groupid = $groupid"; $select = $pdo-&gt;query($sql); $result = $select-&gt;fetchAll(); // $pdo = NULL; return $result; } //  ,    $groupid = $argv[1]; //   $confnum = $argv[2]; //   $group=conf_group($groupid); // call($group, $confnum); }</span></span></code> </pre><br></div></div><br>  Todos los grupos se almacenan en la base de datos de acuerdo con la estructura de "Grupo, n煤mero, nombre, descripci贸n".  Si aparece un nuevo grupo, simplemente agr茅guelo a la base de datos. <br><br>  Ahora, para recopilar, por ejemplo, todos los directores para una reuni贸n, el general solo necesita marcar * 100.  Y como regla, los grandes jefes tienen tel茅fonos grandes.  Por lo tanto, vinculamos * 100 a cualquier tecla de marcaci贸n r谩pida, la firmamos como "directores" y el usuario no se molesta en escribir.  Presion茅 el bot贸n. Reun铆 la reuni贸n. <br><br>  <b>Ahora anticipando sus preguntas:</b> <br><br>  驴Por qu茅 guiones y ami?  Porque mediante el plan de marcado no pude hacer una redirecci贸n sensata de ambos canales sin perderlos en el camino.  En ami, en la funci贸n de redireccionamiento, puede adjuntar un canal adicional + configurar una variable para 茅l (por ejemplo, el n煤mero de conferencia, para que tambi茅n pueda agregarle alguien). <br><br>  Tambi茅n puede notar que pongo caracter铆sticas en un contexto separado de service_code-ael.  Esto es conveniente cuando tiene m谩s de un par de piezas de cualquier caracter铆stica.  Decid铆 hacerlos a trav茅s de *, por lo tanto, en cualquier contexto, simplemente escribo _ * X.  y direcci贸n en este contexto.  Quiz谩s alguien encuentre una soluci贸n m谩s elegante, pero no la he encontrado en varios meses.  Y esta funcionalidad atrajo a los usuarios. <br><br>  驴Por qu茅 ael, no conf?  Bueno, porque es m谩s estructurado y m谩s f谩cil de leer. <br>  y m谩s comprensible  Una funci贸n gotoif vale la pena.  Todav铆a no he llegado a lua. <br><br>  驴Por qu茅 en el ejemplo de colecci贸n masiva se originan a trav茅s de bash y no a trav茅s de AMI?  El problema es que al ejecutar un mont贸n de originar en una fila a trav茅s de ami, el sistema espera a que se complete el anterior para dar el siguiente.  驴Y si nadie levanta el tel茅fono, y hay 20 segundos sin_ans y esas 5 piezas?  Puedes esperar hasta la noche para recoger. <br><br>  Bueno, eso es probablemente todo.  Espero que este art铆culo ayude a los mismos buscadores que yo cuando todo esto deb铆a hacerse de manera r谩pida, c贸moda para los usuarios, y lo m谩s importante, en el futuro, mantener este sistema fue conveniente para m铆, por as铆 decirlo, con una reserva para el futuro. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427117/">https://habr.com/ru/post/es427117/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427105/index.html">Aprender a aprender: la educaci贸n continua es la clave para la competitividad en la era de la econom铆a digital</a></li>
<li><a href="../es427107/index.html">Parsim X12 "en la rodilla"</a></li>
<li><a href="../es427109/index.html">Pirater铆a en el espacio - El delicioso Delta-V y los Steamboats Stealth de hidr贸geno - Parte 1</a></li>
<li><a href="../es427111/index.html">Transformaci贸n de procesos de desarrollo y entrega para una aplicaci贸n heredada</a></li>
<li><a href="../es427113/index.html">Matrices de puertas programables: c贸mo ayudan a las redes 5G</a></li>
<li><a href="../es427123/index.html">Juego de Turing</a></li>
<li><a href="../es427129/index.html">Inteligencia de amenazas: un enfoque moderno para la seguridad de la informaci贸n</a></li>
<li><a href="../es427131/index.html">Conocimiento de Audioman铆a: 15 materiales tem谩ticos sobre producci贸n, dise帽o, oficinas y negocios.</a></li>
<li><a href="../es427133/index.html">Surtido: tarea de optimizaci贸n cl谩sica</a></li>
<li><a href="../es427135/index.html">Implementaci贸n de escenas y secuencias de acciones en juegos.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>