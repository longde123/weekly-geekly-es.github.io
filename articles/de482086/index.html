<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§›ğŸ¾ ğŸ¤¹ğŸ¿ ğŸ™ğŸ¼ Bootkit-Analyse ğŸ‘ğŸ¾ ğŸ‘©ğŸ¾â€ğŸš’ ğŸ¥˜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo allerseits! Im Zusammenhang mit dem Start des Kurses â€Reverse Engineeringâ€œ haben wir eine geplante offene Stunde abgehalten. Der Bootkit-Betrieb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bootkit-Analyse</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/482086/"> <i>Hallo allerseits!</i>  <i>Im Zusammenhang mit dem Start des Kurses <a href="https://otus.pw/1uOJ/">â€Reverse Engineeringâ€œ haben</a> wir eine geplante offene Stunde abgehalten.</i>  <i><b>Der Bootkit-Betriebsalgorithmus wurde</b> in verschiedenen Phasen des Ladevorgangs zerlegt.</i> <br><br><img src="https://habrastorage.org/webt/do/x7/rb/dox7rbq794sk5rkgvwrpq42lq6g.jpeg"><br><br>  Dozent - <a href="https://otus.pw/G9ih/">Arthur Pakulov</a> , <a href="https://otus.pw/G9ih/">Virusanalyst</a> bei Kaspersky Lab. <br><br>  <b><i>Der folgende Artikel ist eine EinfÃ¼hrung und eine Textversion nur eines Teils der Lektion, die sich mit dem Bootkit-Installationsprogramm befasst.</i></b>  <b><i>Eine detaillierte Analyse des Bootkits selbst finden Sie im Video.</i></b> <a name="habracut"></a><br><br>  Ein Bootkit ist ein bÃ¶sartiges Programm, das Master Boot Record, den ersten Sektor der ersten physischen Festplatte oder des ersten Bootsektors, VBR, Ã¤ndert.  Programme dieser Art verfÃ¼gen im Grunde genommen Ã¼ber eine Trojaner-FunktionalitÃ¤t und werden verwendet, um verborgene Aktionen im System auszufÃ¼hren.  In unserem Beispiel fÃ¼hrt das Bootkit eine Privilegieneskalation auf die Prozessebene durch, deren Name mit einer Folge von Buchstaben beginnt: â€inteâ€œ.  TatsÃ¤chlich ist ein Bootkit ein Rootkit, das im 0-Schutzring zu funktionieren beginnt, der bereits gestartet wird, bevor das Betriebssystem geladen wird.  Aus diesem Grund ist er fÃ¼r die Forschung von groÃŸem Interesse. <br><br>  Um ein solches Programm zu entwickeln, reichen die Ã¼blichen Reverse Engineering-Kenntnisse nicht aus.  Es reicht nicht aus, nur die Liste lesen zu kÃ¶nnen, sondern Sie mÃ¼ssen auch Dinge wie Prozessorarchitektur, Speicheradressierung usw. verstehen. Wir haben uns in einer offenen Lektion die wichtigsten Stellen des Bootkits angesehen. <br><br>  FÃ¼r die Arbeit wurde ein spezielles Beispiel fÃ¼r bootkit-xp.exe vorbereitet, das unter Windows XP funktioniert.  Wir haben uns also nicht nur mit dem Bootkit befasst, sondern waren auch ein bisschen nostalgisch fÃ¼r dieses Betriebssystem.  Im Allgemeinen wurde jedoch OS XP gewÃ¤hlt, um das ZurÃ¼cksetzen zu vereinfachen, da XP eine gute Visualisierung ist und keine unnÃ¶tigen Komplikationen auftreten.  Nun, das Beispiel wurde speziell fÃ¼r dieses Betriebssystem geschrieben, gemessen am Code. <br><br>  So <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D425">sieht das Bootkit-Installationsprogramm aus</a> : <br><br><img src="https://habrastorage.org/webt/f4/-4/lr/f4-4lrdezgkdeeokbuyk9w0-4jy.png"><br><br>  Wenn Sie es sich nur ansehen, kÃ¶nnen Sie bestimmte Schlussfolgerungen ziehen.  Beispielsweise ist sofort ersichtlich, dass diese Datei ein geringes Gewicht hat.  Wenn Sie sich den Einstiegspunkt ansehen, sehen Sie, dass der Code einen Dateideskriptor mit dem Namen einer symbolischen VerknÃ¼pfung zur ersten physischen Festplatte - "PhysicalDrive0" - empfÃ¤ngt: <br><br><img src="https://habrastorage.org/webt/qy/3k/ug/qy3kugjvk78hnhogjugvfcf2ggc.png"><br><br>  Um den Code besser <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D612">verstehen zu kÃ¶nnen</a> , haben wir <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D612">auf IDA umgestellt</a> .  Es wird deutlich, dass fÃ¼r einen typischen Trojaner die verfÃ¼gbare FunktionalitÃ¤t recht gering ist.  Auch die Importtabelle ist verdÃ¤chtig klein: <br><br><img src="https://habrastorage.org/webt/fa/jw/pm/fajwpmunsgdiuiicltttrjuum-q.png"><br><br>  Ein solches Bild entsteht normalerweise bei der Analyse von verpackten Proben.  In unserem Fall sieht die Datei jedoch nicht gepackt aus.  Es stellt sich heraus, dass das Sample entweder von einem Protector / Cryptor abgedeckt wird und wÃ¤hrend seiner Arbeit die Adressen von Funktionen auf dynamische Weise erhÃ¤lt, wonach es das gewÃ¼nschte Functional aufruft, oder dass alles in Ordnung ist und das Sample so ist, wie es ist. <br><br>  Wir untersuchen den Code weiter. <br><br><img src="https://habrastorage.org/webt/dd/ap/6r/ddap6rpjjwbfz3zzamn_0folqro.png"><br><br>  Wie wir in HIEW gesehen haben, wird die <b>CreateFileA-</b> Funktion mit einem interessanten Argument als erstem Parameter aufgerufen.  Hier ist es angebracht, sich an so etwas wie <b>Kernelobjekte</b> zu erinnern.  Sie kÃ¶nnen nicht direkt vom Benutzermodus aus bearbeitet werden, sondern werden vom Kernel des Betriebssystems gesteuert.  Im Benutzermodus kann ein Programm nur den Empfang / die Ã„nderung des Status eines Kernelobjekts anfordern.  Um dem System anzuzeigen, mit welchem â€‹â€‹bestimmten Kernelobjekt das Programm arbeiten wird, muss das Handle des erforderlichen Kernelobjekts abgerufen werden.  Wenn alle PrÃ¼fungen bestanden sind, sendet das Betriebssystem auf Anforderung des Eingangs das <b>Handle des</b> angeforderten OA an uns zurÃ¼ck.  Und bereits mit handle kÃ¶nnen wir mit dem zugehÃ¶rigen OA arbeiten. <br><br>  In der obigen Abbildung wird daher mit CreateFile auf eine symbolische VerknÃ¼pfung zur ersten verbundenen physischen Festplatte zugegriffen.  Wenn der Zugriff gewÃ¤hrt wird, kÃ¶nnen Sie mit einer solchen â€Dateiâ€œ wie mit jeder anderen einfachen Datei arbeiten.  Das heiÃŸt, die gesamte Festplatte wird als einzelne groÃŸe Datei dargestellt. <br><br>  Also lasst uns weitermachen.  Handle ist zurÃ¼ck und wir befinden uns hier: <br><br><img src="https://habrastorage.org/webt/zr/1e/1x/zr1e1xk7dhetlxfyumiqyrfnvn4.png"><br><br>  Was passiert als nÃ¤chstes?  Und dann liest die <b>ReadFile-</b> Funktion die ersten 0x200-Bytes.  Und wir haben dort den allerersten Sektor der ersten physischen Festplatte. <br><br><img src="https://habrastorage.org/webt/ev/p8/sc/evp8sct8igaytj9d3ardoecem3u.png"><br><br>  Wie Sie vielleicht erraten haben, handelt es sich um den <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25BB%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25B3%25D1%2580%25D1%2583%25D0%25B7%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C">Master Boot Record</a> (MBR).  MBR besteht aus 3 Teilen: Codeteil, Partitionstabelle und Signatur.  In einer normalen Situation liest das BIOS den MBR unter der Adresse 0: 0x7c00h in den Speicher und Ã¼bergibt ihm die Kontrolle.  Der Codeabschnitt des MBR wird also ausgefÃ¼hrt.  WÃ¤hrend der AusfÃ¼hrung analysiert es die Partitionstabelle, findet den Bootsektor und lÃ¤dt ihn.  Wenn der MBR bei einem Bootkit Ã¼berschrieben wird, erhÃ¤lt sein Code nun die Kontrolle. <br><br>  Ok, MBR wird gelesen und <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D1832">wie geht es weiter</a> ?  Und dann Ã¶ffnet das Bootkit PhysicalDrive0 erneut, jedoch mit Schreibzugriffsmodus. <br><br><img src="https://habrastorage.org/webt/dx/ca/sd/dxcasdk2lmaimniy-ghxtmpwfmc.png"><br><br>  Als nÃ¤chstes wird ein Zeiger auf den 600. Versatz gesetzt.  Das heiÃŸt, der <b>ursprÃ¼ngliche Sektor wird gelesen und in den dritten Sektor kopiert</b> . <br><br>  Warum einen Sektor sichern?  Dies ist natÃ¼rlich notwendig, damit es in Zukunft benÃ¶tigt wird. <br><br>  Dann beginnt der Zyklus.  Wenn man sich den Code ansieht, muss man <b>natÃ¼rlich</b> auf Konstanten wie var_1C, <b>1BEh</b> und andere <b>achten</b> .  Gleichzeitig sollte die darÃ¼ber befindliche MBR-Struktur im Speicher aktualisiert werden.  Insbesondere interessieren wir uns fÃ¼r die Spalte â€Offsetâ€œ. <br><br><img src="https://habrastorage.org/webt/rq/jl/ac/rqjlacxma7m_0m_ldqqbomiqhfa.png"><br><br>  Der Lesepuffer des ersten Sektors befindet sich in <b>lpBuffer</b> .  Dann wird <b>1BEh</b> hinzugefÃ¼gt, und der Zeiger <b>springt</b> an den Anfang der Partitionstabelle.  Alle Daten von der Tabelle bis zum Ende des Sektors werden ab dem gleichen Offset - 1BE - in _markierte_Bytes eingefÃ¼gt. <br><br><img src="https://habrastorage.org/webt/yj/en/ot/yjenotuk4hp061oe0qldeeu0j98.png"><br><br>  Das heiÃŸt, der zweite und dritte Teil des ursprÃ¼nglichen MBR werden in <b>_markierte_ Bytes</b> eingefÃ¼gt. <br><br>  Was passiert als nÃ¤chstes?  Und <b>dann</b> setzt <b>SetFilePointer</b> den Zeiger auf den Anfang unserer â€Dateiâ€œ, das heiÃŸt auf den MBR. <br><br><img src="https://habrastorage.org/webt/eb/7z/vb/eb7zvba8zitins67gn2vtiiu8gs.png"><br><br>  Dann gibt es ein Schreiben (WriteFile), das <i>_markierte_ Bytes bildet</i> und Speicher <i>freigibt</i> .  Damit endet die FunktionalitÃ¤t des Bootkit-Installationsprogramms. <br><br>  Aber es wÃ¤re schÃ¶n zu <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2429">sehen, was genau</a> im ersten Teil von <b>_marked_bytes steht</b> .  Speichern Sie es dazu auf der Festplatte und analysieren Sie es.  Das erste, was auffÃ¤llt, ist eine Verringerung des Inhalts der Variablen um 2 bei 0x413. <br><br><img src="https://habrastorage.org/webt/pq/_w/3k/pq_w3kqifhqcrnmjtebzseacgpu.png"><br><br>  Wenn Sie sich die technische Dokumentation ansehen, kÃ¶nnen Sie feststellen, dass die Variable bei 0X413 die GrÃ¶ÃŸe des physischen Speichers in Kilobyte enthÃ¤lt.  Dementsprechend schneidet der Bootkit-Code zwei Kilobyte Speicher ab: <br><br><img src="https://habrastorage.org/webt/gc/ks/kb/gckskbwy16b2m0k8sgwv6lg__zk.png"><br><br>  Um dies nicht weiter zu tun, wird davon ausgegangen, dass 2 Kilobyte weniger Speicher als zuvor vorhanden sind.  Warum - ist noch nicht klar. <br><br>  <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2734">Als nÃ¤chstes wird die</a> physikalische Adresse mit einer bitweisen Linksverschiebung von 6 Bits auf das "Bit aus" -SpeicherstÃ¼ck berechnet: <br><br><img src="https://habrastorage.org/webt/9i/ve/qb/9iveqb9zzdser14szx1vnercz20.png"><br><br>  Eine Verschiebung von 6 fÃ¼hrt zwei Aktionen gleichzeitig aus - konvertiert Kilobytes in Bytes (multipliziert den Wert der Variablen mit 2 ^ 10), um die physikalische Adresse des abgebissenen SpeicherstÃ¼cks zu erhalten, und extrahiert die Segmentnummer daraus, indem das Ergebnis durch 0x10 (2 ^ 4) dividiert wird. <br><br>  Danach wird Ihr KÃ¶rper Ã¼ber dieses Teil des Speichers kopiert, und da der Bootkit-Code im Teil "Bit off" ist, wird ihn <b>niemand weiter stÃ¶ren</b> .  DarÃ¼ber hinaus Ã¤ndert keine Unterbrechung nicht, was in diesem Speicherbereich geschrieben ist.  Wir kÃ¶nnen sagen, dass der <b>Code fÃ¼r das System praktisch unsichtbar wird</b> , als ob dort kein Speicher vorhanden wÃ¤re. <br><br>  Dies ist nur der Anfang des Bootkits.  Dann gibt es Interrupt-Interception, NTLDR-Signatur-Tracking, Modifikation des Betriebssystem-Kernel-Moduls usw. <br><br>  Deshalb werden wir es nicht verderben, es ist besser, <a href="https://otus.pw/1uOJ/">das Webinar</a> bis zum Ende <a href="https://otus.pw/1uOJ/">anzusehen</a> , um nichts zu verpassen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de482086/">https://habr.com/ru/post/de482086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de482070/index.html">FÃ¼nf Gewohnheiten, die zur Aufrechterhaltung der Gehirnleistung beitragen</a></li>
<li><a href="../de482076/index.html">Kunden vertrauen asoshnikov</a></li>
<li><a href="../de482078/index.html">Risiken von IT-Projekten und IT-Teams</a></li>
<li><a href="../de482080/index.html">Gateway fÃ¼r UDP zwischen Wi-Fi und LoRa</a></li>
<li><a href="../de482084/index.html">Was an Feiertagen zu lesen</a></li>
<li><a href="../de482088/index.html">Umarmung fÃ¼r Entwickler oder wie ich zu KotlinConf kam</a></li>
<li><a href="../de482092/index.html">Was braucht der Blinde? RÃ¼ckblick auf den taubblinden Experten Sergei Fleitin</a></li>
<li><a href="../de482094/index.html">Software Architect: Warum wird es benÃ¶tigt und was ist sein Fluch</a></li>
<li><a href="../de482096/index.html">VR und KreativitÃ¤t: Wie Dell Precision Workstations SchÃ¼lern der British Graduate School of Design helfen</a></li>
<li><a href="../de482100/index.html">AMP-Technologie in E-Mails: Vor- und Nachteile sowie VerwendungsmÃ¶glichkeiten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>