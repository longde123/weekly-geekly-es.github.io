<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¶ ü§ë ü§≥ Voltar aos microsservi√ßos com Istio. Parte 2 ü§úüèæ üè® üïô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota perev. : A primeira parte desta s√©rie foi dedicada √† introdu√ß√£o do Istio e √† demonstra√ß√£o em a√ß√£o. Agora, falaremos sobre aspectos mais complexos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Voltar aos microsservi√ßos com Istio. Parte 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/440378/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>Nota</b></i>  <i><b>perev.</b></i>  <i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A primeira parte</a> desta s√©rie foi dedicada √† introdu√ß√£o do Istio e √† demonstra√ß√£o em a√ß√£o.</i>  <i>Agora, falaremos sobre aspectos mais complexos da configura√ß√£o e uso dessa malha de servi√ßo e, em particular, sobre roteamento bem ajustado e gerenciamento de tr√°fego de rede.</i> <i><br><br></i>  <i>Lembramos tamb√©m que o artigo usa configura√ß√µes (manifestos para Kubernetes e Istio) do reposit√≥rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">istio-mastery</a> .</i> <i><a name="habracut"></a></i> <br><br><h2>  Gerenciamento de tr√°fego </h2><br>  Com o Istio, novos recursos aparecem no cluster para fornecer: <br><br><ul><li>  <b>Roteamento din√¢mico de consultas</b> : lan√ßamentos de can√°rios, teste A / B; </li><li>  <b>Balanceamento de carga</b> : simples e consistente, com base em hashes; </li><li>  <b>Recupera√ß√£o de queda</b> : tempos limite, novas tentativas, disjuntores; </li><li>  <b>Entrada de falha</b> : atrasos, interrup√ß√£o de solicita√ß√µes, etc. </li></ul><br>  Na continua√ß√£o do artigo, esses recursos ser√£o mostrados como um exemplo do aplicativo selecionado e novos conceitos ser√£o introduzidos ao longo do caminho.  O primeiro desses conceitos ser√° o <code>DestinationRules</code> <i>(ou seja, regras sobre o destinat√°rio do tr√°fego / solicita√ß√µes - aprox. Transl.)</i> , Com o qual ativamos o teste A / B. <br><br><h2>  Teste A / B: Regras de Destino na Pr√°tica </h2><br>  O teste A / B √© usado nos casos em que existem duas vers√µes do aplicativo (geralmente elas diferem visualmente) e n√£o temos 100% de certeza de qual deles melhorar√° a intera√ß√£o do usu√°rio.  Portanto, lan√ßamos simultaneamente as duas vers√µes e coletamos m√©tricas. <br><br>  Para implantar a segunda vers√£o do front-end necess√°ria para demonstrar o teste A / B, execute o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube/ab-testing/sa-frontend-green-deployment.yaml deployment.extensions/sa-frontend-green created</code> </pre> <br>  O manifesto de implanta√ß√£o da "vers√£o verde" difere em dois locais: <br><br><ol><li>  A imagem √© baseada em outra tag - <code>istio-green</code> , </li><li>  Os pods t√™m uma <code>version: green</code> r√≥tulo <code>version: green</code> . </li></ol><br>  Como as duas implanta√ß√µes possuem o r√≥tulo <code>app: sa-frontend</code> , as solicita√ß√µes roteadas pelo servi√ßo virtual <code>sa-external-services</code> para o servi√ßo <code>sa-frontend</code> ser√£o redirecionadas para todas as suas inst√¢ncias e a carga ser√° distribu√≠da usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o algoritmo round-robin</a> , que levar√° √† seguinte situa√ß√£o: <br><br><img src="https://habrastorage.org/webt/p-/bi/mj/p-bimjrw8ywosk5q020d3loefsy.png"><br>  <i>Arquivos solicitados n√£o encontrados</i> <br><br>  Esses arquivos n√£o foram encontrados devido ao fato de serem chamados de maneira diferente em diferentes vers√µes do aplicativo.  Vamos nos certificar disso: <br><br><pre> <code class="bash hljs">$ curl --silent http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/ | tr <span class="hljs-string"><span class="hljs-string">'"'</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> | grep main /static/css/main.c7071b22.css /static/js/main.059f8e9c.js $ curl --silent http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/ | tr <span class="hljs-string"><span class="hljs-string">'"'</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> | grep main /static/css/main.f87cd8c9.css /static/js/main.f7659dbb.js</code> </pre> <br>  Isso significa que o <code>index.html</code> , solicitando uma vers√£o dos arquivos est√°ticos, pode ser enviado pelo balanceador de carga para os pods que possuem uma vers√£o diferente, onde, por raz√µes √≥bvias, esses arquivos n√£o existem.  Portanto, para que o aplicativo funcione, precisamos colocar uma restri√ß√£o: " <b>a mesma vers√£o do aplicativo que forneceu index.html tamb√©m deve atender a solicita√ß√µes subsequentes</b> ". <br><br>  Atingiremos a meta com balanceamento de carga consistente com base em hash <i>(Consistent Hash Loadbalancing)</i> .  Nesse caso, as <b>solicita√ß√µes de um cliente s√£o enviadas para a mesma inst√¢ncia de back-end</b> , para a qual uma propriedade predefinida √© usada - por exemplo, um cabe√ßalho HTTP.  Implementado usando DestinationRules. <br><br><h2>  DestinationRules </h2><br>  Depois que o <b>VirtualService</b> enviou uma solicita√ß√£o ao servi√ßo desejado, usando DestinationRules, podemos determinar as pol√≠ticas que ser√£o aplicadas ao tr√°fego destinado √†s inst√¢ncias desse servi√ßo: <br><br><img src="https://habrastorage.org/webt/sd/be/iy/sdbeiy6vndddkdjifebk9a7-q2m.png"><br>  <i>Gerenciamento de Tr√°fego de Recursos do Istio</i> <br><br>  <b>Nota</b> : O efeito dos recursos do Istio no tr√°fego da rede √© apresentado aqui de uma maneira simplificada.  Para ser preciso, a decis√£o em qual inst√¢ncia enviar a solicita√ß√£o √© tomada pelo Envoy no Ingress Gateway configurado no CRD. <br><br>  Usando as Regras de destino, podemos configurar o balanceamento de carga para que hashes consistentes sejam usados ‚Äã‚Äãe respostas da mesma inst√¢ncia de servi√ßo sejam garantidas para o mesmo usu√°rio.  A seguinte configura√ß√£o permite que isto ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">destinationrule-sa-frontend.yaml</a> ) consiga isso: <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: sa-frontend spec: host: sa-frontend trafficPolicy: loadBalancer: consistentHash: httpHeaderName: version # 1</code> </pre> <br>  1 - o hash ser√° gerado com base no conte√∫do do cabe√ßalho da <code>version</code> HTTP. <br><br>  Aplique a configura√ß√£o com o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/ab-testing/destinationrule-sa-frontend.yaml destinationrule.networking.istio.io/sa-frontend created</code> </pre> <br>  Agora execute o comando abaixo e certifique-se de obter os arquivos necess√°rios ao especificar o cabe√ßalho da <code>version</code> : <br><br><pre> <code class="bash hljs">$ curl --silent -H <span class="hljs-string"><span class="hljs-string">"version: yogo"</span></span> http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/ | tr <span class="hljs-string"><span class="hljs-string">'"'</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> | grep main</code> </pre> <br>  <b>Nota</b> : para adicionar valores diferentes no cabe√ßalho e testar os resultados diretamente no navegador, voc√™ pode usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esta extens√£o</a> para o Chrome <i>(ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esta</a> para o Firefox - aprox. Transl.)</i> . <br><br>  Em geral, o DestinationRules possui mais op√ß√µes no campo de balanceamento de carga - consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial para</a> obter detalhes. <br><br>  Antes de explorar o VirtualService, removeremos a "vers√£o verde" do aplicativo e a regra correspondente na dire√ß√£o do tr√°fego, executando os seguintes comandos: <br><br><pre> <code class="bash hljs">$ kubectl delete -f resource-manifests/kube/ab-testing/sa-frontend-green-deployment.yaml deployment.extensions ‚Äúsa-frontend-green‚Äù deleted $ kubectl delete -f resource-manifests/istio/ab-testing/destinationrule-sa-frontend.yaml destinationrule.networking.istio.io ‚Äúsa-frontend‚Äù deleted</code> </pre> <br><h2>  Espelhamento: Servi√ßos Virtuais na Pr√°tica </h2><br>  O sombreamento <i>("blindagem")</i> ou o espelhamento <i>("espelhamento")</i> s√£o usados ‚Äã‚Äãnos casos em que queremos testar uma altera√ß√£o na produ√ß√£o sem afetar os usu√°rios finais: para isso, duplicamos ("espelhar") solicita√ß√µes para a segunda inst√¢ncia, onde s√£o feitas as altera√ß√µes necess√°rias, e veja as consequ√™ncias.  <i>Simplificando, √© quando seu (a) colega seleciona a quest√£o mais cr√≠tica e faz uma solicita√ß√£o de puxar na forma de um monte de sujeira t√£o grande que ningu√©m pode realmente fazer uma revis√£o.</i> <br><br>  Para testar esse cen√°rio em a√ß√£o, crie uma segunda inst√¢ncia do SA-Logic com bugs ( <code>buggy</code> ) executando o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube/shadowing/sa-logic-service-buggy.yaml deployment.extensions/sa-logic-buggy created</code> </pre> <br>  E agora executamos o comando para garantir que todas as inst√¢ncias com <code>app=sa-logic</code> tenham r√≥tulos com as vers√µes correspondentes: <br><br><pre> <code class="bash hljs">$ kubectl get pods -l app=sa-logic --show-labels NAME READY LABELS sa-logic-568498cb4d-2sjwj 2/2 app=sa-logic,version=v1 sa-logic-568498cb4d-p4f8c 2/2 app=sa-logic,version=v1 sa-logic-buggy-76dff55847-2fl66 2/2 app=sa-logic,version=v2 sa-logic-buggy-76dff55847-kx8zz 2/2 app=sa-logic,version=v2</code> </pre> <br>  O <code>sa-logic</code> tem como alvo pods com o r√≥tulo <code>app=sa-logic</code> , para que todos os pedidos sejam distribu√≠dos entre todas as inst√¢ncias: <br><br><img src="https://habrastorage.org/webt/6d/po/v8/6dpov8tnmom1j_sr7tcedj7bufo.png"><br><br>  ... mas queremos que as solicita√ß√µes sejam direcionadas para inst√¢ncias com a vers√£o v1 e espelhadas para inst√¢ncias com a vers√£o v2: <br><br><img src="https://habrastorage.org/webt/7u/n6/aj/7un6aj7gerw57imbzmwgkwgjajw.png"><br><br>  Conseguiremos isso atrav√©s do VirtualService em combina√ß√£o com o DestinationRule, onde as regras determinar√£o os subconjuntos e rotas do VirtualService para um subconjunto espec√≠fico. <br><br><h2>  Definindo subconjuntos nas regras de destino </h2><br>  <i>Os subconjuntos s√£o</i> definidos pela seguinte configura√ß√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sa-logic-subsets-destinationrule.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: sa-logic spec: host: sa-logic # 1 subsets: - name: v1 # 2 labels: version: v1 # 3 - name: v2 labels: version: v2</code> </pre> <br><ol><li>  O <code>host</code> determina que esta regra se aplica apenas aos casos em que a rota vai para o <code>sa-logic</code> ; </li><li>  Os nomes dos subconjuntos s√£o usados ‚Äã‚Äãao rotear para inst√¢ncias do subconjunto; </li><li>  Um r√≥tulo define os pares de valores-chave que as inst√¢ncias devem corresponder para se tornar parte de um subconjunto. </li></ol><br>  Aplique a configura√ß√£o com o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/shadowing/sa-logic-subsets-destinationrule.yaml destinationrule.networking.istio.io/sa-logic created</code> </pre> <br>  Agora que os subconjuntos est√£o definidos, voc√™ pode seguir em frente e configurar o VirtualService para aplicar as regras √†s solicita√ß√µes √† sa-logic, para que elas: <br><br><ol><li>  Encaminhado para um subconjunto da <code>v1</code> , </li><li>  Espelhado para um subconjunto da <code>v2</code> . </li></ol><br>  O seguinte manifesto permite que voc√™ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">realize</a> seu plano ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sa-logic-subconjuntos-shadowing-vs. Yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: sa-logic spec: hosts: - sa-logic http: - route: - destination: host: sa-logic subset: v1 mirror: host: sa-logic subset: v2</code> </pre> <br>  Nenhuma explica√ß√£o √© necess√°ria aqui, ent√£o d√™ uma olhada na a√ß√£o: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/shadowing/sa-logic-subsets-shadowing-vs.yaml virtualservice.networking.istio.io/sa-logic created</code> </pre> <br>  Adicione a carga chamando este comando: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> curl -v http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span>; \ sleep .8; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Vejamos os resultados no Grafana, onde podemos ver que a vers√£o com <code>buggy</code> falha em aproximadamente 60% das solicita√ß√µes, mas nenhuma dessas falhas afeta os usu√°rios finais porque eles t√™m um servi√ßo em funcionamento. <br><br><img src="https://habrastorage.org/webt/x3/g6/so/x3g6so65q5jmyjj48-_kjf254de.png"><br>  <i>Sucesso de respostas de diferentes vers√µes do sa-logic</i> <br><br>  Aqui vimos pela primeira vez como o VirtualService √© aplicado aos Envoys de nossos servi√ßos: quando o <code>sa-web-app</code> faz uma solicita√ß√£o √† <code>sa-logic</code> , ele passa pelo Envecar sidecar Envoy, que - atrav√©s do VirtualService - est√° configurado para rotear a solicita√ß√£o para o subconjunto v1 e espelhar uma solicita√ß√£o para um subconjunto da v2 do <code>sa-logic</code> . <br><br>  Eu sei: voc√™ j√° teve tempo de pensar que os Servi√ßos Virtuais s√£o simples.  Na pr√≥xima se√ß√£o, expandimos essa vis√£o pelo fato de que elas tamb√©m s√£o verdadeiramente magn√≠ficas. <br><br><h2>  Canary rolls </h2><br>  O Canary Deployment √© o processo de lan√ßar uma nova vers√£o de um aplicativo para um pequeno n√∫mero de usu√°rios.  √â usado para garantir que n√£o haja problemas no lan√ßamento e somente depois disso, j√° tendo confian√ßa na qualidade suficiente (do lan√ßamento), para se espalhar para <i>um</i> p√∫blico maior. <br><br>  Para demonstrar lan√ßamentos de can√°rios, continuaremos trabalhando com um subconjunto de <code>buggy</code> na <code>sa-logic</code> . <br><br>  N√£o vamos perder tempo com isso e envie imediatamente 20% dos usu√°rios para a vers√£o com bugs (isso representar√° nossa distribui√ß√£o de can√°rios) e os 80% restantes para o servi√ßo normal.  Para fazer isso, aplique o seguinte VirtualService ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sa-logic-subsets-canary-vs.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: sa-logic spec: hosts: - sa-logic http: - route: - destination: host: sa-logic subset: v1 weight: 80 # 1 - destination: host: sa-logic subset: v2 weight: 20 # 1</code> </pre> <br>  1 √© o peso, que determina a porcentagem de solicita√ß√µes que ser√£o enviadas ao destinat√°rio ou a um subconjunto do destinat√°rio. <br><br>  Atualize a configura√ß√£o anterior do VirtualService para <code>sa-logic</code> seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/canary/sa-logic-subsets-canary-vs.yaml virtualservice.networking.istio.io/sa-logic configured</code> </pre> <br>  ... e veja imediatamente que parte das solicita√ß√µes falha: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ curl -i http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span> \ --silent -w <span class="hljs-string"><span class="hljs-string">"Time: %{time_total}s \t Status: %{http_code}\n"</span></span> \ -o /dev/null; sleep .1; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> Time: 0.153075s Status: 200 Time: 0.137581s Status: 200 Time: 0.139345s Status: 200 Time: 30.291806s Status: 500</code> </pre> <br>  Os Servi√ßos Virtuais ativam lan√ßamentos de can√°rios: nesse caso, reduzimos as poss√≠veis conseq√º√™ncias dos problemas para 20% da base de usu√°rios.  √ìtimo!  Agora, em cada caso, quando n√£o temos certeza do nosso c√≥digo (em outras palavras, sempre ...), podemos usar espelhamento e lan√ßamentos de can√°rios. <br><br><h2>  Tempos limite e novas tentativas </h2><br>  Mas nem sempre os erros est√£o no c√≥digo.  Na lista de " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">8 erros na computa√ß√£o distribu√≠da</a> ", em primeiro lugar, aparece a opini√£o err√¥nea de que "a rede √© confi√°vel".  Na realidade, a rede <b>n√£o</b> √© confi√°vel e, por esse motivo, precisamos de tempos limite e <i>novas tentativas</i> . <br><br>  Para demonstra√ß√£o, continuaremos a usar a mesma vers√£o do <code>sa-logic</code> ( <code>buggy</code> ) e simularemos a falta de confiabilidade da rede com falhas aleat√≥rias. <br><br>  Permita que nosso servi√ßo com erros tenha 1/3 de chance de uma resposta muito longa, 1/3 de conclus√£o com um erro interno do servidor e 1/3 de retorno de p√°gina bem-sucedido. <br><br>  Para mitigar as consequ√™ncias de tais problemas e melhorar a vida dos usu√°rios, podemos: <br><br><ol><li>  adicione um tempo limite se o servi√ßo responder por mais de 8 segundos, </li><li>  tente novamente se a solicita√ß√£o falhar. </li></ol><br>  Para implementa√ß√£o, usaremos a seguinte defini√ß√£o de recurso ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sa-logic-retries-timeouts-vs.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: sa-logic spec: hosts: - sa-logic http: - route: - destination: host: sa-logic subset: v1 weight: 50 - destination: host: sa-logic subset: v2 weight: 50 timeout: 8s # 1 retries: attempts: 3 # 2 perTryTimeout: 3s # 3</code> </pre> <br><ol><li>  O tempo limite para a solicita√ß√£o √© definido como 8 segundos; </li><li>  Tentativas repetidas de solicita√ß√£o s√£o feitas 3 vezes; </li><li>  E cada tentativa √© considerada malsucedida se o tempo de resposta exceder 3 segundos. </li></ol><br>  Portanto, alcan√ßamos a otimiza√ß√£o, porque o usu√°rio n√£o precisa esperar mais de 8 segundos e faremos tr√™s novas tentativas para obter uma resposta em caso de falhas, aumentando a chance de uma resposta bem-sucedida. <br><br>  Aplique a configura√ß√£o atualizada com o seguinte comando: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/retries/sa-logic-retries-timeouts-vs.yaml virtualservice.networking.istio.io/sa-logic configured</code> </pre> <br>  E verifique nos gr√°ficos da Grafana se o n√∫mero de respostas bem-sucedidas acabou: <br><br><img src="https://habrastorage.org/webt/ee/l_/qs/eel_qsg8z2vwzjwi35xmqg6eiko.png"><br>  <i>Melhorias nas estat√≠sticas de respostas bem-sucedidas ap√≥s adicionar tempos limite e novas tentativas</i> <br><br>  Antes de prosseguir para a pr√≥xima se√ß√£o <i>(ou melhor, para a pr√≥xima parte do artigo, porque n√£o haver√° mais experimentos nesta pr√°tica - aprox. Transl.)</i> , Exclua <code>sa-logic-buggy</code> e VirtualService executando os seguintes comandos: <br><br><pre> <code class="bash hljs">$ kubectl delete deployment sa-logic-buggy deployment.extensions ‚Äúsa-logic-buggy‚Äù deleted $ kubectl delete virtualservice sa-logic virtualservice.networking.istio.io ‚Äúsa-logic‚Äù deleted</code> </pre> <br><h2>  Padr√µes de disjuntor e anteparo </h2><br>  Estamos falando de dois padr√µes importantes na arquitetura de microsservi√ßos que permitem obter servi√ßos de <i>autocorre√ß√£o</i> . <br><br>  <b>O disjuntor</b> <i>("disjuntor") √©</i> usado para interromper as solicita√ß√µes que chegam a uma inst√¢ncia de um servi√ßo considerado n√£o √≠ntegro e restaur√°-lo enquanto as solicita√ß√µes do cliente s√£o redirecionadas para inst√¢ncias √≠ntegras desse servi√ßo (o que aumenta a porcentagem de respostas bem-sucedidas).  <i>(Nota: Uma descri√ß√£o mais detalhada do padr√£o pode ser encontrada, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .)</i> <br><br>  <b>O anteparo</b> <i>("parti√ß√£o")</i> isola as falhas de servi√ßo da derrota de todo o sistema.  Por exemplo, o servi√ßo B est√° quebrado e outro servi√ßo (o cliente do servi√ßo B) faz uma solicita√ß√£o para o servi√ßo B, como resultado do qual ele usar√° seu pool de encadeamentos e n√£o poder√° atender a outras solicita√ß√µes (mesmo que n√£o estejam relacionadas ao servi√ßo B).  <i>(Nota: Uma descri√ß√£o mais detalhada do padr√£o pode ser encontrada, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .)</i> <br><br>  Omitirei os detalhes sobre a implementa√ß√£o desses padr√µes, porque eles s√£o f√°ceis de encontrar na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> e quero realmente mostrar autentica√ß√£o e autoriza√ß√£o, que ser√£o discutidas na pr√≥xima parte do artigo. <br><br><h2>  PS do tradutor </h2><br>  Leia tamb√©m em nosso blog: <br><br><ul><li>  ‚ÄúVoltar aos microsservi√ßos com o Istio‚Äù: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 1 (familiaridade com os principais recursos)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 3 (autentica√ß√£o e autoriza√ß√£o)</a> ; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Condu√≠te - uma malha de servi√ßo leve para o Kubernetes</a> "; </li><li>  ‚Äú <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que √© uma malha de servi√ßo e por que preciso dela [para um aplicativo em nuvem com microsservi√ßos]?</a>  " </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt440378/">https://habr.com/ru/post/pt440378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt440366/index.html">Ciclo de vida de um artigo sobre Habr√©: escrevemos um habraparser</a></li>
<li><a href="../pt440370/index.html">Termos de servi√ßo: 99% dos usu√°rios simplesmente n√£o os entendem</a></li>
<li><a href="../pt440372/index.html">Meu compilador Pascal e arte contempor√¢nea polonesa</a></li>
<li><a href="../pt440374/index.html">Fun√ß√µes Yandex enviam email</a></li>
<li><a href="../pt440376/index.html">20 jogos para ensinar a programa√ß√£o do seu filho</a></li>
<li><a href="../pt440382/index.html">200 √© bom ou ruim?</a></li>
<li><a href="../pt440386/index.html">Liberando a manipula√ß√£o de erros eliminando erros</a></li>
<li><a href="../pt440388/index.html">Intervalos: A pr√≥xima evolu√ß√£o do C ++</a></li>
<li><a href="../pt440390/index.html">O mundo diversificado dos sistemas embarcados e o lugar da Embox nele</a></li>
<li><a href="../pt440392/index.html">WebRTC no seu site - sem bugs e sem or√ßamento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>