<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè© üë©üèª‚Äçüöí üë©üèª‚Äçüè≠ Explorando formatos bin√°rios usando o arquivo .class bytecode como exemplo. üíü üêâ üëõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se voc√™ n√£o tem medo da imagem acima, se voc√™ sabe como o big-endian difere do little-endian, se voc√™ sempre esteve interessado em saber como os arqui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Explorando formatos bin√°rios usando o arquivo .class bytecode como exemplo.</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481260/"><p><img src="https://habrastorage.org/webt/2-/ht/7w/2-ht7w15prc6owrbxqrljbxmq0g.png" alt="imagem"></p><br><p>  Se voc√™ n√£o tem medo da imagem acima, se voc√™ sabe como o big-endian difere do little-endian, se voc√™ sempre esteve interessado em saber como os arquivos bin√°rios s√£o "organizados", este artigo √© para VOC√ä! </p><a name="habracut"></a><br><h1 id="vvedenie">  1. Introdu√ß√£o </h1><br><p>  Em Habr√© j√° havia v√°rios artigos sobre engenharia reversa de formatos bin√°rios e sobre o estudo da estrutura de bytecode de um arquivo .class: <br>  <a href="https://habr.com/ru/post/222519/">Pool de constantes</a> <br>  <a href="https://habr.com/ru/post/111456/">Fundamentos de Bytecode Java</a> , <br>  <a href="https://habr.com/ru/post/264919/">Bytecode Java "Ol√°, mundo"</a> , <br>  <a href="https://habr.com/ru/post/480550/">Ol√° Mundo da bytecode para JVM</a> etc. <br>  O pesquisador tem a tarefa de lidar com um protocolo bin√°rio desconhecido ou cavar uma estrutura bin√°ria para a qual existe uma especifica√ß√£o. </p><br><p>  Meu interesse em formatos bin√°rios surgiu mesmo quando eu era estudante e escrevi um artigo sobre o desenvolvimento do driver do sistema de arquivos Linux.  Alguns anos depois, dei palestras sobre os fundamentos do Linux para especialistas forenses - antigamente, o Linux era novo e um jovem especialista depois da universidade podia contar muitas coisas novas para especialistas adultos.  Falando sobre como remover um despejo de um disco usando o dd, e depois de conectar a imagem a outro computador para estudo, percebi que a imagem do disco cont√©m muitas informa√ß√µes interessantes.  Essas informa√ß√µes podem ser extra√≠das mesmo sem a montagem da imagem (huh, mount -o loop ...) se voc√™ soubesse a especifica√ß√£o para o formato do sistema de arquivos e tivesse as ferramentas apropriadas.  Infelizmente, eu n√£o tinha essas ferramentas. </p><br><p>  Depois de alguns anos, eu precisava descompilar a biblioteca Java.  N√£o havia JD GUI naqueles dias, assim como um descompilador ideol√≥gico, mas havia JAD.  Para minha biblioteca, o JAD produziu uma mistura de c√≥digos de c√≥digo Java com mensagens de erro.  Al√©m disso, o JAD n√£o suportava anota√ß√µes e, no Java 6, que apareceu ent√£o, elas eram usadas ao m√°ximo.  Armado com a especifica√ß√£o da m√°quina virtual Java, comecei ... </p><br><h1 id="ideya">  Id√©ia </h1><br><p>  Eu precisava de um mecanismo universal para descrever estruturas bin√°rias e um carregador universal.  O carregador, usando a descri√ß√£o, ler√° os dados bin√°rios na mem√≥ria.  Voc√™ geralmente precisa lidar com n√∫meros, seq√º√™ncias de caracteres, matrizes de dados e estruturas compostas.  Tudo √© simples com n√∫meros - eles t√™m um comprimento fixo - 1, 2, 4 ou 8 bytes e podem ser mapeados imediatamente para os tipos de dados dispon√≠veis no idioma.  Por exemplo: byte, curto, int, longo para Java.  Para tipos num√©ricos com mais de um byte, um marcador de ordem de bytes (a chamada representa√ß√£o BigEndian / LittleEndiang) deve ser fornecido. </p><br><p>  As strings s√£o mais complicadas - elas podem estar em codifica√ß√µes diferentes (ASCII, UNICODE), ter um comprimento fixo ou vari√°vel.  Uma cadeia de comprimento fixo pode ser considerada como uma matriz de bytes.  Para strings de comprimento vari√°vel, voc√™ pode usar duas op√ß√µes de grava√ß√£o - indique seu comprimento no in√≠cio da linha (strings com prefixo Pascal ou Length) ou coloque um caractere especial no final da linha para indicar o final da linha.  Como tal sinal, √© utilizado um byte com valor zero (os chamados srings terminados em nulo).  Ambas as op√ß√µes t√™m vantagens e desvantagens, cuja discuss√£o est√° al√©m do escopo deste artigo.  Se o tamanho for especificado no in√≠cio, ao desenvolver o formato, voc√™ precisar√° decidir sobre o comprimento m√°ximo da string: quantos bytes precisamos alocar para o marcador de comprimento depende disso: 2 <sup>8</sup> - 1 para um byte, 2 <sup>16</sup> - 1 para dois bytes, etc. </p><br><p>  Vamos distinguir estruturas de dados compostos em classes separadas, continuando a decomposi√ß√£o em n√∫meros e seq√º√™ncias de caracteres. </p><br><h1 id="struktura-class-fayla">  Estrutura do arquivo .class </h1><br><p>  Precisamos descrever de alguma forma a estrutura do arquivo .class Java.  Como resultado, eu gostaria de ter um conjunto de classes Java, em que cada classe cont√©m apenas campos que correspondem √† estrutura de dados em estudo e, possivelmente, m√©todos auxiliares para exibir o objeto em um formato leg√≠vel por humanos quando o m√©todo toString () √© chamado.  Categoricamente, eu n√£o gostaria de ter a l√≥gica interna respons√°vel pela leitura ou grava√ß√£o de um arquivo. </p><br><p>  Tomamos a especifica√ß√£o da m√°quina virtual Java, <br>  <a href="https://docs.oracle.com/javase/specs/jvms/se12/jvms12.pdf" rel="nofollow">Especifica√ß√£o da JVM, Java SE 12 Edition</a> . <br>  Estaremos interessados ‚Äã‚Äãna se√ß√£o 4 "A classe File Format". </p><br><p>  Para determinar quais campos em que ordem carregar, introduzimos a anota√ß√£o @FieldOrder (index = ...).  Precisamos indicar explicitamente a ordem dos campos para o carregador, pois a especifica√ß√£o n√£o nos d√° uma garantia da ordem em que eles ser√£o salvos em um arquivo bin√°rio. </p><br><p>  O arquivo .class Java inicia com 4 bytes de n√∫mero m√°gico, dois bytes da vers√£o secund√°ria do Java e dois bytes da vers√£o principal.  Empacotamos o n√∫mero m√°gico na vari√°vel int e o n√∫mero da vers√£o secund√°ria e secund√°ria em resumo: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> magic; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> minorVersion; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> majorVersion;</code> </pre> <br><p>  Al√©m disso, no arquivo .class, est√° o tamanho do pool constante (vari√°vel de dois bytes) e o pr√≥prio pool constante.  Introduzimos a anota√ß√£o @ContainerSize para declarar o tamanho de matrizes e estruturas de lista.  O tamanho pode ser fixo (vamos defini-lo atrav√©s do atributo value) ou ter um comprimento vari√°vel, determinado pela vari√°vel lida anteriormente.  Nesse caso, usaremos o atributo "fieldName", que indica de qual vari√°vel iremos ler o tamanho do cont√™iner.  De acordo com a especifica√ß√£o (se√ß√£o 4.1, <br>  "The ClassFile Structure"), o tamanho real do pool constante difere em 1 do valor <br>  que √© gravado em constant_pool_count: </p><br><pre> <code class="plaintext hljs">u2 constant_pool_count; cp_info constant_pool[constant_pool_count-1];</code> </pre> <br><p>  Para explicar essas corre√ß√µes, introduzimos um atributo de corretor adicional nas anota√ß√µes @ContainerSize. <br>  Agora podemos adicionar uma descri√ß√£o do pool constante: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> constantPoolCount; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"constantPoolCount"</span></span>, corrector = -<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ConstantPoolItem&gt; constantPoolList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;();</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">No caso de c√°lculos mais complexos, voc√™ pode simplesmente adicionar um m√©todo get que retornar√° o valor desejado:</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> containerSize; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(filed=<span class="hljs-string"><span class="hljs-string">"actualContainerSize"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ContainerItem&gt; containerItems; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActualContainerSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> containerSize * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> </div></div><br><h1 id="constant-pool">  Piscina constante </h1><br><p>  Cada elemento no conjunto de constantes √© uma descri√ß√£o da constante correspondente do tipo int, long, float, double, String ou uma descri√ß√£o de um dos componentes da classe Java - campos (campos) da classe Java, m√©todos, assinaturas de m√©todos etc.  O termo "constante" aqui significa um valor sem nome usado no c√≥digo: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (intValue &gt; <span class="hljs-number"><span class="hljs-number">100500</span></span>)</code> </pre> <br><p>  Um valor de 100500 ser√° representado no pool constante como uma inst√¢ncia de CONSTANT_Integer.  A especifica√ß√£o da JVM para Java 12 define 17 tipos que podem estar em um conjunto constante. </p><br><div class="spoiler">  <b class="spoiler_title">Poss√≠veis inst√¢ncias de elementos do conjunto const</b> <div class="spoiler_text"><div class="scrollable-table"><table><thead><tr><th>  Tipo constante </th><th>  Tag </th></tr></thead><tbody><tr><td>  CONSTANT_Class </td><td>  7 </td></tr><tr><td>  CONSTANT_Fieldref </td><td>  9 </td></tr><tr><td>  CONSTANT_Methodref </td><td>  10 </td></tr><tr><td>  CONSTANT_InterfaceMethodref </td><td>  11 </td></tr><tr><td>  CONSTANT_String </td><td>  8 </td></tr><tr><td>  CONSTANT_Integer </td><td>  3 </td></tr><tr><td>  CONSTANT_Float </td><td>  4 </td></tr><tr><td>  CONSTANT_Long </td><td>  5 </td></tr><tr><td>  CONSTANT_Double </td><td>  6 </td></tr><tr><td>  CONSTANT_NameAndType </td><td>  12 </td></tr><tr><td>  CONSTANT_Utf8 </td><td>  1 </td></tr><tr><td>  CONSTANT_MethodHandle </td><td>  15 </td></tr><tr><td>  CONSTANT_MethodType </td><td>  16 </td></tr><tr><td>  CONSTANT_Dynamic </td><td>  17 </td></tr><tr><td>  CONSTANT_InvokeDynamic </td><td>  18 </td></tr><tr><td>  CONSTANT_Module </td><td>  19 </td></tr><tr><td>  CONSTANT_Package </td><td>  20 </td></tr></tbody></table></div></div></div><br><p>  Em nossa implementa√ß√£o, criaremos uma classe ConstantPoolItem na qual haver√° uma tag de campo de byte √∫nico, que determina qual estrutura estamos lendo no momento.  Para cada elemento da tabela acima, crie uma classe Java, um descendente de ConstantPoolItem.  Um carregador de arquivos bin√°rios universal deve poder determinar qual classe deve ser usada com base em uma marca j√° lida. <br>  (em geral, uma tag pode ser uma vari√°vel de qualquer tipo).  Para esse fim, defina a interface HasInheritor e implemente essa interface na classe ConstantPoolItem: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasInheritor</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends T&gt; getInheritor() <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> InheritorNotFoundException; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Collection&lt;Class&lt;? extends T&gt;&gt; getInheritors(); }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstantPoolItem</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasInheritor</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstantPoolItem</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Map&lt;Byte, Class&lt;? extends ConstantPoolItem&gt;&gt; m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>, ClassInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>, FieldRefInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">10</span></span>, MethodRefInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">11</span></span>, InterfaceMethodRefInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">8</span></span>, StringInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span>, IntegerInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span>, FloatInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">5</span></span>, LongInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span>, DoubleInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">12</span></span>, NameAndTypeInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>, Utf8Info.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">15</span></span>, MethodHandleInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>, MethodTypeInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span>, DynamicInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">18</span></span>, InvokeDynamicInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">19</span></span>, ModuleInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">20</span></span>, PackageInfo.class); } <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> tag; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends ConstantPoolItem&gt; getInheritor() <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> InheritorNotFoundException { Class&lt;? extends ConstantPoolItem&gt; clazz = m.get(tag); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clazz == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InheritorNotFoundException(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getClass().getName(), String.valueOf(tag)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> clazz; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Collection&lt;Class&lt;? extends ConstantPoolItem&gt;&gt; getInheritors() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m.values(); } }</code> </pre> <br><p>  O carregador universal instancia a classe necess√°ria e continua lendo.  A √∫nica condi√ß√£o: os √≠ndices nas classes sucessoras devem ter numera√ß√£o de ponta a ponta com a classe pai.  Isso significa que em todas as classes derivadas de ConstantPoolItem, FieldOrder, a anota√ß√£o deve ter um √≠ndice maior que um, pois na classe pai j√° lemos o campo de tag com o n√∫mero "1". </p><br><h1 id="struktura-class-fayla-prodolzhenie">  Estrutura do arquivo .class (continua√ß√£o) </h1><br><p>  Ap√≥s a lista de elementos do pool constante no arquivo .class, h√° um identificador de dois bytes que define os detalhes dessa classe - a classe √© uma anota√ß√£o, uma interface, uma classe abstrata, possui um sinalizador final etc.  Isso √© seguido por um identificador de dois bytes (uma refer√™ncia a um elemento no pool constante) que define essa classe.  Este identificador deve apontar para um elemento do tipo ClassInfo.  A superclasse para uma determinada classe √© definida de maneira semelhante (o que √© indicado ap√≥s a palavra "estender" na defini√ß√£o da classe).  Para classes que n√£o possuem superclasses explicitamente definidas, este campo cont√©m uma refer√™ncia √† classe Object. </p><br><p>  Em Java, qualquer classe pode ter apenas uma superclasse, mas o n√∫mero <br>  Pode haver v√°rias interfaces que essa classe implementa: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> interfacesCount; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"interfacesCount"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Short&gt; interfaceIndexList;</code> </pre> <br><p>  Cada elemento em interfaceIndexList representa um link para um elemento no pool constante (conforme especificado <br>  o √≠ndice deve ser um elemento do tipo ClassInfo). <br>  Vari√°veis ‚Äã‚Äãde classe (propriedades, campos) e m√©todos s√£o representados pelas listas correspondentes: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> fieldsCount; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"fieldsCount"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Field&gt; fieldList; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> methodsCount; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"methodsCount"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Method&gt; methodList;</code> </pre> <br><p>  O elemento final na descri√ß√£o do arquivo .class Java √© a lista de atributos de classe.  Os atributos que descrevem o arquivo de origem relacionado √† classe, classes aninhadas etc. podem ser listados aqui. </p><br><p>  O bytecode Java opera com dados num√©ricos em uma representa√ß√£o big endian; usaremos essa representa√ß√£o por padr√£o.  Para formatos bin√°rios com n√∫meros little-endian, usaremos a anota√ß√£o <a href="https://habr.com/ru/users/littleendian/" class="user_link">LittleEndian</a> .  Para cadeias que n√£o t√™m um comprimento predefinido, mas <br>  s√£o lidos antes do caractere terminal (como cadeias terminadas em nulo do tipo C), usaremos <br>  Anota√ß√£o @StringTerminator: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@StringTerminator</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String nullTerminatedString;</code> </pre> <br><p>  √Äs vezes, nas classes subjacentes, voc√™ precisa encaminhar informa√ß√µes de um n√≠vel superior.  O objeto Method em methodList n√£o possui informa√ß√µes sobre o nome da classe em que est√° localizado; al√©m disso, o objeto de m√©todo n√£o cont√©m seu nome e lista de par√¢metros.  Toda esta informa√ß√£o √© apresentada como √≠ndices sobre os elementos no pool constante.  Isso √© suficiente para uma m√°quina virtual, mas gostar√≠amos de implementar os m√©todos toString () para que eles exibam informa√ß√µes sobre o m√©todo de forma amig√°vel ao ser humano, e n√£o na forma de √≠ndices de elementos no pool constante.  Para fazer isso, a classe Method deve obter uma refer√™ncia ao ConstantPoolList e a uma vari√°vel com o valor thisClassIndex.  Para poder transmitir links para os n√≠veis subjacentes de aninhamento, usaremos a anota√ß√£o <a href="https://habr.com/ru/users/inject/" class="user_link">Injetar</a> : </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"methodsCount"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"constantPoolList"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"thisClassIndex"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Method&gt; methodList;</code> </pre> <br><p>  Na classe atual (ClassFile), os m√©todos getter ser√£o chamados para as vari√°veis ‚Äã‚ÄãconstantPoolList e thisClassIndex, e na classe receptora (neste caso, Method), os m√©todos setter ser√£o chamados (se estiverem presentes). </p><br><h1 id="universalnyy-zagruzchik">  Carregador de inicializa√ß√£o universal </h1><br><p>  Portanto, temos uma interface HasInheritor e cinco anota√ß√µes @FieldOrder, @ContainerSize, <a href="https://habr.com/ru/users/littleendian/" class="user_link">LittleEndian</a> , <a href="https://habr.com/ru/users/inject/" class="user_link">Inject</a> e @StringTerminator, que nos permitem descrever estruturas bin√°rias em um alto n√≠vel de abstra√ß√£o.  Tendo uma descri√ß√£o formal, podemos transmiti-la ao carregador universal, que pode instanciar a estrutura descrita, analisar o arquivo bin√°rio e l√™-lo na mem√≥ria. </p><br><p>  Como resultado, devemos poder usar este c√≥digo: </p><br><pre> <code class="java hljs"> ClassFile classFile; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream is = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(inputFileName)) { Loader loader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamLoader(is); classFile = (ClassFile) loader.load(); }</code> </pre> <br><p>  Infelizmente, os desenvolvedores da plataforma Java s√£o um pouco sofisticados demais para valores de oito bytes no pool. <br>  constantes s√£o fornecidas para duas c√©lulas, a primeira c√©lula deve conter um valor e a segunda permanece <br>  vazio.  Isso se aplica a constantes longas e duplas. </p><br><div class="spoiler">  <b class="spoiler_title">Descri√ß√£o da especifica√ß√£o da JVM</b> <div class="spoiler_text"><p>  Todas as constantes de 8 bytes ocupam duas entradas na tabela constant_pool da classe <br>  arquivo  Se uma estrutura CONSTANT_Long_info ou CONSTANT_Double_info for a entrada <br>  no √≠ndice n na tabela constant_pool, a pr√≥xima entrada utiliz√°vel na tabela √© <br>  localizado no √≠ndice n + 2.  O √≠ndice constant_pool n + 1 deve ser v√°lido, mas √© considerado <br>  inutiliz√°vel. </p></div></div><br>  Aparentemente, os desenvolvedores de Java queriam aplicar algum tipo de otimiza√ß√£o de baixo n√≠vel, mas mais tarde <br>  Reconheceu-se que esta decis√£o de projeto virou <br><div class="spoiler">  <b class="spoiler_title">sem sucesso.</b> <div class="spoiler_text"><p>  Em retrospecto, fazer constantes de 8 bytes tomar duas entradas constantes no pool foi uma m√° escolha. </p></div></div><br><p>  Para lidar com esses casos espec√≠ficos, adicionaremos a anota√ß√£o @EntrySize, que usaremos, <br>  para marcar constantes de oito bytes: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EntrySize</span></span>(value = <span class="hljs-number"><span class="hljs-number">2</span></span>, index = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EightByteNumberInfo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstantPoolItem</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> highBytes; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lowBytes; }</code> </pre> <br><p>  O atributo value indica o n√∫mero de c√©lulas que o elemento ocupar√°, index - o √≠ndice do elemento, <br>  que cont√©m o valor  as classes LongInfo e DoubleInfo estender√£o a classe EightByteNumberInfo. <br>  O carregador de inicializa√ß√£o universal precisar√° ser expandido com um suporte funcional √† anota√ß√£o @EntrySize. </p><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClassFileLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fileName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { File f = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(fileName); FileInputStream fis = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(f); loader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntrySizeSupportLoader(fis); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FileNotFoundException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } }</code> </pre> <br><p>  Ap√≥s carregar a classe com ClassFileLoader, voc√™ pode parar o depurador e examinar a classe carregada no inspetor de vari√°veis ‚Äã‚Äãno IDE. </p><br><p>  O arquivo de classe ficar√° assim: <br><img src="https://habrastorage.org/webt/s6/jg/p_/s6jgp_an_ouz-lfdtc39d8gxd88.png" alt="imagem"></p><br><p>  E o Constant Pool √© assim: <br><img src="https://habrastorage.org/webt/5f/u4/sk/5fu4skrhx-jxhjjyiju4nc_apj0.png" alt="imagem"></p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>  Qualquer pessoa que possa ler at√© o final pode querer escolher o bytecode Java com suas pr√≥prias m√£os.  Sinta-se √† vontade para acessar o github e fazer o download da descri√ß√£o do arquivo de classe Java como um conjunto de classes Java: <a href="https://github.com/esavin/annotate4j-classfile" rel="nofollow">https://github.com/esavin/annotate4j-classfile</a> .  O carregador universal e as anota√ß√µes est√£o aqui: <a href="https://github.com/esavin/annotate4j-core" rel="nofollow">https://github.com/esavin/annotate4j-core</a> . </p><br><p>  Para baixar um arquivo de classe compilado, use o carregador annotate4j.classfile.loader.ClassFileLoader. </p><br><p>  A maior parte do c√≥digo foi escrita para Java 6; adaptei apenas o pool constante √†s vers√µes modernas.  Eu n√£o tinha for√ßa e desejo de implementar completamente o Java loader para Java opcodes, portanto, existem apenas pequenos desenvolvimentos nesta parte. </p><br><p>  Utilizando esta biblioteca (parte principal), consegui reverter o arquivo bin√°rio com os dados de monitoramento de Holter (estudo de ECG da atividade card√≠aca di√°ria).  Por outro lado, n√£o consegui decifrar o protocolo bin√°rio de um sistema de contabilidade escrito em Delphi.  N√£o entendi como as datas s√£o transmitidas e, √†s vezes, surgia uma situa√ß√£o em que os dados reais n√£o correspondiam √† estrutura constru√≠da com os valores anteriores. </p><br><p>  Tentei criar um modelo semelhante ao arquivo de classe Java para o formato ELF (formato execut√°vel no Unix / Linux), mas n√£o conseguia entender completamente a especifica√ß√£o - ela acabou sendo muito vaga para mim.  O mesmo destino aconteceu nos formatos JPEG e BMP - o tempo todo me deparei com algumas dificuldades em entender a especifica√ß√£o. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481260/">https://habr.com/ru/post/pt481260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481250/index.html">AI vs testadores, Brandashmyg, patos: como foi o Heisenbug 2019 Moscou</a></li>
<li><a href="../pt481252/index.html">Ativamos o suporte NVMe em placas-m√£e antigas usando o Asus P9X79 WS como exemplo</a></li>
<li><a href="../pt481254/index.html">Programador fan√°tico. Sinopse parte 1. Por que voc√™ precisa ser pior e n√£o ouvir os conselhos dos pais</a></li>
<li><a href="../pt481256/index.html">Qual startup devo iniciar amanh√£?</a></li>
<li><a href="../pt481258/index.html">Colamos a moldura da escuna sem registro e SMS</a></li>
<li><a href="../pt481264/index.html">Quantas pessoas veem seu √≠cone na App Store durante o aplicativo "App of the Day"</a></li>
<li><a href="../pt481272/index.html">Congelamento ou moderniza√ß√£o - o que fazemos nas f√©rias?</a></li>
<li><a href="../pt481276/index.html">Como eu criei meu YP e compilador para ele por 12 anos</a></li>
<li><a href="../pt481280/index.html">Como preparamos a etapa de qualifica√ß√£o da CTFZone-2020</a></li>
<li><a href="../pt481282/index.html">Qual √© o valor da ideia e como transform√°-la em conceito: ferramentas de designer de jogos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>