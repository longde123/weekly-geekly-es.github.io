<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÑ ‚Ü™Ô∏è üè¢ Salte para a nuvem. Criando uma solu√ß√£o de IoT de or√ßamento no Hub IoT do NodeMCU + Azure üë©üèª‚Äç‚öñÔ∏è üìë üöª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O destino mais popular para dispositivos IoT √© a cole√ß√£o de telemetria. At√© o momento, os pre√ßos dos servi√ßos de IoT na nuvem diminu√≠ram tanto que mes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Salte para a nuvem. Criando uma solu√ß√£o de IoT de or√ßamento no Hub IoT do NodeMCU + Azure</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/421847/"><p>  O destino mais popular para dispositivos IoT √© a cole√ß√£o de telemetria.  At√© o momento, os pre√ßos dos servi√ßos de IoT na nuvem diminu√≠ram tanto que mesmo um usu√°rio comum pode se dar ao luxo de us√°-los.  Hoje falaremos sobre como enviar dados para a nuvem da placa do NodeMCU usando a linguagem Lua. </p><br><p><img src="https://habrastorage.org/webt/k3/f5/nx/k3f5nxom4hfjshqqwpgl43ppjwo.jpeg"><a name="habracut"></a></p><br><p>  <em>Nota: continuamos a s√©rie de publica√ß√µes de vers√µes completas de artigos da revista Hacker.</em>  <em>Ortografia e pontua√ß√£o do autor salvas.</em> </p><br><p>  Dou a palavra ao autor. </p><br><p>  Como trabalho na pilha de tecnologia da Microsoft, uso o Azure Functions e Table Storage para criar a parte da nuvem da solu√ß√£o IoT, mas meu PoC para NodeMCU e Lua tamb√©m podem ser usados ‚Äã‚Äãcom outros provedores de solu√ß√µes de IoT na nuvem. </p><br><h1>  INFO </h1><br><p>  O Expressif NodeMCU √© uma das placas-m√£e mais acess√≠veis com Wi-Fi, micro USB e programador integrado.  √â baseado no m√≥dulo ESP8266.  A placa de segunda gera√ß√£o pode ser comprada por cerca de US $ 6-7.  Voc√™ pode trabalhar com a placa no IDE do Arduino.  Al√©m disso, o conselho suporta uma linguagem de script chamada Lua (traduzida do portugu√™s como ‚ÄúLua‚Äù). </p><br><h2>  Conecte e configure o dispositivo </h2><br><p>  Para que o dispositivo seja reconhecido no Windows, √© necess√°rio baixar o driver no seguinte link: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CP210x USB para UART Bridge VCP Drivers</a> </p><br><p> A velocidade da porta serial padr√£o do NodeMCU √© 115'200bps.  Voc√™ pode definir uma velocidade diferente. Na primeira redefini√ß√£o do dispositivo, ele retornar√° para 115200. <br>  √â importante que o driver esteja configurado exatamente na mesma velocidade: </p><br><p><img src="https://habrastorage.org/webt/ce/sq/y5/cesqy5kslu5pos-rrdqsxvch-vo.png"></p><br><h2>  Firmware </h2><br><p>  Provavelmente, algo estar√° faltando no firmware inicial, portanto, idealmente, voc√™ mesmo estar√° piscando o dispositivo.  Existem v√°rias maneiras de criar uma imagem de firmware.  Usando um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servi√ßo de nuvem</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma imagem do Docker</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instru√ß√µes para Linux</a> .  Eu coletei usando um servi√ßo de nuvem.  Tamb√©m aconselho essa op√ß√£o. </p><br><p>  Se voc√™ precisar enviar dados para a nuvem, as funcionalidades necess√°rias para a sele√ß√£o ser√£o SNTP, MQTT, HTTP (WiFi, timer, arquivo, GPIO, rede, n√≥, UART j√° est√£o selecionados por padr√£o).  Tamb√©m √© necess√°rio marcar como suporte TLS / SSL necess√°rio em Op√ß√µes diversas <br>  O link com o arquivo bin chega ao correio.  Mais precisamente, at√© 2 links v√™m imediatamente.  Uma com uma imagem que suporta opera√ß√µes de ponto flutuante e a segunda com uma que n√£o suporta. </p><br><p>  Antes de piscar o ESP8266, voc√™ deve traz√™-lo para o modo especial.  H√° um bot√£o FLASH separado no quadro.  Pressionar durante a inicializa√ß√£o ou pressionar redefinir leva o dispositivo ao modo de carregador de inicializa√ß√£o.  Se de repente n√£o houver esse bot√£o na modifica√ß√£o da sua placa, antes de piscar, voc√™ precisar√° conectar o GPIO0 ao GND e pressionar reset (este m√©todo √© adequado para o ESP-12). </p><br><p>  O firmware pode ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">atualizado</a> com o utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PyFlasher</a> .  Py no nome significa que o aplicativo est√° escrito em Python.  H√° tamb√©m <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nodemcu-pisca-pisca</a> , mas n√£o foi atualizado por um longo tempo.  Eu n√£o tentei. </p><br><p>  A janela do PyFlasher fica assim: </p><br><p><img src="https://habrastorage.org/webt/1a/ns/rh/1ansrh_oc-zpqvaif8eujfvetvg.png"></p><br><p>  O modo Flash √© selecionado dependendo da placa que voc√™ possui.  A maioria das placas-m√£e modernas baseadas nos m√≥dulos ESP8266 ESP-12 e ESP32 usam o modo DIO.  O ESP8266 01 a 07 se encaixa no modo QIO mais r√°pido.  DOUT √© usado pelo ESP8285. </p><br><h2>  Configura√ß√£o do IDE </h2><br><p>  Fa√ßa o download do IDE gratuito no link do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ESPlorer</a> .  Alternativamente, existe o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ZeroBrane Studio</a> .  Gostei mais do ESPlorer, ent√£o vou dar um exemplo de como trabalhar com ele.  O ESPlorer est√° escrito em JAVA.  A interface do aplicativo √© </p><br><p><img src="https://habrastorage.org/webt/gi/lj/vs/giljvs_zxesytj7k52d_nlka_u8.png"></p><br><p>  No lado esquerdo √© o c√≥digo, configura√ß√µes e algumas outras funcionalidades semelhantes.  √Ä direita est√° a janela de monitoramento e os comandos de gerenciamento de dispositivos.  Abra o aplicativo, selecione a porta.  Defina a velocidade com que a troca ocorrer√° (provavelmente 115200) e clique em Abrir. </p><br><p><img src="https://habrastorage.org/webt/1p/iq/xr/1piqxr933-f-nwkk6wagwtw42ea.png"></p><br><p>  Para aquecer, voc√™ pode executar um script simples que pisca com um LED embutido: </p><br><pre><code class="hljs powershell">LED = <span class="hljs-number"><span class="hljs-number">0</span></span> gpio.mode(LED, gpio.OUTPUT) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash_led</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.LOW)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(500000)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.HIGH)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1, 1000, tmr.ALARM_AUTO, flash_led)</span></span></span></span></code> </pre> <br><p>  Se sua placa n√£o possui um LED embutido (ou voc√™ est√° completamente cansado de exemplos de LED = = piscando), tente executar um script ainda mais simples que exibe a linha: </p><br><pre> <code class="hljs swift"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from Lua!"</span></span>)</code> </pre> <br><p>  Depois de criar um arquivo .lua (por exemplo, test.lua), adicione o c√≥digo e salve-o em disco, voc√™ pode baix√°-lo no seu dispositivo.  Para fazer isso, abra a porta, se n√£o estiver aberta (bot√£o Abrir) e clique no bot√£o Carregar.  Voc√™ pode encontr√°-lo entre os bot√µes localizados abaixo do c√≥digo (√† esquerda). </p><br><p>  Ap√≥s o download do arquivo, voc√™ pode execut√°-lo enviando o comando: </p><br><pre> <code class="hljs lisp">dofile(<span class="hljs-string"><span class="hljs-string">"test.lua"</span></span>)</code> </pre> <br><p>  O comando pode ser inserido manualmente no campo inferior localizado √† direita sob o monitor.  Ou, se voc√™ n√£o quiser digitar nenhum texto, clique no bot√£o Recarregar (a linha extrema de bot√µes √† direita).  Depois de clicar nesse bot√£o, voc√™ receber√° uma lista de bot√µes com os arquivos .lua carregados no quadro.  Ao clicar no bot√£o com o nome do arquivo, o arquivo ser√° executado para execu√ß√£o. </p><br><p>  Se voc√™ deseja que o arquivo seja iniciado imediatamente ap√≥s ligar o quadro, crie um arquivo chamado init.lua. </p><br><h2>  Configurando a parte da nuvem para trabalhar com o dispositivo </h2><br><p>  Vamos deixar nosso dispositivo por um tempo e criar o seu dobro na nuvem.  Recentemente, um dispositivo duplo pode ser criado diretamente no portal do Azure, usando a nova funcionalidade.  No grupo de configura√ß√µes do hub IoT chamado Explorers, voc√™ precisa selecionar Dispositivos IoT e clicar em "+ Adicionar" </p><br><p>  Para conectar o dispositivo ao hub IoT, precisamos gerar SAS (assinatura de acesso compartilhado).  Para gerar o SAS, √© usada uma chave dupla do dispositivo, que pode ser obtida usando algum utilit√°rio auxiliar (Device Explorer, iothub-explorer, IoT Extension for Azure CLI 2.0).  Mas a maneira mais f√°cil √© obter a chave no mesmo local, no portal do Azure, acessando o Hub IoT -&gt; Dispositivos IoT. </p><br><p><img src="https://habrastorage.org/webt/gu/fn/jz/gufnjz89qukktzouxgsoauw01ww.png"></p><br><p>  O SAS pode ser gerado no dispositivo ou pode ser gerado usando qualquer um de seus servi√ßos online.  Se voc√™ usar o SDK, ele poder√° gerar SAS automaticamente para voc√™ (basta especificar a chave dupla do dispositivo no c√≥digo). </p><br><p><img src="https://habrastorage.org/webt/ob/gs/v1/obgsv1ag1bhj7rrcjejvonpvs3u.png"></p><br><p>  A maneira pela qual um token SAS √© gerado por um servi√ßo da web por um tempo limitado √© um pouco mais segura.  Embora haja uma certa nuance.  Se voc√™ enviar apenas o nome do dispositivo para o servi√ßo, algu√©m poder√° pesquisar os nomes para obter o token de outro dispositivo.  Portanto, para tornar o processo um pouco mais seguro, proponho esta solu√ß√£o: vamos salvar o hash do Azure da chave dupla do dispositivo no dispositivo.  E no c√≥digo de servi√ßo, antes de gerar o SAS, verificaremos se o hash corresponde ao hash da chave do dispositivo.  Assim, ser√° poss√≠vel obter o SAS apenas sabendo o nome do dispositivo e o hash de sua chave. </p><br><p>  A primeira maneira pela qual o SAS √© gerado no dispositivo √© mais simples e conveniente, mas um pouco menos seguro.  Uma vez que, ap√≥s obter acesso ao dispositivo, um invasor poder√° obter uma chave e gerar dispositivos SAS por conta pr√≥pria.  No segundo caso, tendo obtido acesso ao dispositivo, o cracker poder√° receber apenas tokens SAS, cuja vida √∫til √© limitada. </p><br><p>  Acontece que ambos os m√©todos n√£o s√£o, em geral, ideais se o hacker tiver acesso ao dispositivo.  Mesmo protegendo uma conex√£o usando uma VPN n√£o ajudar√° aqui.  Nesse caso, o canal de transmiss√£o estar√° protegido, mas aqueles que tiverem o dispositivo em suas m√£os poder√£o acessar o canal.  Infelizmente, em dispositivos NodeMCU, Arduino etc.  n√£o h√° como armazenar chaves / senhas em nenhum armazenamento seguro.  Talvez o mercado de dispositivos IoT de baixo custo exija novas funcionalidades de hardware. </p><br><h2>  Criando uma fun√ß√£o do Azure para gera√ß√£o SAS </h2><br><p>  Como um servi√ßo online, √© mais f√°cil usar os recursos do Azure.  Esses s√£o trechos exclusivos que podem ser gravados imediatamente no portal do Azure no navegador.  Brincando como uma piada, mas dessa maneira voc√™ pode programar at√© em um smartphone.  Obviamente, ningu√©m pro√≠be a cria√ß√£o e a depura√ß√£o do Visual Studio e s√≥ o publica no Azure em formato compilado. </p><br><p>  A tarefa da fun√ß√£o √© executar uma opera√ß√£o geralmente n√£o muito complicada.  De acordo com a ideia do microsservi√ßo, cada fun√ß√£o pode fazer uma coisa, mas √© muito boa (princ√≠pio de responsabilidade √∫nica). </p><br><p>  Voc√™ pode criar um Aplicativo de Fun√ß√£o do Azure no portal preenchendo um pequeno formul√°rio </p><br><p><img src="https://habrastorage.org/webt/hd/ec/cu/hdeccuzb_kfv3cz7ggi1x5cnwe4.png"></p><br><p>  O plano de consumo permite pagar apenas pelas chamadas de fun√ß√£o que foram confirmadas.  Esta √© a op√ß√£o mais barata.  Atualmente, um milh√£o de chamadas de recursos s√£o gratuitas. </p><br><p>  Observe que, juntamente com a cria√ß√£o da fun√ß√£o, um armazenamento de dados auxiliar (armazenamento) tamb√©m √© criado. </p><br><p>  Depois de criar o aplicativo de fun√ß√µes, voc√™ pode criar a pr√≥pria fun√ß√£o.  Nesse caso, precisamos de uma fun√ß√£o como Webhook + API.  A fun√ß√£o pode estar aberta a todos (acesso an√¥nimo) e pode estar dispon√≠vel apenas para os propriet√°rios de um c√≥digo especial.  O c√≥digo pode ser obtido na janela com a fun√ß√£o clicando no link &lt;/&gt; Obter URL da fun√ß√£o: </p><br><p><img src="https://habrastorage.org/webt/fl/mi/4w/flmi4wk8td66jpkudkozeqaec_o.png"></p><br><p>  As fun√ß√µes podem ser escritas em v√°rios idiomas.  Eu prefiro c #. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Common.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Globalization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static async Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req, TraceWriter <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) { string deviceid = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "deviceid", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; string hash = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "hash", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(deviceid)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "device id missing"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(hash)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "hash missing"); var resourceUri ="ArduinoDemoHub.azure-devices.net/devices/"+deviceid; // taken <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> IoT Hub <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> devices rights (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Device Explorer) var connectionString = "HostName=ArduinoDemoHub.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=cuYBKc42lfJr4oSRGQGQ8IiKWxGQkLre7rprZDZ/ths="; var registryManager = RegistryManager.CreateFromConnectionString(connectionString); var device = await registryManager.GetDeviceAsync(deviceid); var key = device.Authentication.SymmetricKey.PrimaryKey; HMACSHA256 hmac = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HMACSHA256(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes("somerandomkeyKJBWyfy4gski")); var hashedkey = Convert.ToBase64String(hmac.ComputeHash(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes(key))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hashedkey!=hash) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "wrong hash"); SharedAccessSignatureBuilder sasBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SharedAccessSignatureBuilder() { Key = key, Target = resourceUri, TimeToLive = TimeSpan.FromDays(Convert.ToDouble(<span class="hljs-number"><span class="hljs-number">7</span></span>)) }; var SAS = sasBuilder.ToSignature(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.OK, SAS); }</code> </pre> <br><p>  Criamos o arquivo project.json e adicionamos o seguinte conte√∫do: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"frameworks"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"net46"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Microsoft.Azure.Devices"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.4.1"</span></span> } } } }</code> </pre> <br><p>  O c√≥digo usa a cadeia de conex√£o ao hub IoT.  Pode ser confundida com a cadeia de conex√£o ao dispositivo.  Para que voc√™ n√£o fique confuso, deixe-me lembr√°-lo de onde voc√™ pode obt√™-lo: </p><br><p><img src="https://habrastorage.org/webt/7v/i9/jd/7vi9jdnq12-lsf2gwv82pbbhge0.png"></p><br><p>  √â necess√°rio pegar a cadeia de conex√£o de alguma pol√≠tica com os direitos de conex√£o do dispositivo. <br>  √â melhor n√£o especificar a pr√≥pria cadeia de conex√£o no c√≥digo, como eu fiz.  Eu fiz isso apenas por uma quest√£o de exemplo.  √â melhor acessar a fun√ß√£o Configura√ß√µes do aplicativo. </p><br><p><img src="https://habrastorage.org/webt/u2/e_/uc/u2e_uchy0i1np_d6ikqjpbtpflw.png"></p><br><p>  E especifique a cadeia de conex√£o l√°.  Depois disso, voc√™ pode "obt√™-lo" da loja segura usando </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ConfigurationManager</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionStrings</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">["___"]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionString</span></span></code> </pre> <br><p>  No dispositivo, precisamos salvar a chave de hash.  Mas primeiro voc√™ precisa codificar os caracteres.  HttpUtility.UrlEncode do espa√ßo System.Web nos ajudar√° com isso. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hashedkey</span></span> = HttpUtility.UrlEncode(hashedkey);</code> </pre> <br><p>  Enviaremos a solicita√ß√£o usando Get, mas nem todos os caracteres podem ser passados ‚Äã‚Äãcomo um valor de par√¢metro. </p><br><h2>  Escrevendo c√≥digo para enviar dados para a nuvem </h2><br><p>  Eu escrevi um pequeno c√≥digo em Lua enviando dados para a nuvem.  O resultado foi uma esp√©cie de PoC.  Voc√™ pode us√°-lo e modific√°-lo de acordo com suas necessidades. <br>  Crie 2 arquivos init.lua e SendDataToCloud.lua <br>  O conte√∫do do primeiro: </p><br><pre> <code class="hljs php">--    <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'init.lua ver 1.2'</span></span>) wifi.setmode(wifi.STATION) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'set mode=STATION (mode='</span></span>..wifi.getmode()..<span class="hljs-string"><span class="hljs-string">')'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'MAC: '</span></span>..wifi.sta.getmac()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'chip: '</span></span>..node.chipid()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'heap: '</span></span>..node.heap()) --  Wifi station_cfg={} station_cfg.ssid=<span class="hljs-string"><span class="hljs-string">"_SSID"</span></span> station_cfg.pwd=<span class="hljs-string"><span class="hljs-string">"___"</span></span> station_cfg.save=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> wifi.sta.config(station_cfg) wifi_status_codes = { [<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"Idle"</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connecting"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Wrong Password"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"No AP Found"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connection Failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-string"><span class="hljs-string">"Got IP"</span></span> } sntp_connect_status_codes = { [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"DNS lookup failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Memory allocation failure"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"UDP send failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Timeout, no NTP response received"</span></span> } --    Wi-fi (   ) tmr.alarm(<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sta</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">==</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nil</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Waiting for IP address! (Status: "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi_status_codes[wifi.sta.status</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">]..</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">")"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"New IP address is "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi.sta.getip</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> --    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NTP</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sntp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'pool.ntp.org'</span></span></span></span><span class="hljs-function"><span class="hljs-params">}, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(sec, usec, server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Synced: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..usec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tls.cert.verify</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(false)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --    dofile</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">'SendDataToCloud.lua'</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(error_code)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Sync Failed: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sntp_connect_status_codes[error_code])</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --      )</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> )</span></span></code> </pre> <br><p>  Este arquivo se conecta √† rede e executa o c√≥digo do arquivo SendDataToCloud.lua se a conex√£o for bem-sucedida. </p><br><p>  Voc√™ deve especificar os dados do seu ponto de acesso Wi-Fi como os valores para station_cfg.ssid e station_cfg.pwd. </p><br><p>  No arquivo a seguir, voc√™ precisa alterar o nome do dispositivo e a IoT do hub (vari√°veis ‚Äã‚ÄãDEVICE e IOTHUB).  A vari√°vel funcurl cont√©m o endere√ßo da fun√ß√£o geradora de SAS e o hash da chave do dispositivo (que anteriormente codificamos usando HttpUtility.UrlEncode) como o valor do par√¢metro hash </p><br><pre> <code class="hljs powershell">--  DEVICE = <span class="hljs-string"><span class="hljs-string">"LuaDevice"</span></span> IOTHUB = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net"</span></span> PORT = <span class="hljs-number"><span class="hljs-number">8883</span></span> USER = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/api-version=2016-11-14"</span></span> telemetry_topic=<span class="hljs-string"><span class="hljs-string">"devices/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/messages/events/"</span></span> connected = false local headers = <span class="hljs-string"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'Accept: */*\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0'</span></span> funcurl = <span class="hljs-string"><span class="hljs-string">"https://arduinofunction.azurewebsites.net/api/GenerateSASFunction?code=Jn7j54PbR31BSRa0UZrDwp4ZEltjmWHmblG9zLo0Ne0tyGM7w/wQ7w=="</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;hash=oJzykimyQsTPtzgJxYq90Xfqmw1rZTPTCH%2bJ5sSurKI%3d"</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;deviceid="</span></span>..DEVICE tmr.alarm(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, function() http.get(funcurl, headers, function(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, header) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then print(<span class="hljs-string"><span class="hljs-string">"HTTP request failed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sas = true print(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> string.match(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-string"><span class="hljs-string">"Shared"</span></span>) then tmr.stop(<span class="hljs-number"><span class="hljs-number">1</span></span>) SAS = string.sub(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,string.len(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)<span class="hljs-literal"><span class="hljs-literal">-1</span></span>) print(SAS) connect(SAS) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DEVICE, 240, USER, SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IoTHub</span></span></span><span class="hljs-function">    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connecting to MQTT broker. Please wait...")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2,1000, 1, function()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IOTHUB, PORT, 1, -- Callback     function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connected to MQTT: "..IOTHUB..":"..PORT.." as "..DEVICE)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">, -- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Callback</span></span></span><span class="hljs-function">    </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client, reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Error Connecting: "..reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> ) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomseed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(3, 1000, tmr.ALARM_AUTO, publish_data)</span></span></span><span class="hljs-function"> --   ,     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("offline", function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("MQTT Disconnected.")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">false</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> --      </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> == </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">somedata</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">random</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1,100)</span></span></span><span class="hljs-function"> --     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payload</span></span></span><span class="hljs-function"> = "</span></span>{ \<span class="hljs-string"><span class="hljs-string">"deviceId\"</span></span> : \<span class="hljs-string"><span class="hljs-string">""</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"\"</span></span>,<span class="hljs-string"><span class="hljs-string">".. "</span></span>\<span class="hljs-string"><span class="hljs-string">"iotdata\"</span></span> :<span class="hljs-string"><span class="hljs-string">"..somedata.."</span></span>}<span class="hljs-string"><span class="hljs-string">" --   client:publish(telemetry_topic, payload, 1, 0, function(client) print("</span></span><span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> published successfully.<span class="hljs-string"><span class="hljs-string">") end) end end</span></span></code> </pre> <br><p>  Os dados s√£o enviados sem o SDK do Azure; portanto, voc√™ pode usar esse c√≥digo n√£o apenas para enviar dados ao Azure.  Existem muitas alternativas: AWS, Google Cloud IoT, IBM Watson IoT Platform. </p><br><p>  O exemplo usa o protocolo MQTT (Message Queuing Telemetry Transport).  Este √© um protocolo aberto projetado especificamente para dispositivos IoT.  Os dados s√£o enviados no formato JSON.  Onde em projetos reais os dados s√£o obtidos dos sensores, um n√∫mero aleat√≥rio √© gerado no exemplo. </p><br><p>  Durante o processo de handshake entre o dispositivo e o hub IoT, o servidor pode enviar seu certificado ou solicitar um certificado de dispositivo.  Se voc√™ se lembra, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√∫ltima vez que</a> trabalhamos com o dispositivo Arduino, exibimos um certificado.  Agora, um coletor de c√≥digo √© suficiente: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tls</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cert</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.verify</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">false</span></span>)</code> </pre> <br><p>  Estamos limitados ao certificado que o servidor nos enviar√°. </p><br><h2>  INFO </h2><br><p>  Voc√™ pode estar interessado no conte√∫do dos certificados para seu hub usando o seguinte comando OpenSSL. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s_client</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-showcerts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-connect</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ArduinoDemoHub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.azure-devices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.net</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8883</span></span></code> </pre> <br><p>  Para preparar o material, foram utilizados os laborat√≥rios, dispon√≠veis no link: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Enviando mensagens de dispositivo para a nuvem (D2C)</a> <br>  O c√≥digo n√£o est√° atualizado e eu tive que atualiz√°-lo um pouco, mas, em geral, o link pode ser √∫til. </p><br><h2>  Trabalhando com NodeMCU a partir do Arduino IDE </h2><br><p>  N√£o consigo ignorar o t√≥pico do uso do SDK.  Sua solu√ß√£o √© boa, mas o SDK √© o mesmo c√≥digo que j√° est√° depurado, simplificado e pronto para uso.  Algumas palavras sobre como configurar e usar o Arduino IDE para trabalhar com o NodeMCU. </p><br><p>  Depois de instalar o Arduino IDE, voc√™ precisa ir para o menu Arquivo - Prefer√™ncias </p><br><p><img src="https://habrastorage.org/webt/ea/u_/fq/eau_fqwxsvtujmn50otjftkgwvi.png"></p><br><p>  E adicione um link ao gerente do conselho adicional - digite no campo URLs adicionais do gerente do conselho o endere√ßo: <a href="">http://arduino.esp8266.com/versions/2.4.0/package_esp8266com_index.json</a> </p><br><p>  Em seguida, v√° para o menu Ferramentas - Placa xxx - Boardx Manager e instale o ESP8266 <br>  Instale as bibliotecas AzureIoTHub, AzureIoTUtility, AzureIoTProtocol_MQTT.  Depois de instalar a √∫ltima biblioteca nos exemplos (menu Arquivo - Exemplos - AzureIoTProtocol_MQTT), voc√™ pode encontrar um exemplo simplesample_mqtt para o ESP8266. </p><br><p>  O exemplo est√° pronto para ir.  Basta preencher os valores das vari√°veis ‚Äã‚Äãno arquivo iot_configs.h <br>  Menciono um pequeno sinal de menos.  Compilar o projeto e fazer o download no quadro, comparado com Lua, leva muito tempo. </p><br><h2>  Salvando dados na nuvem do Azure </h2><br><p>  Com o envio de dados, tudo fica claro, mas como √© barato salvar dados na nuvem. <br>  A maneira mais barata de enviar dados do hub IoT para o banco de dados √© o Azure Functions.  E o armazenamento de dados mais barato √© o Armazenamento de Tabela do Azure. </p><br><p>  Curiosamente, quando voc√™ cria um aplicativo de fun√ß√µes, o armazenamento tamb√©m √© criado automaticamente, o que a pr√≥pria fun√ß√£o precisa para funcionar.  Se voc√™ criar um reposit√≥rio separado, √© recomend√°vel fazer as configura√ß√µes b√°sicas mais ou menos assim: </p><br><p><img src="https://habrastorage.org/webt/zg/va/sz/zgvaszlilbyzjh6srxdmrq3cjyi.png"></p><br><p>  Atualmente, a replica√ß√£o de LSR √© a op√ß√£o mais barata.  Ele √© selecionado ao criar automaticamente um reposit√≥rio vinculado a uma fun√ß√£o. <br>  O que precisamos agora √© receber dados do hub IoT e grav√°-los no armazenamento.  Nesse caso, ao criar uma fun√ß√£o, a janela In√≠cio R√°pido n√£o poder√° oferecer a op√ß√£o desejada. </p><br><p><img src="https://habrastorage.org/webt/x5/vw/6i/x5vw6ia4ubsfidgvpqmlrretqru.png"></p><br><p>  Portanto, clique no link da fun√ß√£o Personalizada, localizada na parte inferior e selecione a op√ß√£o Hub IoT (Hub de Eventos). <br>  Esta janela ser√° aberta para n√≥s: </p><br><p><img src="https://habrastorage.org/webt/gu/t6/ry/gut6ryx8peg_aq2mqfv0dr62agk.jpeg"></p><br><p>  No qual podemos preencher o campo de conex√£o do Hub de Eventos com uma op√ß√£o simples (clicando em novo).  Mas, para indicar o nome do Hub de Eventos, voc√™ precisa acessar o Hub IoT.  No hub, voc√™ precisa acessar Endpoints (endpoints) e obter o nome compat√≠vel com o Event Hub a partir da√≠ </p><br><p><img src="https://habrastorage.org/webt/dl/tk/lb/dltklbv7hubhxdhe07nioe7ckgu.png"></p><br><p>  Vamos para o c√≥digo da fun√ß√£o.  O fragmento a seguir recebe dados do hub IoT e os armazena no armazenamento de tabelas: </p><br><pre> <code class="hljs lua">#r <span class="hljs-string"><span class="hljs-string">"Microsoft.WindowsAzure.Storage"</span></span> #r <span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span> using Microsoft.Azure; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudConfigurationManager using Microsoft.WindowsAzure.Storage; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudStorageAccount using Microsoft.WindowsAzure.Storage.Table; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Table storage types using Newtonsoft.Json; public static void Run(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> myIoTHubMessage, TraceWriter <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) { var e = JsonConvert.DeserializeObject&lt;EventDataEntity&gt;(myIoTHubMessage); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.Info($<span class="hljs-string"><span class="hljs-string">"C# IoT Hub trigger function processed a message: {myIoTHubMessage}"</span></span>); CloudStorageAccount storageAccount = CloudStorageAccount.Parse (<span class="hljs-string"><span class="hljs-string">"DefaultEndpointsProtocol=https;AccountName=iotdatademostorage;AccountKey=JgStNcJvlQYeNsVCmpkHQUkWlZiQ7tJwAm6OCL34+lGx3XrR+0CPiY9RoxIDA6VSvMKlOEUrVWL+KWP0qLMLrw==;EndpointSuffix=core.windows.net"</span></span>); CloudTableClient tableClient = storageAccount.CreateCloudTableClient(); CloudTable <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = tableClient.GetTableReference(<span class="hljs-string"><span class="hljs-string">"iottable"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.CreateIfNotExists(); EventDataEntity edata = new EventDataEntity(<span class="hljs-string"><span class="hljs-string">"IOTpartition"</span></span>, Guid.NewGuid().ToString()); edata.DeviceId = e.DeviceId; edata.IotData = e.IotData; TableOperation insertOperation = TableOperation.Insert(edata); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.Execute(insertOperation); } public class EventDataEntity : TableEntity { public EventDataEntity(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pkey, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> rkey) { this.PartitionKey = pkey; this.RowKey = rkey; } public EventDataEntity() { } public <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> DeviceId { get; set; } public int IotData { get; set; } }</code> </pre> <br><p>  Se voc√™ usar esse c√≥digo em um projeto real, n√£o esque√ßa de colocar a string de conex√£o em um local mais seguro - nas configura√ß√µes do aplicativo (exatamente o mesmo que a string de conex√£o da primeira fun√ß√£o). </p><br><p>  A pr√≥pria cadeia de conex√£o pode ser obtida no item de configura√ß√µes chamado Teclas de acesso: </p><br><p><img src="https://habrastorage.org/webt/ot/z9/pb/otz9pbjqyflhjivwztvvsmkjms4.png"></p><br><p>  Exibir o conte√∫do da tabela com o utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Azure Storage Explorer</a> gratuito </p><br><p>  Como o custo do Armazenamento de Tabelas do Azure √© bastante baixo e o hub de Fun√ß√µes e IoT do Azure oferece determinados recursos mensalmente gratuitamente, o custo de toda a solu√ß√£o por m√™s pode ser inferior a US $ 1.  Obviamente, isso depende da quantidade de dados.  Conte por si mesmo.  Hoje, 1 GB de dados custa 7 centavos de d√≥lar por m√™s e, para cada milh√£o de transa√ß√µes, voc√™ cobra apenas 4 centavos de d√≥lar. </p><br><h2>  INFO </h2><br><p>  Ao usar servi√ßos em nuvem de qualquer provedor, sempre aconselho que voc√™ vincule um cart√£o de cr√©dito √† quantia m√≠nima de dinheiro em sua conta.  √â por acaso que, ao escolher algum tipo de configura√ß√£o incorreta, voc√™ paga muito mais do que espera. </p><br><p>  Lembramos que esta √© a vers√£o completa de um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo da revista Hacker</a> .  Seu autor √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Alexey Sommer</a> . </p><br><h2>  Materiais √∫teis </h2><br><h4>  Guia de arquitetura de aplicativos em nuvem </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/zk/ns/pq/zknspqark8ose3vto4iom_kbdaq.jpeg"></a>  Adote uma abordagem estruturada para desenvolver aplicativos em nuvem.  Este e-book de 300 p√°ginas sobre arquitetura de computa√ß√£o em nuvem discute as diretrizes de arquitetura, desenvolvimento e implementa√ß√£o que se aplicam independentemente da plataforma de nuvem que voc√™ escolher.  Este guia inclui etapas para: </p><br><ul><li>  Escolhendo o estilo certo de arquitetura de aplicativo em nuvem para seu aplicativo ou solu√ß√£o; </li><li>  sele√ß√£o de tecnologias apropriadas de computa√ß√£o e armazenamento de dados; </li><li>  implementar 10 princ√≠pios de desenvolvimento para criar um aplicativo escal√°vel, resiliente e gerenci√°vel; </li><li>  seguindo os cinco princ√≠pios da cria√ß√£o de software de qualidade que garanta o sucesso do seu aplicativo na nuvem; </li><li>  Usando padr√µes de design projetados para o problema que voc√™ est√° tentando resolver. </li></ul><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b>Baixar</b></a> </p><br><h4>  Guia do desenvolvedor do Azure </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img width="200" align="right" src="https://habrastorage.org/webt/ik/2g/ot/ik2gotwyadnbqcjeusitbjdk550.png"></a> </p><br><p>  Nesta atualiza√ß√£o do Guia do Desenvolvedor do Azure, voc√™ ver√° como o conjunto completo de servi√ßos da plataforma de software do Azure atende √†s suas necessidades.  Aqui voc√™ encontrar√° informa√ß√µes sobre abordagens arquiteturais e as situa√ß√µes mais comuns que surgem ao criar aplicativos em nuvem. </p><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b>Baixar</b></a> </p><br><h4>  No√ß√µes b√°sicas do Microsoft Azure </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/w1/pe/sj/w1pesji9lrslkdggsjzwdkya2la.png"></a>  Este livro fornece informa√ß√µes importantes sobre os principais servi√ßos do Azure para desenvolvedores e profissionais de TI que s√£o novos na computa√ß√£o em nuvem.  Demonstra√ß√µes passo a passo est√£o inclu√≠das para ajudar o leitor a entender como come√ßar com cada um dos principais servi√ßos.  Cada cap√≠tulo √© independente, n√£o √© necess√°rio realizar demonstra√ß√µes pr√°ticas de cap√≠tulos anteriores para entender qualquer cap√≠tulo em particular. </p><br><p>  Os seguintes t√≥picos s√£o abordados neste livro: </p><br><ul><li>  Introdu√ß√£o ao Azure; </li><li>  Servi√ßo de Aplicativo do Azure e Aplicativos Web; </li><li>  M√°quinas virtuais; </li><li>  Servi√ßo de armazenamento; </li><li>  Bases de dados </li><li>  Servi√ßos adicionais do Azure. </li></ul><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><b>Baixar</b></a> </p><br><h2>  Links √∫teis </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o em russo para Hub IoT</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Exemplos de IoT do Azure para Csharp (.NET)</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt421847/">https://habr.com/ru/post/pt421847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt421835/index.html">Comiss√£o Interinstitucional desenvolve nova tecnologia para bloquear o Telegram</a></li>
<li><a href="../pt421837/index.html">Criando 1k introdu√ß√£o Caos para ZX-Spectrum</a></li>
<li><a href="../pt421839/index.html">Programa√ß√£o Java funcional com Vavr</a></li>
<li><a href="../pt421841/index.html">Robotaxi Waymo ainda n√£o est√° pronto para o acesso √†s vias p√∫blicas</a></li>
<li><a href="../pt421845/index.html">O que os analistas de dados realmente fazem? Resultados de 35 entrevistas</a></li>
<li><a href="../pt421849/index.html">Eventos para RH em TI em setembro de 2018: My Circle Digest</a></li>
<li><a href="../pt421851/index.html">Problemas de coruja e globo: conectando dois assemblies com namespaces e nomes de classe id√™nticos</a></li>
<li><a href="../pt421855/index.html">Projetores dom√©sticos: os melhores ‚Äúde acordo com a vers√£o‚Äù, foco ultra curto, campe√µes em brilho e velocidade</a></li>
<li><a href="../pt421857/index.html">ToFoIn v 1. Reserva de gateways e altern√¢ncia entre canais externos no FreeBSD</a></li>
<li><a href="../pt421859/index.html">Notas do provedor de IoT. Dispositivos e supera√ß√µes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>