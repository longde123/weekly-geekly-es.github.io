<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤰 🏹 🛢️ Pencarian Teks Lengkap: Fitur khusus Elasticsearch untuk tugas-tugas kompleks 👂🏼 🧚🏿 👜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hai semuanya, nama saya Andrey, dan saya seorang pengembang. Dahulu kala - sepertinya, Jumat lalu - tim kami memiliki proyek di mana mereka membutuhka...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pencarian Teks Lengkap: Fitur khusus Elasticsearch untuk tugas-tugas kompleks</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413075/"><img src="https://habrastorage.org/webt/yb/hh/1r/ybhh1rxmqt9yswla3tfbiexyluo.png" alt="gambar"><br><br>  Hai semuanya, nama saya Andrey, dan saya seorang pengembang.  Dahulu kala - sepertinya, Jumat lalu - tim kami memiliki proyek di mana mereka membutuhkan pencarian bahan-bahan yang membentuk produk.  Katakanlah komposisi sosis.  Pada awal proyek, tidak banyak yang diperlukan dari pencarian: untuk menunjukkan semua resep di mana bahan yang diinginkan terkandung dalam jumlah tertentu;  ulangi untuk bahan-bahan N. <br><a name="habracut"></a><br>  Namun, di masa depan, jumlah produk dan bahan-bahan direncanakan akan meningkat secara signifikan, dan pencarian tidak hanya harus mengatasi peningkatan volume data, tetapi juga memberikan opsi tambahan - misalnya, kompilasi otomatis deskripsi produk berdasarkan bahan yang berlaku. <br><br>  <b>Persyaratan</b> <br><br><ul><li>  Buat pencarian di Elacsticsearch menggunakan database setidaknya 50.000 dokumen. </li><li>  Memberikan respons kecepatan tinggi untuk permintaan - kurang dari 300 ms. </li><li>  Untuk memastikan bahwa permintaannya kecil, dan layanan itu tersedia bahkan dalam kondisi Internet seluler terburuk. </li><li>  Buat logika pencarian seintuitif mungkin dari perspektif UX.  Itu pada dasarnya bahwa antarmuka akan mencerminkan logika pencarian - dan sebaliknya. </li><li>  Minimalkan jumlah interlayers antara elemen sistem untuk kinerja yang lebih tinggi dan ketergantungan yang lebih sedikit. </li><li>  Untuk memberikan peluang kapan saja untuk melengkapi algoritme dengan kondisi baru (misalnya, pembuatan deskripsi produk secara otomatis). </li><li>  Buat dukungan lebih lanjut untuk bagian pencarian proyek sesederhana dan senyaman mungkin. </li></ul><br>  Kami memutuskan untuk tidak terburu-buru dan mulai dari yang sederhana. <br><br>  Pertama-tama, kami menyimpan semua bahan komposisi produk dalam database, setelah menerima 10.000 entri pertama.  Sayangnya, bahkan pada ukuran ini, pencarian basis data terlalu banyak waktu, bahkan dengan mempertimbangkan penggunaan gabungan dan indeks.  Dan dalam waktu dekat jumlah catatan seharusnya melebihi 50.000. Selain itu, pelanggan bersikeras menggunakan Elasticsearch (selanjutnya - ES), karena ia menemukan alat ini dan, tampaknya, memiliki perasaan hangat untuknya.  Kami tidak pernah bekerja dengan ES sebelumnya, tetapi kami tahu tentang kelebihannya dan setuju dengan pilihan ini, karena, misalnya, direncanakan bahwa kami akan sering memiliki entri baru (menurut berbagai perkiraan dari 50 hingga 500 per hari), yang akan diperlukan segera masalah kepada pengguna. <br><br>  Kami memutuskan untuk meninggalkan interlayers di tingkat driver dan cukup menggunakan permintaan REST, karena sinkronisasi dengan database dilakukan hanya pada saat membuat dokumen dan tidak lagi diperlukan.  Ini adalah keuntungan lain - hingga mengirim permintaan pencarian langsung ke ES dari browser. <br><br>  Kami mengumpulkan prototipe pertama di mana kami mentransfer struktur dari database (PostgreSQL) ke dokumen ES: <br><br><pre><code class="php hljs">{<span class="hljs-string"><span class="hljs-string">"mappings"</span></span> : { <span class="hljs-string"><span class="hljs-string">"recipe"</span></span> : { <span class="hljs-string"><span class="hljs-string">"_source"</span></span> : { <span class="hljs-string"><span class="hljs-string">"enabled"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }, <span class="hljs-string"><span class="hljs-string">"properties"</span></span> : { <span class="hljs-string"><span class="hljs-string">"recipe_id"</span></span> : {<span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"integer"</span></span>}, <span class="hljs-string"><span class="hljs-string">"recipe_name"</span></span> : {<span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"text"</span></span>}, <span class="hljs-string"><span class="hljs-string">"ingredients"</span></span> : { <span class="hljs-string"><span class="hljs-string">"type"</span></span> : <span class="hljs-string"><span class="hljs-string">"nested"</span></span>, <span class="hljs-string"><span class="hljs-string">"properties"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ingredient_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredient_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"integer"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span>, <span class="hljs-string"><span class="hljs-string">"percent"</span></span>: <span class="hljs-string"><span class="hljs-string">"float"</span></span> } } } } }}</code> </pre> <br>  Berdasarkan pemetaan ini, kami mendapatkan kira-kira dokumen berikut (kami tidak dapat menunjukkan pekerja dari proyek karena NDA): <br><br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"recipe_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"recipe_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"AAA &amp; BBB"</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredients"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"ingredient_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredient_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"AAA"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Manufacturer 3"</span></span>, <span class="hljs-string"><span class="hljs-string">"percent"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"ingredient_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredient_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"BBB"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Manufacturer 4"</span></span>, <span class="hljs-string"><span class="hljs-string">"percent"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> } ] }</code> </pre> <br>  Semua ini dilakukan dengan menggunakan paket PHP Elasticsearch.  Ekstensi untuk Laravel (Elastiquent, Laravel Scout, dll.) Memutuskan untuk tidak menggunakannya karena satu alasan - pelanggan membutuhkan kinerja tinggi, hingga poin yang disebutkan di atas bahwa "300 ms untuk permintaan banyak."  Dan semua paket untuk Laravel bertindak sebagai overhead tambahan dan melambat.  Itu bisa dilakukan langsung pada Guzzle, tetapi kami memutuskan untuk tidak melakukan ekstrem. <br><br>  Pertama, pencarian resep yang paling sederhana dilakukan langsung pada array.  Ya, semua ini dibawa ke file konfigurasi, tetapi semua permintaan ternyata terlalu besar.  Pencarian dilakukan pada dokumen terlampir (bahan yang sama), pada ekspresi Boolean menggunakan "harus" dan "harus", ada juga arahan untuk bagian wajib pada dokumen yang terlampir - sebagai akibatnya, permintaan mengambil dari seratus baris, dan volumenya dari tiga kilobyte. <br><br>  Jangan lupa tentang persyaratan kecepatan dan ukuran respons - saat itu jawaban dalam API diformat sedemikian rupa untuk meningkatkan jumlah informasi yang bermanfaat: kunci pada setiap objek json dikurangi menjadi satu huruf.  Oleh karena itu, pertanyaan dalam ES beberapa kilobyte menjadi kemewahan yang tidak dapat diterima. <br><br>  Dan pada saat itu, kami menyadari bahwa membangun permintaan raksasa dalam bentuk array asosiatif dalam PHP adalah semacam kecanduan yang sengit.  Selain itu, pengendali menjadi benar-benar tidak dapat dibaca, lihat sendiri: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchSimilar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> $conditions[] = [ <span class="hljs-string"><span class="hljs-string">"nested"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"path"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"ingredients"</span></span>, <span class="hljs-string"><span class="hljs-string">"score_mode"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"max"</span></span>, <span class="hljs-string"><span class="hljs-string">"query"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"bool"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"must"</span></span> =&gt; [ [<span class="hljs-string"><span class="hljs-string">"term"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"ingredients.ingredient_id"</span></span> =&gt; $ingredient_id]], [<span class="hljs-string"><span class="hljs-string">"range"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"ingredients.percent"</span></span>=&gt;[ <span class="hljs-string"><span class="hljs-string">"lte"</span></span>=&gt;$percent + <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"gte"</span></span>=&gt;$percent - <span class="hljs-number"><span class="hljs-number">5</span></span> ]]] ] ] ] ] ]; $parameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][<span class="hljs-string"><span class="hljs-string">'query'</span></span>][<span class="hljs-string"><span class="hljs-string">'bool'</span></span>][<span class="hljs-string"><span class="hljs-string">'should'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'bool'</span></span>][<span class="hljs-string"><span class="hljs-string">'should'</span></span>] = $conditions; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> $equal_conditions[] = [ <span class="hljs-string"><span class="hljs-string">"nested"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"path"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"flavors"</span></span>, <span class="hljs-string"><span class="hljs-string">"query"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"bool"</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">"must"</span></span> =&gt; [ [<span class="hljs-string"><span class="hljs-string">"term"</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">"ingredients.percent"</span></span> =&gt; $percent]] ] ] ] ] ]; $parameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][<span class="hljs-string"><span class="hljs-string">'query'</span></span>][<span class="hljs-string"><span class="hljs-string">'bool'</span></span>][<span class="hljs-string"><span class="hljs-string">'should'</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'bool'</span></span>][<span class="hljs-string"><span class="hljs-string">'must'</span></span>] = $equal_conditions; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;client-&gt;search($parameters); }</code> </pre> <br>  Penyimpangan liris: ketika sampai pada bidang bersarang dalam dokumen, ternyata kami tidak dapat memenuhi kueri formulir: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-string"><span class="hljs-string">"nested"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-string"><span class="hljs-string">"should"</span></span>: [ ... ] } } } }</code> </pre> <br>  untuk satu alasan sederhana - Anda tidak dapat melakukan multi-pencarian di dalam filter bersarang.  Karena itu, saya harus melakukan ini: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-string"><span class="hljs-string">"should"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"nested"</span></span>: { <span class="hljs-string"><span class="hljs-string">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"flavors"</span></span>, <span class="hljs-string"><span class="hljs-string">"score_mode"</span></span>: <span class="hljs-string"><span class="hljs-string">"max"</span></span>, <span class="hljs-string"><span class="hljs-string">"query"</span></span>: { <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { ... } } }} ] } }</code> </pre> <br>  yaitu  pertama, array kondisi harus dideklarasikan, dan di dalam setiap kondisi pencarian dipanggil oleh bidang bersarang.  Dari sudut pandang Elasticsearch, ini lebih benar dan logis.  Akibatnya, kami sendiri melihat bahwa ini logis ketika kami menambahkan istilah pencarian tambahan. <br><br>  Dan di sini kami menemukan templat <s>google yang</s> dibangun dalam ES.  Pilihannya jatuh pada Kumis - mesin template tanpa logika yang cukup nyaman.  Dimungkinkan untuk memasukkan seluruh badan permintaan dan semua data yang dikirim ke dalamnya praktis tanpa perubahan, sebagai akibatnya permintaan terakhir berbentuk: <br><br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"template"</span></span>: <span class="hljs-string"><span class="hljs-string">"template1"</span></span>, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: params{} }</code> </pre> <br>  Tubuh templat ternyata agak sederhana dan mudah dibaca - hanya JSON dan arahan dari Moustache itu sendiri.  Template disimpan di Elasticsearch itu sendiri dan disebut dengan nama. <br><br><pre> <code class="hljs smalltalk">/* search_similar.mustache */ { <span class="hljs-comment"><span class="hljs-comment">"query"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"should"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"minimum_should_match"</span></span>: {{ minimumShouldMatch }}, <span class="hljs-comment"><span class="hljs-comment">"should"</span></span>: [ {{<span class="hljs-symbol"><span class="hljs-symbol">#ingredientsList</span></span>}} // mustache         ingredientsList {{<span class="hljs-symbol"><span class="hljs-symbol">#ingredients</span></span>}} //         ingredients {<span class="hljs-comment"><span class="hljs-comment">"nested"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"path"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"ingredients"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"score_mode"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"max"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"query"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"must"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"term"</span></span>: {<span class="hljs-comment"><span class="hljs-comment">"ingredients.flavor_id"</span></span>: {{ id }} }}, {<span class="hljs-comment"><span class="hljs-comment">"range"</span></span>: {<span class="hljs-comment"><span class="hljs-comment">"ingredients.percent"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"lte"</span></span>: {{ lte }}, <span class="hljs-comment"><span class="hljs-comment">"gte"</span></span>: {{ gte }} }}} ] } } }} {{^isLast}},{{/isLast}} //    {{/ingredients}} {{/ingredientsList}} ] }} ] } } } /*  */ { <span class="hljs-comment"><span class="hljs-comment">"template"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"search_similar"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"params"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"minimumShouldMatch"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">"ingredientsList"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"ingredients"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">"lte"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-comment"><span class="hljs-comment">"gte"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-comment"><span class="hljs-comment">"isLast"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } ] } } }</code> </pre> <br>  Sebagai hasilnya, pada output kami mendapatkan template yang kami hanya melewati array bahan yang diperlukan.  Secara logis, permintaan tidak berbeda jauh dari, dengan syarat, sebagai berikut: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ingredients <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> recipes <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> recipes.id = ingredient.recipe_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ingredients.id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ingredients.id <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ingredients.percent <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">20.0</span></span></code> </pre> <br>  tapi dia bekerja lebih cepat, dan itu adalah dasar yang sudah jadi untuk permintaan lebih lanjut. <br><br>  Di sini, selain pencarian persentase, kami membutuhkan beberapa jenis operasi: pencarian berdasarkan nama di antara bahan, kelompok dan nama resep;  cari berdasarkan bahan id dengan mempertimbangkan toleransi kontennya dalam resep;  kueri yang sama, tetapi dengan perhitungan hasil di bawah empat kondisi (kemudian dikoreksi untuk tugas lain), serta kueri terakhir. <br><br>  Permintaan membutuhkan logika berikut: untuk setiap bahan ada lima tag yang menghubungkannya dengan grup mana pun.  Menurut kebiasaan, babi dan sapi adalah daging, dan ayam dan kalkun adalah unggas.  Setiap tag terletak pada levelnya masing-masing.  Berdasarkan tag ini, kami dapat membuat deskripsi kondisional untuk resep, yang memungkinkan kami membuat pohon pencarian dan / atau deskripsi secara otomatis.  Misalnya, sosis daging dan susu dengan rempah-rempah, hati dan kedelai, ayam halal.  Satu resep dapat memiliki banyak bahan dengan tag yang sama.  Ini memungkinkan kami untuk tidak mengisi rantai tag dengan tangan kami - berdasarkan komposisi resep, kami sudah dapat dengan jelas menggambarkannya.  Struktur dokumen terlampir juga telah berubah: <br><br><pre> <code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"ingredient_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"ingredient_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"AAA"</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"manufacturer_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Manufacturer 3"</span></span>, <span class="hljs-string"><span class="hljs-string">"percent"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"level_1"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"level_2"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"level_3"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"level_4"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"level_5"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> }</code> </pre> <br>  Ada juga kebutuhan untuk menentukan pencarian dengan kondisi "kemurnian" resep.  Sebagai contoh, kami membutuhkan resep di mana tidak ada apa pun selain daging sapi, garam, dan lada.  Kemudian kami harus menyingkirkan resep yang hanya mengandung daging sapi di tingkat pertama dan hanya rempah-rempah di tingkat kedua (tag pertama untuk rempah-rempah adalah nol).  Di sini saya harus menipu: karena kumis adalah templat tanpa logika, tidak mungkin ada pembicaraan tentang perhitungan apa pun;  di sini diperlukan untuk mengimplementasikan bagian dari skrip dalam permintaan dalam bahasa skrip ES - Tanpa rasa sakit.  Sintaksinya sedekat mungkin dengan Java, jadi tidak ada kesulitan.  Akibatnya, kami memiliki JSON kumis-templat yang menghasilkan, di mana bagian dari perhitungan, yaitu penyortiran dan penyaringan, diimplementasikan pada Painless: <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">"filter": [ </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{#levelsList}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{#levels}}</span></span><span class="xml"><span class="xml"> {"script": { "script": " int total=0; for (ingredient in params._source.ingredients){ if ([0,</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{tag}}</span></span><span class="xml"><span class="xml">].contains(ingredient.level_</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{id}}</span></span><span class="xml"><span class="xml">)) total+=1; } return (total==params._source.ingredients.length); " }} </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{^isLast}}</span></span><span class="xml"><span class="xml">,</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{/isLast}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{/levels}}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{/levelsList}}</span></span><span class="xml"><span class="xml"> ]</span></span></code> </pre><br>  Selanjutnya, badan skrip diformat agar mudah dibaca, jeda baris tidak dapat digunakan dalam permintaan. <br><br>  Pada saat itu, kami menghilangkan toleransi untuk kandungan bahan dan menemukan hambatan - kami dapat mempertimbangkan sosis sapi hanya karena bahan ini ditemukan di sana.  Kemudian kami menambahkan - semua pada skrip Painless yang sama - menyaring dengan syarat bahwa bahan ini harus berlaku dalam komposisi: <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">"filter": [ {"script":{ "script": " double nest=0,rest=0; for (ingredient in params._source.ingredients){ if([</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{#tags}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{tagId}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{^isLast}}</span></span><span class="xml"><span class="xml">,</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{/isLast}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{/tags}}</span></span><span class="xml"><span class="xml">].contains(flavor.level_</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{tags.0.levelId}}</span></span><span class="xml"><span class="xml">)){ nest+= ingredient.percent; }else{ if (ingredient.percent&gt;rest){rest = ingredient.percent} } } return(nest&gt;=rest); " }} ]</span></span></code> </pre> <br>  Seperti yang Anda lihat, Elasticsearch tidak memiliki banyak hal untuk proyek ini, jadi mereka harus dikumpulkan dari "sarana yang tersedia".  Tapi ini tidak mengherankan - proyek ini cukup tidak lazim untuk mesin yang digunakan untuk pencarian teks lengkap. <br><br>  Pada salah satu tahap menengah dari proyek, kami membutuhkan hal berikut: menampilkan daftar semua kelompok bahan yang tersedia dan jumlah posisi di masing-masing.  Masalah yang sama terungkap di sini seperti dalam kueri yang berlaku: dari 10.000 resep, sekitar 10 kelompok dihasilkan berdasarkan konten.  Namun, total sekitar 40.000 resep ternyata ada dalam kelompok-kelompok ini, yang sama sekali tidak sesuai dengan kenyataan.  Kemudian kami mulai menggali kueri paralel. <br><br>  Permintaan pertama kami menerima daftar semua grup yang ada di tingkat pertama tanpa jumlah entri.  Setelah itu, beberapa permintaan dibuat: untuk setiap kelompok, permintaan dibuat untuk menerima jumlah sebenarnya dari resep sesuai dengan prinsip persentase yang berlaku.  Semua permintaan ini dikumpulkan dalam satu dan dikirim ke Elasticsearch.  Waktu respons untuk permintaan umum sama dengan waktu pemrosesan permintaan paling lambat.  Agregasi massal memungkinkan untuk memparalelkannya.  Logika serupa (hanya dengan mengelompokkan berdasarkan kondisi dalam kueri) dalam SQL membutuhkan waktu sekitar 15 kali lebih banyak. <br><br><pre> <code class="hljs markdown">/<span class="hljs-bullet"><span class="hljs-bullet">*   *</span></span>/ $params = config('elastic.params'); $params[<span class="hljs-string"><span class="hljs-string">'body'</span></span>] = config('elastic.top_list'); return (Elastic::getClient()-&gt;search($params))[<span class="hljs-string"><span class="hljs-string">'aggregations'</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">'tags'</span></span>][<span class="hljs-string"><span class="hljs-string">'buckets'</span></span>]; /<span class="hljs-bullet"><span class="hljs-bullet">*   *</span></span>/</code> </pre><br>  Setelah itu, kami perlu mengevaluasi: <br><br><ol><li>  berapa banyak resep yang tersedia untuk komposisi saat ini; </li><li>  bahan apa lagi yang bisa kita tambahkan ke komposisi (kadang-kadang kita menambahkan bahan dan mendapat sampel kosong); </li><li>  bahan mana di antara yang dipilih yang dapat kita tandai sebagai satu-satunya bahan pada level ini. </li></ol><br>  Berdasarkan tugas tersebut, kami menggabungkan logika permintaan terakhir yang diterima untuk daftar resep dan logika memperoleh angka pasti dari daftar semua grup yang tersedia: <br><br><pre> <code class="hljs smalltalk">/*  */ <span class="hljs-comment"><span class="hljs-comment">"aggs"</span></span> : { //      <span class="hljs-comment"><span class="hljs-comment">"tags"</span></span> :{ //    <span class="hljs-comment"><span class="hljs-comment">"terms"</span></span> :{ <span class="hljs-comment"><span class="hljs-comment">"field"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ingredients.level_{{ level }}"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"order"</span></span> : {<span class="hljs-comment"><span class="hljs-comment">"_term"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"asc"</span></span>}, <span class="hljs-comment"><span class="hljs-comment">"exclude"</span></span> : [ {{<span class="hljs-symbol"><span class="hljs-symbol">#exclude</span></span>}}{{ id }},{{/exclude}} <span class="hljs-number"><span class="hljs-number">0</span></span>] }, <span class="hljs-comment"><span class="hljs-comment">"aggs"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"reverse_nested"</span></span>: {} } //    ,    } } /*   */ foreach (<span class="hljs-string"><span class="hljs-string">$n</span></span>ot_only as <span class="hljs-string"><span class="hljs-string">$e</span></span>lement) { <span class="hljs-string"><span class="hljs-string">$p</span></span>arameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][] = config(<span class="hljs-string"><span class="hljs-string">'elastic.params'</span></span>); <span class="hljs-string"><span class="hljs-string">$p</span></span>arameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][] = self::getParamsBody( <span class="hljs-string"><span class="hljs-string">$b</span></span>ody, collect(<span class="hljs-string"><span class="hljs-string">$o</span></span>nly-&gt;all())-&gt;push(<span class="hljs-string"><span class="hljs-string">$e</span></span>lement), <span class="hljs-string"><span class="hljs-string">$m</span></span>ax_level, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ); } /*   */ <span class="hljs-string"><span class="hljs-string">$p</span></span>arameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][] = config(<span class="hljs-string"><span class="hljs-string">'elastic.params'</span></span>); <span class="hljs-string"><span class="hljs-string">$p</span></span>arameters[<span class="hljs-string"><span class="hljs-string">'body'</span></span>][] = self::getParamsBody( <span class="hljs-string"><span class="hljs-string">$b</span></span>ody, <span class="hljs-string"><span class="hljs-string">$o</span></span>nly, <span class="hljs-string"><span class="hljs-string">$m</span></span>ax_level, <span class="hljs-string"><span class="hljs-string">$f</span></span>rom, <span class="hljs-string"><span class="hljs-string">$s</span></span>ize<span class="hljs-string"><span class="hljs-string">') ); /*     */ $parameters['</span></span>max_concurrent_searches<span class="hljs-string"><span class="hljs-string">'] = 1 + $not_only-&gt;count(); return (Elastic::getClient()-&gt;msearchTemplate($parameters))['</span></span>responses<span class="hljs-string"><span class="hljs-string">'];</span></span></code> </pre> <br>  Akibatnya, kami menerima permintaan yang menemukan semua resep yang diperlukan dan jumlah totalnya (diambil dari respons ["hit"] ["total"]).  Untuk mempermudah, permintaan ini dicatat di tempat terakhir dalam daftar. <br><br>  Selain itu, melalui agregasi, kami menerima semua bahan id untuk tingkat selanjutnya.  Untuk setiap bahan yang tidak ditandai sebagai "unik," kami membuat kueri di mana kami menandainya sesuai, dan kemudian hanya menghitung jumlah dokumen yang ditemukan.  Jika lebih besar dari nol, maka bahan tersebut dianggap tersedia untuk menetapkan kunci "tunggal".  Saya pikir di sini Anda dapat mengembalikan seluruh templat tanpa saya, yang kami dapatkan pada hasilnya: <br><br><pre> <code class="hljs smalltalk">{ <span class="hljs-comment"><span class="hljs-comment">"from"</span></span>: {{ from }}, <span class="hljs-comment"><span class="hljs-comment">"size"</span></span>: {{ size }}, <span class="hljs-comment"><span class="hljs-comment">"query"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"must"</span></span>: [ {{<span class="hljs-symbol"><span class="hljs-symbol">#ingredientTags</span></span>}} {{<span class="hljs-symbol"><span class="hljs-symbol">#tagList</span></span>}} {<span class="hljs-comment"><span class="hljs-comment">"bool"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"should"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"term"</span></span>: {<span class="hljs-comment"><span class="hljs-comment">"level_{{ levelId }}"</span></span>: {{ tagId }} }} ] }} {{^isLast}},{{/isLast}} {{/tagList}} {{/ingredientTags}} ], <span class="hljs-comment"><span class="hljs-comment">"filter"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"script"</span></span>:{ <span class="hljs-comment"><span class="hljs-comment">"script"</span></span>: <span class="hljs-comment"><span class="hljs-comment">" double nest=0,rest=0; for(ingredient in params._source. ingredients){ if([{{#tags}}{{tagId}}{{^isLast}},{{/isLast}}{{/tags}}].contains(ingredient.level_{{tags.0.levelId}})){ nest+= ingredient.percent; }else{ if (ingredient.percent&gt;rest){ rest= ingredient.percent } } } return(nest&gt;=rest); "</span></span> }} {{<span class="hljs-symbol"><span class="hljs-symbol">#levelsList</span></span>}}, {{<span class="hljs-symbol"><span class="hljs-symbol">#levels</span></span>}} {<span class="hljs-comment"><span class="hljs-comment">"script"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"script"</span></span>: <span class="hljs-comment"><span class="hljs-comment">" int total=0; for(ingredient in params._source.ingredients){ if ([0,{{tag}}].contains(ingredient.level_{{id}})) total+=1; } return (total==params._source.ingredients.length); "</span></span> }} {{^isLast}},{{/isLast}} {{/levels}} {{/levelsList}} ] } }, <span class="hljs-comment"><span class="hljs-comment">"aggs"</span></span> : { <span class="hljs-comment"><span class="hljs-comment">"tags"</span></span> :{ <span class="hljs-comment"><span class="hljs-comment">"terms"</span></span> :{ <span class="hljs-comment"><span class="hljs-comment">"field"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"ingredients.level_{{ level }}"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"order"</span></span> : {<span class="hljs-comment"><span class="hljs-comment">"_term"</span></span> : <span class="hljs-comment"><span class="hljs-comment">"asc"</span></span>}, <span class="hljs-comment"><span class="hljs-comment">"exclude"</span></span> : [ {{<span class="hljs-symbol"><span class="hljs-symbol">#exclude</span></span>}}{{ id }},{{/exclude}} <span class="hljs-number"><span class="hljs-number">0</span></span>] }, <span class="hljs-comment"><span class="hljs-comment">"aggs"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">"reverse_nested"</span></span>: {} } } }, <span class="hljs-comment"><span class="hljs-comment">"sort"</span></span>: [ {<span class="hljs-comment"><span class="hljs-comment">"_score"</span></span>: {<span class="hljs-comment"><span class="hljs-comment">"order"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"desc"</span></span>}} ] }</code> </pre><br>  Tentu saja, kami menyimpan bagian dari tumpukan template dan kueri ini (seperti halaman semua grup yang tersedia dengan jumlah resep yang tersedia), yang menambahkan kami sedikit kinerja di halaman utama.  Keputusan ini memungkinkan data utama dikumpulkan dalam 50 ms. <br><br>  <b>Hasil proyek</b> <br><br>  Kami melakukan pencarian di database setidaknya 50.000 dokumen di Elasticsearch, yang memungkinkan Anda untuk mencari bahan dalam produk dan mendapatkan deskripsi produk dengan bahan yang terkandung di dalamnya.  Segera basis data ini akan bertambah sekitar enam kali (data sedang dipersiapkan), jadi kami cukup senang dengan hasil kami dan Elasticsearch sebagai alat pencarian. <br><br>  Pada masalah kinerja, kami memenuhi persyaratan proyek, dan kami sendiri senang bahwa waktu respons rata-rata untuk permintaan adalah 250-300 ms. <br><br>  Tiga bulan setelah mulai bekerja dengan Elasticsearch, tampaknya tidak lagi membingungkan dan tidak biasa.  Dan keuntungan dari templating sudah jelas: jika kita melihat bahwa permintaan menjadi terlalu besar lagi, kita cukup mentransfer logika tambahan ke templat dan lagi mengirim permintaan asli ke server dengan hampir tidak ada perubahan. <br><br>  "Semua yang terbaik dan terima kasih untuk ikannya!"  (c) <br><br>  <b>PS</b> Pada saat terakhir kami juga perlu menyortir berdasarkan karakter Rusia dalam nama.  Dan kemudian ternyata Elasticsearch tidak memahami alfabet Rusia secara memadai.  Sosis bersyarat “Ultra mega pork 9000 kalori” berubah di dalam penyortiran menjadi “9000” dan berada di akhir daftar.  Ternyata, masalah ini cukup mudah diselesaikan dengan mengubah karakter Rusia menjadi notasi unicode dari bentuk u042B. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id413075/">https://habr.com/ru/post/id413075/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id413063/index.html">Menguji mug termo buatan sendiri pada fase transisi</a></li>
<li><a href="../id413065/index.html">Fitur Baru yang Direncanakan di C # 8.0</a></li>
<li><a href="../id413069/index.html">Pencarian Audio, SEO SEO, dan Bantuan untuk Podcast - Spesialis Google Sudah Mengerjakannya</a></li>
<li><a href="../id413071/index.html">DeepMind mengajarkan AI untuk memainkan video game YouTube</a></li>
<li><a href="../id413073/index.html">Cara bekerja dengan cloud: 30 bahan, panduan praktis dan tips tentang topik PD, IS dan IaaS</a></li>
<li><a href="../id413077/index.html">Intisari materi menarik untuk pengembang seluler # 255 (28 Mei - 3 Juni)</a></li>
<li><a href="../id413083/index.html">Pengembang dari MIT membuat prostesis bionik dengan koordinasi gerakan yang tepat</a></li>
<li><a href="../id413087/index.html">Asisten mobil pria</a></li>
<li><a href="../id413091/index.html">Pencatatan yang nyaman di SpringBoot + Log4j2 + Maven</a></li>
<li><a href="../id413093/index.html">Untuk mengantisipasi balapan pedagang ruang angkasa di Amerika Serikat dan Cina</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>