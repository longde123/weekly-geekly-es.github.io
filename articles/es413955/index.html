<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äç‚úàÔ∏è ü§òüèæ üïü Ciclo de desarrollo completo del dispositivo IoT para el control de calefacci√≥n de piscinas en el ESP8266 en un entorno Arduino üë®üèΩ‚Äçüî¨ üôèüèΩ üë®‚Äçüë©‚Äçüëß‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En esta publicaci√≥n, compartir√© mi experiencia sobre la creaci√≥n de un dispositivo IoT desde cero: desde el surgimiento de una idea y su implementaci√≥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ciclo de desarrollo completo del dispositivo IoT para el control de calefacci√≥n de piscinas en el ESP8266 en un entorno Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413955/"><p>  En esta publicaci√≥n, compartir√© mi experiencia sobre la creaci√≥n de un dispositivo IoT desde cero: desde el surgimiento de una idea y su implementaci√≥n en hardware hasta la creaci√≥n de firmware para un controlador y una interfaz web para administrar un dispositivo creado a trav√©s de Internet. </p><br><p>  Antes de crear este dispositivo, yo: </p><br><ul><li>  Casi no entend√≠a los circuitos.  Solo a nivel de principios de trabajo <br>  resistencia / transistor ... No ten√≠a experiencia en crear circuitos complicados. </li><li>  Nunca dise√±√≥ placas de circuito. </li><li>  Componente SMD nunca soldado.  El nivel de soldador estaba en el nivel de cables de soldadura y alg√∫n tipo de rel√©. </li><li>  Nunca he escrito programas tan complejos para un microcontrolador.  Toda la experiencia fue en el nivel "enciende el LED en Arduino", y conoc√≠ por primera vez el controlador ESP8266. </li><li>  Escrib√≠ bastante C ++ para el "hermano mayor", pero eso fue hace m√°s de una docena de a√±os y todo fue olvidado hace mucho tiempo. </li></ul><br><p>  Por supuesto, la experiencia de trabajar como programador (principalmente Microsoft .NET) y el pensamiento sist√©mico me ayudaron a comprender el tema.  Creo que el lector podr√° hacerlo.  Enlaces y art√≠culos √∫tiles sobre el mar de Internet.  Lo m√°s, en mi opini√≥n, interesante y ayudando a entender el tema, lo traigo con el art√≠culo. </p><a name="habracut"></a><br><h2>  Declaraci√≥n del problema. </h2><br><p>  Vivo en una casa privada cerca de Minsk, y mi propia piscina, aunque sea la m√°s simple, es una parte integral del conjunto de "beneficios" que obtienen muchas personas que viven en una casa de campo.  En nuestro clima inestable, result√≥ que nadar en la piscina es inc√≥modo si est√° al aire libre: el agua se enfr√≠a por la noche y el clima ventoso durante el d√≠a no hace que nadar sea c√≥modo.  El a√±o pasado, con mis propias manos, constru√≠ una c√∫pula geod√©sica <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√°s llena</a> sobre la piscina, puse una colina y colgu√© un bungee: los ni√±os est√°n felices. </p><br><img src="https://habrastorage.org/webt/hh/ec/xp/hhecxpolfqsqevq41tmn-84npsg.jpeg"><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em>Reportaje fotogr√°fico de la</em> construcci√≥n de la c√∫pula en Flickr.</a> </p><br><p>  Este a√±o fui a√∫n m√°s lejos y decid√≠ organizar un calentador de piscina desde una caldera de gas, <br>  que sirve para calentar la casa en invierno y calentar agua caliente en verano. </p><br><p>  En verano, el circuito de "calefacci√≥n" de la caldera con la ayuda de v√°lvulas cambia a calefacci√≥n <br>  piscina  El agua de la piscina se calienta con la ayuda de un intercambiador de calor de titanio, cuyo circuito primario pasa el refrigerante (agua caliente sin impurezas) del circuito de calefacci√≥n y el agua secundaria de la piscina, bombeada por una bomba de recirculaci√≥n del sistema de filtraci√≥n.  Como uso la piscina con un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">clorador (</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ForumHouse</a> se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">describen</a> muchos temas interesantes), el agua contiene un poco de sal y se necesita un intercambiador de calor de titanio.  No puede simplemente tomar y dejar que el agua pase directamente por la caldera; de lo contrario, corroer√° todas las tuber√≠as con sal. </p><br><img src="https://habrastorage.org/webt/d6/_k/pz/d6_kpzjpyzyvy2-vzk9aukvstko.png"><br><p>  Al pasar por el intercambiador de calor, el portador de calor calentado por la caldera con una temperatura de aproximadamente 70-90 ¬∞ C emite calor al agua de la piscina, calent√°ndola un par de grados.  El refrigerante se enfr√≠a un par de decenas de grados y vuelve a la caldera para volver a estar <br>  calentado  La relaci√≥n entre el enfriamiento del agua de la caldera y el calentamiento del agua de la piscina depende de muchos factores: la capacidad del intercambiador de calor y la velocidad de circulaci√≥n del agua en los circuitos primario y secundario. </p><br><p>  Las tuber√≠as conectadas desde la piscina al intercambiador de calor son tuber√≠as de polietileno ordinarias, aquellas que <br>  Actualmente se utiliza para suministrar agua fr√≠a a hogares privados.  Barato, la capacidad de soportar una presi√≥n decente, la ausencia de corrosi√≥n: estas son las principales ventajas de tales tuber√≠as.  Para todos, sin excepci√≥n, las tuber√≠as de polietileno, la temperatura de funcionamiento est√° limitada a 40 grados cent√≠grados.  En principio, esto es m√°s que suficiente para la piscina. </p><br><p>  Sin embargo, existe una alta probabilidad de emergencia en caso de que la bomba <br>  La recirculaci√≥n de agua del agua de la piscina se detendr√° por alguna raz√≥n, y la caldera continuar√° calentando el intercambiador de calor: en este caso, el agua en el circuito secundario del intercambiador de calor se elevar√° r√°pidamente a la temperatura del circuito primario, lo que significa que las secciones de tuber√≠as de polietileno adyacentes al intercambiador de calor se derretir√°n y el agua de la piscina se inundar√°. Todo el espacio alrededor. </p><br><p>  Debe ser posible proteger el sobrecalentamiento del intercambiador de calor. </p><br><h2>  Arreglo r√°pido </h2><br><p>  Para resolver este problema, se incluy√≥ un sensor de flujo que funciona seg√∫n el principio del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">efecto Hall</a> en el circuito del circuito de recirculaci√≥n de agua de la piscina.  Adem√°s, sensores de temperatura ubicados en el circuito secundario <br>  intercambiador de calor, proporciona un segundo nivel de defensa, rastreando el posible sobrecalentamiento. </p><br><p>  Es imposible controlar el sobrecalentamiento solo con sensores de temperatura: el sistema tiene una gran inercia: despu√©s de una parada repentina de agua en el circuito de la piscina, a <br>  apagando la caldera, la temperatura sigue subiendo por alg√∫n tiempo, ya que  la caldera a√∫n impulsa el agua calentada a lo largo del circuito por inercia, evitando el sobrecalentamiento de "yo, mi amado". </p><br><p>  Por lo tanto, es importante responder lo antes posible: es decir, detener el flujo de agua en el circuito <br>  piscina </p><br><p>  Se us√≥ un sensor de flujo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tal</a> .  La carcasa de pl√°stico y la falta de contacto del sensor con el agua permite su uso en agua salada. </p><br><p>  Sensores de temperatura, se decidi√≥ utilizar el Dallas DS18B20, son f√°ciles de conectar varias piezas a la vez en un bus de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">1 cable</a> . </p><br><img src="https://habrastorage.org/webt/nd/pj/d5/ndpjd5v3_0lbaklr-ogjnaxribi.jpeg"><br><p>  Se decidi√≥ colgar un par de sensores en la entrada y salida tanto de la secundaria como de la primaria. <br>  circuito: total 4 sensores.  Una ventaja adicional de este enfoque es <br>  la capacidad de monitorear los par√°metros del sistema: puede monitorear cu√°nto se enfr√≠a el refrigerante en el circuito primario y cu√°nta agua de la piscina se calienta en el circuito secundario.  Entonces, para monitorear la optimizaci√≥n de la calefacci√≥n y predecir el tiempo de calefacci√≥n. </p><br><div class="spoiler">  <b class="spoiler_title">Ubicaciones de sensores en intercambiadores de calor y tuber√≠as de entrada</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/en/vw/mi/envwmicj0l1hc76r23a_uvyjd3w.jpeg"></div></div><br><h2>  Par√°metros del dispositivo </h2><br><p>  El primer prototipo del dispositivo se construy√≥ sobre la base de Arduino Uno y se lanz√≥ con √©xito. </p><br><img src="https://habrastorage.org/webt/ol/xh/rg/olxhrgxw-w4qqnjpzxkuhj7mc7u.png"><br><p>  Pero luego qued√≥ claro que me gustar√≠a m√°s.  Calent√≥ 16 metros c√∫bicos de agua, incluso solo <br>  unos pocos grados no es r√°pido.  Y me gustar√≠a monitorear directamente los par√°metros de calefacci√≥n desde el trabajo, encenderlo / apagarlo.  Pero al mismo tiempo, ser√≠a interesante tomar horarios de calefacci√≥n, por ejemplo, por d√≠a. </p><br><p>  Bueno, dado que ya estamos obteniendo un dispositivo IoT, ¬øpor qu√© no controlamos al mismo tiempo la activaci√≥n remota del clorador de la piscina y la bomba para ello? </p><br><h2>  T√©rminos de referencia </h2><br><p>  Entonces, se decidi√≥ desarrollar un dispositivo: un controlador de piscina multifuncional.  Debe ser capaz de: </p><br><ul><li>  Para controlar la calefacci√≥n de la piscina a trav√©s del intercambiador de calor, enciende / apaga la caldera de gas para calentar el agua. </li><li>  Evite el sobrecalentamiento del intercambiador de calor controlando la presencia de un flujo de agua de la piscina en el circuito secundario y el exceso de temperatura del circuito secundario. <br></li><li>  Muestra estad√≠sticas de calefacci√≥n en tiempo real (temperatura en la entrada y salida de ambos circuitos). </li><li>  Registre (registre) valores de temperatura en la memoria flash.  Mostrar datos para <br>  cierto per√≠odo en forma de gr√°fico. </li><li>  Con un rel√©, puede encender / apagar las bombas de la piscina y el clorador. </li><li>  Administre todos los par√°metros del dispositivo de forma remota a trav√©s del servidor micro-web incorporado. </li></ul><br><p>  Tambi√©n exist√≠a la tentaci√≥n de joder Blink, MQTT.  Pero de estas "campanas y silbatos" en la primera etapa <br>  Se decidi√≥ rechazar.  Y a√∫n m√°s, no quisiera aprovechar la posibilidad de control en alg√∫n lugar externo.  El servidor web incorporado para mis prop√≥sitos es suficiente.  Y la seguridad est√° garantizada por el hecho de que puede ingresar a la red dom√©stica desde el mundo exterior solo a trav√©s de una VPN. </p><br><h2>  Hardware </h2><br><p>  Como controlador, se decidi√≥ utilizar el ESP8266 barato y popular.  Fue perfecto para mis prop√≥sitos, excepto por una cosa: hacer coincidir los niveles de se√±al de los sensores de 5 voltios con la l√≥gica del controlador de 3.3 voltios.  En principio, los sensores de Dallas parecen funcionar a 3 voltios, pero tengo una l√≠nea bastante larga desde el controlador hasta los sensores, unos 7 metros.  Por lo tanto, es mejor aumentar el voltaje. </p><br><p>  Se determin√≥ que es necesario tener el hardware: </p><br><ul><li>  Controlador ESP8266 o su hermano mayor ESP32 (como m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DevKit</a> ). <br></li><li>  Alineaci√≥n de niveles de se√±al para sensores. </li><li>  El regulador de potencia es una parte de 5 voltios del circuito. </li><li>  M√≥dulo de control de rel√©. </li><li>  Reloj RTC + memoria flash para el registro. </li><li>  La pantalla LCD de 2 l√≠neas m√°s simple para mostrar los valores actuales de los sensores y el estado del dispositivo y el rel√©. </li><li>  Varios botones f√≠sicos para controlar el estado del dispositivo sin acceso a trav√©s de la web. </li></ul><br><p>  Muchos componentes de la lista se venden como m√≥dulos para Arduino y muchos m√≥dulos son compatibles con la l√≥gica 3.3v.  Sin embargo, no quer√≠a "atascar" todo esto en la placa con paquetes de cables, porque quiero tener un "dispositivo" bonito y bonito.  S√≠, y por el dinero otorgado a los chinos por los m√≥dulos, puede dibujar y ordenar completamente su placa de circuito impreso individual, y la expectativa de su llegada ser√° compensada por una instalaci√≥n relativamente r√°pida y confiable. </p><br><p>  Una vez m√°s, noto que esta es mi primera experiencia en circuitos y en el dise√±o del hardware de tales cosas.  Tuve que estudiar mucho.  De hecho, en mi especialidad, soy un poco distante de los microcontroladores.  Pero hacer todo "de rodillas" no permiti√≥ el esp√≠ritu de perfeccionismo que vive en m√≠. </p><br><h2>  Diagrama de circuito </h2><br><p>  Hay una gran cantidad de programas en el mercado que le permiten dibujar un circuito y una placa de circuito impreso.  Sin experiencia en esta √°rea, inmediatamente me gust√≥ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">EasyEDA</a> , un editor en l√≠nea gratuito que le permite pintar bellamente un diagrama de circuito, verificar que no se haya olvidado nada y que todos los componentes tengan conexiones, dibujar una placa de circuito impreso y luego ordenar inmediatamente su producci√≥n. </p><br><p>  La primera dificultad que encontr√©: hay muchas opciones para el controlador DevKit ESP8266 o ESP32, algunas de ellas difieren en la ubicaci√≥n de los pines y su prop√≥sito, y algunas incluso en ancho.  Se decidi√≥ dibujar el circuito para que fuera posible colocar DevKit de cualquier ancho y con cualquier ubicaci√≥n de los terminales, y a los lados del mismo: 2 filas de pares de agujeros de puente y, posteriormente, cableado para conectar los terminales necesarios, con respecto al controlador adquirido espec√≠ficamente. </p><br><p>  Coloque debajo del controlador y 2 filas de puentes emparejados: JH1 y JH2 en el diagrama: </p><br><img src="https://habrastorage.org/webt/mz/a0/nl/mza0nlxbzvfaqjqcti7vc32ikbe.png"><br><p>  La ubicaci√≥n de los pines de entrada 5v y salida 3.3v de la fuente de alimentaci√≥n del estabilizador incorporado, as√≠ como GND, me pareci√≥ lo mismo para diferentes DevKit, pero a√∫n as√≠ decid√≠ ir a lo seguro y tambi√©n hacerlos puentes: JP1, JP2, JP3 en el diagrama. </p><br><p>  Decid√≠ firmar los puentes conect√°ndolos a los componentes del circuito con funciones que probablemente realizar√°n. </p><br><div class="spoiler">  <b class="spoiler_title">Y as√≠ es como se ve con el DevKit ESP8266, que finalmente compr√© e instal√©</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/cg/3p/b5/cg3pb5pg7clju7haw77dah1udhs.png"></div></div><br><p>  Aqu√≠ D1 (GPIO5) y D2 (GPIO4) son responsables del bus I2C, D5 (GPIO14) para 1-Wire, D6 (GPIO12) - para recibir pulsos del sensor de flujo. </p><br><p>  Diagrama del circuito: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ar/jj/n3/arjjn3bgb-ffz_yjofhjy72q_cq.png"></a> <br>  (imagen en la que se puede hacer clic) </p><br><p>  A pesar de la presencia a bordo del ESP8266 de un regulador de potencia incorporado para 3.3v, todav√≠a necesitamos 5 voltios para alimentar los sensores y la pantalla LCD, y 12 voltios para alimentar el rel√©.  Se decidi√≥ hacer que la placa tuviera una potencia de 12 voltios y colocar el regulador de voltaje AMS1117-5.0 en la entrada, dando los 5 voltios deseados en la salida. </p><br><p>  Para igualar los niveles de se√±al en el bus de 1 cable, utilic√© un transistor de efecto de campo BSS138 c con "pull-ups" de voltaje en ambos lados. </p><br><img src="https://habrastorage.org/webt/y_/sx/st/y_sxstfcgm3kys4hntq5beb5xby.png"><br><p>  Muy bueno acerca de la coincidencia de niveles est√° escrito en el art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Coincidencia de niveles l√≥gicos de dispositivos 5V y 3.3V</a> . </p><br><p>  Para igualar los niveles de se√±al del sensor de flujo, simplemente utilic√© un divisor de voltaje a trav√©s de las resistencias.  El sensor de flujo es simplemente un dispositivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">colector abierto</a> .  Algunos sensores ya pueden tener una resistencia pull-up incorporada, esto debe considerarse: </p><br><img src="https://habrastorage.org/webt/9v/8e/br/9v8ebrvm_bsfzounu3kamf4grc8.png"><br><p>  Azul en el diagrama es una designaci√≥n esquem√°tica del conjunto del sensor de flujo.  A la derecha del conector hay divisores de voltaje seleccionados por m√≠ para tener un nivel m√°ximo de 3.3 voltios en la salida. </p><br><p>  En el bus I2C, colgu√© un reloj DS3231SN en tiempo real y una memoria flash AT24C256C para almacenar registros.  La memoria flash integrada en el ESP8266 no es adecuada, ya que tiene una peque√±a cantidad de ciclos de reescritura (10 mil versus 1 mill√≥n para AT24Cxxx, seg√∫n las hojas de datos). </p><br><p>  El control de rel√© est√° organizado en un mont√≥n de chips PCF8574AT y ULN2803A. </p><br><img src="https://habrastorage.org/webt/9v/8e/br/9v8ebrvm_bsfzounu3kamf4grc8.png"><br><p>  El primer chip es un expansor de puerto de microcontrolador I2C.  El estado de la salida o entrada activa PCF8574AT se selecciona seleccionando una direcci√≥n en el bus I2C. <br>  El chip tiene algunas caracter√≠sticas interesantes, bien descritas en el art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">expansor de puertos I2C PCF8574</a> . </p><br><p>  El chip no puede controlar directamente la carga (rel√©).  Para esto, se utiliza una matriz de transistores ULN2803A.  Hay una caracter√≠stica: la matriz puede extraer f√°cilmente sus salidas con una carga al suelo, lo que significa que si se aplica un voltaje de suministro al segundo polo del rel√©, la corriente fluir√° a trav√©s del devanado del rel√© y los contactos del rel√© se cerrar√°n.  Desafortunadamente, con esta inclusi√≥n, obtenemos un efecto secundario: el valor de la se√±al del controlador se invierte y todos los rel√©s "hacen clic" cuando se enciende el circuito.  Todav√≠a no he descubierto c√≥mo eliminar esta funci√≥n. </p><br><p>  Aqu√≠ se describe m√°s informaci√≥n sobre el chip. </p><br><p>  El expansor de puerto PCF8574AT tambi√©n se puede usar como entrada: los botones de hardware se pueden colgar en algunas de las entradas, leyendo sus valores en el bus I2C.  En el diagrama, los pines 4-7 se pueden usar para leer el estado de los botones.  Lo principal es no olvidar habilitar mediante programaci√≥n el ajuste incorporado de las patas correspondientes a la nutrici√≥n. </p><br><p>  Al mismo tiempo, dej√© el cableado a la matriz del transistor, en caso de que de repente desee conectar rel√©s adicionales.  Para posibles conexiones, traje todos los cables a los conectores (m√°s precisamente, a los agujeros debajo de ellos donde se pueden soldar los cables o se puede soldar el conector DIP est√°ndar de 2.54 mm). </p><br><p>  El pin del expansor de puerto INT se puede usar para responder r√°pidamente a la presi√≥n de un bot√≥n.  Se puede conectar a un puerto libre en el controlador y configurar el disparador de interrupci√≥n para cambiar el estado de este pin. </p><br><p>  La pantalla LCD de dos l√≠neas tambi√©n se controla a trav√©s del expansor PCF8574AT.  El punto principal: la pantalla est√° alimentada por 5 voltios, mientras que la pantalla est√° controlada por l√≥gica de 3 voltios.  Por cierto, los adaptadores Arduino est√°ndar para I2C no est√°n dise√±ados para doble voltaje.  Encontr√© la idea de tal conexi√≥n en alg√∫n lugar de Internet, desafortunadamente, perd√≠ el enlace, as√≠ que no cito la fuente. </p><br><h2>  Placa de circuito </h2><br><p>  Al dise√±ar el tablero, result√≥ que las partes comunes con patas ocupan demasiado espacio, y muchas fichas en el dise√±o DIP no son f√°ciles de encontrar.  Despu√©s de leer en Internet que la instalaci√≥n de SMD no es tan complicada, y con la habilidad adecuada, es a√∫n menos lenta, decid√≠ dise√±ar la placa para piezas SMD.  Y no me equivoqu√©.  Result√≥ una placa base compacta y hermosa, donde puse f√°cilmente todo lo que necesitaba.  Las piezas SMD, con un buen soldador, fundente y soldadura, resultaron realmente muy f√°ciles de montar. </p><br><p>  En el tablero, agregu√© algunos m√°rgenes cuadrados de agujeros para la creaci√≥n de prototipos, si de repente quiero soldar otra cosa. </p><br><p>  Hice una placa de circuito impreso de 97x97 mm.  Se adapta f√°cilmente a una caja el√©ctrica de corte est√°ndar.  Adem√°s, las tablas con tama√±os inferiores a 100x100 son baratas de fabricar.  La producci√≥n de un lote m√≠nimo de 5 tableros de acuerdo con el dise√±o desarrollado cost√≥ 5 USD, su entrega a Bielorrusia cost√≥ otros 9 USD. </p><br><img src="https://habrastorage.org/webt/u9/ov/ou/u9ovouhbfeuadqoixu_je1zjd54.png"><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El dise√±o de la placa se</a> encuentra en el sitio web de EasyEDA y est√° disponible para todos. </p><br><p>  Observo que en la foto del controlador a continuaci√≥n aparece la primera muestra de la placa, en la que "torc√≠" muchas cosas innecesarias e innecesarias (con la esperanza de usar este lote m√≠nimo de 5 placas en otros proyectos).  Aqu√≠ y en EasyEDA publiqu√© una versi√≥n "limpia" de todas estas cosas innecesarias. </p><br><img src="https://habrastorage.org/webt/vb/jn/p9/vbjnp97xoyff3jde4oeyh2hkvpg.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Fotos de ambos lados del tablero</b> <div class="spoiler_text"><p>  Lado delantero: </p><br><img src="https://habrastorage.org/webt/fs/8_/it/fs8_itdlmt1qredzy8b2h0prk4k.jpeg"><br><p>  Reverso: </p><br><img src="https://habrastorage.org/webt/l8/tc/bo/l8tcboqf53vonco7zla9koydq2s.jpeg"></div></div><br><h2>  Parte de software </h2><br>  Para programar el microcontrolador, dada la acumulaci√≥n en forma de prototipo en Arduino Uno, se decidi√≥ utilizar el entorno Arduino con el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ESP8266 Arduino Core</a> instalado.  S√≠, puedes usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lua</a> en el ESP8266, pero dicen que hay bloqueos.  Yo, dada la funci√≥n cr√≠tica realizada, no quisiera en absoluto. <br>  El entorno Arduino en s√≠ mismo me parece un poco anticuado, pero, afortunadamente, hay una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extensi√≥n</a> para Visual Studio de Visual Micro.  El entorno le permite usar sugerencias de c√≥digo IntelliSence, saltar r√°pidamente a las declaraciones de funciones, refactorizar el c√≥digo: en general, todo lo que el entorno para las computadoras "adultas" se permite.  La versi√≥n paga de Visual Micro tambi√©n le permite depurar convenientemente el c√≥digo, pero estaba contento con la opci√≥n gratuita. <br><h2>  Estructura del proyecto </h2><br>  El proyecto consta de los siguientes archivos: <br><div class="spoiler">  <b class="spoiler_title">Estructura del proyecto en Visual Studio</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/4i/dn/hu/4idnhu7toeunqk727_fnhcmpl34.png"></div></div><br><table><tbody><tr><th>  Archivo </th><th>  Cita </th></tr><tr><td>  WaterpoolManager.ino <br></td><td>  Declaraci√≥n de variables b√°sicas y constantes.  Inicializacion.  Bucle principal <br></td></tr><tr><td>  HeaterMainLogic.ino <br></td><td>  La l√≥gica b√°sica de controlar el rel√© de la caldera (seg√∫n la temperatura) y los rel√©s auxiliares. <br></td></tr><tr><td>  Sensors.ino <br></td><td>  Leer datos del sensor <br></td></tr><tr><td>  Settings.ino <br></td><td>  Configuraci√≥n del dispositivo, guard√°ndolos en la memoria flash del controlador <br></td></tr><tr><td>  LCD.ino <br></td><td>  Salida de informaci√≥n en LCD <br></td></tr><tr><td>  ClockTimer.ino <br></td><td>  Lectura de reloj RTC o simulaci√≥n de reloj <br></td></tr><tr><td>  Rel√©s.ino <br></td><td>  Control de encendido / apagado de rel√© <br></td></tr><tr><td>  ButtonLogic.ino <br></td><td>  L√≥gica de reacci√≥n al estado de los botones de hardware. <br></td></tr><tr><td>  ReadButtonStates.ino <br></td><td>  Leer estados del bot√≥n de hardware <br></td></tr><tr><td>  EEPROM_Logging.ino <br></td><td>  Registro de datos del sensor en EEPROM <br></td></tr><tr><td>  WebServer.ino <br></td><td>  Servidor web incorporado para administraci√≥n de dispositivos y visualizaci√≥n de estado <br></td></tr><tr><td>  <b>Paginas web</b> <br></td><td>  Las p√°ginas del servidor web se almacenan en esta carpeta. <br></td></tr><tr><td>  index.h <br></td><td>  La p√°gina principal para mostrar el estado del dispositivo.  Lectura del estado actual con llamada ajax.  Actualiza cada 5 segundos. <br></td></tr><tr><td>  loggraph.h <br></td><td>  Muestra un registro de datos del sensor y estados de rel√© en un gr√°fico.  Se utiliza la biblioteca jqPlot: toda la construcci√≥n se realiza en el lado del cliente.  La solicitud al controlador va solo a un archivo binario: copias de datos de la EEPROM. <br></td></tr><tr><td>  logtable.h <br></td><td>  tambi√©n, pero en forma de tabla <br></td></tr><tr><td>  ajustes.h <br></td><td>  Gesti√≥n de la configuraci√≥n del dispositivo: configuraci√≥n de l√≠mites de temperatura, flujo de agua, frecuencia de registro de datos <br></td></tr><tr><td>  hora.h <br></td><td>  Ajuste de hora actual <br></td></tr><tr><td><br></td><td>  <b>Bibliotecas</b> <br></td></tr><tr><td>  EepromLogger.cpp <br></td><td>  Biblioteca de registro de Flash <br></td></tr><tr><td>  EepromLogger.h <br></td></tr><tr><td>  crc8.cpp <br></td><td>  8- CRC   <br></td></tr><tr><td> crc8.h <br></td></tr><tr><td> TimeSpan.cpp <br></td><td>      <br></td></tr><tr><td> TimeSpan.h <br></td></tr></tbody></table><br><h2>   </h2><br><p>          OneWire       tempSensAddr.              .       (    4    ): </p><br><pre><code class="hljs powershell"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ds.search(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>]) &amp;&amp; lastSensorIndex &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) { Serial.print(<span class="hljs-string"><span class="hljs-string">"ROM ="</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (byte i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { Serial.print(<span class="hljs-string"><span class="hljs-string">' '</span></span>); Serial.print(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>][<span class="hljs-type"><span class="hljs-type">i</span></span>], HEX); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>], <span class="hljs-number"><span class="hljs-number">7</span></span>) != tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>][<span class="hljs-number"><span class="hljs-number">7</span></span>]) { Serial.print(<span class="hljs-string"><span class="hljs-string">" CRC is not valid!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> lastSensorIndex++; Serial.println(); } ds.reset_search(); lastSensorIndex--; Serial.print(<span class="hljs-string"><span class="hljs-string">"\r\nTemperature sensor count: "</span></span>); Serial.print(lastSensorIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, DEC);  ,       ().       Serial   LCD  : // Read sensor values and print temperatures ds.reset(); ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>xCC, TEMP_SENSOR_POWER_MODE); // Request all sensors at the one time ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>x44, TEMP_SENSOR_POWER_MODE); // Acquire temperatures delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); // Delay is required by temp. sensors char tempString[<span class="hljs-number"><span class="hljs-number">10</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (byte addr = <span class="hljs-number"><span class="hljs-number">0</span></span>; addr &lt;= lastSensorIndex; addr++) { ds.reset(); ds.select(tempSensAddr[<span class="hljs-type"><span class="hljs-type">addr</span></span>]); ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>xBE, TEMP_SENSOR_POWER_MODE); // Read Scratchpad tempData[<span class="hljs-type"><span class="hljs-type">addr</span></span>] = ds.read() | (ds.read() &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); // Read first <span class="hljs-number"><span class="hljs-number">2</span></span> bytes which carry temperature <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> int tempInCelsius = (tempData[<span class="hljs-type"><span class="hljs-type">addr</span></span>] + <span class="hljs-number"><span class="hljs-number">8</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> celsius, with math rounding Serial.print(tempInCelsius, DEC); // Print temperature Serial.println(<span class="hljs-string"><span class="hljs-string">" C"</span></span>); }</code> </pre> <br><p>  Seg√∫n la hoja de datos, los sensores requieren un retraso de al menos 750 ms entre solicitar un valor de temperatura y recibir una respuesta del sensor.  Por lo tanto, el c√≥digo introdujo un retraso con un peque√±o margen. </p><br><p>  Sin embargo, esta demora, cuando todo el dispositivo est√° esperando una respuesta, es aceptable al comienzo, pero es absolutamente inapropiado esperar cada vez con sondeos regulares de los sensores.  Por lo tanto, se escribi√≥ el siguiente c√≥digo complicado, llamado cada 50 ms por temporizador: </p><br><pre> <code class="hljs lua">#define TEMP_MEASURE_PERIOD <span class="hljs-number"><span class="hljs-number">20</span></span> // Time of measuring, * TEMP_TIMER_PERIODICITY ms #define TEMP_TIMER_PERIODICITY <span class="hljs-number"><span class="hljs-number">50</span></span> // Periodicity of timer calling, ms timer.attach_ms(TEMP_TIMER_PERIODICITY, tempReadTimer); int tempMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; void tempReadTimer() // Called many times <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> second, perform only one small operation per call { tempMeasureCycleCount++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempMeasureCycleCount &gt;= TEMP_MEASURE_PERIOD) { tempMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; // Start cycle again } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempMeasureCycleCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ds.reset(); ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0xCC</span></span>, TEMP_SENSOR_POWER_MODE); // Request all sensors at the one <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, TEMP_SENSOR_POWER_MODE); // Acquire temperatures } // Between phases above <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> below should be &gt; <span class="hljs-number"><span class="hljs-number">750</span></span> ms int addr = TEMP_MEASURE_PERIOD - tempMeasureCycleCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (addr &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; addr &lt;= lastSensorIndex) { ds.reset(); ds.<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(tempSensAddr[addr]); ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, TEMP_SENSOR_POWER_MODE); // Read Scratchpad tempData[addr] = ds.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>() | (ds.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>() &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); // Read first <span class="hljs-number"><span class="hljs-number">2</span></span> bytes which carry temperature data } }</code> </pre> <br><p>  Al comienzo de cada ciclo tempMeasureCycleCount, se solicita a los sensores que lean sus valores.  Despu√©s de que pasan aproximadamente 50 ciclos de este tipo (y en total es 50 * 20 = 1000 ms = 1 segundo), se lee el valor de cada sensor, uno a la vez.  Todo el trabajo se divide en pedazos para que el c√≥digo que se ejecuta en la interrupci√≥n del temporizador no tome mucho tiempo del controlador. </p><br><p>  El valor del sensor de flujo se calcula de la siguiente manera.  Al interrumpir el pin en el que se cuelga el sensor, aumentamos el valor del contador de tics que provino del sensor de flujo: </p><br><pre> <code class="hljs pgsql">pinMode(FLOW_SENSOR_PIN, <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span>); attachInterrupt(digitalPinToInterrupt(FLOW_SENSOR_PIN), flow, RISING); // Setup Interrupt <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> flow_frequency; // Flow sensor pulses <span class="hljs-type"><span class="hljs-type">int</span></span> flowMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> flow() // Flow sensor interrupt <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> { flow_frequency++; }</code> </pre> <br><p>  En el mismo temporizador donde se sondean los sensores de temperatura, una vez por segundo tomamos este valor de marca y lo traducimos a litros usando la constante FLOW_SENSOR_CONST, cuyo valor se puede encontrar en las caracter√≠sticas del sensor: </p><br><pre> <code class="hljs pgsql">flowMeasureCycleCount++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flowMeasureCycleCount &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> / TEMP_TIMER_PERIODICITY) { flowMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; litersInMinute = (flow_frequency / FLOW_SENSOR_CONST); // Pulse frequency (Hz) = FLOW_SENSOR_CONST*Q, Q <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> flow rate <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> L/min. flow_frequency = <span class="hljs-number"><span class="hljs-number">0</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">Reset</span></span> Counter }</code> </pre> <br><h2>  Registro de datos de sensores y estado del dispositivo </h2><br><p>  Al desarrollar el mecanismo de registro, el hecho de que el dispositivo puede apagarse repentinamente, es decir,  en casi cualquier momento  Cuando deje de grabar, debemos poder restaurar todo lo grabado hasta el √∫ltimo momento.  Al mismo tiempo, no podemos reescribir constantemente la misma √°rea de memoria flash (por ejemplo, un t√≠tulo determinado en un lugar determinado, recordando la direcci√≥n donde se realiz√≥ la grabaci√≥n por √∫ltima vez), a fin de evitar el "borrado" acelerado de la unidad flash en este lugar. </p><br><p>  Despu√©s de alguna "acumulaci√≥n", se invent√≥ e implement√≥ el siguiente modelo de grabaci√≥n: </p><br><img src="https://habrastorage.org/webt/ue/zv/vg/uezvvgglwxhvsvn5uhdmkiic8ju.png"><br><p>  Cada registro es un registro que contiene informaci√≥n sobre el valor actual del flujo de agua, las temperaturas del sensor, as√≠ como el estado del dispositivo codificado en el byte (los bits individuales indican si el rel√© est√° encendido o no, si el calentamiento est√° habilitado o no): </p><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LogEvent</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> litersInMinute = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> tempCelsius[<span class="hljs-number"><span class="hljs-number">4</span></span>]{ <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> deviceStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  Despu√©s de cada registro, hay un byte de suma de verificaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CRC</a> , que indica si el registro se escribi√≥ correctamente y, en general, si al menos algo se escribi√≥ en esta ubicaci√≥n de memoria. </p><br><p>  Dado que ser√≠a demasiado costoso registrar datos en la hora actual ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">marca de tiempo</a> ) para cada registro en t√©rminos de volumen, los datos se organizan en bloques grandes, con N registros en cada uno.  La marca de tiempo para cada bloque se registra solo una vez, para el resto, se calcula en funci√≥n de la informaci√≥n sobre la frecuencia de registro. </p><br><pre> <code class="hljs vhdl"><span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int logRecordsInBlock = <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> / loggingPeriodSeconds; // <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> hour <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int block_size = sizeof(Block_Header) + logRecordsInBlock * (record_size + crcSize); <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int block_count = total_storage_size / block_size;</code> </pre> <br><p>  Por ejemplo, con una frecuencia de registro de una vez cada 30 segundos, tendremos 120 entradas en un bloque, y el tama√±o del bloque ser√° de aproximadamente 840 bytes.  En total, podemos colocar 39 bloques en la memoria de una unidad flash de 32 kilobytes de tama√±o.  Con tal organizaci√≥n, resulta que cada bloque comienza en una direcci√≥n estrictamente definida en la memoria, y "atravesar" todos los bloques no es un problema. </p><br><p>  En consecuencia, con un salto repentino en el registro durante el √∫ltimo apagado del dispositivo, tendremos un bloqueo inacabado (es decir, en el que faltan algunos de los registros).  Cuando se enciende el dispositivo, el algoritmo busca el √∫ltimo encabezado de bloque v√°lido (marca de tiempo + crc).  Y contin√∫a grabando, comenzando con el siguiente bloque.  La grabaci√≥n se realiza c√≠clicamente: el √∫ltimo bloque sobrescribe los datos del bloque m√°s antiguo. </p><br><p>  Al leer, todos los bloques se leen secuencialmente.  Los bloques no v√°lidos (aquellos que no pasan CRC para la marca de tiempo) se ignoran por completo.  Los registros en cada bloque se leen hasta la reuni√≥n del primer registro no v√°lido (es decir, aquel en el que se cort√≥ la grabaci√≥n la √∫ltima vez si el bloque no se grab√≥ por completo).  El resto son ignorados. <br>  Para cada registro, el tiempo actual se calcula en funci√≥n de la marca de tiempo del bloque y el n√∫mero de serie del registro en el bloque. </p><br><h2>  LCD </h2><br><p>  El dispositivo utiliza una pantalla QC1602A, capaz de mostrar 2 l√≠neas de 16 caracteres.  La primera l√≠nea muestra la informaci√≥n actual sobre los valores actuales de los sensores: flujo y temperaturas.  Si se excede el l√≠mite especificado, aparece un signo de exclamaci√≥n cerca del valor.  La segunda l√≠nea muestra el estado del rel√© de calefacci√≥n y la bomba, as√≠ como el tiempo transcurrido desde que se encendi√≥ o apag√≥ la calefacci√≥n.  Cada 5 segundos, la pantalla en la segunda l√≠nea muestra brevemente los l√≠mites actuales.  Las fotos de la pantalla en varios modos se muestran al final de la publicaci√≥n. </p><br><h2>  Gr√°ficos </h2><br><p>  Cuando se solicita a trav√©s del servidor web incorporado, los datos de registro se leen en forma binaria usando JavaScript: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhttp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhttp.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs.bin"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhttp.responseType = <span class="hljs-string"><span class="hljs-string">"arraybuffer"</span></span>; xhttp.onprogress = updateProgress; xhttp.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">oEvent</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arrayBuffer = xhttp.response; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arrayBuffer) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(arrayBuffer); ‚Ä¶ }}; xhttp.send(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br><p>  Leerlos en alg√∫n formato no binario popular, como ajax, ser√≠a un lujo inadmisible para el controlador, principalmente debido a la gran cantidad que tendr√≠a que devolver el servidor http incorporado. </p><br><p>  Por la misma raz√≥n, la biblioteca JavaScript <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">jqPlot</a> se usa para construir gr√°ficos, y los archivos de la biblioteca JS se cargan desde <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CDN</a> populares. </p><br><p>  Un ejemplo de la programaci√≥n del dispositivo: </p><br><img src="https://habrastorage.org/webt/uh/kr/bc/uhkrbccsl1k8l6w_3am6tunwe5a.png"><br><p>  Se ve claramente que aproximadamente a las 9:35 el dispositivo se encendi√≥ para calentar, la caldera comenz√≥ a calentar gradualmente el circuito de calefacci√≥n (sensores T3, T4), despu√©s de lo cual la temperatura del circuito de la piscina comenz√≥ a aumentar (sensores T1, T2).  Alrededor de las 10:20, la caldera pas√≥ a calentar agua caliente en la casa, la temperatura del circuito de calefacci√≥n baj√≥.  Luego, despu√©s de otros 10 minutos, la caldera volvi√≥ a calentar el agua de la piscina.  A las 10:50 ocurri√≥ un accidente: la bomba de circulaci√≥n de agua en la piscina se apag√≥ de repente.  El flujo de agua cay√≥ bruscamente a cero, el rel√© de calentamiento se apag√≥ (l√≠nea roja punteada en la segunda tabla), evitando el sobrecalentamiento.  Pero el dispositivo a√∫n permaneci√≥ en estado de calentamiento (l√≠nea roja en el segundo gr√°fico).  Es decir  Si la bomba se volviera a encender y las temperaturas fueran normales, el dispositivo volver√≠a a calentarse.  Observo que despu√©s de un apagado de emergencia de la bomba, las temperaturas en el circuito de agua de la piscina (T1, T2) comenzaron a aumentar bruscamente debido al sobrecalentamiento del intercambiador de calor.  Y si no fuera por un apagado brusco de la caldera, habr√≠a problemas. </p><br><h2>  Servidor web incorporado </h2><br><p>  Para comunicarse con el mundo exterior, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se utiliza la</a> clase est√°ndar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ESP8266WebServer</a> .  Cuando se inicia el dispositivo, se inicializa como un punto de acceso con la contrase√±a predeterminada especificada en #define AP_PASS.  Se abre autom√°ticamente una p√°gina web para seleccionar una red wi-fi disponible e ingresar una contrase√±a.  Despu√©s de ingresar la contrase√±a, el dispositivo se reinicia y se conecta al punto de acceso especificado. </p><br><h2>  Dispositivo terminado </h2><br><p>  El dispositivo terminado se coloc√≥ en una caja de corte est√°ndar para el cableado.  Se recort√≥ un agujero para la pantalla LCD y agujeros para los conectores. </p><br><img src="https://habrastorage.org/webt/dz/si/tx/dzsitx4tim2kcxqnticd7ln2vho.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Fotos de la fachada del dispositivo en diferentes modos.</b> <div class="spoiler_text"><p>  Con la visualizaci√≥n del tiempo transcurrido despu√©s de encender: </p><br><img src="https://habrastorage.org/webt/fh/gn/fn/fhgnfnf-emu1rl31w7bm4fbmmvs.jpeg"><br><p>  Con los l√≠mites mostrados: </p><br><img src="https://habrastorage.org/webt/qi/8c/r2/qi8cr2ex8uwr3e9xgzs5ms__vou.jpeg"></div></div><br><h2>  Conclusi√≥n </h2><br><p>  En conclusi√≥n, quiero decir que, al desarrollar dicho dispositivo, obtuve una gran experiencia con circuitos, dise√±o de PCB, habilidades de instalaci√≥n para componentes SMD, en la arquitectura y programaci√≥n de microcontroladores, record√© C ++ casi olvidado y un manejo cuidadoso de la memoria y otros recursos limitados del controlador.  El conocimiento de HTML5, JavaScript y las habilidades de depuraci√≥n de los scripts en el navegador tambi√©n fueron √∫tiles hasta cierto punto. </p><br><p>  Estas habilidades y el placer recibido durante el desarrollo del dispositivo son los principales beneficios obtenidos.  Y los c√≥digos fuente del dispositivo, el diagrama del circuito, las placas de circuito impreso, por favor use, modifique.  Todos los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c√≥digos fuente del proyecto</a> est√°n en GitHab.  Hardware en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proyecto p√∫blico</a> en EasyEDA.  Recopil√© datos en los chips utilizados en el proyecto en una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">unidad de red</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413955/">https://habr.com/ru/post/es413955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413945/index.html">M√°s f√°cil de lo que parece. Cap√≠tulos 4-5</a></li>
<li><a href="../es413947/index.html">Implementaci√≥n del trabajo con el servidor Long Poll en el cliente VKontakte para Sailfish OS</a></li>
<li><a href="../es413949/index.html">¬øPor qu√© seguimos leyendo libros en papel?</a></li>
<li><a href="../es413951/index.html">Ense√±e a otros a convertirse en un mejor programador.</a></li>
<li><a href="../es413953/index.html">Cu√°ndo y por qu√© vale la pena usar las funciones de flecha ES6, y cu√°ndo no</a></li>
<li><a href="../es413957/index.html">Un ejemplo de creaci√≥n de una aplicaci√≥n deportiva en tiempo real en Node.js</a></li>
<li><a href="../es413959/index.html">Imagen de Docker m√°s peque√±a: menos de 1000 bytes</a></li>
<li><a href="../es413963/index.html">Mini CRM para peque√±as empresas</a></li>
<li><a href="../es413965/index.html">Revisi√≥n de c√≥digo: lo est√°s haciendo mal</a></li>
<li><a href="../es413967/index.html">Animal Crossing Developer Mode Ingenier√≠a inversa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>