<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏼 🤴🏿 🗻 Vigilante móvil en Raspberry pi (h.264) 👸🏻 🦖 🕢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los temas sobre el uso de Raspberry pi para el control de FPV y la supervisión del movimiento en un marco a lo largo de los vectores H.264 no son nuev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vigilante móvil en Raspberry pi (h.264)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424191/">  Los temas sobre el uso de Raspberry pi para el control de FPV y la supervisión del movimiento en un marco a lo largo de los vectores H.264 no son nuevos.  El desarrollo no pretende ser original, y se dedicó relativamente poco tiempo (a veces los fines de semana de julio). <br><br>  Pero quizás mi experiencia (y la fuente) será útil para cualquiera. <br><br>  La idea de que necesita hacer videovigilancia en el apartamento surgió después de que un vecino dijo que alguien estaba profundizando en la cerradura de la puerta. <br><br>  Lo primero que se agitó fue la instalación del famoso programa de movimiento en el Raspberry pi zero con una cámara v1.3.  En principio, resuelve el problema.  Si está satisfecho con la notificación por correo y fps = 4-5. <br><br>  Pero esto no parecía interesante.  A la mano había una plataforma con ruedas y arneses de viejos experimentos y 18650 baterías de viejas computadoras portátiles. <br><br>  El resultado es una mezcla divertida de video vigilancia móvil y detección de movimiento. <br>  Como tengo un VPS alquilado, no hubo problemas para acceder desde el exterior (red doméstica detrás de NAT).  La duración de la batería es de aproximadamente 4 días si no abusa del viaje y los faros. <br><br>  Puede pasear por el apartamento, controlando de forma remota tanto la cámara como la plataforma y dejarlo en modo de detección de movimiento en cualquier ubicación deseada. <br><br><img src="https://habrastorage.org/webt/fm/bz/hr/fmbzhriyrbtmqotgwhvk28uexlm.jpeg"><br><br><a name="habracut"></a><h1>  Hardware </h1><br>  Todo el hardware se puede dividir en dos partes, la primera de las cuales no depende de la segunda y se puede usar por separado: <br><br><h4>  Módulo de video vigilancia </h4><br><ul><li>  Frambuesa pi zero </li><li>  USB WiFi Dongle </li><li>  Cámara Raspberry pi v1.3 </li><li>  2 motores paso a paso 28BYJ-48 + ULN2003 driver </li></ul><br><h4>  Plataforma móvil gestionada a través de SPI desde frambuesas </h4><br><ul><li>  4S 16x18650 Li-ion + 4S 30A Li-ion 18650 (BMS) placa + carga DC-DC con estabilización de corriente y voltaje </li><li>  convertidor reductor dc-dc (15v -&gt; 5v). </li><li>  placa stm32f103c8t6 </li><li>  4 motores de engranajes + placa L298N </li><li>  Lámpara LED de 12 v (faro) + control en IRF3205 (+ smd pnp y npn) </li></ul><br>  La imagen Raspbian se ha configurado en modo de solo lectura.  En tal configuración, las frambuesas sobreviven fácilmente a apagados inesperados porque no usan tarjetas SD para grabar en absoluto. <br><br><h1>  Software </h1><br>  El software consta de 3 componentes separados. <br><h4>  Aplicación de Android (probada en LG6 Oreo y Samsung S5 Lollipop) </h4><br>  <b>Modo FPV</b> <br><br><ul><li>  Muestra la transmisión de video H.264 de la cámara en la resolución y velocidad de bits especificadas </li><li>  Controles de cámara y plataforma. </li><li>  Graba videos y fotos de la transmisión. </li></ul><br>  <b>Modo de servicio de Android</b> <br><br><ul><li>  Encuesta de host (con frecuencia especificada) </li><li>  Cargando foto del evento de "movimiento" en el cuadro por evento. </li></ul><br><h4>  Raspberry pi host en python (picamera + spidev + RPi.GPIO) </h4><br>  <b>Modo FPV</b> <br><br><ul><li>  Transmitir transmisión H.264 (con los parámetros especificados por la aplicación de Android) </li><li>  recepción de comandos de control para motores paso a paso y su gestión. </li><li>  Transmitir comandos de control mediante SPI (si el modo está habilitado) </li></ul><br>  <b>Modo de seguimiento de movimiento en el cuadro.</b> <br><br><ul><li>  Detección de movimiento en el marco (de acuerdo con los parámetros especificados por la aplicación de Android) </li><li>  Recepción de solicitudes "y si hay movimiento en el marco" y subir fotos a pedido </li><li>  Envío al host (independientemente de la aplicación) foto de movimientos en el marco. </li></ul><br>  <b>El firmware más simple en stm32f103</b> <br><br><ul><li>  Recibir comandos SPI </li><li>  Controle la dirección de rotación de las ruedas y los motores PWM. </li><li>  Control de faros. </li></ul><br><h1>  Seguimiento de movimiento </h1><br>  El seguimiento de los vectores h.264 resultó ser muy malhumorado y propenso a falsos positivos.  Hay muy pocas implementaciones de detección de movimiento para H.264 en la red.  Los probé todos. <br><br>  La opción más primitiva es contar el número de vectores cuya longitud excede un cierto valor umbral.  Y si algún vector es mayor que el umbral, entonces esta es una señal de que hay movimiento en el marco. <br><br>  Por desgracia  Esta opción solo es adecuada para demostrar el principio.  Hay demasiados falsos positivos.  Especialmente en superficies de color y textura uniformes. <br><br>  Todas las demás opciones dan demasiados falsos positivos o simplemente no cumplen con el criterio de rendimiento: "deben procesarse dentro del tiempo de trama". <br><br>  Como resultado, elegí mi opción.  Aunque prácticamente no da falsos positivos, requiere movimiento en varios cuadros seguidos.  Pero es mejor así que falsas alarmas varias veces al día debido a cambios en la iluminación o en general debido a "movimientos" incomprensibles en el marco por la "decisión" de la cámara.  El tema de los algoritmos de detección confiables para mv H.264 es generalmente un tema separado y complejo.  Los algoritmos requieren mucho tiempo para la depuración práctica y tengo límites estrictos en tiempo de ejecución. <br><br>  Ejemplo de vectores de movimiento (modos de utilidad de instantánea): <br><br><img src="https://habrastorage.org/webt/ga/14/gv/ga14gvgp-rljxqu7-0cdrrhdvvw.jpeg"><br><br><img src="https://habrastorage.org/webt/ya/yz/sv/yayzsvkjptyuqafxeg3aevdyfhq.jpeg"><br><br>  En los eventos "movimiento en el marco", se generan notificaciones. <br><br><img src="https://habrastorage.org/webt/7w/of/kf/7wofkfeel3yhp6k-vt4m7sw51pg.jpeg"><br><br>  en principio, para mis propósitos, resultó bastante seguro que se disparara cuando una figura humana (&gt; 15% del cuadro) se mueve durante al menos 2 segundos.  Con tal grosor de sensibilidad, simplemente no vi falsos positivos en absoluto. <br><br><h3>  Control de movimiento. </h3><br>  Gestión de la plataforma "por tractor".  Es decir  Control PWM y dirección de rotación del lado izquierdo y derecho.  Elementos de control (tiras) debajo de los pulgares de ambas manos.  Resultó ser lo más natural para mí. <br><br><img src="https://habrastorage.org/webt/bk/qk/fn/bkqkfn7r2qda8cgikzkcw7a8vae.jpeg"><br><br>  Control de la cámara: dos tiras que se tocan dan la orden de girar un cierto ángulo (cuanto más lejos del centro de la tira, mayor es el ángulo).  El control continuo de los motores fue incómodo (nuevamente subjetivo para mí). <br><br><img src="https://habrastorage.org/webt/_g/jw/bs/_gjwbsyivgtnnknnbohpoexfgqs.jpeg"><br><br><h3>  Lags FPV </h3><br>  Los retrasos de video fueron relativamente pequeños (&lt;1 seg). <br><br>  Para controlar una plataforma con ruedas con una velocidad máxima de 3-4 km / h para un retraso de 100% PWM en 0.6 segundos, esto es bastante normal y casi no se nota. <br><br>  Sin embargo, me parece que incluso 0.3 segundos de retraso para, por ejemplo, un quadrocopter es mucho. <br><br>  Las pruebas han demostrado que la implementación de la traducción en Python genera entre 50 y 70 ms de retraso, en comparación con la emisión de la misma transmisión H.264 a través de Rapivid.  Para mí, estos 70ms no son importantes.  Pero si alguien quiere exprimir al máximo, entonces debe tener esto en cuenta. <br><br>  Cuando se trabaja a través de "WiFi local" (el teléfono como punto de acceso), el retraso es de 350..600 ms.  Pero no más de 0.6 segundos y estable en este rango.  Aunque, 50-70 metros en áreas abiertas, esto es solo para jugar.  Y a una distancia mayor, el WiFi del teléfono no funciona. <br>  Vale la pena señalar que esto se encuentra en un entorno muy "RF ruidoso" de edificios de apartamentos, con muchas redes WiFi en el área. <br><br><img src="https://habrastorage.org/webt/zw/bx/-y/zwbx-yzkmwqb0r8p2flbur5u__o.jpeg"><br><br>  Me sorprendió el resultado en la configuración "Enrutador WiFi -&gt; proveedor de par trenzado -&gt; VPS -&gt; MTC 4G en el teléfono" a través del reenvío de puerto ssh de frambuesas a VPS. <br>  Un retraso típico resultó ser incluso un poco mejor que a través de WiFi local (!) <br>  Incluso en el camino en un automóvil o cerca de un gran hipermercado de retraso es de solo 300 ms. <br><br>  Sin embargo, a veces (muy raramente e impredeciblemente), el retraso se convirtió en varios segundos.  Recontext ayuda.  Probablemente, estas son algunas características de 4G / MTS / proveedores en la cadena, etc. <br><br><img src="https://habrastorage.org/webt/qm/bb/2v/qmbb2vsylq_qlv66rlpfz2x_d2e.jpeg"><br><br>  Después de que todo funcionó, hubo un deseo de conectar el canal de sonido en ambas direcciones.  Técnicamente, esto es posible y ni siquiera muy difícil.  Pero ya no quiero meterme con un soldador. <br><br>  Si no fuera por el Rasberry pi "extra", sería más fácil usar el teléfono antiguo como host para la videovigilancia y la gestión de la plataforma.  La única ventaja de las frambuesas sobre un teléfono antiguo es menos peso.  Y, tal vez, menos consumo de energía (no se compara). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><b>Todas las fuentes</b></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es424191/">https://habr.com/ru/post/es424191/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es424175/index.html">Eventos digitales en Moscú del 24 al 30 de septiembre.</a></li>
<li><a href="../es424177/index.html">Conexión de la puerta de enlace FXO Grandstream GXW4104 a 3CX</a></li>
<li><a href="../es424183/index.html">4 de octubre, Moscú - Backend Stories 2.0</a></li>
<li><a href="../es424187/index.html">Conferencia DEFCON 22. Adrian Crenshaw. ¿Qué pueden "quemar" los usuarios de TOR?</a></li>
<li><a href="../es424189/index.html">Casa inteligente? ¿O no inteligente?</a></li>
<li><a href="../es424193/index.html">Congreso Internacional de Astronáutica, como lo fue en Australia</a></li>
<li><a href="../es424197/index.html">En el horno de MVP, implementamos MVPr (prototipo mínimo viable)</a></li>
<li><a href="../es424199/index.html">Construyendo un simple servidor GraphQL API en express y nodeJS</a></li>
<li><a href="../es424201/index.html">Cómo el aprendizaje automático me ha ayudado a comprender algunos aspectos del desarrollo de la primera infancia</a></li>
<li><a href="../es424203/index.html">Creación de edificios procesales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>