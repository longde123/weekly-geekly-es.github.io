<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤙🏼 👨🏿‍🏫 🎤 Optimalisasi kueri PostgreSQL paksa 👃🏿 💖 🧓🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apa yang harus dilakukan ketika ada aplikasi sumber tertutup yang tidak mengakses database secara optimal? Bagaimana cara menyetel kueri tanpa menguba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Optimalisasi kueri PostgreSQL paksa</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432944/"> Apa yang harus dilakukan ketika ada aplikasi sumber tertutup yang tidak mengakses database secara optimal?  Bagaimana cara menyetel kueri tanpa mengubah aplikasi, dan mungkin database itu sendiri? <br><br>  Jika Anda belum mengajukan pertanyaan seperti itu, Anda adalah DBA yang sangat sukses dan teliti. <br><br>  Nah, jika ditanya, izinkan saya berbagi penderitaan dan pengalaman. <br><a name="habracut"></a><br><h3>  Perlu menyimpan lebih banyak data, atau mengatur tugas </h3><br>  Anda dapat dengan aman menggulir bagian ini jika riwayat masalah tidak menarik. <br><br>  Awalnya, kami memiliki sistem berpemilik yang mem-parsing datanya dari format tertutup ke dalam database PostgreSQL, tempat kami membaca, menganalisis, dan memproses data ini. <br><br>  Selain itu, alat-alat sistem ini juga menggunakan basis ini untuk operasi tertentu, sehingga untuk meninggalkannya dan membuat salinan dengan strukturnya sepertinya ide yang sia-sia. <br><br>  Secara default, sistem secara otomatis menghapus catatan yang lebih lama dari satu minggu, jadi tidak ada masalah kinerja di stand. <br><br>  Namun, kita perlu menyimpan data lebih lama, selama ada cukup ruang pada disk server.  Yah, sangat disarankan untuk tidak kehilangan akses ke data ini dan masih menggunakan alat built-in dari sistem, bahkan untuk data lama. <br><br>  Oleh karena itu, keputusan yang jelas adalah membuat partisi dan pemicu pada operasi INSERT.  Fokusnya cukup sederhana dan efektif.  Data dimasukkan ke dalam partisi yang diperlukan, penghapusan catatan lama dinonaktifkan, semuanya tampak baik-baik saja. <br><br>  Sampai beberapa tahun telah berlalu dan data belum terakumulasi dengan baik. <br><br>  Di sini, "tiba-tiba" ternyata permintaan yang dibuat oleh toolkit dari sistem yang digunakan tidak membatasi pemilihan berdasarkan tanggal (atau lebih tepatnya, membatasi tidak ke bidang yang sesuai dengan partisi dilakukan).  Yaitu  jika kita mencari sesuatu - pencarian berjalan di semua partisi.  Operasi UPDATE juga mulai melambat - dalam kondisi hanya ada ID-shnik yang digunakan. <br><br>  Akibatnya, permintaan dieksekusi untuk waktu yang lama, menarik semua permintaan lainnya, beban tumbuh dengan cepat. <br><br>  Tentu saja, hal pertama yang terlintas dalam pikiran adalah menghubungi pengembang. <br><br>  Namun, dalam banyak kasus tidak lagi berada di zona akses, atau akan meminta biaya sistem lain untuk penyelesaian dalam beberapa jalur. <br><br>  Karena itu, muncul ide bahwa mungkin sudah ada semacam proxy yang dapat membantu kita. <br><br><h3>  Kami membutuhkan proxy </h3><br>  Googling cepat tidak menemukan jawaban yang jelas untuk pertanyaan tentang bagaimana menulis ulang kueri masuk di sisi PostgreSQL atau beberapa perangkat lunak pihak ketiga. <br><br>  Oleh karena itu (well, hanya untuk bersenang-senang juga, tentu saja) perangkat lunak yang cukup sederhana ditulis yang menerima koneksi dari klien dan proksi mereka di PostgreSQL.  Pada saat yang sama, kueri SQL yang masuk dibaca, dan, jika perlu, diganti. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Berbagi tautan ke github</a> <br><br>  Meskipun saya tidak membuat paket biner, tangan saya tidak dapat menjangkau.  Namun perakitannya cukup sederhana.  Semuanya ditulis dalam C ++ / Qt, karena  Saya sudah menulis ini sejak lama ... <br><br>  Konfigurasi ini cukup sederhana: <br><br>  Tentukan antarmuka dan port mana yang ingin didengarkan: <br><br><pre><code class="plaintext hljs">listen_address=0.0.0.0 listen_port=5433</code> </pre> <br>  Kami memaksa perangkat lunak yang lalai untuk terhubung ke alamat yang ditentukan alih-alih langsung terhubung ke server PostgreSQL. <br><br>  Kami menuliskan tempat untuk meneruskan koneksi (dalam contoh ini, proksi terletak pada mesin yang sama dengan server PostgreSQL): <br><br><pre> <code class="plaintext hljs">dst_address=127.0.0.1 dst_port=5432</code> </pre> <br>  Kami menetapkan ekspresi reguler untuk menangkap permintaan yang diinginkan: <br><br><pre> <code class="plaintext hljs">query = SELECT \* FROM tablename WHERE (.+)</code> </pre> <br>  Kami mengatakan bahwa kami perlu menulis ulang: <br><br><pre> <code class="plaintext hljs">action = rewrite</code> </pre> <br>  Kami mengatakan bagaimana menulis ulang: <br><br><pre> <code class="plaintext hljs">rewrite = SELECT * FROM tablename WHERE (col3 &gt;= '$(now-1M)') AND $(1)</code> </pre> <br>  Dalam contoh ini, kami menambahkan filter ke kondisi kueri oleh kolom dengan tanggal, yang menunjukkan bahwa kami hanya tertarik pada catatan untuk bulan lalu. <br><br>  Orang bisa menulis seperti ini: <br><br><pre> <code class="plaintext hljs">rewrite = SELECT * FROM tablename WHERE (col3 &gt;= now() - interval '1 month') AND $(1)</code> </pre> <br>  Tetapi kemudian permintaan tersebut tidak akan optimal karena kehadiran fungsi now () - pencarian akan tetap dilakukan pada semua partisi.  Untuk mencari hanya di yang diperlukan, Anda harus menentukan nilai konstan.  Karenanya, proksi kami mengganti timestamp dengan pergeseran satu bulan alih-alih konstruk $ (sekarang-1M). <br><br>  Hasil (dari log): <br><br><pre> <code class="plaintext hljs">ORIGINAL query: SELECT * FROM tablename WHERE id=1; MODIFIED query (rule 1): SELECT * FROM tablename WHERE (col3 &gt;= '2018-11-12 11:25:23.0+00') AND id=1;</code> </pre> <br>  Jadi, pada dasarnya, mungkin untuk mengganti permintaan apa pun.  Respons dari server tidak berubah dan dikirim ke klien apa adanya.  Dengan cara ini, penundaan transmisi diminimalkan.  Selain itu, aplikasi biasanya menunggu respons dengan format tertentu, sehingga tidak diinginkan untuk mengubah kumpulan kolom dalam permintaan dan respons. <br><br>  Dimungkinkan juga untuk dengan mudah mencetak semua permintaan yang menarik ke log: <br><br><pre> <code class="plaintext hljs">query = .+ action = log</code> </pre> <br>  Repositori memiliki konfigurasi dengan contoh dan deskripsi yang lebih rinci. <br><br>  Omong-omong, mudah untuk menentukan seberapa baik pengembang menulis dengan benar untuk bekerja dengan database.  Misalnya, jika Anda melihat permintaan yang sering dieksekusi, maka sudah saatnya seseorang untuk merokok manual. <br><br><pre> <code class="plaintext hljs">INSERT INTO tablename (col1, col2, col3) VALUES('value1', 1, '2018-12-31')</code> </pre> <br>  Seharusnya seperti ini: <br><br><pre> <code class="plaintext hljs">INSERT INTO tablename (col1, col2, col3) VALUES($1::varchar, $2::integer, $3::date)</code> </pre> <br>  Sayangnya, sejauh ini proksi kami tidak dapat menulis dengan cara ini: / tapi ini tidak sulit dilakukan.  Mungkin di masa depan akan memungkinkan untuk menulis ulang permintaan pertama ke yang kedua. <br><br>  Ya, poin pentingnya adalah bahwa SSL belum didukung, sehingga semua koneksi dari klien ke proxy akan tanpa enkripsi. <br><br>  Saya akan senang memberikan komentar dan komentar. <br><br>  Jika ada minat aktif pengguna, mungkin saya akan mengembangkan proyek lebih lanjut. <br><br>  Anda dapat menambahkan pekerjaan dengan database lain. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id432944/">https://habr.com/ru/post/id432944/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id432932/index.html">Ekosistem dunia pengadaan digital (untuk mencuri lebih sedikit)</a></li>
<li><a href="../id432934/index.html">Pengangkatan levitasi dengan mudah di ultrasound</a></li>
<li><a href="../id432936/index.html">Webinar Group-IB "SOC yang didorong oleh intelijen dan apakah mungkin untuk melakukannya tanpanya?"</a></li>
<li><a href="../id432940/index.html">50 warna token</a></li>
<li><a href="../id432942/index.html">Pola corutin dan antipatterns di Kotlin</a></li>
<li><a href="../id432946/index.html">Unity - Jebakan Pengembangan Game 2D</a></li>
<li><a href="../id432948/index.html">Cloud pintar, perusahaan pintar: bagaimana AI mengubah industri komputasi awan</a></li>
<li><a href="../id432954/index.html">Dan lagi ke luar angkasa: bagaimana unicorn Stellarium dikunjungi</a></li>
<li><a href="../id432956/index.html">Monster dari Id: bagaimana Doom dibuat</a></li>
<li><a href="../id432958/index.html">Paradoks kuantum baru mengklarifikasi bahwa ide-ide kita tentang kenyataan ternyata salah</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>