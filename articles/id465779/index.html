<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😷 🙎🏻 🚚 Yealink T19 Penyediaan otomatis + Buku Alamat Dinamis 🚜 🤞 💆🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ketika saya mulai bekerja di perusahaan ini, saya sudah memiliki beberapa basis pada perangkat ip, beberapa server dengan asterisk dan splash dalam be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Yealink T19 Penyediaan otomatis + Buku Alamat Dinamis</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465779/">  Ketika saya mulai bekerja di perusahaan ini, saya sudah memiliki beberapa basis pada perangkat ip, beberapa server dengan asterisk dan splash dalam bentuk FreeBPX.  Selain itu, pertukaran telepon analog Samsung IDCS500 bekerja secara paralel dan, secara umum, adalah sistem komunikasi utama di perusahaan, ip telephony hanya bekerja untuk bagian penjualan.  Dan semuanya akan mendidih berulang kali, tetapi suatu hari suatu keputusan diberikan untuk mentransfer semua orang ke telepon IP, tanggal disepakati, peralatan dibeli dan rencana untuk memindahkan perusahaan ke abad ke-21 mulai dilaksanakan. <br>  Hal pertama yang mulai mengganggu dalam situasi ini adalah meningkatnya jumlah telepon yang perlu dikelola, dan hal kedua yang sangat mengkhawatirkan adalah buku telepon.  Jika Endpoint Manager (yang, kebetulan, dikeluarkan dari versi terbaru FreePBX) dapat membantu kami dengan yang pertama, maka berikut adalah beberapa pertanyaan dengan buku: <br><br><ul><li>  Pertama, bagaimana memastikan keakuratannya dengan perubahan terus-menerus dari perpindahan / pergantian pengguna? </li><li>  Kedua, bagaimana cara sepenuhnya menghilangkan identitas ponsel.  Dan jangan mengisi nama kontak setiap saat? </li></ul><br>  Tugas itu menarik, solusinya tidak lama datang.  Sekarang saya akan memberikan daftar lengkap, dan kemudian kami akan menganalisis secara berurutan. <br><a name="habracut"></a><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scapy.all <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sniff <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scapy.layers.inet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> IP <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mysql.connector <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ldap <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> getpass <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tftpy <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> string <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> replace <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn_ldap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(login)</span></span></span><span class="hljs-function">:</span></span> ad = ldap.initialize(<span class="hljs-string"><span class="hljs-string">'ldap://***.local'</span></span>) ad.simple_bind_s(<span class="hljs-string"><span class="hljs-string">'voip@***.local'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>) basedn = <span class="hljs-string"><span class="hljs-string">'OU=IT,DC=***,DC=LOCAL'</span></span> basedn_user = <span class="hljs-string"><span class="hljs-string">'OU=***,OU=***,DC=***,DC=LOCAL'</span></span> scope = ldap.SCOPE_SUBTREE filterexp = <span class="hljs-string"><span class="hljs-string">"(&amp;(sAMAccountName="</span></span> + login + <span class="hljs-string"><span class="hljs-string">")(ObjectClass=person))"</span></span> filterexp2 = <span class="hljs-string"><span class="hljs-string">"(&amp;(ObjectClass=organizationUnit))"</span></span> attrlist = [<span class="hljs-string"><span class="hljs-string">'cn'</span></span>] attrlist2 = [<span class="hljs-string"><span class="hljs-string">'OU'</span></span>] search = ad.search_s(basedn, scope, filterexp, attrlist) adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adname == <span class="hljs-string"><span class="hljs-string">' '</span></span>: search = ad.search_s(basedn_user, scope, filterexp2, attrlist2) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(search)+<span class="hljs-number"><span class="hljs-number">1</span></span>): group = search[i][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'ou'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] basedn_user2 = <span class="hljs-string"><span class="hljs-string">'OU='</span></span>+group+<span class="hljs-string"><span class="hljs-string">','</span></span>+basedn_user search = ad.search_s(basedn_user2, scope, filterexp, attrlist) adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adname != <span class="hljs-string"><span class="hljs-string">' '</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adname adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) ad.unbind_s() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adname <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tftp_file_change</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config,place,adname,current_account,current_account_password)</span></span></span><span class="hljs-function">:</span></span> client = tftpy.TftpClient(<span class="hljs-string"><span class="hljs-string">"192.168.0.3"</span></span>, <span class="hljs-number"><span class="hljs-number">69</span></span>) client.download(<span class="hljs-string"><span class="hljs-string">'template.cfg'</span></span>, place) fileread = open(place, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) line = fileread.readlines() fileread.close() line[<span class="hljs-number"><span class="hljs-number">5</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.label = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + adname.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) line[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.auth_name = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) line[<span class="hljs-number"><span class="hljs-number">3</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.display_name = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) line[<span class="hljs-number"><span class="hljs-number">6</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.password = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account_password[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) filewrite = open(place, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> line: filewrite.write(i) filewrite.close() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> place <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> config client.upload(config,place) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_phone_inform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ipaddr)</span></span></span><span class="hljs-function">:</span></span> fileconf = requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/servlet?phonecfg=get[&amp;accounts=1]'</span></span>) conf = fileconf.text.split(<span class="hljs-string"><span class="hljs-string">'|'</span></span>) current_account = conf[<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current_account <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sniff_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> pcapf = sniff(count=<span class="hljs-number"><span class="hljs-number">1</span></span>, timeout=<span class="hljs-number"><span class="hljs-number">70</span></span>, filter=<span class="hljs-string"><span class="hljs-string">"dst host 192.168.0.3 and port 5060"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(pcapf) == <span class="hljs-number"><span class="hljs-number">0</span></span>: exit() frame = pcapf[<span class="hljs-number"><span class="hljs-number">0</span></span>] macaddr = frame.src <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> macaddr[:<span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> macaddr[:<span class="hljs-number"><span class="hljs-number">8</span></span>] != <span class="hljs-string"><span class="hljs-string">'80:5e:c0'</span></span>: exit() ipaddr = frame[<span class="hljs-number"><span class="hljs-number">0</span></span>][IP].src <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> macaddr, ipaddr <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn_mysql</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query,fquery,macaddr,qwery2)</span></span></span><span class="hljs-function">:</span></span> connect = mysql.connector.connect(host=<span class="hljs-string"><span class="hljs-string">'192.168.0.3'</span></span>, database=<span class="hljs-string"><span class="hljs-string">'voip'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'voip_wr'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'***'</span></span>) cursor = connect.cursor() cursor.execute(fquery) state = cursor.fetchall() state = bool(state[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: cursor.execute(qwery2) connect.commit() connect.close() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: cursor.execute(query) connect.commit() connect.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_account</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(current_account)</span></span></span><span class="hljs-function">:</span></span> connect = mysql.connector.connect(host=<span class="hljs-string"><span class="hljs-string">'192.168.0.3'</span></span>, database=<span class="hljs-string"><span class="hljs-string">'asterisk'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'voip_wr'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'***'</span></span>) cursor = connect.cursor() qwery = <span class="hljs-string"><span class="hljs-string">'select data from sip where id='</span></span> + current_account + <span class="hljs-string"><span class="hljs-string">' and keyword="secret";'</span></span> cursor.execute(qwery) password = cursor.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> password == <span class="hljs-string"><span class="hljs-string">' '</span></span>: exit() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: macaddr, ipaddr = sniff_frame() current_account = get_phone_inform(ipaddr) current_account_password = check_account(current_account) macaddr = macaddr.replace(<span class="hljs-string"><span class="hljs-string">':'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) ipaddr = ipaddr.decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) adname = conn_ldap(getpass.getuser()) query = <span class="hljs-string"><span class="hljs-string">'INSERT INTO station (mac, ip, name, number) VALUES ('</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + macaddr + <span class="hljs-string"><span class="hljs-string">'",'</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + ipaddr + <span class="hljs-string"><span class="hljs-string">'",'</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + adname + <span class="hljs-string"><span class="hljs-string">'",'</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + get_phone_inform(ipaddr) + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + <span class="hljs-string"><span class="hljs-string">')'</span></span> qwery2 = <span class="hljs-string"><span class="hljs-string">'UPDATE station SET ip='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + ipaddr + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + <span class="hljs-string"><span class="hljs-string">', name='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + adname + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + <span class="hljs-string"><span class="hljs-string">', number='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + get_phone_inform(ipaddr) + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + <span class="hljs-string"><span class="hljs-string">' WHERE mac='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + macaddr + <span class="hljs-string"><span class="hljs-string">'"'</span></span> fquery = <span class="hljs-string"><span class="hljs-string">'SELECT EXISTS(SELECT mac FROM voip.station WHERE mac='</span></span> + <span class="hljs-string"><span class="hljs-string">'"'</span></span> + macaddr + <span class="hljs-string"><span class="hljs-string">'")'</span></span> query = query.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) fquery = fquery.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) config = macaddr + <span class="hljs-string"><span class="hljs-string">'.cfg'</span></span> place = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">"~"</span></span>) + <span class="hljs-string"><span class="hljs-string">"\\"</span></span> + <span class="hljs-string"><span class="hljs-string">"AppData\\Local\\"</span></span> + config conn_mysql(query,fquery,macaddr,qwery2) tftp_file_change(config,place,adname,current_account,current_account_password) requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/cgi-bin/ConfigManApp.com?key=AutoP'</span></span>) requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/cgi-bin/ConfigManApp.com?key=Reboot'</span></span>)</code> </pre> <br>  Program ini berjalan pada komputer pengguna dan bekerja di bawah kondisi bahwa komputer terhubung ke jaringan melalui telepon, karena Yealink T19 tidak dapat berfungsi sebagai gateway. <br><br>  Pertama kita perlu memahami apakah itu terhubung?  dan mac dan ip mana yang memiliki telepon kita. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sniff_frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> pcapf = sniff(count=<span class="hljs-number"><span class="hljs-number">1</span></span>, timeout=<span class="hljs-number"><span class="hljs-number">70</span></span>, filter=<span class="hljs-string"><span class="hljs-string">"dst host 192.168.0.3 and port 5060"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(pcapf) == <span class="hljs-number"><span class="hljs-number">0</span></span>: exit() frame = pcapf[<span class="hljs-number"><span class="hljs-number">0</span></span>] macaddr = frame.src <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> macaddr[:<span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> macaddr[:<span class="hljs-number"><span class="hljs-number">8</span></span>] != <span class="hljs-string"><span class="hljs-string">'80:5e:c0'</span></span>: exit() ipaddr = frame[<span class="hljs-number"><span class="hljs-number">0</span></span>][IP].src <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> macaddr, ipaddr</code> </pre><br>  Di sini kita menggunakan fungsi sniff dari kerangka scapy, dengan menggunakannya kita mendapatkan paket udp yang telah ditentukan, tunggu 70 detik dan jika kita tidak menangkap apa-apa, keluar. <br><br><pre> <code class="python hljs">count=<span class="hljs-number"><span class="hljs-number">1</span></span>, timeout=<span class="hljs-number"><span class="hljs-number">70</span></span>, filter=<span class="hljs-string"><span class="hljs-string">"dst host 192.168.0.3 and port 5060"</span></span></code> </pre> <br>  Selanjutnya, kami memastikan bahwa perangkat tersebut benar-benar Yealink dan mengembalikan nilai yang diperlukan (ip dan mac). <br><br>  Dengan menggunakan permintaan khusus, kami mengetahui akun saat ini di telepon.  Untuk melakukan ini, konfigurasi saat ini diunduh dari ponsel dan diuraikan. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_phone_inform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ipaddr)</span></span></span><span class="hljs-function">:</span></span> fileconf = requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/servlet?phonecfg=get[&amp;accounts=1]'</span></span>) conf = fileconf.text.split(<span class="hljs-string"><span class="hljs-string">'|'</span></span>) current_account = conf[<span class="hljs-number"><span class="hljs-number">2</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current_account</code> </pre> <br>  Kami mengetahui kata sandi untuk akun ini.  Untuk melakukan ini, kita beralih ke tabel asterisk.sip dan di dalamnya ke bidang data. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_account</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(current_account)</span></span></span><span class="hljs-function">:</span></span> connect = mysql.connector.connect(host=<span class="hljs-string"><span class="hljs-string">'192.168.0.3'</span></span>, database=<span class="hljs-string"><span class="hljs-string">'asterisk'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'voip_wr'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'***'</span></span>) cursor = connect.cursor() qwery = <span class="hljs-string"><span class="hljs-string">'select data from sip where id='</span></span> + current_account + <span class="hljs-string"><span class="hljs-string">' and keyword="secret";'</span></span> cursor.execute(qwery) password = cursor.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> password == <span class="hljs-string"><span class="hljs-string">' '</span></span>: exit() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> password</code> </pre> <br>  Nah, untuk tahap terakhir, kita terhubung ke ldap AD dan menggunakan sAMAccountName yang diperoleh melalui fungsi <i>getpass.getuser ()</i> untuk mengambil cn dari pengguna saat ini (yang biasanya berisi nama pengguna). <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn_ldap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(login)</span></span></span><span class="hljs-function">:</span></span> ad = ldap.initialize(<span class="hljs-string"><span class="hljs-string">'ldap://***.local'</span></span>) ad.simple_bind_s(<span class="hljs-string"><span class="hljs-string">'voip@***.local'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>) basedn = <span class="hljs-string"><span class="hljs-string">'OU=***,DC=***,DC=LOCAL'</span></span> basedn_user = <span class="hljs-string"><span class="hljs-string">'OU=***,OU=***,DC=***,DC=LOCAL'</span></span> scope = ldap.SCOPE_SUBTREE filterexp = <span class="hljs-string"><span class="hljs-string">"(&amp;(sAMAccountName="</span></span> + login + <span class="hljs-string"><span class="hljs-string">")(ObjectClass=person))"</span></span> filterexp2 = <span class="hljs-string"><span class="hljs-string">"(&amp;(ObjectClass=organizationUnit))"</span></span> attrlist = [<span class="hljs-string"><span class="hljs-string">'cn'</span></span>] attrlist2 = [<span class="hljs-string"><span class="hljs-string">'OU'</span></span>] search = ad.search_s(basedn, scope, filterexp, attrlist) adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adname == <span class="hljs-string"><span class="hljs-string">' '</span></span>: search = ad.search_s(basedn_user, scope, filterexp2, attrlist2) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">1</span></span>, len(search)+<span class="hljs-number"><span class="hljs-number">1</span></span>): group = search[i][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'ou'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] basedn_user2 = <span class="hljs-string"><span class="hljs-string">'OU='</span></span>+group+<span class="hljs-string"><span class="hljs-string">','</span></span>+basedn_user search = ad.search_s(basedn_user2, scope, filterexp, attrlist) adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> adname != <span class="hljs-string"><span class="hljs-string">' '</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adname adname = search[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'cn'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>].decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) ad.unbind_s() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adname</code> </pre> <br>  Kami terhubung ke tabel yang sebelumnya dibuat dalam database (saya membuatnya di tempat yang sama) dan menambahkan semua yang kami pelajari, yaitu: ip, mac, nama pengguna. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">conn_mysql</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query,fquery,macaddr,qwery2)</span></span></span><span class="hljs-function">:</span></span> connect = mysql.connector.connect(host=<span class="hljs-string"><span class="hljs-string">'192.168.0.3'</span></span>, database=<span class="hljs-string"><span class="hljs-string">'voip'</span></span>, user=<span class="hljs-string"><span class="hljs-string">'voip_wr'</span></span>, password=<span class="hljs-string"><span class="hljs-string">'***'</span></span>) cursor = connect.cursor() cursor.execute(fquery) state = cursor.fetchall() state = bool(state[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: cursor.execute(qwery2) connect.commit() connect.close() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: cursor.execute(query) connect.commit() connect.close()</code> </pre> <br>  Kita bisa berhenti pada ini, karena kami telah membuat buku alamat dinamis, Anda bertanya, tetapi saya melangkah lebih jauh dan mengacaukan perangkat autoprovisioning di sini. <br><br>  Untuk melakukan ini, konfigurasi templat diunduh dari server tftp yang sudah dikonfigurasi sebelumnya, ke dalamnya kami melakukan perubahan dan menyimpannya dengan mac.cfg.  Yaitu, untuk Yealink ada dua jenis konfigurasi, satu global, dan yang kedua diterapkan pada telepon tertentu dan harus dalam bentuk mac_phone.cfg <br><br>  Setelah semua perubahan dalam file dan menyimpannya kembali ke server tftp, kami memberikan perintah ke telepon untuk penyediaan dan reboot perangkat. <br><br><pre> <code class="pgsql hljs">def tftp_file_change(config,place,adname,current_account,current_account_password): client = tftpy.TftpClient("192.168.0.3", <span class="hljs-number"><span class="hljs-number">69</span></span>) client.download(<span class="hljs-string"><span class="hljs-string">'template.cfg'</span></span>, place) fileread = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(place, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-type"><span class="hljs-type">line</span></span> = fileread.readlines() fileread.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() <span class="hljs-type"><span class="hljs-type">line</span></span>[<span class="hljs-number"><span class="hljs-number">5</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.label = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + adname.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-type"><span class="hljs-type">line</span></span>[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.auth_name = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-type"><span class="hljs-type">line</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.display_name = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account.encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) <span class="hljs-type"><span class="hljs-type">line</span></span>[<span class="hljs-number"><span class="hljs-number">6</span></span>] = ((<span class="hljs-string"><span class="hljs-string">'account.1.password = '</span></span>).encode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) + current_account_password[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>] + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>) filewrite = <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(place, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span>: filewrite.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(i) filewrite.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>() print place print config client.upload(config,place)</code> </pre> <br><pre> <code class="python hljs">requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/cgi-bin/ConfigManApp.com?key=AutoP'</span></span>) requests.get(<span class="hljs-string"><span class="hljs-string">'http://admin:admin@'</span></span>+ipaddr+<span class="hljs-string"><span class="hljs-string">'/cgi-bin/ConfigManApp.com?key=Reboot'</span></span>)</code> </pre> <br>  Setelah me-reboot perangkat, kita mendapatkan nama lengkap di layar ponsel + selalu dengan benar mengisi buku alamat di hadapan basis data, maka kita hanya perlu mengacaukan XML dan sedikit PHP untuk menampilkan konten secara dinamis.  Ada banyak contoh seperti itu, bahkan YEALINK sendiri memilikinya. <br><br>  PS: Untuk skalabilitas yang lebih besar, Anda dapat memindahkan pengaturan utama (variabel) ke file terpisah. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id465779/">https://habr.com/ru/post/id465779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id465763/index.html">Presentasi Aplikasi Presentasi</a></li>
<li><a href="../id465765/index.html">Intisari materi menarik untuk pengembang seluler # 313 (26 Agustus - 1 September)</a></li>
<li><a href="../id465767/index.html">Pengalaman dan kesimpulan pribadi setelah berganti profesi dari perancang menjadi programmer</a></li>
<li><a href="../id465773/index.html">Memperbarui laptop dengan Windows 10 1903 - dari batu bata hingga hilangnya semua data. Mengapa pembaruan bisa lebih dari sekadar pengguna?</a></li>
<li><a href="../id465775/index.html">Server LTSP berdasarkan CentOS7</a></li>
<li><a href="../id465781/index.html">Bagaimana saya membuat pemecah Okhttp khusus melalui coroutine Kotlin</a></li>
<li><a href="../id465783/index.html">Game dev Rusia, tidak ada artinya dan tanpa ampun</a></li>
<li><a href="../id465787/index.html">Love the Goat</a></li>
<li><a href="../id465789/index.html">Pelatihan Cisco 200-125 CCNA v3.0. Hari 29. PAT dan NAT</a></li>
<li><a href="../id465791/index.html">Kerentanan pengecer - tiga kasus di mana OTP dapat diperoleh dalam permintaan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>