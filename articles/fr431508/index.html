<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêã üê∂ üö∏ Gestion efficace des transactions au printemps üò¢ üçÑ ü§òüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonne journ√©e √† tous! 

 Eh bien, la fin du mois est toujours intense, et il ne nous reste qu'un jour avant le d√©but du deuxi√®me volet du cours ¬´Devel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gestion efficace des transactions au printemps</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/431508/">  Bonne journ√©e √† tous! <br><br>  Eh bien, la fin du mois est toujours intense, et il ne nous reste qu'un jour avant le d√©but du deuxi√®me volet du cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Developer on Spring Framework¬ª</a> - un cours merveilleux et int√©ressant enseign√© par le tout aussi beau et en col√®re <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Yuri</a> (comme certains √©tudiants l'appellent pour le niveau d'exigences en DZ), regardons donc un autre mat√©riel que nous avons pr√©par√© pour vous. <br><br>  Allons-y. <br><br>  <b>Pr√©sentation</b> <br><br>  La plupart du temps, les d√©veloppeurs n'attachent pas d'importance √† la gestion des transactions.  En cons√©quence, soit la majeure partie du code doit √™tre r√©√©crite ult√©rieurement, soit le d√©veloppeur impl√©mente la gestion des transactions sans savoir comment cela devrait r√©ellement fonctionner ni quels aspects devraient √™tre utilis√©s sp√©cifiquement dans leur cas. <br><br>  Un aspect important de la gestion des transactions est de d√©terminer les limites correctes d'une transaction, quand une transaction doit commencer et quand se terminer, quand les donn√©es doivent √™tre ajout√©es √† la base de donn√©es et quand elles doivent √™tre pomp√©es (en cas d'exception). <br><br><img src="https://habrastorage.org/webt/qg/8n/mw/qg8nmwe4wvoqd2iuw3xv3ldpse0.png"><a name="habracut"></a><br><br>  L'aspect le plus important pour les d√©veloppeurs est de comprendre comment impl√©menter au mieux la gestion des transactions dans une application.  Examinons donc les diff√©rentes options. <br><br>  <b>M√©thodes de gestion des transactions</b> <br><br>  Les transactions peuvent √™tre g√©r√©es de la mani√®re suivante: <br><br>  <i><b>1. Contr√¥le du programme en √©crivant du code personnalis√©</b></i> <br><br>  Il s'agit d'une ancienne m√©thode de gestion des transactions. <br><br><pre><code class="java hljs">EntityManagerFactory factory = Persistence.createEntityManagerFactory(<span class="hljs-string"><span class="hljs-string">"PERSISTENCE_UNIT_NAME"</span></span>); EntityManager entityManager = entityManagerFactory.createEntityManager(); Transaction transaction = entityManager.getTransaction() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { transaction.begin(); someBusinessCode(); transaction.commit(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) { transaction.rollback(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ex; }</code> </pre> <br>  <b>Avantages</b> : <br><br><ul><li>  Les limites des transactions sont √©videntes dans le code. </li></ul><br>  <b>Inconv√©nients</b> : <br><br><ul><li>  Il est r√©p√©titif et sujet aux erreurs. </li><li>  Toute erreur peut avoir un tr√®s gros impact. </li><li>  Vous devez √©crire un grand nombre de mod√®les. Si vous souhaitez appeler une autre m√©thode √† partir de cette m√©thode, vous devez √† nouveau la contr√¥ler √† partir du code. </li></ul><br>  <i><b>2. Utilisation de Spring pour la gestion transactionnelle</b></i> <br><br>  Spring prend en charge deux types de gestion des transactions <br><br>  <b>1. Gestion des transactions logicielles</b> : vous devez g√©rer les transactions via la programmation.  Cette m√©thode est suffisamment flexible, mais difficile √† maintenir. <br><br>  <b>2. Gestion d√©clarative des transactions</b> : vous s√©parez la gestion des transactions de la logique m√©tier.  Vous utilisez uniquement des annotations dans la configuration bas√©e sur XML pour la gestion des transactions. <br><br>  <u><b>Nous vous recommandons fortement d'utiliser des transactions d√©claratives.</b></u>  <u><b>Si vous souhaitez conna√Ætre les raisons, poursuivez votre lecture, sinon acc√©dez directement √† la section Gestion d√©clarative des transactions si vous souhaitez impl√©menter cette option.</b></u> <br><br>  Examinons maintenant chaque approche en d√©tail. <br><br>  <i><b>2.1.</b></i>  <i><b>Gestion des transactions programmatiques:</b></i> <br><br>  Le framework Spring fournit deux outils pour la gestion des transactions programmatiques. <br><br>  a.  Utilisation de <code>TransactionTemplate</code> (recommand√© par l'√©quipe Spring): <br><br>  Voyons comment impl√©menter ce type √† l'aide de l'exemple de code ci-dessous (extrait de la documentation Spring avec quelques modifications) <br><br>  <u>Notez que les extraits de code sont extraits de Spring Docs.</u> <br><br>  Fichier Xml contextuel: <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Initialization for data source --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"driverClassName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.mysql.jdbc.Driver"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"url"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jdbc:mysql://localhost:3306/TEST"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"username"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"root"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Initialization for TransactionManager --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transactionManager"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Definition for ServiceImpl bean --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"serviceImpl"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.service.ServiceImpl"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">constructor-arg</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transactionManager"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Classe de <code>Service</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TransactionTemplate transactionTemplate; <span class="hljs-comment"><span class="hljs-comment">//       PlatformTransactionManager public ServiceImpl(PlatformTransactionManager transactionManager) { this.transactionTemplate = new TransactionTemplate(transactionManager); } //       ,   ,    //       xml  this.transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_UNCOMMITTED); this.transactionTemplate.setTimeout(30); //30  ///    public Object someServiceMethod() { return transactionTemplate.execute(new TransactionCallback() { //         public Object doInTransaction(TransactionStatus status) { updateOperation1(); return resultOfUpdateOperation2(); } }); }}</span></span></code> </pre><br>  S'il n'y a pas de valeur de retour, utilisez la classe <code>TransactionCallbackWithoutResult</code> pratique avec une classe anonyme, comme indiqu√© ci-dessous: <br><br><pre> <code class="java hljs">transactionTemplate.execute(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionCallbackWithoutResult() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInTransactionWithoutResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TransactionStatus status)</span></span></span><span class="hljs-function"> </span></span>{ updateOperation1(); updateOperation2(); } });</code> </pre><br><ul><li>  Les instances de la classe <code>TransactionTemplate</code> sont thread-safe, donc tous les √©tats de dialogue ne sont pas pris en charge. </li><li>  <code>TransactionTemplate</code> instances <code>TransactionTemplate</code> prennent n√©anmoins en charge l'√©tat de configuration, donc si une classe doit utiliser un TransactionTemplate avec des param√®tres diff√©rents (par exemple, un niveau d'isolement diff√©rent), vous devez cr√©er deux instances TransactionTemplate diff√©rentes, bien que certaines classes puissent utiliser la m√™me instance TransactionTemplate. </li></ul><br>  b.  Utilisation directe de l'impl√©mentation de <code>PlatformTransactionManager</code> : <br><br>  Examinons √† nouveau cette option dans le code. <br><br><pre> <code class="java hljs">&lt;!-- Initialization <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data source --&gt; &lt;bean id=<span class="hljs-string"><span class="hljs-string">"dataSource"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span></span>&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"driverClassName"</span></span> value=<span class="hljs-string"><span class="hljs-string">"com.mysql.jdbc.Driver"</span></span>/&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"url"</span></span> value=<span class="hljs-string"><span class="hljs-string">"jdbc:mysql://localhost:3306/TEST"</span></span>/&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"username"</span></span> value=<span class="hljs-string"><span class="hljs-string">"root"</span></span>/&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"password"</span></span> value=<span class="hljs-string"><span class="hljs-string">"password"</span></span>/&gt; &lt;/bean&gt; &lt;!-- Initialization <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> TransactionManager --&gt; &lt;bean id=<span class="hljs-string"><span class="hljs-string">"transactionManager"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span></span>&gt; &lt;property name=<span class="hljs-string"><span class="hljs-string">"dataSource"</span></span> ref=<span class="hljs-string"><span class="hljs-string">"dataSource"</span></span> /&gt; &lt;/bean&gt; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PlatformTransactionManager transactionManager; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTransactionManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( PlatformTransactionManager transactionManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.transactionManager = transactionManager; } DefaultTransactionDefinition def = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultTransactionDefinition(); <span class="hljs-comment"><span class="hljs-comment">//     -  ,       def.setName("SomeTxName"); def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED); TransactionStatus status = txManager.getTransaction(def); try { //   -  } catch (Exception ex) { txManager.rollback(status); throw ex; } txManager.commit(status); }</span></span></code> </pre> <br>  Maintenant, avant de passer √† la prochaine m√©thode de gestion des transactions, voyons comment d√©cider du type de gestion des transactions √† choisir. <br><br>  Choisir entre la <b>gestion des transactions</b> <b>programmatique</b> et <b>d√©clarative</b> : <br><br><ul><li>  La gestion des transactions par programme n'est un bon choix que si vous avez un petit nombre d'op√©rations transactionnelles.  (Dans la plupart des cas, ce ne sont pas des transactions.) </li><li>  Un nom de transaction ne peut √™tre d√©fini explicitement que dans la gestion des transactions du programme. </li><li>  La gestion des transactions par programmation doit √™tre utilis√©e lorsque vous souhaitez contr√¥ler explicitement la gestion des transactions. </li><li>  En revanche, si votre application contient de nombreuses op√©rations transactionnelles, cela vaut la peine d'utiliser la gestion d√©clarative. </li><li>  La gestion d√©clarative ne vous permet pas de g√©rer les transactions dans la logique m√©tier et n'est pas difficile √† configurer. </li></ul><br>  <i><b>2.2.</b></i>  <i><b>Transactions d√©claratives (g√©n√©ralement utilis√©es dans presque tous les sc√©narios d'une application Web)</b></i> <br><br>  <b>√âtape 1</b> : d√©finissez le gestionnaire de transactions dans le fichier xml contextuel de votre application Spring. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"txManager"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tx:annotation-driven</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">transaction-manager</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"txManager"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br>  <b>√âtape 2</b> : activez la prise en charge des annotations en ajoutant une entr√©e dans le fichier xml contextuel de votre application Spring. <br><br>  OU ajoutez <code>@EnableTransactionManagement</code> √† votre fichier de configuration, comme indiqu√© ci-dessous: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@EnableTransactionManagement</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppConfig</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br>  <i><b>Spring recommande d'annoter uniquement des classes sp√©cifiques (et des m√©thodes de classes sp√©cifiques) avec l'annotation <code>@Transactional</code> par rapport aux interfaces d'annotation.</b></i> <br><br>  La raison en est que vous placez l'annotation au niveau de l'interface, et si vous utilisez des classes proxy ( <code>proxy-target-class = ¬´true¬ª</code> ) ou l'aspect entrelac√© ( <code>mode = ¬´aspectj¬ª</code> ), alors les param√®tres de transaction ne sont pas reconnus par l'infrastructure proxy et les plexus, par exemple, le comportement transactionnel ne s'appliquera pas. <br><br>  <b>√âtape 3</b> : ajoutez l'annotation <b><code>@Transactional</code></b> √† la classe (m√©thode de classe) ou √† l'interface (m√©thode d'interface). <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tx:annotation-driven</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">proxy-target-class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Configuration par d√©faut: <code>proxy-target-class="false"</code> <br><br><ul><li>  <code>@Transactional</code> peut √™tre plac√©e avant une d√©finition d'interface, une m√©thode d'interface, une d√©finition de classe ou une m√©thode de classe publique. </li><li>  Si vous souhaitez que certaines m√©thodes de classe (marqu√©es d' <code>@Transactional</code> annotation <code>@Transactional</code> ) aient des param√®tres d'attribut diff√©rents, tels que le niveau d'isolement ou le niveau de propagation, placez l'annotation au niveau de la m√©thode pour remplacer les param√®tres d'attribut au niveau de la classe. </li><li>  En mode proxy (qui est d√©fini par d√©faut), seuls les appels de m√©thode ¬´externes¬ª passant par le proxy peuvent √™tre intercept√©s.  Cela signifie qu'un ¬´appel ind√©pendant¬ª, par exemple, une m√©thode dans la cible qui appelle une autre m√©thode de la cible, ne conduira pas √† une transaction r√©elle au moment de l'ex√©cution m√™me si la m√©thode appel√©e est √©tiquet√©e avec <code>@Transactional</code> . </li></ul><br>  Voyons maintenant <code>@Transactional</code> diff√©rence entre les <code>@Transactional</code> annotation <code>@Transactional</code> <br><br> <b><code>@Transactional (isolation=Isolation.READ_COMMITTED)</code></b> <br> <br><ul><li>  La valeur par d√©faut est <code>Isolation.DEFAULT</code> </li><li>  Dans la plupart des cas, vous utiliserez les param√®tres par d√©faut jusqu'√† ce que vous ayez des exigences particuli√®res. </li><li>  Indique au gestionnaire de transactions ( <code>tx</code> ) que le prochain niveau d'isolement doit √™tre utilis√© pour le <code>tx</code> actuel.  Il doit √™tre install√© au point de d√©part de <code>tx</code> , car nous ne pouvons pas modifier le niveau d'isolement apr√®s le d√©marrage de tx. </li></ul><br>  <b>PAR D√âFAUT</b> : utilisez le niveau d'isolement par d√©faut dans la base de donn√©es de base. <br><br>  <b>READ_COMMITTED</b> (lecture de donn√©es fixes): constante indiquant qu'une lecture <b>incorrecte</b> a √©t√© emp√™ch√©e;  Une lecture non r√©p√©t√©e et une lecture fant√¥me peuvent se produire. <br><br>  <b>READ_UNCOMMITTED</b> (lire les donn√©es non valid√©es): ce niveau d'isolement indique qu'une transaction peut lire des donn√©es qui n'ont pas encore √©t√© supprim√©es par d'autres transactions. <br><br>  <b>REPEATABLE_READ</b> (lecture r√©p√©tabilit√©): une constante indiquant que la lecture sale et la lecture non r√©p√©table sont emp√™ch√©es;  une lecture fant√¥me peut appara√Ætre. <br><br>  <b>S√âRIALISABLE</b> : permanent, indiquant que la lecture <b>incorrecte</b> , la lecture non r√©p√©table et la lecture fant√¥me sont interdites. <br><br>  Que signifient ces jargons: lecture ¬´sale¬ª, lecture fant√¥me ou lecture r√©p√©t√©e? <br><br><ul><li>  <b>Sale lecture</b> : la transaction A √©crit.  Pendant ce temps, la transaction ¬´B¬ª lit le m√™me enregistrement jusqu'√† ce que la transaction A soit termin√©e. Plus tard, la transaction A d√©cide d'annuler, et maintenant nous avons des modifications √† la transaction B qui sont incompatibles.  C'est une lecture sale.  La transaction B fonctionnait au niveau d'isolement READ_UNCOMMITTED, afin qu'elle puisse lire les modifications apport√©es par la transaction A avant la fin de la transaction. </li><li>  <b>Lecture non r√©p√©table</b> : la transaction ¬´A¬ª lit certains enregistrements.  La transaction ¬´B¬ª √©crit ensuite cet enregistrement et le valide.  Plus tard, la transaction A lit √† nouveau le m√™me enregistrement et peut recevoir des valeurs diff√©rentes, car la transaction B a apport√© des modifications √† cet enregistrement et les a valid√©es.  Il s'agit d'une lecture non r√©p√©titive. </li><li>  <b>Lecture fant√¥me</b> : la transaction ¬´A¬ª lit une s√©rie d'enregistrements.  Pendant ce temps, la transaction ¬´B¬ª ins√®re un nouvel enregistrement dans la m√™me ligne que la transaction A. Plus tard, la transaction A lit √† nouveau la m√™me plage et re√ßoit √©galement l'enregistrement que la transaction B vient d'ins√©rer. Il s'agit d'une lecture fant√¥me: la transaction a r√©cup√©r√© plusieurs fois une s√©rie d'enregistrements de la base de donn√©es et a re√ßu diff√©rents jeux de r√©sultats (contenant des enregistrements fant√¥mes). </li></ul><br> <code><b>@Transactional(timeout=60)</b></code> <br> <br>  La valeur par d√©faut est le d√©lai d'expiration par d√©faut pour le syst√®me de transaction sous-jacent. <br><br>  Informe le gestionnaire tx de la dur√©e d'attente avant que tx soit inactif avant de d√©cider d'annuler ou non les transactions qui ne r√©pondent pas. <br><br> <code><b>@Transactional(propagation=Propagation.REQUIRED)</b></code> <br> <br>  S'il n'est pas sp√©cifi√©, le comportement de propagation par d√©faut est <code>REQUIRED</code> . <br><br>  Les autres options sont <code>REQUIRES_NEW, MANDATORY, SUPPORTS, NOT_SUPPORTED, NEVER</code> et <code>NESTED</code> . <br><br>  <b>OBLIGATOIRE</b> <br><br>  Indique que la m√©thode cible ne peut pas fonctionner sans un tx actif.  Si tx est d√©j√† en cours d'ex√©cution avant d'appeler cette m√©thode, alors il continuera dans le m√™me tx, ou le nouveau tx commencera peu de temps apr√®s l'appel de cette m√©thode. <br><br>  <b>REQUIRES_NEW</b> <br><br><ul><li>  Indique qu'un nouveau tx doit √™tre ex√©cut√© √† chaque appel de la m√©thode cible.  Si tx est d√©j√† en cours d'ex√©cution, il sera mis en pause avant d'en d√©marrer un nouveau. </li></ul><br>  <b>Obligatoire</b> <br><br><ul><li>  Indique que la m√©thode cible n√©cessite un tx actif.  Si tx ne continue pas, il n'√©chouera pas, lan√ßant une exception. </li></ul><br>  <b>SUPPORTS</b> <br><br><ul><li>  Indique que la m√©thode cible peut √™tre ex√©cut√©e ind√©pendamment de tx.  Si tx fonctionne, il participera au m√™me tx.  S'il est ex√©cut√© sans tx, il sera toujours ex√©cut√© s'il n'y a pas d'erreur. </li></ul><br><ul><li>  Les m√©thodes qui r√©cup√®rent des donn√©es sont les meilleures candidates pour cette option. </li></ul><br>  <b>NOT_SUPPORTED</b> <br><br><ul><li>  Indique que la m√©thode cible ne n√©cessite pas de propagation de contexte de transaction. </li><li>  Fondamentalement, les m√©thodes qui sont ex√©cut√©es dans une transaction, mais qui effectuent des op√©rations avec de la RAM, sont les meilleures candidates pour cette option. </li></ul><br>  <b>Jamais</b> <br><br><ul><li>  Indique que la m√©thode cible l√®vera une exception si elle est ex√©cut√©e dans un processus transactionnel. </li><li>  Cette option n'est dans la plupart des cas pas utilis√©e dans les projets. </li></ul><br> <b><code>@Transactional (rollbackFor=Exception.class)</code></b> <br> <br>  Valeur par d√©faut: <code>rollbackFor=RunTimeException.class</code> <br><br>  Au printemps, toutes les classes d'API l√®vent une RuntimeException, ce qui signifie que si une m√©thode √©choue, le conteneur annule toujours la transaction en cours. <br><br>  Le probl√®me ne concerne que les exceptions v√©rifi√©es.  Ainsi, ce param√®tre peut √™tre utilis√© pour annuler de mani√®re d√©clarative une transaction si une <code>Checked Exception</code> se produit. <br><br> <code><b>@Transactional (noRollbackFor=IllegalStateException.class)</b></code> <br> <br>  Indique que la restauration ne doit pas se produire si la m√©thode cible d√©clenche cette exception. <br><br>  Maintenant, la derni√®re √©tape, mais la plus importante dans la gestion des transactions, consiste √† publier l'annotation <code>@Transactiona</code> l.  Dans la plupart des cas, une confusion survient l√† o√π l'annotation doit √™tre situ√©e: au niveau du service ou au niveau du DAO? <br><br>  <b><code>@Transactional</code> : niveau de service ou DAO?</b> <br><br>  Le service est le meilleur endroit pour placer <code>@Transactional</code> , le niveau de service doit contenir le comportement du cas d'utilisation au niveau de d√©tail pour l'interaction utilisateur, qui va logiquement dans la transaction. <br><br>  Il existe de nombreuses applications CRUD qui n'ont pas de logique m√©tier significative ayant un niveau de service qui transf√®re simplement les donn√©es entre les contr√¥leurs et les objets d'acc√®s aux donn√©es, ce qui n'est pas utile.  Dans ces cas, nous pouvons placer l'annotation de transaction au niveau DAO. <br><br>  Par cons√©quent, dans la pratique, vous pouvez les placer n'importe o√π, c'est √† vous. <br><br>  De plus, si vous mettez <code>@Transactional</code> dans la couche DAO et si votre couche DAO sera r√©utilis√©e par diff√©rents services, il sera difficile de la placer dans la couche DAO, car diff√©rents services peuvent avoir des exigences diff√©rentes. <br><br>  Si votre niveau de service r√©cup√®re des objets √† l'aide de Hibernate, et supposons que vous ayez des initialisations paresseuses dans la d√©finition d'un objet de domaine, vous devez ouvrir la transaction au niveau du service, sinon vous rencontrerez une LazyInitializationException lev√©e par ORM. <br><br>  Prenons un autre exemple o√π votre niveau de service peut appeler deux m√©thodes DAO diff√©rentes pour effectuer des op√©rations de base de donn√©es.  Si votre premi√®re op√©ration DAO a √©chou√©, les deux autres peuvent √™tre transf√©r√©es et vous mettrez fin √† l'√©tat incoh√©rent de la base de donn√©es.  L'annotation du niveau de service peut vous √©viter de telles situations. <br><br>  J'esp√®re que cet article vous a aid√©. <br><br>  LA FIN <br><br>  Il est toujours int√©ressant de voir vos commentaires ou questions. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431508/">https://habr.com/ru/post/fr431508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431498/index.html">WebP reprendra bient√¥t le Web, mais ce ne sera pas long</a></li>
<li><a href="../fr431500/index.html">Bases de donn√©es et Kubernetes (revue et rapport vid√©o)</a></li>
<li><a href="../fr431502/index.html">Conf√©rence pour les d√©veloppeurs iOS Kolesa Mobile 3.0. Reportage vid√©o</a></li>
<li><a href="../fr431504/index.html">Phishing - fonctionne. Chronique du vol de l'iPhone XS suivi du vol de donn√©es iCloud</a></li>
<li><a href="../fr431506/index.html">Xcode et d√©bogage avanc√© dans LLDB: Partie 1</a></li>
<li><a href="../fr431510/index.html">Comment collecter des informations sur le contour. Acheter avec du s√©l√©nium</a></li>
<li><a href="../fr431512/index.html">Une petite √©tude des propri√©t√©s d'un simple U-net, un r√©seau convolutionnel classique pour la segmentation</a></li>
<li><a href="../fr431514/index.html">Interview pour les enqu√™teurs</a></li>
<li><a href="../fr431516/index.html">Un jour dans la vie d'un conseiller financier</a></li>
<li><a href="../fr431518/index.html">Microsoft Connect (); Meetup √† Moscou</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>