<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëâüèø üè§ üë®‚Äç‚öïÔ∏è Membuat API REST dengan Node.js dan Oracle Database. Bagian 2 üë° üî™ üåπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bagian 2: Membuat API REST: Dasar-Dasar Database 
 Pada artikel pertama, Anda membuat server web, di sini Anda akan membuat modul yang bertanggung jaw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Membuat API REST dengan Node.js dan Oracle Database. Bagian 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473346/"><h4>  Bagian 2: Membuat API REST: Dasar-Dasar Database </h4><br>  Pada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel pertama,</a> Anda membuat server web, di sini Anda akan membuat modul yang bertanggung jawab untuk memulai dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mematikan</a> kumpulan koneksi database menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">node-oracledb</a> .  Dan tambahkan fitur yang menyederhanakan pelaksanaan pernyataan sederhana dengan secara otomatis mendapatkan dan melepaskan koneksi dari kumpulan. <br><a name="habracut"></a><br><h4>  Menjalankan pool koneksi </h4><br>  Karena node-oracledb dibangun di atas pustaka klien OCI, ia memiliki dukungan bawaan untuk membuat kumpulan OCI yang sisi-klien dan memiliki karakteristik kinerja yang sangat baik.  Untuk membuat kumpulan koneksi, mulailah dengan membuat file konfigurasi baru bernama <b>database.js</b> di direktori <b>config</b> .  Salin dan tempel kode berikut ke dalam file dan simpan perubahannya. <br><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">hrPool</span></span>: { <span class="hljs-attr"><span class="hljs-attr">user</span></span>: process.env.HR_USER, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: process.env.HR_PASSWORD, <span class="hljs-attr"><span class="hljs-attr">connectString</span></span>: process.env.HR_CONNECTIONSTRING, <span class="hljs-attr"><span class="hljs-attr">poolMin</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">poolMax</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">poolIncrement</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } };</code> </pre> <br>  Seperti file <b>config / webserver.js</b> , file ini memungkinkan Anda untuk mengatur beberapa properti menggunakan variabel lingkungan.  Menggunakan variabel lingkungan memberikan fleksibilitas ketika menggunakan aplikasi di lingkungan yang berbeda dan membantu untuk menyimpan kata sandi dan informasi sensitif lainnya di luar kode sumber.  Jalankan perintah berikut dari terminal untuk mengatur variabel lingkungan yang diperlukan dan pastikan bahwa mereka tersedia di sesi terminal mendatang. <br><br><pre> <code class="plaintext hljs">echo "export HR_USER=hr" &gt;&gt; ~/.bashrc echo "export HR_PASSWORD=oracle" &gt;&gt; ~/.bashrc echo "export HR_CONNECTIONSTRING=0.0.0.0/orcl" &gt;&gt; ~/.bashrc source ~/.bashrc</code> </pre> <br>  Anda mungkin memperhatikan bahwa poolMin dan poolMax sama dan poolIncrement ditetapkan ke 0. Ini akan membuat kolam ukuran tetap yang membutuhkan lebih sedikit sumber daya manajemen - ide bagus untuk kolam yang mendapatkan penggunaan yang konsisten. <br><br>  Meskipun Node.js sering digambarkan sebagai "single-threaded", ia memiliki kumpulan thread yang tersedia untuk operasi tertentu yang jika tidak akan memblokir utas utama yang menjalankan kode JavaScript.  Kumpulan utas ini digunakan oleh node-oracledb untuk melakukan semua operasi asinkronnya, seperti menerima koneksi dan mengeksekusi kode SQL dan PL / SQL.  Namun, ukuran kumpulan utas standar adalah 4. Jika Anda ingin semua 10 koneksi dalam kumpulan berfungsi secara bersamaan, Anda perlu menambah jumlah utas. <br><br>  Variabel lingkungan UV_THREADPOOL_SIZE dapat digunakan untuk menyesuaikan ukuran kumpulan utas.  UV_THREADPOOL_SIZE dapat diatur sebelum menjalankan aplikasi Node.js atau secara internal, tetapi harus diatur sebelum panggilan pertama dilakukan menggunakan kumpulan utas.  Ini karena fakta bahwa kumpulan thread dibuat pada penggunaan pertama dan setelah penciptaannya, ukurannya tetap.  Buka file <b>index.js</b> di root aplikasi dan tambahkan baris berikut setelah baris pertama (yang berisi modul server web). <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that requires services/web-server.js is here *** const dbConfig = require('./config/database.js'); const defaultThreadPoolSize = 4; // Increase thread pool size by poolMax process.env.UV_THREADPOOL_SIZE = dbConfig.hrPool.poolMax + defaultThreadPoolSize;</span></span></code> </pre> <br>  Sekarang setelah kumpulan thread memiliki ukuran yang sesuai, Anda dapat pergi ke modul database.  Buat file baru di direktori <b>layanan</b> bernama <b>database.js</b> .  Salin dan tempel kode berikut ke dalamnya dan simpan perubahannya. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> oracledb = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'oracledb'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dbConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config/database.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pool = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> oracledb.createPool(dbConfig.hrPool); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.initialize = initialize;</code> </pre> <br>  Modul ini pertama-tama memperkenalkan node-oracledb dan file konfigurasi.  Kemudian fungsi asinkron didefinisikan dengan nama inisialisasi, yang kemudian disediakan melalui objek module.exports.  Fungsi inisialisasi membuat kumpulan koneksi, yang disimpan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">cache internal kumpulan koneksi</a> sebagai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kumpulan</a> standar. <br><br>  Sekarang Anda perlu menghubungkan semuanya sehingga kumpulan koneksi dimulai sebelum server web terbuka.  Kembali ke <b>index.js</b> dan tambahkan baris berikut di bawah baris 1. <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that requires services/web-server.js is here *** const database = require('./services/database.js');</span></span></code> </pre> <br>  Kemudian tambahkan blok coba berikut ke fungsi stratup, tepat sebelum blok coba yang ada yang memulai server web. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Initializing database module'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> database.initialize(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(err); process.exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Non-zero failure code } // *** existing try block in startup here ***</span></span></code> </pre> <br>  Pada titik ini, Anda dapat menginstal node-oracledb dan menguji kodenya.  Jalankan perintah berikut di terminal dari direktori hr_app. <br><br><pre> <code class="javascript hljs">npm install oracledb -s node .</code> </pre> <br>  Jika Anda melihat pesan bahwa modul database dan server web sedang berjalan, maka, selamat - kumpulan koneksi Anda sekarang berfungsi! <br><br><h4>  Kolam koneksi shutdown </h4><br>  Jika Anda menutup aplikasi sekarang (menggunakan ctrl + c, seperti sebelumnya), proses Node.js akan dimusnahkan sebelum kumpulan koneksi ditutup.  Meskipun semua proses database terkait harus dibersihkan secara otomatis, yang terbaik adalah secara eksplisit menutup kumpulan koneksi sebelum keluar dari proses Node.js. <br><br>  Kembali ke file <b>layanan / database.js</b> , tambahkan baris kode berikut ke akhir, dan simpan pembaruan. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** previous code above this line *** async function close() { await oracledb.getPool().close(); } module.exports.close = close;</span></span></code> </pre> <br>  Fungsi tutup menggunakan metode oracledb.getPool () untuk mendapatkan kumpulan default secara sinkron, dan kemudian memanggil metode tutup pada kumpulan untuk menutupnya. <br><br>  Untuk memanggil fungsi tutup pada waktu yang tepat, tambahkan baris kode berikut ke file <b>index.js</b> di dalam fungsi shutdown segera setelah blok coba yang ada yang menghentikan server web. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** existing try-catch block in shutdown here *** try { console.log('Closing database module'); await database.close(); } catch (err) { console.log('Encountered error', e); err = err || e; }</span></span></code> </pre> <br>  Jika Anda memulai dan menutup aplikasi lagi, Anda akan melihat bahwa modul database ditutup setelah menutup server web, tetapi sebelum proses selesai. <br><br><h4>  Sederhanakan Operasi CRUD Sederhana </h4><br>  Menjalankan kode SQL atau PL / SQL menggunakan node-oracledb biasanya merupakan proses tiga langkah: dapatkan koneksi, jalankan kode, dan kemudian lepaskan koneksi.  Jika semua yang ingin Anda lakukan adalah melakukan satu panggilan untuk mengeksekusi (tidak ada transaksi multi-langkah diperlukan), maka menerima dan melepaskan koneksi mungkin terlihat seperti kode standar.  Saya suka membuat fungsi yang melakukan ketiga operasi dalam satu panggilan.  Kembali ke file <b>services / database.js</b> , tambahkan kode berikut di bawah ini dan simpan perubahannya. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** previous code above this line *** function simpleExecute(statement, binds = [], opts = {}) { return new Promise(async (resolve, reject) =&gt; { let conn; opts.outFormat = oracledb.OBJECT; opts.autoCommit = true; try { conn = await oracledb.getConnection(); const result = await conn.execute(statement, binds, opts); resolve(result); } catch (err) { reject(err); } finally { if (conn) { // conn assignment worked, need to close try { await conn.close(); } catch (err) { console.log(err); } } } }); } module.exports.simpleExecute = simpleExecute;</span></span></code> </pre> <br>  Biasanya, Anda tidak akan menggunakan modul database dalam modul server web, tetapi tambahkan sekarang untuk memverifikasi bahwa ia berfungsi dengan benar.  Buka file <b>services / web-server.js</b> dan tambahkan baris berikut di bawah deklarasi konstan yang ada di atas. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// line that requires ../config/web-server.js here const database = require('./database.js');</span></span></code> </pre> <br>  Kemudian gunakan kode berikut untuk mengganti seluruh penangan app.get yang merespons dengan "Hello World!"  (Semua 3 baris). <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that adds morgan to app here *** app.get('/', async (req, res) =&gt; { const result = await database.simpleExecute('select user, systimestamp from dual'); const user = result.rows[0].USER; const date = result.rows[0].SYSTIMESTAMP; res.end(`DB user: ${user}\nDate: ${date}`); });</span></span></code> </pre> <br>  Handler baru menggunakan fungsi simpleExecute dari modul database untuk mengambil nilai-nilai pengguna saat ini dan systimestamp dari database.  Nilai-nilai ini kemudian digunakan dalam templat literal untuk menanggapi klien dengan pesan dinamis. <br><br>  Luncurkan aplikasi lagi dan pergi ke localhost: 3000. Anda akan melihat sesuatu seperti gambar berikut. <br><br><img src="https://habrastorage.org/webt/fu/89/1t/fu891trgyo2sweotztn8s0l-h-i.png" alt="gambar"><br><br>  Jika Anda melihat pesan ini, maka semuanya berfungsi sebagaimana mestinya.  Di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel berikutnya,</a> Anda akan terus membuat API dengan menambahkan logika perutean, pengontrol, dan basis data untuk permintaan GET. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id473346/">https://habr.com/ru/post/id473346/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id473334/index.html">Kucing Ghonim: Bagaimana membuat kucing tidak buang air di halaman rumah?</a></li>
<li><a href="../id473338/index.html">TDD: cara menulis spesifikasi dengan benar (menjelaskan)</a></li>
<li><a href="../id473340/index.html">Intisari bahan-bahan segar dari dunia front-end untuk minggu terakhir No. 386 (21 - 27 Oktober 2019)</a></li>
<li><a href="../id473342/index.html">"Jalan panjang sedang menunggu Anda ..." atau menyelesaikan masalah perkiraan di C # menggunakan Ml.NET (DataScience)</a></li>
<li><a href="../id473344/index.html">Konser dan acara KudaGo di cermin Anda</a></li>
<li><a href="../id473348/index.html">Ide inersia (SGDm), gagasan scaling (Adagrad) dan regularisasi dalam pembelajaran mesin menggunakan masalah klasifikasi sebagai contoh</a></li>
<li><a href="../id473350/index.html">Membuat API REST dengan Node.js dan Oracle Database. Bagian 3</a></li>
<li><a href="../id473352/index.html">Koleksi serentak dalam 10 menit</a></li>
<li><a href="../id473354/index.html">Tentang keanehan habrostatistics</a></li>
<li><a href="../id473358/index.html">Instal dan konfigurasikan Nexus Sonatype menggunakan infrastruktur sebagai pendekatan kode</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>