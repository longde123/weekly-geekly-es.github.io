<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∏ üßïüèº üéñÔ∏è Probl√®mes d'utilisation de la fonction NtQuerySystemInformation avec des arguments non document√©s üö• üè∫ üßòüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La matin√©e du jour a commenc√© par le fait que les ¬´si¬ª se sont rompus. Cette expression a √©t√© invent√©e une fois par l'un de mes coll√®gues qui a montr√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Probl√®mes d'utilisation de la fonction NtQuerySystemInformation avec des arguments non document√©s</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/infopulse/blog/433906/">  La matin√©e du jour a commenc√© par le fait que les ¬´si¬ª se sont rompus.  Cette expression a √©t√© invent√©e une fois par l'un de mes coll√®gues qui a montr√© comment son d√©bogueur entre dans le bloc if lors de la navigation dans le code, alors que la condition que le si v√©rifi√© √©tait exactement faux.  Le probl√®me √† ce moment-l√† s'est av√©r√© √™tre trivial - il a utilis√© une version optimis√©e pour la version, et dans ce sc√©nario, la confiance dans le d√©bogage √©tape par √©tape, bien s√ªr, est impossible.  Mais l'expression m√™me ¬´ifs cass√©¬ª a pris racine et a √©t√© utilis√©e ici depuis lors pour indiquer une situation o√π quelque chose de si fondamental a cess√© de fonctionner qu'on y croyait √† peine. <br><br>  Donc, ce jour-l√†, la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NtQuerySystemInformation</a> est tomb√©e en panne - l'une des fonctions les plus importantes du syst√®me d'exploitation Windows, qui renvoie des informations sur les processus, les threads, les descripteurs syst√®me, etc.  Sur les avantages de l'utilisation de cette fonctionnalit√©, j'ai d√©j√† √©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> .  Mais il s'est av√©r√© que m√™me ces pierres angulaires d'un syst√®me peuvent parfois √©chouer. <br><br>  Alors qu'est-ce qui s'est pass√©. <br><a name="habracut"></a><br>  Pendant assez longtemps (pendant plusieurs ann√©es), nous avons utilis√© l'appel √† la fonction NtQuerySystemInformation avec l'argument SystemHandleInformation pour obtenir des informations sur tous les descripteurs du syst√®me.  Oui, cet argument fait officiellement r√©f√©rence √† ceux non document√©s, mais si vous commencez √† rechercher des informations sur la fa√ßon de r√©pertorier tous les descripteurs dans toutes les applications Windows OS en cours d'ex√©cution, la combinaison NtQuerySystemInformation + SystemHandleInformation sera l'option la plus souvent propos√©e.  Et cela fonctionne vraiment, sur tous les syst√®mes d'exploitation √† partir de Windows NT. <br><br>  Pourquoi pourriez-vous avoir besoin de rechercher des descripteurs dans tous les processus?  Eh bien, pour diverses raisons.  Des utilitaires comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Process Hacker les</a> affichent uniquement √† titre informatif.  Il existe des programmes qui le font afin de rechercher une ressource qui est actuellement bloqu√©e par quelqu'un (par exemple, un fichier).  Et vous pouvez, par exemple, trouver dans un processus √©tranger un mutex utilis√© pour autoriser le lancement d'une seule copie du programme, le fermer et autoriser le lancement de deux instances d'une telle application.  Ou listez les descripteurs pour les dupliquer afin d'organiser le sandbox.  En g√©n√©ral, il existe de nombreuses t√¢ches. <br><br>  Je ne donnerai pas ici la description compl√®te de l'√©num√©ration des descripteurs, je dirai simplement qu'elle √©tait, en g√©n√©ral, similaire √† des exemples courants, comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">celui-ci</a> : <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((status = NtQuerySystemInformation( SystemHandleInformation, handleInfo, handleInfoSize, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> )) == STATUS_INFO_LENGTH_MISMATCH) handleInfo = (PSYSTEM_HANDLE_INFORMATION)<span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(handleInfo, handleInfoSize *= <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">// NtQuerySystemInformation stopped giving us STATUS_INFO_LENGTH_MISMATCH. if (!NT_SUCCESS(status)) { printf("NtQuerySystemInformation failed!\n"); return 1; } for (i = 0; i &lt; handleInfo-&gt;HandleCount; i++) { ... }</span></span></code> </pre> <br>  Mais ensuite je lance notre application - et soudain, il s'av√®re que le descripteur dont j'ai besoin (et je sais avec certitude qu'il existe!) Ne figure pas dans la liste renvoy√©e par la fonction NtQuerySystemInformation ().  √áa y est, ils sont venus - "si c'est cass√©". <br><br>  Essayer de reproduire le probl√®me sur d'autres ordinateurs du bureau.  Sur certains, il est reproduit, sur la majorit√© - non.  Nous essayons de comprendre en quoi ceux sur lesquels il se reproduit diff√®rent de ceux sur lesquels tout va bien.  La version Windows est la m√™me partout, les mises √† jour, la construction de notre programme - tout est identique.  Du coup, quelqu'un remarque que tous les ordinateurs portables sur lesquels le probl√®me a √©t√© reproduit sont du m√™me mod√®le.  Incompatibilit√© mat√©rielle?  Mais pourquoi tout √† coup maintenant, √ßa fonctionnait ... De plus, il y a d'autres ordinateurs portables du m√™me mod√®le dans le bureau qui fonctionnent maintenant.  M√™me les versions des pilotes de p√©riph√©riques ont √©t√© compar√©es - tout semble √™tre le m√™me.  Mais tout fonctionne sur certains ordinateurs portables, mais pas sur d'autres. <br><br>  Tirer les cheveux sur la t√™te a dur√© environ une demi-journ√©e, jusqu'√† ce que je remarque accidentellement deux choses: <br><br><ol><li>  Les PID de processus, qui sont g√©n√©ralement des nombres √† trois, quatre ou cinq chiffres sur mon ordinateur pour une raison quelconque, sont devenus √† six chiffres.  C'√©tait assez √©trange de voir un PID de type 780936. Je ne les avais pas remarqu√©s auparavant.  De plus, le nombre total de processus en cours d'ex√©cution √©tait tout √† fait suffisant (jusqu'√† une centaine). </li><li>  Le gestionnaire de t√¢ches sur l'onglet CPU a montr√© le nombre total de descripteurs dans le syst√®me - et c'√©tait √©norme, plus de 800 000. </li></ol><br>  Pour une application normale, il est normal d'ouvrir cent ou deux descripteurs.  Eh bien, mille.  Avec une utilisation active, Chrome peut ouvrir environ 2000, Visual Studio peut en ouvrir 3000 sur de grands projets, mais qui a ouvert 800 000?  Heureusement, le Process Hacker mentionn√© pr√©c√©demment vous permet d'afficher le nombre de descripteurs pour chaque processus et m√™me de trier la liste des processus en fonction du nombre de descripteurs utilis√©s. <br><br>  Et que voyons-nous?  Et nous voyons quelque chose comme cette image: <br><br><img src="https://habrastorage.org/webt/yz/zi/vt/yzzivtoy8-an-odiloby55oherc.png"><br><br>  Je dois dire que je viens de faire la capture d'√©cran ci-dessus, de sorte que le premier de la liste de processus n'a ¬´que¬ª environ 20 000 descripteurs.  Et puis, quand j'ai vu le probl√®me pour la premi√®re fois, il y en avait environ 650 000. Et qui est notre h√©ros?  Bingo!  Il s'agit du processus SynTPEnhService.exe. <br><br>  Et puis tout le puzzle se d√©veloppe dans ma t√™te.  SynTPEnhService.exe fait partie du pilote du pav√© tactile Synaptics.  Il a √©t√© install√© uniquement sur les ordinateurs portables d'un certain mod√®le dans notre bureau, sur lesquels le probl√®me s'est produit.  Une br√®ve observation a montr√© que toutes les 5 secondes, ce processus d√©marre le processus enfant SynTPEnh.exe, qui se ferme apr√®s 1-2 secondes.  Dans le m√™me temps, le processus parent continue de contenir le descripteur du processus enfant, ce qui entra√Æne une fuite de descripteurs.  Un √† la fois toutes les 5 secondes.  C'est 17 280 descripteurs par jour.  Laissez l'ordinateur allum√© pendant une semaine et vous avez maintenant plus de cent mille descripteurs de blocage.  Mon ordinateur personnel n'a pas red√©marr√© pendant plus d'un mois - d'o√π les PID des nouveaux processus avec des nombres sup√©rieurs √† un demi-million.  Cela explique √©galement pourquoi le probl√®me a √©t√© reproduit sur certains ordinateurs portables dans notre bureau, mais il ne s'est pas produit sur les autres ordinateurs portables: certains de mes coll√®gues ont red√©marr√© leur PC tous les jours et quelqu'un, comme moi, les a laiss√©s allum√©s pour la nuit. . <br><br>  √Ä propos, √† cet endroit, je me suis souvenu que j'avais d√©j√† lu un probl√®me avec les pilotes du pav√© tactile Synaptics.  Apr√®s avoir creus√© un peu, j'ai trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> √©crit par Bruce Dawson (de nombreuses traductions de ses articles ont √©t√© publi√©es √† diff√©rents moments sur Habr√©, mais pas celle-ci en particulier).  L√†, il d√©crit le probl√®me de fuite de m√©moire d√ª √† ce red√©marrage sans fin du processus SynTPEnh.exe, mais ne dit rien sur le probl√®me de fuite de poign√©e, donc ma d√©couverte est toujours diff√©rente de celle-ci. <br><br><h3>  R√©solution de probl√®mes </h3><br>  Ainsi, le pilote du pav√© tactile "mange" des centaines de milliers de descripteurs - et alors quoi?  Et le fait que la fonction NtQuerySystemInformation (SystemHandleInformation, ...) √©crite √† l'√©poque de Windows NT avait (et a) un tampon interne assez limit√©.  Je n'ai pu trouver une indication exacte de sa taille nulle part, mais, √©videmment, il n'a pas √©t√© con√ßu pour un million de descripteurs.  Par cons√©quent, la fonction les renvoie ¬´autant que possible¬ª, ce qui signifie que parmi eux, il peut y avoir ou non celui souhait√©. <br><br>  Que faire?  Comme Rick de la s√©rie anim√©e "Rick et Morty" l'a dit: "Lorsque vous inventez la t√©l√©portation, vous d√©couvrez imm√©diatement une chose d√©sagr√©able: vous √™tes la derni√®re personne de l'univers √† l'avoir invent√©e."  Il s'est av√©r√© que Microsoft a r√©alis√© ce probl√®me avec le tampon limit√© dans NtQuerySystemInformation en l'appelant avec l'argument SystemHandleInformation il y a 20 ans, et donc, √† partir de WindowsXP, ils ont ajout√© la fonction NtQuerySystemInformation un autre argument (et √©galement non document√©) SystemExtendedHandleInformation.  Lorsque vous appelez NtQuerySystemInformation (SystemExtendedHandleInformation, ...), tous les descripteurs du syst√®me vous seront retourn√©s, quel que soit leur nombre.  Eh bien, ou plut√¥t, je ne le sais pas avec certitude, il y a peut-√™tre des restrictions pour cet argument, mais c'est s√ªr qu'il peut retourner 800 000 descripteurs dans un √©tat. <br><br>  Sur le net, vous pouvez trouver des exemples d'utilisation de SystemExtendedHandleInformation, par exemple, <a href="">celui-ci</a> .  En g√©n√©ral, tout est similaire l√†-bas, d'autres structures sont simplement utilis√©es, et c'est tout. <br><br>  C'√©tait une histoire instructive sur l'utilisation d'arguments non document√©s du syst√®me d'exploitation Widnows, qui peuvent √™tre tr√®s utiles, mais n√©cessitent des tests minutieux et une pr√©paration aux probl√®mes non standard. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433906/">https://habr.com/ru/post/fr433906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433896/index.html">L'utilisation de l'apprentissage automatique n'est pas difficile. Assez pour √ßa pendant une semaine ...</a></li>
<li><a href="../fr433898/index.html">Digest MBLT DEV :: Num√©ro 200</a></li>
<li><a href="../fr433900/index.html">ICQ est mort. Vive ICQ?</a></li>
<li><a href="../fr433902/index.html">R√©p√©tition pour un programmeur: pourquoi il est important de r√©soudre des probl√®mes similaires</a></li>
<li><a href="../fr433904/index.html">Jira DataCenter - qu'est-ce que c'est? Comment √ßa marche? Comment d√©ployer?</a></li>
<li><a href="../fr433908/index.html">Tetris en C # en 100 lignes</a></li>
<li><a href="../fr433910/index.html">R√©flexions sur la rouille 2019</a></li>
<li><a href="../fr433912/index.html">Vous voulez attirer les meilleurs ing√©nieurs? Code ouvert</a></li>
<li><a href="../fr433916/index.html">Allez communaut√© √† Kazan et nos r√©unions</a></li>
<li><a href="../fr433918/index.html">Pourquoi le Web est-il si compliqu√©?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>