<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧗🏿 🤦🏽 🙋🏼 Ein billiges Fitness-Armband hacken 👩🏿 👏 🧑🏽‍🤝‍🧑🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dies ist eine Übersetzung. Artikel veröffentlicht am 27. Mai 2018 


 Fitness-Tracker vor und nach der Demontage 

 Als ich zur jetzigen Firma kam, be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ein billiges Fitness-Armband hacken</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413895/">  <font color="gray">Dies ist eine Übersetzung.</font>  <font color="gray"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel</a> veröffentlicht am 27. Mai 2018</font> <br><br><img src="https://habrastorage.org/webt/4n/-9/ah/4n-9ah3fvyxx23aobpo2tvx0jg4.jpeg"><br>  <i><font color="gray">Fitness-Tracker vor und nach der Demontage</font></i> <br><br>  Als ich zur jetzigen Firma kam, bekam ich am ersten Tag freundlicherweise eine Reihe von Geschenken.  Unter ihnen war dieses Armband mit einem Fitness-Tracker.  Unabhängig von Ihrer Liebe zur Bewegung ist dies aus rein technischer Sicht ein unglaublich cooles Gerät: <br><br><ul><li>  ein wirklich kleiner Formfaktor (ungefähr 15 × 40 mm); </li><li>  Bluetooth Low Energy (BLE); </li><li>  OLED-Anzeige (96 × 32 Pixel); </li><li>  Batterie </li><li>  USB-Aufladung </li><li>  Beschleunigungsmesser; </li><li>  Vibrationsmotor; </li><li>  Der Preis beträgt ca. 10 $ (!). </li></ul><a name="habracut"></a><br>  Draußen ist die einzige Kennung auf der Rückseite der Aufkleber „FCC ID: 2AHFTID115“.  Wenn Sie es googeln, scheint es dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ID115-</a> Gerät zu entsprechen, und Sie können sogar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">mehrere Fotos</a> seiner Innenseiten finden.  Wenn Sie sich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eines dieser Fotos</a> ansehen, können Sie den Namen der größten integrierten Schaltung (IC) sehen: N51822.  Dies deutet darauf hin, dass es möglicherweise einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">nordischen</a> Mikrocontroller (MCU) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">nRF51822 gibt</a> , einen 32-Bit-ARM-M0-Prozessor mit integrierter BLE-Unterstützung, der theoretisch recht einfach für andere <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufgaben</a> zu programmieren ist, die ein Armband ausführen sollte. <br><br>  Bevor ich das Gadget zerlegte, ging ich noch ein wenig auf Google und stellte fest, dass in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einigen ähnlichen Armbändern</a> derselbe Chip installiert ist und die Leute ihn erfolgreich programmiert haben. <br><br>  Das Öffnen des Koffers war nicht so einfach.  Die schwarze Plastikhülle ist auf den grauen Hintergrund geklebt.  Ich versuchte einen Fön, um den Kleber zu erweichen, und schnitt ihn geduldig mit einem kleinen Messer ab, um den Kunststoff nicht zu stark zu beschädigen.  Nach dem Öffnen habe ich sichergestellt, dass es wirklich nRF51822 gibt.  Später kaufte ich ein fast identisches MCU-Armband von Texas Instrument.  Denken Sie daran, dass es Optionen gibt. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2e6/0af/a75/2e60afa757e9f5859408e49d7f76e54f.jpg"></a> <br>  <i><font color="gray">nRF51822 und Kugelschreiber für Waage</font></i> <br><br><h1>  Einen Weg finden, um zu kommunizieren </h1><br>  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> besagt, dass der Chip über die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zweipolige</a> Schnittstelle ARM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Serial Wire Debug</a> (SWD) programmiert / debuggt werden kann.  Wenn wir einen Kommunikationskanal mit einem Chip einrichten möchten, bedeutet dies zwei Dinge: <br><br><ul><li>  Wir brauchen einen SWD-Programmierer (zum Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Segger J-Link</a> ). </li><li>  Wir benötigen Zugriff auf die beiden SWD-Pins des Mikrocontrollers, nämlich SWDIO (Daten) und SWDCLK (Taktimpulse). </li></ul><br>  Glücklicherweise gibt es mehrere Pads auf dem Board.  Obwohl ihre Existenz klar durch die Notwendigkeit des Debuggens, Testens und Verifizierens erklärt wird, denke ich lieber, dass ein cooler Ingenieur sie dort als kleine Geschenke für Leute wie uns zurückgelassen hat.  Nicht alle von ihnen sind ordnungsgemäß beschriftet, daher schlage ich die folgenden Codes vor: <br><br><img src="https://habrastorage.org/webt/fc/gd/y9/fcgdy9fj-73b3cdtcsbgdqdjovw.jpeg"><br><br><img src="https://habrastorage.org/webt/et/-t/_4/et-t_46am8apprgxc3mtkyyg0gq.jpeg"><br>  <i><font color="gray">Vorder- und Rückseite der Leiterplatte.</font></i>  <i><font color="gray">Kugelschreiber für Skalen und halb beliebige Namen für offene Pads</font></i> <br><br>  Mit demselben billigen <a href="">USB-Mikroskop machte</a> ich mehrere Bilder von der Vorder- und Rückseite der Platine und versuchte, die Spuren vom Mikrocontroller bis zu den Pads zu verfolgen. <br><br><img src="https://habrastorage.org/webt/pc/oe/-h/pcoe-ha9fus65p5oenznunhxx30.jpeg"><br><br><img src="https://habrastorage.org/webt/nk/hy/ed/nkhyedqu2al7dvuxmbqs8ns9g9u.jpeg"><br>  <i><font color="gray">Tracks zu SWDIO- und SWDCLK-Pins auf der Vorder- und Rückseite der Platine</font></i> <br><br>  Bitte beachten Sie, dass dies eine mehrschichtige Leiterplatte mit Durchgangslöchern ist. Überprüfen Sie daher die Spuren auf beiden Seiten der Leiterplatte.  Auf diesen Fotos können Sie die Spuren von den Kontakten SWDIO und SWDCLK auf dem Chip bis zu den Pads IO und CLK verfolgen.  Wir werden also sicherstellen, dass die CLK-Markierung auf der Platine der SWDCLK auf der MCU entspricht und der unbeschriftete Kontakt der SWDIO-Pin ist.  Jetzt können Sie unsere erste Zuordnungstabelle vorbereiten: <br><br><table><tbody><tr><th>  NRF51822 Stift </th><th>  Spielplatz </th><th>  Beschreibung </th></tr><tr><td>  SWDIO </td><td>  IO </td><td>  Datenausgabe zur Programmierung von SWD </td></tr><tr><td>  SWDCLK </td><td>  CLK </td><td>  Taktausgang für SWD-Programmierung </td></tr></tbody></table><br><h1>  Obduktion </h1><br>  Nachdem ich Zugang zu zwei SWD-Pads erhalten hatte, löte ich sehr dünne Drähte an diese und an alle anderen verfügbaren Kontakte. <br><br> <a href=""><img src="https://habrastorage.org/webt/hf/cm/6j/hfcm6jaswn6gf08oxc8ypaehmtu.jpeg"></a> <br><br><h1>  Blink ein wenig </h1><br>  Die nächste Aufgabe besteht darin, zu versuchen, das Gerät für eine bestimmte Aufgabe zu programmieren.  Um das einfachste Programm auszuführen, müssen wir Folgendes sicherstellen: <br><br><ul><li>  Wir haben die Kontakte von SWDIO / SWDCLK korrekt verfolgt. </li><li>  Der SWD-Programmierer wird ausgeführt und der Computer kann Befehle ausgeben. </li><li>  Wir können das Arm-Programm kompilieren und das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nordic SDK</a> korrekt verwenden. </li><li>  Wir können das kompilierte Programm in den Chip flashen. </li><li>  Der Chip funktioniert korrekt und lädt unser Programm. </li></ul><br>  In diesem Fall kann „Hallo Welt“ ein Programm sein, das die LED ein- und ausschaltet.  Und selbst dies ist nicht elementar, da auf der Platine keine eingebaute LED vorhanden ist. Wenn Sie eine externe hinzufügen, müssen Sie noch herausfinden, an was sie angeschlossen werden soll.  Dies fügt dem räumlichen Modell des Problems eine weitere Dimension hinzu.  Aufgrund des Mangels an freiem Käsesatz habe ich gerade zwei LEDs an die Pins <code>P1</code> und <code>P2</code> in der Hoffnung, dass wir mit der MCU zu diesen Pads gelangen können. <br><br> <a href=""><img src="https://habrastorage.org/webt/vj/t0/ab/vjt0abxchpbfjiyq87acqsyq4n4.jpeg"></a> <br>  <i><font color="gray">Schlechter Tag</font></i> <br><br>  Treiber und Befehlszeilenprogramme für den J-Link SWD-Programmierer finden Sie auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der Segger-Website</a> .  Wenn Sie unter macOS arbeiten und Homebrew verwenden, suchen Sie unter <code>caskroom/drivers/segger-jlink</code> nach der Cask-Formel.  Die Kommunikation mit dem SWD-Programmierer wird über das <code>JLinkExe</code> . <br><br>  Dann habe ich das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nordic nRF5 SDK</a> heruntergeladen (ich verwende <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Version 12.3.0</a> ).  Aus den SDK-Beispielen geht hervor, dass wir einen Compiler benötigen, der Arm-Programme kompilieren kann.  Also habe ich <code>gcc-arm-embedded</code> installiert (auch bei Homebrew erhältlich). <br><br>  Nachdem ich die SDK-Dokumentation und die nordischen Entwicklerforen untersucht hatte, stellte ich fest, dass ihre SDKs am häufigsten mit solchen Entwicklungsboards verwendet werden.  Das SDK ist für mehrere Varianten solcher Karten vorkonfiguriert.  Da wir in direktem Kontakt mit dem Controller stehen, müssen Sie einige SDK-Parameter konfigurieren. <br><br>  Ich habe <i>viel</i> Zeit damit verbracht, das nRF5-Ökosystem zu verstehen, aber am Ende konnte ich das Programm immer noch auf einem Chip ausführen!  Das <a href="">Video</a> zeigt zwei blinkende LEDs.  Zu diesem Zeitpunkt habe ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Github-Repository erstellt</a> und dort ein Programm mit einem funktionierenden <code>Makefile</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gespeichert</a> .  Eines der Hauptgeheimnisse war, dass es tatsächlich mehrere Optionen für nRF51822 gibt, und in meinem gibt es nur 16 KB Speicher.  Also musste ich noch <a href="">das Linker-Skript reparieren</a> . <br><br><h1>  Digitaler Ein- / Ausgang </h1><br>  Wie ich bereits sagte, gab die Aufgabe mit blinkenden LEDs einige Hoffnungen und eine Poke-Methode, welche der MCU-Kontakte zu <code>P1</code> und <code>P2</code> , wo die LEDs angeschlossen sind.  Die einfachste Strategie besteht darin, alle Ausgänge nacheinander zu verbinden und nacheinander Hoch- und Niederspannung anzulegen.  Zu meiner Überraschung leuchteten beide LEDs auf!  Ich war noch mehr überrascht, als der Vibromotor anfing zu arbeiten! <br><br>  Also, die der Tabelle hinzugefügte Poke-Methode: <br><br><table><tbody><tr><th>  NRF51822 Stift </th><th>  Spielplatz </th><th>  Beschreibung </th></tr><tr><td>  P0.30 </td><td>  P1 </td><td>  Digitales GPIO </td></tr><tr><td>  P0.00 </td><td>  P2 </td><td>  Digitales GPIO </td></tr><tr><td>  P0.01 </td><td>  - - </td><td>  Vibrationsmotor </td></tr></tbody></table><br><h1>  printf </h1><br>  Die Fähigkeit, Daten auf einen Computer zu übertragen, ist für das Debuggen unverzichtbar.  Der J-Link-Programmierer unterstützt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Echtzeitübertragung (RTT)</a> zum Senden und Empfangen von Daten vom Chip.  Um RTT verwenden zu können, müssen Sie <code>#include "SEGGER_RTT.h"</code> und <code>SEGGER_RTT_WriteString()</code> aufrufen.  Um Daten auf einem Computer zu empfangen, rufen Sie die <code>jlinkrttlogger</code> , die mit J-Link geliefert wird. <br><br><h1>  OLED </h1><br>  Eine weitere Herausforderung besteht darin, OLED zum Laufen zu bringen.  Auf der am häufigsten verwendeten OLED auf dem Markt wird der Treiber / Controller <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ssd1306 ausgeführt. Die</a> Kommunikation mit der MCU erfolgt normalerweise über eine serielle Schnittstelle, die entweder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SPI</a> oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">I²C verwendet</a> .  Hier ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Beispiel von Adafruit</a> . <br><br>  Ich habe ein solches Display in keinem der normalen Geschäfte gefunden.  Und die Größe von 96 × 32 ist nicht Standard.  Eine Suche nach der Kennung QT1316P01A auf dem Display zeigt chinesische Websites wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aliexpress an</a> , es gibt jedoch keine Dokumentation außer den Namen der Schlussfolgerungen: <br><br><img src="https://habrastorage.org/webt/jh/we/dj/jhwedjuvdabshgmklscu3wk6edi.png"><br>  <i><font color="gray">OLED-Pin-Benennung mit Aliexpress</font></i> <br><br>  Wenn die Liste nicht lügt, teilen uns die Kontakte <code>SCL</code> , <code>SDA</code> und <code>RES#</code> , dass dies eine I²C-Option ist.  Wenn zwischen den drei Pins von nRF51822 und diesen drei Pins von OLED Spuren vorhanden sind, werden wir einen Schritt nach vorne machen.  Kehren wir zum Mikroskop zurück. <br><br><img src="https://habrastorage.org/webt/vw/dg/9d/vwdg9dxuopykb2umzrjt1zskvv4.jpeg"><br><br><img src="https://habrastorage.org/webt/zq/zl/ym/zqzlymrnmspwkcroh4argcj_udo.jpeg"><br>  <i><font color="gray">OLED-Datenkontaktspuren</font></i> <br><br>  Wir aktualisieren die Korrespondenztabelle: <br><br><table><tbody><tr><th>  NRF51822 Stift </th><th>  Spielplatz </th><th>  Beschreibung </th></tr><tr><td>  P0.21 </td><td>  - - </td><td>  OLED SDA-Ausgabe </td></tr><tr><td>  P0.22 </td><td>  - - </td><td>  OLED SCL Pin </td></tr><tr><td>  P0.24 </td><td>  - - </td><td>  OLED RES # ausgeben </td></tr></tbody></table><br>  Das I²C-Protokoll ist viel weiter fortgeschritten als jedes einfache serielle Protokoll wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">UART</a> .  Einer der Vorteile besteht darin, dass mehrere Master- und Slave-Geräte am selben Bus unterstützt werden.  Dies macht die Sache etwas komplizierter: Zumindest müssen Sie der MCU mitteilen, für welche Slave-Befehle ausgegeben werden.  Auf hoher Ebene gibt es also neben physischen Kontakten auch eine „logische“ Adresse des OLED-Displays. <br><br>  Glücklicherweise ist ein Beispiel im nRF5 SDK der I²C-Scanner.  Er fragt nach allen möglichen logischen Adressen und meldet, ob dort etwas installiert ist.  Meine modifizierte Version ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .  Es wird das folgende Protokoll erstellt: <br><br> <code>$ make <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> TWI scanner. <br> TWI device detected at 0x3c.</code> <br> <br>  Tolle Neuigkeiten!  Wir haben guten Grund zu der Annahme, dass das Display korrekt identifiziert wurde und es sich tatsächlich um eine I²C-Variante handelt.  Eine <code>0x3c</code> Suche besagt, dass <code>0x3c</code> eine typische Adresse für solche Geräte ist. <br><br>  Jetzt können wir einige Pixel an das Display senden.  Auf dieser Ebene gibt es keine Abstraktion durch die Bibliothek.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">In der</a> Dokumentation zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ssd1306 finden Sie</a> eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einfache</a> Möglichkeit zum Übertragen von Daten.  Der Prozess besteht aus einer Folge von Konfigurationsbefehlen, mit denen die Ausrichtung der Anzeige, der Aufnahmemodus, die Größe usw. festgelegt werden.  Anschließend wird eine Folge von Bytes, die auf dem Bildschirm angezeigt werden, an den Grafikdisplayspeicher (GDDRAM) gesendet. <br><br>  Für die richtige Konfiguration habe ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die ssd1306-Bibliothek von Adafruit studiert</a> und versucht, ähnliche Befehle zu emulieren.  Das war es, was der Löwe in diesem Projekt zeitlich in Anspruch nahm.  Es stellte sich als sehr zeitaufwändig heraus, alle Details herauszufinden, und dennoch kann ich einige Dinge nicht erklären.  Es funktioniert jedoch! <br><br> <a href=""><img src="https://habrastorage.org/webt/lr/ix/r7/lrixr7dxh_7j9098jx677drocxm.jpeg"></a> <br>  <i><font color="gray">Zeigen Sie eine fest codierte Bitmap an</font></i> <br><br>  Der Code für dieses Beispiel ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br>  Mit diesen Einstellungen ist die Anzeige in 4 Zeilen (Seiten) und 96 Spalten unterteilt.  Die Seiten sind also 8 Pixel groß.  Das erste gesendete Byte befindet sich "vertikal" in der ersten Spalte der ersten Seite.  Das zweite Byte belegt die zweite Spalte, dann die dritte usw. bis zur 96. Spalte, wenn es <i>zurückkehrt</i> und von der ersten Spalte auf der zweiten Seite beginnt. <br><br>  Dies ist das <i>erwartete</i> Verhalten.  Wie <a href="">im Video gezeigt</a> , ist das <i>beobachtete</i> Verhalten anders: Zuerst werden die ungeraden Spalten gefüllt, dann die geraden, und erst dann kehrt es zur zweiten Seite zurück. <br><br>  Ich habe viel Zeit damit verbracht, den Grund für solch ein dummes Anzeigeverhalten zu verstehen, und dann noch etwas Zeit, um es zu konfigurieren, um es zu beheben.  Am Ende schluckte ich meinen Stolz und implementierte immer noch eine so seltsame Renderlogik in das Programm, um es zu beenden. <br><br><h1>  Reise nach Arduino </h1><br>  Als ich mich in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die Adafruit ssd1306-Bibliothek</a> für Arduino <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vertiefte</a> , dachte ich immer, es wäre schön, eine Möglichkeit zu haben, bestimmte Arduino-Bits zu „simulieren“, um sie auf nRF51822 zu testen.  Es stellt sich heraus, dass auch viel erfahrenere Leute über dieses Thema nachgedacht haben - das ist es, was das erstaunliche <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sandeepmistry / Arduino-nRF5-</a> Projekt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tut</a> .  Es implementiert die wichtigsten Arduino-Bibliotheken mithilfe des nRF5-SDK. <br><br>  Mit diesem Projekt können wir die Arduino IDE öffnen, das nRF5-Board auswählen und das reichhaltige Arduino-Ökosystem nutzen.  Ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gabelte das Projekt</a> und fügte Unterstützung für das Brett von unserem Armband hinzu.  Sie können es aus dem Dropdown-Menü <code>Tools &gt; Board &gt; ID115 Fitness Bracelet (nRF51822)</code> . <br><br> <a href=""><img src="https://habrastorage.org/webt/jx/ts/2h/jxts2hki_rpefinf1cjd2ms7k1w.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/50/gn/dm/50gndm8tzezp_frgdrile7la5hs.jpeg"></a> <br>  <i><font color="gray">Adafruit ssd1306 Bibliothek in ihrer ursprünglichen Form (oben) und mit einem Patch (unten)</font></i> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dies</a> bedeutet auch, dass wir jetzt die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adafruit OLED-Bibliothek verwenden können</a> .  Zu meiner Überraschung und Erleichterung passierte dasselbe seltsame Verhalten, als zuerst ungerade und gerade OLED-Spalten ausgefüllt wurden!  Ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gabelte</a> gerne <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die</a> Bibliothek und implementierte den gleichen Hack.  Im Vergleich zum Low-Level-Ansatz haben wir jetzt Zugriff auf eine Vielzahl cooler Abstraktionen, wie z. B. die Textausgabe: <br><br> <a href=""><img src="https://habrastorage.org/webt/gd/62/xf/gd62xfqutmoq_szmosnzvpbdu1i.jpeg"></a> <br>  <i><font color="gray">Das bekanntere "Hallo Welt!"</font></i> <br><br><h1>  Analoge Ein- / Ausgabe </h1><br>  Zusätzlich zu den digitalen Ein / Aus-Signalen verfügt der nRF51822 über 10 Pins für den analogen Eingang.  Dies ist beispielsweise zum Ablesen der aktuellen Batterieladung nützlich.  Nach der Dokumentation ergibt das Lesen von analogen Kontakten einen 10-Bit-Wert.  Wenn also am Eingang <code>0V</code> anliegen, lesen wir <code>0</code> , und wenn <code>VCC</code> , lesen wir <code>1023</code> mit Zwischenwerten dazwischen. <br><br>  Ich habe regelmäßig die Werte der Analogeingänge gelesen und die interessantesten Signale aufgezeichnet: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/483/446/36c/48344636cddd789c9c1f86c15ffca411.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3c/3ab/38c/b3c3ab38ce708082b19a67ed9cdb30ae.png"><br>  <i><font color="gray">Der Effekt des Schüttelns der Platine und des Ladens des Akkus gemäß den Daten der Analogeingänge</font></i> <br><br>  Ich bin überzeugt, dass sich der Kontakt <code>P0.05</code> auf die Batterieladung bezieht, da der Wert beim Laden und Entladen zunimmt und abnimmt.  Ich vermute, dass Pin <code>P0.26</code> mit einem der Ausgänge des Beschleunigungsmessers verbunden ist, da er verrückt wird, wenn Sie die Platine schütteln.  Die Kontakte <code>P0.03</code> und <code>P0.04</code> <i>können</i> auch mit verschiedenen Ausgängen des Beschleunigungsmessers verbunden werden, aber hier wird dem Signal vom Eingang höchstwahrscheinlich ein bestimmter Effekt zweiter Ordnung überlagert.  Beachten Sie beispielsweise im ersten Diagramm, wie sich der Batteriestand (Pin 5) ändert, wenn der Beschleunigungsmesser mehr Energie benötigt.  Dies ist ein Beispiel für einen Effekt zweiter Ordnung. <br><br>  Code finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">in dieser Skizze</a> .  Die Quelldaten und das Grafikskript finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .  Jetzt können wir unserer Korrespondenztabelle mehrere Zeilen hinzufügen: <br><br><table><tbody><tr><th>  NRF51822 Stift </th><th>  Spielplatz </th><th>  Beschreibung </th></tr><tr><td>  P0.05 </td><td>  - - </td><td>  Analogeingang - An Batterie angeschlossen </td></tr><tr><td>  P0.26 </td><td>  - - </td><td>  Analogeingang - Einachsiger Beschleunigungsmesser </td></tr><tr><td>  P0.03 </td><td>  - - </td><td>  Analogeingang - eine Achse des Beschleunigungsmessers (wahrscheinlich) </td></tr><tr><td>  P0.04 </td><td>  - - </td><td>  Analogeingang - eine Achse des Beschleunigungsmessers (wahrscheinlich) </td></tr></tbody></table><br><h1>  Knopf </h1><br>  Wenn Sie in der Original-Firmware das Armband an einer bestimmten Stelle berühren, wird das Display eingeschaltet.  Wenn Sie diesen Punkt halten, wird der Chronometer gestartet, wenn ich mich richtig erinnere.  Dies ist keine physische Taste, sondern eine Art kapazitive Berührung, die überraschend gut funktioniert.  Mit dem gleichen Ansatz wie bei der Suche nach digitalen Ausgängen habe ich <a href="">einen Ort gefunden, an dem eine Verbindung zur MCU (Video) hergestellt werden kann</a> . <br><br>  Der Code ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br><table><tbody><tr><th>  NRF51822 Stift </th><th>  Spielplatz </th><th>  Beschreibung </th></tr><tr><td>  P0.10 </td><td>  - - </td><td>  Digitaleingang - Eingebaute Taste </td></tr></tbody></table><br><h1>  Bluetooth Low Energy (BLE) </h1><br>  Die BLE-Funktionalität auf nRF5-Chips wird über SoftDevice implementiert.  Dies ist eine vorkompilierte Binärdatei mit einem BLE-Stapel.  Es wird unabhängig von der Anwendung genäht.  Abhängig von der SDK-Version und der Chip-Version gibt es viele Versionen von SoftDevice. <br><br>  Die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> enthält eine bestimmte Abhängigkeitsmatrix (Sie können leider keinen direkten Link dazu setzen).  Es zeigt, mit welchem ​​SDK die verschiedenen Versionen des Chips geliefert werden - und um welche Version von SoftDevice es sich handelt.  In unserem Fall ist der Chip mit QFAAH0 gekennzeichnet, dieser Chip verfügt über 256 KB Flash-Speicher, 16 KB RAM und die Kompatibilität mit SoftDevice s130 ist deklariert. <br><br>  Mein SDK Version 12.3 enthält bereits einige Beispiele für die Verwendung von SoftDevice s130.  Im Vergleich zu früheren Programmen, die von Adresse <code>0x0</code> direkt mit Mikrochips <code>0x0</code> , müssen Sie jetzt SoftDevice von Adresse <code>0x0</code> und das Programm selbst von Adresse <code>0x1b000</code> .  Nach dem Laden und Initialisieren wird die SoftDevice-Binärdatei an diese Adresse gesendet und die Steuerung an unser Programm übertragen.  Zur Veranschaulichung habe ich dasselbe Beispiel mit blinkenden LEDs verwendet, es jedoch für die SoftDevice-Firmware ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Code</a> ) geändert.  Das beobachtete Verhalten hat sich nicht geändert, außer dass Sie SoftDevice vorab flashen sollten: <br><br> <code>$ make <br> # ... <br> $ make flash-softdevice <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> Hello, world!</code> <br> <br>  Die vielleicht einfachste Anwendung für Bluetooth besteht darin, das Gerät in ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Leuchtfeuer zu</a> verwandeln.  Das Gerät sendet nur seine Anwesenheit.  Ein solches Beispiel befindet sich im SDK mit dem Namen <code>ble_app_beacon</code> .  Es wird davon ausgegangen, dass SoftDevice <code>s130</code> bereits geflasht ist. <br><br>  Auch hier erschwert die Kommunikation auf niedriger Ebene mit dem Chip alles im Vergleich zur Programmierung über das SDK.  Neben der Anpassung der RAM-Größe (dieses Wissen war für mich im Beispiel mit LEDs schwierig) wurde ein weiteres schwer zu verfolgendes Problem festgestellt.  Wie sich herausstellte, verwendet der BLE-Stapel einen Taktgenerator, um zeitkritische Aufgaben auszuführen.  In den SDK-Beispielen wird ein externer Quarzoszillator angenommen.  Als ich dies nach Tausenden von <code>printf</code> erkannte, änderte ich das Konfigurationsflag, um einen synthetischen Taktgenerator zu verwenden, und das Problem wurde gelöst.  Der Quellcode des Beacons ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br><h1>  BLE + Arduino </h1><br>  Als das BLE-Beispiel mit dem nRF5-SDK arbeitete und die Fallen mit RAM und einem Generator kannte, schaute ich noch einmal auf die Arduino-Umgebung.  Und wieder gab es das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">großartige Projekt Sandeepmistry / Arduino-BLEPeripheral</a> (vom selben Typ wie Arduino-nRF5!), Das zusätzlich zu den internen BLE-Einstellungen hervorragende Abstraktionen bietet. <br><br>  Zu meiner Überraschung musste ich nicht einmal die Bibliothek teilen.  Der Autor des arduino-nrf5-Projekts verbrachte Zeit und fügte die Konfiguration aller Karten und Einstellungen hinzu. Die Auswahl des richtigen Taktgenerators für SoftDevice erfolgt nun über eine einfache Auswahl aus dem Dropdown-Menü <code>Tools &gt; Low Frequency Clock &gt; Synthesized</code> .  Genial.  Ich habe schnell <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Beispiel</a> mit eingeschalteter grüner LED über Bluetooth geschrieben (mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dieser Anwendung</a> ).  Seine Arbeit wird <a href="">im Video gezeigt</a> . <br><br><h1>  Weitere Pläne </h1><br>  Nachdem ich unzählige Stunden mit diesem Board herumgespielt habe, jucken meine Hände einige Wochen lang, um es weiter in die Waschmaschine zu stecken und es für eine Weile zu vergessen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de413895/">https://habr.com/ru/post/de413895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de413881/index.html">5,94 Meter Docker-Bild mit Telegramm MTProxy</a></li>
<li><a href="../de413885/index.html">Cavium ThunderX2-Evaluierung: Der Arm Server-Traum wird wahr (Teil 1, Einführung)</a></li>
<li><a href="../de413889/index.html">Verpasste Frist oder warum mehr als die Hälfte der Unternehmen nicht für die DSGVO bereit waren</a></li>
<li><a href="../de413891/index.html">Wie ist das einheitliche staatliche Register der juristischen Personen - ein einheitliches staatliches Register der juristischen Personen?</a></li>
<li><a href="../de413893/index.html">Ein Loch als Sicherheitswerkzeug - 2 oder wie man APT "lebende Köder" fängt</a></li>
<li><a href="../de413897/index.html">Unity3D ECS und Job System</a></li>
<li><a href="../de413899/index.html">Biometrische personenbezogene Daten von Russen</a></li>
<li><a href="../de413901/index.html">Steuerung des selbstausgleichenden EduMip-Roboters mit dem PS4 Dualshock 4 Joystick über ROS</a></li>
<li><a href="../de413903/index.html">Wie Cambridge Analytica Klicks in Stimmen verwandelt</a></li>
<li><a href="../de413907/index.html">Die Zusammenfassung interessanter Materialien für den mobilen Entwickler # 256 (4. Juni - 12. Juni)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>