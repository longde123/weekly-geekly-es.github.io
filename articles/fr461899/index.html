<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úäüèø üí™üèº üèä G√©n√©ration d'√©v√©nements, CQRS et Laravel üë®‚Äçüë®‚Äçüë¶ üë®üèæ‚Äçüç≥ üóíÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La traduction de l'article a √©t√© pr√©par√©e pour les √©tudiants du cours professionnel "Framework Laravel" 
 



 Pr√©sentation 
 Cet article est consacr√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>G√©n√©ration d'√©v√©nements, CQRS et Laravel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/461899/">  <i>La traduction de l'article a √©t√© pr√©par√©e pour les √©tudiants du cours professionnel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Framework Laravel"</a></i> <i><br></i> <br><img src="https://habrastorage.org/webt/h8/4u/y5/h84uy5i5spnt3rdmpaiw2aynd0s.png"><br><br><hr><br><h2>  Pr√©sentation </h2><br>  Cet article est consacr√© aux bases de la cr√©ation de syst√®mes d'√©v√©nements CQRS dans le langage PHP et dans le framework Laravel.  Il est suppos√© que vous connaissez le sch√©ma de d√©veloppement utilisant le bus de commande et que vous avez une id√©e des √©v√©nements (en particulier, la publication d'√©v√©nements pour un tableau d'√©couteurs).  Pour actualiser ces connaissances, vous pouvez utiliser le service Laracasts.  De plus, on suppose que vous avez une certaine compr√©hension du principe CQRS.  Sinon, je recommande fortement d'√©couter deux conf√©rences: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mathias Verraes Workshop on Event Generation</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Greg Young's CQRS and Event Generation</a> . <br><a name="habracut"></a><br>  N'utilisez pas le code donn√© ici dans vos projets!  Il s'agit d'une plateforme d'apprentissage pour comprendre les id√©es derri√®re le CQRS.  Ce code ne peut pas √™tre qualifi√© de fiable, il est mal test√© et, en outre, je programme rarement des interfaces, il sera donc beaucoup plus difficile de modifier des parties individuelles du code.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Broadway, d√©velopp√© par Qandidate Lab,</a> est un bien meilleur exemple de package CQRS que vous pouvez utiliser.  Il s'agit d'un code propre et faiblement coupl√©, cependant, certaines abstractions ne rendent pas tout √† fait clair si vous n'avez jamais rencontr√© de syst√®mes d'√©v√©nements. <br><br>  Et le dernier - mon code est li√© aux √©v√©nements et au bus de commande Laravel.  Je voulais voir √† quoi ressemblerait le code dans Laravel (j'utilise habituellement ce cadre pour des projets de petites agences), mais en y repensant, je pense que je devrais cr√©er mes propres impl√©mentations.  J'esp√®re que mon code sera clair m√™me pour ceux qui n'utilisent pas de frameworks. <br><br>  Sur github, le code est situ√© sur <a href="">https://github.com/scazz/cqrs-tutorial.git</a> , et dans notre guide, nous consid√©rerons ses composants pour augmenter la logique. <br><br>  Nous allons cr√©er un premier syst√®me d'inscription pour une √©cole de surf.  Avec son aide, les clients des √©coles peuvent s'inscrire aux cours.  Pour le processus d'enregistrement, nous formulons les r√®gles suivantes: <br><br><ul><li>  Chaque le√ßon doit avoir au moins un client ... </li><li>  ... mais pas plus de trois. </li></ul><br>  L'une des caract√©ristiques les plus impressionnantes des syst√®mes CQRS bas√©s sur les √©v√©nements est la cr√©ation de mod√®les de lecture sp√©cifiques √† chaque m√©trique requise du syst√®me.  Vous trouverez des exemples de projection de mod√®les de lecture dans ElasticSearch, et Greg Young a impl√©ment√© un langage orient√© sujet dans son magasin d'√©v√©nements pour g√©rer des √©v√©nements complexes.  Cependant, pour plus de simplicit√©, notre projection en lecture sera une base de donn√©es SQL standard √† utiliser avec Eloquent.  Par cons√©quent, nous aurons une table pour les classes et une pour les clients. <br><br>  Le concept de g√©n√©ration d'√©v√©nements vous permet √©galement de traiter des √©v√©nements hors ligne.  Mais dans cet article, j'adh√©rerai au maximum aux mod√®les de d√©veloppement ¬´traditionnels¬ª (encore une fois, pour simplifier), et nos projections de lecture seront mises √† jour en temps r√©el, imm√©diatement apr√®s le stockage des √©v√©nements dans le r√©f√©rentiel. <br><br><h2>  Configuration du projet et premier test </h2><br><pre><code class="plaintext hljs">git clone https://github.com/scazz/cqrs-tutorial</code> </pre> <br>  Cr√©er un nouveau projet Laravel 5 <br><br><pre> <code class="plaintext hljs">$&gt; laravel new cqrs-tutorial</code> </pre> <br>  Et pour commencer, nous avons besoin d'un test.  Nous utiliserons le test d'int√©gration, qui veillera √† ce que l'inscription d'un client aux cours m√®ne au fait que la le√ßon est cr√©√©e dans notre mod√®le Eloquent. <br><br>  Liste des tests / CQRSTest.php: <br><br><pre> <code class="plaintext hljs">use Illuminate\Foundation\Bus\DispatchesCommands; class CQRSTest extends TestCase { use DispatchesCommands;</code> </pre><br><pre> <code class="bash hljs">/** *  ,   BookLesson       * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> void */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span> = <span class="hljs-string"><span class="hljs-string">'123e4567-e89b-12d3-a456-426655440000'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertNotNull(Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)-&gt;clientName, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ); } }</code> </pre> <br>  Nous pr√©affectons la nouvelle activit√© √† un identifiant, cr√©ons une √©quipe pour vous inscrire √† une nouvelle activit√© et demandons √† Laravel de l'envoyer.  Dans le tableau des le√ßons, nous devons cr√©er un nouvel enregistrement que nous pouvons lire en utilisant le mod√®le Eloquent.  Nous avons besoin d'une base de donn√©es, alors remplissez correctement votre fichier .env. <br><br>  Chaque √©v√©nement enregistr√© dans notre magasin d'√©v√©nements s'attache √† la racine de l'agr√©gat, que nous appellerons simplement l'entit√© (Entit√©) - une abstraction √† des fins √©ducatives ne fait qu'ajouter √† la confusion.  ID est un identifiant unique universel (UUID).  Le magasin d'√©v√©nements ne se soucie pas si l'√©v√©nement s'applique √† la le√ßon ou au client.  Il sait seulement qu'il est associ√© √† une pi√®ce d'identit√©. <br><br>  Sur la base des erreurs identifi√©es lors des tests, nous pouvons cr√©er des classes manquantes.  Tout d'abord, nous allons cr√©er la classe LessonId, puis la commande BookLesson (ne vous inqui√©tez pas encore de la m√©thode du gestionnaire, continuez simplement d'ex√©cuter le test).  La classe Lesson est un mod√®le de lecture en dehors de l'espace de noms Lesson.  Un mod√®le de lecture exclusif - la logique du sujet ne sera jamais stock√©e ici.  En conclusion, nous devrons cr√©er une migration pour la table des le√ßons. <br><br>  Pour conserver la clart√© du code, j'utiliserai la biblioth√®que de v√©rification des assertions.  Il peut √™tre ajout√© avec la commande suivante: <br><br><pre> <code class="plaintext hljs">$&gt; composer require beberlei/assert</code> </pre> <br>  Consid√©rez le processus qui doit √™tre lanc√© par cette commande: <br><br><ol><li>  Validation: les commandes imp√©ratives peuvent √©chouer et des √©v√©nements ont d√©j√† eu lieu et ne devraient donc pas √©chouer. </li><li>  Cr√©ez un nouvel √©v√©nement LessonWasBooked (inscrit √† une le√ßon). </li><li>  Mettez √† jour l'√©tat de l'activit√©.  (Le mod√®le d'enregistrement doit conna√Ætre l'√©tat du mod√®le pour pouvoir effectuer la validation.) </li><li>  Ajoutez cet √©v√©nement au flux d'√©v√©nements non valid√©s stock√©s dans le mod√®le d'enregistrement d'activit√©. </li><li>  Enregistrez le flux d'√©v√©nements non valid√©s dans le r√©f√©rentiel. </li><li>  D√©clenchez l'√©v√©nement LessonWasBooked globalement pour informer tous les projecteurs de lecture de mettre √† jour la table des cours. </li></ol><br>  Vous devez d'abord cr√©er un mod√®le d'enregistrement pour la le√ßon.  Nous utiliserons la m√©thode d'usine statique <code>Lesson::bookClientOntoNewLesson()</code> .  Il g√©n√®re un nouvel √©v√©nement <code>LessonWasOpened</code> (la le√ßon est ouverte), applique cet √©v√©nement √† lui-m√™me (d√©finit simplement son ID), ajoute le nouvel √©v√©nement √† la liste des √©v√©nements non <code>DomainEventMessage</code> sous la forme de <code>DomainEventMessage</code> (l'√©v√©nement plus quelques m√©tadonn√©es que nous utilisons lors de l'enregistrement dans le magasin d'√©v√©nements). <br><br>  Le processus est r√©p√©t√© pour ajouter un client √† l'√©v√©nement.  Lors de l'application de l'√©v√©nement <code>ClientWasBookedOntoLesson</code> (le client √©tait inscrit √† la le√ßon), le mod√®le d'enregistrement ne suit pas les noms des clients, mais uniquement le nombre de clients enregistr√©s.  Les mod√®les d'enregistrement n'ont pas besoin de conna√Ætre les noms des clients pour garantir la coh√©rence. <br><br>  Les m√©thodes <code>applyLessonWasOpened</code> et <code>applyClientWasBookedOntoLesson</code> peuvent sembler un peu √©tranges en <code>applyClientWasBookedOntoLesson</code> moment.  Nous les utiliserons plus tard lorsque nous aurons besoin de reproduire d'anciens √©v√©nements afin de former l'√©tat du mod√®le d'enregistrement.  Ce n'est pas facile √† expliquer, donc je vais vous donner un code qui vous aidera √† comprendre ce processus.  Plus tard, nous allons extraire le code qui traite les √©v√©nements non valid√©s et g√©n√®re des messages d'√©v√©nement de domaine. <br><br><pre> <code class="bash hljs">app/School/Lesson/Lesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> openLesson( LessonId <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ) { /*      ,      ,       */ <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new LessonWasOpened( <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); } protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients = 0; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> bookClient( <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients &gt;= 3) { throw new TooManyClientsAddedToLesson(); } <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new ClientBookedOntoLesson( <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>) ); } /** *       ‚Äî *  ,       *      ,       , *      . */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyClientBookedOntoLesson( ClientBookedOntoLesson <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients++; }</code> </pre> <br>  Nous pouvons extraire les composants CQRS de notre mod√®le d'enregistrement - fragments de la classe impliqu√©s dans le traitement des √©v√©nements non valid√©s.  Nous pouvons √©galement effacer l'API d'une entit√© g√©n√©r√©e par √©v√©nement en cr√©ant une fonction secure <code>apply()</code> qui accepte l'√©v√©nement, appelle la m√©thode <code>applyEventName()</code> correspondante et ajoute un nouvel √©v√©nement <code>DomainEventMessage</code> √† la liste des √©v√©nements non <code>DomainEventMessage</code> .  La classe extraite est un d√©tail de l'impl√©mentation CQRS et ne contient pas de logique de domaine, nous pouvons donc cr√©er un nouvel espace de noms: App \ CQRS: <br><br>  <i>Faites attention au code <code>app/CQRS/EventSourcedEntity.php</code></i> <i><br></i>  <i>Pour que le code fonctionne, nous devons ajouter la classe <code>DomainEventMessage</code> , qui est un simple DTO - elle peut √™tre trouv√©e dans <code>app/CQRS/DomainEventMessage.php</code></i> <br><br>  Ainsi, nous avons un syst√®me qui g√©n√®re des √©v√©nements pour chaque tentative d'√©criture et utilise des √©v√©nements pour enregistrer les changements n√©cessaires pour emp√™cher les invariants.  L'√©tape suivante consiste √† enregistrer ces √©v√©nements dans le magasin (EventStore).  Tout d'abord, ce r√©f√©rentiel d'√©v√©nements doit √™tre cr√©√©.  Pour simplifier, nous utiliserons le mod√®le Eloquent, une simple table SQL avec les champs suivants: * <code>UUID</code> (pour savoir √† quelle entit√© appliquer l'√©v√©nement) * <code>event_payload</code> (message s√©rialis√© contenant tout le n√©cessaire pour recr√©er l'√©v√©nement) * <code>event_payload</code> - horodatage pour savoir quand l'√©v√©nement arriv√©.  Si vous examinez attentivement le code, vous verrez que j'ai cr√©√© deux commandes - pour cr√©er et d√©truire notre table de stockage d'√©v√©nements: <br><br><ul><li>  php artisan eloquenteventstore: cr√©er (App \ CQRS \ EloquentEventStore \ CreateEloquentEventStore) </li><li>  php artisan eloquenteventstore: drop (App \ CQRS \ EloquentEventStore \ DropEloquentEventStore) (n'oubliez pas de les ajouter √† App \ Console \ Kernel.php pour qu'ils se chargent). </li></ul><br>  Il y a deux tr√®s bonnes raisons de ne pas utiliser SQL comme magasin d'√©v√©nements: il n'impl√©mente pas le mod√®le d'ajout uniquement (uniquement l'ajout de donn√©es, les √©v√©nements doivent √™tre immuables), et aussi parce que SQL n'est pas un langage de requ√™te id√©al pour les bases de donn√©es temporelles.  Nous programmons l'interface pour faciliter le remplacement du magasin d'√©v√©nements dans les publications suivantes. <br><br>  Pour enregistrer des √©v√©nements, utilisez le r√©f√©rentiel.  Chaque fois que <code>save()</code> est appel√© pour le mod√®le d'enregistrement, nous enregistrons la liste uncommittedEvents dans le magasin d'√©v√©nements.  Pour stocker des √©v√©nements, nous avons besoin d'un m√©canisme pour leur s√©rialisation et leur d√©s√©rialisation.  Cr√©ez un s√©rialiseur pour cela.  Nous aurons besoin de m√©tadonn√©es, telles qu'une classe d'√©v√©nements (par exemple, <code>App\School\Lesson\Events\LessonWasOpened</code> ) et une charge utile d'√©v√©nement (donn√©es n√©cessaires pour reconstruire un √©v√©nement). <br><br>  Tout cela sera encod√© au format JSON, puis √©crit dans notre base de donn√©es avec l'UUID et l'horodatage de l'entit√©.  Nous voulons mettre √† jour nos mod√®les de lecture apr√®s la capture des √©v√©nements, de sorte que le r√©f√©rentiel d√©clenchera chaque √©v√©nement apr√®s l'enregistrement.  Le s√©rialiseur sera responsable de l'√©criture de la classe d'√©v√©nements, tandis que l'√©v√©nement sera responsable de la s√©rialisation de sa charge utile.  Un √©v√©nement enti√®rement s√©rialis√© ressemblera √† ceci: <br><br><pre> <code class="plaintext hljs"> { class: "App\\School\\Lesson\\Events\\", event: $event-&gt;serialize() }</code> </pre> <br>  √âtant donn√© que tous les √©v√©nements n√©cessitent une m√©thode de s√©rialisation et de d√©s√©rialisation, nous pouvons cr√©er une interface <code>SerializableEvent</code> et ajouter une indication du type de valeur attendue.  Mettez √† jour notre √©v√©nement <code>LessonWasOpened</code> : <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php class LessonWasOpened implements SerializableEvent { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'lessonId'</span></span>=&gt; (string) <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getLessonId() ); } }</code> </pre> <br>  Cr√©ez un r√©f√©rentiel <code>LessonRepository</code> .  Nous pouvons refactoriser et extraire les composants CQRS de base plus tard. <br><br> <code>app/School/Lesson/LessonRepository.php</code> <br> <pre> <code class="plaintext hljs">eventStoreRepository = new EloquentEventStoreRepository( new EventSerializer() ); } public function save(Lesson $lesson) { /** @var DomainEventMessage $domainEventMessage */ foreach( $lesson-&gt;getUncommittedDomainEvents() as $domainEventMessage ) { $this-&gt;eventStoreRepository-&gt;append( $domainEventMessage-&gt;getId(), $domainEventMessage-&gt;getEvent(), $domainEventMessage-&gt;getRecordedAt() ); Event::fire($domainEventMessage-&gt;getEvent()); } } }</code> </pre> <br>  Si vous ex√©cutez √† nouveau le test d'int√©gration, puis v√©rifiez la <code>domain_events</code> SQL <code>domain_events</code> , vous devriez voir deux √©v√©nements dans la base de donn√©es. <br><br>  Notre derni√®re √©tape pour r√©ussir le test est d'√©couter les √©v√©nements diffus√©s et de mettre √† jour la projection du mod√®le de lecture de la le√ßon.  Les √©v√©nements de diffusion de le√ßon seront intercept√©s par le <code>LessonProjector</code> , qui appliquera les modifications n√©cessaires √† <code>LessonProjection</code> (mod√®les √©loquents du tableau de le√ßon): <br><br><pre> <code class="bash hljs"> app/School/Lesson/Projections/LessonProjector.php class LessonProjector { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span> = new LessonProjection(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;id = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;save(); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> subscribe(Dispatcher <span class="hljs-variable"><span class="hljs-variable">$events</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span> = self::class; <span class="hljs-variable"><span class="hljs-variable">$events</span></span>-&gt;listen( LessonWasOpened::class, <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span>.<span class="hljs-string"><span class="hljs-string">'@applyLessonWasOpened'</span></span>); } }  app/School/Lesson/Projections/LessonProjection.php class LessonProjection extends Model { public <span class="hljs-variable"><span class="hljs-variable">$timestamps</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; protected <span class="hljs-variable"><span class="hljs-variable">$table</span></span> = <span class="hljs-string"><span class="hljs-string">"lessons"</span></span>; }</code> </pre> <br>  Si vous ex√©cutez le test, vous verrez qu'une erreur SQL s'est produite: <br><br><pre> <code class="plaintext hljs">Unknown column 'clientName' in 'field list'</code> </pre> <br>  D√®s que nous cr√©erons une migration pour ajouter <code>clientName</code> √† la table de cours, nous r√©ussirons le test.  Nous avons impl√©ment√© la fonctionnalit√© de base du CQRS: les √©quipes cr√©ent des √©v√©nements qui sont utilis√©s pour g√©n√©rer des mod√®les de lecture. <br><br><h2>  Am√©lioration du mod√®le de lecture avec des liens </h2><br>  Nous avons franchi une √©tape importante, mais ce n'est pas tout!  Jusqu'√† pr√©sent, le mod√®le de lecture ne prend en charge qu'un seul client (nous en avons sp√©cifi√© trois dans nos r√®gles de domaine).  Les modifications que nous apportons au mod√®le de lecture sont assez simples: nous cr√©ons simplement un mod√®le de projection Client et un <code>ClientProjector</code> qui <code>ClientBookedOntoLesson</code> √©v√©nement <code>ClientBookedOntoLesson</code> .  Tout d'abord, nous mettons √† jour notre test pour refl√©ter les changements que nous voulons voir dans notre mod√®le de lecture: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;id, (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$client</span></span> = <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients()-&gt;first(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>-&gt;name, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); }</code> </pre><br>  Il s'agit d'une d√©monstration claire de la facilit√© avec laquelle il est possible de changer de mod√®le de lecture.  Tout, jusqu'au r√©f√©rentiel d'√©v√©nements, reste inchang√©.  En prime, lorsque nous utilisons le syst√®me d'√©v√©nements, nous obtenons des donn√©es pour les tests de base - lors du changement du projecteur du mod√®le de lecture, nous √©coutons chaque √©v√©nement qui s'est jamais produit dans notre syst√®me. <br><br>  Nous reproduisons ces √©v√©nements √† l'aide du nouveau projecteur, v√©rifions les exceptions et comparons les r√©sultats avec les projections pr√©c√©dentes.  Apr√®s que le syst√®me fonctionne depuis un certain temps, nous aurons une s√©lection assez repr√©sentative d'√©v√©nements pour tester nos projecteurs. <br><br>  Notre mod√®le d'enregistrement n'a actuellement pas la capacit√© de charger l'√©tat actuel.  Si nous voulons ajouter un deuxi√®me client √† la le√ßon, nous pouvons simplement cr√©er un deuxi√®me √©v√©nement ClientWasAddedToLesson, mais nous ne pouvons pas fournir de protection contre les invariants.  Pour plus de clart√©, je propose d'√©crire un deuxi√®me test simulant l'enregistrement de deux clients par le√ßon. <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLoadingWriteModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span> = <span class="hljs-string"><span class="hljs-string">"Fred"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); }</code> </pre> <br>  Pour notre mod√®le d'enregistrement, nous devons impl√©menter une m√©thode de ¬´chargement¬ª d'une entit√© pour laquelle des √©v√©nements lui sont d√©j√† appliqu√©s dans le magasin d'√©v√©nements.  Nous pouvons y parvenir en lisant chaque √©v√©nement faisant r√©f√©rence √† l'UUID de l'entit√©.  De mani√®re g√©n√©rale, le processus est le suivant: <br><br><ol><li>  Nous recevons tous les messages d'√©v√©nements pertinents de la boutique d'√©v√©nements. </li><li>  Pour chaque message, nous recr√©ons l'√©v√©nement correspondant. </li><li>  Nous cr√©ons un nouveau mod√®le d'enregistrement d'entit√© et lisons chaque √©v√©nement. </li></ol><br>  Pour le moment, nos tests g√©n√®rent des exceptions, nous allons donc commencer par cr√©er la <code>BookClientOntoLesson</code> n√©cessaire (enregistrer un client pour la le√ßon), en utilisant la commande <code>BookLesson</code> comme mod√®le.  La m√©thode du gestionnaire ressemblera √† ceci: <br><br><pre> <code class="bash hljs"> app/School/Lesson/Commands/BookClientOntoLesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handle(LessonRepository <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>) { /** @var Lesson <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> */ <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;bookClient(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;clientName); <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>); }      : app/School/Lesson/LessonRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(LessonId <span class="hljs-variable"><span class="hljs-variable">$id</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventStoreRepository-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$id</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = new Lesson(); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;initializeState(<span class="hljs-variable"><span class="hljs-variable">$events</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>; }</code> </pre> <br>  La fonction de chargement du r√©f√©rentiel renvoie un tableau d'√©v√©nements recr√©√©s.  Pour ce faire, elle trouve d'abord des messages sur les √©v√©nements dans le r√©f√©rentiel, puis les transmet au <code>Serializer</code> pour convertir chaque message en √©v√©nement.  <code>Serializer</code> cr√©e des messages √† partir d'√©v√©nements, nous devons donc ajouter la m√©thode <code>deserialize()</code> pour effectuer la transformation inverse.  Rappelez-vous que le <code>Serializer</code> est transmis √† chaque √©v√©nement pour s√©rialiser les donn√©es d'√©v√©nement (par exemple, le nom du client).  Nous ferons de m√™me pour effectuer la transformation inverse, tandis que notre interface <code>SerializableEvent</code> doit √™tre mise √† jour √† l'aide de la m√©thode <code>deserialize()</code> .  Regardons le code pour que tout se mette en place.  Le premier est la <code>EventStoreRepository</code> chargement <code>EventStoreRepository</code> : <br><br><pre> <code class="bash hljs">app/CQRS/EloquentEventStore/EloquentEventStoreRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(<span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> = EloquentEventStoreModel::<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-string"><span class="hljs-string">'uuid'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>)-&gt;get(); <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = []; foreach(<span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> as <span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>) { /*       event_payload,        . */ <span class="hljs-variable"><span class="hljs-variable">$events</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventSerializer-&gt;deserialize( json_decode(<span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>-&gt;event_payload)); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$events</span></span>; }</code> </pre><br>  Utilisation de la fonction de d√©s√©rialisation appropri√©e dans <code>eventSerializer</code> : <br><br><pre> <code class="bash hljs">app/CQRS/Serializer/EventSerializer.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> serialize( SerializableEvent <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; get_class(<span class="hljs-variable"><span class="hljs-variable">$event</span></span>), <span class="hljs-string"><span class="hljs-string">'payload'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;serialize() ); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize( <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;class; <span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;payload; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span>::deserialize(<span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span>); }</code> </pre> <br>  En conclusion, nous utiliserons la m√©thode d'usine statique <code>LessonWasOpened</code> ( <code>deserialize()</code> dans <code>LessonWasOpened</code> (nous devons ajouter cette m√©thode √† chaque √©v√©nement) <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php public static <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>-&gt;lessonId); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new self(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); }</code> </pre> <br>  Nous avons maintenant un tableau de tous les √©v√©nements que nous venons de reproduire par rapport √† notre mod√®le d'enregistrement d'entit√© pour initialiser l'√©tat dans la m√©thode <code>initializeState</code> dans <code>app/CQRS/EventSouredEntity.php</code> <br><br>  Maintenant, lancez notre test.  Bingo! <br>  En fait, pour le moment, nous n'avons pas de test pour v√©rifier la conformit√© avec nos r√®gles de domaine, alors √©crivons-le: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMoreThan3ClientsCannotBeAddedToALesson</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"george"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"fred"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;setExpectedException( TooManyClientsAddedToLesson::class ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"emma"</span></span>) ); }</code> </pre> <br>  Veuillez noter que nous n'avons besoin que de <code>lessonId</code> - ce test r√©initialise l'√©tat de la le√ßon lors de chaque commande. <br><br>  Pour le moment, nous transf√©rons simplement les <code>UUID</code> cr√©√©s manuellement, alors qu'en r√©alit√© nous voulons les g√©n√©rer automatiquement.  Je vais utiliser le <code>Ramsy\UUID</code> , alors installons-le avec <code>composer</code> : <br><br><pre> <code class="plaintext hljs">$&gt; composer require ramsey/uuid</code> </pre> <br>  Maintenant, mettez √† jour nos tests pour utiliser le nouveau package: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEntityCreationWithUUIDGenerator</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertInstanceOf( Lesson::class, Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); }</code> </pre><br>  Maintenant, le nouveau d√©veloppeur de projet peut consulter le code, voir <code>App\School\ReadModels</code> , qui contient un ensemble de mod√®les Eloquent, et utiliser ces mod√®les pour √©crire des modifications dans le tableau des le√ßons.  Nous pouvons √©viter cela en cr√©ant une classe <code>ImmutableModel</code> qui √©tend la classe Eloquent Model et remplace la m√©thode save dans <code>app/CQRS/ReadModelImmutableModel.php</code> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461899/">https://habr.com/ru/post/fr461899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461885/index.html">EDS est un autre type de fraude</a></li>
<li><a href="../fr461887/index.html">Entr√©e dans Aeronet Episode 2: Homing Drone</a></li>
<li><a href="../fr461891/index.html">Comment nous nous sommes fait des amis dans l'infrastructure bancaire √† l'aide de ManageIQ</a></li>
<li><a href="../fr461895/index.html">Apprenez en voyage - comment nous avons conduit lors de la premi√®re journ√©e europ√©enne de l'analyse commerciale</a></li>
<li><a href="../fr461897/index.html">Comment nous maintenons la stabilit√© de l'application Lamoda</a></li>
<li><a href="../fr461901/index.html">Trois ans d'autotests: comment augmenter la vitesse et pas seulement</a></li>
<li><a href="../fr461903/index.html">Adversaire myst√©rieux: emprunts flous</a></li>
<li><a href="../fr461905/index.html">Tic Tac Toe, partie 7: pytest et Travis CI</a></li>
<li><a href="../fr461907/index.html">Analyse de produits dans un studio √† cycle complet</a></li>
<li><a href="../fr461913/index.html">Utilisation mobile dans le commerce √©lectronique: analyse des TOP-20 boutiques en ligne en Russie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>