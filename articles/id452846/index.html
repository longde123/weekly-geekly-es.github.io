<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèæ üßúüèΩ ü§≤üèº Bagaimana kami membangun cluster PostgreSQL yang andal di Patroni ‚òÅÔ∏è üëäüèª üëèüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saat ini, ketersediaan layanan yang tinggi diperlukan selalu dan di mana-mana, tidak hanya dalam proyek besar yang mahal. Situs sementara tidak tersed...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana kami membangun cluster PostgreSQL yang andal di Patroni</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/452846/"><img src="https://habrastorage.org/getpro/habr/post_images/17a/6e9/29d/17a6e929d3e8e24203871d573b17ef0d.jpg"><br><br>  Saat ini, ketersediaan layanan yang tinggi diperlukan selalu dan di mana-mana, tidak hanya dalam proyek besar yang mahal.  Situs sementara tidak tersedia dengan pesan "Maaf, pemeliharaan sedang dilakukan" masih terjadi, tetapi biasanya menyebabkan senyum merendahkan.  Tambahkan ke kehidupan ini di awan, ketika memulai server tambahan Anda hanya perlu satu panggilan ke API, dan Anda tidak perlu memikirkan operasi "besi".  Dan tidak ada lagi alasan mengapa sistem kritis tidak dibuat andal menggunakan teknologi cluster dan redundansi. <br><br>  Kami akan memberi tahu Anda solusi apa yang kami pertimbangkan untuk memastikan keandalan basis data dalam layanan kami dan apa yang kami tuju.  Ditambah demo dengan kesimpulan yang luas. <br><a name="habracut"></a><br><h2>  Warisan dalam arsitektur ketersediaan tinggi </h2><br>  Ini bahkan lebih baik dilihat dalam konteks pengembangan berbagai sistem sumber terbuka.  Solusi lama terpaksa menambahkan teknologi ketersediaan tinggi karena permintaan meningkat.  Dan kualitas mereka berbeda.  Solusi generasi mendatang menempatkan ketersediaan tinggi di inti arsitektur mereka.  Sebagai contoh, MongoDB memposisikan cluster sebagai use case utama.  Cluster berskala horizontal, yang merupakan keunggulan kompetitif yang kuat dari DBMS ini. <br><br>  Kembali ke PostgreSQL.  Ini adalah salah satu proyek opensource populer tertua, rilis pertama yang berlangsung pada tahun ke-95 abad terakhir.  Untuk waktu yang lama, tim proyek tidak menganggap ketersediaan tinggi sebagai tugas yang perlu ditangani oleh sistem.  Oleh karena itu, teknologi replikasi untuk membuat salinan data menjadi terintegrasi hanya dalam versi 8.2 pada tahun 2006, tetapi diajukan (pengiriman log).  Pada 2010, replikasi streaming muncul di versi 9.0, dan itu adalah dasar untuk membuat berbagai kluster.  Ini, pada kenyataannya, sangat mengejutkan bagi orang-orang yang mengenal PostgreSQL setelah Enterprise SQL atau NoSQL modern - solusi standar dari komunitas hanyalah beberapa master-replika dengan replikasi sinkron atau asinkron.  Pada saat yang sama, wizard diaktifkan secara manual di saluran, dan masalah berpindah klien juga diusulkan untuk diselesaikan secara mandiri. <br><br><h2>  Bagaimana kami memutuskan untuk membuat PostgreSQL yang andal dan apa yang kami pilih untuk ini </h2><br>  Namun, PostgreSQL tidak akan menjadi begitu populer jika tidak ada banyak proyek dan alat yang membantu membangun solusi toleran kesalahan yang tidak memerlukan perhatian terus-menerus.  Sejak peluncuran DBaaS, satu server PostgreSQL dan pasangan master replika dengan replikasi asinkron telah tersedia di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mail.ru Cloud Solutions</a> (MCS). <br><br>  Secara alami, kami ingin menyederhanakan kehidupan semua orang dan membuat instalasi PostgreSQL tersedia, yang dapat berfungsi sebagai dasar untuk layanan yang sangat mudah diakses yang Anda tidak harus terus memantau dan bangun di malam hari untuk beralih.  Di segmen ini ada solusi lama terbukti dan generasi utilitas baru yang menggunakan perkembangan terbaru. <br><br>  Saat ini, masalah ketersediaan tinggi tidak bergantung pada redundansi (tidak perlu dikatakan lagi), tetapi pada konsensus - sebuah algoritma untuk memilih pemimpin (pemilihan Pemimpin).  Paling sering, kecelakaan besar terjadi bukan karena kurangnya server, tetapi karena masalah dengan konsensus: pemimpin baru tidak keluar, dua pemimpin muncul di pusat data yang berbeda, dll.  Contohnya adalah crash pada cluster Github MySQL - mereka menulis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">post mortem yang terperinci</a> . <br><br>  Basis matematika dalam hal ini sangat serius.  Di satu sisi, ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">teorema CAP</a> , yang memaksakan pembatasan teoritis pada kemungkinan membangun solusi HA, dan di sisi lain, algoritma penentuan konsensus yang terbukti secara matematis seperti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Paxos</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Raft</a> .  Atas dasar ini, ada DCS yang cukup populer (sistem konsensus desentralisasi) - Zookeeper, etcd, Consul.  Karena itu, jika sistem pengambilan keputusan bekerja pada beberapa algoritmanya sendiri, ditulis secara independen, Anda harus sangat berhati-hati mengenai hal itu.  Setelah menganalisis sejumlah besar sistem, kami memilih Patroni - sistem sumber terbuka, terutama dikembangkan oleh Zalando. <br><br>  Sebagai penyimpangan liris, saya akan mengatakan bahwa kami juga mempertimbangkan solusi multi-master, yaitu, cluster yang dapat diskalakan secara horizontal ke rekaman.  Namun, karena dua alasan utama, mereka memutuskan untuk tidak membuat cluster seperti itu.  Pertama, solusi tersebut memiliki kompleksitas tinggi dan, karenanya, lebih banyak kerentanan.  Akan sulit untuk membuat keputusan yang stabil untuk semua kasus.  Kedua, dalam hal ini, PostgreSQL tidak lagi murni (asli), beberapa fungsi tidak akan tersedia, beberapa aplikasi mungkin mengalami bug tersembunyi ketika bekerja. <br><br><h2>  Patroni </h2><br>  Jadi bagaimana cara kerja Patroni?  Pengembang tidak menemukan kembali roda dan menyarankan menggunakan salah satu solusi DCS yang terbukti sebagai dasar.  Semua masalah dengan sinkronisasi konfigurasi, pilihan pemimpin dan kuorum diberikan kepadanya.  Kami telah memilih etcd untuk ini. <br><br>  Kemudian Patroni berurusan dengan aplikasi yang benar dari semua pengaturan pada PostgreSQL dan pengaturan replikasi, serta eksekusi perintah pada switchover dan failover (yaitu, penyihir switching biasa dan non-standar).  Secara khusus, di cloud MCS, Anda dapat membuat cluster dari wizard, replika sinkron, dan satu atau lebih replika asinkron.  Kehadiran replika sinkron memastikan keamanan data pada setidaknya 2 server, dan replika ini akan menjadi "kandidat utama master." <br><br>  Karena etcd digunakan pada server yang sama, disarankan agar jumlah server menjadi 3 atau 5, untuk nilai kuorum optimal.  Cluster seperti ini diskalakan secara horizontal untuk membaca (saya menulis tentang penskalaan untuk penulisan di atas).  Namun demikian, harus diingat bahwa replika asinkron tertinggal, terutama pada beban tinggi. <br><br>  Penggunaan replika siaga baca semacam itu dibenarkan untuk melaporkan atau menganalisis tugas dan menurunkan server master. <br><br>  Jika Anda ingin membuat cluster sendiri, maka Anda perlu: <br><br><ul><li>  menyiapkan 3 atau lebih server, mengkonfigurasi alamat IP dan aturan firewall di antara mereka; <br></li><li>  instal paket untuk layanan etcd, Patroni, PostgreSQL; <br></li><li>  mengkonfigurasi etcd cluster; <br></li><li>  konfigurasikan layanan patroni agar berfungsi dengan PostgreSQL. <br></li></ul><br>  Secara total, Anda harus membuat lusinan file konfigurasi dengan benar dan tidak membuat kesalahan di mana pun.  Untuk melakukan ini, tentu saja layak menggunakan alat manajemen konfigurasi seperti Ansible, misalnya.  Namun, masih belum ada penyeimbang TCP yang sangat tersedia.  Melakukannya adalah pekerjaan terpisah. <br><br>  Bagi mereka yang membutuhkan cluster siap pakai, tetapi tidak ingin mengotak-atik semua ini, kami mencoba menyederhanakan hidup kami dan membuat cluster siap pakai di Patroni di cloud kami, itu dapat diuji secara gratis.  Selain cluster itu sendiri, kami melakukan: <br><br><ul><li>  Penyeimbang TCP  pada port yang berbeda, masing-masing selalu menunjuk ke replika master, sinkron atau asinkron, masing-masing; <br></li><li>  API untuk mengganti wizard Patroni aktif. <br></li></ul><br>  Mereka dapat dihubungkan baik melalui MCS cloud API dan konsol web. <br><br><h2>  Demo </h2><br>  Untuk menguji kemampuan cluster PostgreSQL di cloud MCS, mari kita lihat bagaimana aplikasi live berperilaku jika ada masalah dengan DBMS. <br><br>  Berikut ini adalah kode untuk aplikasi yang akan mencatat peristiwa buatan dan melaporkannya ke layar.  Jika terjadi kesalahan, ia akan melaporkan ini dan melanjutkan kerjanya dalam siklus hingga kami menghentikannya dengan kombinasi Ctrl + C. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __future__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_function <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> random <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> randint <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sleep <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: connection = psycopg2.connect(user = <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, password = <span class="hljs-string"><span class="hljs-string">"P@ssw0rd"</span></span>, host = <span class="hljs-string"><span class="hljs-string">"89.208.87.38"</span></span>, port = <span class="hljs-string"><span class="hljs-string">"5432"</span></span>, database = <span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>) cursor = connection.cursor() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT version();"</span></span>) record = cursor.fetchone() print(<span class="hljs-string"><span class="hljs-string">"Connection opened to"</span></span>, record[<span class="hljs-number"><span class="hljs-number">0</span></span>]) cursor.execute( <span class="hljs-string"><span class="hljs-string">"INSERT INTO log VALUES ({});"</span></span>.format(randint(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>))) connection.commit() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT COUNT(event_id) from log;"</span></span>) record = cursor.fetchone() print(<span class="hljs-string"><span class="hljs-string">"Logged a value, overall count: {}"</span></span>.format(record[<span class="hljs-number"><span class="hljs-number">0</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> error: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"Error while connecting to PostgreSQL"</span></span>, error) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> connection: cursor.close() connection.close() print(<span class="hljs-string"><span class="hljs-string">"Connection closed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(datetime.now()) main() sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(<span class="hljs-string"><span class="hljs-string">"Caught error:\n"</span></span>, e) sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: print(<span class="hljs-string"><span class="hljs-string">"exit"</span></span>)</code> </pre> <br>  Aplikasi membutuhkan PostgreSQL agar berfungsi.  Buat cluster di cloud MCS menggunakan API.  Di terminal reguler, tempat variabel OS_TOKEN berisi token untuk mengakses API (Anda bisa mendapatkannya dengan perintah openstack token issue), kami mengetikkan perintah: <br><br>  Buat sebuah kluster: <br><br><pre> <code class="bash hljs">cat &lt;&lt;EF &gt; pgc10.json {<span class="hljs-string"><span class="hljs-string">"cluster"</span></span>:{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"postgres10"</span></span>,<span class="hljs-string"><span class="hljs-string">"allow_remote_access"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-string"><span class="hljs-string">"datastore"</span></span>:{<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"postgresql"</span></span>,<span class="hljs-string"><span class="hljs-string">"version"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>},<span class="hljs-string"><span class="hljs-string">"databases"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>}],<span class="hljs-string"><span class="hljs-string">"users"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"databases"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>}],<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>,<span class="hljs-string"><span class="hljs-string">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"P@ssw0rd"</span></span>}],<span class="hljs-string"><span class="hljs-string">"instances"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}},{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}},{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}}]}} EOF curl -s -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OS_TOKEN</span></span></span><span class="hljs-string">"</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Accept: application/json'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> \ -d @pgc10.json https://infra.mail.ru:8779/v1.0/ce2a41bbd1434013b85bdf0ba07c770f/clusters</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/f2c/aee/463/f2caee46351a0f304dac92483739a3c5.png"><br><br>  Ketika cluster memasuki status AKTIF, semua bidang akan menerima nilai saat ini - cluster siap. <br><br>  Di GUI: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b2/0de/606/8b20de6065c6c703282c27f96a67724f.png"><br><br>  Mari kita coba sambungkan dan buat tabel: <br><br><pre> <code class="bash hljs">psql -h 89.208.87.38 -U admin -d myproddb Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user admin: psql (11.1, server 10.7) Type <span class="hljs-string"><span class="hljs-string">"help"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>. myproddb=&gt; CREATE TABLE <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> (event_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> NOT NULL); CREATE TABLE myproddb=&gt; INSERT INTO <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> VALUES (1),(2),(3); INSERT 0 3 myproddb=&gt; SELECT * FROM <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>; event_id ---------- 1 2 3 (3 rows) myproddb=&gt;</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/e04/c3f/7df/e04c3f7dfae02ca66e1f4163eb5b52d0.png"><br><br>  Dalam aplikasi, kami menunjukkan pengaturan saat ini untuk menghubungkan ke PostgreSQL.  Kami akan menentukan alamat penyeimbang TCP, sehingga menghilangkan kebutuhan untuk beralih secara manual ke alamat penyihir.  Jalankan itu.  Seperti yang Anda lihat, peristiwa-peristiwa tersebut berhasil masuk ke dalam basis data. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e37/fd2/33c/e37fd233cc670185c6da974e8ef54f9f.png"><br><br><h2>  Sakelar master terjadwal </h2><br>  Sekarang kita akan menguji operasi aplikasi kita selama perpindahan wizard yang direncanakan: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0d4/7de/e5d/0d47dee5d56f84efe7ade9790a219c8f.png"><br><br>  Kami sedang menonton aplikasi.  Kami melihat bahwa aplikasi ini benar-benar terganggu, tetapi hanya perlu beberapa detik, dalam kasus khusus ini, maksimum 9. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a52/d80/a34/a52d80a34309b6a0e771ca01a722a448.png"><br><br><h2>  Mobil jatuh </h2><br>  Sekarang mari kita coba mensimulasikan kejatuhan mesin virtual, master saat ini.  Mungkin saja mematikan mesin virtual melalui antarmuka Horizon, hanya saja itu akan menjadi shutdown biasa.  Switch semacam itu akan diproses oleh semua layanan, termasuk Patroni. <br><br>  Kami membutuhkan shutdown yang tidak terduga.  Oleh karena itu, saya meminta administrator kami untuk tujuan pengujian mematikan mesin virtual - master saat ini - dengan cara yang tidak normal. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/101/231/8c8/1012318c85c30c4717e6db5df430afc3.png"><br><br>  Pada saat yang sama, aplikasi kami terus bekerja.  Secara alami, sakelar darurat master seperti itu tidak dapat lewat tanpa diketahui. <br><br><pre> <code class="bash hljs">2019-03-29 10:45:56.071234 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 453 Connection closed 2019-03-29 10:45:59.205463 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 454 Connection closed 2019-03-29 10:46:02.661440 Error <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connecting to PostgreSQL server closed the connection unexpectedly This probably means the server terminated abnormally before or <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> processing the request. Caught error: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> variable <span class="hljs-string"><span class="hljs-string">'connection'</span></span> referenced before assignment ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.. -  -   2019-03-29 10:46:30.930445 Error <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connecting to PostgreSQL server closed the connection unexpectedly This probably means the server terminated abnormally before or <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> processing the request. Caught error: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> variable <span class="hljs-string"><span class="hljs-string">'connection'</span></span> referenced before assignment 2019-03-29 10:46:31.954399 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 455 Connection closed 2019-03-29 10:46:35.409800 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 456 Connection closed ^Cexit</code> </pre><br>  Seperti yang Anda lihat, aplikasi dapat melanjutkan pekerjaannya dalam waktu kurang dari 30 detik.  Ya, sejumlah pengguna layanan tertentu akan memiliki waktu untuk melihat masalah.  Namun, ini adalah kegagalan server yang serius, ini tidak terjadi begitu sering.  Pada saat yang sama, orang (administrator) akan sulit bereaksi dengan cepat, kecuali dia sedang duduk di konsol siap dengan skrip switching. <br><br><h2>  Kesimpulan </h2><br>  Tampak bagi saya bahwa cluster seperti itu memberikan keuntungan luar biasa bagi administrator.  Bahkan, gangguan serius dan malfungsi server database tidak akan terlihat untuk aplikasi dan, oleh karena itu, untuk pengguna.  Anda tidak perlu memperbaiki sesuatu dengan tergesa-gesa dan beralih ke konfigurasi sementara, server, dll.  Dan jika Anda menggunakan solusi ini dalam bentuk layanan siap pakai di cloud, maka Anda tidak perlu membuang waktu untuk menyiapkannya.  Dimungkinkan untuk melakukan sesuatu yang lebih menarik. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id452846/">https://habr.com/ru/post/id452846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id452836/index.html">Alat web, atau di mana memulai pentester?</a></li>
<li><a href="../id452838/index.html">Integrasi 3CX dengan Office 365 melalui Azure API</a></li>
<li><a href="../id452840/index.html">Konferensi VMware EMPOWER 2019: bagaimana hari pertama</a></li>
<li><a href="../id452842/index.html">SMPP - Protokol Pesan Singkat Teman Sebaya</a></li>
<li><a href="../id452844/index.html">Transformasi atau kata-kata kotor: cara "mendigitalkan" operator telekomunikasi</a></li>
<li><a href="../id452848/index.html">Apa yang akan terjadi pada 1 Februari 2020?</a></li>
<li><a href="../id452850/index.html">Sistem di dalam kartrid: bagaimana insinyur memperluas kemampuan konsol game</a></li>
<li><a href="../id452852/index.html">Pekerjaan jarak jauh: mitos di malam hari</a></li>
<li><a href="../id452854/index.html">Dari pengguna biasa ke administrator server lengkap (XSS, LFI, Web-Shell)</a></li>
<li><a href="../id452856/index.html">Mengapa proyek indie tidak bisa dirilis?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>