<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôéüèº üë®üèø‚Äçüî¨ üéã Comment et pourquoi nous avons √©crit un service √©volutif hautement charg√© pour 1C: Enterprise: Java, PostgreSQL, Hazelcast ü§õ ü§≥üèΩ üçå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, nous expliquerons comment et pourquoi nous avons d√©velopp√© le syst√®me d'interaction - un m√©canisme qui transf√®re les informations en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment et pourquoi nous avons √©crit un service √©volutif hautement charg√© pour 1C: Enterprise: Java, PostgreSQL, Hazelcast</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/1c/blog/422903/">  Dans cet article, nous expliquerons comment et pourquoi nous avons d√©velopp√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le syst√®me d'interaction</a> - un m√©canisme qui transf√®re les informations entre les applications clientes et les serveurs 1C: Enterprise - de la d√©finition de la t√¢che √† la r√©flexion sur l'architecture et les d√©tails d'impl√©mentation. <br><br>  Le syst√®me d'interaction (ci-apr√®s d√©nomm√© CB) est un syst√®me de messagerie distribu√© √† tol√©rance de panne avec une livraison garantie.  SV est con√ßu comme un service tr√®s charg√© avec une grande √©volutivit√©, et est disponible √† la fois en tant que service en ligne (fourni par 1C) et en tant que produit de circulation qui peut √™tre d√©ploy√© sur ses capacit√©s de serveur. <br><br>  CB utilise le stockage distribu√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hazelcast</a> et le moteur de recherche <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Elasticsearch</a> .  Nous parlerons √©galement de Java et de la fa√ßon dont nous dimensionnons PostgreSQL horizontalement. <br><img src="https://habrastorage.org/webt/gh/nq/sq/ghnqsqdgkb0i4ze_7ig8blrfilk.png" alt="image"><br><a name="habracut"></a><br><br><h2>  √ânonc√© du probl√®me </h2><br>  Pour expliquer pourquoi nous avons cr√©√© le syst√®me d'interaction, je vais vous expliquer un peu comment fonctionne le d√©veloppement d'applications m√©tier dans 1C. <br><br>  Pour commencer, un peu de nous pour ceux qui ne savent pas encore ce que nous faisons :) Nous cr√©ons la plateforme technologique 1C: Enterprise.  La plate-forme comprend un outil de d√©veloppement d'applications m√©tier, ainsi que d'ex√©cution, qui permet aux applications m√©tier de fonctionner dans un environnement multiplateforme. <br><br><h3>  Paradigme de d√©veloppement client-serveur </h3><br>  Les applications m√©tier cr√©√©es sur ¬´1C: Enterprise¬ª fonctionnent dans l'architecture <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">client-serveur</a> √† trois niveaux ¬´SGBD - serveur d'applications - client¬ª.  Le code d'application √©crit dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">langage embarqu√© 1C</a> peut √™tre ex√©cut√© sur le serveur d'application ou sur le client.  Tous les travaux avec les objets d'application (r√©pertoires, documents, etc.), ainsi que la lecture et l'√©criture dans la base de donn√©es, sont effectu√©s uniquement sur le serveur.  La fonctionnalit√© de l'interface formulaires et commandes est √©galement impl√©ment√©e sur le serveur.  Le client re√ßoit, ouvre et affiche des formulaires, ¬´communique¬ª avec l'utilisateur (avertissements, questions ...), de petits calculs dans des formulaires qui n√©cessitent une r√©action rapide (par exemple, multiplier le prix par le montant), travailler avec des fichiers locaux, travailler avec du mat√©riel. <br><br>  Dans le code d'application, les en-t√™tes des proc√©dures et des fonctions doivent indiquer explicitement o√π le code sera ex√©cut√© - en utilisant les directives &amp; Sur le client / &amp; Sur le serveur (&amp; AtClient / &amp; AtServer dans la version en langue anglaise).  Les d√©veloppeurs sur 1C vont me corriger maintenant, en disant qu'il y a en fait <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus de</a> directives, mais pour nous ce n'est pas essentiel maintenant. <br><br>  Le code serveur peut √™tre appel√© √† partir du code client, mais le code client ne peut pas √™tre appel√© √† partir du code serveur.  Il s'agit d'une limitation fondamentale que nous avons faite pour un certain nombre de raisons.  En particulier, parce que le code du serveur doit √™tre √©crit de mani√®re √† √™tre ex√©cut√© de mani√®re √©gale, peu importe o√π il est appel√© - √† partir du client ou du serveur.  Et en cas d'appel du code serveur depuis un autre code serveur, le client est absent en tant que tel.  Et parce que pendant l'ex√©cution du code du serveur, le client qui l'a provoqu√© pouvait se fermer, quitter l'application et le serveur n'aurait personne √† appeler. <br><br><img src="https://habrastorage.org/webt/3e/pb/eh/3epbeh_fc7t4yipr5halnamtbmg.png" alt="image"><br>  <b>Le code qui traite le clic du bouton: l'appel de proc√©dure serveur du client fonctionnera, l'appel de proc√©dure client du serveur ne fonctionnera pas</b> <br><br>  Cela signifie que si nous voulons transf√©rer un message vers l'application client depuis le serveur, par exemple, que la formation d'un rapport "longue dur√©e" est termin√©e et que le rapport peut √™tre consult√©, nous n'avons pas une telle m√©thode.  Nous devons passer √† des astuces, par exemple, √† partir du code client pour interroger p√©riodiquement le serveur.  Mais cette approche charge le syst√®me d'appels inutiles et n'a en effet pas l'air tr√®s √©l√©gante. <br><br>  Et il existe √©galement un besoin, par exemple, lorsqu'un appel t√©l√©phonique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SIP</a> arrive, en informer l'application cliente afin que, par le num√©ro de l'appelant, il le trouve dans la base de donn√©es de la contrepartie et affiche les informations utilisateur sur la contrepartie appelante.  Ou, par exemple, √† la r√©ception de la commande dans l'entrep√¥t, en informer l'application client du client.  En g√©n√©ral, il existe de nombreux cas o√π un tel m√©canisme serait utile. <br><br><h3>  Mise en sc√®ne </h3><br>  Cr√©ez un moteur de messagerie.  Rapide, fiable, avec livraison garantie, avec la possibilit√© de rechercher de mani√®re flexible des messages.  En fonction du m√©canisme, impl√©mentez un messager (messages, appels vid√©o) qui fonctionne √† l'int√©rieur des applications 1C. <br><br>  Concevez un syst√®me √©volutif horizontalement.  L'augmentation de la charge doit √™tre ferm√©e en augmentant le nombre de n≈ìuds. <br><br><h2>  Impl√©mentation </h2><br>  Nous avons d√©cid√© de ne pas int√©grer la partie serveur de SV directement dans la plateforme 1C: Enterprise, mais de l'impl√©menter en tant que produit distinct, dont l'API peut √™tre appel√©e √† partir du code d'application 1C.  Cela a √©t√© fait pour un certain nombre de raisons, dont la principale - je voulais permettre d'√©changer des messages entre diff√©rentes applications 1C (par exemple, entre le Bureau du commerce et de la comptabilit√©).  Diff√©rentes applications 1C peuvent s'ex√©cuter sur diff√©rentes versions de la plateforme 1C: Enterprise, √™tre sur des serveurs diff√©rents, etc.  Dans de telles conditions, la mise en ≈ìuvre de CB en tant que produit distinct situ√© ¬´sur le c√¥t√©¬ª des installations 1C est la solution optimale. <br><br>  Nous avons donc d√©cid√© de faire du CB un produit distinct.  Pour les petites entreprises, nous vous recommandons d'utiliser le serveur CB que nous avons install√© dans notre cloud (wss: //1cdialog.com) pour √©viter les frais g√©n√©raux associ√©s √† l'installation et √† la configuration locale du serveur.  Cependant, les gros clients peuvent juger appropri√© d'installer leur propre serveur CB dans leurs installations.  Nous avons utilis√© une approche similaire dans notre produit SaaS bas√© sur le cloud <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1cFresh</a> - il est publi√© en tant que produit de diffusion pour l'installation par les clients, et est √©galement d√©ploy√© dans notre cloud <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://1cfresh.com/</a> . <br><br><h3>  App </h3><br>  Pour l'√©quilibrage de charge et la tol√©rance aux pannes, nous ne d√©ploierons pas une application Java, mais plusieurs, nous mettrons un √©quilibreur de charge devant eux.  Si vous devez transf√©rer un message d'un n≈ìud √† un autre, utilisez la publication / abonnement dans Hazelcast. <br><br>  Communication du client avec le serveur - par websocket.  Il est bien adapt√© aux syst√®mes en temps r√©el. <br><br><h3>  Cache distribu√© </h3><br>  Choisissez entre Redis, Hazelcast et Ehcache.  Dans la cour 2015.  Redis vient de lancer un nouveau cluster (trop nouveau, effrayant), il y a une Sentinel avec un tas de restrictions.  Ehcache ne sait pas comment s'assembler en cluster (cette fonctionnalit√© est apparue plus tard).  Nous avons d√©cid√© d'essayer avec Hazelcast 3.4. <br>  Hazelcast va au cluster hors de la bo√Æte.  En mode √† n≈ìud unique, il n'est pas tr√®s utile et ne peut servir que de cache - il ne sait pas comment vider les donn√©es sur le disque, il a perdu un n≈ìud unique - il a perdu des donn√©es.  Nous d√©ployons plusieurs Hazelcasts entre lesquels nous sauvegardons des donn√©es critiques.  Le cache n'est pas une sauvegarde - ce n'est pas dommage. <br><br>  Pour nous, Hazelcast c'est: <br><br><ul><li>  R√©f√©rentiel de sessions utilisateur.  Chaque fois, aller dans la base de donn√©es pour une session est long, donc nous mettons toutes les sessions dans Hazelcast. </li><li>  Cache.  Recherche d'un profil utilisateur - archivez le cache.  A √©crit un nouveau message - mettez-le dans le cache. </li><li>  Rubriques pour la communication des instances d'application.  Noda g√©n√®re un √©v√©nement et le place dans le sujet Hazelcast.  Les autres n≈ìuds d'application abonn√©s √† cette rubrique re√ßoivent et traitent l'√©v√©nement. </li><li>  Serrures de cluster.  Par exemple, nous cr√©ons une discussion sur une cl√© unique (discussion-singleton dans le cadre de la base de donn√©es 1C): </li></ul><br><pre><code class="java hljs">conversationKeyChecker.check(<span class="hljs-string"><span class="hljs-string">""</span></span>); doInClusterLock(<span class="hljs-string"><span class="hljs-string">""</span></span>, () -&gt; { conversationKeyChecker.check(<span class="hljs-string"><span class="hljs-string">""</span></span>); createChannel(<span class="hljs-string"><span class="hljs-string">""</span></span>); });</code> </pre> <br>  V√©rifie qu'il n'y a pas de canal.  Ils ont pris la serrure, v√©rifi√© √† nouveau, cr√©√©.  Si vous ne v√©rifiez pas le verrou apr√®s l'avoir pris, il est possible qu'un autre thread √† ce moment soit √©galement v√©rifi√© et essaie maintenant de cr√©er la m√™me discussion - mais il existe d√©j√†.  Il est impossible de verrouiller via un verrou Java synchronis√© ou habituel.  √Ä travers la base - lentement, et la base est dommage, √† travers Hazelcast - ce dont vous avez besoin. <br><br><h3>  Choisir un SGBD </h3><br>  Nous avons une exp√©rience approfondie et r√©ussie de travail avec PostgreSQL et de collaboration avec les d√©veloppeurs de ce SGBD. <br><br>  PostgreSQL n'est pas facile avec un cluster - il a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">XL</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">XC</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Citus</a> , mais, en g√©n√©ral, ce ne sont pas des noSQL, qui √©voluent hors de la bo√Æte.  NoSQL n'√©tait pas consid√©r√© comme le r√©f√©rentiel principal, il suffisait que nous prenions Hazelcast, avec lequel nous n'avions pas travaill√© auparavant. <br><br>  Puisque vous devez faire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©voluer</a> une base de donn√©es relationnelle, cela signifie un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partage</a> .  Comme vous le savez, lors du partitionnement, nous divisons la base de donn√©es en parties distinctes afin que chacune d'entre elles puisse √™tre d√©plac√©e vers un serveur distinct. <br><br>  La premi√®re version de notre partitionnement impliquait la possibilit√© de distribuer chacune des tables de notre application sur diff√©rents serveurs dans des proportions diff√©rentes.  Il y a beaucoup de messages sur le serveur A - s'il vous pla√Æt, transf√©rons une partie de ce tableau au serveur B. Une telle solution vient de crier sur l'optimisation pr√©matur√©e, nous avons donc d√©cid√© de nous limiter √† une approche multi-locataire. <br><br>  Vous pouvez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lire</a> sur le multi-locataire, par exemple, sur le site Web de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Citus Data</a> . <br><br>  Dans SV, il existe des concepts d'application et d'abonn√©.  Une application est une installation sp√©cifique d'une application m√©tier, telle que l'ERP ou la comptabilit√©, avec ses utilisateurs et ses donn√©es m√©tiers.  Un abonn√© est une organisation ou une personne au nom de laquelle l'application est enregistr√©e sur le serveur CB.  Un abonn√© peut enregistrer plusieurs applications et ces applications peuvent √©changer des messages entre elles.  L'abonn√© est √©galement devenu le locataire de notre syst√®me.  Les messages de plusieurs abonn√©s peuvent √™tre dans une seule base physique;  si nous constatons que certains abonn√©s ont commenc√© √† g√©n√©rer beaucoup de trafic - nous le transf√©rons vers une base physique distincte (ou m√™me un serveur de base de donn√©es distinct). <br><br>  Nous avons une base de donn√©es principale o√π une table de routage avec des informations sur l'emplacement de toutes les bases de donn√©es d'abonn√©s est stock√©e. <br><br><img src="https://habrastorage.org/webt/yf/3k/bo/yf3kboqvabg3ljf791sdlpn0zay.png" alt="image"><br><br>  Afin que la base de donn√©es principale ne soit pas un goulot d'√©tranglement, nous conservons la table de routage (et d'autres donn√©es fr√©quemment demand√©es) dans le cache. <br><br>  Si la base de donn√©es des abonn√©s commence √† ralentir, nous la couperons en partitions √† l'int√©rieur.  Sur d'autres projets, nous utilisons pg_pathman pour partitionner de grandes tables. <br><br>  √âtant donn√© que la perte de messages utilisateur est mauvaise, nous prenons en charge nos bases de donn√©es avec des r√©pliques.  La combinaison de r√©pliques synchrones et asynchrones vous permet d'√™tre en s√©curit√© en cas de perte de la base de donn√©es principale.  La perte de message ne se produira qu'en cas de d√©faillance simultan√©e de la base de donn√©es principale et de sa r√©plique synchrone. <br><br>  Si la r√©plique synchrone est perdue, la r√©plique asynchrone devient synchrone. <br>  Si la base de donn√©es principale est perdue, la r√©plique synchrone devient la base de donn√©es principale, la r√©plique asynchrone devient la r√©plique synchrone. <br><br><h3>  Elasticsearch pour la recherche </h3><br>  Puisque, entre autres, CB est √©galement un messager, ici vous avez besoin d'une recherche rapide, pratique et flexible, tenant compte de la morphologie, par des correspondances inexactes.  Nous avons d√©cid√© de ne pas r√©inventer la roue et d'utiliser le moteur de recherche gratuit Elasticsearch, bas√© sur la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lucene</a> .  Nous d√©ployons √©galement Elasticsearch dans un cluster (master - data - data) pour √©liminer les probl√®mes en cas de panne des n≈ìuds d'application. <br><br>  Sur github, nous avons trouv√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin de morphologie russe</a> pour Elasticsearch et nous l'avons utilis√©.  Dans l'index Elasticsearch, nous stockons les racines des mots (d√©finis par le plugin) et des N-grammes.  Lorsque l'utilisateur saisit le texte √† rechercher, nous recherchons le texte saisi parmi les N-grammes.  Lorsqu'il est stock√© dans l'index, le mot "textes" sera divis√© en N-grammes suivants: <br><br>  [ceux, tech, tex, texte, textes, ek, eks, ekst, eksts, ks, kst, kst, kst, st, st, st], <br><br>  Et la racine du mot ¬´texte¬ª sera √©galement enregistr√©e.  Cette approche vous permet de rechercher √† la fois au d√©but, au milieu et √† la fin du mot. <br><br><h2>  Image globale </h2><br><img src="https://habrastorage.org/webt/wo/w3/ke/wow3ke8dq1cqrb_ujsjm4uhevfm.png" alt="image"><br>  R√©p√©tition de l'image du d√©but de l'article, mais avec des explications: <br><br><ul><li>  Equilibreur Internet;  nous avons nginx, √ßa peut √™tre n'importe lequel. </li><li>  Les instances d'applications Java communiquent entre elles via Hazelcast. </li><li>  Pour travailler avec une prise Web, nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Netty</a> . </li><li>  Application Java √©crite en Java 8, constitu√©e de bundles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OSGi</a> .  Les plans - migration vers Java 10 et transition vers les modules. </li></ul><br><h2>  D√©veloppement et test </h2><br>  Dans le processus de d√©veloppement et de test de CB, nous avons rencontr√© un certain nombre de caract√©ristiques int√©ressantes des produits que nous utilisons. <br><br><h3>  Test de charge et fuites de m√©moire </h3><br>  La version de chaque version de CB est un test de r√©sistance.  Il a r√©ussi quand: <br><br><ul><li>  Le test a fonctionn√© pendant plusieurs jours et il n'y a eu aucun d√©ni de service </li><li>  Le temps de r√©ponse pour les op√©rations cl√©s n'a pas d√©pass√© un seuil confortable </li><li>  La d√©gradation des performances par rapport √† la version pr√©c√©dente ne d√©passe pas 10% </li></ul><br>  Nous remplissons la base de test avec des donn√©es - pour cela, nous obtenons des informations sur l'abonn√© le plus actif du serveur de production, multiplions ses nombres par 5 (le nombre de messages, de discussions, d'utilisateurs) et ainsi nous testons. <br><br>  Nous r√©alisons des tests de charge du syst√®me d'interaction en trois configurations: <br><br><ol><li>  Test d'effort </li><li>  Connexions uniquement </li><li>  Inscription abonn√© </li></ol><br>  Lors du stress test, nous d√©marrons plusieurs centaines de threads, et ils chargent sans arr√™t le syst√®me: √©crire des messages, cr√©er des discussions, obtenir une liste de messages.  Nous simulons les actions des utilisateurs ordinaires (obtenir une liste de mes messages non lus, √©crire √† quelqu'un) et des solutions logicielles (transf√©rer un package d'une configuration diff√©rente, traiter la notification). <br><br>  Par exemple, cela fait partie du test de r√©sistance: <br><br><ul><li>  L'utilisateur se connecte. <br><ul><li>  Demande des discussions non lues </li><li>  50% de chance de lire les messages </li><li>  Avec une probabilit√© de 50% √©crit des messages </li><li>  Utilisateur suivant: <br><ul><li>  Avec une probabilit√© de 20% cr√©e une nouvelle discussion. </li><li>  S√©lectionne au hasard l'une de ses discussions </li><li>  Va √† l'int√©rieur </li><li>  Demande des messages, des profils d'utilisateurs </li><li>  Cr√©e cinq messages adress√©s √† des utilisateurs al√©atoires √† partir de cette discussion. </li><li>  Hors discussion </li><li>  Se r√©p√®te 20 fois </li><li>  Se d√©connecte, remonte au d√©but du script </li></ul><br></li><li>  Le chat bot entre dans le syst√®me (√©mule l'√©change de messages √† partir du code des solutions appliqu√©es) <br><br><ul><li>  Avec une probabilit√© de 50%, cr√©e un nouveau canal d'√©change de donn√©es (discussion sp√©ciale) </li><li>  Avec une probabilit√© de 50% √©crit un message sur l'un des canaux existants </li></ul><br></li></ul><br></li></ul><br>  Le sc√©nario ¬´Only Connections¬ª est apparu pour une raison.  Il y a une situation: les utilisateurs ont connect√© le syst√®me, mais ne sont pas encore impliqu√©s.  Le matin √† 09h00, chaque utilisateur allume l'ordinateur, √©tablit une connexion avec le serveur et se tait.  Ces gars-l√† sont dangereux, il y en a beaucoup - des paquets ils n'ont que PING / PONG, mais ils gardent la connexion au serveur (ils ne peuvent pas le garder - mais soudain un nouveau message).  Le test reproduit la situation o√π, en une demi-heure, un grand nombre de ces utilisateurs tentent de se connecter au syst√®me.  Cela ressemble √† un test de r√©sistance, mais il se concentre pr√©cis√©ment sur cette premi√®re entr√©e - afin qu'il n'y ait pas de d√©faillances (une personne n'utilise pas le syst√®me, mais il est d√©j√† en train de tomber - il est difficile de trouver quelque chose de pire). <br><br>  Le sc√©nario d'enregistrement d'abonn√© provient du premier lancement.  Nous avons effectu√© un test de r√©sistance et √©tions s√ªrs que le syst√®me ne ralentit pas en correspondance.  Mais les utilisateurs y sont all√©s et l'enregistrement a commenc√© √† tomber dans un d√©lai d'attente.  Lors de l'inscription, nous avons utilis√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">/ dev / random</a> , qui est li√© √† l'entropie du syst√®me.  Le serveur n'a pas r√©ussi √† accumuler suffisamment d'entropie et a gel√© pendant des dizaines de secondes lors de la demande d'un nouveau SecureRandom.  Il existe de nombreuses fa√ßons de sortir de cette situation, par exemple: passer au moins s√©curis√© / dev / urandom, mettre une carte sp√©ciale qui g√©n√®re l'entropie, g√©n√©rer des nombres al√©atoires √† l'avance et stocker dans le pool.  Nous avons temporairement r√©solu le probl√®me avec un pool, mais depuis lors, nous avons effectu√© un test distinct pour enregistrer de nouveaux abonn√©s. <br><br>  En tant que g√©n√©rateur de charge, nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JMeter</a> .  Il ne sait pas comment travailler avec une prise web, un plug-in est n√©cessaire.  Les premiers dans les r√©sultats de recherche pour "jmeter websocket" sont des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">articles avec BlazeMeter</a> , qui recommandent un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin de Maciej Zaleski</a> . <br><br>  Avec lui, nous avons d√©cid√© de commencer. <br><br>  Presque imm√©diatement apr√®s le d√©but de tests s√©rieux, nous avons constat√© que des fuites de m√©moire avaient commenc√© dans JMeter. <br><br>  Le plugin est une grande histoire distincte, avec 176 √©toiles, il a 132 fourches sur github.  L'auteur lui-m√™me ne s'y est pas engag√© depuis 2015 (nous l'avons pris en 2015, puis cela n'a pas soulev√© de soup√ßons), plusieurs probl√®mes de github sur les fuites de m√©moire, 7 demandes de tirage non ferm√©es. <br>  Si vous d√©cidez d'effectuer des tests de charge avec ce plugin, faites attention aux discussions suivantes: <br><br><ol><li>  Dans un environnement multithread, la LinkedList habituelle a √©t√© utilis√©e, par cons√©quent, ils ont re√ßu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NPE</a> lors de l'ex√©cution.  Il est r√©solu soit en passant √† ConcurrentLinkedDeque, soit par des blocs synchronis√©s.  Ils ont choisi la premi√®re option pour eux-m√™mes ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/43</a> ). </li><li>  Fuite de m√©moire, la d√©connexion ne supprime pas les informations de connexion ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/44</a> ). </li><li>  En mode streaming (lorsque le socket Web ne se ferme pas √† la fin de l'exemple, mais est utilis√© plus loin dans le plan), les mod√®les de r√©ponse ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/maciejzaleski/JMeter-WebSocketSampler/issues/19</a> ) ne fonctionnent pas. </li></ol><br>  C'est l'un de ceux sur github.  Qu'avons-nous fait: <br><br><ol><li>  Ils ont pris la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fourchette Elyran Kogan</a> (@elyrank) - les probl√®mes 1 et 3 ont √©t√© corrig√©s </li><li>  Probl√®me r√©solu 2 </li><li>  Jet√©e mise √† jour du 9.2.14 au 9.3.12 </li><li>  Wrapped SimpleDateFormat dans ThreadLocal;  SimpleDateFormat n'est pas thread-safe, ce qui a conduit √† l'ex√©cution de NPE </li><li>  √âlimination d'une fuite de m√©moire suppl√©mentaire (la connexion a √©t√© ferm√©e de mani√®re incorrecte lors de la d√©connexion) </li></ol><br>  Et pourtant √ßa coule! <br><br>  Le souvenir a commenc√© √† se terminer non pas en un jour, mais en deux.  Il n'y avait absolument plus de temps, ils ont d√©cid√© d'ex√©cuter moins de threads, mais sur quatre agents.  Cela aurait d√ª suffire pendant au moins une semaine. <br><br>  Deux jours se sont √©coul√©s ... <br><br>  Maintenant, la m√©moire a commenc√© √† s'√©puiser √† Hazelcast.  Il √©tait √©vident dans les journaux qu'apr√®s quelques jours de test, Hazelcast commence √† se plaindre d'un manque de m√©moire, et apr√®s un certain temps, le cluster se d√©sagr√®ge et les n≈ìuds continuent de mourir individuellement.  Nous avons connect√© JVisualVM √† Hazelcast et vu une ¬´scie montante¬ª - il appelait r√©guli√®rement GC, mais ne pouvait pas vider sa m√©moire. <br><br><img src="https://habrastorage.org/webt/ha/uc/5y/hauc5ydqebpmxtfirqalulaandi.png" alt="image"><br><br>  Il s'est av√©r√© que dans Hazelcast 3.4, lors de la suppression de map / multiMap (map.destroy ()), la m√©moire n'√©tait pas compl√®tement lib√©r√©e: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/hazelcast/hazelcast/issues/6317</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/hazelcast/hazelcast/issues/4888</a> <br><br>  Maintenant, le bug est corrig√© en 3.5, mais c'√©tait un probl√®me.  Nous avons cr√©√© un nouveau multiMap avec des noms dynamiques et supprim√© selon notre logique.  Le code ressemblait √† ceci: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ MultiMap&lt;UUID, Authentication&gt; sessions = instance.getMultiMap(sub); sessions.put(auth.getUserId(), auth); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ MultiMap&lt;UUID, Authentication&gt; sessions = instance.getMultiMap(sub); sessions.remove(auth.getUserId(), auth); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sessions.size() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sessions.destroy(); } }</code> </pre> <br>  Appeler: <br><br><pre> <code class="java hljs">service.join(auth1, <span class="hljs-string"><span class="hljs-string">"____UUID1"</span></span>); service.join(auth2, <span class="hljs-string"><span class="hljs-string">"____UUID1"</span></span>);</code> </pre> <br>  multiMap a √©t√© cr√©√© pour chaque abonnement et a √©t√© supprim√© lorsqu'il n'√©tait pas n√©cessaire.  Nous avons d√©cid√© de d√©marrer Map &lt;String, Set&gt;, la cl√© sera le nom de l'abonnement et les valeurs seront les identifiants de session (√† partir desquels vous pourrez ensuite obtenir les ID utilisateur, si n√©cessaire). <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">join</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ addValueToMap(sub, auth.getSessionId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Authentication auth, String sub)</span></span></span><span class="hljs-function"> </span></span>{ removeValueFromMap(sub, auth.getSessionId()); }</code> </pre> <br>  Les graphiques se redress√®rent. <br><br><img src="https://habrastorage.org/webt/li/_z/ai/li_zaiochcpbgvviybycfvzslz4.png" alt="image"><br><br><h4>  Qu'avons-nous appris d'autre sur les tests de r√©sistance </h4><br><ol><li>  JSR223 doit √™tre √©crit dans un cache de compilation groovy et activ√© - c'est beaucoup plus rapide.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien</a> </li><li>  Les graphiques Jmeter-Plugins sont plus faciles √† comprendre que les graphiques standard.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien</a> </li></ol><br><br><h3>  √Ä propos de notre exp√©rience avec Hazelcast </h3><br>  Hazelcast √©tait un nouveau produit pour nous, nous avons commenc√© √† travailler avec lui √† partir de la version 3.4.1, maintenant notre serveur de production a la version 3.9.2 (au moment de la r√©daction, la derni√®re version de Hazelcast est 3.10). <br><br><h4>  G√©n√©ration d'ID </h4><br>  Nous avons commenc√© avec des identifiants entiers.  Imaginons que nous ayons besoin d'un autre Long pour une nouvelle entit√©.  La s√©quence ne rentre pas dans la base de donn√©es, les tables participent au partitionnement - il s'av√®re qu'il y a un ID de message = 1 dans DB1 et un ID de message = 1 dans DB2, vous ne pouvez pas mettre un tel ID dans Elasticsearch, soit dans Hazelcast, mais le pire est de vouloir r√©duire les donn√©es de deux bases de donn√©es en une seule (par exemple, d√©cider qu'une seule base de donn√©es est suffisante pour ces abonn√©s).  Vous pouvez cr√©er plusieurs AtomicLongs dans Hazelcast et y conserver le compteur, puis les performances d'obtention d'un nouvel ID sont incrementAndGet plus le temps d'une demande dans Hazelcast.  Mais il y a quelque chose de plus optimal dans Hazelcast - FlakeIdGenerator.  Chaque client se voit attribuer une plage d'ID au contact, par exemple, le premier de 1 √† 10 000, le second de 10 001 √† 20 000, etc.  D√©sormais, le client peut √©mettre de nouveaux identifiants ind√©pendamment jusqu'√† la fin de la plage qui lui est attribu√©e.  Cela fonctionne rapidement, mais lorsque vous red√©marrez l'application (et le client Hazelcast), une nouvelle s√©quence commence - d'o√π les lacunes, etc.  De plus, les d√©veloppeurs ne savent pas tr√®s bien pourquoi les ID sont entiers, mais ils vont si diff√©remment.  Nous avons tous pes√© et opt√© pour les UUID. <br><br>  Soit dit en passant, pour ceux qui veulent ressembler √† Twitter, il existe une telle biblioth√®que Snowcast - il s'agit d'une impl√©mentation Snowflake en plus de Hazelcast.  Vous pouvez le voir ici: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/noctarius/snowcast</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github.com/twitter/snowflake</a> <br><br>  Mais nous n'avons pas atteint ses mains. <br><br><h4>  TransactionalMap.replace </h4><br>  Autre surprise: TransactionalMap.replace ne fonctionne pas.  Voici un test: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceInMap_putsAndGetsInsideTransaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ hazelcastInstance.executeTransaction(context -&gt; { HazelcastTransactionContextHolder.setContext(context); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).put(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-string"><span class="hljs-string">"oldValue"</span></span>); context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-string"><span class="hljs-string">"oldValue"</span></span>, <span class="hljs-string"><span class="hljs-string">"newValue"</span></span>); String value = (String) context.getMap(<span class="hljs-string"><span class="hljs-string">"map"</span></span>).get(<span class="hljs-string"><span class="hljs-string">"key"</span></span>); assertEquals(<span class="hljs-string"><span class="hljs-string">"newValue"</span></span>, value); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { HazelcastTransactionContextHolder.clearContext(); } }); } Expected : newValue Actual : oldValue</code> </pre> <br>  J'ai d√ª √©crire mon remplacement en utilisant getForUpdate: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> &lt;K,V&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceInMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String mapName, K key, V oldValue, V newValue)</span></span></span><span class="hljs-function"> </span></span>{ TransactionalTaskContext context = HazelcastTransactionContextHolder.getContext(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { log.trace(<span class="hljs-string"><span class="hljs-string">"[CACHE] Replacing value in a transactional map"</span></span>); TransactionalMap&lt;K, V&gt; map = context.getMap(mapName); V value = map.getForUpdate(key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldValue.equals(value)) { map.put(key, newValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } log.trace(<span class="hljs-string"><span class="hljs-string">"[CACHE] Replacing value in a not transactional map"</span></span>); IMap&lt;K, V&gt; map = hazelcastInstance.getMap(mapName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.replace(key, oldValue, newValue); }</code> </pre> <br>  Testez non seulement les structures de donn√©es r√©guli√®res, mais aussi leurs versions transactionnelles.  Il arrive que IMap fonctionne, mais TransactionalMap a disparu. <br><br><h4>  Attachez un nouveau JAR sans interruption </h4><br>  Tout d'abord, nous avons d√©cid√© d'enregistrer des objets de nos classes dans Hazelcast.  Par exemple, nous avons une classe Application, nous voulons l'enregistrer et la lire.  Enregistrer: <br><br><pre> <code class="java hljs">IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); map.set(id, application);</code> </pre> <br>  Nous lisons: <br><br><pre> <code class="java hljs">IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> map.get(id);</code> </pre> <br>  Tout fonctionne.  Ensuite, nous avons d√©cid√© de construire un index dans Hazelcast pour le rechercher: <br><br><pre> <code class="java hljs">map.addIndex(<span class="hljs-string"><span class="hljs-string">"subscriberId"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);</code> </pre> <br>  Et lors de l'√©criture d'une nouvelle entit√©, ils ont commenc√© √† recevoir une exception ClassNotFoundException.  Hazelcast a essay√© de compl√©ter l'index, mais ne savait rien de notre classe et voulait qu'il ait un JAR avec cette classe.  Nous l'avons fait, tout a fonctionn√©, mais un nouveau probl√®me est apparu: comment mettre √† jour le JAR sans arr√™ter compl√®tement le cluster?  Hazelcast ne r√©cup√®re pas le nouveau JAR lors d'une mise √† niveau par pod.  A ce moment, nous avons d√©cid√© que nous pourrions tr√®s bien vivre sans chercher par index.  Apr√®s tout, si vous utilisez Hazelcast comme stockage de valeur-cl√©, tout fonctionnera-t-il?  Pas vraiment.  L√† encore, les diff√©rents comportements d'IMap et TransactionalMap.  Lorsque IMap n'a pas d'importance, TransactionalMap g√©n√®re une erreur. <br><br>  IMap  Nous √©crivons 5000 objets, lisons-le.  Tout est attendu. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get5000</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application"</span></span>); UUID subscriberId = UUID.randomUUID(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">5000</span></span>; i++) { UUID id = UUID.randomUUID(); String title = RandomStringUtils.random(<span class="hljs-number"><span class="hljs-number">5</span></span>); Application application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(id, title, subscriberId); map.set(id, application); Application retrieved = map.get(id); assertEquals(id, retrieved.getId()); } }</code> </pre> <br>  Et cela ne fonctionne pas dans la transaction, nous obtenons une exception ClassNotFoundException: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_transaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IMap&lt;UUID, Application&gt; map = hazelcastInstance.getMap(<span class="hljs-string"><span class="hljs-string">"application_t"</span></span>); UUID subscriberId = UUID.randomUUID(); UUID id = UUID.randomUUID(); Application application = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Application(id, <span class="hljs-string"><span class="hljs-string">"qwer"</span></span>, subscriberId); map.set(id, application); Application retrievedOutside = map.get(id); assertEquals(id, retrievedOutside.getId()); hazelcastInstance.executeTransaction(context -&gt; { HazelcastTransactionContextHolder.setContext(context); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { TransactionalMap&lt;UUID, Application&gt; transactionalMap = context.getMap(<span class="hljs-string"><span class="hljs-string">"application_t"</span></span>); Application retrievedInside = transactionalMap.get(id); assertEquals(id, retrievedInside.getId()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { HazelcastTransactionContextHolder.clearContext(); } }); }</code> </pre> <br>  En 3.8, le m√©canisme de d√©ploiement de classe d'utilisateurs est apparu.  Vous pouvez affecter un n≈ìud principal et mettre √† jour le fichier JAR dessus. <br><br>  Maintenant, nous avons compl√®tement chang√© l'approche: nous le s√©rialisons en JSON et l'enregistrons dans Hazelcast.  Hazelcast n'a pas besoin de conna√Ætre la structure de nos classes, mais nous pouvons mettre √† jour sans temps d'arr√™t.  Le contr√¥le de version des objets de domaine est contr√¥l√© par l'application.  Diff√©rentes versions de l'application peuvent √™tre lanc√©es en m√™me temps, et il est possible qu'une nouvelle application √©crive des objets avec de nouveaux champs, mais l'ancienne ne conna√Æt pas ces champs.  Et en m√™me temps, la nouvelle application lit les objets enregistr√©s par l'ancienne application, dans lesquels il n'y a pas de nouveaux champs.  Nous g√©rons de telles situations √† l'int√©rieur de l'application, mais pour plus de simplicit√©, nous ne modifions ni ne supprimons les champs, nous √©tendons les classes uniquement en ajoutant de nouveaux champs. <br><br><h3>  Comment nous fournissons des performances √©lev√©es </h3><br><h4>  Quatre voyages √† Hazelcast - bon, deux √† la base de donn√©es - mauvais </h4><br>  Il est toujours pr√©f√©rable d'acc√©der au cache pour les donn√©es que dans la base de donn√©es, mais vous ne souhaitez pas stocker les enregistrements non r√©clam√©s.  La d√©cision sur quoi mettre en cache, nous reportons √† la derni√®re √©tape de d√©veloppement.  Lorsque la nouvelle fonctionnalit√© est encod√©e, nous activons PostgreSQL pour enregistrer toutes les requ√™tes (log_min_duration_statement √† 0) et ex√©cutons le test de charge pendant 20 minutes. √Ä l'aide des journaux collect√©s, des utilitaires comme pgFouine et pgBadger peuvent cr√©er des rapports analytiques.  Dans les rapports, nous recherchons principalement des requ√™tes lentes et fr√©quentes.  Pour les requ√™tes lentes, nous construisons un plan d'ex√©cution (EXPLAIN) et √©valuons si une telle requ√™te peut √™tre acc√©l√©r√©e.  Les demandes fr√©quentes pour les m√™mes donn√©es d'entr√©e sont bien mises en cache.  Nous essayons de garder les demandes ¬´√† plat¬ª, une table par demande. <br><br><h2>  Fonctionnement </h2><br>  SV en tant que service en ligne a √©t√© lanc√© au printemps 2017, puisqu'un produit SV distinct a √©t√© lanc√© en novembre 2017 (√† l'√©poque en version b√™ta). <br><br>  Pendant plus d'un an de fonctionnement, de graves probl√®mes de fonctionnement du service en ligne de CB ne se sont pas produits.  Nous surveillons le service en ligne via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Zabbix</a> , collectons et d√©ployons depuis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bamboo</a> . <br><br>  Le kit de distribution du serveur CB est livr√© sous forme de packages natifs: RPM, DEB, MSI.  De plus pour Windows, nous fournissons un seul programme d'installation sous la forme d'un EXE, qui installe le serveur, Hazelcast et Elasticsearch sur une seule machine.  Au d√©but, nous appelions cette version de l'installation "d√©mo", mais maintenant il est devenu clair que c'est l'option de d√©ploiement la plus populaire. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr422903/">https://habr.com/ru/post/fr422903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr422893/index.html">Guide Node.js, Partie 1: Informations g√©n√©rales et mise en route</a></li>
<li><a href="../fr422895/index.html">Google veut tuer les URL</a></li>
<li><a href="../fr422897/index.html">Mauvais, mais le mien: comment √©crire du CSS vraiment horrible</a></li>
<li><a href="../fr422899/index.html">Sous surveillance vigilante: comment contr√¥ler les tarifs d'h√©bergement et tenir √† jour le catalogue VPS</a></li>
<li><a href="../fr422901/index.html">Un moniteur de fr√©quence cardiaque pour Poutine, ou qu'est-ce qu'un Ritmer</a></li>
<li><a href="../fr422905/index.html">Mais vous dites Ceph ... est-il si bon?</a></li>
<li><a href="../fr422907/index.html">Aide-m√©moire du robot aspirateur 2018</a></li>
<li><a href="../fr422909/index.html">10 vid√©os de discussion r√©tro 404 Festival les plus populaires</a></li>
<li><a href="../fr422915/index.html">Je recherche un senior sans bureau ni cookies: comment nous avons organis√© une recherche d'employ√©s 100% distants</a></li>
<li><a href="../fr422917/index.html">Je n'ai pas de bouche, mais je dois crier. R√©flexions sur l'IA et l'√©thique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>