<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äç‚úàÔ∏è üëº ‚û°Ô∏è Servidor DHCP nativo usando bash üíÉüèº üö∑ ‚õ¥Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Adoro automatizar o processo e escrever minhas pr√≥prias bicicletas para estudar este ou aquele material. Meu novo objetivo era um servidor DHCP que em...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor DHCP nativo usando bash</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435148/"><img src="https://habrastorage.org/webt/cy/g3/b8/cyg3b8lmcpgxrj7j7_1jbfkxfta.png" align="left">  Adoro automatizar o processo e escrever minhas pr√≥prias bicicletas para estudar este ou aquele material.  Meu novo objetivo era um servidor DHCP que emitisse um endere√ßo em pequenas redes para que fosse poss√≠vel realizar a configura√ß√£o inicial do equipamento. <br><br>  Neste artigo, falarei um pouco sobre o protocolo DHCP e algumas sutilezas do bash. <br><a name="habracut"></a><br><br><br><h1>  Resultado final </h1><br>  Vamos come√ßar do final, para que fique claro o que estamos lutando. <br><br>  Demonstra√ß√£o de trabalho: <br><br><img src="https://habrastorage.org/webt/co/za/6j/coza6jzioblfbafujqfcanrffco.gif"><br><br>  Reposit√≥rio com script: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">firemoon777 / bash-dhcp-server</a> <br><br><h1>  Problema inicial </h1><br>  A configura√ß√£o que eu preciso √© feita desta maneira: n√≥s nos conectamos diretamente via par tran√ßado ao equipamento, emitimos um endere√ßo tempor√°rio via DHCP e o configuramos com um script j√° criado.  E assim dez a vinte vezes seguidas. <br><br>  Para muitos, o conhecido isc-dhcp-server faz seu trabalho perfeitamente, mas, infelizmente, ele n√£o notifica meu script que o endere√ßo foi emitido; portanto, voc√™ precisa bloquear a execu√ß√£o at√© que o endere√ßo seja emitido. <br><br>  A solu√ß√£o, ao que parece, est√° na superf√≠cie: fa√ßa ping at√© ficar azul na cara, at√© que o equipamento responda: <br><br><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ! ping -c1 -W1 <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DHCP</span></span></span><span class="hljs-string">"</span></span> | grep -q <span class="hljs-string"><span class="hljs-string">"time="</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Waiting for </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DHCP</span></span></span><span class="hljs-string">..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Mas essa decis√£o definitivamente n√£o tem aventureiro. <br><br><h1>  Parte te√≥rica </h1><br><h3>  Obtendo um Endere√ßo com um √önico Servidor DHCP </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1t/5q/u9/1t5qu9ltl-tjqlkmc7egjfgjvpe.png"></div><br>  O protocolo DHCP funciona em UDP nas portas 67 e 68. O servidor sempre funciona apenas em 67 e o cliente em 68. Como o cliente n√£o possui um endere√ßo (possui o endere√ßo 0.0.0.0), os pacotes DHCP s√£o transmitidos.  I.e.  o cliente sempre envia pacotes para o endere√ßo 255.255.255.255:67 do endere√ßo 0.0.0.0:68 e o servidor envia do endere√ßo: 67 para o endere√ßo 255.255.255.255:68. <br><br>  O cliente <b>recebe o</b> endere√ßo em quatro pacotes ( <b>DORA</b> ): <br><br><ol><li>  O cliente descobre onde est√° o servidor DHCP ( <b>D</b> iscover) </li><li>  O servidor responde e oferece seu endere√ßo (oferta) </li><li>  O cliente solicita o endere√ßo proposto de um servidor espec√≠fico ( <b>R</b> equest) </li><li>  O servidor concorda e emite o endere√ßo ( <b>A</b> ck) </li></ol><br>  Visualmente, o esquema pode ser representado da seguinte maneira: <br><br><img src="https://habrastorage.org/webt/j5/ug/zy/j5ugzyefd8qvd-wrcsjtdahmnbs.png"><br><br><h3>  Obtendo um endere√ßo com v√°rios servidores DHCP </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/28/uo/fc/28uofcx-gthwmwhs8sgz0jrdysk.png"></div><br>  Quando o cliente envia o Discover, todos os servidores que podem ouvir enviam sua Oferta ao cliente.  Mas o cliente deve escolher um.  A sele√ß√£o do cliente √© anunciada na mensagem Solicitar com a op√ß√£o 54 (servidor DHCP), que cont√©m o endere√ßo IP do servidor DHCP preferido.  Embora a solicita√ß√£o tamb√©m seja enviada a todos na rede, apenas o servidor DHCP cujo IP √© especificado na op√ß√£o 54 responder√°. <br><br><img src="https://habrastorage.org/webt/ke/xi/rv/kexirvjfnljlm3pdhcpfqglh02a.png"><br><br><h3>  Conte√∫do do pacote DHCP </h3><br>  Um pacote DHCP consiste em duas partes: uma constante, 236 bytes de tamanho, e uma vari√°vel que carrega op√ß√µes (op√ß√£o DHCP). <br><br><div class="spoiler">  <b class="spoiler_title">Tabela com todos os campos do pacote DHCP da Wikipedia</b> <div class="spoiler_text"><table><tbody><tr><th>  O campo </th><th>  Descri√ß√£o do produto </th><th>  Comprimento (em bytes) </th></tr><tr><td>  <b>op</b> <br></td><td>  Tipo de mensagem.  Por exemplo, ele pode aceitar valores: BOOTREQUEST (0x01, solicita√ß√£o do cliente para o servidor) e BOOTREPLY (0x02, resposta do servidor para o cliente). <br></td><td>  1 <br></td></tr><tr><td>  <b>htype</b> <br></td><td>  Tipo de endere√ßo de hardware.  Os valores v√°lidos para este campo s√£o definidos nos N√∫meros atribu√≠dos da RFC 1700.  Por exemplo, para um endere√ßo MAC Ethernet, este campo √© definido como 0x01. <br></td><td>  1 <br></td></tr><tr><td>  <b>hlen</b> <br></td><td>  O comprimento do endere√ßo do hardware em bytes.  O endere√ßo MAC Ethernet √© 0x06. <br></td><td>  1 <br></td></tr><tr><td>  <b>l√∫pulo</b> <br></td><td>  O n√∫mero de roteadores intermedi√°rios (os chamados <i>agentes de retransmiss√£o DHCP</i> ) pelos quais a mensagem passou.  O cliente define esse campo para 0x00. <br></td><td>  1 <br></td></tr><tr><td>  <b>xid</b> <br></td><td>  Um identificador de transa√ß√£o exclusivo de 4 bytes gerado pelo cliente no in√≠cio do processo de obten√ß√£o do endere√ßo. <br></td><td>  4 <br></td></tr><tr><td>  <b>segundos</b> <br></td><td>  O tempo em segundos desde o in√≠cio do processo de obten√ß√£o do endere√ßo.  N√£o pode ser usado (neste caso, √© definido como 0x0000). <br></td><td>  2 <br></td></tr><tr><td>  <b>bandeiras</b> <br></td><td>  O campo para sinalizadores s√£o par√¢metros especiais do protocolo DHCP. <br></td><td>  2 <br></td></tr><tr><td>  <b>ciaddr</b> <br></td><td>  Endere√ßo IP do cliente.  Ele √© preenchido apenas se o cliente j√° tiver seu pr√≥prio endere√ßo IP e puder responder a solicita√ß√µes de ARP (isso √© poss√≠vel se o cliente executar o procedimento para atualizar o endere√ßo ap√≥s o t√©rmino da concess√£o). <br></td><td>  4 <br></td></tr><tr><td>  <b>yiaddr</b> <br></td><td>  O novo endere√ßo IP do cliente proposto pelo servidor. <br></td><td>  4 <br></td></tr><tr><td>  <b>siaddr</b> <br></td><td>  Endere√ßo IP do servidor.  Retornado na cl√°usula DHCP (veja abaixo). <br></td><td>  4 <br></td></tr><tr><td>  <b>giaddr</b> <br></td><td>  O endere√ßo IP do agente de retransmiss√£o, se houver algum envolvido no processo de entrega da mensagem DHCP ao servidor. <br></td><td>  4 <br></td></tr><tr><td>  <b>chaddr</b> <br></td><td>  O endere√ßo de hardware (geralmente o endere√ßo MAC) do cliente. <br></td><td>  16 <br></td></tr><tr><td>  <b>roncar</b> <br></td><td>  Nome opcional do servidor como uma sequ√™ncia terminada nula. <br></td><td>  64 <br></td></tr><tr><td>  <b>arquivo</b> <br></td><td>  Um nome de arquivo do servidor opcional usado por esta√ß√µes de trabalho sem disco ao fazer o download remotamente.  Como <b>sname</b> , ele √© representado como uma sequ√™ncia terminada em nulo. <br></td><td>  128 <br></td></tr><tr><td>  <b>op√ß√µes</b> <br></td><td>  Campo de <i>op√ß√µes DHCP</i> .  V√°rias op√ß√µes de configura√ß√£o adicionais s√£o indicadas aqui.  No in√≠cio desse campo, quatro bytes especiais com os valores 99, 130, 83, 99 ("n√∫meros m√°gicos") s√£o indicados, permitindo que o servidor determine a presen√ßa desse campo.  O campo tem um comprimento vari√°vel, mas o cliente DHCP deve estar pronto para receber uma mensagem DHCP de 576 bytes (nesta mensagem, o campo de <b>op√ß√µes</b> tem 340 bytes). <br></td><td>  vari√°vel <br></td></tr></tbody></table><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lista de todas as op√ß√µes de DHCP no RFC 2132</a> <br><br>  As op√ß√µes de DHCP s√£o codificadas da seguinte maneira: <br><table><tbody><tr><td>  N√∫mero </td><td>  Comprimento </td><td>  Dados </td></tr></tbody></table><br>  Por exemplo, par√¢metro 3 (gateway proposto) com um valor de 10.0.0.1: <br><table><tbody><tr><td>  3 </td><td>  4 </td><td>  10 </td><td>  0 0 </td><td>  0 0 </td><td>  1 </td></tr></tbody></table><br>  Caso voc√™ precise passar v√°rios par√¢metros, o comprimento do par√¢metro aumenta. <br>  Por exemplo, no par√¢metro 6 (servidor DNS), transmitiremos dois endere√ßos (1.1.1.1 e 8.8.4.4): <br><table><tbody><tr><td>  6 </td><td>  8 </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  8 </td><td>  8 </td><td>  4 </td><td>  4 </td></tr></tbody></table><br>  Um sinal do final do campo de op√ß√£o √© um par√¢metro com o n√∫mero 255 (0xFF) e um comprimento 0. <br><br>  Na maioria das vezes, o cliente coloca o par√¢metro 55 (uma lista de par√¢metros que ele deseja receber em resposta) no DHCP Discover, no entanto, temos o direito de n√£o fornecer tudo o que ele solicitou. <br><br><h1>  Parte pr√°tica </h1><br>  Foi originalmente planejado escrever o servidor em uma linguagem mais adequada (C) para isso, no entanto, seria mundano e simples.  √â uma quest√£o de escrever um script que assuma as fun√ß√µes do servidor dhcp. <br><br><h3>  Simplifica√ß√£o </h3><br>  Como o servidor em desenvolvimento deveria ser usado em redes de dois n√≥s conectados por um patch, foram adotadas as seguintes simplifica√ß√µes: <br><br><ul><li>  garantido que um cliente na rede; </li><li>  √© garantido que n√£o h√° mais servidores DHCP na rede </li><li>  o iniciador decide qual endere√ßo emitir </li><li>  A libera√ß√£o do DHCP e o decl√≠nio do DHCP s√£o ignorados </li></ul><br><h3>  Ouvinte </h3><br>  Primeiro de tudo, voc√™ precisa aprender como receber pacotes.  Isso requer um ouvinte <strike>compreensivo certificado</strike> , por exemplo, nc.  Mas nem todo NC √© adequado para esses fins.  O OpenBSD netcat 1.130 do Debian √© adequado, mas o 1.105 com Ubuntu se foi.  Execute nc para ouvir todos os pacotes UDP que chegam na porta 67. <br><br><pre> <code class="bash hljs">nc -l 0.0.0.0 -up 67 -w0</code> </pre><br>  O OpenBSD netcat tamb√©m √© necess√°rio devido √† op√ß√£o -w com um valor 0. Ap√≥s receber um pacote (UDP Broadcast), o nc tradicional n√£o recebe mais pacotes, mas n√£o termina. <br><br><h3>  Manipula√ß√£o de bytes brutos </h3><br>  No shell, √© muito dif√≠cil trabalhar com caracteres n√£o imprim√≠veis, como um caractere nulo: ele simplesmente o ignora.  Um pacote DHCP cont√©m muitos bytes 0x00 (por exemplo, o campo de arquivo).  A solu√ß√£o para o problema vem na forma de hex-dump: <br><br><pre> <code class="bash hljs"> nc -l 0.0.0.0 -up 67 -w0 | stdbuf -o0 od -v -w1 -t x1 -An</code> </pre><br>  Um byte por linha, sem sa√≠da do endere√ßo, sem pular bytes duplicados.  Voc√™ tamb√©m pode incrementar stdbuf -o0 para que a sa√≠da n√£o seja armazenada em buffer. <br><br><h3>  Pacotes de recebimento, armazenamento e processamento </h3><br>  No comando od stdout, os bytes s√£o obtidos pelo comando read e adicionados a uma matriz. <br><br><pre> <code class="bash hljs">msg=() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> {0..235}; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> -r tmp msg[<span class="hljs-variable"><span class="hljs-variable">$i</span></span>]=<span class="hljs-variable"><span class="hljs-variable">$tmp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  Embora todos os valores sejam transmitidos em nota√ß√£o hexadecimal, o n√∫mero da op√ß√£o DHCP e o comprimento da op√ß√£o s√£o exibidos melhor na tela / nos logs na forma decimal usual.  Para fazer isso, voc√™ pode usar uma entrada curta bash'a: <br><br><pre> <code class="bash hljs">$ op=AC $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> $((16<span class="hljs-comment"><span class="hljs-comment">#$op)) 172</span></span></code> </pre><br>  O pacote recebido √© editado de acordo com o tipo de solicita√ß√£o (Discover ou Request) e enviado de volta. <br><br><h3>  Resposta </h3><br>  No entanto, enviar um pacote n√£o √© uma tarefa t√£o f√°cil.  Primeiro voc√™ precisa converter bytes do despejo em bytes brutos e enviar tudo de uma s√≥ vez com um pacote. <br><br>  A convers√£o pode ser feita com o utilit√°rio printf usando seq√º√™ncias de escape.  E para que nada se perca, escreva bytes imediatamente em um arquivo. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   &gt;/tmp/dhcp.payload #     for i in ${msg[*]}; do printf "\x$i" &gt;&gt; /tmp/dhcp.payload done</span></span></code> </pre><br>  O OpenBSD netcat tamb√©m √© usado para o envio.  No entanto, se a vers√£o 1.105 com Ubuntu √© adequada como ouvinte, n√£o √© adequada para a transmiss√£o de mensagens UDP: obtemos o erro de protocolo n√£o dispon√≠vel. <br><br><pre> <code class="bash hljs">cat /tmp/dhcp.payload | nc -ub 255.255.255.255 68 -s <span class="hljs-variable"><span class="hljs-variable">$SERVER</span></span> -p 67 -w0</code> </pre><br>  A op√ß√£o -b permite que mensagens de broadcast sejam enviadas e esse √© o segundo motivo pelo qual o servidor deve ser executado sob o superusu√°rio. <br><br><h1>  Quais s√£o as limita√ß√µes? </h1><br>  Este servidor DHCP foi projetado com simplifica√ß√µes como um √∫nico cliente na rede.  No entanto, ele funcionar√° com v√°rios clientes.  Basta obter o endere√ßo mais r√°pido. <br><br><img src="https://habrastorage.org/webt/yq/45/5f/yq455faeeblrxvyhtp9zeffiktg.png"><br><br><h1>  Conclus√£o </h1><br>  Embora os scripts bash dificilmente possam ser chamados de linguagem de programa√ß√£o completa, no entanto, com o devido desejo, voc√™ pode at√© resolver problemas como emitir um endere√ßo IP na rede sem usar software especialmente projetado para isso.  E resolver problemas espec√≠ficos n√£o apenas traz alegria, mas tamb√©m novos conhecimentos que surgiram no momento da solu√ß√£o. <br><br><h1>  Fontes </h1><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DHCP - Wikipedia</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Par√¢metros DHCP e BOOTP - IANA</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435148/">https://habr.com/ru/post/pt435148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435134/index.html">Simplifique o trabalho com bancos de dados no Qt com QSqlRelationalTableModel</a></li>
<li><a href="../pt435136/index.html">Sergey e o m√©todo cient√≠fico</a></li>
<li><a href="../pt435138/index.html">Como assumir o controle de sua infraestrutura de rede. CAP√çTULO TR√äS Seguran√ßa de rede. Parte um</a></li>
<li><a href="../pt435142/index.html">Rastreio de aprendizado usando o eBPF: um guia e exemplos</a></li>
<li><a href="../pt435144/index.html">Introdu√ß√£o ao Spring Boot: Criando uma API REST Simples em Java</a></li>
<li><a href="../pt435150/index.html">Ensaios cl√≠nicos √† porta - Entrevista com Aubrey de Gray</a></li>
<li><a href="../pt435152/index.html">A disputa de patentes entre Apple e Qualcomm levou a interromper as vendas do iPhone 7 e 8 na Alemanha</a></li>
<li><a href="../pt435154/index.html">Mem√≥rias de um rob√¥ subumano, cap√≠tulos 9 a 12</a></li>
<li><a href="../pt435156/index.html">Precisa de mais c√¢meras: o Nokia 9 tem 5 delas imediatamente</a></li>
<li><a href="../pt435160/index.html">Internet das coisas em russo. Par√¢metros espectrais do sinal de r√°dio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>