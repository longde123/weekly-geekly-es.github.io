<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîó üë®‚Äçüë®‚Äçüëß üç∑ Wie das Zip-Archiv aussieht und was wir damit machen k√∂nnen. Teil 4 - Das Archiv lesen üë¶üèª üìÑ üåó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fortsetzung des Zyklus √ºber Zip-Archive und PHP. Bisherige Artikel: Teil 1 , Teil 2 , Teil 3 

 Guten Tag, liebe Leser. 
 Dieses Mal m√∂chte ich wahrsc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie das Zip-Archiv aussieht und was wir damit machen k√∂nnen. Teil 4 - Das Archiv lesen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485264/"> <i>Fortsetzung des Zyklus √ºber Zip-Archive und PHP.</i>  <i>Bisherige Artikel: <a href="https://habr.com/ru/post/471066/">Teil 1</a> , <a href="https://habr.com/ru/post/472966/">Teil 2</a> , <a href="https://habr.com/ru/post/484520/">Teil 3</a></i> <br><br>  Guten Tag, liebe Leser. <br>  Dieses Mal m√∂chte ich wahrscheinlich den letzten Teil des Zyklus √ºber Zip-Archive und PHP vorstellen. <br><br>  In diesem Artikel werde ich zeigen, wie man ein vorhandenes Archiv liest, und als Beispiel nehmen wir <b>photos.zip</b> aus einem <a href="https://habr.com/ru/post/484520/">vorherigen Artikel</a> .  Um nicht alle Vorg√§nge zu wiederholen, verwenden wir das vorgefertigte <a href="">https://github.com/userqq/images/raw/master/photos.zip</a> . <br><br>  Lassen Sie uns nun einen Moment abschweifen und uns daran erinnern, woraus unser Archiv besteht: Zuerst gibt es einen Satz gepackter Dateidaten, wobei jeder gepackten Datei eine lokale Dateikopfstruktur (Local File Header, LFH) vorangestellt ist, nachdem alle Daten einen Satz zentraler Verzeichnisdateikopfstrukturen (Central Directory File Header, CDFH) enthalten - Dies ist ein Inhaltsverzeichnis in unserem Archiv, das alle Elemente und die Positionen ihrer Verschiebung relativ zum Dateianfang auflistet.  Und das EOCD-Archiv (End Of Central Directory Record) ist fertig - hier ist die Position des Anfangs der CDFH-Strukturen, ihre Anzahl und Gesamtl√§nge in Byte.  Daher sollte das Archiv von Anfang an gelesen werden, um zuerst das EOCD zu finden, dann die CDFH-Strukturen zu lesen und somit eine Liste der Dateien im Archiv zu erhalten. <br><br>  <i>Zu Ihrer Information: Einige Formate, wie JPEG, werden von Anfang an gelesen.</i>  <i>Daher k√∂nnen wir das Bild mit dem Archiv zusammenkleben, sogar kitschig durch <b>cat image.jpeg archive.zip&gt; imagearchive.jpeg</b> , ohne die Funktionalit√§t zu verlieren.</i>  <i>Browser und Anwendungen zum Anzeigen von Bildern zeigen uns problemlos ein Bild.</i>  <i>W√§hrend jede Anwendung zum Lesen von Zip-Archiven, sei es 7z oder Entpacken, in der Lage ist, ruhig mit der Datei als Archiv zu arbeiten.</i>  <i>Zum Beispiel hier - <a href="">https://github.com/userqq/images/blob/master/jpegarchive.jpg</a> (Achtung, dieses Ding wiegt ungef√§hr 20 MB, daher empfehle ich nicht, den Datenverkehr √ºber Telefone zu √∂ffnen oder wenn Sie sich f√ºr den Datenverkehr interessieren).</i>  <i>Wenn Sie also das Hosting von Bildern kennen, auf denen die Bilder nicht neu codiert und nicht zugeschnitten sind, k√∂nnen Sie nicht nur Bilder dort hochladen.</i> <br><a name="habracut"></a><br>  Zun√§chst definieren wir eine Hilfsfunktion, die uns die Arbeit mit dem Auspacken erleichtert (ich habe diese Idee in einem der Repositorys f√ºr die Arbeit mit Socken ausspioniert und ein wenig f√ºr unseren Fall modifiziert): <br><br><pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readBytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($fh, $formatArray)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//          pack() // https://www.php.net/manual/ru/function.pack.php //        // , L = unsigned long 32bit = 4  static $lengths = ['L' =&gt; 4, 'l' =&gt; 4, 'i' =&gt; 4, 'I' =&gt; 4, 'S' =&gt; 2, 'a' =&gt; 1]; //     , //    fread()     . $totalLength = 0; //      ,     unpack(); $unpackFormat = []; //   ,        -,     0. // ,    ,      0,      . //       $nullData = []; foreach ($formatArray as $name =&gt; $format) { $length = 1; //      , , ['versionMadeBy' =&gt; 'S'], //       SversionMadeBy //   ['filename' =&gt; ['a', $filenameLength]] //    "a{$filenameLength}filename" if (is_array($format)) { [$format, $length] = $format; } //    ,    - //  ['extraFieldLength' =&gt; ['a', 0]] //       //      ['extraFieldLength' =&gt; null] if ($length &lt; 1) { $nullData[] = $name; continue; } $totalLength += $lengths[$format] * $length; $unpackFormat[] = $format . (($length &gt; 1) ? $length : '') . $name; } $packet = []; if ($totalLength &gt; 0) { $packet = unpack(implode('/', $unpackFormat), fread($fh, $totalLength)); } foreach ($nullData as $empty) { $packet[$empty] = null; } return $packet; }</span></span></code> </pre> <br>  Versuchen wir nun, die EOCD-Struktur zu finden.  Wenn kein Kommentar vorhanden ist, betr√§gt die Mindestl√§nge 22 Byte, von denen die ersten 4 eine Signatur sind.  Deshalb bewegen wir uns zuerst zur Position Dateigr√∂√üe ($ file) - 22, lesen die n√§chsten 4 Bytes und wenn wir Gl√ºck haben und diese Bytes gleich der Signatur sind (0x06054b50), dann ist dies unser EOCD.  Wenn Sie kein Gl√ºck haben - byteweise bewegen wir uns zum Anfang der Datei, bis wir die Datei gefunden oder beendet haben - dann ist dies wahrscheinlich kein Archiv. <br><br><pre> <code class="php hljs">$fh = fopen(<span class="hljs-string"><span class="hljs-string">'photos.zip'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($offset = <span class="hljs-number"><span class="hljs-number">22</span></span>, $length = fstat($fh)[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]; $offset &lt;= $length; $offset++) { fseek($fh, $offset * <span class="hljs-number"><span class="hljs-number">-1</span></span>, SEEK_END); <span class="hljs-comment"><span class="hljs-comment">// "\x50\x4b\x05\x06" === pack('L', 0x06054b50),  EOCD if ("\x50\x4b\x05\x06" === $bytes = fread($fh, 4)) { echo 'EOCD    ' . ($length - $offset) . PHP_EOL; break; } } $EOCD = readBytes($fh, [ 'diskNumber' =&gt; 'S', 'startDiskNumber' =&gt; 'S', 'numberCentralDirectoryRecord' =&gt; 'S', 'totalCentralDirectoryRecord' =&gt; 'S', 'sizeOfCentralDirectory' =&gt; 'L', 'centralDirectoryOffset' =&gt; 'L', 'commentLength' =&gt; 'S', ]); echo '  : ' . $EOCD['numberCentralDirectoryRecord'] . PHP_EOL; echo ' CDFH: ' . $EOCD['centralDirectoryOffset'] . PHP_EOL;</span></span></code> </pre> <br>  Jetzt wissen wir, wie viele Elemente wir im Archiv haben und wo das ‚ÄûInhaltsverzeichnis‚Äú beginnt - eine Liste von CDFH-Strukturen.  Wir k√∂nnen sie durchlaufen und die Namen, die Datengr√∂√üe und die LFH-Startposition f√ºr jedes der Archivelemente ermitteln. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'   :'</span></span> . PHP_EOL; <span class="hljs-comment"><span class="hljs-comment">//  ,       CDFH  LFH - $offset = $EOCD['centralDirectoryOffset']; for ($i = 0; $i &lt; $EOCD['numberCentralDirectoryRecord']; $i++) { fseek($fh, $offset, SEEK_SET); // "\x50\x4b\x01\x02" === pack('L', 0x02014b50),  CDFH if ("\x50\x4b\x01\x02" !== $bytes = fread($fh, 4)) { exit('  CDFH' . PHP_EOL); } //  CDFH $CDFH = readBytes($fh, [ 'versionMadeBy' =&gt; 'S', 'versionToExtract' =&gt; 'S', 'generalPurposeBitFlag' =&gt; 'S', 'compressionMethod' =&gt; 'S', 'modificationTime' =&gt; 'S', 'modificationDate' =&gt; 'S', 'crc32' =&gt; 'L', 'compressedSize' =&gt; 'L', 'uncompressedSize' =&gt; 'L', 'filenameLength' =&gt; 'S', 'extraFieldLength' =&gt; 'S', 'fileCommentLength' =&gt; 'S', 'diskNumber' =&gt; 'S', 'internalFileAttributes' =&gt; 'S', 'externalFileAttributes' =&gt; 'L', 'localFileHeaderOffset' =&gt; 'L', ]); $CDFH += readBytes($fh, [ 'filename' =&gt; ['a', $CDFH['filenameLength']], 'extraField' =&gt; ['a', $CDFH['extraFieldLength']], 'fileComment' =&gt; ['a', $CDFH['fileCommentLength']], ]); // ,       CDFH $offset = ftell($fh); //   LFH fseek($fh, $CDFH['localFileHeaderOffset'], SEEK_SET); // "\x50\x4b\x03\x04" === pack('L', 0x04034b50),  LFH if ("\x50\x4b\x03\x04" !== $bytes = fread($fh, 4)) { exit('  LFH' . PHP_EOL); } //  LFH $LFH = readBytes($fh, [ 'versionToExtract' =&gt; 'S', 'generalPurposeBitFlag' =&gt; 'S', 'compressionMethod' =&gt; 'S', 'modificationTime' =&gt; 'S', 'modificationDate' =&gt; 'S', 'crc32' =&gt; 'L', 'compressedSize' =&gt; 'L', 'uncompressedSize' =&gt; 'L', 'filenameLength' =&gt; 'S', 'extraFieldLength' =&gt; 'S', ]); $LFH += readBytes($fh, [ 'filename' =&gt; ['a', $LFH['filenameLength']], 'extraField' =&gt; ['a', $LFH['extraFieldLength']], ]); $dataOffset = ftell($fh); echo '&gt; ' . $CDFH['filename'] . ' ' . $CDFH['compressedSize'] . ' , '; echo 'LFH: ' . $CDFH['localFileHeaderOffset'] . ', '; echo ' : ' . $dataOffset . ', '; echo ' : ' . ($dataOffset + $CDFH['compressedSize']); echo PHP_EOL; } fclose($fp);</span></span></code> </pre> <br>  <i>Im Allgemeinen ist es in Bezug auf die Leistung nicht die beste Idee, die Datei f√ºr jeden Datensatz hin und her zu durchsuchen. Daher w√ºrde ich empfehlen, alle CDFH-Strukturen zu lesen und dann, falls erforderlich, LFH und Daten zu lesen. Unkonventionelle Programmierung ‚Äú, so k√∂nnen wir.</i> <br><br><div class="spoiler">  <b class="spoiler_title">Vollst√§ndiger Skriptcode</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readBytes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($fh, $formatArray)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $lengths = [<span class="hljs-string"><span class="hljs-string">'L'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'l'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'i'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'I'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'S'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>]; $totalLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; $unpackFormat = []; $nullData = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($formatArray <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $name =&gt; $format) { $length = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($format)) { [$format, $length] = $format; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($length &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { $nullData[] = $name; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } $totalLength += $lengths[$format] * $length; $unpackFormat[] = $format . (($length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) ? $length : <span class="hljs-string"><span class="hljs-string">''</span></span>) . $name; } $packet = []; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($totalLength &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $packet = unpack(implode(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, $unpackFormat), fread($fh, $totalLength)); } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($nullData <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $empty) { $packet[$empty] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; } $fh = fopen(<span class="hljs-string"><span class="hljs-string">'photos.zip'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($offset = <span class="hljs-number"><span class="hljs-number">22</span></span>, $length = fstat($fh)[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]; $offset &lt;= $length; $offset++) { fseek($fh, $offset * <span class="hljs-number"><span class="hljs-number">-1</span></span>, SEEK_END); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"\x50\x4b\x05\x06"</span></span> === $bytes = fread($fh, <span class="hljs-number"><span class="hljs-number">4</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'EOCD    '</span></span> . ($length - $offset) . PHP_EOL; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } $EOCD = readBytes($fh, [ <span class="hljs-string"><span class="hljs-string">'diskNumber'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'startDiskNumber'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'numberCentralDirectoryRecord'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'totalCentralDirectoryRecord'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'sizeOfCentralDirectory'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'centralDirectoryOffset'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'commentLength'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, ]); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'  : '</span></span> . $EOCD[<span class="hljs-string"><span class="hljs-string">'numberCentralDirectoryRecord'</span></span>] . PHP_EOL; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'  CDFH: '</span></span> . $EOCD[<span class="hljs-string"><span class="hljs-string">'centralDirectoryOffset'</span></span>] . PHP_EOL; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'   :'</span></span> . PHP_EOL; $offset = $EOCD[<span class="hljs-string"><span class="hljs-string">'centralDirectoryOffset'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $EOCD[<span class="hljs-string"><span class="hljs-string">'numberCentralDirectoryRecord'</span></span>]; $i++) { fseek($fh, $offset, SEEK_SET); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"\x50\x4b\x01\x02"</span></span> !== $bytes = fread($fh, <span class="hljs-number"><span class="hljs-number">4</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-string"><span class="hljs-string">'  CDFH'</span></span> . PHP_EOL); } $CDFH = readBytes($fh, [ <span class="hljs-string"><span class="hljs-string">'versionMadeBy'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'versionToExtract'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'generalPurposeBitFlag'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'compressionMethod'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'modificationTime'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'modificationDate'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'crc32'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'compressedSize'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'uncompressedSize'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'filenameLength'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'extraFieldLength'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'fileCommentLength'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'diskNumber'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'internalFileAttributes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'externalFileAttributes'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'localFileHeaderOffset'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, ]); $CDFH += readBytes($fh, [ <span class="hljs-string"><span class="hljs-string">'filename'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'a'</span></span>, $CDFH[<span class="hljs-string"><span class="hljs-string">'filenameLength'</span></span>]], <span class="hljs-string"><span class="hljs-string">'extraField'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'a'</span></span>, $CDFH[<span class="hljs-string"><span class="hljs-string">'extraFieldLength'</span></span>]], <span class="hljs-string"><span class="hljs-string">'fileComment'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'a'</span></span>, $CDFH[<span class="hljs-string"><span class="hljs-string">'fileCommentLength'</span></span>]], ]); $offset = ftell($fh); fseek($fh, $CDFH[<span class="hljs-string"><span class="hljs-string">'localFileHeaderOffset'</span></span>], SEEK_SET); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"\x50\x4b\x03\x04"</span></span> !== $bytes = fread($fh, <span class="hljs-number"><span class="hljs-number">4</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-string"><span class="hljs-string">'  LFH'</span></span> . PHP_EOL); } $LFH = readBytes($fh, [ <span class="hljs-string"><span class="hljs-string">'versionToExtract'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'generalPurposeBitFlag'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'compressionMethod'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'modificationTime'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'modificationDate'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'crc32'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'compressedSize'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'uncompressedSize'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'L'</span></span>, <span class="hljs-string"><span class="hljs-string">'filenameLength'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, <span class="hljs-string"><span class="hljs-string">'extraFieldLength'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'S'</span></span>, ]); $LFH += readBytes($fh, [ <span class="hljs-string"><span class="hljs-string">'filename'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'a'</span></span>, $LFH[<span class="hljs-string"><span class="hljs-string">'filenameLength'</span></span>]], <span class="hljs-string"><span class="hljs-string">'extraField'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'a'</span></span>, $LFH[<span class="hljs-string"><span class="hljs-string">'extraFieldLength'</span></span>]], ]); $dataOffset = ftell($fh); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'&gt; '</span></span> . $CDFH[<span class="hljs-string"><span class="hljs-string">'filename'</span></span>] . <span class="hljs-string"><span class="hljs-string">' '</span></span> . $CDFH[<span class="hljs-string"><span class="hljs-string">'compressedSize'</span></span>] . <span class="hljs-string"><span class="hljs-string">' , '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'LFH: '</span></span> . $CDFH[<span class="hljs-string"><span class="hljs-string">'localFileHeaderOffset'</span></span>] . <span class="hljs-string"><span class="hljs-string">', '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' : '</span></span> . $dataOffset . <span class="hljs-string"><span class="hljs-string">', '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' : '</span></span> . ($dataOffset + $CDFH[<span class="hljs-string"><span class="hljs-string">'compressedSize'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> PHP_EOL; } fclose($fh);</code> </pre></div></div><br>  Als Ergebnis des Skripts sollten wir folgende Informationen √ºber das Archiv erhalten: <br><br><pre> <code class="plaintext hljs">$ php readzip.php EOCD    18873702   : 172  CDFH: 18864696    : &gt; 0.jpg 135021 , LFH: 0,  : 35,  : 135056 &gt; 1.jpg 205686 , LFH: 135056,  : 135091,  : 340777 &gt; 2.jpg 81393 , LFH: 340777,  : 340812,  : 422205 &gt; 3.jpg 64892 , LFH: 422205,  : 422240,  : 487132 ... &gt; 171.jpg 50465 , LFH: 18814194,  : 18814231,  : 18864696</code> </pre><br>  Und im Allgemeinen k√∂nnen wir dank dieser Daten bereits alles oder eine bestimmte Datei extrahieren. <br><br>  Wir haben die Verschl√ºsselungskomprimierung umgangen und betrachten nur den Fall, in dem wir die Daten im Archiv haben, aber dies ist nicht erforderlich, um die Struktur zu verstehen, und f√ºr diejenigen, die sich verwirren m√∂chten, wird es nicht schwierig sein, die Spezifikation zu lesen und die fehlende Funktionalit√§t basierend auf dieser Artikelserie hinzuzuf√ºgen. <br><br>  Daher denke ich, dass wir den Hauptzyklus als beendet betrachten k√∂nnen.  Wenn Sie noch Fragen haben oder ich mich an einige Erw√§hnungen in den Kommentaren zu fr√ºheren Artikeln erinnern werde, gibt es m√∂glicherweise einige zus√§tzliche Artikel. <br><br>  F√ºr sim alles. <br><br>  Und ich hoffe, dass es, obwohl es ein bisschen f√ºr dich war, immer noch interessant war :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de485264/">https://habr.com/ru/post/de485264/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de485236/index.html">Python-Konfigurationsdateien</a></li>
<li><a href="../de485238/index.html">Wir verwenden zu oft Redux-Selektoren</a></li>
<li><a href="../de485240/index.html">Layout go pet Projekt auf VPS</a></li>
<li><a href="../de485256/index.html">Ivan Lilekvist und Kim Dotkom, ein gro√ües Interview: Die Geschichte von Megaupload, Auslieferung an die Vereinigten Staaten, Freiheit, Bitcoin. Teil 1</a></li>
<li><a href="../de485260/index.html">13 H√§ufige Fehler f√ºr beginnende Business Analysten</a></li>
<li><a href="../de485266/index.html">Habr-Wettbewerb: Gewinner des Ideenwettbewerbs</a></li>
<li><a href="../de485268/index.html">Wenn .NET √ºberall funktioniert, dann auch unter Windows 3.11 und DOS</a></li>
<li><a href="../de485270/index.html">Hack admin</a></li>
<li><a href="../de485272/index.html">Taimyr Computer - Evolution ist umgekehrt</a></li>
<li><a href="../de485274/index.html">Moscow JS Meetup bei der Raiffeisenbank: senden Sie weiter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>