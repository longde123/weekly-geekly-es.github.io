<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•Ä ‚õΩÔ∏è ‚ò†Ô∏è C√≥mo construimos un cl√∫ster confiable de PostgreSQL en Patroni üõí ‚ú≥Ô∏è üë©üèΩ‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoy en d√≠a, se requiere una alta disponibilidad de servicios siempre y en todas partes, no solo en grandes proyectos costosos. Los sitios que no est√°n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo construimos un cl√∫ster confiable de PostgreSQL en Patroni</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/452846/"><img src="https://habrastorage.org/getpro/habr/post_images/17a/6e9/29d/17a6e929d3e8e24203871d573b17ef0d.jpg"><br><br>  Hoy en d√≠a, se requiere una alta disponibilidad de servicios siempre y en todas partes, no solo en grandes proyectos costosos.  Los sitios que no est√°n disponibles temporalmente con el mensaje "Lo sentimos, se est√° realizando el mantenimiento" a√∫n ocurren, pero generalmente causan una sonrisa condescendiente.  Agregue a esto la vida en las nubes, cuando para iniciar un servidor adicional solo necesita una llamada a la API, y no necesita pensar en la operaci√≥n "iron".  Y ya no hay ninguna excusa por la cual el sistema cr√≠tico no se hizo de manera confiable utilizando tecnolog√≠as de cl√∫ster y redundancia. <br><br>  Le diremos qu√© soluciones consideramos para garantizar la fiabilidad de las bases de datos en nuestros servicios y a qu√© llegamos.  Adem√°s de una demostraci√≥n con conclusiones de largo alcance. <br><a name="habracut"></a><br><h2>  Legado en arquitectura de alta disponibilidad </h2><br>  Esto se ve a√∫n mejor en el contexto del desarrollo de varios sistemas de c√≥digo abierto.  Las soluciones antiguas se vieron obligadas a agregar tecnolog√≠as de alta disponibilidad a medida que aumentaba la demanda.  Y su calidad era diferente.  Las soluciones de pr√≥xima generaci√≥n ponen la alta disponibilidad en el centro de su arquitectura.  Por ejemplo, MongoDB posiciona el cl√∫ster como el caso de uso principal.  El cl√∫ster se escala horizontalmente, lo cual es una gran ventaja competitiva de este DBMS. <br><br>  Volver a PostgreSQL.  Este es uno de los proyectos populares de c√≥digo abierto m√°s antiguos, cuyo primer lanzamiento tuvo lugar en el a√±o 95 del siglo pasado.  Durante mucho tiempo, el equipo del proyecto no consider√≥ la alta disponibilidad como una tarea que el sistema debe abordar.  Por lo tanto, la tecnolog√≠a de replicaci√≥n para crear copias de datos se integr√≥ solo en la versi√≥n 8.2 en 2006, pero se archiv√≥ (env√≠o de registros).  En 2010, apareci√≥ la replicaci√≥n de transmisi√≥n en la versi√≥n 9.0, y es la base para crear una amplia variedad de cl√∫steres.  De hecho, esto es muy sorprendente para las personas que conocen PostgreSQL despu√©s de Enterprise SQL o NoSQL moderno: la soluci√≥n est√°ndar de la comunidad es solo un par de r√©plicas maestras con replicaci√≥n s√≠ncrona o as√≠ncrona.  Al mismo tiempo, el asistente se cambia manualmente en el drenaje, y tambi√©n se propone que el problema de cambiar clientes se resuelva de forma independiente. <br><br><h2>  C√≥mo decidimos hacer PostgreSQL confiable y qu√© elegimos para esto </h2><br>  Sin embargo, PostgreSQL no se habr√≠a vuelto tan popular si no hubiera una gran cantidad de proyectos y herramientas que ayuden a construir una soluci√≥n tolerante a fallas que no requiera atenci√≥n constante.  Desde el lanzamiento de DBaaS, los servidores √∫nicos de PostgreSQL y los pares de r√©plicas maestras con replicaci√≥n as√≠ncrona han estado disponibles en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mail.ru Cloud Solutions</a> (MCS). <br><br>  Naturalmente, quer√≠amos simplificar la vida de todos y hacer que la instalaci√≥n de PostgreSQL est√© disponible, lo que podr√≠a servir como base para servicios altamente accesibles que no tendr√≠a que monitorear constantemente y despertarse por la noche para hacer el cambio.  En este segmento hay soluciones probadas y una generaci√≥n de nuevas utilidades que utilizan los √∫ltimos desarrollos. <br><br>  Hoy, el problema de la alta disponibilidad no se basa en la redundancia (no hace falta decirlo), sino en el consenso: un algoritmo para elegir un l√≠der (elecci√≥n de l√≠der).  La mayor√≠a de las veces, los accidentes mayores ocurren no por falta de servidores, sino por problemas de consenso: un nuevo l√≠der no sali√≥, dos l√≠deres aparecieron en diferentes centros de datos, etc.  Un ejemplo es un bloqueo en el cl√∫ster MySQL de Github: escribieron un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">post mortem detallado</a> . <br><br>  La base matem√°tica en este asunto es muy seria.  Por un lado, existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">teorema de CAP</a> , que impone restricciones te√≥ricas sobre la posibilidad de construir soluciones de HA, y por otro, algoritmos de determinaci√≥n de consenso matem√°ticamente probados como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Paxos</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Raft</a> .  Sobre esta base, existen DCS (sistemas de consenso descentralizados) bastante populares: Zookeeper, etc., c√≥nsul.  Por lo tanto, si el sistema de toma de decisiones funciona con algunos de sus propios algoritmos, escritos de forma independiente, debe ser extremadamente cuidadoso al respecto.  Despu√©s de analizar una gran cantidad de sistemas, nos decidimos por Patroni, un sistema de c√≥digo abierto, desarrollado principalmente por Zalando. <br><br>  Como una digresi√≥n l√≠rica, dir√© que tambi√©n consideramos soluciones multimaestro, es decir, grupos que se pueden escalar horizontalmente para grabar.  Sin embargo, por dos razones principales, decidieron no hacer ese grupo.  En primer lugar, tales soluciones tienen una alta complejidad y, en consecuencia, m√°s vulnerabilidades.  Ser√° dif√≠cil tomar una decisi√≥n estable para todos los casos.  En segundo lugar, en este caso, PostgreSQL deja de ser puro (nativo), algunas funciones no estar√°n disponibles, algunas aplicaciones pueden experimentar errores ocultos cuando funcionan. <br><br><h2>  Patroni </h2><br>  Entonces, ¬øc√≥mo funciona Patroni?  Los desarrolladores no reinventaron la rueda y sugirieron utilizar una de las soluciones DCS probadas como base.  Todos los problemas con la sincronizaci√≥n de las configuraciones, la elecci√≥n de un l√≠der y el qu√≥rum se le dan.  Hemos elegido etcd para esto. <br><br>  Luego, Patroni se ocupa de la aplicaci√≥n correcta de todas las configuraciones en PostgreSQL y las configuraciones de replicaci√≥n, as√≠ como la ejecuci√≥n de comandos en conmutaci√≥n y conmutaci√≥n por error (es decir, asistentes de conmutaci√≥n regulares y no est√°ndar).  Espec√≠ficamente, en la nube MCS, puede crear un cl√∫ster a partir de una r√©plica maestra, s√≠ncrona y una o m√°s r√©plicas as√≠ncronas.  La presencia de una r√©plica sincr√≥nica garantiza la seguridad de los datos en al menos 2 servidores, y esta r√©plica ser√° el principal "candidato para el maestro". <br><br>  Dado que etcd se implementa en los mismos servidores, se recomienda que el n√∫mero de servidores sea 3 o 5, para obtener el valor de qu√≥rum √≥ptimo.  Tal grupo se escala horizontalmente para leer (escrib√≠ sobre escalar para escribir arriba).  Sin embargo, debe tenerse en cuenta que las r√©plicas as√≠ncronas est√°n retrasadas, especialmente a altas cargas. <br><br>  El uso de tales r√©plicas en espera de lectura est√° justificado para tareas de informes o anal√≠ticas y descarga el servidor maestro. <br><br>  Si desea crear un cl√∫ster de este tipo, necesitar√°: <br><br><ul><li>  prepare 3 o m√°s servidores, configure el direccionamiento IP y las reglas de firewall entre ellos; <br></li><li>  instalar paquetes para servicios, etcd, Patroni, PostgreSQL; <br></li><li>  configurar el cl√∫ster etcd; <br></li><li>  configurar el servicio patroni para trabajar con PostgreSQL. <br></li></ul><br>  Es decir, en total, debe componer correctamente una docena de archivos de configuraci√≥n y no cometer errores en ning√∫n lado.  Para hacer esto, definitivamente vale la pena usar una herramienta de administraci√≥n de configuraci√≥n como Ansible, por ejemplo.  Sin embargo, todav√≠a no hay un equilibrador TCP altamente disponible.  Hacerlo es un trabajo separado. <br><br>  Para aquellos que necesitan un cl√∫ster listo para usar, pero no quieren jugar con todo esto, tratamos de simplificar nuestra vida e hicimos un cl√∫ster listo para usar en Patroni en nuestra nube, se puede probar de forma gratuita.  Adem√°s del cl√∫ster en s√≠, hicimos: <br><br><ul><li>  Equilibrador TCP  en diferentes puertos, siempre apunta a la r√©plica principal, s√≠ncrona o as√≠ncrona actual, respectivamente; <br></li><li>  API para cambiar el asistente activo de Patroni. <br></li></ul><br>  Se pueden conectar a trav√©s de la API de nube MCS y la consola web. <br><br><h2>  Demo </h2><br>  Para probar las capacidades del cl√∫ster PostgreSQL en la nube MCS, veamos c√≥mo se comporta una aplicaci√≥n en vivo en caso de problemas con el DBMS. <br><br>  El siguiente es el c√≥digo para una aplicaci√≥n que registrar√° eventos artificiales e informar√° esto a la pantalla.  En caso de errores, informar√° esto y continuar√° su trabajo en un ciclo hasta que lo detengamos con la combinaci√≥n Ctrl + C. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __future__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_function <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> random <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> randint <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sleep <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: connection = psycopg2.connect(user = <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, password = <span class="hljs-string"><span class="hljs-string">"P@ssw0rd"</span></span>, host = <span class="hljs-string"><span class="hljs-string">"89.208.87.38"</span></span>, port = <span class="hljs-string"><span class="hljs-string">"5432"</span></span>, database = <span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>) cursor = connection.cursor() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT version();"</span></span>) record = cursor.fetchone() print(<span class="hljs-string"><span class="hljs-string">"Connection opened to"</span></span>, record[<span class="hljs-number"><span class="hljs-number">0</span></span>]) cursor.execute( <span class="hljs-string"><span class="hljs-string">"INSERT INTO log VALUES ({});"</span></span>.format(randint(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>))) connection.commit() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT COUNT(event_id) from log;"</span></span>) record = cursor.fetchone() print(<span class="hljs-string"><span class="hljs-string">"Logged a value, overall count: {}"</span></span>.format(record[<span class="hljs-number"><span class="hljs-number">0</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> error: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"Error while connecting to PostgreSQL"</span></span>, error) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> connection: cursor.close() connection.close() print(<span class="hljs-string"><span class="hljs-string">"Connection closed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(datetime.now()) main() sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(<span class="hljs-string"><span class="hljs-string">"Caught error:\n"</span></span>, e) sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: print(<span class="hljs-string"><span class="hljs-string">"exit"</span></span>)</code> </pre> <br>  Una aplicaci√≥n necesita PostgreSQL para funcionar.  Cree un cl√∫ster en la nube MCS utilizando la API.  En un terminal normal, donde la variable OS_TOKEN contiene un token para acceder a la API (puede obtenerlo con el comando de emisi√≥n de token openstack), escribimos los comandos: <br><br>  Crea un cl√∫ster: <br><br><pre> <code class="bash hljs">cat &lt;&lt;EF &gt; pgc10.json {<span class="hljs-string"><span class="hljs-string">"cluster"</span></span>:{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"postgres10"</span></span>,<span class="hljs-string"><span class="hljs-string">"allow_remote_access"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-string"><span class="hljs-string">"datastore"</span></span>:{<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"postgresql"</span></span>,<span class="hljs-string"><span class="hljs-string">"version"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>},<span class="hljs-string"><span class="hljs-string">"databases"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>}],<span class="hljs-string"><span class="hljs-string">"users"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"databases"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>}],<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>,<span class="hljs-string"><span class="hljs-string">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"P@ssw0rd"</span></span>}],<span class="hljs-string"><span class="hljs-string">"instances"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}},{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}},{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}}]}} EOF curl -s -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OS_TOKEN</span></span></span><span class="hljs-string">"</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Accept: application/json'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> \ -d @pgc10.json https://infra.mail.ru:8779/v1.0/ce2a41bbd1434013b85bdf0ba07c770f/clusters</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/f2c/aee/463/f2caee46351a0f304dac92483739a3c5.png"><br><br>  Cuando el cl√∫ster ingresa al estado ACTIVO, todos los campos recibir√°n los valores actuales: el cl√∫ster est√° listo. <br><br>  En la GUI: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b2/0de/606/8b20de6065c6c703282c27f96a67724f.png"><br><br>  Intentemos conectarnos y crear una tabla: <br><br><pre> <code class="bash hljs">psql -h 89.208.87.38 -U admin -d myproddb Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user admin: psql (11.1, server 10.7) Type <span class="hljs-string"><span class="hljs-string">"help"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>. myproddb=&gt; CREATE TABLE <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> (event_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> NOT NULL); CREATE TABLE myproddb=&gt; INSERT INTO <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> VALUES (1),(2),(3); INSERT 0 3 myproddb=&gt; SELECT * FROM <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>; event_id ---------- 1 2 3 (3 rows) myproddb=&gt;</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/e04/c3f/7df/e04c3f7dfae02ca66e1f4163eb5b52d0.png"><br><br>  En la aplicaci√≥n, indicamos la configuraci√≥n actual para conectarse a PostgreSQL.  Especificaremos la direcci√≥n del equilibrador TCP, eliminando as√≠ la necesidad de cambiar manualmente a la direcci√≥n del asistente.  Ejec√∫talo.  Como puede ver, los eventos se registran correctamente en la base de datos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e37/fd2/33c/e37fd233cc670185c6da974e8ef54f9f.png"><br><br><h2>  Interruptor maestro programado </h2><br>  Ahora probaremos el funcionamiento de nuestra aplicaci√≥n durante el cambio planificado del asistente: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0d4/7de/e5d/0d47dee5d56f84efe7ade9790a219c8f.png"><br><br>  Estamos viendo la aplicaci√≥n.  Vemos que la aplicaci√≥n se interrumpe realmente, pero solo lleva unos segundos, en este caso particular, un m√°ximo de 9. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a52/d80/a34/a52d80a34309b6a0e771ca01a722a448.png"><br><br><h2>  Ca√≠da del coche </h2><br>  Ahora intentemos simular la ca√≠da de una m√°quina virtual, el maestro actual.  Ser√≠a posible simplemente apagar la m√°quina virtual a trav√©s de la interfaz Horizon, solo que ser√° un apagado regular.  Tal cambio ser√° procesado por todos los servicios, incluido Patroni. <br><br>  Necesitamos un cierre impredecible.  Por lo tanto, les ped√≠ a nuestros administradores con fines de prueba que apagaran la m√°quina virtual, el maestro actual, de manera anormal. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/101/231/8c8/1012318c85c30c4717e6db5df430afc3.png"><br><br>  Al mismo tiempo, nuestra aplicaci√≥n continu√≥ funcionando.  Naturalmente, dicho interruptor de emergencia del maestro no puede pasar desapercibido. <br><br><pre> <code class="bash hljs">2019-03-29 10:45:56.071234 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 453 Connection closed 2019-03-29 10:45:59.205463 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 454 Connection closed 2019-03-29 10:46:02.661440 Error <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connecting to PostgreSQL server closed the connection unexpectedly This probably means the server terminated abnormally before or <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> processing the request. Caught error: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> variable <span class="hljs-string"><span class="hljs-string">'connection'</span></span> referenced before assignment ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.. -  -   2019-03-29 10:46:30.930445 Error <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connecting to PostgreSQL server closed the connection unexpectedly This probably means the server terminated abnormally before or <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> processing the request. Caught error: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> variable <span class="hljs-string"><span class="hljs-string">'connection'</span></span> referenced before assignment 2019-03-29 10:46:31.954399 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 455 Connection closed 2019-03-29 10:46:35.409800 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 456 Connection closed ^Cexit</code> </pre><br>  Como puede ver, la aplicaci√≥n pudo continuar su trabajo en menos de 30 segundos.  S√≠, cierto n√∫mero de usuarios del servicio tendr√° tiempo para notar problemas.  Sin embargo, esta es una falla grave del servidor, esto no sucede con tanta frecuencia.  Al mismo tiempo, la persona (administrador) dif√≠cilmente habr√≠a logrado reaccionar tan r√°pido, a menos que estuviera sentado en la consola listo con un script de cambio. <br><br><h2>  Conclusi√≥n </h2><br>  Me parece que dicho cl√∫ster ofrece una tremenda ventaja para los administradores.  De hecho, las aver√≠as graves y el mal funcionamiento de los servidores de bases de datos no ser√°n perceptibles para la aplicaci√≥n y, en consecuencia, para el usuario.  No tendr√° que reparar algo r√°pidamente y cambiar a configuraciones temporales, servidores, etc.  Y si utiliza esta soluci√≥n en forma de un servicio listo para usar en la nube, no necesitar√° perder el tiempo prepar√°ndolo.  Ser√° posible hacer algo m√°s interesante. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452846/">https://habr.com/ru/post/452846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452836/index.html">¬øHerramientas web o d√≥nde comenzar un pentester?</a></li>
<li><a href="../452838/index.html">Integraci√≥n de 3CX con Office 365 a trav√©s de la API de Azure</a></li>
<li><a href="../452840/index.html">Conferencia VMware EMPOWER 2019: c√≥mo fue el primer d√≠a</a></li>
<li><a href="../452842/index.html">SMPP - Protocolo de mensajes cortos punto a punto</a></li>
<li><a href="../452844/index.html">Transformaci√≥n o blasfemias: c√≥mo "digitalizar" los operadores de telecomunicaciones</a></li>
<li><a href="../452848/index.html">¬øQu√© va a pasar el 1 de febrero de 2020?</a></li>
<li><a href="../452850/index.html">Sistemas dentro de cartuchos: c√≥mo los ingenieros ampliaron las capacidades de las consolas de juegos</a></li>
<li><a href="../452852/index.html">Trabajo remoto: mitos de noche</a></li>
<li><a href="../452854/index.html">De un usuario normal a un administrador de servidor completo (XSS, LFI, Web-Shell)</a></li>
<li><a href="../452856/index.html">¬øPor qu√© los proyectos independientes no viven para lanzar?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>