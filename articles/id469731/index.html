<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤣 💑 🧗🏼 Menangani Pengecualian ASP.NET Menggunakan IRO.Mvc.MvcExceptionHandler 🕸️ ⌨️ 😳</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jika Anda adalah seorang pengembang c # backend, Anda mungkin cepat atau lambat harus menemukan cara terpadu untuk menangani situasi luar biasa. Meski...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menangani Pengecualian ASP.NET Menggunakan IRO.Mvc.MvcExceptionHandler</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469731/"><img src="https://habrastorage.org/webt/qp/uf/w4/qpufw4gxcz0is2ivjqx-uncl2l0.jpeg"><br><br>  Jika Anda adalah seorang pengembang c # backend, Anda mungkin cepat atau lambat harus menemukan cara terpadu untuk menangani situasi luar biasa.  Meskipun, bahkan jika Anda puas dengan 500 kode dalam jawaban, artikel ini masih akan membantu meningkatkan metode Anda, sementara tidak memaksa apa pun untuk menulis ulang. <br><br>  Kami akan berbicara tentang pustaka ASP.NET, yang memungkinkan Anda untuk menyelesaikan masalah ini seanggun mungkin.  Bagi mereka yang terlalu malas untuk membaca artikel yang panjang - readme dan perpustakaan itu sendiri ada di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> , contohnya ada di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> .  Tersedia di nuget.org dan saya hanya akan senang jika itu bermanfaat bagi siapa pun.  Jadi, mari kita beralih ke kode.  Pertama, mari kita lihat alternatifnya. <br><a name="habracut"></a><br>  Salah satu hal pertama yang mungkin terlintas dalam pikiran adalah membuat DTO (objek transfer data) untuk menangani pengecualian, menangkap pengecualian pada pengontrol (meskipun tidak perlu bahwa itu akan menjadi pengecualian, dimungkinkan untuk hanya memeriksa nol atau sesuatu seperti itu), Isi data di DTO dan kirimkan ke klien.  Kode untuk metode ini mungkin terlihat seperti ini: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Code with exception. } catch (Exception ex) { return new JsonResult( new ErrorDto { IsError = true, Message = ex.Message }); } }</span></span></code> </pre> <br>  Pilihan lain adalah menggunakan kode status HTTP untuk ini. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Code with exception. } catch (Exception ex) { return BadRequest(); } }</span></span></code> </pre><br>  Praktik yang cukup umum, tetapi memiliki kelemahan: sulit untuk menggambarkan esensi situasi Anda dengan salah satu kode standar, itulah sebabnya kode yang sama dapat ditafsirkan berbeda bahkan pada sistem yang sama, dan juga memberikan informasi yang terlalu sedikit untuk debugging ke pengembang. <br><br>  Dan di sini beberapa bahkan mungkin mulai menggabungkan kedua metode ini, dan dalam proporsi yang berbeda.  Di suatu tempat mereka akan lupa untuk mengirim DTO, di suatu tempat kode tidak akan dikirim atau yang salah akan dikirim, tetapi di suatu tempat secara umum akan diserialisasi dengan pengaturan json yang salah dan akan kembali tidak apa yang dibutuhkan. <br><br>  Menghadapi hal di atas, banyak yang mencoba untuk menyelesaikan masalah ini menggunakan <b>app.UseExceptionHandler ();</b>  dengan menangani pengecualian melalui itu.  Ini adalah upaya yang baik, tetapi tidak akan membiarkan Anda dengan mudah melupakan masalahnya.  Pertama, Anda masih akan menghadapi masalah dalam memilih DTO untuk pengecualian.  Kedua, penangan seperti itu tidak akan mengizinkan untuk memproses kode kesalahan http yang dikembalikan dari pengontrol, karena  Pengecualian tidak terjadi.  Ketiga, dengan cara ini tidak nyaman untuk menyelesaikan masalah klasifikasi kesalahan, Anda harus menulis banyak kode untuk melampirkan pesan, kode http atau sesuatu untuk setiap pengecualian.  Dan keempat, Anda kehilangan kesempatan untuk menggunakan AspA DeveloperExceptionPage, yang sangat tidak nyaman untuk debugging.  Bahkan jika Anda entah bagaimana menyelesaikan masalah ini, maka semua pengembang pada proyek ini harus benar-benar mengikuti spesifikasi, membangun penanganan kesalahan secara khusus pada pengecualian, jangan mengembalikan DTO mereka, jika tidak kesalahan dalam api Anda mungkin terlihat berbeda dari metode ke metode. <br><br><h2>  Pilihan penanganan pengecualian yang dipilih </h2><br>  Sebelum saya menunjukkan bagaimana IRO.Mvc.MvcExceptionHandler memungkinkan Anda untuk menangani pengecualian, pertama saya akan menjelaskan bagaimana saya melihat penanganan pengecualian yang ideal.  Untuk melakukan ini, kami menetapkan sejumlah persyaratan: <br><br><ol><li>  Seharusnya DTO, tetapi kami juga tidak menolak kode http, karena  untuk banyak kesalahan, mereka masih sangat cocok, dapat digunakan di mana-mana dan dalam proyek lama yang harus Anda dukung juga, dan mereka cukup universal.  DTO standar akan mencakup bidang IsError (yang memungkinkan penulisan penanganan kesalahan universal pada klien), juga harus berisi kode kesalahan string ErrorKey, yang dapat segera dikenali oleh pengembang hanya dengan melihatnya dan menyediakan informasi lebih lanjut.  Selain itu, Anda dapat menambahkan tautan ke halaman dengan deskripsi kesalahan ini, jika perlu. </li><li>  Ini semua ada di prod.  Dalam mode pengembangan, DTO ini harus mengembalikan jejak tumpukan, meminta data: cookie, header, parameter.  Ke depan, middleware yang dijelaskan dalam artikel bahkan mengembalikan tautan ke DeveloperExceptionPage yang dihasilkan, yang memungkinkan Anda untuk menonton jejak pengecualian dalam bentuk yang mudah, tetapi lebih lanjut tentang itu nanti. </li><li>  Pengembang dapat mengikat pengecualian, kode kesalahan http, dan ErrorKey.  Ini berarti bahwa jika ia mengirim kode 403 dari controller, maka jika pengembang melampirkan ErrorKey khusus untuk itu, DTO dengan itu akan dikembalikan.  Dan sebaliknya, jika UnauthorizedAccessException terjadi, itu akan terikat pada kode http dan ErrorKey. </li></ol><br>  Ini adalah format default yang digunakan di perpustakaan: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"__IsError"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ErrorKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"ClientException"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"InfoUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://iro.com/errors/ClientException"</span></span> }</code> </pre><br>  Saya harus mengatakan segera bahwa bentuk di mana data akan dikirim ke klien dapat benar-benar ada, ini hanya salah satu opsi. <br><br><h2>  IRO.Mvc.MvcExceptionHandler </h2><br>  Sekarang saya akan menunjukkan bagaimana saya memecahkan masalah ini untuk diri saya sendiri dengan menulis perpustakaan IRO.Mvc.MvcExceptionHandler. <br><br>  Kami menghubungkan handler pengecualian seperti middleware lainnya - di kelas Startup. <br><br><pre> <code class="cs hljs">app.UseMvcExceptionHandler((s) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//Settings... });</span></span></code> </pre><br>  Di dalam delegasi yang sedang didelegasikan, kita perlu mengkonfigurasi middleware kita.  Hal ini diperlukan untuk memetakan (mengikat) pengecualian pada kode http dan ErrorKey.  Di bawah ini adalah opsi pengaturan yang paling mudah. <br><br><pre> <code class="cs hljs"> s.Mapping((builder) =&gt; { builder.RegisterAllAssignable&lt;Exception&gt;( httpCode: <span class="hljs-number"><span class="hljs-number">500</span></span>, errorKeyPrefix: <span class="hljs-string"><span class="hljs-string">"Ex_"</span></span> ); });</code> </pre><br>  Seperti yang saya janjikan kepada pengembang hardcore paling <s>malas</s> yang tidak terbiasa menangani pengecualian - tidak ada lagi yang perlu dilakukan.  Kode ini akan mengikat semua pengecualian dalam pipa ASP.NET ke DTO umum dengan kode 500, dan nama pengecualian akan ditulis ke ErrorKey. <br><br>  Penting untuk dipahami bahwa metode RegisterAllAssignable tidak hanya mendaftarkan pengecualian dari tipe yang ditentukan, tetapi juga semua turunannya.  Jika Anda hanya ingin mengirim informasi tentang pengecualian khusus kepada klien, itu adalah keputusan yang sepenuhnya masuk akal untuk membuat ClientException Anda dan memetakannya saja.  Pada saat yang sama, jika Anda menetapkan satu kode http untuk ClientException, dan menetapkan kode lain untuk penerusnya SpecialClientException, maka kode SpecialClientException akan digunakan untuk semua keturunannya, mengabaikan pengaturan ClientException.  Semua ini di-cache, sehingga tidak akan ada masalah kinerja. <br><br>  Anda dapat menyempurnakan dan mendaftarkan kode ErrorKey dan http Anda untuk pengecualian tertentu: <br><br><pre> <code class="cs hljs"> s.Mapping((builder) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//By exception, custom error key. builder.Register&lt;ArgumentNullException&gt;( httpCode: 555, errorKey: "CustomErrorKey" ); //By http code. builder.Register( httpCode: 403, errorKey: "Forbidden" ); //By exception, default ErrorKey and http code. builder.Register&lt;NullReferenceException&gt;(); //Alternative registration method. builder.Register((ErrorInfo) new ErrorInfo() { ErrorKey = "MyError", ExceptionType = typeof(NotImplementedException), HttpCode = 556 }); });</span></span></code> </pre><br>  Selain pemetaan, ada baiknya mengkonfigurasi middleweights.  Anda dapat menentukan pengaturan serialisasi json, alamat situs Anda, tautan ke halaman deskripsi kesalahan, mode operasi middleware melalui IsDebug, kode http standar untuk pengecualian tanpa penanganan. <br><br><pre> <code class="cs hljs"> s.ErrorDescriptionUrlHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormattedErrorDescriptionUrlHandler(<span class="hljs-string"><span class="hljs-string">"https://iro.com/errors/{0}"</span></span>); s.IsDebug = isDebug; s.DefaultHttpCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; s.JsonSerializerSettings.Formatting = Formatting.Indented; s.Host=<span class="hljs-string"><span class="hljs-string">"https://iro.com"</span></span>; s.CanBindByHttpCode = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre><br>  Properti terakhir menunjukkan apakah mungkin untuk mengikat DTO kami dengan kode http. <br>  Anda juga dapat menentukan cara menangani situasi dengan pengecualian internal, misalnya TaskCanceledException dengan kesalahan internal yang dicatat karena. Tunggu ().  Misalnya, berikut ini adalah resolver standar yang mengeluarkan pengecualian internal dari pengecualian tersebut dan sudah bekerja dengannya: <br><br><pre> <code class="cs hljs"> s.InnerExceptionsResolver = InnerExceptionsResolvers.InspectAggregateException;</code> </pre><br>  Jika Anda perlu menyempurnakan serialisasi, Anda dapat mengatur metode FilterAfterDTO.  Kembalikan benar untuk menonaktifkan pemrosesan standar dan membuat serialisasi errorContext.ErrorDTO yang Anda inginkan.  Ada akses ke HttpContext dan kesalahan itu sendiri. <br><br><pre> <code class="cs hljs"> s.FilterAfterDTO = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (errorContext) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//Custom error handling. Return true if MvcExceptionHandler must ignore current error, //because it was handled. return false; };</span></span></code> </pre><br><h2>  DeveloperExceptionPage dan keuntungan lain dari mode debug </h2><br>  Kami telah menemukan pengaturannya, sekarang mari kita cari tahu cara men-debug semuanya.  Di prod DTO, jawaban dalam jawabannya sederhana dan saya sudah menunjukkannya di atas, sekarang saya akan menunjukkan bagaimana DTO yang sama terlihat dalam mode debug: <br><br><img src="https://habrastorage.org/webt/da/yo/wf/dayowfdy5xfftmrpeg0czujz8os.png"><br><br>  Seperti yang Anda lihat, ada banyak informasi lebih lanjut di sini, ada stackrace dan data permintaan.  Tetapi bahkan lebih nyaman untuk hanya mengikuti tautan di bidang DebugUrl dan melihat data kesalahan tanpa melelahkan: <br><br><img src="https://habrastorage.org/webt/td/i3/ki/tdi3ki-kc-hr7s6umrlpx3txkci.jpeg"><br><br>  Agak sulit untuk mengimplementasikan fungsi ini, karena  DeveloperExceptionPage tidak dimaksudkan untuk digunakan oleh pengembang pihak ketiga.  Awalnya, tidak mungkin untuk membuka tautan di browser dengan sesi yang berbeda, konten tidak lagi ditampilkan setelah reboot.  Semua ini bisa diselesaikan hanya dengan caching respons html dari perantara ini.  Sekarang Anda setidaknya dapat mengirimkan tautan pengecualian ke rekan setim Anda jika Anda menggunakan server khusus yang dibagikan. <br><br><h2>  Kesimpulan </h2><br>  Saya harap para pengembang yang membaca artikel ini telah menemukan alat yang menarik dan bermanfaat untuk diri mereka sendiri.  Bagi saya, artikel ini sebagian merupakan ujian dari kegunaan perkembangannya dan artikel tentang mereka.  Saya memiliki beberapa proyek keren yang siap pakai yang ingin saya sampaikan kepada komunitas Habr. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id469731/">https://habr.com/ru/post/id469731/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id469709/index.html">Blitz Engine & Battle Prime: ECS dan Kode Jaringan</a></li>
<li><a href="../id469717/index.html">Biarkan cahaya bersinar</a></li>
<li><a href="../id469721/index.html">Dell OptiPlex 7070 Ultra: komputer modular yang mengubah setiap monitor menjadi monoblok</a></li>
<li><a href="../id469723/index.html">Menciptakan keterampilan stateful untuk Alice pada fungsi serverless Yandex.Cloud dan Python</a></li>
<li><a href="../id469725/index.html">Panduan Tata Surya untuk Hitchhikers</a></li>
<li><a href="../id469733/index.html">Mobil RC: Pembelian Pertama - Chassis dan Powertrain</a></li>
<li><a href="../id469735/index.html">Algoritma untuk menghitung akar tingkat ke-n dari angka positif yang berubah-ubah</a></li>
<li><a href="../id469737/index.html">Mainan Kayu, Bagian Lima - 1991</a></li>
<li><a href="../id469739/index.html">Mainan Kayu, Bagian Enam - 1992</a></li>
<li><a href="../id469741/index.html">Celestia: Petualangan Bugs di Luar Angkasa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>