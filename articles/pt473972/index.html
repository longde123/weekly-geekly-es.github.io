<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ûüèΩ üèø üñåÔ∏è Por ordem dos desenvolvedores incorporados: procurando bugs no Amazon FreeRTOS üëÅ‚Äçüó® üëèüèª ü•°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todo mundo que programa microcontroladores provavelmente conhece o FreeRTOS, ou pelo menos ouviu falar sobre esse sistema operacional. Os funcion√°rios...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Por ordem dos desenvolvedores incorporados: procurando bugs no Amazon FreeRTOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/473972/">  Todo mundo que programa microcontroladores provavelmente conhece o FreeRTOS, ou pelo menos ouviu falar sobre esse sistema operacional.  Os funcion√°rios da Amazon decidiram expandir os recursos deste sistema operacional para trabalhar com os servi√ßos da AWS Internet of Things - foi assim que o Amazon FreeRTOS apareceu.  N√≥s, desenvolvedores do analisador de c√≥digo PVS-Studio, fomos solicitados a verificar esses projetos pelo correio e nos coment√°rios abaixo dos artigos.  Bem, voc√™ perguntou - n√≥s fizemos.  O que veio disso - continue lendo. <br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8d2/efa/d2f/8d2efad2f7885ec13add7368f6d2ff96.png" alt="Figura 3"></div><a name="habracut"></a><br><h2>  Um pouco sobre projetos </h2><br>  Para come√ßar, vou falar um pouco sobre o "pai" do projeto verificado - FreeRTOS (voc√™ pode encontrar o c√≥digo fonte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ).  Como a Wikipedia diz, o FreeRTOS √© um sistema operacional de multitarefa em tempo real para sistemas embarcados. <br><br>  Foi escrito no bom e velho C, o que n√£o √© surpreendente - esse sistema operacional deve funcionar em condi√ß√µes t√≠picas de microcontroladores: baixo poder de computa√ß√£o, uma pequena quantidade de RAM e similares.  A linguagem C permite que voc√™ trabalhe com recursos em um n√≠vel baixo e com alto desempenho, por isso √© o mais adequado para o desenvolvimento de um sistema operacional desse tipo. <br><br>  Agora, de volta √† Amaz√¥nia, que n√£o fica parada e se desenvolve em v√°rias √°reas promissoras.  Por exemplo, a Amazon est√° desenvolvendo o mecanismo AAA do jogo Amazon Lumberyard, que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tamb√©m testamos</a> . <br><br>  Uma dessas √°reas √© a Internet das Coisas (Internet of Things, IoT).  Para desenvolver nesta √°rea, a Amazon decidiu escrever seu pr√≥prio sistema operacional - e eles tomaram o kernel do FreeRTOS como base. <br><br>  O sistema resultante - Amazon FreeRTOS - est√° posicionado como "fornecendo a capacidade de conectar-se com seguran√ßa ao Amazon Web Services, como AWS IoT Core ou AWS IoT Greengrass".  O c√≥digo fonte deste projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° armazenado</a> no Github. <br><br>  Neste artigo, examinaremos se h√° erros no FreeRTOS, bem como a seguran√ßa do sistema operacional da Amazon em termos de an√°lise de c√≥digo est√°tico. <br><br><h2>  Como foi o cheque </h2><br>  O c√≥digo foi verificado usando uma ferramenta de busca autom√°tica de erros: analisador de c√≥digo est√°tico PVS-Studio.  √â capaz de detectar erros em programas escritos em C, C ++, C # e Java. <br><br>  Antes de iniciar a an√°lise, √© necess√°rio montar o projeto - para ter certeza de que tenho todas as depend√™ncias necess√°rias e que tudo est√° em ordem com o projeto.  Existem v√°rias maneiras de verificar um projeto - por exemplo, usando um sistema de monitoramento de compila√ß√£o.  Fiz a an√°lise usando o plug-in do Visual Studio - √© bom que os reposit√≥rios dos dois projetos tenham um conjunto de arquivos de projeto que facilitam a cria√ß√£o no Windows. <br><br>  Tudo o que era necess√°rio para mim era coletar os projetos para garantir que houvesse tudo o que era necess√°rio para verifica√ß√£o.  Em seguida, lancei a an√°lise e pronto!  - na minha frente h√° um relat√≥rio do analisador pronto. <br><br>  As bibliotecas de terceiros inclu√≠das nesses projetos tamb√©m podem conter erros e, √© claro, tamb√©m podem afetar a opera√ß√£o do programa.  No entanto, eu os exclu√≠ da an√°lise por uma quest√£o de pureza da narra√ß√£o. <br><br>  Assim, os projetos s√£o analisados, os relat√≥rios s√£o recebidos, erros interessantes s√£o gravados.  √â hora de avan√ßar para a an√°lise deles! <br><br><h2>  O que esconde o FreeRTOS </h2><br>  Inicialmente, esperava escrever dois artigos separados: um para cada sistema operacional.  Eu j√° esfreguei minhas m√£os, preparando-me para escrever um bom artigo sobre o FreeRTOS.  Antecipando a detec√ß√£o de pelo menos alguns erros interessantes (como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CWE-457</a> ), observei ansiosamente os poucos avisos do analisador e ... e nada.  N√£o encontrei nenhum erro interessante. <br><br>  Muitos avisos emitidos pelo analisador n√£o eram relevantes para o FreeRTOS.  Por exemplo, esses avisos eram defici√™ncias de 64 bits, como <i>converter tamanho_t</i> para <i>uint32_t</i> .  Isso se deve ao fato de o FreeRTOS ter sido projetado para funcionar em dispositivos com um tamanho de ponteiro de no m√°ximo 32 bits. <br><br>  Eu verifiquei cuidadosamente todos os avisos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V1027</a> relacionados a convers√µes entre ponteiros e estruturas n√£o relacionadas.  Se estruturas redut√≠veis t√™m o mesmo alinhamento, essa convers√£o n√£o √© um erro.  E n√£o encontrei um √∫nico elenco perigoso! <br><br>  Todos os outros lugares suspeitos estavam relacionados ao estilo de codifica√ß√£o ou foram equipados com um coment√°rio explicando por que isso √© feito exatamente aqui e por que isso n√£o √© um erro. <br><br>  Em geral, quero entrar em contato com os desenvolvedores do FreeRTOS.  Voc√™s s√£o realmente √≥timos!  Quase nunca conhecemos projetos t√£o limpos e de alta qualidade como o seu.  Fiquei muito satisfeito ao ler c√≥digos limpos, arrumados e bem documentados.  Tiremos o chap√©u para voc√™. <br><br>  Embora n√£o tenha encontrado nenhum erro interessante naquele dia, entendi que n√£o iria parar por a√≠.  Eu estava voltando para casa com uma firme convic√ß√£o de que algo interessante seria encontrado na vers√£o da Amazon 100% e que amanh√£ eu definitivamente coletaria erros suficientes para o artigo.  Como voc√™ provavelmente adivinhou, eu estava certa. <br><br><h2>  O que oculta o Amazon FreeRTOS </h2><br>  A vers√£o do sistema da Amazon acabou por ser ... para dizer o m√≠nimo, um pouco pior.  O legado do FreeRTOS permaneceu igualmente limpo, mas as novas revis√µes foram bastante interessantes. <br><br>  Em alguns lugares, a l√≥gica do programa foi violada, em algum lugar trabalhado incorretamente com ponteiros.  Em alguns lugares, o c√≥digo pode levar a um comportamento indefinido, mas em algum lugar o programador simplesmente n√£o sabia sobre o padr√£o de erro que ele fez.  Eu at√© encontrei algumas vulnerabilidades em potencial s√©rias. <br><br>  Algo que adiei com a introdu√ß√£o.  Vamos come√ßar a analisar os bugs! <br><br><h3>  Viola√ß√£o l√≥gica do programa </h3><br>  Vamos come√ßar com as √°reas problem√°ticas, que indicam claramente que o programa n√£o √© executado exatamente como o programador esperava.  O primeiro desses locais ser√° um trabalho suspeito com uma matriz: <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Pool of request and associated response buffers, * handles, and configurations. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> _requestPool_t _requestPool = { <span class="hljs-number"><span class="hljs-number">0</span></span> }; .... <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _scheduleAsyncRequest(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> reqIndex, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> currentRange) { .... <span class="hljs-comment"><span class="hljs-comment">/* Set the user private data to use in the asynchronous callback context. */</span></span> _requestPool.pRequestDatas[reqIndex].pConnHandle = &amp;_connHandle; _requestPool.pRequestDatas[reqIndex].pConnConfig = &amp;_connConfig; _requestPool.pRequestDatas[reqIndex].reqNum = reqIndex; _requestPool.pRequestDatas[reqIndex].currRange = currentRange; _requestPool.pRequestDatas[reqIndex].currDownloaded = <span class="hljs-number"><span class="hljs-number">0</span></span>; _requestPool.pRequestDatas[reqIndex].numReqBytes = numReqBytes; .... _requestPool.pRequestDatas-&gt;scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  O PVS-Studio emitiu dois avisos para este trecho de c√≥digo: <br><br><ul><li>  V619 A matriz '_requestPool.pRequestDatas' est√° sendo utilizada como um ponteiro para um √∫nico objeto.  iot_demo_https_s3_download_async.c 973 </li><li>  V574 O ponteiro '_requestPool.pRequestDatas' √© usado simultaneamente como uma matriz e como um ponteiro para um √∫nico objeto.  Verifique as linhas: 931, 973. iot_demo_https_s3_download_async.c 973 </li></ul><br>  Apenas para o caso, deixe-me lembr√°-lo: o nome da matriz √© um ponteiro para seu primeiro elemento.  Ou seja, se <i>_requestPool.pRequestDatas</i> for uma matriz de estruturas, <i>_requestPool.pRequestDatas [i] .scheduled</i> √© o acesso ao membro <i>agendado</i> da <i>i-</i> √©sima estrutura da matriz.  E se voc√™ escrever <i>_requestPool.pRequestDatas-&gt; agendado</i> , isso significar√° acesso ao membro <i>agendado</i> da primeira estrutura da matriz. <br><br>  √â o que acontece no snippet de c√≥digo acima.  A √∫ltima linha sempre altera o valor apenas para um membro da primeira estrutura da matriz.  Por si s√≥, essa chamada j√° √© suspeita, mas a situa√ß√£o aqui √© ainda mais √≥bvia: em todo o corpo da fun√ß√£o, o array <i>_requestPool.pRequestDatas √©</i> acessado pelo √≠ndice, e somente no final a opera√ß√£o de indexa√ß√£o foi esquecida. <br><br>  Pelo que entendi, a √∫ltima linha deve ficar assim: <br><br><pre> <code class="cpp hljs">_requestPool.pRequestDatas[reqIndex].scheduled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br>  O erro a seguir est√° em uma fun√ß√£o pequena, portanto, eu a darei na √≠ntegra: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Return true if the string " pcString" is found * inside the token pxTok in JSON file pcJson. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BaseType_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prvGGDJsoneq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcJson, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">jsmntok_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pxTok, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pcString )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ulStringSize = ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;end - ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) pxTok-&gt;start; BaseType_t xStatus = pdFALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( pxTok-&gt;type == JSMN_STRING ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>( pcString ) == ulStringSize ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> ) <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>( &amp;pcJson[ pxTok-&gt;start ], <span class="hljs-comment"><span class="hljs-comment">// &lt;= pcString, ulStringSize ) == 0 ) { xStatus = pdTRUE; } } } return xStatus; }</span></span></code> </pre> <br>  <b>PVS-Studio Warning:</b> V642 [CWE-197] Salvar o resultado da fun√ß√£o 'strncmp' dentro da vari√°vel do tipo 'short' √© inapropriado.  Os bits significativos podem ser perdidos quebrando a l√≥gica do programa.  aws_greengrass_discovery.c 637 <br><br>  Vamos dar uma olhada na defini√ß√£o da fun√ß√£o strncmp: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">strncmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count )</span></span></span></span>;</code> </pre> <br>  No exemplo, um resultado do tipo <i>int</i> , cujo tamanho √© 32 bits, √© convertido em uma vari√°vel do tipo <i>int16_t</i> .  Com essa convers√£o "restritiva", os bits mais significativos do valor de retorno ser√£o perdidos.  Por exemplo, se a fun√ß√£o <i>strncmp</i> retornar <i>0x00010000</i> , a fun√ß√£o ser√° <i>perdida</i> durante a convers√£o e a condi√ß√£o ser√° atendida. <br><br>  De fato, √© estranho ver esse elenco em uma condi√ß√£o.  Por que fazer isso se voc√™ pode comparar <i>int</i> normal com zero?  Por outro lado, se o programador conscientemente desejava que a fun√ß√£o √†s vezes retornasse <i>verdadeira</i> , mesmo que n√£o devesse, ent√£o por que esse comportamento complicado n√£o √© descrito pelo coment√°rio?  Mas ent√£o isso j√° √© um marcador.  Em geral, estou inclinado a acreditar que isso √© um erro.  O que voc√™ acha? <br><br><h3>  Comportamento indefinido e indicadores </h3><br>  Agora haver√° um exemplo bastante amplo.  Ele oculta a desreferencia√ß√£o potencial de um ponteiro nulo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _networkReceiveCallback(....) { IotHttpsReturnCode_t status = IOT_HTTPS_OK; _httpsResponse_t* pCurrentHttpsResponse = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; IotLink_t* pQItem = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-comment"><span class="hljs-comment">/* Get the response from the response queue. */</span></span> IotMutex_Lock(&amp;(pHttpsConnection-&gt;connectionMutex)); pQItem = IotDeQueue_PeekHead(&amp;(pHttpsConnection-&gt;respQ)); IotMutex_Unlock(&amp;(pHttpsConnection-&gt;connectionMutex)); <span class="hljs-comment"><span class="hljs-comment">/* If the receive callback is invoked * and there is no response expected, * then this a violation of the HTTP/1.1 protocol. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pQItem == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { IotLogError(....); fatalDisconnect = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; status = IOT_HTTPS_NETWORK_ERROR; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> iotCleanup; } .... iotCleanup : <span class="hljs-comment"><span class="hljs-comment">/* Report errors back to the application. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != IOT_HTTPS_OK) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pCurrentHttpsResponse-&gt;isAsync &amp;&amp; pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback) { pCurrentHttpsResponse-&gt;pCallbacks-&gt;errorCallback(....); } pCurrentHttpsResponse-&gt;syncStatus = status; } .... }</code> </pre> <br>  <b>Aviso do PVS-Studio:</b> V522 [CWE-690] Pode haver desreferencia√ß√£o de um ponteiro nulo em potencial 'pCurrentHttpsResponse'.  iot_https_client.c 1184 <br><br>  As desrefer√™ncias de problemas est√£o na parte inferior <i>se</i> .  Vamos ver o que acontece aqui. <br><br>  No in√≠cio da fun√ß√£o, as <i>vari√°veis ‚Äã‚ÄãpCurrentHttpsResponse</i> e <i>pQItem s√£o</i> inicializadas em <i>NULL</i> e a vari√°vel de <i>status</i> √© <i>inicializada</i> em <i>IOT_HTTPS_OK</i> , o que significa que tudo ocorre sem problemas. <br><br>  Em seguida, <i>√©</i> atribu√≠do ao <i>pQItem</i> o valor retornado da fun√ß√£o <i>IotDeQueue_PeekHead</i> , que retorna um ponteiro para o in√≠cio de uma fila duplamente conectada. <br><br>  O que acontece se a fila estiver vazia?  Nesse caso, a fun√ß√£o <i>IotDeQueue_PeekHead</i> retornar√° <i>NULL</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotDeQueue_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotDeQueue_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pQueue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IotListDouble_PeekHead(pQueue); } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> IotLink_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IotListDouble_PeekHead</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IotListDouble_t* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pList)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* @[declare_linear_containers_list_double_peekhead] */</span></span></span><span class="hljs-function"> </span></span>{ IotLink_t* pHead = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pList != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IotListDouble_IsEmpty(pList) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { pHead = pList-&gt;pNext; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pHead; }</code> </pre> <br>  Em seguida, a condi√ß√£o <i>pQItem == NULL √©</i> atendida e o fluxo de controle <i>prossegue</i> via <i>goto</i> para a parte inferior do corpo da fun√ß√£o.  A essa altura, o ponteiro <i>pCurrentHttpsResponse</i> permanecer√° nulo e o <i>status</i> n√£o <i>ser√°</i> mais igual a <i>IOT_HTTPS_OK</i> .  Como resultado, cairemos nesse mesmo ramo <i>se</i> , e ... amplos!  As consequ√™ncias dessa desreferencia√ß√£o voc√™ mesmo conhece. <br><br>  Ok  Foi um exemplo levemente ornamentado.  Agora, trago √† sua aten√ß√£o uma desreferencia√ß√£o potencial muito simples e compreens√≠vel: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PKI_mbedTLSSignatureToPkcs11Signature</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxSignaturePKCS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pxMbedSignature )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xReturn = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> * pxNextLength; <span class="hljs-comment"><span class="hljs-comment">/* The 4th byte contains the length of the R component */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ucSigComponentLength = pxMbedSignature[ <span class="hljs-number"><span class="hljs-number">3</span></span> ]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if( ( pxSignaturePKCS == NULL ) || ( pxMbedSignature == NULL ) ) { xReturn = FAILURE; } .... }</span></span></code> </pre> <br>  <b>Aviso do PVS-Studio:</b> V595 [CWE-476] O ponteiro 'pxMbedSignature' foi utilizado antes de ser verificado no nullptr.  Verifique as linhas: 52, 54. iot_pki_utils.c 52 <br><br>  Esta fun√ß√£o obt√©m dois ponteiros para <i>uint8_t</i> .  Os dois ponteiros s√£o verificados quanto a <i>NULL</i> , o que √© uma boa pr√°tica - essas situa√ß√µes devem ser resolvidas imediatamente. <br><br>  Mas aqui est√° a m√° sorte: quando o <i>pxMbedSignature</i> for verificado, ele j√° ser√° desreferenciado literalmente uma linha acima.  Ta-daa! <br><br>  Outro exemplo de c√≥digo especulativo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">CK_RV </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vAppendSHA256AlgorithmIdentifierSequence</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x32ByteHashedMessage, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * x51ByteHashOidBuffer )</span></span></span><span class="hljs-function"> </span></span>{ CK_RV xResult = CKR_OK; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> xOidSequence[] = pkcs11STUFF_APPENDED_TO_RSA_SIG; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ( x32ByteHashedMessage == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) || ( x51ByteHashOidBuffer == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) ) { xResult = CKR_ARGUMENTS_BAD; } <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( x51ByteHashOidBuffer, xOidSequence, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>( &amp;x51ByteHashOidBuffer[ <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>( xOidSequence ) ], x32ByteHashedMessage, <span class="hljs-number"><span class="hljs-number">32</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> xResult; }</code> </pre> <br>  <b>Avisos do PVS-Studio:</b> <br><br><ul><li>  V1004 [CWE-628] O ponteiro 'x51ByteHashOidBuffer' foi usado sem seguran√ßa ap√≥s ser verificado com rela√ß√£o ao nullptr.  Verifique as linhas: 275, 280. iot_pkcs11.c 280 </li><li>  V1004 [CWE-628] O ponteiro 'x32ByteHashedMessage' foi usado sem seguran√ßa ap√≥s ser verificado no nullptr.  Verifique as linhas: 275, 281. iot_pkcs11.c 281 </li></ul><br>  O analisador avisa que os par√¢metros de fun√ß√£o que s√£o indicadores s√£o usados ‚Äã‚Äãde maneira insegura ap√≥s serem testados quanto a <i>NULL</i> .  De fato, os argumentos s√£o verificados, mas se algum deles for <i>NULL</i> , nenhuma a√ß√£o ser√° tomada, exceto a grava√ß√£o em <i>xResult</i> .  Este trecho de c√≥digo parece dizer: ‚ÄúSim, isso significa que os argumentos acabaram sendo ruins.  Vamos anot√°-lo agora, enquanto voc√™ continuar, continue. " <br><br>  Bottom line: <i>NULL</i> ser√° passado para <i>memcpy</i> .  O que pode vir disso?  Onde os valores ser√£o copiados e quais?  De fato, adivinhar isso n√£o vale a pena, porque  a norma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">afirma claramente</a> que essa chamada leva a um comportamento indefinido (consulte o par√°grafo 1). <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf7/7d6/856/cf77d6856666f6a1529a1744832bd5bf.png" alt="Figura 2"></div><br><br>  O relat√≥rio do analisador ainda cont√©m exemplos de opera√ß√£o incorreta com ponteiros que encontrei no Amazon FreeRTOS, mas acho que os exemplos acima s√£o suficientes para mostrar os recursos do PVS-Studio na detec√ß√£o de tais erros.  Considere algo novo. <br><br><h3>  VERDADEIRO! = 1 </h3><br>  V√°rios erros que encontrei estavam relacionados a um padr√£o que, infelizmente, √© frequentemente esquecido. <br><br>  O fato √© que o tipo <i>bool</i> (de C ++) √© diferente do tipo <i>BOOL</i> (geralmente usado em C).  O primeiro pode conter apenas <i>verdadeiro</i> ou <i>falso</i> .  O segundo √© um typedef de algum tipo inteiro ( <i>int</i> , <i>long</i> , etc.).  Para ele, "falso" √© o valor <i>0</i> e "verdadeiro" √© qualquer valor diferente de zero. <br><br>  Como n√£o h√° tipo booleano interno em C, essas constantes s√£o definidas por conveni√™ncia: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FALSE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TRUE 1</span></span></code> </pre> <br>  Agora considere um exemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mbedtls_hardware_poll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* output, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* olen)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lStatus = MBEDTLS_ERR_ENTROPY_SOURCE_FAILED; HCRYPTPROV hProv = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Unferenced parameter. */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)data; <span class="hljs-comment"><span class="hljs-comment">/* * This is port-specific for the Windows simulator, * so just use Crypto API. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptAcquireContextA( &amp;hProv, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == CryptGenRandom(hProv, len, output)) { lStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; *olen = len; } CryptReleaseContext(hProv, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lStatus; }</code> </pre> <br>  <b>Avisos do PVS-Studio:</b> <br><br><ul><li>  V676 [CWE-253] √â incorreto comparar a vari√°vel do tipo BOOL com TRUE.  aws_entropy_hardware_poll.c 48 </li><li>  V676 [CWE-253] √â incorreto comparar a vari√°vel do tipo BOOL com TRUE.  A express√£o correta √©: 'FALSE! = CryptGenRandom (hProv, len, output)'.  aws_entropy_hardware_poll.c 51 </li></ul><br>  Encontrou um erro?  E √© :) Fun√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><i>CryptAcquireContextA</i></a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><i>CryptGenRandom</i></a> s√£o fun√ß√µes padr√£o do cabe√ßalho <i>wincrypt.h</i> .  Se for bem-sucedido, eles retornam um valor diferente de zero.  Eu enfatizo - <i>diferente de zero</i> .  Portanto, teoricamente, esse valor pode ser diferente de zero: <i>1</i> , <i>314</i> , <i>42</i> , <i>420</i> . <br><br>  Aparentemente, o programador que escreveu a fun√ß√£o do exemplo n√£o pensou nisso e, como resultado, os valores obtidos s√£o comparados com a unidade. <br><br>  Com que probabilidade a condi√ß√£o <i>TRUE == CryptGenRandom (....)</i> n√£o √© atendida?  Dif√≠cil dizer.  Talvez <i>CryptGenRandom</i> retorne uma unidade com mais frequ√™ncia do que outros valores, e talvez sempre retorne apenas um.  N√£o podemos ter certeza: a implementa√ß√£o desta fun√ß√£o criptogr√°fica est√° oculta aos olhos dos programadores mortais :) <br><br>  √â importante lembrar que essas compara√ß√µes s√£o potencialmente perigosas.  E em vez de: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TRUE == GetBOOL())</code> </pre> <br>  use uma op√ß√£o mais segura: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FALSE != GetBOOL())</code> </pre> <br><h3>  Problemas de otimiza√ß√£o </h3><br>  V√°rios avisos do analisador foram associados a constru√ß√µes de execu√ß√£o lenta.  Por exemplo: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">"/"</span></span>); .... }</code> </pre> <br>  <b>PVS-Studio Warning:</b> V817 √â mais eficiente procurar o caractere '/' do que uma string.  iot_demo_https_common.c 205 <br><br>  Breve e claramente, n√£o √©?  A fun√ß√£o <i>strstr</i> aqui √© usada para procurar apenas um caractere, que √© passado ao par√¢metro como uma string (entre aspas duplas). <br><br>  Este local pode ser potencialmente otimizado substituindo <i>strstr</i> por <i>strchr</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _IotHttpsDemo_GetS3ObjectFileSize(....) { .... pFileSizeStr = <span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(contentRangeValStr, <span class="hljs-string"><span class="hljs-string">'/'</span></span>); .... }</code> </pre> <br>  Em seguida, a pesquisa funcionar√° um pouco mais r√°pido.  Um pouco, mas legal. <br><br>  Essas otimiza√ß√µes s√£o, obviamente, boas, e o analisador encontrou outro local que pode ser otimizado de maneira muito mais not√°vel: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vRunOTAUpdateDemo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { .... xConnectInfo.cleanSession = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; xConnectInfo.clientIdentifierLength = (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(clientcredentialIOT_THING_NAME); xConnectInfo.pClientIdentifier = clientcredentialIOT_THING_NAME; .... } }</code> </pre> <br>  <b>Aviso PVS-Studio:</b> V814 Desempenho reduzido.  A fun√ß√£o 'strlen' foi chamada v√°rias vezes dentro do corpo de um loop.  aws_iot_ota_update_demo.c 235 <br><br>  Hmmm ... Dentro do loop, a cada itera√ß√£o, <i>strlen</i> √© chamado, que cada vez calcula o comprimento da mesma linha.  N√£o √© a opera√ß√£o mais eficiente :) <br><br>  Vamos dar uma olhada na defini√ß√£o de <i>clientcredentialIOT_THING_NAME</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * @brief Host name. * * @todo Set this to the unique name of your IoT Thing. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> clientcredentialIOT_THING_NAME </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span></span></code> </pre> <br>  O usu√°rio √© solicitado a digitar o nome do seu dispositivo aqui.  Por padr√£o, est√° vazio e, neste caso, est√° tudo bem.  Mas e se o usu√°rio quiser inserir um nome longo e bonito l√°?  Por exemplo, eu adoraria chamar minha ideia de " <i>M√°quina de Caf√© Apaixonada e Sofisticada BarBarista-N061E A Edi√ß√£o Final</i> ".  Voc√™ pode imaginar qual seria minha surpresa se, depois disso, minha linda m√°quina de caf√© come√ßar a funcionar um pouco mais devagar?  Bagun√ßa! <br><br>  Para corrigir o erro, o <i>strlen</i> deve ser retirado do corpo do loop.  Afinal, o nome do dispositivo n√£o muda enquanto o programa est√° sendo executado.  Ehhh, aqui seria <i>constexpr</i> de C ++ ... <br><br>  Ok, ok, eu admito: aqui estava um pouco espessa.  Como observou meu colega Andrei Karpov, os compiladores modernos sabem o que <i>√© strlen</i> e ele observou pessoalmente como eles simplesmente usam uma constante no c√≥digo bin√°rio se entenderem que o comprimento de uma string n√£o pode mudar.  Portanto, existe uma alta probabilidade de que, no modo de compila√ß√£o da vers√£o de lan√ßamento, em vez do c√°lculo real do comprimento da string, um valor calculado anteriormente seja simplesmente usado.  No entanto, isso nem sempre funciona, portanto, escrever esse c√≥digo n√£o √© uma boa pr√°tica. <br><br><h2>  Algumas palavras sobre MISRA </h2><br>  O analisador PVS-Studio possui um grande conjunto de regras que permitem verificar seu c√≥digo quanto √† conformidade com os padr√µes MISRA C e MISRA C ++.  Quais s√£o esses padr√µes? <br><br>  MISRA √© o padr√£o de codifica√ß√£o para sistemas embarcados altamente responsivos.  Ele cont√©m um conjunto de regras e diretrizes estritas para escrever c√≥digo e configurar o processo de desenvolvimento.  Existem algumas dessas regras, e elas visam n√£o apenas eliminar erros graves, mas tamb√©m v√°rios ‚Äúodores de c√≥digo‚Äù, al√©m de escrever o c√≥digo mais compreens√≠vel e leg√≠vel. <br><br>  Assim, seguir o padr√£o MISRA n√£o apenas ajuda a evitar erros e vulnerabilidades, mas tamb√©m significativamente - significativamente!  - reduzir a probabilidade de ocorr√™ncia em um c√≥digo existente. <br><br>  O MISRA √© usado nas ind√∫strias aeroespacial, m√©dica, automotiva e militar - onde as vidas humanas dependem da qualidade do software incorporado. <br><br>  Aparentemente, os desenvolvedores do Amazon FreeRTOS est√£o cientes desse padr√£o e, em grande parte, o seguem.  √â isso mesmo: se voc√™ estiver escrevendo um sistema operacional de base ampla para sistemas embarcados, deve pensar em seguran√ßa. <br><br>  No entanto, eu encontrei algumas viola√ß√µes do padr√£o MISRA.  N√£o darei aqui exemplos de regras como "n√£o use uni√£o" ou "uma fun√ß√£o deve ter apenas um retorno no final do corpo" - infelizmente, elas n√£o s√£o espetaculares, como a maioria das regras MISRA.  √â melhor dar exemplos de viola√ß√µes que podem levar a consequ√™ncias graves. <br><br>  Vamos come√ßar com as macros: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FreeRTOS_ms_to_tick(ms) ( ( ms * configTICK_RATE_HZ + 500 ) / 1000 )</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SOCKETS_htonl( ulIn ) ( ( uint32_t ) \ ( ( ( ulIn &amp; 0xFF ) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; 24 ) | ( ( ulIn &amp; 0xFF00 ) &lt;&lt; 8 ) \ | ( ( ulIn &amp; 0xFF0000 ) &gt;&gt; 8 ) | ( ( ulIn &amp; 0xFF000000 ) &gt;&gt; 24 ) ) )</span></span></span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEFT_ROTATE( x, c ) ( ( x </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt; c ) | ( x &gt;&gt; ( 32 - c ) ) )</span></span></span></span></code> </pre> <br>  <b>Avisos do PVS-Studio:</b> <br><br><ul><li>  V2546 [MISRA C 20.7] A macro e seus par√¢metros devem estar entre par√™nteses.  Considere inspecionar o par√¢metro 'ms' da macro 'FreeRTOS_ms_to_tick'.  FreeRTOS_IP.h 201 </li><li>  V2546 [MISRA C 20.7] A macro e seus par√¢metros devem estar entre par√™nteses.  Considere inspecionar o par√¢metro 'ulIn' da macro 'SOCKETS_htonl'.  iot_secure_sockets.h 512 </li><li>  V2546 [MISRA C 20.7] A macro e seus par√¢metros devem estar entre par√™nteses.  Considere inspecionar os par√¢metros 'x', 'c' da macro 'LEFT_ROTATE'.  iot_device_metrics.c 90 </li></ul><br>  Sim, √© exatamente isso que voc√™ pensou.  Os par√¢metros dessas macros n√£o est√£o entre colchetes.  Se algu√©m acidentalmente escreve algo como <br><br><pre> <code class="cpp hljs">val = LEFT_ROTATE(A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span>, B);</code> </pre> <br>  a macro "chamada" ser√° aberta em: <br><br><pre> <code class="cpp hljs">val = ( ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; B ) | ( A[i] | <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; ( <span class="hljs-number"><span class="hljs-number">32</span></span> - B ) ) );</code> </pre> <br>  Lembra das prioridades das opera√ß√µes?  Primeiro, um deslocamento bit a bit √© realizado e somente depois de um ‚Äúou‚Äù bit a bit.  Portanto, a l√≥gica do programa ser√° violada.  Um exemplo mais simples: o que acontece se a express√£o " <i>x + y</i> " for passada para a macro <i>FreeRTOS_ms_to_tick</i> ?  Um dos principais objetivos do MISRA √© evitar a ocorr√™ncia de tais situa√ß√µes. <br><br>  Algu√©m pode objetar: ‚Äúse voc√™ tem programadores que n√£o sabem disso, nenhum padr√£o o salvar√°!‚Äù E eu n√£o vou concordar com isso.  Os programadores tamb√©m s√£o pessoas e, por mais experiente que seja, ele tamb√©m pode se cansar e cometer um erro no final do dia de trabalho.  Esse √© um dos motivos pelos quais a MISRA recomenda fortemente o uso de ferramentas de an√°lise automatizada para validar um projeto quanto √† conformidade com o padr√£o. <br><br>  Dirijo-me aos desenvolvedores do Amazon FreeRTOS: o PVS-Studio encontrou mais 12 macros inseguras, para que voc√™ tenha mais cuidado com elas :) <br><br>  Outra viola√ß√£o interessante de MISRA: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @brief Callback for an asynchronous request to notify * that the response is complete. * * @param[in] 0pPrivData - User private data configured * with the HTTPS Client library request configuration. * @param[in] respHandle - Identifier for the current response finished. * @param[in] rc - Return code from the HTTPS Client Library * signaling a possible error. * @param[in] status - The HTTP response status. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> _responseCompleteCallback(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* pPrivData, IotHttpsResponseHandle_t respHandle, IotHttpsReturnCode_t rc, <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> status) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>* pUploadSuccess = (<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>*)pPrivData; <span class="hljs-comment"><span class="hljs-comment">/* When the remote server response with 200 OK, the file was successfully uploaded. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status == IOT_HTTPS_STATUS_OK) { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { *pUploadSuccess = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Post to the semaphore that the upload is finished. */</span></span> IotSemaphore_Post(&amp;(_uploadFinishedSem)); }</code> </pre> <br>  Voc√™ pode encontrar o erro voc√™ mesmo? <br><br>  <b>PVS-Studio Warning:</b> V2537 [MISRA C 2.7] As fun√ß√µes n√£o devem ter par√¢metros n√£o utilizados.  Considere inspecionar o par√¢metro: 'rc'.  iot_demo_https_s3_upload_async.c 234 <br><br>  Veja mais de perto: o par√¢metro <i>rc</i> n√£o √© usado em nenhum lugar do corpo da fun√ß√£o.  Al√©m disso, no coment√°rio sobre a fun√ß√£o, est√° explicitamente escrito que este par√¢metro √© um c√≥digo de retorno de outra fun√ß√£o e que pode sinalizar um erro.  Ent√£o, por que esse par√¢metro n√£o √© processado de forma alguma?  H√° claramente algo errado aqui. <br><br>  No entanto, mesmo sem esses coment√°rios, par√¢metros n√£o utilizados geralmente indicam l√≥gica de programa quebrada.  Caso contr√°rio, por que eles s√£o necess√°rios na assinatura da fun√ß√£o? <br><br>  Aqui, dei uma pequena fun√ß√£o que √© adequada para um exemplo no artigo.  Al√©m dela, encontrei mais 10 par√¢metros n√£o utilizados.  Muitos deles s√£o usados ‚Äã‚Äãem fun√ß√µes maiores, e encontr√°-los n√£o √© a coisa mais f√°cil. <br><br>  √â suspeito que eles n√£o foram encontrados antes.  De fato, os compiladores podem detectar facilmente esses casos. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b80/6c7/bb9/b806c7bb94c335ce2712e9b46cffc560.png" alt="Figura 1"></div><br><br><h2>  Conclus√£o </h2><br>  Essas n√£o eram todas as √°reas problem√°ticas encontradas pelo analisador, mas o artigo j√° era bastante amplo.  Espero que, gra√ßas a isso, os desenvolvedores do Amazon FreeRTOS possam corrigir algumas defici√™ncias e talvez at√© desejem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">experimentar o PVS-Studio por</a> conta pr√≥pria.  Dessa forma, ser√° poss√≠vel estudar os avisos mais detalhadamente e, de fato, trabalhar com uma interface conveniente √© muito mais f√°cil do que examinar um relat√≥rio de texto. <br><br>  Obrigado por ler nossos artigos!  Vejo voc√™ na pr√≥xima edi√ß√£o: D <br><br>  PS Aconteceu que este artigo foi publicado em 31 de outubro.  Portanto, desejo a todos um feliz Dia das Bruxas! <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Se voc√™ deseja compartilhar este artigo com um p√∫blico que fala ingl√™s, use o link para a tradu√ß√£o: George Gribkov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A pedido dos desenvolvedores incorporados: detectando erros no Amazon FreeRTOS</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473972/">https://habr.com/ru/post/pt473972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473956/index.html">Informa√ß√µes secretas de uma companhia telef√¥nica de traficantes de drogas</a></li>
<li><a href="../pt473958/index.html">Os japoneses da NICT introduziram um cluster de fibra de trabalho com uma largura de banda de 1 Pbit / s</a></li>
<li><a href="../pt473960/index.html">Estrat√©gias de localiza√ß√£o de conte√∫do</a></li>
<li><a href="../pt473962/index.html">O modo escuro est√° agora em todo lugar. Isso √© t√£o √∫til? (no final da p√≥s-pesquisa)</a></li>
<li><a href="../pt473966/index.html">A pedido dos desenvolvedores incorporados: detectando erros no Amazon FreeRTOS</a></li>
<li><a href="../pt473974/index.html">Intercom'19 - uma confer√™ncia sobre automa√ß√£o de comunica√ß√µes da Voximplant ser√° realizada em 14 de novembro</a></li>
<li><a href="../pt473976/index.html">AWS Elasticsearch: produto fundamentalmente defeituoso</a></li>
<li><a href="../pt473978/index.html">Tanta dor, tanta dor, caixa registradora como 2: 0</a></li>
<li><a href="../pt473980/index.html">Tecnologia e o mundo real: 4 startups que est√£o mudando o futuro do design de interiores</a></li>
<li><a href="../pt473982/index.html">NB-IoT: como funciona? Parte 3: SCEF - uma √∫nica janela de acesso aos servi√ßos do operador</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>