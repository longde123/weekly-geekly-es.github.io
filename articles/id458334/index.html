<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏺 ☝🏼 👨🏽‍🎤 Replikasi berkelanjutan dari PostgreSQL Lama ke Baru dengan Slony 🍒 🔡 💧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Replikasi streaming asli di PostgreSQL hanya berfungsi antara server dengan versi utama yang sama. Kami berbicara tentang replikasi logis di posting s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Replikasi berkelanjutan dari PostgreSQL Lama ke Baru dengan Slony</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/458334/"><p><img src="https://habrastorage.org/webt/c-/eo/j8/c-eoj8fosll1jnolz9jlnmi1wrg.jpeg"></p><br><p>  Replikasi streaming asli di PostgreSQL hanya berfungsi antara server dengan versi utama yang sama.  Kami berbicara tentang replikasi logis di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">posting sebelumnya</a> .  Kami melihat bagaimana replikasi logis membantu memindahkan data dari satu versi PostgreSQL ke versi lain.  Tetapi replikasi logis hanya cocok untuk versi PostgreSQL yang didukung, misalnya, PostgreSQL 9.4 dan PostgreSQL 11. Apa yang harus dilakukan dengan versi sebelum 9.4?  Gunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Slony-I</a> . </p><br><p>  Gunakan replikasi dengan Slony-I untuk mentransfer data dari database lama ke versi terbaru PostgreSQL.  Apa itu Slony dan bagaimana cara kerjanya? </p><a name="habracut"></a><br><p>  Ini adalah pos keempat dalam seri kami. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Peningkatan atau migrasi versi PostgreSQL lama ke yang baru</a> , di mana kami mempelajari berbagai metode untuk memperbarui basis data PostgreSQL. </p><br><h3 id="slony">  Slony </h3><br><p>  Slony adalah implementasi replikasi logis tingkat aplikasi untuk PostgreSQL.  Atau lebih tepatnya, itu adalah alat replikasi pihak ketiga yang membutuhkan instalasi dan konfigurasi terpisah.  Slony sudah ada sejak lama.  Versi terbaru mendukung PostgreSQL dari 8.4 hingga 11. </p><br><p>  Tujuan utama replikasi adalah untuk mentransfer perubahan dari satu server database ke yang lain.  Untuk lebih memahami arsitekturnya, mari kita lihat istilah-istilahnya: Slon, events, dan slonik. </p><br><p>  Ngomong-ngomong, Slony, jika Anda belum bisa menebak, ini adalah "gajah".  Dan mereka benar-benar memiliki ingatan yang hebat.  Bukan kebetulan bahwa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">gajah yang</a> ketat tapi imut memamerkan logo PostgreSQL. </p><br><h3 id="slon">  Slon </h3><br><p>  Slon adalah daemon yang berjalan pada setiap node PostgreSQL di replikasi Slony-I.  Daemon ini digunakan untuk menangani peristiwa konfigurasi dan replikasi untuk setiap server PostgreSQL.  Setiap server PostgreSQL disebut host.  Semua node bersama-sama membentuk cluster Slony. </p><br><p>  Node penerbit adalah sumber perubahan, dan node pelanggan menerima dan menerapkan perubahan dari penerbit. </p><br><p> Untuk mengkonfigurasi replikasi, Anda harus menentukan semua tabel yang direplikasi, atau satu set replikasi.  Berlangganan berfungsi untuk set tertentu.  Perubahan pada tabel yang direplikasi digabungkan menjadi SYNC, sekelompok transaksi yang diterapkan bersama pada pelanggan. </p><br><h3 id="sobytiya">  Acara </h3><br><p>  Perubahan dilaporkan dari penerbit sebagai acara.  Ketika suatu acara diproses oleh Slon daemon pada host jarak jauh, sebuah pemberitahuan dihasilkan.  Dan peristiwa memberi tahu node perubahan konfigurasi, seperti menambah atau menghapus node baru, langganan baru, atau perubahan DDL. </p><br><p>  Setiap peristiwa memiliki pengidentifikasi sumber unik, nomor seri, pengidentifikasi transaksi untuk snapshot pada simpul acara, beberapa argumen dan cap waktu dengan zona waktu. <br>  Pemicu yang ditulis untuk PL / pgSQL mencatat semua perubahan pada tabel yang direplikasi.  Sayangnya, tidak ada cara yang dapat diandalkan untuk menangani perubahan pada blob, DDL, atau perubahan pada pengguna dan peran. </p><br><h3 id="slonik">  slonik </h3><br><p>  Ini adalah utilitas baris perintah dengan penganalisis dan juru bahasa yang menerima skrip slonik - bahasa deklaratif sederhana.  Ini dirancang untuk mengatasi keterbatasan bahasa prosedural.  Dengan bantuan perintah slonik, Anda dapat mengonfigurasi atau memodifikasi replikasi di Slony, dan mereka dapat disematkan dalam skrip shell.  Ia menerima perintah dari input standar atau dari file.  Contoh di bawah ini menunjukkan bagaimana skrip slonik diteruskan ke slonik dan tertanam dalam skrip shell. </p><br><p>  Skrip yang membuat konfigurasi awal untuk skema master-slave sederhana dalam database pgbench kami terlihat seperti ini: </p><br><pre><code class="plaintext hljs">#!/bin/sh slonik &lt;&lt;_EOF_ cluster name = percona_pg; node 1 admin conninfo = 'dbname=pg93 host=pg93_host user=percona_pg93_user'; node 2 admin conninfo = 'dbname=pg11 host=pg11_host user=percona_pg11_user'; #-- # Creates a _$(clustername), this example, _percona_pg schema #-- init cluster ( id=1, comment = 'Legacy PG Node'); #-- # Add a list of tables being replicated to a set. #-- create set (id=1, origin=1, comment='pgbench'); set add table (set id=1, origin=1, id=1, fully qualified name = 'public.pgbench_accounts', comment='accounts'); set add table (set id=1, origin=1, id=2, fully qualified name = 'public.pgbench_branches', comment='branches'); set add table (set id=1, origin=1, id=3, fully qualified name = 'public.pgbench_tellers', comment='tellers'); set add table (set id=1, origin=1, id=4, fully qualified name = 'public.pgbench_history', comment='history'); #-- # Create the second node (the slave) tell the 2 nodes how to connect to # each other and how they should listen for events. #-- store node (id=2, comment = 'Target node', event node=1); store path (server = 1, client = 2, conninfo='dbname=pg93 host=pg93_host user=percona_pg93_user'); store path (server = 2, client = 1, conninfo='dbname=pg11 host=pg11_host user=percona_pg11_user'); _EOF_</code> </pre> <br><h3 id="pochemu-slony-udobno-ispolzovat-dlya-migraciy">  Mengapa Slony nyaman untuk migrasi? </h3><br><p>  Terlepas dari keuntungan dari replikasi logis internal, untuk versi sebelum PostgreSQL 9.4, Anda harus menggunakan solusi pihak ketiga ini.  Pendekatan berbasis pemicu tergantung pada API basis data - kedua versi harus kompatibel untuk menggunakan sintaks PL / pgSQL dan SQL. </p><br><h3 id="kak-adaptirovat-bazu-dannyh-dlya-ispolzovaniya-so-slony">  Bagaimana cara mengadaptasi basis data untuk digunakan dengan Slony? </h3><br><ul><li>  Tabel harus memiliki kunci utama.  Tambahkan bidang serial ke semua tabel tanpa kunci utama. </li><li>  Perubahan pada gumpalan OID tidak direplikasi.  Jika Anda memiliki kolom dengan nilai pendek, konversikan ke BYTEA.  Jika objek sangat besar - misalnya, gambar - lebih baik menyimpan data dalam penyimpanan eksternal (katakanlah, S3 di cloud Amazon).  Jika mengubah aplikasi terlalu rumit, terapkan perubahan gumpalan di langkah terakhir migrasi. </li><li>  ALTER TABLE dan operasi DDL lainnya.  Slony tidak mendeteksi perubahan struktur tabel.  Gunakan perintah slonik EXECUTE SCRIPT untuk menerapkan file SQL dengan string SQL atau DDL ke seluruh cluster replikasi. </li></ul><br><h3 id="onlayn-migraciya-iz-predyduschih-versiy-postgresql">  Migrasi online dari versi PostgreSQL sebelumnya </h3><br><ol><li>  Buat pengguna replikasi dengan hak superuser.  Anda dapat mengkonfigurasi hak secara detail, tetapi jauh lebih rumit. </li><li>  Buat database di tujuan dengan akses TCP / IP. </li><li>  Salin definisi tabel dari master ke slave. </li><li>  Instal Slony-I.  Pada server dengan versi OS yang lama, akan lebih mudah untuk menginstal Slony-I dari kode sumber. </li><li>  Tentukan cluster, set tabel, dan informasi koneksi node sebagai daftar perintah slonik. </li><li>  Jalankan daemon slon pada setiap server PostgreSQL.  Periksa output standar atau file log untuk kesalahan koneksi. </li><li>  Jalankan perintah berlangganan slonik untuk memulai sinkronisasi. </li><li>  Uji permintaan hanya baca di Postgres versi baru. </li><li>  Ketika semua data direplikasi dan disinkronkan, hentikan aplikasi dan arahkan ke server Postgres baru. </li><li>  Gunakan node uninstall di versi baru PostgreSQL untuk menghapus semua jejak replikasi Slony. </li></ol><br><h3 id="perehod-na-predyduschie-versii">  Transisi ke versi sebelumnya </h3><br><p>  Gunakan prosedur yang sama untuk meningkatkan ke versi sebelumnya.  Dengan Slony, Anda dapat mereplikasi dari versi apa pun dan ke versi PosgreSQL apa pun yang didukung oleh versi Slony.  Versi minimum yang didukung adalah 8.4. </p><br><h3 id="itogi">  Ringkasan </h3><br><p>  Kami melihat secara umum bagaimana Anda dapat meningkatkan ke versi baru dengan downtime minimal menggunakan Slony.  Cari tahu lebih lanjut di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">webinar</a> kami. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id458334/">https://habr.com/ru/post/id458334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id458316/index.html">Yandex Retro Games Battle 2019 - mengembangkan game untuk ZX Spectrum</a></li>
<li><a href="../id458324/index.html">Semua yang Anda butuhkan untuk memulai dengan Vue.js</a></li>
<li><a href="../id458328/index.html">Cara menduplikasi tujuan dari Yandex.Metrica di Google Analytics</a></li>
<li><a href="../id458330/index.html">Tidak ada batasan untuk kesempurnaan: bagaimana antarmuka saraf membantu manusia</a></li>
<li><a href="../id458332/index.html">Pemrograman asinkron - kinerja async: pahami biaya async dan tunggu</a></li>
<li><a href="../id458336/index.html">Siklus penuh pengembangan produk TI menggunakan contoh proyek: peran tim, tugas pelanggan, tahapan</a></li>
<li><a href="../id458338/index.html">Manajer Keamanan Aplikasi. Pengembang atau keamanan?</a></li>
<li><a href="../id458342/index.html">Tekstur, atau apa yang perlu Anda ketahui untuk menjadi Artis Permukaan. Bagian 1. Pixel</a></li>
<li><a href="../id458344/index.html">Menggunakan Pesan Asinkron untuk Meningkatkan Ketersediaan</a></li>
<li><a href="../id458346/index.html">Pemecahan masalah dengan pwnable.kr 01 - fd. File deskriptor dan proses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>