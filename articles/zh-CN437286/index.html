<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’º â¬†ï¸ ğŸ™ŒğŸ» æˆ‘å°è¯•.NET Core + Kubernetes + Appmetrics + Prometheus + grafana +å·¥ä½œ+å¥åº·æ£€æŸ¥ ğŸ‚ ğŸ‘©ğŸ¾â€ğŸ”§ ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="é€šè¿‡éƒ¨ç½²ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ç«™ç‚¹ï¼Œå¯¹å…¶è¿›è¡Œç›‘æ§ï¼Œæ‰§è¡Œè®¡åˆ’çš„ä½œä¸šå’Œè¿è¡ŒçŠ¶å†µæ£€æŸ¥çš„ç¤ºä¾‹ï¼Œä¸ºå¼€å‘äººå‘˜ç®€è¦åœ°äº†è§£äº†kubernetesï¼ˆéšé™„æ‰€æœ‰æºä»£ç ï¼‰ 

 - å®‰è£…Kubernetes 
 - å®‰è£…ç”¨æˆ·ç•Œé¢ 
 - åœ¨é›†ç¾¤ä¸­å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åº 
 - å‘åº”ç”¨ç¨‹åºæ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡ 
 - é€šè¿‡Prometheusæ”¶...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘å°è¯•.NET Core + Kubernetes + Appmetrics + Prometheus + grafana +å·¥ä½œ+å¥åº·æ£€æŸ¥</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437286/"> é€šè¿‡éƒ¨ç½²ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ç«™ç‚¹ï¼Œå¯¹å…¶è¿›è¡Œç›‘æ§ï¼Œæ‰§è¡Œè®¡åˆ’çš„ä½œä¸šå’Œè¿è¡ŒçŠ¶å†µæ£€æŸ¥çš„ç¤ºä¾‹ï¼Œä¸ºå¼€å‘äººå‘˜ç®€è¦åœ°äº†è§£äº†kubernetesï¼ˆéšé™„æ‰€æœ‰æºä»£ç ï¼‰ <br><br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®‰è£…Kubernetes</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®‰è£…ç”¨æˆ·ç•Œé¢</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨é›†ç¾¤ä¸­å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åº</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‘åº”ç”¨ç¨‹åºæ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é€šè¿‡Prometheusæ”¶é›†æŒ‡æ ‡</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨Grafanaä¸­æ˜¾ç¤ºæŒ‡æ ‡</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é¢„å®šä»»åŠ¡</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®¹é”™</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»“è®º</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¬”è®°</a> <br>  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‚è€ƒ</a> <br><a name="habracut"></a><br><a name="1"></a><h2> å®‰è£…Kubernetes </h2><br>  <i>ä¸é€‚åˆLinuxç”¨æˆ·ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">minikube</a></i> <br><ol><li> ä½ æœ‰ç å¤´å·¥äººæ¡Œé¢å— </li><li> åœ¨å…¶ä¸­æ‚¨éœ€è¦æ‰¾åˆ°å¹¶å¯ç”¨Kuberneteså•èŠ‚ç‚¹é›†ç¾¤ <br><img src="https://habrastorage.org/webt/zc/ij/zs/zcijzspy007dfz7ilba9xhv3mg0.png"></li><li> ç°åœ¨æ‚¨æœ‰äº†api <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">httpï¼š//æœ¬åœ°ä¸»æœºï¼š8001 /</a>ç”¨äºkubernetis </li><li>é€šè¿‡ä¾¿æ·çš„å®ç”¨å·¥å…·kubectlä¸ä»–è¿›è¡Œäº¤æµ <br> ä½¿ç”¨å‘½ä»¤&gt; <code>kubectl version</code>æ£€æŸ¥å…¶<code>kubectl version</code> <br> æœ€æ–°çš„ç›¸å…³å†…å®¹å†™åœ¨è¿™é‡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://storage.googleapis.com/kubernetes-release/release/stable.txt</a> <br> æ‚¨å¯ä»¥é€šè¿‡ç›¸åº”çš„é“¾æ¥<a href="">https://storage.googleapis.com/kubernetes-release/release/v1.13.2/bin/windows/amd64/kubectl.exe</a>ä¸‹è½½å®ƒ </li><li>  <code>kubectl cluster-info</code>é›†ç¾¤æ˜¯å¦æ­£å¸¸è¿è¡Œ&gt; <code>kubectl cluster-info</code> </li></ol><br><a name="2"></a><h2>  UIå®‰è£… </h2><br><ol><li> è¯¥æ¥å£éƒ¨ç½²åœ¨åŒä¸€é›†ç¾¤ä¸­ <br><pre> <code class="bash hljs">kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml</code> </pre> </li><li> è·å–ä»¤ç‰Œä»¥è®¿é—®ç•Œé¢ <pre> <code class="bash hljs">kubectl describe secret</code> </pre> <br> å¹¶å¤åˆ¶ <br><img src="https://habrastorage.org/webt/9q/kl/fa/9qklfaacfs9863l1s5cy7nnz1-k.png"></li><li> ç°åœ¨å¯åŠ¨ä»£ç† <pre> <code class="bash hljs">kubectl proxy</code> </pre> </li><li> æ‚¨å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=http://localhost:8001/api/v1/namespaces/kube-system/services/">httpï¼š//æœ¬åœ°ä¸»æœºï¼š8001 / api / v1 /åç§°ç©ºé—´/ kube-system /æœåŠ¡/ httpsï¼škubernetes-dashboardï¼š/ proxy /</a> <img src="https://habrastorage.org/webt/-w/si/i1/-wsii1ckz09obhzqxwsf25yauvm.png"></li></ol><br><br><a name="3"></a><h2> åœ¨é›†ç¾¤ä¸­è¿è¡Œæ‚¨çš„åº”ç”¨ç¨‹åº </h2><br><ol><li> æˆ‘é€šè¿‡å·¥ä½œå®¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/SanSYS/kuberfirst</a>åˆ¶ä½œäº†ä¸€ä¸ªæ ‡å‡†çš„mvc netcoreapp2.1åº”ç”¨ç¨‹åº </li><li>  Dockerfileï¼š <pre> <code class="actionscript hljs">FROM microsoft/dotnet:<span class="hljs-number"><span class="hljs-number">2.1</span></span>-aspnetcore-runtime AS base WORKDIR /app EXPOSE <span class="hljs-number"><span class="hljs-number">80</span></span> FROM microsoft/dotnet:<span class="hljs-number"><span class="hljs-number">2.1</span></span>-sdk AS build WORKDIR /src COPY ./MetricsDemo.csproj . RUN ls RUN dotnet restore <span class="hljs-string"><span class="hljs-string">"MetricsDemo.csproj"</span></span> COPY . . RUN dotnet build <span class="hljs-string"><span class="hljs-string">"MetricsDemo.csproj"</span></span> -c Release -o /app FROM build AS publish RUN dotnet publish <span class="hljs-string"><span class="hljs-string">"MetricsDemo.csproj"</span></span> -c Release -o /app FROM base AS <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> WORKDIR /app COPY --from=publish /app . ENTRYPOINT [<span class="hljs-string"><span class="hljs-string">"dotnet"</span></span>, <span class="hljs-string"><span class="hljs-string">"MetricsDemo.dll"</span></span>]</code> </pre> </li><li> ç”¨metricsdemo3æ ‡ç­¾æ”¶é›†äº†è¿™ä¸ªä¸œè¥¿ <pre> <code class="bash hljs">docker build -t metricsdemo3 .</code> </pre> </li><li> ä½†æ˜¯ï¼ é»˜è®¤æƒ…å†µä¸‹ï¼ŒCooberä»é›†çº¿å™¨æå–å›¾åƒï¼Œæ‰€ä»¥æˆ‘æé«˜äº†æœ¬åœ°å¯„å­˜å™¨ </li><li> æ³¨æ„-æ²¡æœ‰å°è¯•åœ¨kubernetisä¸­è¿è¡Œ <pre> <code class="bash hljs">docker create -p 5000:5000 --restart always --name registry registry:2</code> </pre></li><li> è€Œä¸”æˆ‘å°†å…¶è§„å®šä¸ºä¸å®‰å…¨çš„æˆæƒï¼š <br><img src="https://habrastorage.org/webt/0e/h3/5e/0eh35ewv6frgqwrwaqddcriqhpu.png"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"registry-mirrors"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"insecure-registries"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"localhost:5000"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"debug"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"experimental"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> </li><li> åœ¨æ¨å…¥æ”¶é“¶æœºä¹‹å‰ï¼Œè¿˜æœ‰ä¸€äº›æ‰‹åŠ¿ <pre> <code class="bash hljs">docker start registry docker tag metricsdemo3 localhost:5000/sansys/metricsdemo3 docker push localhost:5000/sansys/metricsdemo3</code> </pre> </li><li> å®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><img src="https://habrastorage.org/webt/ep/6i/5o/ep6i5ofhvqdr8cokxqbidrqisvk.png"></li><li><div class="spoiler">  <b class="spoiler_title">é€šè¿‡UIå¯åŠ¨</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tv/oa/ed/tvoaedah5gqbrqftpcxjdlwrkpi.png"><br></div></div></li></ol><br><br><h4> å¦‚æœå¯åŠ¨ï¼Œåˆ™ä¸€åˆ‡æ­£å¸¸ï¼Œæ‚¨å¯ä»¥å¼€å§‹æ“ä½œ </h4><br> åˆ›å»ºä¸€ä¸ªéƒ¨ç½²æ–‡ä»¶ <br><div class="spoiler">  <b class="spoiler_title">1-deployment-app.yaml</b> <div class="spoiler_text"><pre> <code class="bash hljs">kind: Deployment apiVersion: apps/v1 metadata: name: metricsdemo labels: app: web spec: replicas: 2 <span class="hljs-comment"><span class="hljs-comment">#    (  ) #  ,      selector: matchLabels: app: metricsdemo template: metadata: labels: app: metricsdemo #     selector  kind: Service spec: containers: - name: metricsdemo #   image: localhost:5000/sansys/metricsdemo3 #    ports: - containerPort: 80 #       # :    ,       --- kind: Service apiVersion: v1 metadata: name: metricsdemo #    __meta_kubernetes_service_name="metricsdemo",  https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config labels: apptype: business #    __meta_kubernetes_service_label_apptype="business" -  instancetype: web #    __meta_kubernetes_service_label_instancetype="web" spec: selector: app: metricsdemo #    labels:app type: LoadBalancer #      ports: - protocol: TCP #    _meta_kubernetes_service_port_protocol="TCP" port: 9376 targetPort: 80 name: portapi #    __meta_kubernetes_service_port_name="portapi"</span></span></code> </pre> </div></div><br> å°è¯´æ˜ <ul><li> ç§ç±»-æŒ‡ç¤ºé€šè¿‡yamlæ–‡ä»¶æè¿°å“ªç§ç±»å‹çš„å®ä½“ </li><li>  apiVersion-å¯¹è±¡ä¼ è¾“åˆ°çš„api </li><li> æ ‡ç­¾-æœ¬è´¨ä¸Šåªæ˜¯æ ‡ç­¾ï¼ˆå·¦ä¾§çš„é”®å’Œå€¼å¯ä»¥è‡ªå·±è€ƒè™‘ï¼‰ </li><li> é€‰æ‹©å™¨-å…è®¸æ‚¨å°†æœåŠ¡ä¸éƒ¨ç½²å…³è”ï¼Œä¾‹å¦‚é€šè¿‡æ ‡ç­¾ </li></ul><br> ä¸‹ä¸€ä¸ªï¼š <pre> <code class="bash hljs">kubectl create -f .\1-deployment-app.yaml</code> </pre><br> å¹¶ä¸”æ‚¨åº”è¯¥åœ¨æ¥å£<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=http://localhost:8001/api/v1/namespaces/kube-system/services/">httpï¼š// localhostï¼š8001 / api / v1 / namespaces / kube-system / services / httpsï¼škubernetes-dashboardï¼š/ proxy /ï¼ƒï¼/ Deploymentï¼Ÿå‘½åç©ºé—´=é»˜è®¤å€¼ä¸‹çœ‹åˆ°éƒ¨ç½²</a> <br><div class="spoiler">  <b class="spoiler_title">è¤å¹•</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/8c/sp/gj/8cspgj27ws9tcjd-6euq5s3djig.png"></div></div><br> é‡Œé¢æœ‰ä¸€ä¸ªå‰¯æœ¬é›†ï¼Œè¡¨æ˜è¯¥åº”ç”¨ç¨‹åºåœ¨ä¸¤ä¸ªå®ä¾‹ï¼ˆPodsï¼‰ä¸­è¿è¡Œï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªç›¸å…³æœåŠ¡ï¼Œå…¶åœ°å€æ¥è‡ªå¤–éƒ¨ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€é…éŸ³çš„åº”ç”¨ç¨‹åº <br><div class="spoiler">  <b class="spoiler_title">å±å¹•æˆªå›¾</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/zl/ix/tl/zlixtl8tehddvrk36ykdfx6hd48.png"><br><img src="https://habrastorage.org/webt/5u/kq/cx/5ukqcxek-nslcezxse0dqot_cym.png"><br></div></div><br><a name="4"></a><h2> å‘åº”ç”¨ç¨‹åºæ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡ </h2><br> å·²å°†åŒ…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.app-metrics.io/</a>æ·»åŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆ°</a>åº”ç”¨ç¨‹åº <br> æˆ‘æš‚æ—¶ä¸ä¼šè¯¦ç»†æè¿°å¦‚ä½•æ·»åŠ å®ƒä»¬-æˆ‘æ³¨å†Œäº†ç”¨äºå¢åŠ å¯¹apiæ–¹æ³•çš„è°ƒç”¨è®¡æ•°å™¨çš„ä¸­é—´ä»¶ <div class="spoiler">  <b class="spoiler_title">è¿™æ˜¯ä¸­é—´ä»¶</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AutoDiscoverRoutes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Request.Path.Value == <span class="hljs-string"><span class="hljs-string">"/favicon.ico"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; keys = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; vals = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> routeData = context.GetRouteData(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (routeData != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { keys.AddRange(routeData.Values.Keys); vals.AddRange(routeData.Values.Values.Select(p =&gt; p.ToString())); } keys.Add(<span class="hljs-string"><span class="hljs-string">"method"</span></span>); vals.Add(context.Request.Method); keys.Add(<span class="hljs-string"><span class="hljs-string">"response"</span></span>); vals.Add(context.Response.StatusCode.ToString()); keys.Add(<span class="hljs-string"><span class="hljs-string">"url"</span></span>); vals.Add(context.Request.Path.Value); Program.Metrics.Measure.Counter.Increment(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CounterOptions { Name = <span class="hljs-string"><span class="hljs-string">"api"</span></span>, <span class="hljs-comment"><span class="hljs-comment">//ResetOnReporting = true, // ,     MeasurementUnit = Unit.Calls, Tags = new MetricTags(keys.ToArray(), vals.ToArray()) }); }</span></span></code> </pre></div></div><br> æ‰€æ”¶é›†çš„æŒ‡æ ‡å¯ä»ä»¥ä¸‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç½‘å€</a>è·å¾—ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">httpï¼š//æœ¬åœ°ä¸»æœºï¼š9376</a> <br><br><img src="https://habrastorage.org/webt/yc/-h/9n/yc-h9ndhal2nj4kgeablgor4oba.png"><br><br>  * IMetricRootæˆ–å…¶æŠ½è±¡å¯ä»¥è½»æ¾åœ°åœ¨æœåŠ¡ä¸­æ³¨å†Œå¹¶åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ï¼ˆ <i>services.AddMetricsï¼ˆProgram.Metricsï¼‰;</i> ï¼‰ <br><br><a name="5"></a><h2> é€šè¿‡Prometheusæ”¶é›†æŒ‡æ ‡ </h2><br> æœ€åŸºæœ¬çš„prometheusè®¾ç½®ï¼šå°†æ–°ä½œä¸šæ·»åŠ åˆ°å…¶é…ç½®ï¼ˆprometheus.ymlï¼‰ä¸­ï¼Œå¹¶å°†å…¶æä¾›ç»™æ–°ç›®æ ‡ï¼š <br><pre> <code class="bash hljs">global: scrape_interval: 15s evaluation_interval: 15s rule_files: <span class="hljs-comment"><span class="hljs-comment"># - "first.rules" # - "second.rules" scrape_configs: - job_name: prometheus static_configs: - targets: ['localhost:9090', '__:']</span></span></code> </pre> <br> ä½†æ˜¯Prometheuså…·æœ‰ä»kubernetisæ”¶é›†æŒ‡æ ‡çš„æœ¬æœºæ”¯æŒ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config</a> <br> æˆ‘æƒ³ç›‘è§†æŒ‰æœåŠ¡ç±»å‹åˆ†åˆ«è¿‡æ»¤çš„æ¯ä¸ªæœåŠ¡ï¼šä¸šåŠ¡æ ‡ç­¾ <br> ç†Ÿæ‚‰ç å¤´ä¹‹åï¼Œå·¥ä½œå¦‚ä¸‹ï¼š <br><pre> <code class="bash hljs">- job_name: business-metrics <span class="hljs-comment"><span class="hljs-comment">#     metrics_path: /metrics kubernetes_sd_configs: - role: endpoints #   .   service,pod,ingress static_configs: - targets: - localhost:9090 relabel_configs: #       default   c  apptype = business - action: keep regex: default;business source_labels: - __meta_kubernetes_namespace - __meta_kubernetes_service_label_apptype</span></span></code> </pre> <br> åœ¨kubernetisä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ä½ç½®ç”¨äºå­˜å‚¨é…ç½®æ–‡ä»¶-ConfigMap <br> æˆ‘åœ¨è¿™é‡Œä¿å­˜æ­¤é…ç½®ï¼š <br><div class="spoiler">  <b class="spoiler_title">2-prometheus-configmap.yaml</b> <div class="spoiler_text"><pre> <code class="bash hljs">apiVersion: v1 kind: ConfigMap <span class="hljs-comment"><span class="hljs-comment">#  ,   metadata: name: prometheus-config #  - namespace: default labels: kubernetes.io/cluster-service: "true" addonmanager.kubernetes.io/mode: EnsureExists data: #     prometheus.yml: | global: scrape_interval: 5s # Default is every 1 minute. evaluation_interval: 5s # The default is every 1 minute. scrape_configs: - job_name: prometheus static_configs: - targets: - localhost:9090 - job_name: business-metrics #     metrics_path: /metrics kubernetes_sd_configs: - role: endpoints #   .   service,pod,ingress static_configs: - targets: - localhost:9090 relabel_configs: #       default   c  apptype = business - action: keep regex: default;business source_labels: - __meta_kubernetes_namespace - __meta_kubernetes_service_label_apptype</span></span></code> </pre></div></div><br> å‡ºå‘å‰å¾€kubernetis <br><pre> <code class="bash hljs">kubectl create -f .\2-prometheus-configmap.yaml</code> </pre> <br> ç°åœ¨ï¼Œæ‚¨éœ€è¦ä½¿ç”¨æ­¤é…ç½®æ–‡ä»¶éƒ¨ç½²prometheus <br><div class="spoiler">  <b class="spoiler_title">kubectlåˆ›å»º-fã€‚\ 3-deployment-prometheus.yaml</b> <div class="spoiler_text"><pre> <code class="bash hljs">apiVersion: extensions/v1beta1 kind: Deployment metadata: name: prometheus namespace: default spec: replicas: 1 template: metadata: labels: app: prometheus-server spec: containers: - name: prometheus image: prom/prometheus args: - <span class="hljs-string"><span class="hljs-string">"--config.file=/etc/config/prometheus.yml"</span></span> - <span class="hljs-string"><span class="hljs-string">"--web.enable-lifecycle"</span></span> ports: - containerPort: 9090 volumeMounts: - name: prometheus-config-volume <span class="hljs-comment"><span class="hljs-comment">#    mountPath: /etc/config/ #     volumes: - name: prometheus-config-volume #     configMap: defaultMode: 420 name: prometheus-config #  - --- kind: Service apiVersion: v1 metadata: name: prometheus spec: selector: app: prometheus-server #    labels:app type: LoadBalancer #      ports: - protocol: TCP port: 9090 targetPort: 9090</span></span></code> </pre></div></div><br> æ³¨æ„-prometheus.ymlæ–‡ä»¶æœªåœ¨ä»»ä½•åœ°æ–¹æŒ‡å®š <br> åœ¨config-mapä¸­æŒ‡å®šçš„æ‰€æœ‰æ–‡ä»¶å°†æˆä¸ºprometheus-config-volumeéƒ¨åˆ†ä¸­çš„æ–‡ä»¶ï¼Œè¯¥éƒ¨åˆ†å®‰è£…åœ¨/ etc / config /ç›®å½•ä¸­ <br> æ­¤å¤–ï¼Œå®¹å™¨å…·æœ‰å¯åŠ¨å‚æ•°ä»¥åŠé…ç½®è·¯å¾„ <br>  --web.enable-lifecycle-è¡¨ç¤ºæ‚¨å¯ä»¥æ‹‰POST /-/é‡æ–°åŠ è½½ï¼Œè¿™å°†åº”ç”¨æ–°çš„é…ç½®ï¼ˆå¦‚æœé…ç½®â€œå®æ—¶â€æ›´æ”¹å¹¶ä¸”æ‚¨ä¸æƒ³é‡æ–°å¯åŠ¨å®¹å™¨ï¼Œåˆ™å¾ˆæœ‰ç”¨ï¼‰ <br><br> å®é™…éƒ¨ç½² <br><pre> <code class="bash hljs">kubectl create -f .\3-deployment-prometheus.yaml</code> </pre> <br> æŒ‰ç…§å°æ­¥éª¤ï¼Œç„¶åè½¬åˆ°åœ°å€<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">httpï¼š//æœ¬åœ°ä¸»æœºï¼š9090 / target</a> ï¼Œæ‚¨åº”è¯¥åœ¨é‚£é‡Œçœ‹åˆ°æœåŠ¡çš„ç«¯ç‚¹ <br><br><img src="https://habrastorage.org/webt/sz/vw/vg/szvwvg5evcq_gfbusz56mx1k-se.png"><br><br> åœ¨ä¸»é¡µä¸Šï¼Œæ‚¨å¯ä»¥å‘Prometheuså‘é€è¯·æ±‚ <br><pre> <code class="bash hljs">sum by (response, action, url, app) (delta(application_api[15s]))</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">å‡è®¾æœ‰äººæ­£åœ¨è®¿é—®è¯¥ç«™ç‚¹ï¼Œç»“æœå°†æ˜¯è¿™æ ·</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/pq/gl/ss/pqglssktt2mud6b2i1nltnqptou.png"><br></div></div><br> æŸ¥è¯¢è¯­è¨€<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-https://prometheus.io/docs/prometheus/latest/querying/basics/</a> <br><br><a name="6"></a><h2> åœ¨Grafanaä¸­æ˜¾ç¤ºæŒ‡æ ‡ </h2><br> æˆ‘ä»¬å¾ˆå¹¸è¿-ç›´åˆ°ç¬¬5ç‰ˆï¼Œä»ªè¡¨æ¿é…ç½®åªèƒ½é€šè¿‡HTTP APIæ»‘åŠ¨ï¼Œä½†æ˜¯ç°åœ¨æ‚¨å¯ä»¥æ‰§è¡Œä¸Prometeusç›¸åŒçš„æŠ€å·§ <br> é»˜è®¤æƒ…å†µä¸‹ï¼ŒGrafanaåœ¨å¯åŠ¨æ—¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¯ä»¥æ‹‰å‡º</a>æ•°æ®æº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é…ç½®</a>å’Œä»ªè¡¨æ¿ <br><ol><li>  <code>/etc/grafana/provisioning/datasources/</code> -æºé…ç½®ï¼ˆç”¨äºè®¿é—®prometeusï¼Œpostgresï¼Œzabbiksï¼Œelasticç­‰çš„è®¾ç½®ï¼‰ </li><li>  <code>/etc/grafana/provisioning/dashboards/</code> - <code>/etc/grafana/provisioning/dashboards/</code>è®¿é—®è®¾ç½® </li><li>  <code>/var/lib/grafana/dashboards/</code> -åœ¨è¿™é‡Œæˆ‘å°†ä»¥jsonæ–‡ä»¶çš„å½¢å¼å­˜å‚¨ä»ªè¡¨æ¿æœ¬èº« </li></ol><br><div class="spoiler">  <b class="spoiler_title">åŸæ¥æ˜¯è¿™æ ·çš„</b> <div class="spoiler_text"><pre> <code class="bash hljs">apiVersion: v1 kind: ConfigMap metadata: creationTimestamp: null name: grafana-provisioning-datasources namespace: default data: all.yml: | datasources: - name: <span class="hljs-string"><span class="hljs-string">'Prometheus'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: <span class="hljs-string"><span class="hljs-string">'prometheus'</span></span> access: <span class="hljs-string"><span class="hljs-string">'proxy'</span></span> org_id: 1 url: <span class="hljs-string"><span class="hljs-string">'http://prometheus:9090'</span></span> is_default: <span class="hljs-literal"><span class="hljs-literal">true</span></span> version: 1 editable: <span class="hljs-literal"><span class="hljs-literal">true</span></span> --- apiVersion: v1 kind: ConfigMap metadata: creationTimestamp: null name: grafana-provisioning-dashboards namespace: default data: all.yml: | apiVersion: 1 providers: - name: <span class="hljs-string"><span class="hljs-string">'default'</span></span> orgId: 1 folder: <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: file disableDeletion: <span class="hljs-literal"><span class="hljs-literal">false</span></span> updateIntervalSeconds: 10 <span class="hljs-comment"><span class="hljs-comment">#how often Grafana will scan for changed dashboards options: path: /var/lib/grafana/dashboards --- apiVersion: v1 kind: ConfigMap metadata: creationTimestamp: null name: grafana-dashboards namespace: default data: service-http-requests.json: | { "annotations": { "list": [ { "builtIn": 1, "datasource": "-- Grafana --", "enable": true, "hide": true, "iconColor": "rgba(0, 211, 255, 1)", "name": "Annotations &amp; Alerts", "type": "dashboard" } ] }, "editable": true, "gnetId": null, "graphTooltip": 0, "links": [], "panels": [ { "aliasColors": {}, "bars": false, "dashLength": 10, "dashes": false, "fill": 1, "gridPos": { "h": 9, "w": 12, "x": 0, "y": 0 }, "id": 2, "legend": { "alignAsTable": false, "avg": false, "current": false, "max": false, "min": false, "rightSide": true, "show": true, "total": false, "values": false }, "lines": true, "linewidth": 1, "links": [], "nullPointMode": "null", "percentage": false, "pointradius": 5, "points": false, "renderer": "flot", "seriesOverrides": [], "spaceLength": 10, "stack": false, "steppedLine": false, "targets": [ { "expr": "sum by (response, action, url, app) (delta(application_api[15s]))", "format": "time_series", "interval": "15s", "intervalFactor": 1, "legendFormat": "{{app}} {{response}} - {{url}}", "refId": "A" } ], "thresholds": [], "timeFrom": null, "timeRegions": [], "timeShift": null, "title": "Http requests", "tooltip": { "shared": true, "sort": 0, "value_type": "individual" }, "type": "graph", "xaxis": { "buckets": null, "mode": "time", "name": null, "show": true, "values": [] }, "yaxes": [ { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true }, { "format": "short", "label": null, "logBase": 1, "max": null, "min": null, "show": true } ], "yaxis": { "align": false, "alignLevel": null } } ], "refresh": "5s", "schemaVersion": 16, "style": "dark", "tags": [], "templating": { "list": [] }, "time": { "from": "now-30m", "to": "now" }, "timepicker": { "refresh_intervals": [ "5s", "10s", "30s", "1m", "5m", "15m", "30m", "1h", "2h", "1d" ], "time_options": [ "5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d", "30d" ] }, "timezone": "", "title": "Business metrics", "uid": "Dm0tD0Qik", "version": 1 }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">éƒ¨ç½²æœ¬èº«ï¼Œæ²¡æœ‰æ–°å†…å®¹</b> <div class="spoiler_text"><pre> <code class="bash hljs">apiVersion: extensions/v1beta1 kind: Deployment metadata: name: grafana namespace: default labels: app: grafana component: core spec: replicas: 1 template: metadata: labels: app: grafana component: core spec: containers: - image: grafana/grafana name: grafana imagePullPolicy: IfNotPresent resources: limits: cpu: 100m memory: 100Mi requests: cpu: 100m memory: 100Mi env: - name: GF_AUTH_BASIC_ENABLED value: <span class="hljs-string"><span class="hljs-string">"true"</span></span> - name: GF_AUTH_ANONYMOUS_ENABLED value: <span class="hljs-string"><span class="hljs-string">"true"</span></span> - name: GF_AUTH_ANONYMOUS_ORG_ROLE value: Admin readinessProbe: httpGet: path: /login port: 3000 <span class="hljs-comment"><span class="hljs-comment"># initialDelaySeconds: 30 # timeoutSeconds: 1 volumeMounts: - name: grafana-provisioning-datasources mountPath: /etc/grafana/provisioning/datasources/ - name: grafana-provisioning-dashboards mountPath: /etc/grafana/provisioning/dashboards/ - name: grafana-dashboards mountPath: /var/lib/grafana/dashboards/ volumes: - name: grafana-provisioning-datasources configMap: defaultMode: 420 name: grafana-provisioning-datasources - name: grafana-provisioning-dashboards configMap: defaultMode: 420 name: grafana-provisioning-dashboards - name: grafana-dashboards configMap: defaultMode: 420 name: grafana-dashboards nodeSelector: beta.kubernetes.io/os: linux --- apiVersion: v1 kind: Service metadata: name: grafana namespace: default labels: app: grafana component: core spec: type: LoadBalancer ports: - protocol: TCP port: 3000 targetPort: 3000 selector: app: grafana component: core</span></span></code> </pre> </div></div><br> å±•å¼€ <br><pre> <code class="bash hljs">kubectl create -f .\4-grafana-configmap.yaml kubectl create -f .\5-deployment-grafana.yaml</code> </pre> <br> è¯·è®°ä½ï¼ŒçŸ³å¢¨çƒ¯ä¸ä¼šç«‹å³å‡é«˜ï¼Œä½†ä¼šå› sqliteè¿ç§»è€Œæœ‰æ‰€å‡å¼±ï¼Œæ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=http://localhost:8001/api/v1/namespaces/kube-system/services/">åœ¨æ—¥å¿—ä¸­çœ‹åˆ°</a> <br> ç°åœ¨è½¬åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">httpï¼š//æœ¬åœ°ä¸»æœºï¼š3000 /</a> <br> ç„¶åç‚¹å‡»ä»ªè¡¨æ¿ä¸Š <br><br><img src="https://habrastorage.org/webt/-s/qu/vp/-squvpxh7r3uxz75j3oripxch_8.png"><br><img src="https://habrastorage.org/webt/pl/yp/ze/plypzemdf5a1z0lpshu6uli3tyi.png"><br><br> å¦‚æœè¦æ·»åŠ æ–°è§†å›¾æˆ–æ›´æ”¹ç°æœ‰è§†å›¾ï¼Œè¯·åœ¨ç•Œé¢ä¸­ç›´æ¥å°†å…¶æ›´æ”¹ï¼Œç„¶åå•å‡»â€œä¿å­˜â€ï¼Œæ‚¨å°†è·å¾—ä¸€ä¸ªå¸¦æœ‰jsonçš„æ¨¡æ€çª—å£ï¼Œæ‚¨éœ€è¦å°†å…¶æ”¾å…¥é…ç½®æ˜ å°„ä¸­ <br><div class="spoiler">  <b class="spoiler_title">ä¸€åˆ‡éƒ½å·²éƒ¨ç½²å¹¶è¿è¡Œè‰¯å¥½</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/go/id/tl/goidtlbneravv92p6g-4mkeonro.png"></div></div><br><a name="7"></a><h2> è®¡åˆ’ä»»åŠ¡ </h2><br> ä¸ºäº†åœ¨ç«‹æ–¹ä½“ä¸­çš„è¡¨å† ä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œæœ‰CronJobçš„æ¦‚å¿µ <br> ä½¿ç”¨CronJobï¼Œæ‚¨å¯ä»¥ä¸ºä»»ä½•ä»»åŠ¡è®¾ç½®æ—¶é—´è¡¨ï¼Œæœ€ç®€å•çš„ç¤ºä¾‹æ˜¯ï¼š <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/ apiVersion: batch/v1beta1 kind: CronJob metadata: name: runapijob spec: schedule: "*/1 * * * *" jobTemplate: spec: template: spec: containers: - name: runapijob image: busybox args: - /bin/sh - -c - date; wget -O - http://metricsdemo:9376/api/job/run/wakeUp &gt; /dev/null restartPolicy: OnFailure</span></span></code> </pre> <br> æ—¶é—´è¡¨éƒ¨åˆ†è®¾ç½®äº†ç‹å† çš„ç»å…¸è§„åˆ™ <br> è§¦å‘å™¨å¯åŠ¨å®¹å™¨ï¼ˆbusyboxï¼‰çš„å®¹å™¨ï¼Œæˆ‘åœ¨å…¶ä¸­æ‹‰åŠ¨äº†metricsdemoæœåŠ¡apiæ–¹æ³• <br> æ‚¨å¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤æ¥è·Ÿè¸ªä½œä¸šã€‚ <br><pre> <code class="bash hljs">kubectl.exe get cronjob runapijob --watch</code> </pre> <br><img src="https://habrastorage.org/webt/vt/1y/9v/vt1y9vjfhpygkk3xzokbywcbvnc.png"><br><br> ä»å·¥ä½œä¸­æŠ½å‡ºçš„ä¸»è¦æœåŠ¡åœ¨å‡ ç§æƒ…å†µä¸‹éƒ½ä¼šå¯åŠ¨ï¼Œå› ä¸ºå¯¹è¯¥æœåŠ¡çš„è°ƒç”¨ä»¥å¤§çº¦å‡åŒ€çš„ä»·å·®åˆ°è¾¾äº†ä¸€ä¸ªç‚‰è†› <br><div class="spoiler">  <b class="spoiler_title">æ™®ç½—ç±³ä¿®æ–¯çš„æ ·å­</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hu/v2/tt/huv2ttrdtjee5ddvgxyk4ucwkou.png"></div></div><br><div class="spoiler">  <b class="spoiler_title">ä¸ºäº†è°ƒè¯•ä½œä¸šï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨è§¦å‘</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ev/k2/c7/evk2c7bl5zdr4gdqf1jcwvddu_w.png"></div></div><br> ä¸€ä¸ªå…³äºè®¡ç®—Ï€æ•°çš„ç¤ºä¾‹çš„å°æ¼”ç¤ºï¼Œå®ƒæ¶‰åŠä»æ§åˆ¶å°å¯åŠ¨çš„å·®å¼‚ <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,       -      kubectl run pi --image=perl -- perl -Mbignum=bpi -wle 'print bpi(2000)' #   . , ,  .   -   kubectl run pi --image=perl --restart=OnFailure -- perl -Mbignum=bpi -wle 'print bpi(2000)' #    5  kubectl run pi --image=perl --restart=OnFailure --schedule="0/5 * * * ?" -- perl -Mbignum=bpi -wle 'print bpi(2000)'</span></span></code> </pre> <br><br><a name="8"></a><h2> å®¹é”™èƒ½åŠ› </h2><br> å¦‚æœåº”ç”¨ç¨‹åºæ„å¤–ç»ˆæ­¢ï¼Œåˆ™ç¾¤é›†ä¼šé‡æ–°å¯åŠ¨Pod <br> ä¾‹å¦‚ï¼Œæˆ‘åšäº†ä¸€ä¸ªåˆ é™¤apiçš„æ–¹æ³• <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HttpGet(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"kill/me"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Selfkill"</span></span>); }</code> </pre> <br>  <i>*å¼‚æ­¥voidæ–¹æ³•ä¸­çš„apiä¸­å‘ç”Ÿçš„å¼‚å¸¸è¢«è§†ä¸ºæœªå¤„ç†çš„å¼‚å¸¸ï¼Œå®ƒä¼šä½¿åº”ç”¨ç¨‹åºå®Œå…¨å´©æºƒ</i> <br><br> æˆ‘å‘¼å<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">httpï¼š//æœ¬åœ°ä¸»æœºï¼š9376 / api / job / kill / me</a> <br> ç‚‰è†›åˆ—è¡¨æ˜¾ç¤ºè¯¥æœåŠ¡çš„ç‚‰è†›ä¹‹ä¸€å·²é‡æ–°å¯åŠ¨ <br><br><img src="https://habrastorage.org/webt/f9/qr/t3/f9qrt3v1y1oo1ks2bucvt5tarvi.png"><br><br>  logså‘½ä»¤æ˜¾ç¤ºå½“å‰è¾“å‡ºï¼Œå¹¶å¸¦æœ‰-pé€‰é¡¹å°†æ˜¾ç¤ºå‰ä¸€ä¸ªå®ä¾‹çš„æ—¥å¿—ã€‚ è¿™æ ·æ‚¨å¯ä»¥æ‰¾å‡ºé‡æ–°å¯åŠ¨çš„åŸå› ã€‚ <br><br> æˆ‘è®¤ä¸ºåªè¦è·Œå€’ï¼Œä¸€åˆ‡éƒ½ä¼šå¾ˆæ¸…æ¥šï¼šè·Œå€’-ä¸Šå‡ <br><br> ä½†æ˜¯è¯¥åº”ç”¨ç¨‹åºå¯ä»¥æœ‰æ¡ä»¶åœ°ç”Ÿæ•ˆï¼Œå³ ä¸ä¼šå€’ä¸‹ï¼Œä½†æ˜¯ä»€ä¹ˆä¹Ÿä¸åšï¼Œæˆ–è€…åšä»–çš„å·¥ä½œï¼Œä½†æ˜¯è¦æ…¢æ…¢ <br><br> æ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£ï¼Œ</a>è‡³å°‘æœ‰ä¸¤ç§ç±»å‹çš„Podä¸­çš„åº”ç”¨ç¨‹åºâ€œç”Ÿå­˜èƒ½åŠ›â€æ£€æŸ¥ <br><ol><li> å‡†å¤‡å°±ç»ª-è¿™ç§ç±»å‹çš„æ£€æŸ¥ç”¨äºäº†è§£æ˜¯å¦æœ‰å¯èƒ½åœ¨æ­¤Podä¸Šå¯åŠ¨æµé‡ã€‚ å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°†åŠèˆ±è§£é™¤ç®¡åˆ¶ï¼Œç›´åˆ°å…¶æ¢å¤æ­£å¸¸ã€‚ <br></li><li> æ´»åŠ¨-æ£€æŸ¥åº”ç”¨ç¨‹åºçš„â€œç”Ÿå­˜èƒ½åŠ›â€ã€‚ ç‰¹åˆ«æ˜¯ï¼Œå¦‚æœæ— æ³•è®¿é—®é‡è¦èµ„æºï¼Œæˆ–è€…å¦‚æœåº”ç”¨ç¨‹åºå®Œå…¨ä¸å“åº”ï¼ˆä¾‹å¦‚ï¼Œæ­»é”å¹¶å› æ­¤è¶…æ—¶ï¼‰ï¼Œåˆ™å°†é‡æ–°å¯åŠ¨å®¹å™¨ã€‚  200è‡³400ä¹‹é—´çš„æ‰€æœ‰httpä»£ç å‡è¢«è§†ä¸ºæˆåŠŸï¼Œå…¶ä½™å‡å¤±è´¥ <br></li></ol><br> æˆ‘å°†æ£€æŸ¥è¶…æ—¶é‡æ–°å¯åŠ¨ï¼Œä¸ºæ­¤ï¼Œæˆ‘å°†æ·»åŠ ä¸€ä¸ªæ–°çš„apiæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†æ ¹æ®ç‰¹å®šå‘½ä»¤å¼€å§‹æ”¾æ…¢123ç§’çš„ç”Ÿå­˜èƒ½åŠ›éªŒè¯æ–¹æ³• <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> deadlock; [HttpGet(<span class="hljs-string"><span class="hljs-string">"alive/{cmd}"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Kill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cmd</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmd == <span class="hljs-string"><span class="hljs-string">"deadlock"</span></span>) { deadlock = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Deadlocked"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deadlock) Thread.Sleep(<span class="hljs-number"><span class="hljs-number">123</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> deadlock ? <span class="hljs-string"><span class="hljs-string">"Deadlocked!!!"</span></span> : <span class="hljs-string"><span class="hljs-string">"Alive"</span></span>; }</code> </pre> <br><br> æˆ‘åœ¨å®¹å™¨çš„1-deployment-app.yamlæ–‡ä»¶ä¸­æ·»åŠ äº†å‡ èŠ‚ï¼š <br><pre> <code class="bash hljs">containers: - name: metricsdemo image: localhost:5000/sansys/metricsdemo3:6 ports: - containerPort: 80 readinessProbe: <span class="hljs-comment"><span class="hljs-comment">#       httpGet: path: /health port: 80 initialDelaySeconds: 5 periodSeconds: 5 livenessProbe: #      httpGet: path: /api/job/alive/check port: 80 initialDelaySeconds: 5 periodSeconds: 5</span></span></code> </pre> <br> å†è¯´ä¸€éï¼Œæˆ‘ç¡®å®šè¯¥åº”ç”¨å·²å¯åŠ¨å¹¶è®¢é˜…äº†æ´»åŠ¨ <br><pre> <code class="bash hljs">kubectl get events --watch</code> </pre> <br> æˆ‘æŒ‰èœå•Deadlock meï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">httpï¼š//æœ¬åœ°ä¸»æœºï¼š9376 / api / job / alive / deadlock</a> ï¼‰ <br><br><img src="https://habrastorage.org/webt/ed/ir/bb/edirbbiw3gjjoptubdh7992z6yy.png"><br><br> åœ¨äº”ç§’é’Ÿå†…ï¼Œæˆ‘å¼€å§‹è§‚å¯Ÿé—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆ <br><br><pre> <code class="bash hljs">1s Warning Unhealthy Pod Liveness probe failed: Get http://10.1.0.137:80/api/job/alive/check: net/http: request canceled (Client.Timeout exceeded <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> awaiting headers) 1s Warning Unhealthy Pod Liveness probe failed: Get http://10.1.0.137:80/api/job/alive/check: net/http: request canceled (Client.Timeout exceeded <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> awaiting headers) 0s Warning Unhealthy Pod Liveness probe failed: Get http://10.1.0.137:80/api/job/alive/check: net/http: request canceled (Client.Timeout exceeded <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> awaiting headers) 0s Warning Unhealthy Pod Readiness probe failed: Get http://10.1.0.137:80/health: dial tcp 10.1.0.137:80: connect: connection refused 0s Normal Killing Pod Killing container with id docker://metricsdemo:Container failed liveness probe.. Container will be killed and recreated. 0s Normal Pulled Pod Container image <span class="hljs-string"><span class="hljs-string">"localhost:5000/sansys/metricsdemo3:6"</span></span> already present on machine 0s Normal Created Pod Created container 0s Normal Started Pod Started container</code> </pre> <br><br><a name="9"></a><h2> ç»“è®º </h2><br><ol><li> ä¸€æ–¹é¢ï¼Œè¿›å…¥é—¨æ§›æ¯”æˆ‘æƒ³è±¡çš„è¦ä½å¾—å¤šï¼Œå¦ä¸€æ–¹é¢ï¼Œå®ƒæ ¹æœ¬ä¸æ˜¯çœŸæ­£çš„kubernetesé›†ç¾¤ï¼Œè€Œä»…ä»…æ˜¯å¼€å‘äººå‘˜çš„è®¡ç®—æœºã€‚ å¹¶ä¸”æ²¡æœ‰è€ƒè™‘èµ„æºï¼Œæœ‰çŠ¶æ€åº”ç”¨ç¨‹åºï¼Œa / bæµ‹è¯•ç­‰æ–¹é¢çš„é™åˆ¶ã€‚ </li><li>  Prometeusé¦–æ¬¡å°è¯•ä½¿ç”¨å®ƒï¼Œä½†æ˜¯åœ¨å®¡æŸ¥å¤šç»´æ•°æ®é›†æœŸé—´é˜…è¯»äº†å„ç§æ–‡æ¡£å’Œç¤ºä¾‹åï¼Œå¾ˆæ˜æ˜¾å®ƒéå¸¸é€‚åˆä»ç¾¤é›†å’Œåº”ç”¨ç¨‹åºä¸­æ”¶é›†æŒ‡æ ‡ </li><li> å¤ªå¥½äº†ï¼Œå®ƒä½¿å¼€å‘äººå‘˜å¯ä»¥åœ¨å…¶è®¡ç®—æœºä¸Šå®ç°åŠŸèƒ½ï¼Œå¹¶é™¤äº†å°†ä¿¡æ¯æ·»åŠ åˆ°éƒ¨ç½²ä¸­ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å°†è®¡åˆ’çš„éƒ¨ç½²é™„åŠ åˆ°çŸ³å¢¨çƒ¯ä¸Šã€‚ ç»“æœï¼Œæ–°çš„æŒ‡æ ‡ä¼šè‡ªåŠ¨æ·»åŠ ã€‚ åŠªåŠ›å°†å¼€å§‹åœ¨èˆå°å’Œäº§å“ä¸Šå±•ç¤ºã€‚ æ–¹ä¾¿çš„ </li></ol><br><br><a name="10"></a><h2> æ³¨æ„äº‹é¡¹ </h2><br><ol><li> åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡<code> :</code>ç›¸äº’è”ç³»<code> :</code> ï¼Œè¿™æ˜¯ä½¿ç”¨grafanaâ†’prometeuså®Œæˆçš„ã€‚ å¯¹äºç†Ÿæ‚‰docker-composeçš„äººæ¥è¯´ï¼Œæ²¡æœ‰ä»€ä¹ˆæ–°é²œçš„ </li><li>  <code>kubectl create -f file.yml</code>åˆ›å»ºä¸€ä¸ªå®ä½“ </li><li>  <code>kubectl delete -f file.yml</code>åˆ é™¤å®ä½“ </li><li>  <code>kubectl get pod</code>æ‰€æœ‰ç‚‰<code>kubectl get pod</code>çš„åˆ—è¡¨ï¼ˆæœåŠ¡ï¼Œç«¯ç‚¹...ï¼‰ <ul><li>  <code>--namespace=kube-system</code>æŒ‰åç§°ç©ºé—´è¿‡æ»¤ </li><li>  <code>-n kube-system</code>ç±»ä¼¼ </li></ul></li><li>  <code>kubectl -it exec grafana-d8d4d9f5c-cvnkh -- /bin/bash</code>åº•éƒ¨é™„ä»¶ </li><li>  <code>kubectl delete service grafana</code>åˆ é™¤æœåŠ¡ï¼Œpodã€‚ éƒ¨ç½²ï¼ˆ-å…¨éƒ¨-å…¨éƒ¨åˆ é™¤ï¼‰ </li><li>  <code>kubectl describe</code>æè¿°å®ä½“ï¼ˆæ‚¨å¯ä»¥ä¸€æ¬¡å®Œæˆæ‰€æœ‰æ“ä½œï¼‰ </li><li>  <code>kubectl edit service metricsdemo</code>é€šè¿‡å¯åŠ¨è®°äº‹æœ¬å³æ—¶ç¼–è¾‘æ‰€æœ‰yaml <div class="spoiler">  <b class="spoiler_title">æ¼”ç¤ºç‰ˆ</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xh/nc/c2/xhncc23bokunuyqam3ekkntdxrw.png"></div></div></li><li>  <code>kubectl --help</code>å¸®åŠ©-å¾ˆå¤§çš„å¸®åŠ©ï¼‰ </li><li> ä¸€ä¸ªå…¸å‹çš„é—®é¢˜æ˜¯æœ‰ä¸€ä¸ªpodï¼ˆè€ƒè™‘æ­£åœ¨è¿è¡Œçš„æ˜ åƒï¼‰ï¼Œå‡ºäº†ç‚¹é—®é¢˜ï¼Œæ²¡æœ‰é€‰é¡¹ï¼Œé™¤äº†æ²¡æœ‰åŠæ³•åœ¨å†…éƒ¨è¿›è¡Œè°ƒè¯•ï¼ˆé€šè¿‡tcpdump / ncç­‰ï¼‰ã€‚  -Yuzai kubectl-debug <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">habr.com/en/company/flant/blog/436112</a> <br></li></ol><br><br><a name="11"></a><h2> å‚è€ƒæ–‡çŒ® </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»€ä¹ˆæ˜¯åº”ç”¨æŒ‡æ ‡ï¼Ÿ</a> </li><li>  Kubernetes <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kuberneteséƒ¨ç½²åˆå­¦è€…æ•™ç¨‹</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">éƒ¨ç½²</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨éƒ¨ç½²è¿è¡Œæ— çŠ¶æ€åº”ç”¨ç¨‹åº</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»€ä¹ˆæ˜¯ConfigMap</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Cronjob</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”Ÿæ´»å‡†å¤‡è°ƒæŸ¥</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">kubectlå¤‡å¿˜å•</a> </li></ul></li><li> æ™®ç½—ç±³ä¿®æ–¯ <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æŸ¥è¯¢è¯­è¨€</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Cooberçš„Prometeusé…ç½®</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetesä¸­Prometheusç®—å­çš„è£…ç½®å’Œå·¥ä½œæœºåˆ¶</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é¢„å…ˆå‡†å¤‡çš„grafanaé…ç½®</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¦æŸ¥çœ‹äººä»¬çš„å·¥ä½œæ–¹å¼</a> ï¼ˆä½†å·²ç»æœ‰äº›äº‹æƒ…å·²ç»è¿‡æ—¶äº†ï¼‰-åŸåˆ™ä¸Šï¼Œè¿™é‡Œè¿˜æœ‰æ—¥å¿—è®°å½•ï¼Œè­¦æŠ¥ç­‰ã€‚ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Helm</a> -Kubernetesçš„è½¯ä»¶åŒ…ç®¡ç†å™¨-é€šè¿‡å®ƒå¯ä»¥æ›´å®¹æ˜“åœ°ç»„ç»‡prometeus + grafanaï¼Œä½†æ˜¯æ‰‹åŠ¨è¿›è¡Œ-ä¼šå‡ºç°æ›´å¤šçš„äº†è§£ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åº“ä¼¯çš„æ™®ç½—ç±³ä¿®æ–¯ç«‹æ–¹ä½“</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kuberneteså¤±è´¥çš„æ•…äº‹</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kubernetes-HAã€‚</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä½¿ç”¨5ä¸ªå‘å¯¼éƒ¨ç½²Kubernetesæ•…éšœè½¬ç§»ç¾¤é›†</a> </li></ol><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://github.com/favicon.ico" width="22"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">githubä¸Šçš„æºä»£ç å’Œæœé…±</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN437286/">https://habr.com/ru/post/zh-CN437286/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN437274/index.html">å®è·µä¸­çš„å¯è§‚å¯Ÿæ€§æ„¿æ™¯</a></li>
<li><a href="../zh-CN437276/index.html">å¸¦æœ‰æ—¥å…‰LEDçš„Remilichtå°ç¯</a></li>
<li><a href="../zh-CN437280/index.html">è½»æ¾è‡ªåšç‰©æµ</a></li>
<li><a href="../zh-CN437282/index.html">é’ˆå¯¹VMwareç”¨æˆ·çš„Kubernetesç®€ä»‹ã€‚ ç¬¬äºŒéƒ¨åˆ†ç»ƒä¹ </a></li>
<li><a href="../zh-CN437284/index.html">ä¸éŸ³å“è¡Œä¸šæœ‰å…³çš„åŠ¨ç‰©å›­ä¸“ä¸š</a></li>
<li><a href="../zh-CN437292/index.html">ä¸ºä»€ä¹ˆä¼ ç»Ÿé›¶å”®å•†åº—æ¨¡å¼å·²ç»æ­»äº†</a></li>
<li><a href="../zh-CN437296/index.html">äººä»¬ä¸ºä»€ä¹ˆä¸ä½¿ç”¨æ­£å¼æ–¹æ³•ï¼Ÿ</a></li>
<li><a href="../zh-CN437298/index.html">å…³äºä¸€ä¸ªäºº</a></li>
<li><a href="../zh-CN437300/index.html">iOSåˆå­¦è€…éœ€è¦æŒæ¡çš„10ç§æŠ€èƒ½å’ŒçŸ¥è¯†</a></li>
<li><a href="../zh-CN437304/index.html">å¦‚æœæ‚¨æ˜¯è‰²ç›²è€…ï¼Œå¦‚ä½•è´­ä¹°åœŸè±†</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>