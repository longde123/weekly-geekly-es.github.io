<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôè üèê üë∏üèº O que sabemos sobre microsservi√ßos üßë‚Äçü§ù‚Äçüßë üà≤ üöØ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Meu nome √© Vadim Madison, lidero o desenvolvimento da System Platform Avito. Sobre como n√≥s, na empresa, estamos mudando de uma arquitetura monol√≠t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O que sabemos sobre microsservi√ßos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/454780/"><p>  Oi  Meu nome √© Vadim Madison, lidero o desenvolvimento da System Platform Avito.  Sobre como n√≥s, na empresa, estamos mudando de uma arquitetura monol√≠tica para uma arquitetura de microsservi√ßos, j√° foi dito mais de uma vez.  √â hora de compartilhar como transformamos nossa infraestrutura para tirar o m√°ximo proveito dos microsservi√ßos e n√£o nos perdermos neles.  Como o PaaS nos ajuda aqui, como simplificamos a implanta√ß√£o e reduzimos a cria√ß√£o de um microsservi√ßo para um clique - continue a ler.  Nem tudo o que escrevo abaixo √© totalmente implementado no Avito, parte √© como desenvolvemos nossa plataforma. </p><br><p>  (E no final deste artigo, falarei sobre a oportunidade de participar de um semin√°rio de tr√™s dias de um especialista em arquitetura de microsservi√ßos, Chris Richardson). </p><br><p><img src="https://habrastorage.org/webt/9e/m3/xm/9em3xmzspjfadie85f_elruwij4.png"></p><a name="habracut"></a><br><h1 id="kak-my-prishli-k-mikroservisam">  Como chegamos aos microsservi√ßos </h1><br><p>  Avito √© um dos maiores classificados do mundo, publica mais de 15 milh√µes de novos an√∫ncios por dia.  Nosso back-end aceita mais de 20 mil solicita√ß√µes por segundo.  Agora temos v√°rias centenas de microsservi√ßos. </p><br><p>  Estamos construindo a arquitetura de microsservi√ßos h√° v√°rios anos.  Como exatamente - nossos colegas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">falaram</a> em detalhes em nossa se√ß√£o no RIT ++ 2017. No CodeFest 2017 (veja o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo</a> ), Sergey Orlov e Mikhail Prokopchuk explicaram em detalhes por que precis√°vamos da transi√ß√£o para microsservi√ßos e qual o papel que o Kubernetes desempenha aqui.  Bem, agora estamos fazendo tudo para minimizar os custos de dimensionamento inerentes a essa arquitetura. </p><br><p>  Inicialmente, n√£o criamos um ecossistema que nos ajudasse de maneira abrangente no desenvolvimento e lan√ßamento de microsservi√ßos.  Eles simplesmente coletaram solu√ß√µes sensatas de c√≥digo aberto, as lan√ßaram em casa e sugeriram que o desenvolvedor as tratasse.  Como resultado, ele foi para uma d√∫zia de lugares (pain√©is, servi√ßos internos), ap√≥s o que se tornou mais forte no desejo de cortar o c√≥digo da maneira antiga, em um mon√≥lito.  A cor verde nos diagramas abaixo indica o que o desenvolvedor faz de uma maneira ou de outra com as pr√≥prias m√£os; a cor amarela indica automa√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/2a/h8/br/2ah8breno6ypqrbgo7uwi4g_ymw.png"></p><br><p>  Agora, no utilit√°rio PaaS CLI, uma equipe cria um novo servi√ßo e mais duas adicionam um novo banco de dados e implantam no Stage. </p><br><p><img src="https://habrastorage.org/webt/ku/wf/ek/kuwfekxz9r75rl_hobbjp-rd82i.png"></p><br><h1 id="kak-preodolet-epohu-mikroservisnoy-razdroblennosti">  Como superar a era da "fragmenta√ß√£o de microsservi√ßos" </h1><br><p> Com uma arquitetura monol√≠tica, para manter a consist√™ncia das mudan√ßas no produto, os desenvolvedores foram for√ßados a descobrir o que estava acontecendo com seus vizinhos.  Ao trabalhar na nova arquitetura, os contextos de servi√ßo n√£o dependem mais um do outro. </p><br><p>  Al√©m disso, para que a arquitetura de microsservi√ßo seja eficaz, muitos processos precisam ser estabelecidos, a saber: </p><br><p>  ‚Ä¢ registro; <br>  Rastreamento de consultas (Jaeger); <br>  ‚Ä¢ agrega√ß√£o de erros (Sentinela); <br>  Status, mensagens, eventos do Kubernetes (processamento de fluxo de eventos); <br>  ‚Ä¢ limite de corrida / disjuntor (voc√™ pode usar o Hystrix); <br>  ‚Ä¢ controle da conectividade do servi√ßo (usamos o Netramesh); <br>  ‚Ä¢ monitoramento (Grafana); <br>  Montagem (TeamCity); <br>  ‚Ä¢ comunica√ß√£o e notifica√ß√£o (Slack, email); <br>  ‚Ä¢ rastreamento de tarefas;  (Jira) <br>  ‚Ä¢ compila√ß√£o de documenta√ß√£o. </p><br><p>  Para que, √† medida que o sistema dimensione, n√£o perca sua integridade e permane√ßa efetivo, repensamos a organiza√ß√£o do trabalho dos microsservi√ßos no Avito. </p><br><h1 id="kak-my-upravlyaemsya-s-mikroservisami">  Como lidamos com microsservi√ßos </h1><br><p>  A condu√ß√£o de uma "pol√≠tica partid√°ria" unificada entre os muitos microsservi√ßos que a Avito ajuda: </p><br><ul><li>  divis√£o da infraestrutura em camadas; </li><li>  Conceito de plataforma como servi√ßo (PaaS); </li><li>  monitoramento de tudo o que acontece com microsservi√ßos. </li></ul><br><p>  As camadas de abstra√ß√£o de infraestrutura incluem tr√™s camadas.  Vamos de cima para baixo. </p><br><p>  <strong>A. Malha de servi√ßo superior.</strong>  No come√ßo, tentamos o Istio, mas descobriu-se que ele usa muitos recursos, o que √© muito caro em nossos volumes.  Portanto, o engenheiro s√™nior da equipe de arquitetura Alexander Lukyanchenko desenvolveu sua pr√≥pria solu√ß√£o - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Netramesh</a> (dispon√≠vel em c√≥digo aberto), que agora usamos em produ√ß√£o e que consome v√°rias vezes menos recursos que o Istio (mas n√£o faz tudo o que o Istio possui). <br>  <strong>B. M√©dio - Kubernetes.</strong>  Nele, implantamos e operamos microsservi√ßos. <br>  <strong>C. Metal inferior.</strong>  N√≥s n√£o usamos nuvens e coisas como o OpenStack, mas sentamos inteiramente no metal puro. </p><br><p>  Todas as camadas s√£o combinadas pelo PaaS.  E essa plataforma, por sua vez, consiste em tr√™s partes. </p><br><p>  <strong>I. Geradores</strong> controlados atrav√©s do utilit√°rio CLI.  √â ela quem ajuda o desenvolvedor a criar um microsservi√ßo da maneira certa e com o m√≠nimo de esfor√ßo. </p><br><p>  <strong>II</strong>  <strong>Coletor combinado</strong> com controle de todas as ferramentas atrav√©s de um painel comum. </p><br><p>  <strong>III</strong>  <strong>Reposit√≥rio</strong> .  Isso interfere nos planejadores que definem automaticamente gatilhos para a√ß√µes significativas.  Gra√ßas a esse sistema, nenhuma tarefa √© perdida apenas porque algu√©m se esqueceu de colocar uma tarefa no Jira.  Usamos uma ferramenta interna chamada Atlas para isso. </p><br><p><img src="https://habrastorage.org/webt/xq/if/9g/xqif9gz-91gsn2qzo6up78dgqts.png"></p><br><p>  A implementa√ß√£o de microsservi√ßos no Avito tamb√©m √© realizada de acordo com um √∫nico esquema, que simplifica o controle sobre eles em cada est√°gio de desenvolvimento e lan√ßamento. </p><br><h1 id="kak-ustroen-standartnyy-konveyer-razrabotki-mikroservisa">  Como o pipeline de desenvolvimento de microsservi√ßo padr√£o funciona </h1><br><p>  Em termos gerais, a cadeia de cria√ß√£o de microsservi√ßos √© a seguinte: </p><br><p>  <em>CLI-push ‚Üí Integra√ß√£o cont√≠nua ‚Üí Assar ‚Üí Implementar ‚Üí Testes artificiais ‚Üí Testes can√°rios ‚Üí Testes de compress√£o ‚Üí Produ√ß√£o ‚Üí Servi√ßo.</em> </p><br><p>  N√≥s passamos por isso exatamente nesta sequ√™ncia. </p><br><h2 id="cli-push">  CLI-push </h2><br><p>  <strong>‚Ä¢ Criando um microsservi√ßo</strong> . <br>  Lutamos por um longo tempo para ensinar cada desenvolvedor a fazer microsservi√ßos.  Incluindo escreveu no Confluence instru√ß√µes detalhadas.  Mas os esquemas mudaram e complementaram.  Conclus√£o - um gargalo formado no in√≠cio da jornada: demorou muito mais tempo para iniciar os microsservi√ßos do que o permitido e, ainda assim, ao cri√°-los, os problemas geralmente surgiam. </p><br><p>  No final, criamos um utilit√°rio CLI simples que automatiza as etapas b√°sicas ao criar um microsservi√ßo.  De fato, ele substitui o primeiro push git.  √â isso que ela faz. </p><br><p>  - Cria um servi√ßo de acordo com o modelo - passo a passo, no modo "assistente".  Temos modelos para as principais linguagens de programa√ß√£o no servidor Avito: PHP, Golang e Python. </p><br><p>  - Em um comando, ele implementa o ambiente para desenvolvimento local em uma m√°quina espec√≠fica - o Minikube aumenta, os gr√°ficos Helm s√£o gerados e lan√ßados automaticamente nos kubernetes locais. </p><br><p>  - Conecta o banco de dados desejado.  O desenvolvedor n√£o precisa saber o IP, o login e a senha para acessar o banco de dados de que precisa - pelo menos localmente, pelo menos no Stage, pelo menos na produ√ß√£o.  Al√©m disso, o banco de dados √© implantado imediatamente em uma configura√ß√£o tolerante a falhas e com balanceamento. </p><br><p>  - Ele pr√≥prio realiza uma montagem ao vivo.  Digamos que um desenvolvedor consertou algo em um microsservi√ßo por meio de seu IDE.  O utilit√°rio v√™ as altera√ß√µes no sistema de arquivos e, com base nelas, remonta o aplicativo (para Golang) e reinicia.  Para o PHP, simplesmente encaminhamos o diret√≥rio dentro do cubo e o live-reload √© obtido "automaticamente". </p><br><p>  - Gera autotestes.  Sob a forma de discos, mas bastante adequado para uso. </p><br><p>  <strong>‚Ä¢ Implantar microsservi√ßo</strong> . </p><br><p>  Era um pouco triste implantar um microsservi√ßo antes.  Obrigat√≥rio obrigat√≥rio: </p><br><p>  I. Dockerfile. </p><br><p>  II  Config. <br>  III  Um gr√°fico Helm, que √© volumoso e inclui: </p><br><p>  - os pr√≥prios gr√°ficos; <br>  - modelos; <br>  - valores espec√≠ficos, tendo em conta diferentes ambientes. </p><br><p>  N√≥s nos livramos da dor de refazer os manifestos do Kubernetes, e agora eles s√£o gerados automaticamente.  Mas o mais importante, eles simplificaram a implanta√ß√£o at√© o limite.  A partir de agora, temos um Dockerfile e o desenvolvedor grava toda a configura√ß√£o em um √∫nico arquivo app.toml curto. </p><br><p><img src="https://habrastorage.org/webt/o6/fd/g-/o6fdg-lpen5l_8evpr1j0rsltbe.png"></p><br><p>  Sim, e no app.toml agora √© assunto por um minuto.  Anotamos onde quantas c√≥pias do servi√ßo aumentar (no servidor de desenvolvimento, na prepara√ß√£o, na produ√ß√£o), indicam suas depend√™ncias.  Observe o tamanho da linha = "pequeno" no bloco [mecanismo].  Este √© o limite que ser√° alocado para o servi√ßo atrav√©s do Kubernetes. </p><br><p>  Al√©m disso, com base na configura√ß√£o, todos os gr√°ficos Helm necess√°rios s√£o gerados automaticamente e as conex√µes com os bancos de dados s√£o criadas. </p><br><p>  <strong>Valida√ß√£o b√°sica.</strong>  Tais verifica√ß√µes tamb√©m s√£o automatizadas. <br>  <strong>Precisa acompanhar:</strong> <br>  - existe um Dockerfile; <br>  - existe app.toml; <br>  - se existe documenta√ß√£o; <br>  - se as depend√™ncias est√£o em ordem; <br>  - s√£o as regras dos alertas definidos. <br>  At√© o √∫ltimo ponto: o pr√≥prio propriet√°rio do servi√ßo indica quais m√©tricas do produto monitorar. </p><br><p>  <strong>‚Ä¢ Prepara√ß√£o da documenta√ß√£o.</strong> <br>  Ainda √© um lugar problem√°tico.  Parece ser o mais √≥bvio, mas ao mesmo tempo um recorde "muitas vezes esquecido" e, portanto, um elo vulner√°vel na cadeia. <br>  √â necess√°rio que a documenta√ß√£o esteja em cada microsservi√ßo.  Os seguintes blocos est√£o inclu√≠dos nele. </p><br><p>  <strong>I. Breve descri√ß√£o do servi√ßo</strong> .  Apenas algumas frases sobre o que ele faz e o que √© necess√°rio. </p><br><p>  <strong>II</strong>  <strong>Link para o diagrama da arquitetura</strong> .  √â importante que uma r√°pida olhada seja f√°cil de entender, por exemplo, se voc√™ usa o Redis para armazenamento em cache ou como o principal armazenamento de dados no modo persistente.  No Avito, at√© agora este √© um link para o Confluence. </p><br><p>  <strong>III</strong>  <strong>Runbook</strong> .  Um pequeno guia para iniciar o servi√ßo e os meandros do manuseio. </p><br><p>  <strong>IV</strong>  <strong>FAQ</strong> , onde seria bom prever os problemas que seus colegas podem encontrar ao trabalhar com o servi√ßo. </p><br><p>  <strong>V. Descri√ß√£o dos terminais para a API</strong> .  Se de repente voc√™ n√£o indicou seu destino, certamente ser√° pago por colegas cujos microsservi√ßos est√£o relacionados ao seu.  Agora usamos o Swagger para isso e nossa solu√ß√£o √© chamada breve. </p><br><p>  <strong>VI</strong>  <strong>Etiquetas</strong>  Ou marcadores que mostram a qual produto, funcionalidade, unidade estrutural da empresa √† qual o servi√ßo pertence.  Eles ajudam a entender rapidamente, por exemplo, se voc√™ n√£o est√° vendo a funcionalidade que seus colegas implementaram h√° uma semana para a mesma unidade de neg√≥cios. </p><br><p>  <strong>VII</strong>  <strong>O propriet√°rio ou propriet√°rios do servi√ßo</strong> .  Na maioria dos casos, ele - ou eles - pode ser determinado automaticamente usando PaaS, mas para o seguro, exigimos que o desenvolvedor os especifique manualmente. </p><br><p>  Por fim, √© uma boa pr√°tica revisar a documenta√ß√£o, semelhante √† revis√£o de c√≥digo. </p><br><h2 id="continuous-integration">  Integra√ß√£o cont√≠nua </h2><br><ul><li>  <strong>Preparando reposit√≥rios.</strong> </li><li>  <strong>Criando um pipeline no TeamCity.</strong> </li><li>  <strong>Definir direitos.</strong> </li><li>  <strong>Procure por propriet√°rios de servi√ßos.</strong>  Existe um esquema h√≠brido - marca√ß√£o manual e automa√ß√£o m√≠nima do PaaS.  Um esquema totalmente autom√°tico falha ao transferir servi√ßos de suporte para outra equipe de desenvolvimento ou, por exemplo, se um desenvolvedor de servi√ßos for encerrado. </li><li>  <strong>Registro de servi√ßo no Atlas</strong> (veja acima).  Com todos os seus propriet√°rios e depend√™ncias. </li><li>  <strong>Verifique as migra√ß√µes.</strong>  Verificamos se h√° algum potencialmente perigoso entre eles.  Por exemplo, em um deles, uma tabela de altera√ß√£o √© exibida ou outra coisa que pode prejudicar a compatibilidade do esquema de dados entre diferentes vers√µes do servi√ßo.  Em seguida, a migra√ß√£o n√£o √© executada, mas √© feita uma assinatura - o PaaS deve sinalizar ao propriet√°rio do servi√ßo quando for seguro us√°-lo. </li></ul><br><h2 id="bake">  Assar </h2><br><p>  O pr√≥ximo est√°gio √© o empacotamento de servi√ßos antes da implanta√ß√£o. </p><br><ul><li>  <strong>Crie o aplicativo.</strong>  De acordo com os cl√°ssicos - na imagem do Docker. </li><li>  <strong>Gera√ß√£o de gr√°ficos Helm para o pr√≥prio servi√ßo e recursos relacionados.</strong>  Incluindo para bancos de dados e cache.  Eles s√£o criados automaticamente de acordo com a configura√ß√£o app.toml gerada no est√°gio de envio por CLI. </li><li>  <strong>Criando tickets para os administradores abrirem portas</strong> (quando necess√°rio). </li><li>  <strong>Execu√ß√£o do teste de unidade e c√°lculo da cobertura do c√≥digo</strong> .  Se a cobertura do c√≥digo estiver abaixo de um determinado valor limite, provavelmente o servi√ßo falhar√° ainda mais - ao implantar.  Se estiver √† beira do permitido, um coeficiente de "pessimiza√ß√£o" ser√° atribu√≠do ao servi√ßo: ent√£o, na aus√™ncia de melhoria do indicador ao longo do tempo, o desenvolvedor receber√° uma notifica√ß√£o de que n√£o h√° progresso por parte dos testes (e algo precisa ser feito com isso). </li><li>  <strong>Considera√ß√£o de limita√ß√µes de mem√≥ria e CPU</strong> .  N√≥s escrevemos principalmente microsservi√ßos em Golang e os executamos em Kubernetes.  A partir daqui, h√° uma sutileza associada √† peculiaridade do idioma Golang: por padr√£o, todos os kernels na m√°quina s√£o usados ‚Äã‚Äãna inicializa√ß√£o, se voc√™ n√£o definir explicitamente a vari√°vel GOMAXPROCS e, quando v√°rios servi√ßos s√£o iniciados na mesma m√°quina, eles come√ßam a competir por recursos, interferindo entre si.  Os gr√°ficos abaixo mostram como o tempo de execu√ß√£o muda se voc√™ executar o aplicativo sem concorr√™ncia e na corrida por recursos.  (A fonte dos gr√°ficos est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ). </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/dl/1g/df/dl1gdfpfvj_me2wgpj28p0ucg90.png"></a> </p><br><p>  <em>Prazo de execu√ß√£o, menos √© melhor.</em>  <em>M√°ximo: 643ms; M√≠nimo: 42ms.</em>  <em>A foto √© clic√°vel.</em> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/nb/zj/fv/nbzjfv9lx89orqn9r8ngnn84zr4.png"></a> </p><br><p>  <em>Hora da cirurgia, menos √© melhor.</em>  <em>M√°ximo: 14091 ns, M√≠nimo: 151 ns.</em>  <em>A foto √© clic√°vel.</em> </p><br><p>  Na fase de prepara√ß√£o da montagem, voc√™ pode definir essa vari√°vel explicitamente ou usar a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">automaxprocs</a> dos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">funcion√°rios</a> do Uber. </p><br><h2 id="deploy">  Implantar </h2><br><p>  <strong>‚Ä¢ verifica√ß√£o de conven√ß√µes.</strong>  Antes de come√ßar a fornecer assemblies de servi√ßo aos ambientes pretendidos, √© necess√°rio verificar o seguinte: <br>  - pontos finais da API. <br>  - Conformidade do esquema de pontos finais de respostas da API. <br>  - formato de log. <br>  - Definindo cabe√ßalhos para solicita√ß√µes de servi√ßo (o netramesh est√° fazendo isso agora) <br>  - Configurando o token do propriet√°rio ao enviar mensagens para o barramento (barramento de eventos).  Isso √© necess√°rio para rastrear a conectividade dos servi√ßos atrav√©s do barramento.  Voc√™ pode enviar dados idempotentes para o barramento que n√£o aumenta a conectividade dos servi√ßos (o que √© bom), bem como dados comerciais que aprimoram a conectividade dos servi√ßos (o que √© muito ruim!).  E no momento em que essa conectividade se torna um problema, entender quem escreve e l√™ o barramento ajuda a dividir corretamente os servi√ßos. </p><br><p>  Embora n√£o haja muitas conven√ß√µes em Avito, a piscina est√° se expandindo.  Quanto mais esses acordos estiverem na forma de um comando compreens√≠vel e conveniente, mais f√°cil ser√° manter a consist√™ncia entre os microsservi√ßos. </p><br><h2 id="sinteticheskie-testy">  Ensaios sint√©ticos </h2><br><p>  <strong>‚Ä¢ Teste de malha fechada.</strong>  Para ele, agora estamos usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hoverfly.io de</a> c√≥digo aberto.  Primeiro, ele registra a carga real no servi√ßo e, em seguida, apenas em um circuito fechado, ele emula. </p><br><p>  <strong>‚Ä¢ Teste de carga.</strong>  Tentamos trazer todos os servi√ßos para o desempenho ideal.  E todas as vers√µes de cada servi√ßo devem ser submetidas a testes de estresse - para que possamos entender o desempenho atual do servi√ßo e a diferen√ßa com as vers√µes anteriores do mesmo servi√ßo.  Se, ap√≥s uma atualiza√ß√£o de servi√ßo, seu desempenho cai uma vez e meia, isso √© um sinal claro para seus propriet√°rios: voc√™ precisa se aprofundar no c√≥digo e corrigir a situa√ß√£o. <br>  Criamos os dados coletados, por exemplo, para implementar corretamente o dimensionamento autom√°tico e, no final, entender como o servi√ßo √© escal√°vel. </p><br><p>  Durante o teste de estresse, verificamos se o consumo de recursos atende aos limites estabelecidos.  E nos concentramos principalmente em extremos. </p><br><p>  <strong>a) Observamos a carga total.</strong> <br>  - Muito pequeno - provavelmente algo n√£o funcionar√° se a carga cair repentinamente v√°rias vezes. <br>  - Muito grande - √© necess√°ria otimiza√ß√£o. </p><br><p> <strong>b) Observamos o ponto de corte pelo RPS.</strong> <br>  Aqui, examinamos a diferen√ßa entre a vers√£o atual e a anterior e o n√∫mero total.  Por exemplo, se um servi√ßo produz 100 rps, √© mal escrito ou √© a sua especificidade, mas, em qualquer caso, esta √© uma ocasi√£o para examinar atentamente o servi√ßo. <br>  Se, pelo contr√°rio, houver muitos RPS, talvez algum bug e alguns dos pontos de extremidade parem de executar a carga, mas algum tipo de <code>return true;</code> acionado <code>return true;</code> </p><br><h2 id="canary-testy">  Testes de can√°rio </h2><br><p>  Ap√≥s a aprova√ß√£o dos testes sint√©ticos, executamos o microsservi√ßo em um pequeno n√∫mero de usu√°rios.  Come√ßamos com cuidado, com uma pequena fra√ß√£o da audi√™ncia estimada do servi√ßo - menos de 0,1%.  Nesse est√°gio, √© muito importante que as m√©tricas t√©cnicas e de produto corretas sejam estabelecidas no monitoramento, para que mostrem o problema no servi√ßo o mais r√°pido poss√≠vel.  O tempo m√≠nimo para um teste de can√°rio √© de 5 minutos, o principal √© de 2 horas.  Para servi√ßos complexos, definimos o hor√°rio no modo manual. <br>  Analisamos: <br>  - m√©tricas espec√≠ficas do idioma, em particular os trabalhadores de php-fpm; <br>  - erros no Sentry; <br>  - status das respostas; <br>  - tempo de resposta (tempo de resposta), preciso e m√©dio; <br>  - lat√™ncia; <br>  - exce√ß√µes processadas e n√£o processadas; <br>  - m√©tricas de alimentos. </p><br><h2 id="squeeze-testing">  Teste de compress√£o </h2><br><p>  O Squeeze Testing tamb√©m √© chamado de teste de extrus√£o.  O nome da t√©cnica foi introduzido no Netflix.  Sua ess√™ncia √© que, a princ√≠pio, preenchemos uma inst√¢ncia com tr√°fego real para o estado de falha e, assim, definimos seu limite.  Em seguida, adicione outra inst√¢ncia e carregue esse par - novamente ao m√°ximo;  vemos o teto e o delta com o primeiro "aperto".  E assim, conectamos uma inst√¢ncia por etapa e calculamos o padr√£o de mudan√ßas. <br>  Os dados de teste por meio de "extrus√£o" tamb√©m s√£o agregados ao banco de dados de m√©tricas gerais, onde enriquecemos os resultados do carregamento artificial com eles ou at√© os substitu√≠mos por "sint√©ticos". </p><br><h2 id="prodakshen">  Produ√ß√£o </h2><br><p>  <strong>‚Ä¢ escala.</strong>  Ao implantar o servi√ßo de produ√ß√£o, rastreamos como ele √© dimensionado.  Nesse caso, monitorar apenas os indicadores da CPU, em nossa experi√™ncia, √© ineficiente.  O dimensionamento autom√°tico com o benchmarking de RPS em sua forma pura funciona, mas apenas para determinados servi√ßos, por exemplo, streaming on-line.  Portanto, estamos analisando principalmente as m√©tricas de produtos espec√≠ficas de aplicativos. </p><br><p>  <strong>Como resultado, ao escalar, analisamos:</strong> <br>  - indicadores de CPU e RAM, <br>  - o n√∫mero de pedidos na fila, <br>  - tempo de resposta <br>  - previs√£o com base em dados hist√≥ricos. </p><br><p>  Ao dimensionar um servi√ßo, tamb√©m √© importante monitorar suas depend√™ncias para que n√£o sejamos o primeiro servi√ßo da cadeia de dimensionamento, e aqueles a quem ele se refere caem sob carga.  Para estabelecer uma carga aceit√°vel para todo o pool de servi√ßos, examinamos os dados hist√≥ricos do servi√ßo dependente "mais pr√≥ximo" (com base em uma combina√ß√£o de CPU e RAM e m√©tricas espec√≠ficas do aplicativo) e os comparamos com os dados hist√≥ricos do servi√ßo de inicializa√ß√£o e assim por diante ao longo de toda a "cadeia de depend√™ncia" ", De cima para baixo. </p><br><h2 id="obsluzhivanie">  Servi√ßo </h2><br><p>  Depois que o microsservi√ßo √© colocado em opera√ß√£o, podemos colocar gatilhos nele. </p><br><p>  <strong>Aqui est√£o situa√ß√µes t√≠picas nas quais dispara fogo.</strong> <br>  - Migra√ß√µes potencialmente perigosas detectadas. <br>  - Atualiza√ß√µes de seguran√ßa foram lan√ßadas. <br>  - O servi√ßo em si n√£o √© atualizado h√° muito tempo. <br>  - A carga no servi√ßo diminuiu significativamente ou qualquer uma de suas m√©tricas de produto est√° al√©m da faixa normal. <br>  - O servi√ßo deixou de atender aos novos requisitos da plataforma. </p><br><p>  Alguns dos gatilhos s√£o respons√°veis ‚Äã‚Äãpela estabilidade do trabalho, outros em fun√ß√£o da manuten√ß√£o do sistema - por exemplo, alguns servi√ßos n√£o s√£o implantados h√° muito tempo e sua imagem b√°sica deixa de passar nas verifica√ß√µes de seguran√ßa. </p><br><h1 id="dashbord">  Dashboard </h1><br><p>  Em resumo, o painel √© o painel de controle de todo o nosso PaaS. </p><br><ul><li>  Um √∫nico ponto de informa√ß√£o sobre um servi√ßo, com dados sobre sua cobertura com testes, o n√∫mero de suas imagens, o n√∫mero de c√≥pias de produ√ß√£o, vers√µes etc. </li><li>  Uma ferramenta para filtrar dados por servi√ßos e etiquetas (marcadores de pertencer a unidades de neg√≥cios, funcionalidade do produto etc.) </li><li>  Meios de integra√ß√£o com ferramentas de infraestrutura para rastreamento, registro em log, monitoramento. </li><li>  Uma √∫nica documenta√ß√£o de ponto de servi√ßo. </li><li>  Um √∫nico ponto de vista de todos os eventos de servi√ßo. </li></ul><br><p><img src="https://habrastorage.org/webt/gi/lx/to/gilxtozg66qrpsxbrnjccubhiw0.png"><br><img src="https://habrastorage.org/webt/hq/wl/lc/hqwllckcrjfwl48sv_2qrjfefp4.png"><br><img src="https://habrastorage.org/webt/hu/ey/bj/hueybjd31isqaeav3w8iwx_oruq.png"><br><img src="https://habrastorage.org/webt/8z/ir/xk/8zirxkio-65hh2rqrj-impyozmc.png"></p><br><h1 id="itogo">  Total </h1><br><p>  Antes da introdu√ß√£o do PaaS, um novo desenvolvedor poderia passar v√°rias semanas classificando todas as ferramentas necess√°rias para executar um microsservi√ßo na produ√ß√£o: Kubernetes, Helm, nossos recursos internos do TeamCity, configurando a conex√£o com bancos de dados e caches de forma tolerante a falhas, etc. Agora, leva algumas horas para ler o in√≠cio r√°pido e fazer o pr√≥prio servi√ßo. </p><br><hr><br><p>  Eu fiz um relat√≥rio sobre este t√≥pico para o HighLoad ++ 2018, voc√™ pode assistir ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">apresenta√ß√£o</a> . </p><br><h1 id="bonus-trek-dlya-teh-kto-dochital-do-konca">  Faixa b√¥nus para quem leu at√© o fim </h1><br><p>  Em Avito, organizaremos um treinamento interno de tr√™s dias para desenvolvedores de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Chris Richardson</a> , especialista em arquitetura de microsservi√ßos.  Queremos dar a oportunidade de participar dele para um dos leitores deste post.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> est√° um programa de treinamento. </p><br><p>  O treinamento ser√° realizado de 5 a 7 de agosto em Moscou.  Estes s√£o dias √∫teis que ser√£o totalmente ocupados.  O almo√ßo e o treinamento estar√£o em nosso escrit√≥rio, e o participante escolhido paga pela viagem e pela acomoda√ß√£o. </p><br><p>  Voc√™ pode se inscrever para participar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">deste formul√°rio do Google</a> .  De voc√™ - a resposta para a pergunta: por que exatamente voc√™ precisa participar do treinamento e informa√ß√µes sobre como entrar em contato com voc√™?  Responda em ingl√™s, porque Chris escolher√° o participante que participar do treinamento. <br>  Anunciaremos o nome do participante do treinamento como uma atualiza√ß√£o para esta postagem nas redes sociais da Avito para desenvolvedores (AvitoTech no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Facebook</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vkontakte</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Twitter</a> ) at√© 19 de julho. </p><br><p>  <em>UPD, 19/07:</em> recebemos dezenas de solicita√ß√µes.  Chris os examinou e escolheu um participante: juntamente com nossos colegas, Andrei Igumnov ir√° estudar.  Parab√©ns! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt454780/">https://habr.com/ru/post/pt454780/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt454766/index.html">HBO, obrigado por me lembrar ... "Kit de primeiros socorros em Chernobyl" de um farmac√™utico bielorrusso</a></li>
<li><a href="../pt454770/index.html">Associa√ß√£o para startups da Samsung - um novo programa para startups na R√∫ssia</a></li>
<li><a href="../pt454774/index.html">Escrevemos o c√≥digo mais √∫til em nossa vida, mas jogamos no lixo. Com a gente</a></li>
<li><a href="../pt454776/index.html">Freelance ou escrit√≥rio? Resposta do freelancer</a></li>
<li><a href="../pt454778/index.html">O livro "Machine Learning: Algorithms for Business"</a></li>
<li><a href="../pt454788/index.html">Arma de um investidor cauteloso: consideramos o valor justo dos t√≠tulos de investimento</a></li>
<li><a href="../pt454790/index.html">Imagem nativa Java: verifica√ß√£o de usabilidade</a></li>
<li><a href="../pt454792/index.html">Compara√ß√£o de algoritmos de classifica√ß√£o de trocas</a></li>
<li><a href="../pt454804/index.html">Crie seu componente com micro-modelos</a></li>
<li><a href="../pt454806/index.html">Treinamento Cisco 200-125 CCNA v3.0. Dia 9. O mundo f√≠sico dos switches. Parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>