<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì® üêà ü§∞ Learning Rust: Como conversei com o UDP com a Azul üè≥Ô∏è üè° üï¥üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eu continuo aprendendo ferrugem. Ainda n√£o sei muito, ent√£o cometo muitos erros. A √∫ltima vez que tentei fazer um jogo de cobra . Tentei ciclos, cole√ß...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Learning Rust: Como conversei com o UDP com a Azul</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433624/"><img src="https://habrastorage.org/webt/zl/na/ih/zlnaihhfzb9dcso-bkwp_extqd4.jpeg"><br><br>  Eu continuo aprendendo ferrugem.  Ainda n√£o sei muito, ent√£o cometo muitos erros.  A √∫ltima vez que tentei fazer um jogo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cobra</a> .  Tentei ciclos, cole√ß√µes, trabalhei com o 3D <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Three.rs</a> .  Aprendeu sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ggez</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ametista</a> .  Desta vez, tentei criar um cliente e um servidor para conversar.  Para GUI usado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Azul</a> .  Tamb√©m assistiram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conrod</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Yew</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Orbtk</a> .  Tentei multithreading, canais e redes.  Levei em considera√ß√£o os erros do artigo anterior e tentei tornar isso mais detalhado.  Para detalhes, bem-vindo ao gato. <a name="habracut"></a><br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fontes, funciona no Windows 10 x64</a> <br><br>  Para redes, usei o UDP porque quero fazer meu pr√≥ximo projeto usando esse protocolo e queria trein√°-lo aqui.  Para a GUI, rapidamente acessei os projetos do Google no Rust, observei os exemplos b√°sicos para eles, e o Azul me fisgou porque ele usa um Modelo de Objeto de Documento e um mecanismo de estilo semelhante ao CSS, e eu estava envolvido no desenvolvimento da Web por um longo tempo.  Em geral, eu escolhi o Framework subjetivamente.  At√© o momento, est√° em alfa profundo: a rolagem n√£o funciona, o foco de entrada n√£o funciona, n√£o h√° cursor.  Para inserir dados em um campo de texto, voc√™ precisa passar o mouse sobre ele e mant√™-lo diretamente acima dele enquanto digita.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mais detalhes ...</a> <br><br>  Na verdade, a maior parte do artigo s√£o coment√°rios de c√≥digo. <br><br><h2>  Azul </h2><br>  Estrutura da GUI usando estilo funcional, DOM, CSS.  Sua interface consiste em um elemento raiz, que possui muitos descendentes, que podem ter seus pr√≥prios descendentes, como em HTML e XML.  Toda a interface √© criada com base nos dados de um √∫nico DataModel.  Nele, todos os dados s√£o transferidos para a apresenta√ß√£o em geral.  Se algu√©m est√° familiarizado com o ASP.NET, o Azul e seu DataModel s√£o como o Razor e seu ViewModel.  Como no HTML, voc√™ pode vincular fun√ß√µes a eventos de elementos DOM.  Voc√™ pode estilizar elementos usando a estrutura CSS.  Este n√£o √© o mesmo CSS que o HTML, mas √© muito semelhante a ele.  Tamb√©m h√° liga√ß√£o bidirecional como no Angular ou MVVM no WPF, UWP.  Mais informa√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no site</a> . <br><br><h2>  Uma breve vis√£o geral do restante das estruturas </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Orbtk</a> - quase o mesmo que Azul e tamb√©m em alfa profundo </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conrod</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√≠deo</a> Voc√™ pode criar aplicativos de desktop multiplataforma. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Yew</a> √© WebAssembly e semelhante ao React.  Para desenvolvimento web. </li></ul><br><h2>  Cliente </h2><br><h3>  A estrutura na qual as fun√ß√µes auxiliares de leitura e grava√ß√£o em um soquete s√£o agrupadas </h3><br><pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChatService</span></span></span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> ChatService { <span class="hljs-comment"><span class="hljs-comment">//1 fn read_data(socket: &amp;Option&lt;UdpSocket&gt;) -&gt; Option&lt;String&gt; { //2 let mut buf = [0u8; 4096]; match socket { Some(s) =&gt; { //3 match s.recv(&amp;mut buf) { //4 Ok(count) =&gt; Some(String::from_utf8(buf[..count].into()) .expect("can't parse to String")), Err(e) =&gt; { //5 println!("Error {}", e); None } } } _ =&gt; None, } } //6 fn send_to_socket(message: String, socket: &amp;Option&lt;UdpSocket&gt;) { match socket { //7 Some(s) =&gt; { s.send(message.as_bytes()).expect("can't send"); } _ =&gt; return, } } }</span></span></code> </pre> <br><ol><li>  Ler dados do soquete </li><li>  Buffer para dados a serem lidos do soquete. </li><li>  Bloqueio de chamada.  Aqui, o encadeamento de execu√ß√£o para at√© que os dados sejam lidos ou ocorra um tempo limite. </li><li>  Obtemos uma string de uma matriz de bytes na codifica√ß√£o UTF8. </li><li>  Chegamos aqui se a conex√£o foi interrompida por um tempo limite ou outro erro ocorreu. </li><li>  Envia uma string para um soquete. </li><li>  Converta a string em bytes na codifica√ß√£o UTF8 e envie os dados para o soquete.  A grava√ß√£o de dados em um soquete n√£o est√° bloqueando, ou seja,  o segmento de execu√ß√£o continuar√° seu trabalho.  Se os dados n√£o puderam ser enviados, interrompemos o programa com a mensagem "n√£o √© poss√≠vel enviar". </li></ol><br><h3>  Uma estrutura que agrupa fun√ß√µes para manipular eventos do usu√°rio e modificar nosso DataModel </h3><br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span></span> {} <span class="hljs-comment"><span class="hljs-comment">//1 const TIMEOUT_IN_MILLIS: u64 = 2000; impl Controller { //2 fn send_pressed(app_state: &amp;mut azul::prelude::AppState&lt;ChatDataModel&gt;, _event: azul::prelude::WindowEvent&lt;ChatDataModel&gt;) -&gt; azul::prelude::UpdateScreen { //3 let data = app_state.data.lock().unwrap(); //4 let message = data.messaging_model.text_input_state.text.clone(); data.messaging_model.text_input_state.text = "".into(); //5 ChatService::send_to_socket(message, &amp;data.messaging_model.socket); //6 azul::prelude::UpdateScreen::Redraw } //7 fn login_pressed(app_state: &amp;mut azul::prelude::AppState&lt;ChatDataModel&gt;, _event: azul::prelude::WindowEvent&lt;ChatDataModel&gt;) -&gt; azul::prelude::UpdateScreen { //8 use std::time::Duration; //9 if let Some(ref _s) = app_state.data.clone().lock().unwrap().messaging_model.socket { return azul::prelude::UpdateScreen::DontRedraw; } //10 app_state.add_task(Controller::read_from_socket_async, &amp;[]); //11 app_state.add_daemon(azul::prelude::Daemon::unique(azul::prelude::DaemonCallback(Controller::redraw_daemon))); //12 let mut data = app_state.data.lock().unwrap(); //13 let local_address = format!("127.0.0.1:{}", data.login_model.port_input.text.clone().trim()); //14 let socket = UdpSocket::bind(&amp;local_address) .expect(format!("can't bind socket to {}", local_address).as_str()); //15 let remote_address = data.login_model.address_input.text.clone().trim().to_string(); //16 socket.connect(&amp;remote_address) .expect(format!("can't connect to {}", &amp;remote_address).as_str()); //17 socket.set_read_timeout(Some(Duration::from_millis(TIMEOUT_IN_MILLIS))) .expect("can't set time out to read"); // 18 data.logged_in = true; // 19 data.messaging_model.socket = Option::Some(socket); //20 azul::prelude::UpdateScreen::Redraw } //21 fn read_from_socket_async(app_data: Arc&lt;Mutex&lt;ChatDataModel&gt;&gt;, _: Arc&lt;()&gt;) { //22 let socket = Controller::get_socket(app_data.clone()); loop { //23 if let Some(message) = ChatService::read_data(&amp;socket) { //24 app_data.modify(|state| { //25 state.messaging_model.has_new_message = true; //26 state.messaging_model.messages.push(message); }); } } } //27 fn redraw_daemon(state: &amp;mut ChatDataModel, _repres: &amp;mut azul::prelude::Apprepres) -&gt; (azul::prelude::UpdateScreen, azul::prelude::TerminateDaemon) { //28 if state.messaging_model.has_new_message { state.messaging_model.has_new_message = false; (azul::prelude::UpdateScreen::Redraw, azul::prelude::TerminateDaemon::Continue) } else { (azul::prelude::UpdateScreen::DontRedraw, azul::prelude::TerminateDaemon::Continue) } } //29 fn get_socket(app_data: Arc&lt;Mutex&lt;ChatDataModel&gt;&gt;) -&gt; Option&lt;UdpSocket&gt; { //30 let ref_model = &amp;(app_data.lock().unwrap().messaging_model.socket); //31 match ref_model { Some(s) =&gt; Some(s.try_clone().unwrap()), _ =&gt; None } } }</span></span></code> </pre><br><ol><li>  O tempo limite em milissegundos ap√≥s o qual a opera√ß√£o de bloqueio da leitura do soquete ser√° interrompida. </li><li>  A fun√ß√£o √© conclu√≠da quando o usu√°rio deseja enviar uma nova mensagem para o servidor. </li><li>  Tomamos posse do mutex com nosso modelo de dados.  Isso bloqueia o encadeamento de redesenho de interface at√© que o mutex seja liberado. </li><li>  Fazemos uma c√≥pia do texto inserido pelo usu√°rio para transferi-lo ainda mais e limpar o campo de entrada de texto. </li><li>  Estamos enviando uma mensagem. </li><li>  Informamos ao Framework que, ap√≥s o processamento deste evento, precisamos redesenhar a interface. </li><li>  A fun√ß√£o funciona quando o usu√°rio deseja se conectar ao servidor. </li><li>  Conectamos a estrutura para representar o per√≠odo de tempo da biblioteca padr√£o. </li><li>  Se j√° estamos conectados ao servidor, interrompemos a execu√ß√£o da fun√ß√£o e informamos ao Framework que n√£o h√° necessidade de redesenhar a interface. </li><li>  Adicione uma tarefa que ser√° executada de forma ass√≠ncrona no thread do pool de threads do Azul Framework.  O acesso ao mutex com o modelo de dados bloqueia a atualiza√ß√£o da interface do usu√°rio at√© que o mutex seja liberado. </li><li>  Adicione uma tarefa recorrente que √© executada no thread principal.  Quaisquer c√°lculos longos neste daemon s√£o bloqueados pela atualiza√ß√£o da interface. </li><li>  N√≥s entramos na posse do mutex. </li><li>  Lemos a porta inserida pelo usu√°rio e criamos um endere√ßo local com base nela, vamos ouvir. </li><li>  Crie um soquete UDP que leia pacotes que chegam ao endere√ßo local. </li><li>  Lemos o endere√ßo do servidor digitado pelo usu√°rio. </li><li>  Dizemos ao nosso soquete UDP para ler pacotes somente deste servidor. </li><li>  Defina o tempo limite para a opera√ß√£o de leitura do soquete.  A grava√ß√£o no soquete ocorre sem esperar, ou seja, apenas gravamos dados e n√£o esperamos nada, e a opera√ß√£o de leitura do soquete bloqueia o fluxo e aguarda at√© que os dados que podem ser lidos cheguem.  Se voc√™ n√£o definir um tempo limite, a opera√ß√£o de leitura do soquete aguardar√° indefinidamente. </li><li>  Defina um sinalizador indicando que o usu√°rio j√° est√° conectado ao servidor. </li><li>  Passamos o soquete criado para o modelo de dados. </li><li>  Informamos ao Framework que, ap√≥s o processamento deste evento, precisamos redesenhar a interface. </li><li>  Uma opera√ß√£o ass√≠ncrona que √© executada no pool de threads do Azul Framework. </li><li>  Obtenha uma c√≥pia do soquete em nosso modelo de dados. </li><li>  Tentando ler dados de um soquete.  Se voc√™ n√£o fizer uma c√≥pia do soquete e aguardar diretamente aqui at√© que uma mensagem chegue do soquete que est√° no mutex em nosso modelo de dados, toda a interface deixar√° de ser atualizada at√© que n√≥s liberemos o mutex. </li><li>  Se recebermos algum tipo de mensagem, alterando nosso modelo de dados, modify far√° o mesmo que lock (). Desembrulhe () passando o resultado para o lambda e liberando o mutex ap√≥s o t√©rmino do c√≥digo lambda. </li><li>  Defina um sinalizador para indicar que temos uma nova mensagem. </li><li>  Adicione uma mensagem √† matriz de todas as mensagens de bate-papo. </li><li>  Uma opera√ß√£o s√≠ncrona repetida em execu√ß√£o no encadeamento principal. </li><li>  Se tivermos uma nova mensagem, informamos ao Framework que precisamos redesenhar a interface do zero e continuar trabalhando com esse daemon; caso contr√°rio, n√£o desenharemos a interface desde o in√≠cio, mas ainda chamaremos essa fun√ß√£o no pr√≥ximo ciclo. </li><li>  Cria uma c√≥pia do nosso soquete para n√£o manter o mutex bloqueado com nosso modelo de dados. </li><li>  N√≥s obtemos o mutex e obtemos um link para o soquete. </li><li>  Crie uma c√≥pia do soquete.  O Mutex ser√° liberado automaticamente ao sair de uma fun√ß√£o. </li></ol><br><h3>  Processamento de dados ass√≠ncrono e daemons em Azul </h3><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// Problem - blocks UI :( fn start_connection(app_state: &amp;mut AppState&lt;MyDataModel&gt;, _event: WindowEvent&lt;MyDataModel&gt;) -&gt; UpdateScreen { //   app_state.add_task(start_async_task, &amp;[]); //  app_state.add_daemon(Daemon::unique(DaemonCallback(start_daemon))); UpdateScreen::Redraw } fn start_daemon(state: &amp;mut MyDataModel, _repres: &amp;mut Apprepres) -&gt; (UpdateScreen, TerminateDaemon) { // UI    thread::sleep(Duration::from_secs(10)); state.counter += 10000; (UpdateScreen::Redraw, TerminateDaemon::Continue) } fn start_async_task(app_data: Arc&lt;Mutex&lt;MyDataModel&gt;&gt;, _: Arc&lt;()&gt;) { // simulate slow load app_data.modify(|state| { // UI    thread::sleep(Duration::from_secs(10)); state.counter += 10000; }); }</span></span></code> </pre><br>  O daemon √© sempre executado no encadeamento principal, portanto, o bloqueio √© inevit√°vel l√°.  Com uma tarefa ass√≠ncrona, se voc√™ fizer, por exemplo, assim, n√£o haver√° bloqueio por 10 segundos. <br><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_async_task</span></span></span></span>(app_data: Arc&lt;Mutex&lt;MyDataModel&gt;&gt;, _: Arc&lt;()&gt;) { <span class="hljs-comment"><span class="hljs-comment">//  UI.  . thread::sleep(Duration::from_secs(10)); app_data.modify(|state| { state.counter += 10000; }); }</span></span></code> </pre><br>  A fun√ß√£o de modifica√ß√£o chama lock () e o mutex com o modelo de dados, portanto, bloqueia a atualiza√ß√£o da interface durante a execu√ß√£o. <br><br><h3>  Nossos estilos </h3><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CUSTOM_CSS: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span> = <span class="hljs-string"><span class="hljs-string">" .row { height: 50px; } .orange { background: linear-gradient(to bottom, #f69135, #f37335); font-color: white; border-bottom: 1px solid #8d8d8d; }"</span></span>;</code> </pre><br><h3>  Na verdade, fun√ß√µes para criar nosso DOM para exibir ao usu√°rio </h3><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> azul::prelude::Layout <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ChatDataModel { <span class="hljs-comment"><span class="hljs-comment">//1 fn layout(&amp;self, info: azul::prelude::WindowInfo&lt;Self&gt;) -&gt; azul::prelude::Dom&lt;Self&gt; { //2 if self.logged_in { self.chat_form(info) } else { self.login_form(info) } } } impl ChatDataModel { //3 fn login_form(&amp;self, info: azul::prelude::WindowInfo&lt;Self&gt;) -&gt; azul::prelude::Dom&lt;Self&gt; { //4 let button = azul::widgets::button::Button::with_label("Login") //5 .dom() //6 .with_class("row") //7 .with_class("orange") //8 .with_callback( azul::prelude::On::MouseUp, azul::prelude::Callback(Controller::login_pressed)); //9 let port_label = azul::widgets::label::Label::new("Enter port to listen:") .dom() .with_class("row"); //10 let port = azul::widgets::text_input::TextInput::new() //11 .bind(info.window, &amp;self.login_model.port_input, &amp;self) .dom(&amp;self.login_model.port_input) .with_class("row"); // 9 let address_label = azul::widgets::label::Label::new("Enter server address:") .dom() .with_class("row"); //10 let address = azul::widgets::text_input::TextInput::new() //11 .bind(info.window, &amp;self.login_model.address_input, &amp;self) .dom(&amp;self.login_model.address_input) .with_class("row"); //12 azul::prelude::Dom::new(azul::prelude::NodeType::Div) .with_child(port_label) .with_child(port) .with_child(address_label) .with_child(address) .with_child(button) } //13 fn chat_form(&amp;self, info: azul::prelude::WindowInfo&lt;Self&gt;) -&gt; azul::prelude::Dom&lt;Self&gt; { //14 let button = azul::widgets::button::Button::with_label("Send") .dom() .with_class("row") .with_class("orange") .with_callback(azul::prelude::On::MouseUp, azul::prelude::Callback(Controller::send_pressed)); //15 let text = azul::widgets::text_input::TextInput::new() .bind(info.window, &amp;self.messaging_model.text_input_state, &amp;self) .dom(&amp;self.messaging_model.text_input_state) .with_class("row"); //12 let mut dom = azul::prelude::Dom::new(azul::prelude::NodeType::Div) .with_child(text) .with_child(button); //16 for i in &amp;self.messaging_model.messages { dom.add_child(azul::widgets::label::Label::new(i.clone()).dom().with_class("row")); } dom } }</span></span></code> </pre><br><ol><li>  A fun√ß√£o que cria o DOM final e √© chamada toda vez que voc√™ precisa redesenhar a interface. </li><li>  Se j√° estamos conectados ao servidor, mostramos o formul√°rio para enviar e ler mensagens, caso contr√°rio, exibimos o formul√°rio para conectar-se ao servidor. </li><li>  Cria um formul√°rio para inserir os dados necess√°rios para conectar-se ao servidor. </li><li>  Crie um bot√£o com a inscri√ß√£o de texto Login. </li><li>  Converta-o em um objeto DOM. </li><li>  Adicione a classe de linha a ela. </li><li>  Adicione a laranja da classe css. </li><li>  Adicione um manipulador de eventos para clicar no bot√£o. </li><li>  Crie um r√≥tulo de texto com o texto a ser exibido na linha do usu√°rio e da classe css. </li><li>  Criamos uma caixa de texto para inserir texto com o texto da propriedade do nosso modelo e linha da classe css. </li><li>  Vincule o campo de texto √† propriedade do nosso DataModel.  Esta √© uma liga√ß√£o bidirecional.  Agora, editar o TextInput altera automaticamente o texto na propriedade do nosso modelo e o oposto tamb√©m √© verdadeiro.  Se alterarmos o texto em nosso modelo, o texto em TextInput ser√° alterado. </li><li>  Criamos um elemento DOM raiz no qual colocamos nossos elementos de interface do usu√°rio. </li><li>  Cria um formul√°rio para enviar e ler mensagens. </li><li>  Crie um bot√£o com o texto "Enviar" e css com as classes "linha", "laranja" e um manipulador de eventos quando ele for clicado. </li><li>  Crie um campo de entrada de texto bidirecional com a propriedade de modelo self.messaging_model.text_input_state e css com a classe "row". </li><li>  Adicione r√≥tulos de texto que exibam mensagens escritas no bate-papo. </li></ol><br><h3>  Nosso modelo que armazena o estado da nossa interface </h3><br>  A documenta√ß√£o da Azul diz que ele deve armazenar todos os dados do aplicativo, incluindo a conex√£o com o banco de dados, ent√£o coloquei um soquete UDP nele. <br><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">//1 #[derive(Debug)] //2 struct ChatDataModel { //3 logged_in: bool, //4 messaging_model: MessagingDataModel, //5 login_model: LoginDataModel, } #[derive(Debug, Default)] struct LoginDataModel { //6 port_input: azul::widgets::text_input::TextInputState, //7 address_input: azul::widgets::text_input::TextInputState, } #[derive(Debug)] struct MessagingDataModel { //8 text_input_state: azul::widgets::text_input::TextInputState, //9 messages: Vec&lt;String&gt;, //10 socket: Option&lt;UdpSocket&gt;, //11 has_new_message: bool, }</span></span></code> </pre><br><ol><li>  Isso nos permitir√° exibir nossa estrutura como uma string em um modelo no formato {:?} </li><li>  Nosso modelo de dados.  Para que possa ser usado na Azul.  Ela deve implementar a caracter√≠stica de layout. </li><li>  Um sinalizador para verificar se o usu√°rio est√° conectado ao servidor ou n√£o. </li><li>  Um modelo para exibir um formul√°rio para enviar mensagens para o servidor e salvar mensagens recebidas do servidor. </li><li>  Modelo para exibir o formul√°rio para conectar-se ao servidor. </li><li>  A porta que o usu√°rio digitou.  Vamos ouvi-lo com o nosso soquete. </li><li>  O endere√ßo do servidor que o usu√°rio digitou.  Vamos nos conectar a ele. </li><li>  Mensagem do usu√°rio.  N√≥s o enviaremos para o servidor. </li><li>  Uma matriz de mensagens que vieram do servidor. </li><li>  O soquete atrav√©s do qual nos comunicamos com o servidor. </li><li>  Um sinalizador para verificar se uma nova mensagem chegou do servidor. </li></ol><br><h3>  E, finalmente, o principal ponto de entrada para o aplicativo.  Inicia um ciclo de desenho da GUI e processamento de entrada do usu√°rio </h3><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span></span>() { <span class="hljs-comment"><span class="hljs-comment">//1 let app = azul::prelude::App::new(ChatDataModel { logged_in: false, messaging_model: MessagingDataModel { text_input_state: azul::widgets::text_input::TextInputState::new(""), messages: Vec::new(), socket: None, has_new_message: false, }, login_model: LoginDataModel::default(), }, azul::prelude::AppConfig::default()); // 2 let mut style = azul::prelude::css::native(); //3 style.merge(azul::prelude::css::from_str(CUSTOM_CSS).unwrap()); //4 let window = azul::prelude::Window::new(azul::prelude::WindowCreateOptions::default(), style).unwrap(); //5 app.run(window).unwrap(); }</span></span></code> </pre><br><ol><li>  Criamos um aplicativo com dados iniciais. </li><li>  Os estilos usados ‚Äã‚Äãpelo aplicativo por padr√£o. </li><li>  Adicione nossos pr√≥prios estilos a eles. </li><li>  Criamos uma janela na qual nosso aplicativo ser√° exibido. </li><li>  Inicie o aplicativo nesta janela. </li></ol><br><h2>  Servidor </h2><br><h3>  O principal ponto de entrada do aplicativo </h3><br>  Aqui geralmente temos um aplicativo de console. <br><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span></span>() { <span class="hljs-comment"><span class="hljs-comment">//1 let socket = create_socket(); //2 let (sx, rx) = mpsc::channel(); //3 start_sender_thread(rx, socket.try_clone().unwrap()); loop { //4 sx.send(read_data(&amp;socket)).unwrap(); } }</span></span></code> </pre><br><ol><li>  Crie um soquete. </li><li>  Criamos um canal unidirecional com um remetente de mensagem sx e muitos destinat√°rios rx. </li><li>  Come√ßamos a enviar mensagens para todos os destinat√°rios em um fluxo separado. </li><li>  Lemos os dados do soquete e enviamos para o fluxo, que envia mensagens aos clientes conectados ao servidor. </li></ol><br><h3>  Fun√ß√£o para criar um fluxo para enviar mensagens aos clientes </h3><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_sender_thread</span></span></span></span>(rx: mpsc::Receiver&lt;(<span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>&gt;, SocketAddr)&gt;, socket: UdpSocket) { <span class="hljs-comment"><span class="hljs-comment">//1 thread::spawn(move || { //2 let mut addresses = Vec::&lt;SocketAddr&gt;::new(); //3 loop { //4 let (bytes, pre) = rx.recv().unwrap(); // 5 if !addresses.contains(&amp;pre) { println!(" {} connected to server", pre); addresses.push(pre.clone()); } //6 let result = String::from_utf8(bytes) .expect("can't parse to String") .trim() .to_string(); println!("received {} from {}", result, pre); //7 let message = format!("FROM: {} MESSAGE: {}", pre, result); let data_to_send = message.as_bytes(); //8 addresses .iter() .for_each(|s| { //9 socket.send_to(data_to_send, s) //10 .expect(format!("can't send to {}", pre).as_str()); }); } }); }</span></span></code> </pre><br><ol><li>  Inicie um novo thread.  move significa que as vari√°veis ‚Äã‚Äãassumem o lambda e o fluxo, respectivamente.  Mais especificamente, nosso novo thread "absorver√°" as vari√°veis ‚Äã‚Äãrx e socket. </li><li>  Uma cole√ß√£o de endere√ßos conectados a n√≥s pelos clientes.  Enviaremos a todos eles nossas mensagens.  Em geral, em um projeto real, seria necess√°rio desconectar um cliente de n√≥s e remover seu endere√ßo dessa matriz. </li><li>  Come√ßamos um loop infinito. </li><li>  Lemos os dados do canal.  Aqui o fluxo ser√° bloqueado at√© que novos dados cheguem. </li><li>  Se n√£o houver esse endere√ßo em nossa matriz, adicione-o l√°. </li><li>  Decodifique uma sequ√™ncia UTF8 de uma matriz de bytes. </li><li>  Criamos uma matriz de bytes que vamos enviar a todos os nossos clientes. </li><li>  Examinamos a coleta de endere√ßos e enviamos dados para todos. </li><li>  A opera√ß√£o de grava√ß√£o no soquete UDP √© sem bloqueio; portanto, aqui a Fun√ß√£o n√£o espera at√© que a mensagem chegue ao destinat√°rio e seja executada quase instantaneamente. </li><li>  esperar em caso de erro far√° uma sa√≠da de emerg√™ncia do programa com a mensagem fornecida. </li></ol><br><h3>  A fun√ß√£o cria um soquete com base na entrada do usu√°rio </h3><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TIMEOUT_IN_MILLIS: <span class="hljs-built_in"><span class="hljs-built_in">u64</span></span> = <span class="hljs-number"><span class="hljs-number">2000</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_socket</span></span></span></span>() -&gt; UdpSocket { <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"Enter port to listen"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//1 let local_port: String = read!("{}\n"); let local_address = format!("127.0.0.1:{}", local_port.trim()); println!("server address {}", &amp;local_address); //2 let socket = UdpSocket::bind(&amp;local_address.trim()) .expect(format!("can't bind socket to {}", &amp;local_address).as_str()); //3 socket.set_read_timeout(Some(Duration::from_millis(TIMEOUT_IN_MILLIS))) .expect("can't set time out to read"); //4 socket }</span></span></code> </pre><br><ol><li>  Lemos a porta que nosso servidor escutar√° e criamos um endere√ßo de servidor local com base nela. </li><li>  Crie um soquete UDP escutando neste endere√ßo. </li><li>  Defina o tempo limite para a opera√ß√£o de leitura.  A opera√ß√£o de leitura est√° bloqueando e bloquear√° o fluxo at√© que novos dados cheguem ou ocorra um tempo limite. </li><li>  Retornamos o soquete criado da Fun√ß√£o. </li><li>  A fun√ß√£o l√™ os dados do soquete e os retorna juntamente com o endere√ßo do remetente. </li></ol><br><h3>  Fun√ß√£o para ler dados de um soquete </h3><br><pre> <code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_data</span></span></span></span>(socket: &amp;UdpSocket) -&gt; (<span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>&gt;, SocketAddr) { <span class="hljs-comment"><span class="hljs-comment">//1 let mut buf = [0u8; 4096]; //2 loop { match socket.recv_from(&amp;mut buf) { //3 Ok((count, address)) =&gt; { //4 return (buf[..count].into(), address); } //5 Err(e) =&gt; { println!("Error {}", e); continue; } }; } }</span></span></code> </pre><br><ol><li>  O buffer √© o local onde vamos ler os dados. </li><li>  Inicia um loop que ser√° executado at√© que dados v√°lidos sejam lidos. </li><li>  Obtemos o n√∫mero de bytes lidos e o endere√ßo do remetente. </li><li>  Cortamos a matriz desde o in√≠cio at√© o n√∫mero de bytes lidos e a convertemos em um vetor de bytes. </li><li>  Se ocorrer um tempo limite ou outro erro, prossiga para a pr√≥xima itera√ß√£o do loop. </li></ol><br><h2>  Sobre camadas no aplicativo </h2><br><div class="spoiler">  <b class="spoiler_title">Offtopic: Um pequeno programa educacional para dois de junho no trabalho.</b>  <b class="spoiler_title">Eu decidi coloc√°-lo aqui, talvez algu√©m venha a calhar.</b>  <b class="spoiler_title">Os poetas afiados de junho s√£o exemplos em C # e estamos falando sobre o ASP.NET</b> <div class="spoiler_text">  Ent√£o, n√£o havia nada a fazer, era √† noite e decidi escrever um pequeno programa educacional sobre arquitetura para Artem e Victor.  Bem, vamos l√°. <br><br>  Na verdade, eu adicionei aqui porque o modo √© de reconhecimento e s√≥ posso escrever artigos uma vez por semana, e o material j√° est√° l√° e na pr√≥xima semana eu queria enviar outra coisa para Habr. <br><br>  Normalmente, um aplicativo √© em camadas.  Em cada camada, h√° objetos que implementam a caracter√≠stica de comportamento da camada em que est√£o localizados.  E assim  Essas s√£o as camadas. <br><br><ol><li>  Camada de apresenta√ß√£o. </li><li>  Camada l√≥gica de neg√≥cios. </li><li>  Camada de acesso a dados. </li><li>  Entidades (usu√°rio, animal etc.) </li></ol><br><br>  Cada camada pode conter seu pr√≥prio DTO e classes completamente arbitr√°rias com m√©todos arbitr√°rios.  O principal √© que eles executem a funcionalidade associada √† camada em que est√£o localizados.  Em aplicativos simples, algumas das camadas podem estar ausentes.  Por exemplo, uma visualiza√ß√£o de camada pode ser implementada atrav√©s do padr√£o MVC, MVP, MVVM.  O que √© completamente opcional.  O principal √© que as classes que est√£o nessa camada implementam a funcionalidade atribu√≠da √† camada.  Lembre-se, padr√µes e arquitetura s√£o apenas recomenda√ß√µes, n√£o dire√ß√µes.  Padr√£o e arquitetura n√£o √© uma lei, este √© um conselho. <br><br>  E assim, consideraremos cada camada no exemplo de um aplicativo ASP.NET padr√£o usando o Entity Framework padr√£o. <br><br><h3>  Camada de apresenta√ß√£o </h3><br>  Temos MVC aqui.  Essa √© a camada que fornece a intera√ß√£o do usu√°rio.  Os comandos v√™m aqui e os usu√°rios obt√™m dados daqui.  N√£o necessariamente pessoas, se tivermos uma API, nosso usu√°rio ser√° um programa diferente.  Carros se comunicam com carros. <br><br><h3>  Camada l√≥gica de neg√≥cios </h3><br>  Aqui, geralmente, as classes s√£o chamadas de Servi√ßo, por exemplo, UserService, embora possa ser qualquer coisa.  Apenas um conjunto de classes com m√©todos.  O principal √© que os c√°lculos e c√°lculos de nossa aplica√ß√£o ocorram aqui.  Essa √© a camada mais grossa e mais volumosa.  Existe a maior parte do c√≥digo e v√°rias classes.  Esta √©, de fato, a nossa aplica√ß√£o. <br><br><h3>  Camada de acesso a dados </h3><br>  Geralmente aqui a EF implementa padr√µes de Unidade de trabalho e reposit√≥rio.  Ent√£o, sim, o DbContext √©, voc√™ pode dizer, Unidade de Trabalho, e o DB define que √© Reposit√≥rio.  Este √©, de fato, o local onde colocamos os dados e de onde obtemos.  Independentemente de a fonte de dados ser um banco de dados, API de outro aplicativo, cache na mem√≥ria ou apenas algum tipo de gerador de n√∫meros aleat√≥rios.  Qualquer fonte de dados. <br><br><h3>  Entidades </h3><br>  Sim, apenas todos os tipos de usu√°rio, animal e muito mais.  Um ponto importante - eles podem ter algum tipo de comportamento caracter√≠stico apenas deles.  Por exemplo: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FirstName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> LastName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FullName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FirstName + <span class="hljs-string"><span class="hljs-string">" "</span></span> + LastName; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">User user</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.FullName == user.FullName; } }</code> </pre> <br><h3>  Bem, e um exemplo muito simples.  Shoba era </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-comment"><span class="hljs-comment">//Entities class User { public int Id { get; set; } public string Name { get; set; } } //Data Access Layer class UserRepository { private readonly Dictionary&lt;int, User&gt; _db; public UserRepository() { _db = new Dictionary&lt;int, User&gt;(); } public User Get(int id) { return _db[id]; } public void Save(User user) { _db[user.Id] = user; } } //Business Logic Layer class UserService { private readonly UserRepository _repo; private int _currentId = 0; public UserService() { _repo = new UserRepository(); } public void AddNew() { _currentId++; var user = new User { Id = _currentId, Name = _currentId.ToString() }; _repo.Save(user); } public string GetAll() { StringBuilder sb = new StringBuilder(); for (int i = 1; i &lt;= _currentId; i++) { sb.AppendLine($"Id: {i} Name: {_repo.Get(i).Name}"); } return sb.ToString(); } } //presentation Layer aka Application Layer class UserController { private readonly UserService _service; public UserController() { _service = new UserService(); } public string RunExample() { _service.AddNew(); _service.AddNew(); return _service.GetAll(); } } namespace ConsoleApp1 { class Program { static void Main(string[] args) { var controller = new UserController(); Console.WriteLine(controller.RunExample()); Console.ReadLine(); } } }</span></span></code> </pre> <br></div></div><br><h2>  PS </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, quero agradecer ao meu Nastya por corrigir erros gramaticais no artigo. </font><font style="vertical-align: inherit;">Ent√£o sim, Nastya, voc√™ n√£o √© em v√£o com um diploma vermelho e geralmente √© legal. </font><font style="vertical-align: inherit;">Eu te amo &lt;3.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433624/">https://habr.com/ru/post/pt433624/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433610/index.html">Notas de um fitoqu√≠mico. Caqui</a></li>
<li><a href="../pt433612/index.html">FCC: Sat√©lites SpaceX em √≥rbita - uma fonte de detritos perigosos para os habitantes da Terra</a></li>
<li><a href="../pt433614/index.html">Como assumir o controle de sua infraestrutura de rede. Cap√≠tulo Um Reten√ß√£o</a></li>
<li><a href="../pt433618/index.html">Som de "tubo quente" com suas pr√≥prias m√£os. E se voc√™ atravessar uma loja, um clube e uma oficina?</a></li>
<li><a href="../pt433620/index.html">Como o SystemUI funciona no Android</a></li>
<li><a href="../pt433628/index.html">Cultura de feedback: como n√£o cair em acusa√ß√µes</a></li>
<li><a href="../pt433630/index.html">Um passo mais perto da vacina contra o HIV: t√≠tulo de anticorpos neutralizantes s√©ricos em macacos</a></li>
<li><a href="../pt433632/index.html">Outra aplica√ß√£o m√≥vel "vazou" os dados de seus usu√°rios</a></li>
<li><a href="../pt433634/index.html">Monitoramento de Colm√©ia | Me Dadan e meio ucraniano | Redund√¢ncia de dados</a></li>
<li><a href="../pt433636/index.html">Lanterna-carregamento-kubotan: uma boa id√©ia ou um manequim</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>