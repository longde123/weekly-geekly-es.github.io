<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßû üíª üëã Asynchrones PHP und die Geschichte eines Fahrrads üë∏ üèáüèΩ üïú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nach der Ver√∂ffentlichung von PHP7 wurde es m√∂glich, langlebige Anwendungen zu relativ geringen Kosten zu schreiben. F√ºr Programmierer stehen Projekte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Asynchrones PHP und die Geschichte eines Fahrrads</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451916/"><p> Nach der Ver√∂ffentlichung von PHP7 wurde es m√∂glich, langlebige Anwendungen zu relativ geringen Kosten zu schreiben.  F√ºr Programmierer stehen Projekte wie <code>prooph</code> , <code>broadway</code> , <code>tactician</code> und <code>messenger</code> zur Verf√ºgung, deren Autoren die L√∂sung der h√§ufigsten Probleme √ºbernehmen.  Aber was ist, wenn Sie einen kleinen Schritt nach vorne machen und sich mit der Frage befassen? </p><br><p>  Versuchen wir, das Schicksal eines anderen Fahrrads herauszufinden, mit dem Sie die Publish / Subscribe-Anwendung implementieren k√∂nnen. </p><a name="habracut"></a><br><p>  Zun√§chst werden wir versuchen, die aktuellen Trends in der PHP-Welt sowie einen kurzen Blick auf den asynchronen Betrieb zu werfen. </p><br><h3 id="php-sozdan-chtoby-umirat">  PHP erstellt, um zu sterben </h3><br><p>  PHP wurde lange Zeit haupts√§chlich im Anforderungs- / Antwort-Workflow verwendet.  Aus Sicht der Entwickler ist dies sehr praktisch, da Sie sich keine Gedanken √ºber Speicherlecks machen und Verbindungen √ºberwachen m√ºssen. </p><br><p>  Alle Abfragen werden isoliert voneinander ausgef√ºhrt, verbrauchte Ressourcen werden freigegeben und Verbindungen zur Datenbank werden beispielsweise geschlossen, wenn der Vorgang abgeschlossen ist. </p><br><p>  Als Beispiel k√∂nnen Sie eine regul√§re CRUD-Anwendung verwenden, die auf der Grundlage des Symfony-Frameworks geschrieben wurde.  Um aus der Datenbank zu lesen und JSON zur√ºckzugeben, m√ºssen mehrere Schritte ausgef√ºhrt werden (um Platz und Zeit zu sparen, schlie√üen Sie die Schritte zum Generieren / Ausf√ºhren von Opcodes aus): </p><br><ul><li>  Analyse der Konfiguration; </li><li>  Container-Zusammenstellung; </li><li>  Routing anfordern </li><li>  Erf√ºllung; </li><li>  Ergebnis rendern. </li></ul><br><p>  Wie im Fall von PHP (unter Verwendung von Beschleunigern) verwendet das Framework aktiv das Caching (einige Aufgaben werden bei der n√§chsten Anforderung nicht abgeschlossen) sowie die verz√∂gerte Initialisierung.  Ab Version 7.4 ist ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Preload</a> verf√ºgbar, der die Initialisierung der Anwendung weiter optimiert. </p><br><p>  Es ist jedoch nicht m√∂glich, alle Gemeinkosten f√ºr die Initialisierung vollst√§ndig zu entfernen. </p><br><h3 id="pomozhem-php-vyzhit">  Helfen wir PHP zu √ºberleben </h3><br><p>  Die L√∂sung des Problems sieht ziemlich einfach aus: Wenn Sie die Anwendung jedes Mal zu teuer ausf√ºhren, m√ºssen Sie sie einmal initialisieren und dann einfach Anforderungen an sie √ºbergeben, um deren Ausf√ºhrung zu steuern. </p><br><p>  Es gibt Projekte im PHP-√ñkosystem wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">php-pm</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RoadRunner</a> .  Beide machen konzeptionell dasselbe: </p><br><ul><li>  Es wird ein √ºbergeordneter Prozess erstellt, der als Supervisor fungiert. </li><li>  Ein Pool von untergeordneten Prozessen wird erstellt. </li><li>  Wenn eine Anforderung empfangen wird, ruft der Master den Prozess aus dem Pool ab und leitet die Anforderung an ihn weiter.  Der Kunde ist zu diesem Zeitpunkt noch anh√§ngig. </li><li>  Sobald die Aufgabe abgeschlossen ist, gibt der Master das Ergebnis an den Client zur√ºck und der untergeordnete Prozess wird an den Pool zur√ºckgesendet. </li></ul><br><p>  Wenn ein untergeordneter Prozess stirbt, erstellt der Supervisor ihn erneut und f√ºgt ihn dem Pool hinzu.  Wir haben aus unserer Anwendung einen Daemon mit einem einzigen Zweck erstellt: Entfernen des Initialisierungsaufwands, wodurch die Geschwindigkeit der Verarbeitung von Anforderungen erheblich erh√∂ht wird.  Dies ist der schmerzloseste Weg, um die Produktivit√§t zu steigern, aber nicht der einzige. </p><br><blockquote>  Hinweis: <br>  Viele Beispiele aus der Serie ‚ÄûNehmen Sie ReactPHP und beschleunigen Sie Laravel N-mal‚Äú gehen im Netzwerk spazieren.  Es ist wichtig, den Unterschied zwischen D√§monisierung (und damit Zeitersparnis beim Bootstrapping der Anwendung) und Multitasking zu verstehen. <br>  Bei Verwendung von PHP-PM oder Roadrunner wird Ihr Code nicht blockierungsfrei.  Sie sparen nur Zeit bei der Initialisierung. <br>  Der Vergleich von PHP-PM, Roadrunner und ReactPHP / Amp / Swoole ist per Definition falsch. </blockquote><br><h5 id="php-i-io">  PHP und I / O. </h5><br><p>  Die Interaktion mit E / A in PHP wird standardm√§√üig im Blockierungsmodus ausgef√ºhrt.  Das hei√üt, wenn wir eine Anforderung zum Aktualisieren der Informationen in der Tabelle ausf√ºhren, wird der Ausf√ºhrungsfluss angehalten und auf eine Antwort aus der Datenbank gewartet.  Je mehr solche Aufrufe die Anforderung verarbeiten, desto l√§nger sind die Serverressourcen inaktiv.  Tats√§chlich m√ºssen wir bei der Verarbeitung der Anforderung mehrmals in die Datenbank gehen, etwas in das Protokoll schreiben und am Ende das Ergebnis an den Client zur√ºckgeben - ebenfalls eine Blockierungsoperation. </p><br><blockquote>  Stellen Sie sich vor, Sie sind ein Callcenter-Betreiber und m√ºssen in einer Stunde 50 Kunden anrufen. <br>  Sie w√§hlen die erste Nummer und dort ist sie besetzt (der Abonnent bespricht telefonisch die letzte Serie des Game of Thrones und was in der Serie enthalten ist). <br>  Und jetzt sitzt du und versuchst ihn vor dem Sieg zu erreichen.  Die Zeit vergeht, die Verschiebung neigt sich dem Ende zu.  Nachdem Sie 40 Minuten verloren haben, um den ersten Abonnenten zu erreichen, haben Sie die Gelegenheit verpasst, andere zu kontaktieren, und nat√ºrlich vom Chef erhalten. <br>  Sie k√∂nnen aber auch etwas anderes tun: Warten Sie nicht, bis der erste Teilnehmer frei ist. Sobald Sie einen Piepton h√∂ren, legen Sie auf und w√§hlen Sie die n√§chste Nummer.  Sie k√∂nnen etwas sp√§ter zum ersten zur√ºckkehren. <br>  Mit diesem Ansatz erh√∂hen sich die Chancen, die maximale Anzahl von Personen anzurufen, erheblich, und die Geschwindigkeit Ihrer Arbeit h√§ngt nicht von der langsamsten Aufgabe ab. </blockquote><p>  Code, der den Ausf√ºhrungsthread nicht blockiert (keine blockierenden E / A-Aufrufe sowie Funktionen wie <code>sleep()</code> ), wird als asynchron bezeichnet. </p><br><p>  Kehren wir zu unserer Symfony CRUD-Anwendung zur√ºck.  Es ist fast unm√∂glich, es im asynchronen Modus zum Laufen zu bringen, da h√§ufig Blockierungsfunktionen verwendet werden: Alle arbeiten mit Konfigurationen, Caches, Protokollierung, Rendern der Antwort und Interaktion mit der Datenbank. </p><br><p>  Aber das sind alles Konventionen. Versuchen wir, Symfony zu werfen und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Amp zu verwenden</a> , das eine Implementierung von Event Loop (einschlie√ülich einer Reihe von Bindemitteln), Promises und Coroutines als Kirsche auf einem Kuchen bietet, um unser Problem zu l√∂sen. </p><br><p>  Versprechen ist eine M√∂glichkeit, asynchronen Code zu organisieren.  Zum Beispiel m√ºssen wir auf eine http-Ressource zugreifen. </p><br><p>  Wir erstellen ein Anforderungsobjekt und √ºbergeben es an den Transport, den Promise mit dem aktuellen Status an uns zur√ºcksendet.  Es gibt drei m√∂gliche Zust√§nde: </p><br><ul><li>  Erfolg: Unsere Anfrage wurde erfolgreich abgeschlossen. </li><li>  Fehler: W√§hrend der Ausf√ºhrung der Anforderung ist ein Fehler aufgetreten (z. B. hat der Server eine Antwort von 500 zur√ºckgegeben). </li><li>  Warten: Die Anforderungsverarbeitung hat noch nicht begonnen. </li></ul><br><p>  Jedes Versprechen hat eine Methode (im Beispiel wird <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Versprechen von Amp</a> analysiert) - <code>onResolve()</code> , an die eine R√ºckruffunktion mit zwei Argumenten √ºbergeben wird </p><br><pre> <code class="php hljs">$promise-&gt;onResolve( <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(?/Throwable $throwable, $result)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> !== $throwable) { <span class="hljs-comment"><span class="hljs-comment">/**   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/**  */</span></span> } );</code> </pre> <br><p>  Nachdem wir das Versprechen erhalten haben, stellt sich die Frage: Wer wird seinen Status √ºberwachen und uns √ºber die Status√§nderung informieren? </p><br><p>  Hierzu wird die Ereignisschleife verwendet. </p><br><p>  Im Wesentlichen ist eine Ereignisschleife ein Scheduler, der die Ausf√ºhrung √ºberwacht.  Sobald die Aufgabe abgeschlossen ist (egal wie), wird der Callable aufgerufen, den wir an Promise √ºbergeben haben. </p><br><p>  In Bezug auf die Nuancen w√ºrde ich empfehlen, einen Artikel von Nikita Popov zu lesen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kooperatives Multitasking mit Coroutinen</a> .  Dies wird dazu beitragen, Klarheit dar√ºber zu schaffen, was passiert und wo sich die Generatoren befinden. </p><br><p>  Lassen Sie uns mit neuem Wissen versuchen, zu unserer JSON-Rendering-Aufgabe zur√ºckzukehren. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/amphp/">Ein Beispiel f√ºr die</a> Verarbeitung einer eingehenden http-Anfrage mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://github.com/amphp/">amphp / http-server</a> . <br>  Sobald wir die Anfrage erhalten, wird ein asynchroner Lesevorgang aus der Datenbank durchgef√ºhrt (wir erhalten Promise) und nach dessen Abschluss erh√§lt der Benutzer den begehrten JSON, der auf der Grundlage der empfangenen Daten gebildet wird. </p><br><blockquote>  Wenn wir einen Port von mehreren Prozessen abh√∂ren m√ºssen, k√∂nnen wir auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">amphp / cluster</a> schauen </blockquote><p>  Der Hauptunterschied besteht darin, dass ein einzelner Prozess mehrere Anforderungen gleichzeitig bedienen kann, da der Ausf√ºhrungsthread nicht blockiert ist.  Der Client erh√§lt seine Antwort, wenn das Lesen aus der Datenbank abgeschlossen ist. Wenn keine Antwort vorliegt, k√∂nnen Sie mit der Bearbeitung der n√§chsten Anforderung beginnen. </p><br><h3 id="divnyy-mir-asinhronnogo-php">  Die wunderbare Welt des asynchronen PHP </h3><br><blockquote>  Haftungsausschluss <br>  Asynchrones PHP wird im Kontext von Exoten betrachtet und nicht als etwas Gesundes / Normales.  Grunds√§tzlich warten sie auf Lachen im Stil von ‚ÄûNimm GO / Kotlin, ein Narr‚Äú usw.  Ich w√ºrde nicht sagen, dass diese Leute falsch liegen, aber ... </blockquote><p>  Es gibt eine Reihe von Projekten, die beim Schreiben von nicht blockierendem PHP-Code helfen.  Im Rahmen des Artikels werde ich nicht alle Vor- und Nachteile vollst√§ndig analysieren, sondern versuchen, sie nur oberfl√§chlich zu untersuchen. </p><br><h5 id="swoolehttpswwwswoolecouk">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Swoole</a> </h5><br><p>  Ein asynchrones Framework, das im Gegensatz zu den anderen in C geschrieben und als Erweiterung f√ºr PHP bereitgestellt wird.  Es verf√ºgt derzeit m√∂glicherweise √ºber die besten Leistungsindikatoren. </p><br><p>  Es gibt eine Implementierung von Kan√§len, Corutin und anderen leckeren Dingen, aber er hat 1 gro√ües Minus - die Dokumentation.  Obwohl es teilweise auf Englisch ist, ist es meiner Meinung nach nicht sehr detailliert und die API selbst ist nicht sehr offensichtlich. </p><br><p>  Die Community ist nicht nur einfach und eindeutig.  Pers√∂nlich kenne ich keine einzige lebende Person, die Swoole im Kampf einsetzt.  Vielleicht werde ich meine √Ñngste √ºberwinden und zu ihm auswandern, aber das wird in naher Zukunft nicht passieren. </p><br><p>  Zu den Minuspunkten k√∂nnen Sie auch hinzuf√ºgen, dass es auch schwierig ist, mit √Ñnderungen zum Projekt beizutragen (mithilfe der Pull-Anforderung), wenn Sie C nicht auf der richtigen Ebene kennen. </p><br><h5 id="workermanhttpsgithubcomwalkorworkerman">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arbeiter</a> </h5><br><p>  Wenn es gegen√ºber seinem Konkurrenten an Geschwindigkeit verliert (was Swoole betrifft), ist es nicht sehr auff√§llig und der Unterschied in einer Reihe von Szenarien kann vernachl√§ssigt werden. </p><br><p>  Es ist in ReactPHP integriert, was wiederum die Anzahl der Implementierungen von Infrastrukturproblemen erh√∂ht.  Um Platz zu sparen, werde ich die Nachteile zusammen mit ReactPHP beschreiben. </p><br><h5 id="reactphphttpsreactphporg">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ReactPHP</a> </h5><br><p>  Zu den Pluspunkten geh√∂ren eine ziemlich gro√üe Community und eine Vielzahl von Beispielen.  Nachteile treten im Verlauf des Gebrauchs auf - dies ist das Konzept von Promise. <br>  Wenn Sie mehrere asynchrone Vorg√§nge ausf√ºhren m√ºssen, verwandelt sich der Code in einen endlosen Papierkorb von Aufrufen (hier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Beispiel f√ºr eine einfache Verbindung zu RabbiqMQ,</a> ohne Exchange / Queue und deren <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ordner</a> zu erstellen). </p><br><p>  Mit etwas Verfeinerung mit einer Datei (als die Norm angesehen) k√∂nnen Sie eine Implementierung von Corutin erhalten, die hilft, Promise Hell loszuwerden. </p><br><p>  Ohne das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Projekt recoilphp / recoil ist die</a> Verwendung von ReactPHP meiner Meinung nach in einer vern√ºnftigen Anwendung nicht m√∂glich. </p><br><p>  Neben allem anderen hat man auch das Gef√ºhl, dass sich seine Entwicklung sehr verlangsamt hat.  Nicht genug, zum Beispiel normale Arbeit mit PostgreSQL. </p><br><h5 id="amphttpsamphporgamp">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Amp</a> </h5><br><p>  Meiner Meinung nach die besten Optionen, die es derzeit gibt. <br>  Zus√§tzlich zu dem √ºblichen Versprechen gibt es eine Implementierung von Coroutine, die den Entwicklungsprozess erheblich vereinfacht und den Code den PHP-Programmierern am vertrautesten erscheinen l√§sst. </p><br><p>  Entwickler erg√§nzen und verbessern das Projekt st√§ndig, mit Feedback gibt es auch keine Probleme. </p><br><p>  Leider ist die Community mit all den Vorteilen des Frameworks relativ klein, aber gleichzeitig gibt es Implementierungen, die beispielsweise mit PostgreSQL arbeiten, sowie alle grundlegenden Dinge (Dateisystem, http-Client, DNS usw.). </p><br><p>  Ich verstehe das Schicksal des ext-asynchronen Projekts immer noch nicht ganz, aber die Jungs halten mit.  Was in der 3. Version daraus wird, wird die Zeit zeigen. </p><br><h3 id="pristupaem-k-realizacii">  Erste Schritte </h3><br><p>  Also haben wir den theoretischen Teil ein wenig gekl√§rt, es ist Zeit, weiter zu √ºben und die Unebenheiten zu f√ºllen. </p><br><p>  Zun√§chst formalisieren wir die Anforderungen ein wenig: </p><br><ul><li>  Asynchrones Messaging (das Konzept der <code>message</code> selbst kann in zwei Typen unterteilt werden) <br><ul><li>  <code>command</code> : Gibt an, dass die Aufgabe ausgef√ºhrt werden muss.  Gibt kein Ergebnis zur√ºck (zumindest bei asynchroner Kommunikation); </li><li>  <code>event</code> : Meldet jede Status√§nderung (z. B. als Ergebnis eines Befehls). </li></ul></li><li>  Nicht blockierendes Format f√ºr die Arbeit mit E / A; </li><li>  Die F√§higkeit, die Anzahl der Prozessoren leicht zu erh√∂hen; </li><li>  M√∂glichkeit, Nachrichtenhandler in einer beliebigen Sprache zu schreiben. </li></ul><br><blockquote>  Jede Nachricht ist von Natur aus eine einfache Struktur und wird nur von der Semantik geteilt.  Die Benennung von Nachrichten ist im Hinblick auf das Verst√§ndnis von Typ und Zweck √§u√üerst wichtig (obwohl dieser Punkt im Beispiel ignoriert wird). </blockquote><p>  F√ºr eine Liste von Anforderungen ist eine einfache Implementierung des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Publish / Subscribe-</a> Musters am besten geeignet. <br>  Um eine verteilte Ausf√ºhrung sicherzustellen, verwenden wir RabbitMQ als Nachrichtenbroker. </p><br><p>  Der Prototyp wurde mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ReactPHP</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bunny</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DoctrineDBAL geschrieben</a> . <br>  Ein aufmerksamer Leser hat vielleicht bemerkt, dass Dbal intern pdo / mysqli-Blockierungsanrufe verwendet, aber zum gegenw√§rtigen Zeitpunkt war dies nicht besonders wichtig, da man verstehen musste, was am Ende passieren sollte. </p><br><p>  Eines der Probleme war das Fehlen von Bibliotheken f√ºr die Arbeit mit PostgreSQL.  Es gibt einige Entw√ºrfe, aber dies reicht nicht f√ºr vollwertige Arbeiten aus (mehr dazu weiter unten). </p><br><p>  Nach einer kurzen Untersuchung wurde ReactPHP zugunsten von Amp entfernt, da es relativ einfach ist und sich sehr aktiv entwickelt. </p><br><h5 id="rabbitmq-transport">  RabbitMQ Transport </h5><br><p>  Bei allen Vorteilen von Amp gab es jedoch ein Problem: Amp hat keinen Treiber f√ºr RabbitMQ ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bunny</a> unterst√ºtzt nur ReactPHP). </p><br><p>  Theoretisch k√∂nnen Sie mit Amp Promise von einem Konkurrenten verwenden.  Es scheint, dass alles einfach sein sollte, aber ReactPHP verwendet Event Loop f√ºr die Arbeit mit Sockets in der Bibliothek. <br>  Zu einem bestimmten Zeitpunkt konnten offensichtlich zwei verschiedene Ereignisschleifen nicht gestartet werden, sodass ich die Funktion <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">adapt ()</a> nicht verwenden konnte. </p><br><p>  Leider lie√ü die Qualit√§t des Codes in Bunny zu w√ºnschen √ºbrig und es war nicht m√∂glich, eine Implementierung angemessen durch eine andere zu ersetzen.  Um die Arbeit nicht zu stoppen, wurde beschlossen, die Bibliothek ein wenig umzuschreiben, damit sie mit Amp funktioniert und den Ausf√ºhrungsfluss nicht blockiert. </p><br><p>  Diese Anpassung sah sehr be√§ngstigend aus, die ganze Zeit sch√§mte ich mich sehr daf√ºr, aber am wichtigsten war, dass sie funktionierte.  Nun, da es nichts Permanenteres als Tempor√§res gibt, blieb der Adapter in Erwartung einer Person, die nicht zu faul ist, um an der Treiberimplementierung beteiligt zu sein. </p><br><p>  Und so ein Mann wurde gefunden.  Das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PHPinnacle-</a> Projekt bietet unter anderem die Implementierung eines auf Amp zugeschnittenen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adapters</a> . </p><br><blockquote>  Der Name des Autors ist Anton Shabovta, der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√ºber asynchrones PHP</a> im Rahmen von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PHP Russland</a> und √ºber die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Entwicklung von Treibern</a> f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PHP-Tage sprechen wird</a> . </blockquote><br><h5 id="postgresql">  PostgreSQL </h5><br><p>  Das zweite Merkmal der Arbeit ist die Interaktion mit der Datenbank.  Unter den Bedingungen von "traditionellem" PHP ist alles einfach: Wir haben eine Verbindung und alle Anforderungen werden nacheinander ausgef√ºhrt. </p><br><p>  Bei asynchroner Ausf√ºhrung m√ºssen mehrere Anforderungen gleichzeitig ausgef√ºhrt werden k√∂nnen (z. B. 3 Transaktionen).  Dazu ist eine Implementierung des Verbindungspools erforderlich. </p><br><p>  Der Arbeitsmechanismus ist recht einfach: </p><br><ul><li>  Wir √∂ffnen <em>N</em> Verbindungen beim Start (oder verz√∂gerte Initialisierung, nicht den Punkt); </li><li>  Bei Bedarf nehmen wir die Verbindung aus dem Pool und stellen sicher, dass niemand anderes sie verwenden kann. </li><li>  Wir f√ºhren die Anfrage aus und zerst√∂ren entweder die Verbindung oder geben sie an den Pool zur√ºck (bevorzugt). </li></ul><br><p>  Erstens k√∂nnen wir mehrere Transaktionen gleichzeitig starten, und zweitens wird die Arbeit beschleunigt, da bereits offene Verbindungen vorhanden sind.  Amp hat eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Amphp / Postgres-</a> Komponente.  Er k√ºmmert sich um die Verbindungen: √ºberwacht deren Anzahl, Lebensdauer und all dies, ohne den Ausf√ºhrungsfluss zu blockieren. </p><br><p>  Wenn Sie beispielsweise ReactPHP verwenden, m√ºssen Sie dies √ºbrigens selbst implementieren, wenn Sie mit einer Datenbank arbeiten m√∂chten. </p><br><h5 id="mutex">  Mutex </h5><br><p>  F√ºr einen effektiven und vor allem ordnungsgem√§√üen Betrieb der Anwendung ist es erforderlich, etwas √Ñhnliches wie Mutexe zu implementieren.  Wir k√∂nnen 3 Szenarien f√ºr ihre Verwendung unterscheiden: </p><br><ul><li>  Im Rahmen eines Prozesses ist ein einfacher Speichermechanismus ohne √úberschuss geeignet; </li><li>  Wenn wir in mehreren Prozessen Sperren bereitstellen m√∂chten, k√∂nnen wir das Dateisystem verwenden (nat√ºrlich im nicht blockierenden Modus). </li><li>  Wenn Sie sich im Kontext mehrerer Server befinden, m√ºssen Sie bereits an etwas wie Zookeeper denken. </li></ul><br><p>  Mutexe werden ben√∂tigt, um Probleme mit den Rennbedingungen zu l√∂sen.  Schlie√ülich wissen wir nicht (und wir k√∂nnen nicht wissen), in welcher Reihenfolge unsere Aufgaben ausgef√ºhrt werden, aber wir m√ºssen trotzdem die Integrit√§t der Daten sicherstellen. </p><br><h5 id="logirovaniekonteksty">  Protokollierung / Kontexte </h5><br><p>  F√ºr die Protokollierung ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Monolog</a> bereits zum Standard geworden, jedoch mit einigen Einschr√§nkungen: Wir k√∂nnen die integrierten Handler nicht verwenden, da sie zu Sperren f√ºhren. <br>  Um in stdOut zu schreiben, k√∂nnen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">amphp / log nehmen</a> oder eine einfache Nachricht schreiben, die an Graylog gesendet wird. </p><br><p>  Da wir zu einem bestimmten Zeitpunkt viele Aufgaben verarbeiten k√∂nnen und Sie beim Aufzeichnen von Protokollen verstehen m√ºssen, in welchem ‚Äã‚ÄãKontext die Daten geschrieben werden.  W√§hrend der Experimente wurde beschlossen, <code>trace_id</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Distributed Tracing</a> ) zu <code>trace_id</code> .  Das Fazit ist, dass die gesamte Anrufkette von einer Pass-Through-ID begleitet sein muss, die verfolgt werden kann.  Zus√§tzlich wird zum Zeitpunkt des Empfangs der Nachricht die <code>package_id</code> generiert, die genau die empfangene Nachricht angibt. </p><br><p>  Auf diese Weise k√∂nnen wir mithilfe beider Bezeichner leicht verfolgen, worauf sich ein bestimmter Datensatz bezieht.  Die Sache ist, dass in herk√∂mmlichem PHP alle Datens√§tze, die wir im Protokoll erhalten, haupts√§chlich in der Reihenfolge sind, in der sie geschrieben wurden.  Bei asynchroner Ausf√ºhrung gibt es kein Muster in der Reihenfolge der Eintr√§ge. </p><br><h5 id="terminating">  Beenden </h5><br><p>  Eine weitere Nuance der asynchronen Entwicklung ist die Steuerung des Herunterfahrens unseres Daemons.  Wenn Sie den Prozess nur beenden, werden nicht alle laufenden Aufgaben abgeschlossen und die Daten gehen verloren. Bei der √ºblichen Vorgehensweise gibt es auch ein solches Problem, das jedoch nicht so gro√ü ist, da jeweils nur eine Aufgabe ausgef√ºhrt wird. </p><br><p>  Um die Ausf√ºhrung korrekt abzuschlie√üen, ben√∂tigen wir: </p><br><ul><li>  Abmelden von der Warteschlange.  Mit anderen Worten, machen Sie es unm√∂glich, neue Nachrichten zu empfangen. </li><li>  Erledige alle verbleibenden Aufgaben (warte auf das L√∂sen von Versprechungen); </li><li>  Und erst danach beenden Sie das Skript. </li></ul><br><h5 id="utechki-otladka">  Lecks, Debugging </h5><br><p>  Entgegen der landl√§ufigen Meinung ist es in modernem PHP nicht so einfach, Situationen zu begegnen, in denen ein Speicherverlust auftritt.  Es ist notwendig, etwas absolut Falsches zu tun. </p><br><p>  Allerdings einmal damit konfrontiert, aber wegen der banalen Nachl√§ssigkeit.  W√§hrend der Implementierung von Heartbeat wurde alle 40 Sekunden ein neuer Timer hinzugef√ºgt, um die Verbindung abzufragen.  Es ist nicht schwer zu erraten, dass nach einiger Zeit die Nutzung des Ged√§chtnisses schnell zunahm. </p><br><p>  Au√üerdem schrieb er unter anderem einen einfachen Beobachter, der optional alle 10 Minuten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">startet</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gc_collect_cycles ()</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gc_mem_caches () aufruft</a> . <br>  Der erzwungene Start des M√ºllsammlers ist jedoch nicht notwendig und grundlegend. </p><br><p>  Um die Speichernutzung st√§ndig zu sehen, wurde der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Protokollierung</a> ein Standard- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MemoryUsageProcessor</a> hinzugef√ºgt. </p><br><p>  Wenn Sie auf die Idee kommen, dass die Ereignisschleife mit etwas blockiert, kann dies auch leicht √ºberpr√ºft werden: Verbinden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sie</a> einfach <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LoopBlockWatcher</a> . </p><br><p>  Sie m√ºssen jedoch sicherstellen, dass dieser Beobachter nicht in der Produktionsumgebung startet.       . </p><br><h3 id="rezultaty">  Ergebnisse </h3><br><p>     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">php-service-bus</a> ,    Message Based . </p><br><p>    ,         : </p><br><pre> <code class="plaintext hljs">composer create-project php-service-bus/skeleton pub-sub-example cd pub-sub-example docker-compose up --build -d</code> </pre> <br><p>   ,      ,   . </p><br><p>   <code>/bin/consumer</code>   ,    . <br>   <code>/src</code>  3 : <code>Ping</code>   ; <code>Pong</code> :    ; <code>PingService</code> : ,   . <br>     <code>PingService</code> ,      2 : </p><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@CommandHandler</span></span></span><span class="hljs-comment">() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ping $command, KernelContext $context)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $context-&gt;delivery(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Pong()); } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@EventListener</span></span></span><span class="hljs-comment">() */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">whenPong</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Pong $event, KernelContext $context)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $context-&gt;logContextMessage(<span class="hljs-string"><span class="hljs-string">'Pong message received'</span></span>); }</code> </pre> <br><ul><li> <code>handle</code>    (        1 ).      <code>@CommandHandler</code> ; <br><ul><li>   Promise ,        RabbitMQ (   <code>delivery()</code> ).       ,   RabbitMQ    . </li></ul></li><li> <code>whenPong</code> ‚Äî   <code>Pong</code> .            .     <code>@EventListener</code> ; <br><blockquote>  ,     ‚Äî   . , , ,     .     php-service-bus  , ,            . <br></blockquote></li></ul><br><p>     2 : ,   (  )  .          ,     ,     (, ). </p><br><p>     <code>Ping</code> ,      <code>Pong</code> .     . </p><br><p>    ,       RabbitMQ: </p><br><pre> <code class="plaintext hljs">tools/ping</code> </pre> <br><p>    ,  php-service-bus     ,  Message based . </p><br><p> Ping\Pong,    ‚Äî ,  ,  <code>Hello, world</code>       . </p><br><p>     ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> . </p><br><p>     - ,    , , Saga pattern (Process manager)        . </p><br><h3 id="nu-i-kak-zhe-ne-pomeryatsya">       </h3><br><p>   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">  symfony/messenger</a> . </p><br><p>    ,      ,      . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de451916/">https://habr.com/ru/post/de451916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de451902/index.html">Microsoft Azure Developer Camp Russland</a></li>
<li><a href="../de451904/index.html">Manchmal ist mehr weniger. Wenn eine Abnahme der Last zu einer Zunahme der Verz√∂gerung f√ºhrt</a></li>
<li><a href="../de451906/index.html">Exchange-Sicherheitsanf√§lligkeit: Ermitteln der Erh√∂hung der Berechtigung f√ºr einen Dom√§nenadministrator</a></li>
<li><a href="../de451908/index.html">Die Geschichte der Computer: eine Nacht im Yandex Museum</a></li>
<li><a href="../de451912/index.html">Das tiefe neuronale Netzwerk von MuseNet schreibt Musik</a></li>
<li><a href="../de451918/index.html">Auf die Frage von TI</a></li>
<li><a href="../de451920/index.html">Optimieren Sie den E-Mail-Speicher in der Zimbra Collaboration Suite</a></li>
<li><a href="../de451922/index.html">Festkomma-Arithmetik in C ++</a></li>
<li><a href="../de451926/index.html">√úber Live-Code nach 130 Streams</a></li>
<li><a href="../de451928/index.html">So richten Sie Webanalysen auf AMP-Seiten ein</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>