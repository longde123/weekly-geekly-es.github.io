<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé£ üë©üèΩ‚Äçüé§ üíª Qu√© sucede cuando se conecta dentro y fuera de un t√∫nel VPN üëâüèª üë¥üèª ü§∂üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De las cartas al soporte t√©cnico de Tucha, nacen estos art√≠culos. Entonces, recientemente un cliente nos contact√≥ con una solicitud para aclarar qu√© s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Qu√© sucede cuando se conecta dentro y fuera de un t√∫nel VPN</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477854/"> De las cartas al soporte t√©cnico de Tucha, nacen estos art√≠culos.  Entonces, recientemente un cliente nos contact√≥ con una solicitud para aclarar qu√© sucede cuando se conecta dentro de un t√∫nel VPN entre la oficina del usuario y el entorno en la nube, as√≠ como cuando se conecta fuera del t√∫nel VPN.  Por lo tanto, el texto completo a continuaci√≥n es una carta real que enviamos a uno de los clientes en respuesta a su pregunta.  Por supuesto, cambiamos las direcciones IP para no anonimizar al cliente.  Pero s√≠, el soporte t√©cnico de Tucha es realmente famoso por sus respuestas integrales y cartas informativas.  :-) <br><br>  Por supuesto, entendemos que para muchos este art√≠culo no ser√° una revelaci√≥n.  Pero, dado que los art√≠culos para administradores principiantes aparecen de vez en cuando en Habr, y tambi√©n porque este art√≠culo apareci√≥ de una carta real a un cliente real, a√∫n compartiremos esta informaci√≥n aqu√≠.  Hay una alta probabilidad de que sea √∫til para alguien. <br>  Por lo tanto, explicamos en detalle lo que sucede entre el servidor en la nube y la oficina si est√°n conectados por una red de sitio a sitio.  Tenga en cuenta que, en este caso, parte de los servicios est√° disponible solo desde la oficina, y parte, desde cualquier lugar desde Internet. <br><br>  Explicaremos de inmediato que nuestro cliente deseaba poder llegar al servidor <b>192.168.A.1</b> desde cualquier lugar a trav√©s de RDP, conectarse a <b>AAA2: 13389</b> y a otros servicios, solo desde la oficina <b>(192.168.B.0 / 24)</b> conectada a trav√©s de VPN  Adem√°s, el cliente se configur√≥ inicialmente para poder acceder a la m√°quina <b>192.168.B.2</b> en la oficina a trav√©s de RDP desde cualquier lugar, conect√°ndose a <b>BBB1: 11111</b> .  Ayudamos a organizar las conexiones IPSec entre la nube y la oficina, y el especialista de TI del cliente comenz√≥ a hacer preguntas sobre lo que suceder√≠a en este o aquel caso.  Para responder a todas estas preguntas, de hecho, le escribimos todo lo que puedes leer a continuaci√≥n. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/yi/h8/nm/yih8nmxyw3h1kvhvrv8grwlqt14.jpeg"><br><p>  Ahora considere estos procesos con m√°s detalle. </p><br><h3>  Primera posici√≥n </h3><br>  Cuando se env√≠a algo desde <b>192.168.B.0 / 24</b> a <b>192.168.A.0 / 24</b> o desde <b>192.168.A.0 / 24</b> a <b>192.168.B.0 / 24</b> , ingresa a la VPN.  Es decir, este paquete se encripta y transmite adicionalmente entre <b>BBB1</b> y <b>AAA1</b> , pero <b>192.168.A.1</b> ve el paquete exactamente desde <b>192.168.B.1</b> .  Se pueden comunicar entre s√≠ a trav√©s de cualquier protocolo.  Las respuestas de retorno se transmiten de la misma manera a trav√©s de VPN, lo que significa que el paquete de <b>192.168.A.1</b> para <b>192.168.B.1</b> se enviar√° como un datagrama ESP de <b>AAA1</b> a <b>BBB1</b> , que el enrutador implementar√° en el otro lado, saque ese paquete y env√≠elo a <b>192.168.B.1</b> como un paquete de <b>192.168.A.1</b> . <br><br>  Ejemplo concreto: <br><br>  1) <b>192.168.B.1</b> accede a <b>192.168.A.1</b> , desea establecer una conexi√≥n TCP con <b>192.168.A.1: 3389</b> ; <br><br>  2) <b>192.168.B.1</b> env√≠a una solicitud para establecer una conexi√≥n desde <b>192.168.B.1: 55555</b> (selecciona el puerto para la retroalimentaci√≥n, de aqu√≠ en adelante utilizaremos el n√∫mero 55555 como ejemplo del n√∫mero de puerto que el sistema selecciona al generar TCP- conexiones) a <b>192.168.A.1: 3389</b> ; <br><br>  3) el sistema operativo que se ejecuta en la computadora con la direcci√≥n <b>192.168.B.1</b> decide transferir este paquete a la direcci√≥n de puerta de enlace del enrutador ( <b>192.168.B.254</b> en nuestro caso), porque hay otras rutas m√°s espec√≠ficas para <b>192.168.A.1</b> , por lo tanto, no pasa el paquete a lo largo de la ruta predeterminada (0.0.0.0/0); <br><br>  4) para esto, ella trata de encontrar la direcci√≥n MAC para la direcci√≥n IP <b>192.168.B.254</b> en la tabla de cach√© del protocolo ARP.  Si no se encuentra, env√≠a desde la direcci√≥n <b>192.168.B.1 una</b> solicitud de difusi√≥n que tiene a la red <b>192.168.B.0 / 24</b> .  Cuando <b>192.168.B.254 le</b> devuelve su direcci√≥n MAC, el sistema le env√≠a un paquete Ethernet y almacena esta informaci√≥n en su tabla de cach√©; <br><br>  5) el enrutador recibe este paquete y decide d√≥nde enviarlo: tiene la pol√≠tica de que debe transmitir todos los paquetes entre <b>192.168.B.0 / 24</b> y <b>192.168.A.0 / 24 a</b> trav√©s de una conexi√≥n VPN entre <b>BBB1</b> y <b>AAA1</b> ; <br><br>  6) el enrutador genera un datagrama ESP de <b>BBB1</b> a <b>AAA1</b> ; <br><br>  7) el enrutador decide a qui√©n enviar este paquete, lo env√≠a a, digamos, <b>BBB254</b> (puerta de enlace del proveedor de Internet), porque no tiene rutas m√°s espec√≠ficas a <b>AAA1</b> que 0.0.0.0/0; <br><br>  8) de la misma manera que ya se mencion√≥, encuentra la direcci√≥n MAC para <b>BBB254</b> y env√≠a el paquete a la puerta de enlace del proveedor de Internet; <br><br>  9) los proveedores de Internet transmiten a trav√©s de sus redes el datagrama ESP de <b>BBB1</b> a <b>AAA1</b> ; <br><br>  10) el enrutador virtual en <b>AAA1</b> recibe este datagrama, lo descifra y recibe un paquete de <b>192.168.B.1: 55555</b> para <b>192.168.A.1: 3389</b> ; <br><br>  11) el enrutador virtual verifica a qui√©n debe enviarse, encuentra la red <b>192.168.A.0 / 24</b> en la tabla de enrutamiento y la env√≠a directamente a <b>192.168.A.1</b> , ya que tiene una interfaz <b>192.168.A.254 / 24</b> ; <br><br>  12) para esto, el enrutador virtual encuentra la direcci√≥n MAC para <b>192.168.A.1</b> y le pasa este paquete a trav√©s de la red Ethernet virtual; <br><br>  13) <b>192.168.A.1</b> recibe este paquete en el puerto 3389, acuerda establecer una conexi√≥n y forma un paquete en respuesta desde <b>192.168.A.1: 3389</b> a <b>192.168.B.1: 55555</b> ; <br><br>  14) su sistema env√≠a este paquete a la direcci√≥n de puerta de enlace del enrutador virtual ( <b>192.168.A.254</b> en nuestro caso), porque no tiene otras rutas m√°s espec√≠ficas para <b>192.168.B.1</b> , por lo tanto, debe transmitir el paquete a lo largo de la ruta predeterminado (0.0.0.0/0); <br><br>  15) de la misma manera que en casos anteriores, el sistema que se ejecuta en el servidor con la direcci√≥n <b>192.168.A.1</b> encuentra la direcci√≥n MAC <b>192.168.A.254</b> , ya que est√° en la misma red con su interfaz <b>192.168.A.1 / 24</b> ; <br><br>  16) el enrutador virtual recibe este paquete y decide d√≥nde enviarlo: tiene una pol√≠tica de que debe transmitir todos los paquetes entre <b>192.168.A.0 / 24</b> y <b>192.168.B.0 / 24 a</b> trav√©s de una conexi√≥n VPN entre <b>AAA1</b> y <b>BBB1</b> ; <br><br>  17) el enrutador virtual genera un datagrama ESP de <b>AAA1</b> a <b>BBB1</b> ; <br><br>  18) el enrutador virtual decide a qui√©n se debe enviar este paquete, lo env√≠a a <b>AAA254</b> (la puerta de enlace del proveedor de Internet, en este caso, tambi√©n somos nosotros), porque no tiene rutas m√°s espec√≠ficas para <b>BBB1</b> que 0.0.0.0/0; <br><br>  19) los proveedores de Internet transmiten a trav√©s de sus redes un datagrama ESP de <b>AAA1</b> a <b>BBB1</b> ; <br><br>  20) el enrutador en <b>BBB1</b> recibe este datagrama, lo descifra y recibe un paquete de <b>192.168.A.1: 3389</b> para <b>192.168.B.1: 55555</b> ; <br><br>  21) entiende que debe transmitirse a <b>192.168.B.1</b> , ya que est√° en la misma red que √©l, por lo tanto, tiene una entrada correspondiente en la tabla de enrutamiento que lo obliga a enviar paquetes para todo <b>192.168.B.0 / 24</b> directamente; <br><br>  22) el enrutador encuentra la direcci√≥n MAC para <b>192.168.B.1</b> y le env√≠a este paquete; <br><br>  23) el sistema operativo en la computadora con la direcci√≥n <b>192.168.B.1</b> recibe un paquete de <b>192.168.A.1: 3389</b> para <b>192.168.B.1: 55555</b> e inicia los siguientes pasos para establecer una conexi√≥n TCP. <br><br>  Este ejemplo es bastante conciso y simplista (y aqu√≠ puede recordar un mont√≥n de detalles) describe lo que sucede en los niveles 2-4.  Los niveles 1, 5-7 no se consideran. <br><br><h3>  Segunda posici√≥n </h3><br>  Si algo se env√≠a espec√≠ficamente a <b>AAA2</b> desde <b>192.168.B.0 / 24</b> , no va a la VPN, sino directamente.  Es decir, si un usuario de la direcci√≥n <b>192.168.B.1</b> accede a <b>AAA2: 13389</b> , este paquete se deshilacha de la direcci√≥n <b>BBB1</b> , pasa a <b>AAA2</b> , y all√≠ el enrutador lo recibe y lo env√≠a a <b>192.168.A.1</b> .  <b>192.168.A.1</b> no sabe nada acerca de <b>192.168.B.1</b> , ve un paquete de <b>BBB1</b> , porque lo entendi√≥.  Por lo tanto, la respuesta a esta solicitud va a lo largo de la ruta general, exactamente lo mismo va de la direcci√≥n <b>AAA2</b> y va a <b>BBB1</b> , y ese enrutador da esta respuesta a <b>192.168.B.1</b> , ve la respuesta de <b>AAA2</b> , a la que se dirigi√≥. <br><br>  Ejemplo concreto: <br><br>  1) <b>192.168.B.1 se</b> dirige a <b>AAA2</b> , desea establecer una conexi√≥n TCP con <b>AAA2: 13389</b> ; <br><br>  2) <b>192.168.B.1</b> env√≠a una solicitud para establecer una conexi√≥n desde <b>192.168.B.1: 55555</b> (este n√∫mero, como en el ejemplo anterior, puede ser diferente) a <b>AAA2: 13389</b> ; <br><br>  3) el sistema operativo que se ejecuta en la computadora con la direcci√≥n <b>192.168.B.1</b> decide transferir este paquete a la direcci√≥n de la puerta de enlace del enrutador ( <b>192.168.B.254</b> en nuestro caso), porque no tiene otras rutas m√°s espec√≠ficas para <b>AAA2</b> , lo que significa que env√≠a el paquete a lo largo de la ruta predeterminada (0.0.0.0/0); <br><br>  4) para esto, ella, como mencionamos en el ejemplo anterior, trata de encontrar la direcci√≥n MAC para la direcci√≥n IP <b>192.168.B.254</b> en la tabla de cach√© del protocolo ARP.  Si no se encuentra, env√≠a desde la direcci√≥n <b>192.168.B.1 una</b> solicitud de difusi√≥n que tiene a la red <b>192.168.B.0 / 24</b> .  Cuando <b>192.168.B.254 le</b> devuelve su direcci√≥n MAC, el sistema le env√≠a un paquete Ethernet y almacena esta informaci√≥n en su tabla de cach√©; <br><br>  5) el enrutador recibe este paquete y decide d√≥nde enviarlo: tiene una pol√≠tica que debe reenviar (reemplazando la direcci√≥n de retorno) todos los paquetes desde <b>192.168.B.0 / 24</b> a otros nodos de Internet; <br><br>  6) dado que esta pol√≠tica implica que la direcci√≥n de retorno debe coincidir con la direcci√≥n m√°s baja en la interfaz a trav√©s de la cual se transmitir√° este paquete, el enrutador primero decide a qui√©n se debe transmitir exactamente este paquete, y √©l, como en el ejemplo anterior, debe enviarlo a <b>BBB254</b> (Gateway de proveedor de servicios de Internet), porque no tiene rutas m√°s espec√≠ficas para <b>AAA2</b> que 0.0.0.0/0; <br><br>  7) por lo tanto, el enrutador reemplaza la direcci√≥n de retorno del paquete, de aqu√≠ en adelante el paquete de <b>BBB1: 44444</b> (el n√∫mero de puerto, por supuesto, puede ser diferente) a <b>AAA2: 13389</b> ; <br><br>  8) el enrutador recuerda lo que ha hecho, lo que significa que cuando <b>se recibe</b> una <b>respuesta</b> de <b>AAA2: 13389</b> a <b>BBB1: 44444</b> , sabr√° que debe cambiar la direcci√≥n y el puerto del destinatario a <b>192.168.B.1: 55555</b> . <br><br>  9) ahora el enrutador debe transferirlo a la red del proveedor de Internet a trav√©s de <b>BBB254</b> , por lo tanto, de la misma manera que ya mencionamos, encuentra la direcci√≥n MAC para <b>BBB254</b> y env√≠a el paquete a la puerta de enlace del proveedor de Internet; <br><br>  10) los proveedores de Internet transfieren un paquete de <b>BBB1</b> a <b>AAA2</b> en sus redes; <br><br>  11) el enrutador virtual en <b>AAA2</b> recibe este paquete en el puerto 13389; <br><br>  12) hay una regla en el enrutador virtual que estipula que los paquetes que provienen de cualquier remitente a este puerto deben enviarse a <b>192.168.A.1: 3389</b> ; <br><br>  13) el enrutador virtual encuentra la red <b>192.168.A.0 / 24</b> en la tabla de enrutamiento y la env√≠a directamente a <b>192.168.A.</b>  1, porque tiene una interfaz <b>192.168.A.254 / 24</b> ; <br><br>  14) para esto, el enrutador virtual encuentra la direcci√≥n MAC para <b>192.168.A.1</b> y le pasa este paquete a trav√©s de la red Ethernet virtual; <br><br>  15) <b>192.168.A.1</b> recibe este paquete en el puerto 3389, acuerda establecer una conexi√≥n y forma un paquete en respuesta desde <b>192.168.A.1: 3389</b> en <b>BBB1: 44444</b> ; <br><br>  16) su sistema env√≠a este paquete a la direcci√≥n de la puerta de enlace del enrutador virtual ( <b>192.168.A.254</b> en nuestro caso), porque no tiene otras rutas m√°s espec√≠ficas para <b>BBB1</b> , por lo tanto, debe transmitir el paquete a lo largo de la ruta predeterminada (0.0. 0,0 / 0); <br><br>  17) de la misma manera que en casos anteriores, el sistema que se ejecuta en el servidor con la direcci√≥n <b>192.168.A.1</b> encuentra la direcci√≥n MAC <b>192.168.A.254</b> , ya que est√° en la misma red con su interfaz <b>192.168.A.1 / 24</b> ; <br><br>  18) El enrutador virtual acepta este paquete.  Cabe se√±alar que recuerda que recibi√≥ un paquete de <b>BBB1: 44444</b> en <b>AAA2: 13389</b> y cambi√≥ la direcci√≥n y el puerto del destinatario a <b>192.168.A.1: 3389</b> , por lo tanto, cambia el paquete de <b>192.168.A.1: 3389</b> a <b>BBB1: 44444</b> direcci√≥n del remitente en <b>AAA2: 13389</b> ; <br><br>  19) el enrutador virtual decide a qui√©n debe enviarse este paquete, lo env√≠a a <b>AAA254</b> (la puerta de enlace del proveedor de Internet, en este caso, tambi√©n somos nosotros), porque no tiene rutas m√°s espec√≠ficas para <b>BBB1</b> que 0.0.0.0/0; <br><br>  20) los proveedores de Internet transfieren un paquete de <b>AAA2</b> a <b>BBB1</b> en sus redes; <br><br>  21) el enrutador en <b>BBB1</b> recibe este paquete y recuerda que cuando envi√≥ el paquete desde <b>192.168.B.1: 55555</b> a <b>AAA2: 13389</b> , cambi√≥ su direcci√≥n y puerto de remitente a <b>BBB1: 44444</b> , lo que significa que esta es la respuesta que debe transmitirse en <b>192.168.B.1: 55555</b> (de hecho, hay varios cheques m√°s, pero no lo examinamos); <br><br>  22) entiende que deben enviarse directamente a <b>192.168.B.1</b> , ya que est√° en la misma red que √©l, por lo tanto, tiene una entrada correspondiente en la tabla de enrutamiento que lo obliga a enviar paquetes para todo <b>192.168.B.0 / 24</b> directamente <br><br>  23) el enrutador encuentra la direcci√≥n MAC para <b>192.168.B.1</b> y le env√≠a este paquete; <br><br>  24) el sistema operativo en la computadora con la direcci√≥n <b>192.168.B.1</b> recibe un paquete de <b>AAA2: 13389</b> para <b>192.168.B.1: 55555</b> e inicia los siguientes pasos para establecer una conexi√≥n TCP. <br><br>  Cabe se√±alar que en este caso la computadora con la direcci√≥n <b>192.168.B.1</b> no sabe nada sobre el servidor con la direcci√≥n <b>192.168.A.1</b> , solo se comunica con <b>AAA2</b> .  Del mismo modo, el servidor con la direcci√≥n <b>192.168.A.1</b> no sabe nada sobre la computadora con la direcci√≥n <b>192.168.B.1</b> .  √âl cree que se conectaron con √©l desde la direcci√≥n <b>BBB1</b> , y no sabe nada m√°s, por as√≠ decirlo. <br><br>  Tambi√©n debe tenerse en cuenta que si esta computadora accede a <b>AAA2: 1540</b> , la conexi√≥n no se establecer√°, porque el reenv√≠o de la conexi√≥n al puerto 1540 no est√° configurado en el enrutador virtual, incluso si est√° en alg√∫n servidor de la red virtual <b>192.168.A.0 / 24</b> (por ejemplo, en un servidor con la direcci√≥n <b>192.168.A.1</b> ) y hay algunos servicios que esperan una conexi√≥n en este puerto.  Si el usuario de la computadora con la direcci√≥n <b>192.168.B.1 es</b> absolutamente necesario para establecer una conexi√≥n con este servicio, debe usar una VPN, es decir  contactar directamente al <b>192.168.A.1: 1540</b> . <br><br>  Se debe enfatizar que cualquier intento de establecer una conexi√≥n con <b>AAA1</b> (excepto la conexi√≥n IPSec de <b>BBB1</b> no tendr√° √©xito. Cualquier intento de establecer una conexi√≥n con <b>AAA2</b> , excepto las conexiones al puerto 13389, tambi√©n fracasar√°. <br>  Tambi√©n tenga en cuenta que si alguien m√°s <b>llama</b> a <b>AAA2</b> (por ejemplo, UDP), todo lo que se indica en los p√°rrafos 10-20 tambi√©n se aplicar√° a √©l.  Lo que sucede antes y despu√©s de eso depende de qu√© hay detr√°s de esto. No poseemos dicha informaci√≥n, por lo tanto, le recomendamos que consulte a los administradores del sitio con la direcci√≥n de la direcci√≥n. <br><br><h3>  Tercer puesto </h3><br>  Y viceversa, si se env√≠a algo desde <b>192.168.A.1</b> a alg√∫n puerto configurado para ser reenviado dentro a BBB1 (por ejemplo, 11111), tampoco <b>ingresa</b> a la VPN, sino que solo se engancha desde <b>AAA1</b> y termina en <b>BBB1</b> , y ese ya lo est√° transfiriendo a alg√∫n lugar en, digamos, <b>192.168.B.2: 3389</b> .  √âl ve este paquete no desde <b>192.168.A.1</b> , sino desde <b>AAA1</b> .  Y, cuando <b>192.168.B.2</b> responde, el paquete pasa de <b>BBB1</b> a <b>AAA1,</b> y luego llega al iniciador de conexi√≥n: <b>192.168.A.1</b> . <br><br>  Ejemplo concreto: <br><br>  1) <b>192.168.A.1 se</b> dirige a <b>BBB1</b> , desea establecer una conexi√≥n TCP con <b>BBB1: 11111</b> ; <br><br>  2) <b>192.168.A.1</b> env√≠a una solicitud para establecer una conexi√≥n desde <b>192.168.A.1: 55555</b> (este n√∫mero, como en el ejemplo anterior, puede ser diferente) en <b>BBB1: 11111</b> ; <br><br>  3) el sistema operativo que se ejecuta en el servidor con la direcci√≥n <b>192.168.A.1</b> decide transferir este paquete a la direcci√≥n de puerta de enlace del enrutador ( <b>192.168.A.254</b> en nuestro caso), porque no tiene otras rutas m√°s espec√≠ficas para <b>BBB1</b> , por lo tanto, env√≠a el paquete a lo largo de la ruta predeterminada (0.0.0.0/0); <br><br>  4) para esto, ella, como mencionamos en los ejemplos anteriores, trata de encontrar la direcci√≥n MAC para la direcci√≥n IP <b>192.168.A.254</b> en la tabla de cach√© del protocolo ARP.  Si no se encuentra, env√≠a desde la direcci√≥n <b>192.168.A.1 una</b> solicitud de difusi√≥n que tiene a la red <b>192.168.A.0 / 24</b> .  Cuando <b>192.168.A.254 le</b> devuelve su direcci√≥n MAC, el sistema le transmite un paquete Ethernet e ingresa esta informaci√≥n en su tabla de cach√©; <br><br>  5) el enrutador virtual recibe este paquete y decide d√≥nde transferirlo: tiene una pol√≠tica que debe reenviar (reemplazando la direcci√≥n de retorno) todos los paquetes desde <b>192.168.A.0 / 24</b> a otros nodos de Internet; <br><br>  6) dado que esta pol√≠tica supone que la direcci√≥n de retorno debe coincidir con la direcci√≥n m√°s baja en la interfaz a trav√©s de la cual se transmitir√° este paquete, el enrutador virtual primero decide a qui√©n se debe transmitir exactamente este paquete, y √©l, como en el ejemplo anterior, debe enviarlo en <b>AAA254</b> (la puerta de enlace del proveedor de Internet, en este caso, tambi√©n somos nosotros), porque no tiene rutas m√°s espec√≠ficas para <b>BBB1</b> que 0.0.0.0/0; <br><br>  7) significa que el enrutador virtual reemplaza la direcci√≥n de retorno del paquete, de ahora en adelante es un paquete de <b>AAA1: 44444</b> (el n√∫mero de puerto, por supuesto, puede ser diferente) a <b>BBB1: 11111</b> ; <br><br>  8) el enrutador virtual recuerda lo que hizo, por lo tanto, cuando <b>se recibe</b> una <b>respuesta</b> de <b>BBB1: 11111</b> para <b>AAA1: 44444</b> , sabr√° que debe cambiar la direcci√≥n y el puerto del destinatario a <b>192.168.A.1: 55555</b> . <br><br>  9) ahora el enrutador virtual debe transferirlo a la red del proveedor de Internet a trav√©s de <b>AAA254</b> , lo que significa que, tal como ya lo mencionamos, encuentra la direcci√≥n MAC de <b>AAA254</b> y env√≠a el paquete a la puerta de enlace del proveedor de Internet; <br><br>  10) los proveedores de Internet transfieren en sus redes un paquete de <b>AAA1 a BBB1</b> ; <br><br>  11) el enrutador en <b>BBB1</b> recibe este paquete en el puerto 11111; <br><br>  12) hay una regla en el enrutador virtual, que estipula que los paquetes recibidos de cualquier remitente a este puerto deben transmitirse a <b>192.168.B.2: 3389</b> ; <br><br>  13) el enrutador encuentra la red <b>192.168.B.0 / 24</b> en la tabla de enrutamiento y la env√≠a directamente a <b>192.168.B.2</b> , ya que tiene una interfaz <b>192.168.B.254 / 24</b> ; <br><br>  14) para esto, el enrutador virtual encuentra la direcci√≥n MAC para <b>192.168.B.2</b> y le pasa este paquete a trav√©s de la red Ethernet virtual; <br><br>  15) <b>192.168.B.2</b> recibe este paquete en el puerto 3389, acuerda establecer una conexi√≥n y forma un paquete en respuesta desde <b>192.168.B.2: 3389</b> a <b>AAA1: 44444</b> ; <br><br>  16) su sistema env√≠a este paquete a la direcci√≥n de la puerta de enlace del enrutador ( <b>192.168.B.254</b> en nuestro caso), porque no tiene otras rutas m√°s espec√≠ficas para <b>AAA1</b> , por lo tanto, debe pasar el paquete a lo largo de la ruta predeterminada (0.0.0.0 / 0); <br><br>  17) de la misma manera que en casos anteriores, el sistema que se ejecuta en la computadora con la direcci√≥n <b>192.168.B.2</b> encuentra la direcci√≥n MAC <b>192.168.B.254</b> , ya que est√° en la misma red con su interfaz <b>192.168.B.2 / 24</b> ; <br><br>  18) El enrutador acepta este paquete.  Cabe se√±alar que recuerda que recibi√≥ un paquete de <b>AAA1</b> en <b>BBB1: 11111</b> y cambi√≥ la direcci√≥n y el puerto del destinatario a <b>192.168.B.2: 3389</b> , por lo tanto, cambia la direcci√≥n del remitente a un paquete de <b>192.168.B.2: 3389</b> para <b>AAA1: 44444</b> en <b>BBB1: 11111</b> ; <br><br>  19) El enrutador decide a qui√©n reenviar este paquete.  Lo env√≠a a, digamos, <b>BBB254</b> (la puerta de enlace del proveedor de Internet, cuya direcci√≥n exacta no conocemos), porque no tiene rutas m√°s espec√≠ficas para <b>AAA1</b> que 0.0.0.0/0; <br><br>  20) los proveedores de Internet transfieren un paquete de <b>BBB1</b> a <b>AAA1</b> en sus redes; <br><br>  21) el enrutador virtual en <b>AAA1</b> recibe este paquete y recuerda que cuando envi√≥ el paquete desde <b>192.168.A.1: 55555</b> a <b>BBB1: 11111</b> , cambi√≥ su direcci√≥n y el puerto del remitente a <b>AAA1: 44444</b> .  Entonces, esta es la respuesta que debe transmitirse a <b>192.168.A.1: 55555</b> (de hecho, como mencionamos en el ejemplo anterior, tambi√©n hay algunas comprobaciones m√°s all√≠, pero esta vez no las abordamos tambi√©n); <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22) entiende que debe enviarse directamente a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ya que est√° en la misma red que √©l, lo que significa que tiene una entrada correspondiente en la tabla de enrutamiento que lo obliga a enviar paquetes para todo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.0 / 24</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directamente; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23) el enrutador encuentra la direcci√≥n MAC para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y le env√≠a este paquete; </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">24) el sistema operativo en el servidor con la direcci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> recibe un paquete de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BBB1: 1111</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1: 55555</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e inicia los siguientes pasos para establecer una conexi√≥n TCP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De la misma manera que en el caso anterior, en este caso el servidor con la direcci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no sabe nada sobre la computadora con la direcci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.B.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , solo se comunica con </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BBB1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La computadora con la direcci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.B.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tampoco sabe nada sobre el servidor con la direcci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.A.1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">√âl cree que se conectaron con √©l desde la direcci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AAA1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y el resto est√° oculto para √©l.</font></font><br><br><h3>  Conclusi√≥n </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As√≠ sucede cuando se conecta dentro de un t√∫nel VPN entre la oficina del cliente y el entorno en la nube, as√≠ como cuando se conecta fuera del t√∫nel VPN. </font><font style="vertical-align: inherit;">Y si a√∫n tiene preguntas o necesita nuestra ayuda para resolver problemas en la nube, </font></font><a href="https://tucha.ua/ru/contacts"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comun√≠quese con 24x7.</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/477854/">https://habr.com/ru/post/477854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../477844/index.html">5 pasos desde la idea hasta la aplicaci√≥n pr√°ctica del aprendizaje autom√°tico con SAP Data Intelligence</a></li>
<li><a href="../477846/index.html">El resumen de eventos para profesionales de recursos humanos en TI para diciembre de 2019</a></li>
<li><a href="../477848/index.html">El peque√±o secreto de un gran coraz√≥n: el primer cardiograma de ballena azul de la historia</a></li>
<li><a href="../477850/index.html">React Native: ¬øuna bala de plata para todos los problemas? C√≥mo elegimos una herramienta multiplataforma para Profi.ru</a></li>
<li><a href="../477852/index.html">Hipocres√≠a no t√≥xica</a></li>
<li><a href="../477856/index.html">Aceleradores de flash PCI-E de 800GB a 6.4TB: desde el amanecer hasta la vida en una PC / servidor normal</a></li>
<li><a href="../477858/index.html">Trabajo fuera de la mesa: ¬øqu√© proyectos salieron a la luz despu√©s de la aceleraci√≥n previa?</a></li>
<li><a href="../477862/index.html">¬øY entonces fue posible? Ciencia y TI en una conferencia</a></li>
<li><a href="../477864/index.html">TabPy para trabajar con datos en ClickHouse de Tableau</a></li>
<li><a href="../477866/index.html">Seminario: Soluciones de TI h√≠bridas para empresas. 5 de diciembre, San Petersburgo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>