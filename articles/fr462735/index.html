<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ¨ üôÑ üàØÔ∏è Test de r√©sistance fiable prenant en compte les nuances impr√©vues üïã ‚òÑÔ∏è ‚ò¢Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a un an, nous avons pens√© √† construire l'infrastructure de tests de charge importants, lorsque nous avons atteint le cap des 12 000 utilisateurs ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Test de r√©sistance fiable prenant en compte les nuances impr√©vues</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/miro/blog/462735/"> Il y a un an, nous avons pens√© √† construire l'infrastructure de tests de charge importants, lorsque nous avons atteint le cap des 12 000 utilisateurs en ligne travaillant dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notre service</a> en m√™me temps.  Pendant 3 mois nous avons r√©alis√© la premi√®re version du test, qui montrait les limites du service. <br><br>  L'ironie du sort est qu'en m√™me temps que le test a √©t√© lanc√©, nous avons atteint les limites de la prod, ce qui a fait chuter le service de 2 heures.  Cela nous a en outre encourag√©s √† passer de la r√©alisation de tests au cas par cas √† la cr√©ation d'une infrastructure porteuse efficace.  Par infrastructure, je veux dire tous les outils pour travailler avec la charge: outils pour le lancement et le d√©marrage, un cluster pour charger la charge, un cluster, un produit similaire, des services pour collecter des m√©triques et pour pr√©parer des rapports, du code pour g√©rer tout cela et des services pour √©voluer. <br><br><img src="https://habrastorage.org/webt/mw/kz/jl/mwkzjls34yw96qxg5lu9ubf-0bs.png"><br><a name="habracut"></a><br>  Voici √† quoi ressemble le sch√©ma miro.com: il existe de nombreux serveurs diff√©rents qui interagissent d'une mani√®re ou d'une autre, et chacun effectue des t√¢ches sp√©cifiques.  Il semble que pour construire l'infrastructure des tests de charge, il nous a suffi de dessiner un tel sch√©ma, de prendre en compte toutes les relations et de commencer √† couvrir chaque bloc s√©quentiellement avec des scripts.  Cette approche est bonne, mais elle prendrait de nombreux mois, ce qui ne nous convenait pas en raison de la croissance rapide - au cours des six derniers mois, nous sommes pass√©s de 12K √† 20K utilisateurs en ligne travaillant dans le service en m√™me temps.  De plus, nous ne savions pas comment l'infrastructure de notre service r√©pondra √† une augmentation de la charge: lequel des blocs deviendra un goulot d'√©tranglement et que nous pouvons √©voluer de mani√®re lin√©aire. <br><br>  En cons√©quence, nous avons d√©cid√© de tester le service en utilisant des utilisateurs virtuels, en simulant leur travail r√©aliste, c'est-√†-dire en construisant un clone de production et en faisant un gros test, qui: <br><br><ul><li>  charger un cluster identique √† la production en structure, mais en avance sur lui en puissance; </li><li>  donnez-nous toutes les donn√©es pour prendre des d√©cisions; </li><li>  montrera que l'ensemble de l'infrastructure est capable de supporter la bonne charge; </li><li>  sera la base des tests de r√©sistance dont nous aurons peut-√™tre besoin √† l'avenir. </li></ul><br>  Le seul inconv√©nient d'un tel test est son prix de revient, car pour cela nous avons besoin d'un environnement qui sera plus grand que l'environnement de production. <br><br>  Dans cet article, je vais vous expliquer comment cr√©er un sc√©nario r√©aliste, des plugins - WS, Stress-client, Taurus, - charger un cluster, vendre un cluster et montrer des exemples d'utilisation de tests.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le prochain article</a> explique comment nous g√©rons des centaines de serveurs pour un test de charge. <br><br><h2>  Cr√©ez un sc√©nario r√©aliste </h2><br>  Pour cr√©er un sc√©nario r√©aliste, nous avons besoin de: <br><br><ul><li>  analyser le travail des utilisateurs sur la prod, et pour cela, d√©terminer les m√©triques qui sont importantes pour nous, commencer √† les collecter r√©guli√®rement et analyser les sauts; </li><li>  cr√©er des blocs personnalis√©s pratiques avec lesquels nous pouvons charger efficacement la partie n√©cessaire de la logique m√©tier; </li><li>  V√©rifiez le r√©alisme du script avec les m√©triques du serveur. </li></ul><br>  Maintenant, plus sur chaque article. <br><br>  <b>Analyse du travail des utilisateurs sur prod</b> <br><br>  Dans notre service, les utilisateurs peuvent cr√©er des tableaux et y travailler avec diff√©rents contenus: photos, textes, mocapas, autocollants, diagrammes, etc.  La premi√®re mesure que nous devons collecter est le nombre de tableaux et la distribution de contenu sur eux. <br><br><img align="left" src="https://habrastorage.org/webt/uq/ah/cp/uqahcpsgmjnzqao48ivvrhgzuvc.png" width="400" height="500"><br>  Sur la m√™me carte au m√™me moment, certains utilisateurs peuvent activement faire quelque chose - cr√©er, supprimer, modifier - et certains simplement afficher le mat√©riel cr√©√©.  Il s'agit √©galement d'une mesure importante - le rapport entre le nombre d'utilisateurs modifiant le contenu du tableau et le nombre total d'utilisateurs d'un tableau.  Nous pouvons l'obtenir sur la base de statistiques sur l'utilisation de la base de donn√©es. <br><br>  Dans notre backend, nous utilisons l'approche par composants.  Composants que nous appelons mod√®les.  Nous divisons notre code en mod√®les afin que pour chaque partie de la logique m√©tier, un certain mod√®le soit responsable.  Nous pouvons calculer le nombre d'appels de base de donn√©es qui se produisent √† travers chaque mod√®le et comprendre quelle partie de la logique charge le plus la base de donn√©es. <br><br><img src="https://habrastorage.org/webt/-d/zu/iu/-dzuiu9istykhoantxrs-po64ky.png"><br><br>  <b>Blocs personnalis√©s pratiques</b> <br><br>  Par exemple, nous devons ajouter un bloc au script qui charge notre service de mani√®re identique √† la fa√ßon dont cela se produit lorsque vous ouvrez une page de tableau de bord avec une liste de tableaux de bord.  Lors du chargement de cette page, des requ√™tes http avec un grand ensemble de donn√©es sont envoy√©es: le nombre de tableaux, les comptes auxquels l'utilisateur a acc√®s, tous les utilisateurs du compte, etc. <br><br><img src="https://habrastorage.org/webt/zb/j1/sx/zbj1sxyfvbkfbotawsqnegvz8zg.gif"><br><br>  Comment charger efficacement un tableau de bord?  Lors de l'analyse du comportement de production, nous avons constat√© des pics de charge dans la base de donn√©es lors de l'ouverture du tableau de bord d'un grand compte.  Nous pouvons recr√©er un compte identique et changer l'intensit√© d'utilisation de ses donn√©es dans le script, en chargeant efficacement un tableau de bord avec un petit nombre de hits.  Nous pouvons √©galement cr√©er une charge in√©gale pour plus de r√©alisme. <br><br>  Dans le m√™me temps, il est important pour nous que le nombre d'utilisateurs virtuels et la charge cr√©√©e par eux soient aussi similaires que possible aux utilisateurs et √† la charge de production.  Pour ce faire, nous recr√©ons √©galement dans le test la charge de fond sur le tableau de bord moyen.  Ainsi, la plupart des utilisateurs virtuels travaillent sur de petits tableaux de bord moyens, et seuls quelques utilisateurs cr√©ent une charge d√©sastreuse, comme cela se produit en production. <br><br>  Au d√©part, nous ne voulions pas couvrir chaque r√¥le de serveur et chaque relation avec un script distinct.  Cela peut √™tre vu dans l'exemple avec le tableau de bord - nous r√©p√©tons simplement pendant le test ce qui se passe lorsque le tableau de bord est ouvert sur le prod lorsque l'utilisateur l'ouvre, et nous ne couvrons pas ce qu'il affecte avec des scripts synth√©tiques.  Cela vous permet par d√©faut de tester des nuances que nous n'avions m√™me pas anticip√©es.  Ainsi, nous approchons de la cr√©ation d'un test d'infrastructure du c√¥t√© de la logique m√©tier. <br><br>  Nous avons utilis√© cette logique pour charger efficacement tous les autres blocs du service.  En m√™me temps, chaque bloc individuel du point de vue de la logique d'utilisation du fonctionnel peut ne pas √™tre r√©aliste;  il est important qu'il donne une charge m√©trique r√©aliste sur les serveurs.  Et puis nous pouvons cr√©er un script √† partir de ces blocs qui imite le vrai travail des utilisateurs. <br><br><img src="https://habrastorage.org/webt/wk/gc/po/wkgcporetjxwqqbca-qfeedkuam.png"><br><br><h3>  Les donn√©es font partie du script. </h3><br>  N'oubliez pas que les donn√©es font √©galement partie du script et que la logique du code lui-m√™me d√©pend beaucoup des donn√©es.  Lors de la construction d'une grande base de donn√©es pour le test - et elle devrait √©videmment √™tre volumineuse pour un test d'infrastructure de grande taille - nous devons apprendre √† cr√©er des donn√©es qui ne donneront pas de r√©sultat lors de l'ex√©cution du script.  Si vous accumulez des donn√©es ind√©sirables, le script peut s'av√©rer irr√©aliste et une grande base de donn√©es sera difficile √† r√©parer.  Par cons√©quent, nous avons commenc√© √† utiliser l'API Rest pour cr√©er des donn√©es de la m√™me mani√®re que nos utilisateurs le font. <br><br>  Par exemple, pour cr√©er des cartes avec les donn√©es disponibles, nous ex√©cutons des requ√™tes API pour charger des cartes √† partir de la sauvegarde.  En cons√©quence, nous obtenons des donn√©es r√©elles honn√™tes - diff√©rentes cartes de diff√©rentes tailles.  Dans le m√™me temps, la base de donn√©es se remplit assez rapidement en raison du fait que nous tirons des demandes dans le script de mani√®re multithread.  En vitesse, cela est comparable √† la g√©n√©ration de donn√©es d'ordures. <br><br><h3>  R√©sultats pour cette partie </h3><br><ul><li>  Utilisez des sc√©narios r√©alistes si vous souhaitez tout v√©rifier en m√™me temps; </li><li>  Analyser le comportement r√©el des utilisateurs pour concevoir la structure du script; </li><li>  Cr√©ez imm√©diatement des blocs pratiques pour la personnalisation; </li><li>  Configurer par de vraies m√©triques de serveur, pas par des analyses d'utilisation; </li><li>  N'oubliez pas que les donn√©es font partie du script. </li></ul><br><h2>  Charger un cluster </h2><br>  Sch√©ma d'outils pour appliquer la charge: <br><br><img src="https://habrastorage.org/webt/sw/gb/wg/swgbwgmqvkv2r8uue1tkrv5oyve.png"><br><br>  Dans Jmeter, nous cr√©ons un script que nous lan√ßons √† l'aide de Taurus et chargeons diff√©rents serveurs avec lui: web, api, serveurs de carte.  Nous effectuons des tests de base de donn√©es s√©par√©ment en utilisant Postgresql, pas Jmeter, donc le diagramme montre une ligne pointill√©e. <br><br><h3>  Travail personnalis√© √† l'int√©rieur de la prise Web </h3><br>  Le travail sur la carte s'effectue √† l'int√©rieur de la connexion WS, et c'est sur la carte que le travail multi-utilisateur est possible.  Maintenant, dans la bo√Æte Jmeter √† l'int√©rieur du gestionnaire de plug-ins, il existe plusieurs plug-ins pour travailler avec le socket Web.  La logique est la m√™me partout - les plugins ouvrent simplement une connexion socket Web, mais toutes les actions qui se produisent √† l'int√©rieur, dans tous les cas, vous devez vous √©crire.  Pourquoi?  Parce que nous ne pouvons pas travailler de la m√™me mani√®re qu'avec les requ√™tes http, c'est-√†-dire que nous ne pouvons pas √©crire un script, extraire des valeurs dynamiques avec des extracteurs et les ignorer davantage. <br><br>  Le travail √† l'int√©rieur du socket Web est g√©n√©ralement tr√®s personnalis√©: vous invoquez certaines m√©thodes avec certaines donn√©es personnalis√©es et, par cons√©quent, vous devez vous-m√™me comprendre si la demande a √©t√© ex√©cut√©e correctement et combien de temps il a fallu pour l'ex√©cuter.  L'√©couteur √† l'int√©rieur de ce plugin est √©galement √©crit ind√©pendamment; nous n'avons pas trouv√© de bonne solution pr√™te √† l'emploi. <br><br><h3>  Client stress√© </h3><br>  Nous voulons r√©p√©ter le plus simplement possible ce que font les vrais utilisateurs.  Mais nous ne savons pas comment enregistrer et lire ce qui se passe dans le navigateur √† l'int√©rieur de WS.  Si nous √©crivons tout √† l'int√©rieur de WS √† partir de z√©ro, nous obtiendrons un nouveau client, et non celui que les vrais utilisateurs utilisent.  Je n'ai pas envie d'√©crire un nouveau client si nous en avons d√©j√† un qui fonctionne. <br><br>  Par cons√©quent, nous avons d√©cid√© de placer notre client √† l'int√©rieur de Jmeter.  Et face √† un certain nombre de difficult√©s.  Par exemple, ex√©cuter js dans Jmeter est une histoire distincte, comme  Il s'agit d'une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version</a> absolument <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sp√©cifique des</a> fonctionnalit√©s prises en charge.  Et si vous souhaitez utiliser votre code client existant, vous ne r√©ussirez probablement pas, car les nouvelles constructions ne peuvent pas √™tre lanc√©es ici, elles devront √™tre r√©√©crites. <br><br>  La deuxi√®me difficult√© est que nous ne voulons pas prendre en charge l'int√©gralit√© du code client pour les tests de charge.  Par cons√©quent, nous avons supprim√© tout ce qui √©tait superflu du client et laiss√© uniquement l'interaction client-serveur.  Cela nous a permis d'utiliser des m√©thodes client-serveur et de faire tout ce que notre client peut faire.  Le plus est que l'interaction client-serveur change extr√™mement rarement, ce qui signifie que la prise en charge du code √† l'int√©rieur du script est rarement requise.  Par exemple, au cours des six derniers mois, je n'ai jamais apport√© de modifications au code, car il fonctionne tr√®s bien. <br><br>  La troisi√®me difficult√© - l'apparition de gros scripts complique consid√©rablement le script.  Premi√®rement, cela peut devenir un goulot d'√©tranglement dans le test.  Deuxi√®mement, nous ne pourrons probablement pas d√©marrer un grand nombre de threads √† partir d'une seule machine.  Maintenant, nous ne pouvons lancer que 730 threads. <br><br>  <b>Notre exemple d'instance Amazon</b> <br><br><pre><code class="plaintext hljs"> Jmeter server  AWS: m5.large ($0.06 per Hour) vCPU: 2 Mem (GiB): 8 Dedicated EBS Bandwidth (Mbps): Up to 3,500 Network Performance (Gbps): Up to 10 ‚Üí ~730 </code> </pre> <br><h3>  O√π trouver des centaines de serveurs et comment √©conomiser </h3><br>  Ensuite, la question se pose: 730 threads d'une seule machine, mais nous voulons 50K.  O√π √©lever autant de serveurs?  Nous cr√©ons une solution cloud, donc acheter des serveurs pour tester une solution cloud semble √©trange.  De plus, c'est toujours une certaine lenteur dans les processus d'achat de fer neuf.  Par cons√©quent, nous devons les augmenter √©galement dans le cloud, nous avons donc finalement choisi entre les fournisseurs de cloud et les outils de chargement dans le cloud. <br><br>  Nous n'avons pas utilis√© d'outils de chargement dans le cloud comme Blazemeter et RedLine13, car ils ont des restrictions d'utilisation qui ne nous convenaient pas.  Nous avons diff√©rents sites de test, nous voulions donc trouver une solution universelle qui permettrait d'utiliser 90% des d√©veloppements, y compris dans les tests locaux. <br><br>  En cons√©quence, nous avons choisi entre les fournisseurs de cloud. <br><br><img src="https://habrastorage.org/webt/ud/35/8n/ud358nhlnnsa9uopiwpfisoipa8.png"><br><br>  Notre production est sur AWS, nous testons donc principalement l√†-bas et nous voulons que le banc d'essai soit aussi similaire que possible √† la production.  Amazon a de nombreuses fonctionnalit√©s payantes, dont certaines que nous utilisons dans le produit, par exemple, des √©quilibreurs.  Si ces fonctionnalit√©s ne sont pas n√©cessaires dans AWS, vous pouvez les utiliser 17 fois moins cher dans Hetzner.  Ou vous pouvez conserver le serveur dans Hetzner, utiliser Openstack et √©crire des √©quilibreurs et d'autres fonctionnalit√©s vous-m√™me, car en utilisant Openstack, vous pouvez r√©p√©ter toute l'infrastructure.  Nous avons r√©ussi. <br><br>  Tester 50 000 utilisateurs avec 69 instances dans AWS nous co√ªte environ 3 000 $ par mois.  Comment √©conomiser?  Par exemple, AWS a des instances temporaires - des instances ponctuelles.  Leur fra√Æcheur est que nous ne les gardons pas constamment, nous ne les √©levons que pour la dur√©e des tests et ils co√ªtent beaucoup moins cher.  La nuance est que quelqu'un d'autre peut les acheter √† un prix plus √©lev√© au moment de notre test.  Heureusement, cela ne s'est jamais produit auparavant, mais nous √©conomisons d√©j√† au moins 60% du co√ªt √† leurs d√©pens. <br><br><h2>  Charger un cluster </h2><br>  Nous utilisons le cluster de bo√Ætes Jmeter.  Cela fonctionne tr√®s bien, il n'a pas besoin d'√™tre modifi√© en aucune fa√ßon.  Il a plusieurs options de lancement.  Nous utilisons le plus simple lorsqu'un assistant d√©marre N instances, et il peut y en avoir des centaines. <br><br><img src="https://habrastorage.org/webt/vz/oj/di/vzojdipz783bcxk6va84kxuu1ga.png"><br><br>  L'assistant ex√©cute le script sur les serveurs Jmeter, tout en restant en contact avec eux, collecte des statistiques g√©n√©rales de toutes les instances en temps r√©el et les affiche dans la console.  Tout cela ressemble exactement √† l'ex√©cution du script sur un serveur, bien que nous voyions les r√©sultats du lancement sur une centaine de serveurs. <br><br>  Pour une analyse d√©taill√©e des r√©sultats de l'ex√©cution du script sur toutes les instances, nous utilisons Kibana.  Journaux Parsim √† l'aide de Filebeat. <br><br><img src="https://habrastorage.org/webt/lp/2i/es/lp2ieslbdsgadsr41ydhss4vtco.png"><br><br><h3>  Un √©couteur Prometheus pour Apache JMeter </h3><br>  Jmeter a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin pour travailler avec Prometheus</a> , qui fournit toutes les statistiques sur l'utilisation de la JVM et des threads √† l'int√©rieur du test.  Cela vous permet de voir √† quelle fr√©quence les utilisateurs se connectent, se d√©connectent, etc.  Le plugin peut √™tre personnalis√© pour envoyer des donn√©es sur le script √† Prometheus et les voir en temps r√©el dans Grafana. <br><br><img src="https://habrastorage.org/webt/mw/ig/3m/mwig3mwxuq6p7rexf1hq9nc8gek.png"><br><br><h3>  Taureau </h3><br>  Nous voulons r√©soudre un certain nombre de probl√®mes actuels avec Taurus, mais nous ne l'avons pas encore r√©solu: <br><br><ul><li>  Configure au lieu des clones de script.  Si vous avez test√© sur Jmeter, vous avez probablement d√ª faire face √† la n√©cessit√© d'ex√©cuter des scripts avec diff√©rents ensembles de param√®tres source, pour lesquels vous deviez cr√©er leurs clones.  Dans Taurus, il est possible d'avoir un sc√©nario et √† l'aide de configurations de contr√¥ler les param√®tres de lancement; </li><li>  Configurer la gestion des serveurs Jmeter lors de l'utilisation d'un cluster; </li><li>  Un analyseur de r√©sultats en ligne qui vous permet de collecter les r√©sultats s√©par√©ment des threads Jmeter et de ne pas surcharger le script lui-m√™me; </li><li>  Int√©gration pratique avec CI; </li><li>  La possibilit√© de tester un syst√®me distribu√©. </li></ul><br><h3>  Les r√©sultats de cette partie </h3><br><ul><li>  Si nous utilisons le code √† l'int√©rieur de Jmeter, alors il est pr√©f√©rable de penser imm√©diatement √† ses performances, car sinon nous pouvons tester Jmeter, pas notre produit; </li><li>  Le cluster Jmeter est une chose merveilleuse: il est facile √† configurer, la surveillance y est facilement viss√©e; </li><li>  Un grand cluster peut √™tre conserv√© sur place, ce sera beaucoup moins cher; </li><li>  Soyez prudent avec les √©couteurs √† l'int√©rieur du Jmeter afin que le script ne ralentisse pas le travail sur un grand nombre de serveurs. </li></ul><br><h2>  Exemples d'utilisation de tests d'infrastructure </h2><br>  Toute l'histoire ci-dessus concerne en grande partie la cr√©ation d'un sc√©nario r√©aliste pour un test de limite de service.  Les exemples ci-dessous montrent comment vous pouvez r√©utiliser l'infrastructure des tests de charge pour r√©soudre des probl√®mes locaux.  Je vais parler en d√©tail de deux tests, mais en g√©n√©ral, nous effectuons p√©riodiquement environ 10 types de tests de charge. <br><a name="database"></a><br><h3>  Test de base de donn√©es </h3><br>  Que pouvons-nous charger de test dans la base de donn√©es?  Les requ√™tes lourdes sont peu probables, car nous pouvons les tester en mode monothread, si nous regardons simplement les plans de requ√™te. <br><br>  Une situation int√©ressante est lorsque nous ex√©cutons le test et voyons la charge sur le disque.  Le graphique montre la progression de l'iowait. <br><br><img src="https://habrastorage.org/webt/o9/7i/wy/o97iwyqnwc7rdo6utv-xjoe-p_c.png"><br><br>  De plus, nous voyons que cela affecte les utilisateurs. <br><br><img src="https://habrastorage.org/webt/3z/c_/ia/3zc_iawonyc_jwscpgs4fl8yi1a.png"><br><br>  Nous comprenons la raison: le vide n'a pas fonctionn√© et n'a pas supprim√© les donn√©es de d√©chets de la base de donn√©es.  Si vous n'avez pas travaill√© avec Postgresql, Vacuum est comme le garbage collector en Java. <br><br><img src="https://habrastorage.org/webt/2l/ks/vr/2lksvred5j50eummkssdxyw7i1w.png"><br><br>  De plus, nous voyons que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Checkpoint a</a> commenc√© √† fonctionner hors du calendrier.  Pour nous, c'est un signal que les configurations Postgresql ne correspondent pas √† l'intensit√© du travail avec la base de donn√©es. <br><br><img src="https://habrastorage.org/webt/le/sx/cb/lesxcbanlw_j5iyhm0bawfrq4ic.png"><br><br>  Notre t√¢che consiste √† configurer correctement la base de donn√©es afin que de telles situations ne se reproduisent pas.  Le m√™me Postgresql a de nombreux param√®tres.  Pour un r√©glage fin, vous devez travailler en courtes it√©rations: correction de la configuration, lancement, v√©rification, correction de la configuration, lancement, v√©rification.  Bien s√ªr, pour cela, vous devez appliquer une bonne charge √† la base, mais pour cela, vous avez juste besoin de grands tests d'infrastructure. <br><br>  La particularit√© est que pour que le test acc√©l√®re normalement et ne tombe pas l√† o√π il n'est pas n√©cessaire, l'overclocking doit √™tre long.  Il nous faut environ trois heures pour tester, et cela ne ressemble plus √† de courtes it√©rations. <br><br>  Nous recherchons une solution.  Nous trouvons l'un des outils Postgresql - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pg_replay</a> .  Il peut reproduire en plusieurs fils exactement ce qui est √©crit dans les journaux et exactement comme cela s'est produit au moment de leur enregistrement.  Comment pouvons-nous l'utiliser efficacement?  Nous r√©duisons le vidage de la base de donn√©es, puis enregistrons tout ce qui se passe dans la base de donn√©es apr√®s l'enregistrement dans les journaux, puis nous avons la possibilit√© de d√©ployer le vidage et de lire tout ce qui s'est pass√© avec la base de donn√©es multithread. <br><br>  O√π √©crire des journaux?  Une solution populaire pour l'enregistrement des journaux est de les collecter sur le prod, car cela donne le script reproductible le plus r√©aliste.  Mais il y a un certain nombre de probl√®mes: <br><br><ul><li>  Pour le test, vous devez utiliser les donn√©es de vente, ce qui n'est pas toujours possible; </li><li>  Le processus utilise une op√©ration syslog co√ªteuse; </li><li>  Le disque est en cours de chargement. </li></ul><br>  Notre approche des grands tests nous aide ici.  Nous effectuons un vidage sur un environnement de test, ex√©cutons un grand test et enregistrons les journaux de tout ce qui se passe au moment o√π le script r√©aliste est ex√©cut√©.  Ensuite, nous utilisons notre propre outil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">marucy</a> pour tester la base de donn√©es: <br><ol><li>  Une instance est cr√©√©e dans AWS; </li><li>  Le d√©potoir dont nous avons besoin est d√©ploy√©; </li><li>  Pg_replay est lanc√© et lit les journaux n√©cessaires; </li><li>  Nous utilisons notre surveillance pour analyser le r√©sultat de Prometheus + Grafana.  Il existe des exemples de tableaux de bord dans le r√©f√©rentiel. </li></ol><br>  Au d√©marrage de marucy, on peut passer un petit nombre de param√®tres qui peuvent √™tre modifi√©s, par exemple l'intensit√© du script. <br><br>  Par cons√©quent, nous utilisons notre script r√©aliste pour cr√©er un test, puis jouer le test sans utiliser un grand cluster.  Il est important de consid√©rer que pour tester une base de donn√©es SQL, le script doit √™tre in√©gal, sinon la base de donn√©es elle-m√™me se comportera diff√©remment du prod. <br><br><h3>  Surveillance de la d√©gradation </h3><br>  Pour les tests de d√©gradation, nous utilisons notre sc√©nario r√©aliste.  L'id√©e est que nous devons nous assurer que le service ne fonctionne pas plus lentement apr√®s la prochaine version.  Si nos d√©veloppeurs changent dans le code ce qui entra√Æne une augmentation du temps d'ex√©cution des requ√™tes, nous pouvons comparer les nouvelles valeurs avec les r√©f√©rences et signaler s'il y a une erreur dans la construction.  Pour les valeurs de r√©f√©rence, nous prenons les valeurs actuelles qui nous conviennent. <br><br>  Le contr√¥le du temps d'ex√©cution des requ√™tes est utile, mais nous sommes all√©s plus loin.  Nous voulions voir que le temps de r√©ponse pendant le travail des vrais utilisateurs apr√®s la sortie ne devenait pas plus long.  Nous pensions qu'au moment des tests de r√©sistance, nous pouvons probablement aller v√©rifier quelque chose, mais ce ne seront que des dizaines de cas.  Il est plus efficace d'ex√©cuter des tests fonctionnels existants et de voir un millier de cas en m√™me temps. <br><br><img src="https://habrastorage.org/webt/_-/xy/0t/_-xy0t6oavpjngkog1hwqelq5ky.png"><br><br>  Comment √ßa marche pour nous?  Il y a un ma√Ætre qui, apr√®s assemblage, est d√©ploy√© sur un banc d'essai.  Ensuite, les tests fonctionnels sont ex√©cut√©s automatiquement en parall√®le avec les tests de charge.  Ensuite, nous obtenons un rapport dans Allure sur la fa√ßon dont les tests fonctionnels se sont d√©roul√©s sous charge. <br><br>  Dans ce rapport, par exemple, nous voyons qu'un test de comparaison a chut√© avec une valeur de r√©f√©rence. <br><br><img src="https://habrastorage.org/webt/t-/hh/b-/t-hhb-mrpc9zgyg0iwhvvt1yxtu.png"><br><br>  Dans les tests fonctionnels, nous pouvons √©galement mesurer le temps d'ex√©cution d'une op√©ration dans un navigateur.  Ou, un test fonctionnel √©choue simplement en raison d'une augmentation du temps d'ex√©cution de l'op√©ration sous charge, car le d√©lai d'attente sur le client fonctionnera. <br><br><h3>  R√©sultats pour cette partie </h3><br><ul><li>  Un test r√©aliste vous permet de tester la base de donn√©es √† moindre co√ªt et de la configurer facilement; </li><li>  Des tests fonctionnels sous charge sont possibles. </li></ul><br><br>  Le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prochain article</a> explique comment nous g√©rons des centaines de serveurs pour un test de charge. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462735/">https://habr.com/ru/post/fr462735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462723/index.html">Attrapez un chat avec TLA +</a></li>
<li><a href="../fr462725/index.html">Astuce de trigonom√©trie</a></li>
<li><a href="../fr462727/index.html">Digest Joomla pour juin-juillet 2019</a></li>
<li><a href="../fr462729/index.html">Soir√©e de conf√©rence ouverte sur la conception narrative au VSBI</a></li>
<li><a href="../fr462733/index.html">Fibre Channel: la vitalit√© de la connexion au stockage dans le centre de donn√©es</a></li>
<li><a href="../fr462737/index.html">Int√©gration d'OpenCart avec les syst√®mes comptables</a></li>
<li><a href="../fr462739/index.html">Conf√©rence de l'industrie du jeu GAMEDEV.HOUSE</a></li>
<li><a href="../fr462743/index.html">Moscou SPA Meetup # 5 - Annonce de r√©union</a></li>
<li><a href="../fr462747/index.html">J'ai √©crit cet article sans jamais regarder le clavier</a></li>
<li><a href="../fr462749/index.html">Gestion du bonheur: comment prendre soin et d√©velopper une √©quipe de bureau √† domicile dans plus de 30 villes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>