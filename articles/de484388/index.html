<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòë üë©‚Äçüî¨ üì§ VVVVVV ??? VVVVVV !!! :) üåè üßùüèª üë©üèΩ‚Äçü§ù‚Äçüë©üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wenn Sie diesen Text lesen, haben Sie entweder gedacht, dass etwas mit der √úberschrift nicht stimmt, oder Sie haben den Namen eines bekannten Computer...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>VVVVVV ??? VVVVVV !!! :)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/484388/">  Wenn Sie diesen Text lesen, haben Sie entweder gedacht, dass etwas mit der √úberschrift nicht stimmt, oder Sie haben den Namen eines bekannten Computerspiels gesehen.  VVVVVV ist ein Indie-Plattformspiel, das durch seine angenehme √§u√üere Einfachheit und nicht weniger angenehme innere Komplexit√§t vielen Spielern die Herzen gestohlen hat.  Vor einigen Tagen wurde VVVVVV 10 Jahre alt, und der Autor des Spiels - Terry Cavanagh - feierte diesen Feiertag mit der Ver√∂ffentlichung seines Quellcodes.  Was f√ºr verr√ºckte Dinge verbirgt es?  Lesen Sie die Antwort in diesem Artikel. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0c8/fdf/72a/0c8fdf72ab45ed2077f8ea957e6b7ea5.png" alt="Abbildung 1"></div><a name="habracut"></a><br><h2>  Einleitung </h2><br>  Oh, VVVVVV ... Ich erinnere mich, dass ich kurz nach der Ver√∂ffentlichung darauf gesto√üen bin und ein gro√üer Fan von Pixel-Retro-Spielen war. Ich war so aufgeregt, es auf meinem Computer zu installieren.  Ich erinnere mich an meine ersten Eindr√ºcke: "Ist das alles?  Nur durch die quadratischen R√§ume rennen? ‚Äú, Dachte ich nach ein paar Minuten des Spielens.  Ich wusste damals nicht, was mich erwartete.  Sobald ich den Startort verlassen hatte, befand ich mich in einer kleinen, aber verwirrenden und floriden zweidimensionalen Welt voller ungew√∂hnlicher Landschaften und Pixelartefakte, die mir unbekannt waren. <br><br>  Ich wurde vom Spiel mitgerissen.  Letztendlich habe ich das Spiel trotz einiger Herausforderungen, wie zum Beispiel hoher Komplexit√§t mit geschickt angewandter Spielsteuerung, komplett geschlagen - die Hauptfigur kann nicht springen, aber die Richtung des Gravitationsvektors auf sich selbst umkehren.  Ich habe keine Ahnung, wie oft mein Charakter damals gestorben ist, aber ich bin sicher, dass die Anzahl der Todesf√§lle in Zehntausenden gemessen wird.  Immerhin hat jedes Spiel seinen eigenen Reiz :) <br><br>  Wie auch immer, kehren wir zum Quellcode zur√ºck, der <a href="http://distractionware.com/blog/2020/01/vvvvvv-is-now-open-source/">zu Ehren des Jubil√§ums des Spiels ver√∂ffentlicht wurde</a> . <br><br>  Im Moment bin ich Entwickler des PVS-Studios, eines statischen Code-Analysators f√ºr C, C ++, C # und Java.  Neben der direkten Entwicklung engagieren wir uns auch f√ºr unsere Produktwerbung.  F√ºr uns besteht eine der besten M√∂glichkeiten darin, Artikel √ºber das √úberpr√ºfen von Open Source-Projekten zu schreiben.  Unsere Leser erhalten spannende Artikel zu Programmierthemen und wir haben die M√∂glichkeit, die Funktionen von PVS-Studio zu demonstrieren.  Als ich von der Er√∂ffnung des VVVVVV-Quellcodes h√∂rte, kam ich einfach nicht daran vorbei. <br><br>  In diesem Artikel untersuchen wir einige interessante Fehler, die der PVS-Studio-Analysator im VVVVVV-Code gefunden hat, und werfen einen detaillierten Blick auf diese Fehler.  Zeigen Sie mit dem Gravitationsvektor nach unten und machen Sie es sich bequem - wir stehen kurz vor dem Start! <br><br><h2>  √úbersicht der Analyzer-Warnungen </h2><br><h3>  Warnung 1 </h3><br>  <a href="https://www.viva64.com/en/w/v512/">V512</a> Ein Aufruf der Funktion 'sprintf' f√ºhrt zum √úberlauf des Puffers 'fileSearch'.  FileSystemUtils.cpp 307 <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_PATH 260 .... void PLATFORM_migrateSaveData(char *output) { char oldLocation[MAX_PATH]; char newLocation[MAX_PATH]; char oldDirectory[MAX_PATH]; char fileSearch[MAX_PATH]; .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Same place, different layout. */</span></span></span><span class="hljs-meta"> strcpy(oldDirectory, output); sprintf(fileSearch, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s\\*.vvvvvv"</span></span></span><span class="hljs-meta">, oldDirectory); .... }</span></span></code> </pre> <br>  Wie Sie sehen, haben die Zeichenfolgen <i>fileSearch</i> und <i>oldDirectory</i> dieselbe Gr√∂√üe: 260 Zeichen.  Nach dem Schreiben des Inhalts der <i>oldDirectory-</i> Zeichenfolge in die <i>Formatzeichenfolge</i> (das dritte <i>sprintf-</i> Argument) sieht es folgenderma√üen aus: <br><pre> <code class="cpp hljs">&lt;i&gt;contents_oldDirectory\*.vvvvvv&lt;/i&gt;</code> </pre> <br>  Diese Zeile ist 9 Zeichen l√§nger als der urspr√ºngliche Wert von <i>oldDirectory</i> .  Diese Zeichenfolge wird in <i>fileSearch geschrieben</i> .  Was passiert, wenn der <i>oldDirectory-</i> String l√§nger als 251 ist?  Der resultierende String ist l√§nger als <i>fileSearch</i> enthalten k√∂nnte, was dazu f√ºhrt, dass die Array-Grenzen verletzt werden.  Welche Daten im RAM besch√§digt werden k√∂nnen und zu welchem ‚Äã‚ÄãErgebnis sie f√ºhren, ist rhetorisch fraglich :) <br><br><h3>  Warnung 2 </h3><br>  <a href="https://www.viva64.com/en/w/v519/">V519</a> Der 'Hintergrund'-Variablen werden nacheinander zweimal Werte zugewiesen.  Vielleicht ist das ein Fehler.  √úberpr√ºfen Sie die Zeilen: 1367, 1373. Map.cpp 1373 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-comment"><span class="hljs-comment">//The Warpzone tmap = warplevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); roomname = warplevel.roomname; tileset = 1; background = 3; // &lt;= dwgfx.rcol = warplevel.rcol; dwgfx.backgrounddrawn = false; warpx = warplevel.warpx; warpy = warplevel.warpy; background = 5; // &lt;= if (warpy) background = 4; if (warpx) background = 3; if (warpx &amp;&amp; warpy) background = 5; break; .... }</span></span></code> </pre> <br>  Dieselbe Variable erh√§lt zweimal hintereinander einen Wert.  Diese Variable wird jedoch nicht zwischen Zuweisungen verwendet.  Was seltsam ist ... Diese Sequenz verst√∂√üt m√∂glicherweise nicht gegen die Logik des Programms, aber solche Zuweisungen selbst weisen auf Verwirrung beim Schreiben von Code hin.  Ob dies tats√§chlich ein Fehler ist, kann nur der Autor mit Sicherheit sagen.  Der Code enth√§lt zwar anschaulichere Beispiele f√ºr diesen Fehler: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"frames"</span></span>) { frames = atoi(pText); frames = <span class="hljs-number"><span class="hljs-number">0</span></span>; } .... }</code> </pre> <br>  In diesem Fall ist klar, dass sich ein Fehler entweder in der Logik oder in der redundanten Zuordnung versteckt.  Vielleicht wurde die zweite Zeile vor√ºbergehend zum Debuggen geschrieben und dann einfach vergessen.  Insgesamt hat PVS-Studio 8 Warnungen in solchen F√§llen ausgegeben. <br><br><h3>  Warnung 3 </h3><br>  <a href="https://www.viva64.com/en/w/v808/">V808</a> 'pKey'-Objekt vom Typ' basic_string 'wurde erstellt, aber nicht verwendet.  editor.cpp 1866 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pElem-&gt;Value())</span></span></span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"edEntities"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (TiXmlElement *edEntityEl = pElem-&gt;FirstChildElement(); edEntityEl; edEntityEl = edEntityEl-&gt;NextSiblingElement()) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(edEntityEl-&gt;Value())</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= //const char* pText = edEntityEl-&gt;GetText() ; if (edEntityEl-&gt;GetText() != NULL) { edentity[i].scriptname = std::string(edEntityEl-&gt;GetText()); } edEntityEl-&gt;QueryIntAttribute("x", &amp;edentity[i].x); edEntityEl-&gt;QueryIntAttribute("y", &amp;edentity[i].y); edEntityEl-&gt;QueryIntAttribute("t", &amp;edentity[i].t); edEntityEl-&gt;QueryIntAttribute("p1", &amp;edentity[i].p1); edEntityEl-&gt;QueryIntAttribute("p2", &amp;edentity[i].p2); edEntityEl-&gt;QueryIntAttribute("p3", &amp;edentity[i].p3); edEntityEl-&gt;QueryIntAttribute("p4", &amp;edentity[i].p4); edEntityEl-&gt;QueryIntAttribute("p5", &amp;edentity[i].p5); edEntityEl-&gt;QueryIntAttribute("p6", &amp;edentity[i].p6); i++; } EditorData::GetInstance().numedentities = i; } .... }</span></span></code> </pre> <br>  Dieser Code ist sehr seltsam.  Der Analysator warnt vor der erstellten, aber nicht verwendeten Variablen <i>pKey</i> , aber in Wirklichkeit war das Problem interessanter.  Ich habe die Zeile, die die Warnung ausgel√∂st hat, absichtlich mit einem Pfeil markiert, da diese Funktion mehr als eine String-Definition mit dem Namen <i>pKey enth√§lt</i> .  Richtig, eine weitere solche Variable wird in der <i>for-</i> Schleife deklariert.  Sie √ºberlappt diejenige, die au√üerhalb der Schleife deklariert wurde. <br><br>  Wenn Sie also auf den Wert der <i>pKey-</i> Zeichenfolge au√üerhalb der <i>for-</i> Schleife verweisen, erhalten Sie den Wert <i>pElem-&gt; Value ()</i> . Wenn Sie dies jedoch innerhalb der Schleife tun, erhalten Sie den Wert <i>edEntityEl -&gt; Wert ()</i> .  √úberlappende Namen sind ein ziemlich grober Fehler, der bei der Code√ºberpr√ºfung m√∂glicherweise nur sehr schwer auffindbar ist. <br><br><h3>  Warnung 4 </h3><br>  <a href="https://www.viva64.com/en/w/v805/">V805</a> Leistungseinbu√üen.  Es ist ineffizient, eine leere Zeichenfolge mit dem Konstrukt 'strlen (str)&gt; 0' zu identifizieren.  Eine effizientere M√∂glichkeit besteht darin, Folgendes zu √ºberpr√ºfen: str [0]! = '\ 0'.  physfs.c 1604 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *prefDir = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PHYSFS_getPrefDir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *org, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *app)</span></span></span><span class="hljs-function"> </span></span>{ .... assert(<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(prefDir) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefDir; } <span class="hljs-comment"><span class="hljs-comment">/* PHYSFS_getPrefDir */</span></span></code> </pre> <br>  Der Analysator hat ein Fragment f√ºr eine m√∂gliche Mikrooptimierung gefunden.  Mit der Funktion <i>strlen</i> wird √ºberpr√ºft, ob die Zeichenfolge leer ist.  Diese Funktion durchl√§uft alle Zeichenfolgenelemente und sucht nach einem Nullterminator ('\ 0').  Wenn wir eine lange Zeichenfolge erhalten, wird jedes Zeichen mit einem Nullterminator verglichen. <br><br>  Aber wir m√ºssen nur √ºberpr√ºfen, ob der String leer ist!  Sie m√ºssen lediglich herausfinden, ob das erste Zeichen eine Terminal-Null ist.  Um diese Pr√ºfung innerhalb der Zusicherung zu optimieren, lohnt es sich daher, Folgendes zu schreiben: <br><br><pre> <code class="cpp hljs">str[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-string"><span class="hljs-string">'\0'</span></span></code> </pre> <br>  Das ist die Empfehlung, die uns der Analysator gibt.  Sicher, der Aufruf der Funktion strlen ist im Zustand des Assert-Makros, daher wird er nur in der Debug-Version ausgef√ºhrt, in der die Geschwindigkeit nicht so wichtig ist.  In der Release-Version werden der Aufruf der Funktion und der Code schnell ausgef√ºhrt.  Trotzdem wollte ich zeigen, was unser Analyseger√§t in Bezug auf Mikrooptimierungen vorschlagen kann. <br><br><h3>  Warnung 5 </h3><br>  Um die Essenz eines anderen Fehlers zu demonstrieren, muss ich hier zwei Codefragmente zitieren: die Deklaration der <i>entclass-</i> Klasse und ihren Konstruktor.  Beginnen wir mit der Deklaration: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: entclass(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">outside</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-comment"><span class="hljs-comment">//Fundamentals bool active, invis; int type, size, tile, rule; int state, statedelay; int behave, animate; float para; int life, colour; //Position and velocity int oldxp, oldyp; float ax, ay, vx, vy; int cx, cy, w, h; float newxp, newyp; bool isplatform; int x1, y1, x2, y2; //Collision Rules int onentity; bool harmful; int onwall, onxwall, onywall; //Platforming specific bool jumping; bool gravity; int onground, onroof; int jumpframe; //Animation int framedelay, drawframe, walkingframe, dir, actionframe; int yp; int xp; };</span></span></code> </pre> <br>  Dieser Klassenkonstruktor sieht folgenderma√üen aus: <br><br><pre> <code class="cpp hljs">entclass::entclass() { clear(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> entclass::clear() { <span class="hljs-comment"><span class="hljs-comment">// Set all values to a default, // required for creating a new entity active = false; invis = false; type = 0; size = 0; tile = 0; rule = 0; state = 0; statedelay = 0; life = 0; colour = 0; para = 0; behave = 0; animate = 0; xp = 0; yp = 0; ax = 0; ay = 0; vx = 0; vy = 0; w = 16; h = 16; cx = 0; cy = 0; newxp = 0; newyp = 0; x1 = 0; y1 = 0; x2 = 320; y2 = 240; jumping = false; gravity = false; onground = 0; onroof = 0; jumpframe = 0; onentity = 0; harmful = false; onwall = 0; onxwall = 0; onywall = 0; isplatform = false; framedelay = 0; drawframe = 0; walkingframe = 0; dir = 0; actionframe = 0; }</span></span></code> </pre> <br>  Ziemlich viele Felder, sagst du nicht?  Es ist kein Wunder, dass PVS-Studio eine Warnung f√ºr einen Fehler ausgegeben hat, die sich hier versteckt: <br><br>  <a href="https://www.viva64.com/en/w/v730/">V730</a> Es ist m√∂glich, dass nicht alle Member einer Klasse im Konstruktor initialisiert werden.  Betrachten Sie die √úberpr√ºfung: oldxp, oldyp.  Ent.cpp 3 <br><br>  Wie Sie sehen, gingen in einer so langen Liste zwei Initialisierungen von Klassenfeldern verloren.  Infolgedessen blieben ihre Werte undefiniert, sodass sie falsch gelesen und an anderer Stelle im Programm verwendet werden k√∂nnen.  Es ist sehr schwierig, einen solchen Fehler nur durch √úberpr√ºfung zu erkennen. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/983/5f3/1be/9835f31be343f47654d9dd80fc159472.png" alt="Abbildung 4"></div><br><br><h3>  Warnung 6 </h3><br>  Schau dir diesen Code an: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> mapclass::loadlevel(....) { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; .... tmap = otherlevel.loadlevel(rx, ry, game, obj); fillcontent(tmap); .... <span class="hljs-comment"><span class="hljs-comment">// The tmap vector gets changed again many times. }</span></span></code> </pre> <br>  PVS-Studio Warnung: <a href="https://www.viva64.com/en/w/v688/">V688</a> Die lokale Variable 'tmap' hat denselben Namen wie einer der Klassenmitglieder, was zu Verwirrung f√ºhren kann.  Map.cpp 1192 <br><br>  Tats√§chlich k√∂nnen Sie in der <i>Mapclass-</i> Klasse denselben Vektor mit demselben Namen finden: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mapclass</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeaths; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; roomdeathsfinal; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; areamap; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; contents; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; explored; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; vmult; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; tmap; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... };</span></span></code> </pre> <br>  Leider macht die gleichnamige Vektordeklaration innerhalb der Funktion den in der Klasse deklarierten Vektor unsichtbar.  In stellt sich heraus, dass der <i>tmap-</i> Vektor nur innerhalb der <i>loadlevel-</i> Funktion <i>ge√§ndert</i> wird.  Der in der Klasse deklarierte Vektor bleibt gleich! <br><br>  Interessanterweise hat PVS-Studio 20 solcher Codefragmente gefunden!  Zum gr√∂√üten Teil beziehen sie sich auf tempor√§re Variablen, die aus Gr√ºnden der Bequemlichkeit als Klassenmitglieder deklariert wurden.  Der Spieleautor (und sein einziger Entwickler) schrieb √ºber sich, dass er diese schlechte Angewohnheit hatte.  Sie k√∂nnen dar√ºber in der Post lesen - der Link ist am Anfang des Artikels angegeben. <br><br>  Er bemerkte auch, dass solche Namen zu sch√§dlichen Fehlern f√ºhrten, die schwer zu entdecken waren.  Solche Fehler k√∂nnen sehr zerst√∂rerisch sein, aber wenn Sie statische Analysen verwenden, wird es weniger schwierig, sie zu finden :) <br><br><h3>  Warnung 7 </h3><br>  <a href="https://www.viva64.com/en/w/v601/">V601</a> Der Integer-Typ wird implizit in den Zeichen-Typ umgewandelt.  Game.cpp 4997 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Game::loadquick(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"totalflips"</span></span>) { totalflips = atoi(pText); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pKey == <span class="hljs-string"><span class="hljs-string">"hardestroom"</span></span>) { hardestroom = atoi(pText); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else if (pKey == "hardestroomdeaths") { hardestroomdeaths = atoi(pText); } .... }</span></span></code> </pre> <br>  Werfen wir einen Blick auf die Definitionen der Variablen aus dem angegebenen Teil des Codes, um zu verstehen, was los ist: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//Some stats: int totalflips; std::string hardestroom; int hardestroomdeaths;</span></span></code> </pre> <br>  <i>totalflips-</i> und <i>hardestroomdeaths-</i> Variablen sind Ganzzahlen, daher ist es ganz normal, ihnen das Ergebnis der <i>atoi-</i> Funktion <i>zuzuweisen</i> .  Aber was passiert, wenn Sie <i>std :: string</i> einen ganzzahligen Wert zuweisen?  Eine solche Zuordnung erweist sich aus sprachlicher Sicht als g√ºltig.  Dadurch wird ein unklarer Wert in die Variable <i>hardestroom geschrieben</i> ! <br><br><h3>  Warnung 8 </h3><br>  <a href="https://www.viva64.com/en/w/v1004/">V1004</a> Der Zeiger 'pElem' wurde unsicher verwendet, nachdem er gegen nullptr verifiziert wurde.  √úberpr√ºfen Sie die Zeilen: 1739, 1744. editor.cpp 1744 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> editorclass::load(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> &amp;_path) { .... <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hDoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;doc)</span></span></span></span>; TiXmlElement *pElem; <span class="hljs-function"><span class="hljs-function">TiXmlHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; version = <span class="hljs-number"><span class="hljs-number">0</span></span>; { pElem = hDoc.FirstChildElement().Element(); <span class="hljs-comment"><span class="hljs-comment">// should always have a valid root // but handle gracefully if it does if (!pElem) { printf("No valid root! Corrupt level file?\n"); } pElem-&gt;QueryIntAttribute("version", &amp;version); // &lt;= // save this for later hRoot = TiXmlHandle(pElem); } .... }</span></span></code> </pre> <br>  Der Analysator warnt, dass der <i>pElem-</i> Zeiger unmittelbar nach seiner √úberpr√ºfung auf <i>nullptr nicht sicher verwendet wird</i> .  √úberpr√ºfen Sie die Definition der <i>Element ()</i> -Funktion, die den Wert zur√ºckgibt, der <i>wiederum</i> den <i>pElem-</i> Poiter initialisiert, um sicherzustellen, dass der Analysator richtig ist: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** @deprecated use ToElement. Return the handle as a TiXmlElement. This may return null. */</span></span> <span class="hljs-function"><span class="hljs-function">TiXmlElement *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Element</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ToElement(); }</code> </pre> <br>  Wie wir dem Kommentar entnehmen k√∂nnen, gibt diese Funktion m√∂glicherweise <i>null zur√ºck</i> . <br><br>  Nun stell dir vor, dass es wirklich passiert ist.  Was wird in diesem Fall passieren?  Tatsache ist, dass diese Situation in keiner Weise behandelt wird.  Ja, es wird eine Meldung angezeigt, dass ein Fehler aufgetreten ist, aber der falsche Zeiger wird nur eine Zeile darunter dereferenziert.  Eine solche Dereferenzierung f√ºhrt entweder zum Absturz des Programms oder zu undefiniertem Verhalten.  Dies ist ein ziemlich schwerwiegender Fehler. <br><br><h3>  Warnung 9 </h3><br>  Dieses Codefragment l√∂ste vier Warnungen des PVS-Studio-Analysators aus: <br><br><ul><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Ein Teil des bedingten Ausdrucks ist immer wahr: x&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Ein Teil des bedingten Ausdrucks ist immer wahr: y&gt; = 0. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Ein Teil des bedingten Ausdrucks ist immer wahr: x &lt;40. editor.cpp 1137 </li><li>  <a href="https://www.viva64.com/en/w/v560/">V560</a> Ein Teil des bedingten Ausdrucks ist immer wahr: y &lt;30. editor.cpp 1137 </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> editorclass::at( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">0</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(<span class="hljs-number"><span class="hljs-number">39</span></span>,y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(y&gt;=<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> at(x,<span class="hljs-number"><span class="hljs-number">29</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; y&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; x&lt;<span class="hljs-number"><span class="hljs-number">40</span></span> &amp;&amp; y&lt;<span class="hljs-number"><span class="hljs-number">30</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> contents[x+(levx*<span class="hljs-number"><span class="hljs-number">40</span></span>)+vmult[y+(levy*<span class="hljs-number"><span class="hljs-number">30</span></span>)]]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Alle Warnungen beziehen sich auf die letzte <i>if-</i> Anweisung.  Das Problem ist, dass alle vier darin durchgef√ºhrten Pr√ºfungen immer <i>true zur√ºckgeben</i> .  Ich w√ºrde nicht sagen, dass es ein schwerwiegender Fehler ist, aber es ist ziemlich lustig.  Der Autor hat sich entschlossen, diese Funktion ernst zu nehmen und f√ºr alle F√§lle jede Variable erneut zu pr√ºfen :) <br><br>  Er h√§tte diese Pr√ºfung entfernen k√∂nnen, da der Ausf√ºhrungsablauf sowieso nicht zum Ausdruck " <i>return 0;</i> "  Es √§ndert nichts an der Programmlogik, hilft aber dabei, redundante Pr√ºfungen und toten Code loszuwerden. <br><br><h3>  Warnung 10 </h3><br>  In seinem Artikel zum Jubil√§um des Spiels bemerkte Terry ironischerweise, dass eines der Elemente, die die Logik des Spiels kontrollierten, der gro√üe Wechsel von der Funktion <i>Game :: updatestate () war</i> , die gleichzeitig f√ºr eine gro√üe Anzahl verschiedener <i>Spielzust√§nde</i> verantwortlich war .  Und es wurde ziemlich erwartet, dass ich die folgende Warnung finden w√ºrde: <br><br>  <a href="https://www.viva64.com/en/w/v2008/">V2008 Cyclomatic</a> Complexity: 548. √úberlegen Sie, ob Sie die Funktion 'Game :: updatestate' √ºberarbeiten m√∂chten.  Game.cpp 612 <br><br>  Ja, Sie haben es richtig verstanden: PVS-Studio gab der Funktion die folgende Komplexit√§tsbewertung - 548. F√ºnfhundertachtundvierzig !!!  So sieht der "nette Code" aus.  Und das trotz der Tatsache, dass au√üer der switch-Anweisung fast nichts anderes in der Funktion ist.  Im Switch selbst habe ich mehr als 300 case-expressions gez√§hlt. <br><br>  Sie wissen, in unserer Firma gibt es einen kleinen Wettbewerb um den l√§ngsten Artikel.  Ich w√ºrde gerne den gesamten Funktionscode (3.450 Zeilen) hierher bringen, aber ein solcher Gewinn w√§re unfair, also beschr√§nke ich mich nur auf den <a href="">Link</a> zum Riesenschalter.  Ich empfehle Ihnen, dem Link zu folgen und seine L√§nge selbst zu sehen!  Aus diesem <i>Grund</i> hat PVS-Studio neben <i>Game :: updatestate ()</i> auch 44 Funktionen mit √ºberh√∂hter zyklomatischer Komplexit√§t gefunden, von denen 10 eine Komplexit√§tszahl von mehr als 200 hatten. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddb/a63/bac/ddba63bac1b88d806adea03d73b70888.png" alt="Abbildung 5"></div><br><br><h2>  Fazit </h2><br>  Ich denke die obigen Fehler reichen f√ºr diesen Artikel aus.  Ja, es gab viele Fehler im Projekt, aber es ist eine Art Feature.  Als Terry Cavanagh seinen Code √∂ffnete, zeigte er, dass man kein perfekter Programmierer sein muss, um ein gro√üartiges Spiel zu schreiben.  Jetzt, 10 Jahre sp√§ter, erinnert sich Terry ironisch an diese Zeiten.  Es ist wichtig, aus Ihren Fehlern zu lernen, und √úbung ist der beste Weg, dies zu tun.  Und wenn dein Training zu einem Spiel wie VVVVVV f√ºhren kann, ist es einfach gro√üartig!  Nun ... es ist h√∂chste Zeit, es noch einmal zu spielen :) <br><br>  Dies waren nicht alle Fehler, die im Spielcode gefunden wurden.  Wenn Sie selbst sehen m√∂chten, was sonst noch zu finden ist, empfehlen wir Ihnen <a href="https://www.viva64.com/en/pvs-studio-download/">, PVS-Studio herunterzuladen und zu testen.</a>  Vergessen Sie auch nicht, dass wir Open Source-Projekte mit kostenlosen Lizenzen versehen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de484388/">https://habr.com/ru/post/de484388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de484376/index.html">Samsung Moskauer Zentrum f√ºr K√ºnstliche Intelligenz in Mitarbeitergeschichten</a></li>
<li><a href="../de484378/index.html">SwayWM - UnixPorn Yourself</a></li>
<li><a href="../de484380/index.html">Umzug - das letzte Jahrhundert! Alternativen zu std :: move in ‚ÄûC ++ der Zukunft‚Äú</a></li>
<li><a href="../de484382/index.html">Bellman-Ford-Algorithmus</a></li>
<li><a href="../de484386/index.html">AWS_Ru Meetup bei der Raiffeisenbank</a></li>
<li><a href="../de484390/index.html">Einblicke in die 18 besten Java-Frameworks f√ºr 2020</a></li>
<li><a href="../de484392/index.html">Anf√§lle</a></li>
<li><a href="../de484394/index.html">Sieben aufregendste Weltraummissionen des kommenden Jahres</a></li>
<li><a href="../de484396/index.html">Windows Server sicherer machen</a></li>
<li><a href="../de484402/index.html">Clean Code f√ºr TypeScript - Teil 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>