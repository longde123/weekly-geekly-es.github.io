<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë©üèª üõÄüèª üêä Extens√£o PHP e Kotlin Native. Parte tr√™s, provavelmente final üçÄ üç£ üë©üèº‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Na primeira parte , s√£o contadas coisas bastante b√°sicas sobre a configura√ß√£o de ferramentas e conceitos gerais. 

 A segunda parte √© sobre, por assim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Extens√£o PHP e Kotlin Native. Parte tr√™s, provavelmente final</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/alfa/blog/423145/"><img align="right" src="https://habrastorage.org/webt/o7/db/cw/o7dbcwsbe8kad4jkw84guc_2n4m.png">  Na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira parte</a> , s√£o contadas coisas bastante b√°sicas sobre a configura√ß√£o de ferramentas e conceitos gerais. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A segunda parte √©</a> sobre, por assim dizer, a primeira abordagem ao proj√©til, id√©ias, planos, planos. <br><br>  Neste artigo, haver√° um pouco mais de explica√ß√µes sobre o interope C e K / N, muitas macros, dor, desesperan√ßa e "raios de bondade".  √â claro que haver√° um cap√≠tulo com uma hist√≥ria sobre conquistas (voc√™ n√£o se elogiar√° ... e, como b√¥nus, uma hist√≥ria sobre um fakap √©pico. <br><a name="habracut"></a><br>  <b>Isen√ß√£o de responsabilidade:</b> todos os itens a seguir s√£o considerados no contexto da cria√ß√£o de uma biblioteca para PHP. <br><br><h2>  Cap√≠tulo Um  Interope ing√™nuo </h2><br>  Como usar as fun√ß√µes K / N em C √© descrito na primeira parte do ciclo.  Portanto, aqui vou lhe dizer como usar as fun√ß√µes C em K / N. <br><br>  <a href="">A documenta√ß√£o oficial √©</a> bastante mesquinha e concisa, no entanto, para projetos simples, √© suficiente. <br><br>  Em resumo, voc√™ precisa criar um arquivo especial com a extens√£o <b>.def</b> e especificar os arquivos de cabe√ßalho necess√°rios. <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">headers</span></span> = php.h</code> </pre> <br>  Em seguida, alimente-o com um programa chamado <b>cinterop</b> . <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># cinterop -def php.def -o php</span></span></code> </pre><br>  Na sa√≠da, voc√™ obter√° a biblioteca libphp.klib que cont√©m o c√≥digo de bit llvm e v√°rias meta-informa√ß√µes. <br><br>  Em seguida, voc√™ pode usar com seguran√ßa as fun√ß√µes e macros descritas no arquivo de cabe√ßalho ( <code>#define</code> ), sem esquecer de conectar a biblioteca no est√°gio de compila√ß√£o. <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># kotlinc -opt -produce static ${SOURCES} -l libphp.klib -o myLib</span></span></code> </pre><br>  Mas h√° uma nuance.  E n√£o um. <br><br><h3>  Na forma descrita acima, a biblioteca n√£o ser√° montada </h3><br>  Porque  Mas porque as seguintes linhas est√£o presentes no php.h: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_version.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend_sort.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_compat.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"zend_API.h"</span></span></span></span></code> </pre><br>  Aqui deve-se notar que o llvm ainda est√° envolvido na compila√ß√£o da biblioteca e possui a <b>op√ß√£o -I</b> e o cinterop tem a <b>op√ß√£o -copt</b> .  Bem, voc√™ entendeu.  Como resultado, esse comando √© suficiente para compilar o <b>php.h.</b> <br><br><pre> <code class="hljs mel"># cinterop -def my.def -o myLib -I${PHP_LIB_ROOT} -copt -I${PHP_LIB_ROOT} \ -copt -I${PHP_LIB_ROOT}/main \ -copt -I${PHP_LIB_ROOT}/Zend \ -copt -I${PHP_LIB_ROOT}/TSRM</code> </pre><br><h3>  Macros.  Eu te amo e odeio!  N√£o, eu odeio isso. </h3><br>  Tudo que voc√™ precisa saber sobre <code>#define</code> em termos de inter&gt; C / K / N √© <br><blockquote>  Toda macro C que se expande para uma constante √© representada como propriedade Kotlin.  Outras macros n√£o s√£o suportadas. </blockquote><br>  E ent√£o lembramos que a extens√£o PHP √© uma macro em uma macro e aciona uma macro e tenta n√£o chorar. <br><br>  Mas nem tudo √© t√£o ruim.  Para contornar essa situa√ß√£o, os desenvolvedores de K / N forneceram um rolo de fita el√©trica azul para anexar ao arquivo def de <b>declara√ß√µes personalizadas</b> .  Parece com isso (por exemplo, pegue a macro <code>Z_TYPE_P</code> ) <br><br><pre> <code class="cpp hljs">headers = php.h --- <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> zend_uchar __zp_get_arg_type(zval *z_value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Z_TYPE_P(z_value); }</code> </pre> <br>  Agora, no c√≥digo K / N, ser√° poss√≠vel usar a fun√ß√£o <code>__zp_get_arg_type</code> <br><br><h2>  Cap√≠tulo Dois  Configura√ß√µes INI do PHP ou uma macro sub-sub. </h2><br>  Este √© um "raio do bem" para o c√≥digo fonte do PHP. <br><br>  Existem 4 macros para extrair configura√ß√µes: <br><br><pre> <code class="cpp hljs">INI_INT(val) INI_FLT(val) INI_STR(val) INI_BOOL(val)</code> </pre><br>  Onde <code>val</code> √© uma sequ√™ncia com o nome da configura√ß√£o. <br><br>  Agora, vejamos o exemplo de <code>INI_STR</code> para ver como essa macro √© definida. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> INI_STR(name) zend_ini_string_ex((name), sizeof(name)-1, 0, NULL)</span></span></code> </pre> <br>  J√° reparou na sua "falha fatal"? <br><br>  Caso contr√°rio, deixe-me dizer: esse √© o <code>sizeof</code> fun√ß√£o.  Quando voc√™ usa a macro diretamente, tudo est√° bem: <br><br><pre> <code class="cpp hljs">php_printf(<span class="hljs-string"><span class="hljs-string">"The value is : %s"</span></span>, INI_STR(<span class="hljs-string"><span class="hljs-string">"my.ini"</span></span>));</code> </pre> <br>  Quando voc√™ o utiliza por meio de uma fun√ß√£o proxy de um arquivo <b>.def</b> , o carro se transforma em ab√≥bora e <b>sizeof (nome)</b> retorna o tamanho do ponteiro.  Xeque-mate Kotlin Native. <br><br>  De fato, existem apenas duas op√ß√µes para contornar. <br><br><ol><li>  N√£o use macros, mas fun√ß√µes √†s quais est√£o anexadas. </li><li>  O inv√≥lucro de c√≥digo r√≠gido funciona para cada configura√ß√£o necess√°ria. </li></ol><br>  A primeira op√ß√£o √© melhor para todos que a segunda, exceto por um ponto - ningu√©m garante que a macro declara√ß√£o n√£o ser√° alterada.  Portanto, para o meu projeto, eu, com um sentimento de profunda insatisfa√ß√£o, escolhi a segunda op√ß√£o. <br><br><h2>  CAP√çTULO TR√äS  Depurar?  Que debag? </h2><br><h3>  Ato 1 - Interoperabilidade. </h3><br>  Em um ponto, depois de anexar a fita azul ao arquivo def de 20 fun√ß√µes de proxy consecutivas, recebi um erro maravilhoso. <br><br><pre> <code class="hljs powershell">Exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> thread <span class="hljs-string"><span class="hljs-string">"main"</span></span> java.lang.Error: /tmp/tmp399964332777824085.c:<span class="hljs-number"><span class="hljs-number">103</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>: error: too many arguments to <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">2</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">have</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">3</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UtilsKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ensureNoCompileErrors</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Utils.kt:137)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexDeclarations</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Indexer.kt:902)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IndexerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildNativeIndexImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Indexer.kt:892)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexer</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeIndexKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildNativeIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NativeIndex.kt:56)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jvm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processCLib</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:283)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">native</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gen</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jvm</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">interop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:38)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cli</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilities</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InteropCompilerKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invokeInterop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InteropCompiler.kt:100)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">org</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jetbrains</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kotlin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cli</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">utilities</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainKt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(main.kt:29)</span></span></span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m_/sg/xb/m_sgxb-qifca4cx1tccuvbxa6ra.png"></div><br>  Comente sobre metade, recompile, se comentar sobre a metade do resto for repetido, coletamos ... E dado que o processo de compila√ß√£o dos cabe√ßalhos √© longo o suficiente ... (sim, parecia mais r√°pido do que subir uma d√∫zia de arquivos de origem e meticulosamente, com uma lupa, reconciliar). <br><br>  O segundo "raio do bem" vai para o JetBrains. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/q0/9u/dd/q09uddpi04rrxoc76xnk5meecow.png"></div><br><h3>  Ato 2 - tempo de execu√ß√£o. </h3><br>  Eu recebo uma <b>falha de segmenta√ß√£o em</b> tempo de execu√ß√£o.  Bem, isso acontece.  Estou subindo no depurador.  Ummm ... STA? <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Program</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">received</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">signal</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SIGSEGV</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Segmentation</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">fault</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">kfun</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:kotlinx.cinterop.toKString</span></span>@<span class="hljs-keyword"><span class="hljs-keyword">kotlinx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">cinterop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">CPointer</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">kotlinx</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">cinterop</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">ByteVarOf</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">kotlin</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Byte</span></span>&gt;&gt;.()<span class="hljs-keyword"><span class="hljs-keyword">kotlin</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">String</span></span> () at /opt/buildAgent/work/<span class="hljs-number"><span class="hljs-number">4</span></span>d622a065c544371/Interop/Runtime/src/main/kotlin/kotlinx/cinterop/Utils.kt:<span class="hljs-number"><span class="hljs-number">402</span></span> <span class="hljs-number"><span class="hljs-number">402</span></span> /opt/buildAgent/work/<span class="hljs-number"><span class="hljs-number">4</span></span>d622a065c544371/Interop/Runtime/src/main/kotlin/kotlinx/cinterop/Utils.kt: No such file or directory.</code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cr/nq/ek/crnqekwr9fheufvuxcc9ixhnsjc.png"></div><br><h2>  Cap√≠tulo Quatro  Coloquei ch√° no seu ch√° para que voc√™ possa tomar ch√° enquanto bebe. </h2><br>  Aqui √© necess√°rio contar como funciona essa porcaria que eu fa√ßo. <br><br>  Voc√™ escreve uma DSL descrevendo a futura extens√£o PHP, escreve c√≥digo K / N com a implementa√ß√£o de fun√ß√µes, classes e m√©todos, executa o <code>make</code> e, milagrosamente, obt√©m uma biblioteca pronta que pode ser conectada ao PHP. <br><br>  A montagem pode ser dividida em 4 etapas: <br><br><ol><li>  Criando uma camada entre C e K / N (a mesma <code>cinterop</code> ) </li><li>  Gera√ß√£o de c√≥digo da extens√£o C </li><li>  Compilando uma Biblioteca com L√≥gica </li><li>  Compilando a biblioteca de destino </li></ol><br>  O objetivo √© adicionar a capacidade de criar inst√¢ncias de uma classe PHP no c√≥digo K / N.  Por exemplo, para que a classe possa definir o m√©todo <code>getInstance()</code> .  E eu quero fazer com que seja conveniente de usar. <br><br>  Em C, esse problema √© resolvido uma ou duas vezes. <br><br><pre> <code class="cpp hljs">zval *obj = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(zval)); object_init_ex(obj, myClass);</code> </pre> <br>  Parece simples - pegue-o e transfira-o para K / N, mas aqui est√° o <code>myClass</code> ... <br><br>  Mas <code>myClass</code> √© uma vari√°vel global do tipo <code>zend_class_entry*</code> , declarada no c√≥digo C do projeto e com um nome desconhecido com anteced√™ncia. <br><br>  Assista suas m√£os.  Voc√™ precisa compilar a biblioteca a partir do c√≥digo K / N, no qual haver√° uma fun√ß√£o que precisa ter acesso ao <code>myClass</code> , definido no c√≥digo C gerado, mas n√£o compilado, a partir do qual essa fun√ß√£o ser√° chamada. <br><br>  Por fim, a implementa√ß√£o dessa funcionalidade levou √† adi√ß√£o de dois novos artefatos: <b>.h</b> e <b>.kt</b> no est√°gio de gera√ß√£o de c√≥digo, complica√ß√£o no est√°gio cinterop e no √©pico phakap, sobre o qual falarei no final. <br><br><h2>  Cap√≠tulo Cinco  O que est√° em meu nome? </h2><br>  O Conto do Porqu√™: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ArgumentType</span></span> { PHP_STRING, PHP_LONG, PHP_DOUBLE, PHP_NULL, ... }</code> </pre> <br>  melhor que: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArgumentType</span></span></span><span class="hljs-class"> {</span></span> STRING, LONG, DOUBLE, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ... }</code> </pre> <br>  Sim, nem √© necess√°rio explicar.  √â isso que <code>ArgumentType.NULL</code> se transforma no arquivo de cabe√ßalho da biblioteca Kotlin: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> extension_kt_kref_php_extension_dsl_ArgumentType (*get)(); <span class="hljs-comment"><span class="hljs-comment">/* enum entry for NULL. */</span></span> } <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre> <br>  E √© assim que o gcc reage a isso. <br><br><pre> <code class="hljs pgsql">/root/simpleExtension/phpmodule/extension_kt_api.h:<span class="hljs-number"><span class="hljs-number">113</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>: error: expected identifier <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'('</span></span> <span class="hljs-keyword"><span class="hljs-keyword">before</span></span> <span class="hljs-string"><span class="hljs-string">'void'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; ^</code> </pre><br>  A cortina!  Cuidado com os nomes. <br><br><h2>  O pen√∫ltimo cap√≠tulo.  Voc√™ n√£o se louvar√° - ningu√©m louvar√°. </h2><br>  De modo geral, alcancei meus objetivos.  Imerso no assunto, a "estrutura" para escrever extens√µes PHP no Kotlin Native, em geral, est√° pronta.  Resta acrescentar algumas funcionalidades, e n√£o as mais cr√≠ticas, e polimento. <br><br>  O projeto em si e, espero, uma boa documenta√ß√£o, podem ser vistos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no github</a> . <br><br>  O que posso dizer sobre K / N?  Apenas bom.  Escrever sobre isso √© um prazer, e pequenos cardumes e rugosidade podem ser atribu√≠dos ao fato de que ele nem saiu do ber√ßo :) <br><br><h2>  O √∫ltimo cap√≠tulo.  Raios de bom, sem aspas. </h2><br>  E agora, absolutamente s√©rio e com profundo respeito, quero agradecer aos caras do JetBrains e aos residentes do canal folgado do Kotlin Native.  Voc√™ √© super! <br><br>  E um agradecimento especial a <b>Nicholas Igotti</b> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tn/gr/px/tngrpxjotuvwziojqifyaxff5-y.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/d1/5r/sn/d15rsndzgsxzin-aeglanekvtv4.png"></div><br><h2>  B√¥nus  Epic Fakap. </h2><br>  O contexto √© descrito no quarto cap√≠tulo. <br><br>  Na verdade, quando tudo foi adicionado a um estado em que foi compilado sem erros, surgiu um problema - durante o teste, o PHP me abriu de um lado completamente desconhecido. <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># php -dextension=./phpmodule/modules/extension.so -r </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"var_dump(ExampleClass::getInstance());"</span></span></span><span class="hljs-meta"> *RECURSION* #</span></span></code> </pre><br>  "Figas!"  - Pensei, entrei no c√≥digo-fonte PHP e encontrei um peda√ßo desse tipo. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IS_OBJECT: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Z_IS_RECURSIVE_P(struc)) { PUTS(<span class="hljs-string"><span class="hljs-string">"*RECURSION*\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  Adicionando depura√ß√£o: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%u"</span></span>, Z_IS_RECURSIVE_P(struc))</code> </pre> <br>  levou a: <br><br><pre> <code class="hljs pgsql">undefined symbol: Z_IS_RECURSIVE_P <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">Unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  "Figas!"  Pensei de novo. <br><br>  Naquele momento, quando imaginei examinar o php.h (7.1.8) realmente usado no host linux, e n√£o aquele que foi retirado do github do brunch principal (7.3.x), um dia passou.  Em linha reta envergonhado. <br><br>  Mas, como se viu, n√£o era uma bobina. <br><br>  O c√≥digo de verifica√ß√£o de recurs√£o correto, em todas as fases da vida do objeto que eu controlei, relatou que tudo deveria funcionar.  E isso significa que voc√™ deve olhar cuidadosamente para aqueles lugares que eu n√£o controlo.  Havia exatamente uma dessas coisas - na qual meu objeto √© retornado √† fun√ß√£o <code>var_dump</code> <br><br><pre> <code class="cpp hljs">RETURN_OBJ( example_symbols()-&gt;kotlin.root.php.extension.proxy.objectToZval( example_symbols()-&gt;kotlin.root.exampleclass.getInstance(<span class="hljs-comment"><span class="hljs-comment">/* */</span></span>) ) )</code> </pre> <br>  Abra a macro RETURN_OBJ at√© o final.  Tire os monitores nervosos e gr√°vidos! <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">1</span></span>) RETURN_OBJ(r) <span class="hljs-number"><span class="hljs-number">2</span></span>) { RETVAL_OBJ(r); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">3</span></span>) { ZVAL_OBJ(return_value, r); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); Z_OBJ_P(__z) = (r); Z_TYPE_INFO_P(__z) = IS_OBJECT_EX; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">5</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); Z_OBJ(*(__z)) = (r); Z_TYPE_INFO(*(__z)) = (IS_OBJECT | (IS_TYPE_REFCOUNTED &lt;&lt; Z_TYPE_FLAGS_SHIFT)); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-number"><span class="hljs-number">6</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { zval *__z = (return_value); (*(__z)).value.obj = (r); (*(__z)).u1.type_info = (<span class="hljs-number"><span class="hljs-number">8</span></span> | ((<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre> <br>  Aqui, ent√£o, senti vergonha pela segunda vez.  Eu, completamente no meu olho azul, empurrei <code>zval*</code> para onde <code>zend_object*</code> esperando e passei quase dois dias procurando pelo erro. <br><br>  Obrigado a todos Kotlin!  :) <br><br>  PS.  Se existe uma alma bondosa que l√™ meu ingl√™s desajeitado e corrige a documenta√ß√£o - n√£o haver√° limite para minha gratid√£o. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423145/">https://habr.com/ru/post/pt423145/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423135/index.html">Feliz Dia do Programador: v√°rios designers de rob√¥s educacionais para crian√ßas</a></li>
<li><a href="../pt423137/index.html">Extens√µes do navegador GitHub para aumentar sua produtividade</a></li>
<li><a href="../pt423139/index.html">Buraco na cerca, gerentes e engenheiros eficazes</a></li>
<li><a href="../pt423141/index.html">Claude Shannon: como um g√™nio resolve problemas</a></li>
<li><a href="../pt423143/index.html">October Slerm: Intensivo em Kubernetes</a></li>
<li><a href="../pt423147/index.html">Sobre a estrat√©gia e o formato de armazenamento na era Hadoop</a></li>
<li><a href="../pt423149/index.html">Compara√ß√£o direta dos m√©todos de corre√ß√£o da miopia a laser ou o que voc√™ paga ao escolher o ReLEx SMILE</a></li>
<li><a href="../pt423151/index.html">Objetos globais em PHP</a></li>
<li><a href="../pt423153/index.html">Guia do Node.js, parte 2: JavaScript, V8, alguns truques de desenvolvimento</a></li>
<li><a href="../pt423155/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Aula 8: Modelo de Seguran√ßa de Rede, Parte 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>