<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∑üèª üÜé üöÄ Generierung von User Space-Verkehr üë¥ ü•Ç ‚õπüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Verkehrserzeugung durch MoonGen + DPDK + Lua aus Sicht des K√ºnstlers 

 Die Neutralisierung von DDoS-Angriffen unter realen Bedingungen erfordert vorl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Generierung von User Space-Verkehr</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/423957/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/d4/ab/qb/d4abqbslioh-eskinpe4jhet0y4.jpeg"></div><br>  <i>Verkehrserzeugung durch MoonGen + DPDK + Lua aus Sicht des K√ºnstlers</i> <br><br>  Die Neutralisierung von DDoS-Angriffen unter realen Bedingungen erfordert vorl√§ufige Tests und Tests verschiedener Techniken.  Netzwerkger√§te und -software sollten unter k√ºnstlichen Bedingungen getestet werden, die den realen Bedingungen nahe kommen - mit intensiven Verkehrsstr√∂men, die Angriffe simulieren.  Ohne solche Experimente ist es √§u√üerst schwierig, zuverl√§ssige Informationen √ºber die spezifischen Merkmale und Einschr√§nkungen eines komplexen Werkzeugs zu erhalten. <br><br>  In diesem Artikel werden einige der in Qrator Labs verwendeten Methoden zur Generierung von Datenverkehr vorgestellt. <br><br>  <b>WARNUNG</b> <br><br>  Wir empfehlen dem Leser dringend, die genannten Tools nicht zum Angriff auf Objekte mit realer Infrastruktur zu verwenden.  Die Organisation von DoS-Angriffen ist gesetzlich strafbar und kann zu schweren Strafen f√ºhren.  Qrator Labs f√ºhrt alle Tests in einer isolierten Laborumgebung durch. <br><a name="habracut"></a><br><h2>  Modernes technisches Niveau </h2><br>  Eine wichtige Aufgabe in unserem Bereich ist die S√§ttigung der 10G-Ethernet-Schnittstelle mit kleinen Paketen, was die Verarbeitung von 14,88 Mpps (Millionen von Paketen pro Sekunde) impliziert.  Im Folgenden betrachten wir die kleinsten Ethernet-Netzwerkpakete - 64 Byte -, da unser Hauptinteresse darin besteht, die Anzahl der √ºbertragenen Pakete pro Zeiteinheit zu maximieren.  Eine einfache Berechnung zeigt, dass wir nur etwa 67 Nanosekunden haben, um ein solches Paket zu verarbeiten. <br><br>  Nur zum Vergleich: Diese Zeit entspricht in etwa dem, was ein moderner Prozessor ben√∂tigt, um Daten aus dem Speicher abzurufen, wenn der Cache fehlt.  Alles wird noch komplizierter, wenn wir mit 40G- und 100G-Ethernet-Schnittstellen arbeiten und versuchen, diese bis zur Leitungsrate (der maximal m√∂glichen deklarierten Leistung des Netzwerkger√§ts) vollst√§ndig zu s√§ttigen. <br><br>  Da der Datenfluss im Normalfall durch die Anwendung im Benutzerbereich (Userspace) und dann durch den Kernel und schlie√ülich zum Netzwerkcontroller (NIC) geleitet wird, besteht die erste und einfachste Idee darin, die Paketerzeugung direkt im Kernel zu konfigurieren.  Ein Beispiel f√ºr eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">solche L√∂sung</a> ist das Kernmodul <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">pktgen</a> [2].  Mit dieser Methode k√∂nnen Sie die Leistung erheblich verbessern, sind jedoch nicht flexibel genug, da die geringste √Ñnderung des Quellcodes im Kernel zu einem langen Erstellungszyklus, einem Neustart der Kernelmodule oder sogar des gesamten Systems und in der Tat zu Tests f√ºhrt, wodurch die Gesamtproduktivit√§t verringert wird (dh der Programmierer ben√∂tigt mehr Zeit) und Anstrengung). <br><br>  Ein anderer m√∂glicher Ansatz besteht darin, direkten Zugriff vom Benutzerbereich auf die Speicherpuffer des Netzwerkcontrollers zu erhalten.  Dieser Weg ist komplizierter, aber die M√ºhe wert, eine h√∂here Produktivit√§t zu erzielen.  Nachteile sind hohe Komplexit√§t und geringe Flexibilit√§t.  Beispiele f√ºr diesen Ansatz sind <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Netmap</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PF_RING</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">DPDK</a> [4]. <br><br>  Ein weiterer effektiver, wenn auch sehr kostspieliger Weg, um eine hohe Leistung zu erzielen, ist die Verwendung nicht universeller, sondern spezialisierter Ger√§te.  Beispiel: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ixia</a> . <br><br>  Es gibt auch L√∂sungen, die auf DPDK basieren und Skripte verwenden. Dies erh√∂ht die Flexibilit√§t bei der Steuerung der Generatorparameter und erm√∂glicht es Ihnen, die Art der beim Start generierten Pakete zu variieren.  Im Folgenden beschreiben wir unsere eigenen Erfahrungen mit einem dieser Tools - MoonGen. <br><br><h2>  MoonGen-Architektur </h2><br>  Besonderheiten von MoonGen sind: <br><br><ol><li>  Die Verarbeitung von DPDK-Daten im Benutzerbereich ist der Hauptgrund f√ºr den Leistungsgewinn. </li><li>  Lua [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">5</a> ] -Stapel mit einfachen Skripten auf der obersten Ebene und Bindungen an die in C geschriebene DPDK-Bibliothek unten; </li><li>  Dank der JIT-Technologie (just in time) arbeiten Lua-Skripte schnell genug, was den allgemein akzeptierten Vorstellungen √ºber die Effektivit√§t von Skriptsprachen etwas widerspricht. </li></ol><br>  MoonGen kann als Lua-Wrapper um die DPDK-Bibliothek betrachtet werden.  Auf der Ebene der Lua-Benutzeroberfl√§che sind mindestens die folgenden DPDK-Vorg√§nge sichtbar: <br><br><ul><li>  Netzwerkcontroller konfigurieren; </li><li>  Zuweisung und direkter Zugriff auf Pools und Speicherpuffer, die zu Optimierungszwecken in kontinuierlich ausgerichteten Bereichen zugewiesen werden sollten; </li><li>  Direkter Zugriff auf RSS-Warteschlangen von Netzwerkcontrollern; </li><li>  API zur Verwaltung von Rechenabl√§ufen unter Ber√ºcksichtigung der Heterogenit√§t des Speicherzugriffs (NUMA- und CPU-Affinit√§t) [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">12</a> ]. </li></ul><br><img src="https://habrastorage.org/webt/qg/vh/ij/qgvhijgvyv0fe5m9vntekmwggxo.png"><br><br>  MoonGen-Architektur, Schema aus Material [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">1</a> ]. <br><br><h3>  Moongen </h3><br>  MoonGen ist ein Skript-Hochgeschwindigkeitspaketgenerator, der auf der DPDK-Bibliothek basiert.  Lua-Skripte steuern den gesamten Prozess: Das vom Benutzer erstellte Skript ist f√ºr das Erstellen, √Ñndern und Senden von Paketen verantwortlich.  Dank der sehr schnellen LuaJIT- und DPDK-Paketverarbeitungsbibliothek k√∂nnen Sie mit dieser Architektur eine 10-Gigabit-Ethernet-Schnittstelle mit 64-Byte-Paketen mit nur einem Kern der CPU s√§ttigen.  Mit MoonGen k√∂nnen Sie diese Geschwindigkeit auch dann erreichen, wenn das Lua-Skript jedes Paket √§ndert.  Es werden keine Tricks wie die Wiederverwendung des gleichen Puffers des Netzwerkcontrollers verwendet. <br><br>  MoonGen kann auch Pakete empfangen, d. H. √úberpr√ºfen, welche Pakete vom zu testenden System verworfen wurden.  Da der Paketempfang ausschlie√ülich von einem benutzerdefinierten Lua-Skript gesteuert wird, k√∂nnen damit auch komplexere Testskripte erstellt werden.  Sie k√∂nnen beispielsweise zwei Instanzen von MoonGen verwenden, um eine Verbindung untereinander herzustellen.  Eine solche Konfiguration kann insbesondere zum Testen der sogenannten mittleren Boxen (Ger√§te zwischen dem Sende- und Empfangspunkt des Verkehrs), beispielsweise Firewalls, verwendet werden.  MoonGen konzentriert sich auf vier Hauptbereiche: <br><br><ul><li>  Hohe Leistung und Multi-Core-Skalierung: mehr als 20 Millionen Pakete pro Sekunde auf einem einzelnen CPU-Kern; </li><li>  Flexibilit√§t: Jedes Paket wird in Echtzeit basierend auf einem vom Benutzer erstellten Lua-Skript generiert. </li><li>  Genaue Zeitstempel: Bei normaler (Standard-) Hardware wird die Zeitmarkierung mit Millisekundengenauigkeit durchgef√ºhrt. </li><li>  Genaue Kontrolle der Intervalle zwischen gesendeten Paketen: zuverl√§ssige Erzeugung der erforderlichen Muster und Verkehrstypen auf normaler Hardware. </li></ul><br><h3>  DPDK </h3><br>  DPDK steht f√ºr Data Plane Development Kit und besteht aus Bibliotheken, deren Hauptfunktionen darin bestehen, die Leistung beim Generieren von Netzwerkpaketen auf einer Vielzahl von Zentralprozessorarchitekturen zu steigern. <br><br>  In einer Welt, in der Computernetzwerke zur Grundlage menschlicher Kommunikation werden, werden Leistung, Bandbreite und Latenz zunehmend zu kritischen Parametern f√ºr Systeme wie drahtlose Netzwerke und Kabelinfrastruktur, einschlie√ülich aller ihrer einzelnen Komponenten: Router, Load Balancer, Firewalls;  sowie Anwendungsbereiche: Medientransfer (Streaming), VoIP usw. <br><br>  DPDK ist eine einfache und bequeme M√∂glichkeit, Tests und Skripte zu erstellen.  Die Daten√ºbertragung innerhalb des Benutzerraums wird nicht so h√§ufig beobachtet, haupts√§chlich weil die meisten Anwendungen √ºber das Betriebssystem und den Kernel-Stack mit Netzwerkger√§ten kommunizieren, was das Gegenteil des DPDK-Modells ist. <br><br><h3>  Lua </h3><br>  Der Hauptzweck der Existenz von Lua besteht darin, einfache und flexible Ausdruckswerkzeuge bereitzustellen, die f√ºr bestimmte aktuelle Aufgaben erweiterbar sind, anstatt einer Reihe von Grundelementen, die nur in einem Programmierparadigma anwendbar sind.  Infolgedessen ist die Basissprache sehr leicht - der gesamte Interpreter ben√∂tigt nur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">180 kB</a> in kompilierter Form und passt sich problemlos an eine Vielzahl m√∂glicher Implementierungen an. <br><br>  Lua ist eine dynamische Sprache.  Es ist so kompakt, dass es auf fast jedem Ger√§t platziert werden kann.  Lua unterst√ºtzt eine kleine Reihe von Typen: Boolesche Werte, Zahlen (Gleitkomma mit doppelter Genauigkeit) und Zeichenfolgen.  Herk√∂mmliche Datenstrukturen wie Arrays, Mengen und Listen k√∂nnen durch die einzige in Lua integrierte Datenstruktur dargestellt werden - eine Tabelle, die ein heterogenes assoziatives Array ist. <br><br>  Lua verwendet die JIT-Kompilierung (just in time) und zeigt daher als Skriptsprache eine Leistung, die mit kompilierten Sprachen wie C vergleichbar ist [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">10</a> ]. <br><br><h2>  Warum Moongen? </h2><br>  Als Unternehmen, das sich auf die Neutralisierung von DDoS-Angriffen spezialisiert hat, ben√∂tigt Qrator Labs eine zuverl√§ssige Methode zum Erstellen, Aktualisieren und Testen eigener Sicherheitsl√∂sungen.  F√ºr letztere Tests werden verschiedene Methoden zur Generierung von Datenverkehr ben√∂tigt, die echte Angriffe simulieren.  Es ist jedoch nicht so einfach, einen gef√§hrlichen, aber unkomplizierten Hochwasserangriff auf 2-3 Ebenen des OSI-Modells zu simulieren, vor allem aufgrund der Schwierigkeiten, eine hohe Leistung bei der Paketerzeugung zu erzielen. <br><br>  Mit anderen Worten, f√ºr ein Unternehmen, das sich mit der kontinuierlichen Verf√ºgbarkeit und Neutralisierung von DDoS befasst, ist die Simulation verschiedener DoS-Angriffe in einer isolierten Laborumgebung eine M√∂glichkeit zu verstehen, wie sich die verschiedenen Ger√§te, die Teil der Hardwarekomplexe des Unternehmens sind, in der Realit√§t verhalten. <br><br>  MoonGen ist eine gute M√∂glichkeit, mit einem Minimum an CPU-Kernen Verkehrswerte zu generieren, die nahe am Grenzwert f√ºr den Netzwerkcontroller liegen.  Die Daten√ºbertragung innerhalb des Benutzerraums verbessert die Leistung des betreffenden Stapels (MoonGen + DPDK) im Vergleich zu vielen anderen Optionen zum Generieren hoher Verkehrswerte erheblich.  Die Verwendung von reinem DPDK erfordert viel mehr Aufwand, daher sollten Sie sich nicht √ºber unseren Wunsch wundern, die Leistung zu optimieren.  Wir unterst√ºtzen auch einen Klon [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">7</a> ] des urspr√ºnglichen MoonGen-Repositorys, um die Funktionalit√§t und Implementierung unserer eigenen Tests zu erweitern. <br><br>  Um maximale Flexibilit√§t zu erreichen, wird die Logik zum Generieren von Paketen vom Benutzer mithilfe des Lua-Skripts festgelegt, das eine der Hauptfunktionen von MoonGen ist.  Bei einer relativ einfachen Paketverarbeitung arbeitet diese L√∂sung schnell genug, um die 10G-Schnittstelle auf einem einzelnen CPU-Kern zu s√§ttigen.  Eine typische M√∂glichkeit, eingehende Pakete zu √§ndern und neue zu erstellen, besteht darin, mit Paketen desselben Typs zu arbeiten, in denen sich nur einige Felder √§ndern. <br><br>  Ein Beispiel ist der unten beschriebene l3-tcp-syn-ack-Flut-Test.  Beachten Sie, dass jede √Ñnderung des Pakets in demselben Puffer vorgenommen werden kann, in dem sich das im vorherigen Schritt generierte oder empfangene Paket herausgestellt hat.  In der Tat werden solche Paketkonvertierungen sehr schnell durchgef√ºhrt, da sie keine teuren Vorg√§nge wie Systemaufrufe, Zugriff auf m√∂glicherweise nicht zwischengespeicherte Speicherabschnitte und dergleichen beinhalten. <br><br><h2>  Tests auf Qrator Labs-Hardware </h2><br>  Qrator Labs f√ºhrt alle Tests im Labor an verschiedenen Ger√§ten durch.  In diesem Fall haben wir die folgenden Netzwerkschnittstellen-Controller verwendet: <br><br><ul><li>  Intel 82599ES 10G </li><li>  Mellanox ConnectX-4 40G </li><li>  Mellanox ConnectX-5 100G </li></ul><br>  Wir stellen separat fest, dass bei der Arbeit mit Netzwerkcontrollern, die mit Standards √ºber 10 G arbeiten, das Leistungsproblem immer akuter wird.  Heute ist es nicht m√∂glich, die 40G-Schnittstelle mit einem Kern zu s√§ttigen, obwohl dies mit einer kleinen Anzahl von Kernen bereits realistisch ist. <br><br>  Bei von Mellanox hergestellten Netzwerkcontrollern k√∂nnen einige Parameter und Einstellungen des Ger√§ts mithilfe der vom Hersteller bereitgestellten Tuning-Anleitung [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">3</a> ] ge√§ndert werden.  Auf diese Weise k√∂nnen Sie die Leistung steigern und in einigen besonderen F√§llen das Verhalten der Netzwerkkarte vertiefen.  Andere Hersteller verf√ºgen m√∂glicherweise √ºber √§hnliche Dokumente f√ºr ihre eigenen Hochleistungsger√§te, die f√ºr den professionellen Gebrauch bestimmt sind.  Auch wenn Sie ein solches Dokument nicht √∂ffentlich finden k√∂nnen, ist es immer sinnvoll, sich direkt an den Hersteller zu wenden.  In unserem Fall waren die Vertreter von Mellanox sehr nett und beantworteten neben der Dokumentation schnell unsere Fragen, wodurch wir eine 100% ige Auslastung des Streifens erreichen konnten, was f√ºr uns sehr wichtig war. <br><br><h3>  TCP SYN Fluttest </h3><br>  L3-tcp-syn-ack-Flut ist ein Beispiel f√ºr die Simulation eines Angriffs wie SYN-Flut [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">6</a> ].  Dies ist eine erweiterte Qrator Labs-Version des l3-tcp-syn-Flood-Tests aus dem Haupt-Repository von MoonGen, das in unserem Repository-Klon gespeichert ist. <br><br>  Unser Test kann drei Arten von Prozessen ausf√ºhren: <br><br><ol><li>  Generieren Sie einen TCP-SYN-Paketstrom von Grund auf neu, indem Sie die erforderlichen Felder wie Quell-IP-Adresse, Quellportnummer usw. variieren. </li><li>  Erstellen Sie eine g√ºltige ACK-Antwort f√ºr jedes empfangene SYN-Paket gem√§√ü TCP. </li><li>  Erstellen Sie eine g√ºltige SYN-ACK-Antwort f√ºr jedes empfangene ACK-Paket gem√§√ü dem TCP-Protokoll. </li></ol><br>  Die interne (bzw. die "hei√üeste") Codeschleife zum Erstellen von ACK-Antworten lautet beispielsweise wie folgt: <br><br><pre><code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tx = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> rx = rxQ:recv(rxBufs) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>, rx <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> buf = rxBufs[i] <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> pkt = buf:getTcpPacket(ipv4) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> pkt.ip4:getProtocol() == ip4.PROTO_TCP <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> pkt.tcp:getSyn() <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (pkt.tcp:getAck() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> synack) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> seq = pkt.tcp:getSeqNumber() <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ack = pkt.tcp:getAckNumber() pkt.tcp:unsetSyn() pkt.tcp:setAckNumber(seq+<span class="hljs-number"><span class="hljs-number">1</span></span>) pkt.tcp:setSeqNumber(ack) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tmp = pkt.ip4.src:get() pkt.ip4.src:set(pkt.ip4.dst:get()) pkt.ip4.dst:set(tmp) ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment">-- some more manipulations with packet fields tx = tx + 1 txBufs[tx] = buf end end if tx &gt; 0 then txBufs:resize(tx) txBufs:offloadTcpChecksums(ipv4) -- offload checksums to NIC txQ:send(txBufs) end</span></span></code> </pre> <br>  Die allgemeine Idee zum Erstellen eines Antwortpakets lautet wie folgt.  Zuerst m√ºssen Sie das Paket aus der Empfangswarteschlange entfernen und dann pr√ºfen, ob der Pakettyp mit dem erwarteten √ºbereinstimmt.  Bereiten Sie im Falle eines Zufalls eine Antwort vor, indem Sie einige Felder des Originalpakets √§ndern.  F√ºgen Sie das erstellte Paket schlie√ülich mit demselben Puffer in die TX-Warteschlange ein.  Um die Leistung zu verbessern, anstatt Pakete einzeln zu nehmen und einzeln zu √§ndern, aggregieren wir sie, extrahieren alle verf√ºgbaren Pakete aus der Empfangswarteschlange, erstellen die entsprechenden Antworten und stellen sie alle in die TX-Warteschlange.  Trotz einer relativ gro√üen Anzahl von Manipulationen an einem Paket bleibt die Leistung hoch, haupts√§chlich aufgrund der Tatsache, dass Lua JIT all diese Operationen in einer kleinen Anzahl von Prozessoranweisungen kompiliert.  Viele andere Tests, nicht nur TCP SYN / ACK, arbeiten nach dem gleichen Prinzip. <br><br>  Die folgende Tabelle zeigt die Ergebnisse des SYN-Fluttests (SYN-Generierung ohne Antwortversuche) mit Mellanox ConnectX-4.  Diese Netzwerkkarte verf√ºgt √ºber zwei 40G-Ports mit einer theoretischen Leistungsobergrenze von 59,52 Mpps an einem Port und 2 * 50 Mpps f√ºr zwei Ports.  Die spezifische Implementierung des Verbindens der Netzwerkkarte mit PCIe schr√§nkt die Bandbreite etwas ein (2 * 50 anstelle der erwarteten 2 * 59,52). <br><table><tbody><tr><td>  <b>Kerne pro Port</b> </td><td>  <b>1 Port, Mpps</b> </td><td>  <b>2 Ports, Mpps pro Port</b> </td></tr><tr><td>  1 </td><td>  20 </td><td>  19 </td></tr><tr><td>  2 </td><td>  38 </td><td>  36 </td></tr><tr><td>  3 </td><td>  56,5 </td><td>  47 </td></tr><tr><td>  4 </td><td>  59,5 </td><td>  50 </td></tr></tbody></table><br>  <i>SYN-Hochwassertest;</i>  <i>Netzwerkkarte: Mellanox Technologies MT27700-Familie (ConnectX-4), dualer 40G-Port;</i>  <i>CPU: Intel¬Æ Xeon¬Æ Silver 4114 CPU bei 2,20 GHz</i> <br><br>  Die folgende Tabelle zeigt die Ergebnisse des gleichen SYN-Fluttests, der an einem Mellanox ConnectX-5 mit einem 100G-Port durchgef√ºhrt wurde. <br><table><tbody><tr><td>  <b>Kerne</b> </td><td>  <b>Mpps</b> </td></tr><tr><td>  1 </td><td>  35 </td></tr><tr><td>  2 </td><td>  69 </td></tr><tr><td>  3 </td><td>  104 </td></tr><tr><td>  4 </td><td>  127 </td></tr><tr><td>  5 </td><td>  120 </td></tr><tr><td>  6 </td><td>  131 </td></tr><tr><td>  7 </td><td>  132 </td></tr><tr><td>  8 </td><td>  144 </td></tr></tbody></table><br>  <i>SYN-Hochwassertest;</i>  <i>Netzwerkkarte: Mellanox Technologies MT27800-Familie (ConnectX-5), einzelner 100G-Port;</i>  <i>CPU: Intel¬Æ Xeon¬Æ Silver 4114 CPU bei 2,20 GHz</i> <br><br>  Beachten Sie, dass wir in allen F√§llen mehr als 96% der theoretischen Leistungsobergrenze f√ºr eine kleine Anzahl von Prozessorkernen erreichen. <br><br><h3>  Erfassen Sie eingehenden Datenverkehr und speichern Sie ihn in PCAP-Dateien </h3><br>  Ein weiteres Beispiel f√ºr den Test ist rx-to-pcap, bei dem versucht wird, den gesamten eingehenden Datenverkehr zu erfassen und in einer bestimmten Anzahl von PCAP-Dateien zu speichern [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">8</a> ].  Obwohl dieser Test nicht speziell die Generierung von Paketen als solche betrifft, dient er als Beweis daf√ºr, dass das Dateisystem das schw√§chste Glied bei der Organisation der Daten√ºbertragung √ºber den Benutzerbereich ist.  Selbst das virtuelle Dateisystem von tmpfs verlangsamt den Stream erheblich.  In diesem Fall werden 8 Kerne des Zentralprozessors f√ºr die Nutzung von 14,88 Mpps ben√∂tigt, w√§hrend nur ein Kern ausreicht, um dieselbe Menge an Datenverkehr zu empfangen (und zur√ºckzusetzen oder umzuleiten). <br><br>  Die folgende Tabelle zeigt den Datenverkehr (in Mpps), der empfangen und in PCAP-Dateien gespeichert wurde, die sich im ext2-Dateisystem auf der SSD (zweite Spalte) oder im tmpfs-Dateisystem (dritte Spalte) befinden. <br><table><tbody><tr><td>  <b>Kerne</b> </td><td>  <b>auf SSD, Mpps</b> </td><td>  <b>auf tmpfs, Mpps</b> </td></tr><tr><td>  1 </td><td>  1.48 </td><td>  1,62 </td></tr><tr><td>  2 </td><td>  4 </td><td>  4.6 </td></tr><tr><td>  3 </td><td>  6.94 </td><td>  8.1 </td></tr><tr><td>  4 </td><td>  9,75 </td><td>  11.65 </td></tr><tr><td>  5 </td><td>  12.1 </td><td>  13.8 </td></tr><tr><td>  6 </td><td>  13.38 </td><td>  14.47 </td></tr><tr><td>  7 </td><td>  14.4 </td><td>  14.86 </td></tr><tr><td>  8 </td><td>  14.88 </td><td>  14.88 </td></tr></tbody></table><br>  <i>Rx-to-pcap-Test;</i>  <i>Netzwerkkarte: Intel 82599ES 10-Gigabit;</i>  <i>CPU: Intel¬Æ Xeon¬Æ CPU E5-2683 v4 bei 2,10 GHz</i> <br><br><h2>  MoonGen-√Ñnderung: tman Task Manager </h2><br>  Wir m√∂chten dem Leser auch unsere eigene Erweiterung der MoonGen-Funktionalit√§t vorstellen, die eine weitere M√∂glichkeit bietet, eine Gruppe von Aufgaben zum Testen zu starten.  Die Hauptidee hierbei ist es, die allgemeine Konfiguration und die Einstellungen f√ºr jede Aufgabe zu trennen, sodass Sie eine beliebige Anzahl verschiedener Aufgaben (d. H. Lua-Skripte) gleichzeitig ausf√ºhren k√∂nnen.  In unserem Klon des MoonGen-Repositorys wird die Implementierung von MoonGen mit dem Task-Manager [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">9</a> ] vorgestellt. Hier werden die Hauptfunktionen nur kurz aufgelistet. <br><br>  √úber die neue Befehlszeilenschnittstelle k√∂nnen Sie mehrere Aufgaben unterschiedlichen Typs gleichzeitig ausf√ºhren.  Das Grundszenario lautet wie folgt: <br><br><pre> <code class="bash hljs">./build/tman [tman options...] [-- &lt;task1-file&gt; [task1 options...]] [-- &lt;task2-file&gt; [task2 options...]] [-- ...]</code> </pre> <br>  Zus√§tzlich bietet ./build/tman -h detaillierte Hilfe. <br><br>  Es gibt jedoch eine Einschr√§nkung: <i>Normale</i> Lua- <i>Jobdateien</i> sind nicht mit der <i>tman-</i> Schnittstelle kompatibel.  Die <i>tman-Jobdatei</i> sollte die folgenden Objekte klar definieren: <br><br><ul><li>  Die Funktion configure (Parser), die die Jobparameter beschreibt. </li><li>  Die Taskfunktion (taskNum, txInfo, rxInfo, args), die den eigentlichen Taskprozess beschreibt.  Hier sind txInfo und rxInfo Arrays von RX- bzw. TX-Warteschlangen;  args enth√§lt die Parameter des Task-Managers und der Task selbst. </li><li>  Beispiele finden Sie in examples / tman. </li></ul><br>  Die Verwendung des Task-Managers bietet Ihnen mehr Flexibilit√§t beim Ausf√ºhren heterogener Tests. <br><br><h3>  Schlussfolgerungen </h3><br>  Die von MoonGen angebotene Methode hat sich als gut f√ºr unsere Ziele erwiesen und die Mitarbeiter mit den erzielten Ergebnissen zufrieden gestellt.  Wir haben ein Tool mit hoher Leistung erhalten, bei dem sowohl die Testumgebung als auch die Sprache recht einfach sind.  Die hohe Leistung dieses Setups wird dank zweier Hauptmerkmale erreicht: direkter Zugriff auf die Puffer der Netzwerkschnittstellen-Controller und Just-In-Time-Kompilierungstechnik in Lua. <br><br>  In der Regel ist das Erreichen einer theoretischen Obergrenze f√ºr die Leistung eines Netzwerkschnittstellen-Controllers eine realisierbare Aufgabe.  Wie wir gezeigt haben, kann ein einzelner Kern ausreichen, um einen 10G-Port zu s√§ttigen, w√§hrend eine volle Auslastung eines 100G-Ports bei einer gr√∂√üeren Anzahl von Kernen kein besonderes Problem darstellt. <br><br>  Wir danken insbesondere dem Mellanox-Team f√ºr die Hilfe bei der Ausr√ºstung und dem MoonGen-Team f√ºr die Reaktion auf die Korrektur der Fehler. <br><br><h2>  Material </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MoonGen: Ein skriptf√§higer Hochgeschwindigkeitspaketgenerator - Paul Emmerich et al., Internet Measurement Conference 2015 (IMC'15), 2015</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pktgen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mellanox Tuning Guide</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Data Plane Development Kit</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lua</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Syn Flut</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Qrator Labs 'Klon des MoonGen-Repositorys</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PCAP-Dateiformat</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Task-Manager</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lua Leistung</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Whitepaper zur Netzwerkfunktionen-Virtualisierung</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NUMA, ungleichm√§√üiger Speicherzugriff</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de423957/">https://habr.com/ru/post/de423957/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de423945/index.html">Der Oberste Gerichtshof hat das Verfahren f√ºr die Pr√ºfung von F√§llen mit Reposts und Likes festgelegt</a></li>
<li><a href="../de423947/index.html">Unsere pers√∂nlichen Daten kosten Sie nichts</a></li>
<li><a href="../de423949/index.html">Ein Universum, das unseren gegenw√§rtigen √úberzeugungen entspricht, ist m√∂glicherweise nicht m√∂glich.</a></li>
<li><a href="../de423953/index.html">Menschliche Funktion oder Einstellung der Einstellung von Technologie</a></li>
<li><a href="../de423955/index.html">Wie wir ein technologisches Produkt geschaffen haben und auf den Grund gefallen sind</a></li>
<li><a href="../de423959/index.html">Unterwassergeh√§use - F√ºr Roboter</a></li>
<li><a href="../de423961/index.html">Verlieren Sie sich nicht: eine neue Methode zur Diagnose von Demenz</a></li>
<li><a href="../de423963/index.html">Kelvin Point Prolog</a></li>
<li><a href="../de423965/index.html">Sie haben SIEM gekauft und sind sich sicher, dass SOC in Ihrer Tasche ist, oder?</a></li>
<li><a href="../de423967/index.html">Die ganze Wahrheit √ºber RTOS. Artikel 10. Scheduler: Erweiterte Funktionen und Kontexterhaltung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>