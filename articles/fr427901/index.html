<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐞 🤰 👆🏽 Comment ne pas utiliser l'API de flux Node.js 🔑 👨🏿‍⚖️ 👉🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quelqu'un a encore tort sur Internet - dans Yesterday Node Weekly, il y avait un lien vers une publication dans laquelle l'auteur essayait de mesurer ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment ne pas utiliser l'API de flux Node.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427901/"><p>  Quelqu'un a encore tort sur Internet - dans Yesterday <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Node Weekly, il y</a> avait un lien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vers une publication</a> dans laquelle l'auteur essayait de mesurer et de comparer les performances de l'API Stream dans Node.js.  La tristesse explique comment l'auteur travaille avec les flux et quelles conclusions il essaie de tirer sur cette base: </p><br><blockquote>  ... cela a plutôt bien fonctionné sur des fichiers plus petits, mais une fois arrivé au plus gros fichier, la même erreur s'est produite.  Bien que Node.js diffuse les entrées et les sorties, il a tout de même tenté de conserver l'ensemble du fichier en mémoire lors de l'exécution des opérations. </blockquote><p>  Essayons de comprendre ce qui ne va pas avec les conclusions et le code de l'auteur. </p><a name="habracut"></a><br><p>  De mon point de vue, le problème est que l'auteur de l'article ne sait pas utiliser Stream'ami et c'est un problème que l'on doit traiter assez souvent.  Ce phénomène, à mon avis, a trois raisons: </p><br><ol><li>  L'histoire complexe de l'API Node.js Stream - la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">douleur et la souffrance décrites ici</a> </li><li>  Pas l'API la plus intuitive si vous essayez de l'utiliser sans wrappers </li><li>  Documentation assez étrange qui présente les flux comme quelque chose de très complexe et de bas niveau </li></ol><br><p>  Dans l'ensemble, cela conduit au fait que les développeurs ne savent souvent pas comment et ne veulent pas utiliser l'API Stream. </p><br><p>  Quel est le problème avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le code d'auteur</a> ? <br>  Pour commencer, répétons la tâche ici (l'original en anglais et un lien vers le fichier se trouvent dans le post): <br>  Il existe un certain fichier de 2,5 Go avec des lignes du formulaire: </p><br><pre><code class="hljs ruby">C00084871<span class="hljs-params"><span class="hljs-params">|N|</span></span>M3<span class="hljs-params"><span class="hljs-params">|P|</span></span><span class="hljs-number"><span class="hljs-number">201703099050762757</span></span><span class="hljs-params"><span class="hljs-params">|15|</span></span>IND<span class="hljs-params"><span class="hljs-params">|COLLINS, DARREN ROBERT|</span></span>SOUTHLAKE<span class="hljs-params"><span class="hljs-params">|TX|</span></span><span class="hljs-number"><span class="hljs-number">760928782</span></span><span class="hljs-params"><span class="hljs-params">|CELANESE|</span></span>VPCHOP&amp;TECH<span class="hljs-params"><span class="hljs-params">|02282017|</span></span><span class="hljs-number"><span class="hljs-number">153</span></span><span class="hljs-params"><span class="hljs-params">||</span></span>PR2552193345215<span class="hljs-params"><span class="hljs-params">|1151824|</span></span><span class="hljs-params"><span class="hljs-params">|P/R DEDUCTION ($76.92 BI-WEEKLY)|</span></span><span class="hljs-number"><span class="hljs-number">4030920171380058715</span></span></code> </pre> <br><p>  Vous devez l'analyser et trouver les informations suivantes: </p><br><ul><li>  Le nombre de lignes dans le fichier </li><li>  Noms sur les 432e et 43243e lignes (ici la vérité se pose la question de savoir comment compter, à partir de 0 ou 1?) </li><li>  Le nom le plus courant et le nombre de fois qu'il apparaît </li><li>  Le nombre de versements pour chaque mois </li></ul><br><p>  Quel est le problème?  - L'auteur dit honnêtement qu'il charge l'intégralité du fichier en mémoire et à cause de cela, Node "se bloque" et l'auteur nous donne un fait intéressant. </p><br><blockquote>  Fait amusant: Node.js ne peut contenir jusqu'à 1,67 Go de mémoire à la fois </blockquote><p>  L'auteur tire une conclusion étrange de ce fait que ce sont les Streams qui chargent tout le fichier en mémoire et qu'il n'a pas écrit le mauvais code. <br>  Réfutons la thèse: " <em>Bien que Node.js diffuse les entrées et les sorties, il est toujours tenté de conserver l'intégralité du fichier</em> ", en écrivant un petit programme qui comptera le nombre de lignes dans un fichier de n'importe quelle taille: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Writable } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> split = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'split'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> linecounter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Writable({ write(chunk, encoding, callback) { counter = counter + <span class="hljs-number"><span class="hljs-number">1</span></span> callback() }, writev(chunks, callback) { counter = counter + chunks.length callback() } }) fs.createReadStream(<span class="hljs-string"><span class="hljs-string">'itcont.txt'</span></span>) .pipe(split()) .pipe(linecounter) linecounter.on(<span class="hljs-string"><span class="hljs-string">'finish'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(counter) })</code> </pre> <br><p>  <em>NB</em> : le code est volontairement écrit le plus simplement possible.  Les variables globales sont mauvaises! </p><br><p>  À quoi devez-vous faire attention: </p><br><ul><li>  split - npm un paquet qui reçoit un flux de lignes à l '"entrée" - renvoie un flux d'ensembles de lignes à la "sortie" avec un saut de ligne séparé.  Très probablement réalisé comme une implémentation du flux de transformation.  Nous y canalisons notre ReadStream avec un fichier, et nous nous canalisons dans ... </li><li>  linecounter - Implémentation de WritableStream.  Dans ce document, nous implémentons deux méthodes: pour traiter une seule pièce (morceau) et plusieurs.  La «ligne» dans cette situation est la ligne de code.  Inverser - ajoutez le nombre souhaité au compteur.  Il est important de comprendre que dans cette situation, nous ne chargerons pas l'intégralité du fichier en mémoire, et l'API divisera tout pour nous en «morceaux» les plus pratiques pour le traitement </li><li>  «terminer» - événements qui «se produisent» lorsque les données arrivant à notre ReadableStream «se terminent».  Lorsque cela se produit, nous promettons des données de compteur </li></ul><br><p>  Eh bien, testons notre création sur un gros fichier: </p><br><pre> <code class="hljs markdown"><span class="hljs-quote"><span class="hljs-quote">&gt; node linecounter.js 13903993</span></span></code> </pre> <br><p>  Comme vous pouvez le voir, tout fonctionne.  D'après ce que nous pouvons conclure que l'API Stream fait un excellent travail avec des fichiers de toute taille et la déclaration de l'auteur de l'article, pour le moins, n'est pas vraie.  De la même manière, nous pouvons calculer toute autre valeur requise dans le problème. </p><br><p>  Dites: </p><br><ul><li>  Êtes-vous intéressé à lire comment résoudre complètement le problème et comment mettre le code résultant sous une forme pratique pour la maintenance? </li><li>  Utilisez-vous Stream API et quelles difficultés avez-vous rencontrées? </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427901/">https://habr.com/ru/post/fr427901/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427891/index.html">Des millions de personnes peuvent être attaquées par une vulnérabilité dans la plate-forme de conférence Cisco WebEx</a></li>
<li><a href="../fr427893/index.html">Bloody Lola sur Omega 2 ou Python étouffant à l'Halloween</a></li>
<li><a href="../fr427895/index.html">Suppression de données d'une base de données partageable</a></li>
<li><a href="../fr427897/index.html">Analyser un imageur à résonance magnétique II: les métamatériaux en IRM</a></li>
<li><a href="../fr427899/index.html">JsonWriterSax - une bibliothèque pour créer JSON</a></li>
<li><a href="../fr427905/index.html">Extraction de nourriture ou Carrefour à travers les yeux d'un pirate</a></li>
<li><a href="../fr427907/index.html">Tir de drone, râteau, hacks de vie, développement personnel et carrière de photographe / vidéaste: nouveau podcast GLPH</a></li>
<li><a href="../fr427909/index.html">Python: comment réduire de moitié la consommation mémoire en ajoutant une seule ligne de code?</a></li>
<li><a href="../fr427911/index.html">Passions de bureau</a></li>
<li><a href="../fr427913/index.html">Prologue divertissant # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>