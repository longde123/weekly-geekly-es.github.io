<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤üèø üçú üí® Browser√ºbergreifende Web-Erweiterung f√ºr benutzerdefinierte Skripte Teil 4 üë±üèø üìΩÔ∏è üë©‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel vervollst√§ndige ich eine Reihe von Ver√∂ffentlichungen, in denen ich √ºber meine Erfahrungen beim Schreiben einer Web-Erweiterung f√ºr ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Browser√ºbergreifende Web-Erweiterung f√ºr benutzerdefinierte Skripte Teil 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417391/"> In diesem Artikel vervollst√§ndige ich eine Reihe von Ver√∂ffentlichungen, in denen ich √ºber meine Erfahrungen beim Schreiben einer Web-Erweiterung f√ºr Browser sprechen wollte.  Ich hatte bereits Erfahrung mit der Erstellung einer Web-Erweiterung, die von etwa 100.000 Chrome-Nutzern installiert wurde und autonom arbeitete. In dieser Artikelserie habe ich mich jedoch entschlossen, den Entwicklungsprozess der Web-Erweiterung zu untersuchen, indem ich sie eng in die Serverseite integriert habe. <br><br><img width="65" src="https://habrastorage.org/getpro/habr/post_images/188/09a/2d6/18809a2d60126c22c85f0dbb38c188dc.png" alt="Bild"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/474/b37/7c9/474b377c9fd5df452ee6b2ae849c2891.png" alt="Bild"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/804/cc0/c91/804cc0c91bd30f83537540bd6aca22df.png" alt="Bild"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/94e/097/462/94e097462cb7f3af3b482312f6fd2ee9.png" alt="Bild"><img width="65" src="https://habrastorage.org/getpro/habr/post_images/4bf/d73/6f6/4bfd736f6830e4396071afedad261bfd.png" alt="Bild"><br><a name="habracut"></a><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 3</a> <br><br><h1>  Geplante Aufgaben </h1><br>  Mit der Web-Erweiterung k√∂nnen Sie ein benutzerdefiniertes Skript so konfigurieren, dass sein Code nach dem Laden der Seite automatisch ausgef√ºhrt wird.  Dies ist beispielsweise praktisch, wenn Sie eine Liste von Seiten desselben Typs zum Crawlen und Empfangen von Daten aus der Skriptausf√ºhrung haben.  Oder wenn Sie l√§stige Anzeigen auf einer Seite im Internet entfernen m√ºssen, einen Code, um Ihre Aktionen auf einer Webressource zu verfolgen, den Hintergrund der Seite in dunkel zu √§ndern usw. <br><br>  In diesem Fall ist es h√§ufig erforderlich, im t√§glichen Zeitplanmodus Daten von der Seite zu empfangen.  Wenn die Site beispielsweise √ºber Wechselkurse verf√ºgt und eine direkte Anforderung per URL das Hash-Argument sch√ºtzt.  Als solche Kopie k√∂nnen Sie die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Website der Central Bank of Europe betrachten</a> .  In diesem Fall m√ºssen Sie die Hash-URL kennen, um die aktuellen Daten im XML-Format zu erhalten, um die aktuellen Wechselkurse zu erhalten. <br><br>  Mit der Web-Erweiterung k√∂nnen Sie die erforderliche H√§ufigkeit f√ºr den Empfang von Daten √ºber ein Skript festlegen, um Wechselkurse anzufordern.  Die Web-Erweiterung akzeptiert eine Zeichenfolge im Format von Kronen als Eingabe. Um Wechselkurse im t√§glichen Modus zu erhalten, m√ºssen Sie * * / 1 * * * angeben. <br><br>  Aus technischer Sicht startet der Serverteil Puppeteer mit dem Hinzuf√ºgen eines Benutzerskripts zur Chromium-Browserseite.  In diesem Fall stehen wir vor dem Problem des absichtlichen Herunterfahrens des Chromium-Prozesses im Laufe der Zeit, da eine Erh√∂hung der Anzahl der Prozesse die Gesamtleistung der Serverseite nachteilig beeinflusst.  Wenn Sie das Benutzerskript im periodischen Modus ausf√ºhren m√∂chten, um das oben genannte Problem zu l√∂sen, m√ºssen Sie eine Anforderung des Benutzerskripts an Puppeteer senden, um den Chromium-Prozess abzuschlie√üen. <br><br>  Nach langwierigen Tests des Implementierungsprozesses des Taskplaners wurde beschlossen, die Ausgabe der Skriptkonsole zu verfolgen.  Um den Chromium-Prozess zu stoppen, muss das Benutzerskript √ºber einen Befehl verf√ºgen, um den Prozess im erforderlichen Codeabschnitt zu stoppen: <br><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'script is ended'</span></span>);</code> </pre> <br>  Mit diesem Befehl kann ein Benutzerskript den von Puppeteer generierten Chromium-Serverprozess schlie√üen.  Dies wird implementiert, indem das Puppenspieler-Konsolenereignis verfolgt wird: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//initialize browser and page page.on('console', async msg =&gt; { for (let i = 0; i &lt; msg.args().length; ++i) { if(await msg.args()[i].jsonValue() == 'script is ended') { await browser.close(); } } });</span></span></code> </pre><br>  Wenn das Benutzerskript nicht √ºber einen solchen Befehl verf√ºgt, muss der Timer zwangsweise beendet werden, um den Ausf√ºhrungsprozess im Taskplanungsmodus abzuschlie√üen.  Dies wird auf einfache Weise mit setTimeout implementiert: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeLimitCron = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeout = setTimeout(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(browser) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.close(); } clearTimeout(timeout); }, timeLimitCron * <span class="hljs-number"><span class="hljs-number">1000</span></span> ); <span class="hljs-comment"><span class="hljs-comment">//time limit for cron, then forced closing, default 30 seconds</span></span></code> </pre><br>  Da der Taskplaner auf der Serverseite ausgef√ºhrt wird und der Benutzer h√§ufig eine bestimmte IP-Adresse verwenden muss, wurde eine Option zur Verwendung eines Proxyservers hinzugef√ºgt. <br><br><img src="https://habrastorage.org/webt/s2/sb/ko/s2sbko8uyscf31aksmaulyn7hus.png"><br><br>  Der Benutzer kann auch das neueste Nachrichtenprotokoll von der Puppenspielerkonsole herunterladen.  Beispielsweise ist es praktisch, den korrekten Betrieb des Proxyservers zu √ºberpr√ºfen. <br><br><h1>  Tastaturk√ºrzel </h1><br>  W√§hrend des Testens und Feldtests stellte sich heraus, dass es f√ºr einige Arten von Skripten n√ºtzlich ist, Hotkeys f√ºr deren Ausf√ºhrung auf Webressourcen zu haben.  Ein Beispiel f√ºr ein solches Skript ist Redability.js.  Dieses Skript erstellt eine "saubere Ansicht", um den Inhalt der Site zu lesen.  Das hei√üt, die js-Bibliothek analysiert die Struktur der Seite mit dem Inhalt und erm√∂glicht es Ihnen, mit hoher Wahrscheinlichkeit den Titel, den Autor und den Inhalt der Seite zu erhalten.  Danach kann das Benutzerskript das HTML der Webressource √ºberschreiben und dem Benutzer das Lesen in ‚Äûreiner Form‚Äú ohne unn√∂tiges Markup, Werbung usw. erm√∂glichen. <br><br>  Anf√§nglich war das Ausf√ºhren eines Benutzerskripts nur √ºber eine Popup-Web-Erweiterung m√∂glich, indem Sie auf die Schaltfl√§che "Ausf√ºhren" klicken.  Diese Logik der Interaktion mit der Schnittstelle wird h√§ufig durch Sicherheits√ºberlegungen gerechtfertigt.  Im obigen Beispiel k√∂nnen Sie den Inhalt einer Webressource jedoch nicht einfach in eine ‚Äûreine Form‚Äú bringen. <br><br>  Wie oben beschrieben, k√∂nnen Sie mit der Web-Erweiterung √ºber content.js mit dem DOM arbeiten. Das Fensterobjekt kann jedoch nicht zum Speichern von Parametern verwendet werden, da es kein Fensterobjekt einer ge√∂ffneten Registerkarte ist.  Diese Bedingung schr√§nkt den Betrieb der Web-Erweiterung als Objekt zum Verfolgen von Tastenanschl√§gen ein. <br><br>  In dem zu l√∂senden Problem m√ºssen die ‚ÄûHotkeys‚Äú zur Speicherung von der Web-Erweiterungsschnittstelle auf die Serverseite √ºbertragen werden.  Als n√§chstes erhalten Sie jedes Mal, wenn Sie eine Webressourcenseite laden, eine Liste mit ‚ÄûHotkeys‚Äú und laden ein Benutzerskript, nachdem Sie auf die richtige Kombination geklickt haben.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hotkeys.js wird</a> als Bibliothek f√ºr die Arbeit mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hotkeys</a> verwendet. <br><br>  Nach dem Empfang der Liste der Hotkeys von der Serverseite wird der folgende Code ausgef√ºhrt: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hotKeysMap = {<span class="hljs-attr"><span class="hljs-attr">keys</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">id</span></span>: []}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data.response.data) { hotKeysMap.keys.push(data.response.data[i][<span class="hljs-string"><span class="hljs-string">'hotkeys'</span></span>]); hotKeysMap.id.push(data.response.data[i][<span class="hljs-string"><span class="hljs-string">"_id"</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(hotKeysMap.keys) { getScript(<span class="hljs-string"><span class="hljs-string">"hotkeys.js"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> script = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"script"</span></span>); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"gCore-hotKeys"</span></span>); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-endpoint"</span></span>, event.data.endPoint); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-token"</span></span>, event.data.token); script.setAttribute(<span class="hljs-string"><span class="hljs-string">"data-userid"</span></span>, event.data.userId); script.innerHTML = <span class="hljs-string"><span class="hljs-string">"GChotKeys = JSON.parse(\""</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(hotKeysMap).replace(<span class="hljs-regexp"><span class="hljs-regexp">/"/g</span></span>, <span class="hljs-string"><span class="hljs-string">"\\\""</span></span>) + <span class="hljs-string"><span class="hljs-string">"\");\n"</span></span> + <span class="hljs-string"><span class="hljs-string">"hotkeys(GChotKeys.keys.join(','), function(event, handler) {"</span></span> + <span class="hljs-string"><span class="hljs-string">" event.preventDefault();"</span></span> + <span class="hljs-string"><span class="hljs-string">" localStorage.setItem('runHotKeysScript', GChotKeys.id[GChotKeys.keys.indexOf(handler.key)]);"</span></span> + <span class="hljs-string"><span class="hljs-string">"});"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.appendChild(script); }); }</code> </pre> <br>  Die Funktion getScript generiert HTML-Code f√ºr das Skript-Tag und schreibt ihn auf die Webressourcenseite.  Somit haben wir auf jeder Seite die M√∂glichkeit, Tastenanschl√§ge zu verfolgen.  Wir m√ºssen auch ein Array von Hotkeys √ºbergeben, die mit der ID des auszuf√ºhrenden Skripts √ºbereinstimmen.  Dies wird implementiert, indem HTML-Code f√ºr das Skript-Tag hinzugef√ºgt wird, dessen Inhalt eine globale Variable zum Speichern des passenden Arrays im JSON-Format initiiert. <br><br>  Es wurde bereits oben erw√§hnt, dass ein Kommunikationsproblem zwischen der ge√∂ffneten Seite der Webressource und dem Skript der Inhaltserweiterung extension.js der Weberweiterung besteht, mit dem das DOM bearbeitet wird.  In diesem Fall k√∂nnen Sie auf eine einfache Technik zur√ºckgreifen, um den Wert in localStorage zu √ºberpr√ºfen. Dies ist ein gemeinsames Objekt f√ºr die beiden oben genannten Interaktionspunkte. <br><br>  In content.js k√∂nnen Sie einfach einmal pro Sekunde den localStorage-Wert √ºberpr√ºfen und dieselben DOM-Manipulationen ausf√ºhren wie beim Klicken auf die Schaltfl√§che "Ausf√ºhren" in der Popup-Web-Erweiterung. <br><br><pre> <code class="javascript hljs">setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'runHotKeysScript'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// run user script localStorage.removeItem('runHotKeysScript'); } }, 1000);</span></span></code> </pre><br>  Auf diese Weise wird die ‚ÄûHotkeys‚Äú -Technik implementiert, mit der Sie schnell Benutzerskripte starten k√∂nnen, indem Sie die Leistung der internen Bibliothek zur L√∂sung praktischer Probleme nutzen. <br><br><h1>  Fazit </h1><br>  W√§hrend der Implementierung dieses Projekts wurden die praktischen Aufgaben des Schreibens der Integration zwischen dem auf meteor.js basierenden Serverteil und der browser√ºbergreifenden Web-Erweiterung gel√∂st.  Die wichtigsten Stolpersteine ‚Äã‚Äãwaren SCP und die Interaktionsprozesse zwischen den drei Komponenten des Client-Teils - der im Browser ge√∂ffneten Seite, den Skripten content.js und background.js. <br><br>  Ich hoffe, dass meine Erfahrung es einfacher macht, spezialisiertere browser√ºbergreifende Web-Erweiterungen zu schreiben. <br><br>  In Zukunft ist geplant, die Web-Erweiterung zu lokalisieren und f√ºr die Community n√ºtzliche Skripte zu schreiben.  Wenn der Leser eine Idee oder einen Wunsch hat, beim Schreiben solcher Benutzerskripte zu helfen, schreiben Sie bitte in private Nachrichten. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de417391/">https://habr.com/ru/post/de417391/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de417377/index.html">Warum sollten Sie Google Cloud nicht verwenden?</a></li>
<li><a href="../de417379/index.html">Neuer Feststoffraketenmotor f√ºr Vega-C und Ariane 6</a></li>
<li><a href="../de417383/index.html">JavaScript ES6: Schw√§chen</a></li>
<li><a href="../de417385/index.html">Wie ich umgezogen bin ... nach Hause oder meine Antwort an den Autor des Artikels √ºber "gnadenloses Mehl"</a></li>
<li><a href="../de417389/index.html">Tilt Shift Lens-Effekt</a></li>
<li><a href="../de417393/index.html">Wie wir ein System geschaffen haben, das Kunden Rabatte basierend auf individuellen Merkmalen zuweist</a></li>
<li><a href="../de417395/index.html">End-to-End-Tests: Was, warum, warum</a></li>
<li><a href="../de417397/index.html">Welche Programmiersprache soll man 2018 lernen und warum?</a></li>
<li><a href="../de417399/index.html">Willkommen an Bord: Einf√ºhrung neuer Entwickler in das Team</a></li>
<li><a href="../de417401/index.html">Schlie√ülich w√§hlen wir ein Budget-Multimeter mit guter Funktionalit√§t</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>