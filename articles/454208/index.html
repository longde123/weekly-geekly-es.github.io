<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∫üèæ ‚öΩÔ∏è üßõüèæ RISC-V desde cero ‚úä üöß üê¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, exploramos varios conceptos de bajo nivel (compilaci√≥n y dise√±o, tiempos de ejecuci√≥n primitivos, ensamblador y m√°s) a trav√©s del pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RISC-V desde cero</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454208/">  En este art√≠culo, exploramos varios conceptos de bajo nivel (compilaci√≥n y dise√±o, tiempos de ejecuci√≥n primitivos, ensamblador y m√°s) a trav√©s del prisma de la arquitectura RISC-V y su ecosistema.  Yo mismo soy desarrollador web, no hago nada en el trabajo, pero es muy interesante para m√≠, ¬°de aqu√≠ es de donde vino el art√≠culo!  √önete a m√≠ en este viaje agitado a las profundidades del caos de bajo nivel. <br><br>  Primero, hablemos un poco sobre RISC-V y la importancia de esta arquitectura, configure la cadena de herramientas RISC-V y ejecute un programa simple C en hardware RISC-V emulado. <br><a name="habracut"></a><br><h1>  Contenido </h1><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬øQu√© es RISC-V?</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Configuraci√≥n de herramientas QEMU y RISC-V</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hola RISC-V!</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Enfoque ingenuo</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Levantando la cortina -v</a> <br></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Busca en nuestra pila</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dise√±o</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Basta!</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><s>Hammertime!</s></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tiempo de ejecuci√≥n!</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Depurar pero ahora de verdad</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Que sigue</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Opcional</a> </li></ol><br><a name="1"></a><h1>  ¬øQu√© es RISC-V? </h1><br>  RISC-V es una arquitectura de conjunto de instrucciones gratuitas.  El proyecto se origin√≥ en la Universidad de California en Berkeley en 2010.  La apertura del c√≥digo y la libertad de uso desempe√±aron un papel importante en su √©xito, que era muy diferente de muchas otras arquitecturas.  Tome ARM: para crear un procesador compatible, debe pagar una tarifa por adelantado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de $ 1 mill√≥n a $ 10 millones, y tambi√©n pagar regal√≠as de 0.5 a 2% sobre las ventas</a> .  Un modelo gratuito y abierto hace que RISC-V sea una opci√≥n atractiva para muchos, incluso para las nuevas empresas que no pueden pagar una licencia para un ARM u otro procesador, para investigadores acad√©micos y (obviamente) para la comunidad de c√≥digo abierto. <br><br>  El r√°pido crecimiento en popularidad de RISC-V no pas√≥ desapercibido.  ARM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lanz√≥ un sitio</a> que intent√≥ (sin √©xito) destacar los supuestos beneficios de ARM sobre RISC-V (el sitio ya est√° cerrado).  El proyecto RISC-V cuenta con el respaldo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">muchas grandes empresas</a> , incluidas Google, Nvidia y Western Digital. <br><br><a name="2"></a><h1>  Configuraci√≥n de herramientas QEMU y RISC-V </h1><br>  No podemos ejecutar el c√≥digo en el procesador RISC-V hasta que configuremos el entorno.  Afortunadamente, esto no requiere un procesador f√≠sico RISC-V; en cambio, tomamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">qemu</a> .  Siga las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instrucciones para</a> instalar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">su sistema operativo</a> .  Tengo MacOS, as√≠ que solo ingrese un comando: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># also available via MacPorts - `sudo port install qemu` brew install qemu</span></span></code> </pre> <br>  Convenientemente, <code>qemu</code> viene con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">varias m√°quinas listas para</a> <code>qemu-system-riscv32 -machine</code> (vea la <code>qemu-system-riscv32 -machine</code> ). <br><br>  A continuaci√≥n, instale <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OpenOCD</a> para las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">herramientas</a> RISC-V y RISC-V. <br><br>  Descargue los ensamblajes ya preparados de las herramientas RISC-V OpenOCD y RISC-V <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br>  Extraemos los archivos a cualquier directorio, lo tengo <code>~/usys/riscv</code> .  Recu√©rdelo para uso futuro. <br><br><pre> <code class="bash hljs">mkdir -p ~/usys/riscv <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Downloads cp openocd-&lt;date&gt;-&lt;platform&gt;.tar.gz ~/usys/riscv cp riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;platform&gt;.tar.gz ~/usys/riscv <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/usys/riscv tar -xvf openocd-&lt;date&gt;-&lt;platform&gt;.tar.gz tar -xvf riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;platform&gt;.tar.gz</code> </pre> <br>  Establezca las variables de entorno <code>RISCV_OPENOCD_PATH</code> y <code>RISCV_PATH</code> para que otros programas puedan encontrar nuestra cadena de herramientas.  Esto puede verse diferente seg√∫n el sistema operativo y el shell: agregu√© las rutas al <code>~/.zshenv</code> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># I put these two exports directly in my ~/.zshenv file - you may have to do something else. export RISCV_OPENOCD_PATH="$HOME/usys/riscv/openocd-&lt;date&gt;-&lt;version&gt;" export RISCV_PATH="$HOME/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;" # Reload .zshenv with our new environment variables. Restarting your shell will have a similar effect. source ~/.zshenv</span></span></code> </pre> <br>  Cree un enlace simb√≥lico en <code>/usr/local/bin</code> para este archivo ejecutable para que pueda ejecutarlo en cualquier momento sin especificar la ruta completa a <code>~/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;/bin/riscv64-unknown-elf-gcc</code> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Symbolically link our gcc executable into /usr/local/bin. Repeat this process for any other executables you want to quickly access. ln -s ~/usys/riscv/riscv64-unknown-elf-gcc-8.2.0-&lt;date&gt;-&lt;version&gt;/bin/riscv64-unknown-elf-gcc /usr/local/bin</span></span></code> </pre> <br>  ¬°Y listo, tenemos un kit de herramientas RISC-V en funcionamiento!  Todos nuestros ejecutables, como <code>riscv64-unknown-elf-gcc</code> , <code>riscv64-unknown-elf-gdb</code> , <code>riscv64-unknown-elf-ld</code> y otros, est√°n en <code>~/usys/riscv/riscv64-unknown-elf-gcc-&lt;date&gt;-&lt;version&gt;/bin/</code> . <br><br><a name="3"></a><h1>  Hola RISC-V! </h1><br>  <i>Parche del 26 de mayo de 2019:</i> <i><br><br></i>  <i>Desafortunadamente, debido a un error en RISC-V QEMU, el programa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">freedom-e-sdk</a> 'hello world' en QEMU ya no funciona.</i>  <i>Se ha lanzado un parche para resolver este problema, pero por ahora, omita esta secci√≥n.</i>  <i>Este programa no ser√° necesario en las secciones posteriores del art√≠culo.</i>  <i>Rastreo la situaci√≥n y actualizo el art√≠culo despu√©s de corregir el error.</i> <i><br><br></i>  <i>Vea <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este comentario</a> para m√°s informaci√≥n.</i> <br><br>  Con las herramientas configuradas, ejecutemos el sencillo programa RISC-V.  Comencemos clonando el repositorio SiFive <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">freedom-e-sdk</a> : <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/wherever/you/want/to/<span class="hljs-built_in"><span class="hljs-built_in">clone</span></span>/this git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --recursive https://github.com/sifive/freedom<span class="hljs-_"><span class="hljs-_">-e</span></span>-sdk.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> freedom<span class="hljs-_"><span class="hljs-_">-e</span></span>-sdk</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Por tradici√≥n</a> , comencemos con el programa 'Hola, mundo' del repositorio <code>freedom-e-sdk</code> .  Utilizamos el <code>Makefile</code> listo para usar que proporcionan para compilar este programa en modo de depuraci√≥n: <br><br><pre> <code class="bash hljs">make PROGRAM=hello TARGET=sifive-hifive1 CONFIGURATION=debug software</code> </pre> <br>  Y ejecutar en QEMU: <br><br><pre> <code class="bash hljs">qemu-system-riscv32 -nographic -machine sifive_e -kernel software/hello/debug/hello.elf Hello, World!</code> </pre> <br>  Este es un gran comienzo.  Puede ejecutar otros ejemplos desde <code>freedom-e-sdk</code> .  Despu√©s de eso, escribiremos e intentaremos depurar nuestro propio programa en C. <br><br><h1>  Enfoque ingenuo </h1><br>  Comencemos con un programa simple que agrega infinitamente dos n√∫meros. <br><br><pre> <code class="cpp hljs">cat add.<span class="hljs-function"><span class="hljs-function">c </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = a + b; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Queremos ejecutar este programa, y ‚Äã‚Äãlo primero que necesitamos para compilarlo para el procesador RISC-V. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -O0 to disable all optimizations. Without this, GCC might optimize # away our infinite addition since the result 'c' is never used. # -g to tell GCC to preserve debug info in our executable. riscv64-unknown-elf-gcc add.c -O0 -g</span></span></code> </pre> <br>  Esto crea el archivo <code>a.out</code> , que por defecto <code>gcc</code> archivos ejecutables.  Ahora ejecute este archivo en <code>qemu</code> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -machine tells QEMU which among our list of available machines we want to # run our executable against. Run qemu-system-riscv64 -machine help to list # all available machines. # -m is the amount of memory to allocate to our virtual machine. # -gdb tcp::1234 tells QEMU to also start a GDB server on localhost:1234 where # TCP is the means of communication. # -kernel tells QEMU what we're looking to run, even if our executable isn't # exactly a "kernel". qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -kernel a.out</span></span></code> </pre> <br>  Elegimos la m√°quina <code>virt</code> que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">originalmente</a> <code>riscv-qemu</code> . <br><br>  Ahora que nuestro programa se ejecuta dentro de QEMU con el servidor GDB en <code>localhost:1234</code> , nos conectamos con el cliente RISC-V GDB desde un terminal separado: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># --tui gives us a (t)extual (ui) for our GDB session. # While we can start GDB without any arguments, specifying 'a.out' tells GDB # to load debug symbols from that file for the newly created session. riscv64-unknown-elf-gdb --tui a.out</span></span></code> </pre> <br>  ¬°Y estamos dentro de GDB! <br><br><pre>  Este GDB se configur√≥ como "--host = x86_64-apple-darwin17.7.0 --target = riscv64-unknown-elf".  ‚îÇ
 Escriba "show configuration" para obtener detalles de la configuraci√≥n.  ‚îÇ
 Para obtener instrucciones de informe de errores, consulte: ‚îÇ
 &lt;http://www.gnu.org/software/gdb/bugs/&gt;.  ‚îÇ
 Encuentre el manual de GDB y otros recursos de documentaci√≥n en l√≠nea en: ‚îÇ
     &lt;http://www.gnu.org/software/gdb/documentation/&gt;.  ‚îÇ
                                                                                                       ‚îÇ
 Para obtener ayuda, escriba "ayuda".  ‚îÇ
 Escriba "apropos word" para buscar comandos relacionados con "word" ... ‚îÇ
 Lectura de s√≠mbolos de a.out ... ‚îÇ
 (gdb) </pre><br>  Podemos intentar ejecutar los comandos de <code>run</code> o <code>start</code> para el archivo ejecutable <code>a.out</code> en GDB, pero por el momento esto no funcionar√° por una raz√≥n obvia.  <code>riscv64-unknown-elf-gcc</code> el programa como <code>riscv64-unknown-elf-gcc</code> , por lo que el host deber√≠a ejecutarse en la arquitectura <code>riscv64</code> . <br><br>  ¬°Pero hay una salida!  Esta situaci√≥n es una de las principales razones de la existencia del modelo cliente-servidor de GDB.  Podemos tomar el archivo ejecutable <code>riscv64-unknown-elf-gdb</code> y, en lugar de iniciarlo en el host, especif√≠quelo en alg√∫n destino remoto (servidor GDB).  Como recordar√°, acabamos de comenzar <code>riscv-qemu</code> y nos dijo que <code>riscv-qemu</code> el servidor GDB en <code>localhost:1234</code> .  Simplemente con√©ctese a este servidor: <br><br><pre>  (gdb) control remoto de destino: 1234 ‚îÇ
 Depuraci√≥n remota utilizando: 1234 </pre><br>  Ahora puede establecer algunos puntos de interrupci√≥n: <br><br><pre> <code class="bash hljs">(gdb) b main Breakpoint 1 at 0x1018e: file add.c, line 2. (gdb) b 5 <span class="hljs-comment"><span class="hljs-comment"># this is the line within the forever-while loop. int c = a + b; Breakpoint 2 at 0x1019a: file add.c, line 5.</span></span></code> </pre> <br>  Y finalmente, especifique GDB <code>continue</code> (comando abreviado <code>c</code> ) hasta llegar al punto de interrupci√≥n: <br><br><pre> <code class="bash hljs">(gdb) c Continuing.</code> </pre> <br>  Notar√° r√°pidamente que el proceso no termina de ninguna manera.  Esto es extra√±o ... ¬øno deber√≠amos llegar inmediatamente al punto de interrupci√≥n <code>b 5</code> ?  Que paso <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a53/834/210/a538342106336ef7ed1b8f9e53a47f48.png"><br><br>  Aqu√≠ puedes ver varios problemas: <br><br><ol><li>  La interfaz de usuario de texto no puede encontrar la fuente.  La interfaz debe mostrar nuestro c√≥digo y cualquier punto de interrupci√≥n cercano. <br></li><li>  GDB no ve la l√≠nea de ejecuci√≥n actual ( <code>L??</code> ) y muestra el contador 0x0 ( <code>PC: 0x0</code> ). <br></li><li>  Alg√∫n texto en la l√≠nea de entrada, que en su totalidad se ve as√≠: <code>0x0000000000000000 in ?? ()</code> <code>0x0000000000000000 in ?? ()</code> </li></ol><br>  Combinados con el hecho de que no podemos alcanzar el punto de ruptura, estos indicadores indican: hicimos <i>algo</i> mal.  Pero que? <br><br><a name="5"></a><h1>  Levantando la cortina -v </h1><br>  Para comprender lo que est√° sucediendo, debe dar un paso atr√°s y hablar sobre c√≥mo funciona realmente nuestro simple programa C debajo del cap√≥.  La funci√≥n <code>main</code> hace una simple adici√≥n, pero ¬øqu√© es realmente?  ¬øPor qu√© deber√≠a llamarse <code>main</code> , no <code>origin</code> o <code>begin</code> ?  Seg√∫n la convenci√≥n, todos los archivos ejecutables comienzan a ejecutarse con la funci√≥n <code>main</code> , pero ¬øqu√© magia proporciona este comportamiento? <br><br>  Para responder a estas preguntas, repitamos nuestro equipo de GCC con el indicador <code>-v</code> para obtener una salida m√°s detallada de lo que realmente est√° sucediendo. <br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gcc add.c -O0 -g -v</code> </pre> <br>  El resultado es grande, por lo que no veremos la lista completa.  Es importante tener en cuenta que, aunque GCC es formalmente un compilador, tambi√©n se predetermina a la compilaci√≥n (para limitarse a la compilaci√≥n y el ensamblaje, debe especificar el indicador <code>-c</code> ).  ¬øPor qu√© es esto importante?  Bueno, eche un vistazo al fragmento de la salida detallada de <code>gcc</code> : <br><br><pre>  # El comando real `gcc -v` genera rutas completas, pero esas son bastante
 # largo, as√≠ que imagina que estas variables existen.
 # $ RV_GCC_BIN_PATH = / Users / twilcock / usys / riscv / riscv64-unknown-elf-gcc- &lt;date&gt; - &lt;version&gt; / bin /
 # $ RV_GCC_LIB_PATH = $ RV_GCC_BIN_PATH /../ lib / gcc / riscv64-unknown-elf / 8.2.0<font></font>
<font></font>
 $ RV_GCC_BIN_PATH /../ libexec / gcc / riscv64-unknown-elf / 8.2.0 / collect2 \
   ... truncado ... 
   $ RV_GCC_LIB_PATH /../../../../ riscv64-unknown-elf / lib / rv64imafdc / lp64d / crt0.o \ 
   $ RV_GCC_LIB_PATH / riscv64-unknown-elf / 8.2.0 / rv64imafdc / lp64d / crtbegin.o \
   -lgcc --start-group -lc -lgloss --end-group -lgcc \ 
   $ RV_GCC_LIB_PATH / rv64imafdc / lp64d / crtend.o
   ... truncado ...
 COLLECT_GCC_OPTIONS = '- O0' '-g' '-v' '-march = rv64imafdc' '-mabi = lp64d' </pre><br>  Entiendo que incluso en forma abreviada esto es mucho, as√≠ que d√©jenme explicarlo.  En la primera l√≠nea, <code>gcc</code> ejecuta el programa <code>collect2</code> , pasa los argumentos <code>crt0.o</code> , <code>crtbegin.o</code> y <code>crtend.o</code> , los <code>-lgcc</code> y <code>--start-group</code> .  La descripci√≥n de collect2 se puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> : en resumen, collect2 organiza varias funciones de inicializaci√≥n en el inicio, haciendo el dise√±o en una o m√°s pasadas. <br><br>  Por lo tanto, GCC compila varios archivos <code>crt</code> con nuestro c√≥digo.  Como puedes adivinar, <code>crt</code> significa 'C tiempo de ejecuci√≥n'.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠ se</a> describe en detalle para qu√© <code>crt</code> destinado cada <code>crt</code> , pero estamos interesados ‚Äã‚Äãen <code>crt0</code> , que hace una cosa importante: <br><br><blockquote>  <i>"Se espera que este objeto [crt0] contenga el car√°cter <code>_start</code> , que indica el arranque del programa".</i> </blockquote><br>  La esencia de la "rutina de carga" depende de la plataforma, pero generalmente involucra tareas importantes como configurar un marco de pila, pasar argumentos de l√≠nea de comando y llamar a <code>main</code> .  S√≠, <i>finalmente</i> encontramos la respuesta a la pregunta: ¬°es <code>_start</code> llama a nuestra funci√≥n principal! <br><br><a name="6"></a><h1>  Busca en nuestra pila </h1><br>  Resolvimos un acertijo, pero ¬øc√≥mo nos acerca esto al objetivo original: ejecutar un programa C simple en <code>gdb</code> ?  Queda por resolver varios problemas: el primero de ellos est√° relacionado con c√≥mo <code>crt0</code> configura nuestra pila. <br><br>  Como vimos anteriormente, el valor predeterminado de <code>gcc</code> <code>crt0</code> .  Los par√°metros predeterminados se seleccionan en funci√≥n de varios factores: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Triplete de destino</a> correspondiente a la estructura del <code>machine-vendor-operatingsystem</code> .  Lo tenemos <code>riscv64-unknown-elf</code> <br></li><li>  Arquitectura de destino, <code>rv64imafdc</code> <br></li><li>  Target ABI, <code>lp64d</code> </li></ul><br>  Por lo general, todo funciona bien, pero no para todos los procesadores RISC-V.  Como se mencion√≥ anteriormente, una de las tareas de <code>crt0</code> es configurar la pila.  ¬øPero √©l no sabe exactamente d√≥nde deber√≠a estar la pila para nuestra CPU ( <code>-machine</code> )?  No puede hacerlo sin nuestra ayuda. <br><br>  En el <code>qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -kernel a.out</code> utilizamos la m√°quina <code>virt</code> .  Afortunadamente, <code>qemu</code> facilita volcar la informaci√≥n de la m√°quina en un volcado <code>dtb</code> (blob de √°rbol de dispositivos). <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Go to the ~/usys/riscv folder we created before and create a new dir # for our machine information. cd ~/usys/riscv &amp;&amp; mkdir machines cd machines # Use qemu to dump info about the 'virt' machine in dtb (device tree blob) # format. # The data in this file represents hardware components of a given # machine / device / board. qemu-system-riscv64 -machine virt -machine dumpdtb=riscv64-virt.dtb</span></span></code> </pre> <br>  Los datos Dtb son dif√≠ciles de leer porque es b√°sicamente un formato binario, pero hay una utilidad de l√≠nea de comandos <code>dtc</code> (compilador del √°rbol de dispositivos) que puede convertir el archivo en algo m√°s legible. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># I'm running MacOS, so I use Homebrew to install this. If you're # running another OS you may need to do something else. brew install dtc # Convert our .dtb into a human-readable .dts (device tree source) file. dtc -I dtb -O dts -o riscv64-virt.dts riscv64-virt.dtb</span></span></code> </pre> <br>  El archivo de salida es <code>riscv64-virt.dts</code> , donde vemos mucha informaci√≥n interesante sobre <code>virt</code> : la cantidad de n√∫cleos de procesador disponibles, la ubicaci√≥n de la memoria de varios dispositivos perif√©ricos, como UART, la ubicaci√≥n de la memoria interna (RAM).  La pila deber√≠a estar en esta memoria, as√≠ que <code>grep</code> con <code>grep</code> : <br><br><pre> <code class="bash hljs">grep memory riscv64-virt.dts -A 3 memory@80000000 { device_type = <span class="hljs-string"><span class="hljs-string">"memory"</span></span>; reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;; };</code> </pre> <br>  Como puede ver, este nodo tiene 'memoria' especificada como <code>device_type</code> .  Aparentemente, encontramos lo que est√°bamos buscando.  Por los valores dentro de <code>reg = &lt;...&gt; ;</code>  Puede determinar d√≥nde comienza el banco de memoria y cu√°l es su longitud. <br><br>  En <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la especificaci√≥n del dispositivo,</a> vemos que la sintaxis <code>reg</code> es un n√∫mero arbitrario de pares <code>(base_address, length)</code> .  Sin embargo, hay cuatro significados dentro del <code>reg</code> .  Extra√±o, ¬øno son dos valores suficientes para un banco de memoria? <br><br>  Una vez m√°s, a partir de la especificaci√≥n del dispositivo (b√∫squeda de la propiedad <code>reg</code> ) descubrimos que el n√∫mero de <code>&lt;u32&gt;</code> para especificar la direcci√≥n y la longitud est√° determinado por las propiedades <code>#size-cells</code> <code>#address-cells</code> y <code>#size-cells</code> en el nodo primario (o en el propio nodo).  Estos valores no se especifican en nuestro nodo de memoria, y el nodo de memoria principal es simplemente la ra√≠z del archivo.  Veamos en √©l estos valores: <br><br><pre> <code class="plaintext hljs">head -n8 riscv64-virt.dts /dts-v1/; / { #address-cells = &lt;0x02&gt;; #size-cells = &lt;0x02&gt;; compatible = "riscv-virtio"; model = "riscv-virtio,qemu";</code> </pre> <br>  Resulta que tanto la direcci√≥n como la longitud requieren dos valores de 32 bits.  Esto significa que con <code>reg = &lt;0x00 0x80000000 0x00 0x8000000&gt;;</code>  nuestra memoria comienza <code> 0x00 + 0x80000000 (0x80000000)</code> y ocupa <code>0x00 + 0x8000000 (0x8000000)</code> bytes, es decir, termina en <code>0x88000000</code> , que corresponde a 128 megabytes. <br><br><a name="7"></a><h1>  Dise√±o </h1><br>  Usando <code>qemu</code> y <code>dtc</code> encontramos las direcciones RAM en la m√°quina virtual virt.  Tambi√©n sabemos que <code>gcc</code> compone <code>crt0</code> por defecto, sin configurar la pila como necesitamos.  Pero, ¬øc√≥mo usar esta informaci√≥n para eventualmente ejecutar y depurar el programa? <br><br>  Como <code>crt0</code> no nos conviene, hay una opci√≥n obvia: escribir su propio c√≥digo y luego componerlo con el archivo de objeto que obtuvimos despu√©s de compilar nuestro programa simple.  Nuestro <code>crt0</code> necesita saber d√≥nde comienza la parte superior de la pila para inicializarla correctamente.  Podr√≠amos <code>crt0</code> valor <code>0x80000000</code> directamente a <code>crt0</code> , pero esta no es una soluci√≥n muy adecuada, teniendo en cuenta los cambios que puedan ser necesarios en el futuro.  ¬øQu√© pasa si queremos usar otra CPU, como <code>sifive_e</code> , con diferentes caracter√≠sticas en el emulador? <br><br>  Afortunadamente, no somos los primeros en hacer esta pregunta, y ya existe una buena soluci√≥n.  El enlazador GNU <code>ld</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">permite definir el car√°cter</a> disponible en nuestro <code>crt0</code> .  Podemos definir el s√≠mbolo <code>__stack_top</code> adecuado para diferentes procesadores. <br><br>  En lugar de escribir su propio archivo de enlace desde cero, tiene sentido tomar el script predeterminado con <code>ld</code> y modificarlo un poco para admitir caracteres adicionales.  ¬øQu√© es un script vinculador?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://www.scoberlin.de/content/media/">Aqu√≠ hay una buena descripci√≥n</a> : <br><br><blockquote>  <i>El prop√≥sito principal de la secuencia de comandos del vinculador es describir c√≥mo las secciones del archivo se combinan en la entrada y la salida, y controlar el dise√±o de la memoria del archivo de salida.</i> </blockquote><br>  Sabiendo esto, <code>riscv64-unknown-elf-ld</code> script de enlace predeterminado <code>riscv64-unknown-elf-ld</code> a un nuevo archivo: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/usys/riscv <span class="hljs-comment"><span class="hljs-comment"># Make a new dir for custom linker scripts out RISC-V CPUs may require. mkdir ld &amp;&amp; cd ld # Copy the default linker script into riscv64-virt.ld riscv64-unknown-elf-ld --verbose &gt; riscv64-virt.ld</span></span></code> </pre> <br>  Este archivo tiene <i>mucha</i> informaci√≥n interesante, mucho m√°s de lo que podemos discutir en este art√≠culo.  La salida detallada con la <code>--Verbose</code> incluye informaci√≥n sobre la versi√≥n <code>ld</code> , arquitecturas compatibles y mucho m√°s.  Todo esto es bueno saberlo, pero dicha sintaxis es inaceptable en el script del enlazador, as√≠ que abra un editor de texto y elimine todo lo superfluo del archivo. <br><br><pre>  vim riscv64-virt.ld<font></font>
<font></font>
 # Eliminar todo lo anterior e incluir la l√≠nea =============
 GNU ld (GNU Binutils) 2.32
   Emulaciones compatibles:
    elf64lriscv
    elf32lriscv
 usando un script de enlazador interno:
 ===================================================
 / * Script para -z combreloc: combina y ordena las secciones de reubicaci√≥n * /
 / * Copyright (C) 2014-2019 Free Software Foundation, Inc.
    Copia y distribuci√≥n de este script, con o sin modificaci√≥n,
    est√°n permitidos en cualquier medio sin regal√≠as siempre que los derechos de autor
    aviso y este aviso se conservan.  * /
 OUTPUT_FORMAT ("elf64-littleriscv", "elf64-littleriscv",
	       "elf64-littleriscv")
 ... resto del script del enlazador ... </pre><br>  Despu√©s de eso, ejecute el comando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MEMORY</a> para determinar manualmente d√≥nde estar√° <code>__stack_top</code> .  Localice la l√≠nea que comienza con <code>OUTPUT_ARCH(riscv)</code> , debe estar en la parte superior del archivo y agregue el comando <code>MEMORY</code> debajo: <br><br><pre> <code class="plaintext hljs">OUTPUT_ARCH(riscv) /* &gt;&gt;&gt; Our addition. &lt;&lt;&lt; */ MEMORY { /* qemu-system-risc64 virt machine */ RAM (rwx) : ORIGIN = 0x80000000, LENGTH = 128M } /* &gt;&gt;&gt; End of our addition. &lt;&lt;&lt; */ ENTRY(_start)</code> </pre> <br>  Creamos un bloque de memoria llamado <code>RAM</code> , para el cual se permite leer ( <code>r</code> ), escribir ( <code>w</code> ) y almacenar el c√≥digo ejecutable ( <code>x</code> ). <br><br>  Genial, hemos definido un dise√±o de memoria que coincide con las especificaciones de nuestra m√°quina <code>virt</code> RISC-V.  Ahora puedes usarlo.  Queremos poner nuestra pila en la memoria. <br><br>  <code>__stack_top</code> definir el car√°cter <code>__stack_top</code> .  Abra su script de enlace ( <code>riscv64-virt.ld</code> ) en un editor de texto y agregue algunas l√≠neas: <br><br><pre> <code class="plaintext hljs">SECTIONS { /* Read-only sections, merged into text segment: */ PROVIDE (__executable_start = SEGMENT_START("text-segment", 0x10000)); . = SEGMENT_START("text-segment", 0x10000) + SIZEOF_HEADERS; /* &gt;&gt;&gt; Our addition. &lt;&lt;&lt; */ PROVIDE(__stack_top = ORIGIN(RAM) + LENGTH(RAM)); /* &gt;&gt;&gt; End of our addition. &lt;&lt;&lt; */ .interp : { *(.interp) } .note.gnu.build-id : { *(.note.gnu.build-id) }</code> </pre> <br>  Como puede ver, definimos <code>__stack_top</code> usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el comando</a> <code>__stack_top</code> .  Se podr√° acceder al s√≠mbolo desde cualquier programa asociado con este script (suponiendo que el programa en s√≠ mismo no determine algo con el nombre <code>__stack_top</code> ).  Establezca <code>__stack_top</code> en <code>ORIGIN(RAM)</code> .  Sabemos que este valor es <code>0x80000000</code> m√°s <code>LENGTH(RAM)</code> , que es 128 megabytes ( <code>0x8000000</code> bytes).  Esto significa que nuestro <code>__stack_top</code> establecido en <code>0x88000000</code> . <br><br>  Por brevedad, no enumerar√© el archivo de enlace completo <a href="">aqu√≠</a> ; puede verlo <a href="">aqu√≠</a> . <br><br><a name="8"></a><h1>  Basta!  <s>Hammertime!</s>  Tiempo de ejecuci√≥n! </h1><br>  Ahora tenemos todo lo que necesitamos para crear nuestro propio tiempo de ejecuci√≥n de C. En realidad, esta es una tarea bastante simple, aqu√≠ est√° todo el archivo <code>crt0.s</code> : <br><br><pre> <code class="plaintext hljs">.section .init, "ax" .global _start _start: .cfi_startproc .cfi_undefined ra .option push .option norelax la gp, __global_pointer$ .option pop la sp, __stack_top add s0, sp, zero jal zero, main .cfi_endproc .end</code> </pre> <br>  Inmediatamente atrae una gran cantidad de l√≠neas que comienzan con un punto.  Este es un archivo para ensamblador <code>as</code> .  Las l√≠neas con puntos se denominan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">directivas de ensamblador</a> : proporcionan informaci√≥n para el ensamblador.  Este no es un c√≥digo ejecutable, como las instrucciones del ensamblador RISC-V como <code>jal</code> y <code>add</code> . <br><br>  Veamos el archivo l√≠nea por l√≠nea.  Trabajaremos con varios registros RISC-V est√°ndar, as√≠ que consulte <a href="">esta tabla</a> , que cubre todos los registros y su prop√≥sito. <br><br><pre> <code class="plaintext hljs">.section .init, "ax"</code> </pre> <br>  Como se indica en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el manual del ensamblador GNU 'como'</a> , esta l√≠nea le dice al ensamblador que inserte el siguiente c√≥digo en la secci√≥n <code>.init</code> , que se asigna ( <code>a</code> ) y el ejecutable ( <code>x</code> ).  Esta secci√≥n es otra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">convenci√≥n com√∫n</a> para ejecutar c√≥digo dentro del sistema operativo.  Trabajamos en hardware puro sin un sistema operativo, por lo que en nuestro caso tal instrucci√≥n puede no ser absolutamente necesaria, pero en cualquier caso, esta es una buena pr√°ctica. <br><br><pre> <code class="plaintext hljs">.global _start _start:</code> </pre> <br>  <code>.global</code> pone el siguiente personaje a disposici√≥n de <code>ld</code> .  Sin esto, el enlace no funcionar√°, porque el <code>ENTRY(_start)</code> en el script del enlazador apunta al s√≠mbolo <code>_start</code> como el punto de entrada al archivo ejecutable.  La siguiente l√≠nea le dice al ensamblador que estamos comenzando la definici√≥n del car√°cter <code>_start</code> . <br><br><pre> <code class="plaintext hljs">_start: .cfi_startproc .cfi_undefined ra ...other stuff... .cfi_endproc</code> </pre> <br>  Estas directivas <code>.cfi</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informan</a> sobre la estructura del marco y c√≥mo manejarlo.  Las <code>.cfi_endproc</code> <code>.cfi_startproc</code> y <code>.cfi_endproc</code> se√±alan el comienzo y el final de la funci√≥n, y <code>.cfi_undefined ra</code> le dice al ensamblador que el registro <code>ra</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">no debe restaurarse</a> a ning√∫n valor que contenga antes de que se <code>_start</code> . <br><br><pre> <code class="plaintext hljs">.option push .option norelax la gp, __global_pointer$ .option pop</code> </pre> <br>  Estas directivas <code>.option</code> cambian el comportamiento del ensamblador de acuerdo con el c√≥digo cuando necesita aplicar un conjunto espec√≠fico de opciones.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠ hay una</a> descripci√≥n detallada de por qu√© es importante el uso de <code>.option</code> en este segmento: <br><br><blockquote>  <i>... dado que posiblemente relajemos el direccionamiento de secuencias a secuencias m√°s cortas en relaci√≥n con el GP, la carga inicial del GP no deber√≠a debilitarse y deber√≠a ser algo como esto:</i> <i><br><br></i> <pre> <code class="plaintext hljs">.option push .option norelax la gp, __global_pointer$ .option pop</code> </pre> <br>  para que despu√©s de relajarte obtengas el siguiente c√≥digo: <br><br><pre> <code class="plaintext hljs">auipc gp, %pcrel_hi(__global_pointer$) addi gp, gp, %pcrel_lo(__global_pointer$)</code> </pre> <br>  en lugar de simple: <br><br><pre> <code class="plaintext hljs">addi gp, gp, 0</code> </pre> </blockquote><br>  Y ahora la √∫ltima parte de nuestros <code>crt0.s</code> : <br><br><pre> <code class="plaintext hljs">_start: ...other stuff... la sp, __stack_top add s0, sp, zero jal zero, main .cfi_endproc .end</code> </pre> <br>  Aqu√≠ finalmente podemos usar el s√≠mbolo <code>__stack_top</code> , que trabajamos mucho para crear.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La</a> <code>__stack_top</code> <code>la</code> (direcci√≥n de carga) carga el valor <code>__stack_top</code> en el registro <code>sp</code> (puntero de pila), configur√°ndolo para su uso en el resto del programa. <br><br>  Luego <code>add s0, sp, zero</code> agrega los valores de los registros <code>sp</code> y <code>zero</code> (que en realidad es el registro <code>x0</code> con una referencia fija a 0) y coloca el resultado en el registro <code>s0</code> .  Este es un <a href="">registro especial</a> que es inusual en varios aspectos.  En primer lugar, es un "registro persistente", es decir, se guarda cuando se llama a la funci√≥n.  En segundo lugar, <code>s0</code> veces act√∫a como un puntero de cuadro, lo que le da a cada funci√≥n llamar un peque√±o espacio en la pila para almacenar los par√°metros pasados ‚Äã‚Äãa esta funci√≥n.  C√≥mo funcionan las llamadas de funci√≥n con los punteros de pila y marco es un tema muy interesante que puede dedicar f√°cilmente a un art√≠culo separado, pero por ahora, solo sepa que en nuestro tiempo de ejecuci√≥n es importante inicializar el puntero de marco <code>s0</code> . <br><br>  A continuaci√≥n vemos el <code>jal zero, main</code> declaraci√≥n <code>jal zero, main</code> .  Aqu√≠ <code>jal</code> significa salto y enlace.  La instrucci√≥n espera operandos en forma de <code>jal rd (destination register), offset_address</code> .  Funcionalmente, <code>jal</code> escribe el valor de la siguiente instrucci√≥n (registro de <code>pc</code> m√°s cuatro) en <code>rd</code> , y luego establece el registro de <code>pc</code> valor de <code>pc</code> actual m√°s la direcci√≥n de desplazamiento con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">extensi√≥n de signo</a> , efectivamente "llamando" a esta direcci√≥n. <br><br>  Como se mencion√≥ anteriormente, <code>x0</code> estrechamente vinculado al valor literal 0, y escribir en √©l es in√∫til.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, puede parecer extra√±o que usemos un registro como registro de destino </font></font><code>zero</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que los ensambladores RISC-V interpretan como un registro </font></font><code>x0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Despu√©s de todo, esto significa una transici√≥n incondicional a </font></font><code>offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. ¬øPor qu√© hacer esto, porque en otras arquitecturas hay una instrucci√≥n expl√≠cita para una transici√≥n incondicional? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este patr√≥n extra√±o </font></font><code>jal zero, offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es en realidad una optimizaci√≥n inteligente. El soporte para cada nueva instrucci√≥n significa un aumento y, en consecuencia, un aumento en el costo del procesador. Por lo tanto, cuanto m√°s simple sea el ISA, mejor. En lugar de contaminar el espacio de instrucciones con dos instrucciones </font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>unconditional jump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la arquitectura RISC-V solo es compatible </font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y se admiten saltos incondicionales </font></font><code>jal zero, main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-V tiene muchas de estas optimizaciones, la mayor√≠a de las cuales toman la forma de las llamadas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pseudoinstrucciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Los ensambladores saben c√≥mo traducirlos en instrucciones reales de hardware. </font><font style="vertical-align: inherit;">Por ejemplo, </font></font><code>j offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">los ensambladores RISC-V traducen </font><font style="vertical-align: inherit;">pseudoinstrucciones </font><font style="vertical-align: inherit;">para saltos </font><font style="vertical-align: inherit;">incondicionales </font><font style="vertical-align: inherit;">a </font></font><code>jal zero, offset_address</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para obtener una lista completa de pseudo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instrucciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oficialmente compatibles </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">,</font></a><font style="vertical-align: inherit;"> consulte </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">la especificaci√≥n RISC-V (versi√≥n 2.2)</font></a><font style="vertical-align: inherit;"> .</font></font><br><br><pre> <code class="plaintext hljs">_start: ...other stuff... jal zero, main .cfi_endproc .end</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuestra √∫ltima l√≠nea es la directiva del ensamblador </font></font><code>.end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que simplemente marca el final del archivo.</font></font><br><br><a name="9"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Depurar pero ahora de verdad </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intentando depurar un programa C simple en un procesador RISC-V, resolvimos muchos problemas. </font><font style="vertical-align: inherit;">Primero, usamos </font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>dtc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encontramos nuestra memoria en la m√°quina virtual </font></font><code>virt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RISC-V. </font><font style="vertical-align: inherit;">Luego usamos esta informaci√≥n para controlar manualmente la asignaci√≥n de memoria en nuestra versi√≥n del script predeterminado del enlazador </font></font><code>riscv64-unknown-elf-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lo que nos permiti√≥ determinar con precisi√≥n el s√≠mbolo </font></font><code>__stack_top</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Luego usamos este s√≠mbolo en nuestra propia versi√≥n </font></font><code>crt0.s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que configura nuestra pila y punteros globales, y finalmente llamamos a la funci√≥n </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ahora puede lograr su objetivo y comenzar a depurar nuestro sencillo programa en GDB. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recordemos aqu√≠ est√° el programa C en s√≠:</font></font><br><br><pre> <code class="cpp hljs">cat add.<span class="hljs-function"><span class="hljs-function">c </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">12</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = a + b; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Compilar y vincular: </font></font><br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gcc -g -ffreestanding -O0 -Wl,--gc-sections -nostartfiles -nostdlib -nodefaultlibs -Wl,-T,riscv64-virt.ld crt0.s add.c</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ indicamos muchas m√°s banderas que la √∫ltima vez, as√≠ que repasemos las que no hemos descrito antes. </font></font><br><br> <code>-ffreestanding</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le dice al compilador que la biblioteca est√°ndar puede no existir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , por lo que no es necesario hacer suposiciones sobre su disponibilidad obligatoria. Este par√°metro no es necesario al iniciar la aplicaci√≥n en su host (en el sistema operativo), pero en este caso no lo es, por lo tanto, es importante informar al compilador de esta informaci√≥n. </font></font><br><br> <code>-Wl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Una lista de banderas separadas por comas para pasar al enlazador ( </font></font><code>ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Aqu√≠, </font></font><code>--gc-sections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">significa "secciones de recolecci√≥n de basura", y </font></font><code>ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se le indica que elimine las secciones no utilizadas despu√©s del enlace. Flags </font></font><code>-nostartfiles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>-nostdlib</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>-nodefaultlibs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√≠gale al enlazador que no procese los archivos de inicio del sistema est√°ndar (por ejemplo, predeterminado</font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), implementaciones est√°ndar de stdlib del sistema y bibliotecas vinculadas predeterminadas del sistema est√°ndar. </font><font style="vertical-align: inherit;">Tenemos nuestro propio script </font></font><code>crt0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y enlazador, por lo que es importante pasar estos marcadores para que los valores predeterminados no entren en conflicto con nuestras preferencias de usuario. </font></font><br><br> <code>-T</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indica la ruta a nuestro script de enlazador, que es simple en nuestro caso </font></font><code>riscv64-virt.ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Finalmente, especificamos los archivos que queremos compilar, compilar y componer: </font></font><code>crt0.s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>add.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como antes, el resultado es un archivo completo y listo para ejecutarse llamado </font></font><code>a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora ejecute nuestro nuevo ejecutable completamente nuevo en </font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># -S freezes execution of our executable (-kernel) until we explicitly tell # it to start with a 'continue' or 'c' from our gdb client qemu-system-riscv64 -machine virt -m 128M -gdb tcp::1234 -S -kernel a.out</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora ejecute </font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, recuerde cargar los s√≠mbolos de depuraci√≥n para </font></font><code>a.out</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, especific√°ndolo con el √∫ltimo argumento:</font></font><br><br><pre> <code class="bash hljs">riscv64-unknown-elf-gdb --tui a.out GNU gdb (GDB) 8.2.90.20190228-git Copyright (C) 2019 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt; This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Type <span class="hljs-string"><span class="hljs-string">"show copying"</span></span> and <span class="hljs-string"><span class="hljs-string">"show warranty"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. This GDB was configured as <span class="hljs-string"><span class="hljs-string">"--host=x86_64-apple-darwin17.7.0 --target=riscv64-unknown-elf"</span></span>. Type <span class="hljs-string"><span class="hljs-string">"show configuration"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> configuration details. For bug reporting instructions, please see: &lt;http://www.gnu.org/software/gdb/bugs/&gt;. Find the GDB manual and other documentation resources online at: &lt;http://www.gnu.org/software/gdb/documentation/&gt;. For <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-string"><span class="hljs-string">"help"</span></span>. Type <span class="hljs-string"><span class="hljs-string">"apropos word"</span></span> to search <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> commands related to <span class="hljs-string"><span class="hljs-string">"word"</span></span>... Reading symbols from a.out... (gdb)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego, conecte nuestro cliente </font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al servidor </font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que lanzamos como parte del comando </font></font><code>qemu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="bash hljs">(gdb) target remote :1234 ‚îÇ Remote debugging using :1234</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Establecer un punto de interrupci√≥n en main: </font></font><br><br><pre> <code class="bash hljs">(gdb) b main Breakpoint 1 at 0x8000001e: file add.c, line 2.</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y comienza el programa: </font></font><br><br><pre> <code class="bash hljs">(gdb) c Continuing. Breakpoint 1, main () at add.c:2</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°De la salida dada est√° claro que alcanzamos con √©xito el punto de interrupci√≥n en la l√≠nea 2! </font><font style="vertical-align: inherit;">Esto tambi√©n es visible en la interfaz de texto, finalmente tenemos la l√≠nea correcta </font></font><code>L</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el valor </font></font><code>PC:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es </font></font><code>L2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>PC:</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>0x8000001e</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si hizo todo como en el art√≠culo, la salida ser√° algo como esto: a </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd8/aa9/78d/bd8aa978df4289f584b5c422cdb6e44c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partir de ahora, puede usarlo </font></font><code>gdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como de costumbre: </font></font><code>-s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para ir a la siguiente instrucci√≥n, </font></font><code>info all-registers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para verificar los valores dentro de los registros a medida que se ejecuta el programa, etc. Experimente para su placer ... nosotros, por supuesto ¬°Trabaj√© mucho por esto!</font></font><br><br><a name="10"></a><h1>  Que sigue </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Hoy hemos logrado mucho y espero haber aprendido mucho! Nunca tuve un plan formal para este y otros art√≠culos, solo segu√≠ lo que era m√°s interesante para m√≠ en todo momento. Por lo tanto, no estoy seguro de lo que suceder√° despu√©s. Me gust√≥ especialmente la inmersi√≥n profunda en las instrucciones </font></font><code>jal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, por lo que tal vez en el pr√≥ximo art√≠culo tomaremos como base el conocimiento adquirido aqu√≠, pero lo reemplazaremos con </font></font><code>add.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alg√∫n programa en ensamblador RISC-V puro. Si tiene algo espec√≠fico que le gustar√≠a ver o tiene alguna pregunta, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abra las entradas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gracias por leer! ¬°Espero encontrarme en el pr√≥ximo art√≠culo!</font></font><br><br><a name="11"></a><h1>  Opcional </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si le gust√≥ el art√≠culo y quiere saber m√°s, consulte la presentaci√≥n de Matt Godbolt titulada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúBits Between Bits: How We Get into main ()‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la conferencia CppCon2018. </font><font style="vertical-align: inherit;">Ella aborda el tema un poco diferente de lo que estamos aqu√≠. </font><font style="vertical-align: inherit;">Muy buena conferencia, ¬°compru√©balo por ti mismo!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/454208/">https://habr.com/ru/post/454208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454190/index.html">Lo que no necesita hacer si le roban su tel√©fono</a></li>
<li><a href="../454196/index.html">Impresi√≥n 3D de electr√≥nica utilizando un ejemplo de dron: ya no se necesitan cables ni tableros</a></li>
<li><a href="../454198/index.html">Creaci√≥n de un proyecto angular de varios m√≥dulos Gradle SpringBoot + en IDEA</a></li>
<li><a href="../454204/index.html">El rastreo conductual no es una panacea?</a></li>
<li><a href="../454206/index.html">PHDays 9: an√°lisis de AI CTF</a></li>
<li><a href="../454210/index.html">Enchantjs olvidado + nuevo 1C-Bitrix = Juego para motivar al cliente</a></li>
<li><a href="../454214/index.html">Odio casi todo el software</a></li>
<li><a href="../454216/index.html">Evidencia encontrada de que todos los cambios son una mezcla de orden y oportunidad</a></li>
<li><a href="../454220/index.html">Term√≥metro de dos d√≠gitos</a></li>
<li><a href="../454222/index.html">Actualice el subsistema de disco del servidor anterior con el bus PCIe 1.0 - 2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>