<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¥ üë®‚Äçüëß‚Äçüëß üç¶ TinyFL - controlador de linterna microcontrolador ‚òÇÔ∏è üèº üôÜüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola habr 


 Quiero contar una historia sobre c√≥mo me puse en manos de un faro chino con un LED Cree XM-L y qu√© sucedi√≥ despu√©s. 



 Antecedentes 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TinyFL - controlador de linterna microcontrolador</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464673/"><p>  Hola habr </p><br><p>  Quiero contar una historia sobre c√≥mo me puse en manos de un faro chino con un LED Cree XM-L y qu√© sucedi√≥ despu√©s. </p><br><p><img src="https://habrastorage.org/webt/ec/vx/uq/ecvxuq8hlp8-x_b6iacutkxyrmo.jpeg"></p><a name="habracut"></a><br><h2 id="predystoriya">  Antecedentes </h2><br><p>  √ârase una vez, ped√≠ una linterna con un LED brillante de un sitio chino.  La linterna result√≥ ser bastante ergon√≥mica (aunque podr√≠a ser m√°s f√°cil), pero su controlador dejaba mucho que desear. </p><br><p>  Brillaba lo suficientemente brillante, pero el controlador ten√≠a solo 3 modos: muy brillante, brillante y estrobosc√≥pico, el cambio entre los cuales se hizo con solo tocar un bot√≥n.  Para encender y apagar la linterna, era necesario ordenar estos 3 modos cada vez.  Adem√°s, esta linterna, cuando se encendi√≥, descarg√≥ la bater√≠a hasta el final, por lo que un par de mis latas 18650 se descargaron profundamente. </p><br><p>  Todo esto fue inc√≥modo y molesto, por lo que en alg√∫n momento decid√≠ hacer mi conductor, que ser√° la historia adicional. </p><br><div class="spoiler">  <b class="spoiler_title">Linterna con un viejo conductor</b> <div class="spoiler_text"><p>  <em>Aqu√≠ hay una linterna, probablemente muchos han tratado con similares</em> <br><img src="https://habrastorage.org/webt/lp/8j/cy/lp8jcyodmsrehdop-qawqouaw-g.jpeg"></p><br><p>  <em>Se parece al controlador original</em> <br><img src="https://habrastorage.org/webt/g-/cr/-w/g-cr-w88dmljau5oknxtpcxbrmu.jpeg"></p></div></div><br><h2 id="tehnicheskoe-zadanie">  T√©rminos de referencia </h2><br><p>  Como saben, para lograr un buen resultado, cualquier desarrollo debe tener buenas especificaciones t√©cnicas, por lo que intentar√© formularlo por m√≠ mismo.  Entonces, el conductor debe: </p><br><ul><li>  Para poder encender / apagar presionando brevemente un bot√≥n (un bot√≥n sin fijar).  Quiz√°s esta sea la raz√≥n principal por la que comenz√≥ todo esto. </li><li>  Tenga un control de brillo suave (continuo), desde el m√°s brillante - "turbo" hasta "luz de luna" cuando el diodo est√° apenas iluminado.  El brillo debe cambiar de manera uniforme. </li><li>  Recuerde el brillo establecido para el tiempo libre. </li><li>  Monitoree la carga de la bater√≠a, advirtiendo cuando est√© casi descargada (aproximadamente 3.3V) y apag√°ndose cuando est√© completamente descargada (aproximadamente 2.9V).  Para diferentes bater√≠as, estos par√°metros pueden ser diferentes.  En consecuencia, el voltaje de funcionamiento debe estar en el rango de 2.7 ~ 4.5V. </li><li>  Tiene 2 modos especiales: baliza de emergencia y luz estrobosc√≥pica (bueno, ¬øpor qu√© no?) </li><li>  Para poder encender / apagar el LED trasero (esto es cierto al andar en bicicleta por la noche, resulta algo as√≠ como una luz indicadora). </li><li>  Tener protecci√≥n contra polaridad inversa y electricidad est√°tica.  No necesariamente, pero ser√° una buena adici√≥n, porque en la oscuridad puede colocar la bater√≠a por el lado equivocado. </li><li>  Sea m√°s peque√±o que el controlador original en tama√±o, pero tenga la misma huella.  El controlador chino es simplemente enorme, por lo que hacerlo m√°s grande no ser√° f√°cil. </li></ul><br><p>  Bueno, si la linterna est√° modificada, ¬øpor qu√© no construir un cargador con un conector micro-USB?  Siempre tengo un cable y una carga USB a mano, y tengo que buscar una fuente de alimentaci√≥n nativa. </p><br><h2 id="zhelezo">  Hierro </h2><br><p>  Tengo cierta experiencia con Arduino, por lo que se decidi√≥ hacer un controlador en la familia AVR MK.  Est√°n ampliamente disponibles, son f√°ciles de programar y tienen modos de baja potencia (suspensi√≥n). </p><br><p>  El microcontrolador Attiny13a fue elegido como el "cerebro" del conductor: es uno de los MC Atmel m√°s baratos (ahora absorbido por Microchip), tiene todo a bordo: un GPIO para conectar un bot√≥n y un LED, un temporizador para generar una se√±al PWM, un ADC para medir voltaje y EEPROM para guardar par√°metros.  Solo est√° disponible 1 KB de memoria flash (pero cu√°nto se necesita para una linterna), as√≠ como 64 B de RAM y la misma cantidad de EEPROM. <br>  Attiny13 est√° disponible en varias opciones de carcasa, en particular en DIP-8, que se puede insertar directamente en una placa de pruebas normal con un paso de 2,54 mm. </p><br><p>  Dado que solo 3 cables van desde la parte posterior a la cabeza de la linterna, el bot√≥n se ve obligado a cortocircuitar a tierra (sobre la imposibilidad de un cortocircuito a m√°s, m√°s adelante), tendr√° que cambiar el LED en el m√°s, lo que significa que necesita un poste de canal P.  Tom√© AO3401 como tal transistor, pero puede tomar SI2323, es m√°s costoso, pero tiene menos resistencia de canal abierto (40 mOhm, mientras que AO3401 tiene 60 mOhm, a 4.5 V), por lo tanto, el controlador se calentar√° menos. </p><br><p>  <em>De las palabras a los hechos, recojo en una placa una versi√≥n preliminar</em> <br><img src="https://habrastorage.org/webt/6g/tx/89/6gtx89n9apulzr9kwouv9v-vkn8.jpeg"></p><br><p>  Actualmente se alimenta directamente del programador, con un voltaje de 5 V (en realidad menos debido a las p√©rdidas en el cable USB).  En lugar del LED, el XM-L hasta ahora ha pegado un LED normal en las patas y ha puesto un transistor d√©bil con un voltaje de umbral alto. <br>  Luego, en el programa Altium Designer, se dibuj√≥ un diagrama, que complet√© con protecci√≥n contra polaridad inversa y ESD. </p><br><p><img src="https://habrastorage.org/webt/nt/cv/re/ntcvrepefjh36tyfclmcwze_e4o.png"></p><br><div class="spoiler">  <b class="spoiler_title">Descripci√≥n detallada y prop√≥sito de todos los componentes.</b> <div class="spoiler_text"><h4 id="obyazatelnye-komponenty">  Prerrequisitos: </h4><br><p>  U1 - Microcontrolador Attiny13a en paquete 8S1 (√≠ndice SSU) </p><br><p>  C1 - condensador de desacoplamiento para la fuente de alimentaci√≥n del microcontrolador, debe estar en la regi√≥n de 0.1 microfaradios, caso 1206 o 0805, coeficiente de temperatura X7R </p><br><p>  R1-R2 es un divisor de resistencia para medir el voltaje de la bater√≠a, aqu√≠ se puede establecer cualquier clasificaci√≥n, aqu√≠ la relaci√≥n principal (750K / 220K, relaci√≥n de divisi√≥n 4.41) y la corriente de fuga, que ser√° mayor si las clasificaciones aumentan (en la corriente es de aproximadamente 4 ŒºA).  Como se usa un ION interno (1.1 V, de acuerdo con la hoja de datos, puede estar entre 1.0 V - 1.2 V), el voltaje m√°ximo en la salida del divisor no debe ser m√°s de 1 V. Con un divisor 750/220, el voltaje m√°ximo permitido en la entrada del divisor ser√° 4.41 V, que m√°s que suficiente para todo tipo de bater√≠as de litio. <br>  Calcul√© el divisor usando esta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">calculadora</a> . </p><br><p>  R3: protege la salida del puerto del microcontrolador de un cortocircuito (si PB1 de repente se tira a VCC, una corriente grande fluir√° a trav√©s del pin y el MC puede quemarse) </p><br><p>  R4: tirar de RESET MK al poder, sin √©l, es posible reiniciar desde las pastillas. </p><br><p>  Q1 - Transistor de efecto de campo de canal P en el paquete SOT-23, instal√© el AO3401, pero cualquier otro con un pinout adecuado (por ejemplo, SI2323) </p><br><p>  R7 es una resistencia de compuerta limitadora de corriente.  Dado que la puerta del transistor tiene una cierta capacidad, al cargar esta capacidad, una corriente grande puede pasar a trav√©s del pin y el pin puede fallar.  Puede configurarlo en la regi√≥n de 100-220 ohmios (ya no deber√≠a ser, el transistor comenzar√° a estar en estado medio cerrado durante mucho tiempo y, como resultado, se calentar√° m√°s) </p><br><p>  R6 - obturador pull-up de resistencia a la alimentaci√≥n.  En caso de que PB0 entre en un estado de alta impedancia, la l√≥gica 1 se instalar√° a trav√©s de esta resistencia en la puerta Q1 y el transistor se cerrar√°.  Esto puede suceder debido a un error en el c√≥digo o en el modo de programaci√≥n. </p><br><p>  D2 - diodo de "bloqueo" - permite que el voltaje "se caiga" (cuando el LED se enciende por un per√≠odo corto a pleno brillo) para alimentar el MK desde el capacitor por un tiempo, tambi√©n protege contra la polaridad inversa. <br>  Puede poner cualquier diodo Schottky en el paquete SOD323 con una ca√≠da de voltaje m√≠nima, puse BAT60. </p><br><p>  Inicialmente, la protecci√≥n contra la polaridad inversa de la fuente de alimentaci√≥n se realiz√≥ en el transistor de efecto de campo (esto se puede ver en las placas hechas por bot√≠n).  Una caracter√≠stica desagradable sali√≥ despu√©s del cableado: cuando se encendi√≥ la carga, se produjo una ca√≠da de voltaje y el MK se reinici√≥, ya que el trabajador de campo no limita la corriente en la direcci√≥n opuesta.  Al principio solde√© un condensador electrol√≠tico de 200 uF entre VCC y GND, pero no me gust√≥ esta soluci√≥n debido a su tama√±o.  Tuve que soldar el transistor y colocar un diodo en su lugar, ya que el SOT-23 y el SOD-323 tienen dimensiones similares. </p><br><p>  Total, en el circuito solo se requieren 10 componentes para la instalaci√≥n. </p><br><h4 id="neobyazatelnye-komponenty">  Componentes opcionales: </h4><br><p>  R5 y D1 son responsables de la luz de fondo (LED2).  La calificaci√≥n m√≠nima de R5 es de 100 ohmios.  Cuanto mayor sea la clasificaci√≥n, m√°s d√©bil se encender√° el LED posterior (se enciende en modo constante, sin PWM).  D1 - cualquier LED en el caso 1206, puse verde, porque  visualmente son m√°s brillantes a las mismas corrientes que otros. </p><br><p>  D3 y D4 son diodos protectores (TVS), utilic√© PESD5V0 (5.0V) en el paquete SOD323.  D3 protege contra sobretensiones por energ√≠a, D4 - por un bot√≥n.  Si el bot√≥n est√° cubierto por una membrana, entonces no tiene un significado especial.  Probablemente valga la pena usar diodos protectores bidireccionales, de lo contrario, cuando se invierte la polaridad, la corriente fluir√° a trav√©s de ellos y se quemar√°n (ver CVC de un diodo protector bidireccional). </p><br><p>  C2: un condensador de tantalio en el caso A (similar a 1206), tiene sentido configurarlo cuando el controlador es inestable (el voltaje de alimentaci√≥n puede exprimirse a altas corrientes de conmutaci√≥n del LED) </p><br><p>  Todas las resistencias de tama√±o 0603 (para m√≠, este es un l√≠mite adecuado para la soldadura manual) </p></div></div><br><p>  Todo est√° claro con los componentes, puede hacer una placa de circuito impreso de acuerdo con el esquema anterior. <br>  Lo primero que debe hacer es construir un modelo 3D de la futura placa, junto con los agujeros: en mi humilde opini√≥n, en Altium Designer, esta es la forma m√°s conveniente de determinar la geometr√≠a de la PCB. <br>  Med√≠ las dimensiones del viejo controlador y sus orificios de montaje: la placa debe estar unida a ellos, pero debe tener dimensiones m√°s peque√±as (por versatilidad, de repente tienes que construirlo en otro lugar). <br>  Un m√≠nimo razonable aqu√≠ result√≥ en alg√∫n lugar alrededor de 25x12.5 mm (relaci√≥n de aspecto 2: 1) con dos orificios con un di√°metro de 2 mm para unir a la carcasa de la l√°mpara con tornillos nativos. </p><br><p>  Hice un modelo 3D en SolidWorks, luego lo export√© a Altium Designer como STEP. <br>  Luego coloqu√© los componentes en el tablero, hice los contactos en las esquinas (es m√°s conveniente y m√°s f√°cil soldar el suelo), Attiny13 colocado en el centro, el transistor m√°s cerca de los contactos LED. <br>  Extend√≠ las pistas de potencia, coloqu√© los componentes restantes tal como resultaron y separ√© las pistas de se√±al.  Para la conveniencia de conectar la memoria, saqu√© contactos separados para ella, que duplican los contactos de la bater√≠a. <br>  Hice todo el cableado (con la excepci√≥n de un puente) en la capa superior, para poder hacer un tablero en casa con LUT. <br>  El ancho m√≠nimo de las rutas de se√±al es de 0.254 mm / 10 mil, las de potencia tienen un ancho m√°ximo siempre que sea posible. </p><br><p>  <em>As√≠ es como se ve la placa cableada en Altium Designer</em> <br><img src="https://habrastorage.org/webt/yu/i4/bo/yui4bosmzwqjagvmj_clljr09ck.png"></p><br><p>  Altium Designer tiene la oportunidad de ver c√≥mo se ver√° la placa en 3D (para esto necesita modelos para todos los componentes, algunos tuvieron que ser construidos por usted mismo). <br>  Quiz√°s alguien aqu√≠ diga que el modo 3D no es necesario para el trazador, pero para m√≠ personalmente es una funci√≥n conveniente que facilita la colocaci√≥n de componentes para la conveniencia de la soldadura. </p><br><p><img src="https://habrastorage.org/webt/my/jk/1r/myjk1rvgvm50odtu4iy77czuy3i.png"></p><br><p>  Al momento de escribir, se hicieron 3 versiones de la placa: la primera para LUT, la segunda para la fabricaci√≥n industrial y la tercera, final con algunas correcciones. </p><br><h2 id="izgotovlenie-plat">  Junta haciendo </h2><br><h3 id="samodelnyy-sposob">  Manera casera </h3><br><p>  LUT: tecnolog√≠a de planchado por l√°ser, un m√©todo para producir placas de circuito mediante grabado en una m√°scara obtenida al convertir el t√≥ner de papel a cobre.  Este m√©todo es ideal para placas simples de un solo lado, como este controlador. <br>  La red tiene muchos art√≠culos sobre esta tecnolog√≠a, por lo que no entrar√© en detalles, sino que solo le contar√© brevemente c√≥mo lo hago. </p><br><p>  Primero debe preparar una plantilla que se imprimir√° en papel t√©rmico.  Exporto la capa top_layer a PDF, obtengo una imagen vectorial. </p><br><p><img src="https://habrastorage.org/webt/lq/f3/dm/lqf3dmub3ivxcx3y32uijk9dy2a.png"></p><br><p>  Dado que la placa es peque√±a, tiene sentido tomar un pedazo de PCB con dimensiones varias veces m√°s grandes y hacer lo que la industria llama paneles. <br>  Para estos fines, CorelDraw es muy conveniente, pero puede usar cualquier otro editor de vectores. <br>  Coloco copias de plantillas en el documento, hago espacios de 0.5-1 mm entre los tableros (depende del m√©todo de separaci√≥n, m√°s sobre eso m√°s adelante), los tableros deben ubicarse sim√©tricamente; de ‚Äã‚Äãlo contrario, ser√° dif√≠cil separarlos. </p><br><p>  Recojo una pieza de PCB de un lado con dimensiones ligeramente m√°s grandes que el panel ensamblado, limpio y desengrasado (prefiero frotar con un borrador y luego con alcohol).  Imprimo una plantilla para grabar en papel t√©rmico (aqu√≠ es importante no olvidar duplicar la plantilla). <br>  Con la ayuda de una plancha y paciencia, acariciando suavemente el papel, lo traduzco a textolita.  Espero a que se enfr√≠e y despegue cuidadosamente el papel. <br>  Las √°reas libres de cobre (no recubiertas con t√≥ner) pueden barnizarse o pegarse con cinta adhesiva (cuanto menor sea el √°rea de cobre, m√°s r√°pida ser√° la reacci√≥n de grabado). </p><br><p>  <em>Un panel de este tipo en el hogar: una gran cantidad de tableros puede compensar los defectos de fabricaci√≥n</em> <br><img src="https://habrastorage.org/webt/ob/f-/fk/obf-fkjp7lq5fcrxrr_x7rprgw8.jpeg"></p><br><p>  Enveneno las tablas con √°cido c√≠trico en una soluci√≥n de per√≥xido de hidr√≥geno, esta es la forma m√°s econ√≥mica, aunque es bastante lenta. <br>  Las proporciones son las siguientes: para 100 ml de per√≥xido, el 3% son 30 g de √°cido c√≠trico y aproximadamente 5 g de sal, todo se mezcla y se vierte en un recipiente con textolita. <br>  Calentar la soluci√≥n acelerar√° la reacci√≥n, pero puede hacer que el t√≥ner se despegue. </p><br><p>  <em>Comienza la magia qu√≠mica desconocida: el cobre est√° cubierto de burbujas y la soluci√≥n adquiere un tinte azul</em> <br><img src="https://habrastorage.org/webt/bc/jh/pz/bcjhpzjgqcrcmqq1wr8j_def1yw.jpeg"></p><br><p>  Despu√©s de un tiempo saco la placa grabada y la limpio de t√≥ner.  No puedo lavarlo con ning√∫n solvente, as√≠ que lo elimino mec√°nicamente con papel de lija fino. </p><br><p>  Ahora queda por esta√±ar la placa: esto ayudar√° con la soldadura y proteger√° el cobre de la oxidaci√≥n y facilitar√° la soldadura.  Prefiero el esta√±ado con la aleaci√≥n Rose: esta aleaci√≥n se derrite a una temperatura de aproximadamente 95 grados, lo que le permite esta√±arse en agua hirviendo (s√≠, tal vez no sea la composici√≥n m√°s confiable para el esta√±ado, sino para placas de circuito caseras). </p><br><p><img src="https://habrastorage.org/webt/a5/fs/lk/a5fslka8zacdyhd2mrfad4irlx0.jpeg"></p><br><p>  Despu√©s del esta√±ado, taladro una tabla (para los contactos uso taladros de carburo f1.0, para puentes - f0.7), taladro con un dremel por falta de otra herramienta.  No me gusta cortar textolita debido al polvo, por lo tanto, despu√©s de perforar, cort√© las tablas con un cuchillo de oficina; en ambos lados hago varios cortes en una l√≠nea, luego los rompo en un corte.  Esto recuerda el m√©todo de corte en V utilizado en la industria, solo que hay una incisi√≥n realizada por un molino. </p><br><p>  <em>Parece una tabla lista para soldar</em> <br><img src="https://habrastorage.org/webt/xw/3v/6n/xw3v6ns0nrje-n8saj5gobrvces.jpeg"></p><br><p>  Cuando la placa est√° lista, puede comenzar a cablear los componentes.  Primero, sueldo un poco (resistencias 0603), luego todo lo dem√°s.  Las resistencias son adyacentes a la MK, por lo que soldar en el orden inverso puede ser problem√°tico.  Despu√©s de soldar, verifico si hay un cortocircuito para alimentar el controlador, despu√©s de lo cual ya es posible iniciar el firmware MK. </p><br><p>  <em>Controladores listos para descargar firmware</em> <br><img src="https://habrastorage.org/webt/4u/au/jk/4uaujk48pqllmzplxcxuy_yfig8.jpeg"></p><br><h3 id="promyshlennyy-sposob">  Forma industrial </h3><br><p>  LUT es r√°pido y asequible, pero la tecnolog√≠a tiene sus inconvenientes (como casi todos los m√©todos de fabricaci√≥n de PP "dom√©sticos").  Es problem√°tico hacer un tablero de doble cara, las pistas se pueden grabar y solo se puede so√±ar con metalizar los agujeros. </p><br><p>  Afortunadamente, los chinos emprendedores han estado ofreciendo servicios durante mucho tiempo para la fabricaci√≥n de placas de circuito impreso de manera industrial. <br>  Por extra√±o que parezca, una placa china de una sola capa costar√° m√°s que una placa de dos capas, por lo que decid√≠ agregar una segunda capa (inferior) a la placa de circuito impreso.  Los caminos de poder y el suelo est√°n duplicados en esta capa.  Adem√°s, se hizo posible hacer un disipador de calor del transistor (pol√≠gonos de cobre en la capa inferior), lo que permitir√° que el controlador trabaje a corrientes m√°s altas. </p><br><p>  <em>La capa inferior del tablero en Altium Designer</em> <br><img src="https://habrastorage.org/webt/x0/hf/b9/x0hfb9uk6flm6d7pat30fzm9lyu.png"></p><br><p>  Para este proyecto, decid√≠ pedir una placa de circuito impreso en el sitio web de PcbWay.  El sitio tiene una calculadora conveniente para calcular el costo de los tableros, dependiendo de sus par√°metros, tama√±os y cantidad.  Despu√©s de calcular el costo, descargu√© el archivo gerber creado anteriormente en Altium Designer, los chinos lo revisaron y el tablero pas√≥ a producci√≥n. </p><br><p>  Hacer un juego de 10 tableros TinyFL me cost√≥ $ 5.  Al registrar un nuevo usuario, se otorga un descuento de $ 5 para el primer pedido, por lo que solo pagu√© el env√≠o, que tambi√©n cuesta alrededor de $ 5. <br>  En este sitio existe la oportunidad de poner el proyecto en el dominio p√∫blico, por lo que si alguien quiere ordenar estos tableros, simplemente puede agregar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este proyecto</a> a la cesta. </p><br><p>  Despu√©s de un par de semanas, me llegaron los mismos tableros, solo <del>  bonita </del>  Fabricado industrialmente.  Solo se pueden descomprimir y completar con el firmware. </p><br><p><img src="https://habrastorage.org/webt/lp/j7/jk/lpj7jktyacb_h-atbtpze-9qzcw.jpeg"></p><br><h2 id="programma-proshivka">  Programa (firmware) </h2><br><p>  La principal dificultad que surgi√≥ al escribir el firmware del controlador, est√° asociada con el tama√±o extremadamente peque√±o de la memoria flash: Attiny13 tiene solo 1024 bytes. <br>  Adem√°s, dado que el cambio de brillo es suave, una tarea no trivial fue cambiarlo uniformemente; para esto tuvimos que hacer la correcci√≥n gamma. </p><br><h4 id="algoritm-upravleniya-drayverom">  Algoritmo de control del controlador </h4><br><p>  El conductor se enciende presionando brevemente el bot√≥n, se apaga con √©l. <br>  El modo de brillo seleccionado se almacena durante la duraci√≥n del apagado. </p><br><p>  Si durante la operaci√≥n hace una doble pulsaci√≥n breve de un bot√≥n (doble clic), el LED adicional se encender√° / apagar√°. <br>  Con una presi√≥n prolongada durante el funcionamiento, el brillo de la l√°mpara cambiar√° gradualmente.  Pulsaci√≥n prolongada repetida cambia de direcci√≥n (m√°s fuerte / m√°s d√©bil). </p><br><p>  El controlador verifica peri√≥dicamente el voltaje de la bater√≠a y, si es inferior a los valores establecidos, advierte al usuario sobre una descarga y luego se apaga para evitar una descarga profunda. </p><br><div class="spoiler">  <b class="spoiler_title">Una descripci√≥n m√°s detallada del algoritmo del controlador.</b> <div class="spoiler_text"><ol><li>  Cuando se suministra alimentaci√≥n al MK, los perif√©ricos se configuran y el MK se pone en suspensi√≥n (si se define STARTSLEEP).  Cuando se suministra energ√≠a al controlador, ambos LED parpadean un cierto n√∫mero de veces si se define STARTBLINKS. </li><li>  Dormir  Attiny13 se queda dormido en modo de apagado (este es el modo m√°s econ√≥mico, de acuerdo con la hoja de datos, el consumo de MK ser√° de ~ 1 ŒºA), del cual solo puede salir por cualquier interrupci√≥n.  En este caso, se trata de una interrupci√≥n INT0: presionar un bot√≥n (establecer PC1 en 0 l√≥gico). <br>  En PC1, debe activarse un pull-up d√©bil interno.  El ADC y el comparador son los principales consumidores de corriente de toda la periferia, por lo que tambi√©n deben desconectarse.  Durante la suspensi√≥n, el contenido de los registros y la RAM se almacenan, por lo que no se necesita la EEPROM para recordar el brillo. </li><li>  Despu√©s de dormir, los perif√©ricos y PWM se encienden y el controlador entra en un ciclo sin fin en el que se controla el bot√≥n y se verifica peri√≥dicamente el voltaje de la bater√≠a. </li><li>  Si se presiona el bot√≥n, se presiona la hora. <br>  4.1.  Si la prensa es corta, se espera un doble clic (si se define BTN_DBCLICK). <br>  Si fuera as√≠, el LED2 adicional cambia <br>  Si no, vaya al paso 2 (dormir) <br>  4.2.  Si la prensa es larga (m√°s larga que BTN_ONOFF_DELAY), se activa el modo de control de brillo.  En este modo: <br><ul><li>  La direcci√≥n del cambio se invierte (m√°s / menos) y el% de llenado PWM cambia mientras se presiona el bot√≥n. </li><li>   /  (RATE_MAX / RATE_MIN),   ; </li><li>   n- (AUXMODES_DELAY)     ,   .    ‚Äî  (   25 ,  8 )    (     50,  1 ).        ,     -    . </li></ul></li><li>       ‚Äî    ADC2,     . <br><ul><li>      BAT_WARNING ‚Äì   </li><li>   BAT_WARNING ‚Äì    ,    . -     . ,         5 . </li><li>   BAT_SHUTDOWN ‚Äî    .2 (). </li></ul></li></ol></div></div><br><h4 id="upravlenie-yarkostyu-svetodioda">    </h4><br><p>  ,      ‚Äî   ,     -     ,  . -    ,     ,       .     P-  ,        ,    ‚Äî ,  .               . <br>      rate, 255 rate = 100% . <br>    1.2      1,     1200000/256 = 4.7 .     (  ),         (,   ,  ,   ).  ,      9.6 (CKSEL[1:0]=10, CKDIV8=1)  4.8  (CKSEL[1:0]=01, CKDIV8=1),      8   4  ,       . </p><br><p> ,         ,         .     ,      (      )      ,         ,  ,               1.5 ,   2        (   Cree XM-L   ‚Äî 3 ). <br>               ,     (rate=255)     3.          ,        .   ,    RATE_MAX     .   ,     SI2323DS      4 ,     2 ,     . </p><br><h4 id="gamma-korrekciya"> - </h4><br><p>      .     ,   5-10%       ,     75-100%      .     ,   n   ,  ,            ,        . </p><br><p>   ,          -.    ,       1      12   .       ,      rate_step_array.  , ,       . </p><br><h4 id="kontrol-napryazheniya-batarei">    </h4><br><p>  n- (      BAT_PERIOD)    .   ,    VIN      R1-R2,       PB4 (  ADC2   ). </p><br><p>        ,    ,      Vref,          1.1 .        ‚Äî     ,      (,  1.1       1023  255,   8- ).   ,        6   ,  255     1.1 ,   4.33  (  4.03),      . </p><br><p>     ,        .    BAT_WARNING       (  ,    ‚Äî    BAT_INFO_STEP,   ),    BAT_SHUTDOWN  . <br>         , ..    ,      . </p><br><p> ,     ,      . ,   4.03  R1 = 1M  R2 = 330,    R = 1330K     4  = 3 . <br>      ()    1 .      ,    ,     (  -       ‚Äî  ). </p><br><h4 id="vnesenie-izmeneniy-v-proshivku">     </h4><br><p>   ,       Arduino    C/C++. <br>      ,          (defines)   flashlight.h. <br>        Arduino IDE   Attiny13(a)  Atmel Studio ‚Äì   ,  Arduino IDE,   . </p><br><div class="spoiler"> <b class="spoiler_title">Arduino IDE</b> <div class="spoiler_text"><p>      Attiny13  IDE.      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> . <br>      Tools&gt;Board Attiny13(a)    Tools&gt;Frequency 1.2MHz. <br> ""      .ino,       ‚Äî      .   ,   ‚Äî      Arduino IDE.       - ,    .cpp. <br>       ,  ,          *.hex.        . </p></div></div><br><div class="spoiler"> <b class="spoiler_title">Atmel Studio</b> <div class="spoiler_text"><p>    IDE    flashlight.atsln,   ‚Äî   flashlight.h   ()  flashlight.cpp   . <br>         ‚Äî    . <br>        F7,   ( ,   ,  ).   debug  flashlight.hex,        . </p></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><p>          USBASP     AVRDUDEPROG.      GUI   avrdude,      ‚Äî      .       (   Attiny13(a),    Fuses    read.   ,      ,   .     programm,      .       flashlight.h </p><br><p> Para cargar firmware, vaya a la pesta√±a Programa, seleccione el archivo de firmware compilado en formato HEX (flashlight.hex) en la l√≠nea Flash y haga clic en Programa.  El estado del firmware se mostrar√° en la ventana a continuaci√≥n.  Si la descarga no se realiza correctamente, puede ser un mal contacto, sucede, vale la pena intentarlo de nuevo.  Por cierto, por esta raz√≥n se hizo el par√°metro STARTBLINKS: un solo parpadeo del LED2 en el momento de suministrar energ√≠a al conductor sirve como una indicaci√≥n del contacto del conductor con el programador. <br>  En lugar de USBASP, puede usar Arduino para descargar firmware, m√°s detalles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> </p><br><p>  <em>Programador USBASP conectado al controlador a trav√©s de un clip con un bucle</em> <br><img src="https://habrastorage.org/webt/7f/b2/sy/7fb2syr5zqnwqejhoqpxqqa_-vw.jpeg"></p><br><p>  Para conectar USBASP a un tinka, uso un clip para un SOIC de 8 pines.  No es un dispositivo muy conveniente, tienes que atormentar 10 minutos antes de atrapar el contacto (tal vez acabo de encontrar un clip defectuoso).  Tambi√©n hay adaptadores SOIC-DIP donde se inserta el microcircuito antes de soldar y se vierte el firmware; esta opci√≥n es m√°s conveniente, pero se pierde la capacidad de programar el controlador en el circuito (es decir, actualizar el firmware despu√©s de soldar el MK a la placa). <br>  Si todo esto no est√° all√≠, simplemente puede soldar los cables a los terminales del MK, que luego se conectan al Arduino. </p></div></div><br><h4 id="kalibrovka">  Calibraci√≥n </h4><br><p>  Las corrientes que pasan por el controlador y el LED no deben exceder los valores m√°ximos.  Para el LED XM-L, esto es 3 A, para el controlador depende del transistor utilizado, por ejemplo, para SI2323 la corriente m√°xima es de aproximadamente 4 A, pero es mejor conducir a corrientes m√°s bajas debido a un calentamiento excesivo.  Para reducir la corriente al brillo m√°ximo, se usa el par√°metro RATE_MAX (#define RATE_MAX xx, donde xx es el brillo m√°ximo de 0 a 255). <br>  La calibraci√≥n del ADC no es un procedimiento obligatorio, pero si desea que el controlador controle con precisi√≥n el voltaje umbral, tendr√° que manipularlo. </p><br><p>  Los c√°lculos no proporcionar√°n una alta precisi√≥n de las mediciones, ya que, en primer lugar, las resistencias pueden variar dentro de la tolerancia (generalmente 1-5%), y en segundo lugar, el ion interno puede tener una dispersi√≥n de 1.0 a 1.2 V. <br>  Por lo tanto, la √∫nica forma aceptable es establecer el valor en unidades ADC (BAT_WARNING y BAT_SHUTDOWN), seleccion√°ndolo experimentalmente para el valor deseado.  Para hacer esto, necesitar√° paciencia, un programador y una fuente de alimentaci√≥n ajustable. <br>  Establec√≠ el valor BAT_PERIOD en 1000 en el firmware (verificando el voltaje una vez por segundo) y reduje gradualmente el voltaje de suministro.  Cuando el conductor comenz√≥ a advertir sobre la descarga, dej√© el valor actual de BAT_WARNING seg√∫n sea necesario. <br>  Esta no es la forma m√°s conveniente, tal vez en el futuro necesite realizar un procedimiento de calibraci√≥n autom√°tica con el almacenamiento de los valores en la EEPROM. </p><br><h2 id="sborka-fonarika">  Montaje de linterna </h2><br><p>  Cuando la placa estuvo lista y el firmware se inund√≥, finalmente podr√≠a colocarlo en lugar del controlador anterior.  Desolde√© el viejo controlador y solt√© uno nuevo en su lugar. </p><br><div class="spoiler">  <b class="spoiler_title">El nuevo controlador est√° conectado en lugar del anterior de acuerdo con este esquema</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ar/7c/6j/ar7c6jgy4zprzi6crl9aogualo8.png"></p></div></div><br><p>  Despu√©s de verificar si hab√≠a un cortocircuito en la fuente de alimentaci√≥n, conect√© la fuente de alimentaci√≥n y verifiqu√© la operabilidad.  Luego mont√© la placa de carga (TP4056), para esto tuve que perforar un agujero en el conector de carga con un poco de dremel, y lo arregl√© con pegamento caliente (era importante que el pegamento no fluyera en el conector, ser√≠a dif√≠cil sacarlo de all√≠). </p><br><p>  No atornill√© la placa con tornillos, porque la rosca de la caja se rompi√≥ por repetidas torsiones, sino que simplemente verti√≥ pegamento sobre ella, tambi√©n peg√≥ los cables en los lugares de soldadura para que no se deshilachen.  Decid√≠ cubrir el controlador y el cargador con barniz acr√≠lico incoloro, esto deber√≠a ayudar contra la corrosi√≥n. </p><br><p><img src="https://habrastorage.org/webt/5g/qs/do/5gqsdoxgldinymg3njvlpsmnxz8.jpeg"></p><br><h2 id="testirovanie-i-raschet-stoimosti-izgotovleniya">  Pruebas y c√°lculo de costes de fabricaci√≥n. </h2><br><p>  Despu√©s de todas las operaciones, fue posible comenzar a probar los controladores.  La corriente se midi√≥ con un mult√≠metro convencional, conect√°ndolo al circuito abierto de la fuente de alimentaci√≥n. </p><br><p>  Consumo de energ√≠a del controlador anterior (medido a 4.04 V): </p><br><ol><li>  Durante el sue√±o - no medido </li><li>  Modo m√°ximo: 0.60 A </li><li>  Modo medio: 0.30 A </li><li>  Estroboscopio: 0.28 A </li></ol><br><p>  Consumo de energ√≠a del nuevo controlador (medido a 4.0 V): </p><br><ol><li>  En modo de reposo, consume alrededor de 4 ŒºA, que es mucho menos que la corriente de autodescarga de una bater√≠a de iones de litio.  La corriente principal en este modo fluye a trav√©s de un divisor de resistencia. </li><li>  En el modo m√≠nimo, la "luz de la luna" es de aproximadamente 5-7 mA, si suponemos que la capacidad de una celda 18650 es de aproximadamente 2500 mA * h, obtenemos unos <strong>20 d√≠as de funcionamiento continuo</strong> .  MK mismo consume en alg√∫n lugar 1.2-1.5 mA (a una frecuencia de operaci√≥n de 1.2 MHz). </li><li>  En el modo m√°ximo, "turbo": consume aproximadamente 1,5 A, en este modo funcionar√° durante aproximadamente una hora y media.  El LED en tales corrientes comienza a calentarse mucho, por lo que este modo no est√° dise√±ado para una operaci√≥n a largo plazo. </li><li>  Baliza de emergencia: consume un promedio de aproximadamente 80 mA, en este modo, la linterna funcionar√° hasta 30 horas. </li><li>  Estroboscopio: consume alrededor de 0,35 A, funcionar√° hasta 6 horas. </li></ol><br><h4 id="cena-voprosa">  Precio de emisi√≥n </h4><br><p>  Si compra componentes en Chip y Deep, saldr√°n alrededor de 100 rublos (60 rublos Attiny13, ~ 40 rublos el resto del polvo suelto).  Tiene sentido ordenar de China, si se hacen varias piezas, entonces en t√©rminos de una pieza ser√° m√°s barato, los chinos generalmente venden en lotes de 10 piezas o m√°s. <br>  Las tarifas se liberar√°n a un precio en la regi√≥n de 300 rublos por 10 piezas (sin entrega), si se ordena en China. <br>  Cablear y flashear un controlador lleva aproximadamente una hora. </p><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p>  La linterna china se ha vuelto mucho m√°s conveniente, aunque ahora tengo quejas sobre su mec√°nica: la parte delantera es demasiado pesada y el foco no es realmente necesario. <br>  En el futuro planeo hacer una versi√≥n de este controlador para linternas con un bot√≥n de encendido (con fijaci√≥n).  Es cierto, estoy confundido por la abundancia de tales proyectos.  ¬øCrees que vale la pena hacer otro? </p><br><p>  <em>Controlador de primer plano (versi√≥n 2_t)</em> <br><img src="https://habrastorage.org/webt/2f/sd/sl/2fsdslzywcu7izjgclyshshwjvy.jpeg"></p><br><p>  <strong>UPD</strong> : Soporte agregado para Arduino IDE. </p><br><p>  El c√≥digo fuente del firmware, los circuitos y el cableado de la placa est√°n ahora en el github, puede descargarlo aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/madcatdev/tinyfl_t</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/464673/">https://habr.com/ru/post/464673/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../464657/index.html">Ingenier√≠a inversa cornisa el√©ctrica AM82TV</a></li>
<li><a href="../464659/index.html">Seguridad de aplicaciones o C√≥mo incrustar seguridad en el desarrollo personalizado. Experiencia personal en AGIMA</a></li>
<li><a href="../464661/index.html">A qui√©n confiar el dise√±o de las instalaciones t√©cnicas de reequipamiento y reconstrucci√≥n</a></li>
<li><a href="../464665/index.html">Particionamiento en SQL Server</a></li>
<li><a href="../464671/index.html">Reciba SMS regulares para mensajeros instant√°neos de Viber y Telegram (usando puertas de enlace GoIP)</a></li>
<li><a href="../464675/index.html">An√°lisis de los mecanismos de localizaci√≥n de la interfaz de la aplicaci√≥n en Splunk</a></li>
<li><a href="../464677/index.html">Inversiones en bolsa y costos asociados: cu√°nto cuestan los servicios de una empresa de corretaje</a></li>
<li><a href="../464679/index.html">Voxgun: un servicio para crear contenido de video profesional sin ning√∫n esfuerzo adicional</a></li>
<li><a href="../464685/index.html">Tel√©grafo √≥ptico, red de microondas y torre Tesla: torres de comunicaci√≥n inusuales</a></li>
<li><a href="../464687/index.html">Si quieres salvar el mundo, el veganismo no es una opci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>