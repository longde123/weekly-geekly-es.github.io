<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèë üë®üèø‚Äç‚úàÔ∏è üßïüèª Unity3D: architecture de jeu, objets scriptables, singletones üë©üèæ‚Äçüè≠ ‚õµÔ∏è üôÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, nous allons parler de la fa√ßon de stocker, recevoir et transmettre des donn√©es √† l'int√©rieur du jeu. √Ä propos de la chose merveilleuse ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unity3D: architecture de jeu, objets scriptables, singletones</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414361/">  Aujourd'hui, nous allons parler de la fa√ßon de stocker, recevoir et transmettre des donn√©es √† l'int√©rieur du jeu.  √Ä propos de la chose merveilleuse appel√©e ScriptableObject, et pourquoi elle est merveilleuse.  Parlons un peu des avantages des singletones lors de l'organisation des sc√®nes et des transitions entre eux. <br><br>  Cet article d√©crit un morceau d'une mani√®re longue et douloureuse de d√©velopper un jeu, diff√©rentes approches utilis√©es dans le processus.  Tr√®s probablement, il y aura beaucoup d'informations utiles pour les d√©butants et rien de nouveau pour les ¬´v√©t√©rans¬ª. <br><a name="habracut"></a><br><h3>  Liens entre scripts et objets </h3><br>  La premi√®re question √† laquelle un d√©veloppeur d√©butant est confront√© est de savoir comment lier toutes les classes √©crites ensemble et configurer les interactions entre elles. <br><br>  Le moyen le plus simple consiste √† sp√©cifier directement un lien vers la classe: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyScript</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> OtherScript otherScript; }</code> </pre> <br>  Et puis - liez manuellement le script via l'inspecteur. <br><br>  Cette approche pr√©sente au moins un inconv√©nient important - lorsque le nombre de scripts d√©passe plusieurs dizaines et que chacun d'eux n√©cessite deux ou trois liens entre eux, le jeu se transforme rapidement en site Web.  Un coup d'≈ìil suffit pour lui causer des maux de t√™te. <br><br>  Il vaut bien mieux (√† mon avis) d'organiser un syst√®me de messages et d'abonnements, √† l'int√©rieur duquel nos objets recevront les informations dont ils ont besoin - et seulement cela!  - sans n√©cessiter une demi-douzaine de liens entre eux. <br><br>  Cependant, apr√®s avoir explor√© le sujet, j'ai d√©couvert que les solutions toutes faites dans Unity sont r√©primand√©es par tous ceux qui ne sont pas paresseux.  Il m'a sembl√© une t√¢che non triviale d'√©crire un tel syst√®me √† partir de z√©ro, et donc je vais chercher des solutions plus simples. <br><br><h3>  Scriptableobject </h3><br>  Il y a essentiellement deux choses √† savoir sur ScriptableObject: <br><br><ul><li>  Ils font partie des fonctionnalit√©s impl√©ment√©es dans Unity, comme MonoBehaviour. </li><li>  Contrairement √† MonoBehaviour, ils ne sont pas li√©s aux objets de sc√®ne, mais existent en tant qu'actifs distincts et <b>sont capables de stocker et de transf√©rer des donn√©es entre les sessions de jeu</b> . </li></ul><br>  Je suis imm√©diatement tomb√© amoureux de leur amour br√ªlant.  Ils sont en quelque sorte devenus ma panac√©e pour tout probl√®me: <br><br><ul><li>  Besoin de stocker les param√®tres du jeu?  ScriptableObject! </li><li>  Cr√©er un inventaire?  ScriptableObject! </li><li>  √âcrire de l'IA?  ScriptableObject! </li><li>  Enregistrer des informations sur un personnage, un ennemi, un objet?  ScriptableObject ne vous laissera jamais tomber! </li></ul><br>  Sans y r√©fl√©chir √† deux fois, j'ai cr√©√© plusieurs classes de type ScriptableObject, puis un r√©f√©rentiel pour elles: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Database</span></span>: <span class="hljs-title"><span class="hljs-title">ScriptableObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PlayerData playerData; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GameSettings gameSettings; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SpellController spellController; }</code> </pre> <br>  Chacun d'entre eux stocke en lui-m√™me toutes les informations utiles et, √©ventuellement, des liens vers d'autres objets.  Chacun d'eux suffit pour passer une fois par l'inspecteur - ils n'iront nulle part ailleurs. <br><br>  Maintenant, je n'ai pas besoin de sp√©cifier un nombre infini de liens entre les scripts!  Pour chaque script, je peux sp√©cifier une <b>fois</b> un lien vers mon r√©f√©rentiel - et il recevra toutes les informations de l√†. <br><br>  Ainsi, le calcul de la vitesse du personnage prend un aspect tr√®s √©l√©gant: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   float speed = database.playerData.speed; //    if (database.spellController.haste.active) speed = speed * database.spellController.haste.speedModifier; // ,     if (database.playerData.health&lt;database.playerData.healthThreshold) speed = speed * database.playerData.woundedModifier;</span></span></code> </pre> <br>  Et si, disons, un pi√®ge ne devrait se d√©clencher que sur un personnage en cours d'ex√©cution: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (database.playerData.isSprinting) Activate();</code> </pre> <br>  De plus, le personnage n'a besoin de rien savoir des sorts ou des pi√®ges.  Il r√©cup√®re simplement les donn√©es du stockage.  Pas mal?  Pas mal. <br><br>  Mais presque imm√©diatement, je rencontre un probl√®me.  ScriptableOnjects ne peut pas stocker directement des liens vers des objets de sc√®ne.  En d'autres termes, je ne peux pas cr√©er de lien vers le joueur, le lier via l'inspecteur et oublier pour toujours la question des coordonn√©es du joueur. <br><br>  Et si vous y r√©fl√©chissez, cela a du sens!  Les actifs existent hors sc√®ne et sont accessibles dans toutes les sc√®nes.  Et que se passe-t-il si vous laissez un lien vers un objet situ√© dans une autre sc√®ne √† l'int√©rieur de l'actif? <br><br>  Rien de bien. <br><br>  Pendant longtemps, une b√©quille a fonctionn√© pour moi: un lien public est cr√©√© dans le r√©f√©rentiel, puis chaque objet, le lien dont vous souhaitez vous souvenir, a rempli ce lien: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerController</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Awake</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { database.playerData.player = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.gameObject; } }</code> </pre> <br>  Ainsi, quelle que soit la sc√®ne, mon r√©f√©rentiel re√ßoit tout d'abord un lien vers le joueur et s'en souvient.  D√©sormais, quiconque, par exemple, l'ennemi ne doit pas stocker de lien vers le joueur, ne doit pas le rechercher via FindWithTag () (ce qui est un processus tr√®s gourmand en ressources).  Il ne fait qu'acc√©der au d√©p√¥t: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Database database; Vector3 destination; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { destination = database.playerData.player.transform.position; }</code> </pre> <br>  Il semblerait: le syst√®me est parfait!  Mais non.  Nous avons encore 2 probl√®mes. <br><br><ol><li>  Je dois encore sp√©cifier manuellement un lien vers le r√©f√©rentiel pour chaque script. </li><li>  Il est difficile d'attribuer des r√©f√©rences √† des objets de sc√®ne √† l'int√©rieur d'un ScriptableObject. </li></ol><br>  √Ä propos de la seconde plus en d√©tail.  Supposons qu'un joueur ait un sort l√©ger.  Le joueur le lance et le jeu dit au magasin: la lumi√®re est jet√©e! <br><br><pre> <code class="cs hljs">database.spellController.light.CastSpell();</code> </pre> <br>  Et cela donne lieu √† une s√©rie de r√©actions: <br><br><ul><li>  Une nouvelle (ou ancienne) lumi√®re d'objet de jeu est cr√©√©e au point du curseur. </li><li>  Un module GUI est lanc√©, nous indiquant que la lumi√®re est active. </li><li>  Les ennemis obtiennent, disons, un bonus temporaire pour trouver un joueur. </li></ul><br>  Comment faire tout √ßa? <br><br>  Il est possible pour chaque objet int√©ress√© par la lumi√®re, directement dans Update () et d'√©crire, disent-ils, de cette fa√ßon et que, chaque trame suive la lumi√®re (si (database.spellController.light.isActive)), et quand elle s'allume - r√©agissez!  Et ne vous souciez pas que 90% du temps ce contr√¥le fonctionnera au ralenti.  Sur plusieurs centaines d'objets. <br><br>  Ou organisez tout cela sous forme de liens pr√©par√©s.  Il s'av√®re que la simple fonction CastSpell () devrait avoir acc√®s aux liens vers le joueur, la lumi√®re et la liste des ennemis.  Et c'est au mieux.  Beaucoup de liens, hein? <br><br>  Vous pouvez, bien s√ªr, enregistrer tout ce qui est important dans notre r√©f√©rentiel lorsque la sc√®ne d√©marre, disperser les liens sur les actifs, qui, en g√©n√©ral, ne sont pas destin√©s √† cela ... Mais encore une fois, je viole le principe d'un r√©f√©rentiel unique, en le transformant en un r√©seau de liens. <br><br><h3>  Singleton </h3><br>  C'est l√† que le singleton entre en jeu.  En fait, c'est un objet qui existe (et ne peut exister) qu'en une seule copie. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GameController</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> GameController Instance; <span class="hljs-comment"><span class="hljs-comment">//   ,      public Database database; public GameObject player; public GameObject GUI; public List&lt;Enemy&gt; enemies; public List&lt;Spell&gt; spells; void Awake () { if (Instance == null) { DontDestroyOnLoad (gameObject); Instance = this; } else if (Instance != this) { Destroy (gameObject); } } }</span></span></code> </pre> <br>  Je l'enclenche sur un objet de sc√®ne vide.  Appelons cela GameController. <br><br>  Ainsi, j'ai un objet dans la sc√®ne qui stocke <b>toutes les</b> informations sur le jeu.  De plus, il peut se d√©placer entre les sc√®nes, d√©truire ses doubles (s'il existe d√©j√† un autre GameController sur la nouvelle sc√®ne), transf√©rer des donn√©es entre les sc√®nes et, si vous le souhaitez, impl√©menter l'enregistrement / le chargement du jeu. <br><br>  De tous les scripts d√©j√† √©crits, vous pouvez supprimer le lien vers l'entrep√¥t de donn√©es.  Apr√®s tout, je n'ai plus besoin de le configurer manuellement.  Toutes les r√©f√©rences aux objets de sc√®ne sont supprim√©es du magasin et transf√©r√©es vers notre GameController (nous en aurons probablement besoin pour enregistrer l'√©tat de la sc√®ne lorsque nous quitterons le jeu).  Et puis je le remplis avec toutes les informations n√©cessaires d'une mani√®re qui me convient.  Par exemple, dans Awake () du joueur et des ennemis (et des objets importants de la sc√®ne), il est prescrit d'ajouter un lien vers eux-m√™mes dans le GameController.  Depuis que je travaille maintenant avec Monobehaviour, les r√©f√©rences aux objets de la sc√®ne s'y ins√®rent tr√®s organiquement. <br><br>  Qu'obtenons-nous? <br><br>  <b>Tout</b> objet peut obtenir <b>toutes les</b> informations dont il a besoin sur le jeu: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GameController.Instance.database.playerData.isSprinting) ActivateTrap();</code> </pre> <br>  Dans ce cas, il n'est absolument pas n√©cessaire de configurer des liens entre les objets, tout est stock√© dans notre GameController. <br><br>  Maintenant, il n'y aura rien de compliqu√© √† maintenir l'√©tat de la sc√®ne.  Apr√®s tout, nous avons d√©j√† toutes les informations n√©cessaires: ennemis, objets, position du joueur, entrep√¥t de donn√©es.  Il suffit de s√©lectionner les informations sur la sc√®ne que vous souhaitez enregistrer et de les √©crire dans un fichier √† l'aide de FileStream lorsque vous quittez la sc√®ne. <br><br><h3>  Les dangers </h3><br>  Si vous lisez jusqu'√† pr√©sent, je devrais vous mettre en garde contre les dangers de cette approche. <br><br>  Une tr√®s mauvaise situation est lorsque de nombreux scripts font r√©f√©rence √† une variable √† l'int√©rieur de notre ScriptableObject.  Il n'y a rien de mal √† obtenir une valeur, mais quand ils commencent √† affecter une variable √† diff√©rents endroits, c'est une menace potentielle. <br><br>  Si nous avons une variable playerSpeed ‚Äã‚Äãenregistr√©e et que nous avons besoin que le lecteur se d√©place √† diff√©rentes vitesses, nous ne devons pas modifier playerSpeed ‚Äã‚Äãdans le stockage, nous devons l'obtenir, l'enregistrer dans une variable temporaire et lui appliquer d√©j√† des modificateurs de vitesse. <br><br>  Le deuxi√®me point - si un objet a acc√®s √† quelque chose - c'est une grande puissance.  Et une grande responsabilit√©.  Et vous devez l'approcher avec prudence afin qu'un script de champignon ne casse pas accidentellement tous vos ennemis IA.  Une encapsulation correctement configur√©e r√©duira les risques, mais ne vous en √©pargnera pas. <br><br>  N'oubliez pas non plus que les singletones sont des cr√©atures douces.  Ne les abusez pas. <br><br>  C'est tout pour aujourd'hui. <br><br>  <i>Beaucoup de choses ont √©t√© glan√©es dans les tutoriels officiels d'Unity, certains dans des tutoriels non officiels.</i>  <i>Je devais arriver √† quelque chose moi-m√™me.</i>  <i>Ainsi, les approches ci-dessus peuvent avoir leurs dangers et leurs inconv√©nients, ce que j'ai rat√©.</i> <i><br><br></i>  <i>Et donc - la discussion est la bienvenue!</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414361/">https://habr.com/ru/post/fr414361/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414351/index.html">Instruments de musique les plus insolites: orgue Hammond, orchestre Vako et Synclavier</a></li>
<li><a href="../fr414353/index.html">Kivy. De la cr√©ation √† la production est une √©tape. 2e partie</a></li>
<li><a href="../fr414355/index.html">La vie apr√®s l'explosion</a></li>
<li><a href="../fr414357/index.html">Nous utilisons l'API Web Bluetooth pour connecter le moniteur de fr√©quence cardiaque et d√©velopper l'application √† l'aide de Vue.js</a></li>
<li><a href="../fr414359/index.html">Interaction avec le serveur via l'API dans iOS sur Swift 3. Partie 1</a></li>
<li><a href="../fr414363/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 319 (11-17 juin 2018)</a></li>
<li><a href="../fr414367/index.html">Galop en trois ans: ce qui peut √™tre int√©ressant √† relire sur le blog HashFlare</a></li>
<li><a href="../fr414369/index.html">Serveur d'impression √† tol√©rance de pannes Windows</a></li>
<li><a href="../fr414371/index.html">Classe d'√©cole et un petit croquis de l'ing√©nierie sociale</a></li>
<li><a href="../fr414373/index.html">Conception asynchrone / attente JavaScript: forces, pi√®ges et mod√®les d'utilisation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>