<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛀🏻 〰️ 📮 Pengembangan Chatbot untuk Facebook Messenger di node.js 🤜🏻 🗑️ 🤟🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Materi, terjemahan yang kami sajikan untuk perhatian Anda hari ini, dikhususkan untuk pengembangan bot obrolan untuk Facebook Messenger. Bot bernama A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pengembangan Chatbot untuk Facebook Messenger di node.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/414081/">  Materi, terjemahan yang kami sajikan untuk perhatian Anda hari ini, dikhususkan untuk pengembangan bot obrolan untuk Facebook Messenger.  Bot bernama Aww Bot, yang berkomunikasi dengan pengguna, akan mengirimi mereka gambar kucing dan anjing lucu. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/lv/_r/ib/lv_ribnji-ia8qpcx065xneusls.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Memulai</font> </h2><br>  Mari kita mulai dengan membuat halaman di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Facebook</a> dengan mengisi kolom yang diperlukan.  Halaman ini untuk bot.  Selain itu, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kami akan membuat</a> aplikasi Facebook, setelah itu, pada halaman Tambahkan Produk, kami akan menghubungkan produk Messenger ke aplikasi.  Selanjutnya, kita akan menemukan diri kita di halaman pengaturan messenger.  Di sini Anda perlu menemukan bagian Pembuatan Token, di dalamnya - pilih halaman bot dalam daftar Halaman.  Setelah itu, kita akan ditanya tentang izin dan token akses akan dibuat.  Bot akan menggunakan token ini untuk melakukan panggilan ke Facebook Messenger API, yang akan memungkinkannya untuk berkomunikasi dengan pengguna. <br><br><h2>  <font color="#3AC1EF">Penyiapan server web</font> </h2><br>  Kami akan menggunakan node.js dan express.js untuk membuat server HTTP.  Jalankan perintah berikut: <br><br><pre><code class="hljs sql">npm <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> express <span class="hljs-keyword"><span class="hljs-keyword">body</span></span>-parser request config <span class="hljs-comment"><span class="hljs-comment">--save</span></span></code> </pre> <br>  Tambahkan kode berikut ke <code>index.js</code> yang memungkinkan Anda membuat server HTTP sederhana: <br><br><pre> <code class="hljs javascript"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>),   bodyParser = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'body-parser'</span></span>),   app = express(); app.use(bodyParser.urlencoded({ <span class="hljs-attr"><span class="hljs-attr">extended</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> })); app.use(bodyParser.json()); app.listen(<span class="hljs-number"><span class="hljs-number">8989</span></span>, () =&gt; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Example app listening on port 8989!'</span></span>)); app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, (req, res) =&gt; res.send(<span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span>));</code> </pre> <br>  Sekarang, jika Anda memulai server dan pergi, menggunakan browser Anda, di <code>http://127.0.0.1:8989</code> , Anda akan melihat halaman dengan respons server - <code>Hello World!</code>  . <br><br><h2>  <font color="#3AC1EF">HTTPS dan lingkungan pengembangan lokal</font> </h2><br>  Sebelum beralih ke teknologi Webhook, kita perlu mengkonfigurasi HTTPS untuk lingkungan pengembangan.  Messenger tidak akan menerima alamat Webhook yang digunakan untuk mengirim pemberitahuan ke server kami jika Anda menggunakan sertifikat SSL yang ditandatangani sendiri.  Sertifikat gratis tersedia dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Let's Encrypt</a> .  Di sini, bagaimanapun, Anda bisa mendapatkan sertifikat hanya untuk domain, dan bukan untuk alamat IP.  Kami akan menggunakan layanan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ngrok</a> , yang akan memungkinkan Anda untuk mengatur akses ke server lokal melalui URL publik yang menggunakan HTTPS. <br><br><h2>  <font color="#3AC1EF">Pengaturan Ngrok</font> </h2><br>  <code>ngrok</code> mudah.  Anda hanya perlu mengunduh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">arsip</a> terkompresi dari situs proyek, unzip dan jalankan perintah berikut: <br><br><pre> <code class="hljs">./ngrok http 80</code> </pre> <br>  Ingatlah untuk mengalihkan port 80 ke 8989 di pengaturan WAN router Anda.  Akibatnya, <code>ngrok</code> akan membuat alamat HTTP dan HTTPS publik untuk server lokal. <br><br><h2>  <font color="#3AC1EF">Bekerja dengan Notifikasi Webhook</font> </h2><br>  Utusan menggunakan teknologi Webhook untuk otentikasi dan untuk mengirim pemberitahuan tentang acara ke aplikasi Anda.  Dari sudut pandang pemrograman, semua ini bermuara pada fungsi callback biasa untuk memproses permintaan HTTP yang akan menerima data tentang peristiwa, seperti pesan yang diterima oleh chatbot.  Untuk mem-parsing permintaan GET dan POST, kita akan menggunakan modul <code>body-parser</code> . <br><br>  Tambahkan rute berikut ke aplikasi.  Ini diperlukan untuk memproses permintaan verifikasi Webhook. <br><br><pre> <code class="hljs bash">//   GET-  webhook app.get(<span class="hljs-string"><span class="hljs-string">'/webhook'</span></span>, (req, res) =&gt; {   //  .    ,       <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> VERIFY_TOKEN = <span class="hljs-string"><span class="hljs-string">"SOMETHING_RANDOM"</span></span>;   //      <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> mode = req.query[<span class="hljs-string"><span class="hljs-string">'hub.mode'</span></span>];   <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> token = req.query[<span class="hljs-string"><span class="hljs-string">'hub.verify_token'</span></span>];   <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> challenge = req.query[<span class="hljs-string"><span class="hljs-string">'hub.challenge'</span></span>];   // ,     mode  token   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode &amp;&amp; token) {       //   mode  token       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mode === <span class="hljs-string"><span class="hljs-string">'subscribe'</span></span> &amp;&amp; token === VERIFY_TOKEN) {           //   challenge             console.log(<span class="hljs-string"><span class="hljs-string">'WEBHOOK_VERIFIED'</span></span>);           res.status(200).send(challenge);       } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {           //   <span class="hljs-string"><span class="hljs-string">'403 Forbidden'</span></span>                res.sendStatus(403);       }   } });</code> </pre> <br>  Sekarang Anda perlu membuka pengaturan messenger, cari bagian Webhooks di sana dan konfigurasikan integrasi aplikasi dengan notifikasi Webhook.  Pada halaman pengaturan, di bidang URL Callback, masukkan URL HTTPS kami yang diterima dari ngrok.  Token verifikasi (yang ada dalam kode dan mewakili string acak yang kami buat) harus ditempatkan di bidang Verifikasi Token.  Setelah itu, Anda harus dapat memverifikasi dan menyimpan pengaturan dengan mengklik tombol Verifikasi dan Simpan jika URL Anda untuk memproses pemberitahuan Webhook tersedia dan token verifikasi cocok dengan yang ada dalam kode. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6fa/aff/26c/6faaff26cf7d89e6d65991816c8bb747.png"></div><br>  <i><font color="#999999">Konfigurasikan token dan URL untuk aplikasi untuk menerima pemberitahuan Webhook</font></i> <br><br>  Setelah menyimpan, pilih halaman Anda dari daftar drop-down dan berlangganan acara halaman. <br><br>  Sekarang buat rute POST untuk menangani acara POST dari messenger.  Tambahkan kode berikut ke aplikasi. <br><br><pre> <code class="hljs lua">//     webhook app.post(<span class="hljs-string"><span class="hljs-string">'/webhook'</span></span>, (req, res) =&gt; {   let body = req.body;   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (body.object === <span class="hljs-string"><span class="hljs-string">'page'</span></span>) {       // ,               body.entry.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entry)</span></span></span></span> {           //  entry.messaging  ,            //     ,    <span class="hljs-number"><span class="hljs-number">0</span></span>           let webhook_event = entry.messaging[<span class="hljs-number"><span class="hljs-number">0</span></span>];           console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(webhook_event);           //  PSID            let sender_psid = webhook_event.sender.id;           console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">'Sender PSID: '</span></span> + sender_psid);           //  ,  , message   postback,           //     -           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webhook_event.message) {               console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(webhook_event.message)           } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webhook_event.postback) {               console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(webhook_event.postback)           }       });       //  <span class="hljs-string"><span class="hljs-string">'200 OK'</span></span>            res.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>(<span class="hljs-number"><span class="hljs-number">200</span></span>).send(<span class="hljs-string"><span class="hljs-string">'EVENT_RECEIVED'</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {       //  <span class="hljs-string"><span class="hljs-string">'404 Not Found'</span></span>,      ,           res.sendStatus(<span class="hljs-number"><span class="hljs-number">404</span></span>);   } });</code> </pre> <br>  Kami mengatur aplikasi sehingga menangani dua jenis peristiwa - <code>message</code> dan <code>postback</code> .  Untuk memeriksa operasi mekanisme notifikasi Webhook, buka messenger dan kirim pesan ke halaman bot.  Jika semuanya berjalan sebagaimana mestinya, PSID pengirim, informasi acara, dan konten pesan akan dicatat.  Sekarang kita akan menulis fungsi penangan untuk acara yang menarik bagi kita. <br><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   message const handleMessage = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sender_psid, received_message)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   let response;   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (received_message.text) {   } } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   postback const handlePostback = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sender_psid, received_postback)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   let response;   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    postback   let payload = received_postback.payload;   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(payload === <span class="hljs-string"><span class="hljs-string">'GET_STARTED'</span></span>){   } }</code> </pre> <br>  Metode <code>handleMessage()</code> bertanggung jawab untuk memproses pesan masuk, dan metode <code>handlePostback()</code> untuk memproses kejadian <code>postback</code> masuk.  Perbarui kode Anda yang ada dengan menambahkan panggilan ke metode ini: <br><br><pre> <code class="hljs cmake">//   //     - <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webhook_event.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span>) {   handleMessage(sender_psid, webhook_event.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (webhook_event.postback) {   handlePostback(sender_psid, webhook_event.postback); }</code> </pre> <br>  Sekarang, ketika kami menerima <code>message</code> atau <code>postback</code> , data akan dikirim ke penangan yang sesuai bersama dengan PSID pengirim. <br><br><h2>  <font color="#3AC1EF">Mengkonfigurasi layar pembuka dan acara postback untuk memulai dialog dengan bot</font> </h2><br>  Ketika pengguna baru memulai percakapan dengan bot, tombol Memulai ditampilkan di jendela obrolan.  Anda dapat mengonfigurasi acara postback Anda sendiri untuk situasi ini.  Misalnya, atur pesan untuk pengguna yang menjelaskan bot dan cara berkomunikasi dengannya.  Untuk mengkonfigurasi ucapan Anda sendiri, jalankan perintah <code>curl</code> ini di terminal: <br><br><pre> <code class="hljs swift">curl -<span class="hljs-type"><span class="hljs-type">X</span></span> <span class="hljs-type"><span class="hljs-type">POST</span></span> -<span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> -d '{ <span class="hljs-string"><span class="hljs-string">"greeting"</span></span>: [   {     <span class="hljs-string"><span class="hljs-string">"locale"</span></span>:<span class="hljs-string"><span class="hljs-string">"default"</span></span>,     <span class="hljs-string"><span class="hljs-string">"text"</span></span>:<span class="hljs-string"><span class="hljs-string">"Hello {{user_first_name}}! Are you ready to see the cutests cats and dogs"</span></span>   } ] }' <span class="hljs-string"><span class="hljs-string">"https://graph.facebook.com/v2.6/me/messenger_profile?access_token=YOUR_PAGE_ACCESS_TOKEN"</span></span></code> </pre> <br>  Kami menyiapkan Aww Bot sehingga menampilkan pesan yang menanyakan pengguna apakah ia siap untuk melihat kucing dan anjing yang paling lucu.  Untuk mengonfigurasi acara postback, jalankan perintah ini di terminal: <br><br><pre> <code class="hljs powershell">curl <span class="hljs-literal"><span class="hljs-literal">-X</span></span> POST <span class="hljs-literal"><span class="hljs-literal">-H</span></span> <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> <span class="hljs-literal"><span class="hljs-literal">-d</span></span> <span class="hljs-string"><span class="hljs-string">'{ "get_started": {"payload": "GET_STARTED"} }'</span></span> <span class="hljs-string"><span class="hljs-string">"https://graph.facebook.com/v2.6/me/messenger_profile?access_token=YOUR_PAGE_ACCESS_TOKEN"</span></span></code> </pre> <br>  Seperti apa sesi obrolan dengan bot tersebut. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ce/ea2/528/8ceea252800a9c2c505880232a4a2df7.png"></div><br>  <i><font color="#999999">Layar Memulai</font></i> <br><br><h2>  <font color="#3AC1EF">Pengaturan aplikasi</font> </h2><br>  Kami akan menggunakan modul konfigurasi npm untuk menyimpan token akses halaman dalam file konfigurasi terpisah.  Buat direktori <code>config</code> di proyek kami dan file <code>default.json</code> di dalamnya.  Dalam file ini, Anda perlu menambahkan token akses ke halaman dan merekam file ini di <code>.gitignore</code> . <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"facebook"</span></span>: {   <span class="hljs-attr"><span class="hljs-attr">"page"</span></span>: {     <span class="hljs-attr"><span class="hljs-attr">"access_token"</span></span>: <span class="hljs-string"><span class="hljs-string">"PAGE_ACCESS_TOKEN"</span></span>   } } }</code> </pre> <br>  Kami akan mendapatkan token akses halaman dalam metode <code>callSendAPI()</code> menggunakan perintah <code>config.get('facebook.page.access_token')</code> . <br><br><h2>  <font color="#3AC1EF">Menangani acara mulai</font> </h2><br>  Berikut adalah kode penanganan acara mulai. <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> handlePostback = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sender_psid, received_postback</span></span></span><span class="hljs-function">) =&gt;</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> response;   <span class="hljs-comment"><span class="hljs-comment">//   postback-   let payload = received_postback.payload;   if(payload === 'GET_STARTED'){       response = askTemplate('Are you a Cat or Dog Person?');       callSendAPI(sender_psid, response);   } }</span></span></code> </pre> <br>  Mari kita buat metode <code>askTemplate()</code> , yang akan mengembalikan objek respons yang disiapkan dengan benar untuk API messenger.  Metode <code>callSendAPI()</code> akan mengirim pesan kepada pengguna.  Tambahkan metode berikut ke aplikasi: <br><br><pre> <code class="hljs coffeescript">const askTemplate = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {       <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>:{           <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"template"</span></span>,           <span class="hljs-string"><span class="hljs-string">"payload"</span></span>:{               <span class="hljs-string"><span class="hljs-string">"template_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"button"</span></span>,               <span class="hljs-string"><span class="hljs-string">"text"</span></span>: text,               <span class="hljs-string"><span class="hljs-string">"buttons"</span></span>:[                   {                       <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"postback"</span></span>,                       <span class="hljs-string"><span class="hljs-string">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"Cats"</span></span>,                       <span class="hljs-string"><span class="hljs-string">"payload"</span></span>:<span class="hljs-string"><span class="hljs-string">"CAT_PICS"</span></span>                   },                   {                       <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"postback"</span></span>,                       <span class="hljs-string"><span class="hljs-string">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">"Dogs"</span></span>,                       <span class="hljs-string"><span class="hljs-string">"payload"</span></span>:<span class="hljs-string"><span class="hljs-string">"DOG_PICS"</span></span>                   }               ]           }       }   } } <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     API Send const callSendAPI = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sender_psid, response, cb = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> =&gt;</span></span> {   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      let request_body = {       <span class="hljs-string"><span class="hljs-string">"recipient"</span></span>: {           <span class="hljs-string"><span class="hljs-string">"id"</span></span>: sender_psid       },       <span class="hljs-string"><span class="hljs-string">"message"</span></span>: response   };   <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  HTTP-  Messenger Platform   request({       <span class="hljs-string"><span class="hljs-string">"uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://graph.facebook.com/v2.6/me/messages"</span></span>,       <span class="hljs-string"><span class="hljs-string">"qs"</span></span>: { <span class="hljs-string"><span class="hljs-string">"access_token"</span></span>: config.get(<span class="hljs-string"><span class="hljs-string">'facebook.page.access_token'</span></span>) },       <span class="hljs-string"><span class="hljs-string">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>,       <span class="hljs-string"><span class="hljs-string">"json"</span></span>: request_body   }, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err, res, body)</span></span></span><span class="hljs-function"> =&gt;</span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) {           <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cb){               cb();           }       } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {           <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(<span class="hljs-string"><span class="hljs-string">"Unable to send message:"</span></span> + err);       }   }); }</code> </pre> <br>  Kami mengirim pesan kepada pengguna yang berisi dua tombol dan teks.  Ketika pengguna memilih apa yang dia butuhkan dengan mengklik tombol yang sesuai, permintaan akan dikirim ke alamat Webhook kami dengan data acara <code>postback</code> dan kami akan memprosesnya. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/378/772/c7c/378772c7c48eab03447ec1ea9dbb6117.png"></div><br>  <i><font color="#999999">Pengguna diminta untuk memilih jenis gambar yang menarik baginya.</font></i> <br><br><h2>  <font color="#3AC1EF">Menangani acara postback khusus</font> </h2><br>  Perbarui kode fungsi pengendali acara postback: <br><br><pre> <code class="hljs lua">const handlePostback = (sender_psid, received_postback) =&gt; {   let response;   //   postback-   let payload = received_postback.payload;   //  ,       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload === <span class="hljs-string"><span class="hljs-string">'CAT_PICS'</span></span>) {       response = imageTemplate(<span class="hljs-string"><span class="hljs-string">'cats'</span></span>, sender_psid);       callSendAPI(sender_psid, response, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{           callSendAPI(sender_psid, askTemplate(<span class="hljs-string"><span class="hljs-string">'Show me more'</span></span>));       });   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload === <span class="hljs-string"><span class="hljs-string">'DOG_PICS'</span></span>) {       response = imageTemplate(<span class="hljs-string"><span class="hljs-string">'dogs'</span></span>, sender_psid);       callSendAPI(sender_psid, response, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{           callSendAPI(sender_psid, askTemplate(<span class="hljs-string"><span class="hljs-string">'Show me more'</span></span>));       });   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(payload === <span class="hljs-string"><span class="hljs-string">'GET_STARTED'</span></span>){       response = askTemplate(<span class="hljs-string"><span class="hljs-string">'Are you a Cat or Dog Person?'</span></span>);       callSendAPI(sender_psid, response);   }   //   }</code> </pre> <br>  Ketika pengguna mengklik tombol <code>Cats</code> , permintaan dengan acara <code>postback</code> yang berisi data <code>CAT_PICS</code> akan <code>CAT_PICS</code> ke alamat kami yang digunakan untuk memproses pemberitahuan Webhook.  Memilih opsi <code>Dogs</code> akan mengirimkan acara <code>postback</code> dengan data <code>DOG_PICS</code> .  Kami menambahkan metode lain ke sistem, <code>imageTemplate()</code> , yang mengembalikan pesan yang berisi tautan ke gambar kucing atau anjing. <br><br><h2>  <font color="#3AC1EF">Buat API sederhana yang mengembalikan tautan gambar</font> </h2><br>  Kami akan menulis API sederhana untuk mengembalikan tautan ke gambar kucing atau anjing yang akan digunakan dalam pesan yang dikirim oleh bot ke pengguna.  Buat file <code>pics.js</code> dan tambahkan kode berikut ke dalamnya: <br><br><pre> <code class="hljs 1c">module.exports = {   cats : [       'https://i.imgur.com/Qbg7CeM.jpg',       'https://i.imgur.com/nUzkpJY.jpg',       'https://i.imgur.com/NpDcKph.jpg',       'https://i.imgur.com/oJtSDaO.jpg',       'https://i.redd.it/82ajpsrd<span class="hljs-number"><span class="hljs-number">1711</span></span>1.jpg',       'https://i.redd.it/00km1d2rt<span class="hljs-number"><span class="hljs-number">0111</span></span>.jpg',       'https://i.redd.it/rdbavhp0y<span class="hljs-number"><span class="hljs-number">7111</span></span>.jpg',       'https://i.redd.it/5hn3mg0n<span class="hljs-number"><span class="hljs-number">9811</span></span>1.jpg',       'https://i.redd.it/d23pb8mta<span class="hljs-number"><span class="hljs-number">6111</span></span>.jpg',       'https://i.redd.it/d2gyrwgy7oz01.jpg',       'https://i.redd.it/z4sgl84q72z01.jpg',       'https://i.redd.it/wvykzo8n1cy01.jpg'   ],   dogs : [       'https://i.redd.it/6tjihi2qe<span class="hljs-number"><span class="hljs-number">7111</span></span>.jpg',       'https://i.imgur.com/etRCs56.jpg',       'https://i.redd.it/nibw50f8y<span class="hljs-number"><span class="hljs-number">4111</span></span>.jpg',       'https://i.redd.it/izcvnvj1o<span class="hljs-number"><span class="hljs-number">7111</span></span>.jpg',       'https://i.redd.it/eqs1g9dldz011.jpg',       'https://i.redd.it/civ9dnu9u<span class="hljs-number"><span class="hljs-number">1111</span></span>.jpg',       'https://i.redd.it/kk03qwclkp011.jpg',       'https://i.redd.it/<span class="hljs-number"><span class="hljs-number">2694</span></span>pupjne011.jpg',       'https://i.redd.it/qk49ls5y6oy01.jpg',       'https://i.imgur.com/oM3mKgB.jpg',       'https://i.redd.it/8kx2riaulux01.jpg'   ] };</code> </pre> <br>  Sekarang sambungkan ke aplikasi. <br><br><pre> <code class="hljs perl">images = <span class="hljs-keyword"><span class="hljs-keyword">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./pics'</span></span>);</code> </pre> <br>  Tambahkan metode berikut ke kode yang digunakan untuk menulis pesan yang berisi tautan ke gambar. <br><br><pre> <code class="hljs scala">const = imageTemplate(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {       <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>:{           <span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"image"</span></span>,           <span class="hljs-string"><span class="hljs-string">"payload"</span></span>:{               <span class="hljs-string"><span class="hljs-string">"url"</span></span>: getImage(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sender_id</span></span></span><span class="hljs-class">),               "</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is_reusable</span></span></span><span class="hljs-class">"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>           }       }   } }</code> </pre> <br>  Dalam proses interaksi pengguna dengan bot, gambar diekstraksi secara berurutan dari array dan dikirim sebagai respons bot kepada pengguna.  Setelah mengirim gambar terakhir, kami kembali ke atas daftar. <br><br>  Kami menambahkan kode berikut ke proyek, yang dirancang untuk menyimpan dan memproses data tentang pengguna yang berkomunikasi dengan bot. <br><br><pre> <code class="hljs markdown">let users = {}; const = getImage(type, sender<span class="hljs-emphasis"><span class="hljs-emphasis">_id) =&gt; {   //       -     if(users[sender_</span></span>id] === undefined){       users = Object.assign({           [<span class="hljs-string"><span class="hljs-string">sender_id</span></span>] : {               'cats<span class="hljs-emphasis"><span class="hljs-emphasis">_count' : 0,               'dogs_</span></span>count' : 0           }       }, users);   }   let count = images[<span class="hljs-string"><span class="hljs-string">type</span></span>].length, //            user = users[<span class="hljs-string"><span class="hljs-string">sender_id</span></span>], // ,         user<span class="hljs-emphasis"><span class="hljs-emphasis">_type_</span></span>count = user[<span class="hljs-string"><span class="hljs-string">type+'_count'</span></span>];   //          let updated<span class="hljs-emphasis"><span class="hljs-emphasis">_user = {       [sender_</span></span>id] : Object.assign(user, {           [<span class="hljs-string"><span class="hljs-string">type+'_count'</span></span>] : count === user<span class="hljs-emphasis"><span class="hljs-emphasis">_type_</span></span>count + 1 ? 0 : user<span class="hljs-emphasis"><span class="hljs-emphasis">_type_</span></span>count + 1       })   };   //      users = Object.assign(users, updated<span class="hljs-emphasis"><span class="hljs-emphasis">_user);   console.log(users);   return images[type][user_</span></span>type_count]; }</code> </pre> <br>  Kami menyimpan PSID dari setiap pengguna yang berkomunikasi dengan bot sebagai kunci dalam objek <code>users</code> .  Jika belum ada catatan pengguna, buat catatan baru.  Kami akan memperbarui informasi nomor gambar setiap kali pengguna meminta gambar kucing atau anjing.  Kemudian kami mengembalikan jalur absolut ke gambar yang akan digunakan dalam templat pesan.  Selanjutnya, kami mengirim pesan dengan gambar dalam bentuk respons terhadap peristiwa <code>postback</code> yang dihasilkan ketika pengguna memilih jenis gambar yang menarik baginya. <br><br><pre> <code class="hljs lua">//  ,    postback- <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload === <span class="hljs-string"><span class="hljs-string">'CAT_PICS'</span></span>) {   response = imageTemplate(<span class="hljs-string"><span class="hljs-string">'cats'</span></span>, sender_psid);   callSendAPI(sender_psid, response, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{       callSendAPI(sender_psid, askTemplate(<span class="hljs-string"><span class="hljs-string">'Show me more'</span></span>));   }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payload === <span class="hljs-string"><span class="hljs-string">'DOG_PICS'</span></span>) {   response = imageTemplate(<span class="hljs-string"><span class="hljs-string">'dogs'</span></span>, sender_psid);   callSendAPI(sender_psid, response, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{       callSendAPI(sender_psid, askTemplate(<span class="hljs-string"><span class="hljs-string">'Show me more'</span></span>));   }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(payload === <span class="hljs-string"><span class="hljs-string">'GET_STARTED'</span></span>){   response = askTemplate(<span class="hljs-string"><span class="hljs-string">'Are you a Cat or Dog Person?'</span></span>);   callSendAPI(sender_psid, response); }</code> </pre> <br>  Selain itu, setelah mengirim gambar, kami meneruskan fungsi panggilan balik ke metode <code>callSendAPI()</code> untuk mengirim pertanyaan baru kepada pengguna tentang gambar yang ia minati.  Jika berhasil, kami memanggil fungsi ini.  Skema kerja ini, dengan mempertimbangkan sifat asinkron dari fungsi callback, memungkinkan pengguna untuk menerima pesan dengan pertanyaan tentang gambar berikutnya setelah pesan dikirim kepadanya dengan gambar yang diminta sebelumnya. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/23f/b00/4b7/23fb004b75889d58a81726991724c5fd.png"></div><br>  <i><font color="#999999">Komunikasi dengan bot</font></i> <br><br><h2>  <font color="#3AC1EF">Ringkasan</font> </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ini adalah</a> repositori untuk proyek ini.  Di sana, di file <code>readme.md</code> , Anda dapat menemukan instruksi untuk menginstal dan mengkonfigurasi bot.  Agar orang lain dapat mengobrol dengan bot Anda, aplikasi Facebook Anda harus disetujui.  Hingga saat ini hanya administrator dan penguji aplikasi Anda yang dapat berbicara dengan bot.  <a href="">Ini adalah</a> video yang menunjukkan proses berkomunikasi dengan bot. <br><br>  <b>Pembaca yang budiman!</b>  Apakah Anda berencana membuat bot untuk Facebook Messenger? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id414081/">https://habr.com/ru/post/id414081/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id414067/index.html">Luncurkan penargetan ulang seluler dengan Sesuaikan: pengaturan, laporan, dan tautan</a></li>
<li><a href="../id414069/index.html">Droning pembatasan selama Piala Dunia FIFA 2018 (FIFA 2018)</a></li>
<li><a href="../id414071/index.html">Dari pemantauan hingga manajemen insiden. Laporan dari DevOps Moscow Meetup</a></li>
<li><a href="../id414073/index.html">Bermigrasi dari jQuery ke Vue.js</a></li>
<li><a href="../id414079/index.html">Fitur kerja dan perangkat internal express.js</a></li>
<li><a href="../id414083/index.html">Musim panas mitap Apache Ignite di St. Petersburg</a></li>
<li><a href="../id414085/index.html">Cara membuat sampel untuk Unified Biometric System dan mengapa itu bisa berbahaya</a></li>
<li><a href="../id414087/index.html">Otomasi segera atau bagaimana bisnis dapat bekerja online hari ini</a></li>
<li><a href="../id414089/index.html">Pemblokiran Telegram ditegakkan oleh keputusan Pengadilan Kota Moskow</a></li>
<li><a href="../id414093/index.html">Seluruh kebenaran tentang RTOS dari Colin Walls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>