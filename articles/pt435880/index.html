<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçä ‚õ∞Ô∏è ‚úçÔ∏è Alterando o esquema das tabelas do PostgreSQL sem bloqueios longos. Palestra Yandex ‚óªÔ∏è üë©‚Äçüíº üë©üèæ‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se ao mesmo tempo muitas opera√ß√µes forem executadas para alterar o esquema do banco de dados, o servi√ßo n√£o poder√° funcionar corretamente na grava√ß√£o....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Alterando o esquema das tabelas do PostgreSQL sem bloqueios longos. Palestra Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/435880/">  Se ao mesmo tempo muitas opera√ß√µes forem executadas para alterar o esquema do banco de dados, o servi√ßo n√£o poder√° funcionar corretamente na grava√ß√£o.  O desenvolvedor Vladimir Kolyasinsky explicou quais opera√ß√µes no PostgreSQL requerem bloqueios de longo prazo e como a equipe do Yandex.Connect fornece quase 100% de acesso de grava√ß√£o ao servi√ßo durante essas opera√ß√µes.  Al√©m disso, voc√™ aprender√° sobre a biblioteca do Django, projetada para automatizar parte dos processos descritos. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/P3ctIoICkOc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><blockquote>  Temos cargas pesadas, milhares de RPS e tempo de inatividade em alguns minutos, para n√£o mencionar mais tempo, √© inaceit√°vel.  √â necess√°rio que as migra√ß√µes ocorram despercebidas pelo usu√°rio.  E com tais cargas, n√£o ser√° poss√≠vel acordar √†s quatro da manh√£, rolar alguma coisa quando n√£o houver carga e voltar para a cama - porque a carga funciona 24 horas. </blockquote><br><a name="habracut"></a>  - Boa noite a todos!  Meu nome √© Vladimir, trabalho na Yandex h√° cinco anos.  Nos √∫ltimos dois anos, desenvolvi servi√ßos e servi√ßos internos para organiza√ß√µes. <br><br>  Um pouco sobre o que esses servi√ßos s√£o para as organiza√ß√µes.  Estamos usando um grande n√∫mero de servi√ßos internos h√° muito tempo: um wiki para armazenar e trocar dados, um messenger para comunica√ß√£o r√°pida com colegas, um rastreador para organizar o processo de trabalho, formul√°rios para realizar pesquisas por dentro e por fora, al√©m de muitos outros servi√ßos. <br><br>  H√° algum tempo, decidimos que nossos servi√ßos s√£o legais e que podem ser √∫teis n√£o apenas dentro do Yandex, mas tamb√©m para pessoas de fora.  Come√ßamos a traz√™-los para uma plataforma Yandex.Connect unificada, adicionando servi√ßos externos existentes, como o Mail para um dom√≠nio. <br><br><img src="https://habrastorage.org/webt/k-/sd/cz/k-sdczg1lnedmrhjfyujg6dkiyu.jpeg"><br><br>  Atualmente, estou desenvolvendo o Form Designer e o Wiki.  A pilha usada √© principalmente servi√ßos escritos em Python da segunda e terceira vers√µes;  Django 1.9-1.11.  Como banco de dados, a maioria √© PostgreSQL.  Tamb√©m √© o aipo com MongoDB e SQS como corretores.  Tudo isso funciona no Docker. <br><br>  Vamos para o problema que estamos enfrentando.  Os servi√ßos s√£o populares, s√£o usados ‚Äã‚Äãpor centenas de milhares de pessoas todos os dias, os dados s√£o acumulados, as tabelas se tornam cada vez mais e, com o tempo, muitas opera√ß√µes de altera√ß√£o de esquemas de banco de dados, que foram executadas despercebidas pelos usu√°rios ontem, come√ßam a interferir na opera√ß√£o normal dos servi√ßos. <br><br>  Hoje falaremos sobre como lidamos com essas situa√ß√µes e como atingimos alta disponibilidade de servi√ßos de leitura e grava√ß√£o. <br><br>  Primeiro, vamos considerar quais opera√ß√µes com o PostgreSQL requerem longos bloqueios na tabela.  Por bloqueio, refiro-me a qualquer tipo de bloqueio que interfira no funcionamento normal da tabela - seja acesso exclusivo, que interfira na escrita e na leitura, ou n√≠veis de bloqueio mais fracos que impedem apenas a grava√ß√£o. <br><br>  A seguir, veremos como evitar bloqueios durante essas opera√ß√µes.  Depois, falaremos sobre quais opera√ß√µes com o PostgreSQL s√£o inicialmente r√°pidas e n√£o exigem bloqueios longos.  E no final, vamos falar sobre nossa biblioteca zero_downtime_migrations, que usamos para automatizar algumas das t√©cnicas descritas anteriormente para evitar bloqueios longos. <br><br>  Opera√ß√µes que requerem um bloqueio longo: <br><br><img src="https://habrastorage.org/webt/zp/wv/xa/zpwvxagaus_ajxsaqixpwe-w7sw.jpeg"><br><br>  Criando um √≠ndice.  Por padr√£o, ele n√£o bloqueia as opera√ß√µes de leitura na tabela, mas todas as opera√ß√µes de grava√ß√£o ser√£o bloqueadas durante todo o tempo em que o √≠ndice √© criado; portanto, o servi√ßo ser√° somente leitura. <br><br>  Al√©m disso, essas opera√ß√µes incluem a adi√ß√£o de uma nova coluna com um valor padr√£o, pois sob o cap√¥ o PostgreSQL substituir√° a tabela inteira e, por esse tempo, ser√° bloqueado tanto para leitura quanto para grava√ß√£o.  Al√©m disso, todos os seus √≠ndices ser√£o substitu√≠dos. <br><br>  Sobre a altera√ß√£o do tipo de coluna - algo semelhante acontecer√°, a placa tamb√©m ser√° substitu√≠da novamente.  Deve-se observar que isso n√£o apenas leva muito tempo em tabelas grandes, mas tamb√©m requer um tempo curto at√© o dobro da quantidade de mem√≥ria livre ocupada pela tabela. <br><br>  Al√©m disso, a opera√ß√£o VACUUM FULL requer o mesmo n√≠vel de bloqueio que as opera√ß√µes anteriores - este √© o acesso exclusivo.  O VACUUM FULL tamb√©m bloquear√° todas as opera√ß√µes de leitura e grava√ß√£o na tabela. <br><br>  As duas √∫ltimas opera√ß√µes est√£o adicionando propriedades exclusivas √† coluna e, em geral, adicionando CONSTRAINT.  Eles tamb√©m exigem bloqueio durante a verifica√ß√£o dos dados, embora levem muito menos tempo do que os considerados anteriormente, pois n√£o substituem as tabelas sob o cap√¥. <br><br><img src="https://habrastorage.org/webt/hl/7j/ui/hl7juizqgpqqzpnhr_byptzs_xw.jpeg"><br><br><img src="https://habrastorage.org/webt/ji/w4/lt/jiw4lt2-5fcmeyd9qfururhscs4.jpeg"><br><br>  Criando um √≠ndice.  Aqui √© bastante simples, ele pode ser criado usando a palavra-chave CONCURRENTLY.  Qual a diferen√ßa?  Essa opera√ß√£o levar√° mais tempo, j√° que n√£o uma, mas v√°rias passagens pela tabela ser√£o executadas e tamb√©m aguardar√° a conclus√£o de todas as opera√ß√µes atuais que possam potencialmente alterar o √≠ndice.  E tamb√©m pode falhar - por exemplo, se um √≠ndice exclusivo for violado ao criar um √≠ndice exclusivo.  Em seguida, o √≠ndice ser√° marcado como inv√°lido e precisar√° ser exclu√≠do e recriado.  O comando REINDEX n√£o √© recomendado, pois funciona da mesma forma que o CREATE INDEX regular, ou seja, bloquear√° a tabela para grava√ß√£o. <br><br>  Em rela√ß√£o √† exclus√£o do √≠ndice - a partir da vers√£o 9.3, voc√™ tamb√©m pode excluir o √≠ndice CONCURRENTLY para evitar o bloqueio durante a exclus√£o, embora em geral seja uma opera√ß√£o t√£o r√°pida. <br><br><img src="https://habrastorage.org/webt/vy/yi/w8/vyyiw8m8oz-dn5gmy7-v9q8m32i.jpeg"><br><br>  Vamos dar uma olhada em adicionar uma nova coluna com um valor padr√£o.  Aqui est√° uma opera√ß√£o padr√£o que √© executada quando queremos executar esse comando, incluindo o Django que executa essa opera√ß√£o. <br><br>  Como posso reescrev√™-lo para evitar a substitui√ß√£o da tabela?  Primeiro, em uma transa√ß√£o, adicione uma nova coluna sem um valor padr√£o e adicione um valor padr√£o em uma solicita√ß√£o separada.  Qual a diferen√ßa aqui?  Quando adicionamos um valor padr√£o a uma coluna existente, isso n√£o altera os dados existentes na tabela.  Somente metadados s√£o alterados.  Ou seja, para todas as novas linhas esse valor padr√£o j√° estar√° garantido.  Resta atualizar todas as linhas existentes que estavam na tabela no momento em que este comando foi executado.  O que faremos em lotes de v√°rios milhares de c√≥pias para n√£o bloquear por muito tempo uma grande quantidade de dados. <br><br>  Ap√≥s atualizar todos os dados, resta apenas executar SET NOT NULL se criarmos uma coluna NOT NULL.  Se n√£o criarmos, ent√£o n√£o.  Dessa forma, voc√™ pode evitar a substitui√ß√£o da tabela ao fazer esse tipo de altera√ß√£o. <br><br>  Essa sequ√™ncia de comandos leva mais tempo que a execu√ß√£o de um comando regular, pois depende do tamanho da tabela e do n√∫mero de √≠ndices nela, e o comando usual simplesmente bloqueia todas as opera√ß√µes e sobrescreve a tabela independentemente da carga, pois n√£o h√° carga no momento.  Mas isso n√£o importa muito, porque durante a opera√ß√£o a tabela est√° dispon√≠vel para leitura e grava√ß√£o.  Leva muito tempo, voc√™ s√≥ precisa seguir isso e pronto. <br><br><img src="https://habrastorage.org/webt/e-/yp/gj/e-ypgjv5j7u5skjfmixtw_ie9oq.jpeg"><br><br>  Sobre como alterar o tipo de coluna.  A abordagem √© semelhante √† adi√ß√£o de uma coluna com um valor padr√£o.  Primeiro, adicionamos uma coluna separada do tipo que precisamos e, em seguida, adicionamos gatilhos para alterar os dados na coluna original para gravar nas duas colunas de uma s√≥ vez, em uma nova com o tipo de dados que precisamos.  Para todas as novas entradas, elas ir√£o imediatamente para ambas as colunas.  Precisamos atualizar todos os existentes.  O que fazemos em por√ß√µes, como no slide anterior, foi semelhante. <br><br>  Depois disso, permanece em uma transa√ß√£o excluir o acionador, excluir a coluna antiga e renomear a coluna antiga para uma nova.  Assim, alcan√ßamos o mesmo resultado: alteramos o tipo da coluna, enquanto o bloqueio da tabela n√£o demorou muito. <br><br><img src="https://habrastorage.org/webt/3n/n3/ge/3nn3geu-vzcexvckvzsoomxx1ns.jpeg"><br><br>  Sobre como adicionar uma coluna exclusiva.  Um bloqueio √© realizado no momento da cria√ß√£o.  Isso pode ser evitado se voc√™ souber que a exclusividade no PostgreSQL √© garantida atrav√©s da cria√ß√£o de um √≠ndice exclusivo.  N√≥s mesmos podemos criar o √≠ndice exclusivo necess√°rio usando CONCURRENTLY.  E depois de criar esse √≠ndice, crie CONSTRAINT usando esse √≠ndice.  Depois disso, a defini√ß√£o do √≠ndice inicial da tabela desaparecer√° e o resultado que a defini√ß√£o da tabela nos mostrar√° n√£o ser√° diferente ap√≥s a execu√ß√£o dessas duas opera√ß√µes. <br><br><img src="https://habrastorage.org/webt/o4/uz/lt/o4uzltwdxqnag3c0uwvvo9hw7uw.jpeg"><br><br>  E, em geral, ao adicionar CONSTRAINT.  Voc√™ pode usar esta t√©cnica para evitar o bloqueio durante a verifica√ß√£o de dados.  Primeiro, adicionamos CONSTRAINT com a palavra-chave NOT VALID.  Isso significa que n√£o √© garantido que este CONSTRAINT seja executado para todas as linhas da tabela.  Mas, ao mesmo tempo, para todas as novas linhas, esse CONSTRAINT j√° ser√° aplicado e as exce√ß√µes correspondentes ser√£o lan√ßadas se n√£o forem executadas. <br><br>  S√≥ podemos validar todos os valores existentes, o que pode ser feito com um comando VALIDATE CONSTRAINT separado e, ao mesmo tempo, esse comando n√£o interfere mais na leitura ou grava√ß√£o na tabela.  Uma tabela para esse hor√°rio estar√° dispon√≠vel. <br><br>  Opera√ß√µes que inicialmente funcionam rapidamente no PostgreSQL e n√£o exigem bloqueios longos: <br><br><img src="https://habrastorage.org/webt/l1/z1/tq/l1z1tq5nwf1l9jhoushtujix-t8.jpeg"><br><br>  Uma dessas opera√ß√µes √© adicionar uma coluna sem valores padr√£o e quaisquer restri√ß√µes.  Como nenhuma altera√ß√£o √© feita na tabela em si, apenas seus metadados s√£o alterados.  E todos os valores NULL que vemos como resultado de SELECT s√£o misturados simplesmente na sa√≠da. <br><br>  Al√©m disso, adicionar valores padr√£o a um r√≥tulo existente √© uma opera√ß√£o r√°pida, pois apenas os metadados s√£o alterados.  A tabela e o bloqueio s√£o obtidos literalmente pelos poucos milissegundos necess√°rios para inserir essas informa√ß√µes. <br><br>  Al√©m disso, a opera√ß√£o r√°pida da configura√ß√£o de SET NOT NULL, aqui leva um pouco mais do que o descrito anteriormente, cerca de alguns segundos por tabela de 30 milh√µes de registros.  Esse tempo tamb√©m pode ser evitado se for importante. <br><br>  Renomear uma coluna, alterar o comprimento de uma coluna tamb√©m n√£o leva √† substitui√ß√£o de uma coluna.  Excluir uma coluna e, em geral, muitas entidades no PostgreSQL tamb√©m √© uma opera√ß√£o r√°pida. <br><br><img src="https://habrastorage.org/webt/fq/rq/0z/fqrq0zlgqqbszyo7aajzsmzrtjy.jpeg"><br><br>  Em rela√ß√£o √† adi√ß√£o de uma coluna NOT NULL.  Para evitar o bloqueio durante a valida√ß√£o, voc√™ pode executar o m√©todo mencionado anteriormente - adicione CONSTRAINT correspondente a CHECK (a coluna N√ÉO √â NULL) NOT VALID e valide-a com um comando separado. <br><br>  A diferen√ßa em geral √© que essa restri√ß√£o existir√° no n√≠vel da tabela e n√£o no n√≠vel da coluna na defini√ß√£o da tabela.  Outra diferen√ßa √© que isso pode afetar o desempenho, cerca de um por cento.  Nesse caso, n√£o haver√° bloqueio, se o servi√ßo estiver muito carregado, mesmo alguns segundos de bloqueio poder√£o levar a uma enorme fila de transa√ß√µes se acumulando e haver√° um problema no servi√ßo. <br><br><img src="https://habrastorage.org/webt/qj/oy/sb/qjoysbcnasbr3xz0komagdri2oe.jpeg"><br><br>  A exclus√£o de dados no PostgreSQL geralmente √© uma opera√ß√£o r√°pida, uma vez que os dados n√£o s√£o exclu√≠dos imediatamente, apenas a coluna √© marcada como desatualizada nos atributos da tabela, e os dados ser√£o realmente exclu√≠dos somente ap√≥s o in√≠cio do pr√≥ximo v√°cuo. <br><br><img src="https://habrastorage.org/webt/v3/75/n5/v375n5xmrwzhinew6obppnsdgeq.jpeg"><br><br>  Vamos conversar sobre a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> .  Eu estou falando sobre Django, migra√ß√£o.  Em geral, o Django √© uma biblioteca para Python, uma estrutura da web, originalmente criada para criar rapidamente sites como not√≠cias, desde ent√£o, foi significativamente atualizada.  Existe um sistema ORM que permite a comunica√ß√£o com registros no banco de dados, com tabelas, como se fossem objetos ou classes Python.  Ou seja, cada tabela possui sua pr√≥pria classe em Python.  E quando fazemos altera√ß√µes em nosso c√≥digo Python, ou seja, adicionamos novos atributos como colunas √† tabela, o Django durante o processo de cria√ß√£o da migra√ß√£o percebe essas altera√ß√µes e cria os arquivos de migra√ß√£o para fazer altera√ß√µes espelhadas no pr√≥prio banco de dados para que n√£o divergam. <br><br>  A biblioteca foi escrita para automatizar algumas das t√©cnicas discutidas anteriormente para evitar bloqueios longos na tabela durante essas migra√ß√µes.  Ele trabalha com o Django desde a vers√£o 1.8 a 2.1 inclusive, e o Python de 2.7 a 3.7 inclusive. <br><br>  Com rela√ß√£o aos recursos atuais da biblioteca, est√° adicionando uma coluna com um valor padr√£o sem bloqueios, anul√°vel ou n√£o, criando um √≠ndice CONCURRENTLY, bem como a capacidade de reiniciar quando falha.  Na implementa√ß√£o padr√£o do Django, se adicionarmos uma coluna com um valor padr√£o, a tabela estar√° bloqueada e, se for grande, poder√° levar 40 minutos de bloqueio na minha experi√™ncia.  A mesa est√° trancada e pronto, aguarde at√© que as altera√ß√µes sejam copiadas e feitas.  30 minutos se passaram - eles pegaram o erro de conex√£o com o banco de dados, a migra√ß√£o caiu, as altera√ß√µes n√£o foram confirmadas e voc√™ deve iniciar novamente, aguarde 40 minutos novamente, bloqueando novamente a tabela por esse tempo. <br><br><img src="https://habrastorage.org/webt/vg/xy/lz/vgxylzlxerxosettf26nbtrqo9u.jpeg"><br><h5>  <sup><sub><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link do GitHub</a></sub></sup> </h5><br>  A biblioteca permite retomar a migra√ß√£o do local em que foi interrompida.  Quando voc√™ trava e reinicia, uma caixa de di√°logo √© exibida com v√°rias op√ß√µes de a√ß√£o, ou seja, voc√™ pode continuar a atualizar os dados.  Geralmente, isso √© uma atualiza√ß√£o de dados porque √© o processo mais longo.  A migra√ß√£o simplesmente continuar√° de onde parou.  Essa opera√ß√£o tamb√©m leva mais tempo do que uma opera√ß√£o padr√£o com bloqueio de tabela, mas, ao mesmo tempo, o servi√ßo permanece operacional no momento. <br><br><img src="https://habrastorage.org/webt/kp/d2/bp/kpd2bpbqlehlnxps9ozwj3iuv4g.jpeg"><br><br>  Sobre a conex√£o como um todo.  Existe documenta√ß√£o;  em resumo, voc√™ precisa substituir o mecanismo nas configura√ß√µes do banco de dados Django pelo mecanismo da biblioteca.  Tamb√©m existem v√°rios mixins se voc√™ usar seus motores para se conectar. <br><br><img src="https://habrastorage.org/webt/x1/fc/gh/x1fcghzaqinnjq-hela3v1aarie.jpeg"><br><br>  Um exemplo de trabalho √© sobre como adicionar uma coluna com um valor padr√£o.  Aqui, adicionamos colunas com um valor booleano, True por padr√£o.  Quais opera√ß√µes s√£o executadas pelo SchemaEditor padr√£o?  As opera√ß√µes que voc√™ pode ver se executar o SQL migram.  Isso √© bastante √∫til, pelo pr√≥prio tipo de migra√ß√£o, nem sempre √© claro o que o Django pode realmente mudar l√°.  E √© √∫til come√ßar e ver se as opera√ß√µes esperadas por n√≥s est√£o conclu√≠das e se algo desnecess√°rio e desnecess√°rio chegou l√°. <br><br>  Quais comandos o SchemaEditor executa?  Primeiro, uma nova coluna √© adicionada a uma transa√ß√£o, o valor padr√£o √© adicionado.  Ent√£o, at√© que essa atualiza√ß√£o retorne e atualize zero, os dados ser√£o atualizados. <br><br>  Ent√£o SET NOT NULL √© definido na coluna e o valor padr√£o ser√° exclu√≠do, repetindo o comportamento do Django, que armazena o valor padr√£o n√£o no banco de dados, mas no n√≠vel l√≥gico do c√≥digo. <br><br>  Aqui, em geral, tamb√©m h√° espa√ßo para crescer.  Por exemplo, voc√™ pode criar um √≠ndice auxiliar para encontrar rapidamente essas linhas com um valor NULL √† medida que se aproxima da atualiza√ß√£o de toda a tabela. <br><br><img src="https://habrastorage.org/webt/je/a8/h3/jea8h37vcuylfp-eut209sdpsse.jpeg"><br><br>  Voc√™ tamb√©m pode corrigir o ID m√°ximo para o tempo de atualiza√ß√£o quando iniciamos a migra√ß√£o, para que, por ID, voc√™ possa encontrar rapidamente valores que ainda n√£o foram atualizados. <br><br>  Em geral, a biblioteca est√° em desenvolvimento, aceitamos solicita√ß√µes de pool.  Quem se importa - participe. <br><br>  Vale a pena prestar aten√ß√£o que, com o crescimento dos bancos de dados, as migra√ß√µes t√™m uma propriedade inevit√°vel para desacelerar.  Voc√™ precisa acompanhar quais bloqueios a tabela possui, executar migra√ß√µes SQL para ver quais opera√ß√µes s√£o aplicadas.  De nossa parte, no Yandex.Connect, usamos essa biblioteca onde seus recursos permitem.  E onde eles n√£o permitem, n√≥s mesmos, por nossas pr√≥prias m√£os, falsas migra√ß√µes de Django, executamos nossas consultas SQL. <br><br>  Assim, alcan√ßamos alta disponibilidade de servi√ßos de leitura e grava√ß√£o.  Temos cargas pesadas, milhares de RPS e tempo de inatividade em alguns minutos, para n√£o mencionar mais tempo, √© inaceit√°vel.  √â necess√°rio que as migra√ß√µes ocorram despercebidas pelo usu√°rio.  E com essas cargas, n√£o ser√° poss√≠vel acordar √†s quatro da manh√£, rolar alguma coisa quando n√£o houver carga e voltar para a cama - porque a carga funciona 24 horas por dia. <br><br>  Vale a pena notar que mesmo opera√ß√µes r√°pidas no PostgreSQL ainda podem causar uma lentid√£o no servi√ßo e erros devido √† maneira como a fila de bloqueio funciona no PostgreSQL. <br><br>  Imagine que uma opera√ß√£o seja iniciada que, mesmo por alguns milissegundos, exija acesso exclusivo.  Um exemplo dessa opera√ß√£o √© adicionar uma coluna sem um valor padr√£o.  Imagine que, no momento de seu lan√ßamento em outra transa√ß√£o, haja alguma outra opera√ß√£o longa - digamos, SELECT com agrega√ß√£o.  Nesse caso, nossa opera√ß√£o far√° uma fila para ela.  Isso acontecer√° porque o acesso a conflitos exclusivos com todos os outros tipos de bloqueios. <br><br>  Enquanto nossa opera√ß√£o de adicionar uma coluna estiver aguardando um bloqueio, todos os outros far√£o fila para ele e n√£o ser√£o executados at√© que seja conclu√≠do.  Ao mesmo tempo, a opera√ß√£o que est√° sendo executada - SELECT com agrega√ß√£o - pode n√£o entrar em conflito com as outras, e se n√£o fosse a cria√ß√£o da coluna, elas n√£o teriam ficado na fila, mas teriam sido executadas em paralelo. <br><br>  Essa situa√ß√£o pode criar grandes problemas no servi√ßo.  Portanto, antes de iniciar o ALTER TABLE ou qualquer outra opera√ß√£o que exija bloqueio exclusivo de acesso, √© necess√°rio procurar para que consultas longas n√£o sejam direcionadas ao banco de dados no momento.  Ou voc√™ pode simplesmente inserir um tempo limite de log muito pequeno.  Ent√£o, se n√£o fosse poss√≠vel fechar rapidamente a trava, a opera√ß√£o cairia.  Poder√≠amos simplesmente reinici√°-lo e n√£o bloquear a tabela por um longo tempo, enquanto a opera√ß√£o aguardar√° a concess√£o de uma concess√£o para bloqueios.  Isso √© tudo, obrigado. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435880/">https://habr.com/ru/post/pt435880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435868/index.html">Slush 2018. Dia da pr√©-visualiza√ß√£o</a></li>
<li><a href="../pt435870/index.html">Orquestra Cibern√©tica. Orquestra√ß√£o de cont√™iner do Docker com aplicativos .NET Core na nuvem</a></li>
<li><a href="../pt435872/index.html">Linguagem de programa√ß√£o Zig</a></li>
<li><a href="../pt435876/index.html">Configura√ß√µes detalhadas do navegador Firefox</a></li>
<li><a href="../pt435878/index.html">Amador em c√≥digo aberto - li√ß√µes aprendidas em 3 anos</a></li>
<li><a href="../pt435882/index.html">Xiaomi Mi Box S revis√£o e uma pequena compara√ß√£o com Mi Box 3</a></li>
<li><a href="../pt435884/index.html">Pesquisa de metais e ... rede neural</a></li>
<li><a href="../pt435886/index.html">SpaceX mostrou prot√≥tipo de nave estelar e reduzir√° 10% do pessoal</a></li>
<li><a href="../pt435890/index.html">Os lados sombrios de uma pessoa ativa</a></li>
<li><a href="../pt435892/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel 281 (de 7 a 13 de janeiro)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>