<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÜüèº üéÅ üßöüèæ Escolhendo um modo operacional de servidor da Web com base na experi√™ncia pessoal ü•Ñ üëâüèø üë®üèæ‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo ser√° √∫til para pessoas que j√° possuem seu pr√≥prio site ou que planejam abri-lo. Artigo particularmente interessante ser√£o webmasters ambic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escolhendo um modo operacional de servidor da Web com base na experi√™ncia pessoal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434198/">  Este artigo ser√° √∫til para pessoas que j√° possuem seu pr√≥prio site ou que planejam abri-lo.  Artigo particularmente interessante ser√£o webmasters ambiciosos que acham que a melhor hora de seu projeto est√° chegando e querem se preparar para o fluxo de visitantes da p√°gina. <br><br>  Mesmo aqueles que ainda sonham com milhares de usu√°rios em seu site, provavelmente se perguntaram: "Quantos usu√°rios meu site permanecer√° se eles fizerem login ao mesmo tempo?"  Lembro-me imediatamente da famosa express√£o ‚ÄúHabraeffect‚Äù - o fen√¥meno de falha no site, que acabou por n√£o estar pronto para v√°rios cliques ap√≥s o aparecimento do link na Internet. <br><a name="habracut"></a><br>  Suponha que o site j√° exista (ou ser√° em breve): onde ele pode ser localizado?  Deve ser um servidor de hospedagem ou vps cl√°ssico?  Se vps, qual e como √© melhor configur√°-lo?  Ou talvez n√£o haja diferen√ßa alguma e seja mais f√°cil escolher o que √© mais barato?  Neste artigo, consideraremos v√°rias op√ß√µes e, na pr√°tica, garantiremos qual √© a melhor para o nosso site. <br><br>  Vamos experimentar: definir diferentes modos de opera√ß√£o do servidor e medir o desempenho.  Simularemos a carga no site usando o servi√ßo Loaddy.com.  L√°, voc√™ pode definir o n√∫mero de usu√°rios, o tipo crescente de carga e o gr√°fico mostrar√° como o servidor responde a eles.  Acredita-se que um usu√°rio gere aproximadamente uma solicita√ß√£o ao site em 10 segundos.  Como site de teste, fa√ßa uma loja virtual de demonstra√ß√£o no cms moguta.  Ele ser√° preenchido com ‚Äúmercadorias‚Äù de teste que s√£o exibidas na p√°gina principal de acordo com v√°rios crit√©rios (ou seja, quando a p√°gina est√° sendo formada, o trabalho est√° em andamento com o banco de dados, etc.).  De uma forma ou de outra, isso permitir√° comparar os modos entre si. <br><br>  Como site de teste, criaremos um servidor VPS no Ubuntu.  Sua configura√ß√£o ser√° [1 n√∫cleo, 1 GB de RAM].  Assumimos que s√£o precisamente esses servidores de n√≠vel de entrada que s√£o criados na maioria dos casos para novos projetos.  A vers√£o de teste da loja online estar√° dispon√≠vel no endere√ßo IP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://130.193.44.219/</a> <br><br>  A hospedagem cl√°ssica tamb√©m √© √∫til, para a qual tamb√©m preencheremos a mesma loja online para realizar testes.  Voc√™ pode seguir nosso pr√≥prio caminho e realizar os mesmos testes em seu projeto! <br><br>  Como na maioria dos casos, um painel de controle √© oferecido juntamente com os vps, faremos as principais altera√ß√µes nas configura√ß√µes nele.  No servidor vps, temos 3 modos de opera√ß√£o: <br><br><ul><li>  Apache </li><li>  Apache no modo CGI; </li><li>  Nginx + php-fpm (sem Apache). </li></ul><br>  Mas primeiro, vamos testar a hospedagem: <br><br><h2>  Hospedagem cl√°ssica de baixo custo </h2><br><img src="https://habrastorage.org/webt/9i/9u/rj/9i9urjtvocmzug1u0s7aug1e-qk.gif" alt="imagem"><br>  O resultado est√° dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Os erros aparecem quando o n√∫mero de visitantes excede 50 pessoas.  A hospedagem deixa de fornecer conte√∫do; no entanto, se voc√™ for ao painel de controle da hospedagem, podemos ver algo como o seguinte: <br><blockquote>  Seu site est√° sujeito a restri√ß√µes nas √∫ltimas 24 horas.  Os recursos do processador foram limitados para o seu site.  Voc√™ atingiu os limites dos processos de entrada (o n√∫mero de scripts PHP e CGI em execu√ß√£o simultaneamente, tarefas agendadas e sess√µes do console) 126 vezes. </blockquote>  Bem, √© claro, hospedagem √© hospedagem, ainda mais barata.  Voc√™ pode, √© claro, encontrar uma tarifa que ofere√ßa mais op√ß√µes, mas √© necess√°rio considerar tudo isso, descobrir de alguma forma os dados exatos das restri√ß√µes e cada provedor de hospedagem. <br><br><h2>  VPS: Apache </h2><br>  O pr√≥ximo na fila √© o nosso teste da For√ßa A√©rea com o modo Apache, que por sinal √© oferecido por padr√£o ao instalar o painel de controle do ISP. <br><br><img src="https://habrastorage.org/webt/cq/ps/3k/cqps3kza1pw3ew7wdszpqcovgva.gif" alt="imagem"><br><br>  O resultado est√° dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Os problemas come√ßam quando o n√∫mero de usu√°rios excede 90. Se formos ao nosso servidor via ssh e examinarmos esse momento na lista de processos usando o comando top, classificados usando Shift + M (pela quantidade de mem√≥ria consumida), veremos algo assim: <br><br><img src="https://habrastorage.org/webt/8y/ml/uk/8ymlukh_jyjx0jlsnttsw_de6mw.gif" alt="imagem"><br><br>  Vemos que o processo apache2 cresceu para muitas subsidi√°rias e elas consumiram toda a RAM do nosso servidor vps. <br><br>  Aqui voc√™ precisa fazer uma pequena observa√ß√£o.  O fato √© que, teoricamente, existe um modo para o servidor Apache que permite, em vez desse grande n√∫mero de processos filho, para cada conex√£o criar v√°rios chamados multiencadeamentos, cada um dos quais serviria a v√°rias conex√µes.  Esse modo √© chamado de <i>trabalhador</i> , diferente do <i>prefork</i> padr√£o.  Mas n√£o √© f√°cil instal√°-lo, √© imposs√≠vel fazer isso em pain√©is como o ISP, e se voc√™ ficar intrigado e tentar faz√™-lo via ssh, acontece que desativar o prefork e ativar o worker n√£o √© suficiente, voc√™ ainda precisa de uma vers√£o segura do thread do php.  E se m√≥dulos como Zend ou IonCube forem usados, eles tamb√©m dever√£o ser seguros para threads.  De qualquer forma, o site oficial do PHP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√£o recomenda</a> definir este modo. <br><br><h2>  VPS: CGI </h2><br>  Vamos ver o que acontece ao usar o modo CGI.  Para isso, √© necess√°rio permitir o uso do PHP no modo CGI no painel de controle do ISP, isso √© feito na se√ß√£o "Contas - Usu√°rios - Configura√ß√µes para o usu√°rio". <br><br><img src="https://habrastorage.org/webt/jc/md/zx/jcmdzxrcghqhwf4xmy2edbixov0.gif" alt="imagem"><br><br>  O resultado est√° dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Uma imagem sombria acabou.  O servidor se recusa a fornecer conte√∫do j√° com mais de 55 visitantes, a RAM √© consumida por processos "php".  A seguir, √© apresentada uma tentativa de restaurar a funcionalidade, mas ainda termina com quase 100% de falha. <br><br><h2>  VPS: Nginx + PHP-FPM </h2><br>  Chegou a hora de um modo no qual o servidor Apache n√£o √© usado, o Nginx funciona e o php √© processado pelo m√≥dulo php-fpm.  Se voc√™ usar o painel de controle do ISP, dever√° ativar este modo para o usu√°rio.  Isso tamb√©m √© feito na se√ß√£o "Contas - Usu√°rios - Configura√ß√µes do usu√°rio".  Al√©m disso, esse modo deve estar dispon√≠vel na se√ß√£o "Configura√ß√µes - Recursos - Servidor Web (www)". <br><br><img src="https://habrastorage.org/webt/g1/9h/tu/g19htuq2ms1wdgc7chekxfrdzzk.gif" alt="imagem"><br><br>  O resultado est√° dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  O que voc√™ precisa!  100% de disponibilidade, enquanto a velocidade de download e o tempo de resposta do servidor est√£o em n√≠veis aceit√°veis, embora aumentem com o aumento da carga.  No entanto, o servidor est√° lidando! <br><br>  Vejamos a tabela de processos no momento da carga m√°xima no servidor: <br><br><img src="https://habrastorage.org/webt/lf/al/bx/lfalbxszotenrmulrkdhifuejky.gif" alt="imagem"><br><br>  Vemos que ainda temos um suprimento de RAM dispon√≠vel.  E os processos filhos do php-fpm7.0 n√£o crescem em grandes n√∫meros, mas s√£o limitados a 5 inst√¢ncias, cada uma das quais serve v√°rios threads. <br><br>  Bem, parece que um "modo vencedor" est√° definido.  Vamos descobrir quantos visitantes simult√¢neos nosso servidor pode atender nesse modo.  Mas antes disso fazemos um pequeno "ajuste".  Primeiro, como o apache n√£o √© usado para essa opera√ß√£o do servidor, ele pode ser completamente desativado.  Faremos isso no painel de controle do ISP, na se√ß√£o "Sistema - Servi√ßos".  Em segundo lugar, mudamos um pouco o princ√≠pio de iniciar processos php-fpm.  Por padr√£o, √© din√¢mico.  Isso significa que os processos filhos ser√£o travados na mem√≥ria, mesmo quando n√£o forem necess√°rios.  Ao mesmo tempo, a mem√≥ria n√£o √© liberada e, com o tempo, esses processos podem crescer mais do que gostar√≠amos.  Portanto, prop√µe-se definir o modo ‚Äúondemand‚Äù - sob demanda.  E defina o n√∫mero de processos filhos e o tempo limite para eles. <br><br>  Para fazer isso, voc√™ precisar√° ir ao servidor via ssh e registrar essas configura√ß√µes no arquivo de configura√ß√£o php.  Isso √© feito convenientemente no arquivo para o usu√°rio para quem o dom√≠nio foi criado no ISP. <br><br>  Geralmente est√° localizado em /etc/php/7.0/fpm/pool.d <br><br>  Ent√£o: <pre><code class="bash hljs">sudo nano /etc/php/7.0/fpm/pool.d/www-root.conf</code> </pre> <br><br>  Por padr√£o, vemos as seguintes configura√ß√µes: <br><br><pre> <code class="plaintext hljs">[www-root] pm = dynamic pm.start_servers = 1 pm.min_spare_servers = 1 pm.max_children = 5 pm.max_spare_servers = 5</code> </pre> <br>  Para ativar o modo ondemand, √© necess√°rio substitu√≠-lo por: <br><pre> <code class="plaintext hljs">pm = ondemand pm.max_children = 5 pm.process_idle_timeout = 10s</code> </pre> <br>  E reinicie o php-fpm com o comando <br><br><pre> <code class="bash hljs">sudo service php7.0-fpm restart</code> </pre> <br>  Depois disso, os processos php-fpm7.0 ser√£o criados sob demanda (se houver uma carga), seu n√∫mero m√°ximo ser√° = 5 e, ap√≥s 10 segundos de inatividade, o processo ser√° interrompido, liberando RAM. <br><br>  Por precau√ß√£o, faremos nosso teste novamente para garantir que toda essa atividade amadora n√£o afete o desempenho do site para pior: <br><br><img src="https://habrastorage.org/webt/j_/ii/3q/j_ii3q4de-cmblsvtxi7grdwumq.gif" alt="imagem"><br><br>  O resultado est√° dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Agora vamos executar o Loaddy com muitos visitantes para entender quantas conex√µes nosso servidor pode suportar: <br><br><img src="https://habrastorage.org/webt/wb/vs/72/wbvs72nk8yujn1n8w-ngook9mm0.gif" alt="imagem"><br><br>  O resultado est√° dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  A boa not√≠cia √© que todas as solicita√ß√µes foram processadas, embora com um grande atraso, com um grande n√∫mero delas por segundo.  O tempo de resposta do servidor √© pr√≥ximo de 10 segundos com mais de 190 ocorr√™ncias, mas vamos lembrar o gr√°fico do modo apache, onde j√° temos 4 segundos de resposta do servidor com mais de 80 usu√°rios, enquanto no modo php-fpm, atrasos semelhantes s√£o observados com 130 solicita√ß√µes que foram alocadas especialmente cursor no gr√°fico acima. <br>  Mas este √© o mesmo VPS. <br><br>  Tabela dos principais processos no final do teste (com 200 usu√°rios): <br><br><img src="https://habrastorage.org/webt/rj/uj/ra/rjujrafp7z1vbu_iqryibz88cew.gif" alt="imagem"><br><br>  Observe que ap√≥s o teste, a mem√≥ria usada pelo pfp-fpm √© liberada: <br><br><img src="https://habrastorage.org/webt/yc/32/vt/yc32vtmtnrupcw6spibvemvkzpk.gif" alt="imagem"><br><br>  Portanto, nosso servidor est√° pronto para novas cargas. <br><br>  Deve-se lembrar que o site opera no modo nginx + php-fpm, o que significa que o apache2 n√£o √© usado no trabalho e, como resultado, o .htaccess n√£o √© usado.  Isso pode n√£o parecer conveniente, mas √© a op√ß√£o mais r√°pida poss√≠vel, e os mecanismos de pesquisa classificam melhor os sites que trabalham mais r√°pido. <br><br><h2>  Conclus√£o </h2><br>  Concluindo, mais um pequeno ponto: se voc√™ configurou tudo no servidor que desejava e decidiu desconectar o painel de controle do ISP ou ficou sem uma licen√ßa para isso, observe que o processo "principal" continuar√° travado no servidor.  Depois de meses, ele pode crescer, ent√£o √© melhor "mat√°-lo" e remov√™-lo da inicializa√ß√£o e do crona. <br><br>  Se voc√™ deseja testar independentemente o site usando o Loaddy ou outros m√©todos, ele est√° dispon√≠vel em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://130.193.44.219/</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434198/">https://habr.com/ru/post/pt434198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434188/index.html">Semana 52 de Seguran√ßa: Os Maiores Sucessos</a></li>
<li><a href="../pt434190/index.html">Como criar um milagre digital de Natal: uma entrevista com o CIO Papai Noel</a></li>
<li><a href="../pt434192/index.html">Como o port√£o de Baldur salvou RPGs de computador</a></li>
<li><a href="../pt434194/index.html">Desenvolvimento de habilidades para Alice. Experi√™ncia com interfaces de voz, dicas para iniciantes</a></li>
<li><a href="../pt434196/index.html">3CX v16 Alpha 2 e planos para o novo ano</a></li>
<li><a href="../pt434200/index.html">A ferrugem √© t√£o terr√≠vel quanto √© pintada</a></li>
<li><a href="../pt434202/index.html">4 segredos sobre como n√£o perder o emprego na ci√™ncia de dados</a></li>
<li><a href="../pt434206/index.html">Distribuidor de jato ok.ru/music</a></li>
<li><a href="../pt434208/index.html">Como foi salvo nossa sexta-feira negra</a></li>
<li><a href="../pt434210/index.html">An√°lise do concurso de question√°rios Android do estande do HeadHunter no Mobius 2018 Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>