<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå± ü¶è üíª Corrigindo c√≥digo Java na produ√ß√£o sem anestesia üîà üëãüèº ü•™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aqui vou falar sobre o dispositivo de uma das muitas ferramentas que ajudam no desenvolvimento de v√°rios servi√ßos para o projeto Odnoklassniki. Dentro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Corrigindo c√≥digo Java na produ√ß√£o sem anestesia</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/429040/"><img src="https://habrastorage.org/webt/di/gh/wc/dighwcvw92d2zysgdcdref8_ptg.png" alt="imagem"><br><br>  Aqui vou falar sobre o dispositivo de uma das muitas ferramentas que ajudam no desenvolvimento de v√°rios servi√ßos para o projeto Odnoklassniki.  Dentro da empresa, chamamos de "Hot Code Replace" (HCR), e essa ferramenta foi projetada para corrigir erros cr√≠ticos e descomplicados na execu√ß√£o de servi√ßos de produ√ß√£o sem interromp√™-los.  Esse √© um recurso extremamente importante, pois permite evitar o processo bastante chato e demorado de criar uma nova vers√£o corrigida de um servi√ßo de lixo eletr√¥nico, evitar a pausa bastante longa na acessibilidade de cada host e evitar a descarga de caches. <br><br>  Em geral, economiza muito tempo e reduz o intervalo desde o momento em que o erro √© detectado at√© a corre√ß√£o de horas para minutos.  Na maioria das vezes, conforme planejado, pequenos erros no c√≥digo s√£o corrigidos; por exemplo, o programador esqueceu de verificar se h√° nulos e, para alguns usu√°rios, certas a√ß√µes no site levam a um erro.  Ou seja, quando a corre√ß√£o √© realizada alterando v√°rias linhas dentro do m√©todo.  E por causa de pequenas mudan√ßas, voc√™ n√£o precisa mais distrair seus colegas e aguardar horas dispon√≠veis para produ√ß√£o. <br><a name="habracut"></a><br>  Por exemplo: <br><br><img src="https://habrastorage.org/webt/ra/dh/vz/radhvzc9u4d1q6dc8r4v6uhlekq.png" alt="imagem"><br>  Voc√™ pode corrigi-lo facilmente: <br><br><img src="https://habrastorage.org/webt/rp/9i/ta/rp9itax-od_0ahz3yg8dxdxvf7u.png" alt="imagem"><br>  Obviamente, voc√™ pode fazer muito mais altera√ß√µes, ao mesmo tempo adicionar novas classes, fazer altera√ß√µes rapidamente, conforme solicitado pelo gerente, sem esperar pela pr√≥xima atualiza√ß√£o.  Mas isso j√° √©, se Monsieur sabe muito sobre pervers√µes. <br><br>  Al√©m disso, √© poss√≠vel colocar "remendos" um no outro e at√© o infinito. <br><br>  Mas essa ferramenta n√£o √© onipotente e se baseia na funcionalidade padr√£o que a classe Java oferece: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">java.lang.instrument.Instrumentation e seu m√©todo void redefineClasses (ClassDefinition ... defini√ß√µes)</a> . <br><br>  Instrumentation.redefineClasses substitui as classes carregadas anteriormente pelo novo c√≥digo de bytes.  Voc√™ pode sobrecarregar v√°rias classes com depend√™ncias diferentes ao mesmo tempo.  A sobrecarga n√£o altera as inst√¢ncias de classe existentes, n√£o muda a heran√ßa e n√£o toca nos campos de inst√¢ncia ou classe.  Voc√™ s√≥ pode alterar o corpo do m√©todo, o conjunto de constantes e atributos.  Voc√™ pode adicionar novas classes ou subclasses.  Assinaturas de m√©todo, campos de inst√¢ncia e campos de classe n√£o podem ser alterados.  Se voc√™ tentar fazer altera√ß√µes incompat√≠veis, redefineClasses, em princ√≠pio, n√£o funcionar√° e gerar√° um erro.  Deve-se lembrar que quando as classes est√£o sobrecarregadas, a execu√ß√£o da se√ß√£o sobrecarregada do c√≥digo n√£o √© interrompida, o novo bytecode ser√° usado na pr√≥xima vez que o mesmo m√©todo for chamado.  E, portanto, se voc√™ tentar corrigir o c√≥digo de um m√©todo que possui um ciclo infinitamente longo, a substitui√ß√£o real ocorrer√° somente ap√≥s o t√©rmino desse ciclo. <br><br>  Se for simplesmente: voc√™ pode alterar o c√≥digo apenas dentro dos m√©todos e do ponto. <br><br>  E aqui est√° um exemplo de um loop while, que at√© o m√©todo ser conclu√≠do, n√£o ser√° corrigido. <br><br><img src="https://habrastorage.org/webt/p7/rv/1a/p7rv1agfvd0f7phg4otdxedkohk.png" alt="imagem"><br><br>  A principal dificuldade foi criar uma ferramenta que funcione no ecossistema Odnoklassniki, uma ferramenta que se encaixa em todos os processos de trabalho estabelecidos.  Que ir√° interagir de forma consistente e transparente com todos os servi√ßos em centenas de hosts, al√©m de ser flex√≠vel e f√°cil de usar.  Essa ferramenta deve lidar com dezenas de experimentos, trabalhos e atualiza√ß√µes que ocorrem continuamente na produ√ß√£o. <br><br>  Como √© o processo de instala√ß√£o de um patch do ponto de vista do desenvolvedor / administrador, tentando corrigir um erro na produ√ß√£o, mas para que isso possa ser feito usando algum procedimento padr√£o e confi√°vel em dezenas de servidores.  Omitimos o processo de localiza√ß√£o e corre√ß√£o de erros no c√≥digo. <br><br>  1. Um brunch separado √© criado no GIT para corre√ß√µes de c√≥digo.  O uso da vers√£o √© muito importante, n√£o apenas por conveni√™ncia, mas tamb√©m para poss√≠veis investiga√ß√µes subsequentes. <br><br>  2. O TeamCity inicia o processo de cria√ß√£o do patch.  Primeiro, uma montagem do projeto √© criada a partir do brunch especificado e, em seguida, a nova montagem √© comparada com a instalada na produ√ß√£o.  Para fazer isso, escrevi um plug-in para a ferramenta de constru√ß√£o, que extrai todos os arquivos dos arquivos, compara discrep√¢ncias e seleciona apenas os arquivos que foram alterados ou adicionados.  Nesse caso, a vers√£o do compilador Java nos dois assemblies deve ser a mesma, porque  outra vers√£o do compilador criar√° arquivos diferentes e quase todos os arquivos do projeto ser√£o inclu√≠dos no patch.  √â muito importante criar apenas um pequeno arquivo, no qual somente os arquivos necess√°rios ser√£o obtidos, porque  Isso ir√° acelerar significativamente o processo de entrega do patch para dezenas de servidores.  O processo de constru√ß√£o √© adequado n√£o apenas para o patch do c√≥digo do projeto, mas tamb√©m √© poss√≠vel substituir a biblioteca corrigida no projeto.  Ao comparar o conte√∫do de dois assemblies, ser√£o encontradas diferen√ßas nas bibliotecas (arquivos jar). <br><br>  3. No caso de uma compila√ß√£o bem-sucedida, o patch √© enviado para um reposit√≥rio especial e, na janela de resultados, uma chave (ou hash) √© emitida, necess√°ria para identificar exclusivamente o patch e garantir que esse c√≥digo chegue √† produ√ß√£o. <br><br><img src="https://habrastorage.org/webt/7v/c5/es/7vc5esvpyls4kbc-djqnyxp5owq.png" alt="imagem"><br><br>  Bem, e novamente - voc√™ pode corrigir um n√∫mero ilimitado de vezes e as compila√ß√µes com o mesmo n√∫mero de vers√£o ser√£o diferentes por um hash. <br><br>  4. Em seguida, todas as atividades s√£o transferidas para o servi√ßo de configura√ß√£o, onde na interface do usu√°rio comum voc√™ pode especificar para qual servi√ßo, em quais hosts e quais vers√µes de aplicativos voc√™ precisa corrigir. <br><br><img src="https://habrastorage.org/webt/pd/qf/um/pdqfummd7yqcqr0igjjbdshtnqk.png" alt="imagem"><br><br>  Essa abund√¢ncia de par√¢metros fornece o n√≠vel necess√°rio de flexibilidade das configura√ß√µes, o que √© muito importante em um grande zool√≥gico de muitos servidores.  Digamos que em alguma parte dos servidores o n√∫mero da vers√£o do aplicativo seja diferente e voc√™ n√£o precise corrigir esse c√≥digo.  Ou, para verifica√ß√£o, o Hot Code Rreplace √© iniciado primeiro em um servidor ou em um grupo de servidores e depois distribu√≠do por todas as inst√¢ncias do aplicativo. <br><br>  5. Por meio de uma altera√ß√£o na configura√ß√£o, os servi√ßos selecionados recebem informa√ß√µes sobre o que o patch precisa ser instalado, sua vers√£o e hash de verifica√ß√£o.  A id√©ia √© que todos os servi√ßos recebam o comando "instalar o patch" e, em seguida, atuem de forma independente.  Eles comparam independentemente sua pr√≥pria vers√£o e somente se a vers√£o corresponder e o hash do patch estiver ausente ou diferente, eles baixam independentemente o conjunto do patch do reposit√≥rio.  O processo de download em si ocorre via HTTP e voc√™ pode alterar rapidamente o endere√ßo do reposit√≥rio, o n√∫mero de tentativas de download e o per√≠odo de espera entre as novas tentativas. <br><br>  6. Cada aplicativo verifica localmente o hash do conjunto e o descompacta.  Ao mesmo tempo, cada arquivo √© verificado quanto √† sua presen√ßa na matriz dentre os retornados por Instrumentation.getAllLoadedClasses (), todas as novas classes e arquivos s√£o gravados em um novo - um caminho de classe tempor√°rio, e esse caminho de classe √© adicionado via Instrumentation.appendToSystemClassLoaderSearch (), e as classes existentes s√£o lidas na mem√≥ria e passe pelo m√©todo redefineClasses. <br><br>  7. Todo o processo: a chegada de um sinal sobre a necessidade de corrigir o aplicativo, o download, a verifica√ß√£o, a descompacta√ß√£o e o aplicativo s√£o registrados em detalhes, tanto no registro geral do aplicativo quanto no pr√≥prio, para que voc√™ possa monitorar de forma r√°pida e sem gestos desnecess√°rios. <br><br>  8. Depois que o patch √© aplicado com sucesso, o processo termina alterando a vers√£o do aplicativo para o patch, adicionando uma linha especialmente composta, incluindo o hash do patch.  No caso de, para alguns hosts, a vers√£o n√£o ter sido alterada para a esperada, vamos para o registro Substituir c√≥digo quente para esse host e ver o que aconteceu l√°.  Se houver problemas de comunica√ß√£o, voc√™ poder√° repetir com seguran√ßa o comando patch e o host desejado tentar√° novamente. <br><br>  Quais poss√≠veis problemas podem impedir o aplicativo de aplicar patches?  Existem alguns deles, e entre eles a funcionalidade da classe Instrumenta√ß√£o que eu colocaria em √∫ltimo lugar.  At√© agora, o c√≥digo torto que n√£o atende √†s condi√ß√µes estritas do redefineClasses sempre foi atualizado pela JVM, sem consequ√™ncias para o aplicativo.  Ao aplicar o m√©todo redefineClasses, a JVM para completamente o aplicativo, mas esse processo leva uma fra√ß√£o de segundo.  Porque n√£o √© nada assustador. <br><br>  O momento mais arriscado √© a entrega do patch ao servidor, que foi decidido por novos treinamentos.  Mas se as retransmiss√µes n√£o ajudarem, voc√™ poder√° repetir o comando para chamar o patch e cada um dos hosts tentar√° repetir o processo, mas instale o patch apenas se necess√°rio, ou seja,  o patch n√£o foi instalado anteriormente ou se a chave de hash foi alterada. <br><br>  Outro problema em potencial √© quando a corre√ß√£o corrige um erro e adiciona um novo.  Para minimizar esse risco, primeiro carregamos o patch em um n√∫mero limitado de servidores, examinamos os logs, gr√°ficos e monitoramos o resultado.  E somente ent√£o lan√ßamos as corre√ß√µes para outros hosts. <br><br>  O que fazer com o rein√≠cio de um aplicativo ou servidor?  Isso j√° est√° incorporado √† l√≥gica de todos os aplicativos de colegas de classe: um dos primeiros em qualquer aplicativo √© o m√≥dulo HCR.  E se, durante a inicializa√ß√£o, forem observadas informa√ß√µes sobre a necessidade de corrigir o aplicativo, o patch ser√° aplicado primeiro. <br><br>  E agora um pouco sobre o que consiste o Hot Code Replace. <br><br><ol><li>  Nosso JavaAgent.  JavaAgent, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">se algu√©m se esqueceu</a> , este √© um arquivo * .jar separado, especialmente formado, que √© captado pela JVM quando o aplicativo come√ßa a usar um par√¢metro adicional, por exemplo: -javaagent: /path/to/lib/my-agent.jar Gra√ßas aos recursos adicionais do Javaagent- e √© poss√≠vel usar a m√°gica de substitui√ß√£o de c√≥digo.  √â no agente que a classe java.lang.instrument.Instrumentation est√° dispon√≠vel.  Mas eu n√£o o obstru√≠ (o agente) com c√≥digo extra, porque  A atualiza√ß√£o do agente √© uma tarefa n√£o trivial, mas simplesmente moveu a inst√¢ncia da classe Instrumentation para o campo est√°tico da classe de utilit√°rio.  Assim, todas as manipula√ß√µes podem ser iniciadas de qualquer lugar no aplicativo. </li><li>  Servi√ßo de configura√ß√£o - √© respons√°vel pela configura√ß√£o de qualquer um dos nossos aplicativos e, portanto, √© inicializado em cada aplicativo primeiro.  √â a√≠ que a principal funcionalidade do Hot Code Replace fica oculta.  Na inicializa√ß√£o do aplicativo ou ao alterar a configura√ß√£o do HCR para um aplicativo espec√≠fico, a compatibilidade da vers√£o √© verificada e todas as manipula√ß√µes acima s√£o executadas. </li><li>  TeamCity e scripts de compila√ß√£o - para criar "patches" convenientemente e salvar apenas classes e recursos modificados ou adicionados a eles. </li></ol><br>  Quais s√£o as vantagens que temos dessa ferramenta?  A primeira √© a velocidade de corre√ß√£o de erros cr√≠ticos no produto.  Pelos registros, vejo que os colegas come√ßaram gradualmente a usar o HCR com mais e mais frequ√™ncia, em vez de esperar por libera√ß√µes.  Em seguida √© a velocidade da aplica√ß√£o.  O aplicativo n√£o precisa ser parado, a JVM congela apenas por uma fra√ß√£o de segundo e todos os seus objetos permanecem em seus lugares e continuam a funcionar. <br><br>  E nossos desenvolvedores se curaram de maneira livre e feliz e corrigiram seus erros de forma imediata e independente diretamente na produ√ß√£o, sem levar em considera√ß√£o o n√∫mero de servidores e a carga. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt429040/">https://habr.com/ru/post/pt429040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt429030/index.html">Logomachine cria logotipos gratuitos por coment√°rio</a></li>
<li><a href="../pt429032/index.html">Splunk Essentials para o aplicativo do setor de servi√ßos financeiros ou como o Splunk entra no mercado de an√°lise financeira</a></li>
<li><a href="../pt429034/index.html">Algumas hist√≥rias sobre programadores underground</a></li>
<li><a href="../pt429036/index.html">Confie em mim, eu sei o que estou fazendo: auto-adapta√ß√£o de um rob√¥ modular ao ambiente de execu√ß√£o de tarefas</a></li>
<li><a href="../pt429038/index.html">Rust News # 2 (outubro de 2018)</a></li>
<li><a href="../pt429042/index.html">Estamos testando o SharxBase, uma plataforma de virtualiza√ß√£o de software e hardware do fornecedor russo SharxDC</a></li>
<li><a href="../pt429044/index.html">As a√ß√µes da Apple sofreram a pior queda desde 2014. Grandes investidores perderam bilh√µes</a></li>
<li><a href="../pt429046/index.html">Quatro anos de desenvolvimento do SObjectizer-5.5. Como o SObjectizer mudou durante esse per√≠odo?</a></li>
<li><a href="../pt429048/index.html">Dicas para um hoster iniciante</a></li>
<li><a href="../pt429050/index.html">Ataque de troca de criptomoeda Gate.io registrado</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>