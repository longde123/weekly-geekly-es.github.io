<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üó≥Ô∏è üôçüèΩ üíº Como trabalhar com o Postgres in Go: pr√°ticas, recursos, nuances üèÄ „äôÔ∏è üéÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O comportamento inesperado do aplicativo em rela√ß√£o ao trabalho com o banco de dados leva a uma guerra entre o DBA e os desenvolvedores: DBA grita: "S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como trabalhar com o Postgres in Go: pr√°ticas, recursos, nuances</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/461935/"><p><img src="https://habrastorage.org/webt/yg/8e/hm/yg8ehmpmicsm7ye6fwju6kwog14.png"></p><br><p>  O comportamento inesperado do aplicativo em rela√ß√£o ao trabalho com o banco de dados leva a uma guerra entre o DBA e os desenvolvedores: DBA grita: "Seu aplicativo descarta o banco de dados", os desenvolvedores - "Mas tudo funcionou antes!"  O pior de tudo √© que o DBA e os desenvolvedores n√£o podem ajudar um ao outro: alguns n√£o sabem as nuances do aplicativo e do driver, outros n√£o sabem os recursos relacionados √† infraestrutura.  Seria bom evitar tal situa√ß√£o. </p><br><p>  Voc√™ precisa entender, geralmente n√£o √© suficiente procurar no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">go-database-sql.org</a> .  √â melhor se armar com a experi√™ncia de outras pessoas.  Ainda melhor se for uma experi√™ncia adquirida com sangue e dinheiro perdido. </p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Uojy57I-xP0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Meu nome √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ryabinkov Artemy</a> e este artigo √© uma interpreta√ß√£o gratuita do meu relat√≥rio da confer√™ncia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Saints HighLoad 2019</a> . </p><br><h1 id="instrumenty">  As ferramentas </h1><br><p>  Voc√™ pode encontrar as informa√ß√µes m√≠nimas necess√°rias sobre como trabalhar com o Go com qualquer banco de dados semelhante ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SQL</a> em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">go-database-sql.org</a> .  Se voc√™ ainda n√£o leu, leia. </p><br><h2 id="sqlx">  sqlx </h2><br><p>  Na minha opini√£o, o poder do Go √© a simplicidade.  E isso √© expresso, por exemplo, no fato de que o Go costuma escrever consultas em SQL puro (o ORM n√£o √© uma honra).  Isso √© uma vantagem e uma fonte de dificuldades adicionais. </p><br><p> Portanto, usando o pacote padr√£o de <code>database/sql</code> idioma <code>database/sql</code> , voc√™ desejar√° expandir suas interfaces.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Quando</a> isso acontecer, d√™ uma olhada em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/jmoiron/sqlx</a> .  Deixe-me mostrar alguns exemplos de como essa extens√£o pode simplificar sua vida. </p><br><p>  O uso do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StructScan</a> elimina a necessidade de mudar manualmente os dados das colunas para as propriedades da estrutura. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Place <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Country <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> City sql.NullString TelephoneCode <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`db:"telcode"`</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p Place err = rows.StructScan(&amp;p)</code> </pre> <br><p>  O uso do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NamedQuery</a> permite usar propriedades da estrutura como espa√ßos reservados em uma consulta. </p><br><pre> <code class="go hljs">p := Place{Country: <span class="hljs-string"><span class="hljs-string">"South Africa"</span></span>} sql := <span class="hljs-string"><span class="hljs-string">`.. WHERE country=:country`</span></span> rows, err := db.NamedQuery(sql, p)</code> </pre> <br><p>  O uso de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Get</a> and <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Select</a> permite que voc√™ se livre da necessidade de gravar manualmente loops que obt√™m linhas do banco de dados. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p Place <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pp []Place <span class="hljs-comment"><span class="hljs-comment">// Get   p     err = db.Get(&amp;p, ".. LIMIT 1") // Select   pp   . err = db.Select(&amp;pp, ".. WHERE telcode &gt; ?", 50)</span></span></code> </pre> <br><h1 id="drayvery">  Drivers </h1><br><p>  <code>database/sql</code> √© um conjunto de interfaces para trabalhar com o banco de dados e <code>sqlx</code> √© sua extens√£o.  Para que essas interfaces funcionem, elas precisam de uma implementa√ß√£o.  Os drivers s√£o respons√°veis ‚Äã‚Äãpela implementa√ß√£o. </p><br><p>  Drivers mais populares: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/lib/pq</a> - <code>pure Go Postgres driver for database/sql.</code>  Esse driver permaneceu por muito tempo o padr√£o padr√£o.  Hoje, por√©m, perdeu sua relev√¢ncia e n√£o est√° sendo desenvolvida pelo autor. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/jackc/pgx</a> - <code>PostgreSQL driver and toolkit for Go.</code>  Hoje √© melhor escolher essa ferramenta. </li></ul><br><p>  <strong>github.com/jackc/pgx</strong> - este √© o driver que voc√™ deseja usar.  Porque </p><br><ul><li>  Ativamente <strong>apoiado e desenvolvido</strong> . </li><li>  Pode ser mais <strong>produtivo</strong> se usado sem interfaces de <code>database/sql</code> . </li><li>  Suporte para mais de <strong>60 tipos de PostgreSQL</strong> que o <code>PostgreSQL</code> implementa fora do padr√£o <code>SQL</code> . </li><li>  A capacidade de implementar convenientemente o <strong>log</strong> do que est√° acontecendo dentro do driver. </li><li>  <code>pgx</code> <strong>erros leg√≠veis por humanos</strong> , enquanto apenas <code>lib/pq</code> lan√ßa ataques de p√¢nico.  Se voc√™ n√£o entrar em p√¢nico, o programa falhar√°.  ( <em>Voc√™ n√£o deve entrar em p√¢nico no Go, isso n√£o √© o mesmo que exce√ß√£o.</em> ) </li><li>  Com o <code>pgx</code> , temos a capacidade de <strong>configurar</strong> independentemente <strong>cada conex√£o</strong> . </li><li>  H√° suporte <strong>para o protocolo de replica√ß√£o l√≥gica do</strong> <code>PostgreSQL</code> . </li></ul><br><h2 id="4kb">  4KB </h2><br><p>  Normalmente, escrevemos esse loop para obter dados do banco de dados: </p><br><pre> <code class="go hljs">rows, err := s.db.QueryContext(ctx, sql) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() { err = rows.Scan(...) }</code> </pre> <br><p>  Dentro do driver, obtemos dados armazenando-os em <strong>um buffer de 4KB</strong> .  <code>rows.Next()</code> gera uma viagem de rede e preenche o buffer.  Se o buffer n√£o for suficiente, vamos √† rede para os dados restantes.  Mais visitas √† rede - menos velocidade de processamento.  Por outro lado, como o limite do buffer √© de 4KB, n√£o vamos esquecer toda a mem√≥ria do processo. </p><br><p>  Mas, √© claro, quero desaparafusar o volume do buffer ao m√°ximo para reduzir o n√∫mero de solicita√ß√µes √† rede e reduzir a lat√™ncia do nosso servi√ßo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Adicionamos</a> essa oportunidade e tentamos descobrir a acelera√ß√£o esperada em <a href="">testes sint√©ticos</a> : </p><br><pre> <code class="bash hljs">$ go <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -v -run=XXX -bench=. -benchmem goos: linux goarch: amd64 pkg: github.com/furdarius/pgxexperiments/bufsize BenchmarkBufferSize/4KB 5 315763978 ns/op 53112832 B/op 12967 allocs/op BenchmarkBufferSize/8KB 5 300140961 ns/op 53082521 B/op 6479 allocs/op BenchmarkBufferSize/16KB 5 298477972 ns/op 52910489 B/op 3229 allocs/op BenchmarkBufferSize/1MB 5 299602670 ns/op 52848230 B/op 50 allocs/op PASS ok github.com/furdarius/pgxexperiments/bufsize 10.964s</code> </pre> <br><p>  Pode-se ver que n√£o h√° grande diferen√ßa na velocidade de processamento.  Porque </p><br><p>  Acontece que estamos limitados pelo tamanho do buffer para enviar dados dentro do pr√≥prio Postgres.  Este buffer tem um tamanho <a href="">fixo</a> de 8 <strong>KB</strong> .  Usando <code>strace</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">voc√™ pode ver</a> que o sistema operacional retorna <code>8192</code> bytes na chamada de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">leitura do</a> sistema.  E o <code>tcpdump</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">confirma</a> isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">com o</a> tamanho dos pacotes. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tom Lane</a> ( <em>um dos principais desenvolvedores do kernel do Postgres</em> ) <a href="">comenta</a> assim: </p><br><blockquote>  Tradicionalmente, pelo menos, esse era o tamanho dos buffers de tubo nas m√°quinas Unix, portanto, em princ√≠pio, esse √© o tamanho de bloco mais ideal para enviar dados atrav√©s de um soquete Unix. </blockquote><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Andres Freund</a> ( <em>desenvolvedor do Postgres do EnterpriseDB</em> ) <a href="">acredita</a> que um buffer de 8 KB n√£o √© a melhor op√ß√£o de implementa√ß√£o at√© o momento, e voc√™ precisa testar o comportamento em tamanhos diferentes e com uma configura√ß√£o de soquete diferente. </p><br><p>  Tamb√©m devemos lembrar que o PgBouncer tamb√©m possui um buffer e seu tamanho pode ser configurado com o par√¢metro <code>pkt_buf</code> . </p><br><h2 id="oids">  OIDs </h2><br><p>  Outro recurso do driver pgx ( <em>v3</em> ): para cada conex√£o, ele faz um pedido ao banco de dados para obter informa√ß√µes sobre o <strong>ID</strong> do <strong>Objeto</strong> ( <em>OID</em> ). </p><br><p>  Esses identificadores foram adicionados ao Postgres para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">identificar exclusivamente</a> objetos internos: linhas, tabelas, fun√ß√µes, etc. </p><br><p>  O driver usa o conhecimento de <code>OIDs</code> para entender qual coluna do banco de dados em qual idioma primitivo adicionar dados.  Para isso, o <code>pgx</code> suporta essa tabela (a <em>chave √© o nome do tipo, o valor √© ID do objeto</em> ) </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]Value{ <span class="hljs-string"><span class="hljs-string">"_aclitem"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"_bool"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"_int4"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"_int8"</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span>, ... }</code> </pre> <br><p>  Essa implementa√ß√£o leva ao fato de que o driver para cada conex√£o estabelecida com o banco de dados faz cerca de tr√™s solicita√ß√µes para formar uma tabela com um <code>Object ID</code> .  No modo normal de opera√ß√£o do banco de dados e do aplicativo, o conjunto de conex√µes no Go permite que voc√™ n√£o gere novas conex√µes com o banco de dados.  Por√©m, com a menor degrada√ß√£o do banco de dados, o conjunto de conex√µes no lado do aplicativo se esgota e o n√∫mero de conex√µes geradas por unidade de tempo aumenta significativamente.  As solicita√ß√µes de <code>OIDs</code> bastante pesadas; como resultado, o driver pode levar o banco de dados a um estado cr√≠tico. </p><br><p>  Aqui √© o momento em que essas solicita√ß√µes foram despejadas em um de nossos bancos de dados: </p><br><p><img src="https://habrastorage.org/webt/lm/ra/vb/lmravbubtqb2ah8dvbvvpklbz8m.png"></p><br><p>  <strong>15 transa√ß√µes por minuto</strong> no modo normal, um salto de at√© <strong>6500 transa√ß√µes</strong> durante a degrada√ß√£o. </p><br><p>  <strong>O que fazer</strong> </p><br><p>  Em primeiro lugar, limite o tamanho da sua piscina de cima. </p><br><p>  Para <code>database/sql</code> isso pode ser feito com a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DB.SetMaxOpenConns</a> .  Se voc√™ abandonar as interfaces de <code>database/sql</code> e usar <code>pgx.ConnPool</code> (o <em>conjunto de conex√µes implementado pelo pr√≥prio driver</em> ), poder√° especificar <code>MaxConnections</code> (o <em>padr√£o √© 5</em> ). </p><br><p>  A prop√≥sito, ao usar o <code>pgx.ConnPool</code> driver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reutilizar√° as</a> informa√ß√µes sobre os <code>OIDs</code> recebidos e n√£o far√° consultas ao banco de dados para cada nova conex√£o. </p><br><p>  Se voc√™ n√£o quiser recusar o <code>database/sql</code> , poder√° armazenar em cache as informa√ß√µes sobre os <code>OIDs</code> . </p><br><pre> <code class="go hljs">github.com/jackc/pgx/stdlib.OpenDB(pgx.ConnConfig{ CustomConnInfo: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(c *pgx.Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*pgtype.ConnInfo, error)</span></span></span></span> { cachedOids = <span class="hljs-comment"><span class="hljs-comment">//  OIDs   . info := pgtype.NewConnInfo() info.InitializeDataTypes(cachedOids) return info, nil } })</span></span></code> </pre> <br><p>  Este √© um m√©todo de trabalho, mas us√°-lo pode ser perigoso sob duas condi√ß√µes: </p><br><ul><li>  voc√™ usa tipos de enumera√ß√£o ou dom√≠nio no Postgres; </li><li>  se o assistente falhar, voc√™ alterna o aplicativo para a r√©plica, que √© derramada pela replica√ß√£o l√≥gica. </li></ul><br><p>  O cumprimento dessas condi√ß√µes leva ao fato de que os <code>OIDs</code> armazenados em cache se tornam inv√°lidos.  Mas n√£o conseguiremos limp√°-los, porque n√£o sabemos o momento de mudar para uma nova base. </p><br><p>  No mundo do <code>Postgres</code> , a replica√ß√£o f√≠sica geralmente √© usada para organizar a alta disponibilidade, que copia as inst√¢ncias do banco de dados pouco a pouco; portanto, problemas com o cache do <code>OIDs</code> raramente <code>OIDs</code> vistos na natureza.  ( <em>Mas √© melhor verificar com seu DBA como a espera funciona para voc√™</em> ). </p><br><p>  Na pr√≥xima vers√£o principal do driver <code>pgx</code> - <code>v4</code> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√£o haver√°</a> campanhas para <code>OIDs</code> .  Agora, o driver depender√° apenas da lista de <code>OIDs</code> no c√≥digo.  Para tipos personalizados, voc√™ precisar√° assumir o controle da desserializa√ß√£o no lado do aplicativo: o driver simplesmente abrir√° um peda√ßo de mem√≥ria como uma matriz de bytes. </p><br><h1 id="logirovanie-i-monitoring">  Registro e Monitoramento </h1><br><p>  O monitoramento e o registro ajudar√£o a detectar problemas antes que a base falhe. </p><br><p>  <code>database/sql</code> fornece o m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DB.Stats ()</a> .  O instant√¢neo de status retornado fornecer√° uma id√©ia do que est√° acontecendo dentro do driver. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> DBStats <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { MaxOpenConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-comment"><span class="hljs-comment">// Pool State OpenConnections int InUse int Idle int // Counters WaitCount int64 WaitDuration time.Duration MaxIdleClosed int64 MaxLifetimeClosed int64 }</span></span></code> </pre> <br><p>  Se voc√™ usar o pool no <code>pgx</code> diretamente, o m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ConnPool.Stat ()</a> fornecer√° informa√ß√µes semelhantes: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ConnPoolStat <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { MaxConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CurrentConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> AvailableConnections <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> }</code> </pre> <br><p>  O registro √© igualmente importante e o <code>pgx</code> permite que voc√™ fa√ßa isso.  O driver aceita a interface do <code>Logger</code> , implementando qual, voc√™ obt√©m todos os eventos que ocorrem dentro do driver. </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Logger <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Log a message at the given level with data key/value pairs. // data may be nil. Log(level LogLevel, msg string, data map[string]interface{}) }</span></span></code> </pre> <br><p>  Provavelmente, voc√™ nem precisa implementar essa interface.  No <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pgx pronto para uso</a> , h√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conjunto de adaptadores</a> para os registradores mais populares, por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uber-go / zap</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sirupsen / logrus</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rs / zerolog</a> . </p><br><h1 id="infrastruktura">  A infraestrutura </h1><br><p>  Quase sempre, ao trabalhar com o <code>Postgres</code> voc√™ usar√° o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pool de</a> <strong>conex√µes</strong> , e ser√° o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PgBouncer</a> ( <em>ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">odiss√©ia</a> - se voc√™ √© Yandex</em> ). </p><br><p>  Por isso, voc√™ pode ler o excelente artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">brandur.org/postgres-connections</a> .  Em resumo, quando o n√∫mero de clientes <strong>excede 100, a</strong> velocidade das solicita√ß√µes de processamento come√ßa a diminuir.  Isso acontece devido aos recursos da implementa√ß√£o do Postgres: o lan√ßamento de um processo separado para cada conex√£o, o mecanismo para remover instant√¢neos e o uso de mem√≥ria compartilhada para intera√ß√£o - tudo isso afeta. </p><br><p>  Aqui est√° a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">refer√™ncia de</a> v√°rias implementa√ß√µes do pool de conex√µes: <br><img src="https://habrastorage.org/webt/im/p1/-n/imp1-nuasdxn1wmve7l89rrvmbw.png"></p><br><p>  E <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compare a</a> largura de banda com e sem o PgBouncer. </p><br><p><img src="https://habrastorage.org/webt/jc/cp/21/jccp2150oefyeiixeu005lpsl_0.png"></p><br><p>  Como resultado, sua infraestrutura ficar√° assim: </p><br><p><img src="https://habrastorage.org/webt/bf/ee/ok/bfeeokt_cdojbuddo7_rhzddjis.png"></p><br><p>  Onde <code>Server</code> √© o processo que processa solicita√ß√µes do usu√°rio.  Esse processo gira em <code>kubernetes</code> em 3 c√≥pias ( <em>pelo menos</em> ).  Separadamente, em um servidor de ferro, existe o <code>Postgres</code> , coberto pelo <code>PgBouncer'</code> .  <code>PgBouncer</code> pr√≥prio <code>PgBouncer</code> de thread √∫nico, ent√£o lan√ßamos v√°rios bouncers, cujo tr√°fego √© equilibrado usando o <code>HAProxy</code> .  Como resultado, obtemos uma cadeia de execu√ß√£o de consulta no banco de dados: <code>   ‚Üí HAProxy ‚Üí PgBouncer ‚Üí Postgres</code> . </p><br><p>  <code>PgBouncer</code> pode funcionar em tr√™s modos: </p><br><ul><li>  <strong>Pool de sess√µes</strong> - para cada sess√£o, uma conex√£o √© emitida e atribu√≠da a ela por todo o tempo de vida. </li><li>  <strong>Pool de transa√ß√µes</strong> - a conex√£o permanece enquanto a transa√ß√£o est√° em execu√ß√£o.  Assim que a transa√ß√£o √© conclu√≠da, o <code>PgBouncer</code> pega essa conex√£o e a devolve para outra transa√ß√£o.  Este modo permite uma disposi√ß√£o muito boa de compostos. </li><li>  <strong>Conjunto de instru√ß√µes</strong> - modo <strong>descontinuado</strong> .  Foi criado apenas para dar suporte ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PL / Proxy</a> . </li></ul><br><p>  Voc√™ pode ver a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">matriz</a> de quais propriedades est√£o dispon√≠veis em cada modo.  Escolhemos o <strong>Pool de Transa√ß√µes</strong> , mas ele tem limita√ß√µes para trabalhar com <code>Prepared Statements</code> . </p><br><h2 id="transaction-pooling--prepared-statements">  Pool de Transa√ß√µes + Instru√ß√µes Preparadas </h2><br><p>  Vamos imaginar que queremos preparar uma solicita√ß√£o e execut√°-la.  Em algum momento, iniciamos uma transa√ß√£o na qual enviamos uma solicita√ß√£o de Prepara√ß√£o e obtemos o ID da solicita√ß√£o preparada no banco de dados. </p><br><p><img src="https://habrastorage.org/webt/pb/tu/bq/pbtubqa7cvmly0ntnhs0dwc9etc.png"></p><br><p>  Depois, em qualquer outro momento, geramos outra transa√ß√£o.  Nele, nos voltamos para o banco de dados e queremos atender √† solicita√ß√£o usando o identificador com os par√¢metros especificados. </p><br><p><img src="https://habrastorage.org/webt/uy/ci/h4/uycih4iuh8aasw43aqodbsxolac.png"></p><br><p>  No modo <strong>Pool de Transa√ß√µes</strong> , duas transa√ß√µes podem ser executadas em conex√µes diferentes, mas o <strong>ID</strong> da <strong>Instru√ß√£o √©</strong> v√°lido apenas dentro de uma conex√£o.  Recebemos uma <code>prepared statement does not exist</code> erro ao tentar executar uma solicita√ß√£o. </p><br><p>  O mais desagrad√°vel: como durante o desenvolvimento e o teste a carga √© pequena, o <code>PgBouncer</code> geralmente emite a mesma conex√£o e tudo funciona corretamente.  Mas assim que lan√ßamos o produto, as solicita√ß√µes come√ßam a cair com um erro. </p><br><p>  Agora encontre <code>Prepared Statements</code> neste c√≥digo: </p><br><pre> <code class="go hljs">sql := <span class="hljs-string"><span class="hljs-string">`select * from places where city = ?`</span></span> rows, err := s.db.Query(sql, city)</code> </pre> <br><p>  Voc√™ n√£o o ver√°!  A prepara√ß√£o da consulta ocorrer√° implicitamente dentro de <code>Query()</code> .  Ao mesmo tempo, a prepara√ß√£o e a execu√ß√£o da solicita√ß√£o ocorrer√£o em diferentes transa√ß√µes e receberemos totalmente tudo o que descrevi acima. </p><br><p>  <strong>O que fazer</strong> </p><br><p>  A primeira op√ß√£o mais f√°cil √© <strong>alternar o <code>PgBouncer</code> para o <code>Session pooling</code></strong> .  Uma conex√£o √© alocada para a sess√£o, todas as transa√ß√µes come√ßam a ocorrer nessa conex√£o e as solicita√ß√µes preparadas funcionam corretamente.  Mas, nesse modo, a efici√™ncia da utiliza√ß√£o de compostos deixa muito a desejar.  Portanto, esta op√ß√£o n√£o √© considerada. </p><br><p>  A segunda op√ß√£o √© <strong>preparar uma solicita√ß√£o no lado do cliente</strong> .  N√£o quero fazer isso por dois motivos: </p><br><ul><li>  Potenciais vulnerabilidades SQL.  O desenvolvedor pode esquecer ou fazer incorretamente escapar. </li><li>  Escapar dos par√¢metros da consulta toda vez que voc√™ precisar escrever com as m√£os. </li></ul><br><p>  Outra op√ß√£o √© <strong>agrupar explicitamente cada solicita√ß√£o em uma transa√ß√£o</strong> .  Afinal, enquanto a transa√ß√£o <code>PgBouncer</code> , o <code>PgBouncer</code> n√£o <code>PgBouncer</code> a conex√£o.  Isso funciona, mas, al√©m da verbosidade em nosso c√≥digo, tamb√©m recebemos mais chamadas de rede: Iniciar, Preparar, Executar, Confirmar.  Total de 4 chamadas de rede por solicita√ß√£o.  Lat√™ncia est√° crescendo. </p><br><p>  Mas eu quero isso com seguran√ßa, conveni√™ncia e efici√™ncia.  E existe essa op√ß√£o!  Voc√™ pode dizer explicitamente ao driver que deseja <strong>usar o modo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Consulta Simples</a></strong> .  Nesse modo, n√£o haver√° prepara√ß√£o e toda a solicita√ß√£o passar√° em uma chamada de rede.  Nesse caso, o driver far√° a blindagem de cada um dos par√¢metros em si (as <em><code>standard_conforming_strings</code> devem ser ativadas no n√≠vel base ou ao estabelecer uma conex√£o</em> ). </p><br><pre> <code class="go hljs">cfg := pgx.ConnConfig{ ... RuntimeParams: <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ <span class="hljs-string"><span class="hljs-string">"standard_conforming_strings"</span></span>: <span class="hljs-string"><span class="hljs-string">"on"</span></span>, }, PreferSimpleProtocol: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }</code> </pre> <br><h1 id="otmena-zaprosov">  Cancelar solicita√ß√µes </h1><br><p>  Os seguintes problemas est√£o relacionados ao cancelamento de solicita√ß√µes no lado do aplicativo. </p><br><p>  D√™ uma olhada neste c√≥digo.  Onde est√£o as armadilhas? </p><br><pre> <code class="go hljs">rows, err := s.db.QueryContext(ctx, ...)</code> </pre> <br><p>  Go possui um m√©todo para controlar o fluxo de execu√ß√£o do programa - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">context.Context</a> .  Nesse c√≥digo, passamos o <code>ctx</code> driver para que, quando o contexto for fechado, o driver cancele a solicita√ß√£o no n√≠vel do banco de dados. </p><br><p>  Ao mesmo tempo, espera-se que economizemos recursos, cancelando solicita√ß√µes pelas quais ningu√©m est√° esperando.  Por√©m, ao cancelar uma solicita√ß√£o, o <code>PgBouncer</code> vers√£o <em>1.7</em> envia informa√ß√µes para a conex√£o de que essa conex√£o est√° pronta para uso e depois a retorna para o pool.  Esse comportamento do <code>PgBouncer'</code> est√° enganando o driver, que, ao enviar a pr√≥xima solicita√ß√£o, recebe instantaneamente o <code>ReadyForQuery</code> em resposta.  No final, detectamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">erros inesperados do ReadyForQuery</a> . </p><br><p>  Come√ßando com o <code>PgBouncer</code> vers√£o <em>1.8,</em> esse comportamento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">foi corrigido</a> .  Use a vers√£o atual do <code>PgBouncer</code> . </p><br><p>  E, embora, neste caso, os erros desapare√ßam - um comportamento interessante permanecer√°.  Em alguns casos, nosso aplicativo pode receber respostas n√£o √† sua solicita√ß√£o, mas √† vizinha (a principal √© que as solicita√ß√µes correspondam ao tipo e ordem dos dados solicitados).  Isso √©, por exemplo, para a consulta em <code>where user_id = 2</code> , a resposta da consulta em <code>where user_id = 42</code> ser√° retornada.  Isso ocorre devido ao processamento de solicita√ß√µes de cancelamento em diferentes n√≠veis: no n√≠vel do pool de drivers e do bouncer. </p><br><h3 id="otlozhennaya-otmena">  Cancelamento atrasado </h3><br><p>  Para cancelar a solicita√ß√£o, precisamos criar uma nova conex√£o com o banco de dados e solicitar um cancelamento.  <code>Postgres</code> cria um processo separado para cada conex√£o.  Enviamos um comando para cancelar a solicita√ß√£o <strong>atual</strong> em um processo espec√≠fico.  Para isso, crie uma nova conex√£o e transfira a identifica√ß√£o do processo (PID) de seu interesse.  Mas enquanto o comando de cancelamento voa para a base, a solicita√ß√£o cancelada pode terminar sozinha. </p><br><p><img src="https://habrastorage.org/webt/us/xf/v_/usxfv_i0ze_axpmjtlir183reiu.png"></p><br><p>  <code>Postgres</code> executar√° o comando e cancelar√° a solicita√ß√£o <strong>atual</strong> no processo especificado.  Mas a solicita√ß√£o atual n√£o ser√° a que queremos cancelar inicialmente.  Devido a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esse comportamento</a> ao trabalhar com o <code>Postgres</code> com o <code>PgBouncer</code> mais seguro n√£o cancelar a solicita√ß√£o no n√≠vel do driver.  Para fazer isso, voc√™ pode definir a <code>CustomCancel</code> , que n√£o cancelar√° a solicita√ß√£o, mesmo que <code>context.Context</code> usado. </p><br><pre> <code class="go hljs">cfg := pgx.ConnConfig{ ... CustomCancel: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_ *pgx.Conn)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }, }</code> </pre> <br><h1 id="cheklist-po-rabote-s-postgres">  Lista de verifica√ß√£o do Postgres </h1><br><p>  Em vez de conclus√µes, decidi fazer uma lista de verifica√ß√£o para trabalhar com o Postgres.  Isso deve ajudar o artigo a se encaixar na minha cabe√ßa. </p><br><ul><li>  Use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/jackc/pgx</a> como um driver para trabalhar com o Postgres. </li><li>  Limite o tamanho do pool de conex√µes de cima. </li><li>  Fa√ßa cache de <code>OIDs</code> ou use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pgx.ConnPool</a> se estiver trabalhando com a vers√£o 3 do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pgx</a> . </li><li>  Colete m√©tricas do pool de conex√µes usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DB.Stats ()</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ConnPool.Stat ()</a> . </li><li>  Registre o que est√° acontecendo no driver. </li><li>  Use o modo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Consulta Simples</a> para evitar problemas com a prepara√ß√£o de consultas no modo transacional <code>PgBouncer</code> . </li><li>  Atualize o <code>PgBouncer</code> para a vers√£o mais recente. </li><li>  Cuidado ao cancelar solicita√ß√µes do aplicativo. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461935/">https://habr.com/ru/post/pt461935/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461919/index.html">Reutilizando formul√°rios no React</a></li>
<li><a href="../pt461921/index.html">HDMI-LVDS. Desenvolvimento em TSUMV59 de MStar</a></li>
<li><a href="../pt461923/index.html">Dia Aberto do JetBrains em S√£o Petersburgo: v√≠deo</a></li>
<li><a href="../pt461927/index.html">Aprendizagem do Ranking Ativo</a></li>
<li><a href="../pt461929/index.html">Monitorando e Verificando o Status do SSD no Linux</a></li>
<li><a href="../pt461937/index.html">A lei de Parkinson e como quebr√°-la</a></li>
<li><a href="../pt461939/index.html">Ano de aventura com grafeno-python</a></li>
<li><a href="../pt461941/index.html">Massageie</a></li>
<li><a href="../pt461945/index.html">Resumo de eventos para profissionais de RH na √°rea de TI em agosto de 2019</a></li>
<li><a href="../pt461949/index.html">AppCode 2019.2: Swift 5.1, an√°lise de cobertura de c√≥digo por testes, exibi√ß√£o de c√≥digo desmontado e muito mais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>