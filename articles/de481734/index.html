<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπÔ∏è üòΩ üçá Erfahrung mit Kartendruckern, Teil 1 üë≤üèæ ‚úíÔ∏è üë©üèæ‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dieser Artikel ist hilfreich f√ºr Benutzer , die mit Kartendruckern ( Evolis Primacy und Smart-51 ) und NFC-codierten Karten wie Mifare Classic und Mif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erfahrung mit Kartendruckern, Teil 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481734/"><p>  Dieser Artikel ist hilfreich f√ºr <strong>Benutzer</strong> , die mit Kartendruckern ( <strong>Evolis Primacy</strong> und <strong>Smart-51</strong> ) und NFC-codierten Karten wie <strong>Mifare Classic</strong> und <strong>Mifare DESFire EV2 arbeiten</strong> .  Im ersten Teil beschreiben wir den allgemeinen Eindruck der Arbeit mit Kartendruckern sowie die Probleme, mit denen wir konfrontiert waren.  Im zweiten Teil sollen weitere praktische Teile gezeigt werden: Code, Bedienungstipps. </p><br><h3 id="1-kak-poyavilas-zadacha">  1. Wie ist die Aufgabe entstanden? </h3><br><p>  Wir entwickeln ein elektronisches Ticketsystem, das auch die Arbeit mit NFC-Karten umfasst.  Jede NFC-Karte hat eine benutzerfreundliche <strong>Nummer</strong> und eine individuelle <strong>ID</strong> .  <strong>Die Nummer</strong> muss auf der Karte aufgedruckt sein und die <strong>ID wird</strong> in den NFC-Chip geschrieben.  Eine der Aufgaben war es, eine stabile Produktion von Transportkarten aufzubauen. </p><br><p>  In der ersten Phase wurde das Problem auf einfachste Weise gel√∂st: Abz√ºge mit <strong>Nummern</strong> werden vom NFC-Kartenanbieter gedruckt, und Ausweise werden von uns mithilfe von Desktop-Leseger√§ten, spezieller Software und einer Person aufgezeichnet.  Nach Erhalt der Karten vom Lieferanten ist es erforderlich, die Karte im System zu registrieren und die <strong>ID</strong> und die <strong>Nummer</strong> miteinander zu verkn√ºpfen.  Als Desktop-Reader verwendeten wir den Z-2 Reader [1]. </p><br><p>  Der Prozess sah ungef√§hr so ‚Äã‚Äãaus: </p><br><ul><li>  Der Bediener nimmt eine Karte auf.  Die Kartennummer ist bereits auf der Karte aufgedruckt, die Registrierung der Karte im System und die Aufzeichnung der <strong>ID</strong> im NFC-Chip sind jedoch erforderlich </li><li>  Der Bediener legt die Karte in den Z-2-Leser ein und registriert die <strong>Nummer</strong> im elektronischen Ticketsystem, indem er die Kartennummer manuell <strong>eingibt</strong> .  Zur B√ºndelung und Registrierung wird ein HTTPS-API-Aufruf durchgef√ºhrt </li><li>  Der Bediener nimmt die n√§chste Karte und macht es erneut. </li></ul><br><p>  Eine einfache und schnelle L√∂sung mit einem <em>kleinen</em> Nachteil.  Der Einfluss des menschlichen Faktors erzeugt Phantomkarten, bei denen die auf der Karte aufgedruckte <strong>Nummer</strong> nicht der Link- <strong>ID-</strong> <strong>Nummer</strong> in der Systemdatenbank entspricht. </p><a name="habracut"></a><br><p>  So entstand die folgende Aussage zum Problem: Es ist erforderlich, die <strong>Nummer</strong> auszudrucken, die <strong>ID</strong> aufzuschreiben und die NFC-Karten <strong>atomar</strong> und mit minimalem menschlichem <strong>Aufwand</strong> im System zu registrieren. </p><br><p>  In diesem Artikel beschreiben wir alle Ger√§te, mit denen wir gearbeitet haben, und alle Fallstricke.  Am Ende werden wir versuchen zu sagen, welche Ausr√ºstung uns besser erscheint. </p><br><h3 id="11-nfc-karty">  1.1.  NFC-Karten </h3><br><p>  Wir haben die NFC-Karten MIFARE Classic 1K und MIFARE DESFire EV2 getestet.  MIFARE Classic ist am h√§ufigsten und am anf√§lligsten f√ºr Kopien.  Sie sind jedoch weiterhin beliebt an Orten wie Universit√§ten und √∂ffentlichen Verkehrsmitteln.  Bei der Abwicklung von Cashflows ist eine zuverl√§ssigere L√∂sung erforderlich.  Daher wurden MIFARE DESFire EV2-Karten zu einer Alternative.  Dies ist einer der letzten Kartentypen, die DES-, TDES- (2KTDES-, 3KTDES-) und AES-Verschl√ºsselungsalgorithmen verwenden [2, 3].  Kurz zu jeder Karte: </p><br><p>  <em>MIFARE Classic</em> </p><br><p>  Die Speicherkarte ist ein Sektor und blockiert.  Die erste Speichereinheit ist ein Sektor.  Auf der Karte befinden sich 16 Sektoren mit jeweils 4 Datenbl√∂cken.  Der Speicher jedes Blocks betr√§gt 16 Bytes.  Um Daten lesen und / oder schreiben zu k√∂nnen, muss sich der Leser am Sektor anmelden.  Ein spezieller Block in jedem Sektor, der Trailer-Block, dient zum Speichern von Schl√ºsseln.  Um mit dem Sektor arbeiten zu k√∂nnen, m√ºssen Sie sich zun√§chst beim Trailer-Block anmelden.  Der Trailer-Block speichert auch 16 Bytes: 6 Bytes pro Schl√ºsseltyp A, 4 Bytes pro Zugriffsrechte, 6 Bytes pro Schl√ºsseltyp B. </p><br><p>  Abbildung 1 [4] zeigt deutlich die Sektoren, Bl√∂cke und Schl√ºssel. </p><br><br><p><img src="https://habrastorage.org/webt/lj/mr/as/ljmrasis1ncssiee0chfn8ougie.png"><br>  Abbildung 1 - Speicherger√§t in Mifare Classic </p><br><p>  <em>MIFARE DESFire</em> </p><br><p>  Das Kartenger√§t √§hnelt einem Dateisystem.  Die Karte besteht aus Anwendungen und Dateien.  Auf der Karte befindet sich eine Hauptanwendung (application) mit der ID - 000000 (0x00, 0x00, 0x00).  Innerhalb der Hauptanwendung k√∂nnen Sie eine neue Anwendung erstellen und darin Datendateien erstellen. <br>  Die Eigenschaften von DESFire-Karten sind in Abbildung 2 [5] dargestellt.  Jeder Anwendung werden eigene Zugriffsschl√ºssel f√ºr die Anwendungsdateien zugewiesen. </p><br><p><img src="https://habrastorage.org/webt/6q/xc/6f/6qxc6fkpk9i2jjpocy9v6iwgf0c.png"><br>  Abbildung 2 - Eigenschaften von Mifare DESFire-Karten </p><br><h3 id="12-printery-kak-reshenie">  1.2.  Drucker als L√∂sung </h3><br><p>  Um diese Aufgabe zu erf√ºllen, werden spezielle Kartendrucker verwendet.  Gegenw√§rtig gibt es viele verschiedene Unternehmen, die diese Drucker anbieten.  Zum Beispiel: Evolis, Smart, Zebra, Datacard usw. Wir haben die <strong>Drucker Evolis Primacy</strong> und <strong>Smart-51</strong> verwendet.  Diese Drucker haben im Kern des Auftrags viele Gemeinsamkeiten: Sie verwenden beide Bandkassetten zum Drucken und haben ein √§hnliches Reinigungsprinzip.  Es gibt auch Unterschiede - verschiedene NFC-Encoder.  Beide Drucker k√∂nnen je nach Kundenwunsch erg√§nzt oder ausgetauscht werden. </p><br><p>  Programmierer f√ºr NFC-Karten st√ºtzen sich auf die Standards ISO / IEC 14443A und ISO / IEC 7816-4 f√ºr DESFire, ISO / IEC 14443 Typ A f√ºr Classic.  Abh√§ngig vom Hersteller k√∂nnen die Programmierer jedoch entweder native Befehle gem√§√ü Standards akzeptieren oder die nativen Befehle spezifisch f√ºr einen bestimmten Programmierer umbrechen.  Wir sind mit dem einen und dem anderen konfrontiert. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Evolis-Primat </th><th>  Smart-51 </th></tr></thead><tbody><tr><td>  Drucken </td><td>  Das Band wird zum Drucken verwendet (Farbe oder Schwarzwei√ü).  Eine ganze Bandkassette wird mitgeliefert. </td><td>  Das Band wird zum Drucken verwendet (Farbe oder Schwarzwei√ü).  Es wird nur Klebeband mitgeliefert, eine Kassette und der Drucker selbst mitgeliefert.  Eine Reinigungsrolle liegt dem Klebeband bei. </td></tr><tr><td>  Encoder </td><td>  Elyctis Encoder.  Einfach zu bedienen, weil  unterst√ºtzt die Interaktion mit Standard-Windows-Bibliotheken f√ºr die Kommunikation mit NFC-Karten, Winscard. </td><td>  DUALi-Encoder.  Der technische Support bietet ein spezielles SDK f√ºr die Arbeit mit dem Encoder. </td></tr><tr><td>  Reinigung </td><td>  Damit der Drucker in einwandfreiem Zustand bleibt, muss er st√§ndig gereinigt werden.  Es gibt zwei Arten der Reinigung: periodisch (nach jeweils 1000 Karten) und verl√§ngert (nach 5000 Karten).  Die Einhaltung des Reinigungsplans ist Voraussetzung in der Garantievereinbarung. </td><td>  Nach Verwendung des bedruckten Farbbands ist eine Reinigung erforderlich.  Abh√§ngig von der Art des Klebebands und der Gr√∂√üe des zu druckenden Bildes ist nach 2-4.000 Karten eine Reinigung erforderlich. </td></tr><tr><td>  Wohnen </td><td>  Durch das Kunststoffgeh√§use ist der Drucker sehr leicht.  Die Innenr√§ume sind leicht zu erreichen, da sich die W√§nde des Druckers nach beiden Seiten √∂ffnen. </td><td>  Das Metallgeh√§use macht den Drucker betriebssicher.  Einige Eingeweide sind nur sichtbar, wenn die obere Abdeckung ge√∂ffnet wird. </td></tr><tr><td>  Software </td><td>  Kommt mit spezieller Software ‚ÄûEvolis Print Center‚Äú und CardPresso.  Die erste wird f√ºr Druckereinstellungen ben√∂tigt, die mit verschiedenen Hilfsprogrammen ausgestattet sind.  Mit der zweiten Software k√∂nnen Sie die Funktionen des Druckers zum Drucken und Codieren schnell testen. </td><td>  Eine separate Software zur Steuerung des Druckers ist nicht erforderlich.  Gen√ºgend Druckereigenschaften in der Liste der Windows-Ger√§te.  Kommt mit SmartID-Software zum Drucken und Codieren. </td></tr></tbody></table></div><br>  Tabelle 1 - Vergleich von Evolis Primacy und Smart-51 <br><h3 id="2-eksperimenty">  2. Experimente </h3><br><p>  Im Allgemeinen kann die Arbeit mit Druckern in mehrere Teile unterteilt werden: Kommunikation mit dem technischen Support, Untersuchung des Zusammenspiels von Karten und Codierern, Drucken. </p><br><h3 id="21-vpechatlenie-ot-tehnicheskoy-podderzhki">  2.1.  Eindruck des technischen Supports </h3><br><p>  Die Arbeit mit Druckern beinhaltete die st√§ndige Kommunikation mit dem technischen Support, da wir unsere eigene Software schreiben mussten.  In beiden F√§llen haben wir mehr mit Distributoren von Unternehmen in unserem Land und den Nachbarl√§ndern gesprochen. </p><br><p>  Die Evolis-H√§ndler waren gr√∂√ütenteils immer in Kontakt.  Die Besonderheiten der Themen zeigten jedoch fast sofort, dass eine Kommunikation mit Vertretern von Evolis erforderlich ist.  Leider gaben sie uns ihre Kontakte nicht bekannt und mussten Nachrichten √ºber einen Distributor austauschen.  Dies betraf jedoch nur Druckausgaben, bei Codierungsfragen erhielten wir die E-Mail eines Elyctis-Vertreters.  Die direkte Kommunikation mit Elyctis hat den Kodierungsprozess erheblich vereinfacht.  Rein technisch haben wir uns sofort verstanden und es gab kein Missverst√§ndnis.  Bei Druck- und Codebeispielen f√ºr Evolis Primacy kam die Kommunikation irgendwann zum Erliegen.  Grunds√§tzlich war der negative Eindruck von den Momenten gepr√§gt, in denen Beispiele f√ºr doppelseitiges Drucken bei uns nicht funktionierten und es lange gedauert hat, dies zu beweisen.  Ich kam zu den Aufzeichnungen der Druckvorg√§nge auf Video, woraufhin weitere produktive Tipps von Evolis folgten. </p><br><p>  Eine der neuesten Fragen des technischen Supports von Evolis war der Anschluss des Druckers √ºber Ethernet.  Momentan verbinden wir den Drucker √ºber USB mit dem Laptop, was bei 1-2 Druckern tolerierbar ist.  Die Antworten warten noch.  Elyctis hat jedoch bereits geantwortet, dass sein Encoder f√ºr den Evolis Primacy-Drucker keine Netzwerkverbindung bietet. </p><br><p>  Bei der Kommunikation mit dem technischen Support von Smart-51 ging es auch darum, √ºber einen Distributor mit Unternehmensvertretern zu kommunizieren.  Am Anfang lief alles reibungslos.  Beim Codieren von Karten wie Mifare DESFire traten Probleme auf.  Probleme wurden durch bestimmte Teams verursacht, die Sie im Internet nicht finden werden.  Aus diesem Grund mussten Sie nur einige Teile aus dem vom Hersteller als Beispiel bereitgestellten Arbeitscode kopieren.  Das gedankenlose Kopieren f√ºhrt jedoch nicht zum Guten.  Infolgedessen wurden zwei Wochen damit verbracht, den Fehler dem Hersteller zu erkl√§ren, auf dessen Seite der Mann deutlich sa√ü, nicht sehr nah an den Komplikationen des Systems, aber die allgemeinen Unterlagen bei sich zu haben.  Es blieb ein unangenehmer Niederschlag zur√ºck, der jedoch sehr gut begann. </p><br><p>  Die Kommunikation √ºber einen Distributor hat keine Pluspunkte, feste Minuspunkte.  Zum Beispiel: </p><br><ol><li>  Versp√§tete Antworten, da die verantwortliche Person auf der Seite des H√§ndlers m√∂glicherweise mit anderen Dingen besch√§ftigt ist oder in den Urlaub f√§hrt. </li><li>  Wenn sich der H√§ndler in einem anderen Land befindet, handelt es sich um zus√§tzliche Feiertage, also nicht um Arbeitstage.  Im Fall von Smart-51 fand die Kommunikation unter Beteiligung von Personen aus 3 L√§ndern statt. </li><li>  Antworten werden nicht weitergeleitet.  Der Antworttext wird vom Verteiler in einen neuen Brief eingef√ºgt.  Aus diesem Grund gehen manchmal angeh√§ngte Dateien verloren und erreichen nicht sofort. </li><li>  Es gibt keine klare Gewissheit, dass Ihre Nachricht den Hersteller unver√§ndert erreicht hat. </li></ol><br><p>  Unten finden Sie eine Tabelle mit der Anzahl der Buchstaben, aus denen die Kommunikation mit dem technischen Support besteht.  Grunds√§tzlich waren die Fragen f√ºr Evolis und Smart ungef√§hr gleich.  Beispiel: "Warum wird keine einheitliche Farbe gedruckt? Haben Sie Codebeispiele in C # oder Java?"  und spezifischere Fragen, warum etwas nicht wie erwartet funktioniert. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Evolis </th><th>  Elyctis </th><th>  Smart-51 </th></tr></thead><tbody><tr><td>  Anzahl der Buchstaben </td><td>  97 </td><td>  37 </td><td>  61 </td></tr></tbody></table></div><br>  Tabelle 2 - Vergleich der Anzahl der E-Mails mit dem technischen Support <br><h3 id="22-kodirovka">  2.2.  Kodierung </h3><br><p>  Die Kommunikation mit dem Leseger√§t erfolgt √ºber APDU-Befehle.  APDU (Application Protocol Data Unit) ist ein Standardformat f√ºr die Kommunikation zwischen einer Karte und einem Leseger√§t.  In diesem Artikel werden die grundlegenden APDU-Teams f√ºr MIFARE Classic und MIFARE DESFire beschrieben. </p><br><div class="scrollable-table"><table><thead><tr><th>  Titel </th><th>  Gr√∂√üe </th><th>  Beschreibung </th></tr></thead><tbody><tr><td>  CLA </td><td>  1 Byte </td><td>  Klassenbytes </td></tr><tr><td>  Ins </td><td>  1 Byte </td><td>  Anweisungsbyte </td></tr><tr><td>  P1 </td><td>  1 Byte </td><td>  Parameter 1 </td></tr><tr><td>  P2 </td><td>  1 Byte </td><td>  Parameter 2 </td></tr><tr><td>  Datenl√§nge </td><td>  1 Byte </td><td>  Gr√∂√üe der √ºbertragenen Daten </td></tr><tr><td>  Daten </td><td>  ... </td><td>  √úbertragene Daten </td></tr><tr><td>  Erwartete Datenl√§nge </td><td>  1 Byte </td><td>  Die Gr√∂√üe der erwarteten Daten in der Antwort </td></tr></tbody></table></div><br>  Tabelle 3 - Format der APDU-Befehle <br><div class="scrollable-table"><table><thead><tr><th>  Titel </th><th>  Gr√∂√üe </th><th>  Beschreibung </th></tr></thead><tbody><tr><td>  SW1 </td><td>  1 Byte </td><td>  H√§ufiger Erfolgs- oder Fehlercode </td></tr><tr><td>  SW2 </td><td>  1 Byte </td><td>  Detaillierter Fehlercode </td></tr><tr><td>  Daten </td><td>  ... </td><td>  Daten zur√ºckgeben </td></tr></tbody></table></div><br>  Tabelle 4 - APDU-Antwortformat <br><p>  Eine Beschreibung aller m√∂glichen Antwortcodes finden Sie hier [6].  Ein Ger√§t zur Kommunikation von Karten mit einem Leseger√§t ist unter [7] zu finden. </p><br><p>  Ein kurzer Kodierungsalgorithmus lautet wie folgt: </p><br><ol><li>  Holen Sie sich die UID der Karte.  Dies ist eine eindeutige Nummer, die vom Lieferanten geflasht wird und sich nicht √§ndert. </li><li>  Daten aus jedem Sektor lesen: <br>  2.1 Melden Sie sich mit dem Standardschl√ºssel (0x00 oder 0xFF) beim Sektor an. <br>  2.2 Daten aus drei Datenbl√∂cken lesen </li><li>  Wenn die gelesenen Daten leer sind, gehen Sie zum Datensatz <br>  3.1 Melden Sie sich mit dem Standardschl√ºssel (0x00 oder 0xFF) beim Sektor an. <br>  3.2 Daten in drei Sektordatenbl√∂cke schreiben <br>  3.3 Erstellen Sie einen neuen Schl√ºssel basierend auf der UID der Karte <br>  3.4 Ersetzen Sie den Autorisierungsschl√ºssel im Trailer-Block durch einen neuen Schl√ºssel. </li></ol><br><h3 id="221-elyctis">  2.2.1.  Elyctis </h3><br><p>  Der Evolis-Drucker verwendet ein <strong>ELYCTIS CL-Leseger√§t</strong> .  Mit der <strong>WinSCard-</strong> Bibliothek (C ++ und C #) und jnasmartcardio (Java) k√∂nnen Sie problemlos mit dem Reader interagieren.  Um schnell Software mit einer relativ einfachen Oberfl√§che zu erstellen, wurde beschlossen, Code in <strong>C #</strong> zu schreiben.  Meistens schreibt unser Team Code in Java, was den √úbergang zu C # weniger schmerzhaft machte.  Ebenfalls f√ºr C # sprach die Tatsache, dass Windows besser f√ºr die Arbeit mit Druckern geeignet ist. </p><br><p>  Die folgende Tabelle enth√§lt Beispiele f√ºr native APDU-Befehle, die vom Elyctis-Reader akzeptiert werden. </p><br><div class="scrollable-table"><table><thead><tr><th>  Beschreibung </th><th>  Daten </th><th>  APDU </th></tr></thead><tbody><tr><td>  Beziehen einer UID-Karte </td><td>  - </td><td>  <strong>0xFF 0xCA 0x00 0x00 0x00</strong> </td></tr><tr><td>  Laden des Autorisierungsschl√ºssels in den Leserspeicher </td><td>  6-Byte-Schl√ºssel </td><td>  Ein Beispiel f√ºr das Laden eines Standardschl√ºssels.  <strong>0xFF 0x82 0x20 0x00 0x06 0x00 0x00 0x00 0x00 0x00 0x00 0x00</strong> </td></tr><tr><td>  Einloggen </td><td>  Sektorautorisierungsblocknummer (3. Sektorblock) und Schl√ºsseltyp (A - 0x60 oder B - 0x61) </td><td>  Ein Beispiel f√ºr die Autorisierung von Sektor 1. Die Blocknummern dieses Sektors sind 4-7, der Trailer-Block ist Nummer 7. <strong>0xFF 0x86 0x00 0x00 0X05 0x01 0x00 0x07 0X60 0x00 0x00</strong> </td></tr><tr><td>  Daten aus einem Block lesen </td><td>  - </td><td>  Ein Beispiel f√ºr das Lesen von Daten aus Block 4 (1. Block von Sektor 1).  Die Sektornummer wird in Parameter 2 eingetragen. 0xFF 0xB0 0x00 0x04 0x00 0x10 </td></tr><tr><td>  Daten in den Block schreiben </td><td>  16 Datenbytes </td><td>  Ein Beispiel f√ºr das Schreiben von Daten in Block 4. <strong>0xFF 0xD6 0x00 0x04 0x10 0x11 0x22 0x33 0x44 0x55 0x66 0x77 0x88 0x11 0x22 0x33 0x44 0x55 0x66 0x77 0x88 0x00</strong> </td></tr></tbody></table></div><br>  Tabelle 5 - Beispiele f√ºr APDU-Befehle f√ºr Mifare Classic <br><p>  Nachdem wir sichergestellt hatten, dass die Kodierung von Karten wie Mifare Classic erfolgreich war, wechselten wir zu <strong>DESFire-Befehlen</strong> .  Unter Referenz [8] finden Sie einfache Beispiele f√ºr Befehle mit Erl√§uterungen.  Bereits im Autorisierungsteam sind wir auf ein interessantes Leserverhalten gesto√üen.  Kurz gesagt, der Leser hat die vollst√§ndige Autorisierung selbst vorgenommen.  Es stellte sich heraus, dass der technische Support von Elyctis uns eine spezielle Firmware zur Verf√ºgung stellte, die <em>easyDESFire-Informationen</em> enthielt.  Es muss nur bestimmt werden, welchen Verschl√ºsselungsalgorithmus der Leser verwendet.  In unserem Fall war es 3DES. </p><br><p>  Im Normalfall erfolgt die Autorisierung durch den Austausch mehrerer Nachrichten. </p><br><ol><li>  Wir senden den APDU-Befehl zur Autorisierung: <strong>0x90 0x0A 0x00 0x00 0x00 0x00</strong> . </li><li>  Abh√§ngig vom Algorithmus reagiert ein Array von 8 zuf√§lligen Bytes, die vom Kartenschl√ºssel codiert werden, auf den Befehl, den wir mit <strong>RandBEnc bezeichnen</strong> . </li><li>  <strong>Wir entschl√ºsseln RandBEnc</strong> und verschieben das Byte nach links.  Bezeichne das Ergebnis mit <strong>RandBLeft</strong> . </li><li>  Wir erzeugen auf unserer Seite ein Array von 8 zuf√§lligen Bytes, <strong>RandA</strong> . </li><li>  <strong>Wir gruppieren RandA</strong> und <strong>RandBLeft</strong> , verschl√ºsseln mit dem Kartenschl√ºssel und senden das resultierende Array von 16 Bytes. </li><li>  Als Antwort erhalten wir den Sitzungsschl√ºssel und melden uns damit bei der Anwendung auf der Karte an. </li></ol><br><p>  Weitere Details zum Autorisierungsprozess finden Sie hier [9].  Der Code aus dem Github ist auch sehr n√ºtzlich [10]. </p><br><p>  W√§hrend der Codierung traten Probleme mit der Verwendung von Befehlen aus der Quelle auf [8].  Mithilfe des technischen Supports von Elyctis haben wir die erforderlichen Befehle erhalten, die f√ºr <em>easyDESFire Intelligence</em> geeignet <em>sind</em> . </p><br><p>  W√§hrend der Codierung auf Elyctis wurde ein gro√ües <strong>Problem des</strong> Lesers aufgedeckt - <strong>Kommunikationsverz√∂gerung</strong> .  Sehr oft erreichen die Signale den Leser nicht, so dass derselbe Befehl manchmal mehrmals gesendet werden muss.  Dieses Verhalten ist weniger verbreitet, wird jedoch weiterhin beim Senden von Befehlen zum Drucken bemerkt.  Das Senden aller Befehle erfolgt daher in einer Schleife bis zur erfolgreichen Ausf√ºhrung. </p><br><h3 id="222-duali">  2.2.2.  DUALi </h3><br><p>  Der Hersteller gibt sein SDK an, um mit einem DUALi-Encoder zu arbeiten.  W√§hrend der Arbeit mit Mifare Classic konnten Befehle zum Lesen und Schreiben dem Vorlagencode entnommen werden, den die Distributoren uns gegeben hatten.  Beispiele waren in C ++, Visual Basic, Java.  Der Code konnte jedoch nur in C ++ vollst√§ndig kompiliert werden.  Die erste Anfrage nach einem C # -Codebeispiel wurde uns verweigert, bzw. der Distributor hat keine.  Wir haben keine zuverl√§ssigen C ++ - Programmierer in unserem Team, daher war das Schreiben des gesamten Codes durch recht einfache Dinge sehr kompliziert.  Zum Beispiel: </p><br><ol><li>  Arbeite mit Arrays <br>  Bei der √úbergabe eines Arrays als Parameter an eine Funktion wurde die Gr√∂√üe des Arrays nicht √ºbergeben.  Um die L√§nge des Arrays zu bestimmen, wurde die Funktion sizeOf () verwendet.  Die Funktion gab jedoch unabh√§ngig von der tats√§chlichen Gr√∂√üe des Arrays konstant eine Gr√∂√üe von 4 zur√ºck.  Dieses Verhalten wurde nicht sofort aufgezeichnet, da einige Arrays tats√§chlich eine Gr√∂√üe von 4 hatten. </li><li>  Konfigurieren Sie alle Bibliotheken <br>  Bei der Installation aller erforderlichen Umgebungen wurden gro√üe Schmerzen festgestellt.  Wir sind zu sehr an Dinge wie maven und apt (auf Ubuntu) gew√∂hnt.  Unser Programm sollte die Backend-API √ºber HTTP-Anfragen aufrufen und die Daten in Base64 verschl√ºsseln.  Zu diesem Zweck wurde entschieden, die Bibliotheken libcurl und openssl zu verwenden.  Das Schreiben des Programms selbst erfolgte in der Microsoft Visual Studio-Umgebung.  L√§ngster Aufwand bei der Installation von libcurl. </li></ol><br><p>  Das SDK selbst ist eine in C ++ geschriebene DLL-Bibliothek.  Dank des Codebeispiels haben wir relativ schnell ein Programm f√ºr die Interaktion mit der Mifare Classic-Karte geschrieben.  Wie bereits erw√§hnt, waren die APDU-Befehle f√ºr DUALi sehr spezifisch: Die ersten beiden Bytes stimmten nicht mit den im Internet verf√ºgbaren √ºberein.  Aus diesem Grund musste ich sie blind kopieren, da im Prinzip alles wie erwartet funktioniert.  Probleme beginnen mit Tests mit DESFire-Karten. </p><br><p>  Das Prinzip der APDU-Befehle f√ºr <strong>DESFire</strong> in DUALi ist zumindest verst√§ndlich.  Es gibt zwei Bytes f√ºr <strong>{CLA, INS}</strong> , sie √§ndern sich nicht und sie sagen, dass der Befehl f√ºr Karten wie DESFire bestimmt ist.  Parameter 1 und 2 √§ndern sich ebenfalls nicht.  Die √ºbertragenen Daten enthalten bereits einen Teil des nativen DESFire-Befehls, n√§mlich die Bytes <strong>{INS, Data}</strong> .  Ungef√§hr eine Woche lang konnten wir nicht die erwarteten Antworten auf einfache Befehle erhalten, z. B. den Befehl "Anwendung ausw√§hlen".  Ganz am Anfang des Codes haben wir die APDU-Ausf√ºhrung des Befehls GetCardStatus verlassen, der kein Befehlsformat f√ºr DESFire war.  Sie arbeitete jedoch und stellte UID-Karten aus.  Wie sich herausstellte, arbeiteten DESFire-Teams nach der Ausf√ºhrung von GetCardStatus nicht mehr.  Dieses Vers√§umnis wurde von unseren Kr√§ften nach einem einw√∂chigen Dialog mit dem Lieferanten festgestellt, der zu nichts f√ºhrte. </p><br><p>  Nach einem Monat stabilen Betriebs unseres Programms mussten wir das Programm in C # umschreiben.  Der Hauptgrund war die Gr√ºndung von CI.  Das C ++ - Programm wurde mit Microsoft Visual Studio kompiliert.  Alle unsere Server laufen unter Linux, daher war es nicht m√∂glich, den Docker mit Windows und dem erforderlichen Visual Studio ToolKit zu starten.  Nat√ºrlich k√∂nnen Sie eine virtuelle Maschine mit Windows erstellen und trotzdem alles f√ºr C ++ konfigurieren, aber das wollte ich nicht.  Nachdem wir wiederholt einen Beispiel-C # -Code vom Hersteller angefordert hatten, wurde uns ein Beispiel zur Verf√ºgung gestellt.     ,         C++,       .           C#   CI. </p><br><h3 id="23-pechat">  2.3.  Drucken </h3><br><p>    ,      , . .       .       ,    ,            . </p><br><p>       .       ,       ,   . </p><br><h3 id="231-pechat-na-evolis-primacy">  2.3.1.   Evolis Primacy </h3><br><p>     JSON ,   HTTP .    Evolis Services Provider,          .      8 : </p><br><ol><li>      </li><li>   </li><li>   :  ,   ,  . . </li><li>    </li><li>     </li><li>    </li><li>   </li><li>    </li></ol><br><p>     -  4-6, . .               .      .         SDK,       .     . <br>      : </p><br><ol><li>   <br>       . </li><li>   <br>      . </li></ol><br><p>                    .          ,      .           .    ,   .          .         .      ,   ,         ,  3. </p><br><img src="https://habrastorage.org/webt/pa/4_/i8/pa4_i8xhdbhicczzxejgvzayzne.jpeg" alt="drawing" width="300"><br><p>  3 ‚Äî    </p><br><p>     3         . </p><br><p>             , . .    QR-.      ,        QR-  .     ,     ,  4  6 . </p><br><p>   , Evolis ,   Evolis Print Center,     ,    ,              .            . </p><br><h3 id="232-pechat-na-smart-51">  2.3.2.   Smart-51 </h3><br><p>     ,     SmartID,     .      ,      Evolis.        : </p><br><ol><li>   ,        . </li><li>     ,     . </li></ol><br><p>          ,     .       Smart-51.   : </p><br><ol><li>      </li><li>    ,  . </li><li>   </li><li>   </li><li>    ,   QR- </li><li>   </li><li>   </li><li>    </li></ol><br><p>    ,     User Manuals .      ,         ,        . </p><br><h3 id="233-obschie-problemy-s-pechatyu">  2.3.3.     </h3><br><p>    ,        .      ,      ,         .           .        .      ,    . </p><br><p>      Evolis Primacy    100 ,   0,76 .      ,  86 .   Smart-51    100 ,          .   ,      . </p><br><h3 id="3-rezultaty"> 3.  </h3><br><p>         .        .        .     17 .        . </p><br><div class="scrollable-table"><table><thead><tr><th>  </th><th>  ,  </th><th>  ,  </th><th>  Total </th></tr></thead><tbody><tr><td> Evolis Primacy </td><td> ‚âà 10 </td><td> ‚âà 10 </td><td> ‚âà 20 </td></tr><tr><td> Smart-51 </td><td> ‚âà 17 </td><td> ‚âà 6 </td><td> ‚âà 23 </td></tr></tbody></table></div><br><img src="https://habrastorage.org/webt/aa/tu/r2/aatur26peetmxaj2ynj4jxwxshm.jpeg" alt="drawing" width="400"><br><p>  a) </p><br><img src="https://habrastorage.org/webt/ll/y1/ed/lly1edhu6n42rdbybxn4-gwvniu.jpeg" alt="drawing" width="400"><br><p>  b) <br>  4 ‚Äî  :  ‚Äî  ,  ‚Äî   </p><br><h3 id="4-zaklyuchenie"> 4.  </h3><br><p>         NFC   -.      , ..      .   Smart-51   Evolis Primacy.    Evolis       ,     . Smart-51             .       Smart-51      Evolis.              ,   .  Evolis Primacy   ,     .      .  Smart-51    .   ,          . </p><br><p>       , ..         .              ,         . </p><br><h3 id="spisok-literatury">  Referenzliste </h3><br><ol><li> <a href="https://ironlogic.ru/il.nsf/htm/ru_z2usb">https://ironlogic.ru/il.nsf/htm/ru_z2usb</a> </li><li> <a href="https://www.nxp.com/products/rfid-nfc/mifare-hf/mifare-desfire/mifare-desfire-ev2:MIFARE_DESFIRE_EV2_2K_8K">https://www.nxp.com/products/rfid-nfc/mifare-hf/mifare-desfire/mifare-desfire-ev2:MIFARE_DESFIRE_EV2_2K_8K</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf">https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf">https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf</a> </li><li> <a href="https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf">https://www.nxp.com/docs/en/data-sheet/MF3DX2_MF3DHX2_SDS.pdf</a> </li><li> <a href="https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses/">https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses/</a> </li><li> Advanced Card Systems Guide <a href="http://downloads.acs.com.hk/drivers/en/API-ACR122U-2.02.pdf">http://downloads.acs.com.hk/drivers/en/API-ACR122U-2.02.pdf</a> </li><li> Mifare Desfire communication example <a href="https://ridrix.wordpress.com/2009/09/19/mifare-desfire-communication-example/">https://ridrix.wordpress.com/2009/09/19/mifare-desfire-communication-example/</a> </li><li> Mifare DESFire Data Sheet <a href="http://neteril.org/files/M075031_desfire.pdf">http://neteril.org/files/M075031_desfire.pdf</a> </li><li>   GitHub  DESFire <a href="">https://github.com/EsupPortail/esup-nfc-tag-server/blob/master/src/main/java/nfcjlib/core/DESFireEV1.java</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481734/">https://habr.com/ru/post/de481734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481716/index.html">Reaktive Programmierung, lohnt es sich, alles fallen zu lassen und dem Traum entgegen zu eilen?</a></li>
<li><a href="../de481718/index.html">11 Faktoren und Hacks im Leben, die Ihre Effektivit√§t steigern</a></li>
<li><a href="../de481726/index.html">Laravel Lokalisiertes Routing</a></li>
<li><a href="../de481728/index.html">Pry -> REPL f√ºr Ruby, das ist es wert</a></li>
<li><a href="../de481730/index.html">Habe MPow T6 geh√∂rt - gro√üartige TWS-Kopfh√∂rer mit praktischer Steuerung</a></li>
<li><a href="../de481736/index.html">Worauf kann die Wi-Fi 6-Infrastruktur aufgebaut werden?</a></li>
<li><a href="../de481738/index.html">Programmieraufgaben - Ein schlechter Weg, um die Qualifikationen von Senior-Entwicklern zu bewerten</a></li>
<li><a href="../de481740/index.html">Beeintr√§chtigt blaues Licht den menschlichen Biorhythmus?</a></li>
<li><a href="../de481742/index.html">Apple-Strategie. Betriebssystem an Hardware binden - Wettbewerbsvorteil oder -nachteil?</a></li>
<li><a href="../de481746/index.html">Einrichten der Umgebung in der CLI. WSL / Windows Terminal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>