<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ∑Ô∏è üÄÑÔ∏è üöù El marco Kernel-Bridge: Puente en anillo0 üéûÔ∏è üë®üèª‚Äç‚öïÔ∏è üë©üèª‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øAlguna vez has querido mirar bajo el cap√≥ del sistema operativo, mirar la estructura interna de sus mecanismos, girar los tornillos y ver las oportun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>El marco Kernel-Bridge: Puente en anillo0</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429198/">  ¬øAlguna vez has querido mirar bajo el cap√≥ del sistema operativo, mirar la estructura interna de sus mecanismos, girar los tornillos y ver las oportunidades que se han abierto?  Quiz√°s incluso quisieron trabajar directamente con el hardware, pero ¬øpensaron que los controladores eran ciencia espacial? <br><br>  Propongo caminar a lo largo del puente hasta el n√∫cleo y ver qu√© tan profundo es la madriguera del conejo. <br><br>  Por lo tanto, presento el marco del controlador para la pirater√≠a del kernel, escrito en C ++ 17, y dise√±ado, si es posible, para eliminar las barreras entre el kernel y el modo de usuario o para suavizar su presencia tanto como sea posible.  Y tambi√©n, un conjunto de API y contenedores de modo de usuario y kernel para un desarrollo r√°pido y conveniente en Ring0 tanto para programadores principiantes como avanzados. <br><br>  Caracter√≠sticas clave: <br><br><ul><li>  Acceso a puertos de E / S, as√≠ como reenv√≠o de instrucciones de <i>entrada</i> , <i>salida</i> , <i>cli</i> y <i>sti</i> al modo de usuario a trav√©s de IOPL </li><li>  Envolturas sobre el tweeter del sistema </li><li>  Acceda a <i>MSR</i> (registros espec√≠ficos del modelo) </li><li> Un conjunto de funciones para acceder a la memoria en modo de usuario de otros procesos y memoria del n√∫cleo </li><li>  Trabajar con memoria f√≠sica, <i>DMI / SMBIOS</i> </li><li>  Creaci√≥n de flujos nucleares y en modo usuario, entrega APC </li><li>  <i>Devoluci√≥n de</i> llamada <i>Ob ***</i> y <i>Ps *** en</i> modo de usuario y filtros del sistema de archivos </li><li>  Descargue controladores y bibliotecas de kernel sin firmar </li></ul><br>  ... y mucho m√°s <br><a name="habracut"></a><br>  Y comenzaremos cargando y conectando el marco a nuestro proyecto C ++. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><b>Github</b></a> <br><br>  Para el ensamblaje, es muy recomendable utilizar la √∫ltima versi√≥n de Visual Studio y el √∫ltimo WDK (Kit de controladores de Windows) disponible, que se puede descargar desde el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sitio web oficial de Microsoft</a> . <br><br>  Para las pruebas, el VMware Player gratuito con Windows instalado, no inferior a Windows 7, de cualquier capacidad es perfecto. <br><br>  La asamblea es trivial y no causar√° preguntas: <br><br><ol><li>  Abra <i>Kernel-Bridge.sln</i> </li><li>  Elija la profundidad de bits requerida </li><li>  Ctrl + Shift + B </li></ol><br>  Como resultado, obtenemos un controlador, una biblioteca en modo de usuario, as√≠ como archivos de utilidades relacionados ( <i>* .inf</i> para instalaci√≥n manual, <i>* .cab</i> para firmar el controlador en Microsoft Hardware Certification Publisher, etc.). <br><br>  Para instalar el controlador (si no es necesaria una firma digital para x64, el certificado EV correspondiente), debe poner el sistema en modo de prueba, ignorando la firma digital de los controladores.  Para hacer esto, ejecute la l√≠nea de comando como administrador: <br><br> <code>bcdedit.exe /set loadoptions DISABLE_INTEGRITY_CHECKS <br> bcdedit.exe /set TESTSIGNING ON <br></code> <br>  ... y reinicie la m√°quina.  Si todo se hace correctamente, aparecer√° una inscripci√≥n en la esquina inferior derecha de que Windows est√° en modo de prueba. <br><br>  La configuraci√≥n del entorno de prueba se ha completado, comencemos a usar la API en nuestro proyecto. <br><br>  El marco tiene la siguiente jerarqu√≠a: <br><br>  <i>/ Kernel-Bridge / API</i> : un conjunto de funciones para usar en controladores y m√≥dulos de <i>kernel</i> , no tiene dependencias externas y se puede usar libremente en proyectos de terceros <br>  <i>/ User-Bridge / API</i> : un conjunto de envoltorios de modo de usuario sobre el controlador y las funciones de utilidad para trabajar con archivos PE, caracteres PDB, etc. <br>  <i>/ SharedTypes /</i> - encabezados nucleares y en modo usuario que contienen los tipos comunes necesarios <br><br>  El controlador se puede cargar de dos maneras: como controlador normal y como minifiltro.  Se prefiere el segundo m√©todo, porque  da acceso a la funcionalidad avanzada de filtros y devoluciones de llamada en modo de usuario para eventos del sistema. <br><br>  Entonces, cree un proyecto de consola en C ++, conecte los archivos de encabezado necesarios y cargue el controlador: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Windows.h&gt; #include "WdkTypes.h" //    x32/x64    WDK #include "CtlTypes.h" //   IOCTL-   #include "User-Bridge.h" // API,   int main() { using namespace KbLoader; BOOL Status = KbLoadAsFilter( L"X:\\Folder\\Path\\To\\Kernel-Bridge.sys", L"260000" //       ); if (!Status) return 0; //   ! //     API ... // : KbUnload(); return 0; }</span></span></span></span></code> </pre><br>  Genial  Ahora podemos usar la API e interactuar con el n√∫cleo. <br>  Comencemos con la funcionalidad m√°s popular en el entorno de los desarrolladores de trucos: leer y escribir la memoria de otro proceso: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> Processes::MemoryManagement; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Size = <span class="hljs-number"><span class="hljs-number">64</span></span>; BYTE Buffer[Size] = {}; BOOL Status = KbReadProcessMemory( <span class="hljs-comment"><span class="hljs-comment">//  KbWriteProcessMemory,   ProcessId, 0x7FFF0000, //     ProcessId &amp;Buffer, Size );</span></span></code> </pre><br>  Nada complicado!  Bajemos un nivel: leer y escribir memoria nuclear: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> VirtualMemory; <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Size = <span class="hljs-number"><span class="hljs-number">64</span></span>; BYTE Buffer[Size]; <span class="hljs-comment"><span class="hljs-comment">//  "",  ""    , //       : BOOL Status = KbCopyMoveMemory( reinterpret_cast&lt;WdkTypes::PVOID&gt;(Buffer), //  0xFFFFF80000C00000, //  Size, FALSE //  ,     );</span></span></code> </pre><br>  ¬øQu√© pasa con las funciones para interactuar con el hierro?  Por ejemplo, puertos de E / S. <br><br>  Los reenviaremos al modo de usuario seleccionando 2 bits IOPL en el registro EFlags, que son responsables del nivel de privilegio en el que est√°n disponibles las instrucciones de <i>entrada</i> / <i>salida</i> / <i>cli</i> / <i>sti</i> . <br><br>  Por lo tanto, podremos ejecutarlos en modo de usuario sin el error de instrucci√≥n privilegiada: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;intrin.h&gt; using namespace IO::Iopl; //  ,   ! KbRaiseIopl(); //  in/out/cli/sti   ! ULONG Frequency = 1000; // 1 kHz ULONG Divider = 1193182 / Frequency; __outbyte(0x43, 0xB6); //     //      : __outbyte(0x42, static_cast&lt;unsigned char&gt;(Divider)); __outbyte(0x42, static_cast&lt;unsigned char&gt;(Divider &gt;&gt; 8)); __outbyte(0x61, __inbyte(0x61) | 3); //   (   ) for (int i = 0; i &lt; 5000; i++); //   Sleep(),  IOPL      ! __outbyte(0x61, __inbyte(0x61) &amp; 252); //   KbResetIopl();</span></span></span></span></code> </pre><br>  ¬øPero qu√© hay de la verdadera libertad?  Despu√©s de todo, a menudo se desea ejecutar c√≥digo arbitrario con privilegios de kernel.  Escribimos todo el c√≥digo del n√∫cleo en el modo de usuario y le transferimos el control desde el n√∫cleo (SMEP se apaga autom√°ticamente, antes de llamar al controlador, guarda el contexto de la FPU y la llamada en s√≠ se realiza dentro de un bloque <i>try..except</i> ): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> KernelShells; <span class="hljs-comment"><span class="hljs-comment">//    KeStallExecutionProcessor: ULONG Result = 1337; KbExecuteShellCode( []( _GetKernelProcAddress GetKernelProcAddress, PVOID Argument ) -&gt; ULONG { //      Ring0 //     : using _KeStallExecutionProcessor = VOID(WINAPI*)(ULONG Microseconds); auto Stall = reinterpret_cast&lt;_KeStallExecutionProcessor&gt;( GetKernelProcAddress(L"KeStallExecutionProcessor") ); Stall(1000 * 1000); //      ULONG Value = *static_cast&lt;PULONG&gt;(Argument); return Value == 1337 ? 0x1EE7C0DE : 0; }, &amp;Result, // Argument &amp;Result // Result ); //   Result = 0x1EE7C0DE</span></span></code> </pre><br>  Pero adem√°s de mimar con shells, tambi√©n existe una funcionalidad seria que le permite crear DLP simples basados ‚Äã‚Äãen el subsistema de filtros de archivos, objetos y procesos. <br><br>  El marco permite filtrar <i>CreateFile</i> / <i>ReadFile</i> / <i>WriteFile</i> / <i>DeviceIoControl</i> , as√≠ como eventos de apertura / duplicaci√≥n de controladores ( <i>ObRegisterCallbacks</i> ) y eventos de procesos / subprocesos de inicio y carga de m√≥dulos ( <i>PsSet *** NotifyRoutine</i> ).  Esto permitir√°, por ejemplo, bloquear el acceso a archivos arbitrarios o reemplazar informaci√≥n sobre los n√∫meros de serie del disco duro. <br><br>  Principio de funcionamiento: <br><br><ol><li>  El controlador registra filtros de archivos e instala las devoluciones de llamada <i>Ob ***</i> / <i>Ps ***</i> </li><li>  El controlador abre un puerto de <i>comunicaci√≥n</i> al que se conectan los clientes que desean suscribirse a un evento </li><li>  Las aplicaciones en modo de usuario se conectan al puerto y reciben datos del controlador sobre el evento que ocurri√≥, realizan el filtrado (trunca los identificadores en los derechos, bloquean el acceso al archivo, etc.) y devuelven el evento al n√∫cleo </li><li>  El conductor aplica los cambios recibidos. </li></ol><br>  Un ejemplo de suscribirse a <i>ObRegisterCallbacks</i> y cortar el acceso al proceso actual: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Windows.h&gt; #include &lt;fltUser.h&gt; #include "CommPort.h" #include "WdkTypes.h" #include "FltTypes.h" #include "Flt-Bridge.h" ... //   ObRegisterCallbacks: CommPortListener&lt;KB_FLT_OB_CALLBACK_INFO, KbObCallbacks&gt; ObCallbacks; //        PROCESS_VM_READ: Status = ObCallbacks.Subscribe([]( CommPort&amp; Port, MessagePacket&lt;KB_FLT_OB_CALLBACK_INFO&gt;&amp; Message ) -&gt; VOID { auto Data = static_cast&lt;PKB_FLT_OB_CALLBACK_INFO&gt;(Message.GetData()); if (Data-&gt;Target.ProcessId == GetCurrentProcessId()) { Data-&gt;CreateResultAccess &amp;= ~PROCESS_VM_READ; Data-&gt;DuplicateResultAccess &amp;= ~PROCESS_VM_READ; } ReplyPacket&lt;KB_FLT_OB_CALLBACK_INFO&gt; Reply(Message, ERROR_SUCCESS, *Data); Port.Reply(Reply); //   });</span></span></span></span></code> </pre><br>  Entonces, revisamos brevemente los puntos principales de la parte del marco del modo de usuario, pero la API central permaneci√≥ detr√°s de escena. <br><br>  Todas las API y contenedores est√°n ubicados en la carpeta correspondiente: <i>/ Kernel-Bridge / API /</i> <br>  Incluyen trabajar con memoria, con procesos, con cadenas y bloqueos, y mucho m√°s, simplificando en gran medida el desarrollo de sus propios controladores.  Las API y los contenedores dependen solo de ellos mismos y no dependen del entorno externo: puede usarlos libremente en su propio controlador. <br><br>  Un ejemplo de trabajo con cadenas en el n√∫cleo es un obst√°culo para todos los principiantes: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;wdm.h&gt; #include &lt;ntstrsafe.h&gt; #include &lt;stdarg.h&gt; #include "StringsAPI.h" WideString wString = L"Some string"; AnsiString aString = wString.GetAnsi().GetLowerCase() + " and another string!"; if (aString.Matches("*another*")) DbgPrint("%s\r\n", aString.GetData());</span></span></span></span></code> </pre><br>  Si desea implementar su propio controlador para su c√≥digo IOCTL, puede hacerlo f√°cilmente de acuerdo con el siguiente esquema: <br><br><ol><li>  Escriba un controlador en <i>/Kernel-Bridge/Kernel-Bridge/IOCTLHandlers.cpp</i> </li><li>  En el mismo archivo, agregue un controlador al final de la matriz de controladores en la funci√≥n <i>DispatchIOCTL</i> </li><li>  Agregue el √≠ndice de consulta a la <i>enumeraci√≥n Ctls :: KbCtlIndices</i> en <i>CtlTypes.h</i> en la MISMA POSICI√ìN que en la matriz de <i>Controladores</i> en el elemento 2 </li><li>  Llame a su controlador desde el modo de usuario escribiendo un contenedor en <i>User-Bridge.cpp</i> , haciendo una llamada usando la funci√≥n <i>KbSendRequest</i> </li></ol><br>  Los tres tipos de E / S son compatibles (METHOD_BUFFERED, METHOD_NEITHER y METHOD_IN_DIRECT / METHOD_OUT_DIRECT), de forma predeterminada, se utiliza METHOD_NEITHER. <br><br>  Eso es todo!  El art√≠culo cubre solo una peque√±a fracci√≥n de todas las posibilidades.  Espero que el marco sea √∫til para desarrolladores novatos de componentes del kernel, ingenieros inversos, desarrolladores de trampas, anti-trampas y protecciones. <br><br>  Y tambi√©n, todos est√°n invitados a participar en el desarrollo.  En los planes futuros: <br><br><ul><li>  Contenedores para la manipulaci√≥n directa de registros PTE y reenv√≠o de memoria nuclear al modo de usuario </li><li>  Inyectores basados ‚Äã‚Äãen las caracter√≠sticas existentes de creaci√≥n y entrega de flujo APC </li><li>  Plataforma GUI para ingenier√≠a inversa en vivo e investigaci√≥n de kernel de Windows </li><li>  Motor de secuencias de comandos para ejecutar fragmentos de c√≥digo del n√∫cleo </li><li>  Soporte para SEH en m√≥dulos cargados din√°micamente </li><li>  Pasando las pruebas HLK </li></ul><br>  Gracias por su atencion! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es429198/">https://habr.com/ru/post/es429198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es429188/index.html">Descripci√≥n general de PICASO 3D Designer XL</a></li>
<li><a href="../es429190/index.html">Fabricando su propio implante para electr√≥nica</a></li>
<li><a href="../es429192/index.html">Estos nuevos trucos a√∫n son capaces de burlar a los videos de Deepfake.</a></li>
<li><a href="../es429194/index.html">7 bibliotecas para el desarrollo de Android en Kotlin</a></li>
<li><a href="../es429196/index.html">Exploraci√≥n m√≥vil iOS en tiempo de ejecuci√≥n con objeci√≥n, o piratear nuestra propia aplicaci√≥n</a></li>
<li><a href="../es429202/index.html">Cursos caros: ¬øvale la pena?</a></li>
<li><a href="../es429204/index.html">Los conceptos err√≥neos m√°s importantes sobre el desarrollo del juego.</a></li>
<li><a href="../es429210/index.html">Dura realidad: sus partes interesadas no quieren un an√°lisis comercial</a></li>
<li><a href="../es429212/index.html">Microsoft ha confirmado la presencia de problemas (masivos) con la activaci√≥n de Windows 10</a></li>
<li><a href="../es429214/index.html">Caracter√≠sticas de Middleware y Pipeline en Laravel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>