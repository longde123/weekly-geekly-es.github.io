<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèº üêä üé≤ Comment ne pas casser le cluster Apache Ignite d√®s le d√©but üó£Ô∏è üì° üíú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut Vous trouverez ci-dessous une transcription de la vid√©o du discours prononc√© lors du rassemblement communautaire Apache Ignite √† Saint-P√©tersbou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment ne pas casser le cluster Apache Ignite d√®s le d√©but</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/gridgain/blog/415973/"><p>  Salut  Vous trouverez ci-dessous une transcription de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o du</a> discours prononc√© lors du rassemblement communautaire Apache Ignite √† Saint-P√©tersbourg le 20 juin.  Vous pouvez t√©l√©charger les diapositives <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zrMWgNyvQVI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Il existe toute une classe de probl√®mes auxquels les utilisateurs novices sont confront√©s.  Ils viennent de t√©l√©charger Apache Ignite, ex√©cutent les deux, trois, dix premi√®res fois et nous posent des questions qui sont r√©solues de la m√™me mani√®re.  Par cons√©quent, je propose de cr√©er une liste de contr√¥le qui vous fera gagner beaucoup de temps et de nerfs lorsque vous ferez vos premi√®res applications Apache Ignite.  Nous parlerons des pr√©paratifs de lancement;  comment assembler le cluster;  comment d√©marrer certains calculs dans la grille de calcul;  Comment pr√©parer un mod√®le de donn√©es et un code afin que vous puissiez √©crire vos donn√©es dans Ignite, puis les lire avec succ√®s.  Et le plus important: comment ne rien casser d√®s le d√©but. </p><a name="habracut"></a><br><h2>  Pr√©paration au lancement - configurer la journalisation </h2><br><p>  Nous avons besoin de journaux.  Si vous avez d√©j√† pos√© une question sur la liste de diffusion Apache Ignite ou sur StackOverflow, comme "pourquoi tout a-t-il raccroch√©", la premi√®re chose qu'on vous a demand√© d'envoyer √©tait probablement tous les journaux de tous les n≈ìuds. </p><br><p> Naturellement, la journalisation Apache Ignite est activ√©e par d√©faut.  Mais il y a des nuances.  Tout d'abord, Apache Ignite √©crit un peu en <code>stdout</code> .  Par d√©faut, il d√©marre en mode dit silencieux.  Dans <code>stdout</code> vous ne verrez que les erreurs les plus terribles, et tout le reste sera enregistr√© dans un fichier, le chemin vers lequel Apache Ignite s'affiche au tout d√©but (par d√©faut - <code>${IGNITE_HOME}/work/log</code> ).  Vous ne l'effacez pas et conservez les journaux plus longtemps, cela peut √™tre tr√®s utile. </p><br><p>  <b><code>stdout</code> s'enflammer au d√©marrage par d√©faut</b> </p><br><p><img src="https://habrastorage.org/webt/dg/wf/4r/dgwf4rf9on5vckayvxqzcbtr5tk.png"></p><br><p>  Pour faciliter la d√©couverte des probl√®mes sans entrer dans des fichiers s√©par√©s et configurer une surveillance s√©par√©e pour Apache Ignite, vous pouvez l'ex√©cuter en mode verbeux avec la commande </p><br><pre> <code class="bash hljs">ignite.sh -v</code> </pre> <br><p>  puis le syst√®me commencera √† √©crire sur tous les √©v√©nements dans <code>stdout</code> avec le reste de la journalisation de l'application. </p><br><p>  V√©rifiez les journaux!  Tr√®s souvent, vous pouvez trouver des solutions √† vos probl√®mes.  Si le cluster s'est effondr√©, tr√®s souvent dans le journal, vous pouvez voir des messages comme ¬´Augmenter tel ou tel d√©lai dans telle ou telle configuration.  Nous sommes tomb√©s √† cause de lui.  Il est trop petit.  Le r√©seau n'est pas assez bon. ¬ª </p><br><h2>  Assemblage de cluster </h2><br><h3>  Invit√©s non invit√©s </h3><br><p>  Le premier probl√®me auquel beaucoup sont confront√©s est les invit√©s non invit√©s dans votre cluster.  Ou vous vous trouvez vous-m√™me √™tre un invit√© non invit√©: d√©marrez un nouveau cluster et soudain, vous voyez que dans le premier instantan√© de topologie au lieu d'un n≈ìud, vous avez deux serveurs d√®s le d√©but.  Comment √ßa?  Vous n'en avez lanc√© qu'un. </p><br><p>  <b>Un message indiquant que le cluster a deux n≈ìuds</b> </p><br><p><img src="https://habrastorage.org/webt/l9/fd/kd/l9fdkdt9vvoaryo1fk84agizhvi.png"></p><br><p>  Le fait est que par d√©faut Apache Ignite utilise la multidiffusion et au d√©marrage, il recherchera tous les autres Apache Ignite qui se trouvent dans le m√™me sous-r√©seau, dans le m√™me groupe de multidiffusion.  Et si c'est le cas, il essaiera de se connecter.  Et en cas d'√©chec de la connexion, il ne d√©marrera pas du tout.  Par cons√©quent, dans le cluster sur mon ordinateur portable de travail, des n≈ìuds suppl√©mentaires du cluster sur l'ordinateur portable du coll√®gue apparaissent r√©guli√®rement, ce qui bien s√ªr n'est pas tr√®s pratique. </p><br><p>  Comment vous en prot√©ger?  La fa√ßon la plus simple de configurer une adresse IP statique.  Au lieu de <code>TcpDiscoveryMulticastIpFinder</code> , qui est utilis√© par d√©faut, il y a <code>TcpDiscoveryVmIpFinder</code> .  L√†, notez toutes les adresses IP et les ports auxquels vous vous connectez.  C'est beaucoup plus pratique et vous prot√©gera d'un grand nombre de probl√®mes, en particulier dans les environnements de d√©veloppement et de test. </p><br><h3>  Trop d'adresses </h3><br><p>  Le prochain probl√®me.  Vous avez d√©sactiv√© la multidiffusion, d√©marrez le cluster, dans une seule configuration, vous d√©finissez une quantit√© d√©cente d'IP √† partir d'environnements diff√©rents.  Et il arrive que vous lanciez le premier n≈ìud dans un nouveau cluster pendant 5 √† 10 minutes, bien que tous les suivants s'y connectent en 5 √† 10 secondes. </p><br><p>  Prenez une liste de trois adresses IP.  Pour chacun, nous prescrivons des plages de 10 ports.  Au total, 30 adresses TCP sont obtenues.  √âtant donn√© qu'Apache Ignite doit tenter de se connecter √† un cluster existant avant de cr√©er un nouveau cluster, il v√©rifiera chaque IP tour √† tour.  Cela peut ne pas blesser votre ordinateur portable, mais la protection de num√©risation de port est souvent incluse dans certains environnements nuageux.  Autrement dit, lorsque vous acc√©dez √† un port priv√© sur une adresse IP, vous ne recevrez aucune r√©ponse tant que le d√©lai d'expiration n'est pas √©coul√©.  Par d√©faut, c'est 10 secondes.  Et si vous avez 3 adresses de 10 ports, vous obtenez 3 * 10 * 10 = 300 secondes d'attente - ces m√™mes 5 minutes pour vous connecter. </p><br><p>  La solution est √©vidente: n'enregistrez pas les ports inutiles.  Si vous avez trois IP, alors vous avez √† peine besoin d'une plage par d√©faut de 10 ports.  C'est pratique lorsque vous testez quelque chose sur la machine locale et ex√©cutez 10 n≈ìuds.  Mais dans les syst√®mes r√©els, un seul port suffit g√©n√©ralement.  Ou d√©sactivez la protection contre l'analyse des ports sur le r√©seau interne, si vous en avez l'occasion. </p><br><p>  Le troisi√®me probl√®me commun est IPv6.  Vous pouvez voir d'√©tranges messages d'erreur r√©seau: impossible de se connecter, impossible d'envoyer un message, n≈ìud segment√©.  Cela signifie que vous √™tes tomb√© du cluster.  Tr√®s souvent, ces probl√®mes sont caus√©s par des environnements mixtes IPv4 et IPv6.  Cela ne veut pas dire qu'Apache Ignite ne prend pas en charge IPv6, mais pour le moment il y a certains probl√®mes. </p><br><p>  La solution la plus simple consiste √† passer l'option √† la machine Java </p><br><pre> <code class="hljs objectivec">-Djava.net.preferIPv4Stack=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  Ensuite, Java et Apache Ignite n'utiliseront pas IPv6.  Cela r√©sout une partie importante des probl√®mes li√©s √† l'effondrement des clusters. </p><br><h2>  Pr√©paration de la base de code - nous s√©rialisons correctement </h2><br><p>  Le cluster s'est rassembl√©, il faut y d√©marrer quelque chose.  L'un des √©l√©ments les plus importants dans l'interaction de votre code avec le code Apache Ignite est Marshaller, ou s√©rialisation.  Pour √©crire quelque chose dans la m√©moire, pour persister, pour envoyer sur le r√©seau, Apache Ignite s√©rialise d'abord vos objets.  Vous pouvez voir les messages qui commencent par les mots: ¬´ne peut pas √™tre √©crit au format binaire¬ª ou ¬´ne peut pas √™tre s√©rialis√© √† l'aide de BinaryMarshaller¬ª.  Il n'y aura qu'un seul tel avertissement dans le journal, mais perceptible.  Cela signifie que vous devez modifier un peu plus votre code pour vous lier d'amiti√© avec Apache Ignite. </p><br><p>  Apache Ignite utilise trois m√©canismes pour la s√©rialisation: </p><br><ul><li>  <code>JdkMarshaller</code> - s√©rialisation Java r√©guli√®re; </li><li>  <code>OptimizedMarshaller</code> - s√©rialisation Java l√©g√®rement optimis√©e, mais les m√©canismes sont les m√™mes; </li><li>  <code>BinaryMarshaller</code> est une s√©rialisation √©crite sp√©cifiquement pour Apache Ignite, utilis√©e partout sous son capot.  Elle a un certain nombre d'avantages.  Quelque part, nous pouvons √©viter une s√©rialisation et une d√©s√©rialisation suppl√©mentaires, et quelque part, nous pouvons m√™me obtenir un objet non d√©s√©rialis√© dans l'API, travailler directement avec lui au format binaire comme avec quelque chose comme JSON. </li></ul><br><p>  <code>BinaryMarshaller</code> pourra s√©rialiser et d√©-s√©rialiser vos POJO qui n'ont que des champs et des m√©thodes simples.  Mais si vous avez une s√©rialisation personnalis√©e via <code>readObject()</code> et <code>writeObject()</code> , si vous utilisez <code>Externalizable</code> , alors <code>BinaryMarshaller</code> ne fonctionnera pas.  Il verra que votre objet ne peut pas √™tre s√©rialis√© par l'enregistrement habituel des champs non transitoires et abandonnera - il reviendra √† <code>OptimizedMarshaller</code> . </p><br><p>  Pour vous faire des amis de tels objets avec Apache Ignite, vous devez impl√©menter l'interface <code>Binarylizable</code> .  Il est tr√®s simple. </p><br><p>  Par exemple, il existe un <code>TreeMap</code> standard de Java.  Il a une s√©rialisation et une d√©s√©rialisation personnalis√©es via un objet en lecture et en √©criture.  Il d√©crit d'abord certains champs, puis √©crit la longueur et les donn√©es elles-m√™mes dans <code>OutputStream</code> . </p><br><p>  <b>Impl√©mentation de <code>TreeMap.writeObject()</code></b> </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(java.io.ObjectOutputStream s)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> java.io.IOException </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Write out the Comparator and any hidden stuff s.defaultWriteObject(); // Write out size (number of Mappings) s.writeInt(size); // Write out keys and values (alternating) for (Iterator&lt;Map.Entry&lt;K,V&gt;&gt; i = entrySet().iterator(); i.hasNext(); ) { Map.Entry&lt;K,V&gt; e = i.next(); s.writeObject(e.getKey()); s.writeObject(e.getValue()); } }</span></span></code> </pre> <br><p>  <code>writeBinary()</code> et <code>readBinary()</code> de <code>Binarylizable</code> fonctionnent exactement de la m√™me mani√®re: <code>BinaryTreeMap</code> s'enveloppe dans un <code>TreeMap</code> normal et l'√©crit dans <code>OutputStream</code> .  Cette m√©thode est facile √† √©crire et augmentera consid√©rablement la productivit√©. </p><br><p>  <b><code>BinaryTreeMap.writeBinary()</code></b> </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeBinary</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BinaryWriter writer)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BinaryObjectException </span></span>{ BinaryRawWriter rewriter = writer. rewrite (); rawWriter.writeObject(map.comparator()); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size = map.size(); rawWriter.writeInt(size); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Map.Entry&lt;Object, Object&gt; entry : ((TreeMap&lt;Object, Object&gt;)map).entrySet()) { rawWriter.writeObject(entry.getKey()); rawWriter.writeObject(entry.getValue()); } }</code> </pre> <br><h2>  Lancement dans Compute Grid </h2><br><p>  Ignite vous permet non seulement de stocker des donn√©es, mais √©galement d'ex√©cuter l'informatique distribu√©e.  Comment ex√©cuter une sorte de lambda pour qu'il disperse tous les serveurs et s'ex√©cute? <br>  Pour commencer, quel est le probl√®me avec ces exemples de code? </p><br><p>  <b>Quel est le probl√®me?</b> </p><br><pre> <code class="java hljs">Foo foo = ‚Ä¶; Bar bar = ...; ignite.compute().broadcast( () -&gt; doStuffWithFooAndBar(foo, bar) );</code> </pre> <br><p>  <b>Et si oui?</b> </p><br><pre> <code class="java hljs">Foo foo = ‚Ä¶; Bar bar = ...; ignite.compute().broadcast(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IgniteRunnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doStuffWithFooAndBar(foo, bar); } });</code> </pre> <br><p>  Comme vous pouvez le deviner, beaucoup connaissent les pi√®ges des lambdas et des classes anonymes, le probl√®me est de capturer les variables de l'ext√©rieur.  Par exemple, nous exp√©dions lambda.  Il utilise quelques variables d√©clar√©es en dehors du lambda.  Cela signifie que ces variables voyageront avec elle et traverseront le r√©seau vers tous les serveurs.  Et puis toutes les m√™mes questions se posent: ces objets sont-ils compatibles avec <code>BinaryMarshaller</code> ?  De quelle taille sont-ils?  Souhaitons-nous g√©n√©ralement qu'ils soient transf√©r√©s quelque part, ou ces objets sont-ils si gros qu'il vaut mieux passer une sorte d'identification et recr√©er les objets √† l'int√©rieur du lambda d√©j√† de l'autre c√¥t√©? </p><br><p>  La classe anonyme est encore pire.  Si le lambda ne peut pas emporter cela avec vous, jetez-le, s'il n'est pas utilis√©, alors la classe anonyme le prendra √† coup s√ªr, et cela ne m√®ne g√©n√©ralement √† rien de bon. </p><br><p>  L'exemple suivant.  Lambda √† nouveau, mais qui utilise un peu l'API Apache Ignite. </p><br><p>  <b>L'utilisation de Ignite √† l'int√©rieur de la fermeture de calcul est <em>incorrecte</em></b> </p><br><pre> <code class="java hljs">ignite.compute().broadcast(() -&gt; { IgniteCache foo = ignite.cache(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); String sql = <span class="hljs-string"><span class="hljs-string">"where id = 42"</span></span>; SqlQuery qry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlQuery(<span class="hljs-string"><span class="hljs-string">"Foo"</span></span>, sql).setLocal(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> foo.query(qry); });</code> </pre> <br><p>  Dans la version originale, il prend le cache et y fait localement une sorte de requ√™te SQL.  Il s'agit d'un tel mod√®le lorsque vous devez envoyer une t√¢che qui ne fonctionne qu'avec des donn√©es locales sur des n≈ìuds distants. </p><br><p>  Quel est le probl√®me ici?  Le lambda capture √† nouveau le lien, mais maintenant pas vers l'objet, mais vers le Ignite local sur le n≈ìud avec lequel nous l'envoyons.  Et cela fonctionne m√™me, car l'objet Ignite a une m√©thode <code>readResolve()</code> , qui permet √† la d√©s√©rialisation de remplacer l'Ignite qui est venu sur le r√©seau par celui local sur le n≈ìud o√π nous l'avons envoy√©.  Mais cela entra√Æne parfois aussi des cons√©quences ind√©sirables. </p><br><p>  Fondamentalement, vous transf√©rez simplement plus de donn√©es sur le r√©seau que vous ne le souhaiteriez.  Si vous avez besoin d'obtenir du code que vous ne contr√¥lez pas le lancement d'Apache Ignite ou de certaines de ses interfaces, alors le plus simple est d'utiliser la m√©thode <code>Ignintion.localIgnite()</code> .  Vous pouvez l'appeler √† partir de n'importe quel thread cr√©√© par Apache Ignite et obtenir un lien vers un objet local.  Si vous avez des lambdas, des services, quoi que ce soit et que vous comprenez que vous avez besoin d'Ignite ici, alors je recommande cette m√©thode. </p><br><p>  <strong>Nous utilisons correctement Ignite √† l'int√©rieur de la fermeture de calcul - via <code>localIgnite()</code></strong> </p><br><pre> <code class="java hljs">ignite.compute().broadcast(() -&gt; { IgniteCache foo = Ignition.localIgnite().cache(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>); String sql = <span class="hljs-string"><span class="hljs-string">"where id = 42"</span></span>; SqlQuery qry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlQuery(<span class="hljs-string"><span class="hljs-string">"Foo"</span></span>, sql).setLocal(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> foo.query(qry); });</code> </pre><br><p>  Et le dernier exemple de cette partie.  Apache Ignite poss√®de une grille de services qui peut √™tre utilis√©e pour d√©ployer des microservices directement dans un cluster, et Apache Ignite aidera √† garder le bon nombre d'instances en ligne.  Disons que dans ce service, nous avons √©galement besoin d'un lien vers Apache Ignite.  Comment l'obtenir?  Nous pourrions utiliser <code>localIgnite()</code> , mais ce lien devra ensuite √™tre enregistr√© manuellement dans le champ. </p><br><p>  <strong>Le service stocke <em>incorrectement</em> Ignite dans un champ - le prend comme argument pour le constructeur</strong> </p><br><pre> <code class="java hljs">MyService s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyService(ignite) ignite.services().deployClusterSingleton(<span class="hljs-string"><span class="hljs-string">"svc"</span></span>, s); ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Ignite ignite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Ignite ignite)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ignite = ignite; } ... }</code> </pre> <br><p>  Il existe un moyen plus simple.  Nous avons toujours des classes compl√®tes, et non lambda, nous pouvons donc annoter le champ en tant que <code>@IgniteInstanceResource</code> .  Une fois le service cr√©√©, Apache Ignite s'y mettra et vous pourrez l'utiliser en toute s√©curit√©.  Je vous conseille fortement de faire exactement cela, et de ne pas essayer de passer Apache Ignite et ses enfants au constructeur. </p><br><p>  <strong>Le service utilise <code>@IgniteInstanceResource</code></strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@IgniteInstanceResource</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Ignite ignite; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } ... }</code> </pre> <br><h2>  √âcriture et lecture de donn√©es </h2><br><h3>  Surveiller la r√©f√©rence </h3><br><p>  Nous avons maintenant un cluster Apache Ignite et du code pr√©par√©. </p><br><p>  Imaginons ce sc√©nario: </p><br><ul><li>  Un cache <code>REPLICATED</code> - des copies des donn√©es sont disponibles sur tous les n≈ìuds; </li><li>  La persistance native est en cours d'√©criture sur le disque. </li></ul><br><p>  Nous commen√ßons un n≈ìud.  La persistance native √©tant activ√©e, nous devons activer le cluster avant de travailler avec lui.  Activez.  Ensuite, nous lan√ßons quelques n≈ìuds suppl√©mentaires. <br>  Tout semble fonctionner: l'√©criture et la lecture vont bien.  Tous les n≈ìuds ont des copies des donn√©es; vous pouvez arr√™ter un n≈ìud en toute s√©curit√©.  Mais si vous arr√™tez le tout premier n≈ìud √† partir duquel vous avez commenc√© le lancement, alors tout se casse: les donn√©es disparaissent et les op√©rations cessent de passer. </p><br><p>  La raison en est la topologie de base - les nombreux n≈ìuds qui stockent des donn√©es de persistance sur eux.  Tous les autres n≈ìuds n'auront pas de donn√©es persistantes. </p><br><p>  Cet ensemble de n≈ìuds est d√©termin√© pour la premi√®re fois au moment de l'activation.  Et les n≈ìuds que vous avez ajout√©s par la suite ne sont plus inclus dans le nombre de n≈ìuds de base.  Autrement dit, une grande partie de la topologie de base se compose d'un seul, le tout premier n≈ìud, lorsqu'il s'arr√™te, tout se casse.  Pour √©viter cela, d√©marrez d'abord tous les n≈ìuds, puis activez le cluster.  Si vous devez ajouter ou supprimer un n≈ìud √† l'aide de la commande </p><br><pre> <code class="bash hljs">control.sh --baseline</code> </pre> <br><p>  Vous pouvez voir quels n≈ìuds y sont r√©pertori√©s.  Le m√™me script peut mettre √† jour la ligne de base √† son √©tat actuel. </p><br><p>  <b>Exemple avec <code>control.sh</code></b> </p><br><p><img src="https://habrastorage.org/webt/nw/6d/fy/nw6dfy5onsssvkwsw1vmwaxczm4.png"></p><br><h3>  Colocation des donn√©es </h3><br><p>  Maintenant que nous savons que les donn√©es sont enregistr√©es, essayez de les lire.  Nous avons un support SQL, vous pouvez faire <code>SELECT</code> - presque comme dans Oracle.  Mais en m√™me temps, nous pouvons √©voluer et fonctionner sur n'importe quel nombre de n≈ìuds, les donn√©es sont stock√©es de mani√®re distribu√©e.  Regardons un tel mod√®le: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Long id; <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Long orgId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Organization</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@QuerySqlField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Long id; }</code> </pre> <br><p>  Demande </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Person <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Organization</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> o <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.orgId = o.id</code> </pre> <br><p>  ne renverra pas toutes les donn√©es.  Qu'est-ce qui ne va pas? </p><br><p>  Personne ( <code>Person</code> ) fait r√©f√©rence √† l'organisation ( <code>Organization</code> ) par ID.  Il s'agit d'une cl√© √©trang√®re classique.  Mais si nous essayons de combiner les deux tables et d'envoyer une telle requ√™te SQL, alors avec plusieurs n≈ìuds du cluster, nous ne recevrons pas toutes les donn√©es. </p><br><p>  Le fait est que, par d√©faut, SQL <code>JOIN</code> ne fonctionne que dans un seul n≈ìud.  Si SQL parcourait constamment le cluster pour collecter des donn√©es et renvoyer le r√©sultat complet, ce serait incroyablement lent.  Nous perdrions tous les avantages d'un syst√®me distribu√©.  Donc, √† la place, Apache Ignite ne regarde que les donn√©es locales. </p><br><p>  Pour obtenir les r√©sultats corrects, nous devons regrouper les donn√©es (colocation).  Autrement dit, pour la combinaison correcte de personne et d'organisation, les donn√©es des deux tables doivent √™tre stock√©es sur le m√™me n≈ìud. </p><br><p>  Comment faire  La solution la plus simple consiste √† d√©clarer une cl√© d'affinit√©.  Il s'agit d'une valeur qui d√©termine sur quel n≈ìud, dans quelle partition, dans quel groupe d'enregistrements telle ou telle valeur sera situ√©e.  Si nous d√©clarons l'ID d'organisation dans <code>Person</code> comme cl√© d'affinit√©, cela signifie que les personnes ayant cet ID d'organisation doivent se trouver sur le m√™me n≈ìud que l'organisation avec le m√™me ID. </p><br><p>  Si, pour une raison quelconque, vous ne pouvez pas le faire, il existe une autre solution moins efficace: activez les jointures distribu√©es.  Cela se fait via l'API, et la proc√©dure d√©pend de ce que vous utilisez - Java, JDBC ou autre chose.  Ensuite, <code>JOIN</code> sera ex√©cut√© plus lentement, mais ils renverront ensuite les r√©sultats corrects. </p><br><p>  Voyons comment travailler avec les cl√©s d'affinit√©.  Comment comprendre que tel ou tel ID, tel ou tel champ est appropri√© pour d√©terminer l'affinit√©?  Si nous disons que toutes les personnes ayant le m√™me <code>orgId</code> seront stock√©es ensemble, alors <code>orgId</code> est un groupe indivisible.  Nous ne pouvons pas le r√©partir entre plusieurs n≈ìuds.  Si la base de donn√©es contient 10 organisations, alors il y aura 10 groupes indivisibles qui peuvent √™tre plac√©s sur 10 n≈ìuds.  S'il y a plus de n≈ìuds dans le cluster, alors tous les n≈ìuds "suppl√©mentaires" resteront sans groupes.  Ceci est tr√®s difficile √† d√©finir lors de l'ex√©cution, alors pensez-y √† l'avance. </p><br><p>  Si vous avez une grande organisation et 9 petites, la taille des groupes sera diff√©rente.  Mais Apache Ignite ne regarde pas le nombre d'enregistrements dans les groupes d'affinit√© lorsqu'il les distribue sur les n≈ìuds.  Par cons√©quent, il ne mettra pas un groupe sur un n≈ìud, mais 9 autres sur un autre afin de niveler en quelque sorte la distribution.  Au contraire, il leur mettra 5 et 5 (ou 6 et 4, ou m√™me 7 et 3). </p><br><p>  Comment r√©partir uniform√©ment les donn√©es?  Puissions-nous avoir </p><br><ul><li>  Touches K; </li><li>  Une vari√©t√© de cl√©s d'affinit√©; </li><li>  P partitions, c'est-√†-dire de grands groupes de donn√©es qu'Apache Ignite distribuera entre les n≈ìuds; </li><li>  N n≈ìuds. </li></ul><br><p>  Il faut alors que la condition </p><br><pre> <code class="hljs ruby">K <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>A &gt;&gt; P &gt;&gt; N</code> </pre> <br><p>  o√π <code>&gt;&gt;</code> est "beaucoup plus" et les donn√©es seront distribu√©es de mani√®re relativement uniforme. </p><br><p>  Par ailleurs, la valeur par d√©faut est P = 1024. </p><br><p>  Tr√®s probablement, vous ne r√©ussirez pas dans une distribution uniforme.  Ce fut le cas dans Apache Ignite 1.x √† 1.9.  Cela s'appelait <code>FairAffinityFunction</code> et ne fonctionnait pas tr√®s bien - cela entra√Ænait trop de trafic entre les n≈ìuds.  Maintenant, l'algorithme est appel√© <code>RendezvousAffinityFunction</code> .  Il ne donne pas une distribution absolument honn√™te, l'erreur entre les n≈ìuds sera de plus ou moins 5-10%. </p><br><h2>  Liste de contr√¥le pour les nouveaux utilisateurs d'Apache Ignite </h2><br><ol><li>  Configurer, lire, stocker des journaux </li><li>  D√©sactivez la multidiffusion, notez uniquement les adresses et les ports que vous utilisez </li><li>  D√©sactiver IPv6 </li><li>  Pr√©parez vos cours pour <code>BinaryMarshaller</code> </li><li>  Gardez une trace de votre ligne de base </li><li>  Configurer la collocation d'affinit√© </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415973/">https://habr.com/ru/post/fr415973/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415961/index.html">Stockage distribu√© russe. Comment √ßa marche</a></li>
<li><a href="../fr415963/index.html">Naive Bayes, ou comment les math√©matiques vous permettent de filtrer le spam</a></li>
<li><a href="../fr415965/index.html">√Ä lire en juillet: 19 nouveaux livres pour les professionnels du num√©rique</a></li>
<li><a href="../fr415967/index.html">SolidFire - Stockage pour ces ** cking hate stockage</a></li>
<li><a href="../fr415969/index.html">HyperX Pulsefire Surge RGB - un tueur n√© naturel</a></li>
<li><a href="../fr415975/index.html">Les Chinois ont pr√©sent√© un pistolet laser d'une port√©e de pr√®s d'un kilom√®tre</a></li>
<li><a href="../fr415977/index.html">Tunnels et VPN r√©sistants au DPI</a></li>
<li><a href="../fr415979/index.html">Security Week 24: Rowhammer sur Android et la complexit√© des vuln√©rabilit√©s mat√©rielles</a></li>
<li><a href="../fr415981/index.html">Google et HTTP</a></li>
<li><a href="../fr415983/index.html">Premier univers 5. D√©calage cosmologique et dynamique d'un univers en expansion uniforme, partie 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>