<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘µ â–¶ï¸ ğŸ§‘ğŸ¾ Rincian kerusakan Cloudflare 2 Juli 2019 ğŸ›ƒ ğŸ‘¸ğŸ¼ ğŸ¤³ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hampir 9 tahun yang lalu, Cloudflare adalah perusahaan kecil, tetapi saya tidak bekerja di dalamnya, saya hanya seorang klien. Sebulan setelah meluncu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Rincian kerusakan Cloudflare 2 Juli 2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/460863/"><p><img src="https://habrastorage.org/webt/dx/yb/5r/dxyb5rids6_8tahyhactypl4rwm.png"></p><br><p>  Hampir 9 tahun yang lalu, Cloudflare adalah perusahaan kecil, tetapi saya tidak bekerja di dalamnya, saya hanya seorang klien.  Sebulan setelah meluncurkan Cloudflare, saya menerima pemberitahuan bahwa DNS tampaknya tidak berfungsi di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">situs web</a> jgc.org saya.  Cloudflare membuat perubahan ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Protokol Buffer</a> , dan ada DNS yang rusak. </p><a name="habracut"></a><br><p>  Saya segera menulis kepada Matthew Prince, mengepalai surat "Di mana DNS saya?", Dan dia mengirim jawaban panjang, penuh dengan rincian teknis ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">baca semua korespondensi di sini</a> ), dan saya menjawab: </p><br><blockquote>  Dari: John Graham Cumming <br>  Tanggal: 7 Oktober 2010 9:14 <br>  Subjek: Re: Di mana DNS saya? <br>  Kepada: Matthew Prince <br><br>  Laporan keren, terima kasih.  Saya pasti akan menelepon jika ada masalah.  Mungkin layak menulis posting tentang ini ketika Anda mengumpulkan semua info teknis.  Saya pikir orang akan menyukai cerita yang terbuka dan jujur.  Terutama jika Anda melampirkan grafik untuk menunjukkan bagaimana lalu lintas tumbuh setelah diluncurkan. <br><br>  Saya memiliki pemantauan yang baik di situs, dan saya menerima SMS tentang setiap kegagalan.  Pemantauan menunjukkan bahwa kegagalan adalah dari 13:03:07 hingga 14:04:12.  Tes dilakukan setiap lima menit. <br><br>  Saya yakin Anda akan mengetahuinya.  Anda pasti tidak membutuhkan orang Anda sendiri di Eropa?  :-) </blockquote><p>  Dan dia menjawab: </p><br><blockquote>  Dari: Matthew Prince <br>  Tanggal: 7 Oktober 2010, 9:57 <br>  Subjek: Re: Di mana DNS saya? <br>  Kepada: John Graham Cumming <br><br>  Terima kasih  Kami menjawab semua orang yang menulis.  Saya akan ke kantor sekarang, dan kami akan menulis sesuatu di blog atau mengirim posting resmi di papan buletin kami.  Saya sepenuhnya setuju, kejujuran adalah segalanya bagi kami. </blockquote><p>  Sekarang Cloudflare adalah perusahaan yang sangat besar, saya bekerja di dalamnya, dan sekarang saya harus menulis secara terbuka tentang kesalahan kita, konsekuensinya dan tindakan kita. </p><br><h3 id="sobytiya-2-iyulya">  2 Juli acara </h3><br><p>  Pada tanggal 2 Juli, kami menerapkan aturan baru dalam aturan yang dikelola untuk WAF, karena <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sumber daya prosesor habis</a> pada setiap inti prosesor yang memproses lalu lintas HTTP / HTTPS di jaringan Cloudflare di seluruh dunia.  Kami terus meningkatkan aturan yang dikelola untuk WAF dalam menanggapi kerentanan dan ancaman baru.  Pada Mei, misalnya, kami bergegas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menambahkan aturan</a> untuk melindungi diri dari kerentanan serius di SharePoint.  Inti dari WAF kami adalah kemampuan untuk menyebarkan aturan secara cepat dan global. </p><br><p>  Sayangnya, pembaruan Kamis lalu berisi ekspresi reguler yang menghabiskan terlalu banyak sumber daya prosesor yang didedikasikan untuk HTTP / HTTPS untuk melakukan backtracking.  Ini memengaruhi fitur inti proxy, CDN, dan WAF kami.  Grafik menunjukkan bahwa sumber daya prosesor untuk melayani lalu lintas HTTP / HTTPS mencapai hampir 100% pada server di jaringan kami. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/au/xp/dz/auxpdz0pbethhc_hka-nvzmmsmo.png"></a> <br>  <em>Menggunakan sumber daya prosesor di salah satu titik kehadiran selama insiden</em> </p><br><p>  Akibatnya, klien kami (dan klien klien kami) berlari ke halaman dengan kesalahan 502 di domain Cloudflare.  502 kesalahan dihasilkan oleh server web Cloudflare front-end, yang masih memiliki kernel gratis, tetapi mereka tidak dapat menghubungi proses yang memproses lalu lintas HTTP / HTTPS. </p><br><p><img src="https://habrastorage.org/webt/mn/36/v_/mn36v_x1bbtqofu8l9lzpjty-pm.png"></p><br><p>  Kami tahu berapa banyak ketidaknyamanan yang menyebabkan pelanggan kami.  Kami sangat malu.  Dan kegagalan ini mencegah kami dari berurusan secara efektif dengan kejadian itu. </p><br><p> Jika Anda salah satu dari klien ini, itu mungkin membuat Anda takut, marah dan kesal.  Selain itu, kami belum mengalami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kegagalan global</a> selama 6 tahun.  Konsumsi CPU yang tinggi adalah karena satu aturan WAF dengan ekspresi reguler yang diformulasikan dengan buruk, yang menyebabkan backtracking yang berlebihan.  Inilah ekspresi bersalahnya: <code>(?:(?:\"|'|\]|\}|\\|\d|(?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\-|\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </p><br><p>  Meskipun itu menarik dalam dirinya sendiri (dan saya akan memberi tahu Anda lebih banyak tentangnya di bawah), layanan Cloudflare terputus selama 27 menit, tidak hanya karena ekspresi reguler yang tidak sesuai.  Butuh beberapa saat untuk menggambarkan urutan kejadian yang menyebabkan kegagalan, jadi kami tidak merespons dengan cepat.  Di akhir posting, saya akan menjelaskan penelusuran mundur dalam ekspresi reguler dan memberi tahu Anda apa yang harus dilakukan. </p><br><h3 id="chto-sluchilos">  Apa yang terjadi </h3><br><p>  Mari kita mulai.  Semua waktu ditunjukkan di sini dalam UTC. </p><br><p>  Pada 13:42, seorang insinyur dari tim firewall membuat perubahan kecil pada aturan untuk mendeteksi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">XSS</a> menggunakan proses otomatis.  Karenanya, tiket permintaan perubahan telah dibuat.  Kami mengelola tiket ini melalui Jira (tangkapan layar di bawah). </p><br><p>  Setelah 3 menit, halaman PagerDuty pertama muncul, melaporkan masalah dengan WAF.  Itu adalah tes sintetis yang memeriksa fungsionalitas WAF (kami memiliki ratusan di antaranya) di luar Cloudflare untuk memantau operasi normal.  Lalu segera ada halaman-halaman dengan pemberitahuan kegagalan dari tes end-to-end lain dari layanan Cloudflare, masalah lalu lintas global, kesalahan 502 yang tersebar luas, dan banyak laporan dari titik kehadiran kami (PoP) di kota-kota di seluruh dunia yang menunjukkan kurangnya sumber daya prosesor. </p><br><p><img src="https://habrastorage.org/webt/fh/iw/ja/fhiwjas8c3-qfcwo-11nks3lld4.png"></p><br><p><img src="https://habrastorage.org/webt/fs/g7/xo/fsg7xokybw-svzn8tn-uyhuj7dm.jpeg"></p><br><p>  Saya menerima beberapa pemberitahuan seperti itu, keluar dari rapat dan sudah berjalan ke meja ketika kepala departemen pengembangan solusi kami mengatakan bahwa kami kehilangan 80% dari lalu lintas.  Saya berlari ke insinyur SRE kami yang sudah mengerjakan masalah.  Awalnya kami pikir itu semacam serangan yang tidak diketahui. </p><br><p><img src="https://habrastorage.org/webt/-r/ox/mw/-roxmwj33bvn_n-xyww8xhfwpmw.jpeg"></p><br><p>  Insinyur Cloudflare SRE tersebar di seluruh dunia dan memantau situasi sepanjang waktu.  Biasanya, peringatan tersebut memberi tahu Anda tentang masalah lokal spesifik lingkup terbatas, dipantau pada dasbor internal, dan diselesaikan beberapa kali sehari.  Tetapi halaman dan pemberitahuan tersebut menunjukkan sesuatu yang sangat serius, dan para insinyur SRE segera mengumumkan tingkat keparahan P0 dan beralih ke manajemen dan teknisi sistem. </p><br><p>  Insinyur London kami pada saat itu sedang mendengarkan ceramah di aula utama.  Ceramah harus diganggu, semua orang berkumpul di ruang konferensi besar, dan lebih banyak ahli diundang.  Ini bukan masalah umum yang SRE bisa cari tahu sendiri.  Sangat mendesak untuk menghubungkan spesialis yang tepat. </p><br><p>  Pada pukul 14:00 kami memutuskan bahwa ada masalah dengan WAF dan tidak ada serangan.  Departemen kinerja mengambil data prosesor, dan menjadi jelas bahwa WAF yang harus disalahkan.  Kolaborator lain mengkonfirmasi teori ini dengan strace.  Orang lain melihat di log bahwa masalah dengan WAF.  Pada pukul 14:02, seluruh tim mendatangi saya ketika diusulkan untuk menggunakan global kill - sebuah mekanisme yang dibangun dalam Cloudflare yang menonaktifkan satu komponen di seluruh dunia. </p><br><p>  Bagaimana kami melakukan global kill untuk WAF adalah cerita yang berbeda.  Tidak sesederhana itu.  Kami menggunakan produk kami sendiri, dan karena layanan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Access</a> kami tidak berfungsi, kami tidak dapat mengotentikasi dan masuk ke panel kontrol internal (ketika semuanya diperbaiki, kami mengetahui bahwa beberapa anggota tim kehilangan akses karena fitur keamanan yang menonaktifkan kredensial jika jangan gunakan panel kontrol internal untuk waktu yang lama). </p><br><p>  Dan kami tidak bisa mendapatkan layanan internal kami, seperti Jira atau sistem build.  Kami membutuhkan solusi, yang jarang kami gunakan (ini juga perlu diselesaikan).  Akhirnya, seorang insinyur mampu memotong WAF pada 14:07, dan pada 14:09 tingkat lalu lintas dan prosesor di mana-mana kembali normal.  Mekanisme pertahanan Cloudflare lainnya berfungsi seperti yang diharapkan. </p><br><p>  Kemudian kami mulai mengembalikan WAF.  Situasinya luar biasa, jadi kami melakukan tes negatif (bertanya pada diri sendiri apakah masalah sebenarnya adalah perubahan ini) dan positif (memastikan bahwa kemunduran berfungsi) di satu kota menggunakan lalu lintas terpisah, memindahkan pelanggan berbayar dari sana. </p><br><p>  Pada pukul 2:52 malam, kami yakin bahwa kami memahami alasannya dan melakukan koreksi, dan menyalakan WAF lagi. </p><br><h3 id="kak-rabotaet-cloudflare">  Bagaimana Cloudflare Bekerja </h3><br><p>  Cloudflare memiliki tim insinyur yang mengelola aturan yang dikelola untuk WAF.  Mereka mencoba untuk meningkatkan tingkat deteksi, mengurangi jumlah positif palsu dan cepat menanggapi ancaman baru saat mereka muncul.  Selama 60 hari terakhir, 476 permintaan perubahan untuk aturan yang dikelola WAF telah diproses (rata-rata, satu setiap 3 jam). </p><br><p>  Perubahan khusus ini perlu digunakan dalam mode simulasi, di mana lalu lintas klien nyata melewati aturan, tetapi tidak ada yang diblokir.  Kami menggunakan mode ini untuk memeriksa efektivitas aturan dan mengukur proporsi hasil positif palsu dan negatif palsu.  Tetapi bahkan dalam mode simulasi, aturan harus benar-benar dieksekusi, dan dalam kasus ini, aturan berisi ekspresi reguler yang menghabiskan terlalu banyak sumber daya prosesor. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/1p/sc/90/1psc90ccs9enwxvdyvu4thq30eo.png"></a> </p><br><p>  Seperti yang dapat Anda lihat dari permintaan perubahan di atas, kami memiliki paket penerapan, paket rollback, dan tautan ke prosedur operasi standar internal (SOP) untuk jenis penyebaran ini.  SOP untuk mengubah aturan memungkinkan Anda untuk mempublikasikannya secara global.  Bahkan, di Cloudflare, semuanya diatur dengan sangat berbeda, dan SOP pertama-tama mengharuskan untuk mengirim perangkat lunak untuk pengujian dan penggunaan internal ke titik kehadiran internal (PoP) (yang digunakan karyawan kami), kemudian ke sejumlah kecil klien di tempat yang terisolasi, kemudian ke sejumlah besar klien, dan hanya kemudian ke seluruh dunia. </p><br><p>  Ini tampilannya.  Kami menggunakan git di sistem internal melalui BitBucket.  Insinyur perubahan mengirim kode yang mereka buat ke TeamCity, dan ketika build berlalu, pengulas ditugaskan.  Ketika permintaan kumpulan disetujui, kode dikumpulkan dan serangkaian tes dilakukan (lagi). </p><br><p>  Jika perakitan dan tes berhasil, permintaan perubahan dibuat di Jira, dan perubahan tersebut harus disetujui oleh penyelia atau spesialis utama yang sesuai.  Setelah disetujui, itu digunakan untuk apa yang disebut "PoP menagerie": DOG, PIG dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Canary</a> (anjing, gondong dan kenari). </p><br><p>  DOG PoP adalah Cloudflare PoP (seperti kota-kota kami lainnya), yang hanya digunakan oleh karyawan Cloudflare.  PoP untuk penggunaan internal memungkinkan Anda untuk menangkap masalah bahkan sebelum solusi mulai menerima lalu lintas pelanggan.  Hal yang berguna. </p><br><p>  Jika tes DOG berhasil, kode dilanjutkan ke tahap PIG (kelinci percobaan).  Ini adalah Cloudflare PoP, di mana sejumlah kecil lalu lintas klien gratis mengalir melalui kode baru. <br>  Jika semuanya baik-baik saja, kodenya masuk ke Canary.  Kami memiliki tiga PoP Canary di berbagai belahan dunia.  Lalu lintas klien berbayar dan gratis melewati kode baru di dalamnya, dan ini adalah pemeriksaan kesalahan terakhir. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ew/d_/0h/ewd_0hfzquucy07y15qbgbckaao.png"></a> <br>  <em>Proses Peluncuran Perangkat Lunak Cloudflare</em> </p><br><p>  Jika kodenya oke di Canary, kami merilisnya.  Melewati semua tahapan - DOG, PIG, Canary, seluruh dunia - membutuhkan beberapa jam atau hari, tergantung pada perubahan kode.  Karena keragaman jaringan dan pelanggan Cloudflare, kami menguji kode secara menyeluruh sebelum rilis global untuk semua pelanggan.  Tetapi WAF tidak secara khusus mengikuti proses ini karena ancaman perlu ditanggapi dengan cepat. </p><br><p>  Ancaman WAF <br>  Dalam beberapa tahun terakhir, ada lebih banyak ancaman signifikan dalam aplikasi konvensional.  Hal ini disebabkan oleh ketersediaan perangkat pengujian perangkat lunak yang lebih besar.  Sebagai contoh, kami baru saja menulis tentang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">fuzzing</a> ). </p><br><p><img src="https://habrastorage.org/webt/br/lu/mp/brlumpkugkwhpdfq3zb0fb5vixm.png"><br>  <em>Sumber: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  Sangat sering, konfirmasi konsep dibuat dan segera diterbitkan di Github sehingga tim yang melayani aplikasi dapat dengan cepat mengujinya dan memastikan bahwa itu dilindungi secara memadai.  Oleh karena itu, Cloudflare membutuhkan kemampuan untuk merespons serangan baru secepat mungkin sehingga pelanggan memiliki kesempatan untuk memperbaiki perangkat lunak mereka. </p><br><p>  Sebuah contoh bagus dari tanggapan cepat Cloudflare adalah penerapan perlindungan kerentanan SharePoint pada bulan Mei ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">baca di sini</a> ).  Hampir segera setelah publikasi iklan, kami melihat sejumlah besar upaya untuk mengeksploitasi kerentanan dalam instalasi SharePoint klien kami.  Teman-teman kami terus-menerus memonitor ancaman baru dan menulis aturan untuk melindungi pelanggan kami. </p><br><p>  Aturan yang menyebabkan masalah pada hari Kamis adalah untuk melindungi terhadap scripting lintas situs (XSS).  Ada juga banyak serangan seperti itu dalam beberapa tahun terakhir. </p><br><p><img src="https://habrastorage.org/webt/tr/jy/oz/trjyozwk_k4raviofhzgeskwf2s.png"><br>  <em>Sumber: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  Prosedur standar untuk memodifikasi aturan yang dikelola untuk WAF memerlukan pengujian integrasi berkelanjutan (CI) sebelum penyebaran global.  Kamis lalu, kami melakukannya dan memperluas aturan.  Pada pukul 13:31, seorang insinyur mengirim permintaan kolam yang disetujui dengan kembalian. </p><br><p><img src="https://habrastorage.org/webt/uz/xj/jo/uzxjjo5648f52t8x-tnu66tuvku.png"></p><br><p>  Pada 13:37, TeamCity mengumpulkan aturan, menjalankan tes dan memberikan lampu hijau.  Test suite WAF menguji fungsionalitas inti WAF dan terdiri dari sejumlah besar unit test untuk fungsi individual.  Setelah pengujian unit, kami memeriksa aturan WAF dengan sejumlah besar permintaan HTTP.  Permintaan HTTP memeriksa permintaan mana yang harus diblokir oleh WAF (untuk mencegat serangan) dan yang dapat dilewati (agar tidak memblokir semuanya dan menghindari kesalahan positif).  Tetapi kami tidak melakukan tes untuk penggunaan sumber daya prosesor yang berlebihan, dan mempelajari log dari rakitan WAF sebelumnya menunjukkan bahwa waktu pelaksanaan uji dengan aturan tidak meningkat, dan sulit untuk mencurigai bahwa tidak ada sumber daya yang cukup. </p><br><p>  Tes telah berlalu, dan TeamCity mulai secara otomatis menyebarkan perubahan pada pukul 13:42. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/8-/s2/gd/8-s2gd8pw8j5zhxukadhwh77xr4.png"></a> </p><br><h3 id="quicksilver">  Quicksilver </h3><br><p>  Aturan WAF dirancang untuk mengatasi ancaman dengan cepat, jadi kami menyebarkannya menggunakan repositori pasangan kunci-nilai terdistribusi Quicksilver, yang mendistribusikan perubahan secara global dalam hitungan detik.  Semua pelanggan kami menggunakan teknologi ini ketika mereka mengubah konfigurasi di dasbor atau melalui API, dan karena itu kami merespons perubahan dengan kecepatan kilat. </p><br><p>  Kami berbicara sedikit tentang Quicksilver.  Kami dulu menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kyoto Tycoon</a> sebagai repositori pasangan nilai kunci terdistribusi secara global, tetapi ada masalah operasional dengannya, dan kami menulis repositori kami yang direplikasi di lebih dari 180 kota.  Sekarang, dengan Quicksilver, kami mengirim perubahan konfigurasi klien, memperbarui aturan WAF, dan mendistribusikan kode JavaScript yang ditulis oleh klien di Cloudflare Workers. </p><br><p>  Hanya diperlukan beberapa detik untuk konfigurasi untuk keliling dunia dari menekan tombol pada dashboard atau memanggil API untuk membuat perubahan konfigurasi.  Pelanggan menyukai pengaturan kecepatan ini.  Dan Pekerja memberi mereka penyebaran perangkat lunak global yang hampir instan.  Rata-rata, Quicksilver mendistribusikan sekitar 350 perubahan per detik. </p><br><p>  Dan Quicksilver sangat cepat.  Rata-rata, kami mencapai persentil ke-99 dari 2,29 untuk menyebarkan perubahan ke setiap komputer di seluruh dunia.  Biasanya kecepatannya bagus.  Lagi pula, ketika Anda menghidupkan fungsi atau menghapus cache, itu terjadi hampir secara instan dan di mana-mana.  Mengirim kode melalui Pekerja Cloudflare dengan kecepatan yang sama.  Cloudflare menjanjikan pelanggannya pembaruan cepat pada waktu yang tepat. </p><br><p>  Tetapi dalam kasus ini, kecepatan memainkan trik pada kami, dan aturan berubah di mana-mana dalam hitungan detik.  Anda mungkin memperhatikan bahwa kode WAF menggunakan Lua.  Cloudflare menggunakan Lua secara ekstensif di lingkungan produksi dan kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">telah membahas</a> detail <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Lua di WAF</a> .  Lua WAF menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PCRE secara</a> internal dan menerapkan pelacakan balik untuk pencocokan.  Ia tidak memiliki mekanisme pertahanan terhadap ekspresi yang di luar kendali.  Di bawah ini saya akan berbicara lebih banyak tentang ini dan apa yang kita lakukan dengannya. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/zd/qq/yo/zdqqyof00zszstm3indwngi26_8.png"></a> </p><br><p>  Sebelum penerapan aturan, semuanya berjalan dengan lancar: permintaan kumpulan dibuat dan disetujui, pipa CI / CD mengumpulkan dan menguji kode, permintaan perubahan dikirim sesuai dengan SOP, yang mengatur penyebaran dan rollback, dan penyebaran selesai. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/5t/47/ar/5t47art0hduaaxywv3io5_71z8a.png"></a> <br>  <em>Proses Penyebaran CloudFare WAF</em> </p><br><p>  Apa yang salah <br>  Seperti yang saya katakan sebelumnya, kami menerapkan lusinan aturan WAF baru setiap minggu, dan kami memiliki banyak sistem perlindungan terhadap konsekuensi negatif dari penyebaran seperti itu.  Dan ketika terjadi kesalahan, biasanya kombinasi dari beberapa keadaan.  Jika Anda hanya menemukan satu alasan, ini tentu saja menenangkan, tetapi tidak selalu benar.  Berikut adalah alasan yang bersama-sama menyebabkan kegagalan layanan HTTP / HTTPS kami. </p><br><ol><li>  Insinyur itu menulis ekspresi reguler yang bisa mengarah pada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kemunduran yang</a> berlebihan. </li><li>  Sebuah alat yang dapat mencegah penggunaan berlebihan sumber daya prosesor yang digunakan oleh ekspresi reguler salah dihapus selama WAF refactoring beberapa minggu sebelumnya - refactoring diperlukan sehingga WAF mengkonsumsi lebih sedikit sumber daya. </li><li>  Mesin regex tidak memiliki jaminan kompleksitas. </li><li>  Test suite tidak dapat mengungkapkan konsumsi CPU yang berlebihan. </li><li>  Prosedur SOP memungkinkan penyebaran global perubahan aturan yang tidak mendesak tanpa proses multi-langkah. </li><li>  Rencana rollback membutuhkan perakitan WAF lengkap dua kali, yang memakan waktu lama. </li><li>  Peringatan lalu lintas global pertama bekerja sangat terlambat. </li><li>  Kami menunda memperbarui halaman status. </li><li>  Kami memiliki masalah dalam mengakses sistem karena macet, dan solusinya tidak berhasil dengan baik. </li><li>  Insinyur SRE telah kehilangan akses ke beberapa sistem karena kredensial mereka telah kedaluwarsa karena alasan keamanan. </li><li>  Pelanggan kami tidak memiliki akses ke dasbor atau API Cloudflare karena mereka pergi melalui wilayah Cloudflare. </li></ol><br><h3 id="chto-izmenilos-s-proshlogo-chetverga">  Apa yang telah berubah sejak Kamis lalu </h3><br><p>  Pertama, kami sepenuhnya menghentikan semua pekerjaan pada rilis untuk WAF dan melakukan hal berikut: </p><br><ol><li>  Memperkenalkan kembali perlindungan terhadap sumber daya prosesor berlebihan yang kami hapus.  (Selesai) </li><li>  Periksa secara manual semua 3868 aturan dalam aturan yang dikelola untuk WAF untuk menemukan dan memperbaiki kasus potensial lainnya dari pengulangan yang berlebihan.  (Verifikasi selesai) </li><li>  Kami menyertakan profil kinerja untuk semua aturan dalam rangkaian uji.  (Diharapkan: 19 Juli) </li><li>  Kami <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">beralih</a> ke mesin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">re2</a> atau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Rust</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">regex</a> - keduanya memberikan jaminan saat runtime.  (Diharapkan: 31 Juli) </li><li>  Kami menulis ulang SOP untuk menerapkan aturan secara bertahap, seperti perangkat lunak lain di Cloudflare, tetapi pada saat yang sama memiliki kemampuan untuk penyebaran darurat global jika serangan sudah dimulai. </li><li>  Kami sedang mengembangkan kemungkinan penarikan segera dashboard dan API Cloudflare dari wilayah Cloudflare. </li><li>  Kami mengotomatiskan pembaruan halaman <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Status Cloudflare</a> . </li></ol><br><p>  Dalam jangka panjang, kami meninggalkan Lua WAF, yang saya tulis beberapa tahun yang lalu.  Kami memigrasikan WAF ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sistem firewall baru</a> .  Jadi WAF akan lebih cepat dan menerima tingkat perlindungan tambahan. </p><br><h3 id="zaklyuchenie">  Kesimpulan </h3><br><p>  Kegagalan ini menyebabkan masalah bagi kami dan pelanggan kami.  Kami dengan cepat bereaksi untuk memperbaiki situasi, dan sekarang kami sedang mengerjakan kesalahan dalam proses yang menyebabkan kegagalan, dan kami menggali lebih dalam lagi untuk melindungi diri dari masalah potensial dengan ekspresi reguler di masa depan dengan beralih ke teknologi baru. </p><br><p>  Kami sangat malu dengan kegagalan ini, dan kami meminta maaf kepada pelanggan kami.  Kami berharap perubahan ini memastikan bahwa ini tidak terjadi lagi. </p><br><h3 id="prilozhenie-bektreking-regulyarnyh-vyrazheniy">  Aplikasi.  Pengulangan Ekspresi Reguler </h3><br><p>  Untuk memahami bagaimana ekspresi: </p><br><pre> <code class="plaintext hljs">(?:(?:\"|'|\]|\}|\\|\d (?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\- |\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </pre> <br><p>  memakan semua sumber daya prosesor, Anda perlu tahu sedikit tentang cara kerja mesin regex standar.  Masalahnya di sini adalah polanya <code>.*(?:.*=.*)</code> .  <code>(?:</code> dan yang sesuai <code>)</code> bukan grup yang menarik (yaitu, ekspresi dalam tanda kurung dikelompokkan sebagai satu ekspresi). </p><br><p>  Dalam konteks konsumsi sumber daya prosesor yang berlebihan, pola ini dapat ditetapkan sebagai <code>.*.*=.*</code> .  Dengan demikian, polanya terlihat tidak perlu rumit.  Tapi yang lebih penting, di dunia nyata, ekspresi seperti itu (mirip dengan ekspresi kompleks dalam aturan WAF) yang meminta mesin untuk mencocokkan sebuah fragmen, diikuti oleh fragmen lain, dapat menyebabkan backtracking bencana.  Dan inilah alasannya. </p><br><p><img src="https://habrastorage.org/webt/wr/7g/ec/wr7gec__o2lld5uwyz5ir6vfolm.png"></p><br><p>  Dalam ekspresi reguler <code>.</code>  berarti bahwa Anda harus mencocokkan satu karakter,. <code>.*</code> - mencocokkan nol atau lebih karakter "dengan rakus", yaitu, menangkap maksimum karakter, jadi <code>.*.*=.*</code> berarti mencocokkan dengan nol karakter atau lebih, kemudian mencocokkan dengan nol atau lebih banyak karakter, cari karakter literal =, cocok dengan nol atau lebih karakter. </p><br><p>  Ambil garis uji <code>x=x</code> .  Ini cocok dengan ungkapan <code>.*.*=.*. .*.*</code>  <code>.*.*=.*. .*.*</code> hingga tanda sama dengan sesuai dengan <code>x</code> pertama (salah satu grup <code>.*</code> sesuai dengan <code>x</code> , dan yang kedua ke nol karakter).  <code>.*</code> setelah = cocok dengan <code>x</code> terakhir. </p><br><p>  Untuk perbandingan seperti itu, 23 langkah diperlukan.  Grup pertama <code>.*</code> <code>.*.*=.*</code> Kisah "rakus" dan cocok dengan seluruh baris <code>x=x</code> .  Mesin pindah ke grup berikutnya <code>.*</code> .  Kami tidak lagi memiliki karakter yang cocok, jadi grup kedua <code>.*</code> Cocok dengan nol karakter (ini dibolehkan).  Kemudian mesin menuju ke tanda <code>=</code> .  Tidak ada lagi karakter (grup pertama <code>.*</code> Menggunakan seluruh ekspresi <code>x=x</code> ), tidak ada kecocokan yang terjadi. </p><br><p>  Dan di sini mesin ekspresi reguler kembali ke awal.  Dia pergi ke grup pertama <code>.*</code> Dan membandingkannya <code> x=</code> (bukan <code>x=x</code> ), dan kemudian mengambil grup kedua <code>.*</code> .  Grup kedua <code>.*</code> Peta ke <code>x</code> kedua, dan sekali lagi kami tidak memiliki karakter tersisa.  Dan ketika mesin mencapai <code>=</code> v <code>.*.*=.*</code> Sekali lagi, tidak ada yang terjadi.  Dan dia mundur lagi. </p><br><p>  Kali ini, grup <code>.*</code> Masih cocok dengan <code>x=</code> , tetapi grup kedua <code>.*</code> Bukan lagi <code>x</code> , tetapi nol karakter.  Mesin mencoba menemukan simbol literal <code>=</code> dalam pola <code>.*.*=.*</code> , Tetapi tidak keluar (setelah semua, kelompok pertama telah menempatinya <code>.*</code> ).  Dan dia mundur lagi. </p><br><p>  Kali ini grup pertama <code>.*</code> mengambil x pertama.  Tetapi kelompok kedua <code>.*</code> "Dengan rakus" menangkap <code>=x</code> .  Sudah menebak apa yang akan terjadi?  Mesin mencoba untuk mencocokkan literal <code>=</code> , gagal dan melakukan backtracking berikutnya. </p><br><p>   <code>.*</code>     <code>x</code> .  <code>.*</code>   <code>=</code> . ,      <code>=</code> ,       <code>.*</code> .   .         ! </p><br><p>     <code>.*</code>     <code>x</code> ,  <code>.*</code> â€”   ,      <code>=</code>   <code> =</code>  .    <code>.*</code>    <code>x</code> . </p><br><p> 23    <code>x=x</code> .      Perl <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Regexp::Debugger</a> ,  ,     . </p><br><p><img src="https://habrastorage.org/webt/a7/do/2n/a7do2nizluizhm1h2q2shajnvgs.gif"></p><br><p>    ,     <code>x=x</code>    <code>x=xx</code> ?  33 .   <code>x=xxx</code> ? 45.   .      <code>x=x</code>  <code>x=xxxxxxxxxxxxxxxxxxxx</code> (20 <code>x</code>  <code>=</code> ).    20 x  <code>=</code> ,     555 ! ( ,     <code>x=</code>      20 <code>x</code> ,   4067 ,  ,   ). </p><br><p><img src="https://habrastorage.org/webt/t-/1m/l4/t-1ml4up0y5w262eye_cyjmlik4.png"></p><br><p>         <code>x=xxxxxxxxxxxxxxxxxxxx</code> : </p><br><p><img src="https://habrastorage.org/webt/t8/oz/wq/t8ozwqwv1otujwl5_bebeglitpe.gif"></p><br><p>   ,         .      ,     . ,     <code>.*.*=.*</code> ; (         ). ,     ,  <code>foo=bar;</code>  . </p><br><p>       .   <code>x=x</code>  90 ,   23.     .   <code>x=</code>  20 <code>x</code> ,  5353 .  .      <code>Y</code>     . </p><br><p><img src="https://habrastorage.org/webt/kn/n9/ex/knn9exewj9a48-fkxyayefzexeu.png"></p><br><p>  ,   5353    <code>x=xxxxxxxxxxxxxxxxxxxx</code>  <code>.*.*=.*;</code> </p><br><p><img src="https://habrastorage.org/webt/d3/gg/ra/d3ggrayopot2-l7vivzm0fqfnmq.gif"></p><br><p>   Â«Â»,   Â«Â» ,    .      <code>.*?.*?=.*?</code> ,   <code>x=x</code>  11  (  23).    <code>x=xxxxxxxxxxxxxxxxxxxx</code> .  ,  <code>?</code>  <code>.*</code>      ,    . </p><br><p>  Â«Â»      .     <code>.*.*=.*;</code>  <code>.*?.*?=.*?;</code> ,    . <code>x=x</code>    555 ,  <code>x=</code>  20 <code>x</code> â€” 5353. </p><br><p> ,    (      ) â€”         .        . </p><br><p>       1968 ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Programming Techniques: Regular expression search algorithm</a> (Â« :    Â»).    ,         ,          ,        . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fd/nn/ri/fdnnril2lmr0udityqylanfzahk.png"></a> </p><br><blockquote> <strong>  <br>     <br>   (Ken Thompson)</strong> <br> Bell Telephone Laboratories, Inc., -,  - <br><br>                 .             IBM 7094    .               ,         .    ,   . <br><br> <strong></strong> <br>      ,       . <br><br>        .      .     â€”                  . <br>              . ,        . ,           . <br> ,           IBM 7094. <br><br> <strong></strong> <br>       .   â€”   ,       .       Â«Â·Â»    .         .      .  2  ,       . </blockquote><p>         ,           ALGOL-60,       IBM 7094.  ,     . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fx/se/9x/fxse9xv8le3pgp2quvsrufznvb8.png"></a> </p><br><blockquote>   .    âŠ•      . <br>   1          .      â€” a, b, c,      S[i]   NNODE. <br><br> NNODE   ,          (. . 5) </blockquote><p>       <code>.*.*=.*</code> ,   ,      . </p><br><p><img src="https://habrastorage.org/webt/mt/_5/lc/mt_5lcklo-jw2x6zmt8nwjg8hpy.png"></p><br><p>  . 0   ,   0,  3 ,     1, 2  3.      <code>.*</code>   . 3      .    <code>=</code>    <code>=</code> .  4  .    ,    . </p><br><p>  ,           <code>.*.*=.*</code> ,     <code>x=x</code> .     0,    . 1. </p><br><p><img src="https://habrastorage.org/webt/tx/a6/cl/txa6cltpurcbwxzrxk1v9ypkec4.png"></p><br><p>    ,        .        . </p><br><p>      ,       (1  2),    .  2. </p><br><p><img src="https://habrastorage.org/webt/ve/pb/nj/vepbnjljx-0cinc-eapaz17mths.png"></p><br><p>  . 2 ,  ,     <code>x</code>  <code>x=x</code> . <code>x</code>     ,    1     1.  <code>x</code>     ,    2     2. </p><br><p>    <code>x</code>  <code>x=x</code>  -   1  2.      3  4,       <code>=</code> . </p><br><p>    <code>=</code>  <code>x=x</code> .   x  ,              1    1    2   2,        <code>=</code>     2   3 (  4).    .  3. </p><br><p><img src="https://habrastorage.org/webt/0b/x8/7f/0bx87fp1aquszmn-wjp7ta3b4i0.png"></p><br><p>      <code>x</code>  <code>x=x</code> .   1  2        1  2.   3 <code>x</code>           3. </p><br><p>      <code>x=x</code> ,      4,     .     ,          .   . </p><br><p> ,     4 (   <code>x=</code> )    ,    ,    <code>x</code> . </p><br><p>        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id460863/">https://habr.com/ru/post/id460863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id460851/index.html">SamsPcbGuide, Bagian 10: Teknologi - Komponen Bebas Timah Solder</a></li>
<li><a href="../id460855/index.html">Bagaimana cara menggunakan PHP untuk mengimplementasikan layanan microser?</a></li>
<li><a href="../id460857/index.html">Bagaimana Namecoin Blockchain Research Memprediksi Serangan Cyber â€‹â€‹RTM</a></li>
<li><a href="../id460859/index.html">Konferensi IThink # 3 di Kharkov - berdasarkan WWDC 2019</a></li>
<li><a href="../id460861/index.html">Lingkup dan penutupan leksikal JavaScript</a></li>
<li><a href="../id460865/index.html">Orang-orang di bulan. Sumber</a></li>
<li><a href="../id460867/index.html">Sumber daya untuk secara otomatis dikonversi ke struktur objek Realm</a></li>
<li><a href="../id460869/index.html">Pengenalan objek waktu-nyata pada iOS menggunakan YOLOv3</a></li>
<li><a href="../id460873/index.html">Why Turok: Dinosaur Hunter untuk N64 adalah tahun-tahun sebelumnya</a></li>
<li><a href="../id460875/index.html">Bagaimana kami di QIWI sampai pada gaya interaksi yang umum antara View dan ViewModel dalam MVVM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>