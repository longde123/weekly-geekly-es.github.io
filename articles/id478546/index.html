<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ½â€ğŸ­ â˜ğŸ¼ ğŸ‘©ğŸ¿â€ğŸ³ Soket web Beberapa pengalaman dalam pengembangan dan operasi. Kami memodifikasi klien ğŸ‘ŒğŸ¾ ğŸ›¡ï¸ ğŸ¥£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya menyambut semua yang tertarik pada protokol ini, dan sebelumnya saya minta maaf atas catatan emosional saya yang terlalu berlebihan. Terlibat dal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Soket web Beberapa pengalaman dalam pengembangan dan operasi. Kami memodifikasi klien</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478546/">  Saya menyambut semua yang tertarik pada protokol ini, dan sebelumnya saya minta maaf atas catatan emosional saya yang terlalu berlebihan.  Terlibat dalam hal ini dengan tergesa-gesa (sebagaimana diperlukan), tetapi untuk waktu yang lama.  Dalam hal ini, praktik tertentu dalam merancang dan menggunakan teknologi ini telah menumpuk dan terbentuk.  Opsi implementasi layanan dijelaskan di <a href="https://habr.com/ru/post/344292/">sini</a> .  Sejak itu banyak air yang mengalir.  Prinsip dasar tetap sama, tetapi kode aplikasi itu sendiri telah mengalami modifikasi alami.  Di beberapa tempat, kesalahan tidak kritis ditemukan dan diperbaiki, di suatu tempat kontrol aliran program, daftar koneksi terbuka, dll dioptimalkan. <br><br>  Tetapi selain sisi server, seperti yang Anda tahu, ada sisi klien.  Dan di sini saya ingin berhenti lebih teliti dan menggambarkan apa yang harus saya hadapi dan apa yang bisa dipengaruhi.  Tentu saja, ketika menggunakan JavaScript, Anda tidak akan dapat terutama â€œbermain-mainâ€, karena semuanya sudah siap dan ditutup, tetapi Anda dapat memberi tahu sesuatu tentang klien Java. <br><br>  Tidak peduli seberapa bagus programmer Anda, selalu sulit untuk mengembangkan, menciptakan sesuatu yang unik, lalu men-debug sajak Anda sendiri.  Karena itu, pada suatu waktu saya menyerah pada godaan untuk menemukan sesuatu yang sudah siap, memungkinkan Anda untuk segera menggunakannya dalam proyek saya.  Kriteria pemilihan untuk modul jadi sederhana.  Saya ingin mendapatkan kode yang lengkap dan berfungsi di Jawa dengan overhead yang minimal. <br><a name="habracut"></a><br>  Sebagai yang terpilih, saya memilih modul menggunakan perpustakaan Apache.  Secara khusus, ini: <br><br><ul><li>  apache-mime4j-core-0.7.2.jar; </li><li>  httpclient-4.2.1.jar; </li><li>  httpcore-4.2.1.jar; </li><li>  httpmime-4.2.1.jar. </li></ul><br>  Apa yang bisa dikatakan tentang penggunaannya?  Perangkat lunak Apache selalu terkenal dengan keandalan, kecanggihan, dan optimalitasnya.  Klien untuk Android bekerja dengan sukses.  Ukuran file * .apk yang sudah selesai tidak terlalu besar.  Tidak ada keluhan khusus tentang pekerjaan perpustakaan ini.  Tapi hidup selalu lebih pintar dari kita.  Dan waktu (dan periode ini sekitar empat hingga lima tahun) membuat penyesuaian sendiri.  Aplikasi ini ditulis ketika ada versi Android 4.2 - 4.4.  Dan kebutuhan untuk solusi baru sudah muncul tahun ini, ketika perangkat dengan versi 10 sudah berjalan lancar. <br><br>  Pengembangan dilakukan pada saat itu di Eclipse untuk Windows 7. Memperbarui Android SDK ke tingkat yang diinginkan menyebabkan fakta bahwa hard drive SSD 128 GB penuh.  Saya harus beralih ke Android Studio.  Selain itu, saya harus mengubah sistem operasi dasar.  Saya mencoba menginstal Ubuntu (saya tidak ingat nomor versi) dan sudah menggunakan Studio di lingkungan ini.  Tetapi sekali lagi, kegagalan, Andriod Studio dengan keras kepala tidak mau menginstal. <br><br>  Kenapa - sudah dilupakan.  Pada akhirnya, atas saran teman-teman, saya menginstal versi terbaru Linux-Mint, dan, lihatlah, toolkit berbaring di atasnya tanpa keluhan.  Lalu apa yang sebenarnya terjadi, justru karena semua rincian ini dijelaskan, yaitu, tes menulis rutin. <br><br>  Jadi, apa yang diharapkan dari tyagomotin ini?  Mari kita mulai dengan fakta bahwa dari situs resmi Apache menyalin lebih banyak versi saat ini dari perpustakaan di atas.  Menambahkannya ke proyek dan ... Dan kesalahan kompilasi jatuh.  Waktu telah berlalu, antarmuka kelas telah berubah.  Jadi saya harus (karena kurangnya waktu untuk mempelajari perpustakaan baru) untuk kembali ke versi lama.  Tapi ... <br><br>  Tetapi sekali lagi, kami tidak mencari cara yang mudah.  Saya pikir, mengapa saya membutuhkan perpustakaan ini sepenuhnya?  Teks dari paket ini adalah.  Bagaimana jika Anda mengambil dan menarik hanya kelas yang diperlukan dari mereka?  Selain itu, ketika mempertimbangkan teks modul untuk bekerja dengan soket web, Anda hanya bisa melihat dua kelas dari perpustakaan ini. <br><br>  Jadi saya membuat proyek baru, dan mulai menambahkan kelas yang diperlukan.  Dan pada akhirnya ternyata bahwa untuk kompilasi yang sukses perlu untuk menarik 32 kelas.  Namun, ya, proyek itu berhasil.  Semuanya bernafas.  Koneksi ke layanan soket web berhasil.  Dan semuanya akan baik-baik saja, tetapi memperhatikan peristiwa berikut, tidak dapat dipahami oleh saya.  Saat menutup koneksi, modul yang bertanggung jawab untuk koneksi melemparkan pengecualian: <br><br>  java.io.EOFException <br>  di java.io.DataInputStream.readByte (DataInputStream.java:77) <br>  di com.example.wsci.HybiParser.start (HybiParser.java:112) <br>  di com.example.wsci.WebSocketClient $ 1.run (WebSocketClient.java:144) <br>  di java.lang.Thread.run (Thread.java:818) <br><br>  Saya bingung.  Berikut bingung.  Koneksi ke server berhasil.  Paket berhasil datang dan pergi.  Tapi, mengapa penutupan itu membuat pengecualian?  Apalagi semuanya standar di server.  Jelas, di suatu tempat dalam teks, klien memiliki beberapa hal yang mempengaruhi penutupan.  Selain itu, teks-teks tersebut menunjukkan fitur seperti itu.  Menurut <a href="https://tools.ietf.org/html/rfc6455">klausa 7.1.1 dokumen,</a> penutupan di sisi klien tidak hanya terdiri dari memanggil metode close (), tetapi juga dalam membentuk dan mengirim paket dengan kode operasi 8 (operasi penutupan).  Dalam hal ini, server akan mengirim paket penutupannya, setelah itu klien akan menutup koneksi.  Namun dalam kasus kami, urutan panggilan seperti itu tidak diamati.  Itu hanya disebut fungsi dekat dan hanya itu.  Secara umum, ada sesuatu untuk dipikirkan.  Dan semakin saya mengintip dan mempelajari teks-teks modul ini dengan parser paket, semakin saya tidak menyukainya, semakin saya memiliki keinginan untuk menulis ulang dengan visi protokol ini.  Pada akhirnya, diputuskan untuk melakukan "prestasi buruh" ini. <br><br>  Apa yang sebenarnya tidak sesuai, apa yang menyebabkan "protes sipil" dalam modul-modul ini?  Pertama, organisasi interaksi antara modul koneksi langsung dengan server dan paket parser.  Ternyata modul koneksi berinteraksi dengan server, menghasilkan pengurai yang diteruskan ke parameter itu sendiri sebagai parameter.  Akibatnya, parser didelegasikan wewenang untuk membuat keputusan tentang acara jaringan yang akan datang.  Dalam hal ini, muncul pertanyaan, tetapi apakah itu baik?  Bukankah lebih baik jika modul parser akan memenuhi misinya masing-masing, mengembalikan hasil kerjanya, tetapi keputusan kontrol tentang peristiwa akan dieksekusi oleh objek yang menghasilkan parser?  Dalam hal ini, hirarki interaksi yang ketat antara objek akan ditentukan.  (Di sini, tentu saja, Anda dapat memperdebatkan apa yang lebih baik - hierarki atau jaringan, tetapi kemudian kami menjauh dari topik.) <br><br>  Hal kedua yang membuat saya ingin menulis ulang semuanya adalah struktur parser.  Objek ini (kelas) harus memenuhi dua fungsi utama, yaitu, untuk membentuk paket data untuk transmisi ke server dan parsing paket yang diterima dari server.  Jadi, dua fungsi inilah yang tidak cocok, pada umumnya.  Dan inilah masalahnya. <br><br>  Bayangkan suatu peristiwa jaringan telah terjadi, sebuah paket telah tiba.  Apa yang dilakukan HybiParser dalam kasus ini?  Objek ini membaca dua byte pertama dari aliran input soket dengan byte dan menentukan tindakan selanjutnya: mem-parsing ukuran data, mask, dll.  Sebagai hasilnya, ini diimplementasikan dalam beberapa operasi baca dari aliran input soket.  Selain itu, penguraian menjadi rumit dengan membaca tahapan, yang selanjutnya memperumit algoritma.  Dan sekali lagi muncul pertanyaan, apakah benar, mengapa kesulitan seperti itu?  Bukankah lebih baik menganggap paket sebagai satu operasi, terutama karena ukuran data yang masuk dapat ditentukan? <br><br>  Yang ketiga.  Tampaknya satu aspek lagi yang kontroversial dari pekerjaan parser adalah siklus penerimaan paket "abadi".  Siklus berjalan dalam aliran program terpisah.  Pada titik tertentu, soket ditutup.  Apa selanjutnya, penanganan pengecualian yang biasa?  Atau apa yang harus dilakukan?  Tidak, saya tidak menentang mekanisme pengecualian, tetapi alangkah baiknya untuk meramalkan keadaan ini dan reaksi terhadapnya sebelumnya.  Misalnya, dimungkinkan untuk mengusulkan mekanisme sinkronisasi sebagai solusi, di mana penyelesaian siklus secara teratur dan, karenanya, aliran program akan terjadi. <br><br>  Sebagai hasil dari evaluasi semua nuansa ini, persyaratan berikut untuk desain modul yang diperlukan ditentukan: <br><br><ul><li>  Modul harus independen dari perpustakaan pihak ketiga; </li><li>  Modul harus sederhana dan mudah diintegrasikan ke dalam proyek lain; </li><li>  Modul harus siap untuk ekspansi fungsional di masa depan. </li></ul><br>  Nah, dan agar tidak disalahkan atas kritik berlebihan terhadap solusi yang sudah jadi, kami menambahkan ini juga bahwa bagian dari fungsi siap pakai dan tidak mengkritik dapat ditransfer dengan aman ke implementasi baru.  Yah, itu saja, dan seperti yang mereka katakan di Kongres XXII CPSU: â€œTujuan kami jelas, tugasnya ditentukan.  Untuk bekerja, kawan!  Demi kemenangan baru komunisme! " <br><br>  Secara umum, agar tidak membebani Anda, pembaca yang budiman, untuk tidak mengambil waktu berharga Anda, saya akan menjelaskan secara singkat proposal saya dan hanya fokus pada poin-poin penting. <br>  Jadi, implementasi yang diusulkan hanya berisi empat modul (sesuai dengan persyaratan di atas dari perpustakaan Apache atau kelas individu dari mereka tidak termasuk dalam proyek): <br><br><ul><li>  WebSocket protocol 07 modul konstanta global; </li><li>  Kelas pengecualian pembantu; </li><li>  Klien soket web; </li><li>  Modul untuk parsing paket tingkat protokol WebSocket 07. </li></ul><br>  Dalam dua modul pertama, implementasinya sepele, tidak ada yang perlu dipertimbangkan.  Modul klien mengimplementasikan kontrol atas koneksi ke server, dan saya ingin membahas beberapa hal berikut.  Fungsi koneksi terbuka memiliki loop header yang datang dari server.  Di sini, parsing kunci Sec-WebSocket-Accept sebenarnya diimplementasikan, dan dalam kasus kami, parsing dilakukan tanpa menggunakan pustaka Apache. <br><br>  Selanjutnya, perhatikan fungsi kontrol loop paket.  Implementasinya sepele, melalui objek sinkronisasi. <br><br>  Titik selanjutnya yang harus dihormati adalah fungsi loop.  Siklusnya tidak "abadi", tetapi dengan jalan keluar dalam kondisi memeriksa objek sinkronisasi.  Dalam satu siklus, paket yang tiba dibaca dalam satu operasi.  Paket diuraikan oleh objek yang sesuai untuk parsing.  Selanjutnya, keputusan manajemen dibuat pada acara jaringan yang akan datang. <br><br>  Untuk melengkapi deskripsi, kami mencatat fungsi mengakhiri sambungan dengan aman.  Ini dilakukan sebagai berikut.  Paket penghentian koneksi dikirim ke server dan variabel kelas Runnable dihasilkan, yang kemudian ditempatkan dalam prosesor antrian untuk dieksekusi melalui fungsi postDelayed, salah satu parameter di antaranya adalah keterlambatan pengoperasian dalam milidetik.  Dalam variabel Runnable, fungsi run berisi urutan panggilan ketika aliran program berakhir dan koneksi ke server ditutup.  Jika paket respons penutupan tiba lebih awal, posisi ini dalam daftar pemrosesan dihapus. <br><br>  Kelas yang mengimplementasikan analisis paket WebSocket berisi dua metode yang memerlukan perhatian: penguraian sendiri dan pembentukan paket untuk transmisi sesuai dengan parameter yang relevan.  Saat parsing, semua flag dan data dari paket yang diterima disimpan di depan umum, variabel kelas.  Mengapa publik?  Ya, untuk kesederhanaan, agar tidak membuat fungsi get / set tambahan untuk mereka. <br><br>  Sebenarnya pembaca yang baik.  Arsip dengan proyek untuk Android Studio <a href="https://yadi.sk/d/TAODjdYRpyWl5Q">terlampir</a> .  Saya tidak akan mengklaim penggunaan teks-teks ini dalam proyek Anda.  Kritik konstruktif diterima.  Jawab pertanyaan sejauh mungkin. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id478546/">https://habr.com/ru/post/id478546/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id478536/index.html">WebRTC melalui Kurento: Pengalaman Pengujian dan Implementasi</a></li>
<li><a href="../id478538/index.html">Cara memeriksa validitas paspor Anda</a></li>
<li><a href="../id478540/index.html">Persiapan untuk forum kesepuluh "Positive Hack Days 10: Memulai"</a></li>
<li><a href="../id478542/index.html">FigmaGen: Otomasi Gaya di Aplikasi iOS</a></li>
<li><a href="../id478544/index.html">Vue Storefront: Impor Direktori dari Magento 2</a></li>
<li><a href="../id478550/index.html">Bagaimana cara mengatur jam tangan? Analisis trek front-end kejuaraan pemrograman kedua</a></li>
<li><a href="../id478552/index.html">Applet kedua, menutupnya dan tombol transparan dalam Memproses 3</a></li>
<li><a href="../id478554/index.html">Webinar "SRE - sensasi atau masa depan?" 12 Desember pukul 11:00</a></li>
<li><a href="../id478560/index.html">Apakah pengirim pesan instan gratis anonim?</a></li>
<li><a href="../id478564/index.html">Bagaimana kami di TsIAN menjinakkan terabyte log</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>