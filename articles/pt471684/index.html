<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìö üë©üèΩ‚Äçüíª üë®‚Äçüë®‚Äçüëß‚Äçüëß Por que voc√™ precisa criar m√≥dulos para o nginx üôÖüèæ üìµ üë®üèª‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Nginx √© um servidor Web que resolve dezenas de tarefas de neg√≥cios, √© configurado de forma flex√≠vel, dimensionado e funciona em quase todos os siste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Por que voc√™ precisa criar m√≥dulos para o nginx</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/471684/">  O Nginx √© um servidor Web que resolve dezenas de tarefas de neg√≥cios, √© configurado de forma flex√≠vel, dimensionado e funciona em quase todos os sistemas operacionais e plataformas.  Uma lista de recursos, capacidades e problemas a serem resolvidos imediatamente pode ser descrita em uma pequena brochura.  Mas, √†s vezes, v√°rias tarefas de neg√≥cios podem ser resolvidas apenas desenvolvendo seus pr√≥prios m√≥dulos para o nginx.  Esses s√£o m√≥dulos orientados aos neg√≥cios e cont√™m alguma l√≥gica comercial, e n√£o apenas uma solu√ß√£o de sistema generalizada. <br><br><img src="https://habrastorage.org/webt/_g/qx/cl/_gqxcl-ni0gc2f2rsr7thf4tici.jpeg"><br><br>  Em geral, tudo no nginx s√£o m√≥dulos que foram escritos por algu√©m.  Portanto, escrever m√≥dulos no nginx n√£o √© apenas poss√≠vel, mas tamb√©m necess√°rio.  Quando √© necess√°rio faz√™-lo e por qu√™, <strong>Vasily Soshnikov</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">dedokOne</a> ) conta o exemplo de v√°rios casos. <br><br>  Vamos falar sobre os motivos que incentivam a escrita de m√≥dulos em C, a arquitetura e o n√∫cleo do nginx, a anatomia dos m√≥dulos HTTP, os m√≥dulos C, NJS, Lua e nginx.conf.  √â importante saber n√£o apenas para quem se desenvolve no nginx, mas tamb√©m para quem usa o nginx-configs, Lua ou outra linguagem dentro do nginx. <br><br>  <em>Nota: o artigo √© baseado em um relat√≥rio de Vasily Soshnikov.</em>  <em>O relat√≥rio est√° sendo constantemente atualizado e atualizado.</em>  <em>As informa√ß√µes no material s√£o bastante t√©cnicas e, para aproveitar ao m√°ximo, os leitores precisam ter experi√™ncia trabalhando com o c√≥digo nginx em um n√≠vel m√©dio e acima.</em> <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/82CyWPpjNNY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  Brevemente sobre nginx </h2><br>  <strong>Tudo o que voc√™ usa com o nginx s√£o os m√≥dulos</strong> .  Cada diretiva na configura√ß√£o do nginx √© um m√≥dulo separado, que foi cuidadosamente escrito por colegas da comunidade nginx. <br><br>  <strong>As diretivas no nginx.conf tamb√©m s√£o m√≥dulos</strong> que resolvem um problema espec√≠fico.  Portanto, nos m√≥dulos nginx s√£o tudo.  add_header, proxy_pass, qualquer diretiva - estes s√£o m√≥dulos ou combina√ß√µes de m√≥dulos que funcionam de acordo com certas regras. <br><br>  <strong>O Nginx √© uma estrutura</strong> que possui: E / S de rede e arquivos, mem√≥ria compartilhada, configura√ß√£o e script.  Essa √© uma enorme camada de bibliotecas de baixo n√≠vel, nas quais voc√™ pode fazer qualquer coisa para trabalhar com as unidades de rede. <br><br>  <strong>O Nginx √© r√°pido e est√°vel, mas complexo</strong> .  Voc√™ deve escrever esse c√≥digo para n√£o perder essas qualidades do nginx.  Nginx inst√°vel na produ√ß√£o s√£o clientes insatisfeitos, e tudo o que se segue disso. <br><br><h2>  Por que criar seus pr√≥prios m√≥dulos </h2><br>  <strong>Converta o protocolo HTTP em outro protocolo.</strong>  Esse √© o principal motivo que muitas vezes motiva a cria√ß√£o de um m√≥dulo espec√≠fico. <br><br>  Por exemplo, o m√≥dulo memcached_pass converte HTTP em outro protocolo e voc√™ pode trabalhar com outros sistemas externos.  O m√≥dulo proxy_pass tamb√©m permite a convers√£o, embora de HTTP (s) para HTTP (s).  Outro bom exemplo √© o fastcgi_pass. <br><br>  Estas s√£o todas as diretrizes do formul√°rio: "v√° para tal e qual back-end, onde n√£o HTTP (mas no caso do proxy_pass HTTP)." <br><br>  <strong>Inser√ß√£o din√¢mica de conte√∫do: desvio do AdBlock, inser√ß√£o de an√∫ncio.</strong>  Por exemplo, temos um back-end e √© necess√°rio modificar o conte√∫do que vem dele.  Por exemplo, o AdBlock, que analisa o c√≥digo de inser√ß√£o de an√∫ncios e precisamos lidar com ele - para ajust√°-lo de uma maneira ou de outra. <br><br>  Outra coisa que voc√™ costuma fazer para incorporar conte√∫do √© o problema com o cache do HLS.  Quando os par√¢metros s√£o armazenados em cache no HLS, dois usu√°rios podem obter a mesma sess√£o ou os mesmos par√¢metros.  A partir da√≠, voc√™ recorta ou adiciona alguns par√¢metros quando precisa rastrear alguma coisa. <br><br>  <strong>Coleta de dados de fluxo de cliques dos medidores da Internet / dispositivos m√≥veis.</strong>  Um caso popular na minha pr√°tica.  Geralmente, isso √© feito no nginx, mas n√£o no access.log, mas um pouco mais inteligente. <br><br>  <strong>Convertendo todos os tipos de conte√∫do.</strong>  Por exemplo, o m√≥dulo rtmp para permite trabalhar n√£o apenas com o rtmp, mas tamb√©m com o HLS.  Este m√≥dulo pode fazer muito com conte√∫do de v√≠deo. <br><br>  <strong>Ponto de autoriza√ß√£o gen√©rico: SEP ou Api Gateway.</strong>  √â o caso quando o nginx funciona como parte da infraestrutura: autoriza, coleta m√©tricas, envia dados para monitoramento e ClickStream.  O Nginx funciona aqui como um hub de infraestrutura - um √∫nico ponto de entrada para back-end. <br><br>  <strong>Enriquecimento de pedidos para seu rastreio subsequente.</strong>  Os sistemas modernos s√£o muito complexos, com v√°rios tipos de back-end que formam equipes diferentes.  Como regra, eles s√£o dif√≠ceis de estrear, √†s vezes √© at√© dif√≠cil entender de onde veio a solicita√ß√£o e para onde foi.  Para simplificar a depura√ß√£o, algumas grandes empresas usam uma t√©cnica complicada - elas adicionam certos dados √†s solicita√ß√µes.  O usu√°rio n√£o os ver√°, mas a partir desses dados √© f√°cil rastrear o caminho da solicita√ß√£o dentro do sistema.  Isso √© chamado de <strong>rastreamento</strong> . <br><br>  <strong>Proxy S3.</strong>  Este ano, muitas vezes vejo pessoas trabalhando com seus objetos atrav√©s do s3.  Mas n√£o √© necess√°rio fazer isso nos m√≥dulos C, a infraestrutura tamb√©m √© suficiente no nginx.  Para resolver alguns desses problemas, voc√™ pode usar Lua, algo est√° sendo resolvido no NJS.  Mas √†s vezes √© necess√°rio escrever m√≥dulos em C. <br><br><h2>  Quando √© a hora de criar m√≥dulos </h2><br>  Existem dois crit√©rios para entender que chegou a hora. <br><br>  <strong>Generaliza√ß√£o de funcionalidade.</strong>  Quando voc√™ entender que outra pessoa precisa do seu produto, estar√° contribuindo com o C√≥digo Aberto, criando funcionalidades generalizadas, publicando-as e permitindo que sejam usadas. <br><br>  <strong>Resolvendo problemas de neg√≥cios.</strong>  Quando uma empresa define esses requisitos que podem ser satisfeitos apenas escrevendo seu pr√≥prio m√≥dulo para o nginx.  Por exemplo, inser√ß√£o din√¢mica / altera√ß√£o de conte√∫do, a cole√ß√£o ClickStream pode ser feita em Lua, mas provavelmente n√£o funcionar√° normalmente. <br><br><h2>  Arquitetura Nginx </h2><br>  Eu tenho escrito c√≥digo nginx por um longo tempo.  Nove dos meus m√≥dulos est√£o girando em produ√ß√£o, um deles em c√≥digo aberto e em produ√ß√£o para muitos.  Portanto, tenho experi√™ncia e entendimento. <br><blockquote>  Nginx √© uma boneca de nidifica√ß√£o, na qual tudo √© constru√≠do em torno do kernel. </blockquote>  Ent√£o eu entendo nginx. <br><blockquote>  Core s√£o inv√≥lucros sobre epoll. </blockquote>  Epoll √© um m√©todo que permite trabalhar de forma ass√≠ncrona com qualquer arquivo descritor, n√£o apenas soquetes, porque um descritor n√£o √© apenas um soquete. <br><br>  Acima do n√∫cleo est√£o upstreams, HTTP e scripts.  Por script, quero dizer nginx.conf, n√£o NJS.  Al√©m dos fluxos upstream, HTTP e scripts, os m√≥dulos HTTP j√° foram criados, sobre os quais falaremos. <br><br><img src="https://habrastorage.org/webt/d7/b6/ff/d7b6ffhplgm4ddkbvncbfh4umym.jpeg"><br><br>  Um exemplo cl√°ssico de upstreams e HTTP s√£o servidores upstream - diretivas dentro da configura√ß√£o.  Um exemplo de m√≥dulo para HTTP √© add_header.  Um exemplo de script √© o pr√≥prio arquivo de configura√ß√£o.  O arquivo cont√©m os m√≥dulos nos quais o nginx consiste; ele √© interpretado de alguma forma e permite que voc√™ fa√ßa algo como administrador ou como usu√°rio. <br><br>  N√£o consideraremos o n√∫cleo e nos deteremos muito brevemente nas correntes ascendentes, porque √© um universo separado dentro do nginx.  A hist√≥ria sobre eles √© digna de v√°rios artigos. <br><br><h2>  Anatomia de m√≥dulos HTTP </h2><br>  Mesmo se voc√™ n√£o escrever o c√≥digo C dentro do nginx, mas us√°-lo, lembre-se da regra principal. <br><blockquote>  No nginx, tudo obedece ao padr√£o da Cadeia de Responsabilidade - COR. </blockquote>  N√£o sei como traduzir isso para o russo, mas descreverei a l√≥gica.  Sua solicita√ß√£o passa por uma gal√°xia de m√≥dulos de cadeia configurados, a partir do local.  Cada um desses m√≥dulos retorna um resultado.  Se o resultado for ruim, a cadeia √© interrompida. <br><br><img src="https://habrastorage.org/webt/ky/sf/zj/kysfzj-evntyaf8v8q53ygxgrr4.jpeg"><br><br>  Ao desenvolver m√≥dulos ou usar alguma diretiva no NJS e Lua, n√£o esque√ßa que seu c√≥digo pode travar a execu√ß√£o dessa cadeia. <br><br>  A analogia mais pr√≥xima da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cadeia de Responsabilidade</a> √© uma linha de c√≥digo Bash: <br><br><pre><code class="bash hljs">grep -RI pool nginx | awk -F<span class="hljs-string"><span class="hljs-string">":"</span></span> <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> | sort -u | wc -l</code> </pre> <br>  No c√≥digo, tudo √© bem simples: se o AWK cair no meio da linha, a <code>sort</code> e os seguintes comandos n√£o ser√£o executados.  O m√≥dulo nginx funciona da mesma forma, mas a verdade est√° no nginx e voc√™ pode contornar isso - reinicie o c√≥digo.  Mas voc√™ deve estar preparado para travar e executar, assim como seus m√≥dulos que voc√™ usa na configura√ß√£o, mas n√£o o fato de que √© assim. <br><br><h3>  Tipos de m√≥dulos HTTP </h3><br><blockquote>  HTTP e nginx s√£o um monte de PHASEs diferentes. </blockquote><br><ul><li>  <strong>Manuseio de fases - manipuladores PHASE</strong> . </li><li>  <strong>Filtros - Filtros de corpo / cabe√ßalhos</strong> .  Essa filtragem √© um cabe√ßalho ou um corpo de solicita√ß√£o. </li><li>  <strong>Proxies</strong> .  M√≥dulos de proxy t√≠picos s√£o proxy_pass, fastcgi_pass, memcached_pass. </li><li>  <strong>M√≥dulos para balanceamento de carga espec√≠fico - Balanceadores de carga</strong> .  Este √© o tipo de m√≥dulo mais torcido, eles n√£o est√£o sendo desenvolvidos muito.  Um exemplo √© o m√≥dulo Ketama CHash, que permite fazer hash consistente dentro do nginx para distribuir solicita√ß√µes para back-end. </li></ul><br>  Vou contar sobre cada um desses tipos e seus prop√≥sitos. <br><br><h3>  Manipuladores de fase </h3><br>  Imagine que temos v√°rias fases, come√ßando na fase de acesso.  Existem v√°rios m√≥dulos em cada fase.  Por exemplo, a fase ACCESS √© dividida em uma conex√£o, uma solicita√ß√£o ao nginx, verifica√ß√£o da autoriza√ß√£o do usu√°rio.  Cada m√≥dulo √© uma c√©lula da cadeia.  Pode haver um n√∫mero infinito desses m√≥dulos em fase. <br><br><img src="https://habrastorage.org/webt/pn/6b/t9/pn6bt9m3khwxmsxgnqjvyzwfcb0.jpeg"><br><br>  O √∫ltimo manipulador final √© a fase CONTENT em que o conte√∫do √© entregue sob demanda. <br><blockquote>  O caminho √© sempre o seguinte: request - uma cadeia de manipuladores - conte√∫do de sa√≠da. </blockquote>  Fases dispon√≠veis para desenvolvedores de m√≥dulos das <a href="https://github.com/nginx/nginx/blob/master/src/http/ngx_">fontes NGINX</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { NGX_HTTP_POST_READ_PHASE = <span class="hljs-number"><span class="hljs-number">0</span></span>, NGX_HTTP_SERVER_REWRITE_PHASE, NGX_HTTP_FIND_CONFIG_PHASE, NGX_HTTP_REWRITE_PHASE, NGX_HTTP_POST_REWRITE_PHASE, NGX_HTTP_PREACCESS_PHASE, NGX_HTTP_ACESS_PHASE, NGX_HTTP_POST_ACESS_PHASE, NGX_HTTP_PRECONTENT_PHASE, NGX_HTTP_CONTENT_PHASE, NGX_HTTP_LOG_PHASE, } ngx_http_phases;</code> </pre> <br>  As fases podem ser substitu√≠das, adicione seu pr√≥prio manipulador.  Nem todos eles s√£o necess√°rios na vida real, se voc√™ n√£o √© o desenvolvedor do nginx core.  Portanto, n√£o falarei sobre cada fase, mas apenas sobre as principais que usei. <br><br>  O principal √© <strong>ACCESS_PHASE.</strong>  √â especialmente √∫til adicionar sua autoriza√ß√£o ao nginx - para verificar a execu√ß√£o da solicita√ß√£o em termos de acesso. <br><br>  As pr√≥ximas fases importantes que frequentemente exploro s√£o as fases de pr√©-conte√∫do e conte√∫do.  <strong>PRECONTENT_PHASE</strong> permite coletar m√©tricas sobre o conte√∫do que ser√° enviado como resposta ao cliente.  <strong>CONTENT_PHASE</strong> permite gerar seu pr√≥prio conte√∫do exclusivo com base em algo. <br><br>  A √∫ltima fase que costumo usar √© a fase de log <strong>LOG_PHASE.</strong>  Ali√°s, a diretiva ACCESS_LOG funciona nela.  A fase de log tem as restri√ß√µes mais loucas que me deixam louco: voc√™ n√£o pode usar sub-requisi√ß√µes e geralmente n√£o pode usar nenhuma solicita√ß√£o.  Voc√™ j√° deixou o conte√∫do para o usu√°rio, e manipuladores, manipuladores de postagens e qualquer sub-solicita√ß√£o n√£o ser√£o executados. <br><br>  Vou explicar por que √© chato.  Digamos quando voc√™ deseja cruzar nginx e Kafka na fase de cria√ß√£o de log.  Nesta fase, tudo j√° foi conclu√≠do: existe um tamanho calculado do conte√∫do, status, todos os dados, mas voc√™ n√£o pode fazer uma sub-solicita√ß√£o.  Eles n√£o trabalham l√°.  Voc√™ precisa escrever em soquetes nus na fase de registro para enviar dados ao Kafka. <br><br><h3>  Filtros de corpo / cabe√ßalhos </h3><br>  Existem dois tipos de filtros: filtros corporais e filtros de cabe√ßalhos. <br><br>  Um exemplo de <strong>filtro Body</strong> √© o m√≥dulo de filtro gzip.  Por que s√£o necess√°rios filtros corporais?  Imagine que voc√™ tem um determinado proxy_pass e deseja transformar o conte√∫do ou analis√°-lo.  Nesse caso, voc√™ deve usar o filtro Corpo. <br><br>  Funciona assim: muitos peda√ßos chegam at√© voc√™, voc√™ faz algo com eles, olha o conte√∫do, agrega, etc.  Mas o filtro tamb√©m tem limita√ß√µes significativas.  Por exemplo, se voc√™ decidir alterar o corpo - para inserir ou cortar o corpo da resposta, lembre-se de que os atributos HTTP, por exemplo, um feed de conte√∫do, ser√£o substitu√≠dos.  Isso pode levar a efeitos estranhos se voc√™ n√£o fornecer restri√ß√µes e refletir corretamente no seu c√≥digo. <br><br>  Um exemplo de <strong>filtro de cabe√ßalho</strong> √© o add_header que todos usaram.  O algoritmo funciona como no filtro Corpo.  Uma resposta √© preparada para o cliente, e o filtro add_header permite fazer algo: adicionar cabe√ßalho, excluir cabe√ßalho, substituir cabe√ßalho, enviar sub-solicita√ß√£o. <br><br>  A prop√≥sito, nas sub-solicita√ß√µes do filtro Corpo e no filtro Cabe√ßalho, voc√™ pode at√© enviar identifica√ß√µes internas para um local adicional. <br><br><h3>  Proxy </h3><br>  Esse √© o tipo de m√≥dulo mais complexo e controverso que permite proxy de solicita√ß√µes para sistemas externos, por exemplo, <strong>converter HTTP para outro protocolo</strong> .  Exemplos: proxy_pass, redis_pass, tnt_pass. <br><br>  Proxy √© uma interface que os desenvolvedores principais do nginx propuseram para facilitar a grava√ß√£o de m√≥dulos proxy.  Se isso for feito da maneira cl√°ssica, ser√£o executados, para os manipuladores PHASES, filtros, filtros e balanceadores.  No entanto, se o protocolo no qual voc√™ deseja converter o HTTP for diferente dos cl√°ssicos, grandes problemas come√ßar√£o.  A API de proxy fornecida pelo nginx simplesmente n√£o √© adequada - voc√™ precisa inventar esse m√≥dulo de proxy do zero. <br><br>  Um bom exemplo desse m√≥dulo √© o postgres_pass.  Ele permite que o nginx se comunique com o PostgreSQL.  O m√≥dulo n√£o usa a interface que foi desenvolvida no nginx - ele possui seu pr√≥prio caminho. <br><blockquote>  Lembre-se de proxy, mas de prefer√™ncia n√£o escreva.  Para escrever proxy, voc√™ ter√° que aprender todo o nginx de cor - √© muito longo e dif√≠cil. </blockquote><br><h3>  Balanceadores de carga </h3><br>  A tarefa dos balanceadores de carga √© muito simples - trabalhar no modo round robin.  Imagine que voc√™ tenha uma se√ß√£o upstream, alguns servidores, especifique pesos e m√©todos de balanceamento.  Este √© um balanceador de carga t√≠pico. <br><br>  Este modo nem sempre √© adequado.  Portanto, o m√≥dulo Ketama CHash foi desenvolvido, onde √© poss√≠vel obter condicionalmente uma solicita√ß√£o de hash consistente para algum servidor.  √Äs vezes √© conveniente.  O Nginx Lua oferece balancer_by_lua.  Em Lua, voc√™ pode escrever qualquer balanceador em geral. <br><br><h2>  M√≥dulos C </h2><br>  A seguir, minha opini√£o absolutamente subjetiva sobre o desenvolvimento de m√≥dulos C.  Para come√ßar - minhas regras subjetivas. <br><br>  <strong>O m√≥dulo inicia com as diretivas nginx.conf.</strong>  Mesmo se voc√™ estiver criando um m√≥dulo C que ser√° operado apenas pela sua empresa, sempre pense nas diretrizes.  Comece a projetar o m√≥dulo com eles, porque √© com isso que o administrador do sistema se comunicar√°.  Isso √© importante - coordene todas as nuances com ele ou com a pessoa que ir√° operar o seu m√≥dulo C.  NGINX √© um produto conhecido, suas diretrizes obedecem a certas leis que os administradores de sistemas conhecem.  Portanto, sempre pense sobre isso. <br><br>  <strong>Use o estilo de c√≥digo nginx.</strong>  Imagine que seu m√≥dulo ser√° suportado por outra pessoa.  Se ele j√° estiver familiarizado com o nginx e seu estilo de c√≥digo, ser√° muito mais f√°cil para ele ler e entender seu c√≥digo. <br><br>  Recentemente, um bom amigo da Alemanha me pediu para ajud√°-lo a lidar com um bug dentro de seu c√≥digo nginx.  N√£o sei para qual estilo de c√≥digo ele o escreveu, mas n√£o conseguia ler o c√≥digo normalmente. <br><br>  <strong>Use o pool de mem√≥ria correto.</strong>  Sempre tenha isso em mente, mesmo se voc√™ tiver muita experi√™ncia com o nginx.  Um erro t√≠pico de um desenvolvedor iniciante de m√≥dulo C para o nginx √© obter o pool errado. <br><br>  Um pouco de hist√≥rico: o nginx geralmente usa a ideologia de alocadores fracos.  Voc√™ pode usar o malloc l√°, mas n√£o √© recomendado.  Ele tem suas pr√≥prias lajes, seu pr√≥prio alocador de mem√≥ria, voc√™ precisa us√°-lo.  Assim, cada objeto tem um link para seu pool, e esse pool precisa ser usado.  Um erro t√≠pico de iniciante √© usar uma conex√£o de pool no filtro de cabe√ßalho, n√£o uma solicita√ß√£o de pool.  Isso significa que, se tivermos uma conex√£o keep-alive, o pool inchar√° at√© ficar sem mem√≥ria ou outros efeitos colaterais.  Portanto, √© importante. <br><br>  Al√©m disso, esses erros s√£o extremamente dif√≠ceis de estrear.  Valgrind ("syshniks" entender√°) n√£o funciona com aloca√ß√£o de laje - mostra uma imagem estranha. <br><br>  <strong>N√£o use E / S de bloqueio.</strong>  Um erro t√≠pico de quem deseja aplicar algo externo mais r√°pido √© usar E / S de bloqueio e soquetes de bloqueio.  Voc√™ nunca pode fazer isso no nginx - existem muitos processos, mas cada processo usa um thread. <br><br>  Voc√™ pode fazer multi-threading, mas, como regra, isso s√≥ piora as coisas.  Se voc√™ usar E / S de bloqueio em uma arquitetura desse tipo, todos estar√£o esperando por essa pe√ßa de bloqueio. <br><br>  Vou decifrar o que disse acima. <br><br><h3>  O m√≥dulo come√ßa com as diretivas nginx.conf </h3><blockquote>  Decida em quais matrizes sua diretiva deve estar: Principal, Servidor, HTTP, local, local se. </blockquote>  Tente evitar a localiza√ß√£o se - como regra, isso leva a um uso muito estranho da configura√ß√£o do nginx. <br><br>  Todas as diretivas no nginx vivem em diferentes contextos e em diferentes escopos.  A diretiva add_header pode funcionar no n√≠vel HTTP, no n√≠vel do local, no n√≠vel do local se.  Isso geralmente √© descrito na documenta√ß√£o. <br><blockquote>  Entenda em que n√≠veis sua diretiva pode funcionar, onde a diretiva √© executada: PHASE Handler, Body / Header filter. </blockquote>  Isso √© importante porque no nginx a configura√ß√£o est√° congelada.  Por conven√ß√£o, quando voc√™ escreve add_header em algum lugar acima, esse valor √© suavizado no add_header inferior, que voc√™ j√° possui no local.  Assim, voc√™ adicionar√° dois cabe√ßalhos.  Isso se aplica a qualquer diretiva. <br><br>  Se voc√™ especificar alguma porta do host, vice-versa - pool de soquetes.  Isso deve ser indicado uma vez. <br><br>  Em geral, eu proibiria qualquer fus√£o - voc√™ simplesmente n√£o precisa.  Portanto, voc√™ sempre deve determinar claramente em quais matrizes nginx da configura√ß√£o sua diretiva ou conjunto de diretivas vive. <br><br>  Bom exemplo: <br><br><pre> <code class="cpp hljs">location /my_location/ { add_header ‚ÄúMy-Header‚Äù ‚Äúmy value‚Äù; }</code> </pre> <br>  Aqui add_header √© simplesmente adicionado ao local.  O mesmo add_header pode estar em algum lugar acima, e tudo seria simplesmente distorcido.  Esse √© um comportamento documentado e compreens√≠vel. <br><blockquote>  Pense no que pode dificultar a implementa√ß√£o da diretiva. </blockquote>  Imagine que voc√™ est√° desenvolvendo um filtro corporal.  Como eu disse acima, o nginx apenas coloca seu m√≥dulo em uma cadeia comum e voc√™ n√£o tem garantia de que o m√≥dulo gzip n√£o entrou na cadeia na frente do seu filtro Body no momento da compila√ß√£o.  Nesse caso, se algu√©m ativar o m√≥dulo gzip, os dados ser√£o enviados ao seu m√≥dulo para o gzip.  Isso amea√ßa que voc√™ simplesmente n√£o pode fazer nada com o conte√∫do.  Voc√™ pode refaz√™-lo novamente, por exemplo, mas isso √© uma zombaria do ponto de vista da CPU. <br><br>  As mesmas regras se aplicam a todos os manipuladores de fase - n√£o h√° garantia de quem ser√° chamado antes e quem ser√° depois.  Portanto, respeite quem ser√° chamado e lembre-se de que algum gzip ou outra coisa pode voar inesperadamente para voc√™. <br><br><h3>  Estilo de c√≥digo Nginx </h3><br><blockquote>  Quando voc√™ criou o produto, lembre-se de que algu√©m o apoiar√°.  N√£o se esque√ßa do estilo de c√≥digo nginx. </blockquote>  Antes de escrever seu m√≥dulo nginx, familiarize-se com a fonte: <a href="">um</a> e o <a href="">segundo</a> . <br><br>  Se, no futuro, voc√™ iniciar o desenvolvimento de m√≥dulos nginx, estar√° bem ciente das fontes nginx.  Voc√™ os amar√° porque n√£o <strong>h√° documenta√ß√£o</strong> .  Voc√™ aprender√° bem a estrutura de diret√≥rios nginx, aprender√° a usar Grep, possivelmente Sed, quando precisar transferir algumas partes do nginx para seus m√≥dulos. <br><br><h3>  Conjunto de mem√≥rias </h3><br>  Piscinas devem ser usadas corretamente.  <strong>Por exemplo, "r-&gt; conex√£o-&gt; pool! = R-&gt; pool".</strong>  Em nenhum caso voc√™ pode usar a configura√ß√£o do conjunto de mem√≥rias ao processar solicita√ß√µes, ela aumentar√° at√© que o nginx seja reiniciado. <br><br>  Entenda a vida √∫til do objeto.  Suponha que a reprodu√ß√£o de solicita√ß√£o tenha exatamente esse tempo de vida √∫til do pipeline.  Nesta piscina, voc√™ pode colocar muitas coisas e abrir espa√ßo.  A conex√£o pode viver teoricamente indefinidamente - √© melhor colocar algo realmente importante nela. <br><br>  <strong>Tente n√£o usar alocadores externos, por exemplo, malloc / free</strong> .  Isso tem um efeito ruim na fragmenta√ß√£o da mem√≥ria.  Se voc√™ opera com grandes volumes de dados e usa muito malloc, esse nginx fica muito lento. <br><br>  <strong>Para os f√£s do Valgrind, existe um</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>hack</strong></a> que permite depurar nginx-pools usando o Valgrind.  Isso √© importante se voc√™ tiver muito c√≥digo C no nginx, porque mesmo um desenvolvedor experiente no trabalho com mem√≥ria pode cometer um erro. <br><br><h3>  Bloqueio de E / S </h3><blockquote>  Tudo √© simples aqui - n√£o use E / S de bloqueio. </blockquote>  Caso contr√°rio, pelo menos haver√° problemas com as conex√µes keep-alive, mas, no m√°ximo, tudo funcionar√° por um per√≠odo muito longo. <br><br>  Conhe√ßo o caso quando uma pessoa usou o Quora dentro do nginx no modo de bloqueio (n√£o pergunte o porqu√™).  Isso levou ao fato de que as conex√µes keep-alive abandonaram suas atividades e atingiram o tempo limite o tempo todo.  √â melhor n√£o fazer isso - tudo funcionar√° por muito tempo, de forma ineficiente e voc√™ ter√° que alterar imediatamente um milh√£o de tempos, porque o nginx iniciar√° o tempo limite em muitas coisas. <br><br>  Mas existe uma alternativa aos m√≥dulos C - NJS e Lua. <br><br><h2>  Quando voc√™ n√£o precisa desenvolver m√≥dulos C </h2><br>  Este ano, tive minha primeira experi√™ncia trabalhando no NJS, tive uma impress√£o subjetiva e at√© percebi o que estava faltando l√°, para que tudo estivesse bem.  Eu tamb√©m gostaria de falar sobre minha experi√™ncia trabalhando em Lua sob o nginx e, al√©m disso, compartilhar os problemas que est√£o presentes em Lua. <br><br><h3>  Lua / LuaJit Essentials </h3><br>  O Nginx n√£o usa Lua, mas LuaJit.  Mas isso n√£o √© Lua, porque Lua j√° avan√ßou duas vers√µes e LuaJit est√° preso em algum lugar no passado.  <strong>O autor praticamente n√£o desenvolve LuaJit - ele geralmente vive em garfos.</strong>  O fork mais atual √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LuaJit2</a> .  Isso adiciona situa√ß√µes estranhas no mesmo OpenResty. <br><br>  <strong>Coletor de lixo precisa de aten√ß√£o</strong> .  O LuaJit n√£o pode superar esse problema - basta apresentar algumas solu√ß√µes alternativas.  Com uma carga enorme, quando muitos Garbage Collector mantidos vivos ficarem vis√≠veis no cliente com falhas no gr√°fico e erros 500. Existem v√°rias maneiras de lidar com o Garbage Collector em Lua, n√£o vou focar neles aqui.  H√° muita informa√ß√£o sobre isso na Internet. <br><br>  <strong>A implementa√ß√£o de cadeias leva a problemas de desempenho</strong> .  Este √© apenas o mal de LuaJit, e em Lua foi reparado.  A implementa√ß√£o de strings no LuaJit simplesmente desafia qualquer l√≥gica.  As linhas ficam mais lentas da maneira mais selvagem, associada √† implementa√ß√£o interna. <br><br>  <strong>Incapacidade de usar muitas bibliotecas prontas</strong> .  Lua est√° bloqueando inicialmente, portanto, a maioria das bibliotecas em Lua e LuaJit usa E / S de bloqueio.  Devido ao fato de o nginx n√£o estar bloqueando, √© imposs√≠vel usar bibliotecas prontas dentro do nginx que usam qualquer E / S de bloqueio.  Isso diminuir√° a velocidade do nginx. <br><br>  As raz√µes para usar LuaJit s√£o id√™nticas √†s raz√µes para usar m√≥dulos: <br><br><ul><li>  prototipagem de m√≥dulos complexos; </li><li>  C√°lculos HMAC, SHA para autoriza√ß√µes; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">balanceadores</a> ; </li><li>  pequenas aplica√ß√µes: manipuladores de cabe√ßalho, regras para redirecionamentos; </li><li>  vari√°veis ‚Äã‚Äãde computa√ß√£o para o nginx.conf. </li></ul><br>  Onde √© melhor n√£o usar LuaJit? <br><blockquote>  A regra principal: n√£o processe um corpo enorme em Lua - isso n√£o funciona. </blockquote>  <strong>Manipuladores de conte√∫do em Lua tamb√©m n√£o funcionam</strong> .  Tente minimizar a l√≥gica para alguns <code>if</code> .  Um balanceador simples funcionar√°, mas uma barra lateral em Lua funcionar√° muito mal. <br><br>  <strong>A mem√≥ria compartilhada ou o Garbage Collector vir√°.</strong>  N√£o use a mem√≥ria compartilhada com o Lua - o Garbage Collector ir√° rapidamente e com garantia levar todo o c√©rebro √† produ√ß√£o. <br><br>  <strong>N√£o use corotinas</strong> com muitos compostos keep-alive.  As corotinas geram ainda mais lixo dentro do LuaJit Garbage Collector, o que √© ruim. <br><br>  Se voc√™ j√° est√° usando LuaJit, lembre-se: <br><br><ul><li>  sobre monitoramento de mem√≥ria; </li><li>  no monitoramento e otimiza√ß√£o do trabalho do Garbage Collector; </li><li>  sobre como o Garbage Collector funciona, se voc√™ escreveu um aplicativo complicado para o LuaJit, porque precisa adicionar algo novo. </li></ul><br><h3>  Njs </h3><br>  Quando eu estava na NGINX Conf, eles me convenceram de que seria legal n√£o escrever c√≥digo em C. Eu pensei que tinha que tentar, e foi isso que obtive. <br><br>  <strong>Autoriza√ß√£o</strong>  Funciona, o c√≥digo √© simples, n√£o afeta a velocidade - tudo est√° √≥timo.  Meu pequeno <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">prot√≥tipo</a> com o qual comecei √© de 10 linhas de c√≥digo.  Mas essas 10 linhas autorizam com s3. <br><br>  <strong>Vari√°veis ‚Äã‚Äãde computa√ß√£o para nginx.conf.</strong>  Muitas vari√°veis ‚Äã‚Äãpodem ser calculadas usando NJS.  Dentro do nginx, isso √© legal.  Existe esse recurso em Lua, mas existe um Garbage Collector, portanto n√£o √© t√£o legal. <br><br>  No entanto, nem tudo √© t√£o bom.  Para fazer coisas realmente legais no NJS, ele sente falta de algumas coisas. <br><br>  <strong>Mem√≥ria compartilhada</strong> .  Consertei a mem√≥ria compartilhada, esse √© meu pr√≥prio garfo, e agora √© o suficiente. <br><br>  <strong>Filtros que suportam mais fases</strong> .  No NJS, h√° apenas a fase e as vari√°veis ‚Äã‚Äãde conte√∫do, e o filtro de cabe√ßalho est√° muito ausente.  Voc√™ precisa escrever muletas para adicionar muitos cabe√ßalhos.  N√£o h√° filtro de corpo suficiente para l√≥gica complexa ou trabalho com conte√∫do. <br><br>  <strong>Informa√ß√µes sobre como monitorar e criar um perfil</strong> .  Agora eu sei como, mas tive que estudar a fonte.  N√£o h√° informa√ß√µes ou ferramentas suficientes sobre o perfil adequado.  Se estiver, est√° oculto onde n√£o pode ser encontrado.  No mesmo ponto, n√£o h√° informa√ß√µes suficientes sobre <strong>onde posso usar o NJS</strong> e onde n√£o posso? <br><br>  <strong>M√≥dulos C.</strong>  Eu tinha o desejo de expandir o NJS. <br><br><h2>  Posf√°cio </h2><br>  <strong>Por que criar seus pr√≥prios m√≥dulos?</strong>  Resolver problemas gerais e de neg√≥cios. <br><br>  <strong>Quando eu preciso implementar m√≥dulos em C?</strong>  Se n√£o houver outras op√ß√µes.  Por exemplo, uma carga pesada, inser√ß√£o de conte√∫do ou economia b√°sica em hardware.  Isso deve ser garantido em C. Na maioria dos casos, Lua ou NJS √© adequado.  Mas voc√™ deve sempre pensar √† frente. <br><br>  <strong>E na Lua?</strong>  Quando voc√™ n√£o pode escrever em C. Por exemplo, voc√™ n√£o precisa converter o corpo da solicita√ß√£o com RPS enorme.  Seu n√∫mero de clientes est√° crescendo; em algum momento voc√™ deixar√° de lidar - pense nisso. <br><br>  <strong>NJS?</strong>  Quando LuaJit est√° completamente cheio de seu Garbage Collector e strings.  Por exemplo, a autoriza√ß√£o gerou muitos objetos Garbage em Lua, mas isso n√£o foi cr√≠tico.  No entanto, isso se refletiu no monitoramento e irritante.  Agora deixou de aparecer no meu monitoramento, e tudo ficou bom. <br><br><blockquote>  No HighLoad ++ 2019, Vasily Soshnikov continuar√° o t√≥pico dos m√≥dulos nginx e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conversar√°</a> mais sobre o NJS, sem esquecer a compara√ß√£o com LuaJit e C. <br><br>  Veja a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lista</a> completa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">de</a> relat√≥rios no site e nos dias 7 e 8 de novembro na maior confer√™ncia para desenvolvedores de sistemas altamente carregados.  Siga nossas novas id√©ias no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">canal de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">newsletter</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">telegrama</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt471684/">https://habr.com/ru/post/pt471684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt471666/index.html">Experimente o desenvolvedor iOS se mudar para a Alemanha com um visto de trabalho</a></li>
<li><a href="../pt471668/index.html">An√°lise t√©cnica da explora√ß√£o checkm8</a></li>
<li><a href="../pt471670/index.html">Tentando Jetpack Compose em batalha?</a></li>
<li><a href="../pt471676/index.html">Golpistas por telefone. A segunda a√ß√£o, na qual eu corro e corro para o caixa eletr√¥nico mais pr√≥ximo</a></li>
<li><a href="../pt471678/index.html">Prestar servi√ßos sob demanda</a></li>
<li><a href="../pt471686/index.html">Como a AWS fabrica seus servi√ßos resilientes. Escala de servidor e banco de dados</a></li>
<li><a href="../pt471688/index.html">Como a AWS fabrica seus servi√ßos resilientes. Escala de rede</a></li>
<li><a href="../pt471700/index.html">Como escolhi uma pilha tecnol√≥gica com uma base para o futuro</a></li>
<li><a href="../pt471702/index.html">Aplicativos Web com aprimoramento cibern√©tico</a></li>
<li><a href="../pt471704/index.html">O livro ‚ÄúMitoc√¥ndrias ego√≠stas. Como manter a sa√∫de e mover a velhice "</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>