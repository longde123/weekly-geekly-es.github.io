<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçã üôä üë©üèæ‚Äçüè´ Blackjack- und Gegenleckschutz üòò üçõ üë∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gr√º√üe. Es gibt so etwas - Hydrolock \ Neptun \ Avkvastorozh - Wasserabsperrsysteme, wenn ein unkontrolliertes Leck auftritt. Das Prinzip ist einfach -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Blackjack- und Gegenleckschutz</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/399459/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√º√üe. Es gibt so etwas - Hydrolock \ Neptun \ Avkvastorozh - Wasserabsperrsysteme, wenn ein unkontrolliertes Leck auftritt. Das Prinzip ist einfach - ein Wassersensor + Automatisierung + ein Paar elektrische Wasserh√§hne. Aber der Teufel steckt wie immer im Detail: wie die Wasserh√§hne angeordnet sind, wie die Lecksensoren angeordnet sind und warum einer 50 Rubel und der andere 500 Rubel kostet. Ein Kilogramm eines Layout-Bulletins wird um diese ganze Sache gewickelt, die Verpackung wird Ihnen die Augen ausschlie√üen usw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Geschichte werde ich durch die Bausteine ‚Äã‚Äãdes Systems gehen, die mich bei der Wahl gef√ºhrt haben. Das gesamte System basiert auf werkseitigen Sensoren und einem hausgemachten Controller auf der Basis von Particle (ex.Spark) Photon (z. B. einem esp8266 mit einer Cloud-IDE f√ºr die sofort einsatzbereite Verkabelung). Die Ger√§tebasis besteht aus einem stm-Controller und einem WLAN-Modul von Broadcom. All dies ist an einen Openhab-Server auf Orange Pi One gebunden.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/715/6ee/aa2/7156eeaa28b44479a5d5aff2e63ff89c.png" width="600"></div><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum nicht ein fertiges System? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Weil ich es selbst kann und es hoch ist </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Die Integration mit externen Systemen ist in vorgefertigten Systemen lahm. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - Fertige Systeme haben keine Zusatzfunktionen - unter Ber√ºcksichtigung von Z√§hlerst√§nden, Wassertemperatursensoren, Benachrichtigung √ºber Wasserausf√§lle und anderen erotischen Fantasien beim Gehen.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginnen wir mit Kr√§nen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
W√§hlte dumm in der Stirn in Bezug auf das Drehmoment. F√ºr einige Zeit lebte er in den Vororten, wo die Wasserqualit√§t (wie wahrscheinlich √ºberall in Zamkadye) zu w√ºnschen √ºbrig l√§sst. Also Kugelh√§hne 1/2 Zoll, wenn Sie das Jahr nicht ber√ºhren - es ist sehr schwierig zu drehen. Und auf dem beheizten 1-Zoll-Handtuchhalter versuche ich nicht einmal, ihn zu bewegen - nur wenn ich die Schulter mit einem Schraubenschl√ºssel verst√§rke, aber hier k√∂nnen Sie etwas abrei√üen. Das Problem liegt in Ablagerungen von Kalzium-Hartholz, die mit einem Wort "√ºberwachsen" sind. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dementsprechend fiel die Wahl auf die Profiserie aus dem Hydrolock - 21N * m Drehmoment f√ºhlt sich nicht wie ein Werbegespr√§ch an, der Kran ist einfach riesig - bewerten Sie den Ort seiner Installation vor dem Kauf. </font></font><br>
<br>
<img src="https://habrastorage.org/files/758/e07/18c/758e0718cc9a46e09306bac214db8cf1.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Hahn ist abgedichtet, eine Gummidichtung um den Umfang, der Eingang unter der Verschraubung. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entfernen Sie die Abdeckung.</font></font><br>
<br>
<img src="https://habrastorage.org/files/f9d/aa4/a25/f9daa4a251e140c3bbe4b049a5af7f46.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor uns liegt die Oberseite des Brettes und der Schrittmotor. All dies wird mit 12 Volt betrieben. Durch Kurzschlie√üen des Steuerkabels mit Masse wird das Ventil in die geschlossene Position gebracht. Auf der Platine sehen wir einen einfachen PIC 12f629 Controller. Lebte die Steuerung im Kranantrieb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die R√ºckseite der Tafel ist die interessanteste. </font></font><br>
<br>
<img src="https://habrastorage.org/files/c14/e08/f2e/c14e08f2e4224088a534e1811fa3729a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L293 Shagovik-Treiber und Fotokoppler (Emitter + Fotodetektor). Sie schaut auf das Hauptzahnrad des Antriebs, das in Teilen lackiert ist - wei√ü und schwarz, geschlossen / offen. </font></font><br>
<br>
<img src="https://habrastorage.org/files/a14/cec/177/a14cec1771ef4d52bc15c83e9183124e.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Kran dreht sich die ganze Zeit in eine Richtung, die Logik der Steuerung ist einfach - wir drehen die Welle, bis wir auf die gew√ºnschte Farbe wechseln. Die Drehung des Krans in eine Richtung ist weniger Verschlei√ü und es ist weniger wahrscheinlich, dass die ber√ºhrungslose Methode zur Positionsbestimmung einen variablen Widerstand oder Endschalter sauer macht / nicht funktioniert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Installation k√∂nnen Sie den Kran vom Antrieb abschrauben - er wird auf 2 Muttern gehalten. Zwischen dem Antrieb und dem Kran befindet sich eine w√§rmeisolierende Dichtung. </font></font><br>
<br>
<img src="https://habrastorage.org/files/bf7/37c/1f7/bf737c1f7a144c72baba7a17fdc94615.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hatte die Reparatur vor anderthalb Jahren. Der vor drei Jahren gekaufte Kran - zerlegen, hineinschauen, mehr kaufen und w√§hrend der Reparatur aufwickeln. Ja, jetzt ... das Maximum, das ich in diesem h√∂llischen Zirkus geschafft habe, war, einen Schmutzsammler in die Montage der Wasserversorgung zu legen, mit der Aussicht, ihn durch einen Kran zu ersetzen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und erst nach anderthalb Jahren kaufte ich einen zweiten Kran und schraubte ihn fest.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infolgedessen beobachten wir ein seltsames und seltenes Ph√§nomen (gelesen mit der Stimme von Drozdov) - alle Informationen von der Website des Herstellers wurden best√§tigt. Dar√ºber hinaus ist die Beschreibung eigenartig, als ob die Technikfreaks geschrieben h√§tten, und dann wurde das Marketing f√ºr die Leute bew√§ssert, aber immer noch verstehen nur wenige Leute alle Chips. Es gibt nicht gen√ºgend Abschnitte auf der Website - f√ºr Integratoren mit technischen Details. Selbst auf Kosten eines erh√∂hten Drehmoments lagen sie nicht am Start - der Kran am Start schl√§gt mit einem Motor von 1,5 A und beginnt nach 2-3 Sekunden im normalen Modus (aktuell 0,7 A) zu steigen. Das Schlie√üen dauert etwa 25 bis 30 Sekunden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine andere Erfahrung: Auf Kosten des Drehmoments - es ist zu viel Zeit f√ºr Moskau, hier ist das Wasser ganz in Ordnung, anderthalb Jahre lang gibt es in einem 100-Œºm-Filter ein Paar Kr√§tze und kein √úberwachsen. </font><font style="vertical-align: inherit;">Das gro√üe Drehmoment muss man mit dem Preis, der √ñffnungszeit und dem Platz im Schrank bezahlen. </font><font style="vertical-align: inherit;">Ich denke, es wird genug konventionelle Laufwerke von Hydrolock Ultimate, Neptune oder Aquastorozh geben. </font><font style="vertical-align: inherit;">Ich kann nicht f√ºr die letzten beiden b√ºrgen - ich habe es nicht geschafft, vor ungef√§hr 5 Jahren hatten sie teilweise Plastikzahnr√§der, jetzt scheinen sie es repariert zu haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt auch einen Winner-Hydrolock mit direktem Anschluss von Sensoren an das Laufwerk - wenn Sie nicht alles brauchen, was ich getan habe. </font><font style="vertical-align: inherit;">Dort ist die Stromversorgung unabh√§ngig von 4 Batterien und die Basis √§hnelt einem ultimativen Antrieb. </font><font style="vertical-align: inherit;">Im Allgemeinen ist es m√∂glicherweise auch f√ºr einen selbstgebauten Controller interessant - es ist 5 Volt, Sie m√ºssen nicht zwei Busse auf 5 und 12 Volt setzen und Sie k√∂nnen die optische Isolation wegwerfen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lecksensoren</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe die Sensoren des gleichen WSU-Z√§hlers gekauft - universell. </font><font style="vertical-align: inherit;">Sie haben zwei ‚ÄûOpen Collector‚Äú -Ausg√§nge, einer zieht nur dann auf den Boden, wenn Wasser vorhanden ist, der zweite - wenn Wasser eindringt, zieht es die ganze Zeit auf den Boden, bis die Stromversorgung unterbrochen wird. </font><font style="vertical-align: inherit;">Ich verwende nur den ersten Ausgang, der Rest der Logik befindet sich im Controller, aber es sieht so aus, als ob dieser Ausgang f√ºr einige weitere Condo-Versandsysteme n√ºtzlich sein kann. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Dr√§hte im Kit sind irgendwo drei Meter lang. </font><font style="vertical-align: inherit;">Die Farbe der Dr√§hte ist Ad_i_Israel. </font><font style="vertical-align: inherit;">Schauen Sie sich das Angebot an:</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roter (brauner) Draht (Vcc) mit einer Spannung von +5 bis +30 Volt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
schwarzer (wei√üer) Draht (OUT2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gr√ºner Draht (OUT1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gelber Draht (GND)</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was hat verhindert, dass wei√üe / schwarze Erde entsteht? </font><font style="vertical-align: inherit;">√úbrigens sind auch beim Kranantrieb die logisch farbigen Dr√§hte kein Ale. </font><font style="vertical-align: inherit;">Der erste Sensor befindet sich in der K√ºche unter dem Waschbecken neben dem Geschirrsp√ºler. </font></font><br>
<br>
<img src="https://habrastorage.org/files/2ea/407/a25/2ea407a255b8420e9b1d6c26772e2709.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der zweite im Badezimmer in einem speziellen Entw√§sserungsgraben. </font><font style="vertical-align: inherit;">Als er den Estrich machte, brachte er ihn nicht an die Wand. </font><font style="vertical-align: inherit;">Das Ergebnis war eine Art Sumpf zum Sammeln von Wasser aus Bad und Toilette. </font></font><br>
<br>
<img src="https://habrastorage.org/files/51d/715/898/51d71589848d4a77a59f8caf0dbf2041.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus Betriebserfahrung - es gab bereits einen Fehlalarm des Sensors in der Sp√ºlmaschine. </font><font style="vertical-align: inherit;">Gemessen am Protokoll f√ºr einen Abfragezyklus (500 ms) gab es eine Schaltung, die den Code modifizierte - die Zustands√§nderung erfolgt nun bei 10 aufeinanderfolgenden identischen Werten vom Sensor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Sensorkontakte sind vergoldet. </font><font style="vertical-align: inherit;">Ein Freund hat seit mehreren Jahren √§hnliche Sensoren, es wurde keine Oxidation festgestellt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drucksensoren</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Praktisch - Showometer. </font><font style="vertical-align: inherit;">Genauigkeit + - 0,5 atm passte mir vollkommen. </font><font style="vertical-align: inherit;">Basierend auf den Sensoren wird ein Wasserabschaltalarm ausgegeben. </font><font style="vertical-align: inherit;">Ali gekauft </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temperatursensoren</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und warum nicht hinzuf√ºgen? </font><font style="vertical-align: inherit;">Von n√ºtzlich - es wird einmal im Jahr in der Lage sein, √ºber das Abschalten von hei√üem Wasser zu informieren. </font><font style="vertical-align: inherit;">Gebraucht banal ds18b20.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z√§hler</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das h√§ufigste Itelma, einmal alle 10 Liter Kontakt aufnehmen. </font><font style="vertical-align: inherit;">Auf der Controllerseite wird der Ausgang auf +3,3 V hochgezogen, das Messger√§t zieht ihn auf den Boden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controller</font></font></h3><br>
<img src="https://habrastorage.org/files/318/4e6/d7a/3184e6d7ad9c4eab99d9962410c7918c.jpg"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Innen</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/a83/72d/117/a8372d1170ca43f8b92925fa76a240f8.jpg"><br>
<img src="https://habrastorage.org/files/f7b/e62/ee8/f7be62ee80a54ff2a0ed60ad17467a8b.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basierend auf dem Teilchenphoton, mehr Details </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Sie haben eine Version mit einem 2G- oder 3G-Modul (Electron). Die erste Firmware war eine vollst√§ndige Schlacke, die mit OK-Dioden blinkte. Sobald Sie jedoch mit dem Kauen komplizierter Wurst beginnen, kann das Spielen mit i2c und Interrupts das WLAN verlieren. Jetzt kannst du leben. Im Prinzip k√∂nnen Sie Drucksensoren aus dem Stromkreis werfen und alles am ESP8266 aufr√ºhren - los geht's. Erstens muss das Photon mit dem Partikelkonto verkn√ºpft sein (√ºber die App auf dem Handy oder √ºber die Partikel-CLI-Konsole - ich verwende nur die zweite Methode) und ein WLAN-Netzwerk registrieren. Nach dem Binden werden </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> im Ger√§teabschnitt der Controller und sein Status f√ºr die Verbindung zur Cloud angezeigt.</font></font><br>
<br>
<img src="https://habrastorage.org/files/71d/c17/687/71dc17687ccb4a289d0a0dd2296fdfca.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe alle Knoten nur zum Aktualisieren der Firmware mit der Cloud verbunden. </font><font style="vertical-align: inherit;">Nicht, dass ich paranoid w√§re - nur mit der Cloud zu arbeiten, kostet keine reichen Controller-Ressourcen. </font><font style="vertical-align: inherit;">Die IDE unterst√ºtzt die Arbeit mit Bibliotheken, buchst√§blich ein Dutzend werden vom Z√§hler selbst unterst√ºtzt, der Rest von der Community. </font><font style="vertical-align: inherit;">Meiner Beobachtung nach wurde alles Gemeinsame schon lange portiert, und ein weiteres Merkmal ist, dass die IDE sofort wei√ü, wie viele Projekte die Bibliothek verwenden.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware-Quellcode</font></font></b><div class="spoiler_text"><pre><code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Adafruit_SSD1306/Adafruit_SSD1306.h"</span></span></span></span>

<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MQTT/MQTT.h"</span></span></span></span>

<span class="hljs-comment"><span class="hljs-comment">// This #include statement was automatically added by the Particle IDE.</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"OneWire/OneWire.h"</span></span></span></span>

SYSTEM_THREAD(ENABLED);
SYSTEM_MODE(MANUAL);
STARTUP(WiFi.selectAntenna(ANT_EXTERNAL));
STARTUP(System.enableFeature(FEATURE_RETAINED_MEMORY));

<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value;
  byte state;
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;
};
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">valve_struct</span></span></span><span class="hljs-class"> {</span></span>
  byte state;
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;
};
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sensor_struct</span></span></span><span class="hljs-class"> {</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> timeout;
  byte state;
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pin;
};

<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> currentMillis = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_conected = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_wifi_uptime = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> previous_counter_read = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> wifi_uptime;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> read_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>;
byte display_timeout = <span class="hljs-number"><span class="hljs-number">0</span></span>;

<span class="hljs-comment"><span class="hljs-comment">//temp onewire </span></span>
OneWire ds0 = OneWire(D2);
OneWire ds1 = OneWire(D3);
byte addr0[<span class="hljs-number"><span class="hljs-number">8</span></span>];
byte addr1[<span class="hljs-number"><span class="hljs-number">8</span></span>];
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense0 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> presense1 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
byte data[<span class="hljs-number"><span class="hljs-number">12</span></span>];

<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> OLED_RESET A7</span></span>
<span class="hljs-function"><span class="hljs-function">Adafruit_SSD1306 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">display</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OLED_RESET)</span></span></span></span>;


<span class="hljs-comment"><span class="hljs-comment">//valve control</span></span>
retained valve_struct valve[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, D4}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, D5} };

<span class="hljs-comment"><span class="hljs-comment">//counter control</span></span>
retained counter_struct counter[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A0}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A1} };
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pressure[<span class="hljs-number"><span class="hljs-number">2</span></span>] = {A2, A3};
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SENSOR_TIMEOUT 10</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> sensor_struct sensor[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D6}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D7} };

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span></span>;

byte server[] = { <span class="hljs-number"><span class="hljs-number">192</span></span>,<span class="hljs-number"><span class="hljs-number">168</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">101</span></span>};
<span class="hljs-function"><span class="hljs-function">MQTT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(server, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1883</span></span></span></span><span class="hljs-function"><span class="hljs-params">, callback)</span></span></span></span>;

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)p, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(p), retain);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf_d[<span class="hljs-number"><span class="hljs-number">12</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf_d,<span class="hljs-string"><span class="hljs-string">"%d"</span></span>,p);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)buf_d, n, retain);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* t, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> retain)</span></span></span><span class="hljs-function"> 
</span></span>{   
    <span class="hljs-comment"><span class="hljs-comment">//char buf_f[18];</span></span>
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">4</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;
<span class="hljs-comment"><span class="hljs-comment">//    dtostrf(p, 9, 4, buf_f);</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//int n = sprintf(buf_f,"%f",p);</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)s.c_str(), s.length(), retain);
}

<span class="hljs-comment"><span class="hljs-comment">// recieve message</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* topic, byte* payload, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> p[length + <span class="hljs-number"><span class="hljs-number">1</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, payload, length);
    p[length] = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p)</span></span></span></span>;
    <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(topic)</span></span></span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.equals(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>))
    {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.equalsIgnoreCase(<span class="hljs-string"><span class="hljs-string">"1"</span></span>))
        {
            Particle.connect();
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(Particle.connected, <span class="hljs-number"><span class="hljs-number">10000</span></span>)) 
                {publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}
            <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
                {Particle.disconnect(); publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);}
        }
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
        {
            Particle.disconnect();
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
        }
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span>))
    {
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m = message.toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) 
        {
            set_valve(x, m);
        }
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
        {
            publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>),  valve[x].state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
        }
    }
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span>))
    {
        <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> m = message.toFloat();
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>).toInt();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt;= <span class="hljs-number"><span class="hljs-number">999999</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) 
        {
            counter[x].value = m;
        }
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/"</span></span> + t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>),  counter[x].value , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
    }
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
<span class="hljs-comment"><span class="hljs-comment">//Serial.begin(9600);</span></span>
    WiFi.on();
    WiFi.connect();
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(WiFi.ready, <span class="hljs-number"><span class="hljs-number">5000</span></span>)) {mqtt_connect();}
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) 
    {
        pinMode(valve[i].pin, OUTPUT);
        digitalWrite(valve[i].pin, valve[i].state);
        pinMode(counter[i].pin, INPUT);
        pinMode(sensor[i].pin, INPUT);
        counter[i].state = digitalRead(counter[i].pin);
        pinMode(pressure[i], AN_INPUT);
    }
    pinMode(A4, INPUT_PULLUP);

    display.begin(SSD1306_SWITCHCAPVCC, <span class="hljs-number"><span class="hljs-number">0x3C</span></span>);  <span class="hljs-comment"><span class="hljs-comment">// initialize with the I2C addr 0x3C (for the 128x64)</span></span>
    display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span>

    <span class="hljs-comment"><span class="hljs-comment">//Particle.connect();</span></span>
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> 
</span></span>{
    currentMillis = millis();
    <span class="hljs-comment"><span class="hljs-comment">//       MQTT </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_conected &gt;= <span class="hljs-number"><span class="hljs-number">30000</span></span> || previous_conected &gt; currentMillis)
    {
        previous_conected = currentMillis;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.isConnected() &amp; wifi_uptime &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>)
        {
            mqtt_connect();
        }
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/rssi"</span></span>, WiFi.RSSI(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_wifi_uptime &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> || previous_wifi_uptime &gt; currentMillis)
    {
        previous_wifi_uptime = currentMillis;
        WiFi.ready() ? wifi_uptime++ : wifi_uptime = <span class="hljs-number"><span class="hljs-number">0</span></span>;
        <span class="hljs-comment"><span class="hljs-comment">//work with button and display</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fg = digitalRead(A4);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)
        {
            display_timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) 
            { 
                display.clearDisplay();
                display.display();
            } 
        }
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fg == <span class="hljs-number"><span class="hljs-number">0</span></span>)
        {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)
            {
                display.clearDisplay();   <span class="hljs-comment"><span class="hljs-comment">// clears the screen and buffer</span></span>
                display.setTextSize(<span class="hljs-number"><span class="hljs-number">2</span></span>);
                display.setTextColor(WHITE);
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>);
                display.print(<span class="hljs-string"><span class="hljs-string">"C="</span></span>);
                display.println(counter[<span class="hljs-number"><span class="hljs-number">0</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>);
                display.print(<span class="hljs-string"><span class="hljs-string">"H="</span></span>);
                display.println(counter[<span class="hljs-number"><span class="hljs-number">1</span></span>].value, <span class="hljs-number"><span class="hljs-number">4</span></span>);
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>);
                display.print(<span class="hljs-string"><span class="hljs-string">"Valve="</span></span>);
                display.print(valve[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);
                display.println(valve[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);
                display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">48</span></span>);
                display.print(<span class="hljs-string"><span class="hljs-string">"Sensor="</span></span>);
                display.print(sensor[<span class="hljs-number"><span class="hljs-number">0</span></span>].state);
                display.print(<span class="hljs-string"><span class="hljs-string">"|"</span></span>);
                display.println(sensor[<span class="hljs-number"><span class="hljs-number">1</span></span>].state);
                display.display();
            }
            display_timeout = <span class="hljs-number"><span class="hljs-number">10</span></span>;
        }
    }
    <span class="hljs-comment"><span class="hljs-comment">//counter check</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_counter_read &gt;= <span class="hljs-number"><span class="hljs-number">500</span></span> || previous_counter_read &gt; currentMillis)
    {
        previous_counter_read = currentMillis;
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) 
        {
            byte count_state = digitalRead(counter[i].pin);
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state != counter[i].state)
            {
                counter[i].state = count_state;
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state == <span class="hljs-number"><span class="hljs-number">0</span></span>)
                {
                    counter[i].value += <span class="hljs-number"><span class="hljs-number">0.01</span></span>;
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/%d"</span></span>, i);
                    publish_message(buf18 , counter[i].value, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
                }
            }
            <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
            byte sensor_state = digitalRead(sensor[i].pin);
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor_state != sensor[i].state) <span class="hljs-comment"><span class="hljs-comment">//</span></span>
            {
                sensor[i].state = sensor_state;
                sensor[i].timeout = SENSOR_TIMEOUT; 
            }
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) 
            {
                sensor[i].timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>)
                {
                    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>];
                    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/sensor/%d"</span></span>, i);
                    publish_message(buf18 , sensor[i].state, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].state  == <span class="hljs-number"><span class="hljs-number">0</span></span>)
                    {
                        set_valve(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span>
                        set_valve(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//close both valve</span></span>
                    }
                }
            }
        }
    }

    <span class="hljs-comment"><span class="hljs-comment">// temp onewire</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - start_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">299000</span></span> || start_temp_timer &gt; currentMillis)
    { <span class="hljs-comment"><span class="hljs-comment">// </span></span>
        start_temp_timer = currentMillis;
        presense0 = start_temp0();
        presense1 = start_temp1();
    }
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - read_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">300000</span></span> || read_temp_timer &gt; currentMillis)
    {<span class="hljs-comment"><span class="hljs-comment">// </span></span>
        read_temp_timer = currentMillis;
        start_temp_timer = currentMillis;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense0) read_temp0();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense1) read_temp1();
        <span class="hljs-comment"><span class="hljs-comment">//preasure calc and send</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>]; 
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++)
        {
            <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf18,<span class="hljs-string"><span class="hljs-string">"home/water_count/pressure/%d"</span></span>, i);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> read_val = analogRead(pressure[i]);
            <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value = (read_val - <span class="hljs-number"><span class="hljs-number">600.0</span></span>) / <span class="hljs-number"><span class="hljs-number">300.0</span></span> ;
            publish_message(buf18 , value, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
        }
    }
    <span class="hljs-comment"><span class="hljs-comment">//Particle.process();</span></span>
    client.loop();
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(<span class="hljs-string"><span class="hljs-string">"water_count"</span></span>))
    { <span class="hljs-comment"><span class="hljs-comment">//  spark    </span></span>
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark/set"</span></span>);
        publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/spark"</span></span>, Particle.connected() ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);
        client.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);
        
    }
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds0.search(addr0)) { ds0.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}
    ds0.reset_search();
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr0, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr0[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}
    
    ds0.reset();
    ds0.select(addr0);
    ds0.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; 
}
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds1.search(addr1)) { ds1.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}
    ds1.reset_search();
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr1, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr1[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;}
    
    ds1.reset();
    ds1.select(addr1);
    ds1.write(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; 
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp0</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span>
    ds0.reset();
    ds0.select(addr0);
    ds0.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);

    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) 
    {
        data[i] = ds0.read();
    }
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/0"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span>
    ds0.reset_search();
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_temp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//delay(1000);</span></span>
    ds1.reset();
    ds1.select(addr1);
    ds1.write(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);

    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) 
    {
        data[i] = ds1.read();
    }
    <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> celsius = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    publish_message(<span class="hljs-string"><span class="hljs-string">"home/water_count/temp/1"</span></span>, celsius, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);
    <span class="hljs-comment"><span class="hljs-comment">//Serial.println(celsius);</span></span>
    ds1.reset_search();
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_valve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vlv, byte state)</span></span></span><span class="hljs-function">
</span></span>{
    valve[vlv].state = state;
    digitalWrite(valve[vlv].pin, state);
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf26[<span class="hljs-number"><span class="hljs-number">26</span></span>];
    <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buf26,<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/%d"</span></span>, vlv);
    publish_message(buf26 , state , <span class="hljs-literal"><span class="hljs-literal">true</span></span>);
}
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√úber MQTT verbinden wir uns mit dem Broker. </font><font style="vertical-align: inherit;">√úberwachen Sie die Sensoren und den Helm in den entsprechenden Zweigen der mqtt-Ereignisse und -Werte. </font><font style="vertical-align: inherit;">Zum Beispiel home / water_count / ventil / 0 - ein Wasserantrieb. </font><font style="vertical-align: inherit;">home / water_count / counter / 0 - Messwerte des Z√§hlers eines kalten Wassers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir abonnieren die Befehle zum √Ñndern des Laufwerkszustands und zum Einstellen des aktuellen Werts des Z√§hlers (kaltes und hei√ües Wasser):</font></font><br>
<br>
<pre><code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>);
<span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt eine Taste am Ger√§t - durch Dr√ºcken schalten wir den Bildschirm ein und zeichnen die aktuellen Messwerte von Z√§hlern, Sensoren und Abgriffen. OLED-Bildschirm, verblasst schnell, wenn er st√§ndig eingeschaltet ist.</font></font><br>
<br>
<pre><code class="hljs lisp">STARTUP(<span class="hljs-name"><span class="hljs-name">System</span></span>.enableFeature(<span class="hljs-name"><span class="hljs-name">FEATURE_RETAINED_MEMORY</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist eine interessante Hardware- und Softwarefunktion des stm-Controllers, die im Referenzteilchen als BackupSRAM bezeichnet wird. Photon hat einen VBAT-Ausgang - dies ist keine Batterieleistung oder Aufladung. Solange an diesem Zweig Spannung anliegt, bleibt der Inhalt von 4 KByte SRAM erhalten, wobei die Steuerung vollst√§ndig stromlos ist. Dies beseitigt das Problem des Verschlei√ües des EEPROM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Code werden die Variablen, die in diesen Speicher gefahren werden m√ºssen, mit dem Hinweis deklariert: beibehalten. Ich habe Hardware vom Superkondensator bei 1,5F implementiert. Laut Datenblatt wird der Speicher bei 1,6 V sterben, nach meinen Bench-Experimenten auf dem Protoboard wird es in 2 Wochen mit ungef√§hr meinem Kondensator kommen. Die Logik des Schlie√üens der Krane beim Ausl√∂sen der Sensoren ist "autonom" und h√§ngt nicht von der Verbindung zu openhab ab. Es gibt einen 3-Wege-Schalter f√ºr die Direktantriebssteuerung - automatisch, AUS (offene H√§hne), Schlie√üen (schlie√üen).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der folgende Schaltplan: </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a8/f4c/63d/1a8f4c63dba34f4e9905b703fabad0fd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Eagle-Projekt kann zusammen mit benutzerdefinierten Bibliotheken hier heruntergeladen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Geb√ºhr wurde LUT gemacht, in den Tracks schrumpfte nicht.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wasserbad LUTs bester Freund</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/files/351/e37/1c3/351e371c3caf487d9f14f839f89402be.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Netzteil. </font><font style="vertical-align: inherit;">Wir brauchen 12 und 5 Volt. </font><font style="vertical-align: inherit;">Der Spender wird bei ebay nach der Zeile "Festplatten-Netzteil 5V 12V" wie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dieser</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durchsucht </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geh√§use</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wurde mit PLA-Kunststoff auf einem 3D-Drucker (Tarantula Tevo) gedruckt. </font><font style="vertical-align: inherit;">D√ºse 0,4 mm, Schicht 0,25 mm. </font><font style="vertical-align: inherit;">Die Abdeckung ist gleichzeitig und die Basis f√ºr die Montage der Controller-Karte. </font><font style="vertical-align: inherit;">Die Basis mit dem Netzteil ist an der Wand befestigt. </font><font style="vertical-align: inherit;">Die Basis mit dem Deckel ist nicht mit Schrauben befestigt, es gibt gen√ºgend Deckelspannung (wie der Deckel der Gro√ümutter auf Marmeladengl√§sern) und die Schichtstruktur der W√§nde funktioniert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3D-Modell im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archiv</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/945/110/37d/94511037d3734ad1a573e84e5fc426ef.png"><br>
<br>
<img src="https://habrastorage.org/files/5aa/546/c0b/5aa546c0b6dd41d58fd6b33bde08df74.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So sieht alles auf einer Wasserleitung montiert aus.</font></font><br>
<br>
<img src="https://habrastorage.org/files/cfb/293/f66/cfb293f66c3f4bb9ad2f46e812418918.jpg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openhab</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bereitgestellt auf Orange Pi One unter Armbian.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Item Config</font></font></b><div class="spoiler_text"><pre><code class="hljs julia">  -    ,  .
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp1	<span class="hljs-string"><span class="hljs-string">"T cool [%.1f ¬∞C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_temp2	<span class="hljs-string"><span class="hljs-string">"T hot [%.1f ¬∞C]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp2:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count0	<span class="hljs-string"><span class="hljs-string">"Count cool [%.2f ¬≥]"</span></span>					(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_count1	<span class="hljs-string"><span class="hljs-string">"Count hot [%.2f ¬≥]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure0	<span class="hljs-string"><span class="hljs-string">"P cool [%.2f .]"</span></span>			(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_pressure1	<span class="hljs-string"><span class="hljs-string">"P hot [%.2f .]"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor0	<span class="hljs-string"><span class="hljs-string">"Sensor0 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/0:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sensor1	<span class="hljs-string"><span class="hljs-string">"Sensor1 is [MAP(water_sensor.map):%s]"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/1:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve0	<span class="hljs-string"><span class="hljs-string">"Valve cool"</span></span>		(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/0:state:default], &gt;[mqtt_bro:home/water_count/valve/0/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_valve1	<span class="hljs-string"><span class="hljs-string">"Valve hot"</span></span>				(gWaterCount)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/1:state:default], &gt;[mqtt_bro:home/water_count/valve/1/set:command:*:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>	watercount_sendStr <span class="hljs-string"><span class="hljs-string">"LastVol:[%s]"</span></span>						(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendCool <span class="hljs-string"><span class="hljs-string">"Send cool [%.2f ¬≥]"</span></span>		(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendHot <span class="hljs-string"><span class="hljs-string">"Send hot [%.2f ¬≥]"</span></span>			(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_sendSwitch <span class="hljs-string"><span class="hljs-string">"Autosend"</span></span> 	(gWaterCount)
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_rssi	<span class="hljs-string"><span class="hljs-string">"WaterCount [%d dB]"</span></span>	(gSpark_RSSI)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/rssi:state:default]"</span></span> }
<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>	watercount_spark_state	<span class="hljs-string"><span class="hljs-string">"WaterCount Spark"</span></span>		(gSpark)		{ mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/spark:state:default], &gt;[mqtt_bro:home/water_count/spark/set:command:*:default]"</span></span> }</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºr den Lecksensor wird eine kleine Transformationsregel ben√∂tigt.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurationen transformieren</font></font></b><div class="spoiler_text"><b>transform\water_sensor.map </b><br>
1=dry<br>
0=wet<br>
undefined=undefined<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir bilden die Seite f√ºr das Management:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfiguriert Sitemap</font></font></b><div class="spoiler_text"><b>Sitemap</b><br>
Text label=¬´¬ª icon=¬´water¬ª <br>
 {<br>
 Frame <br>
 {<br>
 Text item=watercount_temp1<br>
 Text item=watercount_count0<br>
 Text item=watercount_pressure0<br>
 Switch item=watercount_valve0 mappings=[1=¬´Close¬ª, 0=¬´Open¬ª]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_temp2<br>
 Text item=watercount_count1<br>
 Text item=watercount_pressure1<br>
 Switch item=watercount_valve1 mappings=[1=¬´Close¬ª, 0=¬´Open¬ª]<br>
 }<br>
 Frame <br>
 {<br>
 Text item=watercount_sensor0<br>
 Text item=watercount_sensor1 <br>
 }<br>
 Frame <br>
 {<br>
 Switch item=watercount_sendSwitch mappings=[0=¬´OFF¬ª, 1=¬´ON¬ª]<br>
 Text item=watercount_sendStr<br>
 Text item=watercount_sendCool<br>
 Text item=watercount_sendHot<br>
 }<br>
 } <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und Verarbeitungsregeln:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurationsregeln</font></font></b><div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)
		{
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)
			{
				sendTelegram("****_bot", "Sensor0 was wet less than 5 seconds")
			}
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
			{
				sendTelegram("****_bot", "Sensor0 become dry")
			}
		}
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
		{
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)
			{
				sendTelegram("****_bot", "Sensor0 was dry less than 5 seconds");			
			}
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
			{
				sendTelegram("****_bot", "Sensor0 become wet! Valves will be closed!")
			}
		}
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_sensor1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)
		{
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>)
			{
				sendTelegram("****_bot", "Sensor1 was wet less than 5 seconds")
			}
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
			{
				sendTelegram("****_bot", "Sensor1 become dry")
			}
		}
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
		{
			<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>)
			{
				sendTelegram("****_bot", "Sensor1 was dry less than 5 seconds");			
			}
			<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
			{
				sendTelegram("****_bot", "Sensor1 become wet! Valves will be closed!")
			}
		}
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
	
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_temp2"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_temp2 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_temp2.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">37</span></span> )
		{
			sendTelegram("****_bot", String::format("Hot water temp drop to %s", watercount_temp2.state.toString));
		}
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure0"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)
		{
			sendTelegram("****_bot", String::format("Cool pressure drop to %s", watercount_pressure0.state.toString));
		}
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)
		{
			sendTelegram("****_bot", String::format("Cool pressure rise to %s", watercount_pressure0.state.toString));
		}
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure1"
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		Item watercount_pressure1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)
		{
			sendTelegram("****_bot", String::format("Hot pressure drop to %s", watercount_pressure1.state.toString));
		}
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>)
		{
			sendTelegram("****_bot", String::format("Hot pressure rise to %s", watercount_pressure1.state.toString));
		}
	<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>

<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Generate send string counters" //every <span class="hljs-number"><span class="hljs-number">24</span></span> day <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> mounth  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">00.01</span></span> minutes
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 1 24 1/1 ?" 
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaCool = (watercount_count0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()
		var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaHot = (watercount_count1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()
		
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deltaCool &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; deltaHot &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>)
		{
			watercount_sendStr.postUpdate(String::format(" %.2f / %.2f 3", deltaCool, deltaHot))
			watercount_sendCool.state = watercount_count0.state
			watercount_sendHot.state = watercount_count1.state
			sendTelegram("****_bot", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3. %s", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), watercount_sendStr.state.toString()))
		}
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
		{
			watercount_sendSwitch.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)
			sendTelegram("****_bot", "Current counters value less than sended last time. Turn off autosend.")
		}
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Send string counters" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 23 24 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_sendSwitch.state == <span class="hljs-number"><span class="hljs-number">1</span></span>)
		{
			sendMail("uk@uk.ru", " 23,  5, . 23", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue()));
			sendTelegram("****_bot", "Send email with watercount values");
		}
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
		{
			sendTelegram("****_bot", "Can't send email with watercount values - autosend is OFF.");
		}
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Rotate valves" 
	<span class="hljs-keyword"><span class="hljs-keyword">when</span></span>
		<span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 05 25 1/1 ?"
	<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>
		<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_valve0.state == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; watercount_valve1.state == <span class="hljs-number"><span class="hljs-number">0</span></span>)
		{	
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>)
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)
			watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)
			Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>)
			watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>)
			sendTelegram("****_bot", "Valves was rotated.");
		}
		<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>
		{
			sendTelegram("****_bot", "Can't rotate valves, it's closed.");
		}
<span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Senden von Nachrichten verwende ich weder die integrierte Funktionalit√§t der Openhab-Android-Anwendung noch integriere ich sie in deren Cloud. </font><font style="vertical-align: inherit;">Ich mag den Telegramm-Bot. </font><font style="vertical-align: inherit;">Wie Sie den Bot konfigurieren und verbinden, erfahren Sie im </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Um Briefe aus dem Google Mail-Postfach zu senden, m√ºssen Sie bei einer Zwei-Faktor-Authentifizierung ein Einmalkennwort f√ºr die E-Mail-Anwendung aktivieren und dieses Kennwort in der Openhab-Konfiguration festlegen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Befolgen Sie die Regeln. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberpr√ºfen Sie watercount_sensor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Die Steuerung sendet nur dann neue Lecksensorwerte, wenn der Wert ge√§ndert wird oder wenn ein Fehlalarm aufgetreten ist (weniger als 10 Zyklen). Wir analysieren die kam und historische Bedeutung, wir bilden Informationsbotschaften. Es gibt eine Nuance - ein Versuch, prevoiusItem zu erhalten, gibt st√§ndig den aktuellen Wert an, ich habe keine L√∂sung gefunden - ich nehme den Wert "-3 Sek.", Wenn jemand ihn √ºberwunden hat, schreibe ihn in Kommentaren oder in PM auf. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberpr√ºfen Sie watercount_temp2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - pr√ºfen Sie, ob weniger als 37, was bedeutet, dass hei√ües Wasser kalt geworden ist, die Durchflussheizung bei der Ankunft einschalten m√ºssen. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√úberpr√ºfen Sie watercount_pressure</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - wir analysieren den aktuellen und vorherigen Wert und antworten mit einer Meldung auf einen Abfall unter 1 atm und ein Wachstum dar√ºber. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generieren Sie Sendezeichenfolgenz√§hler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- beginnt am 24. eines jeden Monats um 1 Uhr morgens mit cron. Wir √ºberpr√ºfen, ob die Werte jetzt gr√∂√üer sind als die zuletzt gesendeten. Wenn weniger, deaktivieren Sie das automatische Senden und generieren Sie eine Warnung. Wenn OK - wir erinnern uns an die Werte der Z√§hler f√ºr das Senden an das Strafgesetzbuch, senden wir den zuk√ºnftigen Nachrichtentext an das Telegramm. Gleichzeitig sparen wir in watercount_sendStr, wie viel wir im letzten Monat verbraucht haben. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sende-String-Z√§hler generieren</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - startet am 24. Tag um 23.00 Uhr auf cron. √úberpr√ºft, ob das automatische Senden aktiviert ist, wenn es aktiviert ist. Der Helm sendet Z√§hler an die Post der Reederei. Es stellt sich heraus, dass ich den 24. Tag den ganzen Tag Zeit habe, um das automatische Senden zu beheben oder einfach zu reduzieren, wenn in den Telegrammen ein Fehler aufgetreten ist. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update durch Kommentar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ventile drehen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Die Regel zum einmal monatlichen Schlie√üen / √ñffnen des Wasserhahns gegen Kochen. </font><font style="vertical-align: inherit;">Der 25. um 5 Uhr morgens - um nicht in die Arbeit des Geschirrsp√ºlers oder der Waschmaschine zu gelangen, aber selbst wenn er dort ankommt - ist es nicht kritisch, dass die √úberlappung des Wassers etwa 3-4 Sekunden betr√§gt. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und erst hier beginnt das Smart Home ...</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Durch die Kombination von Systemen in einem einzigen Punkt (Openhab) k√∂nnen Sie Logik erstellen, die f√ºr eine Reihe autonomer Systeme nicht verf√ºgbar ist. </font><font style="vertical-align: inherit;">Zum Beispiel: Ein Ereignis mit einer Erh√∂hung des Wasserz√§hlers ist eingetroffen - das Sicherheitssystem ist aktiv, die Schl√∂sser der Vordert√ºr sind geschlossen, der Energieverbrauch des Geschirrsp√ºlers und der Waschmaschine betr√§gt weniger als 5 Watt - was bedeutet, dass ein Leck durch die Sensoren erkannt wird. </font><font style="vertical-align: inherit;">Wir bilden einen Befehl zum Schlie√üen der Kr√§ne und senden eine Nachricht an den Bot im Telegramm. </font><font style="vertical-align: inherit;">Aber das ist sp√§ter wie ein Thread.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de399459/">https://habr.com/ru/post/de399459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de399449/index.html">DNA ist nur halb so gro√ü wie Chromosomen. Alles andere ist eine H√ºlle unbekannter Funktionalit√§t</a></li>
<li><a href="../de399451/index.html">–ü–æ—á–µ–º—É —É –Ω–∞—Å –Ω–µ—Ç –º–ª–∞–¥–µ–Ω—á–µ—Å–∫–∏—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π</a></li>
<li><a href="../de399453/index.html">F√ºnf Formen von Blockchain-Geld sind jetzt verf√ºgbar</a></li>
<li><a href="../de399455/index.html">Nicht nur Haushaltsger√§te: Was gibt es sonst noch in Audiomania f√ºr Musikliebhaber, Liebhaber und Musiker?</a></li>
<li><a href="../de399457/index.html">Russisches FinTech-Meetup Nr. 2: Handel im digitalen Zeitalter</a></li>
<li><a href="../de399461/index.html">K√ºnstliche Intelligenz hilft Menschen, Phobien und √Ñngste loszuwerden</a></li>
<li><a href="../de399463/index.html">Multicopter lernte, auf den D√§chern von fahrenden Autos zu sitzen</a></li>
<li><a href="../de399469/index.html">Das neuronale Netzwerk von Pix2pix f√§rbt Bleistiftskizzen und Schwarzwei√üfotos realistisch</a></li>
<li><a href="../de399471/index.html">Weltraumwohnungen, Teil 5: Wie wir auf Merkur leben werden (oder nicht)</a></li>
<li><a href="../de399473/index.html">Chip Intel 4004 wurde 45 Jahre alt. Ein bisschen IT-Geschichte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>