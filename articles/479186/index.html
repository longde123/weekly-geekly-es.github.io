<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143967986-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-143967986-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ì üëãüèø üìï On the structure of parallel computing or the arguments against the ‚ÄúGo‚Äù operator üßõüèø üßëüèº üå¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Each language that supports parallel (competitive, asynchronous) computing needs a way to run code in parallel. Here are examples from different APIs:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>On the structure of parallel computing or the arguments against the ‚ÄúGo‚Äù operator</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479186/"><p><img src="https://habrastorage.org/getpro/habr/post_images/85d/e9d/a9e/85de9da9eebff2dc7806d48e9b71706e.png"></p><br><p>  Each language that supports parallel (competitive, asynchronous) computing needs a way to run code in parallel.  Here are examples from different APIs: </p><br><pre><code class="plaintext hljs">go myfunc(); // Golang pthread_create(&amp;thread_id, NULL, &amp;myfunc); /* C with POSIX threads */ spawn(modulename, myfuncname, []) % Erlang threading.Thread(target=myfunc).start() # Python with threads asyncio.create_task(myfunc()) # Python with asyncio</code> </pre> <br><p>  There are many options for notation and terminology, but one semantics is to run <code>myfunc</code> in parallel with the main program and continue the parent <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA_%25D0%25B2%25D1%258B%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F" rel="nofollow">thread of execution</a> (Eng. "Control Flow") </p><a name="habracut"></a><br><p>  Another option is <a href="https://ru.wikipedia.org/wiki/Callback_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)" rel="nofollow">Callbacks</a> : </p><br><pre> <code class="plaintext hljs">QObject::connect(&amp;emitter, SIGNAL(event()), // C++ with Qt &amp;receiver, SLOT(myfunc())) g_signal_connect(emitter, "event", myfunc, NULL) /* C with GObject */ document.getElementById("myid").onclick = myfunc; // Javascript promise.then(myfunc, errorhandler) // Javascript with Promises deferred.addCallback(myfunc) # Python with Twisted future.add_done_callback(myfunc) # Python with asyncio</code> </pre> <br><p>  And again, the notation changes, but all the examples make it so that, starting from the current moment, if and when a certain event happens, then <code>myfunc</code> start.  Once callback is set, control returns and the calling function continues.  (Sometimes callbacks are wrapped in <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" rel="nofollow">convenient</a> <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise/race" rel="nofollow">combining</a> functions or <a href="https://twistedmatrix.com/documents/current/core/howto/servers.html" rel="nofollow">Twisted-style protocols</a> , but the basic idea is unchanged.) </p><br><p>  And it's all.  Take any popular concurrency general purpose language and you will probably find that it falls into one of these paradigms (sometimes both, asyncio). </p><br><p>  But not my new weird <a href="https://trio.readthedocs.io/" rel="nofollow">Trio</a> library.  She does not use these approaches.  Instead, if we want to run <code>myfunc</code> and <code>anotherfunc</code> in parallel, we write something like this: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> trio.open_nursery() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> nursery: nursery.start_soon(myfunc) nursery.start_soon(anotherfunc)</code> </pre> <br><blockquote>  nursery - nursery, nursery </blockquote><p>  For the first time faced with the design of "nursery", people are lost.  Why is there <a href="https://pythonworld.ru/osnovy/with-as-menedzhery-konteksta.html" rel="nofollow">a context manager</a> (with-block)?  What is this nursery, and why is it needed to run a task?  Then people understand that the nursery interferes with the usual approaches in other frameworks and get angry.  Everything seems bizarre, specific, and too high-level to be a basic primitive.  All these are understandable reactions!  But bear with it a little. </p><br><p>  <strong>In this article, I want to convince you that nurseries are not a fad, but rather a new primitive for controlling the flow of execution, as fundamental as loops and function calls.</strong>  <strong>Moreover, the approaches discussed above (creating threads and registering callbacks) need to be discarded and replaced by nurseries.</strong> </p><br><p>  Sounds too bold?  But this has already happened: once <code>goto</code> widely used to control the behavior of a program.  Now this is an occasion to laugh: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c37/12a/b90/c3712ab9028c26f7ff089f3ff14e9071.png"></p><br><p>  Several languages ‚Äã‚Äãstill have the so-called <code>goto</code> , but its capabilities are much more limited than the original <code>goto</code> .  And in most languages ‚Äã‚Äãit is not at all.  What happened to him?  This story is surprisingly relevant, although unfamiliar to most because of its antiquity.  Let's remind ourselves what <code>goto</code> , and then see how this can help in asynchronous programming. </p><br><h1 id="oglavlenie">  Table of contents </h1><br><ul><li>  What is goto? </li><li>  What is go? </li><li>  What happened to goto? <br><ul><li>  goto destroys abstraction </li><li>  Brave new world without goto </li><li>  No more goto </li></ul></li><li>  About the dangers of ‚ÄúGo‚Äù type expressions <br><ul><li>  go expressions break abstractions. </li><li>  go-expressions break the auto-cleaning of open resources. </li><li>  go expressions break error handling. </li><li>  No more go </li></ul></li><li>  Nursery as a structural replacement for go <br><ul><li>  The nursery retains the abstraction of functions. </li><li>  Nursery support dynamic adding tasks. </li><li>  You can still leave the nursery. </li><li>  You can identify new types that quack as a nursery. </li><li>  No, however, nurseries are always waiting for the completion of all tasks inside. </li><li>  Works automatic cleaning of resources. </li><li>  Bug raising works. </li><li>  Brave new world without go </li></ul></li><li>  Nurseries in practice </li><li>  conclusions </li><li>  Comments </li><li>  Acknowledgments </li><li>  Footnotes </li><li>  about the author </li><li>  Continuation </li></ul><br><h1 id="chto-takoe-goto">  What is <code>goto</code> ? </h1><br><p>  The first computers were programmed using <a href="https://ru.wikipedia.org/wiki/%25D0%25AF%25D0%25B7%25D1%258B%25D0%25BA_%25D0%25B0%25D1%2581%25D1%2581%25D0%25B5%25D0%25BC%25D0%25B1%25D0%25BB%25D0%25B5%25D1%2580%25D0%25B0" rel="nofollow">assembler</a> , or even more primitively.  This is not very convenient.  So in the 1950s, people such as <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D1%258D%25D0%25BA%25D1%2583%25D1%2581,_%25D0%2594%25D0%25B6%25D0%25BE%25D0%25BD" rel="nofollow">John Backus</a> of IBM and <a href="https://ru.wikipedia.org/wiki/%25D0%25A5%25D0%25BE%25D0%25BF%25D0%25BF%25D0%25B5%25D1%2580,_%25D0%2593%25D1%2580%25D0%25B5%25D0%25B9%25D1%2581" rel="nofollow">Grace Hopper</a> of <a href="https://ru.wikipedia.org/wiki/Remington_Rand" rel="nofollow">Remington Rand</a> began developing languages ‚Äã‚Äãsuch as <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25BE%25D1%2580%25D1%2582%25D1%2580%25D0%25B0%25D0%25BD" rel="nofollow">FORTRAN</a> and <a href="https://en.wikipedia.org/wiki/FLOW-MATIC" rel="nofollow">FLOW-MATIC</a> (better known for its direct descendant <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D0%25B1%25D0%25BE%25D0%25BB" rel="nofollow">COBOL</a> ). </p><br><p>  FLOW-MATIC was very ambitious at the time.  You can think of it as the great-great-great-great-grandfather of Python - it was the first language developed primarily for people, and the second for computers.  He looked like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/620/bfd/d70/620bfdd7076dd6c0536f75a0dd187cd4.png"></p><br><p>  Note that unlike modern languages, there are no conditional <code>if</code> blocks, loops or function calls - in fact there are no blocks or indents at all.  This is just a sequential list of expressions.  Not because this program is too short to require control <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)" rel="nofollow">statements</a> (other than <code>JUMP TO</code> ) - just such a syntax has not yet been invented! </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/eaa/d88/f7b/eaad88f7b6d97d7140f33cf48bb52a55.png"></p><br><p>  Instead, FLOW-MATIC had two options for controlling the flow of execution.  Usually the flow was consistent - start from the top and move down, one expression at a time.  But if you execute the special <code>JUMP TO</code> expression, it could take control somewhere else.  For example, expression (13) jumps to expression (2): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/753/de0/ae9/753de0ae91dc198fa867707d441fc511.png"></p><br><p>  Just as with the primitives of parallelism from the beginning of the article, then there was no agreement on what to call this ‚Äútake one-way jump‚Äù operation.  In the listing, this is <code>JUMP TO</code> , but <code>goto</code> historically taken root (like "go there"), which I use here. </p><br><p>  Here is the complete set of <code>goto</code> jumps in this small program: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/32a/127/4f4/32a1274f45c48110468e47083437bf29.png"></p><br><p>  This seems confusing not only to you!  FLOW-MATIC inherited this jumping-based programming style directly from assembler.  It is powerful, well close to how the computer hardware actually works, but it is very difficult to work directly with it.  This ball of arrows is the reason for the invention of the term "spaghetti code." </p><br><p>  But why did <code>goto</code> cause such a problem?  Why are some control statements good and others not?  How to choose the good ones?  At that time it was completely incomprehensible, and if you do not understand the problem, it is difficult to solve. </p><br><h1 id="chto-takoe-go">  What is <code>go</code> ? </h1><br><p>  Let's digress from our story.  Everyone knows <code>goto</code> was bad, but what does this have to do with asynchrony?  Look at the famous <code>go</code> expression from Golang, which is used to spawn the new "goroutine" (lightweight stream): </p><br><pre> <code class="plaintext hljs">// Golang go myfunc();</code> </pre> <br><p>  Is it possible to draw a diagram of its flow of execution?  It is slightly different from the diagram above, because here the stream is divided.  Let's draw it like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7b4/5ed/524/7b45ed524dc3bcd7625f5aaf60497607.png"></p><br><p>  The colors here are meant to show that <em>both</em> paths are chosen.  From the point of view of the parent goroutine (green line) - the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA_%25D0%25B2%25D1%258B%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F" rel="nofollow">control flow is</a> executed sequentially: it starts from above and then immediately goes down.  Meanwhile, from the point of view of the descendant function (lilac line), the stream comes from above and then jumps into the body of <code>myfunc</code> .  Unlike a regular function call, there is a one-way jump - starting <code>myfunc</code> we switch to a completely new <em>stack</em> and the <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2580%25D0%25B5%25D0%25B4%25D0%25B0_%25D0%25B2%25D1%258B%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F" rel="nofollow">runtime</a> immediately forgets where we came from. </p><br><blockquote>  apparently I mean <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D0%25B5%25D0%25BA_%25D0%25B2%25D1%258B%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25BE%25D0%25B2" rel="nofollow">the call stack</a> </blockquote><p>  But this applies not only to Golang.  This diagram is true for <em>all</em> primitives (controls) listed at the beginning of the article: </p><br><ul><li>  Threading libraries usually return some kind of control object that will allow them to join the thread later - but this is an independent operation that the language itself knows nothing about.  The primitive for creating a new thread has the diagram shown above. </li><li>  Callback registration is semantically equivalent to creating a background thread (although it‚Äôs obvious that the implementation is different), which: <br>  a) is blocked until an event occurs, and then <br>  b) launches a callback function <br>  So, in terms of high-level control operators, callback registration is an expression identical to <code>go</code> . </li><li>  With <code>Futures</code> and <code>Promises</code> the same thing - when you run the function and it returns <code>Promise</code> , it means that it planned to work in the background and returns a control object to get the result later (if you want).  From the point of view of management semantics, it is the same as creating a flow.  After that, you pass the callback to Promis and then as in the previous paragraph. </li></ul><br><p>  This same pattern shows itself in many forms - the key similarity is that in all these cases the control flow is divided - a jump is made to the new thread, but the parent returns to the one who called it.  Knowing what to look at, you will see it everywhere!  This is an interesting game (at least for some types of people)! </p><br><p>  Still, it annoys me that there is no standard name for this category of control statements.  I use the expression <strong>‚Äúgo‚Äù</strong> to call them, just as <strong>‚Äúgoto‚Äù</strong> has become a generic term for all <code>goto</code> expressions.  Why <code>go</code> ?  One reason is that Golang gives us a very clean example of such syntax.  And the other one is: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/1ad/41c/8e1/1ad41c8e1896e247183cd25d08b353f5.png"></p><br><p>  Notice the similarity?  That's right - <strong><code>go</code> is one of the <code>goto</code> forms.</strong> </p><br><p>  Asynchronous programs are notorious for the difficulty of writing and analyzing.  As well as programs based on <code>goto</code> .  The problems caused by <code>goto</code> mostly resolved in modern languages.  If we learn how to fix <code>goto</code> , will this help to create more convenient asynchronous APIs?  Let's find out! </p><br><h1 id="chto-sluchilos-s-goto">  What happened to <code>goto</code> ? </h1><br><p>  So what's wrong with <code>goto</code> that causes so many problems?  In the late 60s, <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B5%25D0%25B9%25D0%25BA%25D1%2581%25D1%2582%25D1%2580%25D0%25B0,_%25D0%25AD%25D0%25B4%25D1%2581%25D0%25B3%25D0%25B5%25D1%2580_%25D0%2592%25D0%25B8%25D0%25B1%25D0%25B5" rel="nofollow">Edsger Wee Dijkstra</a> wrote a couple of works now known that helped to understand this much more clearly: The <a href="http://khpi-iip.mipk.kharkiv.edu/library/extent/dijkstra/pp/ewd215.html" rel="nofollow">arguments against the goto operator</a> and <a href="http://khpi-iip.mipk.kharkiv.edu/library/extent/dijkstra/ewd249/index.html" rel="nofollow">Notes on structural programming</a> . </p><br><h2 id="goto-razrushaet-abstrakcii">  <code>goto</code> destroys abstraction </h2><br><p>  In these works, Dijkstra worried about how we write non-trivial programs and ensure their correctness.  There are many interesting points.  For example, you probably heard this phrase: </p><br><blockquote>  Testing programs can show the presence of errors, but never their absence. </blockquote><p>  Yes, this is from <em>Structural Programming Notes</em> .  But his main concern was <em>abstraction</em> .  He wanted to write programs too big to hold them in their head.  To do this, you must treat the parts of the program as black boxes - for example, you see this program in Python: </p><br><pre> <code class="python hljs">print(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>)</code> </pre> <br><p>  and you don‚Äôt need to know all the details of how <code>print</code> (line formatting, buffering, cross-platform differences, etc.).  All you need to know is that <code>print</code> will somehow print the text you passed in, and you can concentrate on what you want to do in this piece of code.  Dijkstra wanted languages ‚Äã‚Äãto support this type of abstraction. </p><br><p>  At this point, block syntax was invented and languages ‚Äã‚Äãlike ALGOL accumulated ~ 5 different types of control statements: they still had a sequential thread of execution and <code>goto</code> : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/eaa/d88/f7b/eaad88f7b6d97d7140f33cf48bb52a55.png"></p><br><p>  And also acquired conditions, cycles and function calls: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0d8/de3/a21/0d8de3a217a61b13b2c1f6869f706d6b.png"></p><br><p>  You can implement these high-level constructs using <code>goto</code> , and this is how people thought of them before: as a convenient shortcut.  But Dijkstra pointed out the big difference between <code>goto</code> and the rest of the control operators.  For everything but <code>goto</code> , the thread of execution </p><br><ul><li>  comes from above =&gt; [something happens] =&gt; the flow comes from below </li></ul><br><p>  We can call this the ‚Äúblack box rule‚Äù - if the control structure (control operator) has this form, then in a situation where you are not interested in the details inside, you can ignore the part ‚Äúsomething happens‚Äù and treat the block as with a regular sequential team.  Even better, this is true for any code that is composed of these blocks.  When I look at: </p><br><pre> <code class="python hljs">print(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>)</code> </pre> <br><p>  I don‚Äôt need to read the sources of <code>print</code> and all its dependencies in order to understand where the execution thread will go.  Maybe inside <code>print</code> there is a loop, and in it there is a condition in which there is a call to another function ... it's all not important - I know that the thread will go to <code>print</code> , the function will do its job, and eventually the thread will return to the code that I I read. </p><br><p>  But if you have a language with <code>goto</code> - a language where functions and everything else is built on the basis of <code>goto</code> , and <code>goto</code> can jump anywhere, anytime - then these structures are not black boxes at all!  If you have a function with a loop, inside which there is a condition, and inside it there is <code>goto</code> ... then this <code>goto</code> can pass execution anywhere.  Perhaps control will suddenly return completely from another function that you have not even called!  You do not know! </p><br><p>  And that breaks the abstraction - <em>any function can have a potential <code>goto</code> inside, and the only way to find out if this is the case is to keep all the source code of your system in mind.</em>  Once the language has <code>goto</code> , you cannot predict the flow of execution.  That's <em>why</em> <code>goto</code> leads to spaghetti code. </p><br><p>  And as soon as Dijkstra understood the problem, he was able to solve it.  Here is his revolutionary assumption - we should not think of conditions / loops / function calls as abbreviations for <code>goto</code> , but as fundamental primitives with our rights - and we should completely remove <code>goto</code> from our languages. </p><br><p>  From 2018, this seems pretty obvious.  But how do programmers react when you try to pick up their unsafe toys?  In 1969, Dijkstra's proposal seemed incredibly dubious.  <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BD%25D1%2583%25D1%2582,_%25D0%2594%25D0%25BE%25D0%25BD%25D0%25B0%25D0%25BB%25D1%258C%25D0%25B4_%25D0%25AD%25D1%2580%25D0%25B2%25D0%25B8%25D0%25BD" rel="nofollow">Donald Knuth</a> <a href="https://scholar.google.com/scholar%3Fcluster%3D17147143327681396418%26hl%3Den%26as_sdt%3D0,5" rel="nofollow">defended</a> <code>goto</code> .  People who became experts in writing code with <code>goto</code> were rightly indignant against having to re-learn how to express their ideas in new, more restrictive terms.  And of course, it took to create completely new languages. </p><br><p>  As a result, modern languages ‚Äã‚Äãare a little less strict than Dijkstra's original wording. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/385/9c2/6dc/3859c26dcf65e23a85415a039974645f.jpg"></p><br><blockquote>  Left: traditional <code>goto</code> .  Right: Domesticated <code>goto</code> , as in C, C #, Golang, etc.  Failure to cross the boundaries of a function means that he can still pee on your shoes, but is unlikely to rip you apart. </blockquote><p>  They allow you to jump the nesting levels of structural control statements using <code>break</code> , <code>continue</code> , or <code>return</code> .  But at a basic level, they are all built around Dijkstra's idea and can disrupt the sequential flow of execution in a strictly limited way.  In particular, functions ‚Äî a fundamental tool for wrapping a thread of execution in a black box ‚Äî are indestructible.  You cannot execute the <code>break</code> command from one function to another and <code>return</code> cannot return you further than the current function.  No manipulation of the thread of execution inside the function will affect other functions. </p><br><p>  And the languages ‚Äã‚Äãthat preserved the <code>goto</code> operator (C, C #, Golang, ...) severely limited it.  At a minimum, they do not allow you to jump from the body of one function to another.  If you are not using Assembler [2], the classic, unlimited <code>goto</code> is a thing of the past.  Dijkstra won. </p><br><h2 id="divnyy-novyy-mir-bez-goto">  Brave new world without goto </h2><br><p>  Something interesting happened with the disappearance of <code>goto</code> - the language creators were able to start adding new features based on a structured flow of execution. </p><br><p>  For example, Python has a cool syntax for automatically clearing resources - <a href="https://pythonworld.ru/osnovy/with-as-menedzhery-konteksta.html" rel="nofollow">a context manager</a> .  You can write: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># Python with open("my-file") as file_handle: some code</span></span></code> </pre> <br><p>  and this ensures that the file will be opened at runtime <code>some code</code> but after that - immediately closed.  Most modern languages ‚Äã‚Äãhave equivalents ( <a href="https://rurust.github.io/rust-by-example-ru/scope/raii.html" rel="nofollow">RAII</a> , <code>using</code> , try-with-resource, <code>defer</code> , ...).  And they all assume that the control flow is in order.  And what happens if we jump into the <code>with</code> block using <code>goto</code> ?  Is the file open or not?  And if we jump out of there instead of leaving as usual? </p><br><blockquote>  after the code inside the block is completed, <code>with</code> starts the <code>__exit__()</code> method which closes open resources, such as files and connections. </blockquote><p>  Will the file close?  In <code>goto</code> , context managers simply don't work in a clear way. </p><br><p>  The same problem with error handling - when something goes wrong, what should the code do?  Often - send a description of the error up the stack (of calls) to the calling code and let it decide what to do.  Modern languages ‚Äã‚Äãhave constructions specifically for this, such as Exceptions or other forms of <a href="https://doc.rust-lang.ru/stable/rust-by-example/error/result/enter_question_mark.html" rel="nofollow">automatic error raising</a> .  But this help is only available if the language has a call stack and a robust "call" concept.  Recall the spaghetti in the flow example in the FLOW-MATIC example and imagine the exception thrown in the middle.  Where can it even come? </p><br><h2 id="bolshe-nikakih-goto">  No more <code>goto</code> </h2><br><p>  So, the traditional <code>goto</code> - which ignores function boundaries - is bad not only because it is difficult to use correctly.  If only this, <code>goto</code> could have stayed - many bad language constructs remained. </p><br><p>  But even the very <code>goto</code> feature in the language makes <em>everything</em> more complicated.  Third-party libraries can not be considered a black box - without knowing the source, you can‚Äôt figure out which functions are normal and which unpredictably control the flow of execution.  This is a major obstacle to predicting local code behavior.  Powerful features such as context managers and automatic error pop-ups are also lost.  It is better to remove <code>goto</code> altogether, in favor of control operators that support the black box rule. </p><br><h1 id="o-vrede-vyrazheniy-tipa-go">  About the dangers of expressions like "Go" </h1><br><p>  So, we looked at the <code>goto</code> story.  But is it applicable to the <code>go</code> operator?  Well ... all in all!  The analogy is shockingly accurate. </p><br><h2 id="go-vyrazheniya-lomayut-abstrakcii">  go expressions break abstractions. </h2><br><p>  Remember how we said that if the language allows <code>goto</code> , then any function can hide <code>goto</code> in itself?  In most asynchronous frameworks, <code>go</code> expressions lead to the same problem - any function may (or may not) run the task in the background.  It looks like the function has returned control, but does it still work in the background?  And there is no way to find out without reading the source of the function and everything that it calls.  And when will it end?  Hard to say.  If you have <code>go</code> and its analogues, then functions are no longer black boxes that respect the flow of execution.  In my first article on <a href="https://vorpus.org/blog/some-thoughts-on-asynchronous-api-design-in-a-post-asyncawait-world/" rel="nofollow">asynchronous APIs</a> , I called this a ‚Äúcausation violation‚Äù and found that this is the root cause of many common, real problems in programs using <code>asyncio</code> and Twisted, such as flow control problems, problems with proper shutdowns, etc. </p><br><blockquote>  This refers to the control of the flow of data entering and leaving the program.  For example, the program receives data at a speed of 3MB / s, and leaves at a speed of 1MB / s, and accordingly the program consumes more and more memory, see <a href="https://vorpus.org/blog/some-thoughts-on-asynchronous-api-design-in-a-post-asyncawait-world/" rel="nofollow">another article by the author</a> </blockquote><br><h2 id="go-vyrazheniya-lomayut-avtoochistku-otkrytyh-resursov">  go-expressions break the auto-cleaning of open resources. </h2><br><p>  Let's take a look at an example <code>with</code> statement again: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># Python with open("my-file") as file_handle: some code</span></span></code> </pre> <br><p>  Earlier we said that we were ‚Äúguaranteed‚Äù that the file would be open while <code>some code</code> working, and closed after.  But what if <code>some code</code> starts a background task?    : ,  <em></em> ,     <code>with</code> ,      <em></em>   <code>with</code> ,   ,    ,      .  ,       ;   ,       ,   <code>some code</code> . </p><br><p>   ,     ,   -      ,   ,        . </p><br><blockquote>       ,   Python  <code>threading</code> ‚Äî       ,        ,          ‚Äî   ,    <code>with</code> </blockquote><p>  ,    ,     ,     (       ).     ,        .     ,     . </p><br><h2 id="go-vyrazheniya-lomayut-obrabotku-oshibok"> go-   . </h2><br><p>    ,     ,    (exceptions),          .        " ".         ,   .  ,      ,  .      ,       ,   ‚Ä¶      ,      .   ,   -  . (   ,   ,   " -   "     ‚Äî     ;      .)  Rust ‚Äî , ,        -     ‚Äî    .     (thread) , Rust <a href="https://doc.rust-lang.org/std/thread/" rel="nofollow">     </a> . </p><br><p> ,  <em></em>      ,  join         ,   <a href="https://twistedmatrix.com/documents/current/core/howto/defer.html" rel="nofollow">errbacks  Twisted</a>  <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch" rel="nofollow">Promise.catch  Javascript</a> .     ,   ,     .     ,  Traceback  .       <code>Promise.catch</code>       . </p><br><p>      ,       . </p><br><h2 id="bolshe-nikakih-go">   <code>go</code> </h2><br><p> ,  <code>goto</code>        , go-         ‚Äî    ,    ,   ,      .  ,   <code>goto</code> ,     ,     <code>go</code>        . </p><br><p>    ,     ,     !  : </p><br><ul><li>    <code>go</code> -,    ,   "  ", </li><li>        ,    <code>go</code> -. </li></ul><br><p>   ,   <a href="https://trio.readthedocs.io/en/stable/" rel="nofollow">Trio</a> . </p><br><h1 id="pitomnik-kak-strukturnaya-zamena-go">     <code>go</code> </h1><br><p>   :  ,        ,   ,    . ,       ,       : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b13/280/671/b13280671e22430f5417a99dde464344.png"></p><br><p> ,      ,     ,     "  " . </p><br><p>         ?     " " ,  </p><br><p> )      ,   ,    (      ),  <br> )       ,             . </p><br><p>       .   ,        - .      ,       ..  [3] </p><br><p>     : ,  ,        ,     <strong>""</strong> ,    .  Trio   ,    <code>async with</code> : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/22b/0fe/266/22b0fe2660255eede7befcff37f099b9.png"></p><br><p>       ,   <code>as nursery</code>     <code>nursery</code> .      <code>nursery.start_soon()</code> ,    () :      <code>myfunc</code>  <code>anotherfunc</code> .     <em></em> .     ,   ,    () ,   ,   . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cbb/a00/adc/cbba00adc39a2f528626284bbf4a7e55.png"></p><br><p>  ,    ,        ‚Äî        ,    ,       .   ,   . </p><br><blockquote> ,     . </blockquote><p>              : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/017/9df/9f1/0179df9f11831897e5e231edc5d43a20.png"></p><br><p>     ,     .  Here is some of them: </p><br><h2 id="pitomnik-sohranyaet-abstrakciyu-funkciy">    . </h2><br><p>   go- ‚Äî    , ,      ,      .         ‚Äî          ,      ,     .      ,  ,    . </p><br><h2 id="pitomnik-podderzhivayut-dinamicheskoe-dobavlenie-zadach">     . </h2><br><p>    ,        .         : </p><br><pre> <code class="go hljs">run_concurrently([myfunc, anotherfunc])</code> </pre> <br><blockquote> async.gather  Python, Promise.all  Javascript,  .. </blockquote><p>    ,        ,    ,    . ,       <code>accept</code> ,             . <br>   <code>accept</code>   Trio: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> trio.open_nursery() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> nursery: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: incoming_connection = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> server_socket.accept() nursery.start_soon(connection_handler, incoming_connection)</code> </pre> <br><p>    ,   ,  <code>run_concurrently</code>    .   ,    <code>run_concurrently</code>    ‚Äî    ,     ,   <code>run_concurrently</code> ,     . </p><br><h2 id="iz-pitomnika-vsyo-eschyo-mozhno-vyyti">      . </h2><br><p>     .      ,    ,      ? :      .  ,    <code>async with open_nursery()</code>   <code>nursery.start_soon()</code> , ‚Äî    [4], ,     ,      .       ,    ,  . </p><br><p>    ,     ,  " ",    : </p><br><ul><li>     ,     ,      ,     ,    ,    . </li><li>         ,   . </li><li>        ,    . </li></ul><br><p>          ,              . </p><br><p>    ,    ,  go-,       . </p><br><h2 id="vy-mozhete-opredelit-novye-tipy-kotorye-kryakayut-kak-pitomnik">     ,    . </h2><br><p>      ,     - .                ,    ,   .            : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> my_supervisor_library.open_supervisor() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> nursery_alike: nursery_alike.start_soon(...)</code> </pre> <br><p>       ,       ,     .  . </p><br><p>  Trio     ,  <code>asyncio</code>    : <code>start_soon()</code>   ,     <code>Future</code> (     ,       <code>Future</code> ).  ,        ( ,   Trio   <code>Future</code> !),       . </p><br><h2 id="net-pravda-pitomniki-vsegda-zhdut-okonchaniya-vseh-zadach-vnutri"> , ,  <em></em>     . </h2><br><p>           ,     ,   ‚Äî     ‚Äî   . </p><br><p>  Trio,          .     ,   ,    " " ( <a href="https://trio.readthedocs.io/en/latest/reference-core.html" rel="nofollow"></a> ),   <code>Cancelled</code> .  ,        ,    <em></em> ‚Äî   - ,      " ",        ,    ..   ,   ,    .  <em></em>   ,       ,   <em></em>        ,      . </p><br><h2 id="rabotaet-avtomaticheskaya-ochistka-resursov">    . </h2><br><p>     "  ",  <code>with</code>  . ,      <code>with</code>     ,      . </p><br><h2 id="rabotaet-podnyatie-oshibok">   . </h2><br><p>   ,    ,       .      . </p><br><p>  Trio,     ,         ‚Ä¶    -    .      ,      .   ,   ‚Äî     " " ‚Äî     ,     <code>myfunc</code>  <code>anotherfunc</code> ,       .         ,  ,       . </p><br><p> ,    :    (re-raise)    ,    .    ,       </p><br><blockquote>  " " ,  ,      ,     ,   ,   . </blockquote><p>    ,       ,      .    ? </p><br><p>  ‚Äî    ( )   ,                .   ,      ,            ,      ,   . </p><br><p>   ,         ,    -          ( <a href="https://docs.microsoft.com/en-us/dotnet/standard/parallel-programming/task-cancellation" rel="nofollow">task cancellation</a> ).        C#  Golang,                ‚Äî       . </p><br><h2 id="divnyy-novyy-mir-bez-go">     <code>go</code> </h2><br><p>  <code>goto</code>           ,        <code>with</code>  ;  <code>go</code> -   .  For instance: </p><br><ul><li>        ,   ,   ,       . ( : <a href="https://vorpus.org/blog/timeouts-and-cancellation-for-humans/" rel="nofollow">    -</a> ) </li><li>  ‚Äî  Python    ,  <code>ctrl-C</code>    ( <a href="https://vorpus.org/blog/control-c-handling-in-python-and-trio/" rel="nofollow"></a> ).    ,         . </li></ul><br><h1 id="pitomniki-na-praktike">    </h1><br><p> ,   .      ? </p><br><p> ‚Ä¶   :     ! ,     ,     .       ,          , ,         <code>break</code>  <code>continue</code> . </p><br><p>        ,      .   <a href="https://stackoverflow.com/questions/48282841/in-trio-how-can-i-have-a-background-task-that-lives-as-long-as-my-object-does" rel="nofollow">     </a> ‚Äî  ,   1970   ,     <code>goto</code> . </p><br><p>      .    (Knuth, 1974, .275): </p><br><blockquote>   ,         <code>goto</code> ,  ,  " "            <code>goto</code> .  <code>goto</code>   !    ,       ,        <code>goto</code> ,          . ,     ,      . ,      ‚Äî ,     ‚Äî    "goto" . </blockquote><p>        :    .    ,   ,         .     ,     ,      .  ,    ,     . </p><br><p> ,    Happy Eyeballs ( <a href="https://tools.ietf.org/html/rfc8305" rel="nofollow">RFC 8305</a> ),       TCP . ,   ‚Äî     ,   ,     .     <a href="https://github.com/twisted/twisted/compare/trunk...glyph:statemachine-hostnameendpoint" rel="nofollow"> Twisted </a> ‚Äî   600    Python       <a href="https://twistedmatrix.com/trac/ticket/9345" rel="nofollow">  </a> .      15 .  ,        ,  ,       .           ,   ,       .    ,  <a href="https://www.youtube.com/watch%3Fv%3Di-R704I8ySE" rel="nofollow"> </a> .    ?  Time will tell.   . </p><br><h1 id="vyvody">  conclusions </h1><br><p>     ‚Äî  <code>go</code> ,   , , <code>Futures</code> , <code>Promises</code> ,‚Ä¶   ‚Äî   <code>goto</code> ,    .      <code>goto</code> ,    -- <code>goto</code> ,    .   ,      ,                 ;      ,        . ,   <code>goto</code> ,       . </p><br><p>      ,      ,    (         <code>CTRL+C</code> )        ,    . </p><br><p>  ,     ,     ,  ,        ‚Äî  ,   <code>goto</code>    .       FLOW-MATIC   ,    ,     - .   ,       ,  <a href="https://trio.readthedocs.io/en/stable/" rel="nofollow">Trio</a> ,      ,   . </p><br><h1 id="kommentarii">  Comments </h1><br><p>   <a href="https://trio.discourse.group/t/discussion-thread-notes-on-structured-concurrency-or-go-statement-considered-harmful/25" rel="nofollow">     Trio</a> . </p><br><blockquote>       : <br><ul><li>    "What colour is your function?", <a href="https://habr.com/ru/post/466337/"></a> </li><li>     : <a href="https://lukasa.co.uk/2016/07/The_Function_Colour_Myth/" rel="nofollow">The Function Colour Myth</a> </li></ul><br><br>   Trio  : <a href="https://trio.discourse.group/" rel="nofollow">https://trio.discourse.group/</a> </blockquote><br><h1 id="blagodarnosti">  Acknowledgments </h1><br><p>   Graydon Hoare, Quentin Pradet, and Hynek Schlawack      .   ,  ,    . </p><br><blockquote>    <a href="https://habr.com/users/berez/">berez</a>     . </blockquote><p>  :  FLOW-MATIC   <a href="http://archive.computerhistory.org/resources/text/Remington_Rand/Univac.Flowmatic.1957.102646140.pdf" rel="nofollow"> </a> (PDF),  <a href="http://www.computerhistory.org/collections/catalog/102646140" rel="nofollow">  </a> . </p><br><p> Wolves in Action,  Martin Pannier,   <a href="https://creativecommons.org/licenses/by-nc-sa/2.0/" rel="nofollow">CC-BY-SA 2.0</a> , . <br> <a href="https://pixabay.com/en/french-bulldog-pet-dog-funny-2427629/" rel="nofollow"> </a> ,  Daniel Borker,   <a href="https://creativecommons.org/publicdomain/zero/1.0/" rel="nofollow">CC0 public domain dedication</a> . </p><br><h1 id="snoski">  Footnotes </h1><br><p> [2]  WebAssembly  ,          <code>goto</code> : <a href="https://www.w3.org/TR/wasm-core-1/" rel="nofollow"></a> , <a href="" rel="nofollow"></a> </p><br><p> [3]  ,        ,   ,       ,       : <br> The "parallel composition" operator in Cooperating/Communicating Sequential Processes and Occam, the fork/join model, Erlang supervisors,  Martin S√∫strik's  <a href="http://250bpm.com/blog:71" rel="nofollow"> </a>    <a href="https://github.com/sustrik/libdill" rel="nofollow">libdill</a> ,  <a href="https://docs.rs/crossbeam/0.3.2/crossbeam/struct.Scope.html" rel="nofollow">crossbeam::scope</a> / <a href="https://docs.rs/rayon/1.0.1/rayon/fn.scope.html" rel="nofollow">rayon::scope</a>  Rust.         <a href="https://godoc.org/golang.org/x/sync/errgroup" rel="nofollow">golang.org/x/sync/errgroup</a>  <a href="https://godoc.org/github.com/oklog/run" rel="nofollow">github.com/oklog/run</a>  Golang. <br>   ,    - . </p><br><p> [4]   <code>start_soon()</code>  ,   ,  <code>start_soon</code>  ,    ,    ,     .       ,         . </p><br><h1 id="ob-avtore">  about the author </h1><br><p> <a href="https://vorpus.org/" rel="nofollow">Nathaniel J. Smith</a> , Ph.D.,   UC Berkeley   <code>numpy</code> ,        Python    .  Nathaniel                . </p><br><h1 id="prodolzhenie">  Continuation </h1><br><p>             : </p><br><ul><li> <a href="https://habr.com/ru/post/466337/">   </a> ,  Bob Nystrom      </li><li> <a href="https://habr.com/ru/post/466337/"></a>        ,  <a href="https://habr.com/ru/post/466337/"></a>  golang </li><li>  <a href="https://habr.com/ru/post/469441/"> </a> ,   <a href="https://habr.com/ru/users/PsyHaSTe/">PsyHaSTe</a>       Haskell, Golang  C# </li><li>          : <a href="https://habr.com/ru/post/469441/">Go</a> , <a href="https://habr.com/ru/post/469441/">Go</a> , <a href="https://habr.com/ru/post/469441/">python</a> , <a href="https://habr.com/ru/post/469441/">C#</a> (,     JS) </li></ul><br><p>  ,  ,   ,  Haskell      ,      ,           . </p><br><p>       ( <a href="https://habr.com/ru/users/yourock/"> </a> , <a href="https://habr.com/ru/users/0xd34df00d/"> 0xd34df00d</a> , <a href="https://habr.com/ru/users/PsyHaSTe/"></a> )    ,       ( <a href="https://tools.ietf.org/html/rfc8305" rel="nofollow">Happy Eyeballs</a> ),         . </p><br><p>  ,  Trio  ?   Haskell  Golang    ? </p><br><p> <strong> :</strong> </p></div></div><p>Source: <a href="https://habr.com/ru/post/479186/">https://habr.com/ru/post/479186/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479188/index.html">The sum of all natural numbers: 1 + 2 + 3 + 4 + .... Part 2</a></li>
<li><a href="../479192/index.html">Steroid Hypervisor: FreeBSD + ZFS + cbsd</a></li>
<li><a href="../479196/index.html">Most supercomputers run Linux - discuss the situation</a></li>
<li><a href="../479200/index.html">Fractal image compression</a></li>
<li><a href="../479202/index.html">C ++ and Numerical Methods: Approximate Newton-Cotes Integration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter54458986 = new Ya.Metrika({
                  id:54458986,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/54458986" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-143967986-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=IU0EG0jaqnehka2lu5TyzAcchrZXI4Yb1QXKQvJxpqE&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>