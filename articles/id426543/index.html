<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤔 🏥 🤦 Cadangan stateful di Kubernetes 👨🏼‍🎤 👨🏿‍⚕️ 🛡️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jadi, seperti yang diketahui semua orang, DevOpsConfRussia2018 baru-baru ini diadakan di Moskow di “Infraspace” pada 1-2 Oktober. Bagi mereka yang tid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cadangan stateful di Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/426543/"><p>  Jadi, seperti yang diketahui semua orang, <b>DevOpsConfRussia2018</b> baru-baru ini diadakan di Moskow di “Infraspace” pada 1-2 Oktober.  Bagi mereka yang tidak <b>nyaman</b> , <b>DevOpsConf</b> adalah konferensi profesional tentang integrasi pengembangan, pengujian dan proses operasi. </p><br><p>  Perusahaan kami juga ikut serta dalam konferensi ini.  Kami adalah mitranya, mewakili perusahaan di stan kami, dan juga mengadakan pertemuan kecil.  Ngomong-ngomong, ini adalah partisipasi pertama kami dalam kegiatan semacam ini.  Konferensi pertama, mitap pertama, pengalaman pertama. </p><br><p>  Apa yang kita bicarakan?  Mitap berada di topik "Backups in Kubernetes". </p><br><p>  Kemungkinan besar mendengar nama ini, banyak yang akan mengatakan: "Mengapa kembali ke Kubernet?  Tidak perlu didukung, itu Stateless. " </p><br><p><img src="https://habrastorage.org/webt/t7/qd/uy/t7qduyxlblaljfdfs_tduggq0w8.png"></p><a name="habracut"></a><br><h3>  Pendahuluan ... </h3><br><p>  Mari kita mulai dengan sedikit latar belakang.  Mengapa menjadi penting untuk membahas topik ini dan mengapa diperlukan. </p><br><p>  Pada tahun 2016, kami berkenalan dengan teknologi seperti Kubernetes dan mulai secara aktif menerapkannya pada proyek-proyek kami.  Tentu saja, ini terutama proyek-proyek dengan arsitektur microservice, dan ini pada gilirannya memerlukan penggunaan sejumlah besar perangkat lunak yang beragam. </p><br><p>  Dengan proyek pertama di mana kami menggunakan Kubernetes, kami memiliki pertanyaan tentang cara mencadangkan layanan Stateful yang berlokasi di sana, yang terkadang karena suatu alasan atau lainnya jatuh ke dalam k8s. </p><br><p>  Kami mulai mempelajari dan mencari praktik yang ada untuk menyelesaikan masalah ini.  Berkomunikasi dengan kolega dan kawan kami: "Dan bagaimana proses ini dilakukan dan dibangun oleh mereka?" </p><br><p>  Setelah berbicara, kami menyadari bahwa untuk semua ini terjadi dengan metode, cara, dan dengan sejumlah besar kruk.  Namun, kami tidak mengikuti pendekatan terpadu apa pun bahkan <u>dalam kerangka satu proyek</u> . </p><br><p>  Mengapa ini sangat penting?  Karena proyek layanan perusahaan kami didasarkan pada k8, kami hanya perlu mengembangkan metodologi terstruktur untuk menyelesaikan masalah ini. </p><br><p>  Bayangkan Anda bekerja dengan satu proyek khusus di Coober.  Ini berisi beberapa layanan Stateful dan Anda perlu membuat cadangan data mereka.  Pada prinsipnya, di sini Anda dapat melakukan beberapa kruk dan melupakannya.  Tetapi bagaimana jika Anda sudah memiliki dua proyek pada K8?  Dan proyek kedua menggunakan layanan yang sama sekali berbeda dalam pekerjaannya.  Dan jika sudah ada lima proyek?  Sepuluh?  Atau lebih dari dua puluh? </p><br><p>  Tentu saja, mengenakan kruk sudah sulit dan tidak nyaman.  Kami membutuhkan semacam pendekatan terpadu yang dapat digunakan ketika bekerja dengan banyak proyek di Kuba, dan pada saat yang sama, sehingga tim insinyur dapat dengan mudah dan harfiah dalam hitungan menit membuat perubahan yang diperlukan untuk cadangan proyek-proyek ini. </p><br><p>  Dalam kerangka kerja artikel ini, kami hanya akan berbicara tentang alat apa dan praktik apa yang kami gunakan untuk menyelesaikan masalah ini di perusahaan kami. </p><br><h3>  Bagaimana kita melakukan ini? </h3><br><h6>  Nxs-backup apa itu? </h6><br><p>  Untuk cadangan, kami menggunakan alat open source kami sendiri - nxs-backup.  Kami tidak akan membahas detail apa yang dia bisa.  Rincian lebih lanjut dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> berikut. </p><br><p>  Sekarang mari kita beralih ke implementasi backup di k8s.  Bagaimana dan apa sebenarnya yang dilakukan oleh kami. </p><br><h3>  Apa itu cadangan? </h3><br><p> Mari kita lihat contoh cadangan Redmine kita sendiri.  Di dalamnya, kami akan membuat cadangan database MySQL dan file proyek pengguna. </p><br><h3>  Bagaimana kita melakukan ini? </h3><br><h6>  1 CronJob == 1 Layanan </h6><br><p>  Pada server biasa dan cluster pada perangkat keras, hampir semua alat cadangan sebagian besar diluncurkan melalui cron biasa.  Dalam k8s untuk tujuan ini kita menggunakan CronJob, mis. Kita membuat 1 CronJob untuk 1 layanan, yang akan kita backup.  Semua CronJob ini terletak di namespace yang sama dengan layanan itu sendiri. </p><br><p>  Mari kita mulai dengan database MySQL.  Untuk membuat cadangan MySQL, kami membutuhkan 4 elemen, seperti untuk hampir semua layanan lain: </p><br><ul><li>  ConfigMap (nxs-backup.conf) </li><li>  ConfigMap (mysql.conf untuk nxs-backup) </li><li>  Rahasia (akses ke layanan disimpan di sini, dalam hal ini MySQL).  Biasanya, elemen ini sudah ditentukan untuk layanan untuk bekerja dan dapat digunakan kembali. </li><li>  CronJob (untuk setiap layanannya sendiri) </li></ul><br><p>  Mari kita mulai. </p><br><h6>  nxs-backup.conf </h6><br><pre><code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>-conf <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: nxs-backup.conf: |- <span class="hljs-keyword"><span class="hljs-keyword">main</span></span>: server_name: Nixys k8s cluster admin_mail: admins@nixys.ru client_mail: - <span class="hljs-string"><span class="hljs-string">''</span></span> mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@nixys.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file: /dev/stdout jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> <br><p>  Di sini kita mengatur parameter dasar yang dilewatkan ke alat kita, yang diperlukan untuk operasinya.  Ini adalah nama server, email untuk notifikasi, pembatasan konsumsi sumber daya dan parameter lainnya. </p><br><p>  Konfigurasi dapat ditentukan dalam format j2, yang memungkinkan penggunaan variabel lingkungan. </p><br><h6>  mysql.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  File ini menjelaskan logika cadangan untuk layanan terkait, dalam kasus kami ini adalah MySQL. </p><br><p>  Di sini Anda dapat menentukan: </p><br><ul><li>  Apa nama Pekerjaan (bidang: pekerjaan) </li><li>  Jenis pekerjaan (bidang: jenis) </li><li>  Direktori sementara diperlukan untuk mengumpulkan cadangan (bidang: tmp_dir) </li><li>  Opsi koneksi MySQL (bidang: hubungkan) </li><li>  Basis data yang akan didukung (bidang: target) </li><li>  Perlu menghentikan Slave sebelum mengumpulkan (bidang: is_slave) </li><li>  Kunci tambahan untuk mysqldump (bidang: extra_keys) </li><li>  Penyimpanan penyimpanan, mis. Di penyimpanan mana kami akan menyimpan salinan (bidang: penyimpanan) </li><li>  Direktori tempat kami akan menyimpan salinan kami (bidang: backup_dir) </li><li>  Skema penyimpanan (bidang: toko) </li></ul><br><p>  Dalam contoh kami, jenis penyimpanan diatur ke lokal, mis. Kami mengumpulkan dan menyimpan cadangan secara lokal di direktori tertentu dari pod yang diluncurkan. </p><br><p>  Di sini, dengan analogi dengan file konfigurasi ini, Anda dapat menentukan file konfigurasi yang sama untuk Redis, PostgreSQL atau layanan lain yang diperlukan, jika didukung oleh alat kami.  Fakta bahwa itu mendukung dapat ditemukan pada tautan yang diberikan sebelumnya. </p><br><h6>  Mysql rahasia </h6><br><pre> <code class="hljs powershell">apiVersion: v1 kind: Secret metadata: name: app<span class="hljs-literal"><span class="hljs-literal">-config</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: db_name: <span class="hljs-string"><span class="hljs-string">""</span></span> db_host: <span class="hljs-string"><span class="hljs-string">""</span></span> db_user: <span class="hljs-string"><span class="hljs-string">""</span></span> db_password: <span class="hljs-string"><span class="hljs-string">""</span></span> secret_token: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_address: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_domain: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_ssl: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_enable_starttls_auto: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_port: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_auth_type: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_login: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_password: <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p>  Kami menjaga akses rahasia untuk terhubung ke MySQL itu sendiri dan server mail.  Mereka dapat disimpan baik dalam rahasia terpisah, atau mengambil keuntungan dari yang sudah ada, tentu saja, jika ada.  Tidak ada yang menarik di sini.  Rahasia kami juga menyimpan secret_token, yang diperlukan untuk pengoperasian Redmine kami. </p><br><h6>  CronJob MySQL </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_HOST valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_host - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PORT <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'3306'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_user - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PASSWORD valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory restartPolicy: OnFailure</code> </pre> <br><p>  Mungkin elemen ini yang paling menarik.  Pertama, untuk mengkompilasi CronJob yang benar, Anda harus menentukan di mana cadangan yang dikumpulkan akan disimpan. </p><br><p>  Untuk ini kami memiliki server terpisah dengan jumlah sumber daya yang diperlukan.  Dalam contoh ini, node gugus terpisah, nxs-node5, dialokasikan untuk mengumpulkan cadangan.  Pembatasan memulai CronJob pada node yang kita butuhkan diatur oleh direktif nodeAffinity. </p><br><p>  Ketika CronJob dijalankan, direktori terkait terhubung dengannya melalui hostPath dari sistem host, yang digunakan untuk menyimpan salinan cadangan. </p><br><p>  Selanjutnya, ConfigMaps terhubung ke CronJob tertentu, yang berisi konfigurasi untuk nxs-backup, yaitu, file nxs-backup.conf dan mysql.conf yang baru saja kita bicarakan di atas. </p><br><p>  Kemudian, semua variabel lingkungan yang diperlukan diatur, yang didefinisikan langsung dalam manifes atau ditarik dari Secret'ov. </p><br><p>  Jadi, variabel ditransfer ke wadah dan, melalui docker-entrypoint.sh, diganti di ConfigMaps di tempat yang kita butuhkan dengan nilai yang diperlukan.  Untuk MySQL, ini adalah db_host, db_user, db_password.  Dalam hal ini, kami melewatkan port hanya sebagai nilai dalam manifes CronJob, karena ia tidak membawa informasi berharga. </p><br><p>  Nah, dengan MySQL semuanya tampak jelas.  Sekarang mari kita lihat apa yang diperlukan untuk mencadangkan file aplikasi Redmine. </p><br><h6>  desc_files.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: desc-files-conf data: service.conf.j2: |- - job: desc-files type: desc_files tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump_tmp sources: - target: - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/files gzip: yes storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Ini adalah file konfigurasi yang menjelaskan logika cadangan untuk file.  Tidak ada yang tidak biasa di sini, semua parameter yang sama ditetapkan untuk MySQL, dengan pengecualian data otorisasi, karena memang tidak.  Meskipun bisa, jika protokol untuk transfer data terlibat: ssh, ftp, webdav, s3 dan lainnya.  Kami akan mempertimbangkan opsi ini nanti. </p><br><h6>  CronJob desc_files </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir mountPath: /var/www/files - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir persistentVolumeClaim: claimName: redmine-app-files restartPolicy: OnFailure</code> </pre> <br><p>  Tidak ada yang baru, baik, tentang MySQL.  Tapi di sini satu PV tambahan (target-dir) dipasang, yang akan kita buat cadangannya - / var / www / file.  Kalau tidak, semuanya sama, kita menyimpan salinan secara lokal pada simpul yang kita butuhkan, yang ditugaskan CronJob. </p><br><h6>  Ringkasan </h6><br><p>  Untuk setiap layanan yang ingin kami backup, kami membuat CronJob terpisah dengan semua elemen terkait yang diperlukan: ConfigMaps dan Secrets.  Dengan analogi dengan contoh-contoh yang dipertimbangkan, kami dapat membuat cadangan layanan serupa di cluster. </p><br><p>  Saya pikir, berdasarkan dua contoh ini, setiap orang memiliki ide bagaimana kami mendukung layanan Stateful di Kuba.  Saya pikir tidak masuk akal untuk menganalisis secara rinci contoh yang sama untuk layanan lain, karena pada dasarnya mereka semua sama dan memiliki sedikit perbedaan. </p><br><p>  Sebenarnya, inilah yang ingin kami capai, yaitu, semacam <u>pendekatan terpadu</u> untuk membangun proses pencadangan.  Dan agar pendekatan ini dapat diterapkan pada sejumlah besar proyek yang berbeda berdasarkan pada K8. </p><br><h3>  Di mana kita menyimpannya? </h3><br><p>  Dalam semua contoh yang dibahas di atas, kami menyimpan salinan di direktori lokal dari node di mana wadah berjalan.  Tapi tidak ada yang mengganggu untuk menghubungkan Volume Persisten sebagai penyimpanan eksternal yang berfungsi dan mengumpulkan salinan di sana.  Atau Anda hanya dapat menyinkronkannya ke toko jarak jauh menggunakan protokol yang diinginkan tanpa menyimpan secara lokal.  Artinya, ada banyak variasi.  Pertama kumpulkan secara lokal, lalu sinkronkan.  Atau untuk mengumpulkan dan menyimpan hanya di penyimpanan jarak jauh, dll.  Konfigurasi ini cukup fleksibel. </p><br><h6>  mysql.conf + s3 </h6><br><p>  Berikut ini adalah contoh file konfigurasi cadangan MySQL, di mana salinan disimpan secara lokal pada node tempat CronJob berjalan, dan juga disinkronkan dalam s3. </p><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">' --opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: s3 <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump bucket_name: {{ bucket_name }} access_key_id: {{ access_key_id }} secret_access_key: {{ secret_access_key }} s3fs_opts: {{ s3fs_opts }} <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> weeks: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Artinya, jika tidak cukup untuk menyimpan salinan secara lokal, Anda dapat menyinkronkannya ke penyimpanan jarak jauh menggunakan protokol yang sesuai.  Jumlah Penyimpanan untuk penyimpanan bisa berapa saja. </p><br><p>  Namun dalam hal ini, Anda masih perlu membuat beberapa perubahan tambahan, yaitu: </p><br><ul><li>  Hubungkan ConfigMap yang sesuai dengan konten yang diperlukan untuk otorisasi dengan AWS S3, dalam format j2 </li><li>  Buat Rahasia yang sesuai untuk menyimpan akses otorisasi </li><li>  Tetapkan variabel lingkungan yang diperlukan yang diambil dari Rahasia di atas </li><li>  Sesuaikan docker-entrypoint.sh untuk mengganti variabel yang sesuai di ConfigMap </li><li>  Bangun kembali gambar Docker, tambahkan utilitas untuk bekerja dengan AWS S3 </li></ul><br><p>  Meskipun proses ini jauh dari sempurna, tetapi kami sedang mengusahakannya.  Oleh karena itu, dalam waktu dekat kami akan menambah nxs-backup kemampuan untuk menentukan parameter dalam file konfigurasi menggunakan variabel lingkungan, yang akan sangat menyederhanakan pekerjaan dengan file entrypoint dan meminimalkan waktu yang dihabiskan untuk menambahkan dukungan untuk cadangan layanan baru. </p><br><h3>  Kesimpulan </h3><br><p>  Itu mungkin saja. </p><br><p>  Menggunakan pendekatan yang baru saja kita bicarakan, pertama-tama, memungkinkan kita untuk menyusun dan membuat cadangan layanan proyek Stateful ke k8s.  Artinya, ini adalah solusi yang siap pakai, dan yang paling penting, praktik yang dapat Anda terapkan dalam proyek Anda, tanpa membuang waktu dan upaya untuk mencari dan memperbarui solusi open source yang ada. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id426543/">https://habr.com/ru/post/id426543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id426527/index.html">Outstuff baik, outstuff buruk</a></li>
<li><a href="../id426531/index.html">Dell G3 15 (3579): laptop gaming dengan anggaran minimal</a></li>
<li><a href="../id426533/index.html">Noise Security Bit episode 0x21 (Fiksi dan kenyataan: backdoors di perangkat keras dan firmware)</a></li>
<li><a href="../id426537/index.html">Buku "Aplikasi dari awal"</a></li>
<li><a href="../id426541/index.html">Paul Allen, salah satu pendiri Microsoft, meninggal pada usia 65 tahun</a></li>
<li><a href="../id426545/index.html">Joker 2018 bonus: streaming online gratis, pesta, pesta dan meja</a></li>
<li><a href="../id426547/index.html">Sebagai pencipta Android sedang mencoba untuk melepaskan "anti-smartphone" pertama</a></li>
<li><a href="../id426549/index.html">Jenis perangkat lunak baru untuk manajer produk</a></li>
<li><a href="../id426551/index.html">Trekz Air - bagaimana headphone konduksi tulang benar-benar terdengar</a></li>
<li><a href="../id426553/index.html">Iklan spanduk di aplikasi iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>