<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÖ üê∏ ü§≤üèæ Bagaimana jika kompiler tidak mendukung antarmuka zero-offset VMT ü§≠ üë¥üèΩ üà∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Untuk apa ini? 
 Sering kali perlu menulis plugin untuk program. Tetapi karena ketidakcocokan biner kelas, plugin ini harus ditulis dalam bahasa yang ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana jika kompiler tidak mendukung antarmuka zero-offset VMT</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/409565/"><h3>  Untuk apa ini? </h3><br>  Sering kali perlu menulis plugin untuk program.  Tetapi karena ketidakcocokan biner kelas, plugin ini harus ditulis dalam bahasa yang sama dengan program utama.  Di C ++, sudah biasa menempatkan tabel fungsi virtual terlebih dahulu di kelas.  Jika Anda menggunakan aturan tertentu (jangan menggunakan multiple inheritance of interfaces) dan menggunakan kelas abstrak, Anda dapat mencapai kemampuan untuk menjalankan plugin yang dikompilasi di bawah berbagai kompiler C ++. <br><br>  Pada artikel ini saya akan menunjukkan cara menggunakan plugin yang ditulis menggunakan Free Pascal Compiler dalam program C ++ (hanya ide umum, bukan plugin nyata). <br><a name="habracut"></a><br><h3>  Apa itu VMT? </h3><br>  Tabel metode virtual (VMT) adalah tabel koordinat atau vtable adalah mekanisme yang digunakan dalam bahasa pemrograman untuk mendukung pencocokan dinamis (atau mengikat lebih lambat). <br><br>  Standar C ++ tidak secara jelas mendefinisikan bagaimana koordinasi dinamis harus dilaksanakan, tetapi penyusun sering menggunakan beberapa variasi dari model dasar yang sama. <br><br>  Biasanya, kompiler membuat vtable terpisah untuk setiap kelas.  Setelah membuat objek, pointer ke vtable ini, disebut virtual table pointer atau vpointer (juga kadang-kadang disebut vptr atau vfptr), ditambahkan sebagai anggota objek yang tersembunyi (dan seringkali sebagai anggota pertama).  Compiler juga menghasilkan kode "tersembunyi" dalam konstruktor masing-masing kelas untuk menginisialisasi objek vpointer'ov dengan alamat vtable yang sesuai. <br>  (Paragraf diambil dari Wikipedia.) <br><br><h3>  Implementasi. </h3><br>  Pertama kita perlu membuat wrapper di sekitar kode dalam pascal. <br><br>  <b>plugin.hpp</b> <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ApiEntry.hpp"</span></span></span><span class="hljs-meta"> class IPlugin { public: virtual void APIENTRY free () = 0; virtual void APIENTRY print () = 0; }; class Plugin : public IPlugin { public: virtual void APIENTRY free (); virtual void APIENTRY print (); Plugin (); virtual ~Plugin (); private: void* thisPascal; }; extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> IPlugin* APIENTRY getNewPlugin ();</span></span></code> </pre> <br>  Di mana IPlugin adalah antarmuka plugin.  Dan thisPascal adalah pointer ke versi biner dari kelas implementasi antarmuka dalam pascal. <br><br>  Dan kode pembungkus itu sendiri: <b>plugin.cpp</b> <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"plugin.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pascalunit.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; void APIENTRY Plugin::free () { IPlugin_release (thisPascal); delete this; } void APIENTRY Plugin::print () { IPlugin_print (thisPascal); } Plugin::Plugin () { std::cout &lt;&lt; "Plugin::Plugin" &lt;&lt; std::endl; thisPascal = IPlugin_getNewPlugin (); } Plugin::~Plugin () { std::cout &lt;&lt; "Plugin::~Plugin" &lt;&lt; std::endl; } extern "C" IPlugin* APIENTRY getNewPlugin () { Plugin* plugin = new Plugin (); return plugin; }</span></span></span></span></code> </pre><br>  Seperti yang Anda lihat, kode tersebut memanggil fungsi-fungsi dari library dalam pascal dan memberikan mereka pointer ke implementasi plugin dalam pascal yang sebelumnya disimpan saat membuat kelas.  getNewPlugin dipanggil untuk instantiate kelas plugin di program utama. <br><br>  Sekarang mari kita bicara tentang implementasi plugin di Pascal. <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">library</span></span> pascalunit; <span class="hljs-meta"><span class="hljs-meta">{$MODE OBJFPC}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> ctypes; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> IPlugin = <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> _</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-title"><span class="hljs-title">TPlugin</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> (TInterfacedObject, IPlugin) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> _</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Free</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; PPlugin = ^TPlugin; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPlugin</span></span></span><span class="hljs-function">._</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPlugin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> writeln (<span class="hljs-string"><span class="hljs-string">'Hello World'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> _</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(this: PPlugin)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> this^._release (); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(this: PPlugin)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> this^.print (); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPlugin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inherited</span></span>; writeln (<span class="hljs-string"><span class="hljs-string">'TPlugin.Create'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">destructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TPlugin</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Free</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> writeln (<span class="hljs-string"><span class="hljs-string">'TPlugin.Free'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNewPlugin</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> PPlugin; <span class="hljs-keyword"><span class="hljs-keyword">cdecl</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> plugin: PPlugin; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> New (plugin); plugin^ := TPlugin.Create (); result := plugin; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">exports</span></span> getNewPlugin <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">'IPlugin_getNewPlugin'</span></span>, print <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">'IPlugin_print'</span></span>, _release <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-string"><span class="hljs-string">'IPlugin_release'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre><br>  File ini mengimplementasikan antarmuka yang hampir sama dalam pascal dan membungkus fungsi plug-in untuk mengekspor fungsi ke perpustakaan.  Catatan semua fungsi implementasi antarmuka berisi pointer ke kelas sebagai parameter pertama.  Parameter ini diteruskan secara implisit untuk metode kelas sebagai parameter pertama dan diperlukan untuk mengakses metode dan bidang kelas.  Fungsi getNewPlugin digunakan untuk mendapatkan pointer di kelas C ++.  Kode pascal terhubung sebagai perpustakaan. <br><br>  PS: Saya lupa menyebutkan bahwa kode dalam pascal sebaiknya / sebaiknya dibungkus dengan try / catch karena pengecualian tidak boleh dibuang dalam metode plugin ini.  Plugin harus menangani pengecualiannya dan mengembalikan hasilnya segera atau sebagai fungsi terpisah dalam bentuk tipe sederhana. <br><br>  PS2: Menambahkan komentar tentang fungsi bebas dan mengubah kodenya.  Saya tidak akan menambahkan perubahan apa pun di sini untuk menjaga kepatuhan terhadap komentar.  Dan dia menambahkan komentar tentang menggunakan fungsi getNewPlugin dan menghapus objek di aplikasi pihak ketiga.  Meskipun orang yang tahu tentang antarmuka, ini sudah jelas. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sumber sampel</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id409565/">https://habr.com/ru/post/id409565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id409553/index.html">Ulasan smartphone ASUS ZenFone Max Plus (M1)</a></li>
<li><a href="../id409555/index.html">Perlengkapan prototipe menggunakan printer 3D</a></li>
<li><a href="../id409559/index.html">Modifikasi komunikasi: satu bahasa masa depan untuk semua umat manusia</a></li>
<li><a href="../id409561/index.html">Drone di Australia menyelamatkan tenggelam pertama</a></li>
<li><a href="../id409563/index.html">Seorang pria lebih baik dipandu oleh peta - sampai wanita itu mengambil kursus pelatihan</a></li>
<li><a href="../id409569/index.html">Ablasi retina - apa yang penting untuk diketahui tentang hal itu</a></li>
<li><a href="../id409571/index.html">Cara membuat alien - pemikiran tentang desain spesies asing</a></li>
<li><a href="../id409575/index.html">Pembagian dengan nol, apakah jawabannya tidak terbatas pada alam semesta kita?</a></li>
<li><a href="../id409579/index.html">Intel NUC Hades Canyon - Tengkorak baru dengan otak. Dan mata</a></li>
<li><a href="../id409581/index.html">Intelligent Tello Minidron</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>