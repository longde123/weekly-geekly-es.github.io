<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©â€ğŸ‘©â€ğŸ‘¦ â™‚ï¸ ğŸ‘¨â€ğŸš’ ç¬¬1éƒ¨åˆ†ã€‚QInstï¼šæœ€å¥½å…ˆè¾“æ‰ä¸€å¤©ï¼Œç„¶ååœ¨äº”åˆ†é’Ÿå†…é£èµ·æ¥ï¼ˆç¼–å†™æ–‡ä¹¦éå¸¸çç¢ï¼‰ ğŸ‰‘ â†™ï¸ ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ç²—ç•¥åœ°æè¿°äº†å¦‚ä½•ä»ELFæ–‡ä»¶åŠ è½½eBPFå‡½æ•°ã€‚ ç°åœ¨æ˜¯æ—¶å€™ä»å¹»æƒ³è½¬å˜ä¸ºè‹è”åŠ¨ç”»ç‰‡äº†ï¼Œåœ¨èŠ±è´¹äº†ä¸€å®šçš„ç²¾åŠ›ä¹‹åï¼Œéµå¾ªæ˜æ™ºçš„å»ºè®®ï¼Œåˆ¶ä½œäº†é€šç”¨çš„ä»ªå™¨å·¥å…·  ï¼ˆæˆ–è€…ï¼Œç®€è€Œè¨€ä¹‹ï¼ŒUII !!!ï¼‰  ã€‚ ä¸ºæ­¤ï¼Œæˆ‘å°†åˆ©ç”¨Golden Hammeråå›¾æ¡ˆè®¾è®¡ï¼Œå¹¶ä»ç›¸å¯¹ç†Ÿæ‚‰çš„QEMUä¸­æ„å»ºä¸€ä¸ªå·¥å…·ã€‚ ä½œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç¬¬1éƒ¨åˆ†ã€‚QInstï¼šæœ€å¥½å…ˆè¾“æ‰ä¸€å¤©ï¼Œç„¶ååœ¨äº”åˆ†é’Ÿå†…é£èµ·æ¥ï¼ˆç¼–å†™æ–‡ä¹¦éå¸¸çç¢ï¼‰</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452608/"><p> åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸Šä¸€éƒ¨åˆ†ä¸­ï¼Œ</a>æˆ‘ç²—ç•¥åœ°æè¿°äº†å¦‚ä½•ä»ELFæ–‡ä»¶åŠ è½½eBPFå‡½æ•°ã€‚ ç°åœ¨æ˜¯æ—¶å€™ä»å¹»æƒ³è½¬å˜ä¸ºè‹è”åŠ¨ç”»ç‰‡äº†ï¼Œåœ¨èŠ±è´¹äº†ä¸€å®šçš„ç²¾åŠ›ä¹‹åï¼Œéµå¾ªæ˜æ™ºçš„å»ºè®®ï¼Œåˆ¶ä½œäº†é€šç”¨çš„ä»ªå™¨å·¥å…· <del>  <em>ï¼ˆæˆ–è€…ï¼Œç®€è€Œè¨€ä¹‹ï¼ŒUII !!!ï¼‰</em> </del>  ã€‚ ä¸ºæ­¤ï¼Œæˆ‘å°†åˆ©ç”¨Golden Hammeråå›¾æ¡ˆè®¾è®¡ï¼Œå¹¶ä»ç›¸å¯¹ç†Ÿæ‚‰çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">QEMUä¸­</a>æ„å»ºä¸€ä¸ªå·¥å…·ã€‚ ä½œä¸ºå¥–åŠ±ï¼Œæˆ‘ä»¬è·å¾—äº†è·¨ä½“ç³»ç»“æ„çš„æ£€æµ‹ä»¥åŠæ•´ä¸ªè™šæ‹Ÿè®¡ç®—æœºçº§åˆ«çš„æ£€æµ‹ã€‚ æ£€æµ‹çš„å½¢å¼ä¸ºâ€œå¸¦æœ‰eBPFçš„å°å‹æœ¬æœºso-file +å°å‹.o-fileâ€ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ä¼˜åŒ–å’Œä»£ç ç”Ÿæˆä¹‹å‰ï¼Œå°†åœ¨QEMUå†…éƒ¨è¡¨ç¤ºçš„ç›¸åº”æŒ‡ä»¤ä¹‹å‰æ›¿æ¢eBPFå‡½æ•°ã€‚ </p><br><p>ç»“æœï¼Œ <strong>åœ¨ä»£ç ç”Ÿæˆè¿‡ç¨‹</strong>ä¸­<strong>æ·»åŠ </strong>çš„å·¥å…·æœ¬èº«ï¼ˆå³ï¼Œä¸è®¡ç®—æ­£å¸¸ç³»ç»Ÿè¿è¡Œæ—¶çš„å‡ åƒå­—èŠ‚ï¼‰çœ‹èµ·æ¥åƒè¿™æ ·ï¼Œè¿™<strong>ä¸æ˜¯</strong>ä¼ªä»£ç ï¼š </p><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; extern uint8_t *__afl_area_ptr; extern uint64_t prev; void inst_qemu_brcond_i64(uint64_t tag, uint64_t x, uint64_t y, uint64_t z, uint64_t u) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; } void inst_qemu_brcond_i32(uint64_t tag, uint64_t x, uint64_t y, uint64_t z, uint64_t u) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; }</span></span></span></span></code> </pre> <br><p> å¥½äº†ï¼Œæ˜¯æ—¶å€™å°†æˆ‘ä»¬çš„å°ç²¾çµåŠ è½½åˆ°çŸ©é˜µäº†ã€‚ å¥½å§ï¼Œå¦‚ä½•ä¸‹è½½ï¼Œè€Œä¸æ˜¯ <del>  ack </del> å–·é›¾ã€‚ </p><a name="habracut"></a><br><p> æ­£å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ‰å…³QEMU.js</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« ä¸­</a>å·²ç»æåˆ°çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é‚£æ ·</a> ï¼ŒQEMUæ“ä½œæ¨¡å¼ä¹‹ä¸€æ˜¯ä»æ¥å®¾JITç”Ÿæˆä¸»æœºä»£ç ï¼ˆå¯èƒ½å¯¹äºå®Œå…¨ä¸åŒçš„ä½“ç³»ç»“æ„ï¼‰ã€‚ å¦‚æœæ˜¯æˆ‘ä¸Šä¸€æ¬¡å®ç°ä»£ç ç”Ÿæˆåç«¯ï¼Œé‚£ä¹ˆè¿™æ¬¡æˆ‘å°†é€šè¿‡åœ¨ä¼˜åŒ–å™¨å‰é¢è¿›è¡Œæ¥”å…¥æ¥å¤„ç†å†…éƒ¨è¡¨ç¤ºã€‚ è¿™æ˜¯ä¸€ä¸ªä»»æ„å†³å®šå—ï¼Ÿ ä¸è¡Œ å¸Œæœ›ä¼˜åŒ–å™¨å¯ä»¥æ¶ˆé™¤å¤šä½™çš„è§’è½ï¼ŒæŠ›å‡ºä¸å¿…è¦çš„å˜é‡ç­‰ã€‚ æ®æˆ‘äº†è§£ï¼Œä»–å®é™…ä¸Šåšäº†ç®€å•è€Œåˆè¿…é€Ÿçš„äº‹æƒ…ï¼šæ¨é€å¸¸é‡ï¼ŒæŠ›å‡ºâ€œ xï¼š= x + 0â€ä¹‹ç±»çš„è¡¨è¾¾å¼å¹¶åˆ é™¤æ— æ³•è®¿é—®çš„ä»£ç ã€‚ æˆ‘ä»¬å¯ä»¥å¾—åˆ°ç›¸å½“æ•°é‡çš„ä¸œè¥¿ã€‚ </p><br><h1 id="konfiguraciya-sborochnyh-skriptov"> æ±‡ç¼–è„šæœ¬é…ç½® </h1><br><p> é¦–å…ˆï¼Œè®©æˆ‘ä»¬å°†æºæ–‡ä»¶ï¼š <code>tcg/bpf-loader.c</code>å’Œ<code>tcg/instrument.c</code>åˆ°Makefilesä¸­ã€‚ ä¸€èˆ¬è€Œè¨€ï¼Œå¸Œæœ›æœ‰æœä¸€æ—¥å°†å…¶æ¨é€åˆ°ä¸Šæ¸¸ï¼Œå› æ­¤æ‚¨æœ€ç»ˆéœ€è¦æ˜æ™ºåœ°è¿›è¡Œæ­¤æ“ä½œï¼Œä½†æ˜¯ç°åœ¨æˆ‘å°†æ— æ¡ä»¶åœ°å°†è¿™äº›æ–‡ä»¶æ·»åŠ åˆ°ç¨‹åºé›†ä¸­ã€‚ æˆ‘å°†é€šè¿‡ç¯å¢ƒå˜é‡é‡‡ç”¨AFLæœ€ä½³ä¼ ç»Ÿä¸­çš„å‚æ•°ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œæˆ‘å°†åœ¨AFLçš„ä»ªå™¨ä¸Šå†æ¬¡è¿›è¡Œæµ‹è¯•ã€‚ </p><br><p> åªéœ€æŸ¥æ‰¾æåˆ°çš„â€œé‚»å±…â€-ä½¿ç”¨<code>grep -R</code>çš„<code>optimize.c</code>æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†æ‰¾ä¸åˆ°ä»»ä½•ä¸œè¥¿ã€‚ å› ä¸ºæœ‰å¿…è¦æœç´¢<code>optimize.o</code> ï¼š </p><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/Makefile.target +++ b/Makefile.target @@ -110,7 +110,7 @@ obj-y += trace/ obj-y += exec.o obj-y += accel/ obj-$(CONFIG_TCG) += tcg/tcg.o tcg/tcg-op.o tcg/tcg-op-vec.o tcg/tcg-op-gvec.o -obj-$(CONFIG_TCG) += tcg/tcg-common.o tcg/optimize.o +obj-$(CONFIG_TCG) += tcg/tcg-common.o tcg/optimize.o tcg/instrument.o tcg/bpf-loader.o obj-$(CONFIG_TCG_INTERPRETER) += tcg/tci.o obj-$(CONFIG_TCG_INTERPRETER) += disas/tci.o obj-$(CONFIG_TCG) += fpu/softfloat.o</span></span></code> </pre> <br><h1 id="tak-vot-ty-kakoe-metaprogrammirovanie-na-c"> å› æ­¤ï¼Œæ‚¨åœ¨è¿™é‡Œï¼Œç”¨Cè¿›è¡Œå…ƒç¼–ç¨‹... </h1><br><p> é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä»æœ€åä¸€ä¸ªç³»åˆ—ä¸­æ·»åŠ <code>bpf-loader.c</code> ï¼Œå…¶ä¸­åŒ…å«æå–ä¸QEMUæ“ä½œç›¸å¯¹åº”çš„å…¥å£ç‚¹çš„ä»£ç ã€‚ ç¥ç§˜çš„<code>tcg-opc.h</code>æ–‡ä»¶å°†å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * DEF(name, oargs, iargs, cargs, flags) */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* predefined ops */</span></span> DEF(discard, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, TCG_OPF_NOT_PRESENT) DEF(set_label, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, TCG_OPF_BB_END | TCG_OPF_NOT_PRESENT) <span class="hljs-comment"><span class="hljs-comment">/* variable number of parameters */</span></span> DEF(call, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, TCG_OPF_CALL_CLOBBER | TCG_OPF_NOT_PRESENT) DEF(br, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, TCG_OPF_BB_END) <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p> ä»€ä¹ˆåºŸè¯ äº‹å®æ˜¯ï¼Œå®ƒæ²¡æœ‰è¿æ¥åˆ°æºå¤´ä¸­-æ‚¨éœ€è¦å®šä¹‰<code>DEF</code>å®ï¼ŒåŒ…æ‹¬æ­¤æ–‡ä»¶ï¼Œç„¶åç«‹å³åˆ é™¤è¯¥å®ã€‚ çœ‹ï¼Œä»–ä»€è‡³æ²¡æœ‰è­¦å«ã€‚ </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *inst_function_names[] = { #define DEF(name, a, b, c, d) stringify(inst_qemu_##name), #include <span class="hljs-string"><span class="hljs-string">"tcg-opc.h"</span></span> #undef DEF <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> };</code> </pre> <br><p> ç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ•´é½çš„ç›®æ ‡å‡½æ•°åç§°æ•°ç»„ï¼Œç”±æ“ä½œç ç´¢å¼•å¹¶ä»¥NULLç»“å°¾ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ–‡ä»¶ä¸­çš„æ¯ä¸ªå­—ç¬¦è¿è¡Œè¯¥å‡½æ•°ã€‚ æˆ‘äº†è§£è¿™å¹¶ä¸æœ‰æ•ˆã€‚ é‰´äºæ­¤æ“ä½œå…·æœ‰ä¸€æ¬¡æ€§æ€§è´¨ï¼Œå› æ­¤å¾ˆç®€å•ï¼Œè¿™å¾ˆé‡è¦ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªè·³è¿‡æ‰€æœ‰å­—ç¬¦ </p><br><pre> <code class="cpp hljs">ELF64_ST_BIND(sym-&gt;st_info) == STB_LOCAL || ELF64_ST_TYPE(sym-&gt;st_info) != STT_FUNC</code> </pre> <br><p> å…¶ä½™çš„å°†æ ¹æ®åˆ—è¡¨è¿›è¡Œæ£€æŸ¥ã€‚ </p><br><h1 id="privyazyvaemsya-k-potoku-vypolneniya"> æˆ‘ä»¬ä¾é™„äºæ‰§è¡Œæµç¨‹ </h1><br><p> ç°åœ¨ï¼Œæ‚¨éœ€è¦äº†è§£ä»£ç ç”Ÿæˆæœºåˆ¶çš„æµç¨‹ï¼Œå¹¶ç­‰åˆ°æ„Ÿå…´è¶£çš„æŒ‡ä»¤é€šè¿‡ä¸ºæ­¢ã€‚ ä½†æ˜¯é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨<code>tcg/tcg.h</code>å®šä¹‰å‡½æ•°<code>instrumentation_init</code> ï¼Œ <code>tcg_instrument</code>å’Œ<code>instrumentation_shutdown</code>å¹¶å†™ä¸‹å®ƒä»¬çš„è°ƒç”¨ï¼šåˆå§‹åŒ–-åˆå§‹åŒ–åç«¯ä¹‹åï¼Œ <code>tcg_optimize</code> -åœ¨<code>tcg_optimize</code>è°ƒç”¨ä¹‹å‰ã€‚ ä¼¼ä¹<code>instrumentation_shutdown</code>å¯ä»¥æŒ‚åœ¨<code>atexit</code>ä¸Šçš„<code>instrumentation_init</code> ï¼Œè€Œä¸ä¼šé£™å‡ã€‚ æˆ‘ä¹Ÿè¿™ä¹ˆè®¤ä¸ºï¼Œå®ƒå¾ˆå¯èƒ½ä¼šåœ¨å®Œæ•´çš„ç³»ç»Ÿä»¿çœŸæ¨¡å¼ä¸‹å·¥ä½œï¼Œä½†æ˜¯åœ¨ç”¨æˆ·æ¨¡å¼ä»¿çœŸæ¨¡å¼ä¸‹ï¼ŒQEMUè½¬æ¢<code>exit_group</code>ç³»ç»Ÿè°ƒç”¨ï¼Œæœ‰æ—¶<code>exit</code>åˆ°<code>_exit</code>å‡½æ•°è°ƒç”¨ï¼Œè¯¥è°ƒç”¨ä¼šå¿½ç•¥æ‰€æœ‰è¿™äº›atexitå¤„ç†ç¨‹åºï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°†åœ¨<code>linux-user/syscall.c</code>æœç´¢å®ƒï¼Œ <code>linux-user/syscall.c</code>è°ƒç”¨<code>linux-user/syscall.c</code>æˆ‘ä»¬å‰é¢çš„ä»£ç ä¸­ã€‚ </p><br><h1 id="interpretiruem-baytkod"> è§£é‡Šå­—èŠ‚ç  </h1><br><p> å› æ­¤ï¼Œæ˜¯æ—¶å€™é˜…è¯»ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„å†…å®¹äº†ã€‚ ä½¿ç”¨å¸¦æœ‰<code>-x</code>é€‰é¡¹çš„<code>llvm-objdump</code>æˆ–æ›´æ–¹ä¾¿åœ°<code>-d -t -r</code>å¯ä»¥æ–¹ä¾¿åœ°å®Œæˆæ­¤æ“ä½œã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">è¾“å‡ºä¾‹å­</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ ./compile-bpf.sh test-bpf.o: file format ELF64-BPF Disassembly of section .text: 0000000000000000 inst_brcond_i64: 0: 18 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r2 = 0 ll 0000000000000000: R_BPF_64_64 prev 2: 79 23 00 00 00 00 00 00 r3 = *(u64 *)(r2 + 0) 3: 77 03 00 00 01 00 00 00 r3 &gt;&gt;= 1 4: 7b 32 00 00 00 00 00 00 *(u64 *)(r2 + 0) = r3 5: af 13 00 00 00 00 00 00 r3 ^= r1 6: 57 03 00 00 ff ff 00 00 r3 &amp;= 65535 7: 18 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r4 = 0 ll 0000000000000038: R_BPF_64_64 __afl_area_ptr 9: 79 44 00 00 00 00 00 00 r4 = *(u64 *)(r4 + 0) 10: 0f 34 00 00 00 00 00 00 r4 += r3 11: 71 43 00 00 00 00 00 00 r3 = *(u8 *)(r4 + 0) 12: 07 03 00 00 01 00 00 00 r3 += 1 13: 73 34 00 00 00 00 00 00 *(u8 *)(r4 + 0) = r3 14: 7b 12 00 00 00 00 00 00 *(u64 *)(r2 + 0) = r1 15: 95 00 00 00 00 00 00 00 exit 0000000000000080 inst_brcond_i32: 16: 18 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r2 = 0 ll 0000000000000080: R_BPF_64_64 prev 18: 79 23 00 00 00 00 00 00 r3 = *(u64 *)(r2 + 0) 19: 77 03 00 00 01 00 00 00 r3 &gt;&gt;= 1 20: 7b 32 00 00 00 00 00 00 *(u64 *)(r2 + 0) = r3 21: af 13 00 00 00 00 00 00 r3 ^= r1 22: 57 03 00 00 ff ff 00 00 r3 &amp;= 65535 23: 18 04 00 00 00 00 00 00 00 00 00 00 00 00 00 00 r4 = 0 ll 00000000000000b8: R_BPF_64_64 __afl_area_ptr 25: 79 44 00 00 00 00 00 00 r4 = *(u64 *)(r4 + 0) 26: 0f 34 00 00 00 00 00 00 r4 += r3 27: 71 43 00 00 00 00 00 00 r3 = *(u8 *)(r4 + 0) 28: 07 03 00 00 01 00 00 00 r3 += 1 29: 73 34 00 00 00 00 00 00 *(u8 *)(r4 + 0) = r3 30: 7b 12 00 00 00 00 00 00 *(u64 *)(r2 + 0) = r1 31: 95 00 00 00 00 00 00 00 exit SYMBOL TABLE: 0000000000000000 l df *ABS* 00000000 test-bpf.c 0000000000000000 ld .text 00000000 .text 0000000000000000 *UND* 00000000 __afl_area_ptr 0000000000000080 g F .text 00000080 inst_brcond_i32 0000000000000000 g F .text 00000080 inst_brcond_i64 0000000000000008 g O *COM* 00000008 prev</code> </pre> </div></div><br><p> å¦‚æœæ‚¨å°è¯•æŸ¥æ‰¾eBPFæ“ä½œç çš„æè¿°ï¼Œåˆ™ä¼šå‘ç°åœ¨æ˜æ˜¾çš„åœ°æ–¹ï¼ˆLinuxå†…æ ¸çš„æºä»£ç å’Œæ‰‹å†Œé¡µï¼‰ä¸­æœ‰å…³äºå¦‚ä½•ä½¿ç”¨å®ƒï¼Œå¦‚ä½•ç¼–è¯‘ç­‰çš„æè¿°ã€‚ ç„¶åï¼Œæ‚¨ä¼šçœ‹åˆ°iovisorå·¥å…·å›¢é˜Ÿ<a href="">é¡µé¢ï¼Œ</a>å…¶ä¸­åŒ…å«æ–¹ä¾¿çš„éå®˜æ–¹eBPFå‚è€ƒã€‚ </p><br><p> è¯¥æŒ‡ä»¤å ç”¨ä¸€ä¸ª64ä½å­—ï¼ˆå¤§çº¦ä¸¤ä¸ªï¼‰ï¼Œæ ¼å¼ä¸º </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> opcode; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> dst:<span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> src:<span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> offset; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> imm; };</code> </pre> <br><p> å æ®ä¸¤ä¸ªå•è¯çš„å˜é‡ä»…ç”±å…·æœ‰æ‰€æœ‰é€»è¾‘çš„ç¬¬ä¸€æ¡æŒ‡ä»¤å’Œå…·æœ‰32ä¸ªç«‹å³æ•°çš„ç«‹å³æ•°ç»„æˆçš„â€œé¢„å‘Šç‰‡â€ç»„æˆï¼Œå®ƒä»¬åœ¨objdumpåæ±‡ç¼–ç¨‹åºä¸­éå¸¸æ¸…æ™°å¯è§ã€‚ </p><br><p> æ“ä½œç æœ¬èº«ä¹Ÿå…·æœ‰è§„åˆ™çš„ç»“æ„ï¼šæœ€ä½ä¸‰ä½æ˜¯æ“ä½œç±»ï¼š32ä½ALUï¼Œ64ä½ALUï¼ŒåŠ è½½/å­˜å‚¨ï¼Œæ¡ä»¶è·³è½¬ã€‚ å› æ­¤ï¼ŒæŒ‰ç…§QEMUçš„æœ€ä½³ä¼ ç»Ÿåœ¨å®ä¸Šå®ç°å®ƒä»¬éå¸¸æ–¹ä¾¿ã€‚ æˆ‘ä¸ä¼šåœ¨ä»£ç åº“ä¸Šè¿›è¡Œè¯¦ç»†è¯´æ˜ <del> æˆ‘ä»¬ä¸åœ¨ä»£ç å®¡æŸ¥ä¸­ </del> æˆ‘æœ€å¥½å‘Šè¯‰æ‚¨æœ‰å…³çš„é™·é˜±ã€‚ </p><br><p> æˆ‘çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæˆ‘ä»¥QEMU- <code>local_temp</code>çš„å½¢å¼åˆ¶ä½œäº†ä¸€ä¸ªæƒ°æ€§eBPFå¯„å­˜å™¨åˆ†é…å™¨ï¼Œå¹¶å¼€å§‹ä¸åŠ æ€ç´¢åœ°å°†æ­¤å‡½æ•°çš„è°ƒç”¨è½¬ç§»åˆ°å®ã€‚ äº‹å®è¯æ˜ï¼Œè¿™å°±åƒä¸€ä¸ªè‘—åçš„æ¨¡å› ï¼šâ€œæˆ‘ä»¬å°†æŠ½è±¡æ’å…¥åˆ°æŠ½è±¡ä¸­ï¼Œä»¥ä¾¿åœ¨ç”ŸæˆæŒ‡ä»¤çš„åŒæ—¶å¯ä»¥ç”ŸæˆæŒ‡ä»¤ã€‚â€ äº‹åï¼Œæˆ‘å·²ç»ä¸å¤ªäº†è§£å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä½†æ˜¯ç”Ÿæˆçš„æŒ‡ä»¤çš„é¡ºåºæ˜¾ç„¶å‘ç”Ÿäº†å¥‡æ€ªçš„äº‹æƒ…ã€‚ ä¹‹åï¼Œæˆ‘åˆ¶ä½œäº†<code>tcg_gen_...</code>å‡½æ•°çš„ç±»ä¼¼ç‰©ï¼Œå°†æ–°æŒ‡ä»¤æ¨å…¥åˆ—è¡¨çš„ä¸­é—´ï¼Œä»¥æ“ä½œæ•°ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œå¹¶ä¸”é¡ºåºè‡ªåŠ¨å˜ä¸ºåº”æœ‰çš„é¡ºåºï¼ˆå› ä¸ºå‚æ•°å®Œå…¨åœ¨è°ƒç”¨ä¹‹å‰è¢«å®Œå…¨è®¡ç®—è¿‡ä¸€æ¬¡ï¼‰ã€‚ </p><br><p> ç¬¬äºŒä¸ªé—®é¢˜æ˜¯åœ¨æŸ¥çœ‹eBPFä¸­çš„ç«‹å³æ•°æ“ä½œæ•°æ—¶ï¼Œè¯•å›¾å°†TCGå¸¸é‡æ¨ä¸ºä»»æ„æŒ‡ä»¤çš„æ“ä½œæ•°ã€‚ æç¤ºå·²ç»æåˆ°çš„<code>tcg-opc.h</code> ï¼Œè¯¥æ“ä½œçš„å‚æ•°åˆ—è¡¨çš„ç»„æˆä¸¥æ ¼å›ºå®šï¼š <code>n</code>è¾“å…¥å‚æ•°ï¼Œ <code>m</code>è¾“å‡ºå’Œ<code>k</code>å¸¸æ•°ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œè°ƒè¯•æ­¤ç±»ä»£ç æ—¶ï¼Œå®ƒæœ‰åŠ©äºé€šè¿‡å‘½ä»¤è¡Œå‚æ•°<code>-d op,op_opt</code>ç”šè‡³<code>-d op,op_opt,out_asm</code>ä¼ é€’QEMUã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">å¯èƒ½çš„è®ºç‚¹</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ ./x86_64-linux-user/qemu-x86_64 -d help Log items (comma separated): out_asm show generated host assembly code for each compiled TB in_asm show target assembly code for each compiled TB op show micro ops for each compiled TB op_opt show micro ops after optimization op_ind show micro ops before indirect lowering int show interrupts/exceptions in short format exec show trace before each executed TB (lots of logs) cpu show CPU registers before entering a TB (lots of logs) fpu include FPU registers in the 'cpu' logging mmu log MMU-related activities pcall x86 only: show protected mode far calls/returns/exceptions cpu_reset show CPU state before CPU resets unimp log unimplemented functionality guest_errors log when the guest OS does something invalid (eg accessing a non-existent register) page dump pages at beginning of user mode emulation nochain do not chain compiled TBs so that "exec" and "cpu" show complete traces trace:PATTERN enable trace events Use "-d trace:help" to get a list of trace events.</code> </pre> </div></div><br><p> å¥½å§ï¼Œä¸è¦é‡å¤æˆ‘çš„é”™è¯¯ï¼šå†…éƒ¨æŒ‡ä»¤åæ±‡ç¼–ç¨‹åºéå¸¸å…ˆè¿›ï¼Œå¦‚æœæ‚¨åœ¨å…¶ä¸­çœ‹åˆ°ç±»ä¼¼<code>add_i64 loc15,loc15,$554412123213</code> ï¼Œåˆ™ç¾å…ƒç¬¦å·åé¢çš„ä¸œè¥¿ä¸æ˜¯æŒ‡é’ˆã€‚ æ›´ç¡®åˆ‡åœ°è¯´ï¼Œè¿™å½“ç„¶æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä½†å¯èƒ½æŒ‚æœ‰æ ‡å¿—ï¼Œå¹¶ä¸”å…·æœ‰æ“ä½œæ•°å­—é¢å€¼çš„ä½œç”¨ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆã€‚ å½“ç„¶ï¼Œæ‰€æœ‰è¿™ä¸€åˆ‡éƒ½é€‚ç”¨ï¼Œå¦‚æœæ‚¨çŸ¥é“åº”è¯¥æœ‰ä¸€äº›ç‰¹å®šçš„æ•°å­—ï¼Œä¾‹å¦‚<code>$0</code>æˆ–<code>$ff</code> ï¼Œåˆ™æ ¹æœ¬ä¸å¿…æ‹…å¿ƒæŒ‡é’ˆã€‚  :)å¦‚ä½•<code>movi</code>è¿™ä¸ªé—®é¢˜-æ‚¨åªéœ€è¦åˆ›å»ºä¸€ä¸ªè¿”å›æ–°<code>temp</code>çš„å‡½æ•°ï¼Œå°±å¯ä»¥é€šè¿‡<code>movi</code>å°†æ‰€éœ€çš„å¸¸é‡æ”¾å…¥å…¶ä¸­ã€‚ </p><br><p> é¡ºä¾¿è¯´ä¸€å¥ï¼Œå¦‚æœæ‚¨åœ¨<code>tcg/tcg.c</code> <code>#define USE_TCG_OPTIMIZATIONS</code> <code>tcg/tcg.c</code> <code>#define USE_TCG_OPTIMIZATIONS</code> <code>tcg/tcg.c</code> ï¼Œé‚£ä¹ˆçªç„¶é—´ï¼Œä¼˜åŒ–å°†å…³é—­ï¼Œå¹¶ä¸”æ›´å®¹æ˜“åˆ†æä»£ç è½¬æ¢ã€‚ </p><br><p> å¯¹äºsimå¡ï¼Œæˆ‘å°†å‘æœ‰å…´è¶£å°†QEMUçº³å…¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£</a>çš„è¯»è€…ï¼Œç”šè‡³æ˜¯æ­£å¼çš„è¯»è€…ï¼ å…¶ä½™éƒ¨åˆ†ï¼Œæˆ‘å°†æ¼”ç¤ºAFLæ‰¿è¯ºçš„ä»ªå™¨ã€‚ </p><br><h1 id="te-zhe-i-krolik"> å’Œå…”å­ä¸€æ · </h1><br><p> å¯¹äºè¿è¡Œæ—¶çš„å…¨æ–‡ï¼Œæˆ‘å†æ¬¡å°†è¯»è€…å‘é€åˆ°å­˜å‚¨åº“ï¼Œå› ä¸ºå®ƒï¼ˆæ–‡æœ¬ï¼‰æ²¡æœ‰è‰ºæœ¯ä»·å€¼ï¼Œå¹¶ä¸”ä»AFLäº¤ä»˜ä¸­çš„<code>qemu_mode</code>è¯šå®åœ°å¾—åˆ°äº†å¼ºåŒ–ï¼Œå¹¶ä¸”é€šå¸¸æ˜¯ä¸€æ®µå¸¸è§„çš„Cä»£ç ã€‚ ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; extern uint8_t *__afl_area_ptr; extern uint64_t prev; void inst_qemu_brcond_i64(uint64_t tag, uint64_t x, uint64_t y, uint64_t z, uint64_t u) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; } void inst_qemu_brcond_i32(uint64_t tag, uint64_t x, uint64_t y, uint64_t z, uint64_t u) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; }</span></span></span></span></code> </pre> <br><p> å¯¹äºç›¸åº”çš„QEMUæ“ä½œï¼ŒæŒ‚é’©å‡½æ•°å…·æœ‰ä¸<code>iargs</code>ä¸€æ ·å¤šçš„å‚æ•°å¾ˆé‡è¦ã€‚ æ ‡å¤´ä¸­çš„ä¸¤ä¸ª<code>extern</code>å°†åœ¨é‡å®šä½è¿‡ç¨‹ä¸­é“¾æ¥åˆ°è¿è¡Œæ—¶ã€‚ åŸåˆ™ä¸Šï¼Œ <code>prev</code>å¯ä»¥åœ¨æ­¤å¤„å®šä¹‰ï¼Œä½†éšåéœ€è¦å°†å…¶å®šä¹‰ä¸º<code>static</code> ï¼Œå¦åˆ™å®ƒå°†å±äºæˆ‘ä¸æ”¯æŒçš„COMMONéƒ¨åˆ†ã€‚ å®é™…ä¸Šï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•åœ°é‡å†™äº†æ–‡æ¡£ä¸­çš„ä¼ªä»£ç ï¼Œä½†è¿™åœ¨è¿™é‡Œæ˜¯æœºå™¨å¯è¯»çš„ï¼ </p><br><p> è¦æ£€æŸ¥ï¼Œè¯·åˆ›å»º<code>bug.c</code>æ–‡ä»¶ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;stdlib.h&gt; int main(int argc, char *argv[]) { char buf[16]; int res = read(0, buf, 4); if (buf[0] == 'T' &amp;&amp; buf[1] == 'E' &amp;&amp; buf[2] == 'S' &amp;&amp; buf[3] == 'T') abort(); return res * 0; }</span></span></span></span></code> </pre> <br><p> è¿˜æœ‰<code>forksrv</code>æ–‡ä»¶ï¼Œå¯æ–¹ä¾¿åœ°è¾“å…¥AFLï¼š </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash export NATIVE_INST=./instrumentation-examples/afl/afl-native.so export BPF_INST=./instrumentation-examples/afl/afl-bpf.co exec ./x86_64-linux-user/qemu-x86_64 ./instrumentation-examples/afl/bug</span></span></code> </pre> <br><p> å¹¶è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ï¼š </p><br><pre> <code class="bash hljs">AFL_SKIP_BIN_CHECK=1 afl-fuzz -i ../input -o ../output -m none -- ./forksrv</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">ç¾å›½æ¨¡ç³Šåœˆ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">1234 T234 TE34 TES4 TEST &lt;-     crashes,    2200  </code> </pre> </div></div><br><p> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œé€Ÿåº¦è¿˜ä¸æ˜¯å¾ˆçƒ­ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªå€Ÿå£ï¼Œæˆ‘ç°åœ¨è¦è¯´çš„æ˜¯ï¼Œè¿™é‡Œï¼ˆ <code>qemu_mode</code>ä¸ä½¿ç”¨åŸå§‹<code>qemu_mode</code>çš„é‡è¦åŠŸèƒ½ï¼šå°†å¯æ‰§è¡Œä»£ç çš„åœ°å€å‘é€åˆ°forkæœåŠ¡å™¨ã€‚ ä½†æ˜¯ï¼Œç°åœ¨QEMUä»£ç åº“ä¸­æ²¡æœ‰AFLï¼Œå¹¶ä¸”å¸Œæœ›è¿™ç§é€šç”¨åŒ–çš„å·¥å…·æœ‰ä¸€å¤©ä¼šæŒ¤åœ¨ä¸Šæ¸¸ã€‚ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHubé¡¹ç›®</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN452608/">https://habr.com/ru/post/zh-CN452608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN452592/index.html">ç¬¬0éƒ¨åˆ†ã€‚éœ€è¦ä¸€ä¸ªelfåœ¨Matrixä¸­å·¥ä½œã€‚ å¯ä»¥æ¬è¿</a></li>
<li><a href="../zh-CN452596/index.html">ä»ä¸€ä¸ªéª—å­é‚£é‡Œè·å¾—äº†735,000ä¸ªIPv4åœ°å€ï¼Œå¹¶å°†å…¶è¿”å›æ³¨å†Œè¡¨</a></li>
<li><a href="../zh-CN452598/index.html">ç¨‹åºå‘˜å›¢é˜Ÿçš„ç®¡ç†ï¼šå¦‚ä½•ä»¥åŠå¦‚ä½•æ­£ç¡®æ¿€åŠ±ä»–ä»¬ï¼Ÿ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN452602/index.html">é€‚ç”¨äºé«˜è´Ÿè½½æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„Cisco Hyperflex</a></li>
<li><a href="../zh-CN452606/index.html">UDBã€‚ è¿™æ˜¯ä»€ä¹ˆ ç¬¬8éƒ¨åˆ†ã€‚å¤„ç†UDB</a></li>
<li><a href="../zh-CN452610/index.html">å¸®åŠ©å¹¶è¦æ±‚å¥¹ã€‚ å…³äºæ™®é€šç”¨æˆ·ä¿¡æ¯å®‰å…¨çš„æ–‡ç« </a></li>
<li><a href="../zh-CN452612/index.html">åœ¨tensorflow.jsä¸ŠåŠ å¼ºæ·±åº¦ç¥ç»ç½‘ç»œæœºå™¨å­¦ä¹ ï¼šæŠ€å·§</a></li>
<li><a href="../zh-CN452614/index.html">å¦‚ä½•åœ¨Adobe Illustratorä¸­å¼€å§‹ç¼–ç¨‹ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN452618/index.html">Google I / O 2019æ‰€è¯´çš„è¯ï¼šAndroid 10ï¼ŒARåº”ç”¨ç¨‹åºç­‰ç­‰</a></li>
<li><a href="../zh-CN452620/index.html">ä½¿ç”¨Typescriptæ´¾ç”ŸåŠ¨ä½œç±»å‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>