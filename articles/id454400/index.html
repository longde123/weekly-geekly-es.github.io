<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèúÔ∏è üìì üï∫üèø Laporan Harian Status Mesin Virtual dengan R dan PowerShell ‚è´ üßïüèª ‚úãüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entri 


 Hari yang baik Selama setengah tahun sekarang kami telah menjalankan skrip (lebih tepatnya, serangkaian skrip) yang menghasilkan laporan ten...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Laporan Harian Status Mesin Virtual dengan R dan PowerShell</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454400/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/px/tu/kg/pxtukg8q2rhe_wcyxiwdbfa9euq.jpeg"></div><br><h4 id="vstuplenie">  Entri </h4><br><p>  Hari yang baik  Selama setengah tahun sekarang kami telah menjalankan skrip (lebih tepatnya, serangkaian skrip) yang menghasilkan laporan tentang keadaan mesin virtual (dan tidak hanya).  Saya memutuskan untuk membagikan pengalaman pembuatan dan kode itu sendiri.  Saya mengandalkan kritik dan fakta bahwa materi ini mungkin berguna bagi seseorang. </p><a name="habracut"></a><br><h4 id="formirovanie-potrebnosti">  Perlu pembentukan </h4><br><p>  Kami memiliki banyak mesin virtual (sekitar 1500 VM yang didistribusikan melalui vCenter ke-3).  Yang baru dibuat dan yang lama sering dihapus.  Untuk menjaga ketertiban, beberapa bidang khusus ditambahkan ke vCenter untuk membagi VM menjadi Subsistem, menunjukkan apakah mereka diuji, serta oleh siapa dan kapan.  Faktor manusia telah mengarah pada fakta bahwa lebih dari setengah mobil dibiarkan kosong, yang mempersulit pekerjaan.  Sekali setiap enam bulan, seseorang menjadi panik, mulai bekerja memperbarui data ini, tetapi hasilnya tidak lagi relevan selama satu setengah minggu. <br>  Saya akan segera mengklarifikasi bahwa semua orang memahami bahwa harus ada aplikasi untuk membuat mesin, proses pembuatannya, dll.  dll.  Dan sementara semua proses ini diikuti secara ketat dan teratur.  Sayangnya, ini bukan masalahnya dengan kami, tetapi ini bukan subjek dari artikel :) </p><br><p>  Secara umum, diputuskan untuk mengotomatiskan verifikasi kebenaran pengisian bidang. <br>  Kami memutuskan bahwa surat harian dengan daftar mesin yang tidak diisi dengan benar untuk semua insinyur yang bertanggung jawab dan atasan mereka akan menjadi awal yang baik. </p><br><p>  Pada titik ini, salah satu rekan sudah menerapkan skrip PowerShell, yang setiap hari sesuai jadwal mengumpulkan informasi pada semua mesin semua vCenter-s dan membentuk 3 dokumen csv (masing-masing dalam vCenter sendiri), yang diletakkan di disk bersama.  Diputuskan untuk mengambil skrip ini sebagai dasar dan menambahnya dengan cek menggunakan bahasa R, yang saya punya pengalaman dengannya. </p><br><p>  Dalam proses finalisasi, solusinya ditumbuhi dengan memberi informasi melalui surat, database dengan tabel utama dan historis (lebih lanjut tentang ini nanti), serta menganalisis log vSphere untuk menemukan pembuat sebenarnya vm dan waktu pembuatannya. </p><br><p>  Untuk pengembangan, IDE RStudio Desktop dan PowerShell ISE digunakan. </p><br><p>  Script diluncurkan dari mesin virtual Windows biasa. </p><br><h4 id="opisanie-obschey-logiki">  Deskripsi logika umum. </h4><br><p>  Logika umum skrip adalah sebagai berikut. </p><br><ul><li>  Kami mengumpulkan data pada mesin virtual menggunakan skrip PowerShell, yang disebut melalui R, hasilnya digabungkan menjadi satu csv.  Interaksi terbalik antar bahasa dilakukan dengan cara yang sama.  (itu mungkin untuk mengarahkan data langsung dari R ke PowerShell dalam bentuk variabel, tetapi sulit, dan bahkan dengan csv menengah lebih mudah untuk men-debug dan berbagi hasil antara dengan seseorang). </li><li>  Menggunakan R, kami membentuk parameter yang valid untuk bidang yang nilainya kami periksa.  - Kami sedang membentuk dokumen kata yang akan berisi nilai-nilai bidang ini untuk dimasukkan ke dalam surat informasi yang akan menjadi jawaban untuk pertanyaan dari rekan kerja "Tidak baik, tapi bagaimana saya harus mengisi ini?" </li><li>  Kami memuat data pada semua VM dari csv menggunakan R, membentuk kerangka data, menghapus bidang yang tidak perlu dan membentuk dokumen informasi xlsx yang akan berisi informasi ringkasan tentang semua VM yang kami unggah ke sumber daya bersama. </li><li>  Untuk kerangka data untuk semua VM, kami menerapkan semua pemeriksaan untuk kebenaran mengisi bidang dan membentuk tabel yang hanya berisi VM dengan bidang yang tidak diisi dengan benar (dan hanya bidang ini). </li><li>  Daftar VM yang dihasilkan dikirim ke skrip PowerShell lain, yang akan melihat log vCenter untuk acara pembuatan VM, yang akan memungkinkan Anda untuk menentukan perkiraan waktu pembuatan VM dan pembuat yang dimaksud.  Ini adalah kasus ketika tidak ada yang mengaku mobilnya.  Skrip ini tidak berfungsi dengan cepat, terutama jika ada banyak log, jadi kami hanya melihat pada 2 minggu terakhir, dan kami juga menggunakan alur kerja, yang memungkinkan Anda untuk mencari informasi pada beberapa VM secara bersamaan.  Dalam contoh skrip, ada komentar terperinci tentang mekanisme ini.  Hasilnya ditambahkan ke csv, yang kembali dimuat ke R. </li><li>  Kami membentuk dokumen xlsx yang diformat dengan indah di mana bidang yang tidak diisi dengan benar akan disorot dalam warna merah, filter akan diterapkan ke beberapa kolom, dan kolom tambahan berisi dugaan pembuat dan waktu pembuatan VM akan ditunjukkan. </li><li>  Kami membentuk email, tempat kami meletakkan dokumen yang menggambarkan nilai-nilai bidang yang valid, serta tabel dengan salah mengisi.  Dalam teks kami menunjukkan jumlah total VM yang dibuat secara tidak benar, tautan ke sumber daya bersama dan gambar motivasi.  Jika tidak ada VM yang tidak diisi dengan benar, kami mengirim surat lain dengan gambar motivasi yang lebih menyenangkan. </li><li>  Kami mencatat data pada semua VM di database SQL Server, dengan mempertimbangkan mekanisme tabel historis yang diterapkan (mekanisme yang sangat menarik - yang lebih detail) </li></ul><br><h4 id="sobstvenno-skripty">  Skrip </h4><br><div class="spoiler">  <b class="spoiler_title">File utama dengan kode untuk R</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     (       ) setwd("C:\\Scripts\\getVm") ####    #### library(tidyverse) library(xlsx) library(mailR) library(rmarkdown) #####         ##### source(file = "const.R", local = T, encoding = "utf-8") #        ,  . if (file.exists(filenameVmCreationRules)) {file.remove(filenameVmCreationRules)} ####       render("VM_name_rules.Rmd", output_format = word_document(), output_file = filenameVmCreationRules) #        ,   if (file.exists(allVmXlsxPath)) {file.remove(allVmXlsxPath)} ####       PowerShell .    csv. system(paste0("powershell -File ", getVmPsPath)) #  df fullXslx_df &lt;- allVmXlsxPath %&gt;% read.csv2(stringsAsFactors = FALSE) #     full_df &lt;- fullXslx_df %&gt;% mutate( #       ,    ,      , isSubsystemCorrect = Subsystem %&gt;% gsub("[[:space:]]", "", .) %&gt;% str_split(., ",") %&gt;% map(function(x) (all(x %in% AllowedValues$Subsystem))) %&gt;% as.logical(), isOwnerCorrect = Owner %in% AllowedValues$Owner, isCategoryCorrect = Category %in% AllowedValues$Category, isCreatorCorrect = (!is.na(Creator) &amp; Creator != ''), isCreation.DateCorrect = map(Creation.Date, IsDate) ) #        ,  . if (file.exists(filenameAll)) {file.remove(filenameAll)} ####  xslx    #### #      full_df %&gt;% write.xlsx(file=filenameAll, sheetName=names[1], col.names=TRUE, row.names=FALSE, append=FALSE) ####  xslx      #### #  df incorrect_df &lt;- full_df %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Creator, Category, Creation.Date, isOwnerCorrect, isSubsystemCorrect, isCategoryCorrect, isCreatorCorrect, vCenter.Name) %&gt;% filter(isSubsystemCorrect == F | isOwnerCorrect == F | isCategoryCorrect == F | isCreatorCorrect == F) #        ,  . if (file.exists(filenameIncVM)) {file.remove(filenameIncVM)} #   VM     csv incorrect_df %&gt;% select(VM.Name) %&gt;% write_csv2(path = filenameIncVM, append = FALSE) #      incorrect_df_filtered &lt;- incorrect_df %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Category, Creator, vCenter.Name, Creation.Date ) #    numberOfRows &lt;- nrow(incorrect_df) ####   #### #        ,  . #   -     if (numberOfRows &gt; 0) { #       ,  . if (file.exists(creatorsFilePath)) {file.remove(creatorsFilePath)} #  PowerShell ,     VM.    csv. system(paste0("powershell -File ", getCreatorsPath)) #     creators_df &lt;- creatorsFilePath %&gt;% read.csv2(stringsAsFactors = FALSE) #     ,       incorrect_df_filtered &lt;- incorrect_df_filtered %&gt;% select(VM.Name, IP.s, Owner, Subsystem, Category, Creator, vCenter.Name, Creation.Date ) %&gt;% left_join(creators_df, by = "VM.Name") %&gt;% rename(` ` = CreatedBy, `  ` = CreatedOn) #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  .&lt;/h3&gt; &lt;p&gt;           H:  :&lt;p&gt; &lt;p&gt;\\\\server.ru\\VM\\', sourceFileFormat, '&lt;/p&gt; &lt;p&gt;      &lt;strong&gt; &lt;/strong&gt; .   &lt;strong&gt;', numberOfRows,'&lt;/strong&gt;.&lt;/p&gt; &lt;p&gt;   2  . &lt;strong&gt; &lt;/strong&gt;  &lt;strong&gt;  &lt;/strong&gt;,     vCenter   2 &lt;/p&gt; &lt;p&gt;        .      &lt;/p&gt; &lt;p&gt;&lt;img src="data/meme.jpg"&gt;&lt;/p&gt; &lt;/html&gt;' ) #    if (file.exists(filenameIncorrect)) {file.remove(filenameIncorrect)} #       .. source(file = "email.R", local = T, encoding = "utf-8") ####       #### send.mail(from = emailParams$from, to = emailParams$to, subject = "    ", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, attach.files = c(filenameIncorrect, filenameVmCreationRules), debug = FALSE) ####   ,      #### } else { #    emailBody &lt;- paste0( '&lt;html&gt; &lt;h3&gt; ,  &lt;/h3&gt; &lt;p&gt;           H:  :&lt;p&gt; &lt;p&gt;\\\\server.ru\\VM\\', sourceFileFormat, '&lt;/p&gt; &lt;p&gt;,   ,     &lt;/p&gt; &lt;p&gt;&lt;img src="data/meme_correct.jpg"&gt;&lt;/p&gt; &lt;/html&gt;' ) ####      VM #### send.mail(from = emailParams$from, to = emailParams$to, subject = " ", body = emailBody, encoding = "utf-8", html = TRUE, inline = TRUE, smtp = emailParams$smtpParams, authenticate = TRUE, send = TRUE, debug = FALSE) } #######     ##### source(file = "DB.R", local = T, encoding = "utf-8")</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Script untuk mendapatkan daftar vm di PowerShell</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#       $vCenterNames = @( "vcenter01", "vcenter02", "vcenter03" ) $vCenterUsername = "myusername" $vCenterPassword = "mypassword" $filename = "C:\Scripts\getVm\data\allvm\all-vm-$(get-date -f yyyy-MM-dd).csv" $destinationSMB = "\\server.ru\myfolder$\vm" $IP0="" $IP1="" $IP2="" $IP3="" $IP4="" $IP5="" #    vCenter,    .  ,      (, ) Connect-VIServer -Server $vCenterNames -User $vCenterUsername -Password $vCenterPassword write-host "" #       vCenter- function Get-VMinventory { #       ,   $AllVM = Get-VM | Sort Name $cnt = $AllVM.Count $count = 1 #            foreach ($vm in $AllVM) { $StartTime = $(get-date) $IP0 = $vm.Guest.IPAddress[0] $IP1 = $vm.Guest.IPAddress[1] $IP2 = $vm.Guest.IPAddress[2] $IP3 = $vm.Guest.IPAddress[3] $IP4 = $vm.Guest.IPAddress[4] $IP5 = $vm.Guest.IPAddress[5] If ($IP0 -ne $null) {If ($IP0.Contains(":") -ne 0) {$IP0=""}} If ($IP1 -ne $null) {If ($IP1.Contains(":") -ne 0) {$IP1=""}} If ($IP2 -ne $null) {If ($IP2.Contains(":") -ne 0) {$IP2=""}} If ($IP3 -ne $null) {If ($IP3.Contains(":") -ne 0) {$IP3=""}} If ($IP4 -ne $null) {If ($IP4.Contains(":") -ne 0) {$IP4=""}} If ($IP5 -ne $null) {If ($IP5.Contains(":") -ne 0) {$IP5=""}} $cluster = $vm | Get-Cluster | Select-Object -ExpandProperty name $Bootime = $vm.ExtensionData.Runtime.BootTime $TotalHDDs = $vm.ProvisionedSpaceGB -as [int] $CreationDate = $vm.CustomFields.Item("CreationDate") -as [string] $Creator = $vm.CustomFields.Item("Creator") -as [string] $Category = $vm.CustomFields.Item("Category") -as [string] $Owner = $vm.CustomFields.Item("Owner") -as [string] $Subsystem = $vm.CustomFields.Item("Subsystem") -as [string] $IPS = $vm.CustomFields.Item("IP") -as [string] $vCPU = $vm.NumCpu $CorePerSocket = $vm.ExtensionData.config.hardware.NumCoresPerSocket $Sockets = $vCPU/$CorePerSocket $Id = $vm.Id.Split('-')[2] -as [int] #       $Vmresult = New-Object PSObject $Vmresult | add-member -MemberType NoteProperty -Name "Id" -Value $Id $Vmresult | add-member -MemberType NoteProperty -Name "VM Name" -Value $vm.Name $Vmresult | add-member -MemberType NoteProperty -Name "Cluster" -Value $cluster $Vmresult | add-member -MemberType NoteProperty -Name "Esxi Host" -Value $VM.VMHost $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 1" -Value $IP0 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 2" -Value $IP1 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 3" -Value $IP2 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 4" -Value $IP3 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 5" -Value $IP4 $Vmresult | add-member -MemberType NoteProperty -Name "IP Address 6" -Value $IP5 $Vmresult | add-member -MemberType NoteProperty -Name "vCPU" -Value $vCPU $Vmresult | Add-Member -MemberType NoteProperty -Name "CPU Sockets" -Value $Sockets $Vmresult | Add-Member -MemberType NoteProperty -Name "Core per Socket" -Value $CorePerSocket $Vmresult | add-member -MemberType NoteProperty -Name "RAM (GB)" -Value $vm.MemoryGB $Vmresult | add-member -MemberType NoteProperty -Name "Total-HDD (GB)" -Value $TotalHDDs $Vmresult | add-member -MemberType NoteProperty -Name "Power State" -Value $vm.PowerState $Vmresult | add-member -MemberType NoteProperty -Name "OS" -Value $VM.ExtensionData.summary.config.guestfullname $Vmresult | Add-Member -MemberType NoteProperty -Name "Boot Time" -Value $Bootime $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Status" -Value $vm.ExtensionData.Guest.ToolsStatus $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Version" -Value $vm.ExtensionData.Guest.ToolsVersion $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Version Status" -Value $vm.ExtensionData.Guest.ToolsVersionStatus $Vmresult | add-member -MemberType NoteProperty -Name "VMTools Running Status" -Value $vm.ExtensionData.Guest.ToolsRunningStatus $Vmresult | add-member -MemberType NoteProperty -Name "Creation Date" -Value $CreationDate $Vmresult | add-member -MemberType NoteProperty -Name "Creator" -Value $Creator $Vmresult | add-member -MemberType NoteProperty -Name "Category" -Value $Category $Vmresult | add-member -MemberType NoteProperty -Name "Owner" -Value $Owner $Vmresult | add-member -MemberType NoteProperty -Name "Subsystem" -Value $Subsystem $Vmresult | add-member -MemberType NoteProperty -Name "IP's" -Value $IPS $Vmresult | add-member -MemberType NoteProperty -Name "vCenter Name" -Value $vm.Uid.Split('@')[1].Split(':')[0] #           .   ,      . $elapsedTime = $(get-date) - $StartTime $totalTime = "{0:HH:mm:ss}" -f ([datetime]($elapsedTime.Ticks*($cnt - $count))) clear-host Write-Host "Processing" $count "from" $cnt Write-host "Progress:" ([math]::Round($count/$cnt*100, 2)) "%" Write-host "You have about " $totalTime "for cofee" Write-host "" $count++ #  ,   ""       $Vmresult } } #         csv $allVm = Get-VMinventory | Export-CSV -Path $filename -NoTypeInformation -UseCulture -Force #         ,   ,  . try { Copy-Item $filename -Destination $destinationSMB -Force -ErrorAction SilentlyContinue } catch { $error | Export-CSV -Path $filename".error" -NoTypeInformation -UseCulture -Force }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Script PowerShell mengeluarkan log dari pencipta mesin virtual dan tanggal pembuatannya</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   ,      VM $VMfilePath = "C:\Scripts\getVm\creators_VM\creators_VM_$(get-date -f yyyy-MM-dd).csv" #   ,      $filePath = "C:\Scripts\getVm\data\creators\creators-$(get-date -f yyyy-MM-dd).csv" #   Workflow GetCreators-Wf { # ,        param([string[]]$VMfilePath) # ,     workflow $vCenterUsername = "myusername" $vCenterPassword = "mypassword" $daysToLook = 14 $start = (get-date).AddDays(-$daysToLook) $finish = get-date # ,     csv  ,       $UnknownUser = "UNKNOWN" $UnknownCreatedTime = "0000-00-00" #      ,      . $vCenterNames = @( "vcenter01", "vcenter02", "vcenter03" ) #   VM  csv     $list = Import-Csv $VMfilePath -UseCulture | select -ExpandProperty VM.Name # ,     ( 5   ) foreach -parallel ($row in $list) { #  ,       ,     $Using InlineScript { #      $StartTime = $(get-date) Write-Host "" Write-Host "Processing $Using:row started at $StartTime" Write-Host "" #    ,         $con = Connect-VIServer -Server $Using:vCenterNames -User $Using:vCenterUsername -Password $Using:vCenterPassword #   vm $vm = Get-VM -Name $Using:row #  2  .     ,  - .   , $Event = $vm | Get-VIEvent -Start $Using:start -Finish $Using:finish -Types Info | Where { $_.Gettype().Name -eq "VmBeingDeployedEvent" -or $_.Gettype().Name -eq "VmCreatedEvent" -or $_.Gettype().Name -eq "VmRegisteredEvent" -or $_.Gettype().Name -eq "VmClonedEvent"} # $Event = $vm | Get-VIEvent -Types Info | Where { $_.Gettype().Name -eq "VmBeingDeployedEvent" -or $_.Gettype().Name -eq "VmCreatedEvent" -or $_.Gettype().Name -eq "VmRegisteredEvent" -or $_.Gettype().Name -eq "VmClonedEvent"} #      ,      - If (($Event | Measure-Object).Count -eq 0){ $User = $Using:UnknownUser $Created = $Using:UnknownCreatedTime $CreatedFormat = $Using:UnknownCreatedTime } Else { If ($Event.Username -eq "" -or $Event.Username -eq $null) { $User = $Using:UnknownUser } Else { $User = $Event.Username } # Else $CreatedFormat = $Event.CreatedTime #     ,      ,   .      . $Created = $Event.CreatedTime.ToString('yyyy-MM-dd') } # Else Write-Host "Creator for $vm is $User. Creating object." #  .  . $Vmresult = New-Object PSObject $Vmresult | add-member -MemberType NoteProperty -Name "VM Name" -Value $vm.Name $Vmresult | add-member -MemberType NoteProperty -Name "CreatedBy" -Value $User $Vmresult | add-member -MemberType NoteProperty -Name "CreatedOn" -Value $CreatedFormat $Vmresult | add-member -MemberType NoteProperty -Name "CreatedOnFormat" -Value $Created #   $Vmresult } # Inline } # ForEach } $Creators = GetCreators-Wf $VMfilePath #     $Creators | select 'VM Name', CreatedBy, CreatedOn | Export-Csv -Path $filePath -NoTypeInformation -UseCulture -Force Write-Host "CSV generetion finisghed at $(get-date). PROFIT"</span></span></code> </pre></div></div><br><p>  Pustaka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">xlsx</a> pantas mendapatkan perhatian khusus, yang memungkinkan untuk membuat lampiran ke surat diformat dengan jelas (seperti yang disukai manual), dan bukan hanya tabel csv. </p><br><div class="spoiler">  <b class="spoiler_title">Membuat dokumen xlsx yang indah dengan daftar mesin yang salah isi</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    #   : "xls"  "xlsx" wb&lt;-createWorkbook(type="xlsx") #         TABLE_ROWNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) TABLE_COLNAMES_STYLE &lt;- CellStyle(wb) + Font(wb, isBold=TRUE) + Alignment(wrapText=TRUE, horizontal="ALIGN_CENTER") + Border(color="black", position=c("TOP", "BOTTOM"), pen=c("BORDER_THIN", "BORDER_THICK")) #    sheet &lt;- createSheet(wb, sheetName = names[2]) #   addDataFrame(incorrect_df_filtered, sheet, startRow=1, startColumn=1, row.names=FALSE, byrow=FALSE, colnamesStyle = TABLE_COLNAMES_STYLE, rownamesStyle = TABLE_ROWNAMES_STYLE) #  ,     autoSizeColumn(sheet = sheet, colIndex=c(1:ncol(incorrect_df))) #   addAutoFilter(sheet, cellRange = "C1:G1") #   fo2 &lt;- Fill(foregroundColor="red") cs2 &lt;- CellStyle(wb, fill = fo2, dataFormat = DataFormat("@")) #              rowsOwner &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isOwnerCorrect) + 1)) cellsOwner &lt;- getCells(rowsOwner, colIndex = which( colnames(incorrect_df_filtered) == "Owner" )) lapply(names(cellsOwner), function(x) setCellStyle(cellsOwner[[x]], cs2)) #              rowsSubsystem &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isSubsystemCorrect) + 1)) cellsSubsystem &lt;- getCells(rowsSubsystem, colIndex = which( colnames(incorrect_df_filtered) == "Subsystem" )) lapply(names(cellsSubsystem), function(x) setCellStyle(cellsSubsystem[[x]], cs2)) #    rowsCategory &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isCategoryCorrect) + 1)) cellsCategory &lt;- getCells(rowsCategory, colIndex = which( colnames(incorrect_df_filtered) == "Category" )) lapply(names(cellsCategory), function(x) setCellStyle(cellsCategory[[x]], cs2)) #  rowsCreator &lt;- getRows(sheet, rowIndex = (which(!incorrect_df$isCreatorCorrect) + 1)) cellsCreator &lt;- getCells(rowsCreator, colIndex = which( colnames(incorrect_df_filtered) == "Creator" )) lapply(names(cellsCreator), function(x) setCellStyle(cellsCreator[[x]], cs2)) #   saveWorkbook(wb, filenameIncorrect)</span></span></code> </pre> </div></div><br><p>  Outputnya kira-kira seperti ini: </p><br><img src="https://habrastorage.org/webt/ax/y7/bv/axy7bvclwghyjabvvzuanyb2_ry.jpeg"><br><br>  Ada juga nuansa yang menarik dalam mengatur Windows scheduller.  Tidak berhasil untuk mengambil hak dan parameter pengaturan yang benar sehingga semuanya akan dimulai sebagaimana mestinya.  Akibatnya, pustaka R ditemukan, yang dengan sendirinya membuat tugas untuk menjalankan skrip R dan bahkan tidak melupakan file log.  Kemudian Anda dapat memperbaiki tugas dengan pena. <br><br><br><div class="spoiler">  <b class="spoiler_title">Sepotong kode R dengan dua contoh yang membuat tugas di Penjadwal Windows</b> <div class="spoiler_text"><pre> <code class="python hljs">library(taskscheduleR) myscript &lt;- file.path(getwd(), <span class="hljs-string"><span class="hljs-string">"all_vm.R"</span></span>) <span class="hljs-comment"><span class="hljs-comment">##    62  taskscheduler_create(taskname = "getAllVm", rscript = myscript, schedule = "ONCE", starttime = format(Sys.time() + 62, "%H:%M")) ##      09:10 taskscheduler_create(taskname = "getAllVmDaily", rscript = myscript, schedule = "WEEKLY", days = c("MON", "TUE", "WED", "THU", "FRI"), starttime = "02:00") ##   taskscheduler_delete(taskname = "getAllVm") taskscheduler_delete(taskname = "getAllVmDaily") #   ( 4 ) tail(readLines("all_vm.log"), sep ="\n", n = 4)</span></span></code> </pre> </div></div><br><h4 id="otdelno-pro-bd">  Secara terpisah, tentang database </h4><br><p>  Setelah menyiapkan skrip, pertanyaan lain mulai muncul.  Sebagai contoh, saya ingin mencari tanggal kapan VM dihapus, dan log di vCenter sudah dipakai.  Karena skrip menempatkan file ke folder setiap hari dan tidak membersihkannya (kami membersihkannya dengan tangan kami ketika kami ingat), Anda dapat melihat file lama dan menemukan file pertama di mana VM ini tidak ada.  Tapi itu tidak keren. </p><br><p>  Saya ingin membuat database historis. </p><br><p>  Fungsionalitas MS SQL SERVER datang ke bantuan - tabel temporal versi sistem.  Biasanya diterjemahkan sebagai tabel sementara (non-sementara). </p><br><p>  Anda dapat membaca secara detail di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi resmi Microsoft</a> . </p><br><p>  Singkatnya, kita membuat tabel, kita mengatakan bahwa kita akan memilikinya dengan versi dan SQL Server membuat 2 kolom datetime tambahan dalam tabel ini (tanggal catatan dibuat dan tanggal catatan kadaluwarsa) dan tabel tambahan di mana perubahan akan ditulis.  Sebagai hasilnya, kami memperoleh informasi yang relevan dan, melalui pertanyaan sederhana, contoh-contoh yang diberikan dalam dokumentasi, kami dapat melihat siklus hidup mesin virtual tertentu atau keadaan semua VM pada titik waktu tertentu. </p><br><p>  Dalam hal kinerja, transaksi tulis ke tabel utama tidak akan selesai sampai transaksi tulis ke tabel sementara selesai.  Yaitu  pada tabel dengan sejumlah besar operasi penulisan, fungsi ini harus diterapkan dengan hati-hati, tetapi dalam kasus kami ini adalah hal yang sangat keren. </p><br><p>  Agar mekanisme berfungsi dengan benar, perlu untuk menambahkan sepotong kecil kode pada R yang akan membandingkan tabel baru dengan data untuk semua VM dengan yang disimpan dalam database dan menulis hanya mengubah baris untuk itu.  Kode ini tidak terlalu rumit, ia menggunakan library compareDF, tapi saya juga akan memberikannya di bawah ini. </p><br><div class="spoiler">  <b class="spoiler_title">Kode R untuk menulis data ke basis data</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   library(odbc) library(compareDF) #   con &lt;- dbConnect(odbc(), Driver = "ODBC Driver 13 for SQL Server", Server = DBParams$server, Database = DBParams$database, UID = DBParams$UID, PWD = DBParams$PWD, Port = 1433) ####    .   - . #### if (!dbExistsTable(con, DBParams$TblName)) { ####   #### create &lt;- dbSendStatement( con, paste0( 'CREATE TABLE ', DBParams$TblName, '( [Id] [int] NOT NULL PRIMARY KEY CLUSTERED, [VM.Name] [varchar](255) NULL, [Cluster] [varchar](255) NULL, [Esxi.Host] [varchar](255) NULL, [IP.Address.1] [varchar](255) NULL, [IP.Address.2] [varchar](255) NULL, [IP.Address.3] [varchar](255) NULL, [IP.Address.4] [varchar](255) NULL, [IP.Address.5] [varchar](255) NULL, [IP.Address.6] [varchar](255) NULL, [vCPU] [int] NULL, [CPU.Sockets] [int] NULL, [Core.per.Socket] [int] NULL, [RAM..GB.] [int] NULL, [Total.HDD..GB.] [int] NULL, [Power.State] [varchar](255) NULL, [OS] [varchar](255) NULL, [Boot.Time] [varchar](255) NULL, [VMTools.Status] [varchar](255) NULL, [VMTools.Version] [int] NULL, [VMTools.Version.Status] [varchar](255) NULL, [VMTools.Running.Status] [varchar](255) NULL, [Creation.Date] [varchar](255) NULL, [Creator] [varchar](255) NULL, [Category] [varchar](255) NULL, [Owner] [varchar](255) NULL, [Subsystem] [varchar](255) NULL, [IP.s] [varchar](255) NULL, [vCenter.Name] [varchar](255) NULL, DateFrom datetime2 GENERATED ALWAYS AS ROW START NOT NULL, DateTo datetime2 GENERATED ALWAYS AS ROW END NOT NULL, PERIOD FOR SYSTEM_TIME (DateFrom, DateTo) ) ON [PRIMARY] WITH (SYSTEM_VERSIONING = ON (HISTORY_TABLE = ', DBParams$TblHistName,'));' ) ) #    dbClearResult(create) } # if ####     #### #  ,     allVM_db_con &lt;- tbl(con, DBParams$TblName) ####   #### #     (   ) allVM_db &lt;- allVM_db_con %&gt;% select(c(-"DateTo", -"DateFrom")) %&gt;% collect() #     .   Id #       -,   +,   -  + ctable_VM &lt;- fullXslx_df %&gt;% compare_df(allVM_db, c("Id")) ####   #### #  Id ,      remove_Id &lt;- ctable_VM$comparison_df %&gt;% filter(chng_type == "-") %&gt;% select(Id) # ,    (   -     ) if (remove_Id %&gt;% nrow() &gt; 0) { #        delete &lt;- dbSendStatement(con, paste0(' DELETE FROM ', DBParams$TblName, ' WHERE "Id"=? ') # paste ) # send #      dbBind(delete, remove_Id) #    dbClearResult(delete) } # if ####   #### #  ,  ,   . allVM_add &lt;- ctable_VM$comparison_df %&gt;% filter(chng_type == "+") %&gt;% select(-chng_type) # ,   ,      (  -  ) if (allVM_add %&gt;% nrow() &gt; 0) { #       dbWriteTable(con, DBParams$TblName, allVM_add, overwrite = FALSE, append = TRUE) } # if ####     #### dbDisconnect(con)</span></span></code> </pre> </div></div><br><h4 id="itogo">  Total </h4><br><p>  Sebagai hasil dari pengenalan naskah, pesanan dipertahankan dan dipertahankan selama beberapa bulan.  Terkadang VM yang salah mengisi muncul, tetapi skrip berfungsi sebagai pengingat yang baik dan VM langka masuk ke dalam daftar selama 2 hari berturut-turut. </p><br><p>  Cadangan juga dibuat untuk analisis data historis. </p><br><p>  Jelas bahwa banyak dari hal ini dapat direalisasikan bukan "di lutut", tetapi dengan perangkat lunak khusus, tetapi tugas itu menarik dan, bisa dikatakan, opsional. </p><br><p>  Sekali lagi R terbukti menjadi bahasa universal yang indah, yang sempurna tidak hanya untuk memecahkan masalah statistik, tetapi juga bertindak sebagai "peletakan" yang sangat baik antara sumber data lainnya. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/g6/bn/1i/g6bn1ijgn9x3_e2nhnjq6jk5bdw.jpeg"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id454400/">https://habr.com/ru/post/id454400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id454386/index.html">MessageBox untuk AvaloniaUI</a></li>
<li><a href="../id454388/index.html">ARA: algoritma untuk menemukan jumlah maksimum poin pada garis lurus</a></li>
<li><a href="../id454394/index.html">Pemain MIDI Minimalis Empat Bagian</a></li>
<li><a href="../id454396/index.html">Instal sdl2 pada distribusi utama</a></li>
<li><a href="../id454398/index.html">Dari kritik hingga algoritma: bagaimana demokrasi dan teknokrasi datang ke industri musik</a></li>
<li><a href="../id454402/index.html">Arsitektur Mesin Unity State untuk Mengatur Perilaku Unit</a></li>
<li><a href="../id454404/index.html">Pelatihan Cisco 200-125 CCNA v3.0. Hari 6. Isi bagian yang kosong (DHCP, TCP, "jabat tangan", nomor port umum)</a></li>
<li><a href="../id454406/index.html">Akihabara: situs bersarang otaku</a></li>
<li><a href="../id454408/index.html">Banding bit perangkat keras CortexM3 / M4 (ARM), arsitektur kernel, assembler, C / C ++ 14 dan setetes metaprogramming</a></li>
<li><a href="../id454410/index.html">Baru di PHP 7.4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>