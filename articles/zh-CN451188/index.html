<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤾 🧔🏽 🗯️ Sberbank或那里然后回来 ✌🏼 👨‍👨‍👧 ✊🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="第1章。意外的客人 
 这一切都是从不幸的早晨开始的，当时项目经理宣布应将项目实施的最后期限迅速而果断地减少一个月。 更准确地说，该项目应在4天内准备就绪。 不，我们的订单不是野兽，它看上去完全不像猫头鹰 （也许有点像乌鸦），只是发生了。 好吧，如果有必要，那是有必要的，尤其是因为向该团队（我是“ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sberbank或那里然后回来</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451188/"><img src="https://habrastorage.org/webt/si/bq/2u/sibq2unjy0i1yoy_7sa0qljphae.jpeg"><br><br><h2> 第1章。意外的客人 </h2><br> 这一切都是从不幸的早晨开始的，当时项目经理宣布应将项目实施的最后期限迅速而果断地减少一个月。 更准确地说，该项目应在4天内准备就绪。 不，我们的订单不是野兽，它看上去完全不像<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">猫头鹰</a> （也许有点像乌鸦），只是发生了。 好吧，如果有必要，那是有必要的，尤其是因为向该团队（我是“ C”团队的主要开发人员）承诺要提供美味的东西。 时间和日历是星期四，11：00，到星期一，项目应该已经准备好了。 <br><br> 首先，我们到底在做什么。 我们从事电影院的自动化-设备的自动和远程控制，电影放映，监控，视频面板的自动化，现在还包括用于售票和酒吧的终端。 具体而言，最后一段专门针对本文。 <br><a name="habracut"></a><br> 该项目本身必须在星期一之前完成，它是Scala上的主服务器和铁付款终端VeriFone VX 820之间的一种层（实际上，还有更多的终端，但仅以它为例）。 显然，没有人会像这样给我们提供交易，因此使用了Sberbank / Arcus和UCS的实用程序和库。 因此，工作方案应如下： <br><br><img src="https://habrastorage.org/webt/ak/k4/do/akk4do9scie61w_tobeuwpk6liu.png"><br><br> 从外部看，它看起来像这样： <br><br><img src="https://habrastorage.org/webt/oh/ul/ts/ohultstzocyw8za06mbxqwmnrma.jpeg"><br><br> 同样，此子系统应在每个收银员在任何电影院看到的标准收银机上使用。 <br><br> 根据内部传统，我们将团队的每个项目都命名为Old Norse神话，为该子系统选择了名称Gefjon-生育力和生育力的女神的名字（对支付服务器来说是个好名字，不是吗？好吧，关于公牛切断该岛的传说非常适合当前的体系结构，用高级语言切断设备的工作）。 <br><br> 传入和传出消息的格式是带有JSON负载的HTTP服务器。 这是Scala（很难从套接字流中隔离二进制数据）和C（很难通过网络传输对象）之间的最佳折衷。 不需要进行许多可能的操作：付款，取消，退货，各种类型的报告，打开服务菜单和ping。 看起来没什么复杂的。 由于存在三种银行系统（并且预计以后会补充家庭资金），因此决定将项目分为以下几个部分： <br><br><img src="https://habrastorage.org/webt/rk/vm/sc/rkvmscw9ret9atfnts-nezxtaqg.png"><br><br> 绿色块是我们需要制作的，蓝色块是不能更改且银行提供的。 <br><br> 由于主要问题仅是来自Sberbank的软件引起的，因此本文作为一个整体将专门讨论陷阱，我们将其计入船上。 <br><br><h2> 第二章烤羊肉 </h2><br><img src="https://habrastorage.org/webt/zr/-d/ez/zr-dez83p56hekuceyiiqka2rdi.jpeg"><br>  （照片：heaclub.ru） <br><br>  ...看起来像这样。 这个原型的代码看起来是一样的，该代码是几个月前编写的，目的是使所有更高层次的人都清楚我们可以使用银行应用程序。 <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_KB * <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * null; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * grep; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _WIN32_WINNT char * ptr; null = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"nul"</span></span></span><span class="hljs-meta">; grep = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"findstr"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> null = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/dev/null"</span></span></span><span class="hljs-meta">; grep = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"grep"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> sprintf(buf, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s %"</span></span></span><span class="hljs-meta">PRIi32</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"= %sops.ini &gt;%s 2&gt;%s || "</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"echo %"</span></span></span><span class="hljs-meta">PRIi32</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=9,6,PINPAD_TEST &gt;&gt; %sops.ini"</span></span></span><span class="hljs-meta">, grep, TERM_ARCUS_TEST_PINPAD, TERM_PATH, null, null, TERM_ARCUS_TEST_PINPAD, TERM_PATH); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _WIN32_WINNT ptr = buf; while (*ptr) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (*ptr == </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'/'</span></span></span><span class="hljs-meta">) *ptr = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\\'</span></span></span><span class="hljs-meta">; ptr++; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br> 显然，这不适合生产版本，因此本质上有必要重新编写所有内容。 <br><br> 每个提供用于终端的库的银行通常提供两个连接选项：通过库函数（.so / .dll）或通过仅需传递两个值的现成实用程序-操作类型和金额（必要时）。 从理论上讲，没有什么复杂的，只是一些 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buffer[<span class="hljs-number"><span class="hljs-number">100</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%d %d"</span></span>, atoi(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]), atoi(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>])); system(buffer);</code> </pre> <br> 操作结果将被放置在文件“ e”中，而滑动检查将被存储在文件“ p”中。 只需将这些文件发送到stdout并转换为JSON，这样HTTP服务器就可以将它们作为有效负载发送出去，而无需考虑其中的内容。 <br><br> 但是，如果一切都这么简单，那么就不会发表这篇文章。 <br><br><h2> 第4章。越过山脉和越过山脉 </h2><br> 该实现的最初版本是一个简单的应用程序调用-HTTP服务器称为具有统一参数的必需包装器（例如，X-report为4），实用程序（例如gfj_pilot）使用该操作所需的参数启动了sb_pilot（例如，X-report为9）。 。 然后包装器实用程序从电子文件中读取操作结果（例如2000-“付款被拒绝，重复操作”）并将其转换为通用错误（例如3-“读取或处理卡/帐户时出错，重复操作”）。 之后，“ p”文件被转换为base64，以避免格式破坏，并将结果与​​结果一起以JSON的形式发送到stdout。 <br><br> 所有这一切都工作得很好，直到一个好时刻我们被告知... <br><br>  ...这在Windows下不起作用。 <br><br><img src="https://habrastorage.org/webt/yp/44/t_/yp44t_qwokissyt75mayl71mcdm.jpeg"><br><br> 好吧，更准确地说，Windows本身没有问题（除了转帐以Cp-1251编码生成，并且控制台可在CP866上运行）。 根本没有生成“ e”文件。 直接启动银行业务实用程序： <br><br><pre> <code class="plaintext hljs">C:\banks\sber\sb_pilot&gt;dir    C   .   : B401-6B9D   C:\banks\sber\sb_pilot 04.02.2019 12:28 &lt;DIR&gt; . 04.02.2019 12:28 &lt;DIR&gt; .. 31.01.2019 17:12 10 832 F12X24.BIN 31.01.2019 17:12 128 000 gate.dll 31.01.2019 17:12 72 192 loadparm.exe 31.01.2019 17:12 36 204 OPT0.R 31.01.2019 17:12 20 716 OPT1.R 31.01.2019 17:12 1 806 OPT3.R 31.01.2019 17:12 388 608 pilot_nt.dll 31.01.2019 23:06 463 pinpad.ini 31.01.2019 17:12 91 136 posScheduler.exe 31.01.2019 17:12 418 printers.ini 01.02.2019 16:51 91 646 sbkernel1902.log 31.01.2019 17:12 653 312 sbrf.dll 31.01.2019 17:12 840 192 SBRFCOM.dll 31.01.2019 17:12 3 142 656 sb_kernel.dll 01.02.2019 16:51 9 SESS.D 01.02.2019 16:51 715 SPLC.D 31.01.2019 17:12 72 192 upwin.exe 20  5 659 718  2  37 567 004 672   #    (1)  10  (1000 ) C:\banks\sber\sb_pilot&gt;loadparm.exe 1 1000 C:\banks\sber\sb_pilot&gt;dir    C   .   : B401-6B9D   C:\banks\sber\sb_pilot 04.02.2019 12:28 &lt;DIR&gt; . 04.02.2019 12:28 &lt;DIR&gt; .. 04.02.2019 12:28 216 commerr.log 31.01.2019 17:12 10 832 F12X24.BIN 31.01.2019 17:12 128 000 gate.dll 31.01.2019 17:12 72 192 loadparm.exe 31.01.2019 17:12 36 204 OPT0.R 31.01.2019 17:12 20 716 OPT1.R 31.01.2019 17:12 1 806 OPT3.R 01.02.2019 18:51 1 349 p 31.01.2019 17:12 388 608 pilot_nt.dll 31.01.2019 23:06 463 pinpad.ini 31.01.2019 17:12 91 136 posScheduler.exe 31.01.2019 17:12 418 printers.ini 04.02.2019 12:28 92 218 sbkernel1902.log 31.01.2019 17:12 653 312 sbrf.dll 31.01.2019 17:12 840 192 SBRFCOM.dll 31.01.2019 17:12 3 142 656 sb_kernel.dll 01.02.2019 16:51 9 SESS.D 01.02.2019 16:51 715 SPLC.D 31.01.2019 17:12 72 192 upwin.exe 19  5 659 029  2  37 567 008 768   C:\banks\sber\sb_pilot&gt;</code> </pre> <br> 确实，没有“ e”文件。 通往Sberbank＃1。 我们正在写信给Sberbank（随后我们收到了应该是的答复），并且由于没有时间进行通信并且有必要立即开始，因此我们正在寻找获得结果的解决方法。 <br><br><pre> <code class="plaintext hljs">04.02 12:28:55 SBKRNL: Failed to open device \\.\COM1, err 2 04.02 12:28:56 SBKRNL: Failed to open device \\.\COM1, err 2 04.02 12:28:56 SBKRNL: Result = 0 04.02 12:28:56 GATE: unlock:'00000054' 04.02 12:28:56 GATE: lock:'00000054' 'UPOSWINMUTEX2' 04.02 12:28:56 GATE: unlock:'00000054' 04.02 12:28:56 LOADPARM: Unloading GATE.DLL... 04.02 12:28:56 GATE: SB_KERNEL.DLL is unloaded 04.02 12:28:56 LOADPARM: GATE.DLL unloaded</code> </pre> <br> 是的，可以从日志sbkernel.log获得结果。 不方便的是，再也没有地图哈希值可以随后从Sberbank搞定“谢谢”。 不好 <br><br> 您将必须连接到pilot_nt.dll库并从中导入函数。 一切都会好起来的，但是……通向Sberbank＃2：在Linux下没有这样的库，您将不得不为不同的平台创建两个不同的应用程序-对于Linux，调用sb_pilot实用程序（类似于loadparm.exe，顺便说一句，在不同平台上为不同的实用程序名称命名为3） ），在Windows下连接到pilot_nt.dll库。 <br><br><h2> 第5章。黑暗中的谜语 </h2><br> 在19:00时。 <br><br>  Sberbank是一家大公司，大多数软件解决方案都是根据GOST和正式文件制作的。 我们进入Sberbank随图书馆提供的目录： <br><br><pre> <code class="plaintext hljs">Sberbank$ ls -l Docs  30160 drwx------ 2 alex alex 4096  17 19:31 FAQ -rw-rw-r-- 1 alex alex 3398465  9 2018   UPOS    ().docx -rw-rw-r-- 1 alex alex 1182078  9 2018   UPOS  .docx -rw-rw-r-- 1 alex alex 853504  9 2018   .doc drwx------ 3 alex alex 4096  31 17:11     -rw-rw-r-- 1 alex alex 5280787  9 2018    POS-.docx -rw-rw-r-- 1 alex alex 1149640  9 2018  .docx drwx------ 2 alex alex 4096  28 2018  UPOS drwx------ 2 alex alex 4096  28 2018    -rw-rw-r-- 1 alex alex 3451601  9 2018     ().docx -rw-rw-r-- 1 alex alex 1956196  9 2018   .docx -rw-rw-r-- 1 alex alex 1043161  9 2018       ()_().docx -rw-rw-r-- 1 alex alex 4348157  9 2018  POS-.docx -rw-rw-r-- 1 alex alex 3970267  9 2018   .docx drwx------ 3 alex alex 4096  28 2018   -rw-rw-r-- 1 alex alex 2644702  9 2018    POS-.docx drwx------ 2 alex alex 4096  28 2018   -rw-rw-r-- 1 alex alex 1558211  9 2018   .png</code> </pre> <br> 很好，但是我们只对开发人员感兴趣的目录： <br><br><pre> <code class="plaintext hljs">Sberbank$ ls -l Docs/\ \ \ /  8704 -rw-rw-r-- 1 alex alex 47105  9 2018 1C.docx -rw-rw-r-- 1 alex alex 1824  9 2018 cardtype.h -rw-rw-r-- 1 alex alex 2590378  9 2018 cr_ttk_protocol_ru.rtf -rw-rw-r-- 1 alex alex 208  9 2018 deprtmnt.h -rw-rw-r-- 1 alex alex 16681  9 2018 errors.h drwx------ 6 alex alex 4096  28 2018 examples -rw-rw-r-- 1 alex alex 58575  9 2018 gate.h -rw-rw-r-- 1 alex alex 4218  9 2018 paramsln.h -rw-rw-r-- 1 alex alex 61693  9 2018 pilot_nt.h -rw-rw-r-- 1 alex alex 28160  9 2018 ReadTrack2.doc -rw-rw-r-- 1 alex alex 7417  9 2018 sbkernel.h -rw-rw-r-- 1 alex alex 144896  9 2018 sb_pilot.doc -rw-rw-r-- 1 alex alex 3525323  9 2018     ole- sbrf.dll.rtf -rw-rw-r-- 1 alex alex 46683  9 2018      gate.dll.chi -rw-rw-r-- 1 alex alex 255414  9 2018      gate.dll.chm -rw-rw-r-- 1 alex alex 814653  9 2018      gate.dll.pdf -rw-rw-r-- 1 alex alex 41618  9 2018      pilot_nt.chi -rw-rw-r-- 1 alex alex 241716  9 2018      pilot_nt.chm -rw-rw-r-- 1 alex alex 968753  9 2018      pilot_nt.pdf -rw-rw-r-- 1 alex alex 81  9 2018  .txt</code> </pre> <br> 为了以防万一，大量废纸重新读取了pilot_nt，从中我们学到了以下内容： <br><blockquote> 表1.支持的sb_pilot操作系统。 <br><div class="scrollable-table"><table><tbody><tr><th> 操作系统 </th><th> 可容纳人数 </th><th> 模块名称 </th></tr><tr><td> 窗户 </td><td>  32 </td><td>  sb_pilot.exe </td></tr><tr><td> 的Linux </td><td>  32 </td><td>  sb_pilot </td></tr><tr><td> 多斯 </td><td>  16 </td><td>  sb_pilot.exe </td></tr></tbody></table></div></blockquote><br> 事实证明，用于Windows的实用程序仍应称为sb_pilot。 好吧，它是Sberbank＃4的石头，因为它本身的文档不一致。 <br><blockquote> 传输程序结果。 <br><br> 在程序结束时，形成了两个文本文件-交换文件和检查文件。 <br><br> 第一个命名为e，旨在将完美操作的参数传递给调用程序。 该文件的第一行包含操作结果的代码，以及解释文本消息的逗号分隔文本。 代码0表示成功付款，任何其他值-拒绝付款或无法付款。 </blockquote><br><br><img src="https://habrastorage.org/webt/c8/7f/m2/c87fm26nwcdjtfol6m0vamuvk8e.jpeg"><br><br> 懒洋洋地，我们又扔了一块石头，开始研究直接连接图书馆的文档。 <br><blockquote>  <b>调用库函数的过程</b> <br><br> 用信用卡支付（返还）购物时，现金程序必须通过填写TType和Amount字段并在其余字段中指定零值来从Sberbank库调用card_authorize（）函数。 在函数的最后，您需要分析RCode字段。 如果它包含值“ 0”或“ 00”，则认为授权已成功完成，否则被拒绝。 另外，您必须检查“检查”字段的值。 <br><br> 如果不是NULL，则必须将其发送以打印（在非财务模式下），然后 <br> 通过调用函数GlobalFree（）删除。 关闭班次时，现金程序必须通过填写TType = 7字段并在其余字段中指定零值来从Sberbank库中调用close_day（）函数。 在功能结束时，检查“检查”字段的值。 <br><br> 如果“检查”字段不为NULL，则必须将其发送以打印（在非财务模式下），然后通过调用GlobaFree（）函数将其删除。 </blockquote> 听起来很容易，即使提供了头文件也是如此。 好吧，将其插入，编译并... <br><br><pre> <code class="cpp hljs">$ cat main.c &amp;&amp; i686-w64-mingw32-gcc main.c -o main.a <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pilot_nt.h"</span></span></span><span class="hljs-meta"> int main(void) { return 0; } In file included from main.c:1:0: pilot_nt.h:525:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:544:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:567:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:590:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:627:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:668:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span></span></code> </pre> <br> 嗯...什么？ 打开pilot_nt.h： <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta">{ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;...&gt; /** *    * ,         . */ struct auth_answer{ int TType; /**&lt; [in]  .  ::OpetationTypes */ unsigned long Amount; /**&lt; [in]    */ char RCode[3]; /**&lt; [out]    */ char AMessage[16]; /**&lt; [out]    */ int CType; /**&lt; [in,out]   */ char* Check; /**&lt; [out]  ,   GlobalFree    */ }; &lt;...&gt; struct auth_answer7{ auth_answer auth_answ; /**&lt; [in, out]   . . ::auth_answer */ &lt;---- THIS char AuthCode[MAX_AUTHCODE]; /**&lt; [out]  . 7 . */ char CardID [CARD_ID_LEN]; /**&lt; [out]  . 25 . */ int SberOwnCard; /**&lt; [out]     */ };</span></span></span></span></code> </pre> <br> 马上，不用寻找在CP1251编码中的俄语注释。 <br><br> 好吧，最严肃的事情是：亲爱的C ++开发人员。 如果编写extern“ C”，则意味着该块内部的代码必须由C编译器编译。 如果尚未对结构进行“ typedef”定义，则每次将其作为类型引用提及时，都必须编写关键字“ struct”。 <br><br> 为开发人员修补文件，在需要的地方用单词“ struct”代替。 链接到`pilot_nt.dll`库。 胜利不？ 我们启动我们的应用程序。 <br><br><h2> 第6章：从火到火焰 </h2><br> 好吧，你明白了吧？ 该应用程序崩溃了。 直到主要。 思考，为Windows添加errno函数的NIH模拟：GetLastError（针对Microsoft的第3号石头，前两个用于编码）。 <br><br><pre> <code class="plaintext hljs">C:\banks\sber\WIN&gt;sb_pilot.exe 1 1000 E: !g_sblibrary (0xc0000096)</code> </pre> <br>  0xc0000096？  GetLastError不应该返回足够的错误代码吗？ <br><blockquote> 有关操作系统提供的错误代码的完整列表，请参阅系统错误代码。 </blockquote> 是的，在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>打开文章： <br><blockquote> 以下主题提供系统错误代码的列表。 这些值在WinError.h头文件中定义。 <br><br><ul><li> 系统错误代码（0-499）（0x0-0x1f3） </li><li> 系统错误代码（500-999）（0x1f4-0x3e7） </li><li> 系统错误代码（1000-1299）（0x3e8-0x513） </li><li> 系统错误代码（1300-1699）（0x514-0x6a3） </li><li> 系统错误代码（1700-3999）（0x6a4-0xf9f） </li><li> 系统错误代码（4000-5999）（0xfa0-0x176f） </li><li> 系统错误代码（6000-8199）（0x1770-0x2007） </li><li> 系统错误代码（8200-8999）（0x2008-0x2327） </li><li> 系统错误代码（9000-11999）（0x2328-0x2edf） </li><li> 系统错误代码（12000-15999）（0x2ee0-0x3e7f） </li></ul></blockquote> 好的，我们出现了一个未记录的错误，我们扔了石头，打开了全知的Google： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">forum.vingrad.ru/forum/topic-346194/kw-dll-loadlibrary-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">bbs.csdn.net/topics/80078275</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">forums.codeguru.com/showthread.php?179566-0xC0000096-Privileged-Instruction</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.unknowncheats.me/forum/general-programming-and-reversing/97763-privileged-instruction-error.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">cboard.cprogramming.com/windows-programming/146130-prallel-port-programming.html</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">computer-programming-forum.com/82-mfc/dc2481c0ecead2f2.htm</a> </li></ul><br> 错误的本质在于某些子例程使用了指令之一 <br><br><ul><li>  _inp（） </li><li>  _inpw（） </li><li>  _inpd（） </li><li>  _outp（） </li><li>  _outpw（） </li><li>  _outpd（） </li></ul><br>  NT内核尝试直接使用并行端口，因此在NT内核下禁止使用该功能。 显然，此代码在库初始化程序中被调用，即 启动时，库需要轮询设备端口，但是NT内核需要通过驱动程序来工作。 <br><br> 绝望的情况？ <br><br><h2> 第8章蜘蛛和苍蝇 </h2><br> 晚上10点 为了以防万一，产生了验证这不是由于我们使用mingw与Linux交叉编译的事实。 同时，我们了解到Sberbank仅提供32位应用程序，因此它不能与64位应用程序一起使用，好的，但是无论如何，我们将在2019年向Sberbank推出仅32位版本的解决方案。 <br><br>  <b>给定</b> ：安装在virtualbox Windows 7中； <br>  <b>必需</b> ：安装Visual Studio并复制MVP。 <br><br> 我们转到Microsoft网站，下载了Visual Studio 2017.我们获取社区许可证，因为我们将其用于验证，因此对于企业来说，许可证将在起飞时购买。 <br> 下载几百兆字节并... <br><br> 我们看到不支持我们的操作系统版本（Windows 7）。 <br><br> 好的，我们转到各种淫秽网站，我们正在寻找Visual Studio 2008，再次下载数百兆字节，然后... <br><br> 我们得到了iso文件。 <br><br> 好的，让我们尝试安装Daemon Tools 10（因为这是该站点提供的版本）以插入该虚拟磁盘。 <br><br> 运行下载的二进制文件。  Misfire，需要.NET Framework 4.5，下载，安装。 <br> 我们开始下载二进制文件，安装已经开始，引导程序说它需要4.5.2，下载，安装。 <br> 我们启动下载的Binar，安装已经开始，引导加载程序说在安装安全更新KB3033929之前，它不会在任何地方进行安装，下载，安装。 <br><br> 作为消息，我们得到了微软的耳光： <br><br><img src="https://habrastorage.org/webt/r6/qe/de/r6qedenl5w3dez4ysscvod8rmjw.png"><br><br> 我们猛烈地向Microsoft投掷了尖锐的石头，从torrent下载旧的Daemon Tools，成功解压缩Visual Studio，安装，最后（00:00）编译MVP，我们得到了同样的错误。 嗯，有一个很好的版本，但是没有一起发展。 <br><br><h2> 第十一章 </h2><br> 我们正在写给第二位程序员，他目前正在紧急完成服务器和注册过程。 他回忆起有一个git <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">仓库</a>可以连接到NT上的这个库并使用它。 <br><br> 怀疑地查看存储库，下载它，编译并运行它。 可以用 <br><br><img src="https://habrastorage.org/webt/mt/gl/q-/mtglq-c68eyegv74wjnzjvpmddi.png"><br><br> 我们更怀疑地看代码。 该代码是相同的，除了它是用C ++而不是C编写的。 <br> 我们知道语言与它无关。 我们看一下代码提取的Sberbank库。 <br> 我们看到最后一次提交。 <br><br> 在这里，我们正在等待另一个惊喜。 <br><br> 事实证明，Sberbank库的版本可能不同。 最后一次提交将版本从23增加到27。 将版本从Gita复制到您的测试计算机-工作！ <br><br> 我们检查了Sberbank发送的所有档案，比较版本并构建了平板电脑： <br><div class="scrollable-table"><table><tbody><tr><th> 版本号 </th><th> 作品 </th></tr><tr><td>  26.0.15-基本 </td><td> 没有啦 </td></tr><tr><td>  27.4.12-从存储库 </td><td> 是的 </td></tr><tr><td>  23.0.13-从存储库 </td><td> 是的 </td></tr><tr><td>  29.0.9-星期六的最新消息 </td><td> 是的 </td></tr><tr><td>  23.0.13-带有用于Cryptor系统的补丁 </td><td> 是的 </td></tr></tbody></table></div><br> 太好了，现在让我们al愈。 在那些花费26的系统上，升级到29或27，一切都会起飞。 <br> 我们向Sberbank投掷石块9，以破坏NT系统上的行为。 <br><br><h2> 第十二章里面等待着他们的是什么 </h2><br> 电子文件不足？ 没关系，我们采用补丁标题，动态链接到库以正确返回错误，编写将函数的返回代码简单地写入“ e”文件的代码，我们将biner sb_pilot.exe称为... <br><br> 要工作，就行。 <br><br> 那只是“ Cryptor”系统的版本，不会创建“ p”文件。 <br><br>  <i>我们可悲地看着滴落在指关节上的血和墙上的凹痕。</i> <br><br> 首先，什么是Cryptor系统。 <br><br>  Cryptera是一家丹麦公司，生产加密设备/安全设备/密钥等。我想你们都看到了他们产品的副本之一： <br><br><img src="https://habrastorage.org/webt/pb/dz/85/pbdz85atzxiscdkdkq0z97ahhsm.png"><br><br> 因此，Sberbank将其加密模块用于密码键盘，并发布了一个特殊的“补丁”库，如我们已经了解的那样，其中未创建“ p”文件。 我们为此写信给Sberbank，几天后我们就会得到答案，“在原始系统下，将创建文件p”，但在加密后的Cryptor下将不会创建。” 几天之内，我们将给他们10号石，因为您现在需要工作。 <br><br> 幸运的是，我们用来进行操作的功能返回了已经提到的结构： <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_answer</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  .  ::OpetationTypes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Amount; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RCode[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AMessage[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Check; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  ,   GlobalFree    */</span></span> };</code> </pre> <br> 哦，很好，支票已经存在，我们可以将其保存到文件中或立即将其打印为JSON ... <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, answer.Check);</code> </pre> <br> 而且由于访问无效的指针，我们使应用程序崩溃。 <br><br><h2> 第十四章：水与火 </h2><br> 凌晨4点 我们执行Seth Bandha Sarvangasana进行镇定，并仔细阅读该手册： <br><blockquote> 支票的[out]图像，应由GlobalFree在调用程序中释放 </blockquote> 这给了我们什么？ 很多 首先，由于需要使用GlobalFree清理指针，因此使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GlobalAlloc</a>对其进行了分配。 因此，它不会像在16位版本中那样发出指向内存的指针，而是发出具有语义声明的类型HGLOBAL的对象号，可以将其提供给GlobalSize函数以获取分配的块的大小，而GlobalLock可以将其馈入以阻塞一块内存，但是可以获取原始指针。 顺便说一下，NIH malloc和free排在Microsoft的第6个标准库中。 <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, GlobalLock(answer.Check));</code> </pre> <br> 并且仍然下降。 好的，GlobalSize显示什么？ 零吗 不知何故。 <br><br> 我们检查其他应该也要注意的功能-我们看到的是同一张图片。 <br><br> 我想到，我可以根据最酷的支付功能提供的数据自行生成发票（是的，Sberbank拥有名为card_authorize2..14的功能，对此我不会一掷千金）： <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_answer14</span></span></span><span class="hljs-class"> {</span></span> auth_answer ans; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in, out]   . . ::auth_answer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AuthCode[MAX_AUTHCODE]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . 7 . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardID[CARD_ID_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . 25 .     ,   6   4,    '*'.*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ErrorCode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> TransDate[TRANSDATE_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TransNumber; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    . , .    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SberOwnCard; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Hash[CARD_HASH_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in, out]  SHA1   ,   ASCII     . 40 .*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Track3[CARD_TRACK3_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]   */</span></span> DWORD RequestID; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   .  PCI DSS .*/</span></span> DWORD Department; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     0  14-, .      0xFFFFFFFF,          .        ,      4191. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RRN[MAX_REFNUM]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   ,  .    ,     .   12-  .       (   pilot_nt.dll),     –  (     ;     ,   ).*/</span></span> DWORD CurrencyCode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    (810, 643, 840, 978  ..) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardEntryMode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    ('D'-., 'M'- , 'C'-, 'E'- EMV, 'R'- magstripe, 'F'-fallback)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardName[MAX_CARD_NAME_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AID[MAX_AID_ASCII_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out] Application ID   (   ASCIIZ-)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> FullErrorText[MAX_FULL_ERROR_TEXT]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> DWORD GoodsPrice; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    ,  (34.99-&gt;3499)*/</span></span> DWORD GoodsVolume; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  ,  .  (30.234-&gt;30234)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> GoodsCode[MAX_GOODS_CODE+<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     .*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> GoodsName[MAX_GOODS_NAME]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     . !   auth_answer14         gate.dll TGoodsData.     */</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/** @brief     * @param[in] track2      .  NULL,     . * @param[in,out] auth_answer . ::auth_answer14 * @param[in,out] payinfo     * @return int  . */</span></span> <span class="hljs-function"><span class="hljs-function">PILOT_NT_API </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">card_authorize14</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *track2, struct auth_answer14 *auth_answer, struct payment_info_item *payinfo )</span></span></span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们正在尝试选择字段。我们发现只有一件事使我们与幸福分开了-持卡人的姓氏和名字。</font><font style="vertical-align: inherit;">没有它们，单据不</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">详细信息：用于使用支付卡进行交易的ATM，电子终端或其他技术手段的标识符；</font><font style="vertical-align: inherit;">操作类型；</font><font style="vertical-align: inherit;">交易日期；</font><font style="vertical-align: inherit;">交易金额；</font><font style="vertical-align: inherit;">交易货币；</font><font style="vertical-align: inherit;">佣金金额授权码；</font><font style="vertical-align: inherit;">付款卡详细信息。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遗憾的是，但是要对我们拥有的数据形成法律效力，将无法正常工作。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们再次研究文档。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们在“示例”目录中找到Sberbank提供的示例</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Authorization completion finished with code '"</span></span> &lt;&lt; result &lt;&lt; <span class="hljs-string"><span class="hljs-string">"'"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">ofstream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CHEQUE_FILENAME)</span></span></span></span>; file &lt;&lt; argument.auth_answ.Check; file.close(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argument.auth_answ.Check) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Cheque saved to file "</span></span> &lt;&lt; CHEQUE_FILENAME &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-comment"><span class="hljs-comment">//GlobaFree(argument.auth_answ.Check); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它仅显示指针上的文本。</font><font style="vertical-align: inherit;">但是我们已经看到它不能那样工作……以防万一，我们将编译他们的示例并运行它。</font><font style="vertical-align: inherit;">离开行“ file &lt;&lt; arguments.auth_answ.Check;”，好吧，Sberbank，将第11号石作为无效示例。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">早上7点 </font><font style="vertical-align: inherit;">您已经可以写信给几年前用Delphi编写的另一个包装器的开发人员。</font><font style="vertical-align: inherit;">我们得到的答案是一切对他们都有效。</font><font style="vertical-align: inherit;">我们正在寻找其包装的基础，并在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到</font><font style="vertical-align: inherit;">：</font></font><br><br><pre> <code class="cpp hljs">TAuthAnswer = packed record TType: integer; Amount: UINT; <span class="hljs-comment"><span class="hljs-comment">// IN     Rcode: array [0 .. 2] of AnsiChar; AMessage: array [0 .. 15] of AnsiChar; CType: integer; Check: PAnsiChar; end; Result := Func(nil, @FAuthAnswer); FLastError := Result; FCheque := PAnsiChar(FAuthAnswer.Check);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">简单类型的指针转​​换，无需任何函数调用。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们开始怀疑恶魔。</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第十七章雷暴爆发 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">人们开始回到办公室，同情地点头。</font><font style="vertical-align: inherit;">PO不太高兴知道最新消息。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里，我记得一个细节。</font><font style="vertical-align: inherit;">当我们显示结构＃14的字段以查看其值时，每行一个字节被切除。</font><font style="vertical-align: inherit;">一方面，另一方面</font></font><br><blockquote> 注意！<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在auth_answer14结构中，产品名称比gate.dll TGoodsData中的字符短一个字符。</font><font style="vertical-align: inherit;">修正此错误为标准</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">也许它仍然与……有关。一个</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可怕的猜测像闪电一样在大脑中冒出。</font><font style="vertical-align: inherit;">将结构声明为</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packed</span></span></span><span class="hljs-class">)) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  .  ::OpetationTypes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Amount; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RCode[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AMessage[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Check; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  ,   GlobalFree    */</span></span> };</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">而且... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">什么都没有改变。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">静止大小= 0，静止锁定= NULL。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">痛</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">衰变</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您不由自主地用眼睛在天花板上寻找舒适的横梁，以使其可以承受重量。经过无数小时的编码和研究文档，细长的字节行浮现在我们的眼前。但是，如果我们打印通常返回的字节怎么办？</font></font><br><br><pre> <code class="cpp hljs"> u32 i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(answ); i++) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%02x "</span></span>, *((u8 *)&amp;answ + i)); } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); C:\banks\sber\sb_pilot&gt;sb_pilot.exe <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> e8 <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ce e4 ee e1 f0 e5 ed ee <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> f8 <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">7</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ 30 00 00 ce”-表示Sberbank仍使用打包结构。</font><font style="vertical-align: inherit;">但是标题中对此一无所知。</font><font style="vertical-align: inherit;">因此，这些示例不起作用，因此，不可能在末尾获得指向文本的指针-因为该文本由于移位1个字节而损坏。</font><font style="vertical-align: inherit;">通往Sberbank的巨大而多刺的石头！</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后一个maaaalenky的细微差别引起了我的注意。</font><font style="vertical-align: inherit;">4 + 4 + 3 + 16 + 4 + 4 =35。这是36个字节，Obelix。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果有36个字节，则编译器仍在对齐结构。</font><font style="vertical-align: inherit;">因此，在RCode和AMessage之间仍然插入了一个额外的字节。</font><font style="vertical-align: inherit;">但是为什么呢？</font><font style="vertical-align: inherit;">毕竟，我们指出了“ __packed__”！</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第十八章返程 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仍然保持对齐的原因出现在2012年：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">//gcc.gnu.org/bugzilla/show_bug.cgi?id=52991</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一个错误仅在GCC 8中被修复（一块石头可以塞满6年的马车！），尚无法更新。</font><font style="vertical-align: inherit;">幸运的是，有一种解决方法：</font></font><br><br><pre> <code class="cpp hljs">-mno-ms-bitfields</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在我们不讨论这个标志的机制，只是把它交给编译器：</font></font><br><br><img src="https://habrastorage.org/webt/ve/tr/d4/vetrd4m4rsdhmkyxkgrvxbkepko.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">滑！</font><font style="vertical-align: inherit;">亲爱的！</font><font style="vertical-align: inherit;">我想念你，我甚至都不敢发誓，因为我已经扔石头了。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后，我们给了微软一个石头，因为GlobalSize / Lock给无效指针赋予零。</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第十九章最后一章 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了最小化sb_pilot层的ifdefs数量，我们编写了一个单独的应用程序，该应用程序完全模仿sb_pilot的Linux版本。</font><font style="vertical-align: inherit;">因此，使第1层代码相同，仅保留一个条件：</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(BXI_OS_GLX) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GFJ_PILOT_EXECUTABLE </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"./sb_pilot"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> defined(BXI_OS_WIN) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GFJ_PILOT_EXECUTABLE </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"./sb_pilot.exe"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><img src="https://habrastorage.org/webt/wo/eu/2g/woeu2gk8m1mvtibiepfxwiijrbo.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 战斗结果： </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sberbank：12石头 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 微软：7石 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GCC：1石头 </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 在我们的命令板上记录成就： </font></font><br><br><img src="https://habrastorage.org/webt/ko/im/3y/koim3ykfftmlltegcqh_rkdkgxc.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN451188/">https://habr.com/ru/post/zh-CN451188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN451178/index.html">乘员龙降落伞着陆测试</a></li>
<li><a href="../zh-CN451180/index.html">PCB替代了两个直线电机</a></li>
<li><a href="../zh-CN451182/index.html">C数组的大小如何成为库二进制接口的一部分</a></li>
<li><a href="../zh-CN451184/index.html">蓝色起源蓝色月亮计划：2024年之前的月球人</a></li>
<li><a href="../zh-CN451186/index.html">LINSTOR存储库及其与OpenNebula的集成</a></li>
<li><a href="../zh-CN451196/index.html">客户和自由职业者资料的分离</a></li>
<li><a href="../zh-CN451198/index.html">增强现实和虚拟现实在NBA中的作用</a></li>
<li><a href="../zh-CN451200/index.html">让我们通过使用DNS-01挑战和AWS进行加密自动获取SSL证书</a></li>
<li><a href="../zh-CN451204/index.html">免费文本编辑器进行协作</a></li>
<li><a href="../zh-CN451206/index.html">RDF存储库现在发生了什么？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>