<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤üèæ üî† üå≤ Mapeamento de ru√≠do com KSQL, Raspberry Pi e r√°dio üç© üë∞üèø üèä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√Ä primeira vista, esta hist√≥ria tem tudo para ganhar o status de um jejum rom√¢ntico na v√©spera de 8 de mar√ßo: avi√µes, amor, um pouco de espionagem e, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mapeamento de ru√≠do com KSQL, Raspberry Pi e r√°dio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/442876/"><img src="https://habrastorage.org/webt/8h/e_/jp/8he_jpuc-mgf_sarxdvkm3n6xsg.png"><br><br>  √Ä primeira vista, esta hist√≥ria tem tudo para ganhar o status de um jejum rom√¢ntico na v√©spera de 8 de mar√ßo: avi√µes, amor, um pouco de espionagem e, finalmente, um gato (mais precisamente, um gato).  √â dif√≠cil imaginar que tudo isso esteja diretamente relacionado ao Kafka, KSQL e ao experimento "como encontrar as aeronaves mais barulhentas usando a tecnologia da informa√ß√£o dom√©stica".  √â dif√≠cil, mas √© necess√°rio: foi um experimento que Simon Obury conduziu e traduzimos um artigo de sua autoria descrevendo todos os detalhes do processo. <br><a name="habracut"></a><br>  Nosso novo gato chamado Snowflake acorda cedo.  Os sons de avi√µes voando sobre a nossa casa a despertam.  Mas e se, usando Apache Kafka, KSQL e Raspberry Pi, eu pudesse determinar qual avi√£o mant√©m meu gato acordado?  Seria bom criar um divertido painel de rastreamento, no qual o gato pudesse desviar sua aten√ß√£o - e me dar um pouco mais de sono. <br><br><h3>  Em termos gerais </h3> <br><img src="https://habrastorage.org/webt/f8/df/kg/f8dfkgmmkghrnfhtjecrthwx8j8.png"><br>  <i>Transferimos avi√µes do c√©u para gr√°ficos usando Kafka e KSQL</i> <br><br>  A aeronave determina sua localiza√ß√£o usando receptores GPS.  O transmissor de bordo relata periodicamente a localiza√ß√£o, n√∫mero de identifica√ß√£o, altitude e velocidade do navio usando transmiss√µes de r√°dio curtas.  Essas transmiss√µes de vigil√¢ncia dependente autom√°tica de transmiss√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AZN-V</a> ) s√£o essencialmente pacotes de dados abertos para acesso a partir de esta√ß√µes terrestres. <br><br>  Um microcomputador, como o Raspberry Pi, e v√°rios componentes auxiliares s√£o tudo o que √© necess√°rio para receber mensagens dos transmissores a√©reos da aeronave correndo pela minha casa. <br><br>  Os sinais a√©reos da aeronave parecem uma bola de mensagens emaranhada e requerem sistematiza√ß√£o.  Reconhecer esses fluxos de dados ca√≥ticos √© como ouvir uma conversa em uma festa barulhenta.  Portanto, para encontrar um avi√£o que preocupa meu gato, decidi usar uma combina√ß√£o de Kafka e KSQL. <br><br><img src="https://habrastorage.org/webt/om/2c/o0/om2co03tws9dxaml4hsmwrgqzsg.png"><br>  <i>Gato despertado e Raspberry Pi</i> <br><br><h3>  Cole√ß√£o de leituras de AZN-B com o Raspberry Pi </h3><br>  Para coletar transmiss√µes a bordo, usei o Raspberry Pi e o RTL2832U, um modem USB que foi originalmente vendido como um dispositivo para assistir TV digital em um computador.  No Raspberry Pi, instalei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dump1090</a> - um programa que recebe dados do AZN-V via RTL2832U usando uma pequena antena. <br><br><img src="https://habrastorage.org/webt/_u/dx/rd/_udxrdhg_e8cvqomnkbfkiuvvgm.png"><br>  <i>Meu r√°dio de software do Raspberry Pi e RTL2832U</i> <br><br><h3>  Converta sinais AZN-B em temas Kafka </h3><br>  Agora que recebi um fluxo de sinais AZN-B brutos, devemos prestar aten√ß√£o ao tr√°fego.  O Raspberry Pi n√£o tem energia suficiente para computa√ß√£o s√©ria; portanto, tive que transferir o processamento de dados para meu cluster local no Kafka. <br><br><img src="https://habrastorage.org/webt/ar/27/xb/ar27xbolmidgiscrmspvto0vgnk.png"><br><br>  As mensagens recebidas s√£o divididas em <i>mensagens de</i> <i>localiza√ß√£o</i> ou <i>sobre a identifica√ß√£o do quadro</i> .  O local parece uma mensagem do formul√°rio: <i>"o painel 7c6db8 voa a uma altitude de 6.250 p√©s na coordenada -33,8,151.0"</i> .  As informa√ß√µes sobre a identifica√ß√£o do painel ser√£o parecidas com: <i>"o painel 7c451c voa ao longo da rota QJE1726"</i> . <br><br>  Um pequeno <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">script Python</a> para o meu Raspberry Pi compartilha todas as mensagens AZN-B recebidas.  Usei o proxy Confluent Rest Proxy para distribuir dados do Raspberry Pi para os <b>t√≥picos de localiza√ß√£o</b> e de <b>identifica√ß√£o de t√≥picos</b> no Kafka.  O servidor proxy fornece uma interface RESTful para o cluster Kafka, o que facilita a cria√ß√£o de mensagens usando uma simples chamada REST no Pi. <br><br><img src="https://habrastorage.org/webt/6d/ox/35/6dox35w1d-qrzyaiowi80kxtglk.png"><br><br>  Eu queria entender quais avi√µes voam sobre meu teto e quais rotas.  O banco de dados do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OpenFlights</a> permite comparar o c√≥digo do aeroporto, por exemplo, 7C6DB8 atribu√≠do pela Organiza√ß√£o Internacional de Avia√ß√£o Civil (ICAO), com o tipo de aeronave - no nosso caso, o Boeing 737.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Enviei</a> meus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dados de</a> mapeamento para o tema <b>icao-para-aeronave</b> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O KSQL</a> fornece um "mecanismo SQL" que permite processar dados em tempo real nos t√≥picos do Apache Kafka.  Por exemplo, para encontrar o c√≥digo de bordo 7C6DB8, podemos escrever a seguinte consulta: <br><br><pre><code class="plaintext hljs">CREATE TABLE icao_to_aircraft WITH (KAFKA_TOPIC='ICAO_TO_AIRCRAFT_REKEY', VALUE_FORMAT='AVRO', KEY='ICAO'); ksql&gt; SELECT manufacturer, aircraft, registration \ FROM icao_to_aircraft \ WHERE icao = '7C6DB8'; Boeing | B738 | VH-VYI</code> </pre> <br>  Da mesma forma, no t√≥pico <b>detalhes</b> do indicativo, enviei os indicativos (por exemplo, QFA563, este √© o voo da Qantas de Brisbane para Sydney). <br><br><pre> <code class="plaintext hljs">CREATE TABLE callsign_details WITH (KAFKA_TOPIC='CALLSIGN_DETAILS_REKEY', VALUE_FORMAT='AVRO', KEY='CALLSIGN'); ksql&gt; SELECT operatorname, fromairport, toairport \ FROM callsign_details \ WHERE callsign = 'QFA563'; Qantas | Brisbane | Sydney</code> </pre> <br>  Agora, vamos dar uma olhada no fluxo de dados do <b>t√≥pico</b> do <b>local</b> .  Aqui podemos observar um fluxo constante de mensagens recebidas sobre a localiza√ß√£o de um avi√£o voando. <br><br><pre> <code class="plaintext hljs">kafka-avro-console-consumer --bootstrap-server localhost:9092 --property --topic location-topic {"ico":"7C6DB8","height":"6250","location":"-33.807724,151.091495"}</code> </pre> <br>  A consulta KSQL ficar√° assim: <br><pre> <code class="plaintext hljs">ksql&gt; SELECT TIMESTAMPTOSTRING(rowtime, 'yyyy-MM-dd HH:mm:ss'), \ ico, height, location \ FROM location_stream \ WHERE ico = '7C6DB8'; 2018-09-19 07:13:33 | 7C6DB8 | 6250.0 | -33.807724,151.091495</code> </pre> <br><h3>  KSQL: harmoniza√ß√£o de fluxo ... </h3><br>  O valor real do KSQL reside na capacidade de combinar fluxos de entrada de dados de localiza√ß√£o com os dados de origem dos t√≥picos (consulte <a href="">03_ksql.sql</a> ) - isto √©, ao adicionar informa√ß√µes √∫teis ao fluxo de dados brutos.  Isso √© muito semelhante a uma "jun√ß√£o esquerda" em um banco de dados tradicional.  O resultado √© outro tema Kafka criado sem uma √∫nica linha de c√≥digo Java! <br><br>  origem&gt; CREATE STREAM location_and_details_stream AS \ <br>  SELECIONAR l.ico, l.height, l.location, t.aircraft \ <br>  FROM location_stream l \ <br>  JUNTA ESQUERDA icao_para_aircraft t ON l.ico = t.icao; <br>  Al√©m disso, voc√™ recebe uma consulta KSQL.  O fluxo de dados ter√° a seguinte apar√™ncia: <br><br><pre> <code class="plaintext hljs">ksql&gt; SELECT TIMESTAMPTOSTRING(rowtime, 'yy-MM-dd HH:mm:ss') \ , manufacturer \ , aircraft \ , registration \ , height \ , location \ FROM location_and_details_stream; 18-09-27 09:53:28 | Boeing | B738 | VH-YIA | 7225 | -33.821,151.052 18-09-27 09:53:31 | Boeing | B738 | VH-YIA | 7375 | -33.819,151.049 18-09-27 09:53:32 | Boeing | B738 | VH-YIA | 7425 | -33.818,151.048</code> </pre> <br>  Al√©m disso, podemos combinar o fluxo de entrada do <b>indicativo</b> com o tema fixo <b>callsign_details</b> : <br><br><pre> <code class="plaintext hljs">CREATE STREAM ident_callsign_stream AS \ SELECT i.ico \ , c.operatorname \ , c.callsign \ , c.fromairport \ , c.toairport \ FROM ident_stream i \ LEFT JOIN callsign_details c ON i.indentification = c.callsign; ksql&gt; SELECT TIMESTAMPTOSTRING(rowtime, 'yy-MM-dd HH:mm:ss') \ , operatorname \ , callsign \ , fromairport \ , toairport \ FROM ident_callsign_stream ; 18-09-27 13:33:19 | Qantas | QFA926 | Sydney | Cairns 18-09-27 13:44:11 | China Eastern | CES777 | Kunming | Sydney 18-09-27 14:00:54 | Air New Zealand | ANZ110 | Sydney | Auckland</code> </pre> <br>  Agora, temos dois t√≥picos informativos: <br><br><ol><li>  <b>location_and_details_stream</b> , que fornece um fluxo de informa√ß√µes atualizadas sobre a localiza√ß√£o e a velocidade da aeronave; </li><li>  <b>ident_callsign_stream</b> , que descreve os detalhes do voo, incluindo a companhia a√©rea e o destino. </li></ol><br>  Com esses temas constantemente atualizados, podemos criar √≥timos pain√©is de vis√£o geral.  Usei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kafka Connect</a> para fazer upload de temas Kafka preenchidos pelo KSQL no Elasticsearch (scripts completos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ). <br><br><h3>  Kibana Dashboard </h3><br>  Aqui est√° um exemplo de um painel de vis√£o geral mostrando a localiza√ß√£o de um avi√£o em um mapa.  Al√©m disso, voc√™ pode ver um gr√°fico por companhia a√©rea, um gr√°fico da altitude do voo e nuvens de palavras por destino principal.  Um mapa de calor mostra √°reas onde as aeronaves est√£o concentradas, ou seja, √°reas com os mais altos n√≠veis de ru√≠do. <br><br><img src="https://habrastorage.org/webt/mh/fz/sy/mhfzsyskws6uoe5s1-b6m9sudzc.gif"><br><br><h3>  De volta ao gato </h3><br>  Hoje o gato me acordou por volta das 6 da manh√£.  O KSQL pode me ajudar a encontrar o avi√£o que sobrevoou minha casa a uma altitude inferior a 3.500 p√©s? <br><br><pre> <code class="plaintext hljs">select timestamptostring(rowtime, 'yyyy-MM-dd HH:mm:ss') , manufacturer , aircraft , registration , height from location_and_details_stream where height &lt; 3500 and rowtime &gt; stringtotimestamp('18-09-27 06:10', 'yy-MM-dd HH:mm') and rowtime &lt; stringtotimestamp('18-09-27 06:20', 'yy-MM-dd HH:mm'); 2018-09-27 06:15:39 | Airbus | A388 | A6-EOD | 2100.0 2018-09-27 06:15:58 | Airbus | A388 | A6-EOD | 3050.0</code> </pre> <br>  Awesome!  Posso avistar um avi√£o por cima do meu telhado √†s 6:15 da manh√£.  Acontece que Snowflake foi acordado pelo Airbus A380 (um grande navio, a prop√≥sito), que voou para Dubai. <br><br>  Apenas alguns dias de folga e voc√™ tem um sistema de processamento de streaming com o KSQL.  Al√©m disso, permite encontrar rapidamente eventos de dados interessantes.  Embora Snowflake possa ser c√©tico em rela√ß√£o a eles. <br><br><img src="https://habrastorage.org/webt/vs/vf/yp/vsvfypatv-grib-_dstwrco_r2y.png"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt442876/">https://habr.com/ru/post/pt442876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt442864/index.html">Quantos anos tem seu senhor?</a></li>
<li><a href="../pt442866/index.html">IA treinada a partir de d√©cadas de experimenta√ß√£o culin√°ria cria novos pratos</a></li>
<li><a href="../pt442868/index.html">Uma breve excurs√£o aos sistemas de refrigera√ß√£o do data center. Pr√≥s e contras</a></li>
<li><a href="../pt442870/index.html">O melhor do mundo da Angular da semana - Digest No. 2 (26 de janeiro a 7 de mar√ßo)</a></li>
<li><a href="../pt442872/index.html">Como encontrei o ovo da p√°scoa na prote√ß√£o do Android e n√£o consegui um emprego no Google</a></li>
<li><a href="../pt442880/index.html">Pontos de verifica√ß√£o virtuais: lista de verifica√ß√£o de configura√ß√£o</a></li>
<li><a href="../pt442882/index.html">[V√≠deo] "Piems n√£o s√£o necess√°rios" e mais tr√™s id√©ias de gerenciamento de projetos</a></li>
<li><a href="../pt442884/index.html">A tecnologia j√° permite que voc√™ converse com o carro como pessoa</a></li>
<li><a href="../pt442886/index.html">Sketch + Node.js: gere √≠cones para muitas plataformas e marcas. Parte 2</a></li>
<li><a href="../pt442888/index.html">Personalizar select em css puro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>