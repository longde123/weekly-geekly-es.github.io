<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💛 🧘🏽 🚙 "Smart Home" auf Arduino zur Abwechslung 🛶 🌬️ 🍤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nichts Außergewöhnliches, nur ein weiterer Arduino-Controller. Mit Sensoren, Rollen und einer Webseite. Aber mit seinen eigenen Eigenschaften und sein...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"Smart Home" auf Arduino zur Abwechslung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411141/"><img src="https://habrastorage.org/webt/7o/3k/or/7o3kora9koagtgemf_xxr71mlkk.jpeg"><br><br>  Nichts Außergewöhnliches, nur ein weiterer Arduino-Controller.  Mit Sensoren, Rollen und einer Webseite.  Aber mit seinen eigenen Eigenschaften und seiner sehr spezifischen praktischen Anwendung, wenn auch recht banal - die Ferneinbeziehung der elektrischen Heizung in das Land.  Die Anführungszeichen in der Kopfzeile sind nicht zufällig, der Controller ist in der aktuellen Version kein Smart Home, dient aber als gute Basis dafür.  <i>(Hinweis - Dieser Satz wurde am 12.04.18 aufgrund der Kommentare hinzugefügt.)</i> <br><br>  Hauptmerkmale: <br><br><ul><li>  Sensor für elektrische Netzwerkparameter - Stromzähler „Neva“ gemäß RS-485; </li><li>  Fernänderung der auf der SD-Karte liegenden Steuerungswebseite; </li><li>  Zuverlässige Aufnahme einer Gruppe von Dallas-Temperatursensoren in lange Leitungen; </li><li>  Diagramme von Parameteränderungen ohne Einbeziehung von Cloud-Diensten; </li><li>  Ausfallsichere Lösungen (externer Watchdog, USV, automatischer Neustart des Routers); </li><li>  Schutz des Internetschildes vor Einfrieren bei Störungen durch Leistungsrelais; </li><li>  Komplettes Design in einem DIN-Schienengehäuse. </li></ul><a name="habracut"></a><br>  Ich habe dieses System langsam gemacht, als Unterhaltung, von Zeit zu Zeit das Projekt monatelang geworfen ... Es dauerte ungefähr anderthalb Jahre von der Idee bis zur Implementierung :) <br><br>  Da ich vorher nichts mit Mikrocontrollern zu tun hatte, begann ich mit dem Starter-Kit mit Aliexpress, spielte mit LEDs, Tasten und Sensoren, verstand etwas und begann, eine Steuerung für die Fernsteuerung und Überwachung zu bauen.  Nun, das „Smart Home“ ist natürlich nicht direkt, aber so ähnlich. <br><br>  Das praktische Ziel war zunächst eines: die Fernschaltung der Heizung im Land.  Ich habe es noch nicht geschafft, ein Haus zu bauen (meine Hände haben es nicht erreicht), aber ich habe ein wunderbares, komfortables <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sommerhaus</a> aus Hackfleisch, das von elektrischen Konvektoren erhitzt wird.  Wärmen Sie ein Umkleidehaus auf, das sich während der Woche bis Freitagabend abgekühlt hat - eine sehr verlockende Gelegenheit in der kalten Jahreszeit. <br><br>  Die Aufgabe der Fernsteuerung von Lasten erwies sich jedoch als recht trivial.  Arduino plus das Internetschild, eine fertige Skizze aus dem Internet, und die Rollen klicken bereits auf die Häkchen auf der Webseite.  Das praktische Ziel wurde irgendwie sehr schnell und einfach erreicht.  Und es war langweilig.  Ich wollte etwas interessanteres. <br><br>  Ich habe mir ein zweites praktisches Ziel gesetzt - die Überwachung des Stromverbrauchs im Sommerhausnetz.  Ich habe unprätentiöse Stromsensoren für Tests herumgespielt.  Alles hat gut funktioniert, aber diese Option war nicht für Kampfarbeiten geeignet.  Ich konnte keine leistungsstärkeren Sensoren als bei 5A finden, aber ich brauchte mindestens 25A. <br><br>  Und ich hatte die Idee, einen Stromzähler als Leistungssensor zu verwenden.  Und es war ein großartiger Gedanke!  Und ich habe ein solches Gerät geschaffen und gesehen, dass es gut ist!  Nicht ohne Schwierigkeiten, aber ich habe diese Aufgabe perfekt abgeschlossen, mit einem Gefühl tiefer Befriedigung, und ich werde es weiter unten erzählen :). <br><br>  <b>Funktionell</b> <br><br>  Die erste (und bislang letzte) Kampfversion des "Smart Home" -Controllers verfügt über folgende Funktionen: <br><br><ul><li>  Manuelle Fernsteuerung der Aktivierung des Leistungsrelais über einen Browser und Überwachung des aktuellen Status; </li><li>  Fernüberwachung der Parameter eines dreiphasigen Stromversorgungsnetzes (Spannung, Strom, Frequenz und viel mehr unnötiger Müll, den ich später abschaltete); </li><li>  Fernüberwachung der Messwerte eines Zwei-Tarif-Stromzählers; </li><li>  Fernüberwachung einer Gruppe von Temperatursensoren; </li><li>  Protokollieren von Daten und Aufzeichnen von Ereignissen auf einer Speicherkarte; </li><li>  Anzeige der Daten aller Sensoren für den ausgewählten Tag im Browser in Form von Grafiken. </li></ul><br>  <b>Ideologie</b> <br><br>  Das Prinzip des Aufbaus des gesamten Systems - ohne Cloud-Dienste von Drittanbietern sowie Datenerfassungs- und Anzeigeserver.  Das ist weder gut noch schlecht.  In der Anfangsphase des "intelligenten Bauens" ist ein solches Schema ausreichend und einfach.  Obwohl es bestimmte Einschränkungen für die Verwendung auferlegt. <br><br>  Arduino mit einem Internetschild ist der einzige Webserver im System.  Die Webseite mit der Verwaltungsoberfläche wird auf der Internet-Speicherkarte gespeichert und an den Browser übertragen, wenn über die angegebene IP-Adresse auf sie zugegriffen wird.  Die weitere Interaktion der Benutzeroberfläche mit Arduino erfolgt über Java-Skripte, deren Körper nicht in die Webseite eingebettet sind, sondern in meinem Home-Dateispeicher mit Internetzugang gespeichert sind.  Dieser Ansatz reduziert das Gewicht der Webseite, wodurch das Lesen von der SD-Karte beschleunigt wird, und ermöglicht es Ihnen, den Skriptcode schneller und einfacher zu ändern. <br><br>  Das Lesen des Datenprotokolls zum Anzeigen von Grafiken erfolgt auf Anfrage von der Speicherkarte (Drücken einer Taste in einem Browser).  Daten werden nur in der aktuellen Sitzung der Browserseite angezeigt, sie werden nirgendwo gespeichert, und wenn Sie die Seite neu laden, müssen Sie sie erneut lesen.  Dies ist ein Minus der Ideologie, da das Lesen von einer Speicherkarte ziemlich langsam ist und das Abrufen einer täglichen Datenmenge ein oder zwei Minuten dauern kann (es gab die Idee, das Datenspeicherformat zu überarbeiten, um seine Größe zu verringern und das Lesen zu beschleunigen). <br><br>  Die aktuellen Werte der Sensoren werden auf der Seite angezeigt und in Echtzeit mit der Schleifenzyklusfrequenz aktualisiert, die ich habe und die ungefähr 1 Hz beträgt. <br><br>  Der Algorithmus enthält derzeit keine „Schlauheit“.  Ob ich den Algorithmus in Zukunft ermahnen werde - ich weiß nicht, für den Moment ist die aktuelle Version für mich völlig zufriedenstellend. <br><br>  <b>Netzwerktopologie</b> <br><br>  In der Hütte mobiles Internet Yota (USB-Modem + WLAN-Router).  Es gibt keine feste IP-Adresse und es gibt auch keine Möglichkeit, sie zu erhalten, selbst für Geld.  Und selbst wenn es keine dynamische weiße IP-Adresse gibt, ist DynDNS nicht anwendbar.  Nur graue IP-Adresse des internen Yota-Netzwerks.  IPota Yota unterstützt nicht (zumindest für 2017 ist dies der Fall).  Daher habe ich nur einen Weg gefunden, um von außen zum Länderrouter zu gelangen - VPN. <br><br>  Zu Hause (in der Stadt) kabelgebundenes Internet mit einer weißen festen IP-Adresse.  Router, gefolgt von Netzwerkspeicher.  Auf diesem Heimrouter wurde ein VPN-Server eingerichtet.  Der Länderrouter ist so konfiguriert, dass der PPTP-VPN-Tunnel zum Heimrouter angehoben wird. <br><br>  Der Controller auf Arduino ist mit dem LAN-Port des Country-Routers verbunden und befindet sich hinter NAT. Der 80. Port wird an diesen weitergeleitet.  Daher kann ich nur über mein VPN auf Arduino zugreifen.  Dementsprechend sind das Heim-LAN und das VPN, die ich habe, zwei Segmente desselben Subnetzes. Der Zugriff erfolgt direkt dort.  Auf seinem Bürocomputer und auf einem Smartphone stellte er eine VPN-Verbindung her und erhielt Zugriff auf Arduino.  Nicht sehr bequem zu bedienen, aber es funktioniert.  Ja, und relative Sicherheit wird bereitgestellt - ohne Autorisierung in meinem VPN kann niemand anderes zur Controller-Verwaltungsseite gelangen. <br><br>  Der Engpass ist der VPN-Tunnel zum Länderrouter.  Fällt regelmäßig.  Darüber hinaus wird die PPTP-Verbindung abgebrochen, der Internetzugang bleibt bestehen.  Und das Schlimmste ist, dass die PPTP-Verbindung nicht mehr von selbst aufsteigt, wenn sie unterbrochen wird.  Selbst ein Neustart des Routers wird nicht gespeichert.  Nur ein vollständiger Neustart der Stromversorgung mit einem USB-Modem und dann nicht sofort.  Sie müssen es ausschalten, 10 Minuten warten und wieder einschalten.  Glück - gut, nein - die nächste Iteration.  Laut dem technischen Support von Zyxel ist der Grund, dass der Mobilfunkbetreiber PPTP-Pakete blockiert, da eine Seite korrekt sendet, die andere korrekt zuhört, die Daten jedoch nicht erreichen (ich habe Zyxel-Router an beiden Enden des VPN-Tunnels).  Yota scheint schuld zu sein, aber etwas zu erreichen, das von ihnen verständlich ist, ist unmöglich.  Oder vielleicht auch nicht Yota. <br><br>  <b>Wachhund</b> <br><br>  Um einen relativ reibungslosen Betrieb des VPN zu gewährleisten, verwende ich einen <strike>Krückenprogramm-</strike> Watchdog. Der Länderrouter wird über ein von Arduina gesteuertes Leistungsrelais mit Strom versorgt. Sobald der VPN-Server aufhört zu pingen (auch Arduina pingt), wird der Router nach 10 Minuten für 10 Minuten vom Stromnetz getrennt und dann wieder vom Router Es wird eingeschaltet und es wird erwartet, dass innerhalb von 5 Minuten eine PPTP-Verbindung hergestellt wird.  Wenn keine Verbindung besteht, die nächste Iteration.  Manchmal wirkt diese Verbindung wochen- und sogar monatelang stabil und manchmal beginnt sie fast täglich zu brechen.  Es wurde noch kein anderer Weg gefunden, um das Problem zu lösen.  Wie ich bereits sagte, unterstützt Yota IPv6 nicht, es gibt oder verkauft kein weißes IP an Physiker, es gibt keinen anderen Anbieter mit normalen Tarifen und sicherlich keinen unbegrenzten Datenverkehr.  Diese Entscheidung ist zwar eine Krücke, erfüllt aber ihre Aufgabe sehr gut.  Jetzt habe ich bis auf wenige Ausnahmen immer eine Verbindung, wenn ich zum Zeitpunkt des Neustarts komme. <br><br>  Neben Software habe ich auch einen Hardware-Watchdog implementiert.  Nur für den Fall.  Der Controller sollte in Abwesenheit von mir wochen- und manchmal sogar monatelang arbeiten und nicht hängen bleiben.  Wie sich diese ganze Wirtschaft in großen Minuspunkten verhalten wird, war mir nicht bekannt, also war ich in Sicherheit.  Der in Atmega eingebaute Watchdog hat bei mir nicht funktioniert, weil ich bei Arduino Mega überhaupt nicht "out of the box" gearbeitet habe, und um ihn zum Laufen zu bringen, musste ich viel Spaß haben.  Dieses Problem wird hier gut beschrieben.  Außerdem hat er ein maximales Intervall von 8 Sekunden, was mir unzureichend erschien.  Daher habe ich einen speziellen Watchdog-Timer-Chip TPL5000DGST verwendet, dessen Intervall durch eine Kombination von drei Pins festgelegt wird und 64 Sekunden erreichen kann, was perfekt zu mir passt.  Für diesen Chip habe ich ein kleines Steckbrett gekauft, es verlötet und am Anschluss mit den E / A-Anschlüssen von Arduina befestigt (das Foto ist im Montageabschnitt unten zu sehen).  Tests haben den zuverlässigen Betrieb dieses Watchdogs gezeigt, und ich habe mich gefragt, wie oft er in der Realität funktionieren wird.  Zu diesem Zweck habe ich dem Programmcode eine Variable hinzugefügt, in der Uhrzeit und Datum des Programmstarts gespeichert sind. Diese Informationen werden auf der Steuerungswebseite angezeigt.  Die Praxis hat gezeigt, dass der Controller im Gegensatz zu einem VPN lange Zeit reibungslos funktioniert und der Watchdog-Timer nie nützlich war (beim Schreiben des Artikels hat er zum ersten Mal funktioniert, er war nicht umsonst).  Die Dauer des Dauerbetriebs betrug mehr als 3 Monate und hätte länger dauern können, wenn ich nicht von Zeit zu Zeit etwas im Code korrigieren und den Controller neu starten musste. <br><br>  <b>Der Parametersensor des Stromversorgungsnetzes - der Newva-Stromzähler</b> <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/habr/post_images/845/f35/bd5/845f35bd5d12bc60384f1aa0bb1506aa.jpg" width="200"></a> <br><br>  Wie oben erwähnt, kann meiner Meinung nach nichts Besseres und Genaueres als ein moderner digitaler Stromzähler mit einer externen Datenzugriffsschnittstelle als Sensor für Stromversorgungsparameter gefunden werden.  Ich entschied mich für den Newa-Schalter der St. Petersburger Firma Taypit mit der RS-485-Schnittstelle. <br><br>  Ich betone, dass ein Stromzähler mit fest angeschlossenen Kabeln der 485. Schnittstelle offiziell nicht als Zähler verwendet werden darf ( <b>Update</b> : In den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kommentaren wurde</a> vorgeschlagen, dass dies zulässig ist).  Deshalb habe ich im Stromnetz der Hütte zwei Zähler in Reihe geschaltet.  Der erste ist ein offizieller Stromzähler, versiegelt und registriert, der sich im Straßeneingang befindet.  Der zweite ist mein nicht versiegelter und nicht erfasster Stromversorgungssensor, den die Energievertriebsgesellschaft nicht interessiert, weil sie sich nicht um alles kümmert, was nach dem Messgerät installiert wird.  Dieser Stromzähler befindet sich bereits in der Schalttafel im Umkleidekabine, und in derselben Schalttafel befindet sich auch ein Controller auf Arduino, aber dazu später mehr. <br><br>  In der Hütte habe ich ein dreiphasiges Stromversorgungsnetz.  In der Stadt kann ich nur einphasig debuggen.  Deshalb habe ich zwei Meter erworben, einen dreiphasigen Neva MT-324 und einen einphasigen Neva MT-124.  Das anfängliche Debuggen des Controllers wurde auf dem Tisch auf einem Dreiphasenzähler mit einer einphasigen Verbindung durchgeführt und dann im Kampfbetriebsmodus regelmäßig im Datscha-Schild installiert.  Das Debuggen nachfolgender Softwaremodifikationen wurde bereits an einem günstigeren einphasigen Zähler auf dem Tisch durchgeführt: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/a5a/5cb/6fb/a5a5cb6fb932dea11badc7f06376e22d.jpg" width="640"></a> <br><br>  Um das Messgerät an Arduino anzuschließen, ist ein RS-485-TTL-Pegelwandler erforderlich: <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/habr/post_images/258/07f/e5a/25807fe5acb55ec27d079d024a24b1f0.jpg" width="200"></a> <br><br>  Um mit dem Zähler arbeiten zu können, benötigen Sie eine kostenlose serielle Schnittstelle auf Arduino.  Leider hat Arduino Uno nur eine serielle Schnittstelle. Wenn Sie diese unter den Ladentisch nehmen würden, müssten Sie die Debug-Ausgabe von Textinformationen (Port-Monitor) verlieren, und ohne diese wäre es unmöglich, eine Skizze zu schreiben.  Daher verwende ich Arduino Mega, das mehrere serielle Schnittstellen hat.  Es wäre möglich, die zweite serielle Schnittstelle softovo über die digitalen Anschlüsse von Arduino zu implementieren, aber ich habe keine geeignete Bibliothek gefunden, mit der andere Anschlusseinstellungen außer der Geschwindigkeit geändert werden können.  Die Einstellungen des Zählerports unterscheiden sich von den Standardeinstellungen: 9600 Bitrate, 7 Datenbits, 1 Stoppbit, Paritätskontrolle - gerade.  Glücklicherweise können Sie diese Einstellungen mit dem seriellen Standardobjekt in Arduino vornehmen. <br><br>  Es war relativ einfach, das Austauschprotokoll mit dem Zähler abzurufen - der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">öffentlich zugängliche Zählerhersteller</a> verfügt über ein Programm zum Lesen von Parametern unter Windows, das auch über einen Portmonitor verfügt.  Um das Messgerät an einen Computer anzuschließen, habe ich den Schnittstellenkonverter MOXA 232/432 / 485USB verwendet.  Einige Zeit für die visuelle Analyse der Pakete - und ich habe die Hauptbefehle herausgegriffen. <br><br>  Dies schien mir jedoch nicht genug zu sein, und ich kontaktierte den Hersteller per E-Mail.  Nach einem Monat Korrespondenz mit Typit gelang es mir schließlich, eine vollständige Liste der Befehle mit Interpretation zu erhalten: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Parametercodierung MT3XX E4S</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Parametercodierung NEVA MT124 AS OP (E4P)</a> <br><br>  <b>Update 28.10.2019</b> : Erläuterungen zu den Befehlen.  Die Befehle in der Tabelle werden als Textzeichen dargestellt.  Das heißt, wo es 0 (Null) kostet, müssen Sie 0x30 senden.  Punkte und Sternchen sind Trennzeichen für Schönheit, sie bedeuten nichts und Sie müssen sie nicht senden.  Am Ende des Befehls wird ein Prüfsummenbyte hinzugefügt, das unter Berücksichtigung des Befehlspräfixes und des Postfixes berechnet wird, die in der Tabelle nicht angegeben sind.  Das Präfix für alle Lesebefehle lautet 0x01 0x52 0x31 0x02.  Dieser Postfix ist 0x28 0x29 0x03.  Das Senden eines Präfixes ist jedoch nicht erforderlich, und ein Postfix scheint obligatorisch zu sein.  Beispiel: Befehl zum Lesen des Datums 09.09.02 * FF.  Eigentlich müssen Sie die Textzeichencodes 000902FF übergeben.  Das heißt, 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46.  Fügen Sie das Präfix und das Postfix hinzu, wir erhalten die Menge 0x01 0x52 0x31 0x02 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46 0x28 0x29 0x03.  Wir lesen die Prüfsumme als xoder aller Bytes minus 1 und addieren das empfangene Byte am Ende.  Das Präfix wird als optional verworfen.  Als Ergebnis senden wir dies an den Zähler - 0x30 0x30 0x30 0x39 0x30 0x32 0x46 0x46 0x28 0x29 0x03 0x68.  Vor dem Beginn des Austauschzyklus müssen die Befehle für die Austauschinitialisierung stehen. In der folgenden Skizze sind diese Befehle als // Start 1, 2, 3 gekennzeichnet. Sobald der Austausch initialisiert ist, können Sie die Daten vom Zähler im Zyklus für eine beliebig lange Zeit lesen, jedoch nach Verlust der Kommunikation und Möglicherweise ist nach längerem Mangel an Austausch aus anderen Gründen eine Neuinitialisierung erforderlich. <br><br>  Darüber hinaus besteht die technische Angelegenheit darin, einen Zyklus der Parameterabfrage unter Arduino zu schreiben und diese zunächst im Port-Monitor anzuzeigen.  Die Zeit eines Zyklus betrug ungefähr eine Sekunde.  In der endgültigen Version des Projekts mit Datenprotokollierung auf einem Flash-Laufwerk und Abfragetemperatursensoren wurde diese Zeit jedoch auf 4 Sekunden erhöht.  Das passte mir überhaupt nicht und musste in die Optimierung eintauchen.  Infolgedessen habe ich wieder ein zweites Intervall erreicht, ohne die Funktionalität zu verlieren.  Übrigens habe ich die Skizze zwei- oder dreimal von Grund auf neu geschrieben, bis ich die richtige Architektur und die richtigen wirtschaftlichen Algorithmen gefunden habe. <br><br>  <b>Software-Implementierung des Austauschs mit einem Zähler</b> <br><br>  Der Code wird aus dem Kontext meiner großen Arbeitsskizze herausgerissen.  Kompiliert, aber in dieser Form habe ich es nie ausgeführt.  Ich gebe es nur als Beispiel und nicht als fertiges Arbeitsprogramm.  Obwohl theoretisch alles in dieser Form funktionieren sollte. <br><br>  Der Code wird für zwei Arten von Zählern gleichzeitig geschrieben, einphasiges MT-124 und dreiphasiges MT-324.  Der Zählertyp wird im Programm automatisch durch das Antwortwort des Initialisierungsbefehls ausgewählt. <br><br>  Ich zitiere den Code so wie er ist, ohne Hübschheit und ohne zusätzliche Kommentare außer denen, die ich für mich selbst geschrieben habe.  Und ja, ich bin kein Programmierer und lerne nicht einmal dafür. Sie sollten mich also nicht wegen der Qualität des Codes treten, aber Sie können lernen, wie man <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">codiert</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">EnergyMeterNeva.ino</a> <br><br>  Ein großes Plus des Stromzählers ist eine zuverlässige und genaue Echtzeituhr.  Ich musste dem System kein zusätzliches Modul zur Verfügung stellen, das nicht nur irgendwie, sondern auch qualitativ hochwertig zu finden ist.  Die auf die Sekunde genau aktuelle Zeit erhalte ich unter anderem vom Zähler.  Ja, in Bezug auf die Atomzeit ist die Zählerzeit leicht verschoben (einige Sekunden). Ich weiß nicht, womit sie verbunden ist, eine Werkseinstellung von schlechter Qualität oder etwas anderes, aber die Genauigkeit ist ausgezeichnet, nur mit einer leichten Abweichung. <br><br>  In seltenen Momenten, wenn der Strom in der Hütte ausgeschaltet ist und der Zähler nicht mehr verfügbar ist, erhalte ich die aktuelle Zeit vom internen Timer von Arduina.  Wenn der Stromzähler funktioniert und seine Daten verfügbar sind, schreibe ich den internen Timer von Arduina mit dem Wert des Zählers in jeder Schleifenschleife neu.  Wenn der Zähler abfällt, tickt die aktuelle Zeit weiterhin auf dem Arduina-Timer. <br><br>  Neben dem Lesen der Parameter kann natürlich auch der Zähler programmiert werden.  Das heißt, die Schnittstelle funktioniert sowohl zum Lesen als auch zum Schreiben.  Mit solchen Schwierigkeiten versuchte ich jedoch, ein Protokoll zum Lesen von Befehlen zu erhalten, das ich dem Hersteller nicht einmal über die Anforderung eines Aufzeichnungsprotokolls anzeigte.  Erstens brauchte ich es nicht, außer vielleicht nur ein wenig Zeit, um es zu bewegen.  Zweitens vermute ich, dass diese Daten nicht mehr öffentlich sind, da sie für betrügerische Zwecke verwendet werden können. <br><br>  <b>Temperatursensoren</b> <br><br>  Ich habe bereits zuvor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen</a> Test von Temperatursensoren mit einem Skizzenbeispiel separat durchgeführt.  Jetzt blieb es nur noch, ihre Umfrage in das Hauptprojekt einzubetten.  Es war nicht schwer.  Alle neun Sensoren, die ich hatte, arbeiteten problemlos, als ich 1-Wire parallel einschaltete.  Der Messbereich zwischen ihnen betrug etwa 0,5 Grad, was zeigt, dass es sinnlos ist, sie mit einer maximalen Genauigkeit von 0,0625 Grad zu verwenden.  Ich sammelte die Sensoren für den Test in einer Packung und wickelte sie in mehrere Schichten Polyethylenkleber ein.  Für eine größere Genauigkeit platzierte ich die Packung vertikal und wartete einen Tag, um die Temperatur vollständig auszugleichen.  Die Messwerte aller Sensoren waren nicht gleich. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe jedoch nicht begonnen, die Genauigkeit der Umrechnung der Temperatur der Sensoren selbst zu beeinträchtigen. Es ist einfacher, die Messwerte programmgesteuert abzurunden, und ich würde den Nutzen aus dem Zeitpunkt der Umfrage nicht ziehen, da ich einen Algorithmus entwickelt habe, bei dem das Zeitlimit für die Konvertierung keine leere, nutzlose Verzögerung ist (750). Die übliche Logik für die Arbeit mit Sensoren besteht darin, zuerst einen Befehl zum Starten der Temperaturumwandlung auszugeben, dann auf den Abschluss der Umwandlung zu warten (mindestens 750 ms) und dann die Daten zu lesen. Ich habe das Gegenteil getan, wodurch ich ein leeres Warteintervall ausschließen konnte - zuerst habe ich die Daten von den Sensoren gelesen und dann sofort mit der Konvertierung begonnen. Und während der gesamte Rest des Codes im LOOP-Zyklus funktioniert, haben die Daten nur Zeit, sich auf das Lesen in der nächsten Runde vorzubereiten. Mit der Zeit erhalte ich die Daten in diesem Fall etwas später von den Sensoren - der LOOP-Zyklus dauert ungefähr 1-1.5 Sekunden, aber das ist absolut nicht kritisch.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manchmal erhielt ich von allen Sensoren die Daten „85“ oder „0“. Ich verstehe nicht, um welche Art von Pfosten es sich handelt, daher habe ich den Code überprüft und ausgeschlossen, dass solche Daten in das Ergebnis gelangen. Ein weiterer Pfosten wurde an einem der Sensoren entdeckt - er hielt die Einstellungen nicht, als die Stromversorgung ausgeschaltet wurde. Entweder ist sein internes Flash-Laufwerk tot oder etwas anderes. Daher habe ich im Setup die Einstellungen für die Sensoren registriert, und jetzt, wenn die Stromversorgung eingeschaltet wird (falls sie immer noch verschwindet), sind garantiert alle Sensoren konfiguriert. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe die Adressen bestimmter Sensoren anhand eines Skizzenbeispiels erhalten, das irgendwo von mir ausgegraben und ein wenig geändert wurde: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DS18x20_Temperature.ino</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Danach habe ich die Adressen mit Konstanten in einem Array </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">bewertet</font></a><font style="vertical-align: inherit;"> und mich </font><font style="vertical-align: inherit;">im Hauptprogramm sofort an die Sensoren gewandt, deren Adressen: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TempSensors_DS18B20.ino</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Für den korrekten Betrieb der Sensoren am 1-Draht-Bus muss ein 4,7-kΩ-Pull-up-Widerstand zwischen der Datenleitung und der Stromversorgung installiert werden. Es war praktisch für mich, einen SMD-Widerstand zwischen die Stifte des Klemmenblocks zu löten, aber ich fand in einem geeigneten Gehäuse nur 5,1 kOhm und legte ihn ein (er ist auf dem Foto im Montageabschnitt auf der Unterseite der Platine sichtbar). Alles funktioniert gut.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meine Temperatursensoren sind elektrisch parallel an einer langen Leitung (+5, gnd und Daten) angeschlossen, alle 9 Teile, aber schwierig. Twisted Pair-Kabel sind physikalisch durch einen Stern verbunden, um Sensoren bequem um das Objekt herum zu verdrahten. Ich benutze zwei Paare in jedem Kabelarm. Ein Paar ist die Sensorleistung. Das zweite Paar ist eine Datenleitung, die durch eine Leitung zum Sensor führt und von dieser über die zweite Leitung zurückkehrt. Somit ist es möglich, die Kabel mit einem Stern von der Abschirmung zu trennen, aber elektrisch ist es ein Stern nur in der Leistung, und nach den Daten ist es eine Leitung. Diese Verbindungsoption erwies sich bei der Arbeit an langen Leitungen als zuverlässiger. Bei einer einfachen Parallelverbindung traten beim Lesen von Daten viele Fehler auf. Hier ist eine Skizze eines solchen Schemas:</font></font><br><br> <a href=""><img height="300" src="https://habrastorage.org/getpro/habr/post_images/84e/1a3/b3d/84e1a3b3d64983af4236a6dad5458a52.jpg" width="640"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe die halben Meter langen Enden der dreiadrigen Kabel der Sensoren selbst nicht gekürzt, sondern sie so angeschlossen, wie sie waren. Es stellte sich heraus, dass dies nicht kritisch war. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insgesamt gibt es drei Kabel für die Kabinen, zwei für externe Sensoren, jeweils eines für jede und eines für alle verbleibenden sieben internen. Diese sieben internen Sensoren werden auf die gleiche Weise angeschlossen, jedoch innerhalb eines langen Kabels und mit kurzen Abzweigungen davon (siehe die untere T-Form in der Skizze). Irgendwo gab es genug einen Standard-halben Meter Schwanz des Sensors zum Verzweigen, irgendwo wurde er mit Hilfe des gleichen verdrillten Paares verzweigt.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zweidraht-Sensorschaltkreis mit sogenannter Ich habe keine parasitäre Energie verwendet (wenn die Sensoren über die Datenleitung mit Strom versorgt werden), weil ... warum? Auf jeden Fall würde ich vier Paar Kabel nehmen, einfach weil ich sie hatte. Es gibt keine Probleme beim Verlegen des Kabels in den Kabinen. Und die parasitäre Stromversorgungsschaltung ist entscheidend für die in einigen Betriebsarten verbrauchte Strommenge. Es können unnötige Probleme auftreten.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Gesamtlänge des verdrillten Paares in den Kabinen betrug ungefähr 25 Meter. Teile für externe Sensoren - 5 und 10 Meter, und ein zehn Meter langes internes Teil mit Abzweigungen für sieben Sensoren. Alles funktioniert fast perfekt. Anstelle von Temperaturwerten kreuzen sich nur gelegentlich Striche. Dies bedeutet, dass Daten von einem bestimmten Sensor nicht korrekt gelesen wurden. Aber das passiert so selten (ich merke es vielleicht einmal im Monat), dass es keine Probleme verursacht. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remote - </font><font style="vertical-align: inherit;">Zugriff</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für Remote - </font><font style="vertical-align: inherit;">Zugriff auf das Arduino wurde Ethernet Schild gekauft. Mit einer eingebauten Bibliothek erwies sich die Arbeit damit, wie alles andere in Arduino, als recht einfach.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktionell ist mein Arbeitsschema wie folgt. Auf Arduino wurde ein Webserver eingerichtet, der beim Zugriff eines Clients (Browsers) eine Webseite mit verschiedenen Informationen generiert. Die automatische Aktualisierung der Daten auf der Seite wird mithilfe von Javascript implementiert, das den Server nach Timer abfragt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Seite enthält auch eine Reihe von Steuerelementen zur Steuerung von Aktuatoren, die an Arduino-Leistungsrelais angeschlossen sind, die die lastelektrischen Heizungen und die Beleuchtung schalten. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich habe mit dem Design der Webseite kein Dampfbad genommen, zumal eine minimale Menge an Textdaten erforderlich war, um sie schneller zu laden, daher das primitivste HTML und das ist alles:</font></font><br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/1e0/2fa/c9e/1e02fac9e6e1e8c5a16d0a7c07667f94.png" width="475"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anstelle von Daten habe ich Tags in den HTML-Code eingebettet, die im laufenden Betrieb durch echte Daten ersetzt werden, wenn die Seite vom Server generiert wird. Wenn Daten auf Anforderung von Javascript automatisch aktualisiert werden, werden sie direkt vom Mikrocontroller im JSON-Format an den Browser übertragen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Seitencode befindet sich in einer Datei auf der Speicherkarte und wird beim Zugriff auf den Server von dieser geladen. Für eine schnellere und bequemere Änderung des Seitencodes habe ich den Mechanismus zum Aktualisieren selbst eingebaut. Unten unter dem Block der grundlegenden Steuerelemente befinden sich ein Textfeld und eine Schaltfläche zum Senden. Ich kopiere den neuen HTML-Code in das Textfeld und drücke die Taste. Danach sendet das Java-Skript Daten an den Webserver des Controllers, der sie zuerst in der Spooldatei speichert. Wenn die Übertragung erfolgreich war, wird die Hauptdatei durch einen Puffer ersetzt, die Seite wird automatisch aktualisiert.</font></font> Das ist alles.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Änderungen akzeptiert. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ich zitiere die Codefragmente meiner Implementierung dieses Mechanismus. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In die HTML-Seite binden wir das Formular ein:</font></font><br><br><pre><code class="plaintext hljs">&lt;script type="text/javascript" src="http://domain/send_HTM.js"&gt;&lt;/script&gt;&lt;/pre&gt; &lt;pre style="font-size: 14px;"&gt;&lt;form&gt; &lt;br&gt;&lt;br&gt; CONTROL.HTM:&lt;br&gt; &lt;textarea cols="100" rows="20" wrap="off" id="htm"&gt;&lt;/textarea&gt;&lt;br&gt; &lt;input type="button" value="" onclick="send_HTM();"&gt;&lt;br&gt; &lt;div id="progress" style="display:none"&gt; &lt;div id="label"&gt;  :&lt;/div&gt; &lt;div style="width:800px;border:1px solid #000"&gt; &lt;div id="bar" style="background:#00f;height:10px;width:0px"&gt;&lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/form&gt;</code> </pre> <br>  Die Schaltfläche "Senden" startet das folgende <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Java-</a> Skript: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">send_HTM.js</a> <br><br>  In der Skizze in der Funktion zum Verarbeiten von Webserveranforderungen nach Präfixen in den Anforderungen 'CONTROL.HTM' (Senden der Datei starten), 'htmlineN' (Senden der Zeilennummer) und 'END_CONTROL.HTM' (Ende des Sendens der Datei) bestimmen wir die folgenden Aktionen: <br><br><pre> <code class="plaintext hljs">File acceptHtmFile; ................ if (fl_accept_htm) //  'CONTROL.HTM' { SD.remove(CTRL_HTM); acceptHtmFile = SD.open(CTRL_HTM, FILE_WRITE); //     if (!acceptHtmFile) //      -    { #ifdef DEBUG_SD Serial.println("SD-card not found"); #endif client.print("FAIL"); client.stop(); } else client.print("OK_OPEN_FILE"); acceptHtmMode = true; break; } if (fl_htmline) //  'htmlineN' { int b = acceptHtmFile.println(tag); if (b == 0) { client.print("FAIL"); acceptHtmMode = false; cntHtmModeIteration = 0; } else { client.print("OK"); } cntHtmModeIteration = 0; break; } if (fl_endhtm) //  'END_CONTROL.HTM' { SD.remove(CONTROL_HTM); acceptHtmFile.close(); File htmlFile = SD.open(CONTROL_HTM, FILE_WRITE); //    acceptHtmFile = SD.open(CTRL_HTM); //    for (int i = 0; i &lt; acceptHtmFile.size(); i++) { digitalWrite(PIN_WATCHDOG_DONE, 1); htmlFile.write(acceptHtmFile.read()); digitalWrite(PIN_WATCHDOG_DONE, 0); } acceptHtmFile.close(); htmlFile.close(); client.print("OK_CLOSE_FILE"); acceptHtmMode = false; cntHtmModeIteration = 0; break; }</code> </pre> <br>  Die hier definierten CONTROL_HTM- und CTRL_HTM-Namen sind die Namen der HTML-Dateien.  Die erste ist die Hauptdatei, die zweite ist die Pufferdatei.  In dem Array von Tag char liegt der Text der empfangenen Zeichenfolge, der aus der Anforderung ausgewählt wurde.  Die Logik lautet wie folgt: Wenn Daten empfangen werden, werden sie in die Spooldatei geschrieben. Am Ende des Empfangs wird die Spooldatei in der Hauptdatei überschrieben.  Ich konnte immer noch nicht verstehen, wie man die Dateien einfach umbenennt, die SD-Standardbibliothek hat keine solche Funktion, also dummes zeichenweises Kopieren, was viel Zeit in Anspruch nimmt. <br><br>  Es ist praktisch, den Code der Steuerungswebseite nicht auf der Speicherkarte des Controllers, sondern auf dem Clientcomputer zu speichern oder von einer externen Ressource herunterzuladen.  Das Verbot domänenübergreifender Anfragen erlaubt dies jedoch nicht.  Javascripts können ihre Anfragen nur in den Norden senden, aus dem sie geladen wurden.  In diesem Fall können die Javascripts von überall geladen werden. Es ist nur wichtig, woher die Seite mit ihrem Aufruf geladen wurde. <br><br>  <b>Datenprotokollierung</b> <br><br>  Das Ethernet-Shield verfügt über einen integrierten Micro-SD-Kartensteckplatz.  Aufgrund seiner Anwesenheit habe ich beschlossen, Daten in Protokolldateien zu schreiben.  Um mit einer Speicherkarte arbeiten zu können, ist auch eine Bibliothek integriert, und das Schreiben und Lesen von Dateien damit zu verwalten, ist im Allgemeinen elementar. <br><br>  Um die Datenmenge zu speichern, habe ich den Protokollierungsalgorithmus so erstellt, dass der Datensatz nur dann erstellt wird, wenn sich die Daten um mehr als einen vorgegebenen Schwellenwert ändern.  Für die Temperatur beträgt sie 0,1 °, für die Spannung 0,2 V.  Daten für einen Tag werden in eine Datei geschrieben.  Nach null Stunden wird eine neue Datei erstellt.  Ich habe das Nur-Text-Format mit Trennzeichen gewählt, damit Sie den Inhalt von Dateien während des Debuggens schnell steuern können und es eine einfache Möglichkeit gibt, in Excel zu laden. <br><br>  Aufgrund von Designbeschränkungen können Sie eine Speicherkarte nicht bequem einsetzen / entfernen, daher habe ich eine große Karte verwendet.  Nach meinen Berechnungen wird es einige Jahre lang ausgefüllt. Danach muss das Gehäuse zerlegt, die Speicherkarte entfernt und gereinigt werden. <br><br>  Ich sehe keinen Sinn darin, den Code zu protokollieren, da ist dort alles völlig trivial - eine banale Aufzeichnung von Text in einer Datei.  Und dieser Code ist über die gesamte Skizze verteilt (nicht nur die Parameter der Sensoren werden protokolliert, sondern auch eine Vielzahl von einmaligen Ereignissen). Es ist schwierig, ihn zu isolieren. <br><br>  <b>Grafiken</b> <br><br>  Als Charting-Engine verwende ich die hochflexible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Amavart-</a> Javascript-Visualisierungsbibliothek.  Die Bibliothek ist kostenlos und steht zum Download und zur Offline-Nutzung zur Verfügung.  Ich habe diese Bibliothek auch auf meinem NAS mit permanentem Internetzugang gefunden.  Das Verbinden und Verwenden mit den Standardeinstellungen ist nicht schwierig. Um jedoch die Ansicht zu erhalten, die ich brauchte, musste ich viel basteln.  Eine Vielzahl von Beispielen auf der Website und die Verfügbarkeit detaillierter Dokumentation haben geholfen. <br><br>  Als Beispiel werde ich das Javascript zum Zeichnen von Zeitplänen geben.  An sich ist es nutzlos, da es nur in Verbindung mit einem Webserver und einer HTML-Seite funktioniert und möglicherweise mit anderen Skripten verknüpft ist (es ist lange her, ich erinnere mich nicht an alle Details).  Aber die Darstellungseinstellungen meiner Diagramme sind darin enthalten und können von dort <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">abgerufen werden</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">get_log.js</a> <br><br>  Der große Vorteil der Amchart-Bibliothek besteht darin, dass sie aus zerrissenen Daten die richtigen Grafiken zeichnen kann.  Wie oben erwähnt, speichere ich im Protokoll Daten nur, wenn sie sich ändern.  Das heißt, dies geschieht asynchron und zufällig.  Möglicherweise sind einige Minuten lang keine neuen Daten vorhanden, die sich dann in wenigen Sekunden mehrmals ändern.  Dementsprechend gehen Einträge im Protokoll mit beliebigen Zeitintervallen.  Amchart berücksichtigt dies beim Rendern selbstständig. Ich muss die Daten vor dem Rendern nicht interpolieren.  Ich sende das Datenarray einfach so wie es ist und sehe ein schönes Diagramm, das zeitlich einheitlich ist. <br><br>  Ich habe nur einen Nachteil dieser Bibliothek entdeckt - sie weiß nicht, wie (na ja, oder ich verstehe immer noch nicht, wie) Echtzeitdiagramme menschlich aktualisiert werden können.  Sie können vorhandenen Daten neue hinzufügen, aber das gesamte Datenarray wird jedes Mal neu gezeichnet, was den Browser erheblich verlangsamt.  Die Ideologie, Daten von Arduina zu lesen, um sie bei Bedarf vom Browser zu rendern, ist jedoch durch ihre Nichtoptimalität fehlerhaft, sodass es keinen Sinn machte, in Echtzeit um ein schnelles Update zu kämpfen. <br><br>  Die richtige Lösung wäre, einen separaten Server zum Speichern und Visualisieren von Daten zu organisieren, auf dem die Daten von Arduina in Echtzeit ein wenig abfallen und in der Datenbank gespeichert werden und von wo aus sie schnell in einem Browser zur Visualisierung an den Benutzer gesendet werden könnten. <br><br>  Jetzt sehen die Diagramme so aus (am Beispiel des Tages, an dem sich niemand in der Wechselstube befindet und dementsprechend kein Energieverbrauch besteht).  Wenn aktuelle Daten auftreten, wird die Skalierung automatisch so eingestellt, dass alles gut passt und die Werte der aktuellen Pegel auf der vertikalen Achse angezeigt werden: <br><br> <a href=""><img height="246" src="https://habrastorage.org/getpro/habr/post_images/12e/6d5/7e5/12e6d57e563012ba95a5407a1f96a88e.png" width="640"></a> <br><br>  Diagramme werden auf derselben Seite angezeigt, auf der die Steuerung direkt unter dem Hauptsteuerblock stattfindet. <br><br>  Ich stelle aus mehreren Gründen nicht absichtlich einen vollständigen Satz von Projektquellen zur Verfügung: <br><br><ol><li>  Es kann nicht wie in einem anderen Netzwerk als meinem gestartet werden, da ich nicht versucht habe, das Projekt portabel zu machen, und es ist fest an meine Adressen und meine Netzwerktopologie gebunden. </li><li>  Ich bin sicher, dass die allgemeine Ideologie des Projekts viele verschiedene Probleme hat, da dies mein erster Versuch in dem Bereich ist, in dem ich nicht gut verstehe.  Daher schlage ich niemandem das gesamte Projekt zur Wiederholung in dieser Form vor.  Ich habe nur die Momente geteilt, in denen ich weniger zuversichtlich bin. </li><li>  Das Projekt wurde für eine lange Zeit und für eine lange Zeit durchgeführt, und ich werde mich nie an alle Details erinnern und nicht in der Lage sein, eine Reihe von Lösungen zu erklären.  Das Volumen der Skizze ist sehr groß (nach meinen Maßstäben etwa zweitausend Zeilen), es gibt mehr als ein Dutzend verschiedene Java-Skripte, ich habe kein schematisches Diagramm des Eisens erstellt.  Das heißt, ich kann nicht helfen, in den meisten Fragen zu beraten. </li></ol><br>  <b>Montage</b> <br><br>  Von Anfang an habe ich mir das Ziel gesetzt, ein fertiges Gerät zu erstellen und nicht nur ein Layout mit einem Haufen Postings auf dem Tisch: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/721/a45/ba3/721a45ba3d536cfbf0d3b302c32cdd3b.jpg" width="640"></a> <br><br>  Und sofort entschieden, dass ich das Gerät in der Schalttafel platzieren möchte.  Es gibt Essen und eine Theke, und im Allgemeinen ist es bequem. <br><br>  Hierfür war ein Dinrek-Fall erforderlich.  Zuerst dachte ich daran, es zu entwickeln und auf einem 3D-Drucker zu drucken.  Aber ich habe keinen eigenen 3D-Drucker, und was meine Kollegen an ihren selbst zusammengestellten Druckerdrucken arbeiteten, passte mir in der Qualität ihres Aussehens überhaupt nicht.  Ich habe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fertige Koffer</a> auf einer DIN-Schiene (in verschiedenen Größen) zum Verkauf gefunden, sie sehen gut aus, sind bequem zu verwenden (zusammenklappbar) und es gibt auch eine fertige <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Blindkarte</a> für sie. <br><br>  Ich habe das größte Gehäuse gekauft, damit nicht nur Arduino mit dem Internetschild hineinpassen kann, sondern auch ein Relais zum Lastschalten: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/674/493/325/6744933251f7abeed45267d51d2c2e59.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/aed/1dc/c27/aed1dcc279af58de00af5e68f30b8aac.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/fe1/cbb/ab7/fe1cbbab760347fda7df0edf2b0a9c09.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/0f9/13b/250/0f913b2504dcef41d4156e23015f5fef.jpg" width="640"></a> <br><br>  Als nächstes folgte ein langer und faszinierender Prozess, bei dem der gesamte Kutteln in den Koffer eingebaut wurde.  Im Rahmen dieses Geschäfts erwarb ich sogar einen wunderbaren Lötkolben mit Schlaffunktion (die Lötkolben, die ich hatte, stammten noch aus sowjetischer Zeit): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/8f7/cff/613/8f7cff613a071eb2ee93cd09c3286622.jpg" width="640"></a> <br><br>  Für die Installation kaufte ich ein paar Racks, Schrauben, Unterlegscheiben und Muttern aller Art.  Erstmontage: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c28/ff1/ac7/c28ff1ac7b46d25bf58714949091c7d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/fd9/c60/001/fd9c6000193beeb0a82cf14d7ca56cda.jpg" width="640"></a> <br><br>  Um die Drähte mit den oberen Kontakten zu verbinden, mussten verbogene Stifte verwendet werden, da sie sonst nicht in das Gehäuse passten: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/47a/8eb/107/47a8eb107e5b12253386f61745103774.jpg" width="640"></a> <br><br>  Die Isolierscheiben mussten stellenweise geschnitten werden: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4da/e6f/55f/4dae6f55f161153a1d544c8aae3c883e.jpg" width="640"></a> <br><br>  Und stellenweise biegt es sich perverser, hebt die Schraube an der Hülse an und schneidet die Hülse aufwendig ab: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/6ec/226/736/6ec226736d2576706170487958208959.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/f98/c43/fb9/f98c43fb9ddb0da9149193dd92ef465d.jpg" width="640"></a> <br><br>  Für ein einzelnes Reloch gab es nicht genügend Drehpunkte, so dass es nur an zwei Punkten hing: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/398/f46/4b6/398f464b6f08b4372bf8792edb0018b9.jpg" width="640"></a> <br><br>  Zusammengebaute Baugruppe mit Klemmenblöcken: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/bd8/17d/1cb/bd817d1cbc854ac47c7427c26dc0f0c8.jpg" width="640"></a> <br><br>  Dann begann das Handwerk allmählich zu Drähten zu wachsen.  Die Platine wurde nur zur Stromverdrahtung und zum Anschluss an Klemmenblöcke verwendet.  Für Signalverbindungen habe ich das MS-16-Kabel verwendet (ich mag es mehr), für die Stromversorgung ging es nicht durch die Spannung (bis zu 100 V), also MGTF: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/cc3/5ae/01d/cc35ae01d9728523e1edbe1e3d0ae79d.jpg" width="640"></a> <br><br>  Ich habe LEDs an der Vorderseite angebracht, die Strombegrenzungswiderstände direkt an die Beine der LEDs gelötet und sie mit Schrumpfschlauch geschlossen: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4a3/299/840/4a3299840a442a416396a30c81a25e2e.jpg" width="640"></a> <br><br>  Als Ergebnis haben wir eine solche bärtige Füllung bekommen: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/5c7/042/3e7/5c70423e7c3acdbe8f892054ffe010c5.jpg" width="640"></a> <br><br>  Und hier ist ein Schal mit einem Watchdog-Mikrokreislauf, der im Darm meiner Kreation direkt über dem RS-485-TTL-Pegelwandler geschützt ist: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/73d/e5b/318/73de5b318ba3e6299168d634cdbaefe2.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/798/c40/61f/798c4061fa2167591312ff1d40adf5a4.jpg" width="640"></a> <br><br>  Die gesamte Struktur ist zusammenklappbar, alles kann ohne Löten entfernt, getrennt und ersetzt werden, mit Ausnahme eines Schals mit Hundehütte, der an die Stifte des Steckverbinders gelötet ist und mit einer Reihe von E / A-Anschlüssen von Arduina versehen ist. <br><br>  In der Box: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c0b/918/cd8/c0b918cd83cbf30b11bc6b47e150b60f.jpg" width="640"></a> <br><br>  Ich habe Öffnungen für Arduinas Stecker in die Plastikwand des Gehäuses geschnitten.  Zuerst habe ich die Löcher genau entsprechend der Größe der Steckverbinder gemacht, aber die Montage in das Gehäuse muss diagonal gestartet werden (sonst funktioniert es einfach nicht) und die Steckverbinder gingen nicht durch, ich musste ein wenig verschwenden: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/7a1/5bd/21c/7a15bd21c6767e24b78a867b95952606.jpg" width="640"></a> <br><br>  Beim Einschalten des fertigen Produkts auf dem Tisch funktionierte alles sofort: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/262/a25/4f6/262a254f611519e81f429b00b2440758.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4ff/cb6/10c/4ffcb610c648d20fe7c386f821178ad9.jpg" width="640"></a> <br><br>  Auf der Frontplatte gebracht: <br><br><ul><li>  Vier rote LEDs - Lastanzeige; </li><li>  Zwei grüne - Kommunikation mit dem Zähler und mit dem VPN-Server; </li><li>  Zwei gelbe sind frei; </li><li>  Ein Gelb - Anzeige eines Neustarts des Routers; </li><li>  Ein Rot ist Ernährung; </li><li>  Und eine Reset-Taste. </li></ul><br>  Um 5 Volt aus 220 herauszuholen, habe ich ein Dinerey-Netzteil mit Ausgangspegeleinstellung verwendet. Der Strom wurde direkt an den Mikrocontroller geliefert, wobei der Eingangswandler von 7-12 auf 5 Volt umgangen wurde.  Dies war aus mehreren Gründen praktisch.  Erstens war die Leistung des eingebauten Wandlers irgendwann nicht mehr ausreichend, der Strom dort ist begrenzt.  Zweitens war es weiterhin notwendig, das Relais mit 5 Volt zu versorgen.  Drittens ist der Armaturenbrett ein praktischer Dinrek-Formfaktor in Bezug auf die Installation.  Deshalb hier: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/801/0f7/aad/8010f7aad941e5f4619553fe7433c58e.jpg" width="640"></a> <br><br><br>  <b>Test</b> <b><br></b> <br>  Alles wurde auf den Tisch gedreht, alles funktionierte wie es sollte, es war Zeit, den Controller im Schild zu installieren und ihn im Kampfmodus zu überprüfen. <br><br>  Aber zuerst habe ich alles „am Rotz“ angeschlossen und buchstäblich den ganzen Kutteln in eine andere Abschirmung mit geringem Strom geschoben, um die Temperatursensoren unter realen Bedingungen auf langen Leitungen zu testen, die in einem Kabelkanal mit ~ 220-V-Stromkabeln verlegt sind: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/d3c/3a8/b45/d3c3a8b45a90075449e23e24f4ae37e7.jpg" width="640"></a> <br><br>  Wie Sie auf dem Foto oben sehen können, habe ich bisher versucht, den Neustart des Routers über die „intelligente“ Senseit-Buchse mit Strom zu steuern.  Dieses Gerät mit wahnsinnigen Kosten von 5.000 (für 2016) erwies sich jedoch als extrem fehlerhaft und launisch.  Während des Nutzungsjahres war ich wiederholt gezwungen, zu ungünstigen Zeiten ungeplant in der Hütte anzukommen, um dieses Wunder des technischen und Marketing-Denkens manuell von einem tiefen Nachteil in Bezug auf die GSM-Kommunikation zu entfernen.  Mit dem Übergang zu meinem Arduino-Controller, der sich als zuverlässiger als ein Beispiel herausstellte, war ich erleichtert, diesen „professionellen“ Müll in eine schöne Schachtel in einer Schachtel zu werfen und ihn zu vergessen. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/efa/f91/91b/efaf9191b1dffa362e86e302d4858d34.jpg" width="640"></a> <br><br>  Der Test war erfolgreich, es gab keine Fehler und es war möglich, an einem regulären Ort mit der endgültigen Installation fortzufahren: <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/887/ac8/320/887ac8320dca67597c4f979806e22b93.jpg" width="472"></a> <br><br>  Ja, dies ist der Schild ABB TwinLine 800x300x225 IP55 im Wert von 25 Tausend Rubel.  ohne zu füllen (und für weitere 15 Tausend ungefähr füllen).  Und ja, es ist in einem 6x2 Wechselhaus installiert.  Jeder hat seine eigenen Kakerlaken.  Ja, ich habe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die gesamte Elektrik selbst gesammelt</a> .  Und er hat auch eine Umkleidekabine gebaut, ja.  Nein, ich bin kein Elektriker.  Und kein Baumeister. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/4d4/c1b/3e5/4d4c1b3e5710dfb4a87299bb1f55fbfd.jpg" width="640"></a> <br><br>  In den Tiefen des Schildes habe ich eine kleine unterbrechungsfreie Stromversorgung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Powercom WOW 300 gefunden</a> , dort leuchtet die grüne LED und links und darüber - der Eingangsstecker: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/b6a/991/299/b6a991299668084c3ae8265d064e1910.jpg" width="640"></a> <br><br>  Die Akkulaufzeit des Arduino-Geräts, eines Routers mit USB-Modem und WLAN sowie Full-HD-IP-Überwachungskameras beträgt ca. 40 Minuten. <br><br>  Und hier sehen Sie die weißen Netzstecker von zwei unterbrechungsfreien Verbrauchern - dem Arduino-Netzteil und dem Niedrigstromschild, auf dem sich der Router und das Netzteil für die Außenüberwachungskamera befinden.  Diese Leitung führt zu einer Unterbrechung des von Arduino gesteuerten Schützes, nur für denselben Software-Watchdog, der den Router im Falle eines VPN-Ausfalls mit Strom neu startet (die Kamera wird gleichzeitig neu gestartet, obwohl sie ihn nicht benötigt).  Die oberen Linien der verdrillten Paare von Temperatursensoren sind mit der Steuerung verbunden: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/0b8/fd7/50b/0b8fd750b2a17afd69eb55b6d56bf709.jpg" width="640"></a> <br><br>  Ich muss sagen, dass ich dem Umschalten einer starken Last auf kleine blaue chinesische Relais trotz der Parameter dieser Relais, die dies zu ermöglichen scheinen, niemals vertrauen würde.  Daher wurde sofort die Verwendung normaler modularer Schütze <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Legrand Kat. Nr. 4 125 01</a> mit der Möglichkeit der manuellen Steuerung festgelegt.  Das heißt, die Relais im Steuerkörper steuern die Schütze, und die Schütze steuern bereits die Last.  Es ist zuverlässig.  Die Stromversorgung des Routers und der Kamera erfolgt jedoch nur über dieses kleine blaue chinesische Relais, der Strom dort ist gering, so dass es möglich ist. <br><br>  Beim ersten Kampfstart war ich sehr enttäuscht.  Auf dem Tisch habe ich alles außer der Last erlebt.  Warum?  Schütze klicken und es ist klar, dass sie die Last wechseln werden.  Aber nein, es war notwendig zu erleben.  Leistungsstarke Elektrokonvektoren führten zum Zeitpunkt des Öffnens der Kontakte zu Störungen im System, was zu einem garantierten Einfrieren der Internetabschirmung führte.  Und um ihn aus dem Abstieg herauszuholen, war nur durch Entfernen der Stromversorgung möglich, ein einfaches Zurücksetzen half nicht.  Googelte - ja, dieser Chinese hat so ein Problem.  Und die Bibliothek geht mit dieser Situation nicht um.  Das heißt, das Stück Eisen ist schlecht und die Software ist nicht sehr gut. <br><br>  Ich dachte schon, dass alles weg ist.  Ich habe sogar Halbleiterrelais bestellt, aber sie sind größer und passen nicht in mein Design.  Aber dann dachte ich, dass es immer noch möglich sein könnte, die Störung zu unterdrücken.  Wieder gegoogelt, fanden spezielle Rauschunterdrückungskondensatoren (die sogenannten Kondensatoren vom Typ X).  Schließen Sie sie einfach parallel zur Steuerwicklung der Schütze an, und siehe da!  Aufhängevorgänge verschwanden vollständig.  Im vergangenen Betriebsjahr wurde kein einziger Fall registriert: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/7ae/198/80c/7ae19880c09be755c8421266a4ba29df.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/c25/e89/cb2/c25e89cb2e1f8ed607f736bfdfc0cd20.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/6b8/a25/f65/6b8a25f65c6f9de23a3b1ad57a91f97d.jpg" width="472"></a> <br><br>  Aber auf diese Weise können Sie in die Box schauen: <br><br> <a href=""><img height="480" src="https://habrastorage.org/getpro/habr/post_images/776/7c3/7c9/7767c37c908537a36b5bd763a39fc7bc.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/827/6fa/818/8276fa8186818314c5b4ce8516ef6f04.jpg" width="480"></a> <br><br>  Nun, die fertige Ansicht des Visiers mit dem Plastron (im Kit waren keine Stopfen enthalten): <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/habr/post_images/e4c/231/5ac/e4c2315ac67af993ed83151f58896e85.jpg" width="472"></a> <br><br>  Zum Debuggen und Blinken wird das USB-Kabel an den Controller angeschlossen und im Schild hinter einer geschlossenen Tür aufbewahrt (es wird vorübergehend nicht mit diesem Foto verbunden): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/e51/1ce/92d/e511ce92de3e8e090aa842ff540034d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/habr/post_images/8fa/202/f5a/8fa202f5abf1eeb6bbca9192dc82c719.jpg" width="640"></a> <br><br>  Das System arbeitet seit fast einem Jahr und hat Fröste bis zu 20 Grad problemlos überstanden. <br><br>  Generell bin ich mit dem Ergebnis zufrieden.  Für mehr oder weniger funktionale Aufgaben ist Arduino jedoch eindeutig schwach.  Mehr als einmal ging mir der Speicher aus und ich musste schneiden und optimieren.  Und die Arbeitsgeschwindigkeit, insbesondere mit einer Speicherkarte, passt mir überhaupt nicht.  Daher möchte ich bei den zukünftigen Implementierungen solcher Handwerke, wenn überhaupt, auf etwas Stärkerem aufbauen.  Kollegen geben mir einen Raspberry Pi, eine gute Option, denke ich. <br><br>  Jemand könnte sagen: „Wie viele Schwierigkeiten gibt es für eine solch primitive Aufgabe?“ Und wird wahrscheinlich richtig sein.  Für mich ist dieses ganze Unternehmen ein Hobby mit wenig Rechtfertigung für die Bedeutung.  Deshalb suchte ich Unterhaltung in allem, wo ich konnte :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de411141/">https://habr.com/ru/post/de411141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de411131/index.html">Der erste Wettbewerb in Unterwasserrobotik für Schüler der Klassen 1-4</a></li>
<li><a href="../de411133/index.html">Roboterspielzeug für Kinder: zum Lernen und zur Unterhaltung</a></li>
<li><a href="../de411135/index.html">Parameter</a></li>
<li><a href="../de411137/index.html">VTC - Satellitenkommunikationszentrum (Wladiwostok)</a></li>
<li><a href="../de411139/index.html">Das Rätsel um die Neutronenlebensdauer wird komplizierter und dunkle Materie ist immer noch nicht sichtbar</a></li>
<li><a href="../de411143/index.html">Programmierung moderner Mikrocontroller: Vorlesung 1</a></li>
<li><a href="../de411145/index.html">Meine kleinen Relais: Brainfuck Computer ist Realität</a></li>
<li><a href="../de411147/index.html">Riesige Flecken von Riesenplaneten</a></li>
<li><a href="../de411149/index.html">TRIZ-Prognose dezentraler Systeme und der cyber-physischen Gesellschaft von 2035</a></li>
<li><a href="../de411151/index.html">iMX6ULL. Übergang zu Prozessormodulen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>