<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïê üç¨ üëñ Aprenda Metaflow em 10 minutos üéÉ üë™ üë®üèº‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Metaflow √© uma estrutura Python criada na Netflix e focada no campo da Ci√™ncia de Dados. Ou seja, ele foi projetado para criar projetos destinados a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aprenda Metaflow em 10 minutos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/482462/">  O Metaflow √© uma estrutura Python criada na Netflix e focada no campo da Ci√™ncia de Dados.  Ou seja, ele foi projetado para criar projetos destinados a trabalhar com dados e gerenciar tais projetos.  Recentemente, a empresa o transferiu para a categoria de c√≥digo aberto.  A estrutura do Metaflow tem sido amplamente usada na Netflix nos √∫ltimos 2 anos.  Em particular, ele permitiu reduzir significativamente o tempo necess√°rio para a conclus√£o de projetos em produ√ß√£o. <br><br> <a href="https://habr.com/ru/company/ruvds/blog/482462/"><img src="https://habrastorage.org/webt/yd/2j/7p/yd2j7p_dpzkyrjeef9us6a7pgs4.png"></a> <br><br>  O material que estamos traduzindo hoje √© um guia r√°pido para o Metaflow. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">O que √© o Metaflow?</font> </h2><br>  Abaixo est√° um gr√°fico que ilustra a implementa√ß√£o da estrutura Metaflow na Netflix. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6bd/bb8/297/6bdbb82972a098b8fd241f42d7f55b51.png"></div><br>  <i><font color="#999999">Implementa√ß√£o de Metaflow na Netflix</font></i> <br><br>  Em novembro de 2018, esse quadro foi utilizado em 134 projetos da empresa. <br><br>  O Metaflow √© uma estrutura para criar e executar fluxos de trabalho de ci√™ncia de dados.  Possui os seguintes recursos: <br><br><ul><li>  Gerenciamento de recursos de computa√ß√£o. </li><li>  In√≠cio da tarefa em cont√™iner. </li><li>  Gerenciando depend√™ncias externas. </li><li>  Controle de vers√£o, reexecutando tarefas, continuando a execu√ß√£o de tarefas suspensas. </li><li>  API do cliente para examinar os resultados das tarefas que podem ser usadas no ambiente do Jupyter Notebook. </li><li>  Suporte para execu√ß√£o de tarefas locais (por exemplo, em um laptop) e remotas (na nuvem).  Capacidade de alternar entre esses modos. </li></ul><br>  O usu√°rio vtuulos <a href="https://news.ycombinator.com/item%3Fid%3D21698711">escreveu</a> no Ycombinator que o Metaflow pode criar automaticamente snapshots (snapshots) de c√≥digo, dados e depend√™ncias.  Tudo isso √© colocado em um reposit√≥rio com endere√ßamento por conte√∫do, que geralmente √© baseado no S3, embora o sistema de arquivos local tamb√©m seja suportado.  Isso permite que voc√™ continue executando tarefas interrompidas, reproduza resultados obtidos anteriormente e explore tudo relacionado a tarefas, por exemplo, no Jupyter Notebook. <br><br>  Em geral, podemos dizer que o Metaflow visa aumentar a produtividade dos cientistas de dados.  Isso √© feito devido ao fato de a estrutura permitir que eles se envolvam exclusivamente no trabalho com dados, sem se distrair com a resolu√ß√£o de tarefas relacionadas.  Al√©m disso, o Metaflow acelera a retirada de projetos baseados nele na produ√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/311/176/d1631117682028c779664c90bef2a885.png"></div><br>  <i><font color="#999999">As necessidades de um cientista de dados relacionadas √†s suas responsabilidades diretas e a solu√ß√£o de tarefas auxiliares relacionadas √† infraestrutura na qual os c√°lculos s√£o realizados</font></i> <br><br><h2>  <font color="#3AC1EF">Cen√°rios de fluxo de trabalho com Metaflow</font> </h2><br>  Aqui est√£o alguns cen√°rios de fluxo de trabalho que voc√™ pode organizar usando o Metaflow: <br><br><ul><li>  <b>Colabora√ß√£o</b>  Um cientista de dados quer ajudar outro a encontrar a fonte do erro.  Ao mesmo tempo, o assistente gostaria de baixar para o computador todo o ambiente em que a tarefa que falhou funcionava. </li><li>  <b>Continua√ß√£o das tarefas paradas a partir do local em que foram interrompidas.</b>  Algumas tarefas foram interrompidas com um erro (ou foram intencionalmente interrompidas).  O erro foi corrigido (ou o c√≥digo foi editado).  √â necess√°rio reiniciar a tarefa para que seu trabalho continue do local em que falhou (ou foi interrompido). </li><li>  <b>Execu√ß√£o de tarefas h√≠bridas.</b>  Voc√™ precisa executar uma determinada etapa do fluxo de trabalho localmente (talvez seja a etapa de baixar dados de um arquivo armazenado em uma pasta no computador) e outra etapa que exija grandes recursos computacionais (talvez este seja o treinamento do modelo) deve ser executada na nuvem. </li><li>  <b>Exame dos metadados obtidos ap√≥s a conclus√£o de uma tarefa.</b>  Tr√™s dados Os cientistas est√£o envolvidos na sele√ß√£o de hiperpar√¢metros do mesmo modelo, tentando melhorar a precis√£o desse modelo.  Depois disso, √© necess√°rio analisar os resultados da conclus√£o das tarefas de treinamento do modelo e selecionar o conjunto de hiperpar√¢metros que provaram ser os melhores. </li><li>  <b>Usando v√°rias vers√µes do mesmo pacote.</b>  No projeto, voc√™ precisa usar vers√µes diferentes, por exemplo, sklearn libraries.  Durante o pr√©-processamento, sua vers√£o 0.20 √© necess√°ria e, durante a modelagem, a vers√£o 0.22. </li></ul><br><h2>  <font color="#3AC1EF">Fluxo de trabalho t√≠pico do Metaflow</font> </h2><br>  Considere um fluxo de trabalho t√≠pico do Metaflow de uma perspectiva conceitual e de programa√ß√£o. <br><br><h3>  <font color="#3AC1EF">LookVista conceitual do fluxo de trabalho do Metaflow</font> </h3><br>  Do ponto de vista conceitual, os fluxos de trabalho do Metaflow (cadeias de tarefas) s√£o representados por <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BA%25D0%25BB%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D0%25B9_%25D0%25B3%25D1%2580%25D0%25B0%25D1%2584">gr√°ficos ac√≠clicos direcionados</a> (DAGs).  As ilustra√ß√µes abaixo ajudar√£o voc√™ a entender melhor essa ideia. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/584/53d/52e/58453d52e9dfbd50dcc5b974ffae11e1.png"></div><br>  <i><font color="#999999">Gr√°fico ac√≠clico linear</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d7/a8d/810/3d7a8d81017d4112913a5c081c70b9a8.png"></div><br>  <i><font color="#999999">Gr√°fico ac√≠clico com caminhos "paralelos"</font></i> <br><br>  Cada n√≥ do gr√°fico representa uma etapa de processamento de dados no fluxo de trabalho. <br><br>  Em cada etapa da cadeia de tarefas, o Metaflow executa o c√≥digo Python regular sem nenhuma altera√ß√£o especial.  O c√≥digo √© executado em cont√™ineres separados nos quais o c√≥digo √© compactado junto com suas depend√™ncias. <br><br>  Um aspecto fundamental da arquitetura Metaflow √© representado pelo fato de permitir a implementa√ß√£o de quase todas as bibliotecas externas do ecossistema conda em projetos baseados nela, sem o uso de plug-ins.  Isso distingue o Metaflow de outras solu√ß√µes similares de uso geral.  Por exemplo - do Airflow. <br><br><h3>  <font color="#3AC1EF">Flow Fluxo de trabalho do Metaflow em termos de programa√ß√£o</font> </h3><br>  Cada cadeia de tarefas (fluxo) pode ser representada como uma classe Python padr√£o (os nomes dessas classes geralmente t√™m a palavra <code>Flow</code> ) se ela atender aos seguintes requisitos m√≠nimos: <br><br><ul><li>  A classe √© descendente da classe Metaflow <code>FlowSpec</code> . </li><li>  Cada fun√ß√£o que representa uma etapa na cadeia de tarefas tem o decorador <code>@step</code> . </li><li>  No final de cada fun√ß√£o <code>@step</code> , deve haver uma indica√ß√£o de uma fun√ß√£o semelhante que a segue.  Isso pode ser feito usando uma constru√ß√£o desse tipo: <code>self.next(self.function_name_here)</code> . </li><li>  A classe implementa as fun√ß√µes <code>start</code> e <code>end</code> . </li></ul><br>  Considere um exemplo de uma cadeia m√≠nima de tarefas que consiste em tr√™s n√≥s. <br><br>  Seu esquema √© assim: <br><br><pre> <code class="python hljs">start ‚Üí process_message ‚Üí end</code> </pre> <br>  Aqui est√° o c√≥digo dela: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FlowSpec, step <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LinearFlow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlowSpec)</span></span></span><span class="hljs-class">:</span></span>         <span class="hljs-string"><span class="hljs-string">"""     ,      Metaflow.    """</span></span>       <span class="hljs-comment"><span class="hljs-comment">#         @step    def start(self):        self.message = 'Thanks for reading.'        self.next(self.process_message)    @step    def process_message(self):        print('the message is: %s' % self.message)        self.next(self.end)    @step    def end(self):        print('the message is still: %s' % self.message) if __name__ == '__main__':    LinearFlow()</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Instru√ß√µes de instala√ß√£o do Metaflow</font> </h2><br><h3>  <font color="#3AC1EF">RunInstala√ß√£o e teste</font> </h3><br>  Aqui est√° a sequ√™ncia de etapas que voc√™ precisa executar para instalar e iniciar o Metaflow: <br><br><ul><li>  Instale o Metaflow (Python 3 recomendado): <code>pip3 install metaflow</code> . </li><li>  Coloque o fragmento de c√≥digo acima ( <a href="https://gist.github.com/Viveckh/95a3348309b158adba062fa031b753a1">aqui</a> est√° no GitHub) no arquivo <code>linear_flow.py</code> . </li><li>  Para examinar a arquitetura da cadeia de tarefas implementada por este c√≥digo, use o comando <code>python3 linear_flow.py show</code> . </li><li>  Para iniciar o fluxo, execute o <code>python3 linear_flow.py run</code> . </li></ul><br>  Voc√™ deve obter algo semelhante ao mostrado abaixo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/281/5af/ec5/2815afec51573d8a01db3cd8b4ae19e0.png"></div><br>  <i><font color="#999999">Verifica√ß√£o de integridade bem-sucedida do Metaflow</font></i> <br><br>  Aqui vale a pena prestar aten√ß√£o em algumas coisas.  A estrutura do Metaflow cria um <code>.metaflow</code> dados <code>.metaflow</code> local.  L√°, ele armazena todos os metadados relacionados √† execu√ß√£o de tarefas e instant√¢neos associados √†s sess√µes de execu√ß√£o de tarefas.  Se voc√™ definiu as configura√ß√µes do Metaflow relacionadas ao armazenamento de dados na nuvem, os instant√¢neos ser√£o armazenados no AWS S3 Bucket e os metadados relacionados √†s ativa√ß√µes de tarefas ir√£o para o servi√ßo Metadata, com base no RDS (Relational Data Store, Relational Data Store).  Mais tarde, falaremos sobre como explorar esses metadados usando a API do cliente.  Outra ninharia, embora importante, que vale a pena prestar aten√ß√£o, √© que os identificadores de processo (pid, IDs de processo) anexados a diferentes etapas diferem.  Lembre-se - dissemos acima que o Metaflow armazena independentemente cada etapa da cadeia de tarefas e executa cada etapa em seu pr√≥prio ambiente (passando apenas dados entre as etapas). <br><br><h3>  <font color="#3AC1EF">AndInstala√ß√£o e configura√ß√£o do conda (se voc√™ planeja implementar depend√™ncias)</font> </h3><br>  Siga estas etapas para instalar o conda: <br><br><ul><li>  <a href="https://docs.conda.io/en/latest/miniconda.html">Baixe</a> e instale o Miniconda. </li><li>  Adicione <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/concepts/channels.html">um canal conda com o</a> comando <code>conda config --add channels conda-forge</code> . </li></ul><br>  Agora voc√™ est√° pronto para incorporar depend√™ncias conda em suas cadeias de tarefas.  Detalhes deste processo ser√£o discutidos abaixo. <br><br><h2>  <font color="#3AC1EF">Exemplo de fluxo de trabalho realista</font> </h2><br>  Acima, falamos sobre como instalar o Metaflow e como garantir que o sistema esteja operacional.  Al√©m disso, discutimos o b√°sico da arquitetura de fluxo de trabalho e analisamos um exemplo simples.  Aqui, examinamos um exemplo mais complexo, enquanto revelamos alguns dos conceitos do Metaflow. <br><br><h3>  <font color="#3AC1EF">‚ñçJob</font> </h3><br>  Crie um fluxo de trabalho usando o Metaflow que implemente as seguintes fun√ß√µes: <br><br><ul><li>  Carregando dados de filme CSV em um dataframe do Pandas. </li><li>  C√°lculo paralelo de quartis para g√™neros. </li><li>  Salvando um dicion√°rio com os resultados dos c√°lculos. </li></ul><br><h3>  <font color="#3AC1EF">Chain Cadeia de tarefas</font> </h3><br>  O esqueleto da classe <code>GenreStatsFlow</code> √© mostrado <code>GenreStatsFlow</code> .  Ap√≥s analis√°-lo, voc√™ entender√° a ess√™ncia da abordagem implementada aqui para resolver nosso problema. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FlowSpec, step, catch, retry, IncludeFile, Parameter <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenreStatsFlow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlowSpec)</span></span></span><span class="hljs-class">:</span></span>  <span class="hljs-string"><span class="hljs-string">"""    ,  ,   .         :    1)  CSV-   Pandas.    2)     .    3)     .  """</span></span>   @step  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span>    <span class="hljs-string"><span class="hljs-string">"""         :        1)      Pandas.        2)    .        3)        .    """</span></span>       <span class="hljs-comment"><span class="hljs-comment"># </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">  CSV         self.genres = []    self.next(self.compute_statistics, foreach='genres') #  1     @catch(var='compute_failed') #  2  @retry(times=1) #  3  @step  def compute_statistics(self):    """    .   ."""    self.genre = self.input #  4    # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">        self.next(self.join)     @step  def join(self, inputs):    """       ."""    # </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">      self.next(self.end)     @step  def end(self):      """End the flow."""      pass   if __name__ == '__main__':  GenreStatsFlow()</span></span></code> </pre> <br>  Considere algumas partes importantes deste exemplo.  O c√≥digo cont√©m coment√°rios do formul√°rio <code>#  n</code> , ao qual nos referiremos abaixo. <br><br><ul><li>  No <code> 1</code> , na etapa <code>start</code> , preste aten√ß√£o ao par√¢metro <code>foreach</code> .  Gra√ßas a isso, c√≥pias das etapas <code>compute_statistics</code> s√£o <code>compute_statistics</code> em <code>compute_statistics</code> em um <code>for each</code> loop <code>for each</code> entrada na lista de <code>genres</code> . </li><li>  No <code> 2</code> decorador <code>@catch(var='compute_failed')</code> captura qualquer exce√ß√£o que <code>compute_statistics</code> etapa <code>compute_statistics</code> e a grava na vari√°vel <code>compute_failed</code> (pode ser lida na pr√≥xima etapa). </li><li>  No <code> 3</code> decorador <code>@retry(times=1)</code> faz exatamente o que o nome sugere.  Ou seja, quando ocorrem erros, ele repete a etapa. </li><li>  De onde <code>self.input</code> <code> 4</code> , em <code>compute_statistics</code> , <code>self.input</code> ?  A quest√£o √© que <code>input</code> √© uma vari√°vel de classe fornecida pelo Metaflow.  Ele cont√©m dados aplic√°veis ‚Äã‚Äãa uma inst√¢ncia espec√≠fica de <code>compute_statistics</code> (quando h√° v√°rias c√≥pias de uma fun√ß√£o executada em paralelo).  Essa vari√°vel √© adicionada pelo Metaflow somente quando os n√≥s s√£o representados por v√°rios processos paralelos ou quando v√°rios n√≥s s√£o combinados. </li><li>  Aqui est√° um exemplo de como executar a mesma fun√ß√£o em paralelo - <code>compute_statistics</code> .  Mas, se necess√°rio, voc√™ pode executar simultaneamente fun√ß√µes completamente diferentes que n√£o est√£o relacionadas uma √† outra.  Para fazer isso, altere o que √© mostrado no <code> 1</code> para algo como <code>self.next(self.func1, self.function2, self.function3)</code> .  Obviamente, com essa abordagem, ser√° necess√°rio reescrever a etapa de <code>join</code> , possibilitando processar os resultados de v√°rias fun√ß√µes nela. </li></ul><br>  Veja como imaginar a classe de esqueleto acima. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7af/b4b/d00/7afb4bd00f2cea2df0ebf9fff780b8d2.png"></div><br>  <i><font color="#999999">Representa√ß√£o visual da classe GenreStatsFlow</font></i> <br><br><h3>  <font color="#3AC1EF">EadLeia o arquivo de dados e os par√¢metros de transfer√™ncia</font> </h3><br><ul><li>  Fa√ßa <a href="https://www.mediafire.com/file/g9vfu4xxqbs4h2o/movies.csv/file">o</a> download <a href="https://www.mediafire.com/file/g9vfu4xxqbs4h2o/movies.csv/file">deste</a> arquivo CSV do filme. </li><li>  Agora voc√™ precisa equipar o programa com suporte para a possibilidade de transferir dinamicamente o caminho para o arquivo <code>movie_data</code> e o valor <code>max_genres</code> para a <code>max_genres</code> .  O mecanismo de argumentos externos nos ajudar√° nisso.  O Metaflow permite passar argumentos para o programa usando sinalizadores adicionais no comando start do fluxo de trabalho.  Por exemplo, pode ser assim: <code>python3 tutorial_flow.py run --movie_data=path/to/movies.csv --max_genres=5</code> . </li><li>  O Metaflow fornece ao desenvolvedor os objetos <code>IncludeFile</code> e <code>Parameter</code> que permitem ler a entrada no c√≥digo do fluxo de trabalho.  Nos referimos aos argumentos passados ‚Äã‚Äãao atribuir objetos <code>IncludeFile</code> e <code>Parameter</code> a vari√°veis ‚Äã‚Äãde classe.  Depende do que exatamente queremos ler - o arquivo ou o valor usual. </li></ul><br>  Veja como o c√≥digo se parece com a leitura dos par√¢metros passados ‚Äã‚Äãpara o programa quando foi iniciado a partir da linha de comando: <br><br><pre> <code class="python hljs">    movie_data = IncludeFile(<span class="hljs-string"><span class="hljs-string">"movie_data"</span></span>,                             help=<span class="hljs-string"><span class="hljs-string">"The path to a movie metadata file."</span></span>,                             default = <span class="hljs-string"><span class="hljs-string">'movies.csv'</span></span>)                               max_genres = Parameter(<span class="hljs-string"><span class="hljs-string">'max_genres'</span></span>,                help=<span class="hljs-string"><span class="hljs-string">"The max number of genres to return statistics for"</span></span>,                default=<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br><h3>  <font color="#3AC1EF">ClusInclus√£o de conda na cadeia de tarefas</font> </h3><br><ul><li>  Se voc√™ ainda n√£o instalou o conda, consulte a se√ß√£o sobre instala√ß√£o e configura√ß√£o do conda neste artigo. </li><li>  Adicione o decorador <code>GenreStatsFlow</code> fornecido pelo Metaflow √† classe GenreStatsFlow.  Este decorador espera receber a vers√£o python.  Pode ser definido no c√≥digo ou obtido usando uma fun√ß√£o auxiliar.  Abaixo est√° o c√≥digo que demonstra o uso do decorador e mostra uma fun√ß√£o auxiliar. <br><br><pre> <code class="plaintext hljs">def get_python_version():    """     ,    python,       .         conda        python.    """    import platform    versions = {'2' : '2.7.15',                '3' : '3.7.4'}    return versions[platform.python_version_tuple()[0]] #       python. @conda_base(python=get_python_version()) class GenreStatsFlow(FlowSpec):</code> </pre> </li><li>  Agora voc√™ pode adicionar o decorador <code>@conda</code> a qualquer etapa da cadeia de tarefas.  Ele espera um objeto com depend√™ncias, que √© passado a ele atrav√©s do par√¢metro <code>libraries</code> .  O meta-fluxo, antes de iniciar a etapa, assumir√° a tarefa de preparar o cont√™iner com as depend√™ncias especificadas.  Se necess√°rio, voc√™ pode usar com seguran√ßa vers√µes diferentes de pacotes em etapas diferentes, pois o Metaflow inicia cada etapa em um cont√™iner separado. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">    @conda(libraries={'pandas' : '0.24.2'})    @step    def start(self):</span></span></code> </pre> </li><li>  Agora execute o seguinte comando: <code>python3 tutorial_flow.py --environment=conda run</code> . </li></ul><br><h3>  <font color="#3AC1EF">In√≠cio da implementa√ß√£o</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@conda(libraries={'pandas' : '0.24.2'})    @step    def start(self):    """         :        1)      Pandas.        2)    .        3)        .    """        import pandas        from io import StringIO        #      Pandas.        self.dataframe = pandas.read_csv(StringIO(self.movie_data))        #   'genres'      .         #   .        self.genres = {genre for genres \                       in self.dataframe['genres'] \                       for genre in genres.split('|')}        self.genres = list(self.genres)        #        .        #  'foreach'             #          self.next(self.compute_statistics, foreach='genres')</span></span></code> </pre> <br>  Considere alguns dos recursos deste c√≥digo: <br><br><ul><li>  Observe que a express√£o de importa√ß√£o de pandas est√° dentro da fun√ß√£o que descreve a etapa.  O fato √© que essa depend√™ncia √© introduzida pela conda apenas no escopo desta etapa. </li><li>  Mas as vari√°veis ‚Äã‚Äãdeclaradas aqui ( <code>dataframe</code> e <code>genres</code> ) est√£o dispon√≠veis mesmo no c√≥digo das etapas executadas ap√≥s esta etapa.  O ponto √© que o Metaflow funciona com base nos princ√≠pios de separa√ß√£o dos ambientes de execu√ß√£o de c√≥digo, mas permite que os dados se movam naturalmente entre as etapas da cadeia de tarefas. </li></ul><br><h3>  <font color="#3AC1EF">‚ñç Implementa√ß√£o da etapa compute_statistics</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@catch(var='compute_failed')    @retry    @conda(libraries={'pandas' : '0.25.3'})    @step    def compute_statistics(self):        """            .        """        #             # 'input'.        self.genre = self.input        print("Computing statistics for %s" % self.genre)        #         ,         #        .        selector = self.dataframe['genres'].\                   apply(lambda row: self.genre in row)        self.dataframe = self.dataframe[selector]        self.dataframe = self.dataframe[['movie_title', 'genres', 'gross']]        #     gross   .        points = [.25, .5, .75]        self.quartiles = self.dataframe['gross'].quantile(points).values        #  ,    .        self.next(self.join)</span></span></code> </pre> <br>  Observe que nesta etapa nos referimos √† vari√°vel <code>dataframe</code> que foi declarada na etapa <code>start</code> anterior.  Estamos modificando essa vari√°vel.  Ao passar para as pr√≥ximas etapas, essa abordagem, que implica o uso de um novo objeto de <code>dataframe</code> modificado, permite organizar um trabalho eficiente com dados. <br><br><h3>  <font color="#3AC1EF">‚ñç Implementar a etapa de jun√ß√£o</font> </h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@conda(libraries={'pandas' : '0.25.3'})    @step    def join(self, inputs):        """               .        """        inputs = inputs[0:self.max_genres]        #   ,    .        self.genre_stats = {inp.genre.lower(): \                            {'quartiles': inp.quartiles,                             'dataframe': inp.dataframe} \                            for inp in inputs}        self.next(self.end)</span></span></code> </pre> <br>  Aqui vale destacar alguns pontos: <br><br><ul><li>  Nesta etapa, usamos uma vers√£o completamente diferente da biblioteca de pandas. </li><li>  Cada elemento na matriz de <code>inputs</code> √© uma c√≥pia dos <code>compute_statistics</code> executados anteriormente.  Ele cont√©m o estado da fun√ß√£o correspondente executada, ou seja, os valores de v√°rias vari√°veis.  Assim, a <code>input[0].quartiles</code> pode conter quartis para o g√™nero de <code>comedy</code> , e a <code>input[1].quartiles</code> <code>input[0].quartiles</code> pode conter quartis para o g√™nero de <code>sci-fi</code> . </li></ul><br><h3>  <font color="#3AC1EF">Draft Rascunho pronto</font> </h3><br>  O c√≥digo completo do projeto que acabamos de revisar pode ser encontrado <a href="https://github.com/Viveckh/metaflow_crash_course_prep/blob/master/tutorial_flow.py">aqui</a> . <br><br>  Para examinar como o fluxo de trabalho descrito no arquivo <code>tutorial_flow.py</code> , voc√™ precisa executar o seguinte comando: <br><br><pre> <code class="python hljs">python3 tutorial_flow.py --environment=conda show</code> </pre> <br>  Use o seguinte comando para iniciar o fluxo de trabalho: <br><br><pre> <code class="python hljs">python3 tutorial_flow.py --environment=conda run --movie_data=path/to/movies.csv --max_genres=<span class="hljs-number"><span class="hljs-number">7</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Examinando os resultados da execu√ß√£o de um fluxo de trabalho usando a API do cliente</font> </h2><br>  Para examinar instant√¢neos de dados e o status de lan√ßamentos anteriores do fluxo de trabalho, voc√™ pode usar a <a href="https://docs.metaflow.org/metaflow/client">API</a> do cliente fornecida pelo Metaflow.  Essa API √© ideal para explorar os detalhes de experimentos realizados no ambiente do Jupyter Notebook. <br><br>  Aqui est√° um exemplo simples da sa√≠da da vari√°vel <code>genre_stats</code> , extra√≠da dos dados do √∫ltimo lan√ßamento bem-sucedido do <code>GenreStatsFlow</code> . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> metaflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flow, get_metadata <span class="hljs-comment"><span class="hljs-comment">#      print("Using metadata provider: %s" % get_metadata()) #     MovieStatsFlow. run = Flow('GenreStatsFlow').latest_successful_run print("Using analysis from '%s'" % str(run)) genre_stats = run.data.genre_stats print(genre_stats)</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Executando fluxos de trabalho na nuvem</font> </h2><br>  Depois de criar e testar o fluxo de trabalho em um computador comum, √© muito prov√°vel que voc√™ queira executar o c√≥digo na nuvem para acelerar o trabalho. <br><br>  Atualmente, o Metaflow suporta apenas a integra√ß√£o com a AWS.  Na imagem a seguir, voc√™ pode ver um mapeamento dos recursos locais e de nuvem usados ‚Äã‚Äãpelo Metaflow. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08a/acc/458/08aacc458fc3202ec08624422bef0cb4.png"></div><br>  <i><font color="#999999">Metaflow e integra√ß√£o da AWS</font></i> <br><br>  Para conectar o Metaflow √† AWS, voc√™ deve concluir as seguintes etapas: <br><br><ul><li>  Primeiro, voc√™ precisa fazer uma configura√ß√£o √∫nica da AWS, criando recursos com os quais o Metaflow pode trabalhar.  Os mesmos recursos podem ser usados, por exemplo, por membros de uma equipe de trabalho que demonstram entre si os resultados dos fluxos de trabalho.  <a href="https://docs.metaflow.org/metaflow-on-aws/deploy-to-aws">Voc√™</a> pode encontrar instru√ß√µes relevantes aqui.  As configura√ß√µes s√£o r√°pidas o suficiente, porque o Metaflow possui um modelo de configura√ß√µes do CloudFormation. </li><li>  Em seguida, no computador local, voc√™ precisa executar o <code>metaflow configure aws</code> e inserir respostas para as perguntas do sistema.  Com esses dados, o Metaflow poder√° usar data warehouses baseados em nuvem. </li><li>  Agora, para iniciar fluxos de trabalho locais na nuvem, adicione a chave <code>--with batch</code> ao <code>--with batch</code> start do fluxo de trabalho.  Por exemplo, pode ser assim: <code>python3 sample_flow.py run --with batch</code> . </li><li>  Para executar uma inicializa√ß√£o h√≠brida do fluxo de trabalho, ou seja, para executar algumas etapas localmente e outras na nuvem, voc√™ precisa adicionar o decorador do <code>@batch</code> √†s etapas que precisam ser executadas na nuvem.  Por exemplo, assim: <code>@batch(cpu=1, memory=500)</code> . </li></ul><br><h2>  <font color="#3AC1EF">Sum√°rio</font> </h2><br>  Aqui, gostaria de observar alguns recursos do Metaflow que podem ser considerados as vantagens e desvantagens dessa estrutura: <br><br><ul><li>  O Metaflow est√° totalmente integrado √† AWS.  Por√©m, nos planos de desenvolvimento da estrutura, h√° suporte para um n√∫mero maior de provedores de nuvem. </li><li>  Metaflow √© uma ferramenta que suporta apenas a interface da linha de comandos.  Ele n√£o possui uma interface gr√°fica (diferente de outras estruturas universais para organizar processos de trabalho, como o Airflow). </li></ul><br>  <b>Caros leitores!</b>  Voc√™ planeja usar o Metaflow? <br><br> <a href="https://ruvds.com/ru-rub/"><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt482462/">https://habr.com/ru/post/pt482462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt482442/index.html">A maior tecnologia falha em 2019</a></li>
<li><a href="../pt482450/index.html">O MVP se tornou um produto ou minha experi√™ncia com o MVP em 2019</a></li>
<li><a href="../pt482452/index.html">O sistema brasileiro n√£o √© um mito. Como usar em TI?</a></li>
<li><a href="../pt482456/index.html">Nosso FunCode ou Como realizamos um concurso para desenvolvedores do iOS</a></li>
<li><a href="../pt482460/index.html">HowTo SQL: desenhar padr√µes gelados no SQL</a></li>
<li><a href="../pt482464/index.html">O que s√£o * args e ** kwargs em Python?</a></li>
<li><a href="../pt482466/index.html">5 coisas que voc√™ pode fazer para se preparar para o Vue 3.0</a></li>
<li><a href="../pt482468/index.html">5 extens√µes e temas para o VS Code que podem mudar a vida de um desenvolvedor front-end</a></li>
<li><a href="../pt482470/index.html">Carregamento r√°pido de p√°ginas nos telefones baratos mais simples</a></li>
<li><a href="../pt482472/index.html">De que √© feito o JavaScript?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>