<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëºüèº üëÖ ‚ôãÔ∏è Execute scripts PHP via php-fpm sem um servidor web. Ou seu cliente FastCGI (sob o cap√¥) üóìÔ∏è ü§∏üèø üë©üèΩ‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Congratulo-me com todos os leitores de "Habr". 
 Isen√ß√£o de responsabilidade 


 O artigo acabou sendo bastante longo e, para aqueles que n√£o querem l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Execute scripts PHP via php-fpm sem um servidor web. Ou seu cliente FastCGI (sob o cap√¥)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472190/"><p>  Congratulo-me com todos os leitores de "Habr". </p><br><h4 id="diskleymer">  Isen√ß√£o de responsabilidade </h4><br><p>  O artigo acabou sendo bastante longo e, para aqueles que n√£o querem ler os antecedentes, mas querem ir direto ao ponto, pe√ßo-lhe diretamente no cap√≠tulo "Solu√ß√£o". </p><br><h3 id="vstuplenie">  Entrada </h3><br><p>  Neste artigo, gostaria de falar sobre a solu√ß√£o de um problema n√£o padronizado que tive que enfrentar durante o processo de trabalho.  Ou seja, precis√°vamos executar v√°rios scripts php em um loop.  N√£o discutirei os motivos e controv√©rsias de uma solu√ß√£o arquitet√¥nica nesse artigo, porque  na verdade, n√£o era nada disso, era apenas uma tarefa, tinha que ser resolvida e a solu√ß√£o parecia interessante o suficiente para eu compartilhar com voc√™, tanto mais que n√£o encontrei nenhuma mana sobre esse assunto na Internet (bem, √© claro, exceto as especifica√ß√µes oficiais).  Speck, √© claro, √© bom, e √© claro que tudo est√° neles, mas acho que voc√™ concorda que, se voc√™ n√£o estiver particularmente familiarizado com o t√≥pico, e mesmo limitado no tempo, entend√™-lo ainda √© um prazer. </p><a name="habracut"></a><br><h3 id="dlya-kogo-eta-statya">  Para quem √© este artigo? </h3><br><p>  Para quem trabalha com a web e com o protocolo <strong>FastCgi</strong> , <strong>apenas</strong> sabe que esse √© o protocolo segundo o qual o servidor da web executa scripts php, mas deseja estud√°-lo com mais detalhes e olhar sob o cap√¥. </p><br><h3 id="obosnovanie-zachem-eta-statya">  Justifica√ß√£o (por que este artigo) </h3><br><p>  Em geral, como escrevi acima, quando nos deparamos com a necessidade de executar muitos scripts php sem a participa√ß√£o de um servidor web (grosso modo, de outro script php), a primeira coisa que veio √† mente √© ... </p><br><pre><code class="php hljs">shell_exec(<span class="hljs-string"><span class="hljs-string">'php \path\to\script.php'</span></span>)</code> </pre> <br><p>  Por√©m, no in√≠cio de cada script, um ambiente ser√° criado, um processo separado ser√° lan√ßado; em geral, parecia de alguma forma caro para recursos.  Esta implementa√ß√£o foi rejeitada.  A segunda coisa que veio √† mente √©, obviamente, o <strong>php-fpm</strong> , √© t√£o legal que s√≥ inicia o ambiente uma vez, monitora a mem√≥ria, registra tudo corretamente, inicia e interrompe scripts, em geral tudo fica legal e, √© claro, gostamos dessa maneira mais </p><br><p>  Mas √© azar, em teoria, sab√≠amos como funciona, em termos gerais (como se mostrou muito geral), mas acabou sendo muito dif√≠cil implementar esse protocolo na pr√°tica sem a participa√ß√£o de um servidor da web.  A leitura das especifica√ß√µes e algumas horas de tentativas frustradas mostraram que levaria tempo para implementar, o que n√£o t√≠nhamos naquele momento.  N√£o h√° mana para a implementa√ß√£o desse empreendimento, no qual essa intera√ß√£o possa ser descrita de maneira simples e clara, tamb√©m n√£o poder√≠amos tirar nenhuma especifica√ß√£o, das solu√ß√µes prontas que encontramos um script Python e uma lib Pykhov no github, que no final n√£o queriam ser arrastadas para o meu projeto (talvez n√£o est√° correto, mas na verdade n√£o, n√≥s amamos todos os tipos de bibliotecas de terceiros e at√© mesmo n√£o muito populares e, portanto, n√£o testadas).  Em geral, como resultado dessa id√©ia, recusamos e implementamos tudo isso atrav√©s do bom e velho rabbitmq. </p><br><p>  Embora o problema finalmente tenha sido resolvido, eu ainda decidi entender o FastCgi em detalhes e, al√©m disso, decidi escrever um artigo sobre ele, que descrever√° de maneira simples e detalhada como fazer com que o <strong>php-fpm</strong> execute um script php sem um servidor da Web, ou melhor, como o servidor web ter√° um script diferente, ent√£o chamarei de cliente Fcgi.  Em geral, espero que este artigo ajude aqueles que enfrentam a mesma tarefa que n√≥s e, ap√≥s a leitura, seja capaz de escrever rapidamente tudo o que precisar. </p><br><h3 id="tvorcheskiy-poisk-lozhnyy-put">  Pesquisa de criativos (caminho falso) </h3><br><p>  Portanto, o problema √© indicado, devemos prosseguir para a solu√ß√£o.  Naturalmente, como qualquer programador "normal", para resolver um problema sobre o qual n√£o est√° escrito em nenhum lugar o que fazer e o que inserir no console, n√£o li e traduzi a especifica√ß√£o, mas imediatamente criei minha pr√≥pria solu√ß√£o "brilhante".  Sua ess√™ncia √© a seguinte: eu sei que o <strong>nginx</strong> (usamos o nginx e para n√£o escrever mais <strong>coisas tolas</strong> - um servidor web, escreverei o nginx, pois √© mais simp√°tico) transfere algo para o <strong>php-fpm</strong> , ele <strong>tamb√©m</strong> processa o <strong>php-fpm</strong> para ele executa um script com base nisso, bem, tudo parece simples, eu pego e prometo que transmite <strong>nginx</strong> e passarei a mesma coisa. </p><br><p>  O √≥timo <strong>netcat</strong> ajudar√° aqui (utilit√°rio UNIX para trabalhar com tr√°fego de rede, que na minha opini√£o pode fazer quase qualquer coisa).  Ent√£o, configuramos o <strong>netcat</strong> para escutar na porta local e configuramos o <strong>nginx</strong> para trabalhar com arquivos php atrav√©s do soquete (naturalmente, o soquete na mesma porta em que o <strong>netcat</strong> escuta) </p><br><p>  ouvindo a porta 9000 </p><br><pre> <code class="plaintext hljs">nc -l 9000</code> </pre> <br><p>  Voc√™ pode verificar se est√° tudo bem, pode entrar em contato com o endere√ßo 127.0.0.1:9000 atrav√©s de um navegador e a imagem a seguir deve ser </p><br><img src="https://habrastorage.org/webt/ux/9s/_f/ux9s_fkir12e0yn3arj010nnezw.png"><br><p>  configure o <strong>nginx</strong> para que ele processe scripts php atrav√©s de um soquete na porta 9000 (nas configura√ß√µes '/ etc / nginx / sites-available / default', √© claro, eles podem ser diferentes) </p><br><pre> <code class="plaintext hljs">location ~ \.php$ { include snippets/fastcgi-php.conf; fastcgi_pass 127.0.0.1:9000; }</code> </pre><br><p>  Ap√≥s essas manipula√ß√µes, verificaremos o que aconteceu entrando em contato com o script php atrav√©s do navegador </p><br><img src="https://habrastorage.org/webt/u_/hf/j1/u_hfj1xa4tnqyb35rdmfu5nf-na.png"><br><p>  Pode-se observar que o <strong>nginx</strong> enviou vari√°veis ‚Äã‚Äãde ambiente e caracteres n√£o imprim√≠veis, ou seja, os dados foram transmitidos em codifica√ß√£o bin√°ria, o que significa que eles n√£o podem ser t√£o facilmente copiados e enviados para o <strong>soquete php-fpm</strong> .  Se voc√™ salv√°-los em um arquivo, por exemplo, eles ser√£o salvos em codifica√ß√£o hexadecimal, ser√° a seguinte: </p><br><img src="https://habrastorage.org/webt/le/7e/9y/le7e9ycpkn8n3mezj7ksa9xhkki.png"><br><p>  Mas isso tamb√©m n√£o nos d√° muito, provavelmente puramente teoricamente eles podem ser convertidos em codifica√ß√£o bin√°ria, de alguma forma (eu nem imagino como) envi√°-los para o soquete de fpm, e h√° ainda a chance de que toda essa bicicleta funcione de alguma forma e at√© inicie algum tipo de um script, mas de alguma forma √© tudo feio e estranho. </p><br><p>  Ficou claro que esse caminho estava completamente errado, voc√™ pode ver por si mesmo como tudo isso parece miser√°vel e, mais ainda, todas essas a√ß√µes n√£o nos permitem controlar a conex√£o, nem nos aproximam da compreens√£o da intera√ß√£o entre <strong>php-fpm</strong> e <strong>nginx</strong> . </p><br><p>  Tudo se foi, a especifica√ß√£o n√£o pode ser evitada! </p><br><h3 id="reshenie-tut-sobstvenno-nachinaetsya-vsya-sol-dannoy-stati">  Solu√ß√£o (aqui todo o sal deste artigo realmente come√ßa) </h3><br><h4 id="teoreticheskaya-podgotovka">  Treinamento te√≥rico </h4><br><p>  Vamos agora considerar como existe uma conex√£o e troca de dados entre <strong>nginx</strong> e <strong>php-fpm</strong> .  Um pouco de teoria, toda a comunica√ß√£o ocorre como j√° est√° clara atrav√©s dos soquetes; consideraremos ainda mais especificamente uma conex√£o atrav√©s de um soquete TCP. </p><br><p>  A unidade de informa√ß√£o no protocolo <strong>FastCgi</strong> √© um <strong>registro cgi</strong> .  O servidor envia esses registros para o aplicativo e recebe exatamente os mesmos registros em resposta. </p><br><h5 id="nemnogo-teorii-struktury">  Um pouco de teoria (estrutura) </h5><br><p>  Em seguida, considere a estrutura do registro.  Para entender em que consiste um registro, voc√™ precisa entender como s√£o as estruturas C e entender suas designa√ß√µes.  Para aqueles que n√£o sabem mais, isso ser√° descrito brevemente (mas o suficiente para a compreens√£o).  Vou tentar descrever da maneira mais simples poss√≠vel, √© in√∫til entrar em detalhes aqui e tenho medo de ficar confuso com os detalhes. O principal √© ter um entendimento comum. </p><br><p>  Estruturas s√£o simplesmente uma cole√ß√£o de bytes, e uma nota√ß√£o para elas permite que sejam interpretadas.  Ou seja, voc√™ s√≥ tem uma sequ√™ncia de zeros e uns, e alguns dados s√£o criptografados nessa sequ√™ncia, mas at√© agora voc√™ n√£o tem anota√ß√£o para essa sequ√™ncia, esses dados n√£o representam nenhum valor para voc√™, porque  voc√™ n√£o pode interpret√°-los. </p><br><pre> <code class="plaintext hljs">//     1101111000000010010110000010011100010000</code> </pre> <br><p>  O que √© vis√≠vel aqui, temos alguns bits, que tipo de bits n√£o temos id√©ia.  Bem, vamos tentar, por exemplo, dividi-los em bytes e representar no sistema decimal </p><br><pre> <code class="plaintext hljs">//   5  11011110 00000010 01011000 00100111 00010000 //    222 2 88 39 16</code> </pre> <br><p>  Bem, n√≥s os interpretamos e obtivemos alguns resultados, digamos que esses dados sejam respons√°veis ‚Äã‚Äãpelo quanto um determinado apartamento deve pela eletricidade.  Acontece que na casa 222 o apartamento n√∫mero 2 deve pagar 88 rublos.  E o que mais para dois d√≠gitos, o que fazer com eles apenas para soltar?  Claro que n√£o!  o fato √© que n√£o possu√≠amos uma nota√ß√£o (formato) que nos diria como interpretar os dados e interpret√°-los √† nossa maneira, nesse sentido, recebemos n√£o apenas resultados in√∫teis, mas tamb√©m prejudiciais.  Como resultado, o apartamento 2 n√£o pagou absolutamente o que deveria ter.  (os exemplos certamente s√£o absurdos e servem apenas para explicar mais claramente a situa√ß√£o) </p><br><p>  Agora vamos ver como devemos interpretar esses dados corretamente, tendo uma nota√ß√£o (formato).  Al√©m disso, chamarei uma p√° de p√°, nomeadamente nota√ß√£o = formato ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui formatos</a> ). </p><br><pre> <code class="plaintext hljs">//  "Cnn" //  //C -   (char) (8 ) //n -  short (16 ) //      11011110 0000001001011000 0010011100010000 //    222 600 10000</code> </pre> <br><p>  Agora, tudo converge na casa n¬∫ 222, apartamento 600, para eletricidade, deve ser de 1000 rublos.Eu acho que agora a import√¢ncia do formato √© clara, e agora est√° claro a apar√™ncia de uma estrutura semelhante.  (preste aten√ß√£o, aqui o objetivo n√£o √© explicar em detalhes o que s√£o essas estruturas, mas fornecer uma compreens√£o geral do que √© e como funciona) </p><br><p>  O s√≠mbolo dessa estrutura ser√° </p><br><pre> <code class="plaintext hljs">struct { unsigned char houseNumber; unsigned char flatNumperA1; unsigned char flatNumperA2; unsigned char summB1; unsigned char summB2; }; // ,           // houseNumber -  // flatNumperA1 &amp;&amp; flatNumperA2 -  // summB1 &amp;&amp; summB2 -  </code> </pre> <br><h5 id="esche-nemnogo-teorii-fastcgi-zapisi">  Um pouco mais de teoria (entradas do FastCgi) </h5><br><p>  Como eu disse acima, a unidade de informa√ß√£o no protocolo FastCgi √© registros.  O servidor envia os registros para o aplicativo e recebe os mesmos registros em resposta.  Um registro consiste em um cabe√ßalho e um corpo com dados. </p><br><p>  Estrutura do cabe√ßalho: </p><br><ol><li>  A vers√£o do protocolo (sempre 1) √© indicada por 1 byte ('C') </li><li>  tipo de registro.  Para abrir, fechar a conex√£o, etc. N√£o considerarei tudo, considerarei apenas o que √© necess√°rio para uma tarefa espec√≠fica; se forem necess√°rios outros, d√™ as boas-vindas √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">especifica√ß√£o</a> aqui.  √â indicado por 1 byte ('C'). </li><li>  O ID da solicita√ß√£o, um n√∫mero arbitr√°rio, √© indicado por 2 bytes ('n') </li><li>  o comprimento do corpo do registro (dados), indicado por 2 bytes ('n') </li><li>  o comprimento dos dados de alinhamento e dos dados reservados, um byte cada (n√£o h√° necessidade de prestar aten√ß√£o especial para n√£o se distrair do principal no nosso caso, sempre haver√° 0) </li></ol><br><p>  Em seguida √© o corpo do registro: </p><br><ol><li>  os dados em si (aqui s√£o precisamente as vari√°veis ‚Äã‚Äãtransferidas) podem ser bastante grandes (at√© 65535 bytes) </li></ol><br><p>  Aqui est√° um exemplo do registro bin√°rio FastCgi mais simples com formato </p><br><pre> <code class="plaintext hljs">struct { // unsigned char version; unsigned char type; unsigned char idA1; unsigned char idA2; unsigned char bodyLengthB1; unsigned char bodyLengthB2; unsigned char paddingLength; unsigned char reserved; //  unsigned char contentData; // 65535  unsigned char paddingData; };</code> </pre> <br><h4 id="praktika">  Pr√°tica </h4><br><h5 id="skript-klient-i-peredayuschiy-soket">  Cliente de script e soquete de transmiss√£o </h5><br><p>  Para transfer√™ncia de dados, usaremos a extens√£o de soquete php padr√£o.  E a primeira coisa que precisa ser feita √© configurar o <strong>php-fpm</strong> para escutar na porta no host local, por exemplo, 9000. Isso √© feito na maioria dos casos no arquivo '/etc/php/7.3/fpm/pool.d/www.conf', o caminho do curso Depende das configura√ß√µes do seu sistema.  L√° voc√™ precisa registrar algo como o seguinte (trago todo o cal√ßado para que voc√™ possa navegar, a se√ß√£o principal √© ouvir aqui) </p><br><pre> <code class="plaintext hljs">; The address on which to accept FastCGI requests. ; Valid syntaxes are: ; 'ip.add.re.ss:port' - to listen on a TCP socket to a specific IPv4 address on ; a specific port; ; '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on ; a specific port; ; 'port' - to listen on a TCP socket to all addresses ; (IPv6 and IPv4-mapped) on a specific port; ; '/path/to/unix/socket' - to listen on a unix socket. ; Note: This value is mandatory. ;listen = /run/php/php7.3-fpm.sock listen = 127.0.0.1:9002</code> </pre> <br><p>  Ap√≥s configurar o fpm, o pr√≥ximo passo √© conectar ao soquete </p><br><pre> <code class="php hljs">$service_port = <span class="hljs-number"><span class="hljs-number">9000</span></span>; $address = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>; $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); $result = socket_connect($socket, $address, $service_port);</code> </pre> <br><h4 id="nachalo-zaprosa-fcgi_begin_request">  In√≠cio da solicita√ß√£o FCGI_BEGIN_REQUEST </h4><br><p>  Para abrir uma conex√£o, devemos enviar uma entrada com o tipo FCGI_BEGIN_REQUEST = 1 O t√≠tulo da entrada ser√° assim (para converter os valores num√©ricos em uma sequ√™ncia bin√°ria com o formato especificado, ser√° utilizado o php function pack ()) </p><br><pre> <code class="php hljs">socket_write($socket, pack(<span class="hljs-string"><span class="hljs-string">'CCnnCx'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//  - 1 //  - 1 - FCGI_BEGIN_REQUEST //id - 1 //   - 8  // - 0</span></span></code> </pre> <br><p>  O corpo de grava√ß√£o para abrir uma conex√£o deve conter uma fun√ß√£o de grava√ß√£o e um sinalizador que controle a conex√£o </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//      //struct { // unsigned char roleB1; // unsigned char roleB0; // unsigned char flags; // unsigned char reserved[5]; //}; //php  socket_write($socket, pack('nCxxxxx', 1, 0)); // - 1 -  // - 1 -    1   </span></span></code> </pre> <br><p>  Portanto, o registro para abrir a conex√£o foi enviado com sucesso, o <strong>php-fpm</strong> aceitar√° e continuar√° esperando de n√≥s um registro adicional no qual precisamos transferir dados para implantar o ambiente e executar o script. </p><br><h4 id="peredacha-parametrov-okruzheniya-fcgi_params">  Passando par√¢metros de ambiente FCGI_PARAMS </h4><br><p>  Nesse registro, passaremos todos os par√¢metros necess√°rios para implantar o ambiente, bem como o nome do script que precisaremos executar. </p><br><p>  Configura√ß√µes de ambiente m√≠nimas necess√°rias </p><br><pre> <code class="php hljs">$url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span> $env = [ <span class="hljs-string"><span class="hljs-string">'REQUEST_METHOD'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'SCRIPT_FILENAME'</span></span> =&gt; $url, ];</code> </pre> <br><p>  A primeira coisa que precisamos fazer aqui √© preparar as vari√°veis ‚Äã‚Äãnecess√°rias, ou seja, os pares nome =&gt; valor que passaremos para o aplicativo. </p><br><p>  A estrutura do valor do nome dos pares ser√° tal </p><br><pre> <code class="plaintext hljs">//          128  typedef struct { unsigned char nameLength; unsigned char valueLength; unsigned char nameData unsigned char valueData; }; //    1 </code> </pre> <br><p>  H√° 1 byte primeiro - o nome √© longo e, em seguida, 1 byte √© o valor </p><br><pre> <code class="plaintext hljs">//         128  typedef struct { unsigned char nameLengthA1; unsigned char nameLengthA2; unsigned char nameLengthA3; unsigned char nameLengthA4; unsigned char valueLengthB1; unsigned char valueLengthB2; unsigned char valueLengthB3; unsigned char valueLengthB4; unsigned char nameData unsigned char valueData; }; //    4 </code> </pre> <br><p>  No nosso caso, tanto o nome quanto o significado s√£o curtos e se encaixam na primeira op√ß√£o; portanto, consideraremos isso. </p><br><p>  Codifique nossas vari√°veis ‚Äã‚Äãde acordo com o formato </p><br><pre> <code class="php hljs">$keyValueFcgiString = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($env <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-comment"><span class="hljs-comment">//        //  128         $keyLen = strlen($key); $lenKeyChar = $keyLen &lt; 128 ? chr($keyLen) : pack('N', $keyLen); $valLen = strlen($value); $valLenChar = $valLen &lt; 128 ? chr($valLen) : pack('N', $valLen); $keyValueFcgiString .= $lenKeyChar . $valLenChar . $key . $value; }</span></span></code> </pre> <br><p>  Aqui, valores menores que 128 bits s√£o codificados pela fun√ß√£o <em>chr ($ keyLen)</em> , mais que <em>pack ('N', $ valLen)</em> , onde 'N' representa 4 bytes.  E ent√£o tudo isso fica preso em uma linha, de acordo com o formato da estrutura.  O corpo da grava√ß√£o est√° pronto. </p><br><p>  No cabe√ßalho do registro, transferimos tudo da mesma forma que no registro anterior, exceto o tipo (ser√° FCGI_PARAMS = 4) e o comprimento dos dados (ser√° igual ao comprimento dos pares name =&gt; value ou o comprimento da string $ keyValueFcgiString que formamos anteriormente). </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  socket_write($socket, pack('CCnnCx', 1, 4, 1, strlen($keyValueFcgiString), 0)); // body socket_write($socket, $keyValueFcgiString); //             //  body socket_write($socket, pack('CCnnCx', 1, 4, 1, 0, 0));</span></span></code> </pre> <br><h4 id="poluchenie-otveta-fcgi_params">  Obtendo uma resposta de FCGI_PARAMS </h4><br><p>  Na verdade, depois que todo o anterior foi feito e tudo o que ele espera foi enviado para o aplicativo, ele come√ßa a funcionar e s√≥ podemos tirar o resultado desse trabalho do soquete. <br>  Lembre-se de que, em resposta, obtemos as mesmas notas e tamb√©m precisamos interpret√°-las. </p><br><p>  Obtemos o cabe√ßalho, s√£o sempre 8 bytes (receberemos dados por byte) </p><br><pre> <code class="php hljs">$buf = <span class="hljs-string"><span class="hljs-string">''</span></span>; $arrData = []; $len = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($len) { socket_recv($socket, $buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, MSG_WAITALL); <span class="hljs-comment"><span class="hljs-comment">//   1       $arrData[] = $buf; $len--; } //      'CCnnCx' $protocol = unpack('C', $arrData[0]); $type = unpack('C', $arrData[1]); $id = unpack('n', $arrData[2] . $arrData[3]); $dataLen = unpack('n', $arrData[4] . $arrData[5])[1]; //   ,        (unpack  ,    ) $foo = unpack('C', $arrData[6]); var_dump($dataLen); //     </span></span></code> </pre> <br><p>  Agora, de acordo com o comprimento do corpo da resposta recebida, faremos outra leitura no soquete </p><br><pre> <code class="php hljs">$buf2 = <span class="hljs-string"><span class="hljs-string">''</span></span>; $result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($dataLen) { socket_recv($socket, $buf2, <span class="hljs-number"><span class="hljs-number">1</span></span>, MSG_WAITALL); $result[] = $buf2; $dataLen--; } var_dump(implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, $result)); <span class="hljs-comment"><span class="hljs-comment">//       socket_close($socket);</span></span></code> </pre> <br><p>  Viva, funcionou!  Finalmente isso! <br>  O que temos na resposta, se por exemplo neste arquivo </p><br><pre> <code class="php hljs">$url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span> <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>  vamos escrever </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"My fcgi script"</span></span>;</code> </pre> <br><p>  ent√£o na resposta que obtemos como resultado </p><br><p><img src="https://habrastorage.org/webt/dq/pc/ox/dqpcox1zbmcutdzxxeh69i_hbsc.png" alt="imagem"></p><br><h3 id="itogi">  Sum√°rio </h3><br><p>  N√£o vou escrever muito aqui, ent√£o o longo artigo acabou.  Espero que ela ajude algu√©m.  E eu darei o script final, ele acabou sendo bem pequeno.  Obviamente, ele pode fazer um pouco dessa forma, e ele n√£o tem tratamento de erros e tudo isso, mas ele n√£o precisa, ele precisa dele como um exemplo para mostrar o b√°sico. </p><br><div class="spoiler">  <b class="spoiler_title">Vers√£o completa do script</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span>; $env = [ <span class="hljs-string"><span class="hljs-string">'REQUEST_METHOD'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'SCRIPT_FILENAME'</span></span> =&gt; $url, ]; $service_port = <span class="hljs-number"><span class="hljs-number">9000</span></span>; $address = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>; $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); $result = socket_connect($socket, $address, $service_port); <span class="hljs-comment"><span class="hljs-comment">//  //     php-fpm //    ,   (    ), id ,   ,     socket_write($socket, pack('CCnnCx', 1, 1, 1, 8, 0)); //     // ,     socket_write($socket, pack('nCxxxxx', 1, 0)); $keyValueFcgiString = ''; foreach ($env as $key =&gt; $value) { //        //  128         $keyLen = strlen($key); $lenKeyChar = $keyLen &lt; 128 ? chr($keyLen) : pack('N', $keyLen); $valLen = strlen($value); $valLenChar = $valLen &lt; 128 ? chr($valLen) : pack('N', $valLen); $keyValueFcgiString .= $lenKeyChar . $valLenChar . $key . $value; } // ,      php-fpm           //      //1- ( ), 4-  (,    - FCGI_PARAMS), id  ( ),    (   -),     socket_write($socket, pack('CCnnCx', 1, 4, 1, strlen($keyValueFcgiString), 0)); //      socket_write($socket, $keyValueFcgiString); //  socket_write($socket, pack('CCnnCx', 1, 4, 1, 0, 0)); $buf = ''; $arrData = []; $len = 8; while ($len) { socket_recv($socket, $buf, 1, MSG_WAITALL); //   1       $arrData[] = $buf; $len--; } //      'CCnnCx' $protocol = unpack('C', $arrData[0]); $type = unpack('C', $arrData[1]); $id = unpack('n', $arrData[2] . $arrData[3]); $dataLen = unpack('n', $arrData[4] . $arrData[5])[1]; //   ,        (unpack  ,    ) $foo = unpack('C', $arrData[6]); $buf2 = ''; $result = []; while ($dataLen) { socket_recv($socket, $buf2, 1, MSG_WAITALL); $result[] = $buf2; $dataLen--; } var_dump(implode('', $result)); //       socket_close($socket);</span></span></code> </pre></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472190/">https://habr.com/ru/post/pt472190/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472178/index.html">Holivar. Hist√≥ria do Runet. Parte 7. YouTube: comediantes, guinchos e Vale do Sil√≠cio</a></li>
<li><a href="../pt472182/index.html">An√∫ncio do .NET Core 3.1 Preview 1</a></li>
<li><a href="../pt472184/index.html">SSH remoto: dicas e truques</a></li>
<li><a href="../pt472186/index.html">Princ√≠pio aberto-fechado</a></li>
<li><a href="../pt472188/index.html">O que voc√™ precisa saber sobre a Verifica√ß√£o de cheque na App Store (recibo da App Store)</a></li>
<li><a href="../pt472196/index.html">"A√ß√∫car" caseiro para um projeto Android ou "Como n√£o fazer"</a></li>
<li><a href="../pt472198/index.html">Localiza√ß√£o de mensagens push em aplicativos m√≥veis</a></li>
<li><a href="../pt472200/index.html">Moderniza√ß√£o da aula de ci√™ncia da computa√ß√£o em uma escola russa de framboesa: barato e alegre</a></li>
<li><a href="../pt472202/index.html">Windows 10 + Python = c√≥digo VS + WSL</a></li>
<li><a href="../pt472204/index.html">Experimentos simples com o microcontrolador STM32F103 (Blue Tablet)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>