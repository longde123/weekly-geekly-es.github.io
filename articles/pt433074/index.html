<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¨ üö• ‚òØÔ∏è Mudando para o Kotlin em um projeto Android: Dicas e Truques ü•ì üëµüèª üë©üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Publicado por Sergey Yeshin, Desenvolvedor Strong Middle Android, DataArt 

 Mais de um ano e meio se passaram desde que o Google anunciou o suporte o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mudando para o Kotlin em um projeto Android: Dicas e Truques</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataart/blog/433074/"><img src="https://habrastorage.org/webt/ss/no/sd/ssnosdopahysny9zaa0gevj_u54.jpeg"><br>  <i>Publicado por Sergey Yeshin, Desenvolvedor Strong Middle Android, DataArt</i> <br><br>  Mais de um ano e meio se passaram desde que o Google anunciou o suporte oficial ao Kotlin no Android, e os desenvolvedores mais experientes come√ßaram a experiment√°-lo em seus combates e n√£o em projetos h√° mais de tr√™s anos. <br><br>  O novo idioma foi recebido calorosamente na comunidade Android, e a grande maioria dos novos projetos Android come√ßar√° com o Kotlin a bordo.  Tamb√©m √© importante que o Kotlin seja compilado em um bytecode da JVM, portanto, √© totalmente compat√≠vel com Java.  Assim, nos projetos Android existentes escritos em Java, tamb√©m h√° uma oportunidade (al√©m disso, uma necessidade) de usar todos os recursos do Kotlin, gra√ßas aos quais ele conquistou tantos f√£s. <br><br>  No artigo, falarei sobre a experi√™ncia de migrar um aplicativo Android de Java para Kotlin, as dificuldades que precisaram ser superadas no processo e explicarei por que tudo isso n√£o foi em v√£o.  O artigo √© voltado principalmente para desenvolvedores do Android que est√£o come√ßando a aprender o Kotlin e, al√©m da experi√™ncia pessoal, conta com materiais de outros membros da comunidade. <a name="habracut"></a><br><br><h2>  Por que Kotlin? </h2><br>  Descreva brevemente os recursos do Kotlin, pelos quais mudei para ele no projeto, deixando o mundo Java "confort√°vel e dolorosamente familiar": <br><br><ol><li>  Compatibilidade total com Java </li><li>  Seguran√ßa nula </li><li>  Infer√™ncia de tipo </li><li>  M√©todos de extens√£o </li><li>  Fun√ß√µes como objetos de primeira classe e lambda </li><li>  Gen√©ricos </li><li>  Coroutines </li><li>  Nenhuma exce√ß√£o verificada </li></ol><br><h2>  Aplicativo DISCO </h2><br>  Esta √© uma aplica√ß√£o de tamanho pequeno para a troca de cart√µes de desconto, composta por 10 telas.  Usando seu exemplo, consideraremos a migra√ß√£o. <br><br><h3>  Brevemente sobre arquitetura </h3><br>  O aplicativo usa a arquitetura MVVM com o Google Architecture Components sob o cap√¥: ViewModel, LiveData, Room. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oe/n1/e4/oen1e4fepl7q4ff8zdth-jxwjlk.png"></div><br>  Al√©m disso, de acordo com os princ√≠pios de Arquitetura Limpa do tio Bob, selecionei 3 camadas no aplicativo: dados, dom√≠nio e apresenta√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/em/o4/rz/emo4rzbpvpeadmnhzucuyhhtzpq.png"></div><br>  Por onde come√ßar?  Ent√£o, imaginamos os principais recursos do Kotlin e temos uma id√©ia m√≠nima do projeto que precisa ser migrado.  A quest√£o natural √© "por onde come√ßar?". <br><br>  A p√°gina de documenta√ß√£o oficial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o ao Kotlin</a> Android diz que, se voc√™ deseja portar um aplicativo existente para o Kotlin, basta come√ßar a escrever testes de unidade.  Quando voc√™ ganha um pouco de experi√™ncia com essa linguagem, escreve um novo c√≥digo no Kotlin, basta converter o c√≥digo Java existente. <br><br>  Mas h√° um "mas".  De fato, uma simples convers√£o geralmente (embora nem sempre) permite que voc√™ obtenha um c√≥digo funcional no Kotlin; no entanto, seu idioma deixa muito a desejar.  Al√©m disso, mostrarei como eliminar essa lacuna devido aos recursos mencionados (e n√£o apenas) da linguagem Kotlin. <br><br><h2>  Migra√ß√£o de Camadas </h2><br>  Como o aplicativo j√° est√° em camadas, faz sentido migrar por camadas, come√ßando pela parte superior. <br><br>  A sequ√™ncia de camadas durante a migra√ß√£o √© mostrada na figura a seguir: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kp/oq/k_/kpoqk_8rpc0xg9qstzecyrlp_is.png"></div><br>  N√£o √© por acaso que come√ßamos a migra√ß√£o precisamente da camada superior.  Assim, evitamos usar o c√≥digo Kotlin no c√≥digo Java.  Pelo contr√°rio, fazemos com que o c√≥digo Kotlin da camada superior use as classes Java da camada inferior.  O fato √© que o Kotlin foi originalmente projetado levando em considera√ß√£o a necessidade de interagir com o Java.  O c√≥digo Java existente pode ser chamado a partir do Kotlin de maneira natural.  Podemos herdar facilmente das classes Java existentes, acess√°-las e aplicar anota√ß√µes Java √†s classes e m√©todos Kotlin.  O c√≥digo Kotlin tamb√©m pode ser usado em Java sem muitos problemas, mas geralmente √© necess√°rio um esfor√ßo extra, como adicionar uma anota√ß√£o da JVM.  E por que convers√µes desnecess√°rias no c√≥digo Java, se no final ainda ser√£o reescritas no Kotlin? <br><br>  Por exemplo, vejamos a gera√ß√£o de sobrecarga. <br><br>  Normalmente, se voc√™ escrever uma fun√ß√£o Kotlin com valores de par√¢metro padr√£o, ela ser√° vis√≠vel apenas em Java como uma assinatura completa com todos os par√¢metros.  Se voc√™ desejar fornecer v√°rias sobrecargas para chamadas Java, poder√° usar a anota√ß√£o @JvmOverloads: <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JvmOverloads</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">constructor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Double</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-number"><span class="hljs-number">0.0</span></span>) { <span class="hljs-meta"><span class="hljs-meta">@JvmOverloads</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a: String, b: Int = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, c: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"abc"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ... } }</code> </pre> <br>  Para cada par√¢metro com um valor padr√£o, isso criar√° uma sobrecarga adicional, que possui esse par√¢metro e todos os par√¢metros √† direita, na lista de par√¢metros remotos.  Neste exemplo, o seguinte ser√° criado: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Constructors: Foo(int x, double y) Foo(int x) // Methods void f(String a, int b, String c) { } void f(String a, int b) { } void f(String a) { }</span></span></code> </pre> <br>  Existem muitos exemplos de uso de anota√ß√µes da JVM para a opera√ß√£o correta do Kotlin.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Esta p√°gina de documenta√ß√£o</a> detalha a chamada para Kotlin a partir de Java. <br><br>  Agora, descrevemos o processo de migra√ß√£o camada por camada. <br><br><h3>  Camada de apresenta√ß√£o </h3><br>  Essa √© uma camada da interface do usu√°rio que cont√©m telas com visualiza√ß√µes e um ViewModel, por sua vez, contendo propriedades na forma de LiveData com dados do modelo.  A seguir, examinamos os truques e ferramentas que se mostraram √∫teis ao migrar essa camada de aplicativo. <br><br><h4>  1. Processador de anota√ß√£o Kapt </h4><br>  Como em qualquer MVVM, o View √© vinculado √†s propriedades do ViewModel por meio da liga√ß√£o de dados.  No caso do Android, estamos lidando com a Biblioteca de dados do Android, que usa o processamento de anota√ß√µes.  Portanto, o Kotlin possui <b>seu pr√≥prio processador de anota√ß√£o</b> e, se voc√™ n√£o fizer altera√ß√µes no arquivo build.gradle correspondente, o projeto ser√° interrompido.  Portanto, faremos essas altera√ß√µes: <br><br><pre> <code class="java hljs">apply plugin: <span class="hljs-string"><span class="hljs-string">'kotlin-kapt'</span></span> android { dataBinding { enabled = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> } } dependencies { <span class="hljs-function"><span class="hljs-function">api </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fileTree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dir: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'libs'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, include: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'*.jar'</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">///‚Ä¶ kapt "com.android.databinding:compiler:$android_plugin_version" }</span></span></span></span></code> </pre><br>  √â importante lembrar que voc√™ deve substituir completamente todas as ocorr√™ncias da configura√ß√£o annotationProcessor em seu build.gradle pelo kapt. <br><br>  Por exemplo, se voc√™ usar as bibliotecas Dagger ou Room no projeto, que tamb√©m usam o processador de anota√ß√µes sob o cap√¥ para gera√ß√£o de c√≥digo, dever√° especificar kapt como o processador de anota√ß√£o. <br><br><h4>  2. Fun√ß√µes embutidas </h4><br>  Ao marcar uma fun√ß√£o como embutida, solicitamos ao compilador que a coloque no local de uso.  O corpo da fun√ß√£o se torna incorporado, ou seja, √© substitu√≠do pelo uso usual da fun√ß√£o.  Gra√ßas a isso, podemos contornar a restri√ß√£o de apagamento de tipo, ou seja, apagar um tipo.  Ao usar fun√ß√µes embutidas, podemos obter o tipo (classe) em tempo de execu√ß√£o. <br><br>  Esse recurso do Kotlin foi usado no meu c√≥digo para "extrair" a classe da atividade iniciada. <br><br><pre> <code class="scala hljs">inline fun &lt;reified <span class="hljs-type"><span class="hljs-type">T</span></span> : <span class="hljs-type"><span class="hljs-type">Activity</span></span>&gt; <span class="hljs-type"><span class="hljs-type">Context</span></span>?.startActivity(args: <span class="hljs-type"><span class="hljs-type">Bundle</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>?.let { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> intent = <span class="hljs-type"><span class="hljs-type">Intent</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-type"><span class="hljs-type">T</span></span>::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">intent</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">putExtras</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">args</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">it</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">startActivity</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">intent</span></span></span><span class="hljs-class">) } }</span></span></code> </pre> <br>  reified - designa√ß√£o de um tipo reified. <br><br>  No exemplo descrito acima, tamb√©m abordamos um recurso da linguagem Kotlin como Extens√µes. <br><br><h4>  3. Extens√µes </h4><br>  Eles s√£o extens√µes.  Os m√©todos utilit√°rios foram utilizados em extens√µes, o que ajudou a evitar os utilit√°rios de classe inchados e monstruosos. <br><br>  Vou dar um exemplo das extens√µes envolvidas no aplicativo: <br><br><pre> <code class="scala hljs">fun <span class="hljs-type"><span class="hljs-type">Context</span></span>.inflate(res: <span class="hljs-type"><span class="hljs-type">Int</span></span>, parent: <span class="hljs-type"><span class="hljs-type">ViewGroup</span></span>? = <span class="hljs-literal"><span class="hljs-literal">null</span></span>): <span class="hljs-type"><span class="hljs-type">View</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">LayoutInflater</span></span>.from(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).inflate(res, parent, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) } fun &lt;<span class="hljs-type"><span class="hljs-type">T</span></span>&gt; <span class="hljs-type"><span class="hljs-type">Collection</span></span>&lt;<span class="hljs-type"><span class="hljs-type">T</span></span>&gt;?.isNotNullOrEmpty(): <span class="hljs-type"><span class="hljs-type">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; isNotEmpty(); } fun <span class="hljs-type"><span class="hljs-type">Fragment</span></span>.hideKeyboard() { view?.let { hideKeyboard(activity, it.windowToken) } }</code> </pre> <br>  Os desenvolvedores do Kotlin pensaram em extens√µes √∫teis do Android com anteced√™ncia, oferecendo seu plug-in Kotlin Android Extensions.  Entre os recursos que ele oferece est√£o o suporte √† liga√ß√£o e o pacote de exibi√ß√£o.  Informa√ß√µes detalhadas sobre os recursos deste plugin podem ser encontradas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h4>  4. Fun√ß√µes Lambda e fun√ß√µes de ordem superior </h4><br>  Usando as fun√ß√µes lambda no c√≥digo do Android, voc√™ pode se livrar do desajeitado ClickListener e do retorno de chamada, que em Java foram implementados por meio de interfaces auto-escritas. <br><br>  Um exemplo de uso de uma lambda em vez de onClickListener: <br><br><pre> <code class="java hljs">button.setOnClickListener({ doSomething() })</code> </pre> <br>  Os lambdas tamb√©m s√£o usados ‚Äã‚Äãem fun√ß√µes de ordem superior, por exemplo, para fun√ß√µes de cole√ß√£o. <br><br>  Tome o <b>mapa como um</b> exemplo: <br><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T, R&gt;</span></span></span><span class="hljs-function"> List</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(transform: (</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> -&gt; R): List&lt;R&gt; {...}</code> </pre> <br>  H√° um lugar no meu c√≥digo em que preciso "mapear" o ID dos cart√µes para sua remo√ß√£o subseq√ºente. <br><br>  Usando a express√£o lambda passada para mapear, obtenho a matriz de ID desejada: <br><br><pre> <code class="scala hljs"> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> ids = cards.map { it.id }.toIntArray() cardDao.deleteCardsByIds(ids)</code> </pre> <br>  Observe que os par√™nteses podem ser omitidos ao chamar a fun√ß√£o, se lambda √© o √∫nico argumento e a palavra-chave √© o nome impl√≠cito do √∫nico par√¢metro. <br><br><h4>  5. Tipos de plataformas </h4><br>  Voc√™ inevitavelmente precisar√° trabalhar com os SDKs escritos em Java (incluindo, de fato, o Android SDK).  Isso significa que voc√™ deve sempre estar atento ao Kotlin e ao Java Interop, como os tipos de plataforma. <br><br>  Um tipo de plataforma √© um tipo para o qual o Kotlin n√£o pode encontrar informa√ß√µes de validade nulas.  O fato √© que, por padr√£o, o c√≥digo Java n√£o cont√©m informa√ß√µes sobre a validade de null, e as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">anota√ß√µes NotNull</a> e @ Nullable nem sempre s√£o usadas.  Quando n√£o h√° anota√ß√£o correspondente em Java, o tipo se torna plataforma.  Voc√™ pode trabalhar com ele como um tipo que permite nulo e como um tipo que n√£o permite nulo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zw/r_/cu/zwr_cuwc3ajqxcsezq1b0zqcwyw.png"></div><br>  Isso significa que, assim como em Java, o desenvolvedor √© totalmente respons√°vel por opera√ß√µes com esse tipo.  O compilador n√£o adiciona um tempo de execu√ß√£o de verifica√ß√£o nula e permitir√° que voc√™ fa√ßa tudo. <br><br>  No exemplo a seguir, substitu√≠mos onActivityResult em nossa Activity: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(requestCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, resultCode: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">data</span></span></span></span><span class="hljs-function"><span class="hljs-params">: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Intent</span></span></span></span><span class="hljs-function"><span class="hljs-params">{ </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">super</span></span></span></span><span class="hljs-function"><span class="hljs-params">.</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">onActivityResult</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">requestCode</span></span></span></span><span class="hljs-function"><span class="hljs-params">, resultCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">data</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> randomString = <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.getStringExtra(<span class="hljs-string"><span class="hljs-string">"some_string"</span></span>) }</code> </pre> <br>  Nesse caso, dados s√£o um tipo de plataforma que pode conter nulo.  No entanto, do ponto de vista do c√≥digo Kotlin, os dados n√£o podem ser nulos em nenhuma circunst√¢ncia e, independentemente de voc√™ especificar o tipo de Inten√ß√£o como nulo, voc√™ n√£o receber√° um aviso ou erro do compilador, pois as duas vers√µes da assinatura s√£o v√°lidas. .  Mas como n√£o √© garantido o recebimento de dados n√£o vazios, porque nos casos com o SDK voc√™ n√£o pode controlar isso, ficar nulo nesse caso levar√° ao NPE. <br><br>  Al√©m disso, como exemplo, podemos listar os seguintes locais para o poss√≠vel surgimento de tipos de plataforma: <br><br><ol><li>  Service.onStartCommand (), onde o Intent pode ser nulo. </li><li>  BroadcastReceiver.onReceive (). </li><li>  Activity.onCreate (), Fragment.onViewCreate () e outros m√©todos semelhantes. </li></ol><br>  Al√©m disso, acontece que os par√¢metros do m√©todo s√£o anotados, mas por algum motivo o est√∫dio perde a anula√ß√£o ao gerar uma substitui√ß√£o. <br><br><h3>  Camada de dom√≠nio </h3><br>  Essa camada inclui toda a l√≥gica de neg√≥cios e √© respons√°vel pela intera√ß√£o entre a camada de dados e a camada de apresenta√ß√£o.  O papel principal aqui √© desempenhado pelo Reposit√≥rio.  No Reposit√≥rio, realizamos as manipula√ß√µes de dados necess√°rias, tanto do lado do servidor quanto do local.  No andar de cima, para a camada Apresenta√ß√£o, fornecemos apenas o m√©todo da interface Repository, que oculta a complexidade das opera√ß√µes de dados. <br><br>  Como mencionado acima, o RxJava foi usado para implementa√ß√£o. <br><br><h4>  1. RxJava </h4><br>  O Kotlin √© totalmente compat√≠vel com o RxJava e mais conciso em conjunto com ele do que o Java.  No entanto, mesmo aqui eu tive que enfrentar um problema desagrad√°vel.  Parece assim: se voc√™ passar um lambda como par√¢metro do m√©todo <b>andThen</b> , esse lambda n√£o funcionar√°! <br><br>  Para verificar isso, basta escrever um teste simples: <br><br><pre> <code class="scala hljs"><span class="hljs-type"><span class="hljs-type">Completable</span></span> .fromCallable { cardRepository.uploadDataToServer() } .andThen { cardRepository.markLocalDataAsSynced() } .subscribe()</code> </pre> <br>  <b>AndThen</b> conte√∫do falhar√°.  Este √© o caso da maioria dos operadores (como <b>flatMap</b> , <b>adiar</b> , <b>fromAction</b> e muitos outros); realmente, lambda √© esperado como argumento.  E com esse registro com <b>andThen</b> , <b>√© esperado que Completable / Observable / SingleSource</b> .  O problema √© resolvido usando par√™nteses comuns () em vez de encaracolado {}. <br><br>  Esse problema √© descrito em detalhes no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúKotlin e Rx2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como perdi 5 horas por causa de colchetes errados</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"</a> <br><br><h4>  2. Reestrutura√ß√£o </h4><br>  Tamb√©m tocamos em uma sintaxe Kotlin interessante, como <i>designa√ß√£o de desestrutura√ß√£o</i> ou <i>desestrutura√ß√£o</i> .  Permite atribuir um objeto a v√°rias vari√°veis ‚Äã‚Äãao mesmo tempo, dividindo-o em partes. <br><br>  Imagine que temos um m√©todo na API que retorna v√°rias entidades ao mesmo tempo: <br><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/foo/api/sync"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBrandsAndCards</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Single&lt;BrandAndCardResponse&gt; <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BrandAndCardResponse</span></span></span></span>(<span class="hljs-meta"><span class="hljs-meta">@SerializedName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cards"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cards: List&lt;Card&gt;?, <span class="hljs-meta"><span class="hljs-meta">@SerializedName(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"brands"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> brands: List&lt;Brand&gt;?)</code> </pre><br>  Uma maneira compacta de retornar o resultado desse m√©todo √© a desestrutura√ß√£o, conforme mostrado no exemplo a seguir: <br><br><pre> <code class="scala hljs">syncRepository.getBrandsAndCards() .flatMapCompletable {it-&gt; <span class="hljs-type"><span class="hljs-type">Completable</span></span>.fromAction{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (cards, brands) = it syncCards(cards) syncBrands(brands) } } }</code> </pre> <br>  Vale ressaltar que as multi-declara√ß√µes s√£o baseadas na conven√ß√£o: as classes que deveriam ser destru√≠das devem conter fun√ß√µes componentN (), onde N √© o n√∫mero do componente correspondente - um membro da classe.  Ou seja, o exemplo acima se traduz no seguinte c√≥digo: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cards = it.component1() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> brands = it.component2()</code> </pre> <br>  Nosso exemplo usa uma classe de dados que declara automaticamente as fun√ß√µes componentN ().  Portanto, as multi-declara√ß√µes trabalham com ele imediatamente. <br><br>  Falaremos mais sobre a classe de dados na pr√≥xima parte, dedicada √† camada de dados. <br><br><h3>  Camada de dados </h3><br>  Essa camada inclui POJO para dados do servidor e da base, interfaces para trabalhar com dados locais e dados recebidos do servidor. <br><br>  Para trabalhar com dados locais, foi utilizado o Room, que fornece um inv√≥lucro conveniente para trabalhar com o banco de dados SQLite. <br><br>  O primeiro objetivo da migra√ß√£o, que se sugere, s√£o os POJOs, que no c√≥digo Java padr√£o s√£o classes em massa com muitos campos e seus m√©todos get / set correspondentes.  Voc√™ pode tornar o POJO mais conciso com a ajuda das classes Data.  Uma linha de c√≥digo ser√° suficiente para descrever uma entidade com v√°rios campos: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> id:String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardNumber:String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> brandId:String,<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> barCode:String)</code> </pre><br>  Al√©m da concis√£o, obtemos: <br><br><ul><li>  Substitui os m√©todos <b>equals ()</b> , <b>hashCode ()</b> e <b>toString ()</b> sob o cap√¥.  A gera√ß√£o de iguais para todas as propriedades da classe de dados √© extremamente conveniente ao usar o DiffUtil em um adaptador que gera visualiza√ß√µes para o RecyclerView.  O fato √© que o DiffUtil compara dois conjuntos de dados, duas listas: o antigo e o novo, descobre quais altera√ß√µes ocorreram e o uso de m√©todos de notifica√ß√£o atualiza o adaptador de maneira otimizada.  E normalmente, os itens da lista s√£o comparados usando iguais. <br><br>  Assim, ap√≥s adicionar um novo campo √† classe, n√£o precisamos adicion√°-lo a igual para que o DiffUtil leve em considera√ß√£o o novo campo. </li><li>  Classe imut√°vel </li><li>  Suporte para valores padr√£o, que podem ser substitu√≠dos pelo uso do padr√£o Builder. <br><br>  Um exemplo: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Card</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> id : <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> = <span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cardNumber: String=<span class="hljs-string"><span class="hljs-string">"99"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> barcode: String = <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> brandId: String=<span class="hljs-string"><span class="hljs-string">"1"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> newCard = Card(id =<span class="hljs-number"><span class="hljs-number">1L</span></span>,cardNumber = <span class="hljs-string"><span class="hljs-string">"123"</span></span>)</code> </pre> </li></ul><br>  Outra boa not√≠cia: com o kapt configurado (como descrito acima), as classes Data funcionam bem com as anota√ß√µes de Salas, o que permite traduzir todas as entidades do banco de dados em classes Data.  O quarto tamb√©m suporta propriedades anul√°veis.  √â verdade que o Room ainda n√£o suporta os valores padr√£o do Kotlin, mas o bug correspondente j√° foi institu√≠do para isso. <br><br><h2>  Conclus√µes </h2><br>  Examinamos apenas algumas armadilhas que podem surgir durante a migra√ß√£o do Java para o Kotlin.  √â importante que, embora surjam problemas, especialmente com falta de conhecimento te√≥rico ou experi√™ncia pr√°tica, todos eles sejam solucion√°veis. <br><br>  No entanto, o prazer de escrever um c√≥digo expressivo e seguro conciso no Kotlin mais do que compensar√° todas as dificuldades que surjam no caminho da transi√ß√£o.  Posso dizer com confian√ßa que o exemplo do projeto DISCO certamente confirma isso. <br><br><h3>  Livros, links √∫teis, recursos </h3><br><ol><li>  O fundamento te√≥rico do conhecimento da l√≠ngua permitir√° a coloca√ß√£o do livro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kotlin in Action</a> dos criadores da linguagem Svetlana Isakova e Dmitry Zhemerov. <br><br>  Laconicismo, informatividade, ampla cobertura de t√≥picos, foco em desenvolvedores de Java e a disponibilidade de uma vers√£o em russo o tornam o melhor dos manuais poss√≠veis no in√≠cio do aprendizado de idiomas.  Eu comecei com ela. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fontes</a> Kotlin com developer.android. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Guia Kotlin em russo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Um excelente artigo de</a> Konstantin Mikhailovsky, desenvolvedor Android da Genesis, sobre a experi√™ncia de mudar para o Kotlin. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433074/">https://habr.com/ru/post/pt433074/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433062/index.html">AXIS P1367 vs IDIS DC-B3303X: Compare C√¢meras CFTV</a></li>
<li><a href="../pt433064/index.html">Gerenciamento de incidentes: "voc√™ n√£o pode desistir" ou a arte de colocar v√≠rgulas</a></li>
<li><a href="../pt433066/index.html">Copo HighLoad # 2. Campeonato para desenvolvedores de back-end de volta ao servi√ßo</a></li>
<li><a href="../pt433070/index.html">Como distinguir shampoo de champignon e espetos de champagne ... Elasticsearch - procure por produtos nos bancos de dados de lojas</a></li>
<li><a href="../pt433072/index.html">Como hackear a prote√ß√£o contra c√≥pia do console Sega Dreamcast</a></li>
<li><a href="../pt433076/index.html">Como criamos nossa biblioteca da Galeria do Android para exibir conte√∫do de m√≠dia</a></li>
<li><a href="../pt433078/index.html">Escrevemos rob√¥s de negocia√ß√£o usando a estrutura gr√°fica StockSharp. Parte 2</a></li>
<li><a href="../pt433082/index.html">Bombear as contas de outras pessoas se tornou um crime na Cor√©ia do Sul</a></li>
<li><a href="../pt433084/index.html">Li√ß√£o aberta "Engenharia de recursos no exemplo do conjunto de dados cl√°ssico do Titanic"</a></li>
<li><a href="../pt433086/index.html">Tinkoff e tudo, tudo, tudo: IoT, an√°lise e vigil√¢ncia para bancos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>