<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≠ üôÅ üç© Matem√°tica r√°pida de ponto fixo para aplicativos financeiros em Java üïñ ‚ò∏Ô∏è üèòÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="N√£o √© segredo que as informa√ß√µes financeiras (contas, lan√ßamentos e outras contas cont√°beis) n√£o s√£o muito amig√°veis ‚Äã‚Äãcom n√∫meros de ponto flutuante,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Matem√°tica r√°pida de ponto fixo para aplicativos financeiros em Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425565/"><p>  N√£o √© segredo que as informa√ß√µes financeiras (contas, lan√ßamentos e outras contas cont√°beis) n√£o s√£o muito amig√°veis ‚Äã‚Äãcom n√∫meros de ponto flutuante, e muitos artigos recomendam o uso de uma aritm√©tica de ponto fixo.  De fato, em Java, esse formato √© representado apenas pela classe BigDecimal, que nem sempre pode ser usada por motivos de desempenho.  Temos que procurar alternativas.  Este artigo descreve uma biblioteca Java auto-escrita para executar opera√ß√µes aritm√©ticas em n√∫meros de precis√£o fixa.  A biblioteca foi criada para funcionar em aplicativos financeiros de alto desempenho e permite trabalhar com uma precis√£o de 9 casas decimais, mantendo um desempenho aceit√°vel.  Um link para as fontes e refer√™ncias √© fornecido no final do artigo. </p><a name="habracut"></a><br><h1 id="arifmetika-s-plavayuschey-tochkoy">  Aritm√©tica de ponto flutuante </h1><br><p>  Os computadores modernos podem executar opera√ß√µes aritm√©ticas apenas com precis√£o limitada.  Esses s√£o dispositivos discretos que podem n√£o funcionar com todos os n√∫meros poss√≠veis, mas apenas com alguns subconjuntos cont√°veis.  O formato mais comum para trabalhar com n√∫meros reais na mem√≥ria do computador √© um ponto flutuante (bin√°rio) - ponto flutuante (bin√°rio), quando os n√∫meros s√£o armazenados no formato M * 2 ^ E, onde M e E s√£o mantissa inteira e a ordem do n√∫mero.  Mas alguns n√∫meros, como 0,1, n√£o podem ser representados com precis√£o nesse formato.  Portanto, no curso de c√°lculos complexos, algum erro se acumula inevitavelmente.  Ou seja, o resultado do c√°lculo da m√°quina, digamos 0,1 + 0,1 + 0,1, n√£o coincide com o matematicamente correto 0,3.  Dado o exposto, ao programar aritm√©tica complexa, voc√™ pode seguir v√°rias estrat√©gias: </p><br><p>  Estrat√©gia 1 - ignore.  N√£o preste aten√ß√£o ao erro, considere todas as opera√ß√µes como matem√°ticas ideais e espere que a precis√£o dispon√≠vel seja suficiente para resultados aceit√°veis.  A op√ß√£o mais comum. </p><br><p>  Estrat√©gia 2 - calcule meticulosamente.  As f√≥rmulas para calcular erros da m√°quina s√£o conhecidas h√° d√©cadas.  Eles permitem estimar acima o erro relativo de qualquer opera√ß√£o aritm√©tica.  Provavelmente, √© isso que voc√™ precisa fazer para uma simula√ß√£o num√©rica s√©ria.  O problema √© que consome muito tempo.  De fato, cada caractere + - * / no c√≥digo deve ser acompanhado por um c√°lculo de erro.  Voc√™ precisa levar em considera√ß√£o todas as depend√™ncias entre os c√°lculos e repetir o procedimento toda vez que alterar o c√≥digo. </p><br><p>  Estrat√©gia 3 - use um ponto decimal (ponto decimal flutuante) em vez de bin√°rio.  Ou seja, armazene os n√∫meros no formato M * 10 ^ E.  Isso n√£o resolve os problemas de erro (a mantissa ainda √© arredondada para um n√∫mero finito de d√≠gitos significativos), mas pelo menos todos os n√∫meros "simples" para uma pessoa (como 1.1) agora est√£o representados com precis√£o na mem√≥ria.  O retorno ser√° o desempenho.  Qualquer normaliza√ß√£o de n√∫meros (ou seja, uma diminui√ß√£o equivalente na mantissa e um aumento na ordem) requer uma divis√£o por uma pot√™ncia de 10, o que n√£o √© muito r√°pido, ao contr√°rio de uma divis√£o por uma pot√™ncia de 2. E voc√™ precisa normalizar muito - com cada adi√ß√£o ou subtra√ß√£o com ordens diferentes. </p><br><p>  Estrat√©gia 4 - use um ponto fixo (ponto decimal fixo).  Simplifica√ß√£o da estrat√©gia 3, quando fixamos a ordem E. Nesse caso, a normaliza√ß√£o n√£o √© necess√°ria para adi√ß√£o / subtra√ß√£o.  Al√©m disso, todos os c√°lculos ter√£o o mesmo erro absoluto.  Este artigo √© dedicado a essa estrat√©gia. </p><br><h1 id="arifmetika-s-fiksirovannoy-tochkoy">  Aritm√©tica de ponto fixo </h1><br><p>  Em contraste com a f√≠sica, onde o erro relativo √© importante, apenas o absoluto √© necess√°rio nas finan√ßas.  Se, ap√≥s uma transa√ß√£o financeira complexa, o cliente receber US $ 1.000.000,23 enquanto espera US $ 1.000.000,18, poder√£o surgir algumas dificuldades.  Explica√ß√µes como "por que voc√™ precisa de precis√£o em 8 d√≠gitos significativos?"  pode n√£o andar.  E o ponto aqui n√£o est√° em 5 centavos de perda (errar pelo contr√°rio, ‚Äúa favor‚Äù do cliente n√£o √© muito melhor), mas em inconsist√™ncias na contabilidade.  Portanto, as regras de c√°lculos e arredondamentos s√£o claramente especificadas entre as partes, e os artefatos do uso de vari√°veis ‚Äã‚Äãdouble e float √†s vezes complicam a vida. </p><br><p>  Java possui uma classe padr√£o para aritm√©tica de ponto fixo - BigDecimal.  Existem dois problemas: √© lento (devido √† sua universalidade) e n√£o √© est√°vel.  N√£o estabilidade significa que qualquer opera√ß√£o aloca um objeto no heap.  Selecionar e liberar em termos de um objeto leva um pouco de tempo, mas c√°lculos intensivos no c√≥digo "quente" criam uma carga decente no GC, o que √© inaceit√°vel em alguns casos.  Voc√™ pode confiar na an√°lise de escape e na escalariza√ß√£o, mas elas s√£o muito inst√°veis ‚Äã‚Äãno sentido de que mesmo uma pequena altera√ß√£o no c√≥digo ou no JIT (como o carregamento lento de uma nova implementa√ß√£o de interface) pode virar toda a estrutura inline de cabe√ßa para baixo e o m√©todo funcionou bem h√° um minuto, de repente come√ßa a alocar furiosamente a mem√≥ria. <br>  UPD devido a perguntas nos coment√°rios: <strong>O principal motivo para o</strong> abandono do BigDecimal e do BigInteger n√£o √© o baixo desempenho dos c√°lculos, mas a n√£o estabilidade e a sele√ß√£o de objetos. </p><br><p>  A biblioteca descrita √© o resultado de estar cansado de reescrever a aritm√©tica de ponto fixo sem mem√≥ria para cada novo empregador, e eu decidi escrever minha pr√≥pria biblioteca para posterior fornecimento. </p><br><p>  Mostrarei imediatamente um exemplo de uso antes de passar aos detalhes da implementa√ß√£o: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sample</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Decimal margin; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Quantity cumQuantity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Quantity(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Quantity contraQuantity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Quantity(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Quantity cumContraQuantity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Quantity(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Price priceWithMargin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Price(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Price avgPrice = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Price(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sample</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> marginBp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// 1 + margin / 10000 this.margin = Decimal.create(marginBp).divRD(10000L).add(1); } public Price calculateAvgPrice(Quantity[] quantities, Price[] prices) { cumQuantity.set(0); contraQuantity.set(0); // avg = sum(q * p * margin) / sum(q) for (int i = 0; i &lt; quantities.length; i++) { cumQuantity.add(quantities[i]); priceWithMargin.set(prices[i]).mulRD(margin); contraQuantity.set(quantities[i]).mulRD(priceWithMargin); cumContraQuantity.add(contraQuantity); } return avgPrice.quotientRD(cumContraQuantity, cumQuantity); } public static void main(String[] args) throws ParseException { Price p1 = Price.create("1.5"); Price p2 = Price.create(1.6); Quantity q1 = Quantity.create("100"); Quantity q2 = Quantity.create(200); // apply 0.05% margin to the prices Sample sample = new Sample(5); System.out.println(sample.calculateAvgPrice(new Quantity[]{q1, q2}, new Price[]{p1, p2})); } }</span></span></code> </pre> <br><h1 id="ideya-realizacii">  Ideia de implementa√ß√£o </h1><br><p>  Portanto, precisamos de um inv√≥lucro mut√°vel de um primitivo inteiro, mais precisamente - um long'a, o que nos dar√° quase 19 d√≠gitos significativos (o suficiente para a parte inteira e a parte fracion√°ria).  Por muito tempo, queremos dizer N casas decimais.  Por exemplo, com N = 2, o n√∫mero 2,56 √© armazenado como 256 (bin√°rio 100000000).  Os n√∫meros negativos s√£o armazenados como padr√£o, em c√≥digo adicional: </p><br><p>  <em>-2,56</em> <br>  <strong>-256</strong> </p><br><p>  (A seguir, <em>it√°lico</em> indica n√∫meros e c√°lculos "matem√°ticos" e <strong>em negrito</strong> sua representa√ß√£o interna) </p><br><p>  Tamb√©m me pareceu √∫til inserir NaN como um valor separado, retornado em caso de erros aritm√©ticos (em vez de uma exce√ß√£o ou lixo).  <em>NaN</em> √© representado internamente como <strong>Long.MIN_VALUE</strong> , ‚Äúpropagado‚Äù por todas as opera√ß√µes e permite determinar a invers√£o de sinal para todos os n√∫meros restantes. </p><br><p>  Vamos tentar estimar os algoritmos de opera√ß√µes aritm√©ticas para o caso em que N = 2. </p><br><p>  A adi√ß√£o e subtra√ß√£o n√£o exigem gestos extras, basta usar os valores como est√£o: </p><br><p>  <em>1,20 + 2,30 = 3,50</em> <br>  <strong>120 + 230 = 350</strong> </p><br><p>  Multiplica√ß√£o e divis√£o requerem normaliza√ß√£o adicional, ou seja, multiplica√ß√£o / divis√£o por 10 ^ N (por 100 em nosso exemplo) </p><br><p>  <em>1,20 * 2,00 = 2,40</em> <br>  <strong>120 * 200/100 = 240</strong> </p><br><p>  <em>1,20 / 2,00 = 0,60</em> <br>  <strong>100 * 120/200 = 60</strong> </p><br><p>  Divis√£o adicional n√£o √© a opera√ß√£o mais r√°pida.  Mas, neste caso, essa √© uma divis√£o por uma constante, porque anteriormente fixamos N = 2 e 10 ^ N = 100.  A divis√£o por constante, especialmente por "bonita" (tipo 10), √© intensivamente otimizada na CPU e muito mais r√°pida que a divis√£o por um n√∫mero aleat√≥rio.  Fazemos muitas divis√µes por 10 toda vez que convertemos qualquer n√∫mero em uma string (por exemplo, nos logs), e os fabricantes de CPU sabem disso ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">para obter mais detalhes sobre otimiza√ß√£o,</a> consulte "Divis√£o por uma constante"). </p><br><p>  Para consolidar a compreens√£o do que estamos fazendo, darei mais uma opera√ß√£o: invers√£o un√°ria de um n√∫mero, ou seja, 1 / x.  Este √© um caso especial de divis√£o, basta enviar 1,00 em nosso formato e n√£o se esque√ßa de normalizar: </p><br><p>  <em>1,00 / 2,00 = 0,50</em> <br>  <strong>100 * 100/200 = 50</strong> </p><br><p>  Bem, enquanto tudo √© bastante simples, vamos tentar nos aprofundar nos detalhes. </p><br><h1 id="okruglenie">  Arredondamento </h1><br><p>  Vamos tentar desenhar outro n√∫mero: </p><br><p>  <em>1,00 / 3,00 = 0,33</em> <br>  <strong>100 * 100/300 = 33</strong> </p><br><p>  Um resultado matem√°tico honesto fica entre 0,33 e 0,34, mas n√£o podemos imagin√°-lo exatamente.  Qual o caminho a percorrer?  Geralmente arredondado para 0, e esta √© a maneira mais r√°pida (suportada por hardware).  Mas, voltando a problemas financeiros reais, esse nem sempre √© o caso.  Normalmente, ao processar transa√ß√µes com um cliente, o arredondamento √© "a favor do cliente".  Ou seja, o pre√ßo √© arredondado para cima se o cliente estiver vendendo e para baixo se o cliente estiver comprando.  Por√©m, outras op√ß√µes podem ser necess√°rias, por exemplo, arredondamento aritm√©tico para o n√∫mero mais pr√≥ximo com subtipos (meio para cima, meio para baixo, meio par) para minimizar as inconsist√™ncias cont√°beis.  Ou arredondar para ¬± infinito para pre√ßos negativos (para alguns instrumentos financeiros).  O Java BigDecimal j√° cont√©m uma lista de modos de arredondamento padr√£o, e a biblioteca descrita suporta todos eles.  DESNECESS√ÅRIO retorna NaN se a opera√ß√£o inesperadamente exigir arredondamento. </p><br><p>  No modo arredondado, nosso c√°lculo deve fornecer: </p><br><p>  <em>1,00 / 3,00 = 0,34</em> <br>  <strong>100 * 100/300 + 1 = 34</strong> </p><br><p>  Como descobrir o que voc√™ precisa adicionar uma unidade?  Voc√™ precisa do restante da divis√£o 10.000% 300 = 100. O que √© t√£o lento quanto a pr√≥pria divis√£o.  Felizmente, se voc√™ escrever em uma linha no c√≥digo "a / b; a% b", o JIT descobrir√° que 2 divis√µes n√£o s√£o necess√°rias, apenas um comando div do assembler que retorna 2 n√∫meros (quociente e restante). </p><br><p>  Outras op√ß√µes de arredondamento s√£o um pouco mais complicadas, mas tamb√©m podem ser calculadas com base no restante e no divisor. </p><br><p>  Na API, intencionalmente mencionei o arredondamento onde quer que ocorra, como par√¢metro ou como sufixo pr√≥prio <strong>D</strong> ou <strong>D</strong> em m√©todos em que o padr√£o √© zero. </p><br><h1 id="perepolnenie">  Estouro </h1><br><p>  Chegamos √† parte mais dif√≠cil.  Lembre novamente nossa multiplica√ß√£o: </p><br><p>  <em>1,20 * 2,00 = 2,40</em> <br>  <strong>120 * 200/100 = 240</strong> </p><br><p>  Agora imagine que estamos na d√©cada de 1980 e temos processadores de 16 bits.  Ou seja, apenas um curto est√° dispon√≠vel para n√≥s com um valor m√°ximo de 65535. A primeira multiplica√ß√£o exceder√° e ser√° igual a 240000 &amp; 0xFFFF = 44392 (se n√£o tiver sinal, com um sinal tamb√©m ser√° negativo), o que quebrar√° o resultado para n√≥s. </p><br><p>  N√£o vai dar certo  Temos dois argumentos normais (se encaixam em nosso intervalo de valores) e o mesmo resultado esperado normal, mas estamos no meio do caminho.  A mesma situa√ß√£o √© poss√≠vel com um long'om de 64 bits, apenas n√∫meros precisam de mais. </p><br><p>  Nos anos 80, precisar√≠amos de uma multiplica√ß√£o que desse um resultado de 32 bits.  Hoje precisamos de uma multiplica√ß√£o com um resultado de 128 bits.  O mais irritante √© que ambas as multiplica√ß√µes est√£o dispon√≠veis nos montadores 8086 e x86-64, respectivamente, mas n√£o podemos us√°-las no Java!  O JNI, mesmo no caso de um hack com JavaCritical r√°pido, fornece uma sobrecarga de dezenas de nanossegundos, introduz dificuldades com a implanta√ß√£o e a compatibilidade, congela o GC pela dura√ß√£o da chamada.  Al√©m disso, precisar√≠amos, de alguma forma, retornar um resultado de 128 bits do m√©todo nativo, e escrever por refer√™ncia a uma matriz (na mem√≥ria) √© um atraso adicional. </p><br><p>  Em geral, eu tive que escrever multiplica√ß√£o e divis√£o manuais.  Coluna  Eu precisava de duas opera√ß√µes auxiliares: </p><br><ol><li>  A (64) * B (64) = T (128);  T (128) / N (32) = Q (64), R (32) - como parte do ponto fixo de multiplica√ß√£o A * B </li><li>  N (32) * A (64) = T (96);  T (96) / B (64) = Q (64), R (64) - como parte da divis√£o de pontos fixos A / B <br>  (entre par√™nteses indica a dimens√£o dos dados em bits, T √© uma vari√°vel tempor√°ria que n√£o deve ser excedida) </li></ol><br><p>  Ambas as opera√ß√µes retornam o quociente e o restante (um como resultado do m√©todo, o segundo no campo de objeto).  Eles tamb√©m podem transbordar, mas apenas na √∫ltima etapa, quando isso √© inevit√°vel.  Aqui est√° um exemplo (da d√©cada de 1980): </p><br><p>  <em>500,00 / 0,50 = 1000,00</em> <br>  <strong>100 * 50.000 / 50 = 100.000</strong> - estouro! </p><br><p>  A divis√£o de colunas √† Knut n√£o √© o algoritmo mais f√°cil.  Al√©m disso, tamb√©m deve ser relativamente r√°pido.  Portanto, o c√≥digo de ambas as opera√ß√µes √© centenas de linhas de m√°gica bastante grave, levarei muito tempo para lembrar novamente o que exatamente est√° acontecendo l√°.  Coloquei-os em uma aula separada e comentei em detalhes o quanto pude. </p><br><p>  O algoritmo de multiplica√ß√£o n√£o se limita a invocar a opera√ß√£o 1, mas o c√≥digo restante n√£o √© t√£o complicado e apenas adiciona suporte para n√∫meros negativos, arredondamentos e NaN. </p><br><p>  Geralmente (exceto em casos especiais), ambas as opera√ß√µes cont√™m 4 multiplica√ß√µes e 2 divis√µes.  A opera√ß√£o 1 √© significativamente mais r√°pida que 2, pois nela essas divis√µes s√£o constantes. </p><br><p>  A prop√≥sito, se algu√©m notou, N (32) √© nosso 10 ^ N para normaliza√ß√£o.  √â de 32 bits, e da√≠ resulta que N pode ter no m√°ximo 9. Nas aplica√ß√µes reais que eu vi, foram usadas 2, 4 ou 8 casas decimais.  Eu n√£o vi mais de 9, ent√£o isso deve ser suficiente.  Se voc√™ criar 10 ^ N de 64 bits, o c√≥digo se tornar√° mais complicado (e mais lento) ainda mais. </p><br><h1 id="neskolko-raznyh-tochnostey">  V√°rios precis√£o diferente </h1><br><p>  √Äs vezes, √© necess√°rio executar uma opera√ß√£o em argumentos com um n√∫mero diferente de casas decimais.  No m√≠nimo, insira opera√ß√µes que envolvam o tempo normal. </p><br><p>  Por exemplo: </p><br><p>  <em>2.0000 (N = 4) + 3.00 (N = 2) = 5.0000 (N = 4)</em> <br>  <strong>20.000 + 300 * 100 = 50.000</strong> </p><br><p>  <em>3,00 (N = 2) + 2,0000 (N = 4) = 5,00 (N = 2)</em> <br>  <strong>300 + 20.000 / 100 = 500</strong> </p><br><p>  Nesse caso, √© necess√°ria uma normaliza√ß√£o adicional de um dos argumentos.  Observe que matematicamente as duas opera√ß√µes s√£o equivalentes, mas devido √† precis√£o diferente do resultado, elas s√£o calculadas de maneira diferente.  Tamb√©m √© importante notar que a segunda opera√ß√£o geralmente requer arredondamento. </p><br><p>  O n√∫mero de casas decimais N√ÉO √© armazenado no objeto.  Em vez disso, uma subclasse separada √© assumida para cada precis√£o.  Os nomes das classes podem ser orientados para os neg√≥cios, por exemplo Pre√ßo (N = 8), Quantidade (N = 2).  E eles podem ser generalizados: Decimal1, Decimal2, Decimal3, ... Quanto maior a precis√£o, menor o intervalo de valores armazenados, o intervalo m√≠nimo possui Decimal9: ¬± 9223372036.  Sup√µe-se que uma ou duas classes sejam suficientes para cobrir a funcionalidade necess√°ria; nesse caso, o m√©todo getScale abstrato provavelmente ser√° virtualizado e embutido.  As subclasses (em vez de um campo adicional) permitem tipificar estritamente a precis√£o dos argumentos e resultados, bem como sinalizar sobre poss√≠veis arredondamentos no est√°gio de compila√ß√£o. </p><br><p>  A biblioteca permite opera√ß√µes com no m√°ximo 2 (mas n√£o 3) de precis√£o diferente.  Ou seja, a precis√£o dos dois argumentos deve coincidir ou a precis√£o de um dos argumentos e o resultado.  Novamente, o suporte a tr√™s diferentes precis√£o desaceleraria bastante o c√≥digo e complicaria a API.  Como argumentos, voc√™ pode passar um longo regular, para o qual √© assumida uma precis√£o de N = 0. </p><br><p>  <em>2.0000 / 3.0 = 0.6667</em> - ok (precis√£o diferente de 2) <br>  <em>2/3 = 0,6667</em> - ok (argumentos longos, resultado decimal) <br>  <em>2 / 3,0 = 0,66667</em> - imposs√≠vel!  (3 precis√£o diferente) </p><br><h1 id="dostoinstva-i-nedostatki">  Vantagens e desvantagens </h1><br><p>  Obviamente, a computa√ß√£o de alto bit realizada pela biblioteca √© mais lenta que a suportada por hardware.  No entanto, a sobrecarga n√£o √© t√£o grande (veja os benchmarks abaixo). </p><br><p>  Al√©m disso, devido √† falta de sobrecarga do operador em Java, o uso de m√©todos em vez de operadores aritm√©ticos complica a percep√ß√£o do c√≥digo. </p><br><p>  Com base nisso, a biblioteca geralmente √© usada em locais onde a perda de precis√£o absoluta √© cr√≠tica.  Por exemplo, c√°lculo de estat√≠sticas financeiras precisas, levando em considera√ß√£o os indicadores financeiros atuais (posi√ß√µes de negocia√ß√£o, PnL, ordens executadas).  Na troca de informa√ß√µes financeiras em rede entre sistemas, tamb√©m √© mais conveniente usar formatos com um ponto decimal (em vez de bin√°rios). </p><br><p>  Algoritmos matem√°ticos complexos (modelagem, estat√≠stica, previs√£o) s√£o geralmente mais f√°ceis de serem executados de maneira padronizada em dobro, pois seu resultado n√£o √© absolutamente preciso. </p><br><h1 id="kod-i-benchmarki">  C√≥digo e refer√™ncias </h1><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√≥digo</a> </p><br><table><tbody><tr><th>  Refer√™ncia </th><th>  Mode </th><th>  Cnt </th><th>  Pontua√ß√£o </th><th>  Erro </th><th>  Unidades <br></th></tr><tr><td>  DecimalBenchmark.control </td><td>  avgt </td><td>  200 </td><td>  10.072 </td><td>  ¬± 0,074 </td><td>  ns / op <br></td></tr><tr><td>  DecimalBenchmark.multiplyNative </td><td>  avgt </td><td>  200 </td><td>  10,625 </td><td>  ¬± 0,142 </td><td>  ns / op <br></td></tr><tr><td>  DecimalBenchmark.multiplyMyDecimal </td><td>  avgt </td><td>  200 </td><td>  35.840 </td><td>  ¬± 0,121 </td><td>  ns / op <br></td></tr><tr><td>  DecimalBenchmark.multiplyBigDecimal </td><td>  avgt </td><td>  200 </td><td>  126.098 </td><td>  ¬± 0,408 </td><td>  ns / op <br></td></tr><tr><td>  DecimalBenchmark.quotientNative </td><td>  avgt </td><td>  200 </td><td>  70.728 </td><td>  ¬± 0,230 </td><td>  ns / op <br></td></tr><tr><td>  DecimalBenchmark.quotientMyDecimal </td><td>  avgt </td><td>  200 </td><td>  138.581 </td><td>  ¬± 7,102 </td><td>  ns / op <br></td></tr><tr><td>  DecimalBenchmark.quotientBigDecimal </td><td>  avgt </td><td>  200 </td><td>  179.650 </td><td>  ¬± 0,849 </td><td>  ns / op <br></td></tr></tbody></table><br><p>  Em geral, a multiplica√ß√£o √© 4 vezes mais r√°pida que BigDecimal, a divis√£o √© 1,5.  A taxa de divis√£o √© <em>altamente</em> dependente dos argumentos, da√≠ a dispers√£o de valores. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt425565/">https://habr.com/ru/post/pt425565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt425555/index.html">Charles Nutter sobre idiomas din√¢micos na JVM em jug.msk.ru</a></li>
<li><a href="../pt425557/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Palestra 10: Execu√ß√£o Simb√≥lica, Parte 1</a></li>
<li><a href="../pt425559/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Aula 10: Execu√ß√£o Simb√≥lica, Parte 3</a></li>
<li><a href="../pt425561/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Palestra 10: Execu√ß√£o Simb√≥lica, Parte 2</a></li>
<li><a href="../pt425563/index.html">A Calif√≥rnia pro√≠be a venda de dispositivos IoT com ou sem senhas simples</a></li>
<li><a href="../pt425569/index.html">Teste funcional do PWB</a></li>
<li><a href="../pt425571/index.html">Protegendo um servidor Web no Linux</a></li>
<li><a href="../pt425575/index.html">Neuroinflama√ß√£o</a></li>
<li><a href="../pt425581/index.html">Jetpack 11 de outubro de 1961: O Presidente abriu a boca ...</a></li>
<li><a href="../pt425583/index.html">Tudo o que ainda confunde robomobiles, come√ßando com gaivotas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>