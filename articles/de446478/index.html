<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👨🏼 📤 🚊 Ich respektiere weder die Kapselung noch die Verwendung der Methodentabelle eines anderen Typs für den schnellen Aufruf der privaten Methoden 🚊 🚯 👨🏽‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo. Ich möchte Ihnen ein Beispiel für die Verwendung von StructLayout für etwas Interessanteres als Beispiele mit Bytes, Ints und anderen primitive...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ich respektiere weder die Kapselung noch die Verwendung der Methodentabelle eines anderen Typs für den schnellen Aufruf der privaten Methoden</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446478/">  Hallo.  Ich möchte Ihnen ein Beispiel für die Verwendung von <b>StructLayout</b> für etwas Interessanteres als Beispiele mit Bytes, Ints und anderen primitiven Typen zeigen, wenn alles ganz offensichtlich geschieht. <br><br><div style="text-align:center;"><img width="450" src="https://habrastorage.org/webt/yk/sh/jm/ykshjm3lfqprh1tl8ycwxhlttyc.jpeg"></div><br><a name="habracut"></a><br>  Bevor Sie mit der blitzschnellen Verletzung der Kapselung fortfahren, sollten Sie kurz daran erinnern, was StructLayout ist.  Genau genommen ist es sogar <b>StructLayoutAttribute</b> , ein Attribut, mit dem Sie Strukturen und Klassen erstellen können, die der Vereinigung in C ++ ähneln.  Mit diesem Attribut können Sie die Platzierung von Klassenmitgliedern im Speicher steuern (mithilfe von Offsets).  Dementsprechend wird es über der Klasse platziert. <br><br>  Wenn eine Klasse zwei Felder hat, erwarten wir normalerweise, dass diese nacheinander angeordnet werden, dh sie sind unabhängig voneinander (nicht überlappen).  Mit <b>StructLayout</b> können Sie jedoch festlegen, dass der Speicherort der Felder nicht von der Umgebung, sondern vom Benutzer festgelegt wird.  Um den Versatz der Felder explizit anzugeben, sollten wir den Parameter <b>LayoutKind.Explicit verwenden</b> . <br><br>  Um anzugeben, welchen Versatz vom Anfang der Klasse / Struktur (im Folgenden nur "Klasse") wir das Feld platzieren möchten, müssen wir das <b>FieldOffset-</b> Attribut darauf setzen.  Dieses Attribut verwendet als Parameter die Anzahl der Bytes - den Versatz vom Beginn der Klasse.  Es ist unmöglich, einen negativen Wert zu übergeben, um die Zeiger auf die Methodentabelle oder den Synchronisationsblockindex nicht zu verderben.  Es wird also etwas komplizierter. <br><br>  Beginnen wir mit dem Schreiben des Codes.  Zunächst schlage ich vor, mit einem einfachen Beispiel zu beginnen.  Erstellen Sie folgende Klasse: <br><br><pre><code class="plaintext hljs">public class CustomClass { public override string ToString() { return "CUSTOM"; } public virtual object Field { get; } = new object(); }</code> </pre> <br>  Als nächstes verwenden wir den oben beschriebenen Mechanismus, um Feldversätze explizit anzugeben. <br><br><pre> <code class="plaintext hljs"> [StructLayout(LayoutKind.Explicit)] public class CustomStructWithLayout { [FieldOffset(0)] public string Str; [FieldOffset(0)] public CustomClass SomeInstance; }</code> </pre><br>  Im Moment werde ich die Erklärungen verschieben und die schriftliche Klasse wie folgt verwenden: <br><br><pre> <code class="plaintext hljs"> class Program { static void Main(string[] args) { CustomStructWithLayout instance = new CustomStructWithLayout(); instance.SomeInstance = new CustomClass(); instance.Str = "4564"; Console.WriteLine(instance.SomeInstance.GetType()); //System.String Console.WriteLine(instance.SomeInstance.ToString()); //4564 Console.Read(); } }</code> </pre><br>  <i>Wenn</i> Sie die <i>GetType ()</i> -Methode <i>aufrufen, wird</i> eine Zeichenfolge zurückgegeben. Die <i>ToString ()</i> -Methode ist ungezogen und gibt uns die Zeichenfolge "4564". <br><br>  Gehirnentladung: Was wird nach dem Aufruf der virtuellen <b>CustomClass-</b> Eigenschaft angezeigt? <br><br>  Wie Sie bereits vermutet haben, haben wir <b>CustomStructWithLayout</b> initialisiert. Beide Links sind null. Dann initialisieren wir das Feld unseres Typs und weisen die Zeichenfolge dem Feld Str zu.  Infolgedessen <b>verweist der CustomClass-</b> Link nicht auf das <b>CustomClass-</b> Objekt, sondern auf das System.string-Objekt (einschließlich der Methodentabelle und des Index der Synchronisationseinheit).  Der Compiler sieht jedoch, dass das Feld immer noch vom Typ unserer Klasse ist. <br><br>  Zum Beweis hier ein kleiner Ausschnitt aus WinDbg: <br><br><img src="https://habrastorage.org/webt/l5/rb/oo/l5rbooilguqctypvbhwoyfhyq5m.jpeg"><br><br>  Hier können Sie einige ungewöhnliche Dinge sehen. <br><br><ul><li>  In <b>CustomStructWithLayout haben</b> Objektfelder unterschiedliche Adressen von Methodentabellen (sehr zu erwarten), aber die Adressen von Objekten sind gleich. </li><li>  Das zweite ist, dass Sie sehen können, dass sich beide Felder am Versatz 4 befinden. Ich denke, die meisten werden verstehen, aber nur für den Fall, ich werde erklären, direkt an die Adresse des Objekts einen Link zur Methodentabelle platziert.  Die Felder beginnen mit einem Versatz von 4 Bytes (für 32 Bit), und der Index des Synchronisationsblocks befindet sich mit einem Versatz von -4.  Somit haben beide Objekte den gleichen Versatz. </li></ul><br>  Nachdem Sie herausgefunden haben, was passiert, können Sie versuchen, mithilfe von Offsets aufzurufen, was nicht hätte aufgerufen werden sollen. <br><br>  Dazu habe ich die Struktur der String-Klasse in einer meiner Klassen wiederholt.  Aber ich habe nur den Anfang wiederholt, da die Klassenfolge ziemlich umfangreich ist und ich sehr faul bin. <br><br>  Hinweis: Konstanten und Statiken sind nicht erforderlich, nur zum Spaß. <br><br><pre> <code class="plaintext hljs"> public class CustomClassLikeString { public const int FakeAlignConst = 3; public const int FakeCharPtrAlignConst = 3; public static readonly object FakeStringEmpty; public char FakeFirstChar; public int FakeLength = 3; public const int FakeTrimBoth = 3; public const int FakeTrimHead = 3; public const int FakeTrimTail = 3; public CustomClassLikeString(){} public CustomClassLikeString(int a){} public CustomClassLikeString(byte a){} public CustomClassLikeString(short a){} public CustomClassLikeString(string a){} public CustomClassLikeString(uint a){} public CustomClassLikeString(ushort a){} public CustomClassLikeString(long a){ } public void Stub1() { } public virtual int CompareTo(object value) { return 800; } public virtual int CompareTo(string value) { return 801; } }</code> </pre><br>  Nun, die Struktur mit dem Layout wird ein wenig geändert. <br><br><pre> <code class="plaintext hljs"> [StructLayout(LayoutKind.Explicit)] public class CustomStructWithLayout { [FieldOffset(0)] public string Str; [FieldOffset(0)] public CustomClassLikeString SomeInstance; }</code> </pre><br>  Wenn Sie <i>FakeLength</i> oder die <i>CompareTo ()</i> -Methode aufrufen, wird aufgrund des identischen Versatzes dieser Klassenmitglieder relativ zur Adresse des Objekts selbst die entsprechende Zeichenfolgenmethode aufgerufen (in diesem Fall). <br><br>  Das Aufrufen der ersten privaten Methode der Zeichenfolge, die ich verwenden kann, war zu lang, sodass ich bei einer öffentlichen angehalten habe.  Aber das Feld ist privat, alles ist ehrlich.  Übrigens werden die Methoden virtuell gestaltet, um sie vor Optimierungen zu schützen, die die Arbeit beeinträchtigen (z. B. Einbetten), und um die Methode durch den Offset in der Methodentabelle aufzurufen. <br><br>  Also Leistung.  Es ist klar, dass ein direkter Konkurrent beim Aufrufen von Dingen, die nicht aufgerufen werden sollten, und bei Verstößen gegen die Kapselung Reflexion ist.  Ich denke, es ist klar, dass wir schneller sind als dieses Ding, weil wir keine Metadaten analysieren.  Genaue Werte: <br><table><tbody><tr><th>  Methode </th><th>  Job </th><th>  Mittelwert </th><th>  Fehler </th><th>  Stddev </th><th>  Median </th></tr><tr><td>  StructLayoutField </td><td>  Clr </td><td>  0,0597 ns </td><td>  0,0344 ns </td><td>  0,0396 ns </td><td>  0,0498 ns </td></tr><tr><td>  ReflectionField </td><td>  Clr </td><td>  197,1257 ns </td><td>  1,9148 ns </td><td>  1,7911 ns </td><td>  197,4777 ns </td></tr><tr><td>  StructLayoutMethod </td><td>  Clr </td><td>  3,5195 ns </td><td>  0,0382 ns </td><td>  0,0319 ns </td><td>  3,5285 ns </td></tr><tr><td>  ReflectionMethod </td><td>  Clr </td><td>  743,9793 ns </td><td>  13.7378 ns </td><td>  12.8504 ns </td><td>  743,8471 ns </td></tr></tbody></table><br><br>  Hier ist ein langer Code, wie ich die Leistung gemessen habe (wenn jemand sie benötigt): <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> [ClrJob] [RPlotExporter, RankColumn] [InProcessAttribute] public class Benchmarking { private CustomStructWithLayout instance; private string str; [GlobalSetup] public void Setup() { instance = new CustomStructWithLayout(); instance.SomeInstance = new CustomClassLikeString(); instance.Str = "4564"; str = "4564"; } [Benchmark] public int StructLayoutField() { return instance.SomeInstance.FakeLength; } [Benchmark] public int ReflectionField() { return (int)typeof(string).GetField("m_stringLength", BindingFlags.Instance | BindingFlags.NonPublic).GetValue(str); } [Benchmark] public int StructLayoutMethod() { return instance.SomeInstance.CompareTo("4564"); } [Benchmark] public int ReflectionMethod() { return (int)typeof(string).GetMethod("CompareTo", new[] { typeof(string) }).Invoke(str, new[] { "4564" }); } } class Program { static void Main(string[] args) { var summary = BenchmarkRunner.Run&lt;Benchmarking&gt;(); } }</code> </pre><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Russische Version</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de446478/">https://habr.com/ru/post/de446478/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de446464/index.html">15 Papageien: Wählen Sie einen Hosting-Anbieter für VPS / VDS-Server</a></li>
<li><a href="../de446466/index.html">Content Marketing for Business: Habraseminar Nr. 6 und seine wichtigsten Punkte</a></li>
<li><a href="../de446468/index.html">Praktischer Leitfaden zu Umgebungsvariablen in Go</a></li>
<li><a href="../de446472/index.html">Globales Update zur Anzeige der Lamptest.ru-Ergebnisse</a></li>
<li><a href="../de446476/index.html">Pläne für Angular 8.0 und Ivy</a></li>
<li><a href="../de446480/index.html">Unternehmensunsicherheit</a></li>
<li><a href="../de446488/index.html">Die Wahrheit über das Parsen von Websites oder "alle Online-Shops tun es"</a></li>
<li><a href="../de446490/index.html">JPoint 2019: kostenloses Live-Streaming, Party und mehr</a></li>
<li><a href="../de446492/index.html">Sieben einfache Schritte, um Student im Informatikzentrum zu werden</a></li>
<li><a href="../de446494/index.html">Lernen Sie die neuen Intel-Prozessoren kennen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>