<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë©‚Äçüëß ‚¨áÔ∏è üéÆ Projeto de armazenamento no MS SQL Server, integra√ß√£o com 1C 7.7 e automa√ß√£o de desenvolvimento em SSDT üñïüèæ ‚öìÔ∏è üèÇüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O tempo est√° se esgotando e logo n√£o restar√° quase nada desse desenvolvimento, mas ainda n√£o tive tempo de descrev√™-lo. 



 Ser√° sobre uma empresa no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Projeto de armazenamento no MS SQL Server, integra√ß√£o com 1C 7.7 e automa√ß√£o de desenvolvimento em SSDT</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423205/">  O tempo est√° se esgotando e logo n√£o restar√° quase nada desse desenvolvimento, mas ainda n√£o tive tempo de descrev√™-lo. <br><br><img src="https://habrastorage.org/webt/fi/5s/if/fi5siftwc5fvceqqsjgxfnqubum.png"><br><br>  Ser√° sobre uma empresa no n√≠vel federal, com um grande n√∫mero de filiais e sub-filiais.  Mas, como sempre, tudo come√ßou h√° muito tempo com uma pequena loja.  Ao longo dos anos, ocorreu um desenvolvimento bastante r√°pido e espont√¢neo, surgiram filiais, divis√µes e outros escrit√≥rios, e a infraestrutura de TI n√£o recebeu a devida aten√ß√£o naqueles dias, e isso tamb√©m √© uma ocorr√™ncia frequente.  √â claro que o 1C77 foi usado em todos os lugares, sem reservas para replica√ß√£o e dimensionamento; portanto, chegamos √† conclus√£o de que um Sprut-Frankenstein foi gerado com tent√°culos amarrados com fita isolante - em cada ramo havia um mutante aut√¥nomo que trocava com a base central no modo "joelho-alto", apenas alguns livros de refer√™ncia, sem os quais, bem, era imposs√≠vel e o resto √© aut√¥nomo.  Por algum tempo, eles se contentaram com c√≥pias (dezenas delas!) De bases de filiais no escrit√≥rio central, mas os dados neles ficaram por v√°rios dias. <br><br>  A realidade, no entanto, exige a obten√ß√£o de informa√ß√µes de maneira mais r√°pida e flex√≠vel, e √© preciso fazer outra coisa com isso.  A transfer√™ncia de um sistema cont√°bil para outro em tal escala ainda √© um p√¢ntano.  Portanto, decidiu-se criar um data warehouse (DX), no qual as informa√ß√µes fluiriam de diferentes bancos de dados, para que posteriormente outros servi√ßos e o sistema anal√≠tico na forma de cubos, relat√≥rios e vazamentos do SSRS pudessem receber dados deste CD. <br><br>  No futuro, direi que a transi√ß√£o para um novo sistema cont√°bil quase aconteceu e a maior parte do projeto descrito aqui ser√° cortada no futuro pr√≥ximo por desnecess√°ria.  Desculpe, √© claro, mas nada pode ser feito. <br><br>  A seguir, √© um artigo longo, mas antes de come√ßar a ler, observe que, em nenhum caso, aprovo essa decis√£o como padr√£o, mas talvez algu√©m encontre algo √∫til nela. <br><a name="habracut"></a><br>  Come√ßarei com uma abordagem geral do projeto, para a qual o SSDT foi escolhido como ambiente de desenvolvimento, com a publica√ß√£o subsequente do projeto no Git.  Eu acho que hoje existem v√°rios artigos e tutoriais suficientes que descrevem os pontos fortes dessa ferramenta.  Mas existem alguns pontos cujo problema est√° fora deste ambiente. <br><br><h4>  Armazenamento de enumera√ß√µes e vers√µes de banco de dados </h4><br>  Em rela√ß√£o √†s vers√µes e enumera√ß√µes, os requisitos para o projeto significavam: <br><br><ul><li>  Conveni√™ncia de editar e rastrear altera√ß√µes na vers√£o do banco de dados dentro do projeto </li><li>  Conveni√™ncia de visualizar a vers√£o do banco de dados atrav√©s do SSMS para administradores </li><li>  Salvando o hist√≥rico de altera√ß√µes de vers√£o no pr√≥prio banco de dados (quem e quando a implanta√ß√£o) </li><li>  Armazenando enumera√ß√µes em um projeto </li><li>  Facilidade de editar e rastrear altera√ß√µes nas transfer√™ncias </li><li>  Bloqueio de implanta√ß√£o de banco de dados em cima de um existente, se n√£o houver vers√£o de incremento </li><li>  A instala√ß√£o de uma nova vers√£o, hist√≥rico de grava√ß√£o, transfer√™ncias e reestrutura√ß√£o deve ser realizada em uma transa√ß√£o e revertida completamente em caso de falha em qualquer est√°gio </li></ul><br>  Porque  as transfer√™ncias geralmente cont√™m l√≥gica e s√£o valores b√°sicos, sem os quais a adi√ß√£o de registros a outras tabelas se torna imposs√≠vel (devido √†s chaves estrangeiras FK); em ess√™ncia, elas fazem parte da estrutura do banco de dados, juntamente com os metadados.  Portanto, uma altera√ß√£o em qualquer elemento de enumera√ß√£o leva a um incremento da vers√£o do banco de dados e, junto com esta vers√£o, os registros devem ter a garantia de atualiza√ß√£o durante a implanta√ß√£o. <br><br>  Eu acho que todas as vantagens de bloquear a implanta√ß√£o sem aumentar a vers√£o s√£o √≥bvias, uma das quais √© a incapacidade de executar novamente o script de publica√ß√£o, se ele j√° tiver sido executado com √™xito anteriormente. <br><br>  Embora a rede do banco de dados seja frequentemente proposta para usar apenas a vers√£o principal (sem fra√ß√µes), decidimos usar vers√µes no formato XY, em que Y √© o patch quando um erro de digita√ß√£o foi corrigido na descri√ß√£o da tabela, coluna, nome do elemento de listagem ou algo mais pequeno, como adicionar um coment√°rio a um procedimento armazenado etc.  Em todos os outros casos, a vers√£o principal √© criada. <br><br>  Talvez para algu√©m n√£o exista nada <i>disso</i> e tudo seja √≥bvio.  Mas, no devido tempo, despertei muitos nervos e energia em disputas internas sobre como armazenar transfer√™ncias no projeto de banco de dados, para que fosse o feng shui ( <i>de acordo com minha ideia</i> ) e que fosse conveniente trabalhar com eles, enquanto minimiza a probabilidade de erros. <br><br>  Com as transfer√™ncias, em geral, tudo √© simples - criamos um arquivo PostDeploy no projeto e escrevemos um c√≥digo para preencher as tabelas.  Com fus√µes ou trankates - √© assim que voc√™ gosta.  Preferimos piscar, verificando se o n√∫mero de registros na tabela de destino excede o n√∫mero de registros que est√£o na origem (projeto).  Se exceder, uma exce√ß√£o ser√° lan√ßada para chamar a aten√ß√£o, porque √© estranha.  Por que h√° menos registros na fonte?  Porque um √© sup√©rfluo?  Por que de repente?  E se o banco de dados j√° tiver links para ele?  Embora usemos chaves estrangeiras (FK), que n√£o permitem excluir o registro, se houver links para ele, ainda preferimos deixar essa op√ß√£o.  Como resultado, o PostDeploy se transformou em uma planilha ileg√≠vel, pois para cada tabela a ser preenchida, al√©m dos pr√≥prios valores, h√° tamb√©m um c√≥digo de verifica√ß√£o, uma mesclagem e assim por diante. <br><br>  No entanto, se voc√™ usar o PostDeploy no modo SQLCMD, ser√° poss√≠vel extrair blocos de c√≥digo em arquivos separados, como resultado, apenas uma lista estruturada de nomes de arquivos permanecer√° para preencher as enumera√ß√µes no PostDeploy. <br><br>  Existem algumas nuances nas vers√µes do banco de dados.  A Internet debate h√° muito tempo sobre onde armazenar a vers√£o do banco de dados, como deve ser e, em geral, se precisa ser armazenada em algum lugar?  Suponha que decidimos que precisamos, em que local do projeto o armazenamos?  Em algum lugar na natureza de um script PostDeploy, ou coloque-o em uma vari√°vel declarada na primeira linha do script? <br><br>  Na minha opini√£o, nem um nem o outro.  √â mais conveniente quando armazenado em um arquivo separado e n√£o h√° mais nada l√°. <br><br>  Algu√©m dir√° - h√° dacpac nas propriedades do projeto e voc√™ pode definir a vers√£o nele.  Obviamente, voc√™ pode at√© inserir essa vers√£o em seu script, conforme descrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> , mas isso √© inconveniente - para alterar a vers√£o do banco de dados, voc√™ precisa ir a algum lugar distante, clicar em v√°rios bot√µes.  Eu n√£o entendo a l√≥gica da Microsoft - eles a ocultaram em um canto distante, junto com par√¢metros de banco de dados como classifica√ß√£o, n√≠vel de compatibilidade etc., porque a vers√£o do banco de dados muda t√£o "frequentemente" quanto os par√¢metros de classifica√ß√£o, certo?  Quando h√° desenvolvimento constante, a vers√£o √© criada a cada nova implanta√ß√£o, bem, a conveni√™ncia de rastrear altera√ß√µes tamb√©m desempenha um papel importante, porque quando um arquivo alterado com um nome amig√°vel √© aceso, isso √© uma coisa e quando o arquivo de projeto .sqlproj √© aceso, em que existem muitas linhas no formato XML e, em algum lugar no centro da linha, um d√≠gito alterado √© destacado, de alguma forma n√£o muito. <br><br><img src="https://habrastorage.org/webt/bg/i3/48/bgi3485rgezdefuaami2weappqy.png"><br><br>  Melhor assim <br><br><img src="https://habrastorage.org/webt/ro/9y/ld/ro9yldaaeoqcmubpi42adq-so50.png"><br><br>  No entanto, talvez sejam apenas minhas baratas e voc√™ n√£o deve prestar aten√ß√£o nelas. <br><br>  Agora, a pergunta √©: onde armazenar esta vers√£o j√° no banco de dados implantado.  Novamente, parece que o dacpac faz isso lindamente - ele grava tudo nas placas do sistema, mas para ver a vers√£o, voc√™ precisa executar a solicita√ß√£o (ou pode ser de outra forma, mas n√£o sei como cozinh√°-las? Parece que nas vers√µes mais antigas do SSMS havia uma interface para isso, e agora n√£o) <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> msdb.dbo.sysdac_instances_internal</code> </pre> <br>  para o administrador (e n√£o apenas), n√£o √© muito conveniente.  √â muito mais l√≥gico que a vers√£o seja exibida diretamente nas propriedades do pr√≥prio banco de dados. <br><br><img src="https://habrastorage.org/webt/ed/ax/le/edaxle3ic1lfwvaeuhhhphmrulo.png"><br><br>  Ou n√£o? <br><br>  Para fazer isso, voc√™ precisa adicionar um arquivo ao projeto, inclu√≠do na compila√ß√£o, descrevendo as propriedades avan√ßadas <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>;</code> </pre> <br>  Sim, eles est√£o vazios e parecem feios em um script de publica√ß√£o, mas voc√™ n√£o pode ficar sem eles.  Se eles n√£o estiverem descritos no projeto e estiverem no banco de dados, o est√∫dio tentar√° exclu√≠-los sempre que for implantado.  (Houve muitas tentativas de contornar isso de forma sucinta e sem op√ß√µes de implanta√ß√£o desnecess√°rias, mas sem sucesso) <br><br>  Definiremos os valores para eles no script PostDeploy. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @username <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>) = suser_sname() ,@curdatetime <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">format</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>(),<span class="hljs-string"><span class="hljs-string">'dd.MM.yyyy HH:mm:ss'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = @username; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DBVersion)]; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_updateextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = @curdatetime;</code> </pre> <br>  <code>sp_updateextendedproperty</code> sem nenhuma verifica√ß√£o, porque no momento em que o bloco foi iniciado no PostDeploy, todas as propriedades j√° foram criadas se elas n√£o estavam l√°. <br><br>  Bem, seria bom manter o hist√≥rico, sobre quem e quando estava implantando o banco de dados. <br><br>  A implanta√ß√£o de altera√ß√µes de metadados pode ser realizada na transa√ß√£o usando ferramentas padr√£o, marcando a <b>caixa Ativar scripts de transa√ß√£o</b> na janela <b>Op√ß√µes avan√ßadas de publica√ß√£o</b> .  Mas esse sinalizador n√£o afeta os scripts (Pr√© / P√≥s) e eles continuam sendo executados sem uma transa√ß√£o.  Obviamente, nada impede que a transa√ß√£o seja iniciada no in√≠cio do script PostDeploy, mas ser√° uma transa√ß√£o separada dos metadados, e temos a tarefa de reverter as altera√ß√µes de metadados se ocorrer uma exce√ß√£o no PostDeploy. <br><br>  A solu√ß√£o √© simples - inicie a transa√ß√£o no PreDeploy e confirme-a no PostDeploy, e n√£o use nenhuma marca de sele√ß√£o nas configura√ß√µes de publica√ß√£o para esses fins. <br><br>  Para armazenar convenientemente a vers√£o do banco de dados no projeto e registr√°-la nos locais desejados durante a implementa√ß√£o, voc√™ pode recorrer √†s vari√°veis ‚Äã‚ÄãSQLCMD.  No entanto, n√£o quero armazenar a vers√£o em algum lugar natural do c√≥digo, quero que ela fique na superf√≠cie. <br><br><img src="https://habrastorage.org/webt/yg/qm/o9/ygqmo9wf5pnwnyx7kfnumsflps8.png"><br><br>  Para colocar a vers√£o do banco de dados em um arquivo separado e gerenciar a vers√£o a partir da√≠ no n√≠vel do projeto, adicionamos o seguinte bloco ao .sqlproj: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BeforeBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\Properties\DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lines"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtDBVersion"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WriteLinesToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\\SetPreDepVarsTmp.sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Lines</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":setvar DBVersion $(ExtDBVersion)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Overwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Esta √© uma instru√ß√£o para o MSBuild ler uma linha de um arquivo antes de criar e criar um arquivo tempor√°rio com base nos dados lidos.  O MSBuild criar√° um arquivo <code>SetPreDepVarsTmp.sql</code> tempor√°rio, que <code>:setvar DBVersion $(ExtDBVersion)</code> linha <code>:setvar DBVersion $(ExtDBVersion)</code> , onde <code>$(ExtDBVersion)</code> √© o valor lido do nosso arquivo que armazena a vers√£o do banco de dados. <br><br>  Ap√≥s essas manipula√ß√µes, voc√™ pode consultar este arquivo tempor√°rio no script PreDeploy e iniciar a transa√ß√£o global: <br><br><pre> <code class="sql hljs">:r .\SetPreDepVarsTmp.sql go :r ".\BeginTransaction.sql"</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Vers√£o intermedi√°ria</b> <div class="spoiler_text">  Inicialmente, o arquivo ExtendedProperties.sql n√£o recebeu valores vazios, mas valores de vari√°veis <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeployerName'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DeployerName)]; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DeploymentDate'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DeploymentDate)]; GO <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> sp_addextendedproperty @<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = N<span class="hljs-string"><span class="hljs-string">'DBVersion'</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = [$(DBVersion)];</code> </pre> <br>  As vari√°veis, por sua vez, foram registradas no arquivo SetPreDepVarsTmp.sql automaticamente pelo MSBuild, assim: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentDateTime</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.DateTime]::Now.ToString(dd.MM.yyyy HH:mm:ss))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentDateTime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NewLine</span></span></span><span class="hljs-tag">&gt;</span></span> -- <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NewLine</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BeforeBuild"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Lines"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExtDBVersion"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ReadLinesFromFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WriteLinesToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">File</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ProjectDir)\SetPreDepVarsTmp.sql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Lines</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">":setvar DBVersion $(ExtDBVersion)$(NewLine):setvar DeploymentDate "</span></span></span><span class="hljs-tag">$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CurrentDateTime</span></span></span><span class="hljs-tag">)"$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NewLine</span></span></span><span class="hljs-tag">)</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:setvar</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DeploymentUser</span></span></span><span class="hljs-tag"> $(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UserDomain</span></span></span><span class="hljs-tag">)\$(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">UserName</span></span></span><span class="hljs-tag">)" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Overwrite</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Com essa abordagem, voc√™ n√£o precisa reinstalar essas propriedades no PostDeploy, mas o problema √© que SetPreDepVarsTmp.sql continha valores est√°ticos e se o script de publica√ß√£o foi gerado agora, mas implantado em uma hora ou, pior ainda, no dia seguinte (o desenvolvedor verificou por um longo tempo visualmente, por exemplo), a data de publica√ß√£o especificada nas propriedades ser√° diferente da data de publica√ß√£o real e n√£o coincidir√° com a data no hist√≥rico. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Conte√∫do do arquivo BeginTransaction.sql</b> <div class="spoiler_text">  Em ess√™ncia, isso √© apenas copiar e colar do bloco inicial de transa√ß√£o padr√£o que o est√∫dio gera quando a <b>caixa de</b> sele√ß√£o <b>Ativar scripts de transa√ß√£o</b> est√° <b>marcada</b> , mas n√≥s a usamos √† nossa maneira.  No script, apenas o nome da tabela tempor√°ria foi alterado de <code>#tmpErrors</code> para <code>#tmpErrorsManual</code> para que n√£o haja conflito de nomes se algu√©m <code>#tmpErrorsManual</code> a caixa de sele√ß√£o. <br><br><pre> <code class="sql hljs">IF (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> OBJECT_ID(<span class="hljs-string"><span class="hljs-string">'tempdb..#tmpErrors'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual GO CREATE TABLE #tmpErrorsManual (Error int) GO SET XACT_ABORT ON GO SET TRANSACTION ISOLATION LEVEL READ COMMITTED GO BEGIN TRANSACTION GO</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script PostDeploy</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @TableName <span class="hljs-built_in"><span class="hljs-built_in">VarChar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-comment"><span class="hljs-comment">--        if $(SkipEnumDeploy) = 0 begin PRINT N' ...' :r ..\\EnumTable1.sql end --   PRINT N'  ...'; declare @username varchar(256) = suser_sname() , @curdatetime varchar(20) = format(getdate(),'dd.MM.yyyy HH:mm:ss') if $(DBVersion) &gt; (select isnull( MAX( DBVersion),0) from zDBVersionHistory) begin insert into zDBVersionHistory( DBVersion, DeploymentDate, DeployerName) values ($(DBVersion),@curdatetime,@username) EXECUTE sp_updateextendedproperty @name = N'DeployerName', @value = @username; EXECUTE sp_updateextendedproperty @name = N'DBVersion', @value = [$(DBVersion)]; EXECUTE sp_updateextendedproperty @name = N'DeploymentDate', @value = @curdatetime; end else begin RaisError ( N':          ,  .      ,        DBVersion          .' , 16 , 1 ) WITH SETERROR; end GO :r ".\CaptureTransactionError.sql" :r ".\CommitTransaction.sql"</span></span></code> </pre> <br>  A vari√°vel SkipEnumDeploy, como j√° ficou clara, permite que voc√™ pule o est√°gio de atualiza√ß√£o de listagens; isso pode ser √∫til para pequenas altera√ß√µes cosm√©ticas.  Embora, do ponto de vista da religi√£o, isso possa n√£o ser verdade, no entanto, √© definitivamente √∫til no est√°gio de desenvolvimento. <br></div></div><br>  Os arquivos <code>CaptureTransactionError.sql</code> e <code>CommitTransaction.sql</code> tamb√©m <code>CommitTransaction.sql</code> copiados e colados (com corre√ß√µes menores) do algoritmo de transa√ß√£o padr√£o que o est√∫dio gera quando o sinalizador acima √© definido, e que agora tocamos por conta pr√≥pria. <br><br><div class="spoiler">  <b class="spoiler_title">Content CaptureTransactionError.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF @@ERROR &lt;&gt; 0 AND @@TRANCOUNT &gt; 0 <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @@TRANCOUNT = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual (Error) VALUES (1); BEGIN TRANSACTION; END</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Conte√∫do CommitTransaction.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs">IF EXISTS (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpErrorsManual) ROLLBACK TRANSACTION GO DROP TABLE #tmpErrorsManual GO IF @@TRANCOUNT&gt;0 BEGIN PRINT N'     .' COMMIT TRANSACTION END ELSE RaisError ( N'    .' , 16 , 1 );</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Conte√∫do EnumTable1.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TableName = N<span class="hljs-string"><span class="hljs-string">'Table1'</span></span> PRINT N<span class="hljs-string"><span class="hljs-string">'  '</span></span>+@TableName+<span class="hljs-string"><span class="hljs-string">'...'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> try <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> nocount <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> <span class="hljs-comment"><span class="hljs-comment">#tmpEnums; select * into #tmpEnums from (values ( 0, ' 1') , ( 1, ' 2') , ( 2, ' 3') ) as tmp ( Id , Title ) set nocount off --         If ((select count(*) from Table1) &gt; (select count(*) from #tmpEnums)) begin RaisError ( N':      ,   .' , 0 , 1 ) WITH SETERROR; end set Identity_insert Table1 on Merge Table1 as target Using ( select * from #tmpEnums except select * from dbo.Table1 ) as source on target.Id = source.Id when matched then update set target.Title = source.Title when not matched by target then insert ( Id , Title ) values ( source.Id , source.Title ); set Identity_insert Table1 off drop table if exists #tmpEnums; END TRY begin catch IF @@trancount &gt; 0 ROLLBACK TRANSACTION set @Error_Message = Error_Message(); RaisError ( N': %s.' , 0 , 1 , @Error_Message ) WITH SETERROR; end catch :r "..\\CaptureTransactionError.sql"</span></span></code> </pre> <br></div></div><br>  Ao implantar o <code>Publish</code> script ter√° a seguinte estrutura <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- PreDeploy ----:setvar DBVersion "10.6" --   ,     DBVersion ----   --    ,           -- PostDeploy ----  ----   ----  </span></span></code> </pre> <br><br>  Idealmente, √© claro, gostaria que a vers√£o fosse exibida no momento da publica√ß√£o <br><img src="https://habrastorage.org/webt/8a/9w/o2/8a9wo2o5lemfglm1ru1kt5yntdm.png"><br><br>  Mas voc√™ n√£o pode extrair o valor do arquivo para esta janela, embora o MSBuild o leia e o coloque na propriedade ExtDBVersion com a ajuda de instru√ß√µes adicionais no arquivo .sqlproj, como no exemplo acima, mas a constru√ß√£o <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCmdVariable</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DBVersion"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span>$(ExtDBVersion)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCmdVariable</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  n√£o rola. <br><br>  Os desenvolvedores de sequelas em seu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">di√°rio</a> escrevem como isso √© feito.  De acordo com sua vers√£o, a m√°gica est√° na instru√ß√£o <code>SqlCommandVariableOverride</code> , que √© simples - adicione algumas linhas ao arquivo de projeto .sqlproj <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SqlCommandVariableOverride</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DBVersion=$(ExtDBVersion)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  e pronto.  Boa tentativa, mas n√£o.  Talvez quando este post foi publicado, tudo funcionou, mas desde ent√£o, nos Estados Unidos, voc√™ teve tr√™s elei√ß√µes presidenciais e ningu√©m sabe quais instru√ß√µes podem parar de funcionar amanh√£. <br><br><img src="https://habrastorage.org/webt/xv/d9/li/xvd9liiwyjicnv5icr9d1utjnxs.jpeg"><br><br>  E <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> um camarada tentou todas as op√ß√µes, mas nenhuma delas decolou. <br><br>  Portanto, pegue a vers√£o do dacpac ou armazene-a no PostDeploy, ou em um arquivo separado, ou _________ (insira sua vers√£o). <br><br><h4>  Integra√ß√£o com 1C </h4><br>  O primeiro problema foi que o 1C77 n√£o possui servidor de aplicativos ou outro daemon que permita interagir com ele sem iniciar a plataforma.  Quem trabalhou com 1C77 sabe que ela n√£o possui um modo de console completo.  Voc√™ pode executar a plataforma com par√¢metros e at√© fazer algo com base neles, mas h√° muito poucos par√¢metros de console e seu objetivo era diferente.  Mas mesmo com a ajuda deles, voc√™ pode nakolkhozit uma combina√ß√£o inteira.  No entanto, ele pode voar imprevisivelmente, pode abrir uma janela modal e aguardar algu√©m clicar em OK e em outros encantos.  E, talvez, o maior problema - a velocidade da plataforma deixe muito a desejar ... Portanto, existe apenas uma solu√ß√£o - consultas diretas ao banco de dados 1C.  Dada a estrutura, voc√™ n√£o pode simplesmente pegar e escrever essas consultas, mas o benef√≠cio √© que toda a comunidade desenvolveu uma ferramenta maravilhosa - 1C ++ (1cpp.dll), que √© incr√≠vel para eles, OBRIGADO!  A biblioteca permite que voc√™ escreva consultas em termos de 1C, que depois se transformam em nomes reais de tabelas e campos.  Se algu√©m n√£o souber, a solicita√ß√£o pode ser escrita usando um pseudo-nome e ficar√° assim <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $.</code> </pre> <br>  Essa solicita√ß√£o √© compreens√≠vel para os seres humanos, mas n√£o existe tal tabela e campo no servidor; existem outros nomes; portanto, 1C ++ o transformar√° em <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> SP5278 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> SC2235</code> </pre> <br>  e essa solicita√ß√£o j√° √© entendida pelo servidor.  Todo mundo est√° feliz, ningu√©m jura - nem uma pessoa nem um servidor.  Aqui, ao que parece, o problema foi resolvido. <br><br>  O segundo problema estava no plano de configura√ß√µes: uma configura√ß√£o era usada nas filiais, outra no escrit√≥rio central e a terceira nas filiais!  Classe? !! 1 Eu tamb√©m acho.  Al√©m disso, eles n√£o s√£o t√≠picos e nem sequer s√£o patrim√¥nios t√≠picos, mas completamente escritos do zero durante os vikings e, infelizmente, n√£o os melhores arquitetos lan√ßaram as bases desses conf ... Implementa√ß√£o de documentos, por exemplo, em cada configura√ß√£o, tem um conjunto diferente de detalhes.  Mas n√£o apenas os nomes de alguns campos diferem, o que √© muito mais divertido quando os nomes dos detalhes s√£o os mesmos, mas o significado dos dados armazenados neles √© DIFERENTE. <br><br><img src="https://habrastorage.org/webt/hs/jx/sv/hsjxsv_f7qy4xlgpwjiw7uir0ko.jpeg"><br><br>  Nas configura√ß√µes, quase nenhum registro √© usado, tudo √© constru√≠do com base nas complexidades dos documentos.  Portanto, √†s vezes eu tinha que escrever uma planilha inteira em uma transa√ß√£o limpa, com v√°rios casos e jun√ß√µes, para repetir a l√≥gica de algum procedimento da configura√ß√£o, que exibe algumas informa√ß√µes no campo de texto no formul√°rio. <br><br>  Devemos prestar homenagem √† equipe de desenvolvimento, que todos esses anos apoiaram o que eles herdaram dos "implementadores", √© um trabalho enorme - apoiar isso e at√© otimizar alguma coisa.  At√© voc√™ ver - voc√™ n√£o entende, eu mesmo n√£o acreditei no come√ßo que tudo pudesse ser t√£o complicado.  Pergunte - por que n√£o reescrever do zero?  Banal falta de recursos.  A empresa estava se desenvolvendo t√£o r√°pido que, apesar de uma grande equipe de programadores, eles simplesmente n√£o conseguiam acompanhar as necessidades dos neg√≥cios, sem mencionar a reescrita de todo o conceito. <br><br>  Continuamos a hist√≥ria dos pedidos.  Obviamente, todos os blocos para extra√ß√£o de dados se transformaram em armazenamentos, para que mais tarde eles pudessem ser lan√ßados no servidor ignorando a plataforma 1C.  A regra era a seguinte: um armazenamento √© respons√°vel por recuperar uma entidade.  Porque  A lista de desejos no est√°gio inicial j√° se acumulou bastante, porque se tornou dolorosa ao longo dos anos e, em seguida, dezenas de arquivos de armazenamento acabaram. <br><br>  O terceiro problema √© como aumentar a velocidade e a qualidade do desenvolvimento e como apoiar todo esse monstro?  Escreva uma solicita√ß√£o para 1C ++ e copie e cole o resultado de sua convers√£o em um armazenamento?  √â muito inconveniente e entediante, al√©m disso, existe uma alta probabilidade de erros - copie o errado ou o errado ou n√£o selecione a √∫ltima linha da consulta e copie sem ela.  Isso √© especialmente verdadeiro quando se trata de consultas 1C diretas, porque n√£o h√° pseudo-nome como <i>Directory.</i> Nomenclatura. Artigo, apenas nomes reais <i>SC2235.SP5278</i> e, portanto, copiar uma solicita√ß√£o do diret√≥rio de mercadorias para uma loja que recupera clientes √© muito simples.  Obviamente, a solicita√ß√£o provavelmente cair√° devido √† incompatibilidade de tipos e n√∫mero de campos na tabela de destino, mas existem placas id√™nticas, como enumera√ß√µes, nas quais apenas duas colunas s√£o ID e Nome.  Em geral, resta apenas aplicar algum tipo de automa√ß√£o.  Bem, letras suficientes, vamos ao que interessa! <br><br>  Eu queria que o processo de desenvolvimento de armazenamento se resumisse a algo assim: <br><br><ol><li>  Corrigimos a consulta SQL com pseudo-nomes e salvamos </li><li>  Pressionamos um <b>bot√£o m√°gico</b> e, na sa√≠da, recebemos o procedimento armazenado corrigido no SQL convertido, limpo para o servidor </li></ol><br><h4>  Alguns detalhes </h4><br>  Para resolver o terceiro problema, o processamento externo (.ert) foi gravado.  Existem v√°rios procedimentos em processamento, cada um dos quais cont√©m o texto da consulta para extrair uma entidade usando um pseudo-nome, como <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> $.</code> </pre> <br>  No formul√°rio de processamento, h√° um campo para exibir o resultado de um procedimento espec√≠fico, ou seja,  solicita√ß√£o convertida para um formul√°rio compreens√≠vel para o servidor, para que voc√™ possa test√°-lo rapidamente.  Al√©m disso, um <b>bloco de depura√ß√£o √©</b> sempre adicionado a essa solicita√ß√£o, com a declara√ß√£o de vari√°veis, os nomes dos bancos de dados de teste, servidores e muito mais.  Resta apenas copiar e colar no SSMS e pressionar F5.  √â claro que voc√™ pode executar essa solicita√ß√£o a partir do pr√≥prio processamento, mas o plano de solicita√ß√£o e tudo o que, bem, voc√™ entende ... Em geral, √© assim que a depura√ß√£o √© feita.  Porque  Existem v√°rias configura√ß√µes: no processamento, √© poss√≠vel converter os mesmos textos de consulta com pseudo-nomes de objetos em consultas finais para configura√ß√µes diferentes.  De fato, em uma refer√™ncia da Nomenclatura confe √© SC123 e em outra - SC321.  Mas o 1C ++ permite carregar configura√ß√µes diferentes em tempo de execu√ß√£o e gerar uma sa√≠da individual para cada uma delas, de acordo com o dicion√°rio. <br><br>  Em seguida, o modo de execu√ß√£o em lote foi adicionado ao processamento, quando ele inicia automaticamente cada um dos procedimentos para cada configura√ß√£o e a sa√≠da de cada um deles √© gravada em arquivos .sql (a seguir, os arquivos b√°sicos).  Assim, obtemos v√°rias combina√ß√µes de arquivos b√°sicos, que posteriormente devem se transformar automaticamente em procedimentos armazenados usando o VS.  Vale ressaltar que os arquivos base incluem <b>um bloco de depura√ß√£o</b> . <br><br>  Parece, por que n√£o concluir imediatamente os arquivos finais dos procedimentos armazenados e manter tudo nesse processamento?  O fato √© que, para alguns testes, √© necess√°rio executar vers√µes de depura√ß√£o de consultas em lotes nos quais todas as vari√°veis ‚Äã‚Äãs√£o declaradas, al√©m disso, eu queria que os nomes dos procedimentos armazenados fossem gerenciados pelo VS, ignorando 1C, porque √© l√≥gico, n√£o √©? <br><br>  A prop√≥sito, os arquivos b√°sicos tamb√©m s√£o armazenados no projeto, bem, os arquivos dos procedimentos armazenados prontos, √© claro.  A qualquer momento, sem iniciar o 1C, voc√™ pode abrir o arquivo base no SSMS e execut√°-lo sem se preocupar com declara√ß√µes de vari√°veis. <br><br>  No processamento, todos os procedimentos com solicita√ß√µes tamb√©m s√£o modelo, com o mesmo conjunto de par√¢metros, mas neste ou naquele procedimento apenas os par√¢metros necess√°rios s√£o utilizados.  Em alguns, tudo est√° envolvido e, em alguns, dois s√£o suficientes.  Portanto, adicionar um novo procedimento se resume a copiar o modelo e preencher os par√¢metros com as pr√≥prias consultas. <br><br>  O c√≥digo de um dos procedimentos de processamento, que depois se transformar√° em um procedimento armazenado <br><img src="https://habrastorage.org/webt/ci/ev/sb/cievsb9urq5miainrvoqu9mkig0.png"><br><br>  A consulta final est√° mais ou menos assim: <br><pre> <code class="1c hljs">++<span class="hljs-string"><span class="hljs-string">"("</span></span>+OPENQUERY()+<span class="hljs-string"><span class="hljs-string">")"</span></span>+ </code> </pre> <br>  Apar√™ncia do processamento <br><img src="https://habrastorage.org/webt/yv/n4/in/yvn4injz09-m8ljnqhbediqvmqy.png"><br><br>  Ao alternar configura√ß√µes, a lista de itens dispon√≠veis (necess√°rios) para descarregar itens na lista Dados √© alterada.  Se poss√≠vel, o c√≥digo do procedimento em 1C foi o m√°ximo poss√≠vel unificado.  Se as contrapartes s√£o extra√≠das e esses diret√≥rios s√£o inconsistentes em configura√ß√µes diferentes, ent√£o dentro do procedimento de gera√ß√£o existem casos diferentes, como: esse bloco √© corrigido para todos, este √© adicionado √† solicita√ß√£o final apenas para uma conf. E existe um para o outro.  Acontece que nos procedimentos armazenados para uma entidade, mas em configura√ß√µes diferentes, eles podem diferir n√£o apenas pelos nomes de tabelas, mas tamb√©m por blocos inteiros de jun√ß√µes presentes em uma e ausentes em outra.  O conjunto de campos de sa√≠da, √© claro, √© o mesmo e corresponde √† tabela receptora ou ao cont√™iner do pacote SSIS; alguns campos est√£o obstru√≠dos com stubs para configura√ß√µes nas quais esses detalhes n√£o s√£o em princ√≠pio. <br><br>  <b>Bot√£o m√°gico</b> <br><br>  O Visual Studio possui ferramentas como o MSbuild e os incr√≠veis modelos T4.  Portanto, como um bot√£o m√°gico, um script foi escrito em C # para T4, que: <br><br><ol><li>  Registra uma configura√ß√£o vazia no registro (caso contr√°rio, 1C exibir√° uma janela modal com uma sugest√£o para registrar uma conf e aguardar a√ß√µes do usu√°rio) </li><li>  Cria um banco de dados vazio para este konf no servidor SQL, porque sem ele o 1C dar√° um erro </li><li>  Inicia 1C e atrav√©s do OLE diz para executar o processamento (o mesmo .ert), tamb√©m transferindo um GUID exclusivo para 1C </li><li>  A sa√≠da √© uma s√©rie de arquivos com solicita√ß√µes prontas (convertidas) e um arquivo de marcador, no qual o GUID recebido na inicializa√ß√£o √© gravado </li><li>  O registro do conf √© exclu√≠do do registro e um banco de dados tempor√°rio vazio √© exclu√≠do do servidor </li><li>  Verifica o conte√∫do do arquivo de token.  Se o arquivo do marcador contiver o GUID que passamos para o 1C quando iniciado, significa que ele funcionou at√© o fim, n√£o travou, etc., ent√£o v√° para a pr√≥xima etapa ou exibimos um erro </li><li>  Criamos armaz√©ns. </li><li>  N√≥s descompilamos o arquivo .ert com o gcomp para obter os textos dos m√≥dulos e os formul√°rios de processamento, bem, convertemos para Unicode, para envio subsequente ao Git e exibido corretamente l√°.  Para aqueles que n√£o trabalharam com 1C: o arquivo .ert √© um bin√°rio e o est√∫dio, junto com o git, mostra que o arquivo .ert foi alterado, mas n√£o est√° claro o que exatamente mudou nele, talvez apenas algu√©m tenha movido o bot√£o um pixel para a esquerda (o que inaceit√°vel sem justificativa) </li></ol><br><br>     T4       ,     (   ,    )        .      ,          .         ,     ,       ,      ,         - ‚Äî   1. <br><br>  ,  ,    ,        ,        ,          .      ‚Äî   1,     1,  -   . <br><br>      :       ? <br><br><ol><li>     / ; </li><li>    VS     ,     ; </li><li>   4; </li><li> <s>.</s>  Feito. </li></ol><br><div class="spoiler"> <b class="spoiler_title">?</b> <div class="spoiler_text">  Porque               ,       ,    .sqlproj,  <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \1.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \2.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \3.sql"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" \*.sql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>       ¬´     ¬ª.   ,  ,   ,     :) <br><br>     , ,    (, )     .           ( ),         , -   - -       ,             . <br></div></div><br>         ,      .      . , ,      ,      ,       ,       (    ),      . ,    (   ,      )  ,        ,  ,          .           ,   . ,     ,      ,     ,   ,     (   ,          1, ,    MD ). <br><br>      ,         <i>OPENQUERY</i> ,     1   ,     ,       ,       ,         <i>EXEC</i> . <i>OPENQUERY</i>    ,      ,   ,   . <br><br>  177 (  )   SQL2000,   varchar(max)  ,  varchar(8000),     9, ‚Ä¶ ,          EXEC(@SQL1+@SQL2).    ,       SQL2016,     SQL2000.     ,     ,    . <br><br><div class="spoiler"> <b class="spoiler_title">      </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName.dbo.$. <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> @<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName.dbo.$. <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> xxx = <span class="hljs-string"><span class="hljs-string">'hello!'</span></span> ^<span class="hljs-comment"><span class="hljs-comment">--       8 , ,        ,       ,   .          ,             .. ... join ... ) join ...</span></span></code> </pre> </div></div><br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[SP1] @LinkedServerName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) ,@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @TSQL0 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>), @TSQL1 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>), @TSQL2 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">8000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL0=<span class="hljs-string"><span class="hljs-string">' select ... from OPENQUERY('</span></span>+@LinkedName+<span class="hljs-string"><span class="hljs-string">','' select ... from '</span></span>+@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName+<span class="hljs-string"><span class="hljs-string">'.dbo.DH123. join '</span></span>+@<span class="hljs-number"><span class="hljs-number">1</span></span>CDBName+<span class="hljs-string"><span class="hljs-string">'.SC123. ... where '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL1=<span class="hljs-string"><span class="hljs-string">' xxx = ''''hello!'''' join ... join ... )'' join ... '''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @TSQL2=<span class="hljs-string"><span class="hljs-string">' ... EXEC(@TSQL0+@TSQL1+@TSQL2) END</span></span></code> </pre> <br></div></div><br>     ‚Äî     .       (, )   ,       , ,     ,      ,      ,   OPENQUERY  8 . <br><br> .ert             ,        ..  ,     . <br><br>          ,    . <br><br><h4> ETL </h4><br> ,       (  ).      (Stage).   ,  ETL    SSIS , ,   ,     ,      .      .                    (  ),            . <br><br>                 ,     (   ) ,   ,        (..   ),            ,        . <br><br>          ,     ,      . ,     .     zabbix. <br><br>             . <br><br>  Porque    1     ,        ,            .      ,   ,   <code>truncate</code>  . <br><br> ,       (  )       -,  ¬´ 1-¬ª     . <br><br>     SSIS  <br><br><img src="https://habrastorage.org/webt/al/nl/u_/alnlu_3yriilaxfcwlhq_mcf_ce.png"><br><br>      <br><br><img src="https://habrastorage.org/webt/rh/eh/c8/rhehc8b9jtn6qf6polrfqjiduuk.png"><br><br><h4>  ,   </h4><br>         SSIS     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> SQL Server</a> (SQL Server Destination),     ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> OLE DB</a> (OLE DB Destination). <br><br>      ,       ,     ,             .    ,        ,   . (,     ) <br><br>       .           ,    ,      ,        (/  ). <br>                      . <br><br>          ,         (  ).  I.e.       ,        .      ,        ,         .    -        ‚Äî          .            . <br><br>                  ,         (.. )   . <br><br>       ,     ,          . <br><br><h4>  PS </h4><br>     ,     ,      ,    ,   .   ‚Äî   ,    .           -  ,       ,   . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423205/">https://habr.com/ru/post/pt423205/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423191/index.html">Lan√ßamento dos elementos das plataformas offshore. Parte 1</a></li>
<li><a href="../pt423193/index.html">Configurar notifica√ß√µes por push da Web usando pywebpush passo a passo</a></li>
<li><a href="../pt423195/index.html">O que h√° de novo no JPA 2.2</a></li>
<li><a href="../pt423197/index.html">LOLWUT: uma obra de arte em uma equipe de db</a></li>
<li><a href="../pt423203/index.html">L√≠der de equipe legal ser√° respons√°vel pelo servi√ßo</a></li>
<li><a href="../pt423207/index.html">Como fazer uma atualiza√ß√£o autom√°tica de um cliente de jogo online</a></li>
<li><a href="../pt423209/index.html">Formul√°rio 2 do assassino? Vis√£o geral da impressora 3D dental MoonRay S100</a></li>
<li><a href="../pt423211/index.html">Comit√™ da Duma do Estado: gostos e republica√ß√µes permanecer√£o criminalmente respons√°veis</a></li>
<li><a href="../pt423213/index.html">Como no russo antigo, haver√° "este √© um teste"</a></li>
<li><a href="../pt423215/index.html">Onde est√° meu dinheiro, cara: sobre o que o Steam est√° calado</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>