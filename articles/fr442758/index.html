<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèß üòê üó°Ô∏è 5 astuces pour optimiser les requ√™tes SQL dans Greenplum üöò ‚óΩÔ∏è üí¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tout processus li√© √† la base de donn√©es rencontre t√¥t ou tard des probl√®mes de performances des requ√™tes vers cette base de donn√©es. 

 L'entrep√¥t de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>5 astuces pour optimiser les requ√™tes SQL dans Greenplum</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rostelecom/blog/442758/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/-5/0k/gz/-50kgzc35o2xwh_r_xzqqavfglg.jpeg"></a> <br><br>  Tout processus li√© √† la base de donn√©es rencontre t√¥t ou tard des probl√®mes de performances des requ√™tes vers cette base de donn√©es. <br><br>  L'entrep√¥t de donn√©es de Rostelecom est construit sur Greenplum, la plupart des calculs (transformation) sont effectu√©s par des requ√™tes SQL, qui d√©marrent (ou g√©n√®rent et d√©marrent) le m√©canisme ETL.  Le SGBD a ses propres nuances qui affectent consid√©rablement les performances.  Cet article est une tentative de mettre en √©vidence les aspects les plus critiques de travailler avec Greenplum en termes de performances et de partage d'exp√©rience. <br><br><div class="spoiler">  <b class="spoiler_title">En bref sur Greenplum</b> <div class="spoiler_text"> Greenplum - Serveur de base de donn√©es <abbr title="Traitement parall√®le massif">MPP</abbr> , dont le c≈ìur est construit sur PostgreSql. <br><br>  Repr√©sente plusieurs instances diff√©rentes du processus PostgreSql (instances).  L'un d'eux est le point d'entr√©e pour le client et est appel√© instance ma√Ætre (ma√Ætre), tous les autres sont appel√©s instances de segment (segment, instances ind√©pendantes, chacune ayant sa propre donn√©e).  Chaque serveur (h√¥te de segment) peut ex√©cuter un √† plusieurs services (segment).  Ceci est fait afin de mieux utiliser les ressources du serveur et principalement les processeurs.  L'assistant stocke les m√©tadonn√©es, est responsable de la communication des donn√©es avec les clients et distribue √©galement le travail entre les segments. <br><br><img src="https://habrastorage.org/webt/pd/9n/sa/pd9nsaodhcjqwwhzsfvvdflqlou.jpeg"><br><br>  En savoir plus dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> . <br></div></div><br>  Plus loin dans l'article, il y aura de nombreuses r√©f√©rences au plan de demande.  Les informations pour Greenplum sont disponibles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br><h2>  Comment √©crire de bonnes requ√™tes sur Greenplum (enfin, ou du moins pas vraiment triste) </h2><a name="habracut"></a><br>  Comme nous avons affaire √† une base de donn√©es distribu√©e, il est important non seulement comment la requ√™te SQL est √©crite, mais aussi comment les donn√©es sont stock√©es. <br><br><h3>  1. Distribution </h3><br>  Les donn√©es sont stock√©es physiquement sur diff√©rents segments.  Vous pouvez s√©parer les donn√©es par segments de fa√ßon al√©atoire ou par la valeur de la fonction de hachage d'un champ ou d'un ensemble de champs. <br><br>  Syntaxe (lors de la cr√©ation d'une table): <br><br><pre><code class="sql hljs">DISTRIBUTED BY (some_field)</code> </pre> <br>  Ou alors: <br><br><pre> <code class="sql hljs">DISTRIBUTED RANDOMLY</code> </pre> <br>  Le champ de distribution doit avoir une bonne s√©lectivit√© et ne pas avoir de valeurs nulles (ou avoir un minimum de telles valeurs), car les enregistrements avec ces champs seront distribu√©s sur un segment, ce qui peut entra√Æner des distorsions de donn√©es. <br><br>  Le type de champ est de pr√©f√©rence entier.  Le champ est utilis√© pour joindre des tables.  La jointure par hachage est l'un des meilleurs moyens de joindre des tables (en termes d'ex√©cution de requ√™te), fonctionne mieux avec ce type de donn√©es. <br><br>  Pour la distribution, il est conseill√© de ne pas choisir plus de deux champs, et, bien s√ªr, un vaut mieux que deux.  Les champs suppl√©mentaires dans les cl√©s de distribution, d'une part, n√©cessitent un temps suppl√©mentaire pour le hachage, et d'autre part (dans la plupart des cas), ils n√©cessiteront un transfert de donn√©es entre les segments lors de l'ex√©cution des jointures. <br><br>  Vous pouvez utiliser une distribution al√©atoire si vous ne pouvez pas s√©lectionner un ou deux champs appropri√©s, ainsi que pour les petites √©tiquettes.  Mais nous devons tenir compte du fait qu'une telle distribution fonctionne mieux pour l'insertion de donn√©es de masse, et non pour un enregistrement.  GreenPlum distribue les donn√©es selon l'algorithme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cyclique</a> , et il d√©marre un nouveau cycle pour chaque op√©ration d'insertion, √† partir du premier segment, ce qui, avec de petites insertions fr√©quentes, conduit √† des asym√©tries (asym√©trie des donn√©es). <br><br>  Avec un champ de distribution bien choisi, tous les calculs seront effectu√©s sur le segment, sans envoyer de donn√©es √† d'autres segments.  De plus, pour une jointure optimale des tables (jointure), les m√™mes valeurs doivent √™tre situ√©es sur le m√™me segment. <br><br><div class="spoiler">  <b class="spoiler_title">Distribution en images</b> <div class="spoiler_text">  <i>Bonne cl√© de distribution:</i> <br><img src="https://habrastorage.org/webt/x-/r9/8i/x-r98iuubqw2tkoea-tblqbgj-m.jpeg" height="700"><br><br>  <i>Mauvaise cl√© de distribution:</i> <br><img src="https://habrastorage.org/webt/79/ft/-g/79ft-gs67yhdwwq156dmxlsz74o.png"><br><br>  <i>Distribution al√©atoire:</i> <br><img src="https://habrastorage.org/webt/r8/eo/xr/r8eoxrz1t0eksmnylw7yco33rkm.png" height="700"><br></div></div><br>  Le type de champs utilis√© dans la jointure doit √™tre le m√™me dans toutes les tables. <br>  <b>Important:</b> n'utilisez pas comme champs de distribution ceux qui sont utilis√©s pour filtrer les requ√™tes dans o√π, car dans ce cas, la charge pendant la requ√™te ne sera pas √©galement distribu√©e de mani√®re uniforme. <br><br><h3>  2. Partitionnement </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le partitionnement</a> vous permet de diviser de grandes tables, telles que des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">faits</a> , en morceaux logiquement s√©par√©s.  Greenplum divise physiquement votre table en tables distinctes, chacune √©tant divis√©e en segments en fonction des param√®tres de la p. 1. <br><br>  Les tableaux doivent √™tre divis√©s en sections de mani√®re logique, √† cet effet, s√©lectionnez le champ souvent utilis√© dans le bloc where.  En fait, ce sera la p√©riode.  Ainsi, avec un acc√®s appropri√© √† la table dans les requ√™tes, vous ne travaillerez qu'avec une partie de la grande table enti√®re. <br><br>  En g√©n√©ral, le partitionnement est un sujet assez bien connu, et je voulais souligner que vous ne devriez pas choisir le m√™me champ pour le partitionnement et la distribution.  Cela conduira au fait que la demande sera ex√©cut√©e enti√®rement sur un segment. <br><br>  Il est temps de passer, en fait, aux demandes.  La demande sera ex√©cut√©e sur des segments selon un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plan</a> sp√©cifique: <br><br><h3>  3. L'optimiseur </h3><br>  Greenplum poss√®de deux optimiseurs, l'optimiseur h√©rit√© int√©gr√© et l'optimiseur tiers Orca: GPORCA - Orca - Pivotal Query Optimizer. <br><br>  Activer GPORCA sur demande: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> optimizer = <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>;</code> </pre> <br>  <b>En r√®gle g√©n√©rale</b> , l'optimiseur GPORCA est meilleur que le int√©gr√©.  Il fonctionne plus ad√©quatement avec les sous-requ√™tes et <abbr title="Expressions de table courantes">CTE</abbr> (plus de d√©tails <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ). <br>  A fait un appel √† une grande table en CTE avec un filtrage maximal des donn√©es (n'oubliez pas l'√©lagage de partition) et une liste de champs explicitement sp√©cifi√©e - cela fonctionne tr√®s bien. <br><br>  Il modifie l√©g√®rement le plan de requ√™te, par exemple, sinon affiche les partitions analys√©es: <br><br>  <i>Optimiseur standard:</i> <br><br><img src="https://habrastorage.org/webt/hg/0u/rq/hg0urqdrlaefwysxwszfpww18mc.png"><br><br>  <i>Orca:</i> <br><br><img src="https://habrastorage.org/webt/ct/hv/dz/cthvdzt2s5p126cdu1olhb5teci.png"><br><br>  GPORCA permet √©galement de mettre √† jour les champs de partition / distribution.  Bien qu'il existe des situations o√π l'optimiseur int√©gr√© fonctionne mieux.  Un optimiseur tiers est tr√®s exigeant sur les statistiques, il est important de ne pas oublier d' <abbr title="analyser">analyser</abbr> . <br><br>  Peu importe la qualit√© de l‚Äôoptimiseur, une requ√™te mal √©crite n‚Äô√©tirera m√™me pas Orca: <br><br><h3>  4. Manipulations avec des champs dans les conditions where block ou join </h3><br>  Il est important de se rappeler que la fonction appliqu√©e au champ de filtre ou les conditions de la jointure sont appliqu√©es √† <b>chaque</b> enregistrement. <br><br>  Dans le cas du champ de partitionnement (par exemple, date_trunc au champ de partitionnement - date), m√™me GPORCA ne peut pas fonctionner correctement dans ce cas, les <abbr title="√©lagage de partition">partitions de d√©coupage</abbr> ne fonctionneront pas. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     set optimizer = on; explain select * from edw_ods.t_000045_bills c where date_trunc('month',tech_dt) between to_date('20180101', 'YYYYMMDD') and to_date('20180101', 'YYYYMMDD') + interval '1 month - 1 second' ;</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/sc/qo/qv/scqoqv3h43a7ezkr4ug2zu8i9ta.png"><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--     set optimizer = on; explain select * from edw_ods.t_000045_bills c where tech_dt between to_date('20180101', 'YYYYMMDD') and to_date('20180101', 'YYYYMMDD') + interval '1 month - 1 second'</span></span></code> </pre><br><img src="https://habrastorage.org/webt/mo/xz/ah/moxzahjrapobpn_4dss02qykihc.png"><br><br>  <i>J'attire √©galement l'attention sur l'affichage des partitions.</i>  <i>L'optimiseur int√©gr√© affichera les partitions dans une liste:</i> <br><br><img src="https://habrastorage.org/webt/lf/it/wk/lfitwkzpj9xkbvnteyq6ynzc-rw.png"><br><br>  Appliquez soigneusement les fonctions aux constantes dans les m√™mes filtres de partition.  Un exemple est le m√™me date_trunc: <br><br><pre> <code class="sql hljs">date_trunc('month',to_date($p_some_dt, 'YYYYMMDD'))</code> </pre> <br><img src="https://habrastorage.org/webt/t8/ox/u1/t8oxu1zcmjm0ymsmgj0-we_dp7m.png"><br><br>  GPORCA supportera compl√®tement une telle feinte et fonctionnera correctement, l'optimiseur standard ne fonctionnera plus.  Cependant, en faisant une conversion de type explicite, vous pouvez la faire fonctionner: <br><br><pre> <code class="sql hljs">date_trunc('month',to_date($p_some_dt, 'YYYYMMDD'))::timestamp without time zone</code> </pre> <br><img src="https://habrastorage.org/webt/5y/in/3p/5yin3ppep3f9wuzd9ib_kxa2bdm.png"><br><br>  Et si tout est mal fait? <br><br><h3>  5. Motions </h3><br>  Les mouvements sont un autre type d'op√©ration que l'on peut observer dans <i>le plan de requ√™te</i> .  Mouvements de donn√©es si marqu√©s entre les segments: <br><br><ul><li>  <b>Rassembler le mouvement</b> - sera affich√© dans presque tous les plans, signifie combiner les r√©sultats de l'ex√©cution des requ√™tes de tous les segments en un seul flux (g√©n√©ralement vers le ma√Ætre). <br><br>  Deux tables, distribu√©es par une cl√©, qui est utilis√©e pour la jointure, effectuent toutes les op√©rations sur les segments, sans d√©placer les donn√©es.  Sinon, un mouvement de diffusion ou un mouvement de redistribution se produit: </li><li>  <b>Mouvement de diffusion</b> - chaque segment envoie sa copie des donn√©es aux autres segments.  Dans une situation id√©ale, la diffusion se produit uniquement pour les petites tables. </li><li>  <b>Mouvement de redistribution</b> - pour joindre de grandes tables r√©parties sur diff√©rentes cl√©s, la redistribution est effectu√©e pour √©tablir des connexions localement.  Pour les grandes tables, cela peut √™tre une op√©ration assez co√ªteuse. </li></ul><br>  La diffusion et la redistribution sont des op√©rations assez d√©savantageuses.  Ils sont ex√©cut√©s √† chaque ex√©cution de la demande.  Il est recommand√© de les √©viter.  Apr√®s avoir vu de tels points dans le plan de requ√™te, il convient de pr√™ter attention aux cl√©s de distribution.  Des op√©rations distinctes et syndicales provoquent √©galement des motions. <br><br>  Cette liste n'est pas exhaustive et se fonde principalement sur l'exp√©rience de l'auteur.  Il n'a pas fonctionn√© de tout trouver tout de suite sur Internet en m√™me temps.  Ici, j'ai essay√© d'identifier les facteurs les plus critiques affectant les performances de la demande, et de comprendre pourquoi et pourquoi cela se produit. <br><br>  <i>Cet article a √©t√© pr√©par√© par l'√©quipe de gestion des donn√©es de Rostelecom</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442758/">https://habr.com/ru/post/fr442758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442744/index.html">La solution RIPE et ses cons√©quences pour l'exclusion de deux LIR russes (Netup, gcxc.net)</a></li>
<li><a href="../fr442746/index.html">Fool App pour le Windows Store</a></li>
<li><a href="../fr442748/index.html">La chose √† propos du chapeau: les 10 meilleurs rapports de Heisenbug 2018 Moscou</a></li>
<li><a href="../fr442750/index.html">Djinn virtuel le 8 mars - ou comment surprendre vos employ√©s un jour de printemps</a></li>
<li><a href="../fr442754/index.html">Fonctionnement vs bases de donn√©es analytiques: stockage colonne vs stockage</a></li>
<li><a href="../fr442760/index.html">Un article sur la fa√ßon dont CommVault sauvegarde PostgreSQL</a></li>
<li><a href="../fr442762/index.html">Stagiaire Vasya et ses histoires sur l'API idempotency</a></li>
<li><a href="../fr442764/index.html">Recueil sur la gestion des produits. Ce qui excite les produits et les sp√©cialistes du marketing en 2019</a></li>
<li><a href="../fr442770/index.html">Pr√©sentation des scanners de codes-barres JavaScript</a></li>
<li><a href="../fr442772/index.html">Math√©matiques pour Data Scientist: Sections n√©cessaires</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>