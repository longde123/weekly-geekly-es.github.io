<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘ âŒ âœŒğŸ» L'architecture du service de file d'attente de messages distribuÃ©s dans Yandex.Cloud ğŸ’— â­ï¸ ğŸ¥£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, mon nom est Vasily Bogonatov. Je fais partie de ceux qui mettent ma main et ma tÃªte et mettent mon Ã¢me au service des files d'attente de messag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'architecture du service de file d'attente de messages distribuÃ©s dans Yandex.Cloud</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/455642/"> Salut, mon nom est Vasily Bogonatov.  Je fais partie de ceux qui mettent ma main et ma tÃªte et mettent mon Ã¢me au service des files d'attente de messages persistants distribuÃ©s de Yandex Message Queue.  Le service a Ã©tÃ© rendu public fin mai, mais Ã  l'intÃ©rieur de Yandex, il a longtemps Ã©tÃ© activement utilisÃ© dans divers produits. <br><br>  Aujourd'hui, je veux parler aux lecteurs de Habr des files d'attente de messages en gÃ©nÃ©ral et de Yandex Message Queue en particulier.  Tout d'abord, je veux expliquer ce qu'est une "file d'attente de messages persistants distribuÃ©s" et pourquoi elle est nÃ©cessaire.  Montrez sa valeur pratique, les mÃ©canismes de travail avec les messages, parlez de l'API et de l'utilisabilitÃ©.  Dans la deuxiÃ¨me moitiÃ© de l'article, nous examinerons le cÃ´tÃ© technique: comment la base de donnÃ©es Yandex est utilisÃ©e dans nos files d'attente (c'est une base fiable de notre service), Ã  â€‹â€‹quoi ressemble une approche naÃ¯ve et amÃ©liorÃ©e de la construction d'une architecture, quels problÃ¨mes sont causÃ©s par la distribution et comment ils peuvent Ãªtre rÃ©solus. <br><br><img src="https://habrastorage.org/webt/xy/ht/eb/xyhtebqslkofciotlmohtwlopb4.png"><br><a name="habracut"></a><br><h3>  Qu'est-ce qu'une file d'attente de messages persistants distribuÃ©s? </h3><br>  WikipÃ©dia dÃ©finit la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">file</a> d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">attente de messages</a> comme Â«un composant de gÃ©nie logiciel utilisÃ© pour l'interaction interprocessus ou inter-thread dans un processusÂ».  En fait, ce concept est un peu plus large: les processus interagissant Ã  l'aide d'une file d'attente peuvent Ãªtre situÃ©s sur diffÃ©rents serveurs et mÃªme dans diffÃ©rents centres de donnÃ©es. <br><br>  Nous allons clarifier un peu les termes. <br><br>  <b>Une file d'attente de messages</b> est un rÃ©fÃ©rentiel qui fournit le placement et la lecture des donnÃ©es dans un ordre spÃ©cifique. <br><br>  Deux types d'entitÃ©s interagissent gÃ©nÃ©ralement avec une file d'attente: <br><br><ul><li>  <b>Ã©crivains (producteurs)</b> - envoyer des messages Ã  la file d'attente; </li><li>  <b>lecteurs (consommateurs)</b> - reÃ§oivent (lisent) des messages de la file d'attente. </li></ul><br>  Lors de l'utilisation de la file d'attente, les lecteurs et les Ã©crivains sont indÃ©pendants les uns des autres.  Ils peuvent fonctionner avec diffÃ©rentes performances, fiabilitÃ©, disponibilitÃ© et peuvent mÃªme Ãªtre Ã©crits dans diffÃ©rents langages de programmation. <br><br>  Le scÃ©nario principal pour la file d'attente: transmettre de maniÃ¨re fiable et rapide des messages de l'Ã©crivain au lecteur.  Contrairement Ã  la base de donnÃ©es, la file d'attente n'est pas destinÃ©e au stockage Ã  long terme des messages.  Dans de nombreuses implÃ©mentations populaires, il existe un paramÃ¨tre correspondant - Â«PÃ©riode de rÃ©tention des messagesÂ».  Il dÃ©termine la durÃ©e de conservation du message jusqu'Ã  sa suppression dÃ©finitive. <br><br>  Nous avons compris le concept de file d'attente, allez dans la "distribution" et la "persistance". <br><br><ul><li>  Dans notre cas, la <b>distribution</b> signifie la prÃ©sence d'un cluster qui stocke et traite les donnÃ©es et les mÃ©tadonnÃ©es de file d'attente, combinant tous ses nÅ“uds en un seul ensemble Ã  l'aide d'un rÃ©seau informatique. </li><li>  <b>La persistance</b> implique que tous les messages de la file d'attente sont Ã©crits sur le disque et le rÃ©dacteur ne reÃ§oit la confirmation de l'envoi qu'aprÃ¨s un enregistrement rÃ©ussi. </li></ul><br>  La distribution et la persistance n'affectent pas les fonctionnalitÃ©s principales de la file d'attente, elles offrent une tolÃ©rance aux pannes et une fiabilitÃ© du stockage des donnÃ©es.  Quels types de pannes peuvent se produire dans notre systÃ¨me, nous considÃ©rerons un peu plus tard.  Cependant, je ne peux pas me refuser le plaisir et ouvrir un peu les cartes: dans toute l'histoire de l'existence du service, nous n'avons pas perdu un seul message enregistrÃ© du client. <br><br><h3>  Ã€ quoi sert la file d'attente de messages? </h3><br>  La file d'attente vous permet de sÃ©parer les parties de services logiquement indÃ©pendantes les unes des autres, c'est-Ã -dire qu'elle fournit le <b>dÃ©couplage</b> , qui est si demandÃ© dans les microservices dÃ©sormais populaires.  Cela augmente l'Ã©volutivitÃ© et la fiabilitÃ©: vous pouvez toujours augmenter le flux d'enregistrements dans la file d'attente et ajouter plus de lecteurs - gestionnaires de messages, tandis que l'Ã©chec des lecteurs n'affecte pas le travail des Ã©crivains. <br><br>  Les files d'attente attÃ©nuent les pics de charge: elles agissent comme des tampons pour les lecteurs.  Si les capacitÃ©s actuelles du lecteur ne sont pas suffisantes pour le traitement instantanÃ© de tous les messages entrants, les messages en file d'attente seront traitÃ©s ultÃ©rieurement lorsque la charge diminuera.  La mise en mÃ©moire tampon est utile pour les services avec une charge instable, oÃ¹ les Ã©vÃ©nements entrants instantanÃ©s ne sont pas nÃ©cessaires. <br><br>  Voyons comment cela fonctionne, en utilisant l'exemple d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">robot de recherche</a> (aprÃ¨s tout, Yandex a commencÃ© par une recherche!), Qui tÃ©lÃ©charge, traite et place les pages Web dans une base de donnÃ©es.  Prenons une telle architecture. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zo/oe/dh/zooedh0t0qs4uu1lhpdc0psa2qi.png" width="600" height="778"></div><br><br>  La file d'attente de messages rÃ©sout ici les problÃ¨mes suivants: <br><br><ol><li>  Le robot fonctionne beaucoup plus rapidement que les travailleurs chargÃ©s d'analyser et de charger les pages dans la base de donnÃ©es.  Hors ligne, les liens s'accumuleraient et rempliraient la mÃ©moire ou le disque disponible.  La mÃªme chose se produirait si les travailleurs Ã©taient temporairement indisponibles. </li><li>  Sans file d'attente, le robot a besoin de Â«connaÃ®treÂ» l'interface de travail des travailleurs afin de leur assigner des tÃ¢ches.  L'interface peut changer Ã  mesure que le produit se dÃ©veloppe. </li><li>  Un travailleur individuel a une fiabilitÃ© assez faible, il n'y a donc aucune garantie que le lien transmis sera entiÃ¨rement traitÃ© par lui. </li></ol><br>  La file d'attente fournit un stockage de donnÃ©es fiable avec mise Ã  l'Ã©chelle, vous permet de retarder le traitement des liens.  Si un travailleur Ã©choue, le lien brut aprÃ¨s une certaine pÃ©riode sera renvoyÃ© Ã  la file d'attente pour Ãªtre traitÃ© par un autre travailleur.  La file d'attente a sa propre interface, qui est testÃ©e et dÃ©crite dans la documentation, afin que les robots de recherche et les systÃ¨mes de travail puissent dÃ©velopper diffÃ©rentes Ã©quipes dans diffÃ©rents langages de programmation.  Cela n'affectera pas les performances globales. <br><br><h3>  Comment Yandex Message Queue fonctionne avec les messages </h3><br>  On distingue ici trois Ã©tapes principales: <br><br><ul><li>  <b>Ã©crire un</b> message dans la file d'attente; </li><li>  <b>lire un</b> message dans la file d'attente; </li><li>  <b>Suppression d'un</b> message de la file d'attente. </li></ul><br>  Un enregistrement est considÃ©rÃ© comme rÃ©ussi si le message a Ã©tÃ© stockÃ© en toute sÃ©curitÃ© et sera bientÃ´t disponible pour les lecteurs.  L'enregistrement avec dÃ©duplication est possible: lorsqu'une tentative rÃ©pÃ©tÃ©e d'enregistrer un message envoyÃ© est ignorÃ©e. <br><br>  Au moment de la lecture, le message est cachÃ© de la file d'attente pendant une pÃ©riode appelÃ©e dÃ©lai de visibilitÃ© et devient inaccessible aux autres lecteurs.  Si le dÃ©lai de visibilitÃ© expire, le message revient dans la file d'attente et redevient disponible pour le traitement.  L'ordre dans lequel les messages sont lus est dÃ©terminÃ© par la file d'attente et non par le lecteur. <br><br>  Le lecteur lui-mÃªme et la connexion rÃ©seau avec lui sont potentiellement peu fiables.  Un dÃ©lai de visibilitÃ© est nÃ©cessaire pour pouvoir renvoyer un message Ã  la file d'attente lorsque le lecteur tombe en panne ou que la connexion est dÃ©connectÃ©e.  Sinon, il est probable qu'un seul message ne sera jamais traitÃ© correctement. <br><br>  AprÃ¨s une lecture rÃ©ussie, le message est transmis au client avec l'identifiant ReceiptHandle.  Un identifiant indique des donnÃ©es spÃ©cifiques qui doivent Ãªtre supprimÃ©es de la file d'attente de messages. <br><br><h3>  Types de files d'attente dans Yandex Message Queue </h3><br>  Le premier type et le plus couramment utilisÃ© est la file d'attente standard.  Il se caractÃ©rise par un dÃ©bit Ã©levÃ© (des milliers de messages par seconde), d'excellentes performances et un temps d'exÃ©cution court des opÃ©rations de base.  Les files d'attente standard sont constituÃ©es de fragments logiques et prennent en charge une mise Ã  l'Ã©chelle de la bande passante presque linÃ©aire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wy/p0/jp/wyp0jpi_pmhorpq2mikwm_mgl-u.png"></div><br>  Les files d'attente standard ne prennent pas en charge la dÃ©duplication des messages lors de l'Ã©criture dans une file d'attente et ne garantissent pas l'ordre de lecture.  En raison de l'utilisation du partage, une demande de lecture peut ne pas renvoyer un seul message, mÃªme s'ils sont dans la file d'attente.  Le plus souvent, cela se produit en mode d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interrogation courte</a> , lorsque la lecture provient d'un fragment sÃ©lectionnÃ© au hasard. <br><br>  Le deuxiÃ¨me type - <abbr title="Premier entrÃ©, premier sorti">FIFO</abbr> - est l'opposÃ© de la file d'attente standard.  Il fournit un ordre de lecture strict, prend en charge la dÃ©duplication lors de l'Ã©criture et les tentatives rÃ©pÃ©tÃ©es de lecture des messages.  Les performances et l'Ã©volutivitÃ© sont infÃ©rieures Ã  la norme.  Les performances de la file d'attente FIFO sont limitÃ©es Ã  30 requÃªtes par seconde.  Il est recommandÃ© d'utiliser FIFO lorsque vous devez essayer de garantir la sÃ©mantique de livraison Â«exactement une foisÂ».  Habituellement, le mot Â«file d'attenteÂ» signifie FIFO. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yr/jy/l5/yrjyl5kbyfzqzkruqhaoqdrsxzs.png" width="421" height="801"></div><br><h3>  API Yandex Message Queue </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'API</a> est un composant extrÃªmement important de tout produit.  Une bonne interface logicielle doit Ãªtre simple et directe, nÃ©cessitant une familiarisation minimale avec la documentation pour une utilisation efficace.  Ne devrait pas permettre de faire des actions Ã©tranges ou inutiles et se protÃ©ger contre des erreurs stupides, signaler en temps opportun la violation du Â«contratÂ». <br><br>  Si le systÃ¨me possÃ¨de une telle API, il reÃ§oit rapidement des utilisateurs fidÃ¨les et est entourÃ© de Â«wrappersÂ» pratiques pour diffÃ©rentes plates-formes et langages de programmation. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'API Amazon Simple Queue Service (API AWS SQS)</a> est un exemple d'une telle interface, testÃ©e par le temps et un grand nombre de clients.  Par consÃ©quent, nous avons dÃ©cidÃ© de ne pas inventer une interface unique pour Yandex Message Queue, mais avons implÃ©mentÃ© la prise en charge de l'API AWS SQS, et trÃ¨s soigneusement. <br><br>  Dans la plupart des cas, il suffit Ã  l'utilisateur SQS de changer le point de terminaison (adresse de service), la rÃ©gion (pour le moment, nous n'utilisons que Â«ru-central1Â») et d'obtenir de nouvelles informations d'identification dans Yandex.Cloud.  Tout le reste, par exemple, un script utilisant la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ligne de commande AWS</a> , du code utilisant le kit SDK AWS ou un service prÃªt Ã  l'emploi sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Celery</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">boto</a> , est trÃ¨s susceptible de ne pas Ãªtre touchÃ©.  La logique et la fonctionnalitÃ© du service de file d'attente resteront les mÃªmes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_r/td/kn/_rtdknyixiytyqo63khne5gz4uq.png"></div><br>  Une description dÃ©taillÃ©e des mÃ©thodes de l'API Yandex Message Queue se trouve dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">service</a> . <br><br><h3>  Un peu de commoditÃ© </h3><br>  Yandex Message Queue est un service gÃ©rÃ©, c'est-Ã -dire Yandex. Cloud est responsable du fonctionnement des serveurs et des logiciels.  L'Ã©quipe de service surveille l'intÃ©gritÃ© des files d'attente, remplace rapidement les disques dÃ©faillants, Ã©limine les ruptures de rÃ©seau et dÃ©ploie les mises Ã  jour.  La mise Ã  jour n'arrÃªte pas le service: pendant que nous installons la nouvelle version de YMQ sur un groupe de serveurs, l'Ã©quilibreur de charge redirige soigneusement le trafic vers les autres.  Les utilisateurs ne remarquent donc rien. <br><br>  Pour faciliter le contrÃ´le du fonctionnement des files d'attente, nous avons ajoutÃ© un grand nombre de graphiques visuels Ã  YMQ, seule une petite partie d'entre eux est montrÃ©e ici.  Les graphiques sont situÃ©s dans la console Yandex.Cloud, dans la section "Statistiques". <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bi/cp/nn/bicpnn5tjwzqustzy9ye5abnrho.png"></div><br>  Nous allons vous parler des quatre graphiques les plus utiles Ã  notre avis: <br><br><ul><li>  Le graphique <b>Â«Messages en file d'attenteÂ»</b> vous aide Ã  surveiller l'accumulation de donnÃ©es dans la file d'attente.  Une croissance dans le graphique peut signifier que les gestionnaires ne gÃ¨rent pas la charge ou que le traitement s'est arrÃªtÃ©. </li><li>  Graphique <b>"Ã‚ge du message le plus ancien dans la file d'attente"</b> : des valeurs Ã©levÃ©es indiquent des problÃ¨mes de traitement des messages.  Si tout fonctionne correctement, les messages ne devraient pas rester longtemps dans la file d'attente. </li><li>  Le graphique <b>Â«Nombre de tentatives de lecture d'un messageÂ»</b> montre quand les messages commencent Ã  Ãªtre lus plusieurs fois.  Cela peut signifier que les gestionnaires se bloquent lorsqu'ils reÃ§oivent des messages. </li><li>  Le graphique <b>"Temps de mise en file d'attente"</b> indique le temps qui s'Ã©coule entre le moment oÃ¹ le message est envoyÃ© dans la file d'attente et celui oÃ¹ le gestionnaire le reÃ§oit. </li></ul><br>  Les graphiques permettent d'Ã©valuer instantanÃ©ment la dynamique de la file d'attente et la prÃ©sence de pannes sans avoir Ã  consulter les journaux. <br><br>  Nous avons discutÃ© de points plus ou moins gÃ©nÃ©raux, passons maintenant aux dÃ©tails. <br><br><h3>  Comment Yandex Database Queue utilise la base de donnÃ©es Yandex </h3><br>  Le service Yandex Message Queue est construit au-dessus de la base de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">donnÃ©es gÃ©odistribuÃ©e Yandex Database (YDB) Ã  tolÃ©rance de pannes</a> , qui fournit une cohÃ©rence et une prise en charge strictes des transactions ACID.  Nous ne dÃ©monterons pas maintenant son appareil et ses caractÃ©ristiques, nous nous limiterons au schÃ©ma gÃ©nÃ©ral. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uq/5m/o3/uq5mo3fm83hovqxkgt7no-yjevg.png" width="742" height="860"></div><br>  Une file d'attente dans YMQ se compose de fragments logiques, reprÃ©sentÃ©s par un ensemble fixe de tables YDB.  Chaque table stocke sa propre information.  Par exemple, il existe une table d'Ã©tat gÃ©nÃ©rale appelÃ©e State, qui stocke les offs et le nombre rÃ©el de messages.  Il y a une table avec des mÃ©tadonnÃ©es de donnÃ©es et de messages.  Il existe une table avec des attributs associÃ©s. <br><br>  Toutes les opÃ©rations principales avec une file d'attente - travailler avec des messages, modifier des attributs, crÃ©er et supprimer - fonctionnent avec une hiÃ©rarchie de tables et de rÃ©pertoires YDB, ou des requÃªtes transactionnelles sur une ou plusieurs tables d'une file d'attente.  Les donnÃ©es Ã  l'intÃ©rieur des tables de file d'attente sont la source de la vÃ©ritÃ© absolue.  Par consÃ©quent, en plus du fonctionnement correct et stable de la base de donnÃ©es, il est nÃ©cessaire d'assurer un stockage fiable et une haute disponibilitÃ© des donnÃ©es. <br><br>  Nos informations sont stockÃ©es dans plusieurs rÃ©pliques: une copie dans chacun des trois centres de donnÃ©es Yandex.  Si l'un des centres de donnÃ©es n'est pas disponible, le nombre de rÃ©pliques dans les autres double.  Ainsi, le niveau de fiabilitÃ© requis est restaurÃ©.  MÃªme si un centre de donnÃ©es entier et un centre de services dans un autre tombent en panne, les donnÃ©es seront entiÃ¨rement accessibles. <br><br><h3>  La premiÃ¨re version de l'architecture Yandex Message Queue </h3><br>  La premiÃ¨re version de l'architecture YMQ, que nous appelions nous-mÃªmes naÃ¯ve, ressemblait Ã  ceci. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/qc/eu/ajqceuaoisynocw4u3ffek3epjo.png"></div><br>  Le diagramme montre le chemin de la demande HTTPS du client YMQ vers le rÃ©fÃ©rentiel YDB.  Regardons les principaux composants: <br><br><ol><li>  L'Ã©quilibreur L3 envoie une demande au centre de donnÃ©es Yandex le plus proche de l'utilisateur.  Cela rÃ©duit la latence du rÃ©seau, bien que la charge soit rÃ©partie de maniÃ¨re inÃ©gale. </li><li>  Nginx sur la machine virtuelle Yandex.Cloud met fin aux connexions HTTPS, fournit une protection contre les attaques rÃ©seau et envoie la requÃªte par procuration au serveur YMQ, dÃ©jÃ  en HTTP. </li><li>  Le serveur HTTP YMQ implÃ©mente la logique de l'API HTTP SQS, valide et traduit la demande dans un format protobuf fortement typÃ©. </li><li>  YMQ Actor system - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SystÃ¨me d'acteur</a> .  Il a simultanÃ©ment lancÃ© des milliers d'acteurs diffÃ©rents Ã©changeant des informations.  Le systÃ¨me d'acteurs de chaque hÃ´te fait partie d'un cluster.  Tous les acteurs du cluster vivent et agissent dans leur ensemble.  La logique mÃ©tier YMQ est implÃ©mentÃ©e dans diffÃ©rents acteurs impliquÃ©s dans les demandes de transaction Ã  YDB. </li><li>  Tablettes YDB ("tablettes") - partie du noyau YDB, qui est responsable de l'utilisation des tables dans les requÃªtes et les transactions.  Les tablettes elles-mÃªmes ne stockent pas de donnÃ©es.  Ce sont des structures de contrÃ´le en mÃ©moire qui peuvent restaurer l'Ã©tat en cas de panne matÃ©rielle. </li><li>  Le stockage est un stockage fiable, distribuÃ© et tolÃ©rant aux pannes. </li></ol><br>  Cette architecture prÃ©sente un inconvÃ©nient: tous les serveurs du cluster fonctionnent indÃ©pendamment avec des tables de la mÃªme file d'attente.  Cela affecte nÃ©gativement les performances et empÃªche l'organisation de caches fiables de messages cachÃ©s et lisibles.  Il est difficile de limiter le flux de demandes, ce qui est trÃ¨s important pour tout service trÃ¨s chargÃ©. <br><br><h3>  Architecture de Yandex Message Queue avec des maÃ®tres de file d'attente </h3><br>  Le chargement de charge a montrÃ© que la premiÃ¨re version de l'architecture rÃ©siste Ã  environ 450 messages par seconde et par file d'attente avec un fragment.  C'Ã©tait trÃ¨s petit. <br>  Le problÃ¨me principal Ã©tait les requÃªtes de contention.  Un grand nombre de transactions logiquement conflictuelles ont rapidement amenÃ© les caches de messages cachÃ©s dans un Ã©tat incohÃ©rent.  Pour rÃ©soudre le problÃ¨me, nous avons introduit une entitÃ© spÃ©ciale - le maÃ®tre de file d'attente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gc/b4/om/gcb4omkmhk28uhwe2hrlewhzsig.png"></div><br>  <b>Un maÃ®tre de file d'attente</b> est un acteur qui, dans des conditions normales, existe dans un cluster dans une seule instance et passe par toutes les demandes associÃ©es Ã  une file d'attente particuliÃ¨re.  Si une demande Ã  la file d'attente arrive sur un serveur oÃ¹ le maÃ®tre souhaitÃ© est manquant, un acteur proxy spÃ©cial redirige la demande, puis traduit la rÃ©ponse reÃ§ue du maÃ®tre. <br><br>  Lorsque vous utilisez l'Assistant de file d'attente, le cache correct des messages dÃ©verrouillÃ©s rÃ©duit les conflits lors de l'utilisation des tables.  La mise en Å“uvre de la restriction du flux de demandes est simplifiÃ©e, par exemple, grÃ¢ce au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bucket Leaky</a> .  Des mÃ©triques de file d'attente rapides et prÃ©cises sont disponibles: nombre de messages, trafic total, etc.  Vous pouvez regrouper des demandes similaires. <br><br>  En thÃ©orie, une telle architecture prÃ©sente certains inconvÃ©nients liÃ©s Ã  la centralisation: <br><br><ol><li>  RÃ©duction de la tolÃ©rance aux pannes: si une machine virtuelle avec un maÃ®tre Ã©choue, toutes les files d'attente avec des maÃ®tres dessus ne seront pas disponibles.  Cependant, les mÃ©canismes spÃ©ciaux de YDB vous permettent de former de nouveaux maÃ®tres au sein du cluster en quelques secondes.  Cela rÃ©sout largement le problÃ¨me. </li><li>  Ã‰volutivitÃ© limitÃ©e: toutes les demandes passent par un seul hÃ´te.  L'inconvÃ©nient est les tablettes YDB nivelÃ©es.  Ils font tout le travail acharnÃ© avec les donnÃ©es.  Et le maÃ®tre envoie de maniÃ¨re asynchrone les demandes et traite les rÃ©sultats reÃ§us.  Cela en fait une entitÃ© Â«lÃ©gÃ¨reÂ» qui ne crÃ©e pas d'effet Â«goulot d'Ã©tranglementÂ» lors des tests de rÃ©sistance. </li></ol><br><h3>  File d'attente de l'Assistant RequÃªte </h3><br>  Les transactions distribuÃ©es avec des tables de base de donnÃ©es entraÃ®nent certains coÃ»ts supplÃ©mentaires, donc l'idÃ©e de rÃ©duire le nombre de requÃªtes nous semblait logique.  Cent transactions pour l'enregistrement des messages un Ã  la fois est prÃ©fÃ©rable de se transformer en une transaction pour l'enregistrement de cent messages Ã  la fois.  Avec les maÃ®tres de file d'attente, la mise en Å“uvre d'un tel traitement par lots (traitement par lots) est beaucoup plus facile. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yc/rn/0j/ycrn0j7obrbg0_cimvkyzj5izr4.png"></div><br>  Le traitement par lots augmente lÃ©gÃ¨rement la latence pendant les opÃ©rations.  Au lieu de cela, la bande passante est considÃ©rablement augmentÃ©e.  Avec le traitement par lots, une file d'attente Ã  partition unique peut traiter jusqu'Ã  30 000 demandes par seconde. <br><br>  En gÃ©nÃ©ral, le chargement de la file d'attente peut Ãªtre trÃ¨s diffÃ©rent: des milliers de messages par seconde et plusieurs messages par jour.  Nous avions besoin d'optimiser le travail avec les files d'attente Ã  l'aide d'un algorithme flexible.  Les options frontales avec l'accumulation de messages dans le tampon vers le numÃ©ro de seuil ou une rÃ©initialisation de la minuterie ne nous convenaient pas.  Par consÃ©quent, nous avons dÃ©veloppÃ© un algorithme de traitement par lots adaptatif pour YMQ qui fonctionne bien dans les deux cas.  Son travail est prÃ©sentÃ© sous forme de chronogramme. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qm/g2/rx/qmg2rx2e8pllaxuajav0gyxe2kg.png"></div><br>  Ici, lorsqu'un nouveau message arrive, l'un des trois scÃ©narios est possible: <br><br><ol><li>  Une transaction dÃ©marre instantanÃ©ment si aucune autre transaction de ce type n'est en cours d'exÃ©cution. </li><li>  S'il y a dÃ©jÃ  des transactions en cours, le message est ajoutÃ© au tampon et attend la fin des transactions. </li><li>  Si la taille de la mÃ©moire tampon dÃ©passe la valeur seuil, une autre transaction parallÃ¨le est lancÃ©e.  Le nombre de transactions simultanÃ©es est limitÃ©. </li></ol><br>  L'idÃ©e du batch adaptatif ressemble Ã  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'algorithme Nagle</a> pour TCP / IP.    :      ,      latency .    ,        .               . <br><br><h3>        </h3><br>  Yandex Message Queue,      ,    .  ,  ,      -. <br><br>    YDB               .   YMQ     . <br><br>           ,   ,     ,      . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ol/yb/ay/olybayeljh8jcdbcmod9dpylopw.png" width="808" height="712"></div><br>  YMQ   .                    .   Â«Â»        . <br><br><h3>        </h3><br>  YDB           .    ,  ,     ,   Â«Â».             ,       .          . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eg/em/eg/egemegamvnhmv-c5t8pw4im73u0.png" width="661" height="685"></div><br>   :              .    ,    Â«Â»      .  -,   Â«Â»  ,   Â«Â»,    . <br><br>     Â«  Â»               .    ,  ,     . <br><br><h3>   Yandex Message Queue     </h3><br> Yandex Message Queue â€“  - .      .       ,  .     . <br><br><ul><li> <b>-</b>    ,  ,   .      . </li><li> <b> </b>       API   ,    .  ,        . </li><li> <b> </b>  ,     :    ,           . ,       .          .     boto,    24/7,     -    . </li><li> <b> </b>    ,   ,         .        . </li></ul><br>        .       -         .   .       . <br><br>     : <br><br><ul><li>     5,       ; </li><li>    YDB; </li><li>  , , ,   ; </li><li>      ,    ; </li><li>    .       . </li></ul><br>                  . <br><br><h3>  En conclusion </h3><br>      â€“    ,    ,          ,    .              ., ., ., .   . <br><br>      .            .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> Yandex Message Queue  . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455642/">https://habr.com/ru/post/fr455642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455632/index.html">Attention! Bogue dangereux dans l'implÃ©mentation C ++ std :: map :: merge et std :: set :: merge dans Visual Studio 2017</a></li>
<li><a href="../fr455634/index.html">Les mathÃ©matiques et le jeu "Set"</a></li>
<li><a href="../fr455636/index.html">La premiÃ¨re vague affectÃ©e par la vulnÃ©rabilitÃ© Exim. Le script du traitement</a></li>
<li><a href="../fr455638/index.html">Alan Kay n'a pas inventÃ© d'objets</a></li>
<li><a href="../fr455640/index.html">Â«La machine Ã  Ã©motionsÂ» de Marvin Minsky: Chapitre 4. Â«Comment nous reconnaissons la conscienceÂ»</a></li>
<li><a href="../fr455644/index.html">Nous utilisons les donnÃ©es dans la pratique</a></li>
<li><a href="../fr455646/index.html">Semaine de sÃ©curitÃ© 24: portes dÃ©robÃ©es d'usine sur les smartphones Android</a></li>
<li><a href="../fr455648/index.html">Cycle de vie ML</a></li>
<li><a href="../fr455650/index.html">Comment nous avons formÃ© un rÃ©seau de neurones pour classer les vis</a></li>
<li><a href="../fr455652/index.html">Deep Learning vs bon sens: dÃ©velopper un chat bot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>