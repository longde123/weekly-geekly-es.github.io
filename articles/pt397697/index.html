<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äç‚öñÔ∏è üí• üé¥ Como protetizei o indicador do no-break ‚Ü©Ô∏è üö¥üèΩ üòê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No final dos anos 90, recebi a UPS. Bonito, com um indicador LED e um monte de bot√µes, ele tinha duas baterias dentro e poderia suportar a vida √∫til d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como protetizei o indicador do no-break</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/397697/"><img src="https://habrastorage.org/files/4f0/b42/8eb/4f0b428ebdd6405db46834adaf3a9543.jpg" alt="durante a depura√ß√£o"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final dos anos 90, recebi a UPS. Bonito, com um indicador LED e um monte de bot√µes, ele tinha duas baterias dentro e poderia suportar a vida √∫til do meu computador naquele momento (junto com o monitor!) Por at√© 15 minutos. Os tempos em Kamchatka eram dif√≠ceis, as luzes eram apagadas regularmente, portanto esse dispositivo era muito √∫til. Passei por toda a crise de energia com ele e mais de uma vez ele salvou meus documentos da perda repentina de eletricidade. Al√©m disso, voc√™ pode conectar um gravador e, √† luz de uma vela, ouvir o r√°dio ou suas fitas favoritas, preparando um jantar em um fog√£o a g√°s port√°til ...</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naturalmente, o no-break estava quebrando. A primeira vez que seu transformador queimava. N√£o √© aquele que √© grande e est√° no inversor, mas √© pequeno, provavelmente para medir a tens√£o na rede. N√£o encontrando a mesma f√°brica, montei uma de fabrica√ß√£o pr√≥pria e o dispositivo funcionou por mais algum tempo. Ent√£o parou. Durante muito, muito tempo, n√£o consegui encontrar o motivo. Eu tive que soldar pe√ßas diferentes, verific√°-las quanto ao desempenho e sold√°-las de volta. O problema n√£o foi encontrado. O dispositivo estripado caiu embaixo da cama por alguns anos, at√© que, em um belo dia, surgiu a id√©ia de aplicar 5 volts diretamente no controlador. E eis que: houve um bipe do alto-falante embutido e os n√∫meros apareceram no indicador LED. Ele estava vivo! Al√©m disso, √© uma quest√£o de tecnologia: caminhei ao longo do circuito da fonte de alimenta√ß√£o com um volt√≠metro e descobri que um fus√≠vel havia sido soldado na placa, que parecia insolentemente um resistor!O fus√≠vel (queimado naturalmente) foi substitu√≠do e o no-break ganhou vida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, meu reparo e dois anos debaixo da cama n√£o foram embora para o dispositivo por nada. De alguma maneira incompreens√≠vel, a porta foi queimada no controlador, respons√°vel pelo brilho do LED verde "On-Line" e pelo segmento mais baixo de todos os indicadores de segmento digital. N√£o h√° nada a ser feito sobre isso - eu tive que chegar a um acordo. Depois de algum tempo, deixei Kamchatka e nossos caminhos divergiram. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os anos se passaram e, tendo chegado para visitar meus pais, no canto mais distante encontrei minha bateria ininterrupta favorita: abandonada, suja, sem baterias e pernas de borracha. Naquela √©poca, eu j√° havia adquirido minha pr√≥pria casa em outra cidade, ent√£o foi tomada a decis√£o de me refugiar no ref√∫gio, restaurar sua efici√™ncia e us√°-la para a finalidade a que se destina. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desafio</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro de tudo, o no-break foi lavado e seco. Ent√£o, em uma determinada loja de pe√ßas de r√°dio, foram comprados p√©s de borracha adequados e baterias novas. Para minha grande surpresa, um transformador adequado foi encontrado na mesma loja, em troca do meu produto caseiro. Alguns dias de trabalho e a bateria ininterrupta, lavada e atualizada, guincharam alegremente e come√ßaram a carregar suas novas baterias. Tudo estava bem, mas o indicador ainda n√£o estava funcionando.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A id√©ia de consertar isso me veio antes. Tendo desenhado todos os n√∫meros (e algumas letras) do indicador de sete segmentos na folha de caderno, percebi que √© poss√≠vel determinar o estado do segmento mais baixo pelo estado dos demais. O LED verde pode acender quando outros LEDs n√£o estiverem acesos. Havia muitos pensamentos sobre como isso poderia ser feito: de um simples chip ROM a um simples FPGA. Mas, como eu era estudante e morava em Kamchatka, n√£o tive a oportunidade de adquirir algo mais complicado do que l√≥gica mesquinha. A corre√ß√£o do indicador foi adiada.</font></font><br>
<br>
<img src="https://habrastorage.org/files/0d1/175/f43/0d1175f43d72446383ebd4f0dcb687db.jpg" alt="desenhar segmentos"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desta vez, decidi enfrentar o problema com seriedade. Tendo vasculhado os compartimentos, novamente n√£o encontrei para mim nem ROM, nem FPGA e nenhum CPLD. Mas o Arduino Pro Mini, ou melhor, seu clone chin√™s barato com Ali Express, caiu nas m√£os de. Comprei o Arduin para fazer um mini-computador baseado no cart√£o SD WiFi da Transcend. Infelizmente, o cart√£o morreu durante os experimentos, e a placa com o microcontrolador permaneceu inativa. Nada, achamos um novo desafio para ela! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalho</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A exibi√ß√£o din√¢mica √© implementada no m√≥dulo de exibi√ß√£o: os sinais de segmento s√£o comuns a todos os quatro indicadores, de modo que apenas um deles acenda por vez. Al√©m disso: como se com o quinto indicador, tr√™s LEDs tamb√©m estivessem conectados. Cinco sinais de sele√ß√£o permitem especificar qual indicador (ou linha de LEDs) est√° sendo usado agora. Esses sinais de sele√ß√£o s√£o varridos sequencialmente a uma velocidade bastante alta e, devido √† in√©rcia da vis√£o, parece que todos os indicadores est√£o acesos ao mesmo tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo, eu queria resolver a solu√ß√£o mais simples: um ciclo comum que verifica sinais de seis segmentos de trabalho e liga ou desliga o s√©timo que n√£o funciona. Na verdade, isso √© apenas uma emula√ß√£o da ROM, sobre a qual pensei no come√ßo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, tive que conectar seis segmentos de trabalho √† entrada do microcontrolador e um segmento n√£o de trabalho √† sa√≠da. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tendo esbo√ßado uma pequena matriz que comparava os v√°rios estados das entradas com a sa√≠da e o loop que contornava essa matriz, carreguei tudo no controlador e imediatamente tive um problema: o segmento inferior sempre brilhava. Primeiro pensamento: o cant no programa. No entanto, n√£o importa o quanto olhei para o c√≥digo, nenhum erro foi encontrado. No final, entendeu-se que meu ciclo n√£o estava de forma alguma sincronizado com a troca de indicadores. Se lermos o estado dos segmentos no final do ciclo de sele√ß√£o de um indicador, √© prov√°vel que acendamos ou abaixemos o pr√≥ximo segmento no pr√≥ximo. A bagun√ßa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sem pensar duas vezes, soldei cinco sinais de sele√ß√£o de indicador nas entradas restantes restantes do Arduino, configurei-os para gerar uma interrup√ß√£o e comecei a usar o manipulador de interrup√ß√£o em vez de um loop. Tornou-se melhor, mas n√£o resolveu o problema. Nos lugares certos, o segmento queimou como deveria, mas naqueles lugares onde deveria ser extinto, n√£o havia um brilho residual brilhante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de pensar por mais algum tempo, decidi que esse efeito poderia aparecer se o ciclo de pesquisa na matriz do estado desejado para os segmentos demorar mais que o tempo de grava√ß√£o do indicador. Nesse caso, tamb√©m sa√≠mos de nossa fase e gerenciamos o segmento do pr√≥ximo indicador. √â necess√°rio que o menor tempo poss√≠vel passe entre o momento de receber a interrup√ß√£o do sinal de sele√ß√£o e o comando de controle de segmento. Isso poderia ser feito apenas de uma maneira: para remover o c√≥digo que toma a decis√£o sobre o estado do segmento do manipulador de interrup√ß√µes, execute-o no loop principal com prioridade m√≠nima e salve o resultado em uma esp√©cie de buffer global. O manipulador de interrup√ß√£o precisar√° apenas ler o valor desse buffer global e extinguir ou iluminar o segmento, dependendo do seu conte√∫do. No pior dos casoss√≥ podemos nos atrasar com a mudan√ßa no estado do segmento em um determinado indicador, mas n√£o passaremos para o pr√≥ximo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa foi a decis√£o certa. </font><font style="vertical-align: inherit;">Mas, finalmente, funcionou somente depois que sincronizei o ciclo de tomada de decis√£o com uma interrup√ß√£o usando o bloqueio de rota√ß√£o e proibi o processamento de interrup√ß√£o durante esse ciclo. </font><font style="vertical-align: inherit;">E n√£o apenas ganhou, mas ganhou como deveria!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Havia outro problema com os indicadores: na maioria das vezes eles mostravam apenas n√∫meros. </font><font style="vertical-align: inherit;">No entanto, ap√≥s ligar o no-break, o processo de teste foi iniciado, durante o qual, al√©m dos n√∫meros, apareceram mais duas palavras: TEST e PASS. </font><font style="vertical-align: inherit;">E se as letras T, E e P pudessem ser simplesmente adicionadas √† matriz de caracteres v√°lidos e S fosse o mesmo que 5s, a letra A n√£o seria nada, do ponto de vista do meu programa, das oito. </font><font style="vertical-align: inherit;">O ciclo de decis√£o simplesmente encontrou o padr√£o apropriado na matriz e desenhou o segmento inferior. </font><font style="vertical-align: inherit;">Era necess√°rio inventar algo para evitar isso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E eu inventei. Durante a chegada de um sinal sobre uma mudan√ßa de indicador, √© necess√°rio determinar a qual indicador pertence e salvar o estado de seus segmentos em uma vari√°vel especialmente alocada para ele. Agora, a qualquer momento, posso determinar com precis√£o o conte√∫do atual de todos os quatro indicadores de uma s√≥ vez. E se os s√≠mbolos P, 5 e 5 s√£o exibidos no primeiro, terceiro e quarto, respectivamente, o segundo s√≠mbolo √© definitivamente A e voc√™ n√£o precisa acender o segmento inferior. Por precau√ß√£o, tamb√©m adicionei o processamento da palavra FAIL, que eu nunca tinha visto, mas que esperava que aparecesse.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo, com o indicador digital terminado. Resta apenas corrigir o LED verde on-line. Mas aqui uma surpresa me esperava ... A id√©ia era a seguinte: o LED verde (On-Line) sempre acende sozinho. Se os LEDs amarelos (Bateria) ou vermelhos (Bateria fraca) estiverem acesos, o verde n√£o acender√°. Assim, soldamos os fios desses LEDs ao microcontrolador, colocamos um simples if () com um "OR" l√≥gico e tudo deve funcionar. Por√©m, quando o LED amarelo est√° aceso, ele n√£o acende constantemente, mas pisca rapidamente. R√°pido, mas n√£o o suficiente para if () pular e n√£o acender o LED verde. Verificou-se que, ao trabalhar na rede, o LED verde acende com o brilho total, mas ao mudar para a bateria, ele queima com metade do brilho, mas ainda queima. Bem, n√£o √© um problema, pensei, vou colocar um filtro passa-baixo simples:Cortarei todos os flashes r√°pidos, mas deixarei apenas os lentos que correspondem √† transi√ß√£o para a bateria e vice-versa. A an√°lise do tempo de intermit√™ncia do LED amarelo trouxe a seguinte surpresa: o per√≠odo dos pulsos que lhe s√£o fornecidos √© muito inst√°vel e pode atingir valores bastante elevados. Verificou-se que o filtro deve transmitir sinais n√£o superiores a 0,5-1 Hz. Isso n√£o √© muito bom, pois temos um atraso bastante grande na altera√ß√£o do sinal on-line, mas √© bastante toler√°vel.pois temos um atraso bastante grande na altera√ß√£o do sinal on-line, mas √© bastante suport√°vel.pois temos um atraso bastante grande na altera√ß√£o do sinal on-line, mas √© bastante suport√°vel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu decidi tornar o filtro muito simples. </font><font style="vertical-align: inherit;">Monitoramos 50 vezes, em intervalos regulares, o status dos LEDs amarelo e vermelho. </font><font style="vertical-align: inherit;">Se um deles queima, aumentamos o contador especial em um. </font><font style="vertical-align: inherit;">Depois, verificamos o valor do contador e, se os LEDs de controle acenderem por 50% do tempo verificado, acreditamos que ele est√° ligado e, se menor, ent√£o est√° apagado. </font><font style="vertical-align: inherit;">No processo de depura√ß√£o, tive que reduzir esse n√∫mero para 10%. </font><font style="vertical-align: inherit;">Por que - n√£o entendi. </font></font><br>
<br>
<img src="https://habrastorage.org/files/88e/bd5/51b/88ebd551ba62430ba32362657836bd94.jpg" alt="montagem final"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E tudo funcionou! </font><font style="vertical-align: inherit;">Restava apenas montar a placa do Arduino no gabinete da UPS com fita dupla face e uma pistola adesiva.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Elb8pT4lWlQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para os curiosos:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o c√≥digo resultante</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span></span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AVG_TIME    50</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> THS_TIME    45</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_A    _BV(0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_B    _BV(1)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_C    _BV(2)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_D    _BV(3)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_E    _BV(4)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_F    _BV(5)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SEG_G    _BV(6)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_LED_RED  SD_SEG_A</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_LED_YLW  SD_SEG_C</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_LED  _BV(0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_1    _BV(1)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_2    _BV(2)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_3    _BV(3)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LD_SEL_4    _BV(4)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_SEL     (PINC &amp; 0x1f)</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_NONE (0)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_0    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_1    (SD_SEG_B | SD_SEG_C)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_2    (SD_SEG_A | SD_SEG_B | SD_SEG_D | SD_SEG_E | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_3    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_4    (SD_SEG_B | SD_SEG_C | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_5    (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_6    (SD_SEG_A | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_7    (SD_SEG_A | SD_SEG_B | SD_SEG_C)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_8    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_9    (SD_SEG_A | SD_SEG_B | SD_SEG_C | SD_SEG_D | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_E    (SD_SEG_A | SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_P    (SD_SEG_A | SD_SEG_B | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SD_SYM_T    (SD_SEG_D | SD_SEG_E | SD_SEG_F | SD_SEG_G)</span></span><font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GET_SYM     (~PIND &amp; 0x7f)</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BROKEN_SEG  (SD_SEG_D)</span></span><font></font>
<font></font>
<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sd_symbols[] = {                 <span class="hljs-comment"><span class="hljs-comment">// list of known symbols</span></span><font></font>
    SD_SYM_NONE,<font></font>
    SD_SYM_0, SD_SYM_1, SD_SYM_2, SD_SYM_3, SD_SYM_4,<font></font>
    SD_SYM_5, SD_SYM_6, SD_SYM_7, SD_SYM_8, SD_SYM_9,<font></font>
    SD_SYM_E, SD_SYM_P, SD_SYM_T<font></font>
};<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sel, symbol;            <span class="hljs-comment"><span class="hljs-comment">// current input signals</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> fb0, fb1, fb2, fb3, fb4;  <span class="hljs-comment"><span class="hljs-comment">// display frame buffer</span></span><font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// display routine</span></span><font></font>
ISR(PCINT1_vect) {<font></font>
    sel = GET_SEL;<font></font>
    symbol = GET_SYM;<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((sel &amp; LD_SEL_LED) &amp;&amp; fb0) ||<font></font>
            ((sel &amp; LD_SEL_1) &amp;&amp; fb1) ||<font></font>
            ((sel &amp; LD_SEL_2) &amp;&amp; fb2) ||<font></font>
            ((sel &amp; LD_SEL_3) &amp;&amp; fb3) ||<font></font>
            ((sel &amp; LD_SEL_4) &amp;&amp; fb4)){<font></font>
        PORTD &amp;= ~BROKEN_SEG;<font></font>
    }<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
        PORTD |= BROKEN_SEG;<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//</span></span>
<span class="hljs-comment"><span class="hljs-comment">// entry point</span></span>
<span class="hljs-comment"><span class="hljs-comment">//</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">
</span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cur_time;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> led_on_time;
    <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> last_symbol_1, last_symbol_2, last_symbol_3, last_symbol_4;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// setup GPIO ports</span></span>
    DDRC = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    DDRD = BROKEN_SEG;<font></font>
<font></font>
    <span class="hljs-comment"><span class="hljs-comment">// setup pin change interrupt</span></span><font></font>
    PCICR |= _BV(PCIE1);<font></font>
    PCMSK1 |= _BV(PCINT8) | _BV(PCINT9) | _BV(PCINT10) | _BV(PCINT11) | _BV(PCINT12);<font></font>
<font></font>
    cur_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    led_on_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    last_symbol_1 = last_symbol_2 = last_symbol_3 = last_symbol_4 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    fb0 = fb1 = fb2 = fb3 = fb4 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) {
        <span class="hljs-comment"><span class="hljs-comment">// sync with display strobe</span></span><font></font>
        sei();<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sel == <span class="hljs-number"><span class="hljs-number">0</span></span>) {}<font></font>
        cli();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// if select one of segment indicator</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; (LD_SEL_1 | LD_SEL_2 | LD_SEL_3 | LD_SEL_4)) {
            <span class="hljs-comment"><span class="hljs-comment">// looking for displayed symbol</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">14</span></span>; i++) {
                <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sd_symbol = sd_symbols[i];
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((symbol &amp; ~BROKEN_SEG) == (sd_symbol &amp; ~BROKEN_SEG)) {
                    <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> val;
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sd_symbol &amp; BROKEN_SEG) {<font></font>
                        val = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                        val = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_1) {<font></font>
                        last_symbol_1 = sd_symbol;<font></font>
                        fb1 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_2) {<font></font>
                        last_symbol_2 = sd_symbol;<font></font>
                        fb2 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_3) {<font></font>
                        last_symbol_3 = sd_symbol;<font></font>
                        fb3 = val;<font></font>
                    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_4) {<font></font>
                        last_symbol_4 = sd_symbol;<font></font>
                        fb4 = val;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-comment"><span class="hljs-comment">// PASS workaround</span></span>
                    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((last_symbol_1 == SD_SYM_P) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp;<font></font>
                            (last_symbol_3 == SD_SYM_5) &amp;&amp; (last_symbol_4 == SD_SYM_5)) {<font></font>
                        fb2 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                    }<font></font>
                    <span class="hljs-comment"><span class="hljs-comment">// FAIL workaround</span></span>
                    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((last_symbol_1 == SD_SYM_E) &amp;&amp;(last_symbol_2 == SD_SYM_8) &amp;&amp;<font></font>
                            (last_symbol_3 == SD_SYM_1) &amp;&amp; (last_symbol_4 == SD_SYM_1)) {<font></font>
                        fb1 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                        fb2 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                        fb4 = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                    }<font></font>
<font></font>
                    <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// if select LED line</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel &amp; LD_SEL_LED) {
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_time++ &gt; AVG_TIME) {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (led_on_time &lt; THS_TIME) {<font></font>
                    fb0 = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                    fb0 = <span class="hljs-number"><span class="hljs-number">1</span></span>;<font></font>
                }<font></font>
                cur_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
                led_on_time = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
            } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((symbol &amp; (SD_LED_RED | SD_LED_YLW)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) {<font></font>
                    led_on_time++;<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// reset sync flag</span></span>
        sel = <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;<font></font>
}<font></font>
</code></pre><br>
</div></div></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt397697/">https://habr.com/ru/post/pt397697/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt397687/index.html">Em alguns laptops com Windows 10, voc√™ n√£o pode enviar Linux</a></li>
<li><a href="../pt397689/index.html">Por que sempre nos sentimos ocupados</a></li>
<li><a href="../pt397691/index.html">Compre como PRO, mano</a></li>
<li><a href="../pt397693/index.html">Cientistas compilaram um modelo 3D do c√©rebro de Drosophila</a></li>
<li><a href="../pt397695/index.html">O que s√£o plastificantes e o que eles comem</a></li>
<li><a href="../pt397699/index.html">Os benef√≠cios da caligrafia e outros mitos educacionais</a></li>
<li><a href="../pt397701/index.html">Placa de v√≠deo com o meu nome: como se tornar um overclocker profissional</a></li>
<li><a href="../pt397703/index.html">Laureados do Pr√™mio Shnobel 2016</a></li>
<li><a href="../pt397705/index.html">Baterias de √≠on de l√≠tio e pol√≠mero de l√≠tio: truques de marketing e erros comuns</a></li>
<li><a href="../pt397707/index.html">Incr√≠vel cerebelo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>