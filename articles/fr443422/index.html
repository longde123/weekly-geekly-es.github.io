<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÆÔ∏è üë©üèΩ‚Äç‚öïÔ∏è ‚≠êÔ∏è Stockage flexible des donn√©es dans MySQL (JSON) üë©üèº‚Äçü§ù‚Äçüë®üèæ ü•Ö üßùüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alexander Rubin travaille √† Percona et a jou√© √† HighLoad ++ plus d'une fois, familier aux participants en tant qu'expert de MySQL. Il est logique de s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stockage flexible des donn√©es dans MySQL (JSON)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/443422/">  Alexander Rubin travaille √† Percona et a jou√© √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad ++ plus</a> d'une fois, familier aux participants en tant qu'expert de MySQL.  Il est logique de supposer qu'aujourd'hui nous parlerons de quelque chose li√© √† MySQL.  Il en est ainsi, mais seulement en partie, car nous parlerons √©galement de l' <strong>Internet des objets</strong> .  L'histoire sera √† moiti√© divertissante, en particulier sa premi√®re partie, dans laquelle nous examinons l'appareil qu'Alexandre a cr√©√© pour r√©colter les abricots.  Telle est la nature d'un v√©ritable ing√©nieur - si vous voulez des fruits, vous achetez des frais. <br><br><img src="https://habrastorage.org/webt/71/jf/vp/71jfvpzudizjhoc1ikzgfuakds8.jpeg"><br><br><h2>  Contexte <br></h2><br>  Tout a commenc√© par un simple d√©sir de planter un arbre fruitier dans sa r√©gion.  Il semblerait tr√®s simple de le faire - vous venez au magasin et achetez un semis.  Mais en Am√©rique, la premi√®re question que se posent les vendeurs est la quantit√© de lumi√®re solaire que l'arbre recevra.  Pour Alexander, cela s'est av√©r√© √™tre un myst√®re g√©ant - on ignore compl√®tement la quantit√© de lumi√®re solaire sur le site. <br><br>  Pour le savoir, un √©l√®ve peut sortir chaque jour dans la cour, voir combien de soleil et l'√©crire dans un cahier.  Mais ce n'est pas le cas - il faut tout √©quiper et automatiser. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/X5iLzmyZcto" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <em>Pendant la pr√©sentation, de nombreux exemples ont √©t√© pr√©sent√©s et jou√©s en direct.</em>  <em>Vous voulez une image plus compl√®te que dans le texte, passez √† regarder la vid√©o.</em> <br><br>  Ainsi, afin de ne pas enregistrer les observations m√©t√©orologiques dans un ordinateur portable, il existe un grand nombre d'appareils pour les objets Internet - Raspberry Pi, le nouveau Raspberry Pi, Arduino - des milliers de plates-formes diff√©rentes.  Mais j'ai choisi un appareil appel√© <b>Particle Photon</b> pour ce projet.  Il est tr√®s facile √† utiliser, co√ªte 19 $ sur le site officiel. <br><br>  La bonne chose √† propos du photon √† particules est: <br><br><ol><li>  Solution 100% cloud; </li><li>  Tous les capteurs conviennent, par exemple, √† Arduino.  Ils co√ªtent tous moins d'un dollar. </li></ol><br>  J'ai fabriqu√© un tel appareil et l'ai mis dans l'herbe sur le site.  Il dispose d'un nuage de p√©riph√©riques de particules et d'une console.  Cet appareil se connecte via un point d'acc√®s Wi-Fi et envoie des donn√©es: lumi√®re, temp√©rature et humidit√©.  Le testeur a dur√© 24 heures sur une petite batterie, ce qui est plut√¥t bien. <br><br>  De plus, je dois non seulement mesurer l'√©clairage, etc., et les transf√©rer sur le t√©l√©phone (ce qui est vraiment bien - je peux voir en temps r√©el le type d'√©clairage que j'ai), mais aussi <strong>stocker des donn√©es</strong> .  Pour cela, naturellement, en tant que v√©t√©ran de MySQL, j'ai choisi MySQL. <br><br><h2>  Comment √©crire des donn√©es dans MySQL <br></h2><br>  J'ai choisi un sch√©ma assez compliqu√©: <br><br><ul><li>  J'obtiens des donn√©es de la console Particle; <br></li><li>  J'utilise Node.js pour les √©crire sur MySQL. <br></li></ul><br>  J'utilise l'API Particle JS, qui peut √™tre t√©l√©charg√©e sur le site Web de Particle.  J'√©tablis une connexion avec MySQL et j'√©cris, c'est-√†-dire que je fais juste INS√âRER DES valeurs.  Un tel pipeline. <br><br>  Ainsi, l'appareil se trouve dans la cour, se connecte via Wi-Fi au routeur domestique et √† l'aide du protocole MQTT transf√®re les donn√©es √† Particle.  Ensuite, le sch√©ma m√™me: le programme sur Node.js s'ex√©cute sur la machine virtuelle, qui re√ßoit les donn√©es de Particle et les √©crit dans MySQL. <br><br>  Pour commencer, j'ai construit les graphiques √† partir des donn√©es brutes de R. Les graphiques montrent que la temp√©rature et l'illumination augmentent pendant la journ√©e, tombent la nuit et que l'humidit√© augmente - c'est naturel.  Mais il y a aussi du bruit sur le graphique, ce qui est typique pour les appareils Internet of Things.  Par exemple, lorsqu'un bogue rampe sur un appareil et le ferme, le capteur peut transmettre des donn√©es compl√®tement non pertinentes.  Cela sera important pour un examen plus approfondi. <br><br>  Parlons maintenant de MySQL et JSON, ce qui a chang√© en travaillant avec JSON de MySQL 5.7 √† MySQL 8. Ensuite, je vais montrer une d√©mo pour laquelle j'utilise MySQL 8 (au moment du rapport, cette version n'√©tait pas encore pr√™te pour la production, une version stable a d√©j√† √©t√© publi√©e). <br><br><h2>  Stockage de donn√©es MySQL <br></h2><br>  Lorsque nous essayons de stocker les donn√©es re√ßues des capteurs, notre premi√®re pens√©e est <strong>de cr√©er une table dans MySQL</strong> : <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'sensor_wide'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'light'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'temp'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'humidity'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span></code> </pre> <br>  Ici, pour chaque capteur et pour chaque type de donn√©es, il y a une colonne: lumi√®re, temp√©rature, humidit√©. <br><br>  C'est assez logique, mais <strong>il y a un probl√®me - ce n'est pas flexible</strong> .  Supposons que nous voulons ajouter un autre capteur et mesurer autre chose.  Par exemple, certaines personnes mesurent la bi√®re restante dans un f√ªt.  Que faire dans ce cas? <br><br><pre> <code class="plaintext hljs">alter table sensor_wide add water level double ...;</code> </pre><br>  Comment pervertir pour ajouter quelque chose √† la table?  Vous devez faire une table alter, mais si vous avez fait une table alter dans MySQL, alors vous savez de quoi je parle - c'est compl√®tement difficile.  Modifier la table dans MySQL 8 et MariaDB est beaucoup plus simple, mais historiquement, c'est un gros probl√®me.  Donc, si nous devons ajouter une colonne, par exemple, avec le nom de la bi√®re, ce ne sera pas si simple. <br><br>  Encore une fois, les capteurs apparaissent, disparaissent, que faire des anciennes donn√©es?  Par exemple, nous cessons de recevoir des informations sur l'√©clairage.  Ou cr√©ons-nous une nouvelle colonne - comment stocker ce qui n'existait pas auparavant?  L'approche standard est nulle, mais pour l'analyse, elle ne sera pas tr√®s pratique. <br><br>  Une autre option est un magasin de cl√©s / valeurs. <br><br><h3>  Stockage de donn√©es MySQL: cl√© / valeur <br></h3><br>  Il sera <strong>plus flexible</strong> : dans la cl√© / valeur, il y aura un nom, par exemple, la temp√©rature et en cons√©quence les donn√©es. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'cloud_data'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span></code> </pre><br>  Dans ce cas, <strong>un autre probl√®me</strong> appara√Æt <strong>- il n'y a pas de types</strong> .  Nous ne savons pas ce que nous stockons dans le champ ¬´donn√©es¬ª.  Nous devrons le d√©clarer comme un champ de texte.  Lorsque je cr√©e mon appareil Internet des objets, je sais de quel type de capteur il s'agit et en cons√©quence le type, mais si vous devez stocker les donn√©es de quelqu'un d'autre dans le m√™me tableau, je ne saurai pas quelles donn√©es sont collect√©es. <br><br>  Vous pouvez stocker de nombreuses tables, mais la cr√©ation d'une toute nouvelle table pour chaque capteur n'est pas tr√®s bonne. <br><br>  Que peut-on faire?  - Utilisez JSON. <br><br><h3>  Stockage de donn√©es MySQL: JSON <br></h3><br>  La bonne nouvelle est que dans MySQL 5.7, vous pouvez stocker JSON en tant que champ. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">'cloud_data_json'</span></span> ( <span class="hljs-string"><span class="hljs-string">'id'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JSON</span></span>, <span class="hljs-string"><span class="hljs-string">'updated_at'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">'id'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>;</code> </pre><br>  Avant l'apparition de MySQL 5.7, les gens stockaient √©galement JSON, mais sous forme de champ de texte.  Le champ JSON dans MySQL vous permet de stocker le JSON lui-m√™me plus efficacement.  De plus, bas√© sur JSON, vous pouvez cr√©er des colonnes virtuelles et des index bas√©s sur eux. <br><br>  Le seul probl√®me mineur est <strong>que la table augmentera de taille pendant le stockage</strong> .  Mais alors nous obtenons beaucoup plus de flexibilit√©. <br><br>  Le champ JSON est meilleur pour stocker le JSON que le champ de texte car: <br><br><ul><li>  Fournit <strong>une validation automatique des documents</strong> .  Autrement dit, si nous essayons d'√©crire quelque chose qui n'est pas valide, une erreur se produira. <br></li><li>  Il s'agit d'un <strong>format de stockage optimis√©</strong> .  JSON est stock√© au format binaire, ce qui vous permet de passer d'un document JSON √† un autre - ce qu'on appelle sauter. <br></li></ul><br>  Pour stocker des donn√©es dans JSON, nous pouvons simplement utiliser SQL: faire un INSERT, y mettre des ¬´donn√©es¬ª et obtenir des donn√©es de l'appareil. <br><br><pre> <code class="sql hljs">‚Ä¶ stream.on('event', function(data) { var query = connection.query( '<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> cloud_data_json (client_name, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (?, ?)<span class="hljs-string"><span class="hljs-string">', ['</span></span>particle<span class="hljs-string"><span class="hljs-string">', JSON.stringify(data)] ) ‚Ä¶ (demo)</span></span></code> </pre><br><h3>  D√©mo <br></h3><br>  Pour d√©montrer ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> son d√©but dans la vid√©o) l'exemple utilise une machine virtuelle dans laquelle il y a du SQL. <br><br><img src="https://habrastorage.org/webt/r1/mb/po/r1mbpoyh-czzxtsbz2f_umippjc.jpeg"><br><br>  Voici un fragment du programme. <br><br><img src="https://habrastorage.org/webt/ap/fm/pq/apfmpqvjrdx5k8f9z6thallawri.jpeg"><br><br>  <code>INSERT INTO cloud_data (name, data)</code> , j'obtiens les donn√©es d√©j√† au format JSON, et je peux les √©crire directement dans MySQL tel quel, sans penser compl√®tement √† ce qu'il y a √† l'int√©rieur. <br><br>  Il s'est av√©r√© qu'en utilisant ce nuage, vous pouvez acc√©der non seulement aux donn√©es de mon appareil, mais g√©n√©ralement √† <strong>toutes les donn√©es utilis√©es</strong> par cette particule.  Cela semble fonctionner jusqu'√† pr√©sent.  Les gens qui utilisent Particle Photon dans le monde entier envoient des donn√©es: la porte du garage est ouverte, ou le reste de la bi√®re est tel ou tel, ou autre chose.  On ne sait pas o√π se trouvent ces appareils, mais ces donn√©es peuvent √™tre obtenues.  La seule diff√©rence est que lorsque j'obtiens mes donn√©es, j'√©cris quelque chose comme: <code>deviceId: 'mine'</code> . <br><br>  Lorsque nous ex√©cutons le code, nous obtenons un flux de donn√©es provenant des appareils de quelqu'un d'autre qui font quelque chose. <br><br><img src="https://habrastorage.org/webt/sw/wk/c5/swwkc5xibzuqncd-kuuo_figddg.jpeg"><br><br>  Nous ne savons absolument pas quelles sont ces donn√©es: TTL, published_at, coreid, √©tat de la porte (porte ouverte), relais activ√©. <br><br>  Ceci est un excellent exemple.  Supposons que j'essaie de mettre cela dans MySQL dans une structure de donn√©es normale.  Je devrais savoir ce que la porte est l√†, pourquoi elle est ouverte et quels param√®tres g√©n√©raux elle peut prendre.  Si j'ai JSON, je l'√©cris directement dans MySQL en tant que champ JSON. <br><br><img src="https://habrastorage.org/webt/9o/pi/k4/9opik4nqfqiand6n4fhae0zi31u.jpeg"><br><br>  S'il vous pla√Æt, tout a √©t√© enregistr√©. <br><br><img src="https://habrastorage.org/webt/wz/n0/ph/wzn0phesbal_lwsjutyiy3569jq.jpeg"><br><br><h3>  Magasin de documents <br></h3><br>  Le magasin de documents est une tentative dans MySQL de faire du stockage pour JSON.  J'aime vraiment SQL, je le connais bien, je peux faire n'importe quelle requ√™te SQL, etc.  Mais beaucoup de gens n'aiment pas SQL pour diverses raisons, et le magasin de documents peut √™tre une solution pour eux, car avec lui, vous pouvez abstraire de SQL, vous connecter √† MySQL et y √©crire directement JSON. <br><img src="https://habrastorage.org/webt/w5/9z/5y/w59z5ykdgg9nqfnuuzjdhgrfcmu.jpeg"><br><br>  Il existe une autre possibilit√© qui est apparue dans MySQL 5.7: utiliser un protocole diff√©rent, un port diff√©rent et un autre pilote est √©galement n√©cessaire.  Pour Node.js (en fait, pour tout langage de programmation - PHP, Java, etc.), nous nous connectons √† MySQL en utilisant un protocole diff√©rent et pouvons transf√©rer des donn√©es au format JSON.  Encore une fois, je ne sais pas ce que j'ai dans ce JSON - des informations sur les portes ou autre chose, je vide simplement les donn√©es dans MySQL, puis nous le d√©couvrirons. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mysqlx = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'@mysql/xdevapi*); // MySQL Connection var mySession = mysqlx.gctSession({ host: '</span></span>localhost<span class="hljs-string"><span class="hljs-string">', port: 33060, dbUser: '</span></span>photon* }); ‚Ä¶ session.getSchema(<span class="hljs-string"><span class="hljs-string">"particle"</span></span>).getCollection(<span class="hljs-string"><span class="hljs-string">"cloud_data_docstore"</span></span>) .add( data ) .execute(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row</span></span></span><span class="hljs-function">) </span></span>{ }).catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err); }) .then( -<span class="hljs-built_in"><span class="hljs-built_in">Function</span></span> (notices) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Wrote to MySQL"</span></span>) }); ...https:<span class="hljs-comment"><span class="hljs-comment">//dev.mysql.com/doc/dev/connector-nodejs/</span></span></code> </pre><br>  Si vous voulez exp√©rimenter cela, vous pouvez configurer MySQL 5.7 afin qu'il comprenne et √©coute sur le port appropri√© Document store ou X DevAPI.  J'ai utilis√© connector-nodejs. <br><br>  Ceci est un exemple de ce que j'√©cris l√†-bas: bi√®re, etc. Je ne sais absolument pas ce qu'il y a.  Maintenant, nous l'√©crivons et l'analysons plus tard. <br><br><img src="https://habrastorage.org/webt/vo/cw/jn/vocwjnriy8x0mgrsepta-nrcpcm.jpeg"><br><br>  Le prochain point de notre programme est de savoir comment voir ce qu'il y a? <br><br><h3>  Stockage de donn√©es MySQL: index JSON + <br></h3><br>  Il existe une excellente fonctionnalit√© dans JSON et MySQL 5.7 qui peut extraire des champs de JSON.  Il s'agit d'un tel sucre syntaxique sur la fonction JSON_EXTRACT.  Je pense que c'est tr√®s pratique. <br><br>  Dans notre cas, les donn√©es sont le nom de la colonne dans laquelle JSON est stock√© et le nom est notre champ.  Name, data, published_at - c'est tout ce que nous pouvons retirer de cette fa√ßon. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data_name, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> published <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre><br>  Dans cet exemple, je veux voir ce que j'ai √©crit dans la table MySQL et les 10 derniers enregistrements.  Je fais une telle demande et essaie de l'ex√©cuter.  Malheureusement, <strong>cela fonctionnera tr√®s longtemps</strong> . <br><br>  De mani√®re logique, MySQL n'utilisera aucun index dans ce cas.  Nous extrayons les donn√©es de JSON et essayons d'appliquer une sorte de filtre et de tri.  Dans ce cas, nous obtenons Using filesort. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXPLAIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> data_name ... <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">101589</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> filesort</code> </pre><br>  L'utilisation de filesort est tr√®s mauvaise, c'est une sorte externe. <br><br>  La bonne nouvelle est que vous pouvez prendre 2 mesures pour l'acc√©l√©rer. <br><br><h4>  √âtape 1. Cr√©ez une colonne virtuelle <br></h4><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> published_at DATETIME(<span class="hljs-number"><span class="hljs-number">6</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">STR_TO_DATE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.published_at'</span></span>,<span class="hljs-string"><span class="hljs-string">"%Y-%m-%dT%T.%fZ"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  Je fais EXTRAIT, c'est-√†-dire que je tire des donn√©es de JSON et que je cr√©e une colonne virtuelle √† partir de cela.  La colonne virtuelle n'est pas stock√©e dans MySQL 5.7 et dans MySQL 8 - c'est juste la possibilit√© de cr√©er une colonne s√©par√©e. <br><br>  Vous demandez comment c'est, vous avez dit que ALTER TABLE est une op√©ration si longue.  Mais ici, ce n'est pas si mal.  <strong>La cr√©ation d'une colonne virtuelle est rapide</strong> .  Il y a l√† un probl√®me, mais en fait dans MySQL il y a un verrou sur toutes les op√©rations DDL.  ALTER TABLE est une op√©ration assez rapide et ne reconstruit pas la table enti√®re. <br><br>  Nous avons cr√©√© une colonne virtuelle ici.  J'ai d√ª convertir la date, car en JSON, elle est stock√©e au format iso, mais ici MySQL utilise un format compl√®tement diff√©rent.  Pour cr√©er une colonne, je l'ai nomm√©e, je lui ai donn√© un type et j'ai dit que j'y enregistrerais. <br><br>  Pour optimiser la requ√™te d'origine, vous devez extraire published_at et name.  Published_at existe d√©j√†, le nom est plus facile - cr√©ez simplement une colonne virtuelle. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br><h4>  √âtape 2. Cr√©ation d'un index <br></h4><br>  Dans le code ci-dessous, je cr√©e un index sur published_at et ex√©cute la requ√™te: <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (published_at); Query OK, 0 rows affected (0.31 sec) Records: 0 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: published_at key_len: <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: Backward <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">scan</span></span></code> </pre><br>  Vous pouvez voir que MySQL utilise r√©ellement l'index.  Il s'agit d'une optimisation par commande.  Dans cet exemple, les donn√©es et le nom ne sont pas index√©s.  MySQL utilise l'ordre par donn√©es, et puisque nous avons un index sur published_at, il l'utilise. <br><br>  De plus, je pourrais utiliser la m√™me syntaxe sucre <code>STR_TO_DATE(data-&gt;&gt;'$.published_at',"%Y-%m-%dT%T.%fZ")</code> au lieu de published_at dans l'ordre.  MySQL comprendrait toujours qu'il y a un index sur cette colonne et commencerait √† l'utiliser. <br><br>  Il y a en fait un petit probl√®me avec cela.  Supposons que je veuille trier les donn√©es non seulement par published_at, mais aussi par nom. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, data_name <span class="hljs-keyword"><span class="hljs-keyword">asc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">partitions</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: ALL possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> key_len: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">101589</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> filesort</code> </pre><br>  Si votre appareil traite des dizaines de milliers d'√©v√©nements par seconde, published_at ne donnera pas un bon tri, car il y aura des doublons.  Par cons√©quent, nous ajoutons un autre tri par nom_donn√©es.  Il s'agit d'une requ√™te typique non seulement pour l'Internet des objets: donnez-moi les 10 derniers √©v√©nements, mais triez-les par date, puis, par exemple, par nom de famille de la personne dans l'ordre croissant.  Pour cela, dans l'exemple ci-dessus, il y a deux champs et deux cl√©s de tri sont sp√©cifi√©es: d√©croissante et ascendante. <br><br>  Tout d'abord, dans ce cas, MySQL n'utilisera pas d'index.  Dans ce cas particulier, MySQL d√©cide qu'une analyse compl√®te de la table sera plus rentable que l'utilisation d'un index, et l√† encore, l'op√©ration de tri de fichiers tr√®s lente est utilis√©e. <br><br><h2>  Nouveau dans MySQL 8.0 <br></h2><br><h3>  <strong>d√©croissant / croissant</strong> <br></h3><br>  Dans MySQL 5.7, une telle requ√™te ne peut pas √™tre optimis√©e, ne serait-ce qu'au d√©triment d'autres choses.  Dans MySQL 8, il y avait une r√©elle opportunit√© de sp√©cifier le tri pour chaque champ. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> published_at_data_name (published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>, data_name <span class="hljs-keyword"><span class="hljs-keyword">asc</span></span>); Query OK, 0 rows affected (0.44 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  La chose la plus int√©ressante est que la cl√© d√©croissante / ascendante apr√®s le nom de l'index a longtemps √©t√© en SQL.  M√™me dans la toute premi√®re version de MySQL 3.23, vous pouviez sp√©cifier published_at descending ou published_at ascending.  MySQL a accept√© cela, <strong>mais n'a rien fait</strong> , c'est-√†-dire qu'il a toujours tri√© dans une direction. <br><br>  Dans MySQL 8, cela a √©t√© corrig√© et maintenant il existe une telle fonctionnalit√©.  Vous pouvez cr√©er un champ par ordre d√©croissant et avec un tri par d√©faut. <br><br>  Revenons en arri√®re une seconde et regardons √† nouveau l'exemple de l'√©tape 2. <br><br>  Pourquoi √ßa marche, sinon √ßa ne marche pas?  Cela fonctionne car dans les index MySQL, il s'agit d'un arbre B, et les index B peuvent √™tre lus √† la fois depuis le d√©but et la fin.  Dans ce cas, MySQL lit l'index depuis la fin et tout va bien.  Mais si nous descendons et montons, vous ne pouvez pas lire.  Vous pouvez lire dans le m√™me ordre, mais <strong>vous ne pouvez pas combiner deux tris</strong> - vous devez trier √† nouveau. <br><br>  Puisque nous optimisons un cas tr√®s sp√©cifique, nous pouvons cr√©er un index pour lui et sp√©cifier un tri sp√©cifique: ici published_at est d√©croissant, data_name est croissant.  MySQL utilise cet index, et tout ira bien et rapidement. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">explain</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> data_name, published_at, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> published_at <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>\G select_type: SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>: cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">partitions</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> possible_keys: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>: published_at_data_name key_len: <span class="hljs-number"><span class="hljs-number">267</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span>: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: <span class="hljs-literal"><span class="hljs-literal">NULL</span></span></code> </pre><br>  Il s'agit d'une fonctionnalit√© de MySQL 8, qui est maintenant, au moment de la publication, d√©j√† disponible et pr√™t √† √™tre utilis√© en production. <br><br><h3>  R√©sultats de sortie <br></h3><br>  Il y a deux autres choses int√©ressantes que je veux montrer: <br><br>  1. Jolie impression, c'est-√†-dire une belle sortie de donn√©es √† l'√©cran.  Avec SELECT normal, JSON ne sera pas format√©. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> json_pretty(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cloud_data_json <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%beer%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>\G ‚Ä¶ json_pretty(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>): { <span class="hljs-string"><span class="hljs-string">"ttl"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"data"</span></span>: <span class="hljs-string"><span class="hljs-string">"FvGav,tagkey=beer-store spFridge=7.00,pvFridge=7.44"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"LOG_DATA_DEBUG"</span></span>, <span class="hljs-string"><span class="hljs-string">"coreid"</span></span>: <span class="hljs-string"><span class="hljs-string">"3600...."</span></span>, <span class="hljs-string"><span class="hljs-string">"published_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"2017-09-28T18:21:16.517Z"</span></span> }</code> </pre><br>  2. Nous pouvons dire que MySQL affichera le r√©sultat sous la forme d'un tableau JSON ou d'un objet JSON, sp√©cifier les champs, puis la sortie sera format√©e en JSON. <br><br><h2>  Recherche plein texte dans les documents JSON <br></h2><br>  Si nous utilisons un syst√®me de stockage flexible et ne savons pas ce qui se trouve √† l'int√©rieur de notre JSON, il serait logique d'utiliser la recherche en texte int√©gral. <br><br>  Malheureusement, la <strong>recherche en texte int√©gral a ses limites</strong> .  La premi√®re chose que j'ai essay√©e √©tait juste de cr√©er une cl√© de texte int√©gral.  J'ai essay√© de faire une chose pareille: <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); ERROR 3152 (42000): JSON column 'data' supports indexing only via generated columns on a specified ISON path.</code> </pre><br>  Malheureusement, cela ne fonctionne pas.  M√™me dans MySQL 8, la cr√©ation d'un index de texte int√©gral simplement par le champ JSON est malheureusement impossible.  Bien s√ªr, je voudrais avoir une telle fonction - la possibilit√© de rechercher au moins par les cl√©s JSON serait tr√®s utile. <br><br>  Mais si ce n'est pas encore possible, cr√©ons une colonne virtuelle.  Dans notre cas, il y a un champ de donn√©es, et il serait int√©ressant pour nous de voir ce qu'il y a √† l'int√©rieur. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_data <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VIRTUAL</span></span>; Query OK, 0 rows affected (0.01 sec) Records: 0 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> ft_json(data_name, data_data); ERROR 3106 (HY000): 'Fulltext index on virtual generated column' is not supported for generated columns.</code> </pre><br>  Malheureusement, cela ne fonctionne pas non plus - <strong>vous ne pouvez pas cr√©er un index de texte int√©gral sur une colonne virtuelle</strong> . <br><br>  Si c'est le cas, cr√©ons une colonne stock√©e.  MySQL 5.7 vous permet de d√©clarer une colonne en tant que champ stock√©. <br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_name <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> UTF8MB4 -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span>; Query OK, 123518 rows affected (1.75 sec) Records: 123518 Duplicates: 0 Warnings: 0 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> fulltext <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> ft_json(data_name); Query OK, 0 rows affected, 1 warning (3.78 sec) Records: 0 Duplicates: 0 Warnings: 1 mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">warnings</span></span>; +<span class="hljs-comment"><span class="hljs-comment">------------+--------+---------------------------------------------------+ | Level | Code | Message | +------------+--------+---------------------------------------------------+ | Warning | 124 | InnoDB rebuilding table to add column FTS_DOC_ID | +------------+--------+---------------------------------------------------+</span></span></code> </pre><br>  Dans les exemples pr√©c√©dents, nous avons cr√©√© des colonnes virtuelles qui ne sont pas stock√©es, mais des index sont cr√©√©s et stock√©s.  Dans ce cas, j'ai d√ª dire √† MySQL qu'il s'agit d'une colonne STORED, c'est-√†-dire qu'elle sera cr√©√©e et que les donn√©es y seront copi√©es.  Apr√®s cela, MySQL a cr√©√© un index de texte int√©gral, pour cela nous avons d√ª recr√©er la table.  Mais cette limitation est en fait la recherche plein texte InnoDB et InnoDB: vous devez recr√©er le tableau pour ajouter un identifiant de recherche plein texte sp√©cial. <br><br>  Fait int√©ressant, dans MySQL 8, il y avait un <strong>nouvel encodage</strong> <strong>UTF8</strong> <strong>MB4 pour les √©motic√¥nes</strong> .  Bien s√ªr, pas tout √† fait pour eux, mais parce que dans UTF8MB3, il y a des probl√®mes avec le russe, le chinois, le japonais et d'autres langues. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes -&gt; <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> data_data <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> UTF8MB4 -&gt; <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALWAYS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-&gt;&gt;<span class="hljs-string"><span class="hljs-string">'$.data'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> UTF8MB4) ) <span class="hljs-keyword"><span class="hljs-keyword">STORED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Query</span></span> OK, <span class="hljs-number"><span class="hljs-number">123518</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> affected (<span class="hljs-number"><span class="hljs-number">3.14</span></span> sec) <span class="hljs-keyword"><span class="hljs-keyword">Records</span></span>: <span class="hljs-number"><span class="hljs-number">123518</span></span> Duplicates: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Warnings</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  En cons√©quence, MySQL 8 devrait stocker les donn√©es JSON dans UTF8MB4.  Mais que ce soit en raison du fait que Node.js se connecte √† Device Cloud, et que quelque chose y est mal √©crit, ou qu'il s'agit d'un bogue de la version b√™ta, cela ne s'est pas produit.  Par cons√©quent, j'ai d√ª convertir les donn√©es avant de les √©crire dans une colonne stock√©e. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cloud_data_json_indexes <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ft_json, <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> FULLTEXT <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ft_json(data_name, data_data); Query OK, 0 rows affected (1.85 sec) Records: 0 Duplicates: 0 Warnings: 0</code> </pre><br>  Apr√®s cela, j'ai pu cr√©er une recherche en texte int√©gral sur deux champs: sur le nom JSON et sur les donn√©es JSON. <br><br><h2>  Non seulement l'IoT <br></h2><br>  JSON n'est pas seulement l'Internet des objets.  Il peut √™tre utilis√© pour d'autres choses int√©ressantes: <br><br><ul><li>  Champs personnalis√©s (CMS); </li><li>  Structures complexes, etc. </li></ul><br>  Certaines choses peuvent √™tre mises en ≈ìuvre de mani√®re beaucoup plus pratique √† l'aide d'un syst√®me de stockage de donn√©es flexible.  Un excellent exemple a √©t√© fourni √† Oracle OpenWorld: r√©servations de cin√©ma.  Il est tr√®s difficile de l'impl√©menter dans le mod√®le relationnel - vous obtenez de nombreuses tables d√©pendantes, jointures, etc.  D'autre part, nous pouvons stocker la salle enti√®re sous forme de structure JSON, respectivement, l'√©crire dans MySQL dans d'autres tables et l'utiliser de la mani√®re habituelle: cr√©er des index bas√©s sur JSON, etc.  <b>Les structures complexes sont facilement stock√©es au format JSON.</b> <br><br><img src="https://habrastorage.org/webt/9m/i3/th/9mi3thcaas9caominanputmpaua.jpeg"><br><br>  Il s'agit d'un arbre qui a √©t√© plant√© avec succ√®s.  Malheureusement, quelques ann√©es plus tard, les cerfs l'ont mang√©, mais c'est une histoire compl√®tement diff√©rente. <br><br><blockquote>  Ce rapport est un excellent exemple de la fa√ßon dont une section enti√®re se d√©veloppe √† partir d'un sujet lors d'une grande conf√©rence, puis d'un √©v√©nement distinct.  Dans le cas de l'Internet des objets, nous avons eu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">InoThings ++</a> - une conf√©rence pour les professionnels du march√© de l'Internet des objets, qui se tiendra pour la deuxi√®me fois le 4 avril. <br><br>  L'√©v√©nement central de la conf√©rence, semble-t-il, sera la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">table ronde</a> ¬´Avons-nous besoin de normes nationales sur l'Internet des objets?¬ª, Qui sera organiquement compl√©t√©e par des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapports</a> appliqu√©s d√©taill√©s.  Venez si vos syst√®mes fortement charg√©s se d√©placent correctement vers IIoT. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443422/">https://habr.com/ru/post/fr443422/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443406/index.html">Les 20 principales erreurs lors de l'utilisation du multithreading en C ++ et les moyens de les √©viter</a></li>
<li><a href="../fr443408/index.html">Photons, quanta et √©tat de Fock: manipulations au niveau quantique avec un r√©sonateur radiofr√©quence</a></li>
<li><a href="../fr443412/index.html">Pourquoi les programmeurs continuent d'utiliser Java verbeux, bien qu'il existe un Python concis</a></li>
<li><a href="../fr443414/index.html">Panneau: quand les points d'arr√™t ne suffisent pas</a></li>
<li><a href="../fr443416/index.html">Winnti: une attaque contre les cha√Ænes d'approvisionnement - Les d√©veloppeurs de jeux asiatiques sont au premier plan</a></li>
<li><a href="../fr443424/index.html">R√©√©criture du sc√©nario de test pour le frontend junior sur TypeScript et React-hooks</a></li>
<li><a href="../fr443426/index.html">Marque noire - comment OpenShift prot√®ge contre les vuln√©rabilit√©s des conteneurs avec SELinux</a></li>
<li><a href="../fr443428/index.html">Palmer Lucky, le "p√®re" d'Oculus Rift, d√©veloppe un syst√®me de champ de bataille virtuel pour le Pentagone</a></li>
<li><a href="../fr443432/index.html">Sortie de Blazor 0.9.0</a></li>
<li><a href="../fr443434/index.html">Notifications: action requise pour prendre un profit / stop loss. Dans le cas o√π votre courtier ne prend pas en charge ces ordres</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>