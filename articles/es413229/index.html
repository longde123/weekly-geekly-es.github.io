<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎂 🧓🏼 👋🏼 Build Caffe en Google Colaboratory: Tarjeta gráfica gratuita en la nube 🧗🏾 🙏🏾 🌂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Google Colaboratory es un servicio en la nube recientemente lanzado destinado a simplificar la investigación en aprendizaje automático y aprendizaje p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Build Caffe en Google Colaboratory: Tarjeta gráfica gratuita en la nube</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413229/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Google Colaboratory</a> es un servicio en la nube recientemente lanzado destinado a simplificar la investigación en aprendizaje automático y aprendizaje profundo.  Con el Colaboratorio, puede obtener acceso remoto a una máquina con una tarjeta de video conectada, y es completamente gratis, lo que simplifica enormemente la vida cuando tiene que entrenar redes neuronales profundas.  Podemos decir que es un análogo de los documentos de Google para el Jupyter Notebook. <br><br>  Colaboratory tiene Tensorflow <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">preinstalado</a> y casi todas las bibliotecas de Python necesarias para trabajar.  Si falta un paquete, se instala fácilmente sobre la <code>pip</code> través de <code>pip</code> o <code>apt-get</code> .  Pero, ¿qué sucede si necesita construir un proyecto desde la fuente y conectarse a la GPU?  Resulta que esto puede no ser tan simple que descubrí durante la compilación de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SSD-Caffe</a> .  En esta publicación, daré una breve descripción del Colaboratorio, describiré las dificultades encontradas y cómo resolverlas, y proporcionaré algunos trucos útiles. <br><br>  Todo el código está disponible en mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://vk.com/away.php%3Futf%3D1%26to%3D">cuaderno de colaboración</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b0/fv/v8/b0fvv8egfxlwczpdifnoyazgfng.png"></div><a name="habracut"></a><br><h2>  Brevemente sobre Colaboratorio </h2><br>  Hablando en términos generales, Colaboratory le permite ejecutar Jupyter Notebook en una máquina remota.  Los archivos de colaboración son "laptops" .ipynb comunes y se almacenan en el disco de Google.  También hay un conjunto de funciones que le permite cargar archivos desde una máquina remota al disco de Google y viceversa.  También puede compartir estos archivos con otros, puede escribir comentarios sobre ellos, como en los documentos de Google. <br><br>  En el Colaboratorio, puede usar la GPU, es decir, el Tesla K80.  Para hacer esto, conéctelo en la configuración: Tiempo de ejecución <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.845ex" height="2.419ex" viewBox="0 -780.1 5100 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-72" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-69" x="701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-67" x="1047" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-68" x="1527" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-74" x="2104" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-61" x="2465" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-72" x="2995" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-72" x="3446" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-6F" x="3898" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-77" x="4383" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> \ rightarrow </script>  Cambiar tipo de tiempo de ejecución <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.845ex" height="2.419ex" viewBox="0 -780.1 5100 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-72" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-69" x="701" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-67" x="1047" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-68" x="1527" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-74" x="2104" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-61" x="2465" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-72" x="2995" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-72" x="3446" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-6F" x="3898" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/413229/&amp;usg=ALkJrhiLXMV6KrpNjAtPzcQ8Mta9b5q17Q#MJMATHI-77" x="4383" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>r</mi><mi>i</mi><mi>g</mi><mi>h</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>r</mi><mi>o</mi><mi>w</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> \ rightarrow </script>  Acelerador de hardware.  Vale la pena señalar que las GPU no siempre están disponibles, y luego el Colaboratorio ofrecerá arrancar la máquina sin ella. <br><br>  Parece que no se puede iniciar nada excepto el propio Jupyter Notebook, pero hay acceso indirecto al terminal: para esto, debe agregar un signo de exclamación antes del comando del terminal, por ejemplo <code>!mkdir images</code> .  En general, podemos suponer que estamos tratando con una máquina ordinaria perfecta en la que está instalado Ubuntu 17.10 (en el momento de la escritura), pero conectado de forma remota.  Se deduce que todo lo que se puede hacer a través del terminal (no de forma interactiva) se puede hacer en él, incluyendo: <br><br><ul><li>  clonar repositorios usando <code>git clone</code> , </li><li>  cargar datos usando <code>wget</code> (por cierto, incluso los archivos grandes se cargan casi instantáneamente desde un disco de Google), </li><li>  use <code>make</code> (y probablemente <code>cmake</code> ) </li><li>  instalar herramientas y bibliotecas usando <code>apt-get</code> y <code>pip</code> </li></ul><br>  Algunos comentarios más sobre el Colaboratorio: <br><br><ul><li>  Parece que el usuario tiene acceso ilimitado a todos los archivos del sistema (cualquier comando debe escribirse sin <code>sudo</code> ); </li><li>  El estado terminal no se transfiere entre los equipos, incluso si están en la misma celda (por ejemplo, <code>cd dir</code> si es necesario, deberá escribir al comienzo de cada comando); </li><li>  Si se desconecta del Colaboratorio durante mucho tiempo, se borrarán todos los cambios en la máquina virtual, incluidos todos los paquetes instalados y los archivos descargados, por lo tanto, se recomienda que la instalación de los paquetes se incluya en el Jupyter Notebook; </li><li>  Después de 12 horas de uso continuo, la máquina se apaga automáticamente, pero luego se puede reiniciar (en teoría, en la práctica, la GPU puede no estar disponible). </li></ul><br><h2>  SSD-Caffe Build </h2><br>  Quería probar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Single Shot Detector (SSD)</a> , es decir, su <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">implementación Caffe</a> en Google Colaboratory, pero para esto, el proyecto necesitaba ser ensamblado desde la fuente. <br><br>  Por cierto, si alguna versión de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Caffe</a> es adecuada para usted, hay una manera mucho más fácil (incluso funciona, aunque no he intentado ejecutar nada): <br><br><pre> <code class="bash hljs">!apt install caffe-cuda</code> </pre> <br>  Ensamblar SSD-Caffe desde el origen es una búsqueda bastante larga de varios pasos, que solo se puede hacer con muletas. <br><br>  <b>Paso 1: instalación de dependencias</b> <br><br>  Aquí debemos descargar todas las dependencias de Caffe usando <code>apt</code> .  Sin embargo, antes de hacer esto, debe permitir que <code>apt</code> descargue el código fuente de la dependencia.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La guía de instalación de Caffe</a> dice que esto requiere una "línea deb-src en el archivo sources.list".  Desafortunadamente, no hay detalles allí, así que simplemente descomenté todas las líneas <code>deb-src</code> en el archivo <code>/etc/apt/sources.list</code> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'/etc/apt/sources.list'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: txt = f.read() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'/etc/apt/sources.list'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(txt.replace(<span class="hljs-string"><span class="hljs-string">'# deb-src'</span></span>,<span class="hljs-string"><span class="hljs-string">'deb-src'</span></span>))</code> </pre><br>  Y funcionó.  Solo queda descargar las dependencias: <br><br><pre> <code class="bash hljs">!apt update !apt build-dep caffe-cuda</code> </pre><br>  <b>Paso 2: necesita otro compilador</b> <br><br>  Aquí el problema es este: <code>g++-7</code> , que es el predeterminado por defecto, es por alguna razón incompatible con el compilador <code>nvcc</code> CUDA, por lo que debe usar algo más.  Descargué <code>g++-5</code> y lo convertí en el compilador predeterminado: <br><br><pre> <code class="bash hljs">!apt install g++-5 !update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 20 !update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 20</code> </pre><br>  <b>Paso 3: tienes que construir impulso</b> <br><br>  Si intenta construir Caffe en esta etapa, surgirán problemas cuando intente conectar boost, porque fue compilado por otro compilador, por lo que debe descargar sus fuentes y también compilar usando <code>g++-5</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">más en el sitio web de boost</a> ): <br><br><pre> <code class="bash hljs">!wget https://dl.bintray.com/boostorg/release/1.67.0/<span class="hljs-built_in"><span class="hljs-built_in">source</span></span>/boost_1_67_0.tar.bz2 !tar --bzip2 -xf boost_1_67_0.tar.bz2 !<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> boost_1_67_0 &amp;&amp; ./bootstrap.sh --<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>-prefix=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> --with-libraries=system,filesystem,regex,thread,python --with-python-version=2.7 --with-python-root=/usr !<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> boost_1_67_0 &amp;&amp; ./b2 install</code> </pre><br>  <b>Paso 4: Configurar Makefile</b> <br><br>  Clone Caffe con GitHub: <br><br><pre> <code class="bash hljs">!git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/weiliu89/caffe.git &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> caffe &amp;&amp; git checkout ssd</code> </pre><br>  Y cambiamos los campos necesarios en Makefile.config: cambié la ruta a CUDA, cambié la opción BLAS, cambié la versión de OpenCV a un tercero, agregué una capa de Python y también agregué todas las rutas a las bibliotecas que se instalaron, pero por alguna razón no se encontraron (todo esto es conveniente) hecho usando Python): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'caffe/Makefile.config.example'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: config = f.read() comment = [<span class="hljs-string"><span class="hljs-string">'CUDA_DIR := /usr/local/cuda'</span></span>, <span class="hljs-string"><span class="hljs-string">'BLAS := open'</span></span>] uncomment = [<span class="hljs-string"><span class="hljs-string">'# CUDA_DIR := /usr'</span></span>, <span class="hljs-string"><span class="hljs-string">'# BLAS := atlas'</span></span>, <span class="hljs-string"><span class="hljs-string">'# OPENCV_VERSION := 3'</span></span>, <span class="hljs-string"><span class="hljs-string">'# WITH_PYTHON_LAYER := 1'</span></span>] <span class="hljs-comment"><span class="hljs-comment"># replace = [('INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include', 'INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/local/include /usr/include/hdf5/serial /usr/local/lib/python2.7/dist-packages/numpy/core/include/'), ('LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib', 'LIBRARY_DIRS := $(PYTHON_LIB) /usr/local/lib /usr/lib /usr/lib/x86_64-linux-gnu/hdf5/serial')] for c in uncomment: config = config.replace(c, c[2:]) for c in comment: config = config.replace(c, '# '+c) for c1,c2 in replace: config = config.replace(c1, c2) with open('caffe/Makefile.config', 'w') as f: f.write(config)</span></span></code> </pre><br>  Además, en el Makefile en sí, tuve que reemplazar todas las etiquetas <code>-isystem</code> con <code>-I</code> : ambas son responsables de encontrar los encabezados, pero se procesan de manera un poco diferente, y sin este problema de reemplazo ya ocurrió cuando stdlib estaba conectado ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">más detalles aquí</a> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'caffe/Makefile'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: mfile = f.read() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'caffe/Makefile'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(mfile.replace(<span class="hljs-string"><span class="hljs-string">'-isystem'</span></span>,<span class="hljs-string"><span class="hljs-string">'-I'</span></span>))</code> </pre><br>  <b>Paso 5: construir</b> <br><br>  <code>c++config.h</code> una última muleta: para corregir el <code>c++config.h</code> , de lo contrario, hay problemas con los tipos nan ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">más</a> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'/usr/include/x86_64-linux-gnu/c++/5/bits/c++config.h'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: txt = f.read() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'/usr/include/x86_64-linux-gnu/c++/5/bits/c++config.h'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(txt.replace(<span class="hljs-string"><span class="hljs-string">'/* #undef _GLIBCXX_USE_C99_MATH */'</span></span>, <span class="hljs-string"><span class="hljs-string">'/* #undef _GLIBCXX_USE_C99_MATH */\n#define _GLIBCXX_USE_C99_MATH 1'</span></span>))</code> </pre><br>  Ahora, de hecho, puedes construir Caffe: <br><br><pre> <code class="bash hljs">!<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> caffe &amp;&amp; make -j8 &amp;&amp; make pycaffe &amp;&amp; make <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> -j8 &amp;&amp; make distribute !<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib &gt;&gt; /etc/ld.so.conf &amp;&amp; ldconfig !<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /content/caffe/distribute/lib &gt;&gt; /etc/ld.so.conf &amp;&amp; ldconfig</code> </pre><br>  Las dos últimas líneas agregan las rutas de la biblioteca, a saber, boost y Caffe. <br><br>  Ahora se puede usar Caffe (solo necesita especificar la ruta en PYTHONPATH): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys caffe_path = !cd caffe/python &amp;&amp; pwd sys.path.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>, caffe_path[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> caffe</code> </pre><br>  Para probarlo, probé el proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mobilenet-SSD</a> : el código también está en mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://vk.com/away.php%3Futf%3D1%26to%3D">cuaderno de colaboración</a> . <br><br>  En particular, medí el tiempo de predicción para una imagen, y la aceleración en la GPU fue de aproximadamente 3.8. <br><br><h2>  Bonus: algunos trucos útiles </h2><br>  Hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gran tutorial</a> sobre Medium en Google Colaboratory.  También en el propio Colaboratorio hay archivos con ejemplos de casi todo lo que puede ser necesario. <br><br>  Monte un disco de Google en el sistema de archivos de una máquina virtual: <br><br><pre> <code class="bash hljs">!apt-get install -y -qq software-properties-common python-software-properties module-init-tools !add-apt-repository -y ppa:alessandro-strada/ppa 2&gt;&amp;1 &gt; /dev/null !apt-get update -qq 2&gt;&amp;1 &gt; /dev/null !apt-get -y install -qq google-drive-ocamlfuse fuse from google.colab import auth auth.authenticate_user() from oauth2client.client import GoogleCredentials creds = GoogleCredentials.get_application_default() import getpass !google-drive-ocamlfuse -headless -id={creds.client_id} -secret={creds.client_secret} &lt; /dev/null 2&gt;&amp;1 | grep URL vcode = getpass.getpass() !<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> {vcode} | google-drive-ocamlfuse -headless -id={creds.client_id} -secret={creds.client_secret}</code> </pre><br>  Este código devolverá el enlace y dará una ventana de entrada.  Debe seguir el enlace, copiar el código e ingresarlo en la ventana.  Por alguna razón, tengo que hacer esto dos veces.  Siguiente: <br><br><pre> <code class="bash hljs">!mkdir -p drive !google-drive-ocamlfuse drive</code> </pre><br>  Después de eso, puede usar su disco de Google como un directorio normal.  Además, todos los cambios en este directorio se sincronizan automáticamente con Google-drive. <br><br>  Instalación de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Keras</a> : <br><br><pre> <code class="python hljs">!pip install -q keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> keras</code> </pre><br>  Instale <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PyTorch</a> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> wheel.pep425tags <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_abbr_impl, get_impl_ver, get_abi_tag platform = <span class="hljs-string"><span class="hljs-string">'{}{}-{}'</span></span>.format(get_abbr_impl(), get_impl_ver(), get_abi_tag()) accelerator = <span class="hljs-string"><span class="hljs-string">'cu80'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> path.exists(<span class="hljs-string"><span class="hljs-string">'/opt/bin/nvidia-smi'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'cpu'</span></span> !pip install -q http://download.pytorch.org/whl/{accelerator}/torch<span class="hljs-number"><span class="hljs-number">-0.3</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>.post4-{platform}-linux_x86_64.whl torchvision <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> torch</code> </pre><br>  Cambiar directorio de trabajo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os os.chdir(<span class="hljs-string"><span class="hljs-string">"/path/to/wdir"</span></span>)</code> </pre><br>  Borre todos los cambios y reinicie la máquina: <br><br><pre> <code class="bash hljs">!<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -9 -1</code> </pre> <br>  Suba el archivo a la máquina local: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.colab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> files files.download(<span class="hljs-string"><span class="hljs-string">'file.ext'</span></span>)</code> </pre><br>  Obtenga el diccionario de los archivos cargados en el disco de Google: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.colab <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> files uploaded = files.upload()</code> </pre><br>  Salida de comando de terminal de silencio (redirigir a variable): <br><br><pre> <code class="python hljs">lines_list = !pwd</code> </pre><br>  En general, Google Colaboratory brinda una buena oportunidad para realizar capacitación de redes neuronales en la nube.  Es cierto que esto puede no ser suficiente para cuadrículas muy grandes.  Otra ventaja es la capacidad de ejecutar código independientemente del sistema operativo local (que es bueno para la reproducibilidad), y también trabajar juntos en el mismo proyecto.  Como captura, la GPU puede no estar disponible, incluso durante mucho tiempo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413229/">https://habr.com/ru/post/es413229/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413219/index.html">Bienvenido a QA-meetup SuperJob</a></li>
<li><a href="../es413221/index.html">Las bacterias sobreviven en una "sala limpia" durante el montaje de naves espaciales, comiendo productos de limpieza</a></li>
<li><a href="../es413223/index.html">Diccionario habra. Parte 1</a></li>
<li><a href="../es413225/index.html">Semana de la seguridad 20: ciberataques no triviales</a></li>
<li><a href="../es413227/index.html">¿Qué es dios debajo de la ropa?</a></li>
<li><a href="../es413231/index.html">Introducción a los contratos inteligentes</a></li>
<li><a href="../es413233/index.html">El servicio uLogin envía datos desde formularios (correo, teléfono) a un sitio de terceros y no dice nada al respecto.</a></li>
<li><a href="../es413235/index.html">Apuesta por mejores predicciones: nuevas matemáticas de pronósticos del tiempo</a></li>
<li><a href="../es413237/index.html">Facebook niega haber enviado a los fabricantes de dispositivos los mismos datos que el desarrollador Alexander Kogan</a></li>
<li><a href="../es413239/index.html">Cómo hacer que un teléfono inteligente sea un poco más tonto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>