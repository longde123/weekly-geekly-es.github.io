<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöµ üßúüèæ üõê Nous profilons le chargement de Habr ou comment 189 requ√™tes sur la page rendent l'influence ‚úåüèæ üï¢ üôã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, je me suis int√©ress√© aux performances du site Web, aux optimisations de t√©l√©chargement, etc. Et maintenant, en allant une fois d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous profilons le chargement de Habr ou comment 189 requ√™tes sur la page rendent l'influence</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454444/"><p><img src="https://habrastorage.org/webt/dg/5m/ab/dg5mabkefi6xhfiovvydhay2fkw.jpeg" alt="Prenez du jus de cerise √©pais"></p><br><p>  Il y a quelque temps, je me suis int√©ress√© aux performances du site Web, aux optimisations de t√©l√©chargement, etc.  Et maintenant, en allant une fois de plus au Habr, je pensais que j'avais l'habitude de percevoir une charge de ressources assez rapide comme une donn√©e, sans m√™me penser √† la fa√ßon dont cela √©tait r√©alis√©.  J'ai donc d√©cid√© de combiner affaires et plaisir - pour voir comment les choses √©voluent avec les performances d'Habr et quelles solutions techniques ont √©t√© mises en place pour les optimiser. </p><br><p>  Pour ceux qui souhaitent savoir ce qui a √©t√© fait afin que nous recevions le contenu le plus rapidement possible et √† quoi ressemble le t√©l√©chargement du Habr d'Argentine - s'il vous pla√Æt, sous cat. </p><a name="habracut"></a><br><h2 id="podgotovka">  La pr√©paration </h2><br><p>  Nous aurons besoin d'une nouvelle version de Chrome / Canary fonctionnant en mode anonyme (assurez-vous que toutes les extensions sont d√©sactiv√©es).  De plus, dans la console d√©veloppeur (Developer Tools - F12), dans l'onglet r√©seau, vous devez d√©finir l'indicateur de d√©sactivation du cache, car  <strong>Nous ne profilerons que le premier d√©marrage, alors qu'il n'y a pas encore de ressources dans le cache.</strong> </p><br><h2 id="etap-pervyy---po-verham">  Premi√®re √©tape - "A l'√©tage" </h2><br><p>  L'objectif principal de cette partie est de se familiariser avec le site dans son ensemble, de comprendre sa structure et de savoir de quelles ressources sp√©cifiques il a besoin. </p><br><p>  Nous ouvrons les outils de d√©veloppement, allons dans l'onglet r√©seau, ouvrons le site et tout en bas de l'onglet nous regardons les statistiques sur l'utilisation du r√©seau: </p><br><p><img src="https://habrastorage.org/webt/ni/fs/yb/nifsybxewz18qswerh5jubfsn1a.png" alt="Et une cape de m√®re blanche."></p><br><p>  L'ensemble du site a √©t√© charg√© en 2,02 secondes, ce qui est tout simplement g√©nial (compte tenu de la charge de Habr).  L'√©v√©nement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DomContentLoaded</a> (ci-apr√®s simplement DCL) est g√©n√©ralement apparu en 1,01 seconde, ce qui est encore mieux.  Avec tout cela, le site fait 189 demandes et charge 9,6 Mo de ressources.  Cela nous dit que soit l'√©quipe Habra est un g√©nie (cela pourrait bien l'√™tre), et l'article devrait √™tre termin√© ici (et demandez-le √† l'√©quipe pour le caf√© et les cookies), ou rappelez-vous que j'ai une cha√Æne √† 100 Mb / s et Core I7 .  C'est-√†-dire  vous devez vous rapprocher un peu plus de la r√©alit√© et au moins limiter la largeur du canal. </p><br><p>  Nous activons le mode Fast 3G et regardons √† nouveau: </p><br><p><img src="https://habrastorage.org/webt/bp/ov/lk/bpovlkvte1ojvmuamwcoki4uniq.png" alt="Versez doucement le jus sur la cape -"></p><br><p>  DCL a empir√© √† 3,48 secondes, ce qui est encore raisonnablement acceptable.  Mais finalement le site s'est charg√© en 54,76 secondes ath√©es.  Maintenant, tout est logique - vous ne pouvez pas simplement t√©l√©charger et t√©l√©charger pr√®s de 10 m√©gaoctets lorsque votre connexion est faible.  Tr√®s probablement, les gars ont fait du bon travail pour nous montrer le contenu le plus rapidement possible (cela est d√©montr√© par le fait que m√™me en mode fast3g DCL appara√Æt assez rapidement), et ils ont laiss√© tout ce qui n'√©tait pas critique √† charger en arri√®re-plan.  Nous allons v√©rifier cela un peu plus tard, et voyons maintenant pourquoi nous avons charg√© si longtemps.  Trier toutes les demandes par temps de chargement: </p><br><p><img src="https://habrastorage.org/webt/el/jv/uc/eljvucnzbn0d83cd2konxv8ff-8.png" alt="Un spot appara√Ætra."><br>  <a href="">Cliquable</a> </p><br><p>  Les images (top-7) sont charg√©es le plus longtemps et un fichier JavaScript est prebid.js.  Si nous regardons leur taille, nous pouvons supposer que c'est pr√©cis√©ment la raison du chargement lent. </p><br><div class="spoiler">  <b class="spoiler_title">√Ä propos des hypoth√®ses</b> <div class="spoiler_text"><p>  Avec des hypoth√®ses, vous devez √™tre extr√™mement prudent.  Ainsi, par exemple, un long chargement d'une ressource peut √™tre caus√© non seulement par la taille du fichier, mais aussi, par exemple, des probl√®mes avec DNS, une charge de stockage maximale ou un cache de serveur froid.  Par cons√©quent, une hypoth√®se non v√©rifi√©e peut vous faire perdre du temps √† r√©soudre un probl√®me qui n'existe m√™me pas. </p></div></div><br><p>  En regardant les statistiques ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TTFB</a> : 0,610 ms, charge: 40 000 ms), nous pouvons conclure que notre hypoth√®se est tout √† fait probable.  Admirons notre TOP 1 (png, 1560X780, 24 bits): </p><br><p><img src="https://habrastorage.org/webt/61/ts/aj/61tsajb8gnvzqjaw0cg-mqdj32e.png" alt="Maintenant qu'il n'y a plus de place"></p><br><p>  En fait, les probl√®mes d'images sont principalement des probl√®mes de trafic avec vous.  Les images (contrairement aux styles et aux scripts) ne bloquent pas le rendu de la page Web, et donc, malgr√© la pr√©sence de tels poids lourds (cela peut √™tre pire, ils l'ont vu), cela n'a presque aucun effet sur les performances.  Bien s√ªr, l'optimisation dans ce sens (par exemple, le transcodage en jpeg2000 ou webp, ou le chargement progressif ne serait pas superflue). </p><br><div class="spoiler">  <b class="spoiler_title">√Ä propos des images</b> <div class="spoiler_text"><p>  Comme je l'ai √©crit ci-dessus, les images ne bloquent pas le rendu de la page.  Mais ils utilisent notre pool de connexions, et dans http 1.x leur nombre est limit√©, et avec http 2.x et Chrome aussi, tout n'est pas aussi fluide que ce que j'ai entendu.  Par cons√©quent, m√™me ici, il est possible qu'une image ralentisse le chargement d'un script synchrone et que, √† son tour, elle arr√™te d√©j√† le rendu de la page.  De plus, le chargement de l'image peut √©galement provoquer un recomptage de la mise en page, ralentissant ainsi le rendu.  Si nous regardons le balisage Habr, presque toutes les balises img ont une largeur et une hauteur.  Cela √©limine le besoin de refusion pour avoir un impact positif sur les performances de t√©l√©chargement.  Vous pouvez en savoir plus √† ce sujet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p></div></div><br><p>  Voyons quelles autres ressources le Habr tire - nous allons passer en revue les types et les trier par temps de chargement.  Commen√ßons par JavaScript </p><br><h3 id="javascript">  Javascript </h3><br><div class="spoiler">  <b class="spoiler_title">√Ä propos de javascript</b> <div class="spoiler_text"><p>  JavaScript pr√©sente plusieurs probl√®mes en termes de performances du site.  Tout d'abord (tout le monde le sait depuis longtemps), js synchrone bloque le rendu des pages.  C'est-√†-dire  jusqu'√† ce que nous recevions et ex√©cutions notre JavaScript, le navigateur attendra (en fait pas tout √† fait, le navigateur, en particulier Chrome, peut optimiser, mais c'est une autre histoire) et ne restituera pas de contenu suppl√©mentaire.  En utilisant des scripts synchrones dans la t√™te, nous reportons le moment o√π l'utilisateur voit au moins quelque chose (m√™me du texte).  Par cons√©quent, tout le monde essaie de lancer Js √† la fin de la page ou m√™me de le rendre asynchrone.  Cela fonctionne, mais ne r√©sout pas le deuxi√®me probl√®me qui nous am√®ne au fait que JavaScript est toujours un langage de script.  Par cons√©quent, le navigateur ne suffit pas simplement pour le t√©l√©charger - il doit √©galement √™tre ¬´compris¬ª.  Et ici, il s'av√®re que c'est un probl√®me, car les processeurs faibles (par exemple, dans les t√©l√©phones ou netbooks bon march√©, ou m√™me les bons ordinateurs portables en mode de performance limit√©e) le font lentement, bloquant le thread principal!  Vous trouverez ci-dessous un exemple de la fa√ßon dont un script publicitaire asynchrone est entr√© dans la section critique du rendu Habr et bien qu'un peu, mais a encore g√¢ch√© les performances.  Si quelqu'un est int√©ress√©, il y a un tr√®s (tr√®s, tr√®s) bon article sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce sujet.</a> </p></div></div><br><p>  Les scripts Habr chargent beaucoup - 1,1 Mo (et c'est d√©j√† sous une forme compress√©e) pour 40 demandes.  C'est franchement significatif, cela nous revient encore et nous devons y faire quelque chose.  Trier nos scripts "par la cascade".  Notre t√¢che est de trouver les scripts charg√©s AVANT la ligne bleue, car ce sont eux (tr√®s probablement) qui nous emp√™chent de rendre le site le plus rapidement possible. </p><br><p><img src="https://habrastorage.org/webt/0m/8g/u4/0m8gu4f9s-odx2kf7xg8jiweuke.png" alt="Sur le manteau de ma m√®re"><br>  <a href="">Cliquable</a> </p><br><p>  Nous ouvrons le html que Habr nous a donn√© (il est important de regarder la r√©ponse, car le html final sera diff√©rent) et parcourons la liste.  Comme vous pouvez le voir - jQuery, raven.js, advertise.js et adriver.js sont charg√©s de mani√®re synchrone directement √† partir de la balise head (c'est-√†-dire qu'ils bloquent tout).  Gpt et l'√©diteur sont charg√©s √† partir de head mais d√©j√† de mani√®re asynchrone (c'est-√†-dire qu'ils ne bloquent rien, le navigateur rendra la page plus loin pendant le chargement).  Vendors, Main et Math, checklogin sont charg√©s √† la fin, mais de mani√®re synchrone (c'est-√†-dire que le texte est d√©j√† l√†, nous pouvons le lire, mais le DCL n'appara√Ætra pas avant le chargement).  Les autres n'apparaissent pas dans la r√©ponse initiale - ils sont ajout√©s dynamiquement, mais c'est un autre sujet. </p><br><p>  Nous avons donc trouv√© ces scripts qui affectent en quelque sorte la vitesse √† laquelle nous voyons le texte sur la page.  Ce sont les premiers candidats √† l'optimisation.  Id√©alement, ils devraient √™tre rendus asynchrones ou plac√©s aussi bas que possible pour permettre au navigateur de rendre le contenu pour nous.  Cependant, l'id√©al n'est pas r√©alisable, car il y a tr√®s probablement d'autres scripts sur le site qui d√©pendent du m√™me jQuery.  L'envie de t√©l√©charger le corbeau au plus vite - une biblioth√®que de suivi des diverses erreurs qui se produisent sur le client, peut √©galement √™tre comprise.  Mais advertise.js et adriver.js sont d√©j√† de vrais candidats pour au moins descendre la page, et au maximum aussi en mode asynchrone.  Une histoire similaire avec gpt et √©diteur.  Oui, ils sont charg√©s de mani√®re asynchrone, mais, n√©anmoins, ils peuvent (et vont) interf√©rer avec nous lors du chargement.  Par cons√©quent, ils pourraient √©galement √™tre envoy√©s tout en bas de la page.  De plus, vous pouvez essayer d'utiliser les attributs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Resource Hints</a> - preload / prefetch / dns-prefetch pour indiquer au navigateur quoi charger √† l'avance.  Soit dit en passant, je vous conseille de lire les conseils sur les ressources - un outil tr√®s int√©ressant, bien qu'avec un support limit√© (jusqu'√† pr√©sent). </p><br><p>  Triez maintenant la liste par taille de fichier: </p><br><p><img src="https://habrastorage.org/webt/r-/om/kq/r-omkqj5qrslwffj42o5eogv_3s.png" alt="Le manteau doit √™tre rentr√© entier"><br>  https://github.com/Drag13/articles/blob/habrformance/habrformance/scripts.PNG </p><br><p>  Nous voyons un script qui se charge deux fois (pubades).  Nous remarquons √©galement que prebid.js est charg√© √† partir du dossier not-for-prod </p><br><p><img src="https://habrastorage.org/webt/4e/su/7w/4esu7wsvwdpgmbw8nscc_sqcgmo.png" alt="Dans un jus de cerise √©pais."></p><br><p>  Pour vider notre conscience, nous v√©rifions que tous les scripts sont minifi√©s.  Du coup, les scripts check-login.js et adriver.js n'ont pas √©t√© minifi√©s.  Particuli√®rement satisfait du contenu de ce dernier: </p><br><p><img src="https://habrastorage.org/webt/6q/nv/q8/6qnvq8dimcd_5m3w77mr3mkjlea.png" alt="Prenez une cape de maman cerise"></p><br><p>  Et avec des scripts, vous pouvez temporairement arr√™ter. </p><br><h3 id="stili">  Les styles </h3><br><div class="spoiler">  <b class="spoiler_title">√Ä propos des styles</b> <div class="spoiler_text"><p>  Avec les styles, tout n'est pas si simple.  Premi√®rement, le chargement synchrone des styles bloque √©galement le thread principal (bien qu'ils soient analys√©s rapidement, plus rapidement que JavaScript).  Et deuxi√®mement, tout est un peu plus compliqu√©.  Pourquoi le navigateur a-t-il besoin de CSS?  Pour construire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CSSOM</a> .  Que peut faire JavaScript avec CSS?  C'est vrai - changez.  Et que se passera-t-il si CSSOM n'est pas encore construit et que js essaie d√©j√† de changer quelque chose l√†-bas?  La r√©ponse est qui sait.  Par cons√©quent, le navigateur retarde l'ex√©cution de JavaScript jusqu'√† ce que le CSSOM soit calcul√©.  Comme correctement √©crit dans un autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article tr√®s utile</a> - pas de CSS = pas de JavaScript.  Par cons√©quent, le chargement de CSS bloque l'ex√©cution de JS. </p></div></div><br><p>  Voici les styles que Habr charge: </p><br><p><img src="https://habrastorage.org/webt/nm/6y/a7/nm6ya7qcp1bdqcp5sl2fiingrp8.png" alt="Et une tasse de lait."><br>  <a href="">Cliquable</a> </p><br><p>  Comme vous pouvez le voir, il n'y en a que trois, les deuxi√®me et troisi√®me √©tant charg√©s dans un cadre s√©par√©, nous les ignorons donc.  Mais le premier ensemble de styles est crucial pour l'ensemble du site.  Et nous l'avons t√©l√©charg√© depuis tr√®s longtemps.  Pourquoi?  Premi√®rement, ils ont attendu longtemps une r√©ponse du serveur (TTFB 570 ms, nous y reviendrons dans la troisi√®me section), et deuxi√®mement, 713 ms ont √©t√© charg√©s pendant longtemps.  Que peut-on faire ici.  La premi√®re et la plus simple consiste √† essayer d'ajouter l'attribut de pr√©charge.  Cela demandera au navigateur de commencer √† charger CSS le plus t√¥t possible.  La deuxi√®me option consiste √† mettre en √©vidence le CSS critique et √† l'int√©grer directement dans la page Web, et √† charger le reste de mani√®re synchrone (ou m√™me asynchrone).  Cela entra√Ænera une augmentation de la taille de la page (mais elle n'est d√©j√† pas petite et + 5 ko ne g√¢chera rien) et un √©ventuel redessin de la mise en page (perte de temps), mais vous pouvez essayer. </p><br><p>  Je ne montrerai m√™me pas les polices.  Il est l√† seul, bien que pour une raison quelconque, il soit charg√© directement √† partir du serveur Habr au lieu du CDN (et probablement pour une raison).  Mais je dirai merci pour le fait qu'il n'y a qu'une seule police. </p><br><p>  Sur ce point, la partie aper√ßu de l'analyse du site peut √™tre consid√©r√©e comme termin√©e.  Il est temps d'aller plus loin. </p><br><h2 id="etap-vtoroy---ruchnoy-rezhim">  Deuxi√®me √©tape - "Mode manuel" </h2><br><p>  √Ä la derni√®re √©tape, nous avons vu <em>que</em> Habr se charge.  Nous allons maintenant voir <em>comment</em> cela est rendu. </p><br><p>  Acc√©dez √† l'onglet de profilage.  Nous v√©rifions ce qu'est le ralentissement fast3g (puis r√©ex√©cutons sans restrictions) et ex√©cutons.  Tout d'abord, nous sommes int√©ress√©s par tout ce qui se passe avant l'√©v√©nement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">First contentful paint (FCP)</a> et, juste au cas o√π, DCL.  Nous s√©lectionnons la zone depuis le d√©but du chargement sur FCP et regardons le sch√©ma final. </p><br><p><img src="https://habrastorage.org/webt/1s/nb/qi/1snbqidqssgm4mxoulzysms7swu.png" alt="Versez le lait soigneusement -"></p><br><p>  Tout se passe assez rapidement - 2,161 secondes avant FCP (c'√©tait plus rapide, mais apparemment quelque chose avait chang√©), mais comme vous pouvez le voir, la plupart du temps le navigateur √©tait inactif.  La charge utile ne prenait que 14% du temps (environ 310 ms).  Id√©alement, le thread principal du navigateur s'ex√©cute en continu - l'analyse HTML, CSS, ex√©cute JS.  Et ici - rien.  Pourquoi?  Parce que le navigateur n'avait rien √† voir.  Rappelez-vous que nous avons r√©duit le trafic?  Le navigateur a envoy√© des demandes et attend maintenant qu'elles soient termin√©es.  Si nous ouvrons le diagramme des processus r√©seau (le plus haut), tout deviendra imm√©diatement clair. </p><br><p><img src="https://habrastorage.org/webt/uf/1-/gt/uf1-gt0kx7rkdpd9tzeod3hv99o.png" alt="Un spot appara√Ætra."><br>  <a href="">Cliquable</a> </p><br><p>  En 2029, le navigateur a vu main.bundle.css, a envoy√© une demande pour le recevoir et a commenc√© √† attendre.  √Ä ce moment, le pr√©scanner (smart chrome, il peut aller de l'avant) a d√©couvert qu'il y avait des scripts synchrones ci-dessous et sans attendre l'arriv√©e de CSS, il a envoy√© une demande de scripts.  Ensuite, la publicit√© et l'adriver sont charg√©s (mais nous nous souvenons que m√™me si CSSOM n'est pas cr√©√©, vous ne pouvez pas toucher JS), le navigateur les a donc ignor√©s.  Apr√®s cela, gpt et raven se sont charg√©s, mais le CSS √©tait toujours en cours de chargement, ils ont donc √©galement √©t√© ignor√©s.  Enfin, CSS a √©t√© charg√©, que le navigateur a analys√© en 12 ms et a imm√©diatement analys√© le JS int√©gr√© dans la page.  Ensuite, le navigateur s'est √† nouveau ¬´endormi¬ª √† pr√®s de 150 ms en attendant jQuery.min.js.  Et apr√®s cela, j'ai d√©j√† commenc√© √† travailler s√©rieusement - j'ai compris le jQuery charg√© (20 ms), analys√© raven.js (4 ms), analys√© presque toute la page (36 ms), racont√© les styles (28 ms), calcul√© la disposition (78 ms + 8 ms) et, enfin, pendant ~ 6 ms, nous avons peint la page.  Ici, nous avons FCP.  Ensuite, nous analysons la page, analysons les scripts - bonjour √† personne (publishertag.js, gpt.js qui est entr√© dans le thread principal avant DCL), avons jou√© un peu avec les styles (ce qui a caus√© une l√©g√®re perte de temps en raison du recalcul de la mise en page) et avons commenc√© √† attendre les fournisseurs. bundle.js.  Afin d'attendre les vendeurs, nous avons presque inactif pass√© encore 1100 ms.  Certes, en parall√®le, nous avons √©galement charg√© main.bundle.js (qui, incidemment, a d√©marr√© plus rapidement), donc tout n'est pas si mauvais.  Puis tout s'est encore bien pass√©.  Nous avons analys√© les fournisseurs, analys√© le bundle principal, analys√© Math.Jax, et finalement analys√© la page et obtenu DCL.  Certes, une sorte de gestionnaire a fonctionn√© l√†-bas, ce qui sur mon I7 a arr√™t√© le thread principal √† 80 ms (c'est-√†-dire que le site semblait geler √† 80 ms).  Maintenant, nous n'avons presque pas remarqu√© cela, mais sur un processeur faible, th√©oriquement, cela peut √™tre perceptible. Si vous voyez cela apr√®s le rendu du contenu, c'est l'occasion de v√©rifier JS. </p><br><p>  Que puis-je dire.  Encore une fois, malgr√© le fait qu'il semble assez bon.  Les principaux probl√®mes nous ont √©t√© livr√©s: </p><br><ul><li>  Un grand navigateur simple (notamment en raison du d√©s√©quilibre artificiel entre la puissance de calcul de l'ordinateur et la largeur du canal, mais c'est aussi un sc√©nario tout √† fait valable) </li><li>  Long chargement CSS qui a retard√© le travail avec js critiques </li><li>  Chargement synchrone de jQuery, des fournisseurs et des bundles principaux qui a arr√™t√© l'apparition du contenu. </li></ul><br><p>  Ce que nous pouvons faire avec cela, nous avons d√©j√† discut√©: </p><br><ul><li>  Essayez d'ajouter l'attribut de pr√©charge pour CSS et peut-√™tre certains JS </li><li>  R√©duire ou incorporer CSS </li><li>  Essayez g√©n√©ralement de jeter les scripts hors du chargement synchrone (au moins certains) </li></ul><br><p>  Maintenant, r√©p√©tons la m√™me chose sans aucune restriction sur la largeur du canal.  L'image est d√©j√† bien meilleure: 0,452 seconde en FMP, la plus simple de toutes!  13 ms.  DCL - 953 ms, simple 15 ms.  Voici √† quoi ressemble mon t√©l√©chargement de r√™ve.  C'est exactement ce qui s'est pass√© parce que j'ai ouvert un nouvel onglet et que je n'ai pas supprim√© la mise en cache.  Essayons la m√™me chose, mais sans cache: </p><br><p><img src="https://habrastorage.org/webt/g5/ji/5q/g5ji5qscsjud50jdqkoazqoxsga.png" alt="Maintenant qu'il n'y a plus de place"></p><br><p>  Tout est √©galement assez bon, FCP / FMP - 1689, charge utile 45%.  Soit dit en passant, l'ajustement de la charge √† 100% est √©galement mauvais, car les machines plus faibles seront surcharg√©es.  Il est donc pr√©f√©rable d'avoir une r√©serve pour les temps d'arr√™t.  Mais ici, de mani√®re inattendue, beaucoup de temps a √©t√© consacr√© au rendu - 400 ms pour FMP.  Parmi ceux-ci, 200 ms ont √©t√© recalcul√©s dans les styles et recalcul√©s dans la disposition. </p><br><p>  Au fait, un autre point int√©ressant.  Vous vous souvenez des scripts publicitaires - gpt.js et publishertag.js qui ont √©t√© mentionn√©s dans la premi√®re partie?  Maintenant, vous pouvez voir que malgr√© leur asynchronie, ils ont pu (quoique un peu) ruiner nos statistiques.  Cela est d√ª au fait que l'ex√©cution des scripts asynchrones se fait en fonction de l'√©tat de pr√©paration des scripts eux-m√™mes.  C'est-√†-dire  cela peut arriver √† tout moment, y compris avant FCP / DCL, ce qui s'est produit en 3309. </p><br><p>  Nous avons donc fait le d√©montage manuel.  Il est temps de d√©couvrir l'automatisation. </p><br><h2 id="etap-tretiy---s-etogo-nado-bylo-nachinat">  Troisi√®me √©tape - ¬´Nous devions partir de l√†¬ª </h2><br><div class="spoiler">  <b class="spoiler_title">√Ä propos de la ferme collective</b> <div class="spoiler_text"><p>  Je pense que tout le monde comprend que cette √©tude est tr√®s arbitraire.  Au moins, parce que tout le temps pendant que je testais de nouveaux articles apparaissaient, la charge sur le serveur et la charge sur les dorsales du r√©seau changeaient.  Dans le bon sens, vous devez d√©ployer un serveur d√©di√© dans lequel personne n'√©crira quoi que ce soit, √©mulera la charge pertinente avec des retards pertinents, puis profilera quelque chose.  Sinon, vous pouvez faire quelques hypoth√®ses, (par exemple, sur la n√©cessit√© d'ajouter un attribut de pr√©charge sur CSS), l'ajouter, le d√©ployer en production, puis il s'av√®re que la charge pendant le test a fortement augment√© et le serveur nous a donn√© le m√™me style 500 ms plus tard.  Et il s'av√®re que la pr√©charge est mauvaise - cela a simplement aggrav√© tout.  Et l'auteur est le dernier radis du tout.  En outre, le profilage manuel (comme dans la deuxi√®me partie), jusqu'√† ce que vous fuyiez tous les outils automatiques et r√©solviez les probl√®mes qui s'y trouvent, n'a √©galement aucun sens, car apr√®s vos premiers changements, l'image changera. </p><br><p>  Par cons√©quent, avant toute exp√©rience, nous avons besoin de l'environnement le plus stable.  Cette fois.  La seconde - vous ne devriez jamais aller en profondeur (par exemple, dans le profilage) d√®s le d√©but.  D√©marrez d'abord les outils automatiques, laissez-les fonctionner pour vous.  Collectez des rapports, voyez ce qui peut √™tre fait le mieux possible en un minimum de temps.  Essayez de le faire.  Si possible, vous en avez peut-√™tre d√©j√† assez.  Par exemple, votre css.bundle p√®se 100 Ko, mais en r√©alit√©, vous avez besoin de 45 Ko (√† propos, la situation r√©elle: ils ont pris tout le bootstrap, mais seule la grille √©tait n√©cessaire).  Ils ont r√©duit la taille des styles et ont gagn√© une demi-seconde pratiquement pour rien.  Ce sont deux.  V√©rifiez toujours deux fois.  Il semblerait que les styles soient en ligne, tout devrait s'am√©liorer, mais √ßa va empirer.  Pourquoi?  Et parce que dans les styles d'images 50kb base64, et notre page vient de charger 200kb de ressources.  N'oubliez pas qu'il n'y a pas de solution miracle et de scripts universels.  Ce sont trois.  Et la derni√®re, m√™me si elle contredit la phrase pr√©c√©dente.  Si vous n'avez pas de site compliqu√©, surveillez simplement TTFB (probl√®mes de serveur), la taille des ressources t√©l√©charg√©es (bonjour aux logos pour 2 Mo) et ne donnez pas acc√®s √† Google Tag Manager-personne.  Ce sera probablement assez. </p></div></div><br><p>  Nous n'irons pas loin, dans les m√™mes outils de d√©veloppement, ouvrez l'onglet d'audit et lancez LightHouse (LH) avec les param√®tres suivants: bureau, performances uniquement, pas de limitation, stockage clair.  Apr√®s avoir attendu un peu (ne quittez pas la page sur laquelle l'audit est en cours et ne faites rien de mieux) nous obtenons des chiffres fantastiques (m√™me avec le cache d√©sactiv√©) </p><br><p><img src="https://habrastorage.org/webt/cg/cu/rc/cgcurczrbd7r4xhjqrtqgw-pj5s.png" alt="Sur le manteau de ma m√®re"></p><br><p>  Il me semble m√™me qu'ils ont √©t√© sp√©cialement adapt√©s √† ces figures. </p><br><p>  Cependant, LH se plaint toujours de: </p><br><ul><li>  Format d'image obsol√®te (sugg√®re d'utiliser webp, jpeg2000, etc.) </li><li>  DOM node ‚Äì    : 2533,   1500. </li><li>    </li><li>     ‚Äî     23  </li><li>  document.write </li></ul><br><p>   .     (), DOM ‚Äî      node (-),      (  ),   document.write-  writer ( -    ) </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><p>    (       )   .    ,  ,  , .  ,   ,      .       CSS, ‚Äî      ,   ,      JavaScript. ,        ,     .                       . </p></div></div><br><p>     ,       fast3g , ,      ( I7,  celeron): </p><br><p><img src="https://habrastorage.org/webt/td/ei/3j/tdei3jxtwbcvda5csqvvmgz2tua.png" alt="   "></p><br><p>      ( FCP   3500 ms, FMP 5.7): </p><br><ul><li>   ,   . LH    next-gen  ,  ,   ,     11   </li><li>      .       adriver.js  advertise.js  50 ,     . </li><li>    CSS    ,    5kb  45kb. </li><li>      main thread.           JavaScript ‚Äî (8.5   script evaluation   2186 ms   raven.js).   ? </li></ul><br><p>     ?         .    -    .  : </p><br><ul><li>   </li><li>   DOM </li><li>   JavaScript   </li></ul><br><p>    ,        ,         (,  raven.js). </p><br><p>  ,      ,       ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">webpagetest.org</a> </p><br><p>    ‚Äî   ,  ,  .        ‚Äî     ,      .   ,    .   ,    ,   . ,       ,      ,   ‚Äî  -. </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://habr.com</a> ( ru/en ). </p><br><p><img src="https://habrastorage.org/webt/qz/hb/gn/qzhbgnvpgll4xbdlvejmvfzpndm.png" alt="   ."></p><br><p> ( ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ) </p><br><p>    .     ( )    DNS (500 ms   ),     , ssl   .   ,    1150 ms    c      (    ). ,     (    habrastorage). </p><br><p>      main.bundle.css. ,     dr.habracdn.net ,     dns lookup ‚Äî 36 ms (     400 ms).  SSL negotiation 606 ms,  TTFB 601 ms,   .    .       DCL ‚Äî 4100 ms   ,   . </p><br><p>     image analysis , ,        .  -      PNG  1.4,   webp + downscaling ( ,   ) ‚Äî 17.7 KB.  ,       ,     png  154.          . ,  : </p><br><ul><li>         (   ,        , ..    ). </li><li>   .   ,    . </li><li>  TTFB (webpagetest    F  ) ‚Äî     </li><li>       ,       (         ) </li></ul><br><h2 id="vyvody">  Conclusions </h2><br><p>      .     : </p><br><p>  : </p><br><ul><li>  TTFB   500 ms      ( <strong></strong> dns, ssl  initial connection) </li><li>  habrastorage </li></ul><br><p>  : </p><br><ul><li>    </li><li>   DOM-a </li><li>       </li></ul><br><p>  , ,      .      ,     ,    . ,   SPA,       ,    JS   ‚Äî    .     .       //,           </p><br><h2 id="poleznye-ssylki">  Liens utiles </h2><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Webpagetest</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  webpagetest</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   1</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   2</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> FCP</a> </li></ul><br><p>  PS.       (  )   .      ,    .1, .2, .3    . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr454444/">https://habr.com/ru/post/fr454444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr454432/index.html">Arch√©ologie divertissante: le guide de style R sous la loupe</a></li>
<li><a href="../fr454434/index.html">PDA (Pocket Travel Computer): Enregistreur de circuits GPS</a></li>
<li><a href="../fr454436/index.html">Petty Petty Joy # 1: loguru</a></li>
<li><a href="../fr454440/index.html">Petty Little Fun # 2: Starlette</a></li>
<li><a href="../fr454442/index.html">Comment choisir un r√©seau proxy pour votre entreprise: 3 conseils pratiques</a></li>
<li><a href="../fr454446/index.html">Quoi de neuf en C # 8?</a></li>
<li><a href="../fr454450/index.html">Comment Edison a invent√© le sans fil et n'a rien compris</a></li>
<li><a href="../fr454452/index.html">Nous affichons le contenu sur l'image reconnue selon certaines r√®gles</a></li>
<li><a href="../fr454456/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 7. FAQ</a></li>
<li><a href="../fr454458/index.html">Tests m√©tamorphiques: pourquoi presque personne ne conna√Æt cette technique prometteuse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>