<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèª ü§∂üèΩ üèáüèæ Comment √©crire une extension pour GNOME Shell: mode Ne pas d√©ranger ü§üüèø üíÜüèø üíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tout a commenc√© avec le passage √† une nouvelle version d'une distribution Linux, et l√† - le fameux GNOME Shell (GH pour faire court), en Javascript. B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment √©crire une extension pour GNOME Shell: mode Ne pas d√©ranger</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428187/"><p>  Tout a commenc√© avec le passage √† une nouvelle version d'une distribution Linux, et l√† - le <em>fameux</em> GNOME Shell (GH pour faire court), en Javascript.  Bon, ok, sur JS donc sur JS, √ßa marche - et ok. </p><br><p> Dans le m√™me temps, le rythme de mon travail a longtemps exig√© de trouver un exp√©diteur normal, au lieu des tonnes de m√©gaoctets de freinage et de m√©gaoctets de l'onglet <code>outlook.office.com</code> dans le navigateur.  Et maintenant, j'ai trouv√©, √† notre √©poque, plusieurs candidats presque excellents, un probl√®me - l'exp√©diteur a commenc√© √† me recevoir des notifications de nouvelles lettres - et des inscriptions sonores et pop-up. </p><br><p>  Que faire  La d√©cision d'√©crire l'extension Do Not Disturb n'est pas venue tout de suite, je ne voulais vraiment pas √©crire un v√©lo et / ou m'enliser dans le d√©veloppement / code / tonnes d'erreurs, mais j'ai d√©cid√©, et maintenant je veux partager mon exp√©rience avec Habr.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1</a></sup> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/737/175/2b5/7371752b5fb33b8858bff75857fbfa83.jpg"></p><a name="habracut"></a><br><h2 id="tehnicheskie-trebovaniya">  Exigences techniques </h2><br><p>  Je veux avoir <del>  un gros </del>  bouton pour d√©sactiver les notifications et les sons pour l'heure de votre choix: 20 minutes, 40 minutes, 1 heure, 2 heures, 4, 8 et 24 heures.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2</a></sup> Ouais, le timing comme dans Slack. </p><br><p>  Sur les extensions d'extensions.gnome.org, il y avait une extension "Do Not Disturb Button", qui a servi de mod√®le pour √©crire son extension <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Do Not Disturb Time</a> . </p><br><h2 id="konechnyy-rezultat-do-not-disturb-timehttpsextensionsgnomeorgextension1484do-not-disturb-time">  R√©sultat final: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ne pas d√©ranger le temps</a> </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/104/41d/479/10441d479062c7540a2743c6fb0b852d.png" alt="Ne d√©rangez pas le temps"></p><br><p>  Installez depuis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">extensions.gnome.org</a> . <br>  Sources sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> : mettre des √©toiles, fork, proposer des am√©liorations. </p><br><h3 id="kak-ustanovit-rasshirenie-gh-instrukciya">  Comment installer l'extension GH: instructions </h3><br><ol><li>  Installez le package <em>chrome-gnome-shell</em> , un connecteur de navigateur, en utilisant Ubuntu comme exemple: <br> <code>sudo apt install chrome-gnome-shell</code> </li> <li>  √Ä l'aide du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien,</a> installez l'extension du navigateur: <br><ul><li>  suivez le lien <em>Cliquez ici pour installer l'extension du navigateur</em> </li><li>  dans Ubuntu 18.04, cela a fonctionn√© pour moi dans le navigateur Chrome / Chromium, dans Fedora 28/29 - √† la fois dans Firefox et dans Chromium </li></ul></li><li>  Nous recherchons l'extension souhait√©e dans la liste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://extensions.gnome.org</a> : activer, d√©sactiver, modifier les param√®tres d'extension. </li><li>  PROFIT! </li></ol><br><h2 id="nachalo">  Commencer </h2><br><p>  Cr√©ez une extension √† partir de z√©ro: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> gnome<span class="hljs-literal"><span class="hljs-literal">-shell</span></span><span class="hljs-literal"><span class="hljs-literal">-extension</span></span><span class="hljs-literal"><span class="hljs-literal">-tool</span></span> -<span class="hljs-literal"><span class="hljs-literal">-create</span></span><span class="hljs-literal"><span class="hljs-literal">-extension</span></span> Name: <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> Not Disturb Time Description: Disables notifications and sound <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a period Uuid: dnd@catbo.net Created extension <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'~/.local/share/gnome-shell/extensions/dnd@catbo.net'</span></span> <span class="hljs-comment"><span class="hljs-comment">#  gnome-shell Alt+F2, r, Enter #    https://extensions.gnome.org/local/      #   Gnome Shell - , gnome-shell   systemd,   journalctl -f /usr/bin/gnome-shell #    ,       gnome-shell journalctl -f /usr/bin/gnome-shell | grep -E 'dnd|$'</span></span></code> </pre> <br><p>  Le fichier <code>extension.js</code> dans le r√©pertoire correspondant est le point d'entr√©e de notre application, dans une version minimale il ressemble √† ceci: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{} <span class="hljs-comment"><span class="hljs-comment">//   ;    function disable() {} // --||-- ;     enable()</span></span></code> </pre> <br><h3 id="pervyy-kod">  Premier code </h3><br><p>  Tout d'abord, nous voulons ajouter un bouton au <code>Status Menu</code> haut √† droite, comme dans la capture d'√©cran ci-dessus. </p><br><p>  Alors par o√π commencer?  Oh, commen√ßons par la documentation.  Nous avons une documentation officielle, toutes choses.  Mais non, la documentation officielle est tr√®s petite et fragment√©e, mais gr√¢ce √† <code>julio641742</code> et √† sa documentation non officielle, nous obtenons ce dont nous avons besoin: </p><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">// 1 -    (1 - , 0 - , 0.5 -  ) // true,     let dndButton = new PanelMenu.Button(1, "DoNotDisturb", false); // `right` -      (left/center/right) Main.panel.addToStatusArea("DoNotDisturbRole", dndButton, 0, "right"); let box = new St.BoxLayout(); dndButton.actor.add_child(box); let icon = new St.Icon({ style_class: "system-status-icon" }); icon.set_gicon(Gio.icon_new_for_string("/tmp/bell_normal.svg")); box.add(icon);</span></span></code> </pre> <br><p>  Ce code cr√©e l'objet cl√© <code>dndButton</code> de la classe <code>dndButton</code> - il s'agit d'un bouton sp√©cialement con√ßu pour le panneau Menu d'√©tat.  Et nous l'ins√©rons dans ce panneau √† l'aide de la fonction Main.panel.addToStatusArea ().  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3</a></sup> </p><br><p>  Ins√©rez des √©l√©ments de menu avec des gestionnaires boulonn√©s, par exemple: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> menuItem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PopupMenu.PopupMenuItem(<span class="hljs-string"><span class="hljs-string">"hello, world!"</span></span>); menuItem.connect(<span class="hljs-string"><span class="hljs-string">"activate"</span></span>, (menuItem, event) =&gt; { log(<span class="hljs-string"><span class="hljs-string">"hello, world!"</span></span>); }); dndButton.menu.addMenuItem(menuItem);</code> </pre> <br><p>  Merci julio641742 pour la documentation!  Lien: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/julio641742/gnome-shell-extension-reference</a> </p><br><p>  Le code de travail final est <a href="">ici</a> . </p><br><h2 id="osobennosti-raboty-gnome-shell-i-javascript">  Fonctions GNOME Shell et Javascript </h2><br><p>  Outside est la fin de 2018, et Node.js / V8 est le principal outil pour ex√©cuter du code Javascript.  Tout d√©veloppement Web moderne repose sur un ¬´n≈ìud¬ª. </p><br><p>  Mais le shell GNOME et toute l'infrastructure qui l'entoure utilisent un moteur Javascript diff√©rent, le SpiderMonkey de Mozilla, et cela apporte beaucoup de diff√©rences de performances importantes. </p><br><h3 id="import-moduley">  Importer des modules </h3><br><p>  Contrairement √† Node.js, il n'y a pas de require () ici, et aucune importation ES6 sophistiqu√©e non plus.  Au lieu de cela, il existe un objet sp√©cial d'importation, dont l'acc√®s aux attributs conduit au chargement du module: </p><br><pre> <code class="hljs julia"> //<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PanelMenu = require(<span class="hljs-string"><span class="hljs-string">"ui/panelMenu"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PanelMenu = imports.ui.panelMenu;</code> </pre> <br><p>  Dans ce cas, nous avons t√©l√©charg√© le module js / ui / panelMenu.js √† partir de la biblioth√®que de packages GNOME Shell, qui impl√©mente la fonctionnalit√© d'un bouton avec un menu contextuel. </p><br><p>  Oui, tous les boutons du panneau d'un bureau Linux moderne utilisant GNOME sont bas√©s sur panelMenu.js.  Comprenant: le m√™me bouton droit avec indicateurs de batterie, Wi-Fi, volume sonore;  commutateur de langue d'entr√©e en-ru. </p><br><p>  Ensuite, il y a un attribut sp√©cial <code>imports.searchPath</code> - c'est une liste de chemins (lignes) o√π nos modules JS seront recherch√©s.  Par exemple, nous avons allou√© une fonction de temporisation √† un module timeUtils.js distinct et l'avons plac√©e pr√®s du point d'entr√©e de notre extension, extension.js.  Importez timeUtils.js comme suit: </p><br><pre> <code class="hljs pgsql">//     , -  ~/.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/gnome-shell/extensions/&lt;your-<span class="hljs-keyword"><span class="hljs-keyword">extension</span></span>&gt;/ const Me = imports.misc.extensionUtils.getCurrentExtension(); //       imports.searchPath.unshift(Me.path); //   const timeUtils = imports.timeUtils;</code> </pre> <br><h3 id="logirovanie-otladka-javascript">  Journalisation, d√©bogage Javascript </h3><br><p>  Eh bien, puisque nous n'avons pas Node.js, nous avons notre propre journalisation.  Au lieu de console.log (), plusieurs fonctions de journalisation sont disponibles dans le code, voir gjs /../ global.cpp, static_funcs: </p><br><ul><li>  "log" = g_message ("JS LOG:" + message) - connexion dans stderr, exemple: </li></ul><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat helloWorld.js log(<span class="hljs-string"><span class="hljs-string">"hello, world"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$</span></span> gjs helloWorld.js Gjs<span class="hljs-literal"><span class="hljs-literal">-Message</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">21.048</span></span>: JS LOG: hello, world</code> </pre> <br><ul><li>  "logError" - enregistre la pile d'exceptions: <br><ul><li>  le premier argument requis est une exception, puis une virgule s√©pare ce que vous voulez </li><li>  exemple, si vous devez imprimer la pile au bon endroit: </li></ul></li></ul><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'bum!'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { logError(e, <span class="hljs-string"><span class="hljs-string">"what a fuck"</span></span>); }</code> </pre> <br><p>  et cela attirera stderr avec style: </p><br><pre> <code class="hljs powershell">(gjs:<span class="hljs-number"><span class="hljs-number">28674</span></span>): Gjs<span class="hljs-literal"><span class="hljs-literal">-WARNING</span></span> **: <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">46.951</span></span>: JS ERROR: what a fuck: Error: bum! ggg<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> ddd<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><ul><li>  "print" = g_print ("% s \ n", txt);  - uniquement du texte + "\ n" dans stdout, sans pr√©fixe ni coloration, contrairement √† log () </li><li>  "printerr" = g_printerr ("% s \ n", txt) - la diff√©rence par rapport √† l'impression est que dans stderr </li></ul><br><p>  Mais il n'y a pas de d√©bogueur pour SpiderMonkey pr√™t √† l'emploi (ce n'est pas en vain que j'ai minutieusement √©crit par dessus tous les outils disponibles pour la journalisation, utilisez-le!).  Si vous le souhaitez, vous pouvez essayer JSRDbg: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deux</a> . </p><br><h2 id="a-est-li-zhizn-dlya-js-koda-vne-gnome-shell">  Y a-t-il de la vie pour le code JS en dehors de GNOME Shell? </h2><br><p>  Il y en a.  Des applications compl√®tes, y compris une interface utilisateur graphique (GUI), peuvent √™tre √©crites en Javascript!  Vous devez les ex√©cuter en utilisant le binar gjs, le lanceur de code JS-GTK, un exemple de cr√©ation d'une fen√™tre GUI: </p><br><pre> <code class="hljs vala">$ which gjs /usr/bin/gjs $ dpkg --search /usr/bin/gjs gjs: /usr/bin/gjs $ cat gtk.js <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span> = imports.gi.<span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.init(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); let win = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.Window(); win.connect(<span class="hljs-string"><span class="hljs-string">"delete-event"</span></span>, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.main_quit(); }); win.show_all(); <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.main(); $ gjs gtk.js</code> </pre> <br><p>  Ci-dessus, j'ai mentionn√© la division du code en modules et leur chargement √† partir de Javascript.  La question se pose, mais comment dans le module lui-m√™me d√©terminer s'il est lanc√© en tant que module "principal", ou charg√© √† partir d'un autre module? </p><br><p>  Python a une construction authentique: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: main()</code> </pre> <br><p>  Dans Node.js - de m√™me: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.main === <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>) { main(); }</code> </pre> <br><p>  Je n'ai pas trouv√© de r√©ponse officielle √† cette question pour Gjs / GH, mais j'ai trouv√© une telle technique que je m'empresse de partager avec le lecteur (pourquoi quelqu'un a-t-il lu ¬´dosyudova¬ª? Respect!). </p><br><p>  Donc, l'astuce est bas√©e sur l'analyse de la pile d'appels actuelle, si elle se compose de 2 lignes ou plus, alors nous ne sommes pas dans le module main (): </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>().stack.split(<span class="hljs-regexp"><span class="hljs-regexp">/\r\n|\r|\n/g</span></span>).filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">line</span></span></span><span class="hljs-function"> =&gt;</span></span> line.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) .length == <span class="hljs-number"><span class="hljs-number">1</span></span> ) { main(); }</code> </pre> <br><h2 id="uborka-za-soboy">  M√©nage </h2><br><p>  Chaque extension du shell GNOME a acc√®s √† tous les objets de l'ensemble du shell GNOME.  Par exemple, pour afficher le nombre de notifications encore non lues, nous arrivons au conteneur avec elles dans la <code>Notification Area</code> , situ√©e au centre ci-dessus, num√©ro 4 dans l'image (cliquez sur l'inscription avec l'heure actuelle, elle est cliquable dans la vraie vie, pas ici): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/91e/eec/acc/91eeecaccdc67202335ce4d51d8d90d3.png" alt="Ne d√©rangez pas le temps"></p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> unseenlist = Main.panel.statusArea.dateMenu._messageList._notificationSection._list;</code> </pre> <br><p>  Vous pouvez conna√Ætre le nombre de notifications non lues, vous abonner aux √©v√©nements d'ajout et de suppression de notifications: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> number = unseenlist.get_n_children(); unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-added"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"added!"</span></span>); }); unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-removed"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"removed!"</span></span>); });</code> </pre> <br><p>  C'est tr√®s bien, mais l'utilisateur peut parfois d√©cider qu'il n'a plus besoin de l'extension X et clique sur le bouton pour d√©sactiver l'extension.  Pour une extension, cela √©quivaut √† appeler la fonction disable (), et tous les efforts doivent √™tre faits pour que l'extension d√©sactiv√©e ne casse pas la GH active: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dndButton.destroy(); }</code> </pre> <br><p>  Dans ce cas, en plus de supprimer le bouton lui-m√™me, vous devez vous d√©sinscrire des √©v√©nements "acteur ajout√©" / "acteur supprim√©", par exemple: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> signal = unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-added"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"added!"</span></span>); }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dndButton.destroy(); unseenlist.disconnect(signal); }</code> </pre> <br><p>  Si cela n'est pas fait, alors le code des gestionnaires continuera √† √™tre appel√© sur l'√©v√©nement correspondant, essayez de mettre √† jour l'√©tat du bouton de menu qui n'existe pas d√©j√† et ... GNOME Shell commencera √† √©chouer.  Eh bien, oui, nous le ferons, les utilisateurs jureront, les pierres voleront aux d√©veloppeurs de GNOME Shell et GNOME en g√©n√©ral.  La vraie image, Th. </p><br><p>  Donc, GNOME Shell / Gjs est une symbiose de deux syst√®mes, Glib / GTK et Javascript, et ils ont une approche diff√©rente de la gestion des ressources.  Glib / GTK n√©cessite la lib√©ration explicite de ses ressources (boutons, minuteries, etc.).  Si l'objet a √©t√© cr√©√© par le moteur Javascript, alors nous agissons comme d'habitude (ne lib√©rons rien). </p><br><p>  Par cons√©quent, d√®s que notre extension est pr√™te et ne "coule" pas, vous pouvez la publier en toute s√©curit√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://extensions.gnome.org</a> . </p><br><h2 id="rezhim-gnomesessionpresencestatusbusy-i-dbus">  Mode GnomeSession.PresenceStatus.BUSY et DBus. </h2><br><p>  Si vous ne l'avez pas oubli√©, nous faisons l'extension "Ne pas d√©ranger", qui d√©sactive l'affichage des notifications √† l'utilisateur. </p><br><p>  GNOME a d√©j√† un drapeau responsable de cet √©tat.  Apr√®s la connexion de l'utilisateur, le processus gnome-session est cr√©√©, dans lequel se trouve cet indicateur: il s'agit de l'attribut GsmPresencePrivate.status, voir les sources de gnome-session, gnome-session / gsm-presence.c.  Nous avons acc√®s √† cet indicateur via l'interface DBus (telle la communication interprocessus). </p><br><p>  Non seulement nous, mais GH lui-m√™me a besoin d'informations sur ce drapeau afin de ne pas afficher de notifications.  C'est assez facile √† trouver dans la source GH: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._presence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GnomeSession.Presence(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">proxy, error</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onStatusChanged(proxy.status); }); ... this._presence.connectSignal(<span class="hljs-string"><span class="hljs-string">'StatusChanged'</span></span>, (proxy, senderName, [status]) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onStatusChanged(status); });</code> </pre> <br><p>  Dans ce cas, la m√©thode _onStatusChanged est un gestionnaire qui r√©pond √† un changement d'√©tat.  Nous copions ce code pour nous-m√™mes, nous l'adaptons - nous avons compris <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">4</a></sup> notifications, il y avait un son. </p><br><h2 id="vyklyuchenievklyuchenie-zvuka">  Activer / d√©sactiver le son </h2><br><p>  La plupart des bureaux Linux modernes sont contr√¥l√©s par PulseAudio, <del>  travail notoire </del>  auteur du programme du c√©l√®bre Lennart Poettering.  Jusqu'√† pr√©sent, je n'ai pas r√©ussi √† √©crire du code PulseAudio, et j'√©tais heureux d'avoir l'opportunit√© de comprendre PulseAudio √† un certain niveau. </p><br><p>  En cons√©quence, il s'est av√©r√© que pour <code>pactl</code> / d√©sactiver le son, un utilitaire <code>pactl</code> , ou plut√¥t trois commandes bas√©es sur celui-ci: </p><br><ul><li>  "pactl info": d√©couvrez le r√©cepteur par <code>default sink</code> - quelle sortie sonore, s'il y en a plusieurs, est le son par d√©faut </li><li>  "pactl list sinks": d√©couvrez l'√©tat muet / unmute du p√©riph√©rique correspondant </li><li>  "pactl set-sink-mute% (defaultSink) s% (isMute) s": pour activer / d√©sactiver le son lui-m√™me </li></ul><br><p>  Notre t√¢che consiste donc √† ex√©cuter des commandes / processus, √† lire leur sortie standard et √† rechercher r√©guli√®rement les valeurs souhait√©es.  Bref, une t√¢che standard. </p><br><p>  Chez GNOME, la biblioth√®que de base glib est responsable de la cr√©ation de processus, et il existe une excellente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> √† ce sujet.  Et bien s√ªr, elle est en C. Et nous avons JS.  Il est connu que le package Gjs a cr√©√© une couche intelligente et "intuitive" entre la C-API et Javascript.  Mais vous comprenez toujours que vous avez besoin d'exemples et vous ne pouvez pas vous passer de googler. </p><br><p>  En cons√©quence, gr√¢ce √† l'excellent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contenu,</a> nous obtenons un code de travail: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> resList = GLib.spawn_command_line_sync(cmd); <span class="hljs-comment"><span class="hljs-comment">// res = true/false, /   // status = int,    // out/err = ,  stdout/stderr  let [res, out, err, status] = resList; if (res != true || status != 0) { print("not ok!"); } else { // do something useful }</span></span></code> </pre> <br><h2 id="sohranenie-nastroek-v-reestre">  Enregistrement des param√®tres <del>  dans le registre </del></h2><br><p>  Non, bien s√ªr, il n'y a pas de registre sous Linux.  Ici, vous n'√™tes pas Windows.  Il y en a une meilleure, appel√©e GSettings (c'est l'API), plusieurs options d'impl√©mentation sont cach√©es derri√®re, par d√©faut GNOME utilise Dconf.  Voici √† quoi ressemble le framework GUI: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0fe/03c/eca/0fe03ceca6c7fc9338377fc5d0909024.png" alt="dconf-editor"></p><br><p>  - Quoi de mieux que de stocker des param√®tres dans des fichiers en texte brut?  - Demandez aux utilisateurs Linux vieux et barbus.  La principale caract√©ristique de GSettings est que vous pouvez facilement vous abonner aux modifications des param√®tres, par exemple: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Gio = imports.gi.Gio; settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gio.Settings({ <span class="hljs-attr"><span class="hljs-attr">settings_schema</span></span>: schemaObj }); settings.connect(<span class="hljs-string"><span class="hljs-string">"changed::mute-audio"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log(<span class="hljs-string"><span class="hljs-string">"I see, you changed it!"</span></span>); });</code> </pre> <br><p>  Le seul r√©glage jusqu'√† pr√©sent dans notre "Ne pas d√©ranger" est l'option "muet-audio", qui permet √† l'utilisateur de couper le son ou non pendant la dur√©e de "l'heure calme" √† la demande de l'utilisateur. </p><br><h2 id="i-nemnogo-klassiki-gui-na-gtk">  Et un peu classique, GTK GUI </h2><br><p>  Afin de montrer magnifiquement √† l'utilisateur les param√®tres de notre extension (et de ne pas entrer dans le registre avec des pattes sales), GH nous propose d'√©crire un code GUI et de le mettre dans la fonction buildPrefsWidget () du fichier prefs.js.  Dans ce cas, en face de notre extension dans la liste des "Extensions install√©es" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> nous verrons un bouton suppl√©mentaire "Configurer cette extension", en cliquant sur lequel notre beaut√© appara√Ætra. </p><br><p>  Cr√©ons un onglet √Ä propos s√©par√©, car il est connu que sans Ebout, d√©sol√©, le programme n'est pas termin√©. </p><br><p>  De mani√®re g√©n√©rale, pour construire une interface graphique classique, GTK a toute une gamme de blocs de construction, des <code></code> , dont vous pouvez v√©rifier la quantit√© et la qualit√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Nous n'en utiliserons que quelques-uns: </p><br><ul><li>  Gtk.Notebook est un onglet, comme dans un navigateur </li><li>  Gtk.VBox est un conteneur pour structurer verticalement une liste de widgets </li><li>  Gtk.Label est un √©l√©ment de base, une inscription, avec la possibilit√© de formater HTML </li></ul><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildPrefsWidget</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    Gtk.Notebook    GUI let notebook = new Gtk.Notebook(); ... //  About,    VBox c   10 , //   margin/padding   let aboutBox = new Gtk.VBox({ border_width: 10 }); //     About notebook.append_page( aboutBox, new Gtk.Label({label: "About"}), ); //        , //      ,    (expand) aboutBox.pack_start( new Gtk.Label({ label: "&lt;b&gt;Do Not Disturb Time&lt;/b&gt;", use_markup: true, }), true, // expand true, // fill 0, ); ... notebook.show_all(); return notebook; }</span></span></code> </pre> <br><p>  Capture d'√©cran finale: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f87/554/787/f8755478763d159cbb9dfc1518881e60.png"></p><br><h2 id="dopolnitelno">  En option </h2><br><div class="spoiler">  <b class="spoiler_title">1. Modes de fonctionnement: support et fonctionnement</b> <div class="spoiler_text"><p>  Le travail du programmeur implique 2 modes dans mon cas: <br>  1) en mode support, lorsque vous devez r√©pondre rapidement √† des √©v√©nements - mail, Slack, Skype et plus <br>  2) en mode de fonctionnement, lorsqu'il est essentiel de r√©duire les notifications pendant au moins 20 minutes, sinon la concentration est perdue et la productivit√© finale du travail est n√©gligeable.  Pour cela, le mode Ne pas d√©ranger est utile. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">2. Comment d√©sactiver le son</b> <div class="spoiler_text"><p>  Il peut sembler qu'un muet complet, muet, c'est trop.  En effet, en fait, id√©alement, vous aimeriez que Slack / Skype soit entendu en mode Ne pas d√©ranger, mais le reste des sons (notifications r√©elles) ne le sont pas.  Mais pour cela, ils doivent √™tre distingu√©s d'une mani√®re ou d'une autre.  Vous pouvez bien s√ªr cr√©er une API sonore sp√©cifiquement pour les notifications (et cela existe d√©j√†), seulement il y a toujours un programme / programmeur qui n'utilise pas une telle fonctionnalit√©.  Un exemple est le mailer Mailspring: il lit simplement les sons via la balise <code>audio</code> , et ils ne peuvent √™tre distingu√©s en aucune fa√ßon, par exemple, de la parole dans un appel Slack. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">3. PanelMenu.Button</b> <div class="spoiler_text"><p>  PanelMenu.Button - c'est le bouton r√©el dans le menu panneau + pop-up, et vous pouvez le d√©couvrir vous-m√™me et le cr√©er √† partir de z√©ro, les deux seront appr√©ci√©s par les <em>gars de la plaie</em> !  Je visais un r√©sultat rapide et j'ai donc copi√© le code de la documentation non officielle. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">4. SetStatusRemote ()</b> <div class="spoiler_text"><p>  Initialisez r√©ellement un changement de mode √† l'aide de SetStatusRemote (). </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428187/">https://habr.com/ru/post/fr428187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428175/index.html">Impl√©mentation de l'arbre C de pr√©fixe C</a></li>
<li><a href="../fr428177/index.html">Alors, quel est le probl√®me avec la recherche d'emploi / les travailleurs en informatique?</a></li>
<li><a href="../fr428179/index.html">Lors d'une vente aux ench√®res japonaise, un prototype de manette Wii, d√©velopp√© pour le GameCube</a></li>
<li><a href="../fr428181/index.html">Machine morale: impitoyable ou vide de sens?</a></li>
<li><a href="../fr428183/index.html">Impl√©mentation de l'algorithme de Levenberg-Marquardt pour l'optimisation des r√©seaux de neurones sur TensorFlow</a></li>
<li><a href="../fr428189/index.html">Qu'est-ce qu'un paladin?</a></li>
<li><a href="../fr428191/index.html">Que devrions-nous organiser un hackathon, ou comment nous avons men√© un hackathon interne</a></li>
<li><a href="../fr428193/index.html">√Ä propos des tourn√©es</a></li>
<li><a href="../fr428197/index.html">Finances personnelles efficaces. Niveau 1</a></li>
<li><a href="../fr428201/index.html">Trous de taupe en JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>