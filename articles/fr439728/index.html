<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüëß‚Äçüëß ‚ò∫Ô∏è üçú Configurer la sauvegarde et la restauration Zimbra OSE compl√®tes et s√©par√©es sans utiliser Zextras ‚õ©Ô∏è üöò üíΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Par o√π commencer 
 O√π commence la sauvegarde? Planification. Lorsque vous sauvegardez un syst√®me, vous devez faire un plan de sauvegarde: quoi exac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configurer la sauvegarde et la restauration Zimbra OSE compl√®tes et s√©par√©es sans utiliser Zextras</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439728/"><img src="https://habrastorage.org/webt/tl/fg/oj/tlfgoj8_4wwdpcdcj5n8ndx2pu0.png" alt="image"><br><br><h3>  1. Par o√π commencer </h3><br>  O√π commence la sauvegarde?  Planification.  Lorsque vous sauvegardez un syst√®me, vous devez faire un plan de sauvegarde: quoi exactement, √† quelle fr√©quence, combien de temps pour stocker, y aura-t-il suffisamment d'espace libre?  √Ä partir des r√©ponses √† ces questions, la r√©ponse √† la question principale suit - comment sauvegarder? <br><br>  S'il y a beaucoup d'espace libre, vous pouvez stocker l'int√©gralit√© de la machine virtuelle.  Faites des sauvegardes avec le m√™me Veeam sur un calendrier, et ne pensez pas aux difficult√©s.  Mais pour moi, c‚Äôest du gaspillage, j‚Äôai l‚Äôhabitude de tout faire de la mani√®re la plus concise et la plus √©conomique possible.  Bien s√ªr, j'ai d√©ploy√© Veeam, mais je ne fais que des copies de sauvegarde des syst√®mes qui sont impossibles ou probl√©matiques √† d√©ployer √† partir de sauvegardes pendant tr√®s longtemps. <br><br>  √Ä propos des scripts des outils de gestion de l'environnement virtuel, je garderai simplement le silence de mani√®re significative. <br><br>  Zimbra dispose d'un outil zmmailbox.  Et, en examinant de plus pr√®s sa fonctionnalit√©, j'ai r√©alis√© que ce serait plus que suffisant pour moi.  Il peut sauvegarder et restaurer des bo√Ætes aux lettres m√™me sur un syst√®me actif.  Et j'ai aim√© la possibilit√© de sauvegarder les bo√Ætes aux lettres critiques s√©par√©ment de la sauvegarde de l'ensemble du syst√®me.  Ainsi, l'espace occup√© par les sauvegardes sera limit√© par la taille des bo√Ætes aux lettres archiv√©es multipli√©e par le nombre de jours de ¬´profondeur de sauvegarde¬ª, et non par le volume de l'ensemble du syst√®me multipli√© par le m√™me nombre de jours.  De plus, il est extr√™mement difficile de r√©cup√©rer √† partir d'une sauvegarde de l'ensemble du syst√®me, dans le cas de Zimbra.  Il est beaucoup plus facile de copier une machine virtuelle √† l'aide de Veeam ou des outils de gestion d'environnement virtuel (Hyper-V, ESXI, entrez celui souhait√©) juste apr√®s la configuration du syst√®me, et de le mettre ¬´sur l'√©tag√®re¬ª afin qu'√† un moment critique, vous puissiez rapidement d√©ployer des machines virtuelles presque sans poids et t√©l√©charger en elle des sauvegardes de bo√Ætes.  √Ä mon avis, c'est le sc√©nario le moins cher √† tous √©gards. <br><a name="habracut"></a><br><h3>  2. Les donn√©es source: </h3><br>  <i>Syst√®me d'exploitation du serveur</i> : CentOS 7 <br><br><div class="spoiler">  <b class="spoiler_title">√Ä propos de l'OS</b> <div class="spoiler_text">  En fait, la diff√©rence entre CentOS7 et tout autre syst√®me r√©side uniquement dans les commandes au serveur pour installer les packages et, √©ventuellement, l'emplacement de certains fichiers.  Le travail est effectu√© principalement avec des applets de commande Zimbra, de sorte que les diff√©rences de configuration seront minimes. </div></div><br>  <i>Domaine Zimbra</i> : zimbramail.home.local <br>  <i>Nom d'utilisateur et mot de passe pour acc√©der au dossier partag√©</i> : ZimbraBackUp / 123123 <br>  <i>Chemin d'acc√®s au dossier partag√©</i> : \\ BackUpServer1 \ ZM \ <br>  <i>Le chemin pour monter les boules sur l'h√¥te Zimbra</i> : / mnt / ZM / <br><br><h3>  3. Configuration </h3><br>  Commen√ßons donc! <br><br>  Nous allons √©crire des sauvegardes sur un serveur ex√©cutant Windows dans un dossier partag√©.  Si vous le souhaitez, vous pouvez fusionner les sauvegardes n'importe o√π, mais tout est configur√© pour que la plupart des sauvegardes soient √©crites dans BackUpServer1.home.local.  Alors que: <br><br>  1) Nous cr√©ons dans le domaine utilisateur pour acc√©der au dossier partag√© sur ce serveur afin qu'il puisse √™tre mont√© sur le serveur Zimbramail.home.local.  Nom d'utilisateur ZimbraBackUp, mot de passe, conditionnellement, 123123. <br><br>  2) Sur le serveur BackUpServer1, cr√©ez le r√©pertoire \ ZM \ dans le r√©f√©rentiel et partagez-le, en donnant des droits de modification √† l'utilisateur ZimbraBackUp.  Le chemin vers la balle sera: \\ BackUpServer1 \ ZM \ <br><br>  3) Montez la balle sur le serveur Zimbramail.home.local.  Pour que le dossier soit mont√© automatiquement, vous devez corriger le fichier / etc / fstab en y ajoutant la ligne: <br><br><pre><code class="bash hljs">//BackUpServer/ZM /mnt/ZM cifs user,uid=500,rw,suid,username=ZimbraBackUp,password=123123 0 0</code> </pre> <br>  Mais vous devez d'abord v√©rifier si le support fonctionne: <br><br><pre> <code class="bash hljs">$ mount -t cifs //BackUpServer/ZM /mnt/ZM -o user=ZimbraBackUp,password=123123</code> </pre> <br>  Souvent, une erreur comme celle-ci appara√Æt: <br><br><pre> <code class="bash hljs">mount: wrong fs <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, bad option, bad superblock on //BackUpServer1/ZM/, missing codepage or helper program, or other error (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> several filesystems (eg nfs, cifs) you might need a /sbin/mount.&lt;<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>&gt; helper program) In some cases useful info is found <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> syslog - try dmesg | tail or so.</code> </pre> <br>  Vous pouvez le corriger en installant cifs-utils: <br><br><pre> <code class="bash hljs">$ yum install cifs-utils</code> </pre> <br>  Apr√®s la configuration, je recommande de red√©marrer le serveur. <br><br>  4) Cr√©ez 3 fichiers de script: FullBackUp.sh HandBackUp.sh Restore.sh <br><br>  Le premier fichier sera utilis√© pour cr√©er automatiquement des sauvegardes planifi√©es, le second pour la possibilit√© de sauvegarder des bo√Ætes aux lettres individuelles, ou simplement de d√©marrer manuellement ¬´et si¬ª.  Et le troisi√®me script est la restauration d'une ou de toutes les bo√Ætes √† la fois.  J'ai essay√© de commenter autant que possible les scripts et prescrit la journalisation. <br><br><div class="spoiler">  <b class="spoiler_title">Le contenu du fichier FullBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #    MPath="/mnt/ZM/Mounthly" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   MDay=$(date +%d) #   log="/mnt/ZM/BackUpLog.txt" echo -en "BackUp ALL MailBoxes started in $(date +%T)\n" &gt;&gt; $log #       if [ ! -d $Path ]; then #     echo "    ..." mkdir -p $Path if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "    ,      ..." fi #       if [ ! -d $Path/$CDate ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo #        echo "       ..." mkdir -p $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "BackUp CDate dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "BackUp CDate dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "    ,     ..." fi #     /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes #    if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi #       for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then #        echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "File $MBoxes clear\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "File $MBoxes can NOT be cleared\n" &gt;&gt; $log fi #      #      if [ ! -d $ArchPath ]; then #    echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log #         if [ "$MDay" = 1 ]; then #      if [ ! -d $MPath ]; then #     echo "    ..." mkdir -p $MPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Long saving dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Long saving dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else #  echo "    ,     ..." fi cp $ArchPath/$CDate.tgz $MPath/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive is copied in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT copied in $(date +%T)\n" &gt;&gt; $log fi echo "    ( 1 )..." # ,   ,   find $Path -atime +7 | xargs rm -d if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps files was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps files is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi #    ( 2 ) echo "     ( 2 )..." find $ArchPath -atime +61 | xargs rm -f if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Old BackUps archives was deleted\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Old BackUps archives is NOT deleted in $(date +%T)\n" &gt;&gt; $log fi fi else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi echo "BackUp job finished in $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Contenu du fichier HandBackUp.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #    ArchPath="/mnt/ZM/Archive" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #  CDate=$(date +%d-%m-%Y) #   log="/mnt/ZM/BackUpLog.txt" read -p "    (  ),  ALL      : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "BackUp started in $(date +%T)\n" &gt;&gt; $log #     echo "    ..." /opt/zimbra/bin/zmprov -l gaa $ZDomain &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Boxes list created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box list is NOT created! in $(date +%T)\n" &gt;&gt; $log exit fi if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #       echo "      " for MailBox in $( cat $MBoxes); do echo "    $MailBox..." /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi done else MailBox="$A@$ZDomain" #    echo "   ..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then #   echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo "  $MailBox ,  ..." echo -en "Required Mail Box $MailBox exist $(date +%T)\n" &gt;&gt; $log #      if ! [ -d $Path/$Date ]; then #    mkdir -p $Path/$CDate/ echo -en "BackUp directory created in $(date +%T)\n" &gt;&gt; $log fi #    $MailBox /opt/zimbra/bin/zmmailbox -z -m $MailBox getRestUrl "//?fmt=tgz" &gt; $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Mail Box $MailBox BackUp created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en "Mail Box $MailBox BackUp is NOT created! in $(date +%T)\n" &gt;&gt; $log fi else #    -  echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo "  $MailBox  .   " echo -en "Required Mail Box $MailBox is not exist\n" &gt;&gt; $log exit fi fi read -p "      $MailBox? [N]: " F if [[ "$F" = "Y" || "$F" = "y" ]]; then #      if [ ! -d $ArchPath ]; then #     echo "   ..." mkdir -p $ArchPath if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive dirctory was created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive dirctory was NOT created in $(date +%T)\n" &gt;&gt; $log fi else echo "   , ..." fi #    echo "  ..." if [[ "$A" = "ALL" || "$A" = "all" ]]; then tar -czf $ArchPath/$CDate.tar $Path/$CDate if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi else tar -czf $ArchPath/$MailBox.tar $Path/$CDate/$MailBox if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en "Archive created in $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Archive is NOT created in $(date +%T)\n" &gt;&gt; $log fi fi else echo "   " echo -en "User decline archive creating\n" &gt;&gt; $log fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "BackUp job finished in $(date +%T) $(date +%T)\n" &gt;&gt; $log echo -en "_____________________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Le contenu du fichier Restore.sh:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash #   Path="/mnt/ZM/BackUps" #  Zimbra ZDomain="zimbramail.home.local" #  MBoxes="/mnt/ZM/MBoxesList" #   log="/mnt/ZM/RestoreLog.txt" read -p "  ,      02-09-2001: " Date if ! [ -d $Path/$Date ]; then echo "     ." echo -en "No BackUp file at $Date $(date +%T)\n" &gt; $log exit fi read -p "    (  ),  ALL        : " A if [[ "$A" = "ALL" || "$A" = "all" ]]; then echo -en "Restore started in $(date +%T)\n" &gt;&gt; $log #     ls "$Path/$Date" &gt; $MBoxes for MailBox in $( cat $MBoxes); do #   echo "   $MailBox" Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist, creating Mail Box $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox  .   $MailBox..." #   Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   ." fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi done else #     MailBox="$A@$ZDomain" if [ -a $Path/$Date/$MailBox ]; then #   echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov getMailboxInfo $MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Start restore job for $MailBox $(date +%T)\n" &gt;&gt; $log echo " $MailBox . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Mail Box $MailBox does not exist $(date +%T)\n" &gt;&gt; $log echo " $MailBox  ." read -p "            ? [N]: " B if [[ "$B" = "Y" || "$B" = "y" ]]; then echo "   $MailBox..." Result=$(/opt/zimbra/bin/zmprov ca $MailBox 12345678 displayName "$MailBox") #   if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6) [OK]" echo echo -en "Mail Box $MailBox is created, starting restore $(date +%T)\n" &gt;&gt; $log echo " $MailBox  . ..." else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo echo -en "Can NOT create Mail Box $MailBox ! $(date +%T)\n" &gt;&gt; $log echo " $MailBox   .   ..." exit fi else #   ,  .  echo "   .   " exit fi fi #  Result=$(/opt/zimbra/bin/zmmailbox -z -m $MailBox postRestURL "//?fmt=tgz&amp;resolve=replace" $Path/$Date/$MailBox) if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo echo -en " $MailBox   $(date +%T)\n" &gt;&gt; $log else echo -n "$(tput hpa $(tput cols))$(tput cub 6)[FAIL]" echo echo -en " $MailBox  ! $(date +%T)\n" &gt;&gt; $log fi else #     echo "    .   " echo -en "Required BackUp file is not exist\n" &gt;&gt; $log exit fi fi #     echo "    ..." echo -n &gt; $MBoxes if [ $? -eq 0 ]; then echo -n "$(tput hpa $(tput cols))$(tput cub 6)[OK]" echo else echo -n "$(tput hpa $(tput cols))$(tput cub 6) [FAIL]" echo fi echo "BackUp job finished in $(date +%T) $(date +%T)" #  -     echo -en "Restore job complete in $(date +%T)\n" &gt;&gt; $log echo -en "____________________________________\n" &gt;&gt; $log</span></span></code> </pre></div></div><br>  Il y a une subtilit√©.  Si vous cr√©ez et modifiez des fichiers de script pour bash sous Windows, alors lorsque vous essayez d'ex√©cuter le script, une erreur appara√Æt: <b>/ bin / sh ^ M: mauvais interpr√®te: aucun fichier ou r√©pertoire de ce type</b> , c'est-√†-dire que les √©diteurs ex√©cutant sous Windows ajoutent √† la fin de la ligne est le caract√®re de retour chariot "CR \ LF", que les √©diteurs sous Linux n'affiche pas.  Mais ce symbole est l√† et n'a pas disparu.  Pour se d√©barrasser de l'erreur et supprimer les caract√®res suppl√©mentaires, nous proc√©dons comme suit: <br><br><pre> <code class="bash hljs">$ cat your-script.sh | tr -d <span class="hljs-string"><span class="hljs-string">'\r'</span></span> &gt; corrected-your-script.sh</code> </pre> <br>  Eh bien, ou vous pouvez utiliser l'utilitaire dos2unix, mais vous devez toujours l'installer: <br><br><pre> <code class="bash hljs">$ yum install dos2unix $ dos2unix your-script.sh</code> </pre> <br>  5) Nous rendons les scripts ex√©cutables: <br><br><pre> <code class="bash hljs">$ chmod 0740 /opt/zimbra/BkUpRestScripts/FullBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/HandBackUp.sh $ chmod 0740 /opt/zimbra/BkUpRestScripts/Restore.sh</code> </pre> <br>  6) Je vous recommande d'ex√©cuter des scripts avec vos mains et de v√©rifier s'ils fonctionnent et comment ils fonctionnent. <br><br>  7) Cr√©ez une t√¢che dans CRON pour la sauvegarde quotidienne des bo√Ætes aux lettres: <br><br><pre> <code class="bash hljs">10 0 * * * root /opt/zimbra/ BkUpRestScripts/FullBackUp.sh</code> </pre> <br>  8) Profitez <br><br><h3>  4. Script </h3><br>  Dans le cas o√π les commentaires dans les scripts eux-m√™mes n'ont pas aid√©. <br><br><div class="spoiler">  <b class="spoiler_title">1) Script FullBaclUp.sh:</b> <div class="spoiler_text">  Au d√©but, les variables sont d√©termin√©es, laquelle est responsable de quoi - tout est comment√©. <br><br>  Ce qui suit est une v√©rification de l'absence d'un r√©pertoire pour la sauvegarde; s'il n'existe pas, il est cr√©√©.  La conclusion est faite au fichier journal et √† l'√©cran (s'il est d√©marr√© √† la main) sur le succ√®s ou l'√©chec de la cr√©ation d'un r√©pertoire. <br><br>  V√©rifiez l'absence de catalogue avec la date d'aujourd'hui.  S'il n'est pas l√†, il est cr√©√©, la sortie √† l'√©cran et le journal du r√©sultat de la cr√©ation du r√©pertoire sont √©galement g√©n√©r√©s. <br><br>  √âcriture dans un fichier de toutes les bo√Ætes aux lettres Zimbra existantes.  Il est n√©cessaire pour la r√©servation s√©quentielle de chaque bo√Æte.  Affiche le r√©sultat de la commande. <br><br>  Cr√©ation d'une sauvegarde pour chaque bo√Æte aux lettres √† partir de la liste re√ßue.  Avec la sortie de l'ex√©cution √† l'√©cran et au fichier journal. <br><br>  Effacement d'un fichier avec une liste de cases.  √âtant donn√© que les 3 scripts fonctionnent avec ce fichier, il est conseill√© de le nettoyer apr√®s chaque ex√©cution afin qu'il n'y ait pas de surprise.  Vous pouvez le nettoyer avant le d√©but du script, mais il m'est plus familier de ne pas stocker de donn√©es inutiles une fois le travail termin√©, mais de faire la m√™me chose avant et apr√®s que le script fonctionne est un l√©ger degr√© de schizophr√©nie. <br><br>  Vient ensuite un bloc pour cr√©er une archive compress√©e. <br><br>  V√©rifier l'absence du r√©pertoire de stockage des archives, le cr√©er en l'absence et afficher le r√©sultat de la cr√©ation √† l'√©cran et dans le journal. <br><br>  Archivage <br><br>  Cochez "n'est pas le premier jour aujourd'hui?"  Je pr√©f√®re stocker des sauvegardes pendant le premier jour de tous les mois pendant longtemps, cela me suffit pour travailler.  Il peut √™tre stock√© pendant des semaines, mais souvent c'est redondant.  Mais la condition de stockage des sauvegardes pour toute la p√©riode de fonctionnement du serveur de messagerie est d√©finie en haut, donc ils sont toujours l√†.  Si le num√©ro est le premier, l'archive r√©sultante est copi√©e dans un r√©pertoire ¬´Mounthly¬ª distinct.  Et pour le copier l√†, vous devez v√©rifier s'il existe un tel r√©pertoire, et sinon, le cr√©er, qui devrait √™tre signal√© √† l'√©cran et au fichier journal. <br><br>  Ensuite, le stockage est nettoy√© - toutes les sauvegardes de plus de 2 semaines sont supprim√©es, ainsi que les archives de plus de 61 jours.  Le r√©sultat de la suppression est affich√© √† l'√©cran et dans le fichier journal. <br><br>  Apr√®s quoi, le script √©crit l'heure de fin dans le fichier journal et sur l'√©cran et termine son travail. </div></div><br><div class="spoiler">  <b class="spoiler_title">2) Script HandBackUp.sh:</b> <div class="spoiler_text">  Au d√©but, des variables sont √©galement d√©finies, comment√©es √©galement pourquoi elles sont n√©cessaires. <br><br>  Ensuite, l'utilisateur est invit√© √† entrer le nom de la bo√Æte aux lettres √† sauvegarder, sans sp√©cifier le domaine Zimbra.  (il est √©crit dans l'invitation √† entrer), ou s√©lectionnez une sauvegarde de toutes les bo√Ætes aux lettres en √©crivant TOUT ou tous. <br><br>  Si vous choisissez de sauvegarder toutes les bo√Ætes aux lettres, le script fonctionne presque de la m√™me mani√®re que la premi√®re r√©pertori√©e ci-dessus, sauf qu'apr√®s avoir cr√©√© des sauvegardes de chaque bo√Æte aux lettres, il vous demandera - dois-je les archiver? <br><br>  Si une bo√Æte aux lettres sp√©cifique a √©t√© √©crite, son existence est v√©rifi√©e dans Zimbra.  S'il existe une bo√Æte portant le nom sp√©cifi√©, le processus de sauvegarde de cette bo√Æte d√©marre, avec les informations correspondantes affich√©es √† l'√©cran et dans le fichier journal.  Si la case sp√©cifi√©e n'existe pas, l'utilisateur en sera inform√© et le script terminera son travail. <br><br>  Une fois la sauvegarde de la bo√Æte termin√©e, vous serez invit√© √† archiver la copie.  Si l'utilisateur est d'accord - il y a une v√©rification de l'absence d'un r√©pertoire pour stocker l'archive et plus bas dans la liste, comme dans le premier script. <br><br>  Une fois l'archivage termin√©, le fichier contenant la liste des bo√Ætes aux lettres est effac√©.  Juste au cas o√π. <br><br>  √Ä la fin, des informations sur l'heure de fin du script s'affichent √† l'√©cran et dans le fichier journal. </div></div><br><div class="spoiler">  <b class="spoiler_title">3) Script Restore.sh:</b> <div class="spoiler_text">  Comme dans les fichiers pr√©c√©dents, d'abord - la d√©finition des variables avec commentaires. <br><br>  L'utilisateur est invit√© √† s√©lectionner la date de la sauvegarde √† restaurer.  Si la date sp√©cifi√©e ne figure pas dans les sauvegardes, le script est interrompu en le signalant. <br><br>  S'il existe des sauvegardes pour la date sp√©cifi√©e - invitez l'utilisateur √† entrer le nom de la bo√Æte √† restaurer.  Pour restaurer toutes les cases, vous devez √©crire TOUT ou tous. <br><br>  Si l'option ALL est s√©lectionn√©e, le script cr√©e une liste de fichiers dans le dossier de sauvegarde du fichier, notifie le r√©sultat de la cr√©ation. <br><br>  Ensuite, une r√©cup√©ration √©tape par √©tape de chaque bo√Æte.  Tout d'abord, v√©rifiez l'existence d'une bo√Æte dans le syst√®me, sinon, elle est cr√©√©e, puis restaur√©e.  Des informations sur chaque op√©ration sont affich√©es dans le fichier journal et √† l'√©cran. <br><br>  Si une case sp√©cifique est s√©lectionn√©e, c'est presque la m√™me chose.  V√©rifiez l'existence d'un fichier avec le nom demand√©.  Sortie sur l'√©cran et le fichier journal des r√©sultats. <br><br>  V√©rification de l'existence d'une bo√Æte dans le syst√®me.  Sortie sur l'√©cran et le fichier journal des r√©sultats. <br>  L'invitation √† l'utilisateur d'accepter la cr√©ation de la box en l'absence de telle dans le syst√®me.  Sortie sur l'√©cran et le fichier journal des r√©sultats. <br><br>  Cr√©ez une bo√Æte si convenu.  Sortie sur l'√©cran et le fichier journal des r√©sultats. <br>  R√©cup√©ration de bo√Æte aux lettres.  Sortie sur l'√©cran et le fichier journal des r√©sultats. <br><br>  Effacement d'un fichier avec une liste de bo√Ætes de r√©cup√©ration. <br><br>  √Ä la fin, des informations sur l'heure de fin du script s'affichent √† l'√©cran et dans le fichier journal. </div></div><br><h3>  5. Concernant la r√©cup√©ration </h3><br>  Si vous modifiez l√©g√®rement ces scripts, ils conviennent parfaitement pour d√©placer du courrier d'un serveur √† un autre, simplement en cr√©ant des bo√Ætes aux lettres avec tout le contenu dans un nouvel emplacement.  Vous pouvez √©galement restaurer le syst√®me √† partir de z√©ro, lorsque, pour une raison quelconque, il est plus facile de relancer le serveur Zimbra que d'essayer de faire revivre l'ancien.  Comme d√©crit ci-dessus, vous pouvez enregistrer l'image de la machine virtuelle configur√©e en la d√©veloppant si n√©cessaire et en la remplissant de toutes les donn√©es.  Le m√™me algorithme pour passer d'un serveur Zimbra √† un autre.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et aucun utilitaire payant comme Zextras n'est n√©cessaire. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. Conclusion </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En g√©n√©ral, il n'y a rien de compliqu√© dans les scripts que j'ai √©crits. </font><font style="vertical-align: inherit;">Oui, il y a beaucoup de conditions, parce que j'ai essay√© de pr√©voir autant de probl√®mes et d'erreurs que possible dans leur travail, mais j'ai aussi essay√© de commenter le script aussi clairement que possible. </font><font style="vertical-align: inherit;">Tr√®s probablement, hors de la bo√Æte, ils ne fonctionneront pas pour tout le monde. </font><font style="vertical-align: inherit;">Peut-√™tre que quelqu'un n'a pas du tout cette m√©thode de sauvegarde. </font><font style="vertical-align: inherit;">Mais j'esp√®re que beaucoup le trouveront utile.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7. PS: </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceci est le deuxi√®me article de la s√©rie ¬´Comment j'ai impl√©ment√© Zimbra¬ª. </font><font style="vertical-align: inherit;">Le premier concerne l'impl√©mentation, l'autorisation LDAP et la cr√©ation automatique de bo√Ætes aux lettres pour les utilisateurs AD, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le troisi√®me article sur la g√©n√©ration et la mise √† jour automatiques des listes de diffusion bas√©es sur AD dans Zimbra OSE </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et je tiens √©galement √† noter que c'est ma premi√®re exp√©rience de script sur un bash, √† cause de cela, les scripts se sont av√©r√©s si encombrants et ¬´pour particuli√®rement intelligents¬ª, comme on dit.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439728/">https://habr.com/ru/post/fr439728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439718/index.html">D√©veloppement d'applications sur Elixir / Phoenix avec Docker</a></li>
<li><a href="../fr439720/index.html">Introduction √† la programmation: un jeu de tir 3D simple √† partir du sol pendant le week-end, partie 2</a></li>
<li><a href="../fr439722/index.html">Effets des filtres SVG. Partie 2. D√©crire le texte avec feMorphology</a></li>
<li><a href="../fr439724/index.html">Aper√ßu des solutions AI et ML en 2018 et pr√©visions pour 2019: Partie 2 - Outils et biblioth√®ques, AutoML, RL, √©thique en IA</a></li>
<li><a href="../fr439726/index.html">Lock-in: vrai ou fiction?</a></li>
<li><a href="../fr439730/index.html">Organisation du r√©ducteur √† travers une classe standard</a></li>
<li><a href="../fr439732/index.html">Lazarus - animation simple utilisant le composant TImageFragment</a></li>
<li><a href="../fr439734/index.html">D√©ployer Kubernetes sur le bureau en quelques minutes avec MicroK8s</a></li>
<li><a href="../fr439736/index.html">Connexion VPN IPSec entre MikroTik et Kerio Control</a></li>
<li><a href="../fr439738/index.html">A la recherche du bouton "Bien faire". Zyxel dans le r√©seau des petites et moyennes entreprises</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>