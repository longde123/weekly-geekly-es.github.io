<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëäüèΩ ‚òùüèº ‚¨áÔ∏è Anotaciones en tiempo de compilaci√≥n utilizando @Implement como ejemplo üèì üòÄ üë©‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A todos nos encanta detectar errores en la etapa de compilaci√≥n, en lugar de excepciones de tiempo de ejecuci√≥n. La forma m√°s f√°cil de solucionarlos e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Anotaciones en tiempo de compilaci√≥n utilizando @Implement como ejemplo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414715/"><img src="https://habrastorage.org/webt/zq/9v/1a/zq9v1afhchg4c2ft1koorkjfcss.png"><br><br>  A todos nos encanta detectar errores en la etapa de compilaci√≥n, en lugar de excepciones de tiempo de ejecuci√≥n.  La forma m√°s f√°cil de solucionarlos es que el compilador mismo muestra todos los lugares que necesitan ser reparados.  Aunque la mayor√≠a de los problemas solo se pueden detectar cuando se inicia el programa, todav√≠a estamos tratando de hacerlo lo antes posible. <a name="habracut"></a>  En bloques de inicializaci√≥n de clases, en constructores de objetos, en la primera llamada de un m√©todo, etc.  Y a veces tenemos suerte, e incluso en la etapa de compilaci√≥n sabemos lo suficiente como para verificar que el programa no tenga ciertos errores. <br><br>  En este art√≠culo quiero compartir la experiencia de escribir una de esas pruebas.  M√°s precisamente, creando una anotaci√≥n que puede arrojar errores, como lo hace el compilador.  A juzgar por el hecho de que no hay tanta informaci√≥n sobre este tema en RuNet, las situaciones felices descritas anteriormente no son frecuentes. <br><br>  Describir√© el algoritmo de verificaci√≥n general, as√≠ como todos los pasos y matices por los que pas√© tiempo y las c√©lulas nerviosas. <br><br><h3>  Declaraci√≥n del problema. </h3><br>  En esta secci√≥n, dar√© un ejemplo del uso de esta anotaci√≥n.  Si ya sabe qu√© verificaci√≥n desea hacer, puede omitirla de manera segura.  Estoy seguro de que esto no afectar√° la integridad de la presentaci√≥n. <br><br>  Ahora hablaremos m√°s sobre mejorar la legibilidad del c√≥digo que sobre corregir errores.  Un ejemplo, se podr√≠a decir, de la vida, o m√°s bien de mi proyecto de hobby. <br><br>  Supongamos que hay una clase UnitManager, que, de hecho, es una colecci√≥n de unidades.  Tiene m√©todos para agregar, eliminar, obtener una unidad, etc.  Al agregar una nueva unidad, el gerente le asigna una identificaci√≥n.  La generaci√≥n de id se delega a la clase RotateCounter, que devuelve un n√∫mero en el rango dado.  Y hay un peque√±o problema, RotateCounter no puede saber si la identificaci√≥n seleccionada est√° libre.  De acuerdo con el principio de inversi√≥n de dependencia, puede crear una interfaz, en mi caso es RotateCounter.IClient, que tiene un √∫nico m√©todo isValueFree (), que recibe id y devuelve verdadero si id es libre.  Y UnitManager implementa esta interfaz, crea una instancia de RotateCounter y se la pasa a s√≠ misma como cliente. <br><br>  Yo solo hice eso.  Pero, despu√©s de abrir la fuente de UnitManager unos d√≠as despu√©s de escribir, entr√© en un estupor f√°cil despu√©s de ver el m√©todo isValueFree (), que realmente no se ajustaba a la l√≥gica de UnitManager.  Ser√≠a mucho m√°s simple si fuera posible especificar qu√© interfaz implementa este m√©todo.  Por ejemplo, en C #, de donde vine a Java, una implementaci√≥n de interfaz expl√≠cita ayuda a hacer frente a este problema.  En este caso, en primer lugar, puede llamar al m√©todo solo con una conversi√≥n expl√≠cita a la interfaz.  En segundo lugar, y m√°s importante en este caso, el nombre de la interfaz (y sin el modificador de acceso) se indica expl√≠citamente en la firma del m√©todo, por ejemplo: <br><br><pre><code class="cs hljs">IClient.isValueFree(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { }</code> </pre> <br>  Una soluci√≥n es agregar una anotaci√≥n con el nombre de la interfaz que implementa este m√©todo.  Algo as√≠ como <code>@Override</code> , solo con una interfaz.  Estoy de acuerdo, puedes usar una clase interna an√≥nima.  En este caso, al igual que en C #, el m√©todo no solo se puede invocar en el objeto, y puede ver de inmediato qu√© interfaz implementa.  Pero, esto aumentar√° la cantidad de c√≥digo, por lo tanto, degradar√° la legibilidad.  S√≠, y de alguna manera necesita obtenerlo de la clase: cree un captador o campo p√∫blico (despu√©s de todo, tampoco hay sobrecarga de sentencias de conversi√≥n en Java).  No es una mala opci√≥n, pero no me gusta. <br><br>  Al principio, pens√© que en Java, como en C #, las anotaciones son clases completas y se pueden heredar de ellas.  En este caso, solo necesita crear una anotaci√≥n que herede de <code>@Override</code> .  Pero esto no fue as√≠, y tuve que sumergirme en el asombroso y aterrador mundo de los cheques en la etapa de compilaci√≥n. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de muestra de UnitManager</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Unit</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnitManager</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RotateCounter</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Unit[] units; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RotateCounter idGenerator; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnitManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ units = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Unit[size]; idGenerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RotateCounter(<span class="hljs-number"><span class="hljs-number">0</span></span>, size, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Unit unit)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id = idGenerator.findFree(); units[id] = unit; } <span class="hljs-meta"><span class="hljs-meta">@Implement</span></span>(RotateCounter.IClient.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValueFree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> units[value] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span><span class="hljs-function"> </span></span>{ units[id] = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RotateCounter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IClient client; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> next; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minValue; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxValue; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RotateCounter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> minValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxValue, IClient client)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.client = client; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.minValue = minValue; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxValue = maxValue; next = minValue; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incrementAndGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> current = next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next &gt;= maxValue) { next = minValue; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current; } next++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">range</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maxValue - minValue + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findFree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> range = range(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> trysCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (++trysCounter &gt; range) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(<span class="hljs-string"><span class="hljs-string">"No free values."</span></span>); } id = incrementAndGet(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!client.isValueFree(id)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> id; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValueFree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span></span>; } }</code> </pre></div></div><br><h3>  Poco de teor√≠a </h3><br>  Har√© una reserva de inmediato, todos los m√©todos anteriores son instancia, por lo tanto, por brevedad, <code>&lt;_&gt;.&lt;_&gt;()</code> los nombres de los m√©todos con el nombre del tipo y sin par√°metros: <code>&lt;_&gt;.&lt;_&gt;()</code> <br><br>  El procesamiento de elementos en la etapa de compilaci√≥n implica clases especiales de procesador.  Estas son clases que heredan de <code>javax.annotation.processing.AbstractProcessor</code> (simplemente puede implementar la interfaz <code>javax.annotation.processing.Processor</code> ).  Puede leer m√°s sobre procesadores <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  El m√©todo m√°s importante es el proceso.  En el que podemos obtener una lista de todos los elementos anotados y realizar las verificaciones necesarias. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br>  Al principio, sinceramente ingenuo, pens√© que trabajar con tipos en la etapa de compilaci√≥n se lleva a cabo en t√©rminos de reflexi√≥n, pero ... no.  Todo se basa en elementos all√≠. <br><br>  <b>Elemento</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">javax.lang.model.element.Element</a> ): la interfaz principal para trabajar con la mayor√≠a de los elementos estructurales del lenguaje.  Un elemento tiene descendientes que determinan con mayor precisi√≥n las propiedades de un elemento en particular (para m√°s detalles, consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ): <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ds.magic.example.implement; <span class="hljs-comment"><span class="hljs-comment">// PackageElement public class Unit // TypeElement { private int id; // VariableElement public void setId(int id) { // ExecutableElement this.id = id; } }</span></span></code> </pre> <br>  <b>TypeMirror</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">javax.lang.model.type.TypeMirror</a> ) es algo as√≠ como Class &lt;?&gt; Devuelto por el m√©todo getClass ().  Por ejemplo, se pueden comparar para averiguar si los tipos de elementos coinciden.  Puede obtenerlo utilizando el m√©todo <code>Element.asType()</code> .  Este tipo tambi√©n devuelve algunas operaciones de tipo, como <code>TypeElement.getSuperclass()</code> o <code>TypeElement.getInterfaces()</code> . <br><br>  <b>Tipos</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">javax.lang.model.util.Types</a> ): le aconsejo que eche un vistazo m√°s de cerca a esta clase.  Puedes encontrar muchas cosas interesantes all√≠.  En esencia, este es un conjunto de utilidades para trabajar con tipos.  Por ejemplo, le permite recuperar un TypeElement de un TypeMirror. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> TypeElement </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asTypeElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TypeMirror typeMirror)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (TypeElement)processingEnv.getTypeUtils().asElement(typeMirror); }</code> </pre> <br>  <b>TypeKind</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">javax.lang.model.type.TypeKind</a> ): una enumeraci√≥n que le permite aclarar la informaci√≥n de tipo, verificar si el tipo es una matriz (ARRAY), un tipo personalizado (DECLARADO), una variable de tipo (TYPEVAR), etc.  Puede obtenerlo a trav√©s de <code>TypeMirror.getKind()</code> <br><br>  <b>ElementKind</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">javax.lang.model.element.ElementKind</a> ) - enumeraci√≥n, le permite aclarar informaci√≥n sobre el elemento, verificar si el elemento es un paquete (PAQUETE), clase (CLASE), m√©todo (M√âTODO), interfaz (INTERFAZ), etc. <br><br>  <b>Nombre</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">javax.lang.model.element.Name</a> ): la interfaz para trabajar con el nombre del elemento se puede obtener a trav√©s de <code>Element.getSimpleName()</code> . <br><br>  B√°sicamente, estos tipos fueron suficientes para que yo escribiera un algoritmo de verificaci√≥n. <br><br>  Quiero se√±alar otra caracter√≠stica interesante.  Las implementaciones de las interfaces de Element en Eclipse est√°n en los paquetes org.eclipse ..., por ejemplo, los elementos que representan los m√©todos son del tipo <code>org.eclipse.jdt.internal.compiler.apt.model.ExecutableElementImpl</code> .  Esto me dio la idea de que cada IDE implementa estas interfaces de forma independiente. <br><br><h3>  Algoritmo de validaci√≥n </h3><br>  Primero necesitas crear la anotaci√≥n misma.  Ya se ha escrito mucho al respecto (por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ), por lo que no me detendr√© en esto en detalle.  Solo puedo decir que para nuestro ejemplo, necesitamos agregar dos anotaciones <code>@Target</code> y <code>@Retention</code> .  El primero indica que nuestra anotaci√≥n solo se puede aplicar al m√©todo, y el segundo que la anotaci√≥n solo existir√° en el c√≥digo fuente. <br><br>  Las anotaciones deben especificarse qu√© interfaz implementa el m√©todo anotado (el m√©todo al que se aplica la anotaci√≥n).  Esto se puede hacer de dos maneras: especifique el nombre completo de la interfaz con una cadena, por ejemplo <code>@Implement("com.ds.IInterface")</code> , o pase la clase de interfaz directamente: <code>@Implement(IInterface.class)</code> .  La segunda forma es claramente mejor.  En este caso, el compilador supervisar√° el nombre correcto de la interfaz.  Por cierto, si llama a este <b>valor de</b> miembro <b>(),</b> al agregar anotaciones al m√©todo, no necesitar√° especificar expl√≠citamente el nombre de este par√°metro. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>({ElementType.METHOD}) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.SOURCE) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> Implement { Class&lt;?&gt; value(); }</code> </pre> <br>  Entonces comienza la diversi√≥n: la creaci√≥n del procesador.  En el m√©todo de proceso, obtenemos una lista de todos los elementos anotados.  Luego obtenemos la anotaci√≥n en s√≠ y su significado: la interfaz especificada.  En general, el marco de clase de procesador se ve as√≠: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SupportedAnnotationTypes</span></span>({<span class="hljs-string"><span class="hljs-string">"ds.magic.annotations.compileTime.Implement"</span></span>}) <span class="hljs-meta"><span class="hljs-meta">@SupportedSourceVersion</span></span>(SourceVersion.RELEASE_8) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImplementProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Types typeUtils; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProcessingEnvironment procEnv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.init(procEnv); typeUtils = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.processingEnv.getTypeUtils(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Set&lt;? extends TypeElement&gt; annos, RoundEnvironment env)</span></span></span><span class="hljs-function"> </span></span>{ Set&lt;? extends Element&gt; annotatedElements = env.getElementsAnnotatedWith(Implement.class); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Element annotated : annotatedElements) { Implement annotation = annotatedElement.getAnnotation(Implement.class); TypeMirror interfaceMirror = getValueMirror(annotation); TypeElement interfaceType = asTypeElement(interfaceMirror); <span class="hljs-comment"><span class="hljs-comment">//... } return false; } private TypeElement asTypeElement(TypeMirror typeMirror) { return (TypeElement)typeUtils.asElement(typeMirror); } }</span></span></code> </pre> <br>  Quiero se√±alar que no puede obtener y obtener anotaciones de valor as√≠ como as√≠.  Cuando intente llamar a <code>annotation.value()</code> , se generar√° una <b>MirroredTypeException</b> , pero de ella puede obtener un TypeMirror.  Este m√©todo de trampa, as√≠ como la recepci√≥n correcta del valor, encontr√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> : <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> TypeMirror </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValueMirror</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Implement annotation)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { annotation.value(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(MirroredTypeException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e.getTypeMirror(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br>  La verificaci√≥n en s√≠ misma consta de tres partes, si al menos una de ellas falla, deber√° mostrar un mensaje de error y pasar a la siguiente anotaci√≥n.  Por cierto, puede mostrar un mensaje de error utilizando el siguiente m√©todo: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message, Element annotatedElement)</span></span></span><span class="hljs-function"> </span></span>{ Messager messager = processingEnv.getMessager(); messager.printMessage(Kind.ERROR, message, annotatedElement); }</code> </pre> <br>  El primer paso es verificar si las anotaciones de valor son una interfaz.  Aqu√≠ todo es simple: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (interfaceType.getKind() != ElementKind.INTERFACE) { String name = Implement.class.getSimpleName(); printError(<span class="hljs-string"><span class="hljs-string">"Value of @"</span></span> + name + <span class="hljs-string"><span class="hljs-string">" must be an interface"</span></span>, annotated); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br>  A continuaci√≥n, debe verificar si la clase en la que se encuentra el m√©todo anotado implementa realmente la interfaz especificada.  Al principio, tontamente implement√© esta prueba con mis manos.  Pero luego, con buenos consejos, mir√© <b>Tipos</b> y encontr√© el m√©todo <code>Types.isSubtype()</code> all√≠, que verificar√° todo el √°rbol de herencia y devolver√° verdadero si la interfaz especificada est√° all√≠.  Es importante destacar que puede funcionar con tipos gen√©ricos, a diferencia de la primera opci√≥n. <br><br><pre> <code class="java hljs">TypeElement enclosingType = (TypeElement)annotatedElement.getEnclosingElement(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!typeUtils.isSubtype(enclosingType.asType(), interfaceMirror)) { Name className = enclosingType.getSimpleName(); Name interfaceName = interfaceType.getSimpleName(); printError(className + <span class="hljs-string"><span class="hljs-string">" must implemet "</span></span> + interfaceName, annotated); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br>  Finalmente, debe asegurarse de que la interfaz tenga un m√©todo con la misma firma que la anotada.  Me gustar√≠a usar el m√©todo <code>Types.isSubsignature()</code> , pero, desafortunadamente, no funciona correctamente si el m√©todo tiene par√°metros de tipo.  As√≠ que nos remangamos y escribimos todos los cheques con nuestras manos.  Y tenemos tres de ellos otra vez.  Bueno, m√°s precisamente, la firma del m√©todo consta de tres partes: el nombre del m√©todo, el tipo del valor de retorno y la lista de par√°metros.  Debe pasar por todos los m√©todos de la interfaz y encontrar el que pas√≥ las tres comprobaciones.  Ser√≠a bueno no olvidar que el m√©todo puede heredarse de otra interfaz y realizar las mismas comprobaciones recursivas para las interfaces subyacentes. <br><br>  La llamada debe colocarse al final del ciclo en el m√©todo de proceso, as√≠: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!haveMethod(interfaceType, (ExecutableElement)annotatedElement)) { Name name = interfaceType.getSimpleName(); printError(name + <span class="hljs-string"><span class="hljs-string">" don't have \""</span></span> + annotated + <span class="hljs-string"><span class="hljs-string">"\" method"</span></span>, annotated); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br>  Y el m√©todo haveMethod () en s√≠ se ve as√≠: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">haveMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TypeElement interfaceType, ExecutableElement method)</span></span></span><span class="hljs-function"> </span></span>{ Name methodName = method.getSimpleName(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Element interfaceElement : interfaceType.getEnclosedElements()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (interfaceElement <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ExecutableElement) { ExecutableElement interfaceMethod = (ExecutableElement)interfaceElement; <span class="hljs-comment"><span class="hljs-comment">// Is names match? if (!interfaceMethod.getSimpleName().equals(methodName)) { continue; } // Is return types match (ignore type variable)? TypeMirror returnType = method.getReturnType(); TypeMirror interfaceReturnType = method.getReturnType(); if (!isTypeVariable(interfaceReturnType) &amp;&amp; !returnType.equals(interfaceReturnType)) { continue; } // Is parameters match? if (!isParametersEquals(method.getParameters(), interfaceMethod.getParameters())) { continue; } return true; } } // Recursive search for (TypeMirror baseMirror : interfaceType.getInterfaces()) { TypeElement base = asTypeElement(baseMirror); if (haveMethod(base, method)) { return true; } } return false; } private boolean isParametersEquals(List&lt;? extends VariableElement&gt; methodParameters, List&lt;? extends VariableElement&gt; interfaceParameters) { if (methodParameters.size() != interfaceParameters.size()) { return false; } for (int i = 0; i &lt; methodParameters.size(); i++) { TypeMirror interfaceParameterMirror = interfaceParameters.get(i).asType(); if (isTypeVariable(interfaceParameterMirror)) { continue; } if (!methodParameters.get(i).asType().equals(interfaceParameterMirror)) { return false; } } return true; } private boolean isTypeVariable(TypeMirror type) { return type.getKind() == TypeKind.TYPEVAR; }</span></span></code> </pre> <br>  ¬øVes el problema?  No?  Y ella est√° ah√≠.  El hecho es que no pude encontrar una manera de obtener los par√°metros de tipo reales para las interfaces gen√©ricas.  Por ejemplo, tengo una clase que implementa la interfaz <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Predicate</a> : <br><pre> <code class="java hljs">MyPredicate implements Predicate&amp;ltString&amp;gt { <span class="hljs-meta"><span class="hljs-meta">@Implement</span></span>(Predicate.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String t)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br>  Al analizar el m√©todo en la clase, el tipo de par√°metro es <code>String</code> , y en la interfaz es <code>T</code> , y todos los intentos de obtener <code>String</code> lugar no condujeron a nada.  Al final, no se me ocurri√≥ nada mejor que simplemente ignorar los par√°metros de tipo.  La verificaci√≥n se pasar√° con cualquier par√°metro de tipo real, incluso si no coinciden.  Afortunadamente, el compilador arrojar√° un error si el m√©todo no tiene una implementaci√≥n predeterminada y no est√° implementado en la clase base.  Pero a√∫n as√≠, si alguien sabe c√≥mo solucionar esto, estar√© extremadamente agradecido por la pista. <br><br><h3>  Con√©ctese a Eclipse </h3><br>  Personalmente, amo Eclipce y en mi pr√°ctica solo lo us√©.  Por lo tanto, describir√© c√≥mo conectar el procesador a este IDE.  Para que Eclipse vea el procesador, debe empaquetarlo en un archivo .JAR separado, en el que tambi√©n estar√° la anotaci√≥n.  En este caso, debe crear la carpeta <b>META-INF / services</b> en el proyecto y crear el archivo <b>javax.annotation.processing.Processor all√≠</b> e indicar el nombre completo de la clase de procesador: <code>ds.magic.annotations.compileTime.ImplementProcessor</code> , en mi caso.  Por si acaso, dar√© una captura de pantalla, pero cuando nada funcion√≥ para m√≠, casi comenc√© a pecar en la estructura del proyecto. <br><br><img src="https://habrastorage.org/webt/bp/oo/ev/bpooev7zwn5msgfm6pyyhupedwi.png" alt="imagen"><br><br>  A continuaci√≥n, recopile .JAR y con√©ctelo a su proyecto, primero como una biblioteca normal, para que la anotaci√≥n sea visible en el c√≥digo.  Luego conectamos el procesador ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠ est√°</a> m√°s detallado).  Para hacer esto, abra las <b>propiedades</b> del <b>proyecto</b> y seleccione: <br><br><ol><li>  Compilador Java -&gt; Procesamiento de anotaciones y marque la casilla "Habilitar procesamiento de anotaciones". </li><li>  Compilador Java -&gt; Procesamiento de anotaciones -&gt; Ruta de f√°brica marque la casilla de verificaci√≥n "Habilitar configuraciones espec√≠ficas del proyecto".  Luego haga clic en Agregar JAR ... y seleccione el archivo JAR creado anteriormente. </li><li>  Acuerda reconstruir el proyecto. </li></ol><br><h3>  Resumen </h3><br>  Todos juntos y en el proyecto Eclipse se pueden ver en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> .  Al momento de escribir, solo hay dos clases, si la anotaci√≥n se puede llamar as√≠: Implement.java e ImplementProcessor.java.  Creo que ya has adivinado su prop√≥sito. <br><br>  Quiz√°s esta anotaci√≥n pueda parecer in√∫til para algunos.  Quiz√°s lo es.  Pero personalmente, yo mismo lo uso en lugar de <code>@Override</code> , cuando los nombres de los m√©todos no se ajustan bien al prop√≥sito de la clase.  Y hasta ahora, no deseo deshacerme de ella.  En general, hice una anotaci√≥n para m√≠ mismo, y el prop√≥sito del art√≠culo era mostrar qu√© rastrillo estaba atacando.  Espero haberlo hecho  Gracias por su atencion <br><br>  PS.  Gracias a los usuarios de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ohotNik_alex</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Comdiv</a> por su ayuda en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">correcci√≥n</a> de errores. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es414715/">https://habr.com/ru/post/es414715/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es414705/index.html">Obras maestras de la construcci√≥n global de altavoces: supervise la ruta innovadora de Audio desde la tela hasta el metal y los materiales compuestos</a></li>
<li><a href="../es414707/index.html">An√°lisis de blockchain, o ¬øpor qu√© se rompi√≥ el mezclador?</a></li>
<li><a href="../es414709/index.html">Leones del desierto e introspecci√≥n</a></li>
<li><a href="../es414711/index.html">La aplicaci√≥n de f√∫tbol espa√±ola La Liga ha convertido a sus usuarios en estafadores involuntarios</a></li>
<li><a href="../es414713/index.html">Semana de comentarios cruzados</a></li>
<li><a href="../es414717/index.html">TV 4K 2018: recomendaciones para la mejor opci√≥n</a></li>
<li><a href="../es414719/index.html">Cuatro ruedas son buenas, dos son mejores</a></li>
<li><a href="../es414723/index.html">Concurso de programaci√≥n: Comercio</a></li>
<li><a href="../es414725/index.html">Cambio frontal: por qu√© golpear una corriente de protones en un muro de hormig√≥n de cinco metros de espesor</a></li>
<li><a href="../es414727/index.html">La ley de criptomonedas pronto se lanzar√° en Rusia: ¬øqu√© cambiar√° para los participantes del mercado?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>