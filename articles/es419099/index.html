<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèæ ü•´ üê∑ WebSockets en Angular. Parte 2. Soluciones de productos ‚öæÔ∏è üíá ü¶ã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En un art√≠culo anterior, hablamos sobre una soluci√≥n general para sockets web en Angular, donde creamos un bus basado en WebSocketSubject con reconexi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>WebSockets en Angular. Parte 2. Soluciones de productos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419099/"><img src="https://habrastorage.org/webt/hf/xh/dl/hfxhdlv7katnrbytwzqmhjy3xom.png" alt="imagen"><br><br>  En un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo anterior,</a> hablamos sobre una soluci√≥n general para sockets web en Angular, donde creamos un bus basado en WebSocketSubject con reconexi√≥n y servicio para usar en componentes.  Dicha implementaci√≥n es adecuada para la mayor√≠a de los casos simples, por ejemplo, recibir y enviar mensajes de chat, etc., pero sus capacidades pueden no ser suficientes cuando necesita construir algo m√°s flexible y controlado.  En este art√≠culo, revelar√© algunas caracter√≠sticas al trabajar con sockets web y hablar√© sobre los requisitos que usted mismo ha encontrado y, posiblemente, encontrar√°. <br><a name="habracut"></a><br>  A menudo, en proyectos grandes con alta asistencia, el front-end enfrenta tareas que, en otras circunstancias, son m√°s comunes en el back-end.  En condiciones de austeridad de los recursos del servidor, parte de los problemas migran al territorio front-end, por esta raz√≥n se establece un m√°ximo de extensibilidad y control en el proyecto. <br><br>  Aqu√≠ hay una lista de los requisitos b√°sicos para un cliente de socket web que se tratar√° en este art√≠culo: <br><br><ul><li>  Reconexi√≥n autom√°tica "inteligente"; </li><li>  Modo de depuraci√≥n; </li><li>  Sistema de suscripci√≥n de eventos basado en RxJs; </li><li>  Recepci√≥n y an√°lisis de datos binarios; </li><li>  Proyecci√≥n (mapeo) de la informaci√≥n recibida sobre el modelo; </li><li>  Control sobre los cambios del modelo a medida que llegan nuevos eventos; </li><li>  Ignorar eventos arbitrarios y cancelar ignorar. </li></ul><br>  Considere cada art√≠culo con m√°s detalle. <br><br><h2>  Reconectar / Debag </h2><br>  Escrib√≠ sobre reconectar en un art√≠culo anterior, as√≠ que solo citar√© parte del texto: <br><br><blockquote>  La reconexi√≥n, o la organizaci√≥n de reconectarse al servidor, es un factor primordial cuando se trabaja con sockets web, como  interrupciones de la red, fallas del servidor u otros errores que causan una interrupci√≥n de la conexi√≥n pueden hacer que la aplicaci√≥n se bloquee. <br>  Es importante tener en cuenta que los intentos de reconexi√≥n no deber√≠an ser demasiado frecuentes y no deber√≠an continuar indefinidamente, ya que  Este comportamiento puede suspender al cliente. </blockquote><br>  El socket web en s√≠ no sabe c√≥mo volver a conectarse cuando est√° desconectado.  Por lo tanto, si el servidor se reinici√≥ o el servidor se bloque√≥, o el usuario volvi√≥ a conectarse a Internet, para continuar trabajando, tambi√©n debe volver a conectar el socket web. <br><br>  En este art√≠culo, para reconectar y depurar, utilizaremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Reconnecting WebSocket</a> , que contiene la funcionalidad necesaria y otras opciones, como cambiar la url del socket web entre reconexiones, elegir un constructor de WebSocket arbitrario, etc.  Otras alternativas tambi√©n son adecuadas.  Volver a conectar desde el art√≠culo anterior no es adecuado, porque  Est√° escrito bajo WebSocketSubject, que esta vez no se aplica. <br><br><h2>  Sistema de suscripci√≥n a eventos RxJs </h2><br>  Para usar sockets web en los componentes, debe suscribirse a los eventos y cancelar la suscripci√≥n cuando sea necesario.  Para hacer esto, use el popular patr√≥n de dise√±o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pub / Sub</a> . <br><blockquote>  "Editor-suscriptor (ing. Editor-suscriptor o ing. Pub / sub): una plantilla de dise√±o de comportamiento para la transmisi√≥n de mensajes en la que los remitentes de mensajes, llamados editores (ing. Editores), no est√°n directamente vinculados al c√≥digo del programa para enviar mensajes a los suscriptores (ing. Suscriptores )  En cambio, los mensajes se dividen en clases y no contienen informaci√≥n sobre sus suscriptores, si corresponde.  Del mismo modo, los suscriptores manejan una o m√°s clases de mensajes, abstray√©ndose de editores espec√≠ficos ". </blockquote><br>  El suscriptor no se comunica directamente con el editor, sino a trav√©s del bus intermedio: el servicio del sitio web.  Tambi√©n deber√≠a ser posible suscribirse a m√∫ltiples eventos con el mismo tipo de retorno.  Cada suscripci√≥n crea su propio Asunto, que se agrega al objeto de escucha, que le permite direccionar eventos de socket web a las suscripciones necesarias.  Cuando se trabaja con RxJs Subject, existen algunas dificultades con la cancelaci√≥n de la suscripci√≥n, por lo tanto, crearemos un recolector de basura simple que eliminar√° los subjuntos del objeto de los oyentes cuando no tengan observadores. <br><br><h2>  Recepci√≥n y an√°lisis de datos binarios. </h2><br>  WebSocket admite la transferencia de datos binarios, archivos o secuencias, que a menudo se utiliza en grandes proyectos.  Se parece a esto: <br><blockquote>  0x80, &lt;longitud - uno o m√°s bytes&gt;, &lt;cuerpo del mensaje&gt; </blockquote><br>  Para no crear restricciones en la longitud del mensaje transmitido y al mismo tiempo no gastar bytes irracionalmente, los desarrolladores del protocolo utilizaron el siguiente algoritmo.  Cada byte en la indicaci√≥n de longitud se considera por separado: el m√°s alto indica si es el √∫ltimo byte (0) o los otros (1) lo siguen, y los 7 bits m√°s bajos contienen los datos transmitidos.  Por lo tanto, cuando aparece el signo de la trama de datos binarios 0x80, se toma el siguiente byte y se almacena en una "alcanc√≠a" separada.  Luego, el siguiente byte, si tiene el conjunto de bits m√°s significativo, tambi√©n se transfiere a la "alcanc√≠a" y as√≠ sucesivamente hasta que se encuentre el byte con el bit m√°s significativo cero.  Este byte es el √∫ltimo en el indicador de longitud y tambi√©n se agrega a la "alcanc√≠a".  Ahora, los bits altos se eliminan de los bytes en la alcanc√≠a, y el resto se combina.  Esta ser√° la longitud del cuerpo del mensaje: n√∫meros de 7 bits sin el bit m√°s significativo. <br><br>  El an√°lisis frontal y el mecanismo de flujo binario es complejo y est√° asociado con la asignaci√≥n de datos en el modelo.  Se puede dedicar un art√≠culo separado a esto.  Esta vez analizaremos una opci√≥n simple y dejaremos casos dif√≠ciles para las siguientes publicaciones, si hay inter√©s en el tema. <br><br><h2>  Proyecci√≥n (mapeo) de la informaci√≥n recibida sobre el modelo </h2><br>  Independientemente del tipo de transmisi√≥n recibida, se requiere leer y modificar de forma segura.  No hay consenso sobre c√≥mo hacer esto mejor, me adhiero a la teor√≠a de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un modelo de datos</a> , ya que lo considero l√≥gico y confiable para programar en el estilo OOP. <br><blockquote>  ‚ÄúUn modelo de datos es una definici√≥n l√≥gica, abstracta y autosuficiente de objetos, operadores y otros elementos que juntos constituyen una m√°quina de acceso a datos abstractos con la que el usuario interact√∫a.  "Estos objetos le permiten modelar la estructura de datos y los operadores: el comportamiento de los datos". </blockquote><br>  Todos los tipos de neum√°ticos populares que no dan una idea de un objeto como una clase en la que se definen el comportamiento, la estructura, etc. crean confusi√≥n, est√°n menos controlados y a veces est√°n cubiertos de algo que no es t√≠pico para ellos.  Por ejemplo, una clase de perros debe describir a un perro bajo cualquier condici√≥n.  Si el perro se percibe como un conjunto de campos: cola, color, cara, etc., entonces el perro puede crecer una pata adicional, y aparecer√° otro perro en lugar de la cabeza. <br><br><img src="https://habrastorage.org/webt/sq/fa/xu/sqfaxulbeyaffws-46gxho3-dcg.jpeg" alt="imagen"><br><br><h2>  Control sobre los cambios del modelo a medida que llegan nuevos eventos </h2><br>  En este p√°rrafo describir√© el problema que encontr√© al trabajar en la interfaz web de la aplicaci√≥n m√≥vil de apuestas deportivas.  La API de la aplicaci√≥n funcion√≥ a trav√©s de sockets web a trav√©s de los cuales recibieron: actualizaci√≥n de cuotas, adici√≥n y eliminaci√≥n de nuevos tipos de apuestas, notificaciones sobre el inicio o el final de un partido, etc.  - total de unos trescientos eventos del socket web.  Durante el partido, las apuestas y la informaci√≥n se actualizan constantemente, a veces 2-3 veces por segundo, por lo que el problema fue que despu√©s de ellas la interfaz se actualiz√≥ sin control intermedio. <br><br>  Cuando el usuario supervis√≥ la oferta desde un dispositivo m√≥vil y, al mismo tiempo, las listas se actualizaron en su pantalla, la oferta desapareci√≥ del campo de visi√≥n, por lo que el usuario tuvo que buscar la oferta rastreada nuevamente.  Este comportamiento se repiti√≥ para cada actualizaci√≥n. <br><br><img src="https://habrastorage.org/webt/tq/5p/e8/tq5pe8qxiepdjj7dx5-jry10bjs.gif" alt="imagen"><br><br>  La soluci√≥n requer√≠a la inmutabilidad de los objetos que se mostraban en la pantalla, pero al mismo tiempo los coeficientes de apuesta ten√≠an que cambiar, las ofertas irrelevantes para volverse inactivas, y no se agregaban nuevas hasta que el usuario desplazaba la pantalla.  Las opciones desactualizadas no se almacenaban en el back-end, por lo tanto, dichas l√≠neas ten√≠an que recordarse y marcarse con el indicador "eliminado", para lo cual se cre√≥ un almac√©n de datos intermedio entre el sitio web y la suscripci√≥n, lo que garantizaba el control sobre los cambios. <br><br>  En el nuevo servicio, tambi√©n crearemos una capa sustituta y esta vez usaremos <a href="">Dexie.js</a> , un contenedor sobre la API IndexedDB, pero cualquier otra base de datos virtual o de navegador funcionar√°.  Redux es aceptable. <br><br><h2>  Ignorar eventos arbitrarios y cancelar ignorar </h2><br>  En la misma compa√±√≠a, a menudo hay varios proyectos del mismo tipo a la vez: versiones m√≥viles y web, versiones con diferentes configuraciones para diferentes grupos de usuarios, versiones avanzadas y truncadas de la misma aplicaci√≥n. <br><br>  A menudo, todos usan una √∫nica base de c√≥digo, por lo que a veces es necesario desactivar eventos innecesarios en tiempo de ejecuci√≥n o durante la DI sin eliminar la suscripci√≥n y volver a encenderla, es decir.  ignore algunos de ellos, para no procesar eventos innecesarios.  Esta es una caracter√≠stica simple pero √∫til que agrega flexibilidad al bus Pub / Sub. <br><br>  Comencemos con una descripci√≥n de las interfaces: <br><br><pre><code class="hljs cmake"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IWebsocketService { //    addEventListener&lt;T&gt;(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[], id?: number): Observable&lt;T&gt;; runtimeIgnore(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]): void; runtimeRemoveIgnore(topics: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]): void; sendMessage(event: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, data: any): void; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface WebSocketConfig { //   DI url: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; ignore?: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]; garbageCollectInterval?: number; options?: Options; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface ITopic&lt;T&gt; { //   Pub/Sub [hash: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]: MessageSubject&lt;T&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IListeners { //    [topic: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]: ITopic&lt;any&gt;; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IBuffer { //    ws.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> type: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; data: number[]; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IWsMessage { // ws.<span class="hljs-keyword"><span class="hljs-keyword">message</span></span> event: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; buffer: IBuffer; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface IMessage { //   id: number; text: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> type ITopicDataType = IMessage[] | number | <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[]; //  callMessage  </code> </pre> <br>  Heredaremos Asunto para crear un recolector de basura: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageSubject</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subject</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( private listeners: IListeners, //    private topic: string, //   private id: string // id  ) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-comment"><span class="hljs-comment">/* *   next, *       , *   garbageCollect */</span></span> public next(value?: T): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.closed) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectUnsubscribedError(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isStopped) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {observers} = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> len = observers.length; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> copy = observers.slice(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { copy[i].next(value); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!len) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.garbageCollect(); <span class="hljs-comment"><span class="hljs-comment">//   } } } /* * garbage collector * */ private garbageCollect(): void { delete this.listeners[this.topic][this.id]; //  Subject if (!Object.keys(this.listeners[this.topic]).length) { //    delete this.listeners[this.topic]; } } }</span></span></code> </pre> <br>  A diferencia de la implementaci√≥n anterior, websocket.events.ts formar√° parte del m√≥dulo de socket web <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> WS_API = { <span class="hljs-attr"><span class="hljs-attr">EVENTS</span></span>: { <span class="hljs-attr"><span class="hljs-attr">MESSAGES</span></span>: <span class="hljs-string"><span class="hljs-string">'messages'</span></span>, <span class="hljs-attr"><span class="hljs-attr">COUNTER</span></span>: <span class="hljs-string"><span class="hljs-string">'counter'</span></span>, <span class="hljs-attr"><span class="hljs-attr">UPDATE_TEXTS</span></span>: <span class="hljs-string"><span class="hljs-string">'update-texts'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">COMMANDS</span></span>: { <span class="hljs-attr"><span class="hljs-attr">SEND_TEXT</span></span>: <span class="hljs-string"><span class="hljs-string">'set-text'</span></span>, <span class="hljs-attr"><span class="hljs-attr">REMOVE_TEXT</span></span>: <span class="hljs-string"><span class="hljs-string">'remove-text'</span></span> } };</code> </pre> <br>  Para configurar al conectar el m√≥dulo, cree websocket.config: <br><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { InjectionToken } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config: InjectionToken&lt;string&gt; = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InjectionToken(<span class="hljs-string"><span class="hljs-string">'websocket'</span></span>);</code> </pre> <br>  Cree un modelo para Proxy: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Dexie <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'dexie'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { IMessage, IWsMessage } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./websocket.interfaces'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { WS_API } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./websocket.events'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> MessagesDatabase extends Dexie { //    Dexie  typescript <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> messages!: Dexie.<span class="hljs-keyword"><span class="hljs-keyword">Table</span></span>&lt;IMessage, number&gt;; // id <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> number <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> constructor() { super(<span class="hljs-string"><span class="hljs-string">'MessagesDatabase'</span></span>); //   this.version(<span class="hljs-number"><span class="hljs-number">1</span></span>).stores({ //   messages: <span class="hljs-string"><span class="hljs-string">'++id,text'</span></span> }); } }</code> </pre> <br>  Un analizador de modelos simple, en condiciones reales es mejor dividirlo en varios archivos: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">export</span></span> const modelParser = (message: <span class="hljs-type"><span class="hljs-type">IWsMessage</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message &amp;&amp; message.buffer) { /*  */ const encodeUint8Array = <span class="hljs-type"><span class="hljs-type">String</span></span>.fromCharCode .apply(<span class="hljs-type"><span class="hljs-type">String</span></span>, new <span class="hljs-type"><span class="hljs-type">Uint8Array</span></span>(message.buffer.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">)); const parseData = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JSON</span></span></span><span class="hljs-class">.parse(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">encodeUint8Array</span></span></span><span class="hljs-class">); let </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDatabase</span></span></span><span class="hljs-class">; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IndexedDB</span></span></span><span class="hljs-class"> if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MESSAGES</span></span></span><span class="hljs-class">) { // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDatabase</span></span></span><span class="hljs-class">(); } parseData.forEach((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">) =&gt; { /*   */ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">transaction</span></span></span><span class="hljs-class">('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rw'</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">async</span></span></span><span class="hljs-class"> () =&gt; { /* ,    */ </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">await</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">}).count()) === 0) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">await</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messages</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">add</span></span></span><span class="hljs-class">({</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messageData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">}); console.log(`</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Addded</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> ${</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">}`); } }).catch(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class"> =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">console</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">error</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> || </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">e</span></span></span><span class="hljs-class">); }); }); return </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MessagesDB</span></span></span><span class="hljs-class">.messages.toArray(); //   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage</span></span></span><span class="hljs-class">[] } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">COUNTER</span></span></span><span class="hljs-class">) { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Promise</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parseData</span></span></span><span class="hljs-class">)); //    } if (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">message</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">event</span></span></span><span class="hljs-class"> === </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WS_API</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EVENTS</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">UPDATE_TEXTS</span></span></span><span class="hljs-class">) { // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class"> = []; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">parseData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">forEach</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textData</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">) =&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">push</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textData</span></span></span><span class="hljs-class">); }); return new </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Promise</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">)); //     } } else { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">console</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">log</span></span></span><span class="hljs-class">(`[${</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Date</span></span></span><span class="hljs-class">()}] </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Buffer</span></span></span><span class="hljs-class"> is "undefined"`); } };</span></span></code> </pre> <br>  WebsocketModule: <br><br><pre> <code class="hljs powershell">@NgModule({ imports: [ <span class="hljs-type"><span class="hljs-type">CommonModule</span></span> ] }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WebsocketModule</span></span></span></span> { public <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> config(wsConfig: WebSocketConfig): ModuleWithProviders { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ngModule: WebsocketModule, providers: [{<span class="hljs-type"><span class="hljs-type">provide</span></span>: <span class="hljs-type"><span class="hljs-type">config</span></span>, <span class="hljs-type"><span class="hljs-type">useValue</span></span>: <span class="hljs-type"><span class="hljs-type">wsConfig</span></span>}] }; } }</code> </pre> <br>  Comencemos a crear un servicio: <br><br><pre> <code class="hljs ruby">private <span class="hljs-symbol"><span class="hljs-symbol">listeners:</span></span> IListeners; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   private <span class="hljs-symbol"><span class="hljs-symbol">uniqueId:</span></span> number; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   id  private <span class="hljs-symbol"><span class="hljs-symbol">websocket:</span></span> ReconnectingWebSocket; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   constructor(@Inject(config) private <span class="hljs-symbol"><span class="hljs-symbol">wsConfig:</span></span> WebSocketConfig) { this.uniqueId = -<span class="hljs-number"><span class="hljs-number">1</span></span>; this.listeners = {}; this.wsConfig.ignore = wsConfig.ignore ? wsConfig.ignore : []; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  this.connect(); } ngOnDestroy() { this.websocket.close(); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     }</code> </pre> <br>  M√©todo de conexi√≥n: <br><br><pre> <code class="hljs coffeescript">private connect(): void { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ReconnectingWebSocket config const options = { connectionTimeout: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    maxRetries: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ,    ...<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.options }; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReconnectingWebSocket(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.url, [], options); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: Event)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket connected!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: CloseEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket close!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: ErrorEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(`<span class="javascript"><span class="javascript">[${</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">Date</span></span></span><span class="javascript">()}] WebSocket error!</span></span>`); }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.websocket.addEventListener(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event: MessageEvent)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.onMessage(event); }); setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.garbageCollect(); }, (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.garbageCollectInterval || <span class="hljs-number"><span class="hljs-number">10000</span></span>)); }</code> </pre> <br>  Duplicar el recolector de basura, buscar√° suscripciones por tiempo de espera: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">garbageCollect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.hasOwnProperty(<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> topic = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners[<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topic) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic.hasOwnProperty(key)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> subject = topic[key]; <span class="hljs-comment"><span class="hljs-comment">//  Subject    if (!subject.observers.length) { delete topic[key]; } } }  ,   if (!Object.keys(topic).length) { delete this.listeners[event]; } } } }</span></span></code> </pre> <br>  Analizamos a qu√© suscripci√≥n enviar el evento: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> onMessage(event: MessageEvent): void { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> message = JSON.parse(event.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.hasOwnProperty(name) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsConfig.ignore.includes(name)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> topic = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners[name]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> keys = name.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      const isMessage = keys.includes(message.event); const model = modelParser(message); //     if (isMessage &amp;&amp; typeof model !== 'undefined') { model.then((data: ITopicDataType) =&gt; { //   Subject this.callMessage&lt;ITopicDataType&gt;(topic, data); }); } } } }</span></span></code> </pre> <br>  Evento de casco en Asunto: <br><br><pre> <code class="hljs powershell">private callMessage&lt;T&gt;(topic: ITopic&lt;T&gt;, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: T): void { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (const key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> topic) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topic.hasOwnProperty(key)) { const subject = topic[<span class="hljs-type"><span class="hljs-type">key</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (subject) { //   subject.next(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(`[<span class="hljs-variable"><span class="hljs-variable">$</span></span>{Date()}] Topic Subject is <span class="hljs-string"><span class="hljs-string">"undefined"</span></span>`); } } } }</code> </pre> <br>  Crear pub / subtema: <br><br><pre> <code class="hljs markdown">private addTopic<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>(topic: string, id?: number): MessageSubject<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> { const token = (++this.uniqueId).toString(); const key = id ? token + id : token; //  id   const hash = sha256.hex(key); // SHA256-   id  if (!this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>]) { this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>] = <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">any</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>{}; } return this.listeners[<span class="hljs-string"><span class="hljs-string">topic</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">hash</span></span>] = new MessageSubject<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">T</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>(this.listeners, topic, hash); }</code> </pre> <br>  Suscribirse a uno o m√°s eventos: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> addEventListener&lt;T&gt;(topics: string | string[], id?: number): Observable&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics) { //       const topicsKey = typeof topics === <span class="hljs-string"><span class="hljs-string">'string'</span></span> ? topics : topics.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.addTopic&lt;T&gt;(topicsKey, id).asObservable(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(`[${<span class="hljs-type"><span class="hljs-type">Date</span></span>()}] Can<span class="hljs-string"><span class="hljs-string">'t add EventListener. Type of event is "undefined".`); } }</span></span></code> </pre> <br>  Todo aqu√≠ se simplifica intencionalmente, pero se puede convertir a entidades binarias, como es el caso con el servidor.  Env√≠o de comandos al servidor: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sendMessage(event: string, data: <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> = {}): <span class="hljs-type"><span class="hljs-type">void</span></span> { //   ,      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event &amp;&amp; this.websocket.readyState === <span class="hljs-number"><span class="hljs-number">1</span></span>) { this.websocket.send(<span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify({event, data})); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { console.log(<span class="hljs-string"><span class="hljs-string">'Send error!'</span></span>); } }</code> </pre> <br>  Agregue eventos a ignorlist en tiempo de ejecuci√≥n: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtimeIgnore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">topics: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics &amp;&amp; topics.length) { <span class="hljs-comment"><span class="hljs-comment">//    this.wsConfig.ignore.push(...topics); } }</span></span></code> </pre> <br>  Eliminar eventos del ignorelista: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runtimeRemoveIgnore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">topics: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (topics &amp;&amp; topics.length) { topics.forEach((topic: <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">//      const topicIndex = this.wsConfig.ignore.findIndex(t =&gt; t === topic); if (topicIndex &gt; -1) { //    this.wsConfig.ignore.splice(topicIndex, 1); } }); } }</span></span></code> </pre> <br>  Conectamos el m√≥dulo de sockets web: <br><br><pre> <code class="hljs powershell">@NgModule({ declarations: [ <span class="hljs-type"><span class="hljs-type">AppComponent</span></span> ], imports: [ <span class="hljs-type"><span class="hljs-type">BrowserModule</span></span>, <span class="hljs-type"><span class="hljs-type">ReactiveFormsModule</span></span>, <span class="hljs-type"><span class="hljs-type">WebsocketModule.config</span></span>({ <span class="hljs-type"><span class="hljs-type">url</span></span>: <span class="hljs-type"><span class="hljs-type">environment.ws</span></span>, //  <span class="hljs-string"><span class="hljs-string">"ws://mywebsocketurl"</span></span> //    <span class="hljs-type"><span class="hljs-type">ignore</span></span>: [<span class="hljs-type"><span class="hljs-type">WS_API.EVENTS.ANY_1</span></span>, <span class="hljs-type"><span class="hljs-type">WS_API.EVENTS.ANY_2</span></span>], <span class="hljs-type"><span class="hljs-type">garbageCollectInterval</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, //    <span class="hljs-type"><span class="hljs-type">options</span></span>: { <span class="hljs-type"><span class="hljs-type">connectionTimeout</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, //   <span class="hljs-type"><span class="hljs-type">maxRetries</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> //   } }) ], providers: [], bootstrap: [<span class="hljs-type"><span class="hljs-type">AppComponent</span></span>] }) export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span></span> { }</code> </pre> <br>  Usamos en los componentes: <br><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Component({ selector: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'app-root'</span></span></span><span class="hljs-meta">, templateUrl: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.html'</span></span></span><span class="hljs-meta">, styleUrls: [</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'./app.component.css'</span></span></span><span class="hljs-meta">] })</span></span> export <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OnDestroy { private messages$: Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">messagesMulti</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IMessage[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">counter</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">number</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">texts</span></span></span><span class="hljs-class">$: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Observable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">string[]</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">form</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FormGroup; constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> fb: FormBuilder, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> wsService: WebsocketService) { } ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.form = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fb.group({ text: [<span class="hljs-literal"><span class="hljs-literal">null</span></span>, [ Validators.required ]] }); <span class="hljs-comment"><span class="hljs-comment">// get messages this.messages$ = this.wsService .addEventListener&lt;IMessage[]&gt;(WS_API.EVENTS.MESSAGES); // get messages multi this.messagesMulti$ = this.wsService .addEventListener&lt;IMessage[]&gt;([ WS_API.EVENTS.MESSAGES, WS_API.EVENTS.MESSAGES_1 ]); // get counter this.counter$ = this.wsService .addEventListener&lt;number&gt;(WS_API.EVENTS.COUNTER); // get texts this.texts$ = this.wsService .addEventListener&lt;string[]&gt;(WS_API.EVENTS.UPDATE_TEXTS); } ngOnDestroy() { } public sendText(): void { if (this.form.valid) { this.wsService .sendMessage(WS_API.COMMANDS.SEND_TEXT, this.form.value.text); this.form.reset(); } } public removeText(index: number): void { this.wsService.sendMessage(WS_API.COMMANDS.REMOVE_TEXT, index); } }</span></span></code> </pre> <br>  El servicio est√° listo para usar. <br><br><hr><br>  Aunque el ejemplo del art√≠culo no es una soluci√≥n universal para cada proyecto, demuestra uno de los enfoques para trabajar con sockets web en aplicaciones grandes y complejas.  Puede ponerlo en servicio y modificarlo seg√∫n las tareas actuales. <br><br>  La versi√≥n completa del servicio se puede encontrar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . <br><br>  Para todas las preguntas puede contactarme en los comentarios, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">a m√≠</a> en Telegram o en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el canal Angular</a> en el mismo lugar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es419099/">https://habr.com/ru/post/es419099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es419087/index.html">Comprender la mente de otra persona es un mito</a></li>
<li><a href="../es419089/index.html">C√≥mo hacer trampa al jugar a los dados - consejos de expertos del juego</a></li>
<li><a href="../es419091/index.html">Objetos radiactivos entre nosotros</a></li>
<li><a href="../es419095/index.html">Escribimos CSS mejor y m√°s hermoso</a></li>
<li><a href="../es419097/index.html">Mambot: un bot en Telegram para mujeres embarazadas</a></li>
<li><a href="../es419101/index.html">Crea un juego en el hackathon nocturno</a></li>
<li><a href="../es419103/index.html">Escribir un traductor simple en Lisp - I</a></li>
<li><a href="../es419105/index.html">Enlace a la transmisi√≥n de Slurm (Intensivo de Kubernetes)</a></li>
<li><a href="../es419107/index.html">Descripci√≥n general de la parte del archivo de Dell EMC Unity y ejemplos de configuraci√≥n</a></li>
<li><a href="../es419109/index.html">Explica las explosiones en Android P. ¬øQu√© hacer con Android Cutout?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>