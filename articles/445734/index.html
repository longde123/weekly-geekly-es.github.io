<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游놐 游 咎왪잺 Obtener campa침as de publicidad directa de Yandex usando una API en un DataFrame (Python) 游닕 游땸 游녦游</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cuando se trabaja con varios clientes a la vez, se hace necesario analizar r치pidamente mucha informaci칩n en diferentes cuentas e informes. Cuando hay ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Obtener campa침as de publicidad directa de Yandex usando una API en un DataFrame (Python)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445734/">  Cuando se trabaja con varios clientes a la vez, se hace necesario analizar r치pidamente mucha informaci칩n en diferentes cuentas e informes.  Cuando hay m치s de 10 clientes, el vendedor ya no tiene tiempo para monitorear constantemente las estad칤sticas.  Pero hay un camino. <br><br>  En este art칤culo, hablar칠 sobre c칩mo monitorear cuentas publicitarias usando la API y Python. <br><br>  A la salida, recibiremos una solicitud para la API Yandex.Direct, con la que recibiremos estad칤sticas sobre campa침as publicitarias y podremos procesar estos datos. <br><br>  Para esto necesitamos: <br><br><ol><li>  Obtenga Yandex Direct API Token </li><li>  Escribir una solicitud de servidor </li><li>  Importar datos a DataFrame </li></ol><a name="habracut"></a><br><h4>  Importar bibliotecas </h4><br>  Debe importar las bibliotecas que se utilizan en la consulta, as칤 como pandas y DataFrame. <br><br>  Todas las importaciones se ver치n as칤: <br><br><pre><code class="plaintext hljs">import requests from requests.exceptions import ConnectionError from time import sleep import json import pandas as pd import numpy as np from pandas import Series,DataFrame</code> </pre> <br><h4>  Recibiendo token </h4><br>  En este momento no puedo decir mejor que la documentaci칩n de API Direct, por lo que dejar칠 un enlace. <br><br>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Instrucciones para obtener un token</a> ) <br><br><h4>  Estamos escribiendo una solicitud al servidor Yandex.Direct API </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Copie la solicitud de la documentaci칩n de la API</a> <br><br>  <b>Cambiar la solicitud</b> <br><br><ul><li>  Prescribe tu token e inicia sesi칩n </li></ul><br>  Token <br><br>  token = 'blaBlaBLAblaBLABLABLAblabla' <br><br>  Iniciar sesi칩n <br><br>  clientLogin = 'e-66666666' <br><br><ul><li>  Ajustamos el cuerpo de la solicitud por nosotros mismos. </li></ul><br>  De esto <br><br><pre> <code class="plaintext hljs">body = { "params": { "SelectionCriteria": { "DateFrom": "_", "DateTo": "_" }, "FieldNames": [ "Date", "CampaignName", "LocationOfPresenceName", "Impressions", "Clicks", "Cost" ], "ReportName": u("_"), "ReportType": "CAMPAIGN_PERFORMANCE_REPORT", "DateRangeType": "CUSTOM_DATE", "Format": "TSV", "IncludeVAT": "NO", "IncludeDiscount": "NO"</code> </pre> <br>  Hazlo <br><br><pre> <code class="plaintext hljs"> body = { "params": { "SelectionCriteria": { "Filter": [ { "Field": "Clicks", "Operator": "GREATER_THAN", "Values": [ "0" ] }, ] }, "FieldNames": [ "CampaignName", "Impressions", "Clicks", "Ctr", "Cost", "AvgCpc", "BounceRate", "AvgPageviews", "ConversionRate", "CostPerConversion", "Conversions" ], "ReportName": u("Report4"), "ReportType": 춺 ", "DateRangeType": "LAST_5_DAYS", "Format": "TSV", "IncludeVAT": "NO", "IncludeDiscount": "NO" } }</code> </pre> <br>  En <b>SelectionCriteria</b> escribimos c칩mo seleccionaremos los datos.  Por defecto, se escriben 2 fechas all칤, pero para no tener que cambiarlas constantemente, reemplazaremos el per칤odo de tiempo con "칔ltimos 5 d칤as". <br><br>  <b>Configuramos el filtro para los datos</b> .  Esto se requiere principalmente para no obtener valores vac칤os.  El problema es que Direct muestra los datos faltantes como dos desventajas, debido a que cambia el tipo de datos de toda la columna, despu칠s de lo cual no puede realizar operaciones matem치ticas sin gestos innecesarios. <br><br>  <b>FieldNames</b>  Escribimos aqu칤 los datos que necesita.  Registr칠 los campos que uso para el an치lisis, su lista puede diferir. <br><br>  <b>ReportType</b>  El tipo de informe se escribe en este campo, para las campa침as se necesita este informe. <br><br>  Deber칤as obtener algo como esto. <br><br><img src="https://imagizer.imageshack.com/img923/6747/G4Hz4e.png" alt="imagen"><br><br>  5. Importe los datos a un DataFrame. <br><br>  (Un DataFrame es probablemente la forma m치s adecuada de trabajar con estos datos). <br><br>  Pude implementar esta funci칩n escribiendo y leyendo un archivo csv. <br>  Encontramos en la consulta la pieza responsable de la salida de estad칤sticas: esto es "req.text". <br><br>  Eliminamos la salida est치ndar del programa para escribir en el archivo.  Para hacer esto, cambie todas las conclusiones en el c칩digo 200. <br><br><pre> <code class="plaintext hljs"> print("  ") print("RequestId: {}".format(req.headers.get("RequestId", False))) print(" : \n{}췉.format(u(req.text)))</code> </pre> <br>  En: <br><br><pre> <code class="plaintext hljs"> format(u(req.text))</code> </pre> <br>  Ahora importe la respuesta del servidor al DataFrame. <br><br><pre> <code class="plaintext hljs"> file = open("cashe.csv", "w") file.write(req.text) file.close() f = DataFrame.from_csv("cashe.csv",header=1, sep=' ', index_col=0,)</code> </pre> <br>  Paso a paso: <br><br><ul><li>  Abra (y cree autom치ticamente) el archivo cashe.csv para escribir </li><li>  Escribimos la respuesta del servidor </li><li>  Cerrar el archivo </li><li>  Abra el archivo como un DataFrame (especifique el nombre del archivo, en qu칠 fila est치n los encabezados de la tabla, cu치l es el divisor entre los datos, en qu칠 columna est치 el 칤ndice) </li></ul><br>  Result칩 lo siguiente: <br><br><img src="https://imagizer.imageshack.com/img923/8646/jQ4uBP.png" alt="imagen"><br><br>  Eliminamos la restricci칩n en la salida de columnas: <br><br><pre> <code class="plaintext hljs"> pd.set_option('display.max_columns', None) pd.set_option('display.expand_frame_repr', False) pd.set_option('max_colwidth', -1)</code> </pre> <br>  Ahora todo se muestra: <br><br><img src="https://imagizer.imageshack.com/img924/87/fY7apw.png" alt="imagen"><br><br>  El 칰nico problema es que los valores monetarios no se muestran como les gustar칤a.  Estas son las caracter칤sticas de la implementaci칩n de la API Yandex.Direct.  Solo necesitamos dividir los valores monetarios por 1,000,000. <br><br><pre> <code class="plaintext hljs">f['Cost'] = f['Cost']/1000000 f['AvgCpc'] = f['AvgCpc']/1000000 f['CostPerConversion'] = f['CostPerConversion']/1000000</code> </pre> <br>  Tambi칠n sugiero ordenar inmediatamente por el n칰mero de clics <br><br><pre> <code class="plaintext hljs">f=f.sort_values(by=['Clicks'], ascending=False)</code> </pre> <br>  As칤 que preparamos DataFrame para el an치lisis <br><br><img src="https://imagizer.imageshack.com/img922/3497/fftBUP.png" alt="imagen"><br><br>  Para m칤, escrib칤 solicitudes similares de estad칤sticas por d칤a y por campa침a, para estar siempre al tanto de las desviaciones del tr치fico y comprender d칩nde ocurri칩 aproximadamente la desviaci칩n. <br><br>  Gracias por su atencion <br><br><div class="spoiler">  <b class="spoiler_title">C칩digo final:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import requests from requests.exceptions import ConnectionError from time import sleep import json import pandas as pd import numpy as np from pandas import Series,DataFrame pd.set_option('display.max_columns', None) pd.set_option('display.expand_frame_repr', False) pd.set_option('max_colwidth', -1) #        UTF-8   Python 3,    Python 2 import sys if sys.version_info &lt; (3,): def u(x): try: return x.encode("utf8") except UnicodeDecodeError: return x else: def u(x): if type(x) == type(b''): return x.decode('utf8') else: return x # ---   --- #   Reports   JSON- () ReportsURL = 'https://api.direct.yandex.com/json/v5/reports' # OAuth- ,       token = ' ' #     #  ,        clientLogin = ' ' # ---   --- #  HTTP-  headers = { # OAuth-.   Bearer  "Authorization": "Bearer " + token, #     "Client-Login": clientLogin, #    "Accept-Language": "ru", #    "processingMode": "auto" #      # "returnMoneyInMicros": "false", #            # "skipReportHeader": "true", #         # "skipColumnHeader": "true", #          # "skipReportSummary": "true" } #    body = { "params": { "SelectionCriteria": { "Filter": [ { "Field": "Clicks", "Operator": "GREATER_THAN", "Values": [ "0" ] }, ] }, "FieldNames": [ "CampaignName", "Impressions", "Clicks", "Ctr", "Cost", "AvgCpc", "BounceRate", "AvgPageviews", "ConversionRate", "CostPerConversion", "Conversions" ], "ReportName": u("Report4"), "ReportType": "CAMPAIGN_PERFORMANCE_REPORT", "DateRangeType": "LAST_5_DAYS", "Format": "TSV", "IncludeVAT": "NO", "IncludeDiscount": "NO" } } #     JSON body = json.dumps(body, indent=4) # ---      --- #   HTTP- 200,     #   HTTP- 201  202,    while True: try: req = requests.post(ReportsURL, body, headers=headers) req.encoding = 'utf-8' #      UTF-8 if req.status_code == 400: print("         ") print("RequestId: {}".format(req.headers.get("RequestId", False))) print("JSON- : {}".format(u(body))) print("JSON-  : \n{}".format(u(req.json()))) break elif req.status_code == 200: format(u(req.text)) break elif req.status_code == 201: print("       ") retryIn = int(req.headers.get("retryIn", 60)) print("    {} ".format(retryIn)) print("RequestId: {}".format(req.headers.get("RequestId", False))) sleep(retryIn) elif req.status_code == 202: print("    ") retryIn = int(req.headers.get("retryIn", 60)) print("    {} ".format(retryIn)) print("RequestId: {}".format(req.headers.get("RequestId", False))) sleep(retryIn) elif req.status_code == 500: print("    . ,    ") print("RequestId: {}".format(req.headers.get("RequestId", False))) print("JSON-  : \n{}".format(u(req.json()))) break elif req.status_code == 502: print("     .") print(",     -      .") print("JSON- : {}".format(body)) print("RequestId: {}".format(req.headers.get("RequestId", False))) print("JSON-  : \n{}".format(u(req.json()))) break else: print("  ") print("RequestId: {}".format(req.headers.get("RequestId", False))) print("JSON- : {}".format(body)) print("JSON-  : \n{}".format(u(req.json()))) break #  ,       API  except ConnectionError: #         print("     API") #     break #   -   except: #         print("  ") #     break file = open("cashe.csv", "w") file.write(req.text) file.close() f = DataFrame.from_csv("cashe.csv",header=1, sep=' ', index_col=0,) f['Cost'] = f['Cost']/1000000 f['AvgCpc'] = f['AvgCpc']/1000000 f['CostPerConversion'] = f['CostPerConversion']/1000000 f=f.sort_values(by=['Clicks'], ascending=False) print(f)</code> </pre> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/445734/">https://habr.com/ru/post/445734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445720/index.html">Los rusos recibir치n un perfil digital</a></li>
<li><a href="../445722/index.html">Juguemos libros: 쯤u칠 son los libros de juego y cu치les vale la pena probar?</a></li>
<li><a href="../445724/index.html">Reparaci칩n de clientes de WSUS</a></li>
<li><a href="../445726/index.html">El uso del aprendizaje autom치tico para analizar una gran cantidad de comentarios de los encuestados</a></li>
<li><a href="../445730/index.html">Los fundadores de la teor칤a de los sistemas distribuidos en los brazos de la hidra.</a></li>
<li><a href="../445736/index.html">Una breve historia de formatos musicales inusuales</a></li>
<li><a href="../445740/index.html">El gato debajo del cap칩. Parte 1</a></li>
<li><a href="../445742/index.html">Est치ndares de IoT, redes, tres tablas.</a></li>
<li><a href="../445744/index.html">Teor칤a y pr치ctica de un hobby para un profesional de TI.</a></li>
<li><a href="../445756/index.html">Informes en video de la reuni칩n de iOS # 1 de FunTech</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>