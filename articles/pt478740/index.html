<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëë üöó üåÇ V√° em frente! Como a equipe do PHP levou a escrever microsservi√ßos ü§±üèæ üë©üèΩ ‚ùî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Meu nome √© Alexey Skorobogaty, sou arquiteto de sistemas na Lamoda. Em fevereiro de 2019, falei no Go Meetup enquanto ainda estava na pos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>V√° em frente! Como a equipe do PHP levou a escrever microsservi√ßos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/478740/"><p>  Ol√° pessoal!  Meu nome √© Alexey Skorobogaty, sou arquiteto de sistemas na Lamoda.  Em fevereiro de 2019, falei no Go Meetup enquanto ainda estava na posi√ß√£o de l√≠der da equipe Core.  Hoje, quero apresentar uma transcri√ß√£o do meu relat√≥rio, que voc√™ tamb√©m pode <a href="https://www.youtube.com/watch%3Fv%3DF5IVE0IpGJY%26t%3D4s">ver.</a> </p><br><p>  Nossa equipe se chama Core por um motivo: a √°rea de responsabilidade inclui tudo relacionado a pedidos na plataforma de com√©rcio eletr√¥nico.  A equipe foi formada por desenvolvedores e especialistas em PHP em nosso processamento de pedidos, que na √©poca era um √∫nico mon√≥lito.  Est√°vamos envolvidos e continuamos a lidar com sua decomposi√ß√£o em microsservi√ßos. </p><br><p><img src="https://habrastorage.org/webt/qu/71/2m/qu712m7duwr6k_fcoworp0io0go.png" alt="imagem"></p><a name="habracut"></a><br><p>  Um pedido em nosso sistema consiste em componentes relacionados: existe uma unidade de entrega e uma cesta, unidades de desconto e pagamento e, no final, existe um bot√£o que envia o pedido a ser coletado no armaz√©m.  √â nesse momento que come√ßa o trabalho do sistema de processamento de pedidos, onde todos os dados do pedido ser√£o validados e as informa√ß√µes agregadas. </p><br><p><img src="https://habrastorage.org/webt/pm/va/0h/pmva0huzhbmc7szecb-088cnlz8.png" alt="imagem"></p><br><p>  Dentro de tudo isso, est√° complexa l√≥gica multicrit√©rio.  Os blocos interagem entre si e se influenciam.  Mudan√ßas cont√≠nuas e constantes dos neg√≥cios aumentam a complexidade dos crit√©rios.  Al√©m disso, temos diferentes plataformas atrav√©s das quais os clientes podem criar pedidos: site, aplicativos, call center, plataforma B2B.  Bem como crit√©rios rigorosos de SLA / MTTI / MTTR (m√©tricas de registro e resolu√ß√£o de incidentes).  Tudo isso requer alta flexibilidade e estabilidade do servi√ßo. </p><br><h3 id="arhitekturnoe-nasledie">  Patrim√¥nio arquitet√¥nico </h3><br><p>  Como eu j√° disse, no momento da forma√ß√£o de nossa equipe, o sistema de processamento de pedidos era um mon√≥lito - quase 100 mil linhas de c√≥digo que descreviam diretamente a l√≥gica de neg√≥cios.  A parte principal foi escrita em 2011 usando a arquitetura MVC cl√°ssica de v√°rias camadas.  Foi baseado no PHP (framework ZF1), que foi gradualmente coberto de adaptadores e componentes symfony para interagir com v√°rios servi√ßos.  Durante a sua exist√™ncia, o sistema teve mais de 50 colaboradores e, embora tenhamos conseguido manter um estilo unificado de escrever c√≥digo, isso tamb√©m imp√¥s suas limita√ß√µes.  Al√©m disso, surgiu um grande n√∫mero de contextos mistos - por v√°rias raz√µes, alguns mecanismos foram implementados no sistema que n√£o estavam diretamente relacionados ao processamento de pedidos.  Tudo isso levou ao fato de que, no momento, temos um banco de dados MySQL maior que 1 terabyte. </p><br><p> Esquematicamente, a arquitetura inicial pode ser representada da seguinte maneira: </p><br><p><img src="https://habrastorage.org/webt/go/cd/ht/gocdht4rqheqf9wgfglpwbfqir4.png" alt="imagem"></p><br><p>  A ordem, √© claro, estava em cada uma das camadas - mas, al√©m da ordem, havia outros contextos.  Come√ßamos definindo o contexto delimitado do pedido e chamando-o de Pedido do Cliente, pois al√©m do pr√≥prio pedido, existem os mesmos blocos que mencionei no in√≠cio: entrega, pagamento, etc.  Dentro do mon√≥lito, tudo isso era dif√≠cil de gerenciar: quaisquer altera√ß√µes levavam a um aumento de depend√™ncias, o c√≥digo era entregue ao produto por um per√≠odo muito longo e a probabilidade de erros e falha do sistema aumentava o tempo todo.  Mas estamos falando sobre a cria√ß√£o de um pedido, a principal m√©trica de uma loja online - se os pedidos n√£o forem criados, o restante n√£o ser√° t√£o importante.  A falha do sistema causa uma queda imediata nas vendas. </p><br><p>  Portanto, decidimos transferir o contexto de Pedido do Cliente do sistema de Processamento de Pedidos para um microsservi√ßo separado, chamado Gerenciamento de Pedidos. </p><br><p><img src="https://habrastorage.org/webt/dh/ce/sc/dhcesca21xejoakcoz4doqe6-qy.png" alt="imagem"></p><br><h3 id="trebovaniya-i-instrumentariy">  Requisitos e Ferramentas </h3><br><p>  Depois de determinar o contexto que decidimos remover do mon√≥lito, criamos os requisitos para o nosso servi√ßo futuro: </p><br><ul><li>  Desempenho </li><li>  Consist√™ncia dos dados </li><li>  Sustentabilidade </li><li>  Previsibilidade </li><li>  Transpar√™ncia </li><li>  Incremento de mudan√ßa </li></ul><br><p>  Quer√≠amos que o c√≥digo fosse o mais claro e f√°cil de editar poss√≠vel, para que a pr√≥xima gera√ß√£o de desenvolvedores pudesse fazer rapidamente as altera√ß√µes necess√°rias para os neg√≥cios. </p><br><p>  Como resultado, chegamos a uma certa estrutura que usamos em todos os novos microsservi√ßos: </p><br><p>  <strong>Contexto limitado</strong> .  Cada novo microsservi√ßo, come√ßando com o Gerenciamento de pedidos, criamos com base nos requisitos de neg√≥cios.  Deve haver explica√ß√µes espec√≠ficas sobre qual parte do sistema e por que √© necess√°rio coloc√°-lo em um microsservi√ßo separado. </p><br><p>  <strong>Infraestrutura e ferramentas existentes.</strong>  N√£o somos a primeira equipe em Lamoda a come√ßar a implementar o Go, fomos pioneiros diante de n√≥s - a pr√≥pria equipe do Go, que preparou a infraestrutura e as ferramentas: </p><br><ol><li>  Gogi (swagger) √© um gerador de especifica√ß√£o de swagger. </li><li>  Gonkey (teste) - para testes funcionais. </li><li>  Utilizamos o Json-rpc e geramos uma liga√ß√£o cliente / servidor por meio do swagger.  Tamb√©m implantamos tudo isso no Kubernetes, coletamos m√©tricas no Prometheus, usamos o ELK / Jaeger para rastreamento - tudo isso est√° inclu√≠do no pacote que o Gogi cria para cada novo microsservi√ßo por especifica√ß√£o. </li></ol><br><p>  √â assim que √© o nosso novo microsservi√ßo de Gerenciamento de Pedidos: </p><br><p><img src="https://habrastorage.org/webt/dl/1o/qk/dl1oqkgxhptthhlh-3wgn55q2jm.png" alt="imagem"></p><br><p>  Na entrada, temos dados, agregamos, validamos, interagimos com servi√ßos de terceiros, tomamos decis√µes e transferimos os resultados ainda mais para o Processamento de pedidos - o mesmo mon√≥lito grande, inst√°vel e que demanda recursos.  Isso tamb√©m precisa ser considerado ao criar um microsservi√ßo. </p><br><h3 id="sdvig-paradigmy">  Mudan√ßa de paradigma </h3><br><p>  Ao escolher Go, obtivemos imediatamente v√°rias vantagens: </p><br><ul><li>  <strong>A digita√ß√£o forte est√°tica</strong> corta imediatamente um certo intervalo de poss√≠veis erros. </li><li>  <strong>O modelo de simultaneidade</strong> se encaixa bem em nossas tarefas, pois precisamos caminhar e pesquisar simultaneamente v√°rios servi√ßos. </li><li>  <strong>Composi√ß√£o e interfaces tamb√©m</strong> nos ajudam nos testes. </li><li>  <strong>A "simplicidade" do estudo</strong> - foi aqui que descobriram n√£o apenas vantagens √≥bvias, mas tamb√©m problemas. </li></ul><br><p>  A linguagem Go limita a imagina√ß√£o do desenvolvedor.  Isso se tornou um obst√°culo para nossa equipe, acostumada ao PHP quando mudamos para o desenvolvimento no Go.  Estamos diante de uma verdadeira mudan√ßa de paradigma.  Tivemos que passar por v√°rias etapas e entender algumas coisas: </p><br><ol><li>  Ir √© dif√≠cil na constru√ß√£o de abstra√ß√µes. </li><li>  Pode-se dizer que Go √© baseado em objetos, mas n√£o uma linguagem orientada a objetos, pois n√£o h√° heran√ßa direta e outras coisas. </li><li>  O Go ajuda a escrever explicitamente, em vez de ocultar objetos atr√°s de abstra√ß√µes. </li><li>  Go tem pipelining.  Isso nos inspirou a construir cadeias de processadores de dados. </li></ol><br><p>  Como resultado, chegamos a entender que o <strong>Go √© uma linguagem de programa√ß√£o procedural.</strong> <br><img src="https://habrastorage.org/webt/i7/yl/hb/i7ylhb2z0jpa2xivzfbwr6vbj-o.png" alt="imagem"></p><br><h3 id="data-first">  Dados primeiro </h3><br><p>  Eu estava pensando em como visualizar o problema que est√°vamos enfrentando e me deparei com esta imagem: </p><br><p><img src="https://habrastorage.org/webt/7j/4d/i8/7j4di8db5uuv2swuxpwdqg3nalg.png" alt="imagem"></p><br><p>  Esta √© uma vis√£o "orientada a objetos" do mundo, onde constru√≠mos abstra√ß√µes e fechamos objetos por tr√°s delas.  Por exemplo, aqui n√£o √© apenas uma porta, mas um Inicializador de sess√£o interna.  N√£o o aluno, mas a Interface do Monitor do Visitante - e assim por diante. </p><br><p>  Abandonamos essa abordagem e colocamos as entidades em primeiro lugar, sem ficar obscurecidas pelas abstra√ß√µes. </p><br><p>  Racioc√≠nio dessa maneira, colocamos os dados em primeiro lugar e obtivemos esse pipelining no servi√ßo: </p><br><p><img src="https://habrastorage.org/webt/-2/nv/nb/-2nvnbuuplectds4ysnfddoae-c.png" alt="imagem"></p><br><p>  Inicialmente, definimos um modelo de dados que entra no pipeline do manipulador.  Os dados s√£o mut√°veis ‚Äã‚Äãe as altera√ß√µes podem ocorrer sequencialmente e simultaneamente.  Com isso, ganhamos em velocidade. </p><br><h3 id="nazad-v-buduschee">  De volta ao futuro </h3><br><p>  De repente, desenvolvendo microsservi√ßos, chegamos ao modelo de programa√ß√£o dos anos 70.  Ap√≥s os anos 70, surgiram grandes mon√≥litos corporativos, onde apareceu a programa√ß√£o orientada a objetos e a programa√ß√£o funcional - grandes abstra√ß√µes que tornaram poss√≠vel manter o c√≥digo nesses mon√≥litos.  Nos microsservi√ßos, n√£o precisamos de tudo isso, e podemos usar o excelente modelo de CSP ( <em>comunica√ß√£o de processos sequenciais</em> ), cuja ideia foi <a href="https://www.cs.cmu.edu/~crary/819-f09/Hoare78.pdf">apresentada nos anos 70 por Charles Choir.</a> <a href="https://www.cs.cmu.edu/~crary/819-f09/Hoare78.pdf"><br></a> </p><br><p>  Tamb√©m usamos Sequ√™ncia / Sele√ß√£o / Intera√ß√£o - um paradigma de programa√ß√£o estrutural segundo o qual todo o c√≥digo de programa pode ser composto pelas estruturas de controle correspondentes. </p><br><p>  Bem, programa√ß√£o procedural, que era a corrente principal nos anos 70 :) </p><br><h3 id="struktura-proekta">  Estrutura do projeto </h3><br><p><img src="https://habrastorage.org/webt/oe/xr/kj/oexrkjhvj4sf1zrx_kuyhvytb58.png" alt="imagem"></p><br><p>  Como eu disse, em primeiro lugar, colocamos os dados.  Al√©m disso, substitu√≠mos a constru√ß√£o do projeto ‚Äúda infraestrutura‚Äù por uma orientada para os neg√≥cios.  Para que o desenvolvedor, inserindo o c√≥digo do projeto, veja imediatamente o que o servi√ßo est√° fazendo - essa √© a pr√≥pria transpar√™ncia que identificamos como um dos requisitos b√°sicos para a estrutura de nossos microsservi√ßos. </p><br><p>  Como resultado, temos uma arquitetura plana: uma pequena camada de API mais modelos de dados.  E toda a l√≥gica (que √© limitada em nosso contexto pelos requisitos de neg√≥cios de um microsservi√ßo) √© armazenada nos processadores (manipuladores). </p><br><p>  Tentamos n√£o criar novos microsservi√ßos separados sem uma solicita√ß√£o clara da empresa - √© assim que controlamos a granularidade de todo o sistema.  Se existe uma l√≥gica que est√° intimamente relacionada ao microsservi√ßo existente, mas se refere essencialmente a um contexto diferente, conclu√≠mos primeiro nos chamados servi√ßos.  E somente quando uma necessidade constante de neg√≥cios surge, n√≥s a transferimos para um microsservi√ßo separado, que passamos a usar uma chamada rpc. </p><br><p>  Para controlar a granularidade e n√£o produzir microsservi√ßos sem pensar, conclu√≠mos uma l√≥gica que n√£o est√° diretamente relacionada a esse contexto, mas que est√° intimamente relacionada a esse microsservi√ßo, na camada de servi√ßos.  E ent√£o, se houver uma necessidade comercial, levamos para um microsservi√ßo separado - e depois o usamos com a chamada rpc para acess√°-lo. </p><br><p><img src="https://habrastorage.org/webt/yh/ra/yp/yhraypbd9hd2b6uxu6t83cxgjh4.png" alt="imagem"></p><br><p>  Portanto, para a API interna nos processadores do servi√ßo, a intera√ß√£o n√£o muda de forma alguma. </p><br><h3 id="ustoychivost">  Sustentabilidade </h3><br><p>  Decidimos n√£o usar bibliotecas de terceiros com anteced√™ncia, pois os dados com os quais trabalhamos s√£o bastante sens√≠veis.  Por isso, pedalamos um pouco :) Por exemplo, n√≥s mesmos implementamos alguns mecanismos cl√°ssicos - para idempot√™ncia, trabalhador de filas, toler√¢ncia a falhas e transa√ß√µes de compensa√ß√£o.  Nosso pr√≥ximo passo √© tentar reutiliz√°-lo.  Enrole em bibliotecas, talvez em cont√™ineres laterais nos Kubernetes Pods.  Mas agora podemos aplicar esses padr√µes. </p><br><p>  Implementamos em nossos sistemas um padr√£o chamado degrada√ß√£o graciosa: o servi√ßo deve continuar funcionando, independentemente das chamadas externas nas quais agregamos informa√ß√µes.  No exemplo da cria√ß√£o de um pedido: se o pedido entrar no servi√ßo, criaremos um pedido em qualquer caso.  Mesmo se o servi√ßo vizinho cair, o que √© respons√°vel por parte da informa√ß√£o que devemos agregar ou validar.  Al√©m disso - n√£o perderemos o pedido, mesmo que n√£o possamos, a curto prazo, recusar o processamento do pedido, para onde devemos transferir.  Esse tamb√©m √© um dos crit√©rios pelos quais decidimos colocar a l√≥gica em um servi√ßo separado.  Se o servi√ßo n√£o puder fornecer seu trabalho quando os seguintes servi√ßos n√£o estiverem dispon√≠veis na rede, voc√™ precisar√° reprojet√°-lo ou pensar se ele deve ser retirado do mon√≥lito. </p><br><h3 id="go-v-go">  V√° em frente! </h3><br><p>  Quando voc√™ escreve microsservi√ßos de produtos orientados a neg√≥cios a partir de uma arquitetura cl√°ssica orientada a servi√ßos, em particular o PHP, encontra uma mudan√ßa de paradigma.  E isso deve ser passado, caso contr√°rio, voc√™ pode entrar no rake sem parar.  A estrutura de neg√≥cios do projeto nos permite n√£o complicar o c√≥digo mais uma vez e controlar a granularidade do servi√ßo. </p><br><p>  Uma de nossas principais tarefas era aumentar a estabilidade do servi√ßo.  Obviamente, o Go n√£o fornece maior estabilidade apenas fora da caixa.  Mas, na minha opini√£o, no ecossistema Go, ficou mais f√°cil criar todo o kit de Confiabilidade necess√°rio, mesmo com suas pr√≥prias m√£os, sem recorrer a bibliotecas de terceiros. </p><br><p>  Outra tarefa importante foi aumentar a flexibilidade do sistema.  E aqui posso dizer definitivamente que a taxa de introdu√ß√£o de mudan√ßas exigidas pela empresa cresceu significativamente.  Gra√ßas √† arquitetura dos novos microsservi√ßos, o desenvolvedor fica sozinho com os recursos de neg√≥cios; ele n√£o precisa pensar em criar clientes, enviar monitoramento, enviar rastreamento e configurar o log.  Deixamos para o desenvolvedor exatamente a camada de escrita da l√≥gica de neg√≥cios, permitindo que ele n√£o pense em todo o pacote de infraestrutura. </p><br><p>  Vamos reescrever tudo no Go e abandonar o PHP? </p><br><p>  N√£o, j√° que estamos nos afastando das necessidades dos neg√≥cios e h√° alguns contextos nos quais o PHP se encaixa muito bem - ele n√£o precisa dessa velocidade e de todo o kit de ferramentas Go-go.  Toda a automa√ß√£o das opera√ß√µes para entrega de pedidos e gerenciamento de est√∫dio de fotografia √© feita em PHP.  Mas, por exemplo, na plataforma de com√©rcio eletr√¥nico no lado do cliente, quase reescrevemos tudo no Go, pois √© justific√°vel. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt478740/">https://habr.com/ru/post/pt478740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt478722/index.html">Seis receitas para um l√≠der de equipe iniciante: como acompanhar tudo e desenvolver uma equipe</a></li>
<li><a href="../pt478726/index.html">OWASP Moscow Meetup # 9</a></li>
<li><a href="../pt478728/index.html">As 9 melhores descobertas de c√≥digo aberto para novembro de 2019</a></li>
<li><a href="../pt478734/index.html">Bot√µes de forma personalizada na interface do usu√°rio do Unity</a></li>
<li><a href="../pt478736/index.html">O futuro da intelig√™ncia artificial no sistema educacional: tudo o que se deve saber</a></li>
<li><a href="../pt478748/index.html">Teste de confiabilidade dos SSDs: 3dnews vs JEDEC vs senso comum. Onde est√° a verdade, irm√£o?</a></li>
<li><a href="../pt478750/index.html">Bibliotecas de visualiza√ß√£o de dados reais para desenvolvedores de rea√ß√£o</a></li>
<li><a href="../pt478752/index.html">Hist√≥ria dos sistemas de controle de vers√£o</a></li>
<li><a href="../pt478758/index.html">√ìtimo guia de tags UTM: como descobrir de onde os usu√°rios v√™m</a></li>
<li><a href="../pt478760/index.html">Inferno "zero" e como sair dele</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>