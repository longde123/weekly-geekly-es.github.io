<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤱🏿 🖨️ ✌🏾 Kami dari tes lain - kami sedang menguji database di MSTest 🤲🏽 🦁 🖼️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pengujian sebagai prinsip universal 
 Kami telah merayakan milenium selama hampir seperempat abad, dan pengujian baru saja memasuki hidup kami ... Sul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kami dari tes lain - kami sedang menguji database di MSTest</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481474/"><h4>  Pengujian sebagai prinsip universal </h4><br>  Kami telah merayakan milenium selama hampir seperempat abad, dan pengujian baru saja memasuki hidup kami ... Sulit meyakinkan pengembang pemula untuk menggunakan teknik luar biasa ini dalam pekerjaan mereka ... Apa yang bisa kami katakan tentang pengembang, hanya manusia, dan tidak selalu mungkin untuk memahami bahwa pengujian adalah dasar sistem berkelanjutan!  Betapa sulitnya meyakinkan seorang pramuniaga bahwa menguji suatu produk baru tidak berarti memakannya!  Bahkan penjaga keamanan berpengalaman jelas bekerja dengan cara lama - mereka mencoba untuk mengejar ketinggalan dan memilih tes.  Dan Anda tidak akan membuktikan kepada mereka bahwa jika Tuhan Allah sendiri tidak merendahkan untuk menggunakan TDD dalam karyanya (ingat Banjir Besar), maka, seperti yang mereka katakan, Tuhan sendiri memerintahkan ... <br><br>  Jumlah perceraian meningkat - mengapa?  Ya sama saja!  TDD!  Tes dulu - lalu menikah!  Tidak, laki-laki kecil yang mudah tertipu dalam mantel kulit domba yang longgar, ingin iklan yang mengeksploitasi seks, meluncurkan istri muda mereka ke dalam produksi ... <br><br>  Nah, kami bersama Anda dari tes lain, pengujian pertama - lalu yang lainnya! <br><br><h4>  Saya mengenali tester dengan kiprah ... </h4><br>  Jadi, ketika saya mulai menulis basis data kode berikutnya, saya memikirkannya, mengapa tidak melakukan pengujian otomatis pada lapisan DAL saya langsung pada tes yang dibangun ke dalam VisualStudio? <br><br>  Dan saya berhasil!  Transparan ke EntityFramework, tanpa sulap di bawah selimut dan penipuan dengan benda palsu.  Siapa yang peduli - mengungkap VS, berpakaian seperti penguji dan pergi!  (Saya selalu berpakaian seperti tester) <br><br><div class="spoiler">  <b class="spoiler_title">Pakaian tester</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tg/pv/kw/tgpvkwgvjzb4zf7tt-navdbcazi.jpeg" alt="gambar"><br></div></div><a name="habracut"></a><br><h4>  Berbohong kepada semua orang, ini sedang menguji! </h4><br><div class="spoiler">  <b class="spoiler_title">Kasus kehidupan:</b> <div class="spoiler_text">  Bekerja pada proyek dengan kode berikut: <br><br><pre><code class="plaintext hljs">ObjectLink link = this.ObjectLinks.ToList().Where(x =&gt; x.SpotCode.ToLowerInvariant() == code.ToLowerInvariant()).SingleOrDefault();</code> </pre> <br>  Kode ini tidak dicakup oleh tes, karena tidak punya waktu - sangat mendesak untuk meluncurkan fungsionalitas baru yang terkait dengan pemasaran.  Semuanya bekerja ketika memeriksa secara manual, dan saya sudah santai ... tapi Bill Gates merayap tanpa disadari ... <br><br>  Musim gugur yang puitis di St. Petersburg, salju dan hujan mengguyur wajahku dengan lembut, tanah mengalir deras dari kaki celana dan gadis-gadis yang tidak dikenal tersenyum melalui rias wajah, menuangkan truk yang lewat ... Aku sudah menggunakan jari untuk mencungkil hidung, ketika itu berbahaya, tanpa menyatakan perang, sebelum saat fajar, Microsoft memotong kawat berduri dan merilis pembaruan inti 3.0.  Hoster telah diperbarui, saya juga diperbarui, mengapa masuk yang lama - apakah saya lebih buruk daripada hoster?  Saya memeriksa semuanya seperti itu dan meluncurkan pembaruan ... dan kemudian saya meluncurkan mata saya!  Fungsionalitas baru tidak berfungsi!  sepertinya saya mengujinya sebelumnya - apa yang bisa terjadi? <br><br>  Dan ini terjadi: Billy tua memutuskan untuk menghentikannya dari LINQ ToLowerInvariant ... sekarang Anda harus memanggilnya terlebih dahulu dan memasukkan nilai jadi ... jika kode tersebut ditutupi dengan tes, saya akan segera melihatnya saat pengujian.  Sangat baik bahwa saya memperhatikan semuanya sendiri, saya tidak harus bersumpah pada pelanggan, karena penguji malu untuk memerah ... saya harus menyelesaikan masalah dan membuat penyebaran baru. <br></div></div><br><h4>  perangkat dan bahan: </h4><br>  Microsoft VisualStudio 2019 <br>  asp.net Core 3.1 (Saya menginstalnya dengan studio, jika ada yang bisa dikirim melalui instal menu proyek frameworks lainnya) <br>  SQL Server Express (dilengkapi dengan studio) <br>  Ekstensi Git ke studio visual (termasuk) <br><br>  Biasanya, dalam tes unit, setiap tes harus diisolasi, dan keadaan di antara mereka tidak bertahan.  Jadi kita akan benar-benar mendapatkan tes integrasi, tetapi kita akan menggunakan MSTest untuk ini.  Saya berharap mereka tidak membawa kami ke polisi untuk ini. <br><br>  Dalam beberapa edisi saya bertemu dengan penggunaan benda-benda tiruan untuk menguji database. <br>  Pada pandangan pertama, idenya bagus sampai interaksi kompleks antara tabel dimulai. <br>  Maka pengaturan tiruan akan membutuhkan lebih dari pengujian itu sendiri.  Tetapi sebenarnya itu - Control + C - Control + V!  kita semua adalah batasan basis data yang telah terdaftar di EF, basis data, DataAnnotations atau duplikat FluentAPI di lapisan tiruan.  Dan menyalin itu seperti melanggar pola ... ayah, warga negara, melanggar ... tidak baik! <br><br>  Dan jika konfigurasi tiruannya rumit, dan misalnya kita membuat kesalahan dalam pembatasan di sana, ternyata - tes tiruan akan lulus, tetapi apakah akan ada kesalahan pada basis nyata? <br><br>  Itu semua membuat saya tertarik, dan saya memutuskan untuk menguji pendekatan baru. <br><br>  Idenya datang, seperti biasa, dari TRIZ: <i>sistem ideal adalah yang tidak ada, tetapi fungsinya dijalankan</i> .  Dan saya pikir saya perlu menggunakan database itu sendiri dalam tes. <br>  Dan itu agak berhasil bagi saya.  Saya ingin membagikan ini, saya harap seseorang membantu. <br><br>  Cons of mock: <br><br><ul><li>  banyak preset yang menguji </li><li>  tes menjadi kotor, banyak kode tambahan </li><li>  sulit untuk menguji migrasi </li><li>  berperilaku baik hanya di bawah pengawasan, secara aktual dapat menghasilkan kesalahan yang tidak diketahui </li><li>  ketika mengubah struktur database Anda harus terus-menerus memanjat ke mock dan mengubah semuanya di sana juga </li></ul><br>  Kelebihan pengujian pada basis nyata: <br><br><ul><li>  program berperilaku persis seperti pada server tempur </li><li>  tes lebih sederhana, Anda dapat membangun mereka satu demi satu dengan cara yang sama data diisi dalam database </li><li>  kami sendiri dapat menyesuaikan kebersihan basis data dengan memberi nomor pada tes (dalam MSTest, pengujian dilakukan berdasarkan abjad) </li><li>  Anda dapat melihat waktu di mana tes dilakukan (pada server sebenarnya akan berbeda, tetapi setidaknya urutannya terlihat - 10 kali lebih lama, 2 kali, dan Anda sudah dapat mengevaluasi cara kerja program, efisien atau tidak) </li><li>  dapat menguji prosedur yang tersimpan </li></ul><br>  Ada beberapa kesulitan dalam pendekatan ini, yang telah saya gali selama beberapa hari, tetapi kami akan berhasil menyelesaikannya, dan semoga backend batu saya bersama Anda! <br><br>  Ayo pergi! <br><br>  Kami membuat proyek baru Aplikasi Web ASP.Net Core 3.1 (Model-View-Controller), mengubah Otentikasi ke Akun Pengguna Individual (Menyimpan akun pengguna di dalam aplikasi) dan klik buat <br><br><img src="https://habrastorage.org/webt/n1/oq/5c/n1oq5cv0fxxqnuu0sdgdwda7xem.jpeg" alt="gambar"><br><br>  Mulai sekarang, saya akan menyimpan snapshot proyek ke git, Anda dapat mengunduhnya dan mengunggah setiap cabang untuk bereksperimen dengannya <br><br>  <a href="https://github.com/3263927/Habr_1" rel="nofollow">github.com/3263927/Habr_1</a> <br><br>  <b>Snapshot: Snapshot_0_ProjectCreated</b> <br><br><div class="spoiler">  <b class="spoiler_title">Tentang repositori</b> <div class="spoiler_text">  Bahkan ketika saya bekerja sendiri, saya selalu menggunakan repositori - sekarang telah menjadi sangat nyaman, dibangun langsung ke dalam Visual Studio, tanpa baris perintah, semuanya bekerja dengan baik langsung dari VS.  Anda dapat bereksperimen dan mengubah apa pun yang Anda inginkan, maka Anda selalu dapat memperbaiki rollback komit atau beralih ke cabang lama.  Menghemat banyak waktu dan tenaga, saya menyarankan semua orang.  Dan terintegrasi dengan github secara gratis.  Benar, ada beberapa pria di sana beberapa tahun yang lalu yang menghapus semuanya ... Jadi untuk berjaga-jaga, saya meletakkan semua proyek di Dropbox dan memperbarui seminggu sekali, serta mengarsipkan semua proyek dan mengunggah versi terbaru secara manual ke Google Drive.  Nah, di telepon SD ada 120 pertunjukan, di sana juga, sebagai cadangan, tiba-tiba, tiba-tiba ... Beberapa flash drive dengan salinan di saku mereka begitu tak terlihat! <br></div></div><br>  Pada titik ini saya membuat repositori, jadi sekarang saya harus merencanakan pekerjaan untuk membuat cabang baru.  Di masa depan, menggunakan kata kunci Snapshot, akan dimungkinkan untuk menemukan poin pemulihan jika terjadi kesalahan. <br><br>  Saya akan membuat cabang baru di repositori langsung dari VisualStudio, dan saya akan menyebutnya "Sister of Talent" untuk singkat (lelucon, Snap_1_DataBases). <br><br>  <b>tujuan: untuk membuat koneksi dan basis yang berfungsi</b> . <br><br>  Kami mulai membuat pangkalan kami. <br><br>  Saya harus mengatakan segera bahwa kami akan memiliki 3 database - satu tes (pada mesin lokal), produksi lain (pada server jarak jauh, bekerja) dan kerja lokal lainnya (untuk memeriksa kesehatan situs dalam konfigurasi DEBUG). <br><br>  Logikanya adalah ini: <br><br><ul><li>  jika kita ingin menjalankan situs di mesin lokal dan melihat cara kerjanya, maka Habr1_Local akan bekerja untuk kita </li><li>  jika kita memasukkan kode dalam produksi maka Habr1_Production akan bekerja </li><li>  ketika infrastruktur pengujian kami mulai menguji, ia harus menemukan basis Habr1_Test dan menjalankannya </li></ul><br>  Namun, kami memiliki satu kontradiksi - hanya ada dua konfigurasi, Debug dan Release.  Ini masih merupakan masalah, tetapi kemudian akan diselesaikan. <br><br>  Jadi, kami membuat program yang berfungsi minimal - sebagai permulaan kami hanya memeriksa apakah setidaknya satu database berfungsi untuk kami.  Mari kita ciptakan ... dengan tangan Visual Studio itu sendiri! <br><br>  Buka file appsettings.json <br><br>  Ada beberapa baris: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\mssqllocaldb;Database=aspnet-WebApp-[- ,   ];Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre> <br>  Di sana Anda harus memasukkan nama string koneksi, nama server, dan nama database yang benar.  Saya harus mengatakan segera bahwa koneksi lain digunakan dalam produksi, tetapi sekarang kita tidak membutuhkan ini.  Tugas kami adalah membuat dua basis data (lokal dan uji, produksi hanyalah sebuah contoh - kami akan menggunakannya dalam konfigurasi rilis. Kemudian dapat diganti dengan basis data yang berfungsi). <br><br>  Mengapa ini dibutuhkan? <br><br>  Konfigurasi Visual Studio memungkinkan Anda mengubah beberapa pengaturan dengan mengalihkan konfigurasi di panel visual studio: <br><br><img src="https://habrastorage.org/webt/qa/8k/nr/qa8knrxqxt8komoewxxf-b-s2qs.jpeg" alt="gambar"><br><br>  Secara umum, lingkungan pengembangan hanya menyatakan konstanta DEBUG, yang kemudian dapat dibaca dari mana saja dalam kode dan memahami konfigurasi apa yang saat ini kita gunakan, yang mana yang aktif. <br><br>  Remote debugger tidak selalu tersedia, misalnya, pada hosting colocation.  Kami dapat menjalankan server asp.net kami secara lokal, dan terhubung ke database ke remote, dan kami dapat melihat semua kesalahan yang ada di produksi.  Di sini, di konfigurasi rilis kami akan melakukan ini, dan konfigurasi debug akan bekerja dengan database lokal kami.  Dan kami tidak akan melakukan konfigurasi pengujian, untuk alasan keamanan - agar tidak secara tidak sengaja menghapus data apa pun, lupa untuk mengganti konfigurasi <br><br>  Jadi, kami mulai mengubah string koneksi. <br><br>  Nama server - Anda dapat melihatnya pada tampilan tab -&gt; SQL server object explorer <br><br><img src="https://habrastorage.org/webt/mk/-1/tc/mk-1tcplz6dtcpzupszdzpesh84.jpeg" alt="gambar"><br><br>  (Saya akan menghapus nama komputer saya dengan hati-hati, jika tidak, Anda akan menghitung saya dengan IP dan mengetik sesuatu). <br><br>  Jadi saya punya ini (localdb) \ ProjectsV13.  Saya tidak tahu mengapa, selama instalasi saya memanggil SQL saya. <br>  Ini berarti bahwa string koneksi kita menjadi <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local; Trusted_Connection=True;MultipleActiveResultSets=true"</span></span></code> </pre> <br>  Anda mungkin memilikinya secara berbeda, tetapi hanya ProjectV13.  Sisanya harus dibiarkan begitu saja. <br>  Ubah DefaultConnection ke Habr1_Local <br><br>  Ternyata seperti ini: <br><br><pre> <code class="json hljs"> <span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Habr1_Local"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre> <br>  Sekarang Anda harus pergi ke file Startup.cs dan ganti DefaultConnection dengan Habr1_Local di sana: <br><br><pre> <code class="cs hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>)));</code> </pre> <br>  berubah menjadi <br><br><pre> <code class="cs hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"Habr1_Local"</span></span>)));</code> </pre><br>  Kami memulai proyek kami dalam konfigurasi Debug, browser terbuka, kami melihat halaman pertama, klik tombol Login, masukkan email yang valid di sana (tidak akan mengirimi Anda surat, itu hanya memvalidasi format) dan klik Login - dan kami melihat layar ini: <br><br><img src="https://habrastorage.org/webt/p3/u3/r4/p3u3r4gkdanievaornpxfxwoous.jpeg" alt="gambar"><br><br>  Klik Terapkan Migrasi, tunggu hingga konfirmasi muncul di sebelah kanan tombol biru bahwa migrasi telah berlalu dan Anda perlu menyegarkan halaman, menyegarkan, klik konfirmasi untuk mengirim ulang data dan mendapatkan layar yang mengatakan Login Gagal: <br><br><img src="https://habrastorage.org/webt/fc/sw/pc/fcswpc-tqd0gyuhz70cyefi9uls.jpeg" alt="gambar"><br><br>  Jika layar seperti itu terlihat, maka semuanya baik-baik saja - setelah permintaan berlalu dan mengembalikan upaya login yang tidak valid, maka tidak ada kesalahan database, tetapi itu sama sekali tidak menemukan pengguna seperti itu. <br><br><div class="spoiler">  <b class="spoiler_title">Sedikit tentang migrasi:</b> <div class="spoiler_text">  Ini adalah alat yang kompleks dan sulit untuk menyentuhnya di artikel ini, tetapi Anda dapat menyentuh sedikit. <br>  Misalnya, Anda perlu mengubah status database menjadi yang spesifik - Anda dapat membuat snapshot database untuk ini, atau membuat beberapa snapshot untuk setiap negara, dan mengaktifkan / menonaktifkan gambar ini baik secara terprogram maupun dengan perintah khusus. <br><br>  Atau ketika Anda mengembangkan sesuatu di mesin lokal, dan kemudian Anda perlu menyinkronkan keadaan baru dari database di server dengan yang lokal, perbarui server produksi ke keadaan database lokalnya, dan lakukan secara otomatis - Anda juga dapat menerapkan migrasi.  Ini sebenarnya tombol biru ini.  Basis tahu bahwa kondisinya berbeda dari keadaan kode dan berusaha menyinkronkan status ini.  Untuk melakukan ini, tabel khusus dibuat dalam database dengan status yang dikodekan dari struktur database. <br><br>  Sayangnya, alat ini rumit oleh kenyataan bahwa tidak ada antarmuka visual untuk itu, dan Anda harus bekerja dengannya dari baris perintah.  Migrasi nyaman digunakan ketika Anda harus melewati status melalui Git - cukup dengan membuat snapshot basis data seperti file C #.  Tetapi alat ini memiliki satu bahaya - jika tidak dikonfigurasi dengan benar, ia dapat menghapus data dalam basis data, jadi Anda harus menggunakannya dengan hati-hati. <br></div></div><br>  Memeriksa ketersediaan database - Visual Studio seharusnya membuatnya <br><br><img src="https://habrastorage.org/webt/op/6i/c_/op6ic_e4cdoarqotsmz441fkmkc.jpeg" alt="gambar"><br><br>  Jika tidak ada database, maka ada yang salah - baik server SQL tidak diinstal, atau sesuatu yang lain, secara umum, seperti lelucon tentang bagaimana jika programmer adalah dokter: "dokter, kaki saya sakit ... - yah, tidak Saya tahu, saya memiliki kaki yang sama dan tidak ada yang sakit! " <br><br>  Pada titik ini, saya membuat dua string koneksi lagi, appsettings.json mengambil formulir ini: <br><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Habr1_Local"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Local;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Habr1_Test"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Test;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Habr1_Production"</span></span>: <span class="hljs-string"><span class="hljs-string">"Server=(localdb)\\ProjectsV13;Database=Habr1_Production;Trusted_Connection=True;MultipleActiveResultSets=true"</span></span> },</code> </pre><br>  Saya membuat komit dan memasukkan snapshot berikut ke dalam repositori: <br><br>  <b>Snapshot: Snap_1_DataBases</b> <br><br>  Buat cabang baru, Snap_2_Configurations <br><br>  <b>tujuan: membuat konfigurasi yang berfungsi</b> <br><br>  Saat mengalihkan konfigurasi, kami dapat mempertimbangkan dari mana saja dalam program ini konfigurasi mana yang saat ini (sebenarnya, bukan dari mana pun, itu tidak akan berfungsi dari View - Anda perlu melakukan fungsi khusus, tetapi ini tidak penting untuk proyek ini): <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG  DEBUG #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta">  RELEASE ( DEBUG   ) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  Buka file Startup.cs dan konversikan metode ConfigureServices ke ini: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr = "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer( Configuration.GetConnectionString(ConnStr))); services.AddDefaultIdentity&lt;IdentityUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true) .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;(); services.AddControllersWithViews(); services.AddRazorPages(); }</span></span></code> </pre><br>  Seperti yang Anda lihat, kami mengganti Habr1_Local dengan variabel, dan sekarang tergantung pada konfigurasi, connectionstring akan menjadi Habr1_Local atau Habr1_Production <br><br>  Sekarang Anda dapat memulai proyek dan memeriksa bagaimana database dibuat tergantung pada konfigurasi <br><br>  Kami memilih DEBUG pada panel, memulai, masuk, menerapkan migrasi, memeriksa apakah database telah dibuat (Habr1_Local) <br><br>  Kami menghentikan proyek, pilih konfigurasi Release, mulai, login, terapkan migrasi, periksa apakah database telah dibuat - kami memiliki 2 pangkalan. <br><br>  Selesai! <br><br>  <b>Snapshot: Snap_3_HabrDB</b> <br><br>  <b>Tujuan: membuat proyek basis data terpisah, yang kemudian dapat digunakan dalam berbagai proyek</b> <br><br>  Mengapa proyek terpisah? <br><br>  Proyek individual memiliki beberapa keunggulan: <br><br><ul><li>  Mereka dapat digunakan dalam proyek lain. </li><li>  Mereka tidak mengkompilasi ulang jika tidak ada perubahan, yang berarti bahwa total waktu kompilasi berkurang </li><li>  Proyek individual lebih mudah untuk diuji. </li></ul><br>  Jadi, tombol kanan pada solusi - tambahkan -&gt; folder solusi baru, beri nama DB. <br>  Lalu langsung ke folder yang dibuat - tambahkan proyek baru -&gt; .net standar, nama HabrDB. <br>  Untuk beberapa alasan, saya membuatnya sebagai .net standard 2.0, saya perlu mengubahnya ke 2.1 <br>  (Saat membuatnya menawarkan jalur fisik, biarkan ia berada di folder DB dan secara fisik juga). <br><br>  Sepertinya ini untuk saya: <br><br><img src="https://habrastorage.org/webt/g4/kb/wu/g4kbwu45mu92my9ucaanuldtuhs.jpeg" alt="gambar"><br><br>  Jadi, kami memiliki beberapa ApplicationDBContext dalam proyek ini, dan kami membuat yang lain dari kami sendiri?  Apakah mereka akan saling bertentangan?  Sekarang kita akan berteman dengan mereka.  Kami akan memiliki dua konteks berbeda ke database yang sama, yang tidak akan berpotongan melalui Entity Framework.  Kami akan memberi mereka nama skema yang berbeda: satu akan tetap dbo secara default, dan yang lainnya akan "habr". <br><br>  Jika Anda menghubungkan konteks seperti itu melalui akar komposisi, maka mereka dapat didaur ulang di proyek lain hampir secara transparan.  (E.g. konteks gudang dan konteks karyawan) <br><br>  Dan satu lagi momen arsitektur, kadang-kadang Anda perlu menambahkan beberapa properti Anda ke pengguna, ini tidak berlaku langsung ke topik artikel, tetapi kami akan melakukannya hanya untuk mengetahui bagaimana melakukannya.  Selain itu, kami akan dapat membuat dan menghapus konteks secara independen satu sama lain.  Ide yang bagus adalah memisahkan tabel keamanan dengan data pribadi dan mengenkripsi data tersebut di tingkat basis data (kami tidak akan melakukan ini dalam proyek ini, tetapi secara umum hal ini kadang diperlukan, termasuk oleh hukum). <br><br>  Ya, dan lebih mudah untuk menguji dengan cara ini, Anda tidak dapat membuat semua tabel sekaligus, tetapi hanya mereka yang diperlukan untuk menguji konteks yang diberikan. <br><br>  Saya membuat snapshot proyek baru - tahap 4. <br><br>  <b>Tujuan fase ini adalah:</b> <br><br><ul><li>  ubah pengguna standar menjadi mahir </li><li>  ubah pengguna dalam file Srartup.cs </li><li>  ubah pengguna di LoginPartial dan ViewImports </li><li>  buat migrasi baru untuk secara otomatis membuat database dalam format baru </li></ul><br>  Jadi, kami mentransfer kelas ApplicationDBContext dari proyek WebApp ke HabrDB. <br><br>  Itu tidak portabel, hanya disalin.  Kami menghapusnya dari WebApp, membukanya dari proyek HabrDB dan mengubah namespace-nya menjadi HabrDB, banyak kesalahan muncul. <br><br>  Ya, dalam proyek ini tidak ada paket yang diperlukan, sekarang kami akan mengirimkannya. <br><br>  Melalui nuget, dalam proyek HabrDB, Anda perlu menginstal Microsoft.AspNetCore.Identity.EntityFrameworkCore. <br><br><img src="https://habrastorage.org/webt/wj/-d/q4/wj-dq4ldm5nx32fs9hvzdiya5ys.jpeg" alt="gambar"><br><br>  Kami mengklik bola lampu dan menawarkan kami untuk menginstal versi terbaru. <br><br>  File SecurityDBContext akhir (harus juga diganti namanya) menggunakan formulir ini: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Identity.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SecurityDBContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SecurityDBContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptions&lt;SecurityDBContext&gt; options</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)</span></span> { } } }</code> </pre> <br>  Setelah perakitan, kami <s>dengan hati-hati memproses file</s> dengan kesalahan, dan memang benar - kami menghapus ApplicationDBContext dan menggantinya dengan SecurityDBContext.  Sekarang Anda perlu mengganti semua tautan ke ApplicationDBContext di seluruh proyek dengan SecurityDBContext. <br><br>  Setelah itu, segitiga kuning muncul di proyek saya pada referensi dari WebApp, yang menunjukkan bahwa beberapa tautan bekerja dengan tidak benar.  Saya membersihkan proyek (build -&gt; solusi bersih), menutup proyek, menghapus semua direktori Debug, Release, Obj dan Bin dari folder proyek, setelah itu saya membuka proyek lagi, untuk beberapa waktu saya mencari tautan yang diperlukan di Internet dan memuatnya, dan segitiga, menghilang - maka semuanya baik-baik saja. <br><br>  Sekarang hapus folder Data dari proyek WebApp, hapus database kami (Habr1_Local dan Habr1_Production) di jendela SQL Server Object Explorer dan jalankan proyek.  Kami mencoba masuk - dan sekarang alih-alih tawaran menerapkan migrasi memberikan kesalahan. <br><br><img src="https://habrastorage.org/webt/z_/ex/ca/z_excar1pqk18n8pdmyvf3eobog.jpeg" alt="gambar"><br><br>  Itu benar, kami menghapus folder Data di mana semua migrasi berada dan sekarang kerangka kerjanya tidak tahu harus berbuat apa.  Tapi itu sangat keren ?!  Kenapa?  Lalu apa yang kita sekarang akan memperluas kelas pengguna. <br><br>  Tambahkan file baru ke proyek HabrDB: <br>  ApplicationUser.cs <br><br>  Kami mewarisinya dari IdentityUser <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.AspNetCore.Identity; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ApplicationUser</span></span>:<span class="hljs-title"><span class="hljs-title">IdentityUser</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String NickName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime BirthDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String PassportNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br>  Dalam file SecurityDBContext di header kelas tambahkan: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SecurityDBContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ApplicationUser</span></span>&gt;</code> </pre> <br>  Ini diperlukan agar EntityFramework tahu bahwa sekarang saat membuat database Anda perlu menggunakan model pengguna tingkat lanjut dari kelas AppllicationUser alih-alih yang standar. <br><br>  Metode ConfigureServices dalam file Startup.cs mengambil bentuk: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr = "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> services.AddDbContext&lt;SecurityDBContext&gt;(options =&gt; options.UseSqlServer( Configuration.GetConnectionString(ConnStr))); services.AddDefaultIdentity&lt;ApplicationUser&gt;(options =&gt; options.SignIn.RequireConfirmedAccount = true) .AddEntityFrameworkStores&lt;SecurityDBContext&gt;(); services.AddControllersWithViews(); services.AddRazorPages(); }</span></span></code> </pre> <br>  (Ganti IdentityUser dengan ApplicationUser) <br><br>  Dalam file _ViewImports.cshtml, tambahkan baris <br><br>  <a href="https://habr.com/ru/users/using/" class="user_link">menggunakan</a> HabrDB <br><br>  Sekarang semua tampilan akan melihat proyek kami dengan basis dan Anda tidak perlu menulis <a href="https://habr.com/ru/users/using/" class="user_link">menggunakan</a> HabrDB di awal tampilan. <br><br>  Di file _LoginPartial.cshtml, ubah semua IdentityUser ke ApplicationUser. <br><br>  <a href="https://habr.com/ru/users/using/" class="user_link">menggunakan</a> Microsoft.AspNetCore.Identity <br>  <a href="https://habr.com/ru/users/inject/" class="user_link">menyuntikkan</a> SignInManager SignInManager <br>  <a href="https://habr.com/ru/users/inject/" class="user_link">menyuntikkan</a> UserManager UserManager <br><br>  Untuk berjaga-jaga, kami sedang menyusun proyek untuk mengetahui bahwa kami tidak memiliki kesalahan dan kami tidak lupa mengganti apa pun di mana pun. <br><br>  Sekarang lakukan migrasi. <br><br>  Anda perlu membuka Package Manager Console, pilih proyek DB / HabrDB dan tulis untuk itu <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-migration initial</code> </pre> <br>  Inilah yang saya dapatkan: <br><br><img src="https://habrastorage.org/webt/95/zv/aj/95zvaj1nj3d42hnzq2rk_bvncvo.jpeg" alt="gambar"><br><br>  Ayah Migrasi muncul di proyek HabrDB dan ada file di dalamnya yang akan memungkinkan kami membuat basis data kami secara otomatis, tetapi sekarang dengan bidang tambahan kami - NickName, BirthDate, PassportNumber. <br><br>  Mari kita coba cara kerjanya - mari jalankan dan coba masuk (jangan mendaftar, Anda harus memasukkan kata sandi yang rumit di sana): <br><br><img src="https://habrastorage.org/webt/01/ib/0u/01ib0ufzxz_bds3n2scb5pqgyoi.jpeg" alt="gambar"><br><br>  Saya ditawari untuk melakukan migrasi dan saya setuju - ini adalah basis kami: <br><br><img src="https://habrastorage.org/webt/qg/af/js/qgafjs_fgtlnj39nlru_bxb9a2a.jpeg" alt="gambar"><br><br>  Dengan tahap ini, semuanya <br><br>  <b>Snapshot: Snap_4_Security sudah</b> siap <br><br>  Buat tembakan kelima. <br><br>  <b>Tujuan:</b> <br><br><ul><li>  buat string koneksi uji berfungsi </li><li>  buat proyek pengujian basis data </li><li>  buat proyek uji buat basis dan uji sesuatu yang bermanfaat </li></ul><br>  Kami klik kanan pada ayah DB, buat proyek baru - MSTest .net core. <br>  Ubah nama satu-satunya file dalam proyek ini menjadi DBTest dan pikirkan ... <br>   . <br><br>  Masalah <br><br>     ,        ,    ConnectionString       (WebApp),   -   Release/Debug ?..    , Test ? <br><br> ,     — -        ,   Run All Tests —     … ,    … <br><br>      ! <br><br>   HabrDBContext     : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Extensions.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String ConnectionString = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IConfigurationRoot Configuration { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HabrDBContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateTestContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { DirectoryInfo info = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryInfo(Directory.GetCurrentDirectory()); DirectoryInfo temp = info.Parent.Parent.Parent.Parent; String CurDir = Path.Combine(temp.ToString(), <span class="hljs-string"><span class="hljs-string">"WebApp"</span></span>); String ConnStr = <span class="hljs-string"><span class="hljs-string">"Habr1_Test"</span></span>; Configuration = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationBuilder().SetBasePath(CurDir).AddJsonFile(<span class="hljs-string"><span class="hljs-string">"appsettings.json"</span></span>).Build(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbContextOptionsBuilder&lt;HabrDBContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = Configuration.GetConnectionString(ConnStr); builder.UseSqlServer(connectionString); ConnectionString = connectionString; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br>  Nuget      : <br><br><pre> <code class="plaintext hljs">Microsoft.AspNetCore.Identity.EntityFrameworkCore Microsoft.EntityFrameworkCore Microsoft.EntityFrameworkCore.SqlServer Microsoft.Extensions.Configuration.FileExtensions Microsoft.Extensions.Configuration.Json</code> </pre> <br>  CreateTestContext      Connection String   Habr1_Test.      .      reference       ,   builder      connectionString,                 ,       WebApp,       appsettings.json    ,     .      connectionString    (    ). <br><br>           , DLL        .       . <br><br>  Kenapa begitu <br><br>    ConnectionString        ,      ConnectionString.      :        .               - ,        ,              . ,    appsettings.json    . <br><br>    -   ,   -. <br><br>   HabrDB    DBClasses,       .   code first,          . <br><br>   : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel.DataAnnotations; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel.DataAnnotations.Schema; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB.DBClasses</span></span> { [Table(<span class="hljs-string"><span class="hljs-string">"Phones"</span></span>, Schema =<span class="hljs-string"><span class="hljs-string">"Habr"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Phone</span></span> { [Key] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Model { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime DayZero { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br>  ,     «»        — «».     Table         namespace      ( SQL   Schema). <br><br>    :            ,            —   partial . <br><br>   partial   class   HabrDBContext.cs —  : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span></code> </pre> <br>    HabrDBContext.cs —  CTRL+ — CTRL+V  ,   ,       HabrDBContext_Infrastructure.cs,    HabrDBContext_Data.cs <br><br>   : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Phone&gt; Phones { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre> <br>    —      ,    .  ,       —           . <br><br> , ! <br><br>        : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestMethod1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = db.Phones.ToList(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; db.Phones.Add(ph); db.SaveChanges(); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } } }</code> </pre><br>   play   Test Explorer ( Test -&gt; Run All Tests) … <br><br><img src="https://habrastorage.org/webt/9w/qe/68/9wqe686vdpg6jet-epu30oakdou.jpeg" alt="gambar"><br><br> !   . <br><br>    : <br><br><pre> <code class="plaintext hljs">Message: Test method DBTest.DBTest.TestMethod1 threw exception: System.InvalidOperationException: No database provider has been configured for this DbContext. A provider can be configured by overriding the DbContext.OnConfiguring method or by using AddDbContext on the application service provider. If AddDbContext is used, then also ensure that your DbContext type accepts a DbContextOptions&lt;TContext&gt; object in its constructor and passes it to the base constructor for DbContext.</code> </pre> <br> -   … <br> ,   ! <br><br>         HabrDBContext_Infrastructure.cs? ! <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConfiguring</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span></span></span><span class="hljs-function">)</span></span> { String ConnStr = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Configuration == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DEBUG ConnStr = "Habr1_Local"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> ConnStr= "Habr1_Production"; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> Configuration = new ConfigurationBuilder() .SetBasePath(Directory.GetCurrentDirectory()) .AddJsonFile("appsettings.json").Build(); ConnectionString = Configuration.GetConnectionString(ConnStr); } optionsBuilder.UseSqlServer(ConnectionString); }</span></span></code> </pre> <br> … <br><br>  !!! <br>       —  ! <br><br><img src="https://habrastorage.org/webt/an/cv/1a/ancv1ahppxwymetpwayqqwdtlzg.jpeg" alt="gambar"><br><br>  ? <br><br>    breakpoints   OnConfiguring  CreateTestContext   ,     CreateTestContext,     ConnectionString  .    .   -   OnConfiguring…   ?  call stack —     db.Database.EnsureCreated()  !   ,         —    EnsureCreated.       ,    -      EnsureCreated.  ,          (  ,    )   middlware, DI,         ,      —      ,     OnConfiguring —     .   . <br><br>     —  … <br>  ? <br>   ,  …   ? <br>      ,      …    -  .     ?   ,   ? <br><br> <b>Snapshot: Snap_5_ContextCrafting </b> <br><br>    DAL — Data Access Layer. <br><br>    HabrDBContext_Data.cs,   HabrDBContext_DAL.cs <br>   : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">HabrDB</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HabrDBContext</span></span>:<span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Phone ph</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Phones.Add(ph); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SaveChangesAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;List&lt;Phone&gt;&gt; GetAllPhones() { List&lt;Phone&gt; phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Phones.ToListAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> phones; } } }</code> </pre><br>  —    .    ,   -      ,           .     — Data Access Layer.       MVC     .  — ? —      !      —       . <br>      —      .     ! <br>  ! <br><br>    ,      . <br>       DI  startup.cs,         ,    <br><br>    : <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = db.GetAllPhones().Result; Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); }</code> </pre><br>       ,     —   . <br>    ,    -  .    : <br><br><img src="https://habrastorage.org/webt/kc/vz/ea/kcvzeaiyug4owclncwblblpqoaw.jpeg" alt="gambar"><br><br>   db.GetAllPhones().Result?   ,    DAL .     ,       await.   ,       . <br><br>    async Task —     ,       —    await <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); }</code> </pre><br> ,    ,       Task   void —                  . <br><br> ,   . <br><br> <b>Snapshot: Snap_6_Dal</b> <br><br>  ,     ?  ! <br><br>       … <br><br>     db.Database.EnsureDeleted…   ! <br><br>    …              .      ,       —  SQL Management Studio,     db.Database.EnsureDeleted      , ,  ,         ,       ,    . <br><br>  . <br><br>    ,      ,           ,     ,         . <br><br>  : ,         -      ,      . <br><br>    db.Database.EnsureDeleted,    ,   ,      … <br><br><img src="https://habrastorage.org/webt/uh/by/ti/uhbytib40xtjnbwfapd26iqtrus.jpeg" alt="gambar"><br><br> ,  … <br>  ,  . <br><br>      , (  solution)    , add -&gt; .net standard C#,    Extensions.     2.1 . <br><br>        Extensions  DBContextExtensions.cs     : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.EntityFrameworkCore.Infrastructure; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Extensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBContextExtensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> EnsureDeleted&lt;TEntity&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DatabaseFacade db, DbSet&lt;TEntity&gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { TableDescription Table = GetTableName(<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { res = db.ExecuteSqlRaw(<span class="hljs-string"><span class="hljs-string">$"DROP TABLE [</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Table.Schema}</span></span></span><span class="hljs-string">].[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Table.TableName}</span></span></span><span class="hljs-string">];"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TableDescription GetTableName&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = dbSet.GetDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> model = dbContext.Model; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityTypes = model.GetEntityTypes(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityType = entityTypes.First(t =&gt; t.ClrType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableNameAnnotation = entityType.GetAnnotation(<span class="hljs-string"><span class="hljs-string">"Relational:TableName"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableSchemaAnnotation = entityType.GetAnnotation(<span class="hljs-string"><span class="hljs-string">"Relational:Schema"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tableName = tableNameAnnotation.Value.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schemaName = tableSchemaAnnotation.Value.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TableDescription { Schema = schemaName, TableName = tableName }; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DbContext GetDbContext&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> infrastructure = dbSet <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IInfrastructure&lt;IServiceProvider&gt;; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> serviceProvider = infrastructure.Instance; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentDbContext = serviceProvider.GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ICurrentDbContext)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ICurrentDbContext; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentDbContext.Context; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TableDescription</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Schema { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String TableName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br>  Nuget  Microsoft.EntityFrameworkCore <br>     — Microsoft.EntityFrameworkCore.Relational <br><br> Extensions —   .          ,     —   this     <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> EnsureDeleted&lt;TEntity&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DatabaseFacade db, DbSet&lt;TEntity&gt; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span></code> </pre> <br>    .  ,   ,    ,    DatabaseFacade    — EnsureDeleted  ,           ! where TEntity: class     TEntity  constraint —   ,        ,  -      . <br><br>     —  ? <br><br>    GetTableName,    EnsureDeleted,   . <br>     ? <br><br>    GetDbContext,    GetTableName,    … <br><br>     ???!!!        … <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DbSet yang kami coba perluas dengan metode GetDbContext di baris tersebut</font></font><br><br><pre> <code class="cs hljs">Public <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DbContext GetDbContext&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> DbSet&lt;T&gt; dbSet) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span></code> </pre> <br> ,   T   ,  class     … <br><br>  ,    —   ,     —        EnsureDeleted  .      .     DBContext      ,        ,        ,      ,   ,               (   GetTableName),        ,     EnsureDeleted   —  !     removetable  -  ,     - SQL …    - ! <br><br>  exception   EnsureDeleted  ,         ,     -  ,             . <br><br>     ( ) <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureDeleted(db.Phones); }</code> </pre> <br> , , … <br>    —  . <br><br>          ,   . <br><br> <b>Snapshot: Snap_7_Extensions</b> <br><br>   <s></s>  <br><br>     —  HabrDBContext     (    ). ( ,      ,    .     !     ...) <br><br>         ,         ,             .  ?   ,     . <br><br><pre> <code class="cs hljs">HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated();</code> </pre> <br>     <br><br><pre> <code class="cs hljs">HabrDBContext db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureDeleted(db.Phones);</code> </pre> <br>   - … <br><br>   ,       …     ,    —  ! <br><br>       —  . <br><br>       ,    ,            ,   ,    . <br><br>    … <br>  ! <br><br>     DBTest,     — db <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Extensions; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HabrDBContext db; [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AA0_init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); } [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db.Database.EnsureDeleted(db.Phones); } } }</code> </pre><br> ! <br><br>  -    . <br>  ! <br>   ! <br>         DBTestBase,       DBTest. <br>  DBTest   , : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB.DBClasses; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Extensions; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span>:<span class="hljs-title"><span class="hljs-title">DBTestBase</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPhone_Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { String PhoneName = <span class="hljs-string"><span class="hljs-string">"Nokia"</span></span>; DateTime now = DateTime.Now; List&lt;Phone&gt; Phones = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.GetAllPhones(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, Phones.Count); Phone ph = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Phone(); ph.Model = PhoneName; ph.DayZero = now; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> db.AddPhone(ph); Phone ph1 = db.Phones.Single(); Assert.AreEqual(PhoneName, ph1.Model); Assert.AreEqual(now, ph1.DayZero); } [ClassCleanup] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteTable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { db.Database.EnsureDeleted(db.Phones); } } }</code> </pre><br>   DBTestBase: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HabrDB; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.VisualStudio.TestTools.UnitTesting; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DBTest</span></span> { [TestClass] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DBTestBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HabrDBContext db{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes once before the test run. (Optional) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="context"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> [AssemblyInitialize] public static void AssemblyInit(TestContext context) { db = new HabrDBContext().CreateTestContext(); db.Database.EnsureCreated(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes before this class creation </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="context"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> [ClassInitialize] public static void TestFixtureSetup(TestContext context) { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes Before each test </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [TestInitialize] public void Setup() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes once after the test run </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [AssemblyCleanup] public static void AssemblyCleanup() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Runs once after all tests in this class are executed. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Not guaranteed that it executes instantly after all tests from the class. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [ClassCleanup] public static void TestFixtureTearDown() { } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Executes after each test </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [TestCleanup] public void TearDown() { //db.Database.EnsureDeleted();//don`t call! delete database instead of tables! } } }</span></span></code> </pre> <br>   !        DBTestBase,      ,   .  ,       —   . <br><br>  [ClassCleanup]       —   «cleaner»  —     -      . <br><br> ,   ,      ,    . <br><br>        ,            —             —  -     DAL ,               . <br><br>      . <br><br>    ,       (  ). <br><br>   DAL   ,     DAL,   - ,      ,     . <br><br>      -     -. <br><br>  ,           . <br><br>    -  ,     : <br><br> T1_AddPhone_Test, <br> T2_RemovePhone_Test, <br>  ..… <br><br>  ,        —     ! <br>     !       … <br><br>  !  ! <br><br> git repository : <a href="https://github.com/3263927/Habr_1" rel="nofollow">https://github.com/3263927/Habr_1</a> <br><br>   ,          Identity, Roles, Claims, 3D     TypeFilterAttribute (                     .        ! :/) <br><br><div class="spoiler"> <b class="spoiler_title">  ,   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ek/8u/bl/ek8ublhenuarw7809onfz2l_nx4.jpeg" alt="gambar"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id481474/">https://habr.com/ru/post/id481474/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id481460/index.html">Olahpesan -> PubSub di dalam OTP</a></li>
<li><a href="../id481462/index.html">Sejarah perangkat lunak pendidikan: pengembangan komputer pribadi dan guru virtual</a></li>
<li><a href="../id481466/index.html">Cara membangun proyek di Jenkins, jika Anda membutuhkan banyak lingkungan berbeda</a></li>
<li><a href="../id481470/index.html">Karangan bunga pintar untuk sepanjang tahun</a></li>
<li><a href="../id481472/index.html">Riwayat DNS: Saat Nama Domain Dibayar</a></li>
<li><a href="../id481476/index.html">Bagaimana saya mulai berbicara di konferensi dan tidak bisa berhenti</a></li>
<li><a href="../id481478/index.html">STM32 + CMSIS + STM32CubeIDE</a></li>
<li><a href="../id481480/index.html">Ini adalah norma: apa itu peta normal dan bagaimana cara kerjanya</a></li>
<li><a href="../id481482/index.html">Posting silang ke halaman Facebook menggunakan PHP SDK</a></li>
<li><a href="../id481484/index.html">AI berusaha menghindari masalah perilaku belajar yang rumit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>