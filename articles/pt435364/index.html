<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚Ü©Ô∏è üßëüèø üíÜüèæ Customizando a resolu√ß√£o de depend√™ncia no Spring ‚úãüèø üßë‚Äçü§ù‚Äçüßë üö∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Meu nome √© Andrey Nevedomsky e sou o engenheiro-chefe da SberTekh. Trabalho em equipe que desenvolve um dos servi√ßos de sistema do ESF (Sistema Fro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Customizando a resolu√ß√£o de depend√™ncia no Spring</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/435364/">  Oi  Meu nome √© Andrey Nevedomsky e sou o engenheiro-chefe da SberTekh.  Trabalho em equipe que desenvolve um dos servi√ßos de sistema do ESF (Sistema Frontal Unificado).  Em nosso trabalho, usamos ativamente o Spring Framework, em particular seu DI, e de tempos em tempos nos deparamos com o fato de que resolver depend√™ncias no Spring n√£o √© suficientemente inteligente para n√≥s.  Este artigo √© o resultado de minhas tentativas de torn√°-lo mais inteligente e geralmente entender como ele funciona.  Espero que voc√™ possa aprender algo novo sobre o dispositivo da primavera. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ea/bbf/f4c/0eabbff4c25bb87806837c487f847fcc.png"><br><a name="habracut"></a><br>  Antes de ler o artigo, recomendo fortemente que voc√™ leia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">os</a> relat√≥rios de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Boris</a> Yevgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">EvgenyBorisov</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Spring Ripper, Parte 1</a> ;  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Estripador de mola, parte 2</a> .  Ainda existe uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lista de reprodu√ß√£o deles</a> . <br><br><h2>  1. Introdu√ß√£o </h2><br>  Vamos imaginar que nos pediram para desenvolver um servi√ßo para prever o destino e os hor√≥scopos.  Existem v√°rios componentes em nosso servi√ßo, mas os principais para n√≥s ser√£o dois: <br><br><ul><li>  Globa, que implementar√° a interface do FortuneTeller e prever√° o destino; <br><br><img src="https://habrastorage.org/getpro/habr/post_images/301/c90/6f1/301c906f1584237b8bab4f8627484ff2.png" width="365" height="450"><br><br></li></ul><br><ul><li>  Gypsy, que implementar√° a interface HoroscopeTeller e criar√° hor√≥scopos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d9f/520/3ad/d9f5203ad3b823ea61d5322655d2164d.png" width="365" height="450"><br><br></li></ul><br>  Tamb√©m em nosso servi√ßo, haver√° v√°rios pontos de extremidade (controladores) para, de fato, obter adivinha√ß√µes e hor√≥scopos.  E tamb√©m controlaremos o acesso ao nosso aplicativo por IP usando um aspecto que ser√° aplicado aos m√©todos do controlador e ter√° a seguinte apar√™ncia: <br><br><div class="spoiler">  <b class="spoiler_title">RestrictionAspect.java</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Aspect</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RestrictionAspect</span></span></span><span class="hljs-class"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Predicate&lt;String&gt; ipIsAllowed;    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RestrictionAspect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NonNull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Predicate&lt;String&gt; ipIsAllowed)</span></span></span><span class="hljs-function"> </span></span>{        <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ipIsAllowed = ipIsAllowed;    }    <span class="hljs-meta"><span class="hljs-meta">@Before</span></span>(<span class="hljs-string"><span class="hljs-string">"execution(public * com.github.monosoul.fortuneteller.web.*.*(..))"</span></span>)    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkAccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{        val ip = getRequestSourceIp();       log.debug(<span class="hljs-string"><span class="hljs-string">"Source IP: {}"</span></span>, ip);        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ipIsAllowed.test(ip)) {            <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AccessDeniedException(format(<span class="hljs-string"><span class="hljs-string">"Access for IP [%s] is denied"</span></span>, ip));        }    }    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRequestSourceIp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{        val requestAttributes = currentRequestAttributes();        Assert.state(requestAttributes <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ServletRequestAttributes,                <span class="hljs-string"><span class="hljs-string">"RequestAttributes needs to be a ServletRequestAttributes"</span></span>);        val request = ((ServletRequestAttributes) requestAttributes).getRequest();        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.getRemoteAddr();    } }</code> </pre> <br></div></div><br>  Para verificar se o acesso desse IP √© permitido, usaremos alguma implementa√ß√£o do predicado <code>ipIsAllowed</code> .  Em geral, no site desse aspecto, pode haver outros, por exemplo, autorizando. <br><br>  Por isso, desenvolvemos o aplicativo e tudo funciona muito bem para n√≥s.  Mas vamos falar sobre testes agora. <br><br><h2>  Como test√°-lo? </h2><br>  Vamos falar sobre como podemos testar a aplica√ß√£o de aspectos.  Temos v√°rias maneiras de fazer isso. <br><br>  Voc√™ pode escrever testes separados para um aspecto e para os controladores, sem elevar o contexto da mola (que apenas criar√° um proxy com um aspecto para o controlador, voc√™ pode ler mais sobre isso na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> oficial), mas, neste caso, <u>n√£o testaremos exatamente quais aspectos s√£o aplicados corretamente controladores e funcionam exatamente como esperamos</u> ; <br><br>  Voc√™ pode escrever testes nos quais elevaremos o contexto completo de nossa aplica√ß√£o, mas neste caso: <br><br><ul><li>  A execu√ß√£o de testes levar√° muito tempo, porque  todas as caixas subir√£o; </li><li>  precisaremos preparar dados de teste v√°lidos que possam passar por toda a cadeia de chamadas entre compartimentos sem gerar NPE ao mesmo tempo. </li></ul><br>  Mas queremos testar exatamente o que o aspecto aplicou e est√° fazendo seu trabalho.  N√£o queremos testar os servi√ßos chamados pelo controlador e, portanto, n√£o queremos ficar intrigados com os dados de teste e sacrificar o tempo de inicializa√ß√£o.  Portanto, escreveremos testes nos quais levantaremos apenas parte do contexto.  I.e.  em nosso contexto, haver√° um bean de aspecto real e um bean de controlador real, e todo o resto ser√° mokami. <br><br><h2>  Como criar beans moka? </h2><br>  Existem v√°rias maneiras de criar feij√£o moka na primavera.  Para maior clareza, como exemplo, tomamos um dos controladores de nosso servi√ßo - <code>PersonalizedHoroscopeTellController</code> , seu c√≥digo se parece com o seguinte: <br><br><div class="spoiler">  <b class="spoiler_title">PersonalizedHoroscopeTellController.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>( value = <span class="hljs-string"><span class="hljs-string">"/horoscope"</span></span>, produces = APPLICATION_JSON_UTF8_VALUE ) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HoroscopeTeller horoscopeTeller; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Function&lt;String, ZodiacSign&gt; zodiacSignConverter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Function&lt;String, String&gt; nameNormalizer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PersonalizedHoroscopeTellController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HoroscopeTeller horoscopeTeller, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, ZodiacSign&gt; zodiacSignConverter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, String&gt; nameNormalizer )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.horoscopeTeller = horoscopeTeller; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.zodiacSignConverter = zodiacSignConverter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nameNormalizer = nameNormalizer; } <span class="hljs-meta"><span class="hljs-meta">@GetMapping</span></span>(value = <span class="hljs-string"><span class="hljs-string">"/tell/personal/{name}/{sign}"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> PersonalizedHoroscope </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@PathVariable </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String name, @PathVariable </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String sign)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"Received name: {}; sign: {}"</span></span>, name, sign); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PersonalizedHoroscope.builder() .name( nameNormalizer.apply(name) ) .horoscope( horoscopeTeller.tell( zodiacSignConverter.apply(sign) ) ) .build(); } }</code> </pre> <br></div></div><br><h3>  Configura√ß√£o Java com depend√™ncias em cada teste </h3><br>  Para cada teste, podemos escrever Java Config no qual descrevemos os beans de controlador e de aspecto e os beans com os moks de depend√™ncia do controlador.  Essa maneira de descrever os feij√µes ser√° imperativa, porque diremos explicitamente √† primavera como precisamos criar os feij√µes. <br><br>  Nesse caso, o teste para o nosso controlador ficar√° assim: <br><br><div class="spoiler">  <b class="spoiler_title">javaconfig / PersonalizedHoroscopeTellControllerTest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringJUnitConfig</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LIMIT = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PersonalizedHoroscopeTellController controller; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Predicate&lt;String&gt; ipIsAllowed; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNothingWhenAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwExceptionWhenNotAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); assertThatThrownBy(() -&gt; controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT))) .isInstanceOf(AccessDeniedException.class); } <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>(AspectConfiguration.class) <span class="hljs-meta"><span class="hljs-meta">@EnableAspectJAutoProxy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> PersonalizedHoroscopeTellController </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">personalizedHoroscopeTellController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HoroscopeTeller horoscopeTeller, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, ZodiacSign&gt; zodiacSignConverter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, String&gt; nameNormalizer )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PersonalizedHoroscopeTellController(horoscopeTeller, zodiacSignConverter, nameNormalizer); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HoroscopeTeller </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">horoscopeTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock(HoroscopeTeller.class); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Function&lt;String, ZodiacSign&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zodiacSignConverter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock(Function.class); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Function&lt;String, String&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameNormalizer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock(Function.class); } } }</code> </pre> <br></div></div><br>  Esse teste parece bastante complicado.  Nesse caso, teremos que escrever Java Config para cada um dos controladores.  Embora o conte√∫do seja diferente, ele ter√° o mesmo significado: crie um bean e moki de controlador para suas depend√™ncias.  Portanto, em ess√™ncia, ser√° o mesmo para todos os controladores.  Eu, como qualquer programador, sou uma pessoa pregui√ßosa, ent√£o recusei imediatamente essa op√ß√£o. <br><br><h3>  Anota√ß√£o @MockBean em cada campo com depend√™ncia </h3><br>  A <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anota√ß√£o @MockBean</a> apareceu no Spring Boot Test vers√£o 1.4.0.  √â semelhante ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@Mock</a> do Mockito (e at√© o usa internamente), com a √∫nica diferen√ßa: ao usar o <code>@MockBean</code> , o mock criado ser√° automaticamente colocado no contexto da primavera.  Este m√©todo de declarar mok ser√° declarativo, pois n√£o precisamos dizer exatamente ao Spring como criar esses mok. <br><br>  Nesse caso, o teste ter√° a seguinte apar√™ncia: <br><br><div class="spoiler">  <b class="spoiler_title">mockbean / PersonalizedHoroscopeTellControllerTest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringJUnitConfig</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LIMIT = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HoroscopeTeller horoscopeTeller; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Function&lt;String, ZodiacSign&gt; zodiacSignConverter; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Function&lt;String, String&gt; nameNormalizer; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Predicate&lt;String&gt; ipIsAllowed; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PersonalizedHoroscopeTellController controller; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNothingWhenAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwExceptionWhenNotAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); assertThatThrownBy(() -&gt; controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT))) .isInstanceOf(AccessDeniedException.class); } <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-meta"><span class="hljs-meta">@Import</span></span>({PersonalizedHoroscopeTellController.class, RestrictionAspect.class, RequestContextHolderConfigurer.class}) <span class="hljs-meta"><span class="hljs-meta">@EnableAspectJAutoProxy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>{ } }</code> </pre> <br></div></div><br>  Nesta op√ß√£o, ainda existe o Java Config, mas √© muito mais compacto.  Entre as defici√™ncias - tive que declarar campos com depend√™ncias do controlador (campos com anota√ß√£o <code>@MockBean</code> ), mesmo que n√£o sejam mais usados ‚Äã‚Äãno teste.  Bem, se voc√™ usar a vers√£o Spring Boot menor que 1.4.0 por algum motivo, n√£o poder√° usar esta anota√ß√£o. <br><br>  Portanto, eu tive uma id√©ia para outra op√ß√£o para zombar.  Eu gostaria que funcionasse dessa maneira ... <br><br><h3>  @ Anota√ß√£o autom√°tica no componente dependente </h3><br>  Gostaria que tiv√©ssemos a anota√ß√£o <code>@Automocked</code> , que eu poderia colocar apenas acima do campo com o controlador, e ent√£o o moki seria criado automaticamente para esse controlador e colocado no contexto. <br><br>  O teste neste caso pode ser assim: <br><br><div class="spoiler">  <b class="spoiler_title">automocked / PersonalizedHoroscopeTellControllerTest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringJUnitConfig</span></span> <span class="hljs-meta"><span class="hljs-meta">@ContextConfiguration</span></span>(classes = AspectConfiguration.class) <span class="hljs-meta"><span class="hljs-meta">@TestExecutionListeners</span></span>(listeners = AutomockTestExecutionListener.class, mergeMode = MERGE_WITH_DEFAULTS) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LIMIT = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Automocked</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PersonalizedHoroscopeTellController controller; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Predicate&lt;String&gt; ipIsAllowed; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNothingWhenAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwExceptionWhenNotAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ when(ipIsAllowed.test(anyString())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); assertThatThrownBy(() -&gt; controller.tell(randomAlphabetic(LIMIT), randomAlphabetic(LIMIT))) .isInstanceOf(AccessDeniedException.class); } }</code> </pre> <br></div></div><br>  Como voc√™ pode ver, essa op√ß√£o √© a mais compacta das apresentadas, existe apenas um bean controlador (mais um predicado para um aspecto), a anota√ß√£o <code>@Automocked</code> est√° <code>@Automocked</code> e toda a <u>m√°gica de criar beans e coloc√°-los no contexto √© escrita uma vez</u> e pode ser usada em todos os testes. <br><br><h2>  Como isso funciona? </h2><br>  Vamos ver como funciona e o que precisamos para isso. <br><br><h3>  TestExecutionListener </h3><br>  Existe essa interface na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primavera</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TestExecutionListener</a> .  Ele fornece uma API para incorpora√ß√£o no processo de execu√ß√£o de teste em seus v√°rios est√°gios, por exemplo, ao criar uma inst√¢ncia de uma classe de teste, antes ou depois de chamar um m√©todo de teste etc.  Ele tem v√°rias implementa√ß√µes prontas para uso.  Por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DirtiesContextTestExecutionListener</a> , que limpa o contexto se voc√™ colocar a anota√ß√£o apropriada;  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DependencyInjectionTestExecutionListener</a> - executa inje√ß√£o de depend√™ncia em testes, etc.  Para aplicar seu Ouvinte personalizado ao teste, voc√™ precisa colocar a anota√ß√£o <code>@TestExecutionListeners</code> acima e indicar sua implementa√ß√£o. <br><br><h3>  Encomendado </h3><br>  H√° tamb√©m uma interface <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ordenada</a> na primavera.  √â usado para indicar que os objetos devem ser classificados de alguma maneira.  Por exemplo, quando voc√™ tem v√°rias implementa√ß√µes da mesma interface e deseja injet√°-las em uma cole√ß√£o, elas ser√£o ordenadas de acordo com Ordenado.  No caso de TestExecutionListener, esta anota√ß√£o indica em qual ordem eles devem ser aplicados. <br><br>  Portanto, nosso Ouvinte implementar√° 2 interfaces: <b>TestExecutionListener</b> e <b>Ordered</b> .  N√≥s o chamamos de <b>AutomockTestExecutionListener</b> e ficar√° assim: <br><br><div class="spoiler">  <b class="spoiler_title">AutomockTestExecutionListener.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutomockTestExecutionListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestExecutionListener</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ordered</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1900</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareTestInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TestContext testContext)</span></span></span><span class="hljs-function"> </span></span>{ val beanFactory = ((DefaultListableBeanFactory) testContext.getApplicationContext().getAutowireCapableBeanFactory()); setByNameCandidateResolver(beanFactory); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val field : testContext.getTestClass().getDeclaredFields()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (field.getAnnotation(Automocked.class) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } log.debug(<span class="hljs-string"><span class="hljs-string">"Performing automocking for the field: {}"</span></span>, field.getName()); makeAccessible(field); setField( field, testContext.getTestInstance(), createBeanWithMocks(findConstructorToAutomock(field.getType()), beanFactory) ); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setByNameCandidateResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DefaultListableBeanFactory beanFactory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((beanFactory.getAutowireCandidateResolver() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> AutomockedBeanByNameAutowireCandidateResolver)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } beanFactory.setAutowireCandidateResolver( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AutomockedBeanByNameAutowireCandidateResolver(beanFactory.getAutowireCandidateResolver()) ); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Constructor&lt;?&gt; findConstructorToAutomock(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Class&lt;?&gt; clazz) { log.debug(<span class="hljs-string"><span class="hljs-string">"Looking for suitable constructor of {}"</span></span>, clazz.getCanonicalName()); Constructor&lt;?&gt; fallBackConstructor = clazz.getDeclaredConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val constructor : clazz.getDeclaredConstructors()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constructor.getParameterTypes().length &gt; fallBackConstructor.getParameterTypes().length) { fallBackConstructor = constructor; } val autowired = getAnnotation(constructor, Autowired.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (autowired != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> constructor; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fallBackConstructor; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBeanWithMocks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Constructor&lt;T&gt; constructor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DefaultListableBeanFactory beanFactory)</span></span></span><span class="hljs-function"> </span></span>{ createMocksForParameters(constructor, beanFactory); val clazz = constructor.getDeclaringClass(); val beanName = forClass(clazz).toString(); log.debug(<span class="hljs-string"><span class="hljs-string">"Creating bean {}"</span></span>, beanName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beanFactory.containsBean(beanName)) { val bean = beanFactory.createBean(clazz); beanFactory.registerSingleton(beanName, bean); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> beanFactory.getBean(beanName, clazz); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createMocksForParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Constructor&lt;T&gt; constructor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DefaultListableBeanFactory beanFactory)</span></span></span><span class="hljs-function"> </span></span>{ log.debug(<span class="hljs-string"><span class="hljs-string">"{} is going to be used for auto mocking"</span></span>, constructor); val constructorArgsAmount = constructor.getParameterTypes().length; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; constructorArgsAmount; i++) { val parameterType = forConstructorParameter(constructor, i); val beanName = parameterType.toString(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beanFactory.containsBean(beanName)) { beanFactory.registerSingleton( beanName, mock(parameterType.resolve(), withSettings().stubOnly()) ); } log.debug(<span class="hljs-string"><span class="hljs-string">"Mocked {}"</span></span>, beanName); } } }</code> </pre> <br></div></div><br>  O que est√° acontecendo aqui?  Primeiro, no m√©todo <code>prepareTestInstance()</code> , ele encontra todos os campos com a anota√ß√£o <code>@Automocked</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val field : testContext.getTestClass().getDeclaredFields()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (field.getAnnotation(Automocked.class) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }</code> </pre> <br>  Em seguida, torna esses campos grav√°veis: <br><br><pre> <code class="java hljs">makeAccessible(field);</code> </pre> <br>  Em seguida, no m√©todo <code>findConstructorToAutomock()</code> , <code>findConstructorToAutomock()</code> encontra o construtor apropriado: <br><br><pre> <code class="java hljs">Constructor&lt;?&gt; fallBackConstructor = clazz.getDeclaredConstructors()[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (val constructor : clazz.getDeclaredConstructors()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (constructor.getParameterTypes().length &gt; fallBackConstructor.getParameterTypes().length) { fallBackConstructor = constructor; } val autowired = getAnnotation(constructor, Autowired.class); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (autowired != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> constructor; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fallBackConstructor;</code> </pre> <br>  Um construtor adequado no nosso caso √© o construtor com a anota√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@Autowired</a> ou o construtor com o maior n√∫mero de argumentos. <br><br>  Em seguida, o construtor encontrado √© passado como argumento para o m√©todo <code>createBeanWithMocks()</code> , que por sua vez chama o m√©todo <code>createMocksForParameters()</code> , onde as simula√ß√µes dos argumentos do construtor s√£o criadas e registradas no contexto: <br><br><pre> <code class="java hljs">val constructorArgsAmount = constructor.getParameterTypes().length; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; constructorArgsAmount; i++) { val parameterType = forConstructorParameter(constructor, i); val beanName = parameterType.toString(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beanFactory.containsBean(beanName)) { beanFactory.registerSingleton( beanName, mock(parameterType.resolve(), withSettings().stubOnly()) ); } }</code> </pre> <br>  √â importante observar que uma representa√ß√£o em cadeia do tipo do argumento (junto com os gen√©ricos) ser√° usada como o nome do compartimento.  Ou seja, para um argumento do tipo <u><code>packages.Function&lt;String, String&gt;</code> representa√ß√£o <code>packages.Function&lt;String, String&gt;</code> string ser√° a string <code>"packages.Function&lt;java.lang.String, java.lang.String&gt;"</code></u> .  Isso √© importante, voltaremos a isso. <br><br>  Ap√≥s criar simula√ß√µes para todos os argumentos e registr√°-los no contexto, voltamos a criar o bean da classe dependente (ou seja, o controlador no nosso caso): <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!beanFactory.containsBean(beanName)) { val bean = beanFactory.createBean(clazz); beanFactory.registerSingleton(beanName, bean); }</code> </pre> <br>  Voc√™ tamb√©m deve prestar aten√ß√£o ao fato de termos usado a <u>Ordem 1900</u> .  Isso √© necess√°rio porque nosso Ouvinte deve ser chamado ap√≥s limpar o contexto ohm de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DirtiesContextBeforeModesTestExecutionListener</a> (order = 1500) e antes da inje√ß√£o de depend√™ncia da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DependencyInjectionTestExecutionListener</a> (order = 2000), porque nosso Listener cria novos compartimentos. <br><br><h2>  AutowireCandidateResolver </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AutowireCandidateResolver √©</a> usado para determinar se o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BeanDefinition corresponde √†</a> descri√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">da</a> depend√™ncia.  Ele tem v√°rias implementa√ß√µes "prontas para uso", entre elas: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">QualifierAnnotationAutowireCandidateResolver</a> - determina se a depend√™ncia √© adequada com base no Qualifier; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GenericTypeAwareAutowireCandidateResolver</a> - determina se a depend√™ncia √© adequada com base em gen√©ricos; </li><li>  e outros </li></ul><br>  Ao mesmo tempo, a implementa√ß√£o "pronta para uso" √© uma boneca russa de heran√ßa, ou seja,  eles se expandem.  Vamos escrever um decorador, porque  √© mais flex√≠vel. <br><br>  O resolvedor funciona da seguinte maneira: <br><br><ol><li>  O Spring usa um descritor de depend√™ncia - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DependencyDescriptor</a> ; <br></li><li>  Em seguida, s√£o necess√°rios todos os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BeanDefinition</a> da classe apropriada; <br></li><li>  Repete as BeanDefinitions recebidas, chamando o m√©todo <code>isAutowireCandidate()</code> do resolvedor; <br></li><li>  Dependendo de a descri√ß√£o do bean corresponder √† descri√ß√£o da depend√™ncia ou n√£o, o m√©todo retornar√° verdadeiro ou falso. <br></li></ol><br><h2>  Por que voc√™ precisou do seu resolvedor? </h2><br>  Agora vamos ver por que precisamos do nosso resolvedor no exemplo do nosso controlador. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonalizedHoroscopeTellController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HoroscopeTeller horoscopeTeller; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Function&lt;String, ZodiacSign&gt; zodiacSignConverter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Function&lt;String, String&gt; nameNormalizer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PersonalizedHoroscopeTellController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HoroscopeTeller horoscopeTeller, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, ZodiacSign&gt; zodiacSignConverter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;String, String&gt; nameNormalizer )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.horoscopeTeller = horoscopeTeller; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.zodiacSignConverter = zodiacSignConverter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nameNormalizer = nameNormalizer; }</code> </pre> <br>  Como voc√™ pode ver, ele possui duas depend√™ncias do mesmo tipo - <b>Fun√ß√£o</b> , mas com gen√©ricos diferentes.  Em um caso, <b>String</b> e <b>ZodiacSign</b> , no outro, <b>String</b> e <b>String</b> .  E o problema disso √© que o <u>Mockito n√£o √© capaz de criar moks levando em considera√ß√£o os gen√©ricos</u> .  I.e.  se criarmos mokas para essas depend√™ncias e as colocarmos em contexto, o Spring n√£o poder√° injet√°-las nessa classe, pois elas n√£o conter√£o informa√ß√µes sobre gen√©ricos.  E veremos a exce√ß√£o de que, no contexto, h√° mais de um bean da classe <b>Function</b> .  √â precisamente esse problema que resolveremos com a ajuda do nosso resolvedor.  Afinal, como voc√™ se lembra, em nossa implementa√ß√£o do Listener, usamos um tipo com gen√©ricos como o nome da lixeira, o que significa que tudo o que precisamos fazer √© ensinar a primavera a comparar o tipo de depend√™ncia com o nome da lixeira. <br><br><h2>  AutomockedBeanByNameAutowireCandidateResolver </h2><br>  Portanto, nosso resolvedor far√° exatamente o que escrevi acima, e a implementa√ß√£o do m√©todo <code>isAutowireCandidate()</code> ser√° parecida com esta: <br><br><div class="spoiler">  <b class="spoiler_title">AutowireCandidateResolver.isAutowireCandidate ()</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAutowireCandidate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BeanDefinitionHolder beanDefinitionHolder, DependencyDescriptor descriptor)</span></span></span><span class="hljs-function"> </span></span>{ val dependencyType = descriptor.getResolvableType().resolve(); val dependencyTypeName = descriptor.getResolvableType().toString(); val candidateBeanDefinition = (AbstractBeanDefinition) beanDefinitionHolder.getBeanDefinition(); val candidateTypeName = beanDefinitionHolder.getBeanName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candidateTypeName.equals(dependencyTypeName) &amp;&amp; candidateBeanDefinition.getBeanClass() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> candidateResolver.isAutowireCandidate(beanDefinitionHolder, descriptor); }</code> </pre> <br></div></div><br>  Aqui, ele obt√©m a representa√ß√£o em string do tipo de depend√™ncia na descri√ß√£o da depend√™ncia, obt√©m o nome do bean em BeanDefinition (que j√° cont√©m a representa√ß√£o em string do tipo de bean), depois os compara e, se corresponderem, retornar√° true.  Se n√£o corresponderem, ele delega para o resolvedor interno. <br><br><h2>  Op√ß√µes de umedecimento da bandeja de teste </h2><br>  No total, em testes, podemos usar as seguintes op√ß√µes para umecta√ß√£o de lixeira: <br><br><ul><li>  Configura√ß√£o Java - ser√° imperativo, complicado, com um padr√£o, mas, talvez, o mais informativo poss√≠vel; <br></li><li>  <code>@MockBean</code> - ser√° declarativo, menos volumoso que o Java Config, mas ainda haver√° um pequeno boilerplate na forma de campos com depend√™ncias que n√£o s√£o usadas no pr√≥prio teste; <br></li><li>  <code>@Automocked</code> Resolvedor <code>@Automocked</code> + personalizado - c√≥digo m√≠nimo em testes e clich√™, mas com escopo potencialmente bastante estreito e isso ainda precisa ser gravado.  Mas pode ser muito conveniente onde voc√™ deseja garantir que a mola crie proxies corretamente. <br></li></ul><br><h2>  Adicionar decoradores </h2><br>  Nossa equipe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ama o</a> modelo de design <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">do Decorator</a> por sua flexibilidade.  De fato, aspectos implementam esse padr√£o espec√≠fico.  Mas, se voc√™ configurar o contexto da primavera com anota√ß√µes e usar a varredura de pacotes, ter√° um problema.  Se voc√™ tiver v√°rias implementa√ß√µes da mesma interface no contexto, quando o aplicativo <b>iniciar</b> , uma <b>NoUniqueBeanDefinitionException cair√°</b> , ou seja,  a primavera n√£o ser√° capaz de descobrir qual dos gr√£os deve ser injetado.  Esse problema tem v√°rias solu√ß√µes e, em seguida, vamos examin√°-las, mas primeiro, vamos descobrir como nosso aplicativo ser√° alterado. <br><br>  Agora as interfaces <b>FortuneTeller</b> e <b>HoroscopeTeller</b> t√™m uma implementa√ß√£o, adicionaremos mais 2 implementa√ß√µes para cada uma das interfaces: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f1b/efb/01b/f1befb01b6356587cfe2c1728c7f2b0f.png"><br><br><ul><li>  Armazenamento em cache ... - decorador de armazenamento em cache; <br></li><li>  Logging ... √© um decorador de logging. <br></li></ul><br>  Ent√£o, como voc√™ resolve o problema de determinar a ordem dos beans? <br><br><h2>  Configura√ß√£o Java com decorador de n√≠vel superior </h2><br>  Voc√™ pode usar o Java Config novamente.  Nesse caso, descreveremos os beans como m√©todos da classe config, e teremos que especificar os argumentos necess√°rios para chamar o construtor do bean como argumentos para o m√©todo.  Da√≠ se segue que, no caso de uma altera√ß√£o no construtor da lixeira, teremos que alterar a configura√ß√£o, o que n√£o √© muito legal.  Das vantagens desta op√ß√£o: <br><br><ul><li>  haver√° baixa conectividade entre decoradores, como  a conex√£o entre eles ser√° descrita na configura√ß√£o, ou seja,  eles n√£o saber√£o nada um do outro; <br></li><li>  todas as altera√ß√µes na ordem dos decoradores ser√£o localizadas em um s√≥ lugar - a configura√ß√£o. <br></li></ul><br>  No nosso caso, o Java Config ficar√° assim: <br><br><div class="spoiler">  <b class="spoiler_title">DomainConfig.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DomainConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> FortuneTeller </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fortuneTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Map&lt;FortuneRequest, FortuneResponse&gt; cache, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> FortuneResponseRepository fortuneResponseRepository, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Function&lt;FortuneRequest, PersonalData&gt; personalDataExtractor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> PersonalDataRepository personalDataRepository )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingFortuneTeller( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingFortuneTeller( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Globa(fortuneResponseRepository, personalDataExtractor, personalDataRepository), cache ) ); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HoroscopeTeller </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">horoscopeTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Map&lt;ZodiacSign, Horoscope&gt; cache, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HoroscopeRepository horoscopeRepository )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoggingHoroscopeTeller( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CachingHoroscopeTeller( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gypsy(horoscopeRepository), cache ) ); } }</code> </pre> <br></div></div><br>  Como voc√™ pode ver, para cada uma das interfaces, apenas um bean √© declarado aqui, e os m√©todos cont√™m nos argumentos as depend√™ncias de todos os objetos criados dentro.  Nesse caso, a l√≥gica para criar beans √© bastante √≥bvia. <br><br><h2>  Qualificador </h2><br>  Voc√™ pode usar a anota√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@Qualifier</a> .  Isso ser√° mais declarativo que o Java Config, mas nesse caso voc√™ precisar√° especificar explicitamente o nome do bean do qual o bean atual depende.  Qual a desvantagem implica: maior conectividade entre os compartimentos.  E como a conectividade aumenta, mesmo no caso de uma altera√ß√£o na ordem dos decoradores, as altera√ß√µes ser√£o manchadas uniformemente no c√≥digo.  Ou seja, no caso de adicionar um novo decorador, por exemplo, no meio da cadeia, as altera√ß√µes afetar√£o pelo menos duas classes. <br><br><div class="spoiler">  <b class="spoiler_title">LoggingFortuneTeller.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Primary</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoggingFortuneTeller</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FortuneTeller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FortuneTeller internal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger logger; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoggingFortuneTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @Qualifier(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cachingFortuneTeller"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @NonNull </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> FortuneTeller internal ) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internal = internal; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.logger = getLogger(internal.getClass()); }</code> </pre> <br></div></div><br>        , ,       (      ,  <b>FortuneTeller</b> ,   ),      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@Primary</a> .     <b>internal</b>   <code>@Qualifier</code>    ,     ‚Äî <b>cachingFortuneTeller</b> .         . <br><br><h2> Custom qualifier </h2><br>    2.5       Qualifier',    .     . <br><br>     enum   : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> DecoratorType { LOGGING, CACHING, NOT_DECORATOR }</code> </pre> <br>    ,    qualifier': <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Qualifier</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RUNTIME) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> Decorator { <span class="hljs-function"><span class="hljs-function">DecoratorType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> NOT_DECORATOR</span></span>; }</code> </pre> <br>  :    ,       <code>@Qualifier</code> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CustomAutowireConfigurer</a> ,        . <br><br>         Qualifier'   : <br><br><div class="spoiler"> <b class="spoiler_title">CachingFortuneTeller.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Decorator</span></span>(CACHING) <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CachingFortuneTeller</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FortuneTeller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FortuneTeller internal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;FortuneRequest, FortuneResponse&gt; cache; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CachingFortuneTeller</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @Decorator(NOT_DECORATOR)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> FortuneTeller internal, </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> Map&lt;FortuneRequest, FortuneResponse&gt; cache ) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.internal = internal; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cache = cache; }</code> </pre> <br></div></div><br>   ‚Äì    ,      <code>@Decorator</code>   ,   ,     ‚Äì      ,      <u> </u> ,     <b>FortuneTeller</b> ',    ‚Äì <b>Globa</b> . <br><br>       Qualifier' - , - . ,          ,     . ,      -    ‚Äì      ,     ,      . <br><br><h2> DecoratorAutowireCandidateResolver </h2><br>   ‚Äì   !      ! :)   ,     -     ,   Java Config',        . ,   -    ,     .     : <br><br><div class="spoiler"> <b class="spoiler_title">DomainConfig.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DomainConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> OrderConfig&lt;FortuneTeller&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fortuneTellerOrderConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () -&gt; asList( LoggingFortuneTeller.class, CachingFortuneTeller.class, Globa.class ); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> OrderConfig&lt;HoroscopeTeller&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">horoscopeTellerOrderConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> () -&gt; asList( LoggingHoroscopeTeller.class, CachingHoroscopeTeller.class, Gypsy.class ); } }</code> </pre> <br></div></div><br>     ‚Äì    Java Config'       ,       ‚Äì . ,     ! <br><br>     -   .   , ,    ,      .    : <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@FunctionalInterface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderConfig</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ List&lt;Class&lt;? extends T&gt;&gt; getClasses(); }</code> </pre> <br><h3> BeanDefinitionRegistryPostProcessor </h3><br>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BeanDefinitionRegistryPostProcessor</a> ,   BeanFactoryPostProcessor,   , ,  ,      BeanDefinition'.  ,      BeanFactoryPostProcessor,    . <br><br>    : <br><br><ul><li>   BeanDefinition'; <br></li><li>  BeanDefinition' ,   <b>OrderConfig</b> '.  , ..              BeanDefinition'   ; <br></li><li>   ,   <b>OrderConfig</b> ',  BeanDefinition',    ,     () . <br></li></ul><br><h3> BeanFactoryPostProcessor </h3><br>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BeanFactoryPostProcessor</a> ,      BeanDefinition'  ,    . ,      ¬´ Spring-¬ª. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/459/cac/4c5/459cac4c50791a09e9195d53fe51b9e0.png"><br><br> ,      , ‚Äì       AutowireCandidateResolver': <br><br><div class="spoiler"> <b class="spoiler_title">DecoratorAutowireCandidateResolverConfigurer.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorAutowireCandidateResolverConfigurer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeanFactoryPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessBeanFactory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ConfigurableListableBeanFactory configurableListableBeanFactory)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> BeansException </span></span>{ Assert.state(configurableListableBeanFactory <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> DefaultListableBeanFactory, <span class="hljs-string"><span class="hljs-string">"BeanFactory needs to be a DefaultListableBeanFactory"</span></span>); val beanFactory = (DefaultListableBeanFactory) configurableListableBeanFactory; beanFactory.setAutowireCandidateResolver( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DecoratorAutowireCandidateResolver(beanFactory.getAutowireCandidateResolver()) ); } }</code> </pre> <br></div></div><br><br><h3> DecoratorAutowireCandidateResolver </h3><br>       : <br><div class="spoiler"> <b class="spoiler_title">DecoratorAutowireCandidateResolver.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecoratorAutowireCandidateResolver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutowireCandidateResolver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AutowireCandidateResolver resolver; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAutowireCandidate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> BeanDefinitionHolder bdHolder, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DependencyDescriptor descriptor)</span></span></span><span class="hljs-function"> </span></span>{ val dependentType = descriptor.getMember().getDeclaringClass(); val dependencyType = descriptor.getDependencyType(); val candidateBeanDefinition = (AbstractBeanDefinition) bdHolder.getBeanDefinition(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dependencyType.isAssignableFrom(dependentType)) { val candidateQualifier = candidateBeanDefinition.getQualifier(OrderQualifier.class.getTypeName()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candidateQualifier != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dependentType.getTypeName().equals(candidateQualifier.getAttribute(<span class="hljs-string"><span class="hljs-string">"value"</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resolver.isAutowireCandidate(bdHolder, descriptor); }</code> </pre> <br></div></div><br>    descriptor'   (dependencyType)     (dependentType): <br><br><pre> <code class="java hljs">val dependentType = descriptor.getMember().getDeclaringClass(); val dependencyType = descriptor.getDependencyType();</code> </pre> <br>    bdHolder' BeanDefinition: <br><br><pre> <code class="java hljs">val candidateBeanDefinition = (AbstractBeanDefinition) bdHolder.getBeanDefinition();</code> </pre> <br>       .    ,     : <br><br><pre> <code class="java hljs">dependencyType.isAssignableFrom(dependentType)</code> </pre> <br>    ,      , ..      . <br><br>   BeanDefinition'       : <br><br><pre> <code class="java hljs">val candidateQualifier = candidateBeanDefinition.getQualifier(OrderQualifier.class.getTypeName());</code> </pre> <br>    ,         : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candidateQualifier != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dependentType.getTypeName().equals(candidateQualifier.getAttribute(<span class="hljs-string"><span class="hljs-string">"value"</span></span>)); }</code> </pre> <br>    ‚Äì     (),   ‚Äì  false. <br><br><h3>    </h3><br><ul><li> ,           <a href="">ConfigurationClassBeanDefinitionReader</a> '; <br></li><li>              ,   BeanDefintion'    Qualifier'.                 ,      . <br></li></ul><br><h2>     </h2><br> ,          : <br><br><ul><li> Java Config ‚Äì   ,  ,      ,        ; <br></li><li> <code>@Qualifier</code> ‚Äì  ,      -       ; <br></li><li> Custom qualifier ‚Äì   ,     Qualifier',   ; <br></li><li>     - ‚Äì ,  ,     ,     . <br></li></ul><br><h2>  </h2><br>  ,          ,     .           ‚Äì :   .    ,               , ,  .    ‚Äì   ,            JRE.     ,      ,   . <br><br>   ,      ‚Äì  ,   ,        - .  Obrigado pela leitura! <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todas as fontes est√£o dispon√≠veis em: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/monosoul/spring-di-customization</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435364/">https://habr.com/ru/post/pt435364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435352/index.html">Confer√™ncia DEFCON 18. Espionagem pr√°tica usando um telefone celular. Parte 2</a></li>
<li><a href="../pt435354/index.html">Confer√™ncia DEFCON 18. Espionagem pr√°tica usando um telefone celular. Parte 1</a></li>
<li><a href="../pt435358/index.html">Antiguidades: Minidisk na era do iPod</a></li>
<li><a href="../pt435360/index.html">Snippets vs Clover - supere o teste em tempo real mais popular</a></li>
<li><a href="../pt435362/index.html">Speed ‚Äã‚Äãhash</a></li>
<li><a href="../pt435368/index.html">Anatomia patol√≥gica no local de trabalho</a></li>
<li><a href="../pt435372/index.html">Algumas palavras sobre o FastPath e o FastTrack no MikroTik</a></li>
<li><a href="../pt435374/index.html">A matem√°tica em Gamedev √© simples. Triangula√ß√£o e Triangle.Net em Unity</a></li>
<li><a href="../pt435376/index.html">Space 2019: naves tripuladas, novos foguetes e sondas lunares</a></li>
<li><a href="../pt435380/index.html">Contas gratuitas no GitHub poder√£o [quase] sem restri√ß√µes trabalhar com reposit√≥rios privados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>