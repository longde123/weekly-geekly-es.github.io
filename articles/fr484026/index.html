<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ù£Ô∏è ‚ôäÔ∏è üëõ Partie 6: Portage de MemTest86 + vers RISC-V ü§¶üèæ üë®üèª‚Äçüç≥ üë©üèø‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Peu de sp√©cialistes informatiques ont probablement besoin d'expliquer ce qu'est Memtest86 + - peut-√™tre est-il d√©j√† devenu plus ou moins la norme pour...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Partie 6: Portage de MemTest86 + vers RISC-V</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484026/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ne/fb/ha/nefbhar5ihkfmvccfwp0jqrm78u.png"></div><br><p> Peu de sp√©cialistes informatiques ont probablement besoin d'expliquer ce qu'est Memtest86 + - peut-√™tre est-il d√©j√† devenu plus ou moins la norme pour tester la RAM sur un PC.  Lorsque dans l'une des <a href="https://habr.com/ru/post/459470/">parties pr√©c√©dentes,</a> j'ai rencontr√© une barre de m√©moire cass√©e fournie avec la carte, elle (avec un netbook compatible DDR2) semblait une solution √©vidente.  Une autre question est que l√†, en principe, le fonctionnement instable du syst√®me √©tait visible √† l'≈ìil nu.  Dans des cas plus d√©licats, j'ai entendu qu'en plus du ¬´tapotement¬ª banal des cellules de m√©moire √† l'infini, cet outil utilise des mod√®les de donn√©es sp√©ciaux sur lesquels les erreurs de fonctionnement DDR sont plus susceptibles d'√™tre d√©tect√©es.  En g√©n√©ral, une chose merveilleuse, il est dommage que m√™me dans le nom, il est dit: 86 - "Uniquement pour les syst√®mes compatibles x86."  Ou pas? </p><br><p>  Sous la coupe, vous verrez mes tentatives de portage de MemTest86 + v5.1 sur RISC-V et le sous-total.  <em>Spoiler: √ßa bouge!</em> </p><a name="habracut"></a><br><p>  <strong>AVERTISSEMENT: le projet r√©sultant a √©t√© test√© de mani√®re minimale sp√©cifiquement par moi sur un assemblage RocketChip sp√©cifique sur une carte sp√©cifique.</strong>  <strong>La pr√©cision et la s√©curit√© (en particulier sur d'autres syst√®mes) ne sont pas garanties.</strong>  <strong>Utilisez √† vos risques et p√©rils.</strong>  <strong>En particulier, les zones de m√©moire actuellement r√©serv√©es ne sont en aucun cas trait√©es si elles tombent dans la plage de RAM.</strong> </p><br><p>  Comme je l'ai d√©j√† dit, il n'y a pas si longtemps, j'ai achet√© une carte m√®re avec Cyclone IV sur AliExpress, mais sa m√©moire √©tait bogu√©e.  Heureusement, l'une des caract√©ristiques importantes de cette carte √©tait l'utilisation de modules SO-DIMM DDR2 conventionnels - les m√™mes que dans mon ancien netbook.  N√©anmoins, il serait int√©ressant d'obtenir, pour ainsi dire, une solution auto-h√©berg√©e pour tester les modules de m√©moire (et, en fait, √©galement le contr√¥leur).  La perspective de d√©boguer mes erreurs dans des conditions de mauvaise m√©moire n'√©tait pas du tout agr√©able.  N'esp√©rant surtout pas une solution rapide et me pr√©parant mentalement √† reporter la r√©√©criture compl√®te dans un autre assembleur pour une dur√©e ind√©finie, j'ai ouvert un article Wikipedia sur Memtest86 + et j'ai soudainement vu ¬´Written in: C and assembly¬ª dans la carte.  Hmm, c'est-√†-dire lui, bien que "... 86", mais n'est pas √©crit enti√®rement en assembleur?  C'est encourageant.  Il ne reste plus qu'√† comprendre la relation. </p><br><p>  Alors, allez sur <a href="http://www.memtest.org/" rel="nofollow">memtest.org</a> et t√©l√©chargez la version 5.01 sous GPL2.  Pour faciliter le d√©veloppement, je l'ai <a href="https://github.com/atrosinenko/memtest86-plus-riscv" rel="nofollow">recharg√©</a> sur GitHub.  Heureusement, directement dans l'archive source, nous sommes accueillis par le fichier <a href="https://github.com/atrosinenko/memtest86-plus-riscv/blob/68b365d13cf22accd52f88af49c33f57c6643ae5/README.background" rel="nofollow">README.background</a> , intitul√© </p><br><blockquote>  L'anatomie et la physiologie de Memtest86-SMP </blockquote><p> Il explique en d√©tail (et m√™me avec des images sous forme d'art ASCII) le fonctionnement de haut niveau du code.  Au tout d√©but du document, nous voyons une <em>disposition binaire</em> , compos√©e de <code>bootsect.o</code> , <code>setup.o</code> , <code>head.o</code> et quelques <code>memtest_shared</code> .  Il est facile de voir que ces trois fichiers objets sont obtenus √† partir des sources d'assembleur correspondantes.  √Ä premi√®re vue, tout le reste est √©crit en C!  Pas mal, pas mal ... </p><br><p>  En cons√©quence, j'ai copi√© le <code>Makefile</code> dans <code>Makefile.arch</code> et j'ai commenc√© √† tout r√©√©crire et √† essayer de jeter ce qui ne correspond pas.  Tout d'abord, bien s√ªr, j'avais besoin d'une cha√Æne d'outils pour RISC-V, qui, heureusement, est toujours avec moi depuis les exp√©riences pr√©c√©dentes.  Au d√©but, j'ai pens√© √† cr√©er un port pour l'architecture 32 bits, mais ensuite je me suis souvenu qu'un processeur 64 bits avait √©t√© t√©l√©charg√© sur la carte, et j'avais la <code>riscv64-</code> d' <code>riscv64-</code> avec le pr√©fixe <code>riscv64-</code> . </p><br><p>  <em>Digression lyrique:</em> bien s√ªr, la premi√®re chose a √©t√© d'√©tudier la question de la compatibilit√© du code 32 et 64 bits.  En cons√©quence, la sp√©cification pour la partie non privil√©gi√©e de l'ISA (Instruction Set Architecture) se trouve au paragraphe <code>1.3 RISC-V ISA Overview</code> d√©claration <code>1.3 RISC-V ISA Overview</code> : </p><br><blockquote>  Le principal avantage de la s√©paration explicite des ISA de base est que chaque ISA de base peut √™tre optimis√©e pour ses besoins sans n√©cessiter de prendre en charge toutes les op√©rations n√©cessaires pour les autres ISA de base.  Par exemple, RV64I peut omettre des instructions et des CSR qui ne sont n√©cessaires que pour g√©rer les registres plus √©troits dans RV32I.  Les options RV32I peuvent utiliser l'espace de codage autrement r√©serv√© aux instructions requises uniquement par des variantes d'espace d'adressage plus larges. </blockquote><p>  Je tiens √©galement √† noter que la cha√Æne d'outils avec le pr√©fixe <code>riscv64-</code> est susceptible de collecter facilement du code 32 bits si l'architecture cible est correctement s√©lectionn√©e - plus √† ce sujet plus tard. </p><br><p>  Lors du portage, il est judicieux de garder ces documents √† port√©e de main: </p><br><ul><li>  <a href="https://riscv.org/specifications/" rel="nofollow">Manuel d'instructions RISC-V Volume I: ISA non privil√©gi√©</a> </li><li>  <a href="https://riscv.org/specifications/privileged-isa/" rel="nofollow">Manuel d'instructions RISC-V Volume II: Architecture privil√©gi√©e</a> </li><li>  De plus, certains <a href="https://sifive.cdn.prismic.io/sifive%252F834354f0-08e6-423c-bf1f-0cb58ef14061_fu540-c000-v1.0.pdf" rel="nofollow">manuels SiFive FU540-C000</a> - un manuel pour la puce, similaire au comportement d'un processeur logiciel, qui est utilis√© pour le d√©bogage dans les FPGA, ne seront pas <a href="https://sifive.cdn.prismic.io/sifive%252F834354f0-08e6-423c-bf1f-0cb58ef14061_fu540-c000-v1.0.pdf" rel="nofollow">d√©plac√©s.</a> </li></ul><br><h2 id="nastroyka-sborki">  Configuration de la construction </h2><br><p>  Commen√ßons par accepter: je veux obtenir un port adapt√© pour un portage ult√©rieur vers des architectures autres que x86 et RISC-V.  Je propose √©galement de supprimer les disquettes de d√©marrage et autres sp√©cificit√©s x86 de la construction multiplateforme. </p><br><p>  Ce que nous avons finalement: il y a trois fichiers assembleur: <code>bootsect.S</code> , <code>setup.S</code> et <code>head.S</code>  Les deux premiers sont n√©cessaires uniquement au d√©marrage, et le troisi√®me est n√©cessaire plus tard lors du d√©placement vers une autre zone de m√©moire.  Le fait est que pour tester la m√©moire "sous soi", le code de test doit d'abord se d√©placer vers un nouvel endroit.  Ces fichiers sont collect√©s dans ELF, √† partir desquels des sections de code, de donn√©es, etc. sont ensuite extraites.  De plus, il est collect√© sous forme de PIC (Position Independent Code) - au d√©but, j'ai m√™me √©t√© surpris: bien que le code soit autonome (c'est-√†-dire sans noyau, libc, etc.), il utilise de telles fonctionnalit√©s avanc√©es. </p><br><p>  De plus, les param√®tres qui d√©finissent l'architecture se rencontrent p√©riodiquement dans le Makefile: <code>-march=i486</code> , <code>-m32</code> et similaires.  J'ai besoin d'√©crire quelque chose comme √ßa, <del>  puis comme une ventouse </del>  .  La situation avec l'architecture RISC-V est quelque chose comme ceci: il existe des <code>rv64</code> <code>rv32</code> et <code>rv64</code> (comme, il y a toujours le plus tronqu√© embarqu√© et rv128 r√©serv√© pour l'avenir, mais nous ne sommes pas tr√®s int√©ress√©s par elles), et le nom ISA est form√© en assignant des lettres √† ce pr√©fixe extensions: <code>i</code> - l'ensemble d'instructions de base entier, <code>m</code> - multiplication et division d'entiers, ... Bien s√ªr, je voudrais faire <code>rv64i</code> , mais Memtest86 ne sera pas facilement port√© sur l'architecture sans multiplication.  Certes, il semble que le compilateur g√©n√®re simplement des appels de fonction au lieu d'instructions ¬´probl√©matiques¬ª, mais il y a un risque de rester avec des performances consid√©rablement r√©duites (sans parler du fait que ces fonctions devront √™tre √©crites ou prises quelque part). </p><br><p>  Vous aurez √©galement besoin de la ligne ABI.  En principe, les bases de la convention d'appel sont d√©j√† d√©crites dans le <code>Volume I</code> sp√©cifi√© dans le "Manuel du programmeur d'assemblage RISC-V", donc je vais faire quelque chose comme </p><br><pre> <code class="plaintext hljs">$ riscv64-linux-gnu-gcc-9 -mabi=help riscv64-linux-gnu-gcc-9: error: unrecognized argument in option '-mabi=help' riscv64-linux-gnu-gcc-9: note: valid arguments to '-mabi=' are: ilp32 ilp32d ilp32e ilp32f lp64 lp64d lp64f riscv64-linux-gnu-gcc-9: fatal error: no input files compilation terminated.</code> </pre> <br><p>  Et sans r√©fl√©chir √† <code>lp64</code> , je prendrai <code>lp64</code> .  <em>Pour l'avenir, je dirai qu'avec cet ABI, les fichiers d'en-t√™te de la biblioth√®que standard ne fonctionnaient pas, j'ai donc pris <code>lp64f</code> et ARCH ¬´mis √† niveau¬ª vers <code>rv64imf</code> .</em>  <em>Sans panique, je ne compte pas vraiment utiliser de virgule flottante dans mon port.</em> </p><br><p>  √âtant donn√© que je ne voulais pas approfondir l'√©criture de scripts de l'√©diteur de liens multiplateforme - et que je ne pouvais donc pas <em>trouver</em> imm√©diatement <em>les cl√©s de ld</em> , j'ai d√©cid√© de m'en sortir avec le fichier <code>head.S</code> l'assembleur, accroch√© au reste des fonctions en utilisant <code>memtest_shared.arch.lds</code> .  J'ai jet√© une indication du format de sortie et de l'architecture √† partir de celui-ci (apr√®s tout, il est plus facile de le changer √† partir d'une variable dans le Makefile), et j'ai √©galement temporairement comment√© <code>DISCARD</code> √† la fin, ne pouvant pas d√©terminer quelles sections sp√©cifiques des informations de d√©bogage dont j'avais besoin.  <em>(Pour l'avenir: de bonnes informations de d√©bogage, mais <code>.rela</code> a d√ª √™tre ajout√©) De</em> mani√®re g√©n√©rale, la version x86 a soulign√© la n√©cessit√© de tenir en 64k - j'esp√®re que cela est en quelque sorte li√© aux fonctionnalit√©s du mode r√©el et ne nous concerne pas sur RISC-V .  En cons√©quence, l'objet partag√© avec le PIC sera collect√©, comme dans l'original, le code et les donn√©es qui seront charg√©s en m√©moire en seront mordus. </p><br><p>  Nous collectons ... et la compilation tombe sur le premier fichier <code>reloc.c</code> - apparemment, il est tir√© de certains <code>ld-linux.so</code> et est responsable de la prise en charge de la table de d√©calage global, etc.  selon les conventions d'appel pour x86.  Il s'est av√©r√© qu'il fallait travailler directement avec les registres √† l'aide d'inserts d'assembleur.  Mais nous sommes √† RISC-V - il a √©t√© initialement con√ßu pour prendre en charge nativement PIC, alors n'h√©sitez pas √† lancer <code>reloc.c</code> .  De plus, il y avait encore des encarts, parfois assez longs.  Heureusement, ils √©taient soit dans le code de test imm√©diatement apr√®s le code C comment√©, qu'ils optimisent (√† partir d'eux, j'ai √† nouveau cr√©√© des morceaux de code √† part enti√®re commut√©s par la directive du pr√©processeur) ou quelque chose de d√©pendant de la plate-forme, sans lequel, dans les cas extr√™mes, je peux (probablement) faire (comme activer / d√©sactiver le cache, soustraire le CPUID, etc.).  Enfin, il y avait des choses comme l'appel <code>rdtsc</code> , que moi <code>rdtsc</code> , sans gros probl√®mes, j'ai mis dans un en-t√™te d√©pendant de la plate-forme et l'avons impl√©ment√© conform√©ment √† la documentation sur RISC-V. </p><br><p>  En cons√©quence, nous avons obtenu le r√©pertoire <code>arch/i386</code> , o√π une grande quantit√© de code de support PCI a √©t√© d√©plac√©e, a lu les informations des chipsets, les d√©finitions sp√©cifiques √† la plate-forme des adresses mapp√©es en m√©moire, etc.  De plus, le d√©but de la fonction <code>test_start</code> est <code>test_start</code> , qui est le point d'entr√©e de <code>setup.S</code> au code C. Combien de temps, court, mais commentant tout ce qui est possible et r√©alisant tout ce qui ne peut pas √™tre comment√© sous RISC-V (comme <code>setup.S</code> et le code pour travailler avec port s√©rie dans l'impl√©mentation SiFive), j'ai obtenu le <code>arch/riscv</code> , avec lequel tout a √©t√© plus ou moins compil√©. </p><br><p>  Ici, je suis oblig√© de pr√©ciser que les exp√©riences elles-m√™mes ont √©t√© partiellement r√©alis√©es avant la r√©daction de l'article, de sorte qu'une <em>s√©quence</em> sp√©cifique <em>d'</em> actions peut contenir une certaine quantit√© de ¬´fiction artistique¬ª.  Cependant, j'essaie au moins de mener la pr√©sentation de telle mani√®re qu'elle repr√©sente en tout cas l'un des chemins possibles <em>(je suis programmeur, je m'en souviens)</em> .  Voyons donc comment tout d√©marrer. </p><br><h2 id="zapusk-na-zheleze">  Courir sur le fer </h2><br><p>  Depuis les exp√©riences pass√©es, j'ai toujours un ¬´support¬ª poussi√©reux du Raspberry Pi, c√¢bl√© √† la carte de d√©bogage.  Les fils fournissent UART, JTAG et un adaptateur avec une carte SD.  Un certain processeur RV64 avec un contr√¥leur DDR2 est cousu dans la m√©moire de configuration.  Comme par le pass√©, j'allume la ¬´framboise¬ª, j'ouvre deux sessions SSH avant celle-ci, dont l'une transmet le port TCP 3333 pour connecter gdb √† OpenOCD.  Dans l'une des sessions, je d√©marre minicom pour surveiller UART, dans un autre - openocd pour d√©boguer √† partir de l'h√¥te via JTAG.  J'allume la puissance de la carte - et les messages dans la console sur la fa√ßon dont elle charge les donn√©es de la SD ont couru. </p><br><p>  Vous pouvez maintenant ex√©cuter la commande: </p><br><pre> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:3333' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80010000' \ -ex 'add-symbol-file /path/to/memtest_shared 0x80010000' -ex 'set $pc=0x80010000'</code> </pre> <br><p>  les options <code>-ex</code> gdb de pr√©tendre que l'utilisateur a entr√© ces commandes depuis la console: </p><br><ul><li>  le premier √©tablit une connexion avec OpenOCD </li><li>  le second copie le contenu du fichier h√¥te sp√©cifi√© √† l'adresse indiqu√©e </li><li>  le troisi√®me explique √† gdb que les informations sur le code source doivent √™tre extraites de <em>ce</em> fichier, en tenant compte du fait qu'il a √©t√© t√©l√©charg√© √† <em>cette</em> adresse (et non de ce qui y est indiqu√©) <br><ul><li>  note: on prend les caract√®res du fichier ELF, et on charge le binaire "brut" </li></ul></li><li>  enfin, le quatri√®me traduit de force le pointeur de commande actuel en notre code </li></ul><br><p>  Malheureusement, tout ne se d√©roule pas parfaitement, et bien que les lignes de code du d√©bogueur s'affichent correctement, mais dans toutes les variables globales - les z√©ros.  En fait, si nous ex√©cutons une commande de la forme <code>p &amp;global_var</code> dans gdb, nous voyons, h√©las, l'adresse conform√©ment √† l'adresse de t√©l√©chargement initiale (j'ai <code>0x0</code> ), qui n'est pas sp√©cifi√©e en utilisant <code>add-symbol-file</code> .  Comme b√©quille, mais une solution tr√®s simple, j'ai simplement ajout√© <code>0x80010000</code> √† l'adresse sp√©cifi√©e manuellement et j'ai regard√© le contenu de la m√©moire via <code>x/x 0xADDR</code> .  En fait, il serait possible d'indiquer temporairement l'adresse de d√©part correcte dans le script de l'√©diteur de liens, qui co√Øncide actuellement avec l'adresse de t√©l√©chargement dans <em>cette configuration de test</em> . </p><br><h2 id="osobennosti-relokacii-na-sovremennyh-arhitekturah">  Caract√©ristiques de la relocalisation sur des architectures modernes </h2><br><p>  Eh bien, comment t√©l√©charger le code d'une mani√®re ou d'une autre, nous l'avons compris - nous le commen√ßons.  Ne marche pas.  Le d√©bogage √©tape par √©tape montre que nous tombons pendant le fonctionnement de la fonction <code>switch_to_main_stack</code> - il semble qu'il essaie toujours d'utiliser la valeur non li√©e de l'adresse du symbole correspondant √† la pile de travail. </p><br><p>  Tout de m√™me, le premier volume de documentation nous parle de diff√©rentes pseudo-instructions et de leur travail avec et hors tension PIC: </p><br><p><img src="https://habrastorage.org/webt/vj/7-/_u/vj7-_uqmqyqjloo1webrgpqsdc8.png" alt="Quelques pseudo-instructions RISC-V"></p><br><p>  Comme vous pouvez le voir, le principe g√©n√©ral est que les adresses en m√©moire sont compt√©es √† partir de l'instruction en cours, la premi√®re ajoutant le haut de l'offset et la suivante <code>add</code> polissant les bits de poids faible.  Il est difficile de d√©clarer une variable globale comme </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vars</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variables</span></span></span><span class="hljs-class">;</span></span></code> </pre> <br><p>  Par cons√©quent, nous prenons la documentation psABI RISC-V ELF avec des <a href="" rel="nofollow">descriptions des types de d√©localisations</a> et √©crivons la partie sp√©cifique √† la plate-forme pour <code>reloc.c</code> .  Ici, il convient de noter que le fichier d'origine, apparemment, a √©t√© extrait du code multiplateforme.  L√†, m√™me au lieu de sp√©cifier une profondeur de bits sp√©cifique, des macros du type <code>ElfW(Addr)</code> , qui sont d√©velopp√©es dans <code>Elf32_Addr</code> ou <code>Elf64_Addr</code> .  Pas partout, cependant, c'est pourquoi nous les ajoutons l√† o√π ils ne sont pas dans le code g√©n√©ral (ainsi que dans le <a href="" rel="nofollow"><code>arch/riscv/reloc.inc.c</code></a> - apr√®s tout, pour RISC-V, il n'y a pas de sens particulier √† √™tre li√© √† une profondeur de bits sp√©cifique, o√π il n'est pas requis). </p><br><p>  En cons√©quence, <code>switch_to_main_stack</code> commenc√© √† passer (pas sans instructions d'assembleur d√©pendant de la plate-forme, bien s√ªr).  Le d√©bogueur affiche toujours des variables globales de mani√®re tordue.  Eh bien, d'accord :( </p><br><h2 id="opredelenie-oborudovaniya">  D√©finition du mat√©riel </h2><br><p>  Bien s√ªr, pour les tests, il serait possible d'utiliser des constantes cod√©es en dur au lieu du code de d√©finition d'√©quipement qui a √©t√© jet√©, mais pour chaque assemblage de processeur sp√©cifique, la reconstruction de memtest est m√™me trop co√ªteuse selon les normes de mon application.  Par cons√©quent, nous agirons "comme des adultes s√©rieux".  Heureusement, sur RISC-V (et probablement sur la plupart des architectures modernes), il est habituel que le chargeur de d√©marrage transmette un code au <a href="https://en.wikipedia.org/wiki/Device_tree" rel="nofollow">Device Tree Blob</a> , qui est une version compil√©e de la description DTS comme ceci: </p><br><div class="spoiler">  <b class="spoiler_title">zeowaa-1gb.dts</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/dts-v1/; / { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-dev"; model = "freechips,rocketchip-unknown"; chosen { bootargs = "console=ttySIF0,125200 debug loglevel=7"; }; firmware { sifive,uboot = "YYYY-MM-DD"; }; L16: aliases { serial0 = &amp;L8; }; L15: cpus { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; timebase-frequency = ^_^ltÛ¥âÄgt^_^; L5: cpu@0 { device_type = "cpu"; clock-frequency = ^_^lt&amp;#0;gt^_^; compatible = "sifive,rocket0", "riscv"; d-cache-block-size = ^_^lt gt^_^; d-cache-sets = ^_^lt@gt^_^; d-cache-size = ^_^lt·ÄÄgt^_^; d-tlb-sets = ^_^lt gt^_^; d-tlb-size = ^_^lt gt^_^; i-cache-block-size = ^_^lt gt^_^; i-cache-sets = ^_^lt@gt^_^; i-cache-size = ^_^lt·ÄÄgt^_^; i-tlb-sets = ^_^lt gt^_^; i-tlb-size = ^_^lt gt^_^; mmu-type = "riscv,sv39"; next-level-cache = &lt;&amp;L10&gt;; reg = &lt;0x0&gt;; riscv,isa = "rv64imafdc"; status = "okay"; timebase-frequency = ^_^ltÛ¥âÄgt^_^; tlb-split; L3: interrupt-controller { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,cpu-intc"; interrupt-controller; }; }; }; L10: ram@80000000 { device_type = "memory"; reg = &lt;0x0 0x80000000 0x0 0x40000000&gt;; reg-names = "mem"; }; L14: soc { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt gt^_^; compatible = "freechips,rocketchip-unknown-soc", "simple-bus"; ranges; L1: clint@2000000 { compatible = "riscv,clint0"; interrupts-extended = &lt;&amp;L3 3 &amp;L3 7&gt;; reg = &lt;0x2000000 0x10000&gt;; reg-names = "control"; }; L2: debug-controller@0 { compatible = "sifive,debug-013", "riscv,debug-013"; interrupts-extended = &lt;&amp;L3 65535&gt;; reg = &lt;0x0 0x1000&gt;; reg-names = "control"; }; L9: gpio@64002000 { #gpio-cells = ^_^lt gt^_^; #interrupt-cells = ^_^lt gt^_^; compatible = "sifive,gpio0"; gpio-controller; interrupt-controller; interrupt-parent = &lt;&amp;L0&gt;; interrupts = &lt;3 4 5 6 7 8&gt;; reg = &lt;0x64002000 0x1000&gt;; reg-names = "control"; }; L0: interrupt-controller@c000000 { #interrupt-cells = ^_^lt gt^_^; compatible = "riscv,plic0"; interrupt-controller; interrupts-extended = &lt;&amp;L3 11 &amp;L3 9&gt;; reg = &lt;0xc000000 0x4000000&gt;; reg-names = "control"; riscv,max-priority = ^_^lt gt^_^; riscv,ndev = ^_^lt gt^_^; }; L6: rom@10000 { compatible = "sifive,maskrom0"; reg = &lt;0x10000 0x2000&gt;; reg-names = "mem"; }; L8: serial@64000000 { compatible = "sifive,uart0"; interrupt-parent = &lt;&amp;L0&gt;; clocks = &lt;&amp;tlclk&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64000000 0x1000&gt;; reg-names = "control"; }; L7: spi@64001000 { #address-cells = ^_^lt gt^_^; #size-cells = ^_^lt&amp;#0;gt^_^; compatible = "sifive,spi0"; interrupt-parent = &lt;&amp;L0&gt;; interrupts = ^_^lt gt^_^; reg = &lt;0x64001000 0x1000&gt;; clocks = &lt;&amp;tlclk&gt;; reg-names = "control"; L12: mmc@0 { compatible = "mmc-spi-slot"; disable-wp; reg = &lt;0x0&gt;; spi-max-frequency = ^_^lt gt^_^; voltage-ranges = &lt;3300 3300&gt;; }; }; tlclk: tlclk { #clock-cells = ^_^lt&amp;#0;gt^_^; clock-frequency = ^_^lt gt^_^; clock-output-names = "tlclk"; compatible = "fixed-clock"; }; }; };</code> </pre> </div></div><br><p>  J'avais l'habitude d'analyser des fichiers ELF, mais maintenant je suis √† nouveau convaincu par FDT (arbre de l'appareil plat): ces <a href="https://github.com/devicetree-org/devicetree-specification/releases/download/v0.2/devicetree-specification-v0.2.pdf" rel="nofollow">sp√©cifications</a> <em>aimables</em> <a href="https://github.com/devicetree-org/devicetree-specification/releases/download/v0.2/devicetree-specification-v0.2.pdf" rel="nofollow">sont</a> √©crites par de <em>bonnes personnes attentionn√©es</em> <del>  (Pourtant, ils analysent ensuite eux-m√™mes!) </del>  et l'analyse de ces fichiers (au moins jusqu'√† ce que vous ayez besoin de traiter des entr√©es non fiables) ne pose aucun probl√®me particulier.  Voici donc: au d√©but du fichier, il y a une structure d'en-t√™te simple contenant le nombre magique <code>0xd00dfeed</code> et quelques autres champs.  Nous nous int√©ressons au d√©calage de "l'arbre plat" <code>off_dt_struct</code> et de la table de lignes <code>off_dt_strings</code> .  En fait, vous devez √©galement traiter <code>off_mem_rsvmap</code> , qui √©num√®re les zones de m√©moire qu'il <code>off_mem_rsvmap</code> mieux √©viter.  Je les ignore toujours (ils ne sont pas sur ma planche), mais <strong>ne r√©p√©tez pas cela √† la maison</strong> . </p><br><p>  En principe, le traitement n'est pas particuli√®rement difficile: il suffit de marcher sur un arbre plat en respectant les jetons.  <em>Il existe</em> trois jetons <em>cl√©s</em> : </p><br><ul><li>  <code>FDT_BEGIN_NODE</code> - dans les donn√©es suppl√©mentaires qui le suivent, vient le nom de l'√©l√©ment de sous-arbre sous la forme d'une cha√Æne termin√©e par un caract√®re nul.  Ajoutez simplement le nom √† la pile </li><li>  <code>FDT_END_NODE</code> - la sous-arborescence est termin√©e, supprimez l'√©l√©ment de la pile </li><li>  <code>FDT_PROP</code> - voici un peu plus compliqu√©: il est suivi d'une structure, suivi de len octets de donn√©es suppl√©mentaires.  Le nom de la ¬´variable¬ª se situe √† l'offset <code>nameoff</code> dans la table des cha√Ænes <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> nameoff; }</code> </pre> </li></ul><br><p>  Eh bien, en g√©n√©ral, c'est tout: nous parcourons cette section, sans oublier d'observer l'alignement sur 4 octets.  Oh oui, une mouche dans la pommade: les nombres en FDT sont au grand format endian, donc on fait une fonction simple </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">be32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (x &lt;&lt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | (x &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff0000</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | ((x &amp; <span class="hljs-number"><span class="hljs-number">0xff00</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); }</code> </pre> <br><p>  Par cons√©quent, dans <code>riscv_entry</code> premi√®re chose √† faire est d'analyser FDT, et la partie de <code>head.S</code> qui est charg√©e de transf√©rer le contr√¥le √† <code>riscv_entry</code> ressemble √† quelque chose comme </p><br><pre> <code class="plaintext hljs"> .globl startup_32 #  --    ... startup_32: lla sp, boot_stack_top mv s0, a0 # s0, s1 -- callee-saved mv s1, a1 # ...  .bss #   jal _dl_start #      mv a0, s0 mv a1, s1 j riscv_entry</code> </pre> <br><p>  Dans le registre <code>a0</code> hart id nous est transmis (hart est quelque chose comme un flux mat√©riel dans la terminologie RISC-V) - Je ne l'utilise pas encore, je devrais le comprendre dans un cas √† un seul thread.  En <code>a1</code> chargeur de d√©marrage place un pointeur sur le FDT.  Nous le passons √† la fonction <code>void riscv_entry(ulong hartid, uint8_t *fdt_address)</code> . </p><br><p>  Maintenant, avec l'av√®nement de la parsilka FDT dans mon code, la s√©quence de chargement de la carte est devenue comme ceci: </p><br><ul><li>  allumez le pouvoir </li><li>  attendre la console U-boot </li><li>  entrez des commandes pour pr√©parer le FDT correct.  En particulier, la <code>/chosen/bootargs</code> command <code>/chosen/bootargs</code> stocke la ligne de commande du noyau.  Tout ce que je retire de FDT - plage RAM, adresse UART, ... - peut et doit √™tre laiss√© tel quel <br><pre> <code class="plaintext hljs">run fdtsetup fdt set /chosen bootargs "console=ttyS0 btrace"</code> </pre> </li><li>  √† l'aide de la commande <code>fdt addr</code> , recherchez l'adresse de t√©l√©chargement FDT, si vous n'avez pas regard√© </li></ul><br><p>  Et du c√¥t√© gdb, la commande est ajout√©e </p><br><ul><li> <code>-ex 'set $a1=0xfdtaddr'</code> </li> </ul><br><h2 id="vyvod-informacii-na-ekran">  Sortie d'informations sur l'√©cran </h2><br><p>  Il s'est av√©r√© qu'en plus des insertions d'assembleur, il existe √©galement des adresses de m√©moire connues.  Par exemple <code>SCREEN_ADR</code> (exactement comme √ßa, avec un <code>D</code> ), qui pointe vers la zone correspondant √† ce qui est affich√© √† l'√©cran.  Quand je suis tomb√© sur cela, j'ai simplement plac√© d'un geste large tout ce qui s'y r√©f√®re sous <code>#if HAS_SCREEN</code> , puis <code>#if HAS_SCREEN</code> d√©bogu√© aveugl√©ment pendant longtemps.  Je pensais d√©j√† manuellement une fois de temps en temps pour vider tout cela sur la console, mais j'ai remarqu√© que le m√™me code douloureusement de nombreuses s√©quences d'√©chappement sortaient sur le port s√©rie.  Il s'est av√©r√© que tout avait d√©j√† √©t√© √©crit avant nous, il vous suffit de placer les d√©finitions plus pr√©cis√©ment - et le voici, l'interface famili√®re (bien qu'en noir et blanc) dans la fen√™tre minicom!  (Pour le moment, HAS_SCREEN n'est pas utilis√© du tout - je viens de d√©marrer le tableau <code>dummy_con</code> pour changer le code d'origine au minimum.) </p><br><h2 id="otladka-na-qemu">  D√©bogage sur QEMU </h2><br><p>  J'ai donc tout d√©bogu√© sur un vrai tableau, et depuis un certain temps maintenant - m√™me pas aveugl√©ment.  Mais tout ralentit sur JTAG - l'horreur!  Eh bien, au final, tout devrait fonctionner sur du vrai mat√©riel, mais ce serait bien de d√©boguer sur QEMU.  Apr√®s un certain nombre d'exp√©riences, quelque chose s'est av√©r√© √™tre une b√©quille, mais tr√®s similaire au travail avec une planche: </p><br><pre> <code class="plaintext hljs">$ qemu-system-riscv64 -M help Supported machines are: none empty machine sifive_e RISC-V Board compatible with SiFive E SDK sifive_u RISC-V Board compatible with SiFive U SDK spike_v1.10 RISC-V Spike Board (Privileged ISA v1.10) (default) spike_v1.9.1 RISC-V Spike Board (Privileged ISA v1.9.1) virt RISC-V VirtIO Board (Privileged ISA v1.10)</code> </pre> <br><p>  Nous regardons quelles cartes QEMU est pr√™te √† √©muler.  Je suis int√©ress√© par le mat√©riel compatible <code>sifive_u</code> . </p><br><pre> <code class="plaintext hljs">$ qemu-system-riscv64 -M sifive_u,dumpdtb -m 1g # - QEMU      on --  strace   $ ls -l on -rw-rw-r-- 1 trosinenko trosinenko 1923  19 20:14 on $ dtc -I dtb &lt; on &gt; on.dts #   $ vim on.dts #  bootargs $ dtc &lt; on.dts &gt; on.dtb &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 1 is not a phandle reference &lt;stdout&gt;: Warning (clocks_property): /soc/ethernet@100900fc:clocks: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/interrupt-controller@c000000:interrupts-extended: cell 2 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 0 is not a phandle reference &lt;stdout&gt;: Warning (interrupts_extended_property): /soc/clint@2000000:interrupts-extended: cell 2 is not a phandle reference</code> </pre> <br><p>  Nous avons maintenant un blob d'arbre de p√©riph√©rique ¬´fixe¬ª.  <strong>Sans changer la configuration de la VM</strong> (b√©quilles!), Lancez: </p><br><pre> <code class="plaintext hljs">qemu-system-riscv64 \ -M sifive_u -m 1g \ -serial stdio \ -s -S</code> </pre> <br><p>  <code>-serial stdio</code> redirige le port s√©rie vers la console, car les s√©quences d'√©chappement seront activement utilis√©es.  Les options <code>-s -S</code> augmentent respectivement gdbserver et cr√©ent une machine virtuelle √† suspendre.  Vous pouvez t√©l√©charger le code √† l'aide du <code>loader</code> , mais vous devez ensuite red√©marrer QEMU √† chaque fois. </p><br><p>  Vous pouvez vous connecter en utilisant </p><br><pre> <code class="plaintext hljs">riscv64-unknown-elf-gdb \ -ex 'target remote 127.0.0.1:1234' \ -ex 'restore /path/to/on.dtb binary 0x80100000' \ -ex 'restore /path/to/memtest_shared.bin binary 0x80020000' \ -ex 'add-symbol-file memtest_shared 0x80100000' \ -ex 'set $a1=0x80020000' \ -ex 'set $pc=0x80100000'</code> </pre> <br><p>  En cons√©quence, tout fonctionne plus que intelligemment! </p><br><h2 id="obschiy-princip-raboty">  Principe g√©n√©ral de travail </h2><br><p> , ,  ,   Memtest86+   <code>btrace</code> ,        ,      (  ,     QEMU): </p><br><p><img src="https://habrastorage.org/webt/su/lr/qh/sulrqhzmiona327osxqzaikijf0.png" alt="mode btrace"></p><br><p>  ,      , memtest          .     ,      (, trap):  ,   ,   QEMU - !  ¬´¬ª   <code>Illegal instruction</code>  ,    .      <code>mcause</code> (?),   ‚Äî <code>mepc</code> (?),   ‚Äî <code>mtval</code> (    ?),    . </p><br><p><img src="https://habrastorage.org/webt/lc/is/ho/lcishowkkjngpnorx_gkyav-svg.png" alt="Instruction ill√©gale"></p><br><p>   ,      : </p><br><p> <strong>head.S:</strong> </p><br><pre> <code class="plaintext hljs">#       #   = 0 ---   ,   #  ,    ,     ... lla t1, _trap_entry csrw mtvec, t1 # ... _trap_entry: csrr a0, mcause csrr a1, mepc csrr a2, mtval jal riscv_trap_entry</code> </pre> <br><p>  ,        calling convention,  .        memtest,    HiFive_U-Boot,      <code>Volume II</code> : </p><br><p> <strong>arch.c:</strong> </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *errors[] = { <span class="hljs-string"><span class="hljs-string">"Instruction address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Instruction access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Illegal instruction"</span></span>, <span class="hljs-string"><span class="hljs-string">"Breakpoint"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load access fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO address misaligned"</span></span>, <span class="hljs-string"><span class="hljs-string">"Store/AMO access fault"</span></span>, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Instruction page fault"</span></span>, <span class="hljs-string"><span class="hljs-string">"Load page fault"</span></span>, ^_^quot quot^_^, <span class="hljs-string"><span class="hljs-string">"Store/AMO page fault"</span></span>, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">riscv_trap_entry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ulong cause, ulong epc, ulong tval)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[<span class="hljs-number"><span class="hljs-number">32</span></span>]; cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"EXCP: "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cause &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors) / <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(errors[<span class="hljs-number"><span class="hljs-number">0</span></span>])) { cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, errors[cause]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { itoa(buf, cause); cprint(<span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, buf); } cprint(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"PC: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, epc, <span class="hljs-number"><span class="hljs-number">8</span></span>); cprint(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Addr: "</span></span>); hprint3(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, tval, <span class="hljs-number"><span class="hljs-number">8</span></span>); HALT(); }</code> </pre> <br><p>        ‚Äî    ¬´ ¬ª   .   ,   ¬´¬ª    ,  ,      ,  . </p><br><p>         :     .       ,  memtest  :    : ¬´       ,   ,    .        ¬ª.    :  <code>do_test</code>   <code>main.c</code>    2,   (    ),       ‚Äî    ¬´¬ª ,    memtest.       ,    <code>run_at</code> ,    memtest  <code>_start</code>  <code>_end</code>    (   ¬´¬ª  ),  -     spinlock'        <code>goto *addr;</code>        . ,  ,      ¬´¬ª    ,    ¬´¬ª. </p><br><p>      ,    <strong> </strong>  <code>bss</code>    ‚Äî    <code>_dl_start</code>  ,   <code>riscv_entry</code>  ,   trap entry. ,   :     L1I-,   .    ,     <code>fence.i</code> . </p><br><p>   ,  Memtest86+ ‚Äî ,         <code>barrier_s</code>    .       ,          . ,   ,       . </p><br><h2 id="podvodnye-kamni">   </h2><br><p>    ,   :   .   :           .    <em></em> : ,  -       (Own Address,     )   .     ,     ,   .       . -    .   ,   x86 , ,    <code>uint64_t</code>   <code>0x80000002</code>       . ,     : <a href="https://stackoverflow.com/questions/12491578/whats-the-actual-effect-of-successful-unaligned-accesses-on-x86" rel="nofollow"> </a> ,   load/store  x86   ,     ‚Äî .    ,    QEMU    ,  ¬´  ,      ¬ª. </p><br><p> ,     ,  <em>  </em> ‚Äî   unaligned access  .. </p><br><p> ,   ,     RocketChip,   ‚Äî QEMU,   ,  ,   RocketChip ‚Äî unaligned access trap,  QEMU  ¬´  ¬ª. <br>   ¬´misaligned¬ª            ,   </p><br><blockquote> Changed description of misaligned load and store behavior. The specification now allows visible misaligned address traps in execution environment interfaces, rather than just mandating invisible handling of misaligned loads and stores in user mode. Also, now allows access exceptions to be reported for misaligned accesses (including atomics) that should not be emulated. </blockquote><p>  , ,  ‚Äî   ,  user-mode code   ,             .     .   , ,   .   ,       ‚Äî -   machine mode    . ,     <code>rdtsc</code> (x86)  <code>rdtime</code> (rv64),   trap,     . , ,                memory-mapped . </p><br><p>    :      ,  <em> </em>   <code>low_test_addr</code> (       ),  ,   fdt   .   ,  ,  <code>low_test_addr</code>   ,  ,      2   <code>high_test_adr</code>    ‚Ä¶ ,     ‚Äî   : <code>head.S</code>       <code>initial_load_addr</code> ,    <code>riscv_entry</code>    <code>move_to_correct_addr</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">move_to_correct_addr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_start = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_start; <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> cur_end = (<span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span>)&amp;_end; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur_start == low_test_addr || cur_start == high_test_adr) { <span class="hljs-comment"><span class="hljs-comment">//  ,     return; } if (cur_start == initial_load_addr &amp;&amp; (cur_start - low_test_addr) &lt; (cur_end - cur_start) ) { //   " ":   , //           //     ,    ,   //     ... serial_echo_print("FIRST STARTUP RELOCATION...\n"); void *temp_addr = (((uintptr_t)&amp;_end &gt;&gt; 12) + 1) &lt;&lt; 12; run_at(temp_addr, 0); } else { // ,    --- ,  . serial_echo_print("FINAL STARTUP RELOCATION...\n"); run_at(low_test_addr, 0); } }</span></span></code> </pre> <br><p> ,     ‚Äî   ,  memtest ,  RAM  -   .  RISC-V    ,        <code>v-&gt;plim_lower</code> . </p><br><p>     ,   ¬´¬ª ,    -,   ‚Äî  <code>test.c</code>    <code>ulong</code> (  <code>unsigneg long</code> ),   32- x86   <code>uint32_t</code> ,    ¬´ 64 ¬ª   <code>uint64_t</code> .       ¬´!!! Good: ffffffff Real: ffffffff Bad bits: 00000000¬ª.   ?       - -1,  32    1.   ,         ,        0‚Ä¶  ,     : ,  <code>ulong</code>      ( <code>uint32_t</code> ),          ( <code>uintptr_t</code> ). ,       . ,     <code>uint64_t</code>   4. RISC-V  <em></em>  ,       C, ,    ‚Äî    UB. <del>     memtest  UBSan. </del>  ,  ,  UBSan   trap-on-error        JTAG. </p><br><h2 id="upakovyvaem-dlya-zagruzchika">    </h2><br><p> ,  memtest -  ,    ,          U-Boot. </p><br><p>       :    <code>mkimage</code>   U-Boot   <em>  Linux</em> : </p><br><pre> <code class="plaintext hljs">mkimage -A riscv -O linux -T kernel -C none \ -a 0x80000000 -e 0x80000000 \ -n memtest -d memtest.bin memtest.uboot</code> </pre> <br><p>      SD-      </p><br><pre> <code class="plaintext hljs">run mmcsetup; run fdtsetup; fdt set /chosen bootargs "console=ttyS0"; fatload mmc 0:1 82000000 memtest.uboot; bootm fdt; bootm 82000000 - ${fdtaddr}</code> </pre> <br><p> (   ,   <code>run</code>     ‚Äî        ). </p><br><p>      :       FDT: <code>0xbffb7c80</code> . ,  :    <code>ffffffff</code> ,     .     ,         (     ),    :   HiFive_U-Boot      : </p><br><pre> <code class="cpp hljs"> theKernel(machid, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)images-&gt;ft_addr);</code> </pre> <br><p>    ,     </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*theKernel)(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arch, uint params);</code> </pre> <br><p>  ,     , ,  ,  32        ,     <code>head.S</code> : </p><br><pre> <code class="plaintext hljs"> li t0, 0xffffffffL and a1, a1, t0</code> </pre> <br><h2 id="promezhutochnyy-itog">   </h2><br><p> ,  , - ,  ,     ,  : </p><br><ul><li>     x86.       ‚Äî       review         <strong>   </strong> </li><li>   SMP   RISC-V </li><li>        <code>arch/</code> -  </li><li>     <code>test.c</code>  RISC-V (      <code>-O0</code> !) </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484026/">https://habr.com/ru/post/fr484026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484012/index.html">Rationalisez le processus d'√©criture dans un bloc-notes</a></li>
<li><a href="../fr484014/index.html">10 mythes SEO √† laisser derri√®re eux en 2020</a></li>
<li><a href="../fr484016/index.html">Les bases de l'apprentissage en profondeur sur l'exemple de l'auto-encodeur de d√©bogage, num√©ro de pi√®ce 1</a></li>
<li><a href="../fr484018/index.html">C√¥t√© technique informatique du yachting</a></li>
<li><a href="../fr484020/index.html">Qui essayez-vous d'impressionner avec vos d√©lais?</a></li>
<li><a href="../fr484028/index.html">Horseshoe Bend - tablette convertible avec √©cran rabattable</a></li>
<li><a href="../fr484034/index.html">Mise en ≈ìuvre du plan de travail de stockage cibl√© des marchandises bas√© sur l'unit√© de comptabilit√© d'entrep√¥t ¬´1C Integrated Automation 2¬ª</a></li>
<li><a href="../fr484036/index.html">Un nouveau groupe industriel cr√©e une norme universelle pour les maisons intelligentes</a></li>
<li><a href="../fr484046/index.html">V√©rification d'Emby avec PVS-Studio</a></li>
<li><a href="../fr484048/index.html">PHP et expressions r√©guli√®res: les bases pour les d√©butants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>