<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöú üë©üèø‚Äçü§ù‚Äçüë®üèº üëäüèæ Pr√©-carregamento no php 7.4: Compositor e sele√ß√£o de arquivos para pr√©-carregamento üê± üíÖ üí™üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No Badoo, estamos migrando ativamente para o PHP 7.4 e estamos muito entusiasmados com a oportunidade de usar a nova fun√ß√£o de pr√©-carregamento. N√£o f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pr√©-carregamento no php 7.4: Compositor e sele√ß√£o de arquivos para pr√©-carregamento</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/480746/">  No Badoo, estamos migrando ativamente para o PHP 7.4 e estamos muito entusiasmados com a oportunidade de usar a nova fun√ß√£o de pr√©-carregamento.  N√£o faz muito tempo, <a href="https://habr.com/ru/company/badoo/blog/472528/">conversamos</a> sobre nossos experimentos com ela. <br><br>  Aparentemente, a comunidade est√° t√£o animada quanto n√≥s.  Os desenvolvedores de framework est√£o <a href="https://github.com/laravel/ideas/issues/1406">discutindo</a> ativamente <a href="https://github.com/laravel/ideas/issues/1406">a</a> possibilidade de introduzir uma pr√©-carga (e alguns j√° <a href="https://symfony.com/blog/new-in-symfony-4-4-preloading-symfony-applications-in-php-7-4">fizeram seu suporte</a> ).  Agora √© a vez do gerente de depend√™ncia do Composer. <br><br><img src="https://habrastorage.org/webt/t2/b9/bm/t2b9bmzxxtkxl00vu23lyoqwnd4.png"><br><br>  <a href="https://medium.com/%40DarkGhostHunter">Italo Baeza</a> escreveu <a href="https://medium.com/swlh/composer-how-it-should-preload-in-php-7-4-3f8d19fda40">um artigo</a> no qual expressou sua opini√£o sobre como o Composer deveria trabalhar com a pr√©-carga.  Decidi compartilhar uma tradu√ß√£o deste texto e, ao mesmo tempo, uma tradu√ß√£o de <a href="https://medium.com/swlh/preloading-your-php-7-4-project-in-one-line-9ede756f292c">seu outro artigo</a> , sobre como os pr√≥prios desenvolvedores do Composer responderam √† proposta, bem como sobre uma nova ferramenta que facilita o trabalho com a pr√©-carga. <br><a name="habracut"></a><br><h2>  Como o compositor deve pr√©-carregar no PHP 7.4 </h2><br>  O pr√©-carregamento √© um dos recursos importantes que o PHP 7.4 oferece aos desenvolvedores que precisam de melhor desempenho.  Essa fun√ß√£o pode ser chamada de "aquecimento" antes de implementar o mecanismo JIT, que aparecer√° (ou deve aparecer) no PHP 8. Antes disso, o pr√©-carregamento ser√° suficiente e, quem sabe, talvez eles possam trabalhar em conjunto. <br><br>  O que √© a fun√ß√£o de pr√©-carga √© explicada <a href="https://stitcher.io/blog/preloading-in-php-74">neste artigo</a> .  A linha inferior √© muito simples: php.ini especifica um script PHP para o qual, quando o processo √© iniciado, os arquivos s√£o carregados na mem√≥ria (pr√©-carregamento).  Em combina√ß√£o com o OPCache e a fun√ß√£o carregador autom√°tico <a href="https://medium.com/tech-tajawal/php-composer-the-autoloader-d676a2f103aa">, os</a> arquivos do Composer tamb√©m podem ser compilados e vinculados uma vez, ap√≥s o que estar√£o dispon√≠veis para todas as solicita√ß√µes subsequentes.  Gra√ßas a isso, o PHP n√£o precisa baixar e compilar arquivos com todas as solicita√ß√µes. <br><br>  No entanto, os desenvolvedores do Composer n√£o concordaram em como ele deve ajudar na pr√©-carga, al√©m de fornecer fun√ß√µes de inicializa√ß√£o.  Os fatos s√£o os seguintes: <br><br><ul><li>  o pr√©-carregamento foi anunciado pela primeira vez no PHP 7.4; <br></li><li>  n√£o h√° diretiva Composer para ajudar a pr√©-carregar arquivos; <br></li><li>  para pr√©-carregar, voc√™ precisa acessar o php.ini, ou seja, o pr√≥prio processo; <br></li><li>  pr√©-carregar todos os arquivos n√£o melhorar√° necessariamente o desempenho em compara√ß√£o com pr√©-carregar apenas os arquivos mais solicitados. <br></li></ul><br>  Em outras palavras, apenas aqueles que t√™m acesso total aos servidores podem usar o pr√©-carregamento.  Isso exclui servidores compartilhados e algumas solu√ß√µes PaaS que n√£o envolvem o trabalho com o php.ini. <br><br>  Ent√£o, como o Composer pode ajudar na pr√©-carga, considerando que essa √© uma inova√ß√£o?  Aqui est√° a minha opini√£o. <br><br><h2>  Como a pr√©-carga deve funcionar </h2><br>  O mecanismo para pr√©-carregamento deve se basear em uma lista de arquivos que ser√£o <i>carregados</i> e armazenados na mem√≥ria na inicializa√ß√£o.  E como essa √© uma lista, precisamos trabalhar com uma matriz de arquivos e deixar o Composer fazer todo o trabalho, em vez de <i>carregar</i> cada arquivo manualmente. <br><br>  O Composer deve pegar a lista de arquivos especificados pelo aplicativo (o projeto raiz) e compilar tudo em arquivos que o PHP possa usar sem nenhuma dificuldade. <br>  Ao mesmo tempo, precisamos adicionar e remover pacotes do mecanismo de pr√©-carregamento. <br>  O pr√©-carregamento nunca deve funcionar no n√≠vel do pacote, pois √© responsabilidade do desenvolvedor ativar ou desativar o pr√©-carregamento de cada pacote. <br><br>  O pr√©-carregamento no Composer deve ser opcional.  O desenvolvedor deve poder desativ√°-lo para que o PHP use seu pr√≥prio pr√©-carregador, que pode funcionar com base na an√°lise do OPCache - depende da carga do aplicativo e funciona com muito mais efici√™ncia do que apenas pr√©-carregar todos os arquivos. <br><br><h3>  Tudo come√ßa em preload.json </h3><br>  Para n√£o complicar o sistema, coloque o arquivo preload.json na raiz do projeto.  Ele listar√° os arquivos de pr√©-carregamento que o Composer pode selecionar.  Como esse √© um arquivo JSON, o desenvolvedor pode ger√°-lo com a ajuda de um comando especial.  Eu acho que seria √≥timo se o Composer tivesse um utilit√°rio para criar um arquivo JSON baseado em script. <br><br><pre><code class="php hljs">{ <span class="hljs-string"><span class="hljs-string">"pre-compile"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"my-script.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"my-other-script.php"</span></span> ], <span class="hljs-string"><span class="hljs-string">"extensions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"php"</span></span> ], <span class="hljs-string"><span class="hljs-string">"files"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"app/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"config/"</span></span>, <span class="hljs-string"><span class="hljs-string">"helpers.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Models/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Controllers/*/Http/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Views/Compiled*.php"</span></span> ], <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"App\\Models"</span></span>, <span class="hljs-string"><span class="hljs-string">"App\\Controllers\\"</span></span>, <span class="hljs-string"><span class="hljs-string">"App\\Views\\MainView"</span></span>, <span class="hljs-string"><span class="hljs-string">"Vendor\\Package\\*"</span></span>, ], <span class="hljs-string"><span class="hljs-string">"packages"</span></span>: { <span class="hljs-string"><span class="hljs-string">"symfony/http-client"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"robert/*-client"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"vendor/package"</span></span>: { <span class="hljs-string"><span class="hljs-string">"files"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }, <span class="hljs-string"><span class="hljs-string">"foo/bar"</span></span>: { <span class="hljs-string"><span class="hljs-string">"files"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"helpers.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"loaders/*"</span></span> ], <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"Foo\\Bar\\DynamicLoaders\\*"</span></span>, <span class="hljs-string"><span class="hljs-string">"Foo\\Bar\\Clients"</span></span> ] } }, <span class="hljs-string"><span class="hljs-string">"output"</span></span>: <span class="hljs-string"><span class="hljs-string">"preload-compiled.php"</span></span> }</code> </pre> <br>  O uso do preload.json permite verificar rapidamente se o pr√©-carregamento est√° inclu√≠do no projeto: se o arquivo estiver ausente, o pr√©-carregamento n√£o √© suportado ou indesej√°vel. <br><br>  Vamos ver o que as teclas fazem. <br><br>  <b>pr√©-compilar</b> <br><br>  Esses arquivos ser√£o executados pelo Composer.  Cada script deve retornar uma matriz de caminhos de arquivo absolutos para adicion√°-los √† lista de pr√©-carregamento, que desempenhar√° o papel da lista principal. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"pre-compile"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"my-script.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"my-other-script.php"</span></span> ]</code> </pre><br>  Esses arquivos ser√£o executados na ordem especificada. <br><br>  O objetivo √© que o desenvolvedor crie uma lista de arquivos como achar melhor, em vez de confiar em um √∫nico arquivo JSON.  Esses arquivos ser√£o executados antes de tudo.  E sim, voc√™ s√≥ pode implementar o preload.json com essa chave.  Como estamos falando de arquivos PHP, ao compilar uma matriz, voc√™ pode at√© adicionar outros arquivos. <br><br>  <b>extens√µes</b> <br><br>  Esta √© uma lista de extens√µes que precisam ser pr√©-carregadas.  Por padr√£o, apenas os arquivos com a extens√£o php s√£o obtidos. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"extensions"</span></span>: [<span class="hljs-string"><span class="hljs-string">"php"</span></span>, <span class="hljs-string"><span class="hljs-string">"php5"</span></span>, <span class="hljs-string"><span class="hljs-string">"php7"</span></span>]</code> </pre> <br>  Por exemplo, voc√™ pode adicionar um diret√≥rio preenchido com arquivos * .phtml, incluindo alguns arquivos PHP √∫teis, e o Composer selecionar√° apenas eles, e n√£o todo o conte√∫do do diret√≥rio. <br>  Como voc√™ entende, esse processo pode ser substitu√≠do adicionando arquivos manualmente. <br><br>  <b>arquivos</b> <br><br>  Essa chave informa ao Composer para baixar todos os arquivos da lista cujos caminhos s√£o relativos ao local do compositer.json. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"files"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"helpers.php"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Models/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Controllers/*/Http/*"</span></span>, <span class="hljs-string"><span class="hljs-string">"app/Views/Compiled*.php"</span></span>, ]</code> </pre><br>  Descobrir a lista √© f√°cil: <br><br><ul><li>  use caminhos relativos para adicionar arquivos e diret√≥rios; <br></li><li>  dos diret√≥rios, apenas os arquivos filhos armazenados neles ser√£o adicionados (n√£o recursivamente); <br></li><li>  caminhos recursivos s√£o indicados por um asterisco (*); <br></li><li>  Usando este s√≠mbolo, voc√™ tamb√©m pode, por exemplo, adicionar certos arquivos e diret√≥rios: <code>src/Clients/*/Stores</code> ou <code>src/Model*.php</code> . <br></li></ul><br>  Adicionar arquivos por m√°scara sem selecionar ou criar manualmente scripts espec√≠ficos de aplicativos √© especialmente √∫til no desenvolvimento de aplicativos grandes. <br><br>  Se voc√™ precisar pr√©-carregar todos os arquivos usando <a href="">a chave de carregamento autom√°tico</a> no arquivo JSON do Composer, configure-o como <code>true</code> . <br><br>  <b>namespace</b> <br><br>  Essa chave informa ao Composer para carregar arquivos com um determinado namespace ou nome de classe, como <code>file</code> ou <code>directory</code> .  O mesmo mecanismo permite chamar dinamicamente nomes de espa√ßo de outros pacotes instalados. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"namespaces"</span></span>: [   <span class="hljs-string"><span class="hljs-string">"App\\Models"</span></span>,   <span class="hljs-string"><span class="hljs-string">"App\\Controllers\\"</span></span>,   <span class="hljs-string"><span class="hljs-string">"App\\Views\\MainView"</span></span>,   <span class="hljs-string"><span class="hljs-string">"Vendor\\Package\\*"</span></span>, ]</code> </pre> <br>  Isso tamb√©m √© conveniente ao trabalhar em aplicativos grandes, que dependem mais de namespaces, em vez de arquivos que podem ser alterados a qualquer momento.  O Composer extrai automaticamente os arquivos de acordo com o espa√ßo para nome e os coloca em uma lista. <br><br>  <b>pacotes</b> <br><br>  Essa chave permite carregar outros arquivos registrados a partir de pacotes externos, como arquivos auxiliares ou classes associadas a um espa√ßo para nome. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"packages"</span></span>: {   <span class="hljs-string"><span class="hljs-string">"symfony/http-client"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,   <span class="hljs-string"><span class="hljs-string">"robert/*-client"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,   <span class="hljs-string"><span class="hljs-string">"vendor/package"</span></span>: {       <span class="hljs-string"><span class="hljs-string">"files"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,       <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>   },   <span class="hljs-string"><span class="hljs-string">"foo/bar"</span></span>: {       <span class="hljs-string"><span class="hljs-string">"files"</span></span>: {           <span class="hljs-string"><span class="hljs-string">"helpers.php"</span></span>,           <span class="hljs-string"><span class="hljs-string">"loaders/*"</span></span>       },       <span class="hljs-string"><span class="hljs-string">"namespace"</span></span>: [           <span class="hljs-string"><span class="hljs-string">"Foo\\Bar\\DynamicLoaders\\*"</span></span>,           <span class="hljs-string"><span class="hljs-string">"Foo\\Bar\\Clients"</span></span>       ]   } }</code> </pre> <br>  Tudo √© muito simples aqui: se o valor for verdadeiro, ser√° carregado todo o conte√∫do <a href="">da chave de carregamento autom√°tico</a> no arquivo composer.json deste pacote.  Caso contr√°rio, voc√™ poder√° controlar com mais detalhes a adi√ß√£o de pr√©-carregamento. <br><br>  Se o valor da chave for verdadeiro, ele far√° o download de todos os arquivos registrados no <code>autoload</code> .  O valor padr√£o √© <code>false</code> .  Isso tamb√©m se aplica √† chave do <code>namespace</code> para <code>namespace</code> . <br><br>  Voc√™ tamb√©m pode selecionar arquivos ou espa√ßos de nome individuais com esta regra.  Mas, neste caso, a chave de <code>autoload</code> n√£o ser√° usada. <br><br>  <b>sa√≠da</b> <br><br>  Este √© simplesmente o nome do arquivo da lista de pr√©-carregamento compilado. <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"output"</span></span>: <span class="hljs-string"><span class="hljs-string">"preload-compiled.php"</span></span></code> </pre> <br><h3>  Montagem f√°cil </h3><br>  Nossa lista de pr√©-carregamento est√° pronta e podemos chamar o Composer para compilar o script principal de pr√©-carregamento. <br><br><pre> <code class="php hljs">composer preload</code> </pre> <br>  Como resultado, o preload-compiled.php ser√° criado com todos os arquivos que o PHP deve pr√©-carregar.  Obviamente, voc√™ pode alterar o nome do arquivo como desejar. <br><br>  Voc√™ tamb√©m precisa substituir as chaves de <code>preload</code> - <code>preload</code> par√¢metros. <br><br><pre> <code class="php hljs">composer preload \   --input=my-custom-preload-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>.json \   --output=my-preload.php</code> </pre> <br><h3>  Desativado por padr√£o </h3><br>  Projetos sem preload.json retornar√£o um erro se voc√™ tentar compilar um arquivo para pr√©-carregamento.  O motivo √© que o Composer n√£o vai (e n√£o deve) adivinhar o que deve ser pr√©-carregado. <br><br>  Deixe-me lembr√°-lo de que a pr√©-carga n√£o interfere com a funcionalidade normal do Composer.  Como esse √© um comando do console, com desenvolvimento local, voc√™ pode abandonar completamente o pr√©-carregamento.  A √∫nica coisa que o mecanismo de pr√©-carregamento do Composer precisa √© de um arquivo de carregamento autom√°tico, que deve ser gerado se estiver ausente.  Bem, quase 2020 √© o ano no quintal, o PSR-4 √© usado em todos os lugares, certo? <br><br><h3>  Resultado </h3><br>  Voc√™ deve obter um arquivo php com algo como isto: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Preloading </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@generated</span></span></span><span class="hljs-comment"> by Composer */</span></span> <span class="hljs-comment"><span class="hljs-comment">// Autoload the classes so those can be preloaded using `require_once`. require_once __DIR__.'/../autoload.php'; // File list $files = [ '/var/www/app/Foo.php', '/var/www/app/Bar.php', '/var/www/helpers/basic.php', '/var/www/helpers/advanced.php', '/var/www/vendor/Foo/Bar/src/Class.php', '/var/www/vendor/Foo/Bar/helpers/helpers.php', '/var/www/vendor/Foo/Bar/config.php', // ... ]; // Preload all root project files foreach ($files as $file) { require_once $file; }</span></span></code> </pre> <br>  De fato, esta √© apenas uma lista de arquivos que ser√£o pr√©-carregados usando a fun√ß√£o de carregamento autom√°tico no Composer.  O PHP executar√° esse arquivo uma vez e se tornar√° hist√≥rico. <br><hr><br>  Eu sinceramente espero que o Composer tenha alguma maneira de pr√©-carregar arquivos sem ter que escrever um hack. <br><br>  Como o m√©todo descrito acima n√£o faz parte do kernel do Composer, voc√™ ainda pode selecionar os arquivos mais importantes para pr√©-carregamento com base na an√°lise do OPCache sem tocar nos menos necess√°rios.  Imagine que, em vez de pr√©-carregar 1.500 arquivos com capacidade de 100 MB, voc√™ pode baixar apenas 150 arquivos com capacidade de 10 MB, mantendo 99% do desempenho original. <br><br><h2>  Pr√©-carregamos o projeto PHP 7.4 em uma linha </h2><br>  Logo depois que escrevi um artigo sobre como o Composer pode ajud√°-lo a pr√©-carregar um projeto, <a href="https://github.com/Seldaek">Seldaek</a> (membro da equipe de desenvolvimento do Composer) <a href="https://github.com/composer/composer/issues/7777">acabou com toda a esperan√ßa de</a> que o Composer tivesse uma op√ß√£o f√°cil de pr√©-carregar o projeto no processo PHP a partir do gerenciador de pacotes. <br><br><blockquote>  (...) vou explicar: tenho certeza de que, no futuro pr√≥ximo, n√£o adicionaremos nada relacionado √† pr√©-carga no Composer. </blockquote><br>  Porque  O pr√©-carregamento do PHP √© mais um problema de desenvolvimento (e n√£o uma depend√™ncia); √© resolvido editando manualmente o php.ini - somente os desenvolvedores podem fazer isso se eles pr√≥prios gerenciam o PHP. <br><br>  Mas isso n√£o me impede de criar meu pr√≥prio pacote para pr√©-carregar o projeto.  E voce tambem <br><br><h2>  Pr√©-carregamento e M√©tricas </h2><br>  O pr√©-carregamento pode ser uma boa ferramenta para um aumento <a href="https://wiki.php.net/rfc/preload">simples e barato</a> da produtividade sem processamento s√©rio. <br><br>  Mas o problema n√£o √© <i>como</i> pr√© <i>-</i> carregar, mas o <i>que</i> .  O pr√©-carregamento de estruturas inteiras e milhares de arquivos esgotar√° rapidamente a mem√≥ria; portanto, fazer isso √†s cegas n√£o √© uma op√ß√£o, pelo menos em grandes projetos.  √â aconselh√°vel baixar apenas os arquivos mais solicitados.  Mas como defini-los? <br><br>  Felizmente, o OPCache permite que o <a href="https://www.php.net/manual/en/function.opcache-get-status.php">opcache_get_status ()</a> colete dados sobre quais arquivos s√£o mais acessados.  Voc√™ n√£o pode apenas descobrir quais arquivos est√£o com maior demanda, mas tamb√©m quanta mem√≥ria eles consomem algum tempo ap√≥s o in√≠cio do aplicativo. <br><br>  √â recomend√°vel aguardar uma semana ou at√© o momento em que o OPCache registra um certo n√∫mero de ocorr√™ncias.  Tudo depende da aplica√ß√£o, mas voc√™ entendeu. <br>  Ent√£o, vamos criar uma lista de pr√©-carregamento com base nas estat√≠sticas dos arquivos mais populares.  Eu fiz um pacote para isso. <br><br><h2>  Imagine ... Preloader! </h2><br>  Este pacote criar√° automaticamente uma lista de pr√©-carregamento para seu aplicativo.  Ele coletar√° estat√≠sticas de uso do OPCache, classificar√° os arquivos pelo n√∫mero de ocorr√™ncias e criar√° uma lista para que o tamanho total do arquivo n√£o exceda o limite especificado. <br><br><img src="https://habrastorage.org/webt/sm/1b/vi/sm1bvipjlzifwjfc4evvvpaqaau.png"><br><br>  Fiquei intrigado por um longo tempo em busca da melhor estrat√©gia de cria√ß√£o de listas.  E cheguei √† conclus√£o de que √© melhor adicionar todos os arquivos at√© voc√™ atingir o limite de mem√≥ria, que para pacotes √© de 32 MB por padr√£o.  Os arquivos ser√£o classificados pelo n√∫mero de ocorr√™ncias e o pr√≥prio pacote ser√° exclu√≠do automaticamente. <br><br>  Em outras palavras, o PHP melhorar√° o desempenho do aplicativo ao processar a maioria das solicita√ß√µes. <br><br>  E como us√°-lo?  Diga ao Composer Autoloader onde escrever o script do Preloader e pronto. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DarkGhostHunter</span></span>\<span class="hljs-title"><span class="hljs-title">Preloader</span></span>\<span class="hljs-title"><span class="hljs-title">Preloader</span></span>; Preloader::make() -&gt;autoload(<span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>) -&gt;output(<span class="hljs-string"><span class="hljs-string">'preload.php'</span></span>) -&gt;generate();</code> </pre><br>  Claro, voc√™ precisa escolher quando gerar, mas esse √© o ponto.  Voc√™ pode fazer isso aleatoriamente e reescrever a lista, por exemplo, para cada 100¬™ solicita√ß√£o. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">DarkGhostHunter</span></span>\<span class="hljs-title"><span class="hljs-title">Preloader</span></span>\<span class="hljs-title"><span class="hljs-title">Preloader</span></span>; Preloader::make() -&gt;whenOneIn(<span class="hljs-number"><span class="hljs-number">100</span></span>) -&gt;autoload(<span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>) -&gt;output(<span class="hljs-string"><span class="hljs-string">'preload.php'</span></span>) -&gt;overwrite() -&gt;generate();</code> </pre><br>  Voc√™ receber√° um script de pr√©-carregamento pronto para colocar no php.ini. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * This file is generated automatically by Preloader. * * This script uses Composer Autoload file and `require_once` to preload the files in this * list. Add this file to your `php.ini` in `opcache.preload` to preload this list into * PHP at startup. Additionally, this file also includes information about Opcache. * * * Add (or update) this line in `php.ini`: * * opcache.preload=/www/app/vendor/preload.php * * --- Config --- * Generated at: 2019-11-20 15:20:49 UTC * Opcache * - Used Memory: 130585 B * - Free Memory: 294896 B * - Wasted Memory: 347764 B * - Cached files: 2675 * - Hit rate: 94% * - Misses: 542 * Preloader config * - Memory limit: 32 MB * - Overwrite: false * - Files excluded: 0 * - Files appended: 0 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'/www/app/vendor/autoload.php'</span></span>; $files = [ <span class="hljs-string"><span class="hljs-string">'/www/app/ClassFoo.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/ClassBar.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/ClassBaz.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/ClassQuz.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/ClassQux.php'</span></span>, <span class="hljs-string"><span class="hljs-string">'/www/app/vendor/author/package/src/Example.php'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// ... ]; foreach ($files as $file) { require_once $file; }</span></span></code> </pre><br>  E √© isso.  Experimente voc√™ mesmo: <a href="https://packagist.org/packages/darkghosthunter/preloader%3Fsource%3Dpost_page-----9ede756f292c----------------------">darkghosthunter / preloader - Packagist</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt480746/">https://habr.com/ru/post/pt480746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt480734/index.html">Que o TestMace √© melhor que o Postman</a></li>
<li><a href="../pt480736/index.html">Por que nem todos os erros precisam ser corrigidos para melhorar um produto de TI</a></li>
<li><a href="../pt480738/index.html">Experi√™ncia na cria√ß√£o de um produto na R√∫ssia ou como criar um aspirador de p√≥ sem fio ‚Äúpopular‚Äù PRO-EXPERT</a></li>
<li><a href="../pt480740/index.html">4 recursos legais do Numpy que eu uso constantemente</a></li>
<li><a href="../pt480744/index.html">Como um programador pode proteger seu projeto de estima√ß√£o</a></li>
<li><a href="../pt480748/index.html">Por que voc√™ precisa de tantos desenvolvedores?</a></li>
<li><a href="../pt480752/index.html">ICANN suspende a venda da zona de dom√≠nio .ORG</a></li>
<li><a href="../pt480754/index.html">Gerenciamento do caos: limpeza com roteamento</a></li>
<li><a href="../pt480760/index.html">Trabalhar no exterior: em quais pa√≠ses a Internet mais r√°pida?</a></li>
<li><a href="../pt480762/index.html">V&V n√£o significa vingan√ßa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>