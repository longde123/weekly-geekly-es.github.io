<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéø üë©üèΩ‚Äçü§ù‚Äçüë®üèø üí≠ Tempo de alta precis√£o: como trabalhar com fra√ß√µes de segundo no MySQL e PHP üêøÔ∏è üéÖ ü§µüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Depois que me peguei pensando que, ao trabalhar com o tempo nos bancos de dados, quase sempre utilizo o tempo exato para o segundo simplesmente porque...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tempo de alta precis√£o: como trabalhar com fra√ß√µes de segundo no MySQL e PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/469615/"><p><img src="https://habrastorage.org/webt/uu/43/0k/uu430kx8xpmnjcelv7obc41muik.jpeg"></p><br><p>  Depois que me peguei pensando que, ao trabalhar com o tempo nos bancos de dados, quase sempre utilizo o tempo exato para o segundo simplesmente porque estou acostumado a isso e que essa √© a op√ß√£o descrita na documenta√ß√£o e em um grande n√∫mero de exemplos.  No entanto, agora essa precis√£o est√° longe de ser suficiente para todas as tarefas.  Os sistemas modernos s√£o complexos - eles podem consistir em v√°rias partes, ter milh√µes de usu√°rios interagindo com eles - e, em muitos casos, √© mais conveniente usar maior precis√£o, cujo suporte j√° existe h√° muito tempo. </p><br><p>  Neste artigo, falarei sobre maneiras de usar o tempo com partes fracion√°rias de segundo no MySQL e PHP.  Como foi concebido como um tutorial, o material foi projetado para uma ampla gama de leitores e, em alguns lugares, repete a documenta√ß√£o.  O principal valor deve ser que eu coletei em um texto tudo o que voc√™ precisa saber para trabalhar com esse tempo no MySQL, PHP e no framework Yii, al√©m de adicionar descri√ß√µes de problemas n√£o √≥bvios que voc√™ pode encontrar. </p><br><p>  Vou usar o termo "tempo de alta precis√£o".  Na documenta√ß√£o do MySQL, voc√™ ver√° o termo "segundos fracion√°rios", mas sua tradu√ß√£o literal parece estranha, mas n√£o encontrei outra tradu√ß√£o estabelecida. </p><a name="habracut"></a><br><h2 id="kogda-stoit-ispolzovat-vremya-vysokoy-tochnosti">  Quando usar o tempo de alta precis√£o? </h2><br><p>  Para come√ßar, mostrarei uma captura de tela da caixa de entrada da minha caixa de entrada que ilustra bem a ideia: </p><br><p><img src="https://habrastorage.org/webt/bc/tg/gx/bctggxr0qbeetqe9hmmb4zjmbom.png" alt="Duas letras de um remetente"></p><br><p>  As cartas s√£o a rea√ß√£o da mesma pessoa a um evento.  Um homem acidentalmente apertou o bot√£o errado, rapidamente percebeu isso e se corrigiu.  Como resultado, recebemos duas cartas enviadas ao mesmo tempo, que s√£o importantes para classificar corretamente.  Se o tempo de envio for o mesmo, h√° uma chance de que as letras sejam exibidas na ordem errada e o destinat√°rio fique constrangido, porque ele receber√° o resultado errado pelo qual contar√°. </p><br><p>  Me deparei com as seguintes situa√ß√µes nas quais o tempo de alta precis√£o seria relevante: </p><br><ol><li>  Voc√™ deseja medir o tempo entre algumas opera√ß√µes.  Tudo √© muito simples aqui: quanto maior a precis√£o dos registros de data e hora nos limites do intervalo, maior a precis√£o do resultado.  Se voc√™ usar segundos inteiros, poder√° cometer um erro por 1 segundo (se cair nas bordas dos segundos).  Se voc√™ usar seis casas decimais, o erro ser√° seis ordens de magnitude inferiores. </li><li>  Voc√™ tem uma cole√ß√£o na qual √© prov√°vel que haja v√°rios objetos com o mesmo hor√°rio de cria√ß√£o.  Um exemplo √© um bate-papo familiar para todos, onde a lista de contatos √© classificada pela hora da √∫ltima mensagem.  Se aparecer a navega√ß√£o p√°gina por p√°gina, existe o risco de perder contatos nas bordas da p√°gina.  Esse problema pode ser resolvido sem tempo de alta precis√£o devido √† classifica√ß√£o e pagina√ß√£o por um par de campos (tempo + identificador exclusivo de um objeto), mas esta solu√ß√£o tem suas desvantagens (pelo menos a complica√ß√£o das consultas SQL, mas n√£o apenas isso).  Aumentar a precis√£o do tempo ajudar√° a reduzir a probabilidade de problemas e ocorrer sem complicar o sistema. </li><li> Voc√™ precisa manter um hist√≥rico de altera√ß√µes de algum objeto.  Isso √© especialmente importante no mundo dos servi√ßos, onde as modifica√ß√µes podem ocorrer em paralelo e em lugares completamente diferentes.  Como exemplo, posso trabalhar com fotografias de nossos usu√°rios, onde muitas opera√ß√µes diferentes podem ser realizadas em paralelo (o usu√°rio pode tornar a foto privada ou exclu√≠-la, ela pode ser moderada em um dos v√°rios sistemas, cortada para uso como foto no chat, etc.). ) </li></ol><br><p>  Deve-se ter em mente que n√£o se pode acreditar nos valores obtidos em 100% e a precis√£o real dos valores obtidos pode ser menor que seis casas decimais.  Isso se deve ao fato de podermos obter um valor de tempo impreciso (especialmente ao trabalhar em um sistema distribu√≠do composto por muitos servidores), o tempo pode mudar inesperadamente (por exemplo, ao sincronizar via NTP ou ao alterar o rel√≥gio), etc. N√£o vou me debru√ßar sobre todos esses problemas, mas darei alguns artigos em que voc√™ pode ler mais sobre eles: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Os erros dos programadores em rela√ß√£o ao tempo"</a> (o artigo em si √© muito minimalista, mas al√©m das teses do texto, explica√ß√µes podem ser encontradas nos coment√°rios); </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"O pesado fardo do tempo</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"</a> </li></ul><br><h2 id="rabota-so-vremenem-vysokoy-tochnosti-v-mysql">  Trabalhe com tempo de alta precis√£o no MySQL </h2><br><p> O MySQL suporta tr√™s tipos de colunas nas quais o tempo pode ser armazenado: <code>TIME</code> , <code>DATETIME</code> e <code>TIMESTAMP</code> .  Inicialmente, eles s√≥ podiam armazenar valores m√∫ltiplos de um segundo (por exemplo, 14/08/2019 √†s 19:20:21).  Na vers√£o 5.6.4, lan√ßada em dezembro de 2011, tornou-se poss√≠vel trabalhar com a parte fracion√°ria de um segundo.  Para fazer isso, ao criar a coluna, voc√™ precisa especificar o n√∫mero de casas decimais, que devem ser armazenadas na parte fracion√°ria do registro de data e hora.  O n√∫mero m√°ximo de caracteres com suporte √© seis, o que permite armazenar o tempo exato no microssegundo.  Se voc√™ tentar usar mais caracteres, receber√° um erro. </p><br><p>  Um exemplo: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`ChatContactsList`</span></span> ( <span class="hljs-string"><span class="hljs-string">`chat_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-string"><span class="hljs-string">`title`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`last_message_send_time`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>; Query OK, 0 rows affected (0.02 sec) Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`ChatContactsList`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MODIFY</span></span> last_message_send_time <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ERROR 1426 (42000): Too-big precision 9 specified for 'last_message_send_time'. Maximum is 6. Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`ChatContactsList`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MODIFY</span></span> last_message_send_time <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; Query OK, 0 rows affected (0.09 sec) Records: 0 Duplicates: 0 Warnings: 0 Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> ChatContactsList (title, last_message_send_time) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'Chat #1'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>()); Query OK, 1 row affected (0.03 sec) Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList; +<span class="hljs-comment"><span class="hljs-comment">---------+---------+-------------------------+ | chat_id | title | last_message_send_time | +---------+---------+-------------------------+ | 1 | Chat #1 | 2019-09-22 22:23:15.000 | +---------+---------+-------------------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  Neste exemplo, o registro de data e hora do registro inserido tem uma fra√ß√£o zero.  Isso aconteceu porque o valor de entrada foi indicado no segundo mais pr√≥ximo.  Para resolver o problema, a precis√£o do valor de entrada deve ser igual ao valor no banco de dados.  O conselho parece √≥bvio, mas √© relevante, pois um problema semelhante pode surgir em aplicativos reais: fomos confrontados com uma situa√ß√£o em que o valor de entrada tinha tr√™s casas decimais e seis eram armazenados no banco de dados. </p><br><p>  A maneira mais f√°cil de impedir que esse problema ocorra √© usar os valores de entrada com precis√£o m√°xima (at√© microssegundos).  Nesse caso, ao gravar dados na tabela, o tempo ser√° arredondado para a precis√£o necess√°ria.  Essa √© uma situa√ß√£o absolutamente normal que n√£o causar√° nenhum aviso: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> last_message_send_time=<span class="hljs-string"><span class="hljs-string">"2019-09-22 22:23:15.2345"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> chat_id=<span class="hljs-number"><span class="hljs-number">1</span></span>; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList; +<span class="hljs-comment"><span class="hljs-comment">---------+---------+-------------------------+ | chat_id | title | last_message_send_time | +---------+---------+-------------------------+ | 1 | Chat #1 | 2019-09-22 22:23:15.235 | +---------+---------+-------------------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  Ao usar a inicializa√ß√£o autom√°tica e a atualiza√ß√£o autom√°tica das colunas TIMESTAMP usando uma estrutura no formato <code>DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</code> √© importante que os valores tenham a mesma precis√£o que a pr√≥pria coluna: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>; ERROR 1067 (42000): Invalid default value for 'updated' Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>); ERROR 1067 (42000): Invalid default value for 'updated' Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); Query OK, 0 rows affected (0.07 sec) Records: 0 Duplicates: 0 Warnings: 0 Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> last_message_send_time=<span class="hljs-string"><span class="hljs-string">'2019-09-22 22:22:22'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> chat_id=<span class="hljs-number"><span class="hljs-number">1</span></span>; Query OK, 0 rows affected (0.00 sec) Rows matched: 1 Changed: 0 Warnings: 0 Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList; +<span class="hljs-comment"><span class="hljs-comment">---------+---------+-------------------------+-------------------------+ | chat_id | title | last_message_send_time | updated | +---------+---------+-------------------------+-------------------------+ | 1 | Chat #1 | 2019-09-22 22:22:22.000 | 2019-09-22 22:26:39.968 | +---------+---------+-------------------------+-------------------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  As fun√ß√µes do MySQL para trabalhar com o passar do tempo suportam o trabalho com a parte fracion√°ria das unidades de medida.  N√£o listarei todos (sugiro procurar na documenta√ß√£o), mas darei alguns exemplos: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) + <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-number"><span class="hljs-number">7.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>; +<span class="hljs-comment"><span class="hljs-comment">------------------------+--------------------------+------------------------------+ | NOW(2) | NOW(4) | NOW(4) + INTERVAL 7.5 SECOND | +------------------------+--------------------------+------------------------------+ | 2019-09-22 21:12:23.31 | 2019-09-22 21:12:23.3194 | 2019-09-22 21:12:30.8194 | +------------------------+--------------------------+------------------------------+ 1 row in set (0.00 sec) Test&gt; SELECT SUBTIME(CURRENT_TIME(6), CURRENT_TIME(3)), CURRENT_TIME(6), CURRENT_TIME(3); +-------------------------------------------+-----------------+-----------------+ | SUBTIME(CURRENT_TIME(6), CURRENT_TIME(3)) | CURRENT_TIME(6) | CURRENT_TIME(3) | +-------------------------------------------+-----------------+-----------------+ | 00:00:00.000712 | 21:12:50.793712 | 21:12:50.793 | +-------------------------------------------+-----------------+-----------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  O principal problema associado ao uso da parte fracion√°ria de segundos nas consultas SQL √© a inconsist√™ncia da precis√£o nas compara√ß√µes ( <code>&gt;</code> , <code>&lt;</code> , <code>BETWEEN</code> ).  Voc√™ pode encontr√°-lo se os dados no banco de dados tiverem uma precis√£o e nas consultas - outra.  Aqui est√° um pequeno exemplo que ilustra esse problema: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">#         Test&gt; INSERT INTO ChatContactsList (title, last_message_send_time) VALUES ('Chat #2', '2019-09-22 21:16:39.123456'); Query OK, 0 row affected (0.00 sec) Test&gt; SELECT chat_id, title, last_message_send_time FROM ChatContactsList WHERE title='Chat #2'; +---------+---------+-------------------------+ | chat_id | title | last_message_send_time | +---------+---------+-------------------------+ | 2 | Chat #2 | 2019-09-22 21:16:39.123 | &lt;-     - ,    +---------+---------+-------------------------+ 1 row in set (0.00 sec) Test&gt; SELECT title, last_message_send_time FROM ChatContactsList WHERE last_message_send_time &gt;= '2019-09-22 21:16:39.123456'; &lt;-    ,    INSERT- +---------+-------------------------+ | title | last_message_send_time | +---------+-------------------------+ | Chat #1 | 2019-09-22 22:22:22.000 | +---------+-------------------------+ 1 row in set (0.00 sec) &lt;- Chat #2   - ,     ,    </span></span></code> </pre> <br><p>  Neste exemplo, a precis√£o dos valores na consulta √© maior que a precis√£o dos valores no banco de dados e o problema ocorre "na borda de cima".  Na situa√ß√£o oposta (se o valor de entrada tiver uma precis√£o menor que o valor do banco de dados), n√£o haver√° problema - o MySQL trar√° o valor para a precis√£o desejada em INSERT e SELECT: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> ChatContactsList (title, last_message_send_time) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'Chat #3'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-09-03 21:20:19.1'</span></span>); Query OK, 1 row affected (0.00 sec) Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> title, last_message_send_time <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> last_message_send_time &lt;= <span class="hljs-string"><span class="hljs-string">'2019-09-03 21:20:19.1'</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------+-------------------------+ | title | last_message_send_time | +---------+-------------------------+ | Chat #3 | 2019-09-03 21:20:19.100 | +---------+-------------------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  A consist√™ncia da precis√£o dos valores deve ser sempre lembrada ao trabalhar com tempo de alta precis√£o.  Se esses problemas de limite forem cr√≠ticos para voc√™, verifique se o c√≥digo e o banco de dados funcionam com o mesmo n√∫mero de casas decimais. </p><br><div class="spoiler">  <b class="spoiler_title">Reflex√µes sobre a escolha da precis√£o em colunas com partes fracion√°rias de segundos</b> <div class="spoiler_text"><p>  A quantidade de espa√ßo ocupado pela parte fracion√°ria de uma unidade de tempo depende do n√∫mero de caracteres na coluna.  Parece natural escolher significados familiares: tr√™s ou seis casas decimais.  Mas no caso de tr√™s caracteres, n√£o √© t√£o simples.  De fato, o MySQL usa um byte para armazenar duas casas decimais: </p><br><blockquote><div class="scrollable-table"><table><thead><tr><th>  Segundos fracion√°rios de precis√£o </th><th>  Requisitos de armazenamento </th></tr></thead><tbody><tr><td>  0 0 </td><td>  0 bytes </td></tr><tr><td>  1, 2 </td><td>  1 byte </td></tr><tr><td>  3, 4 </td><td>  2 bytes </td></tr><tr><td>  5, 6 </td><td>  3 bytes </td></tr></tbody></table></div><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Requisitos de armazenamento para data e hora</a> </blockquote><p>  Acontece que, se voc√™ selecionar tr√™s casas decimais, n√£o estar√° utilizando totalmente o espa√ßo ocupado e, para a mesma sobrecarga, poder√° usar quatro caracteres.  Em geral, eu recomendo que voc√™ sempre use um n√∫mero par de caracteres e, se necess√°rio, ‚Äúcorte‚Äù caracteres desnecess√°rios ao imprimir.  A op√ß√£o ideal √© n√£o ser ganancioso e usar seis casas decimais.  Na pior das hip√≥teses (com o tipo DATETIME), esta coluna ocupar√° 8 bytes, ou seja, o mesmo que o n√∫mero inteiro na coluna BIGINT. </p></div></div><br><p>  Veja tamb√©m: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Segundos fracion√°rios em valores de tempo"</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúInicializa√ß√£o e atualiza√ß√£o autom√°ticas para TIMESTAMP e DATETIME‚Äù</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Fun√ß√µes de data e hora"</a> . </li></ul><br><h2 id="rabota-so-vremenem-vysokoy-tochnosti-v-php">  Trabalhe com tempo de alta precis√£o em PHP </h2><br><p>  N√£o basta ter tempo de alta precis√£o no banco de dados - voc√™ precisa trabalhar com ele no c√≥digo dos seus programas.  Nesta se√ß√£o, falarei sobre tr√™s pontos principais: </p><br><ol><li>  Hor√°rio de recebimento e formata√ß√£o: explicarei como obter o registro de data e hora antes de coloc√°-lo no banco de dados, obt√™-lo de l√° e fazer algum tipo de manipula√ß√£o. </li><li>  Trabalhando com o tempo no DOP: mostrarei um exemplo de como o PHP suporta o tempo de formata√ß√£o em uma biblioteca de banco de dados. </li><li>  Trabalhando com o tempo nas estruturas: falarei sobre o uso do tempo nas migra√ß√µes para alterar a estrutura do banco de dados. </li></ol><br><h3 id="poluchenie-i-formatirovanie-vremeni">  Obtendo e formata√ß√£o da hora </h3><br><p>  Ao trabalhar com o tempo, h√° v√°rias opera√ß√µes b√°sicas que voc√™ precisa ser capaz de fazer: </p><br><ul><li>  obtendo o ponto atual no tempo; </li><li>  obtendo um momento no tempo de alguma string formatada; </li><li>  adicionando um per√≠odo a um ponto no tempo (ou subtraindo um per√≠odo); </li><li>  obtendo uma string formatada para um ponto no tempo. </li></ul><br><p>  Nesta parte, mostrarei quais s√£o as possibilidades para executar essas opera√ß√µes no PHP. </p><br><p>  A primeira maneira √© trabalhar com <strong>um registro de data e hora como um n√∫mero</strong> .  Nesse caso, no c√≥digo PHP, trabalhamos com vari√°veis ‚Äã‚Äãnum√©ricas, as quais operamos atrav√©s de fun√ß√µes como <code>time</code> , <code>date</code> e <code>strtotime</code> .  Este m√©todo n√£o pode ser usado para trabalhar com tempo de alta precis√£o, pois em todas essas fun√ß√µes os carimbos de data / hora s√£o um n√∫mero inteiro (o que significa que a parte fracion√°ria deles ser√° perdida). </p><br><p>  Aqui est√£o as assinaturas das principais fun√ß√µes desta documenta√ß√£o oficial: </p><br><blockquote> <code>time ( void ) : int</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.php.net/manual/ru/function.time.php</a> <br><br> <code>strtotime ( string $time [, int $now = time() ] ) : int</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://php.net/manual/ru/function.strtotime.php</a> <br><br> <code>date ( string $format [, int $timestamp = time() ] ) : string</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://php.net/manual/ru/function.date.php</a> <br><br> <code>strftime ( string $format [, int $timestamp = time() ] ) : string</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.php.net/manual/ru/function.strftime.php</a> </blockquote><br><div class="spoiler">  <b class="spoiler_title">Um ponto interessante sobre a fun√ß√£o de data</b> <div class="spoiler_text"><p>  Embora seja imposs√≠vel passar a parte fracion√°ria de um segundo para a entrada dessas fun√ß√µes, na linha do modelo de formata√ß√£o passada para a entrada da fun√ß√£o de <code>date</code> , voc√™ pode definir caracteres para exibir milissegundos e microssegundos.  Ao formatar, os zeros sempre ser√£o retornados em seus lugares. </p><br><div class="scrollable-table"><table><thead><tr><th>  Caractere no formato de sequ√™ncia </th><th>  Descri√ß√£o do produto </th><th>  Exemplo de valor de retorno </th></tr></thead><tbody><tr><td>  vc </td><td>  Microssegundos (adicionado no PHP 5.2.2).  Observe que date () sempre retornar√° 000000, como  √© necess√°rio um par√¢metro inteiro, enquanto o DateTime :: format () suporta microssegundos se o DateTime for criado com eles. </td><td>  Por exemplo: 654321 </td></tr><tr><td>  v </td><td>  Milissegundos (adicionado no PHP 7.0.0).  A observa√ß√£o √© a mesma que para u. </td><td>  Por exemplo: 654 </td></tr></tbody></table></div><br><p>  Um exemplo: </p><br><pre> <code class="php hljs">$now = time(); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> date(<span class="hljs-string"><span class="hljs-string">'Ymd H:i:s.u'</span></span>, $now); <span class="hljs-comment"><span class="hljs-comment">// 2019-09-11 21:27:18.000000 print date('Ymd H:i:s.v', $now); // 2019-09-11 21:27:18.000</span></span></code> </pre> </div></div><br><p>  Tamb√©m incluem esse m√©todo as <code>hrtime</code> <code>microtime</code> e <code>hrtime</code> , que permitem obter um <code>hrtime</code> hora com uma parte fracion√°ria para o momento atual.  O problema √© que n√£o existe uma maneira pronta para formatar esse r√≥tulo e obt√™-lo a partir de uma sequ√™ncia de um formato espec√≠fico.  Isso pode ser resolvido atrav√©s da implementa√ß√£o independente dessas fun√ß√µes, mas n√£o considerarei essa op√ß√£o. </p><br><blockquote>  Se voc√™ precisar trabalhar apenas com cron√¥metros, a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HRTime</a> √© uma boa op√ß√£o, que n√£o considerarei mais detalhadamente devido √†s limita√ß√µes de seu uso.  S√≥ posso dizer que isso permite que voc√™ trabalhe com o tempo at√© o nanossegundo e garante a monotonia dos timers, o que elimina alguns dos problemas que podem ser encontrados ao trabalhar com outras bibliotecas. </blockquote><p>  Para trabalhar totalmente com partes fracion√°rias de segundo, voc√™ precisa usar o m√≥dulo <strong>DateTime</strong> .  Com certas reservas, ele permite executar todas as opera√ß√µes listadas acima: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    : $time = new \DateTimeImmutable(); //      : $time = new \DateTimeImmutable('2019-09-12 21:32:43.908502'); $time = \DateTimeImmutable::createFromFormat('Ymd H:i:s.u', '2019-09-12 21:32:43.9085'); // / : $period = \DateInterval::createFromDateString('5 seconds'); $timeBefore = $time-&gt;add($period); $timeAfter = $time-&gt;sub($period); //      : print $time-&gt;format('Ymd H:i:s.v'); // '2019-09-12 21:32:43.908' print $time-&gt;format("Ymd H:i:su"); // '2019-09-12 21:32:43.908502'</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">O ponto n√£o √≥bvio ao usar `DateTimeImmutable :: createFromFormat`</b> <div class="spoiler_text"><p>  A letra <code>u</code> na string de formato significa microssegundos, mas tamb√©m funciona corretamente no caso de partes fracion√°rias de menor precis√£o.  Al√©m disso, esta √© a √∫nica maneira de especificar partes fracion√°rias de um segundo em uma string de formato.  Um exemplo: </p><br><pre> <code class="php hljs">$time = \DateTimeImmutable::createFromFormat(<span class="hljs-string"><span class="hljs-string">'Ymd H:i:s.u'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-09-12 21:32:43.9085'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// =&gt;   DateTimeImmutable    2019-09-12 21:32:43.908500 $time = \DateTimeImmutable::createFromFormat('Ymd H:i:s.u', '2019-09-12 21:32:43.90'); // =&gt;   DateTimeImmutable    2019-09-12 21:32:43.900000 $time = \DateTimeImmutable::createFromFormat('Ymd H:i:s.u', '2019-09-12 21:32:43'); // =&gt;  false</span></span></code> </pre> </div></div><br><p>  O principal problema deste m√≥dulo √© o inconveniente ao trabalhar com intervalos contendo segundos fracion√°rios (ou mesmo a impossibilidade de tal trabalho).  A <code>\DateInterval</code> embora contenha a parte fracion√°ria de um segundo com as mesmas seis casas decimais precisas, voc√™ s√≥ pode inicializar essa parte fracion√°ria por meio de <code>DateTime::diff</code> .  O construtor da classe DateInterval e o m√©todo de f√°brica <code>\DateInterval::createFromDateString</code> podem funcionar apenas com segundos inteiros e n√£o permitem especificar a parte fracion√°ria: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     -   $buggyPeriod1 = new \DateInterval('PT7.500S'); //       ,    $buggyPeriod2 = \DateInterval::createFromDateString('2 minutes 7.5 seconds'); print $buggyPeriod2-&gt;format('%R%H:%I:%S.%F') . PHP_EOL; //  "+00:02:00.000000"</span></span></code> </pre> <br><p>  Outro problema pode surgir ao calcular a diferen√ßa entre dois pontos no tempo usando o m√©todo <code>\DateTimeImmutable::diff</code> .  No PHP anterior √† vers√£o 7.2.12, havia um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">erro</a> devido ao qual as partes fracion√°rias de um segundo existiam separadamente de outros d√≠gitos e podiam receber seu pr√≥prio sinal: </p><br><pre> <code class="php hljs">$timeBefore = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTimeImmutable(<span class="hljs-string"><span class="hljs-string">'2019-09-12 21:20:19.987654'</span></span>); $timeAfter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTimeImmutable(<span class="hljs-string"><span class="hljs-string">'2019-09-14 12:13:14.123456'</span></span>); $diff = $timeBefore-&gt;diff($timeAfter); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> $diff-&gt;format(<span class="hljs-string"><span class="hljs-string">'%R%a days %H:%I:%S.%F'</span></span>) . PHP_EOL; <span class="hljs-comment"><span class="hljs-comment">//  PHP  7.2.12+   "+1 days 14:52:54.135802" //       "+1 days 14:52:55.-864198"</span></span></code> </pre> <br><p>  Em geral, aconselho que voc√™ tenha cuidado ao trabalhar com intervalos e cubra cuidadosamente esse c√≥digo com testes. </p><br><p>  Veja tamb√©m: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Data e hora"</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Fun√ß√£o hora."</a> </li></ul><br><h3 id="rabota-so-vremenem-vysokoy-tochnosti-v-pdo">  Trabalhe com tempo de alta precis√£o no DOP </h3><br><p>  PDO e mysqli s√£o as duas interfaces principais para consultar bancos de dados MySQL a partir do c√≥digo PHP.  No contexto de uma conversa sobre o tempo, eles s√£o semelhantes um ao outro, ent√£o eu vou falar apenas sobre um deles - DOP. </p><br><p>  Ao trabalhar com bancos de dados no DOP, a hora aparece em dois locais: </p><br><ul><li>  como um par√¢metro passado para consultas executadas; </li><li>  como um valor que vem em resposta √†s consultas SELECT. </li></ul><br><p>  √â uma boa pr√°tica passar espa√ßos reservados ao passar par√¢metros para a solicita√ß√£o.  Os espa√ßos reservados podem transferir valores de um conjunto muito pequeno de tipos: valores booleanos, seq√º√™ncias de caracteres e n√∫meros inteiros.  N√£o h√° um tipo adequado para data e hora, portanto, voc√™ deve converter manualmente o valor de um objeto da classe DateTime / DateTimeImmutable em uma seq√º√™ncia de caracteres. </p><br><pre> <code class="php hljs">$now = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTimeImmutable(); $db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \PDO(<span class="hljs-string"><span class="hljs-string">'mysql:...'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>, [\PDO::ATTR_ERRMODE =&gt; \PDO::ERRMODE_EXCEPTION]); $stmt = $db-&gt;prepare(<span class="hljs-string"><span class="hljs-string">'INSERT INTO Test.ChatContactsList (title, last_message_send_time) VALUES (:title, :date)'</span></span>); $result = $stmt-&gt;execute([<span class="hljs-string"><span class="hljs-string">':title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Test #1"</span></span>, <span class="hljs-string"><span class="hljs-string">':date'</span></span> =&gt; $now-&gt;format(<span class="hljs-string"><span class="hljs-string">'Ymd H:i:s.u'</span></span>)]);</code> </pre> <br><p>  Usar esse c√≥digo n√£o √© muito conveniente, pois cada vez que voc√™ precisa formatar o valor transmitido.  Portanto, na base de c√≥digo do Badoo, implementamos o suporte para espa√ßos reservados digitados em nosso wrapper para trabalhar com o banco de dados.  No caso de datas, isso √© muito conveniente, pois permite transferir um valor em diferentes formatos (um objeto que implementa DateTimeInterface, uma sequ√™ncia de caracteres formatada ou um n√∫mero com carimbo de data / hora) e todas as transforma√ß√µes e verifica√ß√µes necess√°rias da corre√ß√£o dos valores transferidos j√° s√£o realizadas dentro.  Como b√¥nus, ao transferir um valor incorreto, aprendemos sobre o erro imediatamente, e n√£o ap√≥s receber um erro do MySQL ao executar a consulta. </p><br><p>  A recupera√ß√£o de dados dos resultados da consulta parece bastante simples.  Ao executar esta opera√ß√£o, o PDO retorna os dados na forma de seq√º√™ncias de caracteres, e no c√≥digo precisamos processar mais os resultados se quisermos trabalhar com objetos de tempo (e aqui precisamos da funcionalidade para obter o tempo da sequ√™ncia de caracteres formatada, sobre a qual falei na se√ß√£o anterior). </p><br><pre> <code class="php hljs">$stmt = $db-&gt;prepare(<span class="hljs-string"><span class="hljs-string">'SELECT * FROM Test.ChatContactsList ORDER BY last_message_send_time DESC, chat_id DESC LIMIT 5'</span></span>); $stmt-&gt;execute(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)) { $row[<span class="hljs-string"><span class="hljs-string">'last_message_send_time'</span></span>] = is_null($row[<span class="hljs-string"><span class="hljs-string">'last_message_send_time'</span></span>]) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTimeImmutable($row[<span class="hljs-string"><span class="hljs-string">'last_message_send_time'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">//  -  }</span></span></code> </pre> <br><blockquote>  Nota <br><br>  O fato de o PDO retornar dados como seq√º√™ncias de caracteres n√£o √© inteiramente verdade.  Ao receber valores, √© poss√≠vel definir o tipo de valor para a coluna usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>PDOStatement::bindColumn</code></a> .  Eu n√£o falei sobre isso porque h√° o mesmo conjunto limitado de tipos que n√£o ajuda nas datas. </blockquote><p>  Infelizmente, h√° um problema para estar ciente.  No PHP anterior √† vers√£o 7.3, h√° um erro devido ao qual o PDO, quando o atributo <code>PDO::ATTR_EMULATE_PREPARES</code> est√° <code>PDO::ATTR_EMULATE_PREPARES</code> "corta" a parte fracion√°ria de um segundo quando √© recebido do banco de dados.  Detalhes e um exemplo podem ser encontrados na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descri√ß√£o</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bug no php.net</a> .  No PHP 7.3, esse erro foi corrigido e avisou que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">essa altera√ß√£o quebra a compatibilidade com vers√µes anteriores</a> . </p><br><p>  Se voc√™ estiver usando o PHP vers√£o 7.2 ou anterior e n√£o puder atualiz√°-lo ou ativar o <code>PDO::ATTR_EMULATE_PREPARES</code> , poder√° solucionar esse erro corrigindo consultas SQL que retornam o tempo com uma parte fracion√°ria, para que esta coluna tenha um tipo de string.  Isso pode ser feito, por exemplo, assim: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(last_message_send_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> last_message_send_time_fixed <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> last_message_send_time <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  Este problema tamb√©m pode ser encontrado ao trabalhar com o m√≥dulo <code>mysqli</code> : se voc√™ usar consultas preparadas chamando o m√©todo <code>mysqli::prepare</code> , no PHP anterior √† vers√£o 7.3, a parte fracion√°ria de um segundo n√£o ser√° retornada.  Assim como no PDO, voc√™ pode corrigir isso atualizando o PHP ou ignorando a convers√£o de tempo em um tipo de string. </p><br><p>  Veja tamb√©m: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Consultas preparadas e procedimentos armazenados na DOP"</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Consultas preparadas no mysqli"</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o sobre o m√©todo mysqli_stmt :: bind_param</a> (aqui s√£o descritos os tipos de espa√ßos reservados suportados no mysqli); </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Solicita√ß√£o de pool para PHP, na qual eles corrigiram o "truncamento" da parte fracion√°ria de segundos</a> . </li></ul><br><h3 id="rabota-so-vremenem-vysokoy-tochnosti-v-yii-2">  Trabalhar com tempo de alta precis√£o no Yii 2 </h3><br><p>  As estruturas mais modernas fornecem funcionalidade de migra√ß√£o que permite armazenar o hist√≥rico de altera√ß√µes no esquema do banco de dados no c√≥digo e alter√°-lo de forma incremental.  Se voc√™ usa migra√ß√µes e deseja usar um tempo de alta precis√£o, sua estrutura deve suport√°-lo.  Felizmente, isso funciona imediatamente em todas as principais estruturas. </p><br><p>  Nesta se√ß√£o, mostrarei como esse suporte √© implementado no Yii (nos exemplos que usei a vers√£o 2.0.26).  Sobre o Laravel, Symfony e outros, n√£o escreverei para n√£o tornar o artigo infinito, mas ficarei feliz em adicionar detalhes nos coment√°rios ou novos artigos sobre este t√≥pico. </p><br><p>  Na migra√ß√£o, escrevemos c√≥digo que descreve as altera√ß√µes no esquema de dados.  Ao criar uma nova tabela, descrevemos todas as suas colunas usando m√©todos especiais da classe \ yii \ db \ Migration (eles s√£o declarados na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bandeja SchemaBuilderTrait</a> ).  Os m√©todos de <code>timestamp</code> , <code>timestamp</code> e <code>datetime</code> e <code>datetime</code> e <code>datetime</code> que podem ter um valor de entrada de precis√£o s√£o respons√°veis ‚Äã‚Äãpela descri√ß√£o das colunas que cont√™m data e hora. </p><br><p>  Um exemplo de migra√ß√£o em que uma nova tabela √© criada com uma coluna de tempo de alta precis√£o: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">db</span></span>\<span class="hljs-title"><span class="hljs-title">Migration</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m190914_141123_create_news_table</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createTable(<span class="hljs-string"><span class="hljs-string">'news'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;primaryKey(), <span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;string()-&gt;notNull(), <span class="hljs-string"><span class="hljs-string">'content'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;text(), <span class="hljs-string"><span class="hljs-string">'published'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timestamp(<span class="hljs-number"><span class="hljs-number">6</span></span>), <span class="hljs-comment"><span class="hljs-comment">//     ]); } public function down() { $this-&gt;dropTable('news'); } }</span></span></code> </pre> <br><p>  E este √© um exemplo de migra√ß√£o em que a precis√£o em uma coluna existente √© alterada: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m190916_045702_change_news_time_precision</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;alterColumn( <span class="hljs-string"><span class="hljs-string">'news'</span></span>, <span class="hljs-string"><span class="hljs-string">'published'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timestamp(<span class="hljs-number"><span class="hljs-number">6</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;alterColumn( <span class="hljs-string"><span class="hljs-string">'news'</span></span>, <span class="hljs-string"><span class="hljs-string">'published'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timestamp(<span class="hljs-number"><span class="hljs-number">3</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre> <br><p>       ActiveRecord     -  :          ,         DateTime-.  ,     ‚Äî    ¬´¬ª      <code>PDO::ATTR_EMULATE_PREPARES</code> .   Yii    ,        .   ,       ,        PDO. </p><br><p> . : </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">    Yii 2</a> ; </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  SchemaBuilderTrait</a> . </li></ul><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p> ,   ,     ‚Äî  ,     .                 ,    ,    . ,    ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt469615/">https://habr.com/ru/post/pt469615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt469599/index.html">Analisando o mecanismo 2D de desenvolvimento no WinForms</a></li>
<li><a href="../pt469605/index.html">O futuro do Li-Fi: polaritons, excitons, f√≥tons e alguns bissulfeto de tungst√™nio</a></li>
<li><a href="../pt469607/index.html">Consci√™ncia humana. N√£o √© poss√≠vel transferir a c√≥pia?</a></li>
<li><a href="../pt469609/index.html">Por favor, esteja online</a></li>
<li><a href="../pt469613/index.html">Sobre o sistema nacional de gerenciamento de dados</a></li>
<li><a href="../pt469617/index.html">Destrua o monop√≥lio da Am√©rica na EDA. Inn√≥polis d√° o primeiro passo</a></li>
<li><a href="../pt469619/index.html">Pesquisa: se o comprador entender que est√° conversando com o bot de bate-papo, a compra n√£o ser√° realizada.</a></li>
<li><a href="../pt469623/index.html">GitLab 12.3 com firewall de aplicativos da web e an√°lise de desempenho</a></li>
<li><a href="../pt469625/index.html">Como coletamos dados em campanhas publicit√°rias de plataformas on-line (o caminho dif√≠cil para o produto)</a></li>
<li><a href="../pt469629/index.html">O √°tomo pac√≠fico n√£o est√° em todos os lares: op√ß√µes inesperadas para fontes de energia de radionucl√≠deos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>