<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèΩ‚Äçü§ù‚Äçüßëüèª üôã ‚úåüèª Incorporamos o int√©rprete Lua no projeto do microcontrolador (stm32) üçï üèê ‚ò™Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em aplicativos bastante grandes, uma parte significativa do projeto √© a l√≥gica de neg√≥cios. √â conveniente depurar esta parte do programa no computador...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Incorporamos o int√©rprete Lua no projeto do microcontrolador (stm32)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459602/"><img src="https://habrastorage.org/webt/p6/9j/kz/p69jkzome873c4rbil8fftedrxs.png"><br><br>  Em aplicativos bastante grandes, uma parte significativa do projeto √© a l√≥gica de neg√≥cios.  √â conveniente depurar esta parte do programa no computador e, em seguida, incorpor√°-la ao projeto do microcontrolador, esperando que essa pe√ßa seja executada exatamente como foi planejada sem nenhuma depura√ß√£o (caso ideal). <br><br>  Como a maioria dos programas para microcontroladores √© escrita em C / C ++, para esses fins, eles geralmente usam classes abstratas que fornecem interfaces para entidades de baixo n√≠vel (se um projeto √© gravado apenas usando C, as estruturas de ponteiros de fun√ß√£o s√£o usadas com freq√º√™ncia).  Essa abordagem fornece o n√≠vel de abstra√ß√£o necess√°rio sobre o ferro, no entanto, √© repleta de necessidade de recompila√ß√£o constante do projeto, seguida pela programa√ß√£o da mem√≥ria n√£o vol√°til do microcontrolador com um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grande</a> arquivo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">firmware</a> bin√°rio. <br><br>  No entanto, existe outra maneira - usar uma linguagem de script que permita depurar a l√≥gica de neg√≥cios em tempo real no pr√≥prio dispositivo ou carregar scripts de trabalho diretamente da mem√≥ria externa, sem incluir esse c√≥digo no firmware do microcontrolador. <br><br>  Eu escolhi Lua como a linguagem de script. <a name="habracut"></a><br><br><h2>  Por que Lua? </h2><br>  Existem v√°rias linguagens de script que voc√™ pode incorporar em um projeto para um microcontrolador.  Alguns simples, do tipo BASIC, PyMite, Pe√£o ... Cada um tem seus pr√≥s e contras, cuja discuss√£o n√£o est√° inclu√≠da na lista de problemas discutidos neste artigo. <br><br>  Brevemente sobre o que √© bom especificamente lua - pode ser encontrado no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Lua em 60 minutos"</a> .  Este artigo me inspirou muito e, para um estudo mais detalhado da quest√£o, li o manual oficial do autor do idioma Robert Jeruzalimsky " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Programa√ß√£o em Lua</a> " (dispon√≠vel na tradu√ß√£o oficial para o russo). <br><br>  Eu tamb√©m gostaria de mencionar o projeto eLua.  No meu caso, eu j√° tenho uma camada de baixo n√≠vel de software pronta para intera√ß√£o com os perif√©ricos do microcontrolador e outros perif√©ricos necess√°rios localizados na placa do dispositivo.  Portanto, n√£o considerei esse projeto (pois √© reconhecido por fornecer as pr√≥prias camadas para conectar o n√∫cleo Lua aos perif√©ricos do microcontrolador). <br><br><h2>  Sobre o projeto no qual Lua ser√° incorporada </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Por tradi√ß√£o</a> , meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto sandbox</a> ser√° usado como a qualidade do campo para experimentos (link para o commit com a lua j√° integrada com todas as melhorias necess√°rias descritas abaixo). <br><br>  O projeto √© baseado no microcontrolador stm32f405rgt6 com 1 MB n√£o vol√°til e 192 KB de RAM (atualmente s√£o usados ‚Äã‚Äãos 2 blocos mais antigos com uma capacidade total de 128 KB). <br><br>  O projeto possui um sistema operacional FreeRTOS em tempo real para suportar a infraestrutura perif√©rica de hardware.  Toda a mem√≥ria para tarefas, sem√°foros e outros objetos do FreeRTOS √© alocada estaticamente no est√°gio de vincula√ß√£o (localizado na √°rea .bss da RAM).  Todas as entidades do FreeRTOS (sem√°foros, filas, pilhas de tarefas etc.) fazem parte de objetos globais nas √°reas particulares de suas classes.  No entanto, o heap do FreeRTOS ainda √© alocado para dar suporte √†s fun√ß√µes <i>malloc</i> , <i>free</i> , <i>calloc</i> (necess√°rias para fun√ß√µes como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">printf</a> ) que s√£o redefinidas para trabalhar com ele.  H√° uma API elevada para trabalhar com cart√µes MicroSD (FatFS), bem como para depurar UART (115200, 8N1). <br><br><h2>  Sobre a l√≥gica de usar Lua como parte de um projeto </h2><br>  Para fins de depura√ß√£o da l√≥gica de neg√≥cios, assume-se que os comandos ser√£o enviados via UART, empacotados (como um objeto separado) em linhas finalizadas (terminando com o caractere "\ n" + 0-terminador) e enviados para a m√°quina lua.  Em caso de execu√ß√£o malsucedida, imprima por meio de printf (j√° que estava <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">envolvido anteriormente</a> no projeto).  Quando a l√≥gica √© depurada, ser√° poss√≠vel fazer o download do arquivo final da l√≥gica comercial do arquivo do cart√£o microSD (n√£o inclu√≠do no material deste artigo).  Al√©m disso, com a finalidade de depurar Lua, a m√°quina ser√° executada dentro de um thread do FreeRTOS separado (no futuro, um thread separado ser√° alocado para cada script de l√≥gica de neg√≥cios depurado no qual ser√° executado com seu ambiente). <br><br><h2>  Inclus√£o do subm√≥dulo lua no projeto </h2><br>  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">espelho oficial do projeto no github</a> ser√° usado como fonte da biblioteca lua (j√° que meu projeto tamb√©m est√° publicado l√°. Voc√™ pode usar as fontes diretamente do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site oficial</a> ).  Como o projeto possui um sistema estabelecido para montar subm√≥dulos como parte do projeto, CMakeLists individuais para cada subm√≥dulo, criei um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">subm√≥dulo separado</a> no qual inclu√≠ esse fork e o CMakeLists para manter um estilo de constru√ß√£o √∫nico. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CMakeLists</a> cria as fontes do reposit√≥rio lua como uma biblioteca est√°tica com os seguintes sinalizadores de compila√ß√£o do submodulo (extra√≠dos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">arquivo de configura√ß√£o do submodule</a> no projeto principal): <br><br><pre><code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(C_COMPILER_FLAGS <span class="hljs-string"><span class="hljs-string">"-std=gnu99;-fshort-enums;-fno-exceptions;-Wno-type-limits;-ffunction-sections;-fdata-sections;"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(MODULE_LUA_COMP_FLAGS <span class="hljs-string"><span class="hljs-string">"-O0;-g3;${C_COMPILER_FLAGS}"</span></span></code> </pre> <br>  E sinalizadores de especifica√ß√£o do processador usado (definido na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">raiz CMakeLists</a> ): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(HARDWARE_FLAGS -mthumb; -mcpu=cortex-m4; -mfloat-abi=hard; -mfpu=fpv4-sp-d16;)</code> </pre> <br>  √â importante observar a necessidade de o CMakeLists raiz especificar uma defini√ß√£o que permita n√£o usar valores duplos (j√° que o microcontrolador n√£o possui suporte de hardware para double. Only float): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span>(-DLUA_32BITS)</code> </pre> <br>  Bem, resta apenas informar o vinculador sobre a necessidade de montar esta biblioteca e incluir o resultado no layout do projeto final: <br><br><div class="spoiler">  <b class="spoiler_title">Gr√°fico de CMakeLists para vincular um projeto √† biblioteca lua</b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_subdirectory</span></span>(<span class="hljs-variable"><span class="hljs-variable">${CMAKE_SOURCE_DIR}</span></span>/bsp/submodules/module_lua) ... <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>(<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf PUBLIC <span class="hljs-comment"><span class="hljs-comment"># -Wl,--start-group       #      . #  Lua    ,      #  . "-Wl,--start-group" ..._... MODULE_LUA ..._... "-Wl,--end-group")</span></span></code> </pre> </div></div><br><h2>  Definindo fun√ß√µes para trabalhar com mem√≥ria </h2><br>  Como o pr√≥prio Lua n√£o lida com mem√≥ria, essa responsabilidade √© transferida para o usu√°rio.  No entanto, ao usar a biblioteca empacotada <i>lauxlib</i> e a fun√ß√£o <i>luaL_newstate</i> , a fun√ß√£o <i>l_alloc</i> √© <i>vinculada</i> como um sistema de mem√≥ria.  √â definido da seguinte forma: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l_alloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ud, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> osize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nsize)</span></span></span><span class="hljs-function"> </span></span>{ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)ud; (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)osize; <span class="hljs-comment"><span class="hljs-comment">/* not used */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nsize == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(ptr, nsize); }</code> </pre> <br>  Conforme mencionado no in√≠cio do artigo, o projeto j√° substituiu as fun√ß√µes <i>malloc</i> e <i>free</i> , mas n√£o h√° fun√ß√£o <i>realloc</i> .  Precisamos consertar isso. <br><br>  No mecanismo padr√£o para trabalhar com o heap do FreeRTOS, o arquivo heap_4.c usado no projeto n√£o possui uma fun√ß√£o para redimensionar um bloco de mem√≥ria alocado anteriormente.  A este respeito, √© necess√°rio fazer a sua implementa√ß√£o com base em <i>malloc</i> e <i>livre</i> . <br><br>  Como no futuro √© poss√≠vel alterar o esquema de aloca√ß√£o de mem√≥ria (usando outro arquivo heap_x.c), foi decidido n√£o usar os interiores do esquema atual (heap_4.c), mas criar um suplemento de n√≠vel superior.  Embora menos eficaz. <br><br>  √â importante observar que o m√©todo <i>realloc</i> n√£o apenas exclui o bloco antigo (se existir) e cria um novo, mas tamb√©m move os dados do bloco antigo para o novo.  Al√©m disso, se o bloco antigo tiver mais dados que o novo, o novo ser√° preenchido com os antigos at√© o limite e os dados restantes ser√£o descartados. <br><br>  Se esse fato n√£o for levado em considera√ß√£o, sua m√°quina poder√° executar esse script tr√™s vezes a partir da linha " <i>a = 3 \ n</i> ", ap√≥s o que ocorrer√° uma falha grave.  O problema pode ser resolvido ap√≥s o estudo da imagem residual dos registros no manipulador de falhas graves, a partir da qual ser√° poss√≠vel descobrir que a falha ocorreu ap√≥s tentar expandir a tabela nas entranhas do c√≥digo do interpretador e de suas bibliotecas.  Se voc√™ chamar um script como " <i>print 'test'</i> ", o comportamento mudar√° dependendo de como o arquivo de firmware √© montado (em outras palavras, o comportamento √© indefinido). <br><br>  Para copiar dados do bloco antigo para o novo, precisamos descobrir o tamanho do bloco antigo.  O FreeRTOS heap_4.c (como outros arquivos que fornecem m√©todos de manipula√ß√£o de heap) n√£o fornece uma API para isso.  Portanto, voc√™ tem que terminar o seu.  Como base, peguei a fun√ß√£o <i>vPortFree</i> e reduzi sua funcionalidade da seguinte forma: <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo da fun√ß√£o VPortGetSizeBlock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vPortGetSizeBlock</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *puc = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)pv; BlockLink_t *pxLink; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pv != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { puc -= xHeapStructSize; pxLink = (BlockLink_t *)puc; configASSERT((pxLink-&gt;xBlockSize &amp; xBlockAllocatedBit) != <span class="hljs-number"><span class="hljs-number">0</span></span>); configASSERT(pxLink-&gt;pxNextFreeBlock == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pxLink-&gt;xBlockSize &amp; ~xBlockAllocatedBit; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> </div></div><br>  Agora √© pequeno, escreva <i>realloc com</i> base em <i>malloc</i> , <i>free</i> e <i>vPortGetSizeBlock</i> : <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de implementa√ß√£o Realloc baseado em malloc, free e vPortGetSizeBlock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> new_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* p = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> old_size = vPortGetSizeBlock(ptr); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> cpy_len = (new_size &lt; old_size)?new_size:old_size; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, ptr, cpy_len); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; }</code> </pre> </div></div><br><h2>  Adicione suporte para trabalhar com stdout </h2><br>  Como √© conhecido pela descri√ß√£o oficial, o pr√≥prio interpretador lua n√£o pode trabalhar com E / S.  Para esses fins, uma das bibliotecas padr√£o est√° conectada.  Para sa√≠da, ele usa o fluxo <i>stdout</i> .  A fun√ß√£o <i>luaopen_io</i> da biblioteca padr√£o √© respons√°vel pela conex√£o com o fluxo.  Para dar suporte ao trabalho com <i>stdout</i> (diferente do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">printf</a> ), voc√™ precisar√° substituir a fun√ß√£o <i>fwrite</i> .  Eu o redefini com base nas fun√ß√µes descritas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o de escrita</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> fwrite(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *buf, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> count, FILE *stream) { stream = stream; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> len = size * count; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*&gt;(buf); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_write_char((s[i])) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len; }</code> </pre> </div></div><br>  Sem sua defini√ß√£o, a fun√ß√£o de <i>impress√£o</i> em lua ser√° executada com √™xito, mas n√£o haver√° sa√≠da.  Al√©m disso, n√£o haver√° erros na pilha Lua da m√°quina (uma vez que formalmente a fun√ß√£o foi executada com sucesso). <br><br>  Al√©m dessa fun√ß√£o, precisaremos da fun√ß√£o <i>fflush</i> (para que o modo interativo funcione, que ser√° <i>discutido</i> posteriormente).  Como essa fun√ß√£o n√£o pode ser substitu√≠da, voc√™ precisar√° nome√°-la um pouco diferente.  A fun√ß√£o √© uma vers√£o simplificada da fun√ß√£o <i>fwrite</i> e destina-se a enviar o que est√° agora no buffer com sua limpeza subsequente (sem transfer√™ncia adicional de carro). <br><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o Mc_fflush</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mc_fflush</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len = buf_p; buf_p = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uart_1.tx(tx_buf, len, <span class="hljs-number"><span class="hljs-number">100</span></span>) != mc_interfaces::res::ok) { errno = EIO; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br><h2>  Recuperando seq√º√™ncias de caracteres de uma porta serial </h2><br>  Para obter strings para uma m√°quina lua, decidi escrever uma classe simples uart-terminal, que: <br><br><ul><li>  recebe dados em uma porta serial byte a byte (em interrup√ß√£o); </li><li>  adiciona o byte recebido √† fila, de onde o fluxo o recebe; </li><li>  em um fluxo de bytes, se n√£o for um feed de linha, enviado de volta no formato em que chegou; </li><li>  se um feed de linha chegou (' <i>\ r</i> '), s√£o enviados 2 bytes de retorno de carro do terminal (" <i>\ n \ r</i> "); </li><li>  depois de enviar a resposta, o manipulador do byte que chegou (objeto de layout de linha) √© chamado; </li><li>  controla o pressionamento da tecla de exclus√£o de caracteres (para evitar a exclus√£o de caracteres de servi√ßo da janela do terminal); </li></ul><br>  Links para fontes: <br><br><ul><li>  A interface da classe UART est√° <a href="">aqui</a> ; </li><li>  A classe base do UART est√° <a href="">aqui</a> e <a href="">aqui</a> ; </li><li>  classe uart_terminal <a href="">aqui</a> e <a href="">aqui</a> ; </li><li>  criando um objeto de classe como parte do projeto <a href="">aqui</a> . </li></ul><br>  Al√©m disso, observo que, para que esse objeto funcione corretamente, voc√™ precisa atribuir uma prioridade √† interrup√ß√£o do UART no intervalo permitido para trabalhar com as fun√ß√µes do FreeRTOS a partir da interrup√ß√£o.  Caso contr√°rio, voc√™ poder√° obter erros interessantes de dif√≠cil depura√ß√£o.  No exemplo atual, as seguintes op√ß√µes para interrup√ß√µes s√£o definidas no arquivo <a href="">FreeRTOSConfig.h</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√µes no FreeRTOSConfig.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configPRIO_BITS 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configKERNEL_INTERRUPT_PRIORITY 0XF0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   FreeRTOS API   //   0x8 - 0xF. #define configMAX_SYSCALL_INTERRUPT_PRIORITY 0x80</span></span></span></span></code> </pre> </div></div><br>  No pr√≥prio projeto, um objeto da classe <i>nvic</i> define a prioridade da interrup√ß√£o 0x9, inclu√≠da no intervalo v√°lido (a classe nvic √© descrita <a href="">aqui</a> e <a href="">aqui</a> ). <br><br><h2>  Forma√ß√£o de strings para uma m√°quina Lua </h2><br>  Os bytes recebidos do objeto uart_terminal s√£o transferidos para uma inst√¢ncia de uma classe simples serial_cli, que fornece uma interface m√≠nima para editar a string e transferi-la diretamente para o encadeamento no qual a lua-machine √© executada (chamando a fun√ß√£o de retorno de chamada).  Ao aceitar o caractere '\ r', uma fun√ß√£o de retorno de chamada √© chamada.  Essa fun√ß√£o deve copiar uma linha para si mesma e "liberar" o controle (uma vez que a recep√ß√£o de novos bytes √© bloqueada durante uma chamada. Isso n√£o √© um problema com fluxos priorizados corretamente e com uma velocidade UART suficientemente baixa). <br><br>  Links para fontes: <br><br><ul><li>  arquivos de descri√ß√£o serial_cli <a href="">aqui</a> e <a href="">aqui</a> ; </li><li>  criando um objeto de classe como parte do projeto <a href="">aqui</a> . </li></ul><br>  √â importante observar que essa classe considera inv√°lida uma string com mais de 255 caracteres e a descarta.  Isso √© intencional, porque o int√©rprete lua permite inserir constru√ß√µes linha por linha, aguardando o final do bloco. <br><br><h2>  Passando uma string para o interpretador Lua e sua execu√ß√£o </h2><br>  O pr√≥prio interpretador Lua n√£o sabe como aceitar o c√≥digo do bloco linha por linha e, em seguida, executa o bloco inteiro por si pr√≥prio.  No entanto, se voc√™ instalar Lua em um computador e executar o interpretador no modo interativo, podemos ver que a execu√ß√£o √© linha a linha com a nota√ß√£o correspondente √† medida que voc√™ digita, que o bloco ainda n√£o est√° completo.  Como o modo interativo √© o que √© fornecido no pacote padr√£o, podemos ver seu c√≥digo.  Est√° localizado no arquivo <a href="">lua.c.</a>  Estamos interessados ‚Äã‚Äãna fun√ß√£o <i>doREPL</i> e em tudo que ela usa.  Para n√£o criar uma bicicleta, para obter as fun√ß√µes do modo interativo no projeto, <i>criei</i> uma porta desse c√≥digo em uma classe separada, que <i>chamei lua_repl</i> pelo nome da fun√ß√£o original, que usa printf para imprimir informa√ß√µes no console e tem um m√©todo p√∫blico <i>add_lua_string</i> para adicionar uma linha recebida do objeto de classe serial_cli descrito acima. <br><br>  Refer√™ncias: <br><br><ul><li>  descri√ß√£o da classe lua_repl <a href="">aqui</a> ; </li><li>  c√≥digo <a href="">aqui</a> , <a href="">aqui</a> e <a href="">aqui</a> ; </li></ul><br>  A classe √© feita de acordo com o padr√£o singleton de Myers, j√° que n√£o h√° necessidade de fornecer v√°rios modos interativos no mesmo dispositivo.  Um objeto da classe lua_repl recebe dados de um objeto da classe serial_cli <a href="">aqui</a> . <br><br>  Como o projeto j√° possui um sistema unificado para inicializa√ß√£o e manuten√ß√£o de objetos globais, o ponteiro para o objeto da classe lua_repl √© passado para o objeto da classe global <a href="">player :: base</a> <a href="">aqui</a> .  No m√©todo <i>start</i> de um objeto da classe <a href="">player :: base</a> (declarado <a href="">aqui</a> . Tamb√©m √© chamado de main), o m√©todo <i>init</i> do objeto da classe lua_repl √© chamado com a prioridade da tarefa FreeRTOS 3 (no projeto, voc√™ pode atribuir a prioridade da tarefa de 1 a 4. Onde 1 √â a prioridade mais baixa e 4 √© a mais alta).  Ap√≥s uma inicializa√ß√£o bem-sucedida, a classe global inicia o agendador FreeRTOS e o modo interativo inicia seu trabalho. <br><br><h2>  Problemas de portabilidade </h2><br>  Abaixo est√° uma lista dos problemas que encontrei durante a porta Lua da m√°quina. <br><br><h4>  2-3 scripts de linha √∫nica de atribui√ß√£o de vari√°veis ‚Äã‚Äãs√£o executados, ent√£o tudo cai em falha grave </h4><br>  O problema estava com o m√©todo realloc.  √â necess√°rio n√£o apenas selecionar novamente o bloco, mas tamb√©m copiar o conte√∫do do antigo (conforme descrito acima). <br><br><h4>  Ao tentar imprimir um valor, o int√©rprete cai em falha grave </h4><br>  J√° era mais dif√≠cil detectar o problema, mas no final consegui descobrir que o snprintf era usado para impress√£o.  Como lua armazena valores em double (ou float no nosso caso), printf (e seus derivados) com suporte a ponto flutuante √© necess√°rio (escrevi sobre os meandros de printf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ). <br><br><h2>  Requisitos para mem√≥ria n√£o vol√°til (flash) </h2><br>  Aqui est√£o algumas medidas que eu fiz para julgar quanta mem√≥ria n√£o vol√°til (flash) precisa ser alocada para integrar a m√°quina Lua no projeto.  A compila√ß√£o foi realizada usando gcc-arm-none-eabi-8-2018-q4-major.  A vers√£o do Lua 5.4 foi usada.  Abaixo nas medi√ß√µes, a frase ‚Äúsem Lua‚Äù significa a n√£o inclus√£o do int√©rprete e m√©todos de intera√ß√£o com ele e suas bibliotecas, bem como um objeto da classe lua_repl no projeto.  Todas as entidades de baixo n√≠vel (incluindo substitui√ß√µes para as fun√ß√µes <i>printf</i> e <i>fwrite</i> ) permanecem no projeto.  O tamanho da pilha do FreeRTOS √© 1024 * 25 bytes.  O restante √© ocupado por entidades globais do projeto. <br><br>  A tabela de resumo dos resultados √© a seguinte (todos os tamanhos em bytes): <br><table border="1"><tbody><tr><th>  Op√ß√µes de compila√ß√£o </th><th>  Sem lua </th><th>  Apenas n√∫cleo </th><th>  Lua com biblioteca base </th><th>  Lua com base de bibliotecas, corotina, tabela, string </th><th>  luaL_openlibs </th></tr><tr><td>  -O0 -g3 </td><td>  103028 </td><td>  220924 </td><td>  236124 </td><td>  262652 </td><td>  308372 </td></tr><tr><td>  -O1 -g3 </td><td>  74940 </td><td>  144732 </td><td>  156916 </td><td>  174452 </td><td>  213068 </td></tr><tr><td>  -Os -g0 </td><td>  71172 </td><td>  134228 </td><td>  145756 </td><td>  161428 </td><td>  198400 </td></tr></tbody></table><br><h2>  Requisitos de RAM </h2><br>  Como o consumo de RAM depende inteiramente da tarefa, fornecerei uma tabela de resumo da mem√≥ria consumida imediatamente ap√≥s ligar a m√°quina com um conjunto diferente de bibliotecas (ele √© exibido pela <i>impress√£o (comando collectgarbage ("count") * 1024</i> )). <br><table border="1"><tbody><tr><td>  Composi√ß√£o: </td><td>  RAM usada </td></tr><tr><td>  Lua com biblioteca base </td><td>  4809 </td></tr><tr><td>  Lua com base de bibliotecas, corotina, tabela, string </td><td>  6407 </td></tr><tr><td>  luaL_openlibs </td><td>  12769 </td></tr></tbody></table><br>  No caso de usar todas as bibliotecas, o tamanho da RAM necess√°ria aumenta significativamente em compara√ß√£o com os conjuntos anteriores.  No entanto, seu uso em uma parte consider√°vel dos aplicativos n√£o √© necess√°rio. <br><br>  Al√©m disso, 4 kb tamb√©m s√£o alocados para a pilha de tarefas, na qual a m√°quina Lua √© executada. <br><br><h2>  Uso adicional </h2><br>  Para uso total da m√°quina no projeto, voc√™ precisar√° descrever melhor todas as interfaces exigidas pelo c√≥digo de l√≥gica de neg√≥cios para os objetos de hardware ou servi√ßo do projeto.  No entanto, este √© o t√≥pico de um artigo separado. <br><br><h2>  Sum√°rio </h2><br>  Este artigo descreveu como conectar uma m√°quina Lua a um projeto para um microcontrolador, al√©m de iniciar um int√©rprete interativo completo que permite experimentar a l√≥gica de neg√≥cios diretamente da linha de comando do terminal.  Al√©m disso, os requisitos para o hardware do microcontrolador foram considerados para diferentes configura√ß√µes da m√°quina Lua. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt459602/">https://habr.com/ru/post/pt459602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt459590/index.html">Programa de afiliados de c√≥digo aberto descentralizado na blockchain Waves</a></li>
<li><a href="../pt459592/index.html">Tr√™s dicas de gerenciamento de tempo para quem j√° tentou de tudo.</a></li>
<li><a href="../pt459594/index.html">Leia entre notas: sistema de transfer√™ncia de dados dentro da m√∫sica</a></li>
<li><a href="../pt459596/index.html">iOS Digest No. 9 (28 de junho a 11 de julho)</a></li>
<li><a href="../pt459598/index.html">Perguntas frequentes do SELinux (FAQ)</a></li>
<li><a href="../pt459604/index.html">Telegrama - bot | Menu completo</a></li>
<li><a href="../pt459606/index.html">Redes sociais distribu√≠das</a></li>
<li><a href="../pt459610/index.html">Esses roteadores perigosos: o hacking em maior escala dos equipamentos de rede recentes e os m√©todos de prote√ß√£o</a></li>
<li><a href="../pt459612/index.html">Como a Qualcomm roubou a ind√∫stria m√≥vel por quase 20 anos seguidos</a></li>
<li><a href="../pt459614/index.html">Pato-rob√¥ agita arrozais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>