<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤¹ğŸ¼ ğŸ‘­ ğŸ•µğŸ» å¦ä¸€ä¸ªæ¨¡æ‹Ÿåº“ ğŸŒŒ ğŸ§š ğŸŒ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸‹åˆå¥½ æˆ‘ä»äº‹æµ‹è¯•è‡ªåŠ¨åŒ–ã€‚ åƒæ‰€æœ‰è‡ªåŠ¨åŒ–å·¥ç¨‹å¸ˆä¸€æ ·ï¼Œæˆ‘æœ‰ä¸€ç»„é€šå¸¸é€‰æ‹©ç¼–å†™æµ‹è¯•çš„åº“å’Œå·¥å…·ã€‚ ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç»å¸¸ä¼šå‡ºç°ä¸€äº›ç†Ÿæ‚‰çš„åº“æ— æ³•è§£å†³æ­¤é—®é¢˜ï¼Œå¹¶å­˜åœ¨ä½¿è‡ªåŠ¨æµ‹è¯•ä¸ç¨³å®šæˆ–è„†å¼±çš„é£é™©ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³å‘Šè¯‰æ‚¨ä½¿ç”¨å˜²ç¬‘ovçš„çœ‹ä¼¼æ ‡å‡†ä»»åŠ¡æ˜¯å¦‚ä½•ä¿ƒä½¿æˆ‘ç¼–å†™æ¨¡å—çš„ã€‚ æˆ‘ä¹Ÿæƒ³åˆ†äº«æˆ‘çš„å†³å®šå¹¶å¬å¬åé¦ˆã€‚ 
 åº”ç”¨ç¨‹...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¦ä¸€ä¸ªæ¨¡æ‹Ÿåº“</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476904/"><p>ä¸‹åˆå¥½ æˆ‘ä»äº‹æµ‹è¯•è‡ªåŠ¨åŒ–ã€‚ åƒæ‰€æœ‰è‡ªåŠ¨åŒ–å·¥ç¨‹å¸ˆä¸€æ ·ï¼Œæˆ‘æœ‰ä¸€ç»„é€šå¸¸é€‰æ‹©ç¼–å†™æµ‹è¯•çš„åº“å’Œå·¥å…·ã€‚ ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç»å¸¸ä¼šå‡ºç°ä¸€äº›ç†Ÿæ‚‰çš„åº“æ— æ³•è§£å†³æ­¤é—®é¢˜ï¼Œå¹¶å­˜åœ¨ä½¿è‡ªåŠ¨æµ‹è¯•ä¸ç¨³å®šæˆ–è„†å¼±çš„é£é™©ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³å‘Šè¯‰æ‚¨ä½¿ç”¨å˜²ç¬‘ovçš„çœ‹ä¼¼æ ‡å‡†ä»»åŠ¡æ˜¯å¦‚ä½•ä¿ƒä½¿æˆ‘ç¼–å†™æ¨¡å—çš„ã€‚ æˆ‘ä¹Ÿæƒ³åˆ†äº«æˆ‘çš„å†³å®šå¹¶å¬å¬åé¦ˆã€‚ </p><a name="habracut"></a><br><h1> åº”ç”¨ç¨‹å¼ </h1><br><p> å®¡è®¡æ˜¯é‡‘èéƒ¨é—¨çš„å¿…è¦éƒ¨é—¨ä¹‹ä¸€ã€‚ æ•°æ®éœ€è¦å®šæœŸæ£€æŸ¥ï¼ˆå¯¹å¸ï¼‰ã€‚ åœ¨è¿™æ–¹é¢ï¼Œæˆ‘æµ‹è¯•è¿‡çš„åº”ç”¨ç¨‹åºå‡ºç°äº†ã€‚ ä¸ºäº†ä¸è°ˆè®ºæŠ½è±¡çš„ä¸œè¥¿ï¼Œè®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬çš„å›¢é˜Ÿæ­£åœ¨å¼€å‘ä¸€ä¸ªç”¨äºå¤„ç†å³æ—¶é€šè®¯ç¨‹åºä¸­çš„åº”ç”¨ç¨‹åºçš„åº”ç”¨ç¨‹åºã€‚ å¯¹äºæ¯ä¸ªåº”ç”¨ç¨‹åºï¼Œå¿…é¡»åœ¨elasticsearchä¸­åˆ›å»ºä¸€ä¸ªé€‚å½“çš„äº‹ä»¶ã€‚ éªŒè¯åº”ç”¨ç¨‹åºå°†æ˜¯æˆ‘ä»¬å¯¹æœªè·³è¿‡åº”ç”¨ç¨‹åºçš„ç›‘è§†ã€‚ </p><br><p> å› æ­¤ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«ä»¥ä¸‹ç»„ä»¶çš„ç³»ç»Ÿï¼š </p><br><ol><li> é…ç½®æœåŠ¡å™¨ã€‚ å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä¸ªå•ä¸€çš„å…¥å£ç‚¹ï¼Œä»–ä¸ä»…å¯ä»¥é…ç½®ç”¨äºéªŒè¯çš„åº”ç”¨ç¨‹åºï¼Œè¿˜å¯ä»¥é…ç½®ç³»ç»Ÿçš„å…¶ä»–ç»„ä»¶ã€‚ </li><li> éªŒè¯ç”³è¯·ã€‚ </li><li> æ¥è‡ªåº”ç”¨ç¨‹åºçš„æ•°æ®å¤„ç†å­˜å‚¨åœ¨elasticsearchä¸­çš„åº”ç”¨ç¨‹åºã€‚ </li><li> å‚è€ƒæ•°æ®ã€‚ æ•°æ®æ ¼å¼å–å†³äºä¸åº”ç”¨ç¨‹åºé›†æˆçš„Messengerã€‚ </li></ol><br><h1> æŒ‘æˆ˜èµ› </h1><br><p> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµ‹è¯•è‡ªåŠ¨åŒ–çœ‹èµ·æ¥éå¸¸ç®€å•ï¼š </p><br><ol><li> ç¯å¢ƒå‡†å¤‡ï¼š <br><ul><li> ä½¿ç”¨æœ€å°çš„é…ç½®ï¼ˆä½¿ç”¨msiå’Œå‘½ä»¤è¡Œï¼‰å®‰è£…Elasticsearchã€‚ </li><li> å·²å®‰è£…éªŒè¯åº”ç”¨ç¨‹åºã€‚ </li></ul></li><li> æµ‹è¯•æ‰§è¡Œï¼š <br><ul><li> éªŒè¯åº”ç”¨ç¨‹åºå·²é…ç½®ã€‚ </li><li>  Elasticsearchå……æ»¡äº†å¯¹åº”æµ‹è¯•çš„æµ‹è¯•æ•°æ®ï¼ˆå¤„ç†äº†å¤šå°‘ä¸ªåº”ç”¨ç¨‹åºï¼‰ã€‚ </li><li> è¯¥åº”ç”¨ç¨‹åºä»Messengeræ¥æ”¶â€œå‚è€ƒâ€æ•°æ®ï¼ˆå‡å®šå®é™…ä¸Šæœ‰å¤šå°‘ä¸ªåº”ç”¨ç¨‹åºï¼‰ã€‚ </li><li> æ£€æŸ¥ç”±åº”ç”¨ç¨‹åºå‘å¸ƒçš„åˆ¤å†³ï¼šæˆåŠŸéªŒè¯çš„åº”ç”¨ç¨‹åºæ•°é‡ï¼Œä¸¢å¤±çš„åº”ç”¨ç¨‹åºæ•°é‡ç­‰ã€‚ </li></ul></li><li> æ¸…æ´ç¯å¢ƒã€‚ </li></ol><br><p> é—®é¢˜æ˜¯æˆ‘ä»¬æ­£åœ¨æµ‹è¯•ç›‘è§†ï¼Œä½†æ˜¯è¦é…ç½®å®ƒï¼Œæˆ‘ä»¬éœ€è¦æ¥è‡ªé…ç½®æœåŠ¡å™¨çš„æ•°æ®ã€‚ é¦–å…ˆï¼Œä¸ºæ¯æ¬¡è¿è¡Œå®‰è£…å’Œé…ç½®æœåŠ¡å™¨æ˜¯ä¸€é¡¹è€—æ—¶çš„æ“ä½œï¼ˆä¾‹å¦‚ï¼Œå®ƒæœ‰è‡ªå·±çš„åŸºç¡€ï¼‰ã€‚ å…¶æ¬¡ï¼Œæˆ‘æƒ³éš”ç¦»åº”ç”¨ç¨‹åºï¼Œä»¥ç®€åŒ–å‘ç°ç¼ºé™·æ—¶é—®é¢˜çš„å®šä½ã€‚ æœ€åï¼Œå†³å®šä½¿ç”¨æ¨¡æ‹Ÿã€‚ </p><br><p> è¿™å¯èƒ½ä¼šå¼•å‘ä¸€ä¸ªé—®é¢˜ï¼šâ€œå¦‚æœæˆ‘ä»¬ä»ç„¶æ¨¡æ‹ŸæœåŠ¡å™¨ï¼Œä¹Ÿè®¸æˆ‘ä»¬ä¸èƒ½èŠ±æ—¶é—´å®‰è£…å’Œå¡«å……Elasticsearchï¼Œè€Œè¦æ›¿æ¢æ¨¡æ‹Ÿå—ï¼Ÿâ€ã€‚ ä½†æ˜¯ï¼Œæ‚¨å§‹ç»ˆéœ€è¦è®°ä½ï¼Œæ¨¡æ‹Ÿçš„ä½¿ç”¨æä¾›äº†çµæ´»æ€§ï¼Œä½†æ˜¯å¢åŠ äº†ç›‘è§†æ¨¡æ‹Ÿè¡Œä¸ºçš„ç›¸å…³æ€§çš„ä¹‰åŠ¡ã€‚ å› æ­¤ï¼Œæˆ‘æ‹’ç»æ›¿æ¢elasticsearchï¼šå®‰è£…å’Œå¡«å……å®ƒéå¸¸ç®€å•ã€‚ </p><br><h1> ç¬¬ä¸€æ¬¡æ¨¡æ‹Ÿ </h1><br><p>æœåŠ¡å™¨ä»¥/é…ç½®ä¸­çš„å‡ ç§æ–¹å¼å°†é…ç½®å‘é€åˆ°GETè¯·æ±‚ã€‚ æˆ‘ä»¬å¯¹ä¸¤ç§æ–¹å¼æ„Ÿå…´è¶£ã€‚ ç¬¬ä¸€ä¸ªæ˜¯<code>/configuration/data_cluster</code>ä¸é›†ç¾¤é…ç½® </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span> } }</code> </pre> <br><p> ç¬¬äºŒæ˜¯<code>/configuration/reconciliation</code>ä¸é’»äº•åº”ç”¨ç¨‹åºçš„é…ç½®<code>/configuration/reconciliation</code> </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-attr"><span class="hljs-attr">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///c:/path"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span> } } }</code> </pre> <br><p> å›°éš¾åœ¨äºï¼Œæ‚¨éœ€è¦èƒ½å¤Ÿåœ¨æµ‹è¯•æœŸé—´æˆ–æµ‹è¯•ä¹‹é—´æ›´æ”¹æœåŠ¡å™¨å“åº”ï¼Œä»¥æµ‹è¯•åº”ç”¨ç¨‹åºå¦‚ä½•å“åº”é…ç½®æ›´æ”¹ï¼Œé”™è¯¯çš„å¯†ç ç­‰ã€‚ </p><br><p> å› æ­¤ï¼Œé™æ€æ¨¡æ‹Ÿå’Œç”¨äºå•å…ƒæµ‹è¯•ä¸­çš„æ¨¡æ‹Ÿå·¥å…·ï¼ˆæ¨¡æ‹Ÿï¼Œæ¥è‡ªpytestçš„Monkeypatchç­‰ï¼‰å¯¹æˆ‘ä»¬ä¸èµ·ä½œç”¨ã€‚ æˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªæˆ‘è®¤ä¸ºå¾ˆé€‚åˆæˆ‘çš„å‡ºè‰²çš„<code>pretenders</code>åº“ã€‚  <a href="https://pretenders.readthedocs.io/en/latest/" title="é˜…è¯»å‡è£…è€…æ–‡æ¡£">ä¼ªè£…ç¨‹åº</a>æä¾›ä½¿ç”¨è§„åˆ™ç¡®å®šHTTPæœåŠ¡å™¨å¦‚ä½•å“åº”è¯·æ±‚çš„HTTPæœåŠ¡å™¨çš„åŠŸèƒ½ã€‚ è§„åˆ™å­˜å‚¨åœ¨é¢„è®¾ä¸­ï¼Œä»è€Œå¯ä»¥éš”ç¦»ä¸åŒæµ‹è¯•å¥—ä»¶çš„æ¨¡æ‹Ÿã€‚ é¢„è®¾å¯ä»¥æ¸…é™¤å¹¶é‡æ–°å¡«å†™ï¼Œä½¿æ‚¨å¯ä»¥æ ¹æ®éœ€è¦æ›´æ–°ç­”æ¡ˆã€‚ åœ¨å‡†å¤‡ç¯å¢ƒæœŸé—´ï¼Œåªéœ€å°†æœåŠ¡å™¨æœ¬èº«æå‡ä¸€æ¬¡å³å¯ï¼š </p><br><pre> <code class="bash hljs">python -m pretenders.server.server --host 127.0.0.1 --port 8000</code> </pre> <br><p> åœ¨æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ å®¢æˆ·ç«¯çš„ä½¿ç”¨ã€‚ åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œå½“ç­”æ¡ˆåœ¨æµ‹è¯•ä¸­è¢«å®Œå…¨ç¡¬ç¼–ç æ—¶ï¼Œå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pretenders.client.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPMock <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pretenders.common.constants <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FOREVER @pytest.fixture <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configuration_server_mock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> mock = HTTPMock(host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, port=<span class="hljs-number"><span class="hljs-number">8000</span></span>, name=<span class="hljs-string"><span class="hljs-string">"server"</span></span>) request.addfinalizer(mock.reset) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_server_mock)</span></span></span><span class="hljs-function">:</span></span> configuration_server_mock.when(<span class="hljs-string"><span class="hljs-string">"GET /configuration/data_cluster"</span></span>).reply( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, body=json.dumps({ <span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }), status=<span class="hljs-number"><span class="hljs-number">200</span></span>, times=FOREVER, ) configuration_server_mock.when(<span class="hljs-string"><span class="hljs-string">"GET /configuration/reconciliation"</span></span>).reply( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, body=json.dumps({ <span class="hljs-string"><span class="hljs-string">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///c:/path"</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }, }), status=<span class="hljs-number"><span class="hljs-number">200</span></span>, times=FOREVER, ) <span class="hljs-comment"><span class="hljs-comment"># test application</span></span></code> </pre> <br><p> ä½†è¿™è¿˜ä¸æ˜¯å…¨éƒ¨ã€‚ å‡­å€Ÿå…¶çµæ´»æ€§ï¼Œ <code>pretenders</code>æœ‰ä¸¤ä¸ªå¿…é¡»è®°ä½çš„å±€é™æ€§ï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­å¿…é¡»åŠ ä»¥è§£å†³ï¼š </p><br><ol><li> ä¸èƒ½ä¸€æ¬¡åˆ é™¤ä¸€ä¸ªè§„åˆ™ã€‚ ä¸ºäº†æ›´æ”¹ç­”æ¡ˆï¼Œæ‚¨å¿…é¡»åˆ é™¤æ•´ä¸ªé¢„è®¾å¹¶å†æ¬¡é‡æ–°åˆ›å»ºæ‰€æœ‰è§„åˆ™ã€‚ </li><li> è§„åˆ™ä¸­ä½¿ç”¨çš„æ‰€æœ‰è·¯å¾„éƒ½æ˜¯ç›¸å¯¹çš„ã€‚ é¢„è®¾å…·æœ‰æ ¼å¼ä¸º/å˜²è®½http / &lt;é¢„è®¾åç§°&gt;çš„å”¯ä¸€è·¯å¾„ï¼Œå¹¶ä¸”è¯¥è·¯å¾„æ˜¯è§„åˆ™ä¸­æ‰€æœ‰å·²åˆ›å»ºè·¯å¾„çš„é€šç”¨å‰ç¼€ã€‚ è¢«æµ‹åº”ç”¨ç¨‹åºä»…æ¥æ”¶ä¸»æœºåï¼Œå¹¶ä¸”ä¸çŸ¥é“å‰ç¼€ã€‚ </li></ol><br><p> ç¬¬ä¸€ä¸ªé™åˆ¶æ˜¯éå¸¸ä¸æ„‰å¿«çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ç¼–å†™ä¸€ä¸ªæ¨¡å—æ¥å°è£…è¯¥é…ç½®æ¥è§£å†³ã€‚ ä¾‹å¦‚ </p><br><pre> <code class="python hljs">configuration.data_cluster.port = <span class="hljs-number"><span class="hljs-number">443</span></span></code> </pre> <br><p> æˆ–ï¼ˆä»¥å‡å°‘æ›´æ–°è¯·æ±‚çš„é¢‘ç‡ï¼‰ </p><br><pre> <code class="python hljs">data_cluster_config = get_default_data_cluster_config() data_cluster_config.port = <span class="hljs-number"><span class="hljs-number">443</span></span> configuration.update_data_cluster(data_cluster_config)</code> </pre> <br><p> è¿™ç§å°è£…ä½¿æˆ‘ä»¬å‡ ä¹å¯ä»¥è½»æ¾åœ°æ›´æ–°æ‰€æœ‰è·¯å¾„ã€‚ æ‚¨è¿˜å¯ä»¥ä¸ºæ¯ä¸ªå•ç‹¬çš„ç«¯ç‚¹åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„é¢„è®¾ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªé€šç”¨ï¼ˆä¸»è¦ï¼‰é¢„è®¾ï¼Œå°†å…¶é‡å®šå‘ï¼ˆé€šè¿‡307æˆ–308ï¼‰åˆ°å•ç‹¬çš„é¢„è®¾ã€‚ ç„¶åï¼Œæ‚¨åªèƒ½æ¸…é™¤ä¸€ä¸ªé¢„è®¾ä»¥æ›´æ–°è§„åˆ™ã€‚ </p><br><p> ä¸ºäº†æ‘†è„±å‰ç¼€ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<a href="https://mitmproxy.org/" title="è½¬åˆ°mitmproxyç½‘ç«™">mitmproxy</a>åº“ã€‚ è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œé™¤å…¶ä»–åŠŸèƒ½å¤–ï¼Œè¿˜å¯ä»¥é‡å®šå‘è¯·æ±‚ã€‚ æˆ‘ä»¬å°†åˆ é™¤å‰ç¼€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="bash hljs">mitmdump --mode reverse:http://127.0.0.1:8000 --replacements :~http:^/:/mockhttp/server/ --listen-host 127.0.01 --listen-port 80</code> </pre> <br><p> è¯¥å‘½ä»¤çš„å‚æ•°æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><ol><li>  <code>--listen-host 127.0.0.1</code>å’Œ<code>--listen-port 80</code>æ˜æ˜¾ã€‚  Mitmproxyæå‡å…¶æœåŠ¡å™¨ï¼Œå¹¶ä½¿ç”¨è¿™äº›å‚æ•°ç¡®å®šè¯¥æœåŠ¡å™¨å°†ä¾¦å¬çš„æ¥å£å’Œç«¯å£ã€‚ </li><li>  <code>--mode reverse:http://127.0.0.1:8000</code>æ„å‘³ç€å¯¹mitproxyæœåŠ¡å™¨çš„è¯·æ±‚å°†é‡å®šå‘åˆ°<code>http://127.0.0.1:8000</code> ã€‚  <a href="https://docs.mitmproxy.org/stable/concepts-modes/" title="å„ç§æ¨¡å¼çš„æ–‡æ¡£">åœ¨è¿™é‡Œ</a>é˜…è¯»æ›´å¤šã€‚ </li><li>  <code>--replacements :~http:^/:/mockhttp/server/</code>å®šä¹‰äº†ç”¨äºæ›´æ”¹è¯·æ±‚çš„æ¨¡æ¿ã€‚ å®ƒç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªè¯·æ±‚è¿‡æ»¤å™¨ï¼ˆHTTPè¯·æ±‚ä¸º<code>/mockhttp/server</code> ï¼‰ï¼Œä¸€ä¸ªç”¨äºæ›´æ”¹çš„æ¨¡æ¿ï¼ˆç”¨<code>^/</code>æ›¿æ¢è·¯å¾„çš„å¼€å¤´ï¼‰å’Œå®é™…æ›¿æ¢çš„<code>/mockhttp/server</code> ï¼ˆ <code>/mockhttp/server</code> ï¼‰ã€‚  <a href="https://docs.mitmproxy.org/stable/overview-features/" title="åŠŸèƒ½æ–‡æ¡£">åœ¨è¿™é‡Œ</a>é˜…è¯»æ›´å¤šã€‚ </li></ol><br><p> åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å‘æ‰€æœ‰HTTPè¯·æ±‚æ·»åŠ äº†<code>mockhttp/server</code> ï¼Œå¹¶å°†å…¶é‡å®šå‘åˆ°<code>http://127.0.0.1:8000</code> ï¼Œå³ ç»™æˆ‘ä»¬çš„æœåŠ¡å™¨ä¼ªè£…è€…ã€‚ ç»“æœï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ï¼Œç°åœ¨å¯ä»¥é€šè¿‡å¯¹<code>http://127.0.0.1/configuration/data_cluster</code>çš„GETè¯·æ±‚è·å¾—é…ç½®ã€‚ </p><br><p> æ€»çš„æ¥è¯´ï¼Œæˆ‘å¯¹<code>pretenders</code>å’Œ<code>mitmproxy</code>çš„è®¾è®¡æ„Ÿåˆ°æ»¡æ„ã€‚ ç”±äºè¡¨é¢ä¸Šå¾ˆå¤æ‚-æ¯•ç«Ÿæ˜¯2å°æœåŠ¡å™¨è€Œä¸æ˜¯ä¸€å°çœŸæ­£çš„æœåŠ¡å™¨-å‡†å¤‡å·¥ä½œåŒ…æ‹¬å®‰è£…2ä¸ªè½¯ä»¶åŒ…å¹¶åœ¨å‘½ä»¤è¡Œä¸Šæ‰§è¡Œ2ä¸ªå‘½ä»¤ä»¥å¯åŠ¨å®ƒä»¬ã€‚ å¹¶ä¸æ˜¯æ‰€æœ‰çš„äº‹æƒ…éƒ½åƒç®¡ç†æ¨¡æ‹Ÿé‚£æ ·ç®€å•ï¼Œä½†æ˜¯æ‰€æœ‰çš„å¤æ‚æ€§éƒ½åªåœ¨ä¸€ä¸ªåœ°æ–¹ï¼ˆç®¡ç†é¢„è®¾ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥éå¸¸ç®€å•ï¼Œå¯é åœ°è§£å†³ã€‚ ä½†æ˜¯ï¼Œæ–°çš„æƒ…å†µå‡ºç°åœ¨é—®é¢˜ä¸­ï¼Œè¿™ä½¿æˆ‘å¼€å§‹æ€è€ƒæ–°çš„è§£å†³æ–¹æ¡ˆã€‚ </p><br><h1> ç¬¬äºŒæ¬¡æ¨¡æ‹Ÿ </h1><br><p> åœ¨é‚£ä¸€åˆ»ä¹‹å‰ï¼Œæˆ‘å‡ ä¹æ²¡æœ‰è¯´è¿‡å‚è€ƒæ•°æ®æ¥è‡ªä½•å¤„ã€‚ ç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„ç”¨ä½œæ•°æ®æºçš„åœ°å€ã€‚ å®ƒç¡®å®å¯ä»¥åƒè¿™æ ·å·¥ä½œï¼Œä½†ä»…é€‚ç”¨äºå…¶ä¸­ä¸€ä¸ªä¾›åº”å•†ã€‚ å¦ä¸€ä¸ªä¾›åº”å•†æä¾›äº†ä¸€ä¸ªç”¨äºæ¥æ”¶åº”ç”¨ç¨‹åºçš„APIï¼Œæ­£æ˜¯è¿™ä¸ªé—®é¢˜å¼•èµ·äº†ä»–çš„å…´è¶£ã€‚ åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å¾ˆéš¾æé«˜ä¾›åº”å•†çš„APIï¼Œå› æ­¤æˆ‘è®¡åˆ’æŒ‰ç…§ä¸ä»¥å‰ç›¸åŒçš„æ–¹æ¡ˆå°†å…¶æ›¿æ¢ä¸ºæ¨¡æ‹Ÿã€‚ ä½†æ˜¯è¦æ¥æ”¶ç”³è¯·ï¼Œéœ€è¦ä¸€ä¸ªè¡¨æ ¼ </p><br><pre> <code class="plaintext hljs">GET /application-history?page=2&amp;size=5&amp;start=1569148012&amp;end=1569148446</code> </pre> <br><p> è¿™é‡Œæœ‰2åˆ†ã€‚ é¦–å…ˆï¼Œä¸€äº›é€‰æ‹©ã€‚ äº‹å®æ˜¯ï¼Œå¯ä»¥ä»¥ä»»ä½•é¡ºåºæŒ‡å®šå‚æ•°ï¼Œè¿™æå¤§åœ°ä½¿<code>pretenders</code>è§„åˆ™çš„æ­£åˆ™è¡¨è¾¾å¼å¤æ‚åŒ–ã€‚ è¿˜å¿…é¡»è®°ä½ï¼Œå‚æ•°æ˜¯å¯é€‰çš„ï¼Œä½†è¿™ä¸æ˜¯è¯¸å¦‚éšæœºé¡ºåºä¹‹ç±»çš„é—®é¢˜ã€‚ å…¶æ¬¡ï¼Œæœ€åä¸€ä¸ªå‚æ•°ï¼ˆå¼€å§‹å’Œç»“æŸï¼‰æŒ‡å®šè¿‡æ»¤è®¢å•çš„æ—¶é—´é—´éš”ã€‚ è¿™ç§æƒ…å†µä¸‹çš„é—®é¢˜åœ¨äºï¼Œæˆ‘ä»¬æ— æ³•é¢„å…ˆé¢„æµ‹åº”ç”¨ç¨‹åºå°†ä½¿ç”¨å“ªä¸ªé—´éš”ï¼ˆä¸æ˜¯å¹…åº¦ï¼Œè€Œæ˜¯å¼€å§‹æ—¶é—´ï¼‰æ¥å½¢æˆæ¨¡æ‹Ÿå“åº”ã€‚ ç®€è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å¹¶ä½¿ç”¨å‚æ•°å€¼æ¥å½¢æˆâ€œåˆç†çš„â€ç­”æ¡ˆã€‚ ä¾‹å¦‚ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œâ€œåˆç†æ€§â€å¾ˆé‡è¦ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æµ‹è¯•åº”ç”¨ç¨‹åºæ˜¯å¦éå†äº†åˆ†é¡µçš„æ‰€æœ‰é¡µé¢ï¼šå¦‚æœæˆ‘ä»¬ä»¥ç›¸åŒçš„æ–¹å¼å›ç­”æ‰€æœ‰è¯·æ±‚ï¼Œé‚£ä¹ˆç”±äºä»…è¯·æ±‚äº”åˆ†ä¹‹ä¸€çš„é¡µé¢ï¼Œæˆ‘ä»¬å°†æ— æ³•å‘ç°ç¼ºé™·ã€‚ ã€‚ </p><br><p> æˆ‘è¯•å›¾å¯»æ‰¾æ›¿ä»£è§£å†³æ–¹æ¡ˆï¼Œä½†æœ€ç»ˆæˆ‘å†³å®šå°è¯•ç¼–å†™è‡ªå·±çš„è§£å†³æ–¹æ¡ˆã€‚ å› æ­¤<a href="https://github.com/KillAChicken/loose-server" title="è½¬åˆ°å­˜å‚¨åº“å’Œæ–‡æ¡£">æœåŠ¡å™¨æ¾åŠ¨äº†</a> ã€‚ è¿™æ˜¯ä¸€ä¸ª<a href="https://palletsprojects.com/p/flask/" title="è½¬åˆ°é¡¹ç›®é¡µé¢">Flask</a>åº”ç”¨ç¨‹åºï¼Œåœ¨å¯åŠ¨åå¯ä»¥åœ¨å…¶ä¸­é…ç½®è·¯å¾„å’Œå“åº”ã€‚ å¼€ç®±å³ç”¨ï¼Œä»–çŸ¥é“å¦‚ä½•ä½¿ç”¨æœ‰å…³è¯·æ±‚ç±»å‹ï¼ˆGETï¼ŒPOSTç­‰ï¼‰å’Œè·¯å¾„çš„è§„åˆ™ã€‚ è¿™ä½¿æ‚¨å¯ä»¥æ›¿æ¢åŸå§‹ä»»åŠ¡ä¸­çš„<code>pretenders</code>å’Œ<code>mitmproxy</code> ã€‚ æˆ‘è¿˜å°†å±•ç¤ºå¦‚ä½•å°†å…¶ç”¨äºä¸ºä¾›åº”å•†APIåˆ›å»ºæ¨¡æ‹Ÿã€‚ </p><br><p> åº”ç”¨ç¨‹åºéœ€è¦2æ¡ä¸»è¦è·¯å¾„ï¼š </p><br><ol><li> åŸºæœ¬ç«¯ç‚¹ã€‚ è¿™æ˜¯å°†ç”¨äºæ‰€æœ‰å·²é…ç½®è§„åˆ™çš„å‰ç¼€ã€‚ </li><li> é…ç½®ç«¯ç‚¹ã€‚ è¿™æ˜¯æ‚¨å¯ä»¥ç”¨æ¥é…ç½®æ¨¡æ‹ŸæœåŠ¡å™¨æœ¬èº«çš„é‚£äº›è¯·æ±‚çš„å‰ç¼€ã€‚ </li></ol><br><pre> <code class="bash hljs">python -m looseserver.default.server.run --host 127.0.0.1 --port 80 --base-endpoint / --configuration-endpoint /_mock_configuration/</code> </pre> <br><p> é€šå¸¸ï¼Œæœ€å¥½ä¸è¦é…ç½®åŸºæœ¬ç«¯ç‚¹å’Œé…ç½®ç«¯ç‚¹ï¼Œä»¥ä½¿ä¸€ä¸ªç«¯ç‚¹æ˜¯å¦ä¸€ä¸ªç«¯ç‚¹çš„çˆ¶èŠ‚ç‚¹ã€‚ å¦åˆ™ï¼Œå­˜åœ¨é…ç½®å’Œæµ‹è¯•è·¯å¾„å†²çªçš„é£é™©ã€‚ é…ç½®ç«¯ç‚¹ä¼˜å…ˆï¼Œå› ä¸ºFlaskè§„åˆ™æ˜¯åœ¨é…ç½®ä¹‹å‰æ·»åŠ çš„ï¼Œè€Œä¸æ˜¯åœ¨åŠ¨æ€è·¯å¾„ä¸­æ·»åŠ çš„ã€‚ åœ¨æœ¬ä¾‹ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä¸æ‰“ç®—åœ¨æ­¤æ¨¡æ‹Ÿä¸­åŒ…æ‹¬ä¾›åº”å•†APIï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>--base-endpoint /configuration/</code> ã€‚ </p><br><p> æµ‹è¯•çš„æœ€ç®€å•ç‰ˆæœ¬å˜åŒ–ä¸å¤§ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPClient <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PathRule <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FixedResponse @pytest.fixture <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configuration_server_mock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockFactory</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._client = HTTPClient(configuration_url=<span class="hljs-string"><span class="hljs-string">"http://127.0.0.1/_mock_configuration/"</span></span>) self._rule_ids = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, json_response)</span></span></span><span class="hljs-function">:</span></span> rule = self._client.create_rule(PathRule(path=path)) self._rule_ids.append(rule.rule_id) response = FixedResponse( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, status=<span class="hljs-number"><span class="hljs-number">200</span></span>, body=json.dumps(json_response), ) self._client.set_response(rule_id=rule.rule_id, response=response) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_delete_rules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rule_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self._rule_ids: self._client.remove_rule(rule_id=rule_id) mock = MockFactory() request.addfinalizer(mock._delete_rules) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_server_mock)</span></span></span><span class="hljs-function">:</span></span> configuration_server_mock.create_rule( path=<span class="hljs-string"><span class="hljs-string">"configuration/data_cluster"</span></span>, json_response={ <span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, } ) configuration_server_mock.create_rule( path=<span class="hljs-string"><span class="hljs-string">"configuration/reconciliation"</span></span>, json_response={ <span class="hljs-string"><span class="hljs-string">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///applications"</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }, } )</code> </pre> <br><p> å›ºå®šè£…ç½®å˜å¾—è¶Šæ¥è¶Šå›°éš¾ï¼Œä½†æ˜¯ç°åœ¨å¯ä»¥ä¸€æ¬¡åˆ é™¤ä¸€ä¸ªè§„åˆ™ï¼Œä»è€Œç®€åŒ–äº†ä½¿ç”¨å®ƒä»¬çš„å·¥ä½œã€‚ ä¸å†éœ€è¦ä½¿ç”¨<code>mitmproxy</code> ã€‚ </p><br><p> è®©æˆ‘ä»¬å›åˆ°ä¾›åº”å•†APIã€‚ æˆ‘ä»¬å°†ä¸ºæ¾æ•£çš„æœåŠ¡å™¨åˆ›å»ºä¸€ç§æ–°å‹çš„è§„åˆ™ï¼Œæ ¹æ®å‚æ•°å€¼ï¼Œå®ƒå°†ç»™å‡ºä¸åŒçš„ç­”æ¡ˆã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªè§„åˆ™ç”¨äºpageå‚æ•°ã€‚ </p><br><p> éœ€è¦ä¸ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åˆ›å»ºæ–°çš„è§„åˆ™å’Œç­”æ¡ˆã€‚ è®©æˆ‘ä»¬ä»æœåŠ¡å™¨å¼€å§‹ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.server.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ServerRule <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerParameterRule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ServerRule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parameter_name, parameter_value=None, rule_type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PARAMETER"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> super(ServerParameterRule, self).__init__(rule_type=rule_type) self._parameter_name = parameter_name self._parameter_value = parameter_value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_match_found</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self._parameter_value <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._parameter_name <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.args <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.args.get(self._parameter_name) == self._parameter_value</code> </pre> <br><p> æ¯ä¸ªè§„åˆ™éƒ½å¿…é¡»å®šä¹‰ä¸€ä¸ª<code>is_match_found</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç¡®å®šå®ƒæ˜¯å¦åº”é€‚ç”¨äºç»™å®šçš„è¯·æ±‚ã€‚ è¾“å…¥å‚æ•°æ˜¯è¯·æ±‚å¯¹è±¡ã€‚ åˆ›å»ºæ–°è§„åˆ™åï¼Œæœ‰å¿…è¦â€œæ•™å¯¼â€æœåŠ¡å™¨ä»¥ä½¿å…¶ä»å®¢æˆ·ç«¯æ¥å—ã€‚ ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨<code>RuleFactory</code> ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.server.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_rule_factory <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.server.application <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> configure_application <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_application</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base_endpoint, configuration_endpoint)</span></span></span><span class="hljs-function">:</span></span> server_rule_factory = create_rule_factory(base_endpoint) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_parse_param_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rule_type, parameters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServerParameterRule( rule_type=rule_type, parameter_name=parameters[<span class="hljs-string"><span class="hljs-string">"parameter_name"</span></span>], parameter_value=parameters[<span class="hljs-string"><span class="hljs-string">"parameter_value"</span></span>], ) server_rule_factory.register_rule( rule_type=<span class="hljs-string"><span class="hljs-string">"PARAMETER"</span></span>, parser=_parse_param_rule, serializer=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> rule_type, rule: <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configure_application( rule_factory=server_rule_factory, base_endpoint=base_endpoint, configuration_endpoint=configuration_endpoint, ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: application = _create_application(base_endpoint=<span class="hljs-string"><span class="hljs-string">"/"</span></span>, configuration_endpoint=<span class="hljs-string"><span class="hljs-string">"/_mock_configuration"</span></span>) application.run(host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, port=<span class="hljs-number"><span class="hljs-number">80</span></span>)</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é»˜è®¤æƒ…å†µä¸‹ä¸ºè§„åˆ™åˆ›å»ºä¸€ä¸ªå·¥å‚ï¼Œä»¥ä¾¿å®ƒåŒ…å«æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„è§„åˆ™ï¼Œå¹¶æ³¨å†Œä¸€ä¸ªæ–°ç±»å‹ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦è§„åˆ™ä¿¡æ¯ï¼Œå› æ­¤<code>serializer</code>å®é™…ä¸Šä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ æ­¤å·¥å‚è¿›ä¸€æ­¥è½¬ç§»åˆ°åº”ç”¨ç¨‹åºã€‚ å®ƒå¯ä»¥åƒå¸¸è§„çš„Flaskåº”ç”¨ç¨‹åºä¸€æ ·è¿è¡Œã€‚ </p><br><p> ä¸å®¢æˆ·çš„æƒ…å†µç›¸ä¼¼ï¼šæˆ‘ä»¬åˆ›å»ºè§„åˆ™å’Œå·¥å‚ã€‚ ä½†æ˜¯å¯¹äºå®¢æˆ·ç«¯ï¼Œé¦–å…ˆï¼Œæ²¡æœ‰å¿…è¦å®šä¹‰<code>is_match_found</code>æ–¹æ³•ï¼Œå…¶æ¬¡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦åºåˆ—åŒ–ç¨‹åºæ‰èƒ½å°†è§„åˆ™å‘é€åˆ°æœåŠ¡å™¨ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ClientRule <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_rule_factory <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientParameterRule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ClientRule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parameter_name, parameter_value=None, rule_type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PARAMETER"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, rule_id=None)</span></span></span><span class="hljs-function">:</span></span> super(ClientParameterRule, self).__init__(rule_type=rule_type, rule_id=rule_id) self.parameter_name = parameter_name self.parameter_value = parameter_value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_serialize_param_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rule)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">"parameter_name"</span></span>: rule.parameter_name, <span class="hljs-string"><span class="hljs-string">"parameter_value"</span></span>: rule.parameter_value, } client_rule_factory = create_rule_factory() client_rule_factory.register_rule( rule_type=<span class="hljs-string"><span class="hljs-string">"PARAMETER"</span></span>, parser=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> rule_type, parameters: ClientParameterRule(rule_type=rule_type, parameter_name=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), serializer=_serialize_param_rule, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HTTPClient(configuration_url=configuration_url, rule_factory=client_rule_factory)</code> </pre> <br><p> ä»ç„¶å¯ä»¥ä½¿ç”¨<code>_create_client</code>åˆ›å»ºå®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æµ‹è¯•ä¸­ä½¿ç”¨è§„åˆ™ã€‚ åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘æ·»åŠ äº†å¦ä¸€ä¸ªé»˜è®¤è§„åˆ™çš„ä½¿ç”¨ï¼š <code>CompositeRule</code> ã€‚ å®ƒä½¿æ‚¨å¯ä»¥å°†å¤šä¸ªè§„åˆ™ç»„åˆä¸ºä¸€ä¸ªï¼Œä»¥ä¾¿ä»…å½“æ¯ä¸ªè§„åˆ™è°ƒç”¨<code>is_match_found</code>è¿”å›Trueæ—¶å®ƒä»¬æ‰èµ·ä½œç”¨ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture def configuration_server_mock(request): class MockFactory: def __init__(self): self._client = _create_client("http://127.0.0.1/_mock_configuration/") self._rule_ids = [] def create_paged_rule(self, path, page, json_response): rule_prototype = CompositeRule( children=[ PathRule(path=path), ClientParameterRule(parameter_name="page", parameter_value=page), ] ) rule = self._client.create_rule(rule_prototype) self._rule_ids.append(rule.rule_id) response = FixedResponse( headers={"Content-Type": "application/json"}, status=200, body=json.dumps(json_response), ) self._client.set_response(rule_id=rule.rule_id, response=response) ... mock = MockFactory() request.addfinalizer(mock._delete_rules) return mock def test_something(configuration_server_mock): ... configuration_server_mock.create_paged_rule( path="application-history", page=None, json_response=["1", "2", "3"], ) configuration_server_mock.create_paged_rule( path="application-history", page="1", json_response=["1", "2", "3"], ) configuration_server_mock.create_paged_rule( path="application-history", page="2", json_response=["4", "5"], )</span></span></code> </pre> <br><h1> ç»“è®º </h1><br><p>  <code>pretenders</code>å’Œ<code>mitmproxy</code>ä¸ºåˆ›å»º<code>mitmproxy</code>æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„å·¥å…·ã€‚ ä¼˜ç‚¹ï¼š </p><br><ol><li> è®¾ç½®ç®€å•ã€‚ </li><li> èƒ½å¤Ÿä½¿ç”¨é¢„è®¾éš”ç¦»æŸ¥è¯¢é›†ã€‚ </li><li> ä¸€æ¬¡åˆ é™¤æ•´ä¸ªéš”ç¦»é›†ã€‚ </li></ol><br><p> ç¼ºç‚¹åŒ…æ‹¬ï¼š </p><br><ol><li> éœ€è¦ä¸ºè§„åˆ™åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼ã€‚ </li><li> æ— æ³•å•ç‹¬æ›´æ”¹è§„åˆ™ã€‚ </li><li> æ‰€æœ‰åˆ›å»ºçš„è·¯å¾„éƒ½å­˜åœ¨å‰ç¼€ï¼Œæˆ–è€…ä½¿ç”¨<code>mitmproxy</code>è¿›è¡Œé‡å®šå‘ã€‚ </li></ol><br><p> æ–‡æ¡£é“¾æ¥ï¼š <br>  <a href="https://pretenders.readthedocs.io/en/latest/">å‡è£…è€…</a> <br>  <a href="https://docs.mitmproxy.org/stable/">ä¸‰ç”²æ°§åŸº</a> <br>  <a href="https://github.com/KillAChicken/loose-server/wiki">æœåŠ¡å™¨æ¾åŠ¨</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN476904/">https://habr.com/ru/post/zh-CN476904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN476880/index.html">å®‰å…¨å©´å„¿åºŠï¼šCSRF</a></li>
<li><a href="../zh-CN476888/index.html">2020å¹´UXè®¾è®¡çš„å‘å±•è¶‹åŠ¿</a></li>
<li><a href="../zh-CN476890/index.html">å¯¹äºåœ¨Houdiniå·¥ä½œçš„äººã€‚ å…³äºVexçš„æœ¬æ€§å’ŒPythonå…¥é—¨è¯¾ç¨‹</a></li>
<li><a href="../zh-CN476900/index.html">arduinoä¸Šçš„è‡ªä¸»è®¾å¤‡ï¼ŒæŒ‡ç¤ºæ¸©åº¦å‡é«˜ï¼ˆé™ä½ï¼‰</a></li>
<li><a href="../zh-CN476902/index.html">å·´é‡Œæ‘©å°”ï¼ŒVoximplantçš„çƒ­é—¨è¯é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ å·²å®ç°çš„ç½‘ç»œå¥—æ¥å­—ï¼Œå…ˆç”Ÿ</a></li>
<li><a href="../zh-CN476906/index.html">SOLIDWORKS 2020æ–°å¢åŠŸèƒ½</a></li>
<li><a href="../zh-CN476908/index.html">Hadoopæ­»äº†å—ï¼Ÿ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN476910/index.html">ä¸Šå¤ï¼šDOSæ¸¸æˆçš„å£°å¡çš„è‰°éš¾é€‰æ‹©</a></li>
<li><a href="../zh-CN476912/index.html">ç¨‹åºå‘˜çš„å…¬å¸ä»£ç æƒåˆ©</a></li>
<li><a href="../zh-CN476914/index.html">ä»Githubå­˜å‚¨åº“å®‰è£…Powershellæ¨¡å—</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>