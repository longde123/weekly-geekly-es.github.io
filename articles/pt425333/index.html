<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè™ üå¨Ô∏è üò¨ Inicie voc√™ mesmo, a primavera est√° chegando (Parte 2) üë©üèæ‚Äç‚öñÔ∏è üßòüèº ü§πüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evgeny EvgenyBorisov Borisov (NAYA Technologies) e Kirill tolkkv Tolkachev (Cyan.Finance, Twitter ) continuam falando sobre o uso do Spring Boot para ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Inicie voc√™ mesmo, a primavera est√° chegando (Parte 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/425333/"><p>  Evgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">EvgenyBorisov</a> Borisov (NAYA Technologies) e Kirill <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">tolkkv</a> Tolkachev (Cyan.Finance, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Twitter</a> ) continuam falando sobre o uso do Spring Boot para resolver os problemas do imagin√°rio Braavos Iron Bank.  Na segunda parte, focaremos nos perfis e sutilezas do lan√ßamento do aplicativo. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c19/236/8c6/c192368c6d6e05d473201da0031d3ccc.png"><br><br></p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7Cq5zEm2wq0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  A primeira parte do artigo pode ser encontrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  At√© recentemente, o cliente veio e apenas exigiu o envio de um corvo.  Agora a situa√ß√£o mudou.  O inverno chegou, o muro caiu. </p><br><p> Em primeiro lugar, o princ√≠pio da emiss√£o de empr√©stimos est√° mudando.  Se antes, com uma probabilidade de 50%, davam a todos, exceto Starks, agora agora pagavam apenas √†queles que pagam d√≠vidas.  Portanto, estamos alterando as regras para emiss√£o de empr√©stimos em nossa l√≥gica de neg√≥cios.  Mas apenas para as ag√™ncias do banco, localizadas onde o inverno j√° chegou, tudo permanece como antes.  Lembro que este √© um servi√ßo que decide se concede ou n√£o um empr√©stimo.  Faremos apenas outro servi√ßo que funcionar√° apenas no inverno. </p><br><p>  Vamos √† nossa l√≥gica de neg√≥cios: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;  } }</code> </pre> <br><p>  J√° temos uma lista daqueles que pagam d√≠vidas. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">money-raven</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jpa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.hibernate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ddl-auto</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">validate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ironbank</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>:   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  : <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>: ,   : <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span></code> </pre> <br><p>  E h√° uma classe que j√° est√° associada √† propriedade - <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetProperties</span></span></span><span class="hljs-class"> </span></span>{ List&lt;String&gt; ; }</code> </pre> <br><p>  Como nos tempos anteriores, apenas injetamos aqui: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Lembre-se da inje√ß√£o de construtor (sobre anota√ß√µes m√°gicas): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Quase pronto. </p><br><p>  Agora devemos ceder apenas aos que pagam d√≠vidas: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Mas aqui temos um pequeno problema.  Agora, temos duas implementa√ß√µes: os antigos e os novos servi√ßos. </p><br><pre> <code class="java hljs">Description Parameter <span class="hljs-number"><span class="hljs-number">1</span></span> of constructor in com.ironbank.moneyraven.service.TransferMoneyProphecyBackend‚Ä¶ - nameBasedProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper‚Ä¶ - WhileListBackendProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper...</code> </pre> <br><p>  √â l√≥gico dividir esses beans em diferentes perfis.  Perfil de <code></code> e perfil de <code></code> .  Deixe nosso novo servi√ßo ser executado apenas no perfil <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  E o servi√ßo antigo √© no <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !name.contains(<span class="hljs-string"><span class="hljs-string">"Stark"</span></span>) &amp;&amp; ThreadLocalRandom.current().nextBoolean(); } }</code> </pre> <br><p>  Mas o inverno chega devagar.  Nos reinos pr√≥ximos ao muro quebrado, j√° √© inverno.  Mas em algum lugar no sul - ainda n√£o.  I.e.  Os aplicativos localizados em diferentes ramifica√ß√µes e fusos hor√°rios devem funcionar de maneira diferente.  De acordo com as condi√ß√µes de nossa tarefa, n√£o podemos apagar a antiga implementa√ß√£o onde o inverno chegou e usar a nova classe.  Queremos que os funcion√°rios do banco n√£o fa√ßam absolutamente nada: entregaremos a eles um aplicativo que funcionar√° no modo ver√£o at√© o inverno chegar.  E quando chega o inverno, eles simplesmente o reiniciam e √© isso.  Eles n√£o precisar√£o alterar o c√≥digo, apagar nenhuma classe.  Portanto, inicialmente temos dois perfis: parte da lixeira √© criada quando o ver√£o e parte da lixeira √© criada quando o inverno. </p><br><p>  Mas outro problema aparece: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fbd/7a6/882/fbd7a6882ff3180ccfc693ac3b41a852.png"><br></p><br><p>  Agora, n√£o temos um √∫nico bean, porque especificamos dois perfis e o aplicativo inicia no perfil padr√£o. </p><br><p>  Portanto, temos uma nova exig√™ncia do cliente. </p><br><h2>  Lei de Ferro 2. Nenhum perfil √© permitido </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/04a/0bb/57a/04a0bb57aa20425f959898ac3eecf8a5.png"><br></p><br><p>  N√£o queremos elevar o contexto se o perfil n√£o estiver ativado, porque o inverno j√° chegou, tudo ficou muito ruim.  H√° certas coisas que devem acontecer ou n√£o, dependendo se o <code></code> ou se o <code></code> .  Al√©m disso, observe a exce√ß√£o, cujo texto √© fornecido acima.  Ele n√£o explica nada.  Um perfil n√£o est√° definido, portanto, n√£o h√° implementa√ß√£o do <code>ProphetService</code> .  Ao mesmo tempo, ningu√©m disse que √© necess√°rio definir um perfil. </p><br><p>  Portanto, agora queremos aparafusar uma pe√ßa adicional em nosso iniciador, que, ao criar o contexto, verificar√° se algum perfil est√° definido.  Se n√£o estiver definido, n√£o avan√ßaremos e lan√ßaremos apenas uma exce√ß√£o (e n√£o uma exce√ß√£o sobre a falta de uma lixeira). </p><br><p>  Podemos fazer isso com nosso ouvinte de aplicativos?  N√£o.  E h√° tr√™s raz√µes para isso: </p><br><ul><li>  O ouvinte de responsabilidade √∫nica √© respons√°vel por fazer o corvo voar.  O Ouvinte n√£o deve verificar se um perfil foi ativado, porque a ativa√ß√£o de um perfil afeta n√£o apenas o pr√≥prio ouvinte, mas tamb√©m muito mais. </li><li>  Quando um contexto √© constru√≠do, coisas diferentes acontecem.  E n√£o queremos que eles comecem a acontecer se um perfil n√£o tiver sido definido. </li><li>  O ouvinte funciona no final quando o contexto √© resolvido.  E o fato de n√£o haver perfil, sabemos muito antes.  Por que esperar esses cinco minutos condicionais at√© o servi√ßo quase aumentar e tudo cair. </li></ul><br><p>  Al√©m disso, ainda n√£o sei quais erros aparecer√£o devido ao fato de come√ßarmos a crescer sem um perfil (suponha que eu n√£o conhe√ßa a l√≥gica de neg√≥cios).  Portanto, na aus√™ncia de um perfil, voc√™ precisa trazer o contexto em um est√°gio muito inicial.  A prop√≥sito, se voc√™ usa qualquer Spring Cloud, isso se torna ainda mais relevante para voc√™, porque o aplicativo faz muitas coisas desde o in√≠cio. </p><br><p>  Para implementar o novo requisito, existe o <code>ApplicationContextInitializer</code> .  Essa √© outra interface que nos permite estender algum ponto do Spring especificando-o em spring.factories. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/889/f21/a3b/889f21a3bee67ede3394d3c52b02e96d.png"><br></p><br><p>  Implementamos essa interface e temos um Context Initializer, que possui um <code>ConfigurableApplicationContext</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Com isso, podemos obter o ambiente - o que a SpringApplication preparou para n√≥s.  Todas as propriedades que passamos para ele chegaram l√°.  Entre outras coisas, eles tamb√©m cont√™m perfis. </p><br><p>  Se n√£o houver perfis l√°, devemos lan√ßar uma exce√ß√£o dizendo que voc√™ n√£o pode trabalhar assim. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> applicationContext.getEnvironment().getActiveProfiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> {     <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>);   } } }</code> </pre> <br><p>  Agora voc√™ precisa registrar essas coisas em spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer</code> </pre> <br><p>  Pelo exposto, voc√™ pode adivinhar que <code>ApplicationContextInitializer</code> √© um ponto de extens√£o.  <code>ApplicationContextInitializer</code> funciona quando o contexto est√° apenas come√ßando a ser criado, ainda n√£o h√° caixas. </p><br><p>  Surge a pergunta: se escrevemos <code>ApplicationContextInitializer</code> , por que n√£o deveria, como ouvinte, ser escrito em uma configura√ß√£o que se estende de qualquer maneira?  A resposta √© simples: porque deve funcionar muito mais cedo quando n√£o h√° contexto nem configura√ß√µes.  I.e.  ainda n√£o pode ser injetado.  Portanto, prescrevemos como uma pe√ßa separada. </p><br><p>  Uma tentativa de iniciar mostrou que tudo havia ca√≠do r√°pido o suficiente e relatou que est√°vamos come√ßando sem um perfil.  Agora vamos tentar especificar algum perfil, e tudo funciona - o corvo √© enviado. </p><br><p>  <code>ApplicationContextInitializer</code> - atende quando o contexto j√° foi criado, mas n√£o h√° mais nada al√©m do ambiente. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4ee/fb1/3e5/4eefb13e5b1e2f8f04c19e22f58062a8.png"><br></p><br><p>  Quem cria o ambiente?  Carlson - <code>SpringBootApplication</code> .  Ele a preenche com v√°rias meta-informa√ß√µes, que podem ser retiradas do contexto.  A maioria das coisas pode ser injetada via <code>@value</code> , algo pode ser obtido no ambiente, pois acabamos de obter perfis. </p><br><p>  Por exemplo, propriedades diferentes v√™m aqui: </p><br><ul><li>  qual Spring Boot pode construir; </li><li>  que na inicializa√ß√£o s√£o transmitidos atrav√©s da linha de comando; </li><li>  sist√™mico; </li><li>  enunciado como vari√°veis ‚Äã‚Äãde ambiente; </li><li>  prescrito nas propriedades do aplicativo; </li><li>  registrado em alguns outros arquivos de propriedades. </li></ul><br><p>  Tudo isso √© coletado e definido em um objeto de ambiente.  Ele tamb√©m cont√©m informa√ß√µes sobre quais perfis est√£o ativos.  O objeto de ambiente √© a √∫nica coisa que existe no momento em que o Spring Boot come√ßa a criar o contexto. </p><br><p>  Gostaria de adivinhar automaticamente qual ser√° o perfil se as pessoas se esquecerem de perguntar com as m√£os (fazemos tudo para que os funcion√°rios do banco, que est√£o desamparados o suficiente sem programadores, possam iniciar o aplicativo para que tudo funcione para eles, independentemente do que seja).  Para fazer isso, adicionaremos ao nosso acionador de partida algo que adivinhe o perfil - <code></code> ou n√£o - dependendo da temperatura na rua.  E outra nova interface m√°gica nos ajudar√° a tudo isso - <code>EnvironmentPostProcessor</code> , porque precisamos fazer isso antes que o <code>ApplicationContextInitializer</code> funcione.  E antes do <code>ApplicationContextInitializer</code> existe apenas o <code>EnvironmentPostProcessor</code> . </p><br><p>  Estamos novamente implementando uma nova interface.  Existe apenas um m√©todo, que da mesma maneira que <code>ConfigurableEnvironment</code> lan√ßa no <code>SpringApplication</code> , porque ainda n√£o temos o <code>ConfigurableContext</code> (ele j√° existe no <code>SpringInitializer</code> n√£o est√° aqui; existe apenas ambiente). </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Nesse ambiente, podemos definir o perfil.  Mas primeiro voc√™ precisa verificar se ningu√©m o instalou antes.  Portanto, <code>getActiveProfiles</code> precisamos verificar <code>getActiveProfiles</code> .  Se as pessoas souberem o que est√£o fazendo e estabelecerem um perfil, n√£o tentaremos adivinhar por elas.  Mas se n√£o houver perfil, tentaremos entender pelo clima. </p><br><p>  E a segunda - precisamos entender se temos inverno ou ver√£o agora.  Voltaremos a temperatura de <code>-300</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Sob essa condi√ß√£o, temos o inverno e podemos estabelecer um novo perfil.  Lembramos que o perfil √© chamado <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Agora precisamos especificar o <code>EnvironmentPostProcessor</code> em spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer org.springframework.boot.env.EnvironmentPostProcessor=com.ironbank.moneyraven.starter.ResolveProfileEnvironmentPostProcessor</code> </pre> <br><p>  Como resultado, o aplicativo inicia sem um perfil, dizemos que √© produ√ß√£o e verificamos em qual perfil ele come√ßou conosco.  Magicamente, percebemos que nosso perfil √© <code></code> .  E o aplicativo n√£o caiu, porque o <code>ApplicationContextInitializer</code> , que verifica se h√° um perfil, vem a seguir. <br>  O resultado: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Falamos sobre o <code>EnvironmentPostProcessor</code> , que √© executado antes do <code>ApplicationContextInitializer</code> .  Mas quem dirige? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fd0/20e/e9e/fd020ee9edd65a1e41e62e0ebe689658.png"><br></p><br><p>  Essa aberra√ß√£o inicia, que, aparentemente, √© o filho ileg√≠timo de <code>ApplicationListener</code> e <code>EnvironmentPostProcessor</code> , porque √© herdado de <code>ApplicationListener</code> e <code>EnvironmentPostProcessor</code> .  √â chamado <code>ConfigFileApplicationListener</code> (por que "ConfigFile" - ningu√©m sabe). </p><br><p>  Ele √© o nosso Carlson, ou seja,  O Spring Application fornece um ambiente preparado para ouvir dois eventos: <code>ApplicationPreparedEvent</code> e <code>ApplicationEnvironmentPreparedEvent</code> .  N√£o analisaremos agora quem lan√ßa esses eventos.  Existe outra camada (na minha opini√£o, j√° √© completamente sup√©rflua, pelo menos nesta fase do desenvolvimento do Spring), que lan√ßa um evento que o ambiente est√° come√ßando a ser constru√≠do (Application.yml, propriedades, vari√°veis ‚Äã‚Äãde ambiente s√£o analisadas etc.) ) <br>  Ap√≥s receber <code>ApplicationEnvironmentPreparedEvent</code> , o ouvinte entende que voc√™ precisa configurar o ambiente - encontre todo o <code>EnvironmentPostProcessor</code> e deixe-os funcionar. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cd3/8c4/3b8/cd38c43b8a10c9867cc9b3ebcb3ee1e9.png"><br></p><br><p>  Depois disso, ele diz ao <code>SpringFactoriesLoader</code> para entregar tudo o que voc√™ pediu, ou seja, todo o <code>EnvironmentPostProcessor</code> , para spring.factories.  Em seguida, coloca todo o <code>EnvironmentPostProcessor</code> em uma lista. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9b0/e39/f0f/9b0e39f0fe2514c22cfdc03af4b3f464.png"><br></p><br><p>  e entende que ele tamb√©m √© um <code>EnvironmentPostProcessor</code> (simultaneamente), portanto, ele se empurra para l√°, <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/bf0/d30/0f9bf0d30e0065e707c813101aa173d9.png"><br>  ao mesmo tempo, classifica-os, acompanha-os e chama o <code>postProcessEnvironment</code> cada m√©todo. </p><br><p>  Dessa forma, todos os <code>postProcessEnvironment</code> s√£o iniciados antes do <code>SpringApplicationInitializer</code> .  Nesse caso, um <code>EnvironmentPostProcessor</code> incompreens√≠vel chamado <code>ConfigFileApplicationListener</code> tamb√©m √© iniciado. </p><br><p>  Quando o ambiente √© configurado, tudo volta para Carlson novamente. </p><br><p>  Se o ambiente estiver pronto, voc√™ poder√° criar um contexto.  E Carlson come√ßa a criar contexto com o <code>ApplicationInitializer</code> .  Aqui temos a nossa pr√≥pria pe√ßa, que verifica se, no contexto, existe um ambiente em que existem perfis ativos.  Caso contr√°rio, estamos caindo, porque, caso contr√°rio, ainda teremos problemas mais tarde.  Ent√£o os iniciantes trabalham, com todas as configura√ß√µes usuais j√°. </p><br><p>  A imagem acima reflete que o Spring tamb√©m n√£o est√° indo bem.  Esses alien√≠genas se re√∫nem periodicamente l√°, a responsabilidade √∫nica n√£o √© respeitada e voc√™ precisa escalar com cuidado. </p><br><p>  Agora, queremos falar um pouco sobre o outro lado dessa criatura estranha, que √© ouvinte de um lado e <code>EnvironmentPostProcessor</code> do outro. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffc/200/bf0/ffc200bf085fd822e7fd1fdf6d9e8fec.png"><br></p><br><p>  Como o <code>EnvironmentPostProcessor</code> ele pode carregar application.yml, propriedades do aplicativo, todos os tipos de vari√°veis ‚Äã‚Äãde ambiente, argumentos de comando etc.  E como ouvinte, ele pode ouvir dois eventos: </p><br><ul><li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> </ul><br><p>  A quest√£o √©: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/452/851/6fc/4528516fcdf7fa9038e8ae80d2a8ac9a.png"><br></p><br><p>  Todos esses eventos ocorreram na antiga primavera.  E aqueles sobre os quais falamos acima s√£o eventos do Spring Boot (eventos especiais que ele adicionou para seu ciclo de vida).  E h√° um monte deles.  Estes s√£o os principais: </p><br><ul><li> <code>ApplicationStartingEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> <li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ContextRefreshedEvent</code> </li> <li> <code>EmbeddedServletContainerInitializedEvent</code> </li> <li> <code>ApplicationReadyEvent</code> </li> <li> <code>ApplicationFailedEvent</code> </li> </ul><br><p>  Esta lista est√° longe de tudo.  Mas √© importante que alguns deles estejam relacionados ao Spring Boot e fa√ßam parte do Spring (bom e velho <code>ContextRefreshedEvent</code> , etc.). </p><br><p>  A ressalva √© que nem todos esses eventos podem ser recebidos no aplicativo (meros mortais - av√≥s diferentes - n√£o podem apenas ouvir os eventos complexos que o Spring Boot lan√ßa).  Mas se voc√™ conhece os mecanismos secretos do spring.factories e define o Application Listener no n√≠vel do spring.factories, esses eventos, desde o est√°gio inicial da inicializa√ß√£o do aplicativo, chegam at√© voc√™. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/54f/14e/bca/54f14ebca5de6e029b3b47dc50f8c7e2.png"><br></p><br><p>  Como resultado, voc√™ pode influenciar o in√≠cio do seu aplicativo em um est√°gio bastante inicial.  A piada, no entanto, √© que parte desse trabalho √© realizada em outras entidades - como <code>EnvironmentPostProcessor</code> e <code>ApplicationContextInitializer</code> . </p><br><p>  Voc√™ poderia fazer tudo com os ouvintes, mas seria inconveniente e feio.  Se voc√™ deseja ouvir todos os eventos que o Spring lan√ßa, e n√£o apenas <code>ContextRefreshedEvent</code> e <code>ContextStartedEvent</code> , n√£o √© necess√°rio definir o ouvinte, como um bean, da maneira usual (caso contr√°rio, ser√° criado tarde demais).  Ele tamb√©m deve ser registrado atrav√©s do spring.factories, e ser√° criado muito antes. </p><br><p>  A prop√≥sito, quando analisamos esta lista, n√£o estava claro para n√≥s quando o <code>ContextStartedEvent</code> e o <code>ContextStoppedEvent</code> dispararam? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/796/e78/7ca/796e787ca88d7271898b4072c03d3691.png"><br></p><br><p>  Acontece que esses eventos nunca funcionam.  Ficamos intrigados por um longo tempo sobre quais eventos deveriam ser capturados para entender que o aplicativo realmente foi iniciado.  E aconteceu que os eventos sobre os quais est√°vamos falando agora aparecem quando voc√™ puxa com for√ßa os m√©todos do contexto: </p><br><ul><li> <code>ctx.start();</code>  -&gt; <code>ContextStartedEvent</code> </li><li> <code>ctx.stop();</code>  -&gt; <code>ContextStoppedEvent</code> </li></ul><br><p>  I.e.  <code>SpringApplication.run</code> vir√£o somente se executarmos <code>SpringApplication.run</code> , obtermos o contexto, extrair <code>ctx.start();</code>  ou <code>ctx.stop();</code>  .  N√£o est√° muito claro por que isso √© necess√°rio.  Mas, novamente, eles deram a voc√™ um ponto de extens√£o. </p><br><p>  Spring tem algo a ver com isso?  Nesse caso, em algum lugar deve haver uma exce√ß√£o: </p><br><ul><li> <code>ctx.stop();</code>  (1) </li><li> <code>ctx.start();</code>  2) </li><li> <code>ctx.close();</code>  (3) </li><li> <code>ctx.start();</code>  4) </li></ul><br><p>  De fato, estar√° na √∫ltima linha, porque depois de <code>ctx.close();</code>  nada pode ser feito com o contexto.  Mas chame <code>ctx.stop();</code>  antes de <code>ctx.start();</code>  - voc√™ pode (o Spring simplesmente ignora esses eventos - eles s√£o apenas para voc√™). </p><br><p>  Escreva para seus ouvintes, ou√ßa voc√™ mesmo, <code>ctx.stop();</code> suas leis, o que fazer em <code>ctx.stop();</code>  e o que fazer em <code>ctx.start();</code>  . </p><br><p>  No total, o diagrama da intera√ß√£o e do ciclo de vida do aplicativo √© mais ou menos assim: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f05/25b/6b5/f0525b6b5742a9a7969a17465b174a4f.png"><br></p><br><p>  As cores aqui mostram diferentes per√≠odos da vida. </p><br><ul><li>  Azul √© Spring Boot, o aplicativo j√° foi iniciado.  Isso significa que as solicita√ß√µes de servi√ßo do Tomcat enviadas pelos clientes s√£o processadas, todo o contexto √© definitivamente gerado, todos os beans est√£o funcionando, os bancos de dados est√£o conectados etc. </li><li>  Verde - um evento <code>ContextRefreshedEvent</code> chegou e o contexto foi criado.  A partir deste momento, por exemplo, os ouvintes de aplicativos come√ßam a funcionar, que voc√™ implementa definindo a anota√ß√£o ApplicationListener ou atrav√©s da interface de mesmo nome com um gen√©rico que escuta determinados eventos.  Se voc√™ deseja receber mais eventos, precisa escrever o mesmo ApplicationListener em spring.factories (o Spring usual funciona aqui).  Uma barra indica onde o relat√≥rio do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Spring Ripper</a> come√ßa. </li><li>  Numa fase anterior, o SpringApplication funciona, o que prepara o contexto para n√≥s.  Esse √© o trabalho de preparar o aplicativo que fizemos quando √©ramos desenvolvedores regulares do Spring.  Por exemplo, WebXML configurado. </li><li>  Mas existem est√°gios ainda anteriores.  Mostra quem, onde e para quem trabalha. </li><li>  Ainda existe um est√°gio cinza no qual √© imposs√≠vel cunhar de alguma maneira.  Este √© o est√°gio em que o SpringApplication fica fora da caixa (apenas entre no c√≥digo). </li></ul><br><p>  Se voc√™ notou, durante o relat√≥rio de duas partes, fomos da direita para a esquerda: come√ßamos do final, estragamos a configura√ß√£o que voava do iniciador e adicionamos o seguinte, etc.  Agora vamos falar rapidamente de toda a cadeia na dire√ß√£o oposta. <br>  Voc√™ escreve em seu <code>SpringApplication.run</code> principal.  Ele encontra ouvintes diferentes, lan√ßa um evento que ele come√ßou a construir.  Depois disso, os ouvintes encontram o <code>EnvironmentPostProcessor</code> , deixe-os configurar o ambiente.  Depois que o ambiente √© configurado, come√ßamos a construir o contexto (Carlson entra).  Carlson cria o contexto e permite que todos os Inicializadores de Aplicativos fa√ßam algo com esse contexto.  Temos um ponto de extens√£o.  Depois disso, o contexto j√° est√° configurado e, em seguida, acontece o mesmo que em um aplicativo Spring regular, quando o contexto √© criado - <code>BeanFactoryPostProcessor</code> , <code>BeanPostProcessor</code> , os beans s√£o configurados.  √â isso que a primavera comum faz. </p><br><h2>  Como executar </h2><br><p>  Terminamos de discutir o processo de cria√ß√£o de um aplicativo. </p><br><p>  Mas t√≠nhamos mais uma coisa que os desenvolvedores n√£o gostam.  Eles n√£o gostam de pensar como, no final, sua aplica√ß√£o ser√° iniciada.  O administrador o executar√° no Tomcat, JBoss ou no WebLogic?  Apenas tem que funcionar.  Se n√£o funcionar, na pior das hip√≥teses, o desenvolvedor precisar√° configurar algo novamente </p><br><p>  Ent√£o, quais s√£o os nossos m√©todos de lan√ßamento? </p><br><ul><li>  guerra tomcat; </li><li>  ideia; </li><li>  <code>java -jar/war</code> . </li></ul><br><p>  O Tomcat n√£o √© uma tend√™ncia em massa, n√£o falaremos sobre isso em detalhes. </p><br><p>  A ideia tamb√©m n√£o √©, em princ√≠pio, muito interessante.  √â apenas um pouco mais complicado do que vou dizer abaixo.  Mas em Idea, em princ√≠pio, n√£o deve haver problemas.  Ela v√™ que tipo de depend√™ncias o acionador de partida trar√°. <br>  Se fizermos <code>java -jar</code> , o principal problema √© criar um caminho de classe antes de iniciar o aplicativo. </p><br><p>  O que as pessoas fizeram em 2001?  Eles escreveram em <code>java -jar</code> qual jar deve ser executado, ent√£o um espa√ßo, <code>classpath=...</code> e scripts foram indicados l√°.  No nosso caso, existem 150 MB de v√°rias depend√™ncias que os iniciantes adicionaram.  E tudo isso teria que ser feito manualmente.  Naturalmente, ningu√©m faz isso.  N√≥s apenas escrevemos: <code>java -jar</code> , qual jar deve ser executado e √© isso.  De alguma forma, o caminho de classe ainda est√° sendo constru√≠do.  Vamos falar sobre isso agora. </p><br><p>  Vamos come√ßar com a prepara√ß√£o do arquivo jar para que ele possa ser iniciado sem o Tomcat.  Antes de criar o <code>java -jar</code> , voc√™ precisa construir um jar.  Esse jarro obviamente deve ser incomum, algum tipo de anal√≥gico de guerra, onde tudo estar√° dentro, incluindo o Tomcat incorporado. </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>  Quando baixamos o projeto, algu√©m j√° registrou um plug-in em nosso POM.  Aqui, a prop√≥sito, voc√™ pode lan√ßar configura√ß√µes, mas mais sobre isso mais tarde.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, al√©m do jar comum que cria o Maven ou Gradle do seu aplicativo, tamb√©m √© criado um jar incomum. </font><font style="vertical-align: inherit;">Por um lado, parece bom:</font></font></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/877/aad/b8e/877aadb8e0edbfbe6df10853b8c3f0c9.png"><br></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mas se voc√™ olhar de lado: </font></font></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5ea/499/a35/5ea499a35d217fca525c27d7c8d2cfd3.png"><br></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Isso √© basicamente um an√°logo da guerra. </font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vamos ver do que se trata. </font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, existem pe√ßas padr√£o, como no jarro comum. </font><font style="vertical-align: inherit;">Quando escrevemos </font></font><code>java -jar</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, todas as classes que est√£o na raiz, por exemplo, s√£o ativadas </font></font><code>org.springframework.boot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mas essas n√£o s√£o as nossas aulas. </font><font style="vertical-align: inherit;">Dificilmente escrevemos o pacote org.springframework.boot. </font><font style="vertical-align: inherit;">Portanto, antes de tudo, para n√≥s √© familiar</font></font><code>META-INF</code> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5a0/6c7/31e/5a06c731e6b958d02f683de73b2c5a9c.png"><br></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O Spring Boot tamb√©m MANIFEST (atrav√©s do mesmo plug-in Maven ou Gradle), personaliza-o e prescreve a classe principal, que inicia no jar. </font></font></p><br><p>  ,  jar-    :     -,    main-.     <code>java -jar</code>   -jar,   ,   main-class-. </p><br><p>  ,   ,        MANIFEST,  main-class   ,    main (    Idea).     ,     .     class path?    <code>java -jar</code>  ,  main,   , ‚Äî    main,     .    MANIFEST      JarLauncher. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/496/8b5/f76/4968b5f76b6ece2fc7431dbc6195d14e.png"><br></p><br><p>  I.e.     ,     ,    JarLauncher.    ,    main,     class path. <br>    ,    main?   property ‚Äî <code>Start-class</code> . </p><br><p>  I.e.       .     class path  jar. ,    ‚Äî <code>org.springframework.boot</code> ‚Äî   class path.      <code>org.springframework.boot.loader.JarLauncher</code>  main-class.   , main-class  .   class path,    <code>BOOT-INF</code> (   lib     class  ,      ). </p><br><p>    RavenApplication, properties   class  <code>BOOT-INF</code> ,   ,  Tomcat  ,   <code>BOOT-INF/lib/</code> .  JarLauncher  classpath,     ‚Äî  ,    <code>start-class</code> .     Spring, <code>ContextSpringApplication</code> ‚Äî   flow,     . </p><br><p>   ,   start-class-?    ,     .      ,  . </p><br><p> ,     .     property,   <code>mainClass</code> ,   MANIFEST   <code>Start-Class</code> ,  <code>mainClass</code> ‚Äî   JarLauncher. </p><br><p>      ,   mainClass,   ?     . Spring boot plugin   ‚Äì  mainClass: </p><br><ul><li>     ‚Äì    .     ‚Äî     main class; </li><li>    ‚Äì ,   mainClass   <code>@SpringBootApplication</code>   , , ,  ; </li><li>    ‚Äî  exception   ,    main class,  ,     jar-  .  I.e.    ,  ,   . ,   ,     main class. </li><li>  @SpringBootApplication  ‚Äî   . </li></ul><br><p> JarLauncher   .   Tomcat     WarLauncher,      war-  ,  jar-. </p><br><p>    ,     <code>java -jar</code> .   ?  Voc√™ pode.   . </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;       &lt;configuration&gt;          &lt;executable&gt;<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>&lt;/executable&gt;       &lt;/configuration&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>     <code>&lt;configuration&gt;</code>    <code>&lt;executable&gt;true&lt;/executable&gt;</code>    Gradle  ,  : </p><br><pre> <code class="java hljs">springBoot { executable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }</code> </pre> <br><p>      jar   executable jar.       . </p><br><p>  ,    .   Windows ,     exe-,   .       Spring Boot, ..   jar,    .      ,    . <br>   ? </p><br><p>      (jar ‚Äî  zip-,     ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/355/f0a/08d/355f0a08d8a971a533cd824c84939827.png"><br></p><br><p> Spring Boot  - . </p><br><p>  -,   jar-.   ,      ,     ‚Äî <code>#!/bin/bash</code> .     . </p><br><p>       .   <code>exit 0</code>   -  ‚Äî      zip-. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/365/674/922/365674922651752dc5a5896f48764d8e.png"><br></p><br><p>   ,   zip-    ‚Äî <code>0xf4ra</code> .     ,  ,    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/60e/915/263/60e915263d6af6d19a5f0a7df977ee82.png"><br></p><br><p>       (,   ..). </p><br><p>  jar    : </p><br><ul><li>     ‚Äî     ; </li><li>  ,    "   bash" ( <code>#!/bin/bash</code> ); </li><li> bash   ; </li><li>      <code>exit 0</code> ; </li><li>    <code>java -jar</code>   ‚Äî     jar-,   ; </li><li>  <code>java -jar</code>  zip-   jar-,  ,    ,       . </li></ul><br><h2>  Conclus√µes </h2><br><p>         ,  Spring Boot ‚Äî   ,     ,     . </p><br><p> -,  .  ,    Spring,   Spring ‚Äî      Spring Boot.    ,         ,        ‚Äî , ,   ,     . ,  ,     Spring, Spring Boot  . </p><br><p> -,    <code>@SpringBootApplication</code> ,     best practice,     Spring-. </p><br><p>   ‚Äî   ,     ,   .    property  environment variable,    var arg   ,       ,    JSON.            <code>@value</code>       ,    .  configuration properties ,     ,     ,       .  ,  Spring     .   ,     ,      . </p><br><p>  .      ,    .          Spring,  Spring Boot    .    - ,   ,  ,           . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dc9/832/498/dc983249828e3fd26a257f871e46409e.png"><br></p><br><blockquote>  Minuto de publicidade. 19-20    Joker 2018,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´          [Joker Edition]¬ª</a> ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">¬´Micronaut vs Spring Boot,     ?¬ª</a>  .  ,  Joker       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt425333/">https://habr.com/ru/post/pt425333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt425323/index.html">"Toca do coelho". Designer de UX na equipe de produtos</a></li>
<li><a href="../pt425325/index.html">Int√©rpretes de Bytecode DIY</a></li>
<li><a href="../pt425327/index.html">Programa√ß√£o funcional: me√ßa sete vezes, corte uma vez</a></li>
<li><a href="../pt425329/index.html">Alguns conselhos aos millennials dos "oldies". Como ter sucesso em nosso mundo digital</a></li>
<li><a href="../pt425331/index.html">Alice ajudar√° os desenvolvedores a encontrar objetos nas solicita√ß√µes do usu√°rio. NER em caixas de di√°logo</a></li>
<li><a href="../pt425335/index.html">Armada invicta Garmin</a></li>
<li><a href="../pt425337/index.html">Como escalar o Scrum - algumas palavras sobre a estrutura de desenvolvimento √°gil do Nexus</a></li>
<li><a href="../pt425339/index.html">Arquitetura de informa√ß√µes da Internet - parte 2</a></li>
<li><a href="../pt425341/index.html">Vis√£o geral da ‚ÄúTop 3D Expo. Educa√ß√£o digital 2018 ¬ª</a></li>
<li><a href="../pt425343/index.html">25 ferramentas √∫teis do Kubernetes: implanta√ß√£o e gerenciamento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>