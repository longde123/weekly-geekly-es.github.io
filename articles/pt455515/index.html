<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôéÔ∏è üö∫ üßíüèø Como reverter e invadir o disco r√≠gido externo auto-criptografado do Aigo. Parte 1: Dissecando em partes üñáÔ∏è üç™ üë∂üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inverter e invadir unidades externas de auto-criptografia √© o meu antigo hobby. No passado, eu costumava praticar com modelos como o Zalman VE-400, Za...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como reverter e invadir o disco r√≠gido externo auto-criptografado do Aigo. Parte 1: Dissecando em partes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455515/"><p>  Inverter e invadir unidades externas de auto-criptografia √© o meu antigo hobby.  No passado, eu costumava praticar com modelos como o Zalman VE-400, Zalman ZM-SHE500, Zalman ZM-VE500.  Mais recentemente, um colega me trouxe outra exposi√ß√£o: Patriot (Aigo) SK8671, constru√≠da de acordo com um design t√≠pico - um indicador LCD e um teclado para inserir um c√≥digo PIN.  Aqui est√° o que veio dele ... </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1. Introdu√ß√£o</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2. Arquitetura de Hardware</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Placa principal</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Placa de LCD</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Placa do teclado</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2.4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">N√≥s olhamos para os fios</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3. A sequ√™ncia de etapas do ataque</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">- 3.1</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Remova o despejo de dados da unidade flash SPI</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">- 3.2</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cheirar a comunica√ß√£o</a> </p><br><p><img src="https://habrastorage.org/webt/wx/nm/gk/wxnmgkeurrmiurx87rujoynxrsq.jpeg"></p><a name="habracut"></a><br><a name="a1"></a><br><h1 id="1-vvedenie">  1. Introdu√ß√£o </h1><br><p><img src="https://habrastorage.org/webt/rb/oq/4n/rboq4nvybyfanowvledmkbcfyww.jpeg"><br>  <em>Habita√ß√£o</em> </p><br><p><img src="https://habrastorage.org/webt/n8/cu/bd/n8cubdbf1sr0ejoafvh9qktfdiy.jpeg"><br>  <em>Embalagem</em> </p><br><p>  O acesso aos dados armazenados no disco, supostamente criptografado, √© realizado ap√≥s a inser√ß√£o do c√≥digo PIN.  Algumas notas introdut√≥rias sobre este dispositivo: </p><br><ul><li>  Para alterar o c√≥digo PIN, pressione F1 antes de desbloquear; </li><li>  O c√≥digo PIN deve ter entre 6 e 9 d√≠gitos; </li><li>  Ap√≥s 15 tentativas incorretas, o disco √© limpo. </li></ul><br><a name="a2"></a><br><h1 id="2-apparatnaya-arhitektura">  2. Arquitetura de Hardware </h1><br><p>  Primeiro, preparamos o dispositivo em partes para entender em quais componentes ele consiste.  A tarefa mais tediosa √© abrir o caso: um monte de engrenagens microsc√≥picas e pl√°stico.  Depois de abrir o gabinete, vemos o seguinte (preste aten√ß√£o ao conector de cinco pinos soldado por mim): </p><br><p><img src="https://habrastorage.org/webt/wf/yy/6m/wfyy6mnjauhszmkgkukchy3q5yk.jpeg"></p><br><a name="a21"></a><br><h2 id="21-osnovnaya-plata">  2.1  Placa principal </h2><br><p>  A placa principal √© bem simples: </p><br><p><img src="https://habrastorage.org/webt/69/n6/da/69n6dayylddfb1cbhpytgbl4y5y.jpeg"></p><br><p>  Suas partes mais not√°veis ‚Äã‚Äã(veja de cima para baixo): </p><br><ul><li>  Conector LCD (CN1); </li><li>  tweeter (SP1); </li><li>  Pm25LD010 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">especifica√ß√£o</a> ) unidade flash SPI (U2); </li><li>  Controlador Jmicron JMS539 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">especifica√ß√£o</a> ) para USB-SATA (U1); </li><li>  Conector USB 3 (J1). </li></ul><br><p>  A unidade flash SPI armazena o firmware do JMS539 e algumas configura√ß√µes. </p><br><a name="a22"></a><br><h2 id="22-plata-zhk-indikatora">  2.2  Placa de LCD </h2><br><p>  N√£o h√° nada not√°vel na placa de LCD. </p><br><p><img src="https://habrastorage.org/webt/jd/49/fl/jd49flekfpte0q31hl6nv3pfcbo.jpeg"><br><img src="https://habrastorage.org/webt/qs/j_/vc/qsj_vchcmyj0eigmolvy-10mrh0.jpeg"></p><br><p>  Apenas: </p><br><ul><li>  Indicador LCD de origem desconhecida (provavelmente com uma fonte chinesa definida);  com controle seq√ºencial; </li><li>  conector de fita para placa de teclado. </li></ul><br><a name="a23"></a><br><h2 id="23-klaviaturnaya-plata">  2.3  Placa do teclado </h2><br><p>  Quando voc√™ olha para a placa do teclado, as coisas assumem uma reviravolta mais interessante. </p><br><p><img src="https://habrastorage.org/webt/qh/gr/df/qhgrdfppixqecphruejzkdtd0_g.jpeg"></p><br><p>  Aqui, na parte traseira, vemos o conector da fita, bem como o Cypress CY8C21434 - o microcontrolador PSoC 1 (daqui em diante denominado simplesmente PSoC) </p><br><p><img src="https://habrastorage.org/webt/bm/bs/ly/bmbslyrwh20yn47te073qtleiw0.jpeg"></p><br><p>  O CY8C21434 usa o conjunto de instru√ß√µes M8C (consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> ).  Na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">p√°gina do produto, √©</a> indicado que ele suporta a tecnologia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CapSense</a> (uma solu√ß√£o da Cypress, para teclados capacitivos).  Aqui eu posso ver o conector de cinco pinos soldado por mim - esta √© uma abordagem padr√£o para conectar um programador externo atrav√©s da interface ISSP. </p><br><a name="a24"></a><br><h2 id="24-smotrim-na-provoda">  2.4  N√≥s olhamos para os fios </h2><br><p>  Vamos descobrir o que est√° relacionado a isso.  Para fazer isso, basta tocar os fios com um mult√≠metro: </p><br><p><img src="https://habrastorage.org/webt/wa/ox/uz/waoxuzmwczjnhtih625bqj6myga.png"></p><br><p>  Explica√ß√µes para este diagrama desenhado por joelho: </p><br><ul><li>  PSoC √© descrito na especifica√ß√£o t√©cnica; </li><li>  o pr√≥ximo conector, o da direita, √© uma interface ISSP que, por vontade do destino, corresponde ao que est√° escrito sobre ele na Internet; </li><li>  o conector mais √† direita √© um terminal para um conector de fita com uma placa de teclado; </li><li>  ret√¢ngulo preto √© um desenho do conector CN1, projetado para conectar a placa principal √† placa de LCD.  P11, P13 e P4 - conectado √†s pernas 11, 13 e 4 do PSoC na placa de LCD. </li></ul><br><a name="a3"></a><br><h1 id="3-posledovatelnost-shagov-ataki">  3. A sequ√™ncia de etapas do ataque </h1><br><p>  Agora que sabemos em que componentes esta unidade consiste, precisamos: 1) garantir que a funcionalidade b√°sica de criptografia esteja realmente presente;  2) descobrir como as chaves de criptografia s√£o geradas / armazenadas;  3) encontre onde exatamente o c√≥digo PIN est√° marcado. </p><br><p>  Para fazer isso, eu executei as seguintes etapas: </p><br><ul><li>  removeu um despejo de dados de uma unidade flash SPI; </li><li>  Tentei remover o despejo de dados da unidade flash PSoC; </li><li>  certificou-se de que a troca de dados entre o Cypress PSoC e o JMS539 realmente contenha as teclas pressionadas; </li><li>  certificou-se de que, ao alterar a senha, nada seja substitu√≠do na unidade flash SPI; </li><li>  estava com pregui√ßa de reverter o firmware 8051 do JMS539. </li></ul><br><a name="a31"></a><br><h2 id="31-snimaem-damp-dannyh-spi-fleshki">  3.1  Remova o despejo de dados da unidade flash SPI </h2><br><p>  Este procedimento √© muito simples: </p><br><ul><li>  conecte as pontas de prova √†s pernas da unidade flash: CLK, MOSI, MISO e (opcionalmente) EN; </li><li>  ‚ÄúFarejar‚Äù as comunica√ß√µes usando um farejador usando um analisador l√≥gico (usei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Saleae Logic Pro 16</a> ); </li><li>  decodificar o protocolo SPI e exportar os resultados para CSV; </li><li>  Use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">decode_spi.rb</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">analisar</a> os resultados e obter um despejo. </li></ul><br><p>  Observe que essa abordagem no caso do controlador JMS539 funciona especialmente bem, pois esse controlador carrega todo o firmware da unidade flash USB durante a fase de inicializa√ß√£o. </p><br><pre><code class="plaintext hljs">$ decode_spi.rb boot_spi1.csv dump 0.039776 : WRITE DISABLE 0.039777 : JEDEC READ ID 0.039784 : ID 0x7f 0x9d 0x21 --------------------- 0.039788 : READ @ 0x0 0x12,0x42,0x00,0xd3,0x22,0x00, [...] $ ls --size --block-size=1 dump 49152 dump $ sha1sum dump 3d9db0dde7b4aadd2b7705a46b5d04e1a1f3b125 dump</code> </pre> <br><p>  Depois de remover o dump da unidade flash SPI, cheguei √† conclus√£o de que sua √∫nica tarefa √© armazenar o firmware da unidade de controle JMicron, que est√° embutida no microcontrolador 8051.  Infelizmente, despejar a unidade flash SPI acabou sendo in√∫til: </p><br><ul><li>  ao alterar o c√≥digo PIN, o despejo da unidade flash permanece o mesmo; </li><li>  ap√≥s o est√°gio de inicializa√ß√£o, o dispositivo n√£o acessa a unidade flash SPI. </li></ul><br><a name="a32"></a><br><h2 id="32-obnyuhivaem-kommunikacii">  3.2  Cheirar a comunica√ß√£o </h2><br><p>  Essa √© uma maneira de descobrir qual chip √© respons√°vel por verificar as comunica√ß√µes quanto ao tempo / conte√∫do de interesse.  Como j√° sabemos, o controlador USB-SATA est√° conectado ao LCD Cypress PSoC atrav√©s do conector CN1 e duas fitas.  Portanto, conectamos as sondas √†s tr√™s pernas correspondentes: </p><br><ul><li>  P4, entrada / sa√≠da geral; </li><li>  P11, I2C SCL; </li><li>  P13, I2C SDA. </li></ul><br><p><img src="https://habrastorage.org/webt/dx/pf/gt/dxpfgtrawhj8ddziq_evoclmrs0.jpeg"></p><br><p>  Em seguida, iniciamos o analisador l√≥gico Saleae e inserimos no teclado: "123456 ~".  Como resultado, vemos o diagrama a seguir. </p><br><p><img src="https://habrastorage.org/webt/ai/d9/dg/aid9dgvtwdzzsgkzgbnwgvlxnya.png"></p><br><p>  Nele podemos ver tr√™s canais de troca de dados: </p><br><ul><li>  o canal P4 possui v√°rias rajadas curtas; </li><li>  em P11 e P13 - troca de dados quase cont√≠nua. </li></ul><br><p>  Aumentando a primeira rajada no canal P4 (o ret√¢ngulo azul da figura anterior), vemos o seguinte: </p><br><p><img src="https://habrastorage.org/webt/_v/iu/yi/_viuyiqhajm685cu9yc2rrwxoem.png"></p><br><p>  Aqui voc√™ pode ver que no P4 h√° quase 70ms de um sinal uniforme, que, como me pareceu a princ√≠pio, desempenha o papel de um sinal de rel√≥gio.  No entanto, tendo passado algum tempo tentando verificar meu palpite, descobri que este n√£o √© um sinal de rel√≥gio, mas um fluxo de √°udio que √© transmitido ao squeaker quando voc√™ pressiona as teclas.  Portanto, esta se√ß√£o de sinal em si n√£o cont√©m informa√ß√µes √∫teis para n√≥s.  No entanto, pode ser usado como um indicador - para saber o momento em que o PSoC registra um pressionamento de tecla. </p><br><p>  No entanto, o √∫ltimo fluxo de √°udio do canal P4 √© um pouco diferente dos outros: este √© o som do ‚Äúc√≥digo errado‚Äù! </p><br><p>  Voltando ao diagrama de teclas, ao aumentar o diagrama do √∫ltimo fluxo de √°udio (veja novamente o ret√¢ngulo azul), obtemos: </p><br><p><img src="https://habrastorage.org/webt/vs/e7/tl/vse7tleuvfbpoybhymvb5bsm-rw.png"></p><br><p>  Aqui vemos sinais mon√≥tonos em P11.  Ent√£o parece que este √© o rel√≥gio.  E P13 s√£o dados.  Observe como o padr√£o muda ap√≥s o final do sinal sonoro.  Seria interessante ver o que est√° acontecendo aqui. </p><br><p>  Os protocolos que funcionam com dois fios geralmente s√£o SPI ou I2C, e a especifica√ß√£o t√©cnica Cypress diz que esses contatos correspondem ao I2C, o que, como vemos, √© verdadeiro para o nosso caso: </p><br><p><img src="https://habrastorage.org/webt/bc/pj/hy/bcpjhy-jy0c-tn6t5kuwkdgpjbi.png"></p><br><p>  O chipset USB-SATA pesquisa constantemente o PSoC - para ler o estado da chave, cujo padr√£o √© "0".  Ent√£o, quando voc√™ pressiona a tecla "1", ela muda para "1".  A transmiss√£o final, imediatamente ap√≥s pressionar ‚Äú~‚Äù, ser√° diferente se o c√≥digo PIN incorreto for inserido.  No entanto, no momento eu n√£o verifiquei o que realmente foi transmitido l√°.  Mas suspeito que isso dificilmente √© uma chave de criptografia.  De qualquer forma, consulte a pr√≥xima se√ß√£o para entender como eu removi o despejo do firmware interno do PSoC. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt455515/">https://habr.com/ru/post/pt455515/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt455505/index.html">Reagir a acelera√ß√£o do aplicativo quatro vezes</a></li>
<li><a href="../pt455507/index.html">Vis√£o geral do pacote Python dat√°vel</a></li>
<li><a href="../pt455509/index.html">A hist√≥ria de por que eu ainda uso o jQuery</a></li>
<li><a href="../pt455511/index.html">O sono √© o principal recurso para o c√©rebro de um programador</a></li>
<li><a href="../pt455513/index.html">A explos√£o e a conspira√ß√£o global: a hist√≥ria da cria√ß√£o de baterias de √≠ons de l√≠tio</a></li>
<li><a href="../pt455517/index.html">Formado no curso de Netologia ‚ÄúData Science‚Äù sobre seu trabalho no setor banc√°rio</a></li>
<li><a href="../pt455519/index.html">Como implementamos a integra√ß√£o de novos desenvolvedores</a></li>
<li><a href="../pt455523/index.html">Implementa√ß√£o da interface do usu√°rio do OpenStack LBaaS</a></li>
<li><a href="../pt455525/index.html">Zimbra e Mail Bomb Defense</a></li>
<li><a href="../pt455527/index.html">O que est√° escrito nisso? Nos bastidores dos objetos JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>