<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öóÔ∏è üïô üç£ Configurando um servidor para implantar um aplicativo Rails usando o Ansible ‚úçüèº üòΩ üòã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° n√£o muito tempo, eu precisava escrever v√°rios manuais ans√≠veis para preparar o servidor para implantar o aplicativo rails. E, surpreendentemente, n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configurando um servidor para implantar um aplicativo Rails usando o Ansible</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460769/"><p>  H√° n√£o muito tempo, eu precisava escrever v√°rios manuais ans√≠veis para preparar o servidor para implantar o aplicativo rails.  E, surpreendentemente, n√£o encontrei um simples manual passo a passo.  N√£o queria copiar o manual de outra pessoa sem entender o que estava acontecendo e, como resultado, tive que ler a documenta√ß√£o, coletando tudo sozinho.  Talvez algu√©m que eu possa ajudar a acelerar esse processo com este artigo. </p><br><p>  A primeira coisa a entender √© que o ansible fornece uma interface conveniente para executar uma lista predefinida de a√ß√µes no (s) servidor (es) remoto (s) via SSH.  N√£o h√° m√°gica aqui, voc√™ n√£o pode instalar o plug-in e sair da caixa de inatividade zero com a implanta√ß√£o do seu aplicativo com janela de encaixe, monitoramento e outras vantagens.  Para escrever um manual, voc√™ deve saber exatamente o que deseja fazer e como faz√™-lo.  Portanto, n√£o gosto de playbooks prontos do github, nem de artigos como: "Copie e execute, ele funcionar√°". </p><a name="habracut"></a><br><h2 id="chto-nam-nuzhno">  Do que precisamos? </h2><br><p>  Como eu disse, para escrever um manual, voc√™ precisa saber o que deseja fazer e como faz√™-lo.  Vamos decidir o que precisamos.  Para uma aplica√ß√£o Rails, precisaremos de v√°rios pacotes de sistema: nginx, postgresql (redis, etc).  Al√©m disso, precisamos do ruby ‚Äã‚Äãde uma determinada vers√£o.  √â melhor instal√°-lo atrav√©s do rbenv (rvm, asdf ...).  Executar tudo isso a partir da raiz do usu√°rio √© sempre uma m√° ideia, portanto, voc√™ precisa criar um usu√°rio separado e configurar os direitos para ele.  Depois disso, voc√™ precisa fazer o upload do nosso c√≥digo para o servidor, copiar as configura√ß√µes do nginx, postgres, etc e executar todos esses servi√ßos. </p><br><p>  <strong>Como resultado, a sequ√™ncia de a√ß√µes √© a seguinte:</strong> </p><br><ol><li>  Entrar como root </li><li>  instalar pacotes do sistema </li><li>  crie um novo usu√°rio, configure direitos, chave ssh </li><li>  configurar pacotes do sistema (nginx etc) e execut√°-los </li><li>  Crie um usu√°rio no banco de dados (voc√™ pode criar imediatamente um banco de dados) </li><li>  Efetue login como um novo usu√°rio </li><li>  Instale rbenv e ruby </li><li>  Instale o bundler </li><li>  Preencha o c√≥digo do aplicativo </li><li>  Iniciamos o servidor Puma </li></ol><br><p>  Al√©m disso, os √∫ltimos passos podem ser feitos usando o capistrano, pelo menos ela pode copiar o c√≥digo nos diret√≥rios da vers√£o da caixa, alternar a vers√£o com um link simb√≥lico em uma implanta√ß√£o bem-sucedida, copiar configura√ß√µes do diret√≥rio compartilhado, reiniciar o puma etc.  Tudo isso pode ser feito com o Ansible, mas por qu√™? </p><br><h2 id="faylovaya-struktura">  Estrutura de arquivo </h2><br><p>  O Ansible possui uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estrutura de arquivos</a> rigorosa para todos os seus arquivos, portanto, √© melhor mant√™-lo em um diret√≥rio separado.  E n√£o √© t√£o importante se ser√° no pr√≥prio aplicativo de trilhos ou separadamente.  Voc√™ pode armazenar arquivos em um reposit√≥rio git separado.  Pessoalmente, foi mais conveniente para mim criar o diret√≥rio ansible em / config do diret√≥rio rails do aplicativo e armazenar tudo em um reposit√≥rio. </p><br><h3 id="simple-playbook">  Manual simples </h3><br><p>  Playbook √© um arquivo yml que descreve o que e como deve ser feito usando uma sintaxe especial.  Vamos criar o primeiro manual que n√£o faz nada: </p><br><pre><code class="plaintext hljs">--- - name: Simple playbook hosts: all</code> </pre> <br><p>  Aqui, simplesmente dizemos que nosso playbook se chama <code>Simple Playbook</code> e que seu conte√∫do deve ser executado para todos os hosts.  Podemos salv√°-lo no diret√≥rio / ansible com o nome <code>playbook.yml</code> e tentar executar: </p><br><pre> <code class="plaintext hljs">ansible-playbook ./playbook.yml PLAY [Simple Playbook] ************************************************************************************************************************************ skipping: no hosts matched</code> </pre> <br><p>  A Ansible diz que n√£o conhece hosts que correspondam √† lista all.  Eles devem estar listados em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">arquivo de invent√°rio</a> especial. </p><br><p>  Vamos cri√°-lo no mesmo diret√≥rio ansible: </p><br><pre> <code class="plaintext hljs">123.123.123.123</code> </pre> <br><p>  Portanto, basta especificar o host (idealmente, o host do seu VPS para testes, ou voc√™ pode registrar o host local) e salve-o no nome de <code>inventory</code> . <br>  Voc√™ pode tentar executar o ansible com um arquivo invet√≥rio: </p><br><pre> <code class="plaintext hljs">ansible-playbook ./playbook.yml -i inventory PLAY [Simple Playbook] ************************************************************************************************************************************ TASK [Gathering Facts] ************************************************************************************************************************************ PLAY RECAP ************************************************************************************************************************************</code> </pre> <br><p>  Se voc√™ tiver acesso ssh ao host especificado, o ansible conectar√° e coletar√° informa√ß√µes sobre o sistema remoto.  (TAREFA padr√£o [Reunindo fatos]), ap√≥s o qual apresentar√° um breve relat√≥rio de progresso (PLAY RECAP). </p><br><p>  Por padr√£o, o nome de usu√°rio no qual voc√™ est√° conectado ao sistema √© usado para a conex√£o.  Provavelmente n√£o estar√° no host.  No arquivo playbook, voc√™ pode especificar qual usu√°rio usar para se conectar usando a diretiva remote_user.  Al√©m disso, as informa√ß√µes sobre um sistema remoto geralmente podem ser desnecess√°rias para voc√™ e voc√™ n√£o deve perder tempo coletando-o.  Voc√™ tamb√©m pode desativar esta tarefa: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no</code> </pre> <br><p>  Tente executar o manual novamente e verifique se a conex√£o est√° funcionando.  (Se voc√™ especificou a raiz do usu√°rio, tamb√©m deve especificar a diretiva torne-se: verdadeira para obter direitos elevados. Como a documenta√ß√£o diz: <code>become set to 'true'/'yes' to activate privilege escalation.</code> - <code>become set to 'true'/'yes' to activate privilege escalation.</code> Embora n√£o esteja claro o porqu√™) . </p><br><p>  Talvez voc√™ receba um erro causado pelo ansible que o int√©rprete python n√£o pode determinar e especifique-o manualmente: </p><br><pre> <code class="plaintext hljs">ansible_python_interpreter: /usr/bin/python3</code> </pre> <br><p>  onde voc√™ tem python pode ser encontrado com o comando <code>whereis python</code> . </p><br><h3 id="ustanovka-sistemnyh-paketov">  Instalar pacotes do sistema </h3><br><p>  O Ansible vem com muitos m√≥dulos para trabalhar com v√°rios pacotes do sistema, portanto, n√£o precisamos escrever scripts bash por qualquer motivo.  Agora precisamos de um desses m√≥dulos para atualizar o sistema e instalar pacotes do sistema.  Eu tenho o Ubuntu Linux no VPS, respectivamente, para instalar pacotes, uso o <code>apt-get</code> e um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">m√≥dulo para ele</a> .  Se voc√™ usa um sistema operacional diferente, pode precisar de um m√≥dulo diferente (lembre-se, eu disse no in√≠cio que precisamos saber com anteced√™ncia o que e como faremos).  No entanto, √© prov√°vel que a sintaxe seja semelhante. </p><br><p>  Complementamos nosso manual de instru√ß√µes com as primeiras tarefas: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root become: true gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present</code> </pre> <br><p>  Tarefa √© apenas a tarefa que o ansible executar√° em servidores remotos.  Atribu√≠mos um nome √† tarefa para rastrear seu progresso no log.  E descrevemos, usando a sintaxe de um m√≥dulo espec√≠fico, o que ele precisa fazer.  Nesse caso, <code>apt: update_cache=yes</code> - diz para atualizar os pacotes do sistema usando o m√≥dulo apt.  A segunda equipe √© um pouco mais complicada.  Passamos a lista de pacotes para o m√≥dulo apt e dizemos que seu <code>state</code> deve se tornar <code>present</code> , ou seja, dizemos para instalar esses pacotes.  Da mesma forma, podemos dizer a eles para serem exclu√≠dos ou atualizados, simplesmente alterando o <code>state</code> .  Observe que, para o rails funcionar com o postgresql, precisamos do pacote postgresql-contrib que estamos instalando atualmente.  Novamente, isso precisa ser conhecido e feito, e, por si s√≥, o ansible n√£o far√° isso. </p><br><p>  Tente executar o playbook novamente e verifique se os pacotes est√£o instalados. </p><br><h3 id="sozdanie-novyh-polzovateley">  Cria√ß√£o de novos usu√°rios. </h3><br><p>  Para trabalhar com usu√°rios, o Ansible tamb√©m possui um m√≥dulo - usu√°rio.  Adicione outra tarefa (ocultei as partes j√° conhecidas do manual por tr√°s dos coment√°rios, para n√£o copi√°-lo totalmente todas as vezes): </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: my_user shell: /bin/bash password: "{{ 123qweasd | password_hash('sha512') }}"</code> </pre> <br><p>  Criamos um novo usu√°rio, definimos uma senha e uma senha.  E ent√£o nos deparamos com v√°rios problemas.  E se os nomes de usu√°rio precisarem ser diferentes para hosts diferentes?  Sim, e manter a senha aberta no manual √© uma p√©ssima id√©ia.  Para come√ßar, colocaremos o nome de usu√°rio e a senha em vari√°veis ‚Äã‚Äãe, no final do artigo, mostrarei como criptografar a senha. </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}"</code> </pre> <br><p>  As vari√°veis ‚Äã‚Äãs√£o definidas usando colchetes duplos nos playbooks. </p><br><p>  Indicaremos os valores das vari√°veis ‚Äã‚Äãno arquivo de invent√°rio: </p><br><pre> <code class="plaintext hljs">123.123.123.123 [all:vars] user=my_user user_password=123qweasd</code> </pre> <br><p>  Preste aten√ß√£o √† diretiva <code>[all:vars]</code> - diz que o pr√≥ximo bloco de texto s√£o vari√°veis ‚Äã‚Äã(vars) e s√£o aplic√°veis ‚Äã‚Äãa todos os hosts (todos). </p><br><p>  A constru√ß√£o de <code>"{{ user_password | password_hash('sha512') }}"</code> tamb√©m <code>"{{ user_password | password_hash('sha512') }}"</code> interessante.  O fato √© que o ansible n√£o define o usu√°rio atrav√©s de <code>user_add</code> como voc√™ faria manualmente.  E ele salva todos os dados diretamente, e √© por isso que tamb√©m devemos converter a senha em um hash antecipadamente, como esse comando. </p><br><p>  Vamos adicionar nosso usu√°rio ao grupo sudo.  No entanto, antes disso, voc√™ precisa garantir que esse grupo exista, porque ningu√©m far√° isso por n√≥s: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo"</code> </pre> <br><p>  √â bastante simples, tamb√©m temos um m√≥dulo de grupo para criar grupos, com uma sintaxe muito semelhante ao apt.  Ent√£o √© suficiente registrar esse grupo no usu√°rio ( <code>groups: "sudo"</code> ). <br>  Tamb√©m √© √∫til adicionar uma chave ssh a esse usu√°rio, para que possamos efetuar login sem uma senha: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook # ... tasks: # ... - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p>  Nesse caso, a constru√ß√£o <code>"{{ lookup('file', '~/.ssh/id_rsa.pub') }}"</code> √© interessante - ela copia o conte√∫do do arquivo id_rsa.pub (seu nome pode ser diferente), ou seja, a parte p√∫blica da chave ssh e carrega-o na lista de chaves autorizadas para o usu√°rio no servidor. </p><br><h3 id="roli">  Fun√ß√µes </h3><br><p>  Todas as tr√™s tarefas para cria√ß√£o podem ser facilmente usadas como um grupo de tarefas, e seria bom manter esse grupo separado do manual principal para que ele n√£o cres√ßa muito.  Existem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pap√©is</a> para isso em ansible. <br>  De acordo com a estrutura de arquivos indicada no in√≠cio, as fun√ß√µes devem ser colocadas em um diret√≥rio de fun√ß√µes separado, para cada fun√ß√£o - um diret√≥rio separado com o mesmo nome, dentro do diret√≥rio de tarefas, arquivos, modelos, etc. <br>  Vamos criar a estrutura do arquivo: <code>./ansible/roles/user/tasks/main.yml</code> (main √© o arquivo principal que ser√° carregado e executado quando a fun√ß√£o estiver conectada √† playbook, outros arquivos de fun√ß√£o poder√£o ser conectados nela).  Agora voc√™ pode transferir para este arquivo todas as tarefas relacionadas ao usu√°rio: </p><br><pre> <code class="plaintext hljs"># Create user and add him to groups - name: Ensure a 'sudo' group group: name: sudo state: present - name: Add a new user user: name: "{{ user }}" shell: /bin/bash password: "{{ user_password | password_hash('sha512') }}" groups: "sudo" - name: Deploy SSH Key authorized_key: user: "{{ user }}" key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state: present</code> </pre> <br><p>  No manual principal, voc√™ deve especificar para usar a fun√ß√£o de usu√°rio: </p><br><pre> <code class="plaintext hljs">--- - name: Simple playbook hosts: all remote_user: root gather_facts: no tasks: - name: Update system apt: update_cache=yes - name: Install system dependencies apt: name: git,nginx,redis,postgresql,postgresql-contrib state: present roles: - user</code> </pre> <br><p>  Al√©m disso, pode fazer sentido executar uma atualiza√ß√£o do sistema antes de todas as outras tarefas, para isso, voc√™ pode renomear o bloco de <code>tasks</code> no qual elas s√£o definidas nas <code>pre_tasks</code> . </p><br><h3 id="nastroyka-nginx">  Configura√ß√£o do Nginx </h3><br><p>  O Nginx j√° deve estar instalado conosco, voc√™ precisa configur√°-lo e execut√°-lo.  Vamos fazer isso imediatamente no papel.  Crie uma estrutura de arquivos: </p><br><pre> <code class="plaintext hljs">- ansible - roles - nginx - files - tasks - main.yml - templates</code> </pre> <br><p>  Agora precisamos de arquivos e modelos.  A diferen√ßa entre os dois √© que os arquivos ansible s√£o copiados diretamente, como est√£o.  E os modelos devem ter a extens√£o j2 e podem usar os valores das vari√°veis ‚Äã‚Äãusando os mesmos colchetes duplos. </p><br><p>  Vamos incluir o nginx no arquivo <code>main.yml</code> .  Para isso, temos um m√≥dulo systemd: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes</code> </pre> <br><p>  Aqui, n√£o apenas dizemos que o nginx deve ser iniciado (ou seja, executa-o), mas tamb√©m dizemos imediatamente que ele deve estar ativado. <br>  Agora copie os arquivos de configura√ß√£o: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644'</code> </pre> <br><p>  Criamos o arquivo de configura√ß√£o principal do nginx (voc√™ pode acess√°-lo diretamente do servidor ou grav√°-lo).  E tamb√©m o arquivo de configura√ß√£o para o nosso aplicativo no diret√≥rio sites_available (isso n√£o √© necess√°rio, mas √∫til).  No primeiro caso, usamos o m√≥dulo de c√≥pia para copiar arquivos (o arquivo deve estar em <code>/ansible/roles/nginx/files/nginx.conf</code> ).  No segundo - copie o modelo, substituindo os valores das vari√°veis.  O modelo deve estar em <code>/ansible/roles/nginx/templates/my_app.j2</code> ).  E pode ser algo como isto: </p><br><pre> <code class="plaintext hljs">upstream {{ app_name }} { server unix:{{ app_path }}/shared/tmp/sockets/puma.sock; } server { listen 80; server_name {{ server_name }} {{ inventory_hostname }}; root {{ app_path }}/current/public; try_files $uri/index.html $uri.html $uri @{{ app_name }}; .... }</code> </pre> <br><p>  Preste aten√ß√£o √†s inser√ß√µes <code>{{ app_name }}</code> , <code>{{ app_path }}</code> , <code>{{ server_name }}</code> , <code>{{ inventory_hostname }}</code> - essas s√£o todas as vari√°veis ‚Äã‚Äãcujos valores ansible ser√£o substitu√≠dos no modelo antes de copiar.  Isso √© √∫til se voc√™ usar o manual para diferentes grupos de hosts.  Por exemplo, podemos complementar nosso arquivo de invent√°rio: </p><br><pre> <code class="plaintext hljs">[production] 123.123.123.123 [staging] 231.231.231.231 [all:vars] user=my_user user_password=123qweasd [production:vars] server_name=production app_path=/home/www/my_app app_name=my_app [staging:vars] server_name=staging app_path=/home/www/my_stage app_name=my_stage_app</code> </pre> <br><p>  Se executarmos agora o nosso manual, ele executar√° as tarefas especificadas para os dois hosts.  Mas, ao mesmo tempo, para o host intermedi√°rio, as vari√°veis ‚Äã‚Äãdiferem da produ√ß√£o, e n√£o apenas nas fun√ß√µes e playbooks, mas tamb√©m nas configura√ß√µes do nginx.  <code>{{ inventory_hostname }}</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nome_do_host_do_</a> <code>{{ inventory_hostname }}</code> n√£o precisa ser especificado no arquivo de invent√°rio - essa √© uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vari√°vel especial ansible</a> e o host para o qual o manual est√° atualmente em execu√ß√£o √© armazenado l√°. <br>  Se voc√™ deseja ter um arquivo de invent√°rio para v√°rios hosts e executar apenas um grupo, isso pode ser feito com o seguinte comando: </p><br><pre> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging"</code> </pre> <br><p>  outra op√ß√£o √© ter arquivos de invent√°rio separados para diferentes grupos.  Ou voc√™ pode combinar duas abordagens se tiver muitos hosts diferentes. </p><br><p>  Vamos voltar √† configura√ß√£o do nginx.  Ap√≥s copiar os arquivos de configura√ß√£o, precisamos criar um link simb√≥lico no sitest_enabled no my_app.conf em sites_available.  E reinicie o nginx. </p><br><pre> <code class="plaintext hljs">... # old code in mail.yml - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted</code> </pre> <br><p>  Tudo √© simples aqui - novamente, m√≥dulos ansible com sintaxe bastante padr√£o.  Mas h√° um ponto.  Reiniciar o nginx toda vez n√£o faz sentido.  Voc√™ notou que n√£o estamos escrevendo comandos do formul√°rio: "fa√ßa assim", a sintaxe se parece mais com "isso deve ter esse estado".  E na maioria das vezes √© assim que funciona o ansible.  Se o grupo j√° existir ou o pacote do sistema j√° estiver instalado, o ansible verificar√° isso e pular√° a tarefa.  Al√©m disso, os arquivos n√£o ser√£o copiados se coincidirem completamente com o que j√° est√° no servidor.  Podemos tirar proveito disso e reiniciar o nginx somente se os arquivos de configura√ß√£o foram alterados.  Existe uma diretiva de registro para isso: </p><br><pre> <code class="plaintext hljs"># Copy nginx configs and start it - name: enable service nginx and start systemd: name: nginx state: started enabled: yes - name: Copy the nginx.conf copy: src: nginx.conf dest: /etc/nginx/nginx.conf owner: root group: root mode: '0644' backup: yes register: restart_nginx - name: Copy template my_app.conf template: src: my_app_conf.j2 dest: /etc/nginx/sites-available/my_app.conf owner: root group: root mode: '0644' register: restart_nginx - name: Create symlink to sites-enabled file: src: /etc/nginx/sites-available/my_app.conf dest: /etc/nginx/sites-enabled/my_app.conf state: link - name: restart nginx service: name: nginx state: restarted when: restart_nginx.changed</code> </pre> <br><p>  Se um dos arquivos de configura√ß√£o mudar, a c√≥pia ser√° executada e a vari√°vel <code>restart_nginx</code> ser√° registrada.  E somente se essa vari√°vel tiver sido registrada, o servi√ßo ser√° reiniciado. </p><br><p>  Bem, √© claro, voc√™ precisa adicionar a fun√ß√£o nginx ao manual principal. </p><br><h3 id="nastroyka-postgresql">  Configura√ß√£o do Postgresql </h3><br><p>  Precisamos ativar o postgresql com systemd, assim como fizemos com o nginx, e tamb√©m criar um usu√°rio que usaremos para acessar o banco de dados e o pr√≥prio banco de dados. <br>  Crie a fun√ß√£o <code>/ansible/roles/postgresql/tasks/main.yml</code> : </p><br><pre> <code class="plaintext hljs"># Create user in postgresql - name: enable postgresql and start systemd: name: postgresql state: started enabled: yes - name: Create database user become_user: postgres postgresql_user: name: "{{ db_user }}" password: "{{ db_password }}" role_attr_flags: SUPERUSER - name: Create database become_user: postgres postgresql_db: name: "{{ db_name }}" encoding: UTF-8 owner: "{{ db_user }}"</code> </pre> <br><p>  N√£o descreverei como adicionar vari√°veis ‚Äã‚Äãao invent√°rio, isso j√° foi feito v√°rias vezes, bem como a sintaxe dos m√≥dulos postgresql_db e postgresql_user.  Mais dados podem ser encontrados na documenta√ß√£o.  A diretiva <code>become_user: postgres</code> mais interessante <code>become_user: postgres</code> .  O fato √© que, por padr√£o, apenas o usu√°rio do postgres tem acesso ao banco de dados postgresql e somente localmente.  Essa diretiva nos permite executar comandos em nome desse usu√°rio (a menos que tenhamos acesso). <br>  Al√©m disso, pode ser necess√°rio adicionar uma linha ao pg_hba.conf para abrir o acesso ao banco de dados para um novo usu√°rio.  Isso pode ser feito da mesma maneira que alteramos a configura√ß√£o do nginx. </p><br><p>  E √© claro que voc√™ precisa adicionar o papel do postgresql ao manual principal. </p><br><h3 id="ustanovka-ruby-cherez-rbenv">  Instale o ruby ‚Äã‚Äãatrav√©s do rbenv </h3><br><p>  O Ansible n√£o possui m√≥dulos para trabalhar com o rbenv, mas √© instalado clonando um reposit√≥rio git.  Portanto, essa tarefa se torna a mais n√£o-padr√£o.  Vamos criar a fun√ß√£o <code>/ansible/roles/ruby_rbenv/main.yml</code> para ela e come√ßar a preench√™-la: </p><br><pre> <code class="plaintext hljs"># Install rbenv and ruby - name: Install rbenv become_user: "{{ user }}" git: repo=https://github.com/rbenv/rbenv.git dest=~/.rbenv</code> </pre> <br><p>  Novamente usamos a diretiva become_user para trabalhar com o usu√°rio que criamos para esses fins.  Como o rbenv est√° instalado em seu diret√≥rio inicial, n√£o em todo o mundo.  E tamb√©m usamos o m√≥dulo git para clonar o reposit√≥rio especificando repo e dest. </p><br><p>  Em seguida, precisamos registrar o rbenv init no bashrc e adicionar o rbenv ao PATH no mesmo local.  Para isso, temos o m√≥dulo lineinfile: </p><br><pre> <code class="plaintext hljs">- name: Add rbenv to PATH become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'export PATH="${HOME}/.rbenv/bin:${PATH}"' - name: Add rbenv init to bashrc become_user: "{{ user }}" lineinfile: path: ~/.bashrc state: present line: 'eval "$(rbenv init -)"'</code> </pre> <br><p>  Em seguida, instale o ruby_build: </p><br><pre> <code class="plaintext hljs">- name: Install ruby-build become_user: "{{ user }}" git: repo=https://github.com/rbenv/ruby-build.git dest=~/.rbenv/plugins/ruby-build</code> </pre> <br><p>  E, finalmente, instale o ruby.  Isso √© feito via rbenv, ou seja, apenas um comando bash: </p><br><pre> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" rbenv install {{ ruby_version }} args: executable: /bin/bash</code> </pre> <br><p>  Dizemos qual equipe executar e como.  No entanto, aqui nos deparamos com o fato de o ansible n√£o executar o c√≥digo contido no bashrc antes de executar os comandos.  Portanto, o rbenv ter√° que ser definido diretamente no mesmo script. </p><br><p>  O pr√≥ximo problema √© que o comando shell n√£o tem estado em termos de ansible.  Ou seja, uma verifica√ß√£o autom√°tica se esta vers√£o do ruby ‚Äã‚Äãest√° instalada ou n√£o.  N√≥s podemos fazer isso sozinhos: </p><br><pre> <code class="plaintext hljs">- name: Install ruby become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" if ! rbenv versions | grep -q {{ ruby_version }} then rbenv install {{ ruby_version }} &amp;&amp; rbenv global {{ ruby_version }} fi args: executable: /bin/bash</code> </pre> <br><p>  E resta instalar o bundler: </p><br><pre> <code class="plaintext hljs">- name: Install bundler become_user: "{{ user }}" shell: | export PATH="${HOME}/.rbenv/bin:${PATH}" eval "$(rbenv init -)" gem install bundler</code> </pre> <br><p>  E, novamente, adicione nossa fun√ß√£o ruby_rbenv ao manual principal. </p><br><h3 id="shared-files">  Arquivos compartilhados. </h3><br><p>  Em geral, essa configura√ß√£o pode ser conclu√≠da.  Resta ent√£o rodar o capistrano e ele copiar√° o pr√≥prio c√≥digo, criar√° os diret√≥rios necess√°rios e iniciar√° o aplicativo (se tudo estiver configurado corretamente).  No entanto, muitas vezes o capistrano precisa de arquivos de configura√ß√£o adicionais, como <code>database.yml</code> ou <code>.env</code> pode copi√°-los exatamente como arquivos e modelos para o nginx.  Existe apenas uma sutileza.  Antes de copiar arquivos, voc√™ precisa criar uma estrutura de diret√≥rios para eles, algo como isto: </p><br><pre> <code class="plaintext hljs"># Copy shared files for deploy - name: Ensure shared dir become_user: "{{ user }}" file: path: "{{ app_path }}/shared/config" state: directory</code> </pre> <br><p>  especificamos apenas um diret√≥rio e o ansible criar√° automaticamente o pai, se necess√°rio. </p><br><h2 id="ansible-vault">  Cofre Ansible </h2><br><p>  J√° descobrimos que dados secretos, como senha de usu√°rio, podem aparecer em vari√°veis.  Se voc√™ criou um arquivo <code>.env</code> para o aplicativo e <code>database.yml</code> , deve haver ainda mais esses dados cr√≠ticos.  Seria bom escond√™-los de olhares indiscretos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O cofre Ansible √©</a> usado para isso. </p><br><p>  Vamos criar um arquivo para as vari√°veis <code>/ansible/vars/all.yml</code> (aqui voc√™ pode criar arquivos diferentes para diferentes grupos de hosts, assim como no arquivo de invent√°rio: production.yml, staging.yml, etc). <br>  Nesse arquivo, voc√™ precisa transferir todas as vari√°veis ‚Äã‚Äãque devem ser criptografadas usando a sintaxe yml padr√£o: </p><br><pre> <code class="plaintext hljs"># System vars user_password: 123qweasd db_password: 123qweasd # ENV vars aws_access_key_id: xxxxx aws_secret_access_key: xxxxxx aws_bucket: bucket_name rails_secret_key_base: very_secret_key_base</code> </pre> <br><p>  Ent√£o este arquivo pode ser criptografado com o comando: </p><br><pre> <code class="plaintext hljs">ansible-vault encrypt ./vars/all.yml</code> </pre> <br><p>  Naturalmente, durante a criptografia, ser√° necess√°rio definir uma senha para descriptografia.  Voc√™ pode ver o que aparece dentro do arquivo depois de chamar este comando. </p><br><p>  Usando <code>ansible-vault decrypt</code> arquivo pode ser descriptografado, modificado e depois criptografado novamente. </p><br><p>  Para funcionar, descriptografar o arquivo n√£o √© necess√°rio.  Voc√™ o armazena na forma criptografada e executa o manual com o argumento <code>--ask-vault-pass</code> .  O Ansible solicitar√° uma senha, obter√° as vari√°veis ‚Äã‚Äãe concluir√° as tarefas.  Todos os dados permanecer√£o criptografados. </p><br><p>  Um comando completo para v√°rios grupos de hosts e o cofre ansible seria algo parecido com isto: </p><br><pre> <code class="plaintext hljs">ansible-playbook -i inventory ./playbook.yml -l "staging" --ask-vault-pass</code> </pre> <br><p>  E n√£o vou lhe dar o texto completo de playbooks e pap√©is, escreva para si mesmo.  Porque o mais ansioso √© este - se voc√™ n√£o entender o que precisa ser feito, ele n√£o o far√°. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460769/">https://habr.com/ru/post/pt460769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460743/index.html">Guia do Iniciante do Flutter</a></li>
<li><a href="../pt460745/index.html">Experi√™ncia no uso de um m√≥dulo GSM em automa√ß√£o residencial</a></li>
<li><a href="../pt460747/index.html">Procure lucros ou aperte nozes: o Spotify parou de trabalhar com autores diretamente - o que significa</a></li>
<li><a href="../pt460751/index.html">Como lan√ßamos rob√¥s em pouco Chernobyl. Parte 1</a></li>
<li><a href="../pt460755/index.html">Rob√¥ de carrinho ROS - Parte 1: Ferro</a></li>
<li><a href="../pt460773/index.html">Implementando a correspond√™ncia de padr√µes em Java</a></li>
<li><a href="../pt460777/index.html">Esta √© a vez: por que a Apple mudou os requisitos para desenvolvedores de aplicativos</a></li>
<li><a href="../pt460779/index.html">Depura√ß√£o avan√ßada</a></li>
<li><a href="../pt460783/index.html">Consenso sobre a reputa√ß√£o do n√≥. √â necess√°rio?</a></li>
<li><a href="../pt460785/index.html">Aplicativos para e-books no sistema operacional Android. Parte 1. Introdu√ß√£o e aplicativos de escrit√≥rio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>