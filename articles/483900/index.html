<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôéüèΩ üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üíø Creaci√≥n de un sistema Embedded Linux tolerante a fallos basado en el m√≥dulo Mars ZX3 de Enclustra üé¶ ü•° ‚òùüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Debido a la carga de trabajo de especialistas, hace varios a√±os nos vimos obligados a dar un desarrollo a las contrapartes. El desarrollo se llev√≥ a c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Creaci√≥n de un sistema Embedded Linux tolerante a fallos basado en el m√≥dulo Mars ZX3 de Enclustra</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483900/">  Debido a la carga de trabajo de especialistas, hace varios a√±os nos vimos obligados a dar un desarrollo a las contrapartes.  El desarrollo se llev√≥ a cabo en el m√≥dulo Enclustra Mars ZX3, que utiliza el SOC ARM + FPGA Zynq-7020.  Para construir Linux, utilizamos Bcl de Enclustra (bsp-xilinx), que fue ligeramente modificado. <br><br>  En el proceso de probar el software desarrollado, inmediatamente encontramos fallas de software cuando se apag√≥ la alimentaci√≥n.  Durante el an√°lisis, se descubri√≥ que los comandos de configuraci√≥n enviados al dispositivo a trav√©s de la red se escrib√≠an en archivos que, cuando ocurr√≠a una falla de energ√≠a, a veces resultaba estar vac√≠a o completamente ausente.  Esto nos oblig√≥ a reconsiderar la ideolog√≠a de construir el ensamblado de Linux que nos fue entregado.  El proceso de construcci√≥n del sistema en s√≠ est√° bien descrito en el <a href="http://enclustra.github.io/ebe-docs/user-doc-xilinx/index_xilinx.html">sitio del</a> fabricante del m√≥dulo, por lo que no me detendr√© en √©l.  Solo describir√© lo que nos ha permitido resolver la tarea que tenemos ante nosotros de aumentar la confiabilidad y prevenir fallas. <br><a name="habracut"></a><br>  El m√≥dulo Mars ZX3 tiene chips QSPI Flash y NAND Flash.  En nuestro caso, el m√≥dulo se carga con QSPI Flash, en el que se escribi√≥ U-Boot.  Dado que ambos chips usan los mismos pines Zynq-7020, despu√©s de cargar U-Boot cambia los pines a NAND Flash, en el que el script de arranque, el √Årbol de dispositivos, el kernel de Linux, el sistema de archivos ubifs y las variables de entorno se escriben en secciones separadas.  Adem√°s, todas las secciones, excepto la secci√≥n con variables de entorno, estaban reservadas (es decir, hab√≠a dos de esas secciones).  El siguiente es un fragmento del archivo del √Årbol de dispositivos, que muestra c√≥mo se rompi√≥ NAND Flash en la versi√≥n que nos transmitieron los contratistas: <br><br><pre><code class="bash hljs">partition@nand-linux { label = <span class="hljs-string"><span class="hljs-string">"nand-linux"</span></span>; reg = &lt;0x0 0x500000&gt;; }; partition@nand-device-tree { label = <span class="hljs-string"><span class="hljs-string">"nand-device-tree"</span></span>; reg = &lt;0x500000 0x100000&gt;; }; partition@nand-bootscript { label = <span class="hljs-string"><span class="hljs-string">"nand-bootscript"</span></span>; reg = &lt;0x600000 0x100000&gt;; }; partition@nand-linux-second { label = <span class="hljs-string"><span class="hljs-string">"nand-linux-second"</span></span>; reg = &lt;0x700000 0x500000&gt;; }; partition@nand-device-tree-second { label = <span class="hljs-string"><span class="hljs-string">"nand-device-tree"</span></span>; reg = &lt;0xC00000 0x100000&gt;; }; partition@nand-bootscript-second { label = <span class="hljs-string"><span class="hljs-string">"nand-bootscript"</span></span>; reg = &lt;0xD00000 0x100000&gt;; }; partition@nand-rootfs { label = <span class="hljs-string"><span class="hljs-string">"nand-rootfs"</span></span>; reg = &lt;0xE00000 0xF500000&gt;; }; partition@nand-rootfs-second { label = <span class="hljs-string"><span class="hljs-string">"nand-rootfs"</span></span>; reg = &lt;0x10300000 0xF500000&gt;; }; partition@boot-env { label = <span class="hljs-string"><span class="hljs-string">"nand-env"</span></span>; reg = &lt;0x1F800000 0x100000&gt;; };</code> </pre> <br>  Se supon√≠a que las segundas secciones se utilizar√≠an cuando las secciones principales fallaran.  Para hacer esto, Linux tuvo que implementar un proceso que monitorea la integridad del sistema y, en caso de falla, escribe un valor en la variable de entorno que le indica que inicie el sistema desde las particiones de respaldo.  Se supon√≠a que este algoritmo se implementar√≠a en el futuro. <br><br>  Los datos de configuraci√≥n se registraron en dos carpetas para la copia de seguridad, pero esto no salv√≥ la situaci√≥n.  Se supone que, en ausencia de archivos de configuraci√≥n, se vuelven a crear autom√°ticamente, con la configuraci√≥n predeterminada. <br><br>  El problema es que NAND Flash escribe datos una p√°gina a la vez y el borrado se produce en bloques.  Por lo tanto, si se produce un fallo de alimentaci√≥n durante la grabaci√≥n de datos, no solo estos datos se da√±ar√°n, sino que el sistema de archivos puede da√±arse.  Iniciar un sistema de respaldo solo puede retrasar la aparici√≥n de un problema.  Aunque en este caso es posible realizar la restauraci√≥n de las particiones principales desde las de respaldo. <br><br>  Decidimos ir hacia otro lado, montando rootfs como un sistema de archivos de solo lectura y escribiendo archivos de configuraci√≥n para separar <i>las</i> secciones de <i>datos</i> y <i>copias de seguridad</i> que se montaron para leer y escribir.  En este caso, la necesidad de particiones de respaldo desaparece, pero las dejamos para el futuro, ya que la cantidad de memoria nos permiti√≥ hacer esto.  Si es necesario, se pueden eliminar. <br><br>  Como resultado, se realiz√≥ el siguiente particionamiento NAND Flash: <br><br><pre> <code class="bash hljs"> partition@nand-linux { label = <span class="hljs-string"><span class="hljs-string">"nand-linux"</span></span>; reg = &lt;0x0 0x500000&gt;; }; partition@nand-device-tree { label = <span class="hljs-string"><span class="hljs-string">"nand-device-tree"</span></span>; reg = &lt;0x500000 0x100000&gt;; }; partition@nand-bootscript { label = <span class="hljs-string"><span class="hljs-string">"nand-bootscript"</span></span>; reg = &lt;0x600000 0x100000&gt;; }; partition@nand-linux-second { label = <span class="hljs-string"><span class="hljs-string">"nand-linux-second"</span></span>; reg = &lt;0x700000 0x500000&gt;; }; partition@nand-device-tree-second { label = <span class="hljs-string"><span class="hljs-string">"nand-device-tree"</span></span>; reg = &lt;0xC00000 0x100000&gt;; }; partition@nand-bootscript-second { label = <span class="hljs-string"><span class="hljs-string">"nand-bootscript"</span></span>; reg = &lt;0xD00000 0x100000&gt;; }; partition@nand-rootfs { label = <span class="hljs-string"><span class="hljs-string">"nand-rootfs"</span></span>; reg = &lt;0xE00000 0x9600000&gt;; }; partition@nand-rootfs-second { label = <span class="hljs-string"><span class="hljs-string">"nand-rootfs"</span></span>; reg = &lt;0xA400000 0x9600000&gt;; }; partition@nand-data { label = <span class="hljs-string"><span class="hljs-string">"nand-data"</span></span>; reg = &lt;0x13A00000 0x5F00000&gt;; }; partition@nand-data-backup { label = <span class="hljs-string"><span class="hljs-string">"nand-data-backup"</span></span>; reg = &lt;0x19900000 0x5F00000&gt;; }; partition@boot-env { label = <span class="hljs-string"><span class="hljs-string">"nand-env"</span></span>; reg = &lt;0x1F800000 0x100000&gt;; };</code> </pre> <br>  Al flashear NAND Flash con el comando U-Boot, borramos las secciones <i>nand-data</i> y <i>nand-data-backup</i> : <br><br><pre> <code class="plaintext hljs">u-boot&gt;nand erase.part nand-data u-boot&gt;nand erase.part nand-data-backup</code> </pre> <br>  En el script de arranque de Linux, implementamos el montaje del sistema de archivos ra√≠z como de solo lectura, reemplazando la l√≠nea en el archivo / etc / inittab en el ensamblado de Linux: <br><br><pre> <code class="bash hljs">::sysinit:/bin/mount -o remount,rw /</code> </pre> <br>  en <br><br><pre> <code class="bash hljs">::sysinit:/bin/mount -o remount,ro /</code> </pre> <br>  Agregamos un script de arranque a la carpeta <i>/etc/init.d/</i> , que monta las secciones <i>nand-data</i> y <i>nand-data-backup</i> para leer y escribir.  En caso de un error de montaje (durante el primer arranque o si el sistema de archivos est√° da√±ado), estas particiones se formatean y se vuelven a montar.  Las carpetas <i>/ mnt / data /</i> y <i>/ mnt / backup /</i> deben crearse previamente en el sistema de archivos ra√≠z. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # # datafs Mount datafs. # umask 077 start() { printf "Starting mount datafs..." /usr/sbin/ubiattach /dev/ubi_ctrl -m 8 /usr/sbin/ubiattach /dev/ubi_ctrl -m 9 mount_datafs_err=0; mount_datafs_backup_err=0; /bin/mount -t ubifs ubi1:datafs /mnt/data mount_datafs_err=$? if [ $mount_datafs_err -ne 0 ]; then /usr/sbin/ubidetach -p /dev/mtd8 /usr/sbin/ubiformat /dev/mtd8 -y /usr/sbin/ubiattach /dev/ubi_ctrl -m 8 /usr/sbin/ubimkvol /dev/ubi1 -N datafs -s 81MiB /bin/mount -t ubifs ubi1:datafs /mnt/data mount_datafs_err=$? fi /bin/mount -t ubifs ubi2:datafs /mnt/backup mount_datafs_backup_err=$? if [ $mount_datafs_backup_err -ne 0 ]; then /usr/sbin/ubidetach -p /dev/mtd9 /usr/sbin/ubiformat /dev/mtd9 -y /usr/sbin/ubiattach /dev/ubi_ctrl -m 9 /usr/sbin/ubimkvol /dev/ubi2 -N datafs -s 81MiB /bin/mount -t ubifs ubi2:datafs /mnt/backup mount_datafs_backup_err=$? fi printf "Mount datafs: " if [ $mount_datafs_err -ne 0 ]; then echo "Error" else echo "OK" fi printf "Mount backup datafs: " if [ $mount_datafs_backup_err -ne 0 ]; then echo "Error" else echo "OK" fi touch /var/lock/datafs } stop() { /bin/umount /mnt/data /bin/umount /mnt/backup rm -f /var/lock/datafs } restart() { stop sleep 1 start } case "$1" in start) start ;; stop) stop ;; restart|reload) restart ;; *) echo "Usage: $0 {start|stop|restart|reload}" exit 1 esac exit 0</span></span></code> </pre> <br>  Al descargar, si faltan los archivos de configuraci√≥n en la carpeta <i>/ mnt / data /</i> , se descargan de la carpeta <i>/ mnt / backup /</i> .  Si no hay archivos de configuraci√≥n en <i>/ mnt / backup /</i> , se crean autom√°ticamente desde el software con los par√°metros predeterminados.  Si los archivos est√°n presentes en <i>/ mnt / data /</i> pero no en <i>/ mnt / backup /</i> , se copian de <i>/ mnt / data /</i> a <i>/ mnt / backup /</i> .  Todas estas operaciones son realizadas por el software del usuario. <br><br>  En la siguiente etapa, para aumentar la confiabilidad, nos negamos a escribir la configuraci√≥n en un archivo para cada comando.  Toda la configuraci√≥n ahora se almacena en RAM y, si es necesario, mediante un comando separado se puede guardar en archivos en las carpetas <i>/ mnt / data /</i> y <i>/ mnt / backup /</i> . <br><br>  Si durante el trabajo necesita realizar cambios en el sistema de archivos ra√≠z sin actualizar el dispositivo, puede volver a montar el sistema desde la consola para leer y escribir con el comando <br><br><pre> <code class="bash hljs">mount -o remount,rw /</code> </pre> <br>  Realice cambios y luego vuelva a montar en Solo lectura: <br><br><pre> <code class="bash hljs">mount -o remount,ro /</code> </pre> </div></div><p>Source: <a href="https://habr.com/ru/post/483900/">https://habr.com/ru/post/483900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../483882/index.html">Pruebas unitarias en arquitectura Clean Swift</a></li>
<li><a href="../483886/index.html">Decodificador Movix Pro: del software a la √∫ltima tuerca</a></li>
<li><a href="../483888/index.html">Ejecutar programas de un solo archivo en Java 11 sin compilaci√≥n</a></li>
<li><a href="../483896/index.html">C√≥mo lanzar un producto solo si es desarrollador: Consejos del creador de Laravel, Taylor Otvel. Parte 2: Encontrar una idea</a></li>
<li><a href="../483898/index.html">¬øDocumentos como c√≥digo contra o en conjunto con Confluence? Descripci√≥n general de varias formas de publicar desde un repositorio a Confluence</a></li>
<li><a href="../483906/index.html">Terminal m√≥vil en sistemas de control de acceso.</a></li>
<li><a href="../483910/index.html">Teor√≠a de la informaci√≥n visual (Parte 1)</a></li>
<li><a href="../483912/index.html">¬øQu√© hay de nuevo en YouTrack en 2020?</a></li>
<li><a href="../483914/index.html">Te invitamos a DINS JavaScript EVENING: hablamos sobre el dise√±o de API y resolvemos problemas usando tipos de datos algebraicos</a></li>
<li><a href="../483916/index.html">DJI no ha podido parchear las aplicaciones DJI Fly para Android 10 desde hace un mes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>