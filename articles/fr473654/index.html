<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüíª üò¥ ‚òùüèæ Compositeur PHP: corriger les d√©pendances sans douleur ü§öüèª üõåüèº üò©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beaucoup d'entre vous ont probablement rencontr√© une situation o√π il y a un bogue ou non les fonctionnalit√©s n√©cessaires dans la biblioth√®que ou le fr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Compositeur PHP: corriger les d√©pendances sans douleur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/473654/"><p>  Beaucoup d'entre vous ont probablement rencontr√© une situation o√π il y a un bogue ou non les fonctionnalit√©s n√©cessaires dans la biblioth√®que ou le framework que vous utilisez.  Supposons que vous n'√©tiez pas trop paresseux et que vous ayez form√© une demande de pull.  Mais ils ne l'accepteront pas tout de suite, et la prochaine version du produit en g√©n√©ral peut arriver dans un an. </p><br><p><img src="https://habrastorage.org/webt/jv/ys/9h/jvys9h_dh2zmefozo_xhrosiipo.jpeg" alt="Compositeur PHP: corriger les d√©pendances sans douleur"></p><br><p>  Que faire si vous devez de toute urgence appliquer la correction au produit?  La solution √©vidente consiste √† utiliser un fork d'une biblioth√®que ou d'un framework.  Cependant, tout n'est pas simple avec les fourches.  L'utilisation de l'h√©ritage pour remplacer la fonctionnalit√© qui doit √™tre modifi√©e n'est pas toujours possible et n√©cessite souvent des changements majeurs.  Les plugins pour Composer qui peuvent corriger les d√©pendances viennent √† la rescousse. </p><br><p>  Dans cet article, je parlerai davantage des raisons pour lesquelles les fourches ne sont pas pratiques, et je consid√©rerai √©galement deux plugins pour Composer pour les correctifs de d√©pendance: comment ils diff√®rent, comment les utiliser et quels sont leurs avantages.  Si vous avez rencontr√© des probl√®mes similaires ou si vous vous demandez simplement, bienvenue chez cat. <a name="habracut"></a></p><br><p> Le probl√®me est plus facilement consid√©r√© avec un exemple.  Disons que nous voulons changer quelque chose dans la biblioth√®que de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">couverture de code PHP</a> , qui est utilis√©e dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">framework de</a> test <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHPUnit</a> pour mesurer le niveau de couverture de code par les tests.  Supposons que nous voulons corriger quelque chose comme √ßa dans la version 7.0.8 (fichier <code>myFix.patch</code> ): </p><br><pre> <code class="diff hljs">diff --git a/src/CodeCoverage.php b/src/CodeCoverage.php index 2c92ae2..514171e 100644 --- a/src/CodeCoverage.php +++ b/src/CodeCoverage.php @@ -190,6 +190,7 @@ public function filter(): Filter */ public function getData(bool $raw = false): array { + // for example some changes here if (!$raw &amp;&amp; $this-&gt;addUncoveredFilesFromWhitelist) { $this-&gt;addUncoveredFilesFromWhitelist(); }</code> </pre> <br><p>  Cr√©ons notre exemple de biblioth√®que.  Que ce soit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">php-composer-patches-example</a> .  Les d√©tails ici ne sont pas tr√®s importants, mais si vous d√©cidez de voir ce qu'est la biblioth√®que, j'apporte la sortie de la console sous le spoiler. </p><br><div class="spoiler">  <b class="spoiler_title">Texte masqu√©</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ git clone git@github.com:mougrim/php-composer-patches-example.git   ¬´php-composer-patches-example¬ª‚Ä¶ remote: Enumerating objects: 3, done. remote: Counting objects: 100% (3/3), done. remote: Compressing objects: 100% (2/2), done. remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0  : 100% (3/3), . $ cd php-composer-patches-example/ $ $ composer.phar init --name=mougrim/php-composer-patches-example --description="It's an example for article with using forks and patches for changing dependencies" --author='Mougrim &lt;rinat@mougrim.ru&gt;' --type=library --require='phpunit/phpunit:^8.4.2' --license=MIT --homepage='https://github.com/mougrim/php-composer-patches-example' Welcome to the Composer config generator This command will guide you through creating your composer.json config. Package name (&lt;vendor&gt;/&lt;name&gt;) [mougrim/php-composer-patches-example]: Description [It's an example for article with using forks and patches for changing dependencies]: Author [Mougrim &lt;rinat@mougrim.ru&gt;, n to skip]: Minimum Stability []: Package Type (eg library, project, metapackage, composer-plugin) [library]: License [MIT]: Define your dependencies. Would you like to define your dev dependencies (require-dev) interactively [yes]? no { "name": "mougrim/php-composer-patches-example", "description": "It's an example for article with using forks and patches for changing dependencies", "type": "library", "homepage": "https://github.com/mougrim/php-composer-patches-example", "require": { "phpunit/phpunit": "^8.4.2" }, "license": "MIT", "authors": [ { "name": "Mougrim", "email": "rinat@mougrim.ru" } ] } Do you confirm generation [yes]? yes Would you like to install dependencies now [yes]? yes Loading composer repositories with package information Updating dependencies (including require-dev) Package operations: 29 installs, 0 updates, 0 removals - Installing sebastian/version (2.0.1): Loading from cache - Installing sebastian/type (1.1.3): Loading from cache - Installing sebastian/resource-operations (2.0.1): Loading from cache - Installing sebastian/recursion-context (3.0.0): Loading from cache - Installing sebastian/object-reflector (1.1.1): Loading from cache - Installing sebastian/object-enumerator (3.0.3): Loading from cache - Installing sebastian/global-state (3.0.0): Loading from cache - Installing sebastian/exporter (3.1.2): Loading from cache - Installing sebastian/environment (4.2.2): Loading from cache - Installing sebastian/diff (3.0.2): Loading from cache - Installing sebastian/comparator (3.0.2): Loading from cache - Installing phpunit/php-timer (2.1.2): Loading from cache - Installing phpunit/php-text-template (1.2.1): Loading from cache - Installing phpunit/php-file-iterator (2.0.2): Loading from cache - Installing theseer/tokenizer (1.1.3): Loading from cache - Installing sebastian/code-unit-reverse-lookup (1.0.1): Loading from cache - Installing phpunit/php-token-stream (3.1.1): Loading from cache - Installing phpunit/php-code-coverage (7.0.8): Loading from cache - Installing doctrine/instantiator (1.2.0): Loading from cache - Installing symfony/polyfill-ctype (v1.12.0): Loading from cache - Installing webmozart/assert (1.5.0): Loading from cache - Installing phpdocumentor/reflection-common (2.0.0): Loading from cache - Installing phpdocumentor/type-resolver (1.0.1): Loading from cache - Installing phpdocumentor/reflection-docblock (4.3.2): Loading from cache - Installing phpspec/prophecy (1.9.0): Loading from cache - Installing phar-io/version (2.0.1): Loading from cache - Installing phar-io/manifest (1.0.3): Loading from cache - Installing myclabs/deep-copy (1.9.3): Loading from cache - Installing phpunit/phpunit (8.4.2): Loading from cache sebastian/global-state suggests installing ext-uopz (*) phpunit/phpunit suggests installing phpunit/php-invoker (^2.0.0) phpunit/phpunit suggests installing ext-soap (*) Writing lock file Generating autoload files $ $ echo 'vendor/' &gt; .gitignore $ echo 'composer.lock' &gt;&gt; .gitignore $ git add .gitignore composer.json $ $ git commit --gpg-sign --message='Init composer' [master ce800ae] Init composer 2 files changed, 18 insertions(+) create mode 100644 .gitignore create mode 100644 composer.json $ git push origin master  : 4, . Delta compression using up to 4 threads.  : 100% (3/3), .  : 100% (4/4), 1.21 KiB | 1.21 MiB/s, . Total 4 (delta 0), reused 0 (delta 0) To github.com:mougrim/php-composer-patches-example.git f31c342..ce800ae master -&gt; master</code> </pre> </div></div><br><h2 id="chto-ne-tak-s-forkom-zavisimosti">  Quel est le probl√®me avec une fourchette de d√©pendance </h2><br><p>  Voyons comment se produit la d√©pendance de fork.  Essayons de bifurquer la couverture de code PHP. </p><br><ol><li>  Nous allons √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la page de couverture du code PHP sur GitHub</a> . </li><li>  Appuyez sur le bouton Fork <img src="https://habrastorage.org/webt/qj/ff/ta/qjfftaa4kurvcfu91mlrvr2twie.png" alt="Bouton de fourche">  (note: vous aurez votre fourchette, remplacez mougrim par votre nom d'utilisateur). </li><li>  Clonez la fourche: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:mougrim/php-code-coverage.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-code-coverage</code> </pre> </li><li>  Acc√©dez √† la version que nous voulons corriger: <br><pre> <code class="bash hljs">git checkout 7.0.8</code> </pre> </li><li>  Cr√©ez une branche pour le correctif: <br><pre> <code class="bash hljs">git checkout -b 7.0.8-myFix</code> </pre> </li><li>  Nous apportons les modifications n√©cessaires, nous nous engageons, nous poussons: <br><pre> <code class="bash hljs">git apply ../myFix.patch git add src/CodeCoverage.php git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'My fix'</span></span> git push -u origin 7.0.8-myFix</code> </pre> </li><li>  Ajoutez fork comme r√©f√©rentiel dans composer.json pour notre biblioth√®que (cela est n√©cessaire pour que lors de la connexion du <code>phpunit/php-code-coverage</code> , pas le package d'origine soit connect√©, mais le fork): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout -b useFork composer.phar config repositories.phpunit/php-code-coverage vcs https://github.com/mougrim/php-code-coverage.git</code> </pre> </li><li>  Changez la version de la d√©pendance en brunch: <br><pre> <code class="bash hljs">composer.phar require phpunit/php-code-coverage <span class="hljs-string"><span class="hljs-string">'dev-7.0.8-myFix'</span></span></code> </pre> </li></ol><br><p>  Mais en fait, c'est encore plus compliqu√©: Composer dit que l'installation est impossible, car <code>phpunit/phpunit</code> n√©cessite la version de <code>phpunit/php-code-coverage</code> <code>^7.0.7</code> , et pour notre projet n√©cessite <code>dev-7.0.8-myFix</code> : </p><br><pre> <code class="plaintext hljs">$ composer.phar require phpunit/php-code-coverage 'dev-7.0.8-myFix' ./composer.json has been updated Loading composer repositories with package information Updating dependencies (including require-dev) Your requirements could not be resolved to an installable set of packages. Problem 1 - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - phpunit/phpunit 8.4.2 requires phpunit/php-code-coverage ^7.0.7 -&gt; satisfiable by phpunit/php-code-coverage[7.0.x-dev]. - Can only install one of: phpunit/php-code-coverage[7.0.x-dev, dev-7.0.8-myFix]. - Installation request for phpunit/php-code-coverage dev-7.0.8-myFix -&gt; satisfiable by phpunit/php-code-coverage[dev-7.0.8-myFix]. - Installation request for phpunit/phpunit ^8.4.2 -&gt; satisfiable by phpunit/phpunit[8.4.2]. Installation failed, reverting ./composer.json to its original content.</code> </pre> <br><p>  Que faire √† ce sujet?  Il y a quatre options: </p><br><ol><li>  En plus du <code>phpunit/php-code-coverage</code> , forkez PHPUnit et √©crivez la version <code>dev-7.0.8-myFix</code> pour la d√©pendance <code>phpunit/php-code-coverage</code> .  Ce chemin est plut√¥t compliqu√© en termes de support et plus il est compliqu√©, plus les biblioth√®ques d√©pendent de la <code>phpunit/php-code-coverage</code> . </li><li>  Utilisez un <a href="">alias</a> lors de la connexion de <code>phpunit/php-code-coverage</code> .  Mais les alias ne sont pas extraits des d√©pendances, ce qui signifie qu'ils devront toujours √™tre √©crits manuellement. </li><li>  Faites une <code>phpunit/php-code-coverage</code> dans votre fork afin que la balise <code>7.0.8</code> √† un autre commit.  Ce n'est au moins pas √©vident, mais au maximum - dans Git, il n'est pas pratique de travailler avec des balises qui font r√©f√©rence √† diff√©rentes validations avec le m√™me nom dans diff√©rents r√©f√©rentiels distants. </li><li>  Dans votre fork <code>phpunit/php-code-coverage</code> utilisez la balise alpha release, par exemple <code>7.0.8-a+myFix</code> (il peut y avoir des collisions avec les versions alpha de la biblioth√®que source). </li></ol><br><p>  Toutes les options ont leurs inconv√©nients.  J'ai √©galement essay√© d'utiliser une balise comme <code>7.0.8.1</code> , mais Composer n'accepte pas de telles balises. </p><br><p>  Les deuxi√®me et quatri√®me options semblent le moindre des maux.  Par le nombre d'actions, ils sont approximativement les m√™mes, dans cet article, nous n'en consid√©rerons qu'une - la quatri√®me.  Cr√©ez une balise de version alpha: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-code-coverage git tag 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix git push origin 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example composer.phar require phpunit/php-code-coverage <span class="hljs-string"><span class="hljs-string">'7.0.8-a+myFix'</span></span> git add composer.json git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use fork'</span></span> git push -u origin useFork</code> </pre> <br><p>  Supposons que nous voulons utiliser notre biblioth√®que <code>mougrim/php-composer-patches-example</code> dans un projet qui d√©pend de <code>phpunit/phpunit</code> .  Ici, on ne peut pas se passer du chamanisme, vous devrez √† nouveau sp√©cifier le r√©f√©rentiel <code>https://github.com/mougrim/php-code-coverage.git</code> pour <code>phpunit/php-code-coverage</code> , ainsi qu'indiquer explicitement la d√©pendance vis-√†-vis de <code>phpunit/php-code-coverage</code> version <code>7.0.8-a+myFix</code> (sinon l'installation <code>7.0.8-a+myFix</code> ): </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project/ composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span> composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar config repositories.phpunit/php-code-coverage vcs https://github.com/mougrim/php-code-coverage.git composer.phar require phpunit/php-code-coverage 7.0.8<span class="hljs-_"><span class="hljs-_">-a</span></span>+myFix composer.phar require mougrim/php-composer-patches-example dev-useFork</code> </pre> <br><p>  Veuillez noter que php-composer-patches-example est connect√© en tant que r√©f√©rentiel, car ce r√©f√©rentiel n'est qu'un exemple et n'a donc pas √©t√© ajout√© √† Packagist.  Dans votre cas, cette √©tape sera probablement ignor√©e. </p><br><p>  Pour r√©sumer l'utilisation des fourches. </p><br><p>  Les avantages de cette approche: </p><br><ul><li>  Pas besoin d'installer des plugins pour Composer. </li></ul><br><p>  Inconv√©nients de cette approche: </p><br><ul><li>  si vous utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>roave/security-advisories</code></a> , vous ne verrez pas d'informations indiquant que la version de la d√©pendance que vous avez cr√©√©e et modifi√©e contient une vuln√©rabilit√©; </li><li>  quand une nouvelle version de la d√©pendance sort, l'histoire de fork devra √™tre r√©p√©t√©e √† nouveau; </li><li>  si vous voulez corriger une d√©pendance de d√©pendance, comme dans l'exemple consid√©r√©, alors <code>dev-*</code> ne fonctionnera pas pour cela et vous devez chamaniser avec les versions ou fork pour les d√©pendances conflictuelles; </li><li>  s'il existe des projets qui d√©pendent de votre biblioth√®que, vous n'aurez pas √† installer la biblioth√®que dans le projet de la mani√®re la plus √©vidente et la plus pratique; </li><li>  s'il y a des projets qui d√©pendent de votre biblioth√®que, pour eux la version <code>phpunit/php-code-coverage</code> sera strictement fix√©e, ce qui n'est pas toujours acceptable; </li><li>  De plus, si les projets des points ci-dessus ont d√©j√† bifurqu√© la couverture de code PHP pour une autre raison, alors tout devient encore plus compliqu√©. </li></ul><br><p>  Je pense que vous avez d√©j√† r√©alis√© que la d√©pendance √† la fourche n'est pas une si bonne id√©e. </p><br><h2 id="ispolzovanie-cweaganscomposer-patches">  Utilisation de cweagans / composer-patches </h2><br><p>  Une fois de plus √©prouvant de la douleur et de la souffrance en utilisant des fourches, je suis tomb√© sur des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>cweagans/composer-patches</code></a> dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PHP Digest n ¬∞ 101</a> (au fait, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">pronskiy a un</a> blog utile, je recommande de vous abonner).  Il s'agit d'un plugin pour omposer, qui vous permet d'appliquer des correctifs aux d√©pendances.  Apr√®s avoir lu la description, j'ai pens√© que c'est exactement ce dont vous avez besoin. </p><br><p>  Comment utiliser cweagans / composer-patches: </p><br><ol><li>  Cloner la couverture du code PHP: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-code-coverage git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:sebastianbergmann/php-code-coverage.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-code-coverage</code> </pre> </li><li>  Acc√©dez √† la version que nous voulons corriger: <br><pre> <code class="bash hljs">git checkout 7.0.8</code> </pre> </li><li>  Nous apportons les modifications n√©cessaires. </li><li>  Cr√©ez un patch: <br><pre> <code class="bash hljs">mkdir -p ../php-composer-patches-example/patches/phpunit/php-code-coverage git diff HEAD &gt; ../php-composer-patches-example/patches/phpunit/php-code-coverage/myFix.patch</code> </pre> </li><li>  Dans notre projet, nous connectons des <code>cweagans/composer-patches</code> : <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout master composer.phar update git checkout -b cweagansComposerPatches composer.phar require cweagans/composer-patches <span class="hljs-string"><span class="hljs-string">'^1.6.7'</span></span></code> </pre> </li><li>  Pour configurer <code>cweagans/composer-patches</code> ajoutez ce qui suit √† <code>composer.json</code> (vous pouvez sp√©cifier plusieurs correctifs pour un package): <br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"preferred-install"</span></span>: <span class="hljs-string"><span class="hljs-string">"source"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"patches"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"phpunit/php-code-coverage"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"My fix description"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix.patch"</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"enable-patching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> </li><li>  Mettre √† jour les d√©pendances: <br><pre> <code class="bash hljs">composer.phar update</code> </pre> </li><li>  Si quelque chose s'est mal pass√©, cela peut √™tre vu dans la sortie de la commande pr√©c√©dente, mais juste au cas o√π, vous pouvez v√©rifier que nos modifications ont √©t√© appliqu√©es: <br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> </li><li>  Validez et poussez le r√©sultat: <br><pre> <code class="bash hljs">git add composer.json patches/phpunit/php-code-coverage/myFix.patch git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use cweagans/composer-patches'</span></span> git push -u origin cweagansComposerPatches</code> </pre> </li></ol><br><p>  Nous nous assurons que lors de l'installation de notre biblioth√®que dans le projet, le patch s'appliquera √©galement. </p><br><p>  Cr√©ez un projet: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-project mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span></code> </pre> <br><p>  Ajoutez les lignes suivantes √† <code>composer.json</code> : </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"enable-patching"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> <br><p>  Installez <code>mougrim/php-composer-patches-example</code> : </p><br><pre> <code class="bash hljs">composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar require mougrim/php-composer-patches-example dev-cweagansComposerPatches</code> </pre> <br><p>  Il semblerait que lors de la connexion du package, il aurait d√ª y avoir une tentative d'application du correctif, mais non. <br>  Nous mettons √† jour les packages pour que le patch s'applique, mais cela ne se produit pas: </p><br><pre> <code class="plaintext hljs">$ composer.phar update Removing package phpunit/php-code-coverage so that it can be re-installed and re-patched. - Removing phpunit/php-code-coverage (7.0.8) Loading composer repositories with package information Updating dependencies (including require-dev) Package operations: 1 install, 0 updates, 0 removals No patches supplied. Gathering patches for dependencies. This might take a minute. - Installing phpunit/php-code-coverage (7.0.8): Loading from cache - Applying patches for phpunit/php-code-coverage patches/phpunit/php-code-coverage/myFix.patch (My fix description) Could not apply patch! Skipping. The error was: The "patches/phpunit/php-code-coverage/myFix.patch" file could not be downloaded: failed to open stream: No such file or directory Writing lock file Generating autoload files</code> </pre> <br><p>  Apr√®s avoir fouill√© dans un outil de suivi des bogues, j'ai trouv√© qu'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">correctif bas√© sur</a> un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fichier n'√©tait pas r√©solu dans le</a> bogue des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©pendances</a> .  Il s'av√®re que vous devez soit sp√©cifier l'URL avant le correctif (ce qui signifie le t√©l√©charger quelque part), soit sp√©cifier le chemin d'acc√®s au correctif manuellement dans chaque projet o√π vous installez une d√©pendance qui n√©cessite des correctifs. </p><br><p>  Pour r√©sumer l'utilisation des <code>cweagans/composer-patches</code> . </p><br><p>  Les avantages de cette approche: </p><br><ul><li>  le plugin a une communaut√©; </li><li>  <code>roave/security-advisories</code> ne cessera pas de fonctionner; </li><li>  lorsqu'une nouvelle version de la d√©pendance est publi√©e, si le correctif est appliqu√© avec succ√®s, il suffira de s'assurer que tout fonctionne avec la nouvelle version (pour les versions mineures, avec une forte probabilit√© que cela fonctionne tout seul, pour les versions majeures, il est √©galement probable que rien ne sera fait); </li><li>  s'il y a des projets qui d√©pendent de votre biblioth√®que, pour eux la version de <code>phpunit/php-code-coverage</code> ne sera pas strictement fix√©e; </li><li>  De plus, dans le cas du paragraphe ci-dessus, un tel projet pourra appliquer ses correctifs en PHP Code Coverage. </li></ul><br><p>  Inconv√©nients: </p><br><ul><li>  Il s'agit d'un plugin pour Composer, ce qui signifie que lors de la mise √† jour de Composer, il peut se casser; </li><li>  <code>enable-patching=true</code> doit √™tre sp√©cifi√© pour que les correctifs soient appliqu√©s √† partir des d√©pendances; </li><li>  le principal responsable du projet n'a pas beaucoup de temps pour le traiter, par cons√©quent, en r√®gle g√©n√©rale, il accepte les demandes de tirage, mais ne d√©veloppe pas particuli√®rement le projet (par exemple, il avait des id√©es pour la deuxi√®me version de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t√¢che</a> , mais peu de choses ont chang√© apr√®s trois ans); </li><li>  il y a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">correctif bas√© sur</a> un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fichier qui n'est pas r√©solu dans le</a> bogue des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©pendances</a> , ce qui n'est pas pratique et est suspendu dans le backlog depuis trois ans maintenant; </li><li>  Vous ne pouvez pas utiliser diff√©rents correctifs pour diff√©rentes versions de d√©pendances. </li></ul><br><p>  Le dernier point est devenu un obstacle pour moi.  J'ai d'abord fait une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">demande de fonctionnalit√©</a> .  Le responsable a √©crit qu'il ne voulait pas ajouter cette fonctionnalit√© au code principal, mais dans la deuxi√®me version, il serait possible d'√©crire un plug-in (oui, un plug-in pour le plug-in pour Composer).  Les perspectives pour la deuxi√®me version √©taient vagues, j'ai donc d√©cid√© de chercher des alternatives.  Parmi la petite liste, je n'ai pas trouv√© de plugin qui serait pris en charge. </p><br><p>  Je ne voulais pas entrer dans le code du plugin, j'ai donc d√©cid√© de bifurquer les fourches - c'est s√ªr, quelqu'un avait d√©j√† rencontr√© le probl√®me et l'avait r√©solu. </p><br><h2 id="ispolzovanie-vaimo-composer-patches">  Utilisation des correctifs Vaimo Composer </h2><br><p>  Dans la plupart des fourches, il n'y avait aucune diff√©rence par rapport √† l'original (pourquoi fourche-t-on m√™me?).  Une partie des fourches a √©t√© cr√©√©e pour les demandes de tirage, qui ont d√©j√† √©t√© fusionn√©es avec la biblioth√®que principale.  Cependant, il y avait un candidat int√©ressant qui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©solvait</a> mon probl√®me - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vaimo Composer Patches</a> .  √Ä cette √©poque, il √©tait toujours d√©fini comme une fourchette, mais son responsable, semble-t-il, n'allait pas faire de demandes de tirage.  Entre autres choses, par exemple, il a d√©j√† chang√© le nom du package en <code>vaimo/composer-patches</code> .  Mais il y avait un probl√®me: les probl√®mes √©taient d√©sactiv√©s, c'est-√†-dire qu'il n'y avait aucun retour de l'auteur.  De plus, le plugin n'√©tait pas h√©berg√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Packagist</a> . </p><br><p>  Une telle bonne fourche ne doit pas √™tre perdue dans un tas d'autres fourches inutiles.  Par cons√©quent, j'ai contact√© l'auteur pour lui demander d'activer les probl√®mes et d'ajouter un package √† Packagist.  Apr√®s presque un mois, l'auteur a r√©pondu et a fait tout cela.  :) </p><br><p>  L'utilisation de <code>vaimo/composer-patches</code> pas diff√©rente de l'utilisation du plugin pr√©c√©dent, mais vous pouvez sp√©cifier diff√©rents patchs pour diff√©rentes versions. </p><br><ol><li>  Nous faisons reculer notre biblioth√®que (la suppression du dossier <code>vendor</code> est n√©cessaire, car les plugins <code>cweagans/composer-patches</code> et <code>vaimo/composer-patches</code> ne <code>vaimo/composer-patches</code> pas tr√®s compatibles entre eux): <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout master rm -rf vendor/ composer.phar update</code> </pre> </li><li>  Nous r√©alisons les points 1-4 de la section pr√©c√©dente. </li><li>  Dans notre projet, nous connectons des <code>vaimo/composer-patches</code> : <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../php-composer-patches-example git checkout -b vaimoComposerPatches composer.phar require vaimo/composer-patches <span class="hljs-string"><span class="hljs-string">'^4.20.2'</span></span></code> </pre> </li><li>  Pour configurer <code>vaimo/composer-patches</code> ajoutez ce qui suit √† <code>composer.json</code> (la documentation peut √™tre consult√©e <a href="">ici</a> ): <br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"patches"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"phpunit/php-code-coverage"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"My fix description"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"&lt; 7.0.0"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix-leagcy.patch"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"&gt;= 7.0.0"</span></span>: <span class="hljs-string"><span class="hljs-string">"patches/phpunit/php-code-coverage/myFix.patch"</span></span> } } } } }</code> </pre> </li><li>  Mettre √† jour les d√©pendances: <br><pre> <code class="bash hljs">composer.phar update</code> </pre> </li><li>  Si quelque chose s'est mal pass√©, cela peut √™tre vu dans la sortie de la commande pr√©c√©dente, mais juste au cas o√π, vous pouvez vous assurer que nos modifications sont appliqu√©es: <br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> </li><li>  Validez et poussez le r√©sultat: <br><pre> <code class="bash hljs">git add composer.json patches/phpunit/php-code-coverage/myFix.patch git commit --gpg-sign --message=<span class="hljs-string"><span class="hljs-string">'Use vaimo/composer-patches'</span></span> git push -u origin vaimoComposerPatches</code> </pre> </li></ol><br><p>  Nous nous assurons que lors de l'installation de notre biblioth√®que dans le projet, le patch s'appliquera √©galement. </p><br><p>  Cr√©ez un projet et installez <code>mougrim/php-composer-patches-example</code> : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../ rm -rf php-project mkdir php-project <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> php-project composer.phar require phpunit/phpunit <span class="hljs-string"><span class="hljs-string">'^8.4.2'</span></span> composer.phar config repositories.mougrim/php-composer-patches-example vcs https://github.com/mougrim/php-composer-patches-example.git composer.phar require mougrim/php-composer-patches-example dev-vaimoComposerPatches</code> </pre> <br><p>  Au cas o√π, vous pouvez vous assurer que nos modifications ont √©t√© appliqu√©es: </p><br><pre> <code class="plaintext hljs">$ grep example vendor/phpunit/php-code-coverage/src/CodeCoverage.php // for example some changes here</code> </pre> <br><p>  Pour r√©sumer l'utilisation des <code>vaimo/composer-patches</code> . </p><br><p>  Les avantages de ce plugin sont presque les m√™mes que les pr√©c√©dents, mais incluent √©galement les suivants: </p><br><ul><li>  le responsable d√©veloppe activement le plugin et a d√©j√† publi√© la quatri√®me version majeure; </li><li>  il n'est pas n√©cessaire de prescrire quoi que ce soit de plus pour que les correctifs des d√©pendances soient appliqu√©s; </li><li>  Vous pouvez utiliser diff√©rents correctifs pour diff√©rentes versions de d√©pendances; </li><li>  le plugin a beaucoup de param√®tres, donc si la fonctionnalit√© d√©crite dans l'article ne vous suffit pas, alors regardez la documentation - peut-√™tre que la fonctionnalit√© dont vous avez besoin est d√©j√† impl√©ment√©e. </li></ul><br><p>  Inconv√©nients: </p><br><ul><li>  comme le pr√©c√©dent, il s'agit d'un plugin pour Composer, ce qui signifie que lors de la mise √† jour de Composer, il peut se casser; </li><li>  contrairement au plugin pr√©c√©dent, cette communaut√© en a moins. </li></ul><br><h2 id="vyvody">  Conclusions </h2><br><p>  Pour r√©sumer les r√©sultats g√©n√©raux: </p><br><ul><li>  l'utilisation de fourchettes de package pour des correctifs mineurs n'est pas pratique; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>cweagans/composer-patches</code></a> est un bon plugin, mais se d√©veloppe mal, donc je ne le recommande pas; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vaimo Composer Patches</a> est un excellent plugin qui r√©sout bien le probl√®me de la correction des d√©pendances, et a √©galement un tas de param√®tres </li><li>  Vaimo Composer Patches a une petite communaut√©, mais j'esp√®re que cet article va l'augmenter; </li><li>  si de nombreuses modifications sont n√©cessaires dans la d√©pendance, il peut √™tre plus facile de recourir √† un hard fork (garder le fork ind√©pendant de la d√©pendance d'origine). </li></ul><br><p>  J'ai √©galement fait une conclusion indirecte: si une sorte de d√©pendance ne fournit pas la fonctionnalit√© n√©cessaire, il peut y avoir des fourches qui ont impl√©ment√© cette fonctionnalit√© et encore plus. </p><br><p>  Chez Badoo, nous utilisons les patchs Vaimo Composer dans deux cas: </p><br><ul><li>  dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SoftMocks</a> pour patcher PHPUnit et PHP Code Coverage; </li><li>  dans le r√©f√©rentiel interne du correctif Webmozart Assert pour la compatibilit√© avec SoftMocks en tant que correctif temporaire (alors que SoftMocks ne prend pas en charge les constructions <code>array_map(array('static', 'valueToString')</code> ). </li></ul><br><p>  Rinat Akhmadeev, Sr.  D√©veloppeur PHP </p><br><p>  <strong>UPD1</strong> : Merci <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">BoShurik</a> pour le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> vers les <a href="">alias</a> .  Ajout d'un point sur les alias √† l'article. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473654/">https://habr.com/ru/post/fr473654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473640/index.html">Coucher de soleil Big Data</a></li>
<li><a href="../fr473642/index.html">Cribble Crabble Gradle: Auto-Build Magic</a></li>
<li><a href="../fr473646/index.html">Hackathon dans une petite entreprise: comment organiser sans vider un train de ressources</a></li>
<li><a href="../fr473648/index.html">Le cheval est mort - Cri: transition du tslint au eslint</a></li>
<li><a href="../fr473652/index.html">Cr√©ation d'une API REST avec Node.js et une base de donn√©es Oracle. Partie 5</a></li>
<li><a href="../fr473656/index.html">Exp√©rience de g√©n√©rateur de site statique Hugo</a></li>
<li><a href="../fr473658/index.html">G√©rer les bogues dans Go 1.13</a></li>
<li><a href="../fr473660/index.html">Arcade Reverse Engineering: Record Michael Jordan au NBA Jam</a></li>
<li><a href="../fr473664/index.html">Exp√©rience d'apprentissage de premi√®re main. Yandex.Practicum - Analyste de donn√©es</a></li>
<li><a href="../fr473666/index.html">En tant qu'√©crivain de science-fiction, Arthur Clark a presque ferm√© la revue Tech - Youth</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>