<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🤝‍👨🏽 😙 🆙 Mais l'essence est quelque chose, ou minimiser le code source est plus facile qu'il n'y paraît. ✨ 📂 🛷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En ces merveilleux jours de janvier, nous sommes tous, bien sûr, préoccupés par la question de minimiser le code source tout en préservant l'invariant...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mais l'essence est quelque chose, ou minimiser le code source est plus facile qu'il n'y paraît.</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482634/"><img src="https://habrastorage.org/webt/ls/g9/gy/lsg9gy2nbzs5m0redadf6s3sqjc.png"><br><p>  En ces merveilleux jours de janvier, nous sommes tous, bien sûr, préoccupés par la question de minimiser le code source tout en préservant l'invariant.  Je veux dire, je m'en fous?!?  En vain ... Ici le compilateur est tombé, et le programme est gigantesque - il est en quelque sorte gênant pour les développeurs d'envoyer une telle chose.  Et puis le plaisir commence: que faire si vous le jetez?  Oh, ça ne tombe pas - d'accord, on le laisse, mais si c'est le cas?  - plante toujours, et ceci, et ceci, et cela ... Oh, j'ai démarré le compilateur sur les anciennes sources. </p><br><p>  Dans le même temps, l'automatisation de la recherche de bugs est une question de vie: git bisect, llvm-bugpoint, creduce, ... Dans cet article je décrirai encore une autre façon de résoudre le problème de la simplification du cas de test, plus ou moins universel par rapport au langage de programmation, et en montrerai quelques uns exemples d'utilisation. </p><a name="habracut"></a><br><p> Universel, disons ... Peut-être, bien sûr, il a déjà été mis en œuvre dix fois, mais cela arrêterait-il un cycliste aguerri.  <em>Et quand entre les mains d'un microscope, tous les problèmes semblent être des clous.</em>  Dans le rôle d'un microscope - <a href="https://pmd.github.io/" rel="nofollow">PMD</a> . </p><br><p>  En général, il existe un tel langage pour écrire des modèles décrits par des équations différentielles - Modelica.  Il est assez avancé, il y a une implémentation ouverte très cool et en général.  Mais il y a un petit problème: parfois une erreur de compilation interne se produit dans le compilateur.  Dans un <a href="https://habr.com/ru/post/474920/">article précédent,</a> j'ai déjà montré comment ajouter la prise en charge de Modela à l'analyseur statique PMD (en passant, certaines de mes erreurs sont apparues lors du processus de révision) en plus des dix modules de langage existants.  Alors maintenant, j'ai décidé - à quoi bon disparaître - et j'ai envoyé un outil de preuve de concept Source Code Minimizer, réutilisant les modules de langage PMD existants.  Malheureusement, j'ai été envoyé, mais pas très loin, dans un référentiel voisin: le mentor a déclaré qu'il ne décidait toujours pas de prendre en charge cela jusqu'à la fin du siècle, et qu'il est perdu dans la base de code commune, j'ai donc rapidement trouvé une invitation à collaborer dans ma boîte de réception est fraîchement créé <a href="https://github.com/pmd/pmd-scm" rel="nofollow">pmd / pmd-scm</a> . </p><br><p>  D'abord, quelle est l'énoncé du problème?  Il est nécessaire de réduire la taille du code source, en préservant une partie de ses propriétés.  Plus précisément, je veux </p><br><ul><li>  le code résultant était prévisible <br><ul><li>  il ne doit pas être aussi <strong>minimal que possible</strong> , la «fin de fichier» est autorisée, mais elle ne devrait pas se transformer en tourment </li><li>  l'obfuscation automatique n'est pas envisagée </li></ul></li><li>  le programme minimisé peut être divisé en plusieurs fichiers avec le code source <br><ul><li> par exemple, en Java, chaque classe <code>public</code> doit être dans un fichier séparé avec le nom correct, etc. </li><li>  Je veux que chaque fichier reste visible à la fin </li></ul></li><li>  dans le processus de transformations, l'invariant indiqué doit être conservé </li></ul><br><h2 id="vnutrennee-ustroystvo">  Dispositif interne </h2><br><p>  Dans cette section, je vais décrire grossièrement l'implémentation.  Pour commencer, je constate à nouveau que cette idée, pour le dire en douceur, n'est pas nouvelle.  Et si j'ai cité git bisect simplement comme exemple du «mécanisme de débogage automatique», je suis tombé sur <a href="https://github.com/csmith-project/creduce" rel="nofollow">creduce</a> ou quelque chose de similaire pendant un certain temps (bien que je ne l'ait pas utilisé).  Mais j'ai dû utiliser <a href="https://llvm.org/docs/Bugpoint.html" rel="nofollow">llvm-bugpoint</a> - c'est impressionnant: vous vous asseyez, déboguez votre LLVM Pass, et il - une telle infection - se bloque sur certains systèmes de fichiers.  Donc, vous pouvez compiler ce fichier en code bit LLVM, exécuter <code>opt</code> sur le fichier .bc avec votre plugin et vous assurer qu'il se bloque.  Et puis, grosso modo, je viens de remplacer <code>opt</code> par <code>llvm-bugpoint</code> , et après une minute, j'ai eu un «squelette» lourd d'une des fonctions, consistant en un nuage de blocs de base et de transitions entre eux;  tout sauf les branches a été jeté avec succès.  Soit dit en passant, comme dans mon énoncé du problème, après une douzaine de minutes de simplification manuelle, tout se résume au fait que j'ai mal traité l'un des types de branche, et tout le reste n'était que décor.  En général, l'idée n'est pas nouvelle. </p><br><p>  Et maintenant pour la mise en œuvre.  Puisqu'il était censé être un outil plus ou moins universel, je voulais créer une sorte de framework dans lequel nous pourrions entasser des implémentations optimisées pour différents langages.  En conséquence, deux concepts plutôt orthogonaux se sont démarqués: </p><br><ul><li>  pris en charge invariant </li><li>  stratégie de minimisation </li></ul><br><h2 id="invariant">  Invariant </h2><br><p>  J'ai déjà décrit l'une des options de la propriété que vous souhaitiez enregistrer: «le compilateur a imprimé une phrase sur la console» («Erreur interne du compilateur», par exemple).  En outre, les idées peuvent être glanées à partir d'une variété de fuzzers: <a href="https://github.com/google/AFL" rel="nofollow">AFL</a> , <a href="https://github.com/grimm-co/killerbeez" rel="nofollow">Killerbeez</a> et autres: </p><br><ul><li>  le processus s'est terminé avec du code retour (en particulier, «crash on signal» sous Linux) </li><li>  le processus a pris plus de T millisecondes.  Ici, hélas, une instabilité peut se produire en raison de la charge flottante du système.  Pour une plus grande précision, vous pouvez utiliser le temps CPU, bien que, idéalement, les compteurs de performances soient utiles. </li><li>  le compilateur peut (pas) générer un fichier de sortie </li><li>  ... </li></ul><br><p>  J'ai déjà implémenté certains d'entre eux (code retour, ligne imprimée), d'autres non, certains peuvent être spécifiques à des langues individuelles.  En général, il s'agit d'une partie de la tâche assez autonome, souvent complètement indépendante d'une langue spécifique. </p><br><h2 id="strategiya-minimizacii">  Stratégie de minimisation </h2><br><p>  À première vue, tout ici est purement dépendant de la langue.  Quelque part, vous devez jeter les variables avec les cas d'utilisation, quelque part - pour conserver le même nombre d'équations et d'inconnues.  Il est d'autant plus important d'abstraire cette partie du code.  Mais quelque chose de basique peut être rendu commun pour tout le monde: par exemple, d'un simple mouvement du poignet, le moteur de règles XPath tourne ... tourne ... ... oh, pour XPath version 1.0, ce n'est pas le cas.  Désolé, un petit problème technique - dans un outil universel pour couper les arbres de syntaxe <del>  pour l'hiver </del>  .  En général, l'API de stratégie de minimisation est assez simple: en gros, la fonction a une fonction d'étape (on lui donne une liste des nœuds racine des arbres de syntaxe), qui peut demander "mais essayez de jeter ces branches" via l'interface d'opération.  Si l'invariant est violé, la fonction retourne le contrôle; sinon, elle fait tourner la pile en lançant une exception spéciale, et la version résultante est considérée comme la prochaine approximation.  Un processus est considéré comme terminé si la fonction d'étape a renvoyé le contrôle sans passer par une exception.  Vous pouvez dire que cela est terriblement inefficace - peut-être que oui, <del>  ZATO CONVENIENT !! 111 </del>  , mais de quoi s'agit-il, s'il est censé démarrer régulièrement le processus de compilation externe des centaines de fois dans un cycle. </p><br><p>  Cela soulève la question: comment récupérer la source de l'AST aminci?  Bien sûr, vous pouvez essayer d'écrire un code spécial pour chaque langue qui génère un fichier texte.  Mais, comme vous le savez, un programmeur doit être paresseux.  Donc ça ne marchera pas - ce n'est déjà clairement pas de la série "ramassé les implémentations existantes et c'est parti."  Heureusement, dans les nœuds de l'arborescence, il y a des informations sur les lignes et colonnes de début et de fin pour ce nœud - cela signifie que si le module de langue indique correctement ces informations, vous pouvez prendre le texte source et en découper soigneusement des morceaux (d'où, d'ailleurs, et quelques difficultés d'obscurcissement: il ne suffit pas de jeter quelque chose, mais vous devez le remplacer: des identifiants, par exemple).  Soit dit en passant, dans la base de code PMD, nous avons même trouvé une classe pour éditer un fichier en utilisant des opérations de coupe de texte sans intersection (ainsi que l'ajout, mais ce n'est pas si intéressant pour cette tâche particulière). </p><br><h2 id="teoriya-itog">  Théorie: Résumé </h2><br><p>  Pour le moment, j'ai mis en œuvre deux stratégies.  L'un d'eux est le découpage XPath, qui est, dans un sens, un cas dégénéré, car il écrit de force le résultat, même s'il ne s'agit plus d'une source syntaxiquement correcte.  Le second est déjà «honnête» itératif et interactif (dans le sens où il interagit vraiment avec le compilateur et vérifie l'invariant): il essaie juste de lancer les branches une par une en boucle.  En voici un peu plus: </p><br><ul><li>  en principe, la vérification de l'invariant pour la source, qui n'est pas analysée, n'a guère de sens pour une stratégie "honnête": même si le compilateur survit à cela, le minimiseur devra redémarrer la source.  Par conséquent, il est logique de jeter les fichiers «cassés» à l'avance: l'analyse dans votre processus est plus rapide que l'exécution de tout le compilateur </li><li>  dans le cas général, il serait probablement pratique d'utiliser des coroutines ici (enfin, ou de retourner le flux de contrôle à l'envers), mais comme c'est loin d'être la partie la plus difficile du calcul, à chaque étape de la fonction d'étape, je me contente de marcher autour de l'arbre, en comptant la distance hauts.  Je me souviens seulement du comptoir.  Donc, au début, je pensais que le sommet est plus grand, le sommet est moins - quelle différence cela fait-il, heuristique quand même!  Il s'est avéré que l'erreur par unité peut parfois modifier le taux de «convergence».  En substance, c'est logique: jeter des fonctions entières de la classe dans l'ordre sera souvent une stratégie efficace.  Mais pour sauter un peu, et chaque fois <strong>pour aller à l'intérieur de la</strong> fonction, dans la plupart des cas n'ayant rien à voir avec le problème, cela ressemble à une idée comme ça. </li><li>  par ailleurs sur les coroutines et le déploiement du flux de contrôle: il y aurait des problèmes avec cela, car après le redémarrage du texte modifié, l'AST peut ne pas changer de manière très évidente (c'est-à-dire non seulement ces branches seront rejetées, mais quelque part les nœuds vides disparaîtront, quelque part généralement l'analyse va dans l'autre sens).  Sans oublier que les nœuds de la nouvelle AST ne seront pas identiques par référence aux anciens, et la correspondance logique par <code>equals</code> - ressemble également à une tâche difficile </li><li>  en principe, vous pouvez utiliser les capacités de PMD à des degrés divers: vous pouvez utiliser des types calculés, des dépendances de définition-utilisation, etc.  et faites quelque chose de très intelligent (mais vous devez envisager une API universelle).  En revanche, pour la stratégie décrite, il suffit d'obtenir un arbre d'analyse.  Et ici, vous pouvez même <a href="https://github.com/kaitai-io/kaitai_struct" rel="nofollow">accrocher</a> du <a href="https://github.com/kaitai-io/kaitai_struct" rel="nofollow">Kaitai Struct</a> et essayer de pousser <a href="https://github.com/google/AFL" rel="nofollow">afl-tmin</a> pour minimiser les fichiers binaires :) </li></ul><br><h2 id="praktika">  Pratique </h2><br><p>  Pour commencer, construisons un minimiseur: </p><br><pre> <code class="plaintext hljs">git clone https://github.com/pmd/pmd-scm.git cd pmd-scm ./mvnw clean verify unzip pmd-scm-dist/target/pmd-scm-bin-1.0.0-SNAPSHOT.zip</code> </pre> <br><p>  Maintenant, vous avez besoin d'une source.  Prenons <a href="" rel="nofollow">GreedyStrategy.java</a> par exemple. </p><br><p>  À l'aide de <a href="https://github.com/pmd/pmd-designer" rel="nofollow">Rule Designer,</a> découvrez à quoi ressemble un AST typique pour Java et exécutez </p><br><pre> <code class="plaintext hljs">$ ./bin/run.sh scm --language java \ --input-file ../pmd-scm/src/main/java/net/sourceforge/pmd/scm/strategies/GreedyStrategy.java \ --output-file GreedyStrategy-min.java \ --strategy xpath \ --xpath-expression '//BlockStatement[count(../BlockStatement) &gt; 1]' Original file(s): 6155 bytes, 1099 nodes. After initial white-space cleanup: size 4548 bytes (73%), 1099 nodes (100%) After pass #1: size 1984 bytes (32%), 1099 nodes (100%) After final white-space cleanup: size 1984 bytes (32%), 325 nodes (29%) After blank line clean up: size 1767 bytes (28%), 325 nodes (29%)</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> net.sourceforge.pmd.scm.strategies; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashSet; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Set; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> net.sourceforge.pmd.lang.ast.Node; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GreedyStrategy</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractMinimizationStrategy</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Configuration</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MinimizationStrategy </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createStrategy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GreedyStrategy(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MinimizationStrategyConfigurationFactory FACTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AbstractFactory(<span class="hljs-string"><span class="hljs-string">"greedy"</span></span>) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MinimizationStrategyConfiguration </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(); } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GreedyStrategy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Configuration configuration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(configuration); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;Node, HashSet&lt;Node&gt;&gt; directlyDependingNodes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;Node, Set&lt;Node&gt;&gt; transitivelyDependingNodes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchDirectDependentsFromSubtree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Node node)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// process depending nodes } private Set&lt;Node&gt; indirectlyDependentNodesFor(Node currentNode) { } private void collectNodesToRemove(Set&lt;Node&gt; result, Node node) { } private int previousPosition = 0; private int positionCountdown; private void findNodeToRemove(Node currentNode) throws Exception { } private void processSingleRoot(Node currentRoot) throws Exception { // cannot remove root for (int i = 0; i &lt; currentRoot.jjtGetNumChildren(); ++i) { findNodeToRemove(currentRoot.jjtGetChild(i)); } } @Override public void performSinglePass(List&lt;Node&gt; roots) throws Exception { } }</span></span></code> </pre> <br><p>  Autrement dit, nous avons vidé toutes les fonctions <em>contenant directement plus d'une instruction</em> .  Cependant, la suppression des commentaires, des lignes vides, etc.  Je ne l'ai pas précisé - après tout, est-ce (jusqu'à présent?) Principalement un outil de <strong>débogage des compilateurs</strong> , plutôt que de créer de belles descriptions d'interface. </p><br><p>  Regardons quelque chose de plus intéressant maintenant: essayez de minimiser deux fichiers avec les commentaires du compilateur en même temps: </p><br><p>  <strong>orig / TestResource.java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(<span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unused</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// unused } }</span></span></code> </pre> <br><p>  <strong>orig / Main.java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ String str = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestResource().func(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span>; } }</code> </pre> <br><p>  Comme vous pouvez le voir, ils ne compilent pas: </p><br><pre> <code class="plaintext hljs">$ javac orig/TestResource.java orig/Main.java orig/Main.java:3: error: incompatible types: int cannot be converted to String String str = new TestResource().func(); ^ orig/Main.java:5: error: incompatible types: unexpected return value return 123; ^ 2 errors</code> </pre> <br><p>  Imaginons que quelque chose ne va pas avec la première erreur, et essayons de faire un exemple minimal qui produit </p><br><pre> <code class="plaintext hljs">error: incompatible types: int cannot be converted to String</code> </pre> <br><p>  Pour ce faire, exécutez </p><br><pre> <code class="plaintext hljs">$ bin/run.sh scm --language java \ --input-file orig/TestResource.java orig/Main.java \ --output-file TestResource.java Main.java \ --invariant message \ --printed-message "error: incompatible types: int cannot be converted to String"\ --command-line "javac TestResource.java Main.java" \ --strategy greedy Original file(s): 290 bytes, 77 nodes. After initial white-space cleanup: size 258 bytes (88%), 77 nodes (100%) After pass #1: size 255 bytes (87%), 64 nodes (83%) After pass #2: size 244 bytes (84%), 57 nodes (74%) After pass #3: size 205 bytes (70%), 51 nodes (66%) After pass #4: size 192 bytes (66%), 46 nodes (59%) After pass #5: size 181 bytes (62%), 39 nodes (50%) After pass #6: size 179 bytes (61%), 39 nodes (50%) After final white-space cleanup: size 149 bytes (51%), 39 nodes (50%) After blank line clean up: size 147 bytes (50%), 39 nodes (50%)</code> </pre> <br><p>  En conséquence, nous obtenons </p><br><p>  <strong>TestResource.java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestResource</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  <strong>Main.java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String str = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestResource().func(); } }</code> </pre> <br><pre> <code class="plaintext hljs">$ javac TestResource.java Main.java TestResource.java:3: error: missing return statement } ^ Main.java:3: error: incompatible types: int cannot be converted to String String str = new TestResource().func(); ^ 2 errors</code> </pre> <br><p>  Tout comme commandé! </p><br><h2 id="itog">  Résumé </h2><br><p>  Jusqu'à présent, le projet est à un stade assez précoce, mais il y a déjà quelque chose à démontrer.  À l'avenir, il y a des idées pour créer une API pour les dépendances d'indication de langue entre les nœuds AST, afin de permettre de fournir des stratégies spécifiques au langage.  Il serait également intéressant de créer une stratégie universelle qui exécute le script Groovy / Kotlin / autre chose - après tout, les gens qui utilisent Java ne l'ont peut-être jamais vu, mais ils connaissent parfaitement bien, par exemple, Modelika, et ont dans leur tête leurs moyens avancés pour presser la source. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482634/">https://habr.com/ru/post/fr482634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482614/index.html">L'utilisation de BSP dans Doom est-elle vraiment une initiative ingénieuse?</a></li>
<li><a href="../fr482620/index.html">Slurm: Habr, bonnes vacances ...</a></li>
<li><a href="../fr482622/index.html">Simulation de courir sous la pluie</a></li>
<li><a href="../fr482626/index.html">Surveillance des applications avec Logger.Backends</a></li>
<li><a href="../fr482628/index.html">Regardez "Little Green Spider of Time"</a></li>
<li><a href="../fr482636/index.html">Expérience d'admission dans une magistrature en Allemagne (analyse détaillée)</a></li>
<li><a href="../fr482642/index.html">OSCD: Sprint Detection Sprint # 1, résultats</a></li>
<li><a href="../fr482644/index.html">Enregistreur de frappe pour Windows avec changement de droits dans DACL</a></li>
<li><a href="../fr482646/index.html">Améliorez les performances du SPA en divisant vos bibliothèques angulaires en plusieurs parties</a></li>
<li><a href="../fr482648/index.html">Arthur Khachuyan: «Du vrai Big Data dans la publicité»</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>