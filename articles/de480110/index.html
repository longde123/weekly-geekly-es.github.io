<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧤 🚳 🗝️ uMCPIno: Schreiben eines einfachen Protokolls mit garantierter Zustellung für Arduino 🖐️ 👩🏼‍💼 🛴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Grüße, meine Lieben! 
 Irgendwann in ihrem Leben hört jede hartnäckige DIY-Box auf, den Kantian Arduino als „Dinge an sich“ zu verpassen, die sie einf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>uMCPIno: Schreiben eines einfachen Protokolls mit garantierter Zustellung für Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480110/"><h3>  Grüße, meine Lieben! </h3><br>  Irgendwann in ihrem Leben hört jede hartnäckige DIY-Box auf, den Kantian Arduino als „Dinge an sich“ zu verpassen, die <s>sie einfach nicht können!</s>  : Das Blinken der LED, das Übertragen von Daten von den Sensoren über das Kabel zum PC macht sicherlich Spaß, aber der heilige Gral ist in der Mobilität, in der Befreiung von den „Kupferbindungen“, in der wahren Freiheit unter den Wellen des universellen Äthers. <br>  Hier eröffnet sich uns die harte Realität von instabilen Kommunikationskanälen, Übertragungsfehlern und nicht zugestellten Nachrichten. <br>  Gott verbietet es, auf diesem Gebiet Originalität zu behaupten: Die Menschheit hat lange Zeit eine ganze Reihe von Protokollen für alle Gelegenheiten verwendet. <br>  Aber unser Ziel ist es zu lernen, und da ich ein begeisterter Unterstützer der Aufklärung im Kampf bin, werden wir unser eigenes Protokoll „Fahrrad“ erfinden. <br>  Heute schlage ich vor, ein Protokoll zu entwickeln, das die garantierte Zustellung, Integrität und Abfolge von Nachrichten zwischen zwei Teilnehmern (Punkt-zu-Punkt, Punkt-zu-Punkt) gewährleistet, weiß, wie und wendet den <a href="https://en.wikipedia.org/wiki/Nagle%2527s_algorithm" rel="nofollow">Nagle-</a> Algorithmus und das <a href="https://en.wikipedia.org/wiki/Protocol_pipelining" rel="nofollow">Protokoll-Pipelining an</a> , was auch immer dies bedeutet.  Gleichzeitig sollte es einen minimalen <a href="https://en.wikipedia.org/wiki/Overhead_(computing)" rel="nofollow">Overhead haben</a> und sich sogar in den beengten Arduino UNO pressen. <br><br><img src="https://habrastorage.org/webt/jt/7a/_b/jt7a_bc6uynr5uu08ab3plyuucq.png"><br><br>  Ich bitte alle, die sich an Bord dafür interessieren, die Luken zu schließen, die Königssteine ​​zu öffnen, die Ballasttanks zu füllen.  Wir haben einen Ausflug in die Vergangenheit, Ziel: Jahr 1974! <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Für die Ungeduldigen (ich selbst bin so!)</b> <div class="spoiler_text">  Hier ist das Github-Repository, in dem die Implementierungen sind: <br><ul><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/Arduino" rel="nofollow">Für Arduino</a> </li><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/STM32" rel="nofollow">Für STM32</a> </li><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/CSharp" rel="nofollow">Für PC (C #)</a> </li></ul><br></div></div><br>  Nach der guten alten Tradition beschäftigen sich mindestens zwei anerkannte Experten auf diesem Gebiet mit der Beschreibung von kryptografischen Algorithmen und Protokollen. Wenn jemand sie nicht kennt, machen Sie sich mit ihnen bekannt: <br><div class="spoiler">  <b class="spoiler_title">Alice</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/fb4/6f4/f08/fb46f4f081e1affbfba68c39dcbc7768.jpg" alt="Bild"><br></div></div><br>  Und <br><div class="spoiler">  <b class="spoiler_title">Bob</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/048/a75/668/048a75668215c8147df3f5720f283899.jpg" alt="Bild"><br></div></div><br><br><h3>  Zunächst beschreiben wir eine einfache Aufgabe </h3><br>  Alice und Bob sitzen in benachbarten Schützengräben und können ihren Kopf nicht heben, um sich zu sehen.  Sie können nur mit Stimme sprechen, daneben pfeifen Kugeln und Granaten, die ihre Schreie übertönen, und außerdem müssen Sie schreien, wenn einer von ihnen spricht, damit Sie überhaupt nichts hören. <br>  Die Situation wird durch die Tatsache erschwert, dass sie von Feinden belauscht werden - und Sie müssen eine Codesprache verwenden, die aus irgendeinem Grund aus langen Folgen von Zahlen besteht. <br>  Da sowohl Alice als auch Bob Menschen sind, müssen sie regelmäßig zum Essen oder zur Toilette gehen, und sie sind so ungeduldig, dass sie im ungeduldigsten Moment ungeduldig sein können! <br><br><h3>  Wie und warum eine Verbindung herstellen? </h3><br>  Wie können wir in einer so bedrückenden Situation, in der alles zum Scheitern verurteilt zu sein scheint, eine zuverlässige Datenübertragung veranlassen? <br><br>  Die erste Lösung, die in den Sinn kommen kann, besteht darin, <s>Stoppwort-</s> Codephrasen zu verwenden, um die Übertragung zu starten und zu beenden. <br><br>  Sagen wir mal, wenn Alice eine Nachricht senden möchte, muss sie "Beginne die Übertragung!" Rufen und warten, bis Bob mit "Beginne den Empfang!" Antwortet. <br>  Wenn Alice nicht auf Bobs Antwort wartet, wiederholt sie einfach ihre Aufforderung, die Übertragung zu starten.  Natürlich sollten Sie dies nicht zu oft tun, sonst hören Sie, wie wir wissen, nur Bobs Antwort nicht. <br><br>  Großartig.  Aber was passiert, wenn Alice als Antwort vom nächsten Graben hört: "Beginne die Übertragung!"? <br>  Es stellt sich heraus, dass Bob sich auch dazu entschlossen hat, jetzt einige wichtige Informationen zu übertragen.  Alice hat einen milden Charakter und sie hätte denken können: "Okay, ich werde warten, meine Nachricht ist im Prinzip nicht dringend, lass Bob sie zuerst weitergeben."  Sie denkt darüber nach und antwortet: "Beginnen Sie mit dem Empfang!". <br><br>  Da <s>in Kriegszeiten der Sinuswert vier erreichen kann, ist die</s> Schallgeschwindigkeit endlich und es dauert einige Zeit, um zu verstehen, was Alice und Bob gehört haben, und selbst Bob, als Gentleman, kann sich entscheiden, der Dame nachzugeben, zuckt er mit den Schultern und schreit: "Ich fange an zu empfangen!" <br><br>  Um die Empörung zu veranschaulichen, werden wir Zeitdiagramme verwenden.  Die Zeit vergeht auf sie. <br><br>  Der Fall, in dem Alice und Bob sich nicht rechtzeitig einig waren: <br><img src="https://habrastorage.org/webt/cz/ye/hn/czyehnoehw9e3wnxveaiwvef5ok.png"><br><br>  Der Fall, als die Nachricht verloren ging: <br><img src="https://habrastorage.org/webt/5u/yk/md/5uykmdq7sxiagt-5twd3uhpnxas.png"><br><br>  Das ist ein Fiasko.  Alles wird zu verwirrend und wird durch die Tatsache verschlimmert, dass der Adressat einen der Sätze entweder hören oder nicht hören kann, und in jedem Fall weiß der Gesprächspartner nicht, ob seine Nachricht vom Adressaten gehört wurde. <br><br>  Nun erwarten sowohl Alice als auch Bob ein Willkommen.  Es wäre logisch zu erkennen, dass ein Konflikt aufgetreten ist und jemand die Übertragung fortsetzen muss.  Aber was ist, wenn alles auf eine neue Art und Weise wieder passiert?  Und hier sind wir wieder, wo wir angefangen haben. <br><br>  Wenn Sie der Meinung sind, dass die Situation äußerst selten ist, denken Sie daran, wann Sie das letzte Mal über Sprache mit jemandem gesprochen haben, wenn Ihr Teilnehmer oder Sie (oder beide) eine langsame Internetverbindung haben.  "Hallo hallo hallo, du verschwindest."  "Sie können hallo hallo nicht hören." <br><br>  Während sich die Lage in Schützengräben erwärmt, fordern die Kommandeure die Übermittlung von Berichten. <br>  Es ist Zeit <s>, sich den primären Quellen zuzuwenden: Um Marx zu studieren, wird Engels</s> vor mehr als 40 Jahren zurückkehren und sehen, wie solche Probleme von <a href="https://en.wikipedia.org/wiki/Digital_Equipment_Corporation" rel="nofollow">DEC-</a> Ingenieuren bei der Entwicklung des <a href="https://en.wikipedia.org/wiki/Digital_Data_Communications_Message_Protocol" rel="nofollow">DDCMP-</a> Protokolls gelöst wurden. <br><br>  Laut den Entwicklern von DDCMP müssen Alice und Bob Emotionen ablehnen und wie <a href="https://en.wikipedia.org/wiki/Finite-state_machine" rel="nofollow">endliche Zustandsmaschinen werden</a> . <br>  Dies bedeutet, dass unsere Alice und Bob von nun an nur noch wenige feste Zustände haben. Übergänge zwischen diesen Zuständen können streng nach bestimmten Regeln erfolgen, wenn bestimmte Ereignisse eintreten. <br><br>  Zuerst listen wir einfach die Zustände auf: <br><br><ul><li>  Angehalten </li><li>  ERSTER START </li><li>  ANERKANNTER START </li><li>  LAUFEN </li></ul><br><br>  Wie Sie sehen, gibt es nur vier davon.  Und jetzt, egal was passiert, weiß jeder der Abonnenten mit Sicherheit, dass sich sein Gegenüber in nur einem dieser Zustände befindet.  Mit Blick auf die Zukunft werde ich sagen, dass fast immer ein Teilnehmer weiß, in welchem ​​Zustand sich der zweite Teilnehmer befindet, <s>aber dies ist nicht korrekt</s> . <br><br><h3>  Betrachten wir die Zustände im Detail getrennt </h3><br>  <b>HALTED</b> ist der einfachste Zustand, niemand geht irgendwohin, jeder bleibt an seinem Platz, nichts wird gesendet und nicht empfangen, irgendwelche äußeren Reize werden ignoriert.  Alle bis auf einen - der Wille der höheren Behörden.  Im ursprünglichen DDCMP-Protokoll kann der Übergang vom <b>Status HALTED</b> nur auf <b>Anforderung</b> des Benutzers in den <b>Status INITIAL START versetzt werden.</b> Alice oder Bob erhalten den Befehl, eine Verbindung herzustellen. <br><br>  Was passiert, wenn Alice oder Bob eine solche Bestellung erhalten? <br>  Sie stellen sofort fest, dass sich der Zustand von <b>HALTED</b> zu <b>INITIAL START</b> geändert hat. Dieser Übergang beinhaltet, wie jeder andere, eine genau definierte Abfolge von Aktionen.  In diesem Fall müssen Sie „DO IT!“ Rufen und die Uhr auf die Uhr stellen.  Das ist alles. <br><br>  Also schrie Alice, was von ihr verlangt wurde, und drückte einen Knopf auf der Stoppuhr.  Um zu verstehen, was von Bob zu erwarten ist, werden wir herausfinden, was mit Alice passieren kann, wenn sie sich im <b>INITIAL START-</b> Zustand befindet. <br><br>  - Von dem Moment an, als Alice bemerkte, dass die Zeit vergangen ist, sagen wir 10 Sekunden, und sie hat keine Reaktion von Bob gehört (beachte, ich sage nicht, dass Bob ihr nichts geschrien hat - das ist nicht bekannt, aber nur, dass Alice nichts weiß Alice ist eine weise und rationale Frau und verlässt sich ausschließlich auf Fakten.  Wir nennen dieses Ereignis ein Timeout - das Wartezeitintervall wurde überschritten.  In diesem Fall fordert uns das Protokoll auf, Folgendes zu wiederholen: Rufen Sie „DO IT ONCE!“ Und wiederholen Sie die Zeit.  Noch nicht dick. <br><br>  - Wenn Alice hörte, dass Bob dasselbe schrie - "DO ONE TIME!", Dann geht Alice <b>nicht selektiv</b> in den Zustand <b>ACKNOWLEDGED START über</b> , über den sie sofort "DO TWO!" Rufen und die Uhr erneut einstellen sollte. <br><br>  - Wenn Alice von Bob "DO TWO!" Hört, geht sie sofort in den Zustand <b>RUNNING</b> (!) Und ruft "ACCEPTED NOOOOOL!".  Wenn ihre Stoppuhr gestartet wurde, schaltet sie sie vorsichtshalber aus. <br><br>  Es ist sehr wichtig, keine unnötigen Bewegungen auszuführen, die vom aktuellen Status nicht vorgesehen sind.  Was auch immer Bob weint, egal wie fluchend oder bettelnd, Alice reagiert nur wie vereinbart. <br><br>  Solche Dinge werden bequem in einer Tabelle dargestellt.  <b>Beginnen</b> wir also mit den bereits beschriebenen Zuständen <b>HALTED</b> und <b>INITIAL START</b> , und dann werden wir die Tabelle weiter auffüllen. <br><br><div class="scrollable-table"><table><tbody><tr><th>  AKTUELLER STAAT </th><th>  EREIGNIS <br></th><th>  NEUER ZUSTAND </th><th>  AKTION <br></th></tr><tr><td>  JEDERMANN </td><td>  Der Befehl "Verbindung trennen" </td><td>  Angehalten <br></td><td></td></tr><tr><td>  Angehalten <br></td><td>  "Connect" bestellen <br></td><td>  INITIAL STATE </td><td>  1) Schreien Sie "DO IT ONCE!" <br>  2) Starten Sie den Timer <br></td></tr><tr><td rowspan="3">  ERSTER START <br></td><td>  Ich hörte "DO IT ONCE!" <br></td><td>  ANERKANNTER START <br></td><td>  1) Schrei "DO TWO!" <br>  2) Starten Sie den Timer <br></td></tr><tr><td>  Ich hörte "DO TWO!" </td><td>  LAUFEN <br></td><td>  1) Ruf "NOOOL AKZEPTIERT!" <br>  2) Stoppen Sie den Timer <br></td></tr><tr><td>  Die Zeit ist abgelaufen - Timeout </td><td>  ERSTER START <br></td><td>  1) Schreien Sie "DO IT ONCE!" <br>  2) Starten Sie den Timer <br></td></tr></tbody></table></div><br><br>  Ich lasse bewusst einige Punkte aus der ursprünglichen Beschreibung von DDCMP weg - wir brauchen sie nicht, wir wollen DDCMP nicht nur wiederholen, sondern auf <s>der gleichen</s> Basis <s>nur ein weiteres</s> neues Protokoll aufbauen. <br><br>  Aber zurück zur Beschreibung von Zuständen und Übergängen.  Der nächste Status ist <b>BESTÄTIGTER START</b> . <br>  In diesem Zustand ist alles, was Alice oder Bob Sorgen machen kann: <br><br>  - Nach Ablauf der Wartezeit, in diesem Fall müssen Sie im selben Zustand bleiben, schreien Sie "DO TWO!" und starten Sie den Timer erneut <br><br>  - Das hörbare "DO TWO!" wird in den Status " <b>RUNNING</b> " übersetzt, während Sie "ACCEPTED NOOOOL!" rufen. Halten Sie den Timer an. <br><br>  - das gehörte "DO IT!" geht in den gleichen Zustand, Sie müssen "DO TWO!" rufen und den Timer starten; <br><br>  - "NOOOL ACCEPTED!" gehört - Übergang in den Zustand <b>RUNNING</b> , Timer anhalten. <br><br>  Wir haben all das in einen Tisch gelegt. <br><div class="scrollable-table"><table><tbody><tr><th>  AKTUELLER STAAT </th><th>  EREIGNIS <br></th><th>  NEUER ZUSTAND </th><th>  AKTION <br></th></tr><tr><td rowspan="4">  ANERKANNTER START <br></td><td>  Ich hörte "DO IT ONCE!" <br></td><td>  ANERKANNTER START <br></td><td>  1) Schrei "DO TWO!" <br>  2) Starten Sie den Timer <br></td></tr><tr><td>  Ich hörte "DO TWO!" </td><td>  LAUFEN <br></td><td>  1) Ruf "NOOOL AKZEPTIERT!" <br>  2) Stoppen Sie den Timer <br></td></tr><tr><td>  Ich hörte "NOOOL AKZEPTIERT!" </td><td>  LAUFEN <br></td><td>  1) Stoppen Sie den Timer <br></td></tr><tr><td>  Die Zeit ist abgelaufen - Timeout </td><td>  ANERKANNTER START </td><td>  1) Schrei "DO TWO!" <br>  2) Starten Sie den Timer <br></td></tr></tbody></table></div><br><br>  Mit einem Handschlag ist fast alles fertig - es bleibt nur ein <b>RUNNING-</b> Status zu berücksichtigen, da einer der Teilnehmer bereits darauf zugreifen kann, und der zweite - sofort zur Toilette eilen und bei seiner Rückkehr alles vergessen und versuchen, eine neue Verbindung herzustellen. <br><br>  Aus der Sicht des Handshake-Verfahrens (wir beschäftigen uns noch nicht mit der Datenübertragung, für die alles gestartet wurde - dies ist eine separate Geschichte) im Zustand <b>RUNNING sind</b> wir an zwei Ereignissen interessiert: <br><br>  - Wenn sie zu uns "DO IT ONCE!" rufen - ist alles sehr schlecht, es ist eine vollständige Desynchronisation, alles muss neu gestartet werden.  Das ursprüngliche Protokoll <b>weist</b> Sie an, einfach in den <b>Status HALTED zu wechseln</b> .  Aber das wird uns in keiner Weise helfen - wenn dies aus irgendeinem Grund auf einem autonomen Arduino passiert ist, der einige Daten von einigen Sensoren überträgt, dann ist dies für uns ein völliger Fehler.  Wie wir wissen, können Sie von <b>HALTED</b> nur auf Anordnung der Behörden zu <b>INITIAL START</b> gehen. <br>  Aus diesem <b>Grund ändern</b> wir hier das Protokoll: Der Empfang des <b>Befehls</b> "DO ONCE!" <b>Im</b> Status " <b>HALTED</b> " sollte wie eine behördliche Anweisung funktionieren - d. H.  <b>Schalten Sie in den Status INITIAL START</b> , rufen Sie „DO IT ONCE!“ und starten Sie den Timer.  Darüber hinaus ist es in einigen Fällen zweckmäßig, einen Befehl zum Aufbau der Kommunikation zu erteilen, nachdem Sie sich mit Strom versorgt haben. <br>  Daher wird im ungünstigsten Fall die Verbindung einfach zurückgesetzt. <br><br>  - das zweite Ereignis, auf das im Zustand <b>RUNNING</b> reagiert werden muss - wenn aus einem benachbarten Graben „DO TWO!“ zu hören ist.  Das ist schon interessanter.  In diesem Fall müssen Sie „ER AKZEPTIERT!“ Rufen. Mit ER ist die Anzahl der Nachrichten gemeint, die in der aktuellen Kommunikationssitzung erfolgreich empfangen wurden.  Dies ist ein neues Konzept.  Im Folgenden werden wir alles genauer betrachten, aber vorerst werden wir alles, was wir gelernt haben, auf den aktuellen Moment in eine Tabelle bringen: <br><br><div class="scrollable-table"><table><tbody><tr><th>  AKTUELLER STAAT </th><th>  EREIGNIS <br></th><th>  NEUER ZUSTAND </th><th>  AKTION <br></th></tr><tr><td rowspan="4">  ANERKANNTER START <br></td><td>  Ich hörte "DO IT ONCE!" <br></td><td>  ANERKANNTER START <br></td><td>  1) Schrei "DO TWO!" <br>  2) Starten Sie den Timer <br></td></tr><tr><td>  Ich hörte "DO TWO!" </td><td>  LAUFEN <br></td><td>  1) Ruf "NOOOL AKZEPTIERT!" <br>  2) Stoppen Sie den Timer <br></td></tr><tr><td>  Ich hörte "NOOOL AKZEPTIERT!" </td><td>  LAUFEN <br></td><td>  1) Stoppen Sie den Timer <br></td></tr><tr><td>  Die Zeit ist abgelaufen - Timeout </td><td>  ANERKANNTER START </td><td>  1) Schrei "DO TWO!" <br>  2) Starten Sie den Timer <br></td></tr></tbody></table></div><br><br>  Wenn Alice und Bob sich strikt an das Protokoll halten, haben sie nur keine Möglichkeit <s>, in</s> etwas <s>Unverständliches zu geraten</s> , außer wie sie eine Verbindung herstellen, gemeinsam in den Status <b>RUNNING</b> wechseln oder im schlimmsten Fall versuchen, sie herzustellen, bevor auf den Sieg <s>geklickt wird</s> . <br><br>  Ein aggressiver Leser kann versuchen, alle Optionen zu sortieren und zu dem Schluss kommen, dass sich die Reihe von Zuständen und Übergängen als geschlossen und streng bestimmt herausstellt.  Wir (mit Hilfe der Köpfe der DEC-Ingenieure) haben Alice und Bob nun mit einer Reihe von Regeln verbunden, die einfach durch Befolgen der Regeln eine Verbindung herstellen, wenn dies unter den gegenwärtigen Bedingungen im Prinzip möglich ist. <br><br><h3>  Wie übertrage ich jetzt Daten? </h3><br>  Okay, das war ein schönes Training.  Candy-Bouquet-Periode in der Beziehung zweier Netzwerkknoten.  Denken Sie daran, dass wir ein Unternehmen gegründet haben: Wir müssen Daten mit garantierter Zustellung und Priorität übertragen!  Mit Disaster Recovery.  Soweit Hardware-Ressourcen dies zulassen (Alice und Bob können sich als schwache 8-Bit-Controller mit 2 Kilobyte RAM herausstellen!). <br><br>  Die DEC-Ingenieure lehren uns, dass die Nachrichten, die wir nummerieren müssen, gezählt werden müssen, wie viel wir gesendet haben, wie viele wir empfangen haben und wie viele der gesendeten Nachrichten den Empfänger erreicht haben. <br><br><div class="spoiler">  <b class="spoiler_title">Es ist Zeit für einen Exkurs!</b> <div class="spoiler_text">  Gib es zu.  Als ich die Namen der Variablen in der Beschreibung des DDCMP-Protokolls sah, entschied ich, dass es kein Zufall war: Amerikaner ziehen sehr gerne schöne Abkürzungen an ihren Ohren an. <br><br>  Für unsere Bequemlichkeit gibt es sogar mehrere Ressourcen, bei denen Interessierte das Schöne berühren können. <br>  Mein Favorit ist dieser - <a href="https://www.cfa.harvard.edu/~gpetitpas/Links/Astroacro.html" rel="nofollow">dumme oder übermäßig erzwungene astronomische Abkürzungsseite (oder DOOFAAS)</a> <br><br>  Was sind diese Erfindungen wert! <br>  Hier ist ein Beispiel: <br><br>  <b>WASP</b> - Wideband Analog SPectrometer (Aber nicht das, was Sie gedacht haben!) <br>  <b>SAURON</b> - Spektroskopische <b>Flächeneinheit</b> zur Erforschung optischer Nebel <br>  <b>CISCO</b> - Cooled Infrared Spectrograph und Camera for OHS (Das ist es also!) <br><br>  Und hier nur Feuer: <br>  <b>SQUIRT</b> (oh ja, Artikel 18+!) - Satettile QUick Research Testbed <br>  <b>SHIT</b> (Weder mehr noch weniger!) - Super Huge Interferometric Telescope mit der Aufschrift „Look for yourself“, zu der der Link zur Zusammenfassung an den gleichnamigen Artikel angehängt ist. <br><br>  Daher werden die Variablen, die die Anzahl der empfangenen, gesendeten und zugestellten Pakete auf dem Knoten in der ursprünglichen Beschreibung des Protokolls angeben, als <b>RNA bezeichnet</b> . <br><br>  Ah, warum haben sie das Protokoll nicht so genannt - RNA!  Eine Art RNA-Netzwerk.  DECnet-Protokolle hatten jede Chance, zu Internetprotokollen zu werden, wenn die Geschichte anders ausgefallen wäre. <br></div></div><br><br><h3>  Aber zurück zu unseren Schützengräben </h3><br>  Der ursprüngliche Protokollstandard definiert, dass alle Zähler 8-Bit und Inkrement Modulo 256 sind. Dies bedeutet, dass maximal 256 Nachrichten gesendet werden können, für die noch keine Bestätigung eingegangen ist. <br>  Und wenn keine Bestätigung eingeht, müssen sie möglicherweise erneut übertragen werden, und wenn dies erforderlich ist, müssen sie bis zur Bestätigung gespeichert werden.  Immerhin haben wir die Lieferung garantiert! <br><br>  Die körperlichen Parameter unserer Alice und Bob diktieren uns unterschiedliche Bedingungen.  In 8-Bit-Arduino kann diese Datenmenge einfach nicht gespeichert werden, und wir müssen Kompromisse eingehen.  Und ich spreche nicht von der Tatsache, dass in der Norm die Länge von Paketen (Nachrichten) in Bytes auf eine 16-Bit-Zahl begrenzt ist, d.h.  64 Kilobyte sind ein unzulässiger Luxus! <br><br><h3>  Damit ist die Verbindung hergestellt.  Was weiter? </h3><br>  In dem Moment, in dem Alice oder Bob <b>in den</b> Zustand <b>RUNNING wechseln</b> , werden die Zähler zurückgesetzt. <br>  Wie ich bereits erwähnte, beinhaltet das ursprüngliche Protokoll die Nummerierung von Nachrichten modulo 256, aber wir müssen diese Nummer reduzieren, um der geringen Speicherkapazität in Arduino-ähnlichen Dingen zu entsprechen. <br>  Um sofort alle Inkremente von Zählern einschränken zu können, werden wir eine bestimmte Konstante UMCP_PACKETS_NUMBER einführen, und nun werden alle Inkremente in diesem Modul auftreten. <br><br>  Wenn Sie UMCP_PACKETS_NUMBER = 8 nehmen und die maximale Paketgröße UMCP_PACKET_DATA_SIZE ist - die Teile der zu einem Zeitpunkt übertragenen Daten sind auf 64 Bytes begrenzt, dann passt alles in das Arduino UNO und bleibt ein bisschen für die Benutzeranforderungen. <br>  Es ist wichtig zu bedenken, dass diese beiden Parameter für beide Parteien gleich sein müssen. <br><br>  Wenn Alice und Bob nun erfolgreich eine Verbindung hergestellt haben und einer von ihnen Daten übertragen muss, müssen die Daten offensichtlich zunächst in Teile mit einer Größe von maximal 64 Byte aufgeteilt werden, und zweitens muss jedes Paket auch einen Status enthalten Zwei Absenderzähler: Die Anzahl der empfangenen und gesendeten Nachrichten (R und N). <br><br>  Sehen Sie, wie einfach es jetzt ist, die sogenannten zu organisieren  Pipelining und wie einfach es ist, mit Fehlersituationen umzugehen! <br><br>  Wenn Alice gleich nach dem Verbindungsaufbau 3 Pakete hintereinander sendet, wird für alle der Zähler R auf 0 gesetzt (sie hat noch keine Pakete erhalten), und der Zähler N wird mit jedem neuen Paket um eins erhöht. <br><br>  Wenn Bob alle erfolgreich akzeptiert, reicht es aus, nur für das letzte Paket eine Bestätigung zu senden, um den Empfang aller drei Pakete zu bestätigen. Wenn er lediglich den Status seiner Zähler R = 3 und N = 0 zurücksendet, wird Alice sofort verstehen, dass alle gesendet wurden Ihre Nachrichten erreichten den Adressaten. <br><br>  Es war ein idealer Fall, in dem keine höhere Gewalt auftrat.  Schauen wir uns nun an, was möglicherweise schief gehen könnte und wie Sie damit umgehen können. <br><br>  Wenn Bob aus irgendeinem Grund das erste Paket überspringt und eines der nächsten annimmt, macht er sofort darauf aufmerksam, dass der Zähler N (die Anzahl der von Alice gesendeten Pakete) den Zähler R auf Bobs Seite deutlich überschreitet und Bob leicht erkennt, dass er das erste Paket verpasst hat .  In diesem Fall muss er nur den flachsten Captain Evidence spielen und Alice den Status seines Zählers der empfangenen Pakete mitteilen (R = 0).  Alice versteht gleichzeitig, dass sie N = 3 ist und Bob R = 0 hat, das heißt, dass es notwendig ist, Pakete auf eine neue Art und Weise zu übertragen, beginnend mit der ersten. <br><br>  Wenn Sie sich dieses Schema genau ansehen, können Sie feststellen, dass bei jeder Übertragung des Status seiner Zähler durch einen Abonnenten sofort das Ergebnis der Übertragung von Datenpaketen angezeigt wird und die Differenz zwischen dem auf der einen Seite gesendeten und dem auf der anderen Seite empfangenen Zähler angibt, wie viele Pakete verloren gegangen sind und von welcher Nummer es angefangen hat. <br><br>          ,     A        R   ,   «»  . <br><br>  ,       ,        (). <br>   RNA       SACK  SPEP.   ,     (Send ACKnowledgement),   —       (Send REPly to a message). <br><br> ,   DDCMP     — SNAK (Send Negative AcKnowledgement).         - .               ,      , ,         —       . <br>       ,      . <br><br>          - . -      .  Und das ist die Wahrheit.    . <br>                  . <br><br>       ,        —   ,   .      ,   ,    L,   (,      —  R). <br><div class="scrollable-table"><table><tbody><tr><th>  </th><th>  </th></tr><tr><td>    NR=RL+1 </td><td> 1)   <br> 2)    <br> 3) RL=RL+1 <br> 4)  RR=NL  AL&lt;=RR&lt;=NL   <br>      AL  RR  <br>  <br> 5) AL=RR <br></td></tr><tr><td>     — REP </td><td> 1) SACK = true <br> 2) SREP = false <br></td></tr><tr><td>   — ACK </td><td> 1)   <br> 2) SREP = false <br> 3)  RR=NL  AL&lt;=RR&lt;=NL   <br>      AL  RR  <br>  <br> 4) AL=RR <br></td></tr><tr><td>    </td><td> 1) SREP = true </td></tr><tr><td>      SREP </td><td> 1)     REP(RL, NL) <br> 2)   <br></td></tr><tr><td>    AL&lt;NL </td><td> 1)     AL+1 <br> 2)   <br></td></tr><tr><td>  ,   SACK </td><td> 1)   ACK(RL,NL) </td></tr><tr><td>  , AL=NL,  SACK  SREP <br>  ,     <br></td><td> 1) NL=NL+1 <br> 2)     <br></td></tr></tbody></table></div><br><br>   ,     . ,    . <br>    DDCMP,      ,     SELECT —  (  )   «»    . <br>    ,      ,    . <br>    :   SELECT.    :   ,   ,   — . <br><br>     ACK  REP    .         .   «»   ,    «»,        . ,      , ,     .          ( ?). <br><br>        ,          ,   — .        —    SELECT. <br><br>               . <br><br>         . <br>   ,  ! <br><br><h3>     </h3><br>   Message Framing —        . <br>  ,    . <br><br> 1.    ,       R  N .  Arduino         8    .      ,      ,    4-. <br><br>     : <br><pre><code class="cpp hljs"> = (RL &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>) | (NL &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre> <br>  Und wir werden den Status der Zähler wie folgt lesen: <br><pre> <code class="cpp hljs">NR = (c &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; RR = c &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>;</code> </pre> <br>  c - entsprechendes Byte aus der Nachricht <br><br>  2. Wir erinnern uns auch, dass jede Nachricht den Status des SELECT-Flags enthalten muss.  Die verschiedenen Arten von Nachrichten selbst sind: <br><div class="scrollable-table"><table><tbody><tr><th>  Lustiger Name <br></th><th>  Ernster Name <br></th><th>  Beschreibung <br></th><th>  SELECT Flag Wert <br></th><th>  PTYPE-Wert </th></tr><tr><td>  "TUN SIE ES EINMAL!" <br></td><td>  STR <br></td><td>  STaRt <br></td><td>  wahr </td><td>  40 <br></td></tr><tr><td>  "ZWEI TUN!" <br></td><td>  STA <br></td><td>  STart bestätigt </td><td>  wahr </td><td>  36 </td></tr><tr><td>  "NOOL AKZEPTIERT!" <br></td><td>  ACK (NL = 0, RL = 0) <br></td><td>  Bestätigung <br></td><td>  wahr </td><td>  33 <br></td></tr><tr><td>  "AKZEPTIERT VON ER, SENDET VON EN" </td><td>  ACK (NL, RL) </td><td>  Bestätigung </td><td>  wahr </td><td>  33 </td></tr><tr><td>  "BESTÄTIGEN, WIE ICH VERSTEHE?" <br></td><td>  REP (NL, RL) <br></td><td>  Beantworten Sie eine Nachricht </td><td>  wahr </td><td>  34 </td></tr><tr><td>  "DATENPAKET" <br></td><td>  DTA (NL, RL) <br></td><td>  Datenpaket </td><td>  falsch </td><td>  17 </td></tr><tr><td>  EXTREMES DATENPAKET <br></td><td>  DTE (NL, RL) </td><td>  DaTa-Paket - Ende </td><td>  wahr </td><td>  49 </td></tr></tbody></table></div><br><br>  Das heißt, nur 6 verschiedene Arten von Nachrichten.  Alle Nachrichten mit Ausnahme von DTA geben das SELECT-Flag "frei" - sie benötigen eine sofortige Antwort vom entfernten Teilnehmer, und ohne das Flag kann er es nicht senden.  Die DTA-Nachricht gibt kein Flag zurück, um Pipelining zu ermöglichen. <br><br>  Im Allgemeinen haben wir genug 3 Bits für den Nachrichtentyp, aber um nicht mit den Bits zu verwechseln, weisen wir dem Typ ein ganzes Byte zu - im Falle einer Revision haben wir eine gewisse Handlungsfreiheit. <br><br>  Wenn die Nachricht Daten enthält, müssen wir deren Menge und Prüfsumme übertragen.  Da die maximale Paketgröße 64 Byte beträgt, nehmen wir auch ein Byte für die Prüfsumme und für die Länge - plötzlich müssen Sie die Paketgröße erhöhen. <br><br>  3. Wir benötigen auch eine Signatur des Nachrichtenanfangs und eine separate Prüfsumme für den Header. <br><br>  In diesem Sinne sieht der Header (auch als Kontrollmeldungen bezeichnet) folgendermaßen aus: <br><div class="scrollable-table"><table><tbody><tr><th>  Offset, Byte <br></th><th>  Beschreibung </th><th>  Größe, bisschen </th></tr><tr><td>  0 </td><td>  SIGN = 0xAD <br></td><td>  8 </td></tr><tr><td>  1 </td><td>  PTYPE </td><td>  8 </td></tr><tr><td>  2 </td><td>  TCNT </td><td>  4 <br></td></tr><tr><td>  2 </td><td>  RCNT </td><td>  4 </td></tr><tr><td>  3 </td><td>  Hchk </td><td>  8 </td></tr></tbody></table></div><br><br>  Und der Datenblock sieht so aus: <br><div class="scrollable-table"><table><tbody><tr><th>  Offset, Byte <br></th><th>  Beschreibung </th><th>  Größe, bisschen </th></tr><tr><td>  4 </td><td>  DCNT <br></td><td>  8 </td></tr><tr><td>  5..5 + DCNT-1 <br></td><td>  DATA <br></td><td>  8 * DCNT </td></tr><tr><td>  5 + DCNT </td><td>  Dchk </td><td>  8 </td></tr></tbody></table></div><br><br>  Das ist alles  Dies ist eine vollständige Beschreibung des Protokolls, das wir von DDCMP erhalten haben. <br>  Jetzt können Sie die Implementierung durchführen. <br><br><h3>  Wie ist es aufgebaut und wie benutzt man es? </h3><br>  Zunächst ein wenig über die Struktur des Repositorys. <br>  Wie eingangs erwähnt, liegt der Projektcode auf dem Github: <a href="https://github.com/AlekUnderwater/uMCPIno" rel="nofollow">uMCPIno</a> <br><br>  Um zu sehen, wie alles funktioniert, können Sie eine <a href="" rel="nofollow">Testanwendung</a> auf einem PC ausführen. <br><br>  Führen Sie im Archiv "uMCPIno_Test.exe" aus, wählen Sie den gewünschten COM-Port aus und testen Sie die Funktionsweise. <br>  Sie können ein Paar virtueller COM-Anschlüsse überprüfen (ich mache dies normalerweise). <br>  Warum können Sie zwei Kopien der Anwendung ausführen.  Vergessen Sie nur nicht, in einer Kopie "AUSGEWÄHLT NACH STANDARD" zu aktivieren - dies ist der Master, und in der anderen - deaktivieren Sie ihn.  Übrigens, wenn Sie interessiert sind, können Sie sehen, was passiert, wenn Sie diese Regel nicht einhalten =) <br><br>  Mit der Option EXTRAS können Sie alle Gedankenbewegungen im Gehirn des Protokolls anzeigen.  Alle Änderungen des Zustands der SELECT-Flags, Ereignisse von Timern, Änderungen des Zustands des Knotens sowie die Werte der Variablen R und N in den gesendeten und empfangenen Nachrichten werden angezeigt. <br><br>  Ich verbinde meinen Arduino UNO über einen UART &lt;-&gt; USB-Konverter mit meinem Laptop.  Mit den Stiftleisten können Sie jederzeit einen Zeilenumbruch simulieren: <br><img src="https://habrastorage.org/webt/nn/vg/kp/nnvgkplqtoqbazpubopcb8bff-g.jpeg"><br><br>  Wenn Sie die Anwendung jetzt auf dem Laptop ausführen, stellt das Arduina nach dem Drücken der Taste "CONNECT" eine Verbindung her: <br><img src="https://habrastorage.org/webt/cy/jm/lx/cyjmlxn_ga-_zvrzel5yjmfwdz4.png"><br><br>  Und so reagiert das System auf den Versuch, durch eine "zerrissene" Leitung zu senden: <br><img src="https://habrastorage.org/webt/lu/kb/dw/lukbdwxot1xuopxjdqxgpq1xqsq.png"><br><br>  So binden Sie uMCPIno in Ihre PC-Anwendung ein: <br><ol><li>  Das Repository verfügt über eine uMCPIno-Bibliothek.  Verbinden Sie es mit den Referenzen Ihres Projekts </li><li>  Es enthält die Klasse uMCPInoPort.  Wir erklären seine Instanz: <br><pre> <code class="cs hljs">uMCPInoPort port; port = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> uMCPInoPort(<span class="hljs-string"><span class="hljs-string">"COM1"</span></span>, UCNLDrivers.BaudRate.baudRate9600, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">8100</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>);</code> </pre><br>  Parameter in der Reihenfolge: Portname, dann Portgeschwindigkeit, Standard-SELECT-Status, Intervall für SELECT, Timeout-Intervall, Paketgröße und die maximale Anzahl nicht bestätigter Nachrichten. <br></li><li>  Veranstaltungen abonnieren: <br>  wenn sich das SELECT - port.Select Flag ändert: <br><pre> <code class="cs hljs">OnSelectChangedEventHandler</code> </pre> <br>  wenn sich der Zustand ändert - port.State: <br><pre> <code class="cs hljs">OnStateChangedEventHandler</code> </pre> <br>  Der Remote-Host bestätigt den Erhalt des Codes: <br><pre> <code class="cs hljs">OnDataBlockAcknowledgedEventHandler</code> </pre> <br>  wann kommt das datenpaket an <br><pre> <code class="cs hljs">OnDataBlockReceivedEventHandler</code> </pre> <br></li><li>  Öffnen Sie vor der Arbeit den Anschluss <br><pre> <code class="cs hljs">port.Open();</code> </pre> <br></li><li>  Um Daten zu senden, rufen wir die Methode auf: <pre> <code class="cs hljs">port.Send(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data);</code> </pre> <br></li><li>  Nach Abschluss schließen Sie den Hafen: <pre> <code class="cs hljs">port.Close();</code> </pre> <br></li></ol><br><br>  Senden Sie einfach zwei Bytes! <br><br>  Fahren wir nun mit der Implementierung für Arduino fort.  Zwei Beispiele befinden sich im Ordner <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/Arduino" rel="nofollow">github.com/AlekUnderwater/uMCPIno/tree/master/Arduino</a> <br><br>  <a href="" rel="nofollow">Das erste</a> ist nur ein Konverter von und nach uMCP.  Die erste serielle Schnittstelle dient zur Kommunikation mit dem Host und die serielle Schnittstelle 1 (sofern sie sich auf Ihrer Platine befindet) oder die Software-serielle Schnittstelle an den Anschlüssen 2 und 3 zur Kommunikation mit einem anderen uMCPIno-Knoten.  Hier können Sie Bluetooth oder ein Funkmodul anschließen. <br><br>  <a href="" rel="nofollow">Die zweite</a> ist eine Projektvorlage mit Unterstützung für das uMCPIno-Protokoll <br><br>  Beide Projekte haben Einstellungen, in denen Sie klettern können und sollten.  Hier sind sie: <br><br>  Der Standardstatus des SELECT-Flags.  Wenn es auf (true) gesetzt ist, wird es vom Timer auf true gesetzt, auch wenn der Remote-Knoten das Flag nicht zurückgibt. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_SELECT_DEFAULT_STATE (false)</span></span></code> </pre> <br><br>  Um die Dauer dieses Timers einzustellen, gibt es die folgende Einstellung: Intervall zum Zurückgeben des SELECT-Flags in Millisekunden <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_SELECT_DEFAULT_INTERVAL_MS (4000)</span></span></code> </pre> <br><br>  Das Intervall für das Warten auf eine Antwort in Millisekunden sollte etwas kürzer als das Intervall für das Zurücksetzen des SELECT-Flags sein. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_TIMEOUT_INTERVAL_MS (3000)</span></span></code> </pre> <br><br>  Die tatsächliche Baudrate der Leitung.  Dieser Parameter wird benötigt, um zu bestimmen, wann die Übertragung beendet wird. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_LINE_BAUDRATE_BPS (9600)</span></span></code> </pre> <br><br>  Datenakkumulationsintervall für den Nagle-Algorithmus.  Nehmen Sie es unverschämt gleich 100 Millisekunden.  Während dieser Zeit warten wir auf eine Reihe von Paketen. Wenn diese nicht eingegeben wurden, senden wir sie so, wie sie sind.  Die Aufgabe des Nagle-Algorithmus besteht darin, das Netzwerk von einem Haufen kleiner Pakete mit einer Größe von einem bis mehreren Bytes zu befreien. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_NAGLE_DELAY_MS (100)</span></span></code> </pre> <br><br>  Mit diesen Einstellungen werden die Portgeschwindigkeiten für die Kommunikation mit dem Steuerungssystem (Host) und der Leitung festgelegt.  Verwechseln Sie die Portgeschwindigkeit nicht mit einer Leitung mit einer physischen Übertragungsrate. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_HOST_CONNECTION_BAUDRATE_BPS (9600) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Host connection port speed #define CFG_LINE_CONNECTION_BAUDRATE_BPS (9600) // Line connection port speed</span></span></span></span></code> </pre> <br><br>  Wenn diese Einstellung aktiviert ist, fordert sich das Protokoll selbst an, eine Verbindung herzustellen, wenn die Steuerung mit Strom versorgt wird. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_IS_AUTOSTART_ON_POWERON (true)</span></span></code> </pre> <br><br>  Dies ist die Größe des Puffers in Byte für eingehende Datenpakete. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_IL_RING_SIZE (255)</span></span></code> </pre> <br><br>  Als nächstes wollen wir sehen, wie die Hauptskizzenschleife aussieht: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ uMCP_ITimers_Process(); DC_Input_Process(); DC_Output_Process(); <span class="hljs-comment"><span class="hljs-comment">//  ip_ready  ,      if (ip_ready) { uMCP_OnIncomingPacket(); } //        ,     -  if ((state == uMCP_STATE_HALTED) &amp;&amp; ((ih_Cnt &gt; 0) || (isStartup &amp;&amp; CFG_IS_AUTOSTART_ON_POWERON))) { if (isStartup) { isStartup = false; } uMCP_STATE_Set(uMCP_STATE_ISTART); uMCP_CtrlSend(uMCP_PTYPE_STR, 0, 0, true); } else if (state == uMCP_STATE_RUNNING) { uMCP_Protocol_Perform(); //      -   if (il_ready) { il_ready = false; USER_uMCPIno_DataPacketReceived(); } } }</span></span></code> </pre><br><br>  Nun wollen wir sehen, wie das Protokoll funktioniert.  Die Hauptlogik ist in der Funktion uMCP_Protocol_Perform () enthalten.  Hier ist ihr Code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCP_Protocol_Perform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == uMCP_STATE_RUNNING) { <span class="hljs-comment"><span class="hljs-comment">//              SELECT  if ((!iTimer_State[uMCP_Timer_TX]) &amp;&amp; (!iTimer_State[uMCP_Timer_TMO]) &amp;&amp; (select)) { //     if (ih_Cnt == 0) { //    REP -  if (srep) { uMCP_CtrlSend(uMCP_PTYPE_REP, N, R, true); srep = false; } //     -   else if (sentBlocksCnt &gt; 0) { uMCP_DataBlockResend((A + 1) % UMCP_PACKETS_NUMBER, true, true); } //    SACK  -        //  -       ACK else if ((!selectDefaultState) || (sack)) { uMCP_CtrlSend(uMCP_PTYPE_ACK, N, R, false); sack = false; } } //     -  else if (ih_Cnt &gt; 0) { //              -  if ((ih_Cnt &gt;= UMCP_PACKET_DATA_SIZE) || (millis() &gt;= ih_TS + CFG_NAGLE_DELAY_MS)) { //   N N = (N + 1) % UMCP_PACKETS_NUMBER; uMCP_NextDataBlockSend(); } } } } }</span></span></code> </pre><br><br>  Ein Paketparser, der in einer Funktion lebt <pre> <code class="cpp hljs">On_NewByte_From_Line</code> </pre>  ebenfalls nach dem Prinzip einer endlichen Zustandsmaschine angeordnet und arbeitet "byteweise".  Dies geschieht, um Speicherplatz zu sparen. <br><br>  Der Rest der Implementierung ist nicht von besonderem Interesse.  Wir analysieren besser, wie der Benutzer mit dem Protokoll interagiert.  In diesem Beispiel gibt es vier "Kontaktstellen". <br><br>  Die erste Funktion ist das Senden von Daten auf der uMCPIno-Leitung: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCPIno_SendData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(byte* dataToSend, byte dataSize)</span></span></span></span>;</code> </pre> <br>  Hier ist alles einfach - Sie haben einen Byte-Puffer dataToSend, dessen Größe dataSize ist.  Die Funktion gibt true zurück, wenn das Senden möglich ist (es ist Platz zum Hinzufügen von Daten vorhanden), andernfalls false. <br>  Um nicht umsonst zu fahren, können Sie mit der Funktion sofort prüfen, ob ausreichend Platz vorhanden ist: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCP_IsCanSend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(byte dataSize)</span></span></span></span>;</code> </pre> <br><br>  Um eingehende Datenpakete zu analysieren, müssen Sie Ihren Code zum Funktionskörper hinzufügen <pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USER_uMCPIno_DataPacketReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><br>  Eingehende Daten werden in den il_ring-Ringpuffer geschrieben.  Das Lesen kann wie folgt organisiert werden: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (il_Cnt &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { c = il_ring[il_rPos]; il_rPos = (il_rPos + <span class="hljs-number"><span class="hljs-number">1</span></span>) % CFG_IL_RING_SIZE; il_Cnt--; <span class="hljs-comment"><span class="hljs-comment">//   "c" -      }</span></span></code> </pre><br><br>  Für gehobene Genüsse gibt es eine Funktion <br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USER_uMCP_OnTxBufferEmptry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br>  Welches aufgerufen wird, wenn alle Daten erfolgreich gesendet wurden.  Es ist auch möglich und notwendig, eine Art Code einzufügen. <br><br><h3>  Warum ist das alles und wo? </h3><br>  Ich habe mich hauptsächlich aus Spaß damit beschäftigt.  Außerdem brauchte ich ein einfaches und vor allem "leichtes" Protokoll, um Daten über unsere <a href="https://habr.com/ru/post/428367/">uWAVE-Sonarmodems</a> zu senden.  Da sie mit einer Geschwindigkeit von nur 80 bps und einer maximalen Kommunikationsreichweite von 1000 m / s und einer Schallgeschwindigkeit von etwa 1500 m / s Daten über Wasser übertragen, ist die Übertragung mit spürbaren Verzögerungen verbunden, und es gibt nur einen Sonarkanal (wenn nicht den meisten) !) der lautesten, langsamsten und instabilsten. <br>  Vor allem aus diesem Grund musste ich den Mechanismus der negativen Bestätigung (NAK) aufgeben - wenn es möglich ist, nicht zu übertragen -, ist es besser, nicht zu 100% zu übertragen. <br>  In der Realität hat sich das Protokoll als nützlich <a href="http://www.dorji.com/products.php%3FCateId%3D9" rel="nofollow">erwiesen,</a> wenn Daten über einen Funkkanal mit <a href="http://www.dorji.com/products.php%3FCateId%3D9" rel="nofollow">DORJI-</a> Modulen und dem Arduino bekannten <a href="https%253A%252F%252Fwww.elecrow.com%252Fdownload%252FHC-12.pdf%26usg%3DAOvVaw2rNtYm7nLdpqPN6HR-LAS8" rel="nofollow">NS-012</a> übertragen wurden. <br><br><h3>  Was weiter? </h3><br>  Wenn es Zeit gibt, plane ich, die Möglichkeit der Adressierung (die übrigens in DDCMP war) hinzuzufügen.  Da die Hauptaufgabe dieses Protokolls nun darin besteht, alle Arten von Tests unserer Sonarmodems und anderer Sensornetzwerke zu vereinfachen, gibt es (im wahrsten Sinne des Wortes!) Fallstricke.  Ich kann nur sagen, dass das Problem nicht durch einfaches Hinzufügen der Felder "Absender" und "Ziel" gelöst werden kann. <br>  Vielleicht kommt es zu <a href="https://en.wikipedia.org/wiki/Geographic_routing" rel="nofollow">Geographic Routing</a> und all dem Jazz. <br><br><h3>  PS </h3><br>  Für konstruktive Kritik, Wünsche und Anregungen bin ich traditionell sehr dankbar.  Es ist immer wichtig zu verstehen, ob Sie etwas Nützliches für Menschen tun oder Zeit verschwenden. <br>  Vielleicht habe ich bei dem Versuch, den Übergang dieses Longreads zum Roman "Krieg und Frieden" zu vermeiden, einige Details übersehen - zögern Sie nicht zu fragen. <br><br><h3>  PPS </h3><br>  Vielen Dank, dass ich mich für meinen Analphabetismus schäme und auf Fehler hinweise (grammatikalisch und logisch): <br><ul><li>  <a href="https://habr.com/ru/users/berez/" class="user_link">berez</a> </li><li>  <a href="https://habr.com/ru/users/edo1h/" class="user_link">edo1h</a> </li></ul><br>  Das Projekt war ursprünglich Open Source, aber jetzt ist der Artikel auch Open Source. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de480110/">https://habr.com/ru/post/de480110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de480100/index.html">Anfänger über SEO</a></li>
<li><a href="../de480102/index.html">November Product Management Digest</a></li>
<li><a href="../de480104/index.html">9 nützliche HTML-Tricks</a></li>
<li><a href="../de480106/index.html">So stellen Sie ein Oracle DB-Image für Testcontainer zusammen</a></li>
<li><a href="../de480108/index.html">Physik in einem Unity-Projekt am Beispiel des Mobile Fighting</a></li>
<li><a href="../de480112/index.html">Unterschiede zwischen C ++ / Visual Basic und Java auf allgemeiner Ebene (für Anfänger und Studenten)</a></li>
<li><a href="../de480114/index.html">Alles über Steuern für IT-Freiberufler. IE und selbständig. Teil 1</a></li>
<li><a href="../de480116/index.html">Die Position der Mail.ru-Gruppe zur Entwicklung von Open Source in Russland</a></li>
<li><a href="../de480118/index.html">Wir schreiben einen Touch-Typing-Simulator mit reinem JavaScript. Teil 1</a></li>
<li><a href="../de480120/index.html">Eine neue Leistung in der Kryptographie - Faktorisierung eines 795-Bit-RSA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>