<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍💻 🚴🏼 👐 So verwenden Sie die Node.js Stream-API nicht 🐳 👨‍⚖️ ⌛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im Internet liegt wieder jemand falsch - in der gestrigen Node Weekly gab es einen Link zu einem Beitrag, in dem der Autor versucht, die Leistung der ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So verwenden Sie die Node.js Stream-API nicht</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427901/"><p>  Im Internet liegt wieder jemand falsch - in der gestrigen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Node Weekly gab</a> es einen Link <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zu einem Beitrag,</a> in dem der Autor versucht, die Leistung der Stream-API in Node.js zu messen und zu vergleichen.  Traurigkeit bewirkt, wie der Autor mit Streams arbeitet und welche Schlussfolgerungen er daraus zu ziehen versucht: </p><br><blockquote>  ... das hat bei kleineren Dateien ziemlich gut funktioniert, aber als ich zur größten Datei kam, ist der gleiche Fehler aufgetreten.  Obwohl Node.js die Ein- und Ausgänge gestreamt hat, wurde dennoch versucht, die gesamte Datei während der Ausführung der Vorgänge im Speicher zu halten </blockquote><p>  Versuchen wir herauszufinden, was mit den Schlussfolgerungen und dem Code des Autors nicht stimmt. </p><a name="habracut"></a><br><p>  Aus meiner Sicht besteht das Problem darin, dass der Autor des Artikels nicht weiß, wie man Stream'ami verwendet, und dies ist ein Problem, mit dem man sich ziemlich oft befassen muss.  Dieses Phänomen hat meiner Meinung nach drei Gründe: </p><br><ol><li>  Die komplexe Geschichte der Node.js Stream API - die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier beschriebenen Schmerzen und Leiden</a> </li><li>  Nicht die intuitivste API, wenn Sie versuchen, sie ohne Wrapper zu verwenden </li><li>  Ziemlich seltsame Dokumentation, die Streams als etwas sehr Komplexes und Niedriges darstellt </li></ol><br><p>  Alles in allem führt dies dazu, dass Entwickler häufig nicht wissen, wie und die Stream-API nicht verwenden möchten. </p><br><p>  Was ist los mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dem Autorencode</a> ? <br>  Wiederholen wir zunächst die Aufgabe hier (das Original in englischer Sprache und ein Link zur Datei finden Sie im Beitrag): <br>  Es gibt eine bestimmte 2,5-GB-Datei mit Zeilen des Formulars: </p><br><pre><code class="hljs ruby">C00084871<span class="hljs-params"><span class="hljs-params">|N|</span></span>M3<span class="hljs-params"><span class="hljs-params">|P|</span></span><span class="hljs-number"><span class="hljs-number">201703099050762757</span></span><span class="hljs-params"><span class="hljs-params">|15|</span></span>IND<span class="hljs-params"><span class="hljs-params">|COLLINS, DARREN ROBERT|</span></span>SOUTHLAKE<span class="hljs-params"><span class="hljs-params">|TX|</span></span><span class="hljs-number"><span class="hljs-number">760928782</span></span><span class="hljs-params"><span class="hljs-params">|CELANESE|</span></span>VPCHOP&amp;TECH<span class="hljs-params"><span class="hljs-params">|02282017|</span></span><span class="hljs-number"><span class="hljs-number">153</span></span><span class="hljs-params"><span class="hljs-params">||</span></span>PR2552193345215<span class="hljs-params"><span class="hljs-params">|1151824|</span></span><span class="hljs-params"><span class="hljs-params">|P/R DEDUCTION ($76.92 BI-WEEKLY)|</span></span><span class="hljs-number"><span class="hljs-number">4030920171380058715</span></span></code> </pre> <br><p>  Sie müssen es analysieren und die folgenden Informationen herausfinden: </p><br><ul><li>  Die Anzahl der Zeilen in der Datei </li><li>  Namen in der 432. und 43243. Zeile (hier stellt sich die Wahrheit, wie man zählt, von 0 oder 1?) </li><li>  Der gebräuchlichste Name und wie oft er vorkommt </li><li>  Die Anzahl der Raten für jeden Monat </li></ul><br><p>  Was ist das Problem?  - Der Autor sagt ehrlich, dass er die gesamte Datei in den Speicher lädt. Aus diesem Grund „hängt“ der Knoten und der Autor gibt uns eine interessante Tatsache. </p><br><blockquote>  Unterhaltsame Tatsache: Node.js kann jeweils nur bis zu 1,67 GB Speicher speichern </blockquote><p>  Der Autor zieht aus dieser Tatsache eine seltsame Schlussfolgerung, dass es Streams sind, die die gesamte Datei in den Speicher laden, und er hat nicht den falschen Code geschrieben. <br>  Lassen Sie uns die These widerlegen: " <em>Obwohl Node.js die Ein- und Ausgänge gestreamt hat, wird immer noch versucht, die gesamte Datei zu speichern</em> ", indem wir ein kleines Programm schreiben, das die Anzahl der Zeilen in einer Datei beliebiger Größe zählt: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Writable } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'stream'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> split = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'split'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> linecounter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Writable({ write(chunk, encoding, callback) { counter = counter + <span class="hljs-number"><span class="hljs-number">1</span></span> callback() }, writev(chunks, callback) { counter = counter + chunks.length callback() } }) fs.createReadStream(<span class="hljs-string"><span class="hljs-string">'itcont.txt'</span></span>) .pipe(split()) .pipe(linecounter) linecounter.on(<span class="hljs-string"><span class="hljs-string">'finish'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(counter) })</code> </pre> <br><p>  <em>NB</em> : Der Code wurde absichtlich so einfach wie möglich geschrieben.  Globale Variablen sind schlecht! </p><br><p>  Worauf Sie achten sollten: </p><br><ul><li>  split - npm ein Paket, das einen Zeilenstrom am „Eingang“ empfängt - gibt einen Strom von Leitungssätzen mit einem getrennten Zeilenumbruch an den „Ausgang“ zurück.  Höchstwahrscheinlich als Implementierung des Transformationsstroms gemacht.  Wir leiten unseren ReadStream mit einer Datei hinein und leiten uns in ... </li><li>  linecounter - Implementierung von WritableStream.  Darin implementieren wir zwei Methoden: zum Verarbeiten eines Stücks (Chunk) und mehrerer.  Die "Zeile" in dieser Situation ist die Codezeile.  Umkehren - Fügen Sie die gewünschte Zahl zum Zähler hinzu.  Es ist wichtig zu verstehen, dass in dieser Situation nicht die gesamte Datei in den Speicher geladen wird und die API alles für uns in „Teile“ unterteilt, die für die Verarbeitung am bequemsten sind </li><li>  'finish' - Ereignisse, die "eintreten", wenn die in unserem ReadableStream eintreffenden Daten "enden".  In diesem Fall verpfänden wir Zählerdaten </li></ul><br><p>  Lassen Sie uns unsere Kreation an einer großen Datei testen: </p><br><pre> <code class="hljs markdown"><span class="hljs-quote"><span class="hljs-quote">&gt; node linecounter.js 13903993</span></span></code> </pre> <br><p>  Wie Sie sehen können, funktioniert alles.  Daraus können wir schließen, dass die Stream-API bei Dateien jeder Größe hervorragende Arbeit leistet und die Aussage des Autors des Beitrags, gelinde gesagt, nicht wahr ist.  Auf ungefähr die gleiche Weise können wir jeden anderen für das Problem erforderlichen Wert berechnen. </p><br><p>  Sagen Sie: </p><br><ul><li>  Möchten Sie lesen, wie Sie das Problem vollständig lösen und den resultierenden Code für die Wartung in eine bequeme Form bringen können? </li><li>  Verwenden Sie die Stream-API und auf welche Schwierigkeiten sind Sie gestoßen? </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de427901/">https://habr.com/ru/post/de427901/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de427891/index.html">Millionen von Menschen können durch Sicherheitslücken in der Cisco WebEx Conference Platform angegriffen werden</a></li>
<li><a href="../de427893/index.html">Bloody Lola auf Omega 2 oder Python an Halloween würgen</a></li>
<li><a href="../de427895/index.html">Entfernen von Daten aus einer Shardable-Datenbank</a></li>
<li><a href="../de427897/index.html">Analyse eines Magnetresonanztomographen II: Metamaterialien in der MRT</a></li>
<li><a href="../de427899/index.html">JsonWriterSax - eine Bibliothek zum Erstellen von JSON</a></li>
<li><a href="../de427905/index.html">Food Mining oder Crossroads mit den Augen eines Hackers</a></li>
<li><a href="../de427907/index.html">Drohnenschießen, Rechen, Life Hacks, Selbstentwicklung und Karriere eines Fotografen / Videografen: neuer GLPH-Podcast</a></li>
<li><a href="../de427909/index.html">Python: Wie kann der Speicherverbrauch um die Hälfte reduziert werden, indem nur eine Codezeile hinzugefügt wird?</a></li>
<li><a href="../de427911/index.html">Büro Leidenschaften</a></li>
<li><a href="../de427913/index.html">Unterhaltsamer Prolog Nr. 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>