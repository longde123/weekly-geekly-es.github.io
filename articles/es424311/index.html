<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòø üë®‚Äçüë©‚Äçüë¶ üôÜüèΩ L√≥gica comercial asincr√≥nica en estos d√≠as ‚ùï üèÇüèø üíâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En resumen: 


- La prueba ya est√° implementada en C ++ , JS y PHP , adecuada para Java . 
- M√°s r√°pido que coroutine y Promise, m√°s funciones. 
- No ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L√≥gica comercial asincr√≥nica en estos d√≠as</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424311/"><p>  En resumen: </p><br><blockquote><ul><li>  La prueba ya est√° implementada en <strong>C ++</strong> , <strong>JS</strong> y <strong>PHP</strong> , adecuada para <strong>Java</strong> . </li><li>  <strong>M√°s r√°pido</strong> que coroutine y Promise, m√°s funciones. </li><li>  No requiere una pila de software separada. </li><li>  Se hace amigo de todas las herramientas de seguridad y depuraci√≥n. </li><li>  Funciona en cualquier arquitectura y no requiere indicadores especiales del compilador. </li></ul><br></blockquote><a name="habracut"></a><br><hr><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mirar hacia atr√°s</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FutoIn AsyncSteps: una alternativa a las corutinas</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">A los numeros</a> </li></ul><br><h2 id="vzglyad-nazad">  Mirar hacia atr√°s </h2><br><p>  En los albores de la computadora, hab√≠a un flujo de control √∫nico con bloqueo en la entrada-salida.  Luego se le a√±adieron interrupciones de hierro.  Ahora puede usar efectivamente dispositivos lentos e impredecibles. </p><br><p>  Con el crecimiento de las capacidades de hierro y su baja disponibilidad, se hizo necesario realizar varias tareas simult√°neamente, lo que proporcion√≥ soporte de hardware.  As√≠ que hubo procesos aislados con interrupciones extra√≠das del hierro en forma de se√±ales. </p><br><p>  La siguiente etapa evolutiva fue el subprocesamiento m√∫ltiple, que se implement√≥ sobre la base de los mismos procesos, pero con acceso compartido a la memoria y otros recursos.  Este enfoque tiene sus limitaciones y una sobrecarga significativa para cambiar a un sistema operativo seguro. </p><br><p>  Para la comunicaci√≥n entre procesos e incluso m√°quinas diferentes, la abstracci√≥n Promise / Future se propuso hace m√°s de 40 a√±os. </p><br><p>  Las interfaces de usuario y el problema del cliente 10K actualmente rid√≠culo han llevado al apogeo de los enfoques Event Loop, Reactor y Proactor, que est√°n m√°s orientados a eventos que una l√≥gica comercial clara y consistente. </p><br><p>  Finalmente, llegamos a la corutina moderna (corutina), que en esencia es una emulaci√≥n de flujos sobre las abstracciones descritas anteriormente con las correspondientes limitaciones t√©cnicas y la transferencia de control determinista. </p><br><p>  Para transmitir eventos, resultados y excepciones, todos volvieron al mismo concepto de Promesa / Futuro.  Algunas oficinas decidieron nombrar un poco diferente: "Tarea". </p><br><p> Al final, escondieron todo en un hermoso paquete <code>async/await</code> , que requiere soporte de compilador o traductor dependiendo de la tecnolog√≠a. </p><br><h3 id="problemy-s-tekuschiy-situaciy-asinhronnoy-biznes-logiki">  Problemas con situaciones actuales de l√≥gica de negocios asincr√≥nicas </h3><br><p>  Considere solo corutinas y Promesa, decoradas con <code>async/await</code> , como  La existencia de problemas en los enfoques m√°s antiguos confirma el proceso de evoluci√≥n en s√≠. </p><br><p>  Estos dos t√©rminos no son id√©nticos.  Por ejemplo, en ECMAScript no hay corutinas, pero existe un alivio sint√°ctico para usar <code>Promise</code> , que a su vez solo organiza el trabajo con el infierno de devoluci√≥n de llamadas.  De hecho, los motores de secuencias de comandos como V8 van m√°s all√° y hacen optimizaciones especiales para funciones y llamadas puras y <code>async/await</code> . </p><br><p>  Los expertos <code>co_async/co_await</code> no se <code>co_async/co_await</code> en C ++ 17 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠ en el recurso</a> , pero la presi√≥n de las corutinas gigantes de software puede aparecer en el est√°ndar exactamente en su forma.  Mientras tanto, la soluci√≥n tradicionalmente reconocida es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Boost.Context</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Boost.Fiber</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Boost.Coroutine2</a> . </p><br><p>  En Java, todav√≠a no hay <code>async/await</code> a nivel de lenguaje, pero hay soluciones como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">EA Async</a> , que, como Boost.Context, deben personalizarse para cada versi√≥n de JVM y byte de c√≥digo. </p><br><p>  Go tiene sus propias rutinas, pero si observa cuidadosamente los art√≠culos y los informes de errores de los proyectos abiertos, resulta que aqu√≠ no todo es tan sencillo.  Quiz√°s perder la interfaz de rutina como entidad administrada no es una buena idea. </p><br><h4 id="mnenie-avtora-soprogrammy-na-golom-zheleze-opasny">  Opini√≥n del autor: las corutinas de metal desnudo son peligrosas </h4><br><p>  Personalmente, el autor tiene poco en contra de las rutinas en lenguajes din√°micos, pero es extremadamente cauteloso con cualquier coqueteo con la pila a nivel de c√≥digo de m√°quina. </p><br><p>  Algunos puntos: </p><br><ol><li>  Pila requerida: <br><ul><li>  stack on the heap tiene una serie de desventajas: problemas de determinaci√≥n oportuna de desbordamiento, da√±os por vecinos y otros problemas de confiabilidad / seguridad, </li><li>  una pila segura requiere al menos una p√°gina de memoria f√≠sica, una p√°gina condicional y una sobrecarga adicional para cada llamada a las funciones <code>async</code> : 4 + KB (m√≠nimo) + mayores l√≠mites del sistema, </li><li>  en √∫ltima instancia, puede ser que una parte significativa de la memoria asignada para las pilas no se use durante el tiempo de inactividad de rutina. </li></ul></li><li>  Es necesario implementar una l√≥gica compleja para guardar, restaurar y eliminar el estado de la rutina: <br><ul><li>  para cada caso de arquitectura de procesador (incluso modelos) e interfaz binaria (ABI): <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejemplo</a> , </li><li>  Las caracter√≠sticas de arquitectura nuevas u opcionales introducen problemas potencialmente latentes (por ejemplo, Intel TSX, coprocesadores ARM o MIPS), </li><li>  Otros posibles problemas debido a la documentaci√≥n cerrada de los sistemas patentados (la documentaci√≥n de Boost se refiere a esto). </li></ul></li><li>  Posibles problemas con las herramientas de an√°lisis din√°mico y con la seguridad en general: <br><ul><li>  por ejemplo, se requiere la integraci√≥n con Valgrind debido a las mismas pilas de saltos, </li><li>  es dif√≠cil hablar por los antivirus, pero probablemente no les guste en el ejemplo de los problemas con la JVM en el pasado, </li><li>  Estoy seguro de que aparecer√°n nuevos tipos de ataques y se revelar√°n las vulnerabilidades asociadas con la implementaci√≥n de las rutinas. </li></ul></li></ol><br><h4 id="mnenie-avtora-generatory-i-yield-principialnoe-zlo">  Opini√≥n del autor: generadores y <code>yield</code> mal fundamental </h4><br><p>  Este tema aparentemente de terceros est√° directamente relacionado con el concepto de corutinas y la propiedad "continuar". </p><br><p>  En resumen, debe existir un iterador completo para cualquier colecci√≥n.  Por qu√© crear un problema de generador de iterador recortado no est√° claro.  Por ejemplo, un caso con <code>range()</code> en Python es m√°s un alarde exclusivo que una excusa para una complicaci√≥n t√©cnica. </p><br><p>  Si el caso es un generador infinito, entonces la l√≥gica de su implementaci√≥n es elemental.  ¬øPor qu√© crear dificultades t√©cnicas adicionales para impulsar un ciclo continuo sin fin? </p><br><p>  La √∫nica justificaci√≥n sensata que surgi√≥ m√°s tarde que los defensores de las corutinas dan es todo tipo de analizadores de flujo con control invertido.  De hecho, este es un caso especializado estrecho para resolver problemas individuales a nivel de biblioteca, no la l√≥gica de negocios de las aplicaciones.  Al mismo tiempo, existe una soluci√≥n elegante, simple y m√°s descriptiva a trav√©s de m√°quinas de estados finitos.  El √°rea de estos problemas t√©cnicos es mucho m√°s peque√±a que el √°rea de la l√≥gica empresarial com√∫n. </p><br><p>  De hecho, el problema a resolver se obtiene de un dedo y requiere esfuerzos relativamente serios para la implementaci√≥n inicial y el soporte a largo plazo.  Tanto es as√≠ que algunos proyectos pueden introducir una prohibici√≥n sobre el uso de las rutinas de nivel de c√≥digo de m√°quina siguiendo el ejemplo de una prohibici√≥n de <code>goto</code> a <code>goto</code> o el uso de asignaci√≥n de memoria din√°mica en industrias individuales. </p><br><h4 id="mnenie-avtora-model-asyncawait-na-promise-iz-ecmascript-bolee-nadyozhna-no-trebuet-adaptacii">  Opini√≥n de los autores: el modelo Promise <code>async/await</code> ECMAScript es m√°s confiable, pero requiere adaptaci√≥n </h4><br><p>  A diferencia de las rutinas continuas, en este modelo las piezas de c√≥digo se dividen secretamente en bloques no interrumpibles dise√±ados como funciones an√≥nimas.  En C ++, esto no es del todo adecuado debido a las peculiaridades de la administraci√≥n de memoria, un ejemplo: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeObject</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">funcPromise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Promise.resolved(value_); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">funcCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::function&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">()&gt; &amp;&amp;cb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Value&amp; val)</span></span></span><span class="hljs-function"> </span></span>{ somehow_call_later(cb); } Value value_; }; <span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SomeObject some_obj; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> some_obj.funcPromise() .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>([](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception &amp;e){ <span class="hljs-comment"><span class="hljs-comment">// ... }) .then([&amp;](SomeObject::value &amp;&amp;val){ return Promise([&amp;](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ some_obj.funcCallback(resolve, val); }); }); }</span></span></code> </pre> <br><p>  En primer lugar, <code>some_obj</code> se destruir√° al salir de <code>example()</code> y antes de llamar a funciones lambda. </p><br><p>  En segundo lugar, las funciones lambda con variables o referencias de captura son objetos y secretamente agregan copiar / mover, lo que puede afectar negativamente el rendimiento con una gran cantidad de capturas y la necesidad de asignar memoria en el mont√≥n durante el borrado de tipo en la <code>std::function</code> habitual. </p><br><p>  En tercer lugar, la interfaz de <code>Promise</code> en s√≠ se concibi√≥ sobre el concepto de "promesa" del resultado, en lugar de la ejecuci√≥n coherente de la l√≥gica empresarial. </p><br><p>  Una soluci√≥n esquem√°tica NO √≥ptima podr√≠a verse as√≠: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocalContext</span></span></span><span class="hljs-class"> {</span></span> SomeObject some_obj; }; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ctx = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;LocalContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> some_obj.funcPromise() .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>([](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception &amp;e){ <span class="hljs-comment"><span class="hljs-comment">// ... }) .then([ctx](SomeObject::Value &amp;&amp;val){ struct LocalContext2 { LocalContext2(std::shared_ptr&lt;LocalContext&gt; &amp;&amp;ctx, SomeObject::Value &amp;&amp;val) : ctx(ctx), val(val) {} std::shared_ptr&lt;LocalContext&gt; ctx; SomeObject::Value val; }; auto ctx2 = std::make_shared&lt;LocalContext2&gt;( std::move(ctx), std::forward&lt;SomeObject::Value&gt;(val) ); return Promise([ctx2](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ ctx2-&gt;ctx-&gt;some_obj.funcCallback([ctx2, resolve](){ resolve(); }, val); }); }); }</span></span></code> </pre> <br><p>  <em>Nota: <code>std::move</code> lugar de <code>std::shared_ptr</code> no <code>std::shared_ptr</code> adecuado debido a la incapacidad de transferir a varias lambdas a la vez y al crecimiento de su tama√±o.</em> </p><br><p>  Con la adici√≥n de <code>async/await</code> horrores asincr√≥nicos vienen en un estado digerible: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">async </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SomeObject some_obj; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { SomeObject::Value val = await some_obj.func(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception&amp; e) ( <span class="hljs-comment"><span class="hljs-comment">// ... } // Capture "async context" return Promise([async](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ some_obj.funcCallback([async](){ resolve(); }, val); }); }</span></span></code> </pre> <br><h4 id="mnenie-avtora-planirovschik-soprogramm---eto-perebor">  Opini√≥n del autor: el planificador de rutina es un fracaso </h4><br><p>  Algunos cr√≠ticos consideran que la falta de un planificador y el uso "deshonesto" de los recursos del procesador son un problema.  Quiz√°s un problema m√°s grave es la localidad de datos y el uso eficiente de la memoria cach√© del procesador. </p><br><p>  Sobre el primer problema: la priorizaci√≥n a nivel de corutinas individuales parece una gran sobrecarga.  En cambio, se pueden operar en com√∫n para una tarea unificada espec√≠fica.  Esto es lo que hacen los flujos de tr√°fico. </p><br><p>  Esto es posible mediante la creaci√≥n de instancias separadas de Event Loop con sus propios hilos "de hierro" y la planificaci√≥n a nivel del sistema operativo.  La segunda opci√≥n es sincronizar las rutinas con una primitiva relativamente primitiva (Mutex, Throttle) en t√©rminos de competencia y / o rendimiento. </p><br><p>  La programaci√≥n asincr√≥nica no hace que los recursos del procesador sean gomosos y requiere restricciones absolutamente normales en el n√∫mero de tareas procesadas simult√°neamente y l√≠mites en el tiempo total de ejecuci√≥n. </p><br><p>  La protecci√≥n contra el bloqueo prolongado en una rutina requiere las mismas medidas que con las devoluciones de llamada, para evitar el bloqueo de las llamadas al sistema y los largos ciclos de procesamiento de datos. </p><br><p>  El segundo problema requiere investigaci√≥n, pero al menos la rutina se acumula y los detalles de la implementaci√≥n del Futuro / Promesa ya violan la localidad de los datos.  Existe la oportunidad de intentar continuar la ejecuci√≥n de la misma rutina si Future ya importa.  Se necesita un cierto mecanismo para calcular el tiempo de ejecuci√≥n o el n√∫mero de tales continuaciones para evitar que una rutina capture el tiempo completo del procesador.  Esto puede no dar un resultado o dar un resultado doble, dependiendo del tama√±o de la memoria cach√© del procesador y el n√∫mero de subprocesos. </p><br><p>  Tambi√©n hay un tercer punto: muchas implementaciones de planificadores de rutina les permiten ejecutarse en diferentes n√∫cleos de procesador, lo que, por el contrario, agrega problemas debido a la sincronizaci√≥n obligatoria al acceder a recursos compartidos.  En el caso de una sola secuencia de Event Loop, dicha sincronizaci√≥n solo se requiere a nivel l√≥gico, ya que  Se garantiza que cada bloque de devoluci√≥n de llamada s√≠ncrono funcionar√° sin una carrera con los dem√°s. </p><br><h4 id="mnenie-avtora-vsyo-horosho-v-meru">  Opini√≥n del autor: todo es bueno con moderaci√≥n </h4><br><p>  La presencia de hilos en los sistemas operativos modernos no niega el uso de procesos individuales.  Adem√°s, el procesamiento de una gran cantidad de clientes en Event Loop no niega el uso de hilos aislados de "hierro" para otras necesidades. </p><br><p>  En cualquier caso, las rutinas y diversas variantes de Event Loops complican el proceso de depuraci√≥n sin el apoyo necesario en las herramientas, y con las variables locales en la pila de rutinas, todo se vuelve a√∫n m√°s dif√≠cil: pr√°cticamente no hay forma de llegar a ellas. </p><br><hr><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2p/pp/lb/2ppplbzrvm8c0yvbasdwrojknss.png" width="326" height="326"></div><br><h2 id="futoin-asyncsteps---alternativa-soprogrammam">  FutoIn AsyncSteps: una alternativa a las corutinas </h2><br><p>  Tomamos como base el patr√≥n ya establecido de Event Loop y la organizaci√≥n de esquemas de devoluci√≥n de llamada de acuerdo con el tipo de promesa ECMAScript (JavaScript). </p><br><p>  En t√©rminos de planificaci√≥n de ejecuci√≥n, estamos interesados ‚Äã‚Äãen las siguientes actividades de Event Loop: </p><br><ol><li>  <code>Handle immediate(callack)</code> requiere una pila de llamadas limpia. </li><li>  Devoluci√≥n de llamada <code>Handle deferred(delay, callback)</code> . </li><li>  Cancele la devoluci√≥n de llamada <code>handle.cancel()</code> . </li></ol><br><p>  Entonces obtenemos una interfaz llamada <code>AsyncTool</code> , que se puede implementar de muchas maneras, incluso sobre los desarrollos probados existentes.  No tiene relaci√≥n directa con la escritura de la l√≥gica empresarial, por lo que no entraremos en m√°s detalles. </p><br><h3 id="derevo-shagov">  √Årbol de pasos: </h3><br><p>  En el concepto AsyncSteps, un √°rbol abstracto de pasos sincr√≥nicos se alinea y ejecuta al profundizar en la secuencia de creaci√≥n.  Los pasos de cada nivel m√°s profundo se establecen din√°micamente a medida que se completa dicho pasaje. </p><br><p>  Toda la interacci√≥n tiene lugar a trav√©s de una √∫nica interfaz <code>AsyncSteps</code> , que, por convenci√≥n, se pasa como primer par√°metro a cada paso.  Por convenci√≥n, el nombre del par√°metro es <code>asi</code> o est√° en desuso <code>as</code> .  Este enfoque le permite romper casi por completo la conexi√≥n entre una implementaci√≥n espec√≠fica y escribir l√≥gica empresarial en complementos y bibliotecas. </p><br><p>  En implementaciones can√≥nicas, cada paso recibe su propia instancia de un objeto que implementa <code>AsyncSteps</code> , lo que permite el seguimiento oportuno de errores l√≥gicos al usar la interfaz. </p><br><p>  Ejemplo abstracto: </p><br><pre> <code class="hljs lua"> asi.add( // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> func( asi ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func"</span></span> ) asi.add( // Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> func( asi ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 func"</span></span> ) asi.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>( <span class="hljs-string"><span class="hljs-string">"MyError"</span></span> ) }, onerror( asi, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ){ // Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> catch <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 onerror: "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ) asi.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>( <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) } ) }, onerror( asi, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ){ // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> catch <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 onerror: "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> strequal <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) { asi.success( <span class="hljs-string"><span class="hljs-string">"Prm"</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>], <span class="hljs-literal"><span class="hljs-literal">true</span></span>) } } ) asi.add( // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">2</span></span> func( asi, str_param, int_param, array_param ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func2: "</span></span> + param ) } )</code> </pre> <br><p>  Resultado de ejecuci√≥n: </p><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> func <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> func <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> onerror <span class="hljs-number"><span class="hljs-number">1</span></span>: MyError <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> onerror <span class="hljs-number"><span class="hljs-number">1</span></span>: NewError <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> func <span class="hljs-number"><span class="hljs-number">2</span></span>: Prm</code> </pre> <br><p>  En sincronizaci√≥n, se ver√≠a as√≠: </p><br><pre> <code class="hljs coffeescript"> str_res, int_res, array_res, bool_res <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func 1"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 func 1"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"MyError"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>( error ){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 onerror 1: "</span></span> + error ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>( error ){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 onerror 1: "</span></span> + error ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( error strequal <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) { str_res = <span class="hljs-string"><span class="hljs-string">"Prm"</span></span> int_res = <span class="hljs-number"><span class="hljs-number">123</span></span> array_res = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] bool_res = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { re-<span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> } } { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func 2: "</span></span> + str_res ) }</code> </pre> <br><p>  El mimetismo m√°ximo del c√≥digo s√≠ncrono tradicional es inmediatamente visible, lo que deber√≠a ayudar en la legibilidad. </p><br><p>  Desde el punto de vista de la l√≥gica empresarial, con el tiempo crece un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gran conjunto de requisitos</a> , pero podemos dividirlo en partes f√°ciles de entender.  A continuaci√≥n se describe el resultado de correr en la pr√°ctica durante cuatro a√±os. </p><br><h3 id="bazovye-api-vremeni-vypolneniya">  API de Core Runtime: </h3><br><ol><li>  <code>add(func[, onerror])</code> - imitaci√≥n de <code>try-catch</code> . </li><li>  <code>success([args...])</code> : una indicaci√≥n expl√≠cita de finalizaci√≥n exitosa: <br><ul><li>  impl√≠cito por defecto </li><li>  puede pasar los resultados al siguiente paso. </li></ul></li><li>  <code>error(code[, reason)</code> - interrupci√≥n de la ejecuci√≥n con un error: <br><ul><li>  <code>code</code> : tiene un tipo de cadena para integrarse mejor con los protocolos de red en la arquitectura de microservicios, </li><li>  <code>reason</code> : una explicaci√≥n arbitraria para una persona. </li></ul></li><li>  <code>state()</code> : un an√°logo de Thread Local Storage.  Claves asociativas predefinidas: <br><ul><li>  <code>error_info</code> : explicaci√≥n del √∫ltimo error para una persona, </li><li>  <code>last_exception</code> : puntero al objeto de la √∫ltima excepci√≥n, </li><li>  <code>async_stack</code> : una pila de llamadas as√≠ncronas en la <code>async_stack</code> que la tecnolog√≠a lo permite, </li><li>  el resto lo establece el usuario. </li></ul></li></ol><br><p>  El ejemplo anterior ya es con c√≥digo C ++ real y algunas caracter√≠sticas adicionales: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/iasyncsteps.hpp&gt; using namespace futoin; void some_api(IAsyncSteps&amp; asi) { asi.add( [](IAsyncSteps&amp; asi) { std::cout &lt;&lt; "Level 0 func 1" &lt;&lt; std::endl; asi.add( [](IAsyncSteps&amp; asi) { std::cout &lt;&lt; "Level 1 func 1" &lt;&lt; std::endl; asi.error("MyError"); }, [](IAsyncSteps&amp; asi, ErrorCode code) { std::cout &lt;&lt; "Level 1 onerror 1: " &lt;&lt; code &lt;&lt; std::endl; asi.error("NewError", "Human-readable description"); } ); }, [](IAsyncSteps&amp; asi, ErrorCode code) { std::cout &lt;&lt; "Level 0 onerror 1: " &lt;&lt; code &lt;&lt; std::endl; if (code == "NewError") { // Human-readable error info assert(asi.state().error_info == "Human-readable description"); // Last exception thrown is also available in state std::exception_ptr e = asi.state().last_exception; // NOTE: smart conversion of "const char*" asi.success("Prm", 123, std::vector&lt;int&gt;({1, 2, 3}, true)); } } ); asi.add( [](IAsyncSteps&amp; asi, const futoin::string&amp; str_res, int int_res, std::vector&lt;int&gt;&amp;&amp; arr_res) { std::cout &lt;&lt; "Level 0 func 2: " &lt;&lt; str_res &lt;&lt; std::endl; } ); }</span></span></span></span></code> </pre> <br><h3 id="api-dlya-sozdaniya-ciklov">  API para crear bucles: </h3><br><ol><li>  <code>loop( func, [, label] )</code> : paso con un cuerpo infinitamente repetible. </li><li>  <code>forEach( map|list, func [, label] )</code> : iteraci√≥n por pasos del objeto de colecci√≥n. </li><li>  <code>repeat( count, func [, label] )</code> : n√∫mero de veces especificado de iteraci√≥n por pasos. </li><li>  <code>break( [label] )</code> es un an√°logo de la interrupci√≥n de bucle tradicional. </li><li>  <code>continue( [label] )</code> es un an√°logo de la continuaci√≥n del bucle tradicional con una nueva iteraci√≥n. </li></ol><br><p>  <em>La especificaci√≥n ofrece nombres alternativos <code>breakLoop</code> , <code>continueLoop</code> y otros en caso de conflicto con palabras reservadas.</em> </p><br><p>  Ejemplo de C ++: </p><br><pre> <code class="cpp hljs"> asi.loop([](IAsyncSteps&amp; asi) { <span class="hljs-comment"><span class="hljs-comment">// infinite loop asi.breakLoop(); }); asi.repeat(10, [](IAsyncSteps&amp; asi, size_t i) { // range loop from i=0 till i=9 (inclusive) asi.continueLoop(); }); asi.forEach( std::vector&lt;int&gt;{1, 2, 3}, [](IAsyncSteps&amp; asi, size_t i, int v) { // Iteration of vector-like and list-like objects }); asi.forEach( std::list&lt;futoin::string&gt;{"1", "2", "3"}, [](IAsyncSteps&amp; asi, size_t i, const futoin::string&amp; v) { // Iteration of vector-like and list-like objects }); asi.forEach( std::map&lt;futoin::string, futoin::string&gt;(), [](IAsyncSteps&amp; asi, const futoin::string&amp; key, const futoin::string&amp; v) { // Iteration of map-like objects }); std::map&lt;std::string, futoin::string&gt; non_const_map; asi.forEach( non_const_map, [](IAsyncSteps&amp; asi, const std::string&amp; key, futoin::string&amp; v) { // Iteration of map-like objects, note the value reference type });</span></span></code> </pre> <br><h3 id="api-integracii-s-vneshnimi-sobytiyami">  API para integraci√≥n con eventos externos: </h3><br><ol><li>  <code>setTimeout( timeout_ms )</code> : arroja un error de tiempo de espera despu√©s de un tiempo de espera si el paso y su sub√°rbol no han completado la ejecuci√≥n. </li><li>  <code>setCancel( handler )</code> : establece el controlador de cancelaci√≥n, que se llama cuando el subproceso se cancela por completo y cuando la pila de pasos asincr√≥nicos se expande durante el procesamiento de errores. </li><li>  <code>waitExternal()</code> : una simple espera para un evento externo. <br><ul><li>  <em>Nota: Es seguro usarlo solo en tecnolog√≠as con un recolector de basura.</em> </li></ul></li></ol><br><p>  Una llamada a cualquiera de estas funciones hace necesaria una llamada expl√≠cita al <code>success()</code> . </p><br><p>  Ejemplo de C ++: </p><br><pre> <code class="cpp hljs"> asi.add([](IAsyncSteps&amp; asi) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> handle = schedule_external_callback([&amp;](<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> err) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { asi.error(<span class="hljs-string"><span class="hljs-string">"ExternalError"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (...) { <span class="hljs-comment"><span class="hljs-comment">// pass } } else { asi.success(); } }); asi.setCancel([=](IAsyncSteps&amp; asi) { external_cancel(handle); }); }); asi.add( [](IAsyncSteps&amp; asi) { // Raises Timeout error after specified period asi.setTimeout(std::chrono::seconds{10}); asi.loop([](IAsyncSteps&amp; asi) { // infinite loop }); }, [](IAsyncSteps&amp; asi, ErrorCode code) { if (code == futoin::errors::Timeout) { asi(); } });</span></span></code> </pre> <br><p>  Ejemplo de ECMAScript: </p><br><pre> <code class="javascript hljs">asi.add( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">asi</span></span></span><span class="hljs-function">) =&gt;</span></span> { asi.waitExternal(); <span class="hljs-comment"><span class="hljs-comment">// disable implicit success() some_obj.read( (err, data) =&gt; { if (!asi.state) { // ignore as AsyncSteps execution got canceled } else if (err) { try { asi.error( 'IOError', err ); } catch (_) { // ignore error thrown as there are no // AsyncSteps frames on stack. } } else { asi.success( data ); } } ); } );</span></span></code> </pre> <br><h3 id="api-integracii-s-futurepromise">  API de integraci√≥n de futuro / promesa: </h3><br><ol><li>  <code>await(promise_future[, on_error])</code> - esperando Future / Promise como un paso. </li><li>  <code>promise()</code> - convierte todo el flujo de ejecuci√≥n en Future / Promise, usado en lugar de <code>execute()</code> . </li></ol><br><p>  Ejemplo de C ++: </p><br><pre> <code class="hljs pgsql"> [](IAsyncSteps&amp; asi) { // Proper way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AsyncSteps instances // <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> hard dependency <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> implementation. auto new_steps = asi.newInstance(); new_steps-&gt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([](IAsyncSteps&amp; asi) {}); // Can be <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> outside <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> AsyncSteps event <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> // new_steps.promise().wait(); // <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> // new_steps.promise&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;().<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); // Proper way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> standard std::future asi.await(new_steps-&gt;promise()); // Ensure instance lifetime asi.state()["some_obj"] = std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>(new_steps); };</code> </pre> <br><h3 id="api-kontrolya-potoka-vypolneniya-biznes-logiki">  API de control de flujo de l√≥gica de negocios: </h3><br><ol><li>  <code>AsyncSteps(AsyncTool&amp;)</code> es un constructor que une un hilo de ejecuci√≥n a un Event Loop espec√≠fico. </li><li>  <code>execute()</code> : inicia el hilo de ejecuci√≥n. </li><li>  <code>cancel()</code> - cancela el hilo de ejecuci√≥n. </li></ol><br><p>  Ya se requiere una implementaci√≥n de interfaz espec√≠fica aqu√≠. </p><br><p>  Ejemplo de C ++: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/ri/asyncsteps.hpp&gt; #include &lt;futoin/ri/asynctool.hpp&gt; void example() { futoin::ri::AsyncTool at; futoin::ri::AsyncSteps asi{at}; asi.loop([&amp;](futoin::IAsyncSteps &amp;asi){ // Some infinite loop logic }); asi.execute(); std::this_thread::sleep_for(std::chrono::seconds{10}); asi.cancel(); // called in d-tor by fact }</span></span></span></span></code> </pre> <br><h3 id="prochie-api">  otras API: </h3><br><ol><li>  <code>newInstance()</code> : le permite crear un nuevo hilo de ejecuci√≥n sin dependencia directa de la implementaci√≥n. </li><li>  <code>sync(object, func, onerror)</code> : lo mismo, pero con sincronizaci√≥n relativa a un objeto que implementa la interfaz correspondiente. </li><li>  <code>parallel([on_error])</code> - <code>add()</code> , cuyos pasos secundarios son secuencias AsyncSteps separadas: <br><ul><li>  todos los hilos tienen un <code>state()</code> com√∫n <code>state()</code> , </li><li>  el subproceso principal contin√∫a la ejecuci√≥n al finalizar todos los elementos secundarios </li><li>  un error no detectado en cualquier hijo cancela inmediatamente todos los otros hilos hijos. </li></ul></li></ol><br><p>  Ejemplos de C ++: </p><br><pre> <code class="cpp hljs"> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/ri/mutex.hpp&gt; using namespace futoin; ri::Mutex mtx_a; void sync_example(IAsyncSteps&amp; asi) { asi.sync(mtx_a, [](IAsyncSteps&amp; asi) { // synchronized section asi.add([](IAsyncSteps&amp; asi) { // inner step in the section // This synchronization is NOOP for already // acquired Mutex. asi.sync(mtx_a, [](IAsyncSteps&amp; asi) { }); }); }); } void parallel_example(IAsyncSteps&amp; asi) { using OrderVector = std::vector&lt;int&gt;; asi.state("order", OrderVector{}); auto&amp; p = asi.parallel([](IAsyncSteps&amp; asi, ErrorCode) { // Overall error handler asi.success(); }); p.add([](IAsyncSteps&amp; asi) { // regular flow asi.state&lt;OrderVector&gt;("order").push_back(1); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(4); }); }); p.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(2); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(5); asi.error("SomeError"); }); }); p.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(3); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(6); }); }); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order"); // 1, 2, 3, 4, 5 }); };</span></span></span></span></code> </pre> <br><h3 id="standartnye-primitivy-dlya-sinhronizacii">  Primitivas est√°ndar para sincronizaci√≥n </h3><br><ol><li>  <code>Mutex</code> : restringe la ejecuci√≥n simult√°nea de <code>N</code> subprocesos con una cola en <code>Q</code> , de forma predeterminada <code>N=1, Q=unlimited</code> . </li><li>  <code>Throttle</code> : limita el n√∫mero de entradas <code>N</code> en el per√≠odo <code>P</code> con una cola en <code>Q</code> , por defecto <code>N=1, P=1s, Q=0</code> . </li><li>  <code>Limiter</code> es una combinaci√≥n de <code>Mutex</code> y <code>Throttle</code> , que generalmente se usa en la entrada de procesamiento de solicitudes externas y cuando se llaman a sistemas externos con el prop√≥sito de una operaci√≥n estable bajo carga. </li></ol><br><p>  En caso de <code>DefenseRejected</code> l√≠mites de <code>DefenseRejected</code> cola, se <code>DefenseRejected</code> un error <code>DefenseRejected</code> , cuyo significado queda claro en la descripci√≥n del <code>Limiter</code> . </p><br><h3 id="klyuchevye-preimuschestva">  Beneficios clave </h3><br><p>  El concepto de AsyncSteps no era un fin en s√≠ mismo, sino que naci√≥ de la necesidad de una ejecuci√≥n asincr√≥nica m√°s controlada de programas en t√©rminos de l√≠mite de tiempo, cancelaci√≥n y conectividad general de devoluciones de llamada individuales.  Ninguna de las soluciones universales en ese momento y ahora ofrecen la misma funcionalidad.  Por lo tanto: </p><br><p> <strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> FTN12</a>   </strong> ‚Äî           . </p><br><p> <strong>  <code>setCancel()</code></strong> ‚Äî                    .       ,     .   RAII  <code>atexit()</code>   . </p><br><p> <strong>   <code>cancel()</code></strong> ‚Äî     ,         .   <code>SIGTERM</code>  <code>pthread_cancel()</code> ,       . </p><br><p> <strong>   <code>setTimeout()</code></strong> ‚Äî                 .    ,    "Timeout". </p><br><p> <strong>     </strong> ‚Äî  FutoIn AsyncSteps             . </p><br><p> <strong>      </strong> ‚Äî          ABI     ,    .    Embedded     MMU. </p><br><hr><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yj/8x/wv/yj8xwvibm7tjsj30qhojwbleige.jpeg"></div><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em> </em></a> </p><br><h2 id="k-cifram">   </h2><br><p>    Intel Xeon E3-1245v2/DDR1333  Debian Stretch    . </p><br><p>   : </p><br><ol><li> Boost.Fiber  <code>protected_fixedsize_stack</code> . </li><li> Boost.Fiber  <code>pooled_fixedsize_stack</code>     . </li><li> FutoIn AsyncSteps   . </li><li> FutoIn AsyncSteps      ( <code>FUTOIN_USE_MEMPOOL=false</code> ). <br><ul><li>      <code>futoin::IMemPool</code> . </li></ul></li><li> FutoIn NitroSteps&lt;&gt; ‚Äî           . <br><ul><li>         . </li></ul></li></ol><br><p>    Boost.Fiber    : </p><br><ol><li>     1 . . </li><li>       30 .   1 . . <br><ul><li>   30 .     <code>mmap()/mprotect()</code>  <code>boost::fiber::protected_fixedsize_stack</code> . </li><li>          . </li></ul></li><li>   30 .   10 .     . <br><ul><li>    ""          . </li></ul></li></ol><br><p>      "" , ..     ,       .        .   . </p><br><p>    GCC 6.3.0.   lang  tcmalloc  ,     . </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitLab</a> . </p><br><h3 id="1-posledovatelnoe-sozdanie"> 1.   </h3><br><table><thead><tr><th>  </th><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 4.8s </td><td> 208333.333Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 0.23s </td><td> 4347826.086Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>0.21s</strong> </td><td> <strong>4761904.761Hz</strong> </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 0.31s </td><td> 3225806.451Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> 0.255s </td><td> 3921568.627Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qm/ur/y6/qmury65-mbkth_om8smkfi7vamq.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>     Boost.Fiber -      ,     <code>pooled_fixedsize_stack</code>   ,    AsyncSteps. </p><br><h3 id="2-parallelnoe-sozdanie-i-ispolnenie"> 2.     </h3><br><table><thead><tr><th>  </th><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 6.31s </td><td> 158478.605Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 1.558s </td><td> 641848.523Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>1.13s</strong> </td><td> <strong>884955.752Hz</strong> </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 1.353s </td><td> 739098.300Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> 1.43s </td><td> 699300.699Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0s/gz/lu/0sgzlur2xsrlf-wo4mrcynvzhxi.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>    ,          .    ,        ‚Äî            . </p><br><h3 id="3-parallelnye-cikly"> 3.   </h3><br><table><thead><tr><th>  </th><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 5.096s </td><td> 1962323.390Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 5.077s </td><td> 1969667.126Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> 5.361s </td><td> 1865323.633Hz </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 8.288s </td><td> 1206563.706Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> <strong>3.68s</strong> </td><td> <strong>2717391.304Hz</strong> </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/c1/17/pbc117djqds0d4twh5fzcklsmfc.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>   ,        Boost.Fiber      AsyncSteps,    NitroSteps. </p><br><h3 id="ispolzovanie-pamyati-po-rss">   ( RSS) </h3><br><table><thead><tr><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 124M </td></tr><tr><td> Boost.Fiber pooled </td><td> 505M </td></tr><tr><td> FutoIn AsyncSteps </td><td> 124M </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> <strong>84M</strong> </td></tr><tr><td> FutoIn NitroSteps </td><td> 115M </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ol/w0/6n/olw06nef5wj3ah1lo9u-pby9sfg.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>  , Boost.Fiber  . </p><br><h3 id="bonus-testy-na-nodejs"> :   Node.js </h3><br><p>      -  <code>Promise</code> : +    10 . .   10 .          JIT  <code>NODE_ENV=production</code> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>@futoin/optihelp</code></a> . </p><br><p>      <a href="">GitHub</a>  <a href="">GitLab</a> .   Node.js v8.12.0  v10.11.0,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FutoIn CID</a> . </p><br><table><thead><tr><th> Tech </th><th> Simple </th><th> Loop </th></tr></thead><tbody><tr><td> <strong>Node.js v10</strong> </td><td></td><td></td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>1342899.520Hz</strong> </td><td> 587.777Hz </td></tr><tr><td> async/await </td><td> 524983.234Hz </td><td> <strong>630.863Hz</strong> </td></tr><tr><td> <strong>Node.js v8</strong> </td><td></td><td></td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>682420.735Hz</strong> </td><td> <strong>588.336Hz</strong> </td></tr><tr><td> async/await </td><td> 365050.395Hz </td><td> 400.575Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x7/-n/b5/x7-nb5v9dfkwn1lttyg67w2b_tk.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gh/yj/9p/ghyj9pczw0smbfksq-aad_tltay.png"></div><br><p> <em> ‚Äî .</em> </p><br><p>   <code>async/await</code> ? ,   V8  Node.js v10       . </p><br><p>  ,   Promise  <code>async/await</code> <strong></strong> Node.js Event Loop.          ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> ),   FutoIn AsyncSteps   . </p><br><p> <em>   AsyncSteps  Node.js Event Loop      <code>async/await</code>  -  Node.js v10.</em> </p><br><p> <em>,      ++   ‚Äî    .  ,    Node.js    10 .</em> </p><br><h3 id="vyvody">  Conclusiones </h3><br><p>   C++, FutoIn AsyncSteps  Boost.Fiber       ,     Boost.Fiber         <code>mmap()/mprotect</code> . </p><br><p>       ,      -      ,   .     . </p><br><p> FutoIn AsyncSteps  JavaScript  <code>async/await</code>       Node.js v10. </p><br><p>   ,       -,       .        . </p><br><p>   -                        ""  .     ‚Äî   API. </p><br><hr><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p> ,  FutoIn AsyncSteps ,          "" <code>async/await</code> . ,         .      <code>Promise</code>  ECMAScript, AsyncSteps    ""           . </p><br><p>               .        AsyncSteps  NitroSteps   . </p><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> ,    - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> . </p><br><p>       Java/JVM         ‚Äî    .    . </p><br><p>      ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitLab</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es424311/">https://habr.com/ru/post/es424311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es424297/index.html">Curso MIT "Seguridad de sistemas inform√°ticos". Lecci√≥n 9: Seguridad de aplicaciones web, Parte 3</a></li>
<li><a href="../es424301/index.html">Algoritmo de filtro de imagen de red neuronal adaptativo</a></li>
<li><a href="../es424305/index.html">RIB de arquitectura m√≥vil multiplataforma de Uber</a></li>
<li><a href="../es424307/index.html">GitLab 11.3 lanzado con repositorio Maven y entornos seguros</a></li>
<li><a href="../es424309/index.html">DevCore: parte del software del proyecto DevBoy</a></li>
<li><a href="../es424313/index.html">EveryLang es un programa que puede hacer casi todo</a></li>
<li><a href="../es424315/index.html">Una nueva ronda de sustituci√≥n de importaciones. ¬øD√≥nde correr y qu√© hacer?</a></li>
<li><a href="../es424319/index.html">La estructura de la tienda en l√≠nea. Parte 2</a></li>
<li><a href="../es424321/index.html">Poner NetFlow barato y enojado</a></li>
<li><a href="../es424323/index.html">Un ejemplo de trabajo con el m√©todo ICE del gerente de producto de Google y Microsoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>