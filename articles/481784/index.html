<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ú üßóüèæ üí° C√≥mo se hizo realidad Kafka üöä üèáüèª üéê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! 


 Trabajo en el equipo de Tinkoff, que est√° desarrollando su propio centro de notificaciones. En su mayor parte, desarrollo en Java usand...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo se hizo realidad Kafka</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/481784/"><p><img src="https://habrastorage.org/webt/d1/z0/m1/d1z0m1b3kvl5hobn4_4nnxuxc3o.png"></p><br><p>  Hola Habr! </p><br><p>  Trabajo en el equipo de Tinkoff, que est√° desarrollando su propio centro de notificaciones.  En su mayor parte, desarrollo en Java usando Spring boot y resuelvo varios problemas t√©cnicos que surgen en el proyecto. </p><br><p>  La mayor√≠a de nuestros microservicios interact√∫an de forma as√≠ncrona entre s√≠ a trav√©s de un intermediario de mensajes.  Anteriormente, utilizamos IBM MQ como intermediario, que dej√≥ de hacer frente a la carga, pero al mismo tiempo ten√≠a altas garant√≠as de entrega. </p><br><p>  Como reemplazo, se nos ofreci√≥ Apache Kafka, que tiene una alta escalabilidad, pero, desafortunadamente, requiere un enfoque de configuraci√≥n casi individual para diferentes escenarios.  Adem√°s, el mecanismo de entrega de al menos una vez, que funciona por defecto en Kafka, no permiti√≥ mantener el nivel de consistencia requerido de f√°brica.  A continuaci√≥n, compartir√© nuestra experiencia en la configuraci√≥n de Kafka, en particular, le dir√© c√≥mo configurar y vivir exactamente con una sola entrega. </p><a name="habracut"></a><br><h2 id="garantirovannaya-dostavka-i-ne-tolko">  Entrega garantizada y m√°s. </h2><br><p>  Los par√°metros que se analizar√°n m√°s adelante ayudar√°n a evitar una serie de problemas con la configuraci√≥n de conexi√≥n predeterminada.  Pero primero, quiero prestar atenci√≥n a un par√°metro que facilitar√° una posible depuraci√≥n. </p><br><p>  <strong>Client.id</strong> para Productor y Consumidor ayudar√° con esto.  A primera vista, puede usar el nombre de la aplicaci√≥n como valor, y en la mayor√≠a de los casos esto funcionar√°.  Aunque la situaci√≥n en la que se usan varios consumidores en la aplicaci√≥n y usted les da el mismo client.id lleva a la siguiente advertencia: </p><br><pre><code class="java hljs">org.apache.kafka.common.utils.AppInfoParser ‚Äî Error registering AppInfo mbean javax.management.InstanceAlreadyExistsException: kafka.consumer:type=app-info,id=kafka.test-<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Si desea usar JMX en una aplicaci√≥n con Kafka, entonces esto puede ser un problema.  Para este caso, es mejor usar una combinaci√≥n del nombre de la aplicaci√≥n y, por ejemplo, el nombre del tema, como el valor de client.id.  El resultado de nuestra configuraci√≥n se puede ver en la salida del comando <strong>kafka-consumer-groups</strong> de las utilidades de Confluent: </p><br><p><img src="https://habrastorage.org/webt/1e/qh/1z/1eqh1zw485osmsizmx6gu9_d8ne.png"></p><br><p>  Ahora analizaremos el escenario de entrega garantizada de mensajes.  Kafka Producer tiene un par√°metro <strong>acks</strong> que le permite configurar despu√©s de cu√°ntos acuses de recibo el l√≠der del cl√∫ster debe considerar el mensaje grabado con √©xito.  Este par√°metro puede tomar los siguientes valores: </p><br><ul><li>  0 - el reconocimiento no ser√° considerado. </li><li>  1 - par√°metro predeterminado, se requiere confirmaci√≥n de solo 1 r√©plica. </li><li>  ‚àí1: se requiere confirmaci√≥n de todas las r√©plicas sincronizadas ( <strong>configuraci√≥n de</strong> cl√∫ster <strong>min.insync.replicas</strong> ). </li></ul><br><p>  Se puede ver a partir de los valores anteriores que acks igual a -1 da las garant√≠as m√°s fuertes de que el mensaje no se perder√°. </p><br><p>  Como todos sabemos, los sistemas distribuidos no son confiables.  Para protegerse contra el mal funcionamiento temporal, Kafka Producer proporciona un par√°metro de <strong>reintentos</strong> que le permite establecer el n√∫mero de intentos de reintento durante <strong>delivery.timeout.ms</strong> .  Dado que el par√°metro de reintentos predeterminado es Integer.MAX_VALUE (2147483647), el n√∫mero de retransmisiones de un mensaje puede controlarse cambiando solo delivery.timeout.ms. </p><br><h2 id="dvizhemsya-k-exactly-once-delivery">  Avanzando hacia exactamente una vez la entrega </h2><br><p>  Esta configuraci√≥n permite a nuestro Productor entregar mensajes con una alta garant√≠a.  ¬øAhora hablemos sobre c√≥mo garantizar la grabaci√≥n de una sola copia de un mensaje en un tema de Kafka?  En el caso m√°s simple, para hacer esto en Producer, establezca el par√°metro <strong>enable.idempotence</strong> en verdadero.  La idempotencia garantiza la grabaci√≥n de un solo mensaje en una partici√≥n particular de un tema.  Un requisito previo para habilitar la idempotencia es <strong>acks = all, retry&gt; 0, max.in.flight.requests.per.connection ‚â§ 5</strong> .  Si el desarrollador no establece estos par√°metros, los valores anteriores se establecer√°n autom√°ticamente. </p><br><p>  Cuando se configura la idempotencia, es necesario asegurarse de que los mismos mensajes caigan en las mismas particiones cada vez.  Esto se puede hacer configurando la clave y el par√°metro divisioner.class en Producer.  Comencemos con la llave.  Para cada env√≠o, debe ser el mismo.  Esto se logra f√°cilmente utilizando cualquier identificador comercial del mensaje original.  El par√°metro divisioner.class tiene un valor predeterminado de <a href="">DefaultPartitioner</a> .  Con esta estrategia de partici√≥n, el comportamiento predeterminado es el siguiente: </p><br><ul><li>  Si la partici√≥n se especifica expl√≠citamente al enviar el mensaje, entonces la usamos. </li><li>  Si no se especifica la partici√≥n, pero se especifica la clave, seleccione la partici√≥n por hash de la clave. </li><li>  Si la partici√≥n y la clave no est√°n especificadas, seleccione las particiones a su vez (round-robin). </li></ul><br><p>  Adem√°s, el uso de la clave y el env√≠o idempotente con el par√°metro <strong>max.in.flight.requests.per.connection = 1</strong> le brinda un procesamiento ordenado de los mensajes en el consumidor.  Por separado, vale la pena recordar que si el control de acceso est√° configurado en su cl√∫ster, necesitar√° los derechos para escribir de forma idempotente sobre el tema. </p><br><p>  Si de repente carece de las capacidades de env√≠o idempotente por clave o la l√≥gica en el lado del productor requiere la preservaci√≥n de la consistencia de los datos entre diferentes particiones, entonces las transacciones vendr√°n al rescate.  Adem√°s, utilizando una transacci√≥n en cadena, puede sincronizar condicionalmente un registro en Kafka, por ejemplo, con un registro en la base de datos.  Para habilitar el env√≠o transaccional al Productor, es necesario que posea idempotencia y, opcionalmente, establezca <strong>transaccional.id</strong> .  Si el control de acceso est√° configurado en su cl√∫ster Kafka, entonces para la grabaci√≥n transaccional, as√≠ como idempotente, necesitar√° permisos de escritura, que pueden otorgarse mediante una m√°scara utilizando el valor almacenado en transaccional.id. </p><br><p>  Formalmente, puede usar cualquier cadena, por ejemplo, el nombre de la aplicaci√≥n, como un identificador de transacci√≥n.  Pero si ejecuta varias instancias de la misma aplicaci√≥n con el mismo transaccional.id, la primera instancia iniciada se detendr√° con un error, ya que Kafka lo considerar√° un proceso zombie. </p><br><pre> <code class="java hljs">org.apache.kafka.common.errors.ProducerFencedException: Producer attempted an operation with an old epoch. Either there is a newer producer with the same transactionalId, or the producer<span class="hljs-string"><span class="hljs-string">'s transaction has been expired by the broker.</span></span></code> </pre> <br><p>  Para resolver este problema, agregamos un sufijo al nombre de la aplicaci√≥n en forma de nombre de host, que se obtiene de las variables de entorno. </p><br><p>  El productor est√° configurado, pero las transacciones en Kafka controlan solo el alcance del mensaje.  Independientemente del estado de la transacci√≥n, el mensaje cae inmediatamente en el tema, pero tiene atributos del sistema adicionales. </p><br><p>  Para evitar que el consumidor lea dichos mensajes con anticipaci√≥n, debe establecer el par√°metro isolated.level en read_committed.  Tal Consumidor podr√° leer mensajes no transaccionales como antes, y los transaccionales solo despu√©s de una confirmaci√≥n. <br>  Si instal√≥ todas las configuraciones enumeradas anteriormente, entonces configur√≥ exactamente una vez la entrega.  Felicidades </p><br><p>  Pero hay un matiz m√°s.  Transactional.id, que configuramos anteriormente, es en realidad un prefijo de transacci√≥n.  En el administrador de transacciones, se le agrega un n√∫mero de serie.  El identificador recibido se emite en <strong>transactional.id.expiration.ms</strong> , que se configura en el cl√∫ster de Kafka y tiene un valor predeterminado de "7 d√≠as".  Si durante este tiempo la aplicaci√≥n no recibi√≥ ning√∫n mensaje, cuando intente el siguiente env√≠o transaccional, recibir√° una <strong>InvalidPidMappingException</strong> .  Despu√©s de eso, el coordinador de transacciones emitir√° un nuevo n√∫mero de secuencia para la pr√≥xima transacci√≥n.  Sin embargo, el mensaje se puede perder si InvalidPidMappingException no se procesa correctamente. </p><br><h2 id="vmesto-itogov">  En lugar de totales </h2><br><p>  Como puede ver, solo enviar mensajes a Kafka no es suficiente.  Debe elegir una combinaci√≥n de par√°metros y estar preparado para realizar cambios r√°pidos.  En este art√≠culo, intent√© mostrar exactamente una vez las configuraciones de entrega en detalle y describ√≠ varios problemas de configuraci√≥n de client.id y transactional.id que encontramos.  El resumen de la configuraci√≥n de Productor y Consumidor se resume a continuaci√≥n. </p><br><p>  Productor: </p><br><ol><li>  acks = todos </li><li>  reintentos&gt; 0 </li><li>  enable.idempotence = true </li><li>  max.in.flight.requests.per.connection ‚â§ 5 (1 - para env√≠o ordenado) </li><li>  transaccional.id = $ {nombre-aplicaci√≥n} - $ {nombre de host} </li></ol><br><p>  Consumidor: </p><br><ol><li>  isolated.level = read_committed </li></ol><br><p>  Para minimizar los errores en futuras aplicaciones, creamos nuestro contenedor sobre la configuraci√≥n del resorte, donde los valores para algunos de los par√°metros enumerados ya est√°n establecidos. </p><br><p>  Y aqu√≠ hay un par de materiales para estudio independiente: </p><br><ul><li>  <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-98%2B-%2BExactly%2BOnce%2BDelivery%2Band%2BTransactional%2BMessaging">KIP-98 - Exactamente una vez entrega y mensajer√≠a transaccional</a> </li><li>  <a href="https://kafka.apache.org/documentation/">Descripci√≥n de la configuraci√≥n</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/481784/">https://habr.com/ru/post/481784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../481774/index.html">Hojas de trucos de seguridad: parches virtuales</a></li>
<li><a href="../481776/index.html">Servicios 5G y de juegos en la nube: pruebe c√≥mo funciona en Mosc√∫</a></li>
<li><a href="../481778/index.html">An√°lisis de malware Skeleton Key</a></li>
<li><a href="../481780/index.html">MyOffice tiene m√°s de 200 nuevas funciones.</a></li>
<li><a href="../481782/index.html">Acerca de los problemas de Python Translator y repensar el lenguaje</a></li>
<li><a href="../481786/index.html">Google entierra la extensi√≥n PHP IMAP</a></li>
<li><a href="../481788/index.html">An√°lisis para resolver problemas reales de la industria (salvar lechones y otros)</a></li>
<li><a href="../481790/index.html">C√≥mo las trampas est√°n cambiando la comunidad speedrunner</a></li>
<li><a href="../481792/index.html">C√≥mo PVS-Studio celebr√≥ la segunda mitad de las conferencias de 2019</a></li>
<li><a href="../481794/index.html">Beckender - un psicoterapeuta: un depurador de la psique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>