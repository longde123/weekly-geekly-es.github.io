<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÜ ü•Å üë©üèø Application Web sur Kotlin + Spring Boot + Vue.js (module compl√©mentaire) üê¢ üôÜüèº ‚úäüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, chers habitants de Habr! 

 Comme son nom l'indique, cet article est un ajout √† l' application Web pr√©c√©demment √©crite sur Kotlin + Spring Bo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Application Web sur Kotlin + Spring Boot + Vue.js (module compl√©mentaire)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482222/">  Bonjour, chers habitants de Habr! <br><br>  Comme son nom l'indique, cet article est un ajout √† l' <a href="https://habr.com/ru/post/467161/">application Web</a> pr√©c√©demment √©crite <a href="https://habr.com/ru/post/467161/">sur Kotlin + Spring Boot + Vue.js</a> , qui nous permet d'am√©liorer le squelette d'une future application et de la rendre plus facile √† travailler avec. <br><a name="habracut"></a><br>  Avant de commencer l'histoire, permettez-moi de remercier tous ceux qui ont comment√© dans l'article pr√©c√©dent. <br><br><h3>  Table des mati√®res </h3><br><ul><li>  <a href="https://habr.com/ru/post/482222/">Configuration CI / CD (Heroku)</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Protection contre les bots (reCAPTCHA)</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Envoi d'email</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Migration Gradle</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Stockage du jeton JWT dans les cookies</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Confirmation d'inscription par e-mail</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Liens utiles</a> </li></ul><br><a name="cicd"></a><br><h2>  Configuration CI / CD (Heroku) </h2><br>  Prenons l'exemple de la mise en ≈ìuvre d'une int√©gration et d'une livraison continues en utilisant la plate-forme PaaS cloud <a href="https://www.heroku.com/" rel="nofollow">Heroku</a> . <br><br>  La premi√®re chose que nous devons faire est de mettre le code d'application dans le r√©f√©rentiel sur <a href="https://github.com/" rel="nofollow">GitHub</a> .  Pour qu'il n'y ait rien de superflu dans le r√©f√©rentiel, je recommande le contenu suivant du fichier <i>.gitignore</i> : <br><br><div class="spoiler">  <b class="spoiler_title">.gitignore</b> <div class="spoiler_text"><pre><code class="plaintext hljs">*.class # Help # backend/*.md # Package Files # *.jar *.war *.ear # Eclipse # .settings .project .classpath .studio target # NetBeans # backend/nbproject/private/ backend/nbbuild/ backend/dist/ backend/nbdist/ backend/.nb-gradle/ backend/build/ # Apple # .DS_Store # Intellij # .idea *.iml *.log # logback logback.out.xml backend/src/main/resources/public/ backend/target backend/.mvn backend/mvnw frontend/dist/ frontend/node/ frontend/node_modules/ frontend/npm-debug.log frontend/target !.mvn/wrapper/maven-wrapper.jar</code> </pre> <br></div></div><br>  <u>Important:</u> avant de commencer √† travailler avec Heroku, ajoutez un fichier appel√© <i>Procfile</i> (sans aucune extension) au r√©pertoire racine avec la ligne: <br>  <code>web: java -Dserver.port=$PORT -jar backend/target/backend-0.0.1-SNAPSHOT.jar</code> , o√π <i>backend-0.0.1-SNAPSHOT.jar</i> est le nom du fichier JAR d' <i>assembly</i> .  Et assurez-vous de <u>vous engager et de pousser</u> . <br><br>  <u>Remarque:</u> vous pouvez √©galement ajouter le fichier travis.yaml au r√©pertoire racine pour r√©duire le temps de g√©n√©ration et de d√©ploiement de l'application sur Heroku: <br><br><div class="spoiler">  <b class="spoiler_title">travis.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">language: java jdk: - oraclejdk8 script: mvn clean install jacoco:report coveralls:report cache: directories: - node_modules</code> </pre> <br></div></div><br>  Ensuite: <br><br>  <b># 1</b> Inscrivez-vous sur <a href="https://www.heroku.com/" rel="nofollow">Heroku</a> . <br><br>  <b># 2</b> Cr√©ez une nouvelle application: <br><br><div class="spoiler">  <b class="spoiler_title">Cr√©er une nouvelle application</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/u3/ml/bx/u3mlbx0w2ho3uezsrl75nyse2m4.png"><br></div></div><br>  <b># 3</b> Heroku vous permet de connecter des ressources suppl√©mentaires √† l'application, par exemple, la base de donn√©es PostreSQL.  Pour ce faire, faites: <i>Application -&gt; Ressources -&gt; Modules compl√©mentaires -&gt; Heroku Postgres</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Postgres Heroku</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/k5/l8/ht/k5l8htgji3kaxmqyznbdqhyeuki.png"><br></div></div><br>  <b># 4</b> Choisissez un plan: <br><br><div class="spoiler">  <b class="spoiler_title">S√©lection du plan</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/id/jv/vd/idjvvdwyyk9ou_wbes00mxvfdac.png"><br></div></div><br>  <b># 5</b> Vous pouvez maintenant voir la ressource connect√©e: <br><br><div class="spoiler">  <b class="spoiler_title">Ressource connect√©e</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/l2/mx/mf/l2mxmf3itjef2-1lpiwmltrtadq.png"><br></div></div><br>  <b># 6</b> Regardez les informations d'identification, elles seront n√©cessaires pour configurer les variables d'environnement: <i>Param√®tres -&gt; Afficher les informations d'identification</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Afficher les informations d'identification</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/gh/xl/v9/ghxlv99r9m2mgrr6ceemgpn-hjg.png"><br></div></div><br>  <b># 7</b> D√©finissez les variables d'environnement: <i>Application -&gt; Param√®tres -&gt; Reveal Config Vars</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Variables d'environnement</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xr/uj/q8/xrujq8lynqi6kqoqtqiklpwbaxu.png"><br></div></div><br>  <b># 8</b> D√©finissez les variables d'environnement pour la connexion au format suivant: <br><br><pre> <code class="plaintext hljs">SPRING_DATASOURCE_URL = jdbc:postgresql://&lt;i&gt;hostname:port&lt;/i&gt;/&lt;i&gt;db_name&lt;/i&gt; SPRING_DATASOURCE_USERNAME = &lt;i&gt;username&lt;/i&gt; SPRING_DATASOURCE_PASSWORD = &lt;i&gt;password&lt;/i&gt;</code> </pre><br><div class="spoiler">  <b class="spoiler_title">√Ä quoi √ßa ressemble</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/me/jr/ne/mejrnecja54rgwchq6peumbc6w0.png"><br></div></div><br>  <b># 9</b> Cr√©ez toutes les tables n√©cessaires dans la nouvelle base de donn√©es. <br><br>  <b># 10</b> Le fichier application.properties, respectivement, devrait ressembler √† ceci: <br><br><div class="spoiler">  <b class="spoiler_title">application.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">spring.datasource.url=${SPRING_DATASOURCE_URL} spring.datasource.username=${SPRING_DATASOURCE_USERNAME} spring.datasource.password=${SPRING_DATASOURCE_PASSWORD} spring.jpa.generate-ddl=true spring.jpa.properties.hibernate.temp.use_jdbc_metadata_defaults = false spring.jpa.database-platform=org.hibernate.dialect.PostgreSQL9Dialect spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true</code> </pre><br></div></div><br>  <b># 11</b> Cr√©er un <i>nouveau pipeline</i> - <i>Cr√©er un nouveau pipeline</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Cr√©er un nouveau pipeline</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dh/sg/wb/dhsgwbhgaz9arzl4lgwkdoykeda.png"><br></div></div><br>  <b># 12</b> M√©thode de d√©ploiement - <i>GitHub</i> (cliquez sur <i>Se connecter √† GitHub</i> et suivez les instructions dans une nouvelle fen√™tre). <br><br>  <b># 13</b> <i>Activer les d√©ploiements automatiques</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Activer les d√©ploiements automatiques</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/8e/fb/ui/8efbuinhnr0y1j7eggqkhbjae2s.png"><br></div></div><br>  <b># 14</b> D√©ploiement manuel - Cliquez sur <i>D√©ployer la branche</i> pour le premier d√©ploiement.  Dans le navigateur, vous verrez la sortie de la ligne de commande. <br><br><div class="spoiler">  <b class="spoiler_title">D√©ploiement manuel</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/7i/5m/tz/7i5mtzam___vhonxjbtuogrg-ay.png"><br></div></div><br>  <b># 15</b> Cliquez sur <i>Afficher</i> apr√®s la g√©n√©ration r√©ussie pour ouvrir l'application d√©ploy√©e: <br><br><div class="spoiler">  <b class="spoiler_title">Afficher</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/cp/p-/fr/cpp-frnkeudluh4bm1ir-f4oi10.png"><br></div></div><br><a name="recaptcha"></a><br><h2>  Protection contre les bots (reCAPTCHA) </h2><br>  La premi√®re √©tape pour activer la v√©rification reCAPTCHA dans notre application consiste √† cr√©er un nouveau reCAPTCH dans <a href="https://www.google.com/recaptcha/intro/v3.html" rel="nofollow">le panneau d'administration de Google</a> .  L√†, nous cr√©ons un nouveau site (Ajouter un nouveau site / Cr√©er) et d√©finissons les param√®tres suivants: <br><br><div class="spoiler">  <b class="spoiler_title">Param√®tres ReCAPTCHA</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xi/eh/rp/xiehrpgngjvxqvd1dq-4wp5gfqc.png"><br></div></div><br>  Dans la section <i>Domaines</i> , vous devez sp√©cifier en plus de l'adresse o√π l'application va vivre, vous devez sp√©cifier <code>localhost</code> , de sorte que lors du d√©bogage, vous √©vitiez les probl√®mes sous la forme de l'impossibilit√© de se connecter √† votre application. <br><br>  <b>Backend</b> <br><br>  Enregistrez la <i>cl√©</i> du <i>site</i> et <i>la cl√© secr√®te</i> ... <br><br><div class="spoiler">  <b class="spoiler_title">cl√© de site / cl√© secr√®te</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hs/re/-t/hsre-ttxpgbhgau9q4fsvtdqxq0.png"><br></div></div><br>  ... puis de les affecter √† des variables d'environnement, et les noms de variables, √† leur tour, √† affecter √† de nouvelles propri√©t√©s <i>application.properties</i> : <br><br><pre> <code class="plaintext hljs">google.recaptcha.key.site=${GOOGLE_RECAPTCHA_KEY_SITE} google.recaptcha.key.secret=${GOOGLE_RECAPTCHA_KEY_SECRET}</code> </pre><br>  Ajoutez une nouvelle d√©pendance dans <i>pom.xml</i> pour v√©rification du c√¥t√© Google des jetons reCAPTCHA que le client nous enverra: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.mashape.unirest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>unirest-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.4.9<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Il est maintenant temps de mettre √† jour les entit√©s que nous utilisons pour autoriser et enregistrer les utilisateurs en leur ajoutant un champ de cha√Æne pour le m√™me jeton reCAPTCHA: <br><br><div class="spoiler">  <b class="spoiler_title">LoginUser.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.JsonProperty <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoginUser</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Serializable { @JsonProperty</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"username"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> username: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"password"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"recapctha_token"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> recaptchaToken: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() {} <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(username: String, password: String, recaptchaToken: String) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password = password <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.recaptchaToken = recaptchaToken } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">1764970284520387975L</span></span> } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">NewUser.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.JsonProperty <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewUser</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Serializable { @JsonProperty</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"username"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> username: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"firstName"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> firstName: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"lastName"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastName: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"email"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> email: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"password"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"recapctha_token"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> recaptchaToken: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() {} <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(username: String, firstName: String, lastName: String, email: String, password: String, recaptchaToken: String) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = firstName <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = lastName <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.email = email <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password = password <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.recaptchaToken = recaptchaToken } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">1764970284520387975L</span></span> } }</code> </pre><br></div></div><br>  Ajoutez un petit service qui diffusera le jeton reCAPTCHA √† un service Google sp√©cial et indiquera en r√©ponse si le jeton a r√©ussi la v√©rification: <br><br><div class="spoiler">  <b class="spoiler_title">ReCaptchaService.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Service <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.client.RestOperations <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Autowired <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mashape.unirest.http.HttpResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mashape.unirest.http.JsonNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mashape.unirest.http.Unirest <span class="hljs-meta"><span class="hljs-meta">@Service(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"captchaService"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReCaptchaService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> BASE_VERIFY_URL: String = <span class="hljs-string"><span class="hljs-string">"https://www.google.com/recaptcha/api/siteverify"</span></span> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> restTemplate: RestOperations? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${google.recaptcha.key.site}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keySite: String <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${google.recaptcha.key.secret}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keySecret: String <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateCaptcha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> url: String = String.format(BASE_VERIFY_URL + <span class="hljs-string"><span class="hljs-string">"?secret=%s&amp;response=%s"</span></span>, keySecret, token) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jsonResponse: HttpResponse&lt;JsonNode&gt; = Unirest.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(url) .header(<span class="hljs-string"><span class="hljs-string">"accept"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>).queryString(<span class="hljs-string"><span class="hljs-string">"apiKey"</span></span>, <span class="hljs-string"><span class="hljs-string">"123"</span></span>) .asJson() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (jsonResponse.getStatus() == <span class="hljs-number"><span class="hljs-number">200</span></span>) } }</code> </pre><br></div></div><br>  Ce service doit √™tre utilis√© dans le contr√¥leur d'enregistrement et d'autorisation des utilisateurs: <br><br><div class="spoiler">  <b class="spoiler_title">AuthController.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.ReCaptchaService ‚Ä¶ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> captchaService: ReCaptchaService ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(loginRequest.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>]... ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(newUser.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>...</code> </pre><br></div></div><br>  <b>Frontend</b> <br><br>  La premi√®re √©tape consiste √† installer et enregistrer le package <code>reCAPTHA</code> : <br><br><pre> <code class="plaintext hljs">$ npm install --save vue-recaptcha</code> </pre> <br>  Connectez-vous ensuite au script dans <i>index.html</i> : <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://www.google.com/recaptcha/api.js onload=vueRecaptchaApiLoaded&amp;render=explicit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">defer</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Ajoutez n'importe quel captcha √† n'importe quel espace libre sur la page: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vue-recaptcha</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"recaptcha"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"invisible"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:sitekey</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sitekey"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">verify</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onCapthcaVerified"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expired</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onCaptchaExpired"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Et le bouton de l'action cible (autorisation ou enregistrement) appellera maintenant d'abord la m√©thode de validation: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b-button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-on:click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"validateCaptcha"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">variant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"primary"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b-button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Ajoutez la d√©pendance aux composants: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> VueRecaptcha <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue-recaptcha'</span></span></code> </pre> <br>  Modifier l' <i>exportation par d√©faut</i> : <br><br><pre> <code class="javascript hljs">components: { VueRecaptcha }, ‚Ä¶ data() { ‚Ä¶ siteKey: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">i</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">  </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">i</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ‚Ä¶ }</code> </pre><br>  Et ajoutez de nouvelles m√©thodes: <br><br><ul><li>  <code>validateCaptcha()</code> - qui est appel√© en cliquant sur le bouton </li><li>  <code>onCapthcaVerified(recaptchaToken)  onCaptchaExpired()</code> - que le captcha appelle lui-m√™me </li></ul><br><div class="spoiler">  <b class="spoiler_title">De nouvelles m√©thodes</b> <div class="spoiler_text"><pre> <code class="javascript hljs">validateCaptcha() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$refs.recaptcha.execute() }, onCapthcaVerified(recaptchaToken) { AXIOS.post(<span class="hljs-string"><span class="hljs-string">`/auth/signin`</span></span>, {<span class="hljs-string"><span class="hljs-string">'username'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$data.username, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$data.password, <span class="hljs-string"><span class="hljs-string">'recapctha_token'</span></span>: recaptchaToken}) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$store.dispatch(<span class="hljs-string"><span class="hljs-string">'login'</span></span>, {<span class="hljs-string"><span class="hljs-string">'token'</span></span>: response.data.accessToken, <span class="hljs-string"><span class="hljs-string">'roles'</span></span>: response.data.authorities, <span class="hljs-string"><span class="hljs-string">'username'</span></span>: response.data.username}); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$router.push(<span class="hljs-string"><span class="hljs-string">'/home'</span></span>) }, error =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showAlert(error.response.data.message); }) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showAlert(<span class="hljs-string"><span class="hljs-string">'Server error. Please, report this error website owners'</span></span>); }) }, onCaptchaExpired() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$refs.recaptcha.reset() }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">R√©sultat</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m0/rc/w9/m0rcw9xjgqjqpgiuwdib16_mur8.png"><br></div></div><br><a name="email"></a><br><h2>  Envoi d'email </h2><br>  Envisagez la possibilit√© d'envoyer des lettres √† notre application via un serveur de messagerie public, tel que Google ou Mail.ru. <br><br>  La premi√®re √©tape, respectivement, sera de cr√©er un compte sur le serveur de messagerie s√©lectionn√©, s'il ne l'est pas d√©j√†. <br><br>  La deuxi√®me √©tape, nous devons ajouter les d√©pendances suivantes dans <i>pom.xml</i> : <br><br><div class="spoiler">  <b class="spoiler_title">D√©pendances</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-mail<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-thymeleaf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>commons-io<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>commons-io<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Vous devez √©galement ajouter de nouvelles propri√©t√©s √† <i>application.properties</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Propri√©t√©s SMTP</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">spring.mail.host=${SMTP_MAIL_HOST} spring.mail.port=${SMTP_MAIL_PORT} spring.mail.username=${SMTP_MAIL_USERNAME} spring.mail.password=${SMTP_MAIL_PASSWORD} spring.mail.properties.mail.smtp.auth=true spring.mail.properties.mail.smtp.starttls.enable=true spring.mail.properties.mail.smtp.ssl.enable=true spring.mail.properties.mail.smtp.connectiontimeout=5000 spring.mail.properties.mail.smtp.timeout=5000 spring.mail.properties.mail.smtp.writetimeout=5000</code> </pre><br></div></div><br>  Vous pouvez sp√©cifier les param√®tres SMTP ici: <a href="https://support.google.com/mail/answer/7126229%3Fhl%3Dru" rel="nofollow">Google</a> et <a href="https://help.mail.ru/mail-help/mailer/popsmtp" rel="nofollow">Mail.ru</a> <br><br>  Cr√©ez une interface o√π nous d√©clarons plusieurs m√©thodes: <br><br><ul><li>  Pour envoyer un SMS normal </li><li>  Pour envoyer un e-mail HTML </li><li>  Pour envoyer un e-mail √† l'aide d'un mod√®le </li></ul><br><div class="spoiler">  <b class="spoiler_title">EmailService.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.email <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.SimpleMailMessage <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, text: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleMessageUsingTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, template: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, params:</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MutableMap</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Any&gt;)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendHtmlMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, htmlMsg: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre><br></div></div><br>  Cr√©ons maintenant une impl√©mentation de cette interface - le service d'envoi d'emails: <br><br><div class="spoiler">  <b class="spoiler_title">EmailServiceImpl.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.email <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Autowired <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.io.FileSystemResource <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.MailException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.SimpleMailMessage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.javamail.JavaMailSender <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.javamail.MimeMessageHelper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.thymeleaf.spring5.SpringTemplateEngine <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.thymeleaf.context.Context <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.mail.MessagingException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.mail.internet.MimeMessage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.io.IOUtils <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.env.Environment <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailServiceImpl</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EmailService { @Value</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"\${spring.mail.username}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sender: String <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> environment: Environment <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> emailSender: JavaMailSender? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> templateEngine: SpringTemplateEngine <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, text: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> message = SimpleMailMessage() message.setTo(to) message.setFrom(sender) message.setSubject(subject) message.setText(text) emailSender!!.send(message) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (exception: MailException) { exception.printStackTrace() } } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleMessageUsingTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, template: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, params:</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MutableMap</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Any&gt;)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> message = emailSender!!.createMimeMessage() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> helper = MimeMessageHelper(message, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context: Context = Context() context.setVariables(params) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> html: String = templateEngine.process(template, context) helper.setTo(to) helper.setFrom(sender) helper.setText(html, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) helper.setSubject(subject) emailSender!!.send(message) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendHtmlMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, htmlMsg: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> message = emailSender!!.createMimeMessage() message.setContent(htmlMsg, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> helper = MimeMessageHelper(message, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>) helper.setTo(to) helper.setFrom(sender) helper.setSubject(subject) emailSender!!.send(message) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (exception: MailException) { exception.printStackTrace() } } }</code> </pre><br></div></div><br><ul><li>  Nous utilisons JavaMailSender configur√© automatiquement par Spring pour envoyer des e-mails </li><li>  L'envoi de lettres r√©guli√®res est extr√™mement simple - il vous suffit d'ajouter du texte au corps de la lettre et de l'envoyer </li><li>  Les e-mails HTML sont d√©finis comme des messages de type MIME et leur contenu sous forme de <code>text/html</code> </li><li>  Pour traiter le mod√®le de message HTML, nous utilisons le moteur de mod√®le Spring </li></ul><br>  Cr√©ons un mod√®le simple pour √©crire en utilisant le framework <a href="https://www.thymeleaf.org/" rel="nofollow">Thymeleaf</a> en le pla√ßant dans <i>src / main / resources / templates /</i> : <br><br><div class="spoiler">  <b class="spoiler_title">emailTemplate.html</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:th</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.thymeleaf.org"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Hello<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"font-family: Arial, Helvetica, sans-serif;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>Hello!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"margin-top: 20px; margin-bottom: 30px; margin-left: 20px;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Hello, dear: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">th:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${addresseeName}"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">th:src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${signatureImage}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200px;"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Les √©l√©ments changeants du mod√®le (dans notre cas, le nom du destinataire et le chemin de l'image pour signature) sont d√©clar√©s √† l'aide d'espaces r√©serv√©s. <br><br>  Maintenant, cr√©ez ou mettez √† jour un contr√¥leur qui enverra des lettres: <br><br><div class="spoiler">  <b class="spoiler_title">BackendController.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.email.EmailServiceImpl <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.web.response.ResponseMessage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.ResponseEntity <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.HttpStatus ‚Ä¶ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> emailService: EmailService <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${spring.mail.username}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> addressee: String ‚Ä¶ <span class="hljs-meta"><span class="hljs-meta">@GetMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/sendSimpleEmail"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@PreAuthorize(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"hasRole('USER')"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { emailService.sendSimpleMessage(addressee, <span class="hljs-string"><span class="hljs-string">"Simple Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello! This is simple email"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Error while sending message"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Email has been sent"</span></span>), HttpStatus.OK) } <span class="hljs-meta"><span class="hljs-meta">@GetMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/sendTemplateEmail"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@PreAuthorize(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"hasRole('USER')"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendTemplateEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params:MutableMap&lt;String, Any&gt; = mutableMapOf() params[<span class="hljs-string"><span class="hljs-string">"addresseeName"</span></span>] = addressee params[<span class="hljs-string"><span class="hljs-string">"signatureImage"</span></span>] = <span class="hljs-string"><span class="hljs-string">"https://coderlook.com/wp-content/uploads/2019/07/spring-by-pivotal.png"</span></span> emailService.sendSimpleMessageUsingTemplate(addressee, <span class="hljs-string"><span class="hljs-string">"Template Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"emailTemplate"</span></span>, params) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Error while sending message"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Email has been sent"</span></span>), HttpStatus.OK) } <span class="hljs-meta"><span class="hljs-meta">@GetMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/sendHtmlEmail"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@PreAuthorize(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"hasRole('USER')"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendHtmlEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { emailService.sendHtmlMessage(addressee, <span class="hljs-string"><span class="hljs-string">"HTML Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;h1&gt;Hello!&lt;/h1&gt;&lt;p&gt;This is HTML email&lt;/p&gt;"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Error while sending message"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Email has been sent"</span></span>), HttpStatus.OK) }</code> </pre><br></div></div><br>  <u>Remarque:</u> Pour nous assurer que tout fonctionne, nous nous enverrons d'abord des lettres. <br><br>  De plus, pour nous assurer que tout fonctionne, nous pouvons cr√©er une interface Web modeste qui tirera simplement les m√©thodes du service Web: <br><br><div class="spoiler">  <b class="spoiler_title">Email.vue</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;template&gt; &lt;div id="email"&gt; &lt;b-button v-on:click="sendSimpleMessage" variant="primary"&gt;Simple Email&lt;/b-button&gt;&lt;br/&gt; &lt;b-button v-on:click="sendEmailUsingTemplate" variant="primary"&gt;Template Email&lt;/b-button&gt;&lt;br/&gt; &lt;b-button v-on:click="sendHTMLEmail" variant="primary"&gt;HTML Email&lt;/b-button&gt;&lt;br/&gt; &lt;/div&gt; &lt;/template&gt; &lt;script&gt; import {AXIOS} from './http-common' export default { name: 'EmailPage', data() { return { counter: 0, username: '', header: {'Authorization': 'Bearer ' + this.$store.getters.getToken} } }, methods: { sendSimpleMessage() { AXIOS.get('/sendSimpleEmail', { headers: this.$data.header }) .then(response =&gt; { console.log(response); alert("OK"); }) .catch(error =&gt; { console.log('ERROR: ' + error.response.data); }) }, sendEmailUsingTemplate() { AXIOS.get('/sendTemplateEmail', { headers: this.$data.header }) .then(response =&gt; { console.log(response); alert("OK") }) .catch(error =&gt; { console.log('ERROR: ' + error.response.data); }) }, sendHTMLEmail() { AXIOS.get('/sendHtmlEmail', { headers: this.$data.header }) .then(response =&gt; { console.log(response); alert("OK") }) .catch(error =&gt; { console.log('ERROR: ' + error.response.data); }) } } } &lt;/script&gt; &lt;style&gt; #email { margin-left: 38%; margin-top: 50px; } button { width: 150px; } &lt;/style&gt;</code> </pre><br></div></div><br>  <u>Remarque:</u> n'oubliez pas de mettre √† jour <code>router.js</code> et d'ajouter le lien vers la <code>App.vue</code> navigation <code>App.vue</code> si vous cr√©ez un nouveau composant. <br><br><a name="gradle"></a><br><h2>  Migration Gradle </h2><br>  Je vais clarifier tout de suite: si cet √©l√©ment est consid√©r√© comme une am√©lioration, laissez chacun d√©cider de son propre projet.  Nous regardons simplement comment proc√©der. <br><br>  En g√©n√©ral, vous pouvez utiliser l'instruction <a href="http://www.rationaljava.com/2016/02/moving-from-maven-to-gradle-in-under-5.html" rel="nofollow">Moving from Maven to Gradle en moins de 5 minutes</a> , mais il est peu probable que le r√©sultat soit √† la hauteur des attentes.  Je recommanderais toujours de faire la migration manuellement, cela ne prendra pas beaucoup de temps. <br><br>  La premi√®re chose que nous devons faire est d' <a href="https://gradle.org/install/" rel="nofollow">installer Gradle</a> . <br><br>  Ensuite, nous devons effectuer la proc√©dure suivante pour les deux sous-projets - <code>backend</code> et <code>fronted</code> : <br><br>  <b># 1</b> Supprimer les fichiers Maven - <i>pom.xml</i> , <i>.mvn</i> . <br><br>  <b># 2</b> Dans le r√©pertoire du sous-projet, ex√©cutez gradle init et r√©pondez aux questions: <br><br><ul><li>  <i>S√©lectionnez le type de projet √† g√©n√©rer:</i> <b>basique</b> </li><li>  <i>S√©lectionnez le langage d'impl√©mentation:</i> <b>Kotlin</b> </li><li>  <i>S√©lectionnez le script de construction DSL:</i> <b>Kotlin</b> (puisque nous √©crivons un projet dans Kotlin) </li></ul><br>  <b># 3</b> Supprimez <i>settings.gradle.kts</i> - ce fichier n'est n√©cessaire que pour le projet racine. <br><br>  <b># 4</b> Ex√©cutez <code>gradle wrapper</code> . <br><br>  Passons maintenant √† notre projet racine.  Pour cela, vous devez suivre les √©tapes 1, 2 et 4 d√©crites ci-dessus pour les sous-projets - tout est le m√™me <u>sauf la suppression de <i>settings.gradle.kts</i></u> . <br><br>  La configuration de construction du projet <i>backend</i> ressemblera √† ceci: <br><br><div class="spoiler">  <b class="spoiler_title">build.gradle.kts</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jetbrains.kotlin.gradle.tasks.KotlinCompile plugins { id(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot"</span></span>) version <span class="hljs-string"><span class="hljs-string">"2.1.3.RELEASE"</span></span> id(<span class="hljs-string"><span class="hljs-string">"io.spring.dependency-management"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.0.8.RELEASE"</span></span> kotlin(<span class="hljs-string"><span class="hljs-string">"jvm"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.3.50"</span></span> kotlin(<span class="hljs-string"><span class="hljs-string">"plugin.spring"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.3.50"</span></span> id(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin.plugin.jpa"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.3.50"</span></span> } group = <span class="hljs-string"><span class="hljs-string">"com.kotlin-spring-vue"</span></span> version = <span class="hljs-string"><span class="hljs-string">"0.0.1-SNAPSHOT"</span></span> java.sourceCompatibility = JavaVersion.VERSION_1_8 repositories { mavenCentral() maven { url = uri(<span class="hljs-string"><span class="hljs-string">"https://plugins.gradle.org/m2/"</span></span>) } } dependencies { runtimeOnly(project(<span class="hljs-string"><span class="hljs-string">":frontend"</span></span>)) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-actuator:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-web:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-data-jpa:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-mail:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-security:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.postgresql:postgresql:42.2.5"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-thymeleaf:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"commons-io:commons-io:2.4"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"io.jsonwebtoken:jjwt:0.9.0"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"io.jsonwebtoken:jjwt-api:0.10.6"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"com.mashape.unirest:unirest-java:1.4.9"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"com.fasterxml.jackson.module:jackson-module-kotlin:2.9.8"</span></span>) runtimeOnly(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-devtools:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-reflect"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib-jdk8"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-noarg:1.3.50"</span></span>) testImplementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-test"</span></span>) { exclude(group = <span class="hljs-string"><span class="hljs-string">"org.junit.vintage"</span></span>, module = <span class="hljs-string"><span class="hljs-string">"junit-vintage-engine"</span></span>) } } tasks.withType&lt;KotlinCompile&gt; { kotlinOptions { freeCompilerArgs = listOf(<span class="hljs-string"><span class="hljs-string">"-Xjsr305=strict"</span></span>) jvmTarget = <span class="hljs-string"><span class="hljs-string">"1.8"</span></span> } }</code> </pre><br></div></div><br><ul><li>  Tous les plugins Kotlin et Spring requis doivent √™tre sp√©cifi√©s. </li><li>  N'oubliez pas le plugin <i>org.jetbrains.kotlin.plugin.jpa</i> - il est n√©cessaire de se connecter √† la base de donn√©es </li><li>  Dans les d√©pendances, vous devez sp√©cifier <code>runtimeOnly(project(":frontend"))</code> - nous devons d'abord construire le projet <i>frontend</i> </li></ul><br>  Construire la configuration pour le projet <i>frontal</i> : <br><br><div class="spoiler">  <b class="spoiler_title">build.gradle.kts</b> <div class="spoiler_text"><pre> <code class="kotlin hljs">plugins { id(<span class="hljs-string"><span class="hljs-string">"org.siouan.frontend"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.2.1"</span></span> id(<span class="hljs-string"><span class="hljs-string">"java"</span></span>) } group = <span class="hljs-string"><span class="hljs-string">"com.kotlin-spring-vue"</span></span> version = <span class="hljs-string"><span class="hljs-string">"0.0.1-SNAPSHOT"</span></span> java { targetCompatibility = JavaVersion.VERSION_1_8 } buildscript { repositories { mavenCentral() maven { url = uri(<span class="hljs-string"><span class="hljs-string">"https://plugins.gradle.org/m2/"</span></span>) } } } frontend { nodeVersion.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">"10.16.0"</span></span>) cleanScript.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">"run clean"</span></span>) installScript.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">"install"</span></span>) assembleScript.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">"run build"</span></span>) } tasks.named(<span class="hljs-string"><span class="hljs-string">"jar"</span></span>, Jar::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">) </span></span>{ dependsOn(<span class="hljs-string"><span class="hljs-string">"assembleFrontend"</span></span>) from(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$buildDir</span></span></span><span class="hljs-string">/dist"</span></span>) into(<span class="hljs-string"><span class="hljs-string">"static"</span></span>) }</code> </pre><br></div></div><br><ul><li>  Dans mon exemple, le plugin <code>org.siouan.frontend</code> est utilis√© pour construire le projet </li><li>  Dans la section <code>frontend {...}</code> indiquer la version de Node.js, ainsi que les commandes qui appellent les scripts de nettoyage, d'installation et d'assemblage sp√©cifi√©s dans <code>package.json</code> </li><li>  Maintenant, nous emballons notre sous-projet frontal dans un fichier JAR et l'utilisons comme d√©pendance ( <code>runtimeOnly(project(":frontend"))</code> dans le <i>backend</i> ), nous devons donc d√©crire une t√¢che qui copie les fichiers du r√©pertoire d'assembly vers <i>/ public</i> et cr√©e un fichier jar </li></ul><br>  <u>Remarque:</u> <br><br><ul><li>  Modifiez <code>vue.config.js</code> , en changeant le r√©pertoire de <i>construction</i> en <i>build / dist</i> . </li><li>  Dans le fichier de <i>script de construction</i> <code>package.json</code> , sp√©cifiez la construction <code>vue-cli-service build</code> ou assurez-vous qu'il est sp√©cifi√© </li></ul><br>  Le fichier settings.gradle.kts du projet racine doit contenir le code suivant: ... <br><br><pre> <code class="kotlin hljs">rootProject.name = <span class="hljs-string"><span class="hljs-string">"demo"</span></span> include(<span class="hljs-string"><span class="hljs-string">":frontend"</span></span>, <span class="hljs-string"><span class="hljs-string">":backend"</span></span>)</code> </pre><br>  ... est le nom du projet et des sous-projets. <br><br>  Et maintenant, nous pouvons construire le projet en ex√©cutant la commande: <code>./gradlew build</code> <br><br>  <u>Remarque:</u> si pour les espaces r√©serv√©s sp√©cifi√©s dans <i>application.properties</i> (par exemple, <code>${SPRING_DATASOURCE_URL}</code> ) il n'y a pas de variables d'environnement correspondantes, l'assembly √©chouera.  Pour √©viter cela, utilisez <code><b>/gradlew build -x</b></code> <br><br>  Vous pouvez v√©rifier la structure des projets en utilisant la commande <code>gradle -q projects</code> , le r√©sultat devrait ressembler √† ceci: <br><br><pre> <code class="plaintext hljs">Root project 'demo' +--- Project ':backend' \--- Project ':frontend'</code> </pre> <br>  Et enfin, pour ex√©cuter l'application, vous devez ex√©cuter <code>./gradlew bootRun</code> . <br><br><h4>  .gitignore </h4><br>  Les fichiers et dossiers suivants doivent √™tre ajout√©s au fichier <i>.gitignore</i> : <br><br><ul><li>  backend / build / </li><li>  frontend / build / </li><li>  construire </li><li>  .gradle </li></ul><br>  <u>Important:</u> vous ne devez pas ajouter de fichiers <code>gradlew</code> √† <i>.gitignore</i> - ils ne <i>contiennent</i> rien de dangereux, mais ils sont n√©cessaires pour un assemblage r√©ussi sur un serveur distant. <br><br><h4>  D√©ploiement sur Heroku </h4><br>  Examinons les modifications que nous devons apporter pour que l'application se d√©ploie en toute s√©curit√© sur Heroku. <br><br>  <b># 1 Procfile</b> <br><br>  Nous devons demander √† Heroku de nouvelles instructions pour lancer l'application: <br><br><pre> <code class="plaintext hljs">web: java -Dserver.port=$PORT -jar backend/build/libs/backend-0.0.1-SNAPSHOT.jar</code> </pre> <br>  <b># 2 variables d'environnement</b> <br><br>  Heroku est capable de refaire le type d'application (par exemple, l'application Spring Boot) et de suivre les instructions d'assemblage appropri√©es.  Mais notre application (le projet racine) ne ressemble pas √† une application Spring Boot pour Heroku.  Si nous laissons tout tel quel, Heroku nous demandera de d√©finir la <code>stage</code> .  Honn√™tement, je ne sais pas o√π se termine ce chemin, car je ne l'ai pas suivi.  Il est plus facile de d√©finir une variable <code>GRADLE_TASK</code> avec une valeur de <code>build</code> : <br><br><img src="https://habrastorage.org/webt/5j/xz/o2/5jxzo2ukto8lyakkxajjg5rrvtg.png"><br><br>  <b># 3 reCAPTCHA</b> <br><br>  Lorsque vous placez l'application dans un nouveau domaine, n'oubliez pas de mettre √† jour le captcha, les variables d'environnement <code>GOOGLE_RECAPTCHA_KEY_SITE</code> et <code>GOOGLE_RECAPTCHA_KEY_SECRET</code> , ainsi que de mettre √† jour la cl√© de site dans le sous-projet frontal. <br><br><a name="cookies"></a><br><h2>  Stockage du jeton JWT dans les cookies </h2><br>  Tout d'abord, je vous recommande fortement de lire l'article <a href="https://www.rdegges.com/2018/please-stop-using-local-storage/" rel="nofollow">Veuillez cesser d'utiliser le stockage local</a> , en particulier la <i>section Pourquoi le stockage local n'est pas s√©curis√© et vous ne devriez pas l'utiliser pour stocker des donn√©es sensibles</i> . <br><br>  Voyons comment vous pouvez stocker le jeton JWT dans un endroit plus s√©curis√© - les cookies dans le drapeau <code>httpOnly</code> , o√π il ne sera pas disponible pour la lecture / modification √† l'aide de JavaScript. <br><br>  <b># 1</b> Suppression de toute la logique li√©e √† JWT du frontend: <br>  √âtant donn√© que le jeton n'est toujours pas accessible avec JavaScript avec la nouvelle m√©thode de stockage, vous pouvez supprimer en toute s√©curit√© toutes les r√©f√©rences √† celui-ci de notre sous-projet. <br><br>  Mais le r√¥le de l'utilisateur sans r√©f√©rence √† d'autres donn√©es n'est pas une information si importante, elle peut toujours √™tre stock√©e dans le stockage local et d√©terminer si l'utilisateur est autoris√© ou non, selon que ce r√¥le est d√©fini. <br><br><div class="spoiler">  <b class="spoiler_title">store / index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vuex <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vuex'</span></span>; Vue.use(Vuex); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> state = { <span class="hljs-attr"><span class="hljs-attr">role</span></span>: localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'user-role'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'user-name'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">authorities</span></span>: localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'authorities'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getters = { <span class="hljs-attr"><span class="hljs-attr">isAuthenticated</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.role != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; state.role != <span class="hljs-string"><span class="hljs-string">''</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }, <span class="hljs-attr"><span class="hljs-attr">isAdmin</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.role === <span class="hljs-string"><span class="hljs-string">'admin'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }, <span class="hljs-attr"><span class="hljs-attr">getUsername</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.username; }, <span class="hljs-attr"><span class="hljs-attr">getAuthorities</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.authorities; } }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mutations = { <span class="hljs-attr"><span class="hljs-attr">auth_login</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, user</span></span></span><span class="hljs-function">) =&gt;</span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'user-name'</span></span>, user.username); localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'user-authorities'</span></span>, user.roles); state.username = user.username; state.authorities = user.roles; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isUser = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isAdmin = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; user.roles.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.roles[i].authority === <span class="hljs-string"><span class="hljs-string">'ROLE_USER'</span></span>) { isUser = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.roles[i].authority === <span class="hljs-string"><span class="hljs-string">'ROLE_ADMIN'</span></span>) { isAdmin = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isUser) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'user-role'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>); state.role = <span class="hljs-string"><span class="hljs-string">'user'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isAdmin) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'user-role'</span></span>, <span class="hljs-string"><span class="hljs-string">'admin'</span></span>); state.role = <span class="hljs-string"><span class="hljs-string">'admin'</span></span>; } }, <span class="hljs-attr"><span class="hljs-attr">auth_logout</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { state.token = <span class="hljs-string"><span class="hljs-string">''</span></span>; state.role = <span class="hljs-string"><span class="hljs-string">''</span></span>; state.username = <span class="hljs-string"><span class="hljs-string">''</span></span>; state.authorities = []; localStorage.removeItem(<span class="hljs-string"><span class="hljs-string">'user-role'</span></span>); localStorage.removeItem(<span class="hljs-string"><span class="hljs-string">'user-name'</span></span>); localStorage.removeItem(<span class="hljs-string"><span class="hljs-string">'user-authorities'</span></span>); } }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> actions = { <span class="hljs-attr"><span class="hljs-attr">login</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context, user</span></span></span><span class="hljs-function">) =&gt;</span></span> { context.commit(<span class="hljs-string"><span class="hljs-string">'auth_login'</span></span>, user) }, <span class="hljs-attr"><span class="hljs-attr">logout</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context</span></span></span><span class="hljs-function">) =&gt;</span></span> { context.commit(<span class="hljs-string"><span class="hljs-string">'auth_logout'</span></span>); } }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vuex.Store({ state, getters, mutations, actions });</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soyez prudent lors de la refactorisation </font></font><code>store/index.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: si l'autorisation et la d√©sautorisation ne fonctionnent pas correctement, les messages d'erreur seront persistants dans la console. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Renvoyez le JWT sous forme de cookie dans le contr√¥leur d'autorisation ( </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas dans le corps de la r√©ponse</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AuthController.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.authCookieName}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authCookieName: String <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.isCookieSecure}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isCookieSecure: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-meta"><span class="hljs-meta">@PostMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/signin"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticateUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Valid</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loginRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LoginUser</span></span></span></span><span class="hljs-function"><span class="hljs-params">, response: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HttpServletResponse</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userCandidate: Optional &lt;User&gt; = userRepository.findByUsername(loginRequest.username!!) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(loginRequest.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userCandidate.isPresent) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User = userCandidate.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authentication = authenticationManager.authenticate( UsernamePasswordAuthenticationToken(loginRequest.username, loginRequest.password)) SecurityContextHolder.getContext().setAuthentication(authentication) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jwt: String = jwtProvider.generateJwtToken(user.username!!) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cookie: Cookie = Cookie(authCookieName, jwt) cookie.maxAge = jwtProvider.jwtExpiration!! cookie.secure = isCookieSecure cookie.isHttpOnly = <span class="hljs-literal"><span class="hljs-literal">true</span></span> cookie.path = <span class="hljs-string"><span class="hljs-string">"/"</span></span> response.addCookie(cookie) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authorities: List&lt;GrantedAuthority&gt; = user.roles!!.stream().map({ role -&gt; SimpleGrantedAuthority(role.name)}).collect(Collectors.toList&lt;GrantedAuthority&gt;()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity.ok(SuccessfulSigninResponse(user.username, authorities)) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"User not found!"</span></span>), HttpStatus.BAD_REQUEST) } }</code> </pre><br></div></div><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Remarque S'il vous pla√Æt que je mets les </font><font style="vertical-align: inherit;">options </font></font><code>authCookieName</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>isCookieSecure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application.properties</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - envoyer des </font><font style="vertical-align: inherit;">cookies au drapeau </font></font><code>secure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne peut https, ce </font><font style="vertical-align: inherit;">qui le </font><font style="vertical-align: inherit;">rend extr√™mement difficile de d√©bogage avec localhost. </font><font style="vertical-align: inherit;">MAIS en production, bien s√ªr, il est pr√©f√©rable d'utiliser des cookies avec ce drapeau. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De plus, il est d√©sormais recommand√© que les r√©ponses du contr√¥leur utilisent une entit√© sans champ sp√©cial pour le JWT. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mise √† jour </font></font><code>JwtAuthTokenFilter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avions l'habitude de prendre un jeton de l'en-t√™te de la demande, maintenant nous le prenons des cookies:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JwtAuthTokenFilter.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.authCookieName}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authCookieName: String ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJwt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HttpServletRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: String? { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (cookie <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.cookies) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cookie.name == authCookieName) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cookie.value } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> }</code> </pre><br></div></div><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Activation de </font></font><a href="https://ru.wikipedia.org/wiki/Cross-origin_resource_sharing" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CORS</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si, dans mon article pr√©c√©dent, vous pouviez toujours ignorer cette question, il serait maintenant √©trange de prot√©ger le jeton JWT sans avoir √† activer CORS c√¥t√© backend. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez r√©soudre ce probl√®me en modifiant </font></font><code>WebSecurityConfig.kt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebSecurityConfig.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">corsConfigurationSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: CorsConfigurationSource { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> configuration = CorsConfiguration() configuration.allowedOrigins = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080"</span></span>, <span class="hljs-string"><span class="hljs-string">"http://localhost:8081"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://kotlin-spring-vue-gradle-demo.herokuapp.com"</span></span>) configuration.allowedHeaders = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"*"</span></span>) configuration.allowedMethods = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>, <span class="hljs-string"><span class="hljs-string">"OPTIONS"</span></span>) configuration.allowCredentials = <span class="hljs-literal"><span class="hljs-literal">true</span></span> configuration.maxAge = <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> source = UrlBasedCorsConfigurationSource() source.registerCorsConfiguration(<span class="hljs-string"><span class="hljs-string">"/**"</span></span>, configuration) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> source } <span class="hljs-meta"><span class="hljs-meta">@Throws(Exception::class)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(http: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HttpSecurity</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { http .cors().and() .csrf().disable().authorizeRequests() .antMatchers(<span class="hljs-string"><span class="hljs-string">"/**"</span></span>).permitAll() .anyRequest().authenticated() .and() .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and() .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) http.addFilterBefore(authenticationJwtTokenFilter(), UsernamePasswordAuthenticationFilter::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">headers</span></span></span></span>().cacheControl().disable() }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et maintenant, vous pouvez supprimer toutes les annotations </font></font><code>@CrossOrigin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des contr√¥leurs. </font></font><br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important:</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le param√®tre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AllowCredentials est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> requis pour envoyer des demandes depuis le frontend. </font><font style="vertical-align: inherit;">En savoir plus √† ce sujet </font></font><a href="https://stackoverflow.com/questions/45004354/when-should-i-really-set-access-control-allow-credentials-to-true-in-my-resp" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mise √† jour des en-t√™tes du c√¥t√© frontal:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http-commons.js</font></font></b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AXIOS = axios.create({ <span class="hljs-attr"><span class="hljs-attr">baseURL</span></span>: <span class="hljs-string"><span class="hljs-string">`/api`</span></span>, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Origin'</span></span>: [<span class="hljs-string"><span class="hljs-string">'http://localhost:8080'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://localhost:8081'</span></span>, <span class="hljs-string"><span class="hljs-string">'https://kotlin-spring-vue-gradle-demo.herokuapp.com'</span></span>], <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Methods'</span></span>: <span class="hljs-string"><span class="hljs-string">'GET,POST,DELETE,PUT,OPTIONS'</span></span>, <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Headers'</span></span>: <span class="hljs-string"><span class="hljs-string">'*'</span></span>, <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Credentials'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } })</code> </pre><br></div></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> V√©rifier </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essayons de nous connecter √† l'application en nous connectant √† partir d'un h√¥te qui ne figure pas dans la liste autoris√©e </font></font><code>WebSecurityConfig.kt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pour ce faire, ex√©cutez le backend sur le port </font></font><code>8080</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le frontend, par exemple, sur </font></font><code>8082</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et essayez de vous connecter:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sw/ce/hk/swcehkifaph10nqjveh17sv1w88.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demande d'autorisation rejet√©e par la politique CORS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voyons maintenant comment les cookies de drapeau fonctionnent en g√©n√©ral </font></font><code>httpOnly</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pour ce faire, allons par exemple sur le site </font></font><a href="https://kotlinlang.org/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://kotlinlang.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ex√©cutons-le dans la console du navigateur:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/4o/s7/ct/4os7ctztsejgbzclio8ci8nloky.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les non- </font></font><code>httpOnly</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cookies li√©s √† ce site </font><font style="vertical-align: inherit;">appara√Ætront dans la console </font><font style="vertical-align: inherit;">, qui, comme nous le voyons, sont accessibles via JavaScript. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, allons dans notre application, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connectez-vous</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (pour que le navigateur </font><font style="vertical-align: inherit;">enregistre le cookie </font><font style="vertical-align: inherit;">avec JWT) et r√©p√©tez la m√™me chose:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fh/_b/zh/fh_bzh9ytv6rf_xn40fjf3c83ag.png"><br></div></div><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque:</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cette m√©thode de stockage d'un jeton JWT est plus fiable que l'utilisation du stockage local, mais vous devez comprendre qu'il ne s'agit pas d'une panac√©e.</font></font><br><br><a name="confirmation"></a><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Confirmation d'inscription par e-mail </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un bref algorithme pour effectuer cette t√¢che est le suivant: </font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour tous les nouveaux utilisateurs, l'attribut </font></font><code>isEnabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de la base de donn√©es est d√©fini sur</font></font><code>false</code> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un jeton de cha√Æne est g√©n√©r√© √† partir de caract√®res arbitraires, qui servira de cl√© pour confirmer l'enregistrement </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le token est envoy√© √† l'utilisateur par mail dans le cadre du lien </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'attribut </font></font><code>isEnabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est d√©fini sur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si l'utilisateur suit le lien pendant une p√©riode de temps d√©finie.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examinons maintenant ce processus plus en d√©tail. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons besoin d'une table pour stocker le jeton pour confirmer l'inscription:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.verification_token ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, token <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, expiry_date <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone, user_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.verification_token <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> verification_token_users_fk <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (user_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> public.users (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">MATCH</span></span> SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et, en cons√©quence, une nouvelle entit√© pour le mappage relationnel-objet ...: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VerificationToken.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.jpa <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Calendar <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"verification_token"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VerificationToken</span></span></span></span>( <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue(strategy = GenerationType.AUTO)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> id: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span>? = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-meta"><span class="hljs-meta">@Column(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"token"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-meta"><span class="hljs-meta">@Column(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"expiry_date"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expiryDate: Date, <span class="hljs-meta"><span class="hljs-meta">@OneToOne(targetEntity = User::class, fetch = FetchType.EAGER, cascade = [CascadeType.PERSIST])</span></span> <span class="hljs-meta"><span class="hljs-meta">@JoinColumn(nullable = false, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user_id"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User ) { <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(token: String?, user: User) : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, token, calculateExpiryDate(<span class="hljs-number"><span class="hljs-number">1440</span></span>), user) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateExpiryDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(expiryTimeInMinutes: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Date { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cal = Calendar.getInstance() cal.time = Timestamp(cal.time.time) cal.add(Calendar.MINUTE, expiryTimeInMinutes) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Date(cal.time.time) }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... et le r√©f√©rentiel: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VerificationTokenRepository.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.repository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.jpa.VerificationToken <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.jpa.repository.JpaRepository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.* <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VerificationTokenRepository</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VerificationToken, Long</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Optional&lt;VerificationToken&gt; }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous devons maintenant impl√©menter des outils de gestion des jetons - cr√©ation, v√©rification et envoi par e-mail. </font><font style="vertical-align: inherit;">Pour ce faire, nous modifions </font></font><code>UserDetailsServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en ajoutant des m√©thodes pour cr√©er et v√©rifier le jeton:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserDetailsServiceImpl.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createVerificationTokenForUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, user: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { tokenRepository.save(VerificationToken(token, user)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateVerificationToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: String { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> verificationToken: Optional&lt;VerificationToken&gt; = tokenRepository.findByToken(token) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (verificationToken.isPresent) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User = verificationToken.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().user <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cal: Calendar = Calendar.getInstance() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((verificationToken.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().expiryDate.time - cal.time.time) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { tokenRepository.delete(verificationToken.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TOKEN_EXPIRED } user.enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> tokenRepository.delete(verificationToken.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()) userRepository.save(user) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TOKEN_VALID } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TOKEN_INVALID } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajoutez maintenant une m√©thode pour envoyer un e-mail avec un lien de confirmation √† </font></font><code>EmailServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EmailServiceImpl.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"> <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${host.url}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hostUrl: String <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userDetailsService: UserDetailsServiceImpl ... <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendRegistrationConfirmationEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> token = UUID.randomUUID().toString() userDetailsService.createVerificationTokenForUser(token, user) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> link = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$hostUrl</span></span></span><span class="hljs-string">/?token=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$token</span></span></span><span class="hljs-string">&amp;confirmRegistration=true"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> msg = <span class="hljs-string"><span class="hljs-string">"&lt;p&gt;Please, follow the link to complete your registration:&lt;/p&gt;&lt;p&gt;&lt;a href=\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$link</span></span></span><span class="hljs-string">\"&gt;</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$link</span></span></span><span class="hljs-string">&lt;/a&gt;&lt;/p&gt;"</span></span> user.email?.let{sendHtmlMessage(user.email!!, <span class="hljs-string"><span class="hljs-string">"KSVG APP: Registration Confirmation"</span></span>, msg)} }</code> </pre><br></div></div><br>  <u>Remarque:</u> <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je recommanderais de stocker l'URL de l'h√¥te dans </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application.properties</font></font></i> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans notre lien, nous transmettons deux param√®tres GET ( </font></font><code>token</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>confirmRegistration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √† l'adresse o√π l'application est d√©ploy√©e. </font><font style="vertical-align: inherit;">Plus tard, je vais expliquer pourquoi.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous modifions le contr√¥leur d'inscription comme suit: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les nouveaux utilisateurs d√©finiront la valeur </font></font><code>false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du champ</font></font><code>isEnabled</code> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Apr√®s avoir cr√©√© un nouveau compte, nous vous enverrons un e-mail pour confirmer l'inscription </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©er un contr√¥leur de validation de jeton distinct </font></font></li><li> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important:</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lors de l'autorisation nous v√©rifierons si le compte est v√©rifi√©:</font></font></li></ul><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AuthController.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.controller <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.email.EmailService <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.validation.Valid <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Autowired <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.HttpStatus <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.ResponseEntity <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.authentication.AuthenticationManager <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.context.SecurityContextHolder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.crypto.password.PasswordEncoder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.GrantedAuthority <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.authority.SimpleGrantedAuthority <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.ui.Model <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.model.LoginUser <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.model.NewUser <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.web.response.SuccessfulSigninResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.web.response.ResponseMessage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.jpa.User <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.repository.UserRepository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.repository.RoleRepository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.jwt.JwtProvider <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.ReCaptchaService <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.UserDetailsService <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationEventPublisher <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.context.request.WebRequest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.UnsupportedEncodingException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.Cookie <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletRequest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.UserDetailsServiceImpl.Companion.TOKEN_VALID <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.UserDetailsServiceImpl.Companion.TOKEN_INVALID <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.UserDetailsServiceImpl.Companion.TOKEN_EXPIRED <span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/api/auth"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthController</span></span></span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.authCookieName}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authCookieName: String <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.isCookieSecure}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isCookieSecure: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authenticationManager: AuthenticationManager <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userRepository: UserRepository <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> roleRepository: RoleRepository <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> encoder: PasswordEncoder <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jwtProvider: JwtProvider <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> captchaService: ReCaptchaService <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userService: UserDetailsService <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> emailService: EmailService <span class="hljs-meta"><span class="hljs-meta">@PostMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/signin"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticateUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Valid</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loginRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LoginUser</span></span></span></span><span class="hljs-function"><span class="hljs-params">, response: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HttpServletResponse</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userCandidate: Optional &lt;User&gt; = userRepository.findByUsername(loginRequest.username!!) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(loginRequest.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userCandidate.isPresent) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User = userCandidate.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!user.enabled) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Account is not verified yet! Please, follow the link in the confirmation email."</span></span>), HttpStatus.UNAUTHORIZED) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authentication = authenticationManager.authenticate( UsernamePasswordAuthenticationToken(loginRequest.username, loginRequest.password)) SecurityContextHolder.getContext().setAuthentication(authentication) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jwt: String = jwtProvider.generateJwtToken(user.username!!) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cookie: Cookie = Cookie(authCookieName, jwt) cookie.maxAge = jwtProvider.jwtExpiration!! cookie.secure = isCookieSecure cookie.isHttpOnly = <span class="hljs-literal"><span class="hljs-literal">true</span></span> cookie.path = <span class="hljs-string"><span class="hljs-string">"/"</span></span> response.addCookie(cookie) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authorities: List&lt;GrantedAuthority&gt; = user.roles!!.stream().map({ role -&gt; SimpleGrantedAuthority(role.name)}).collect(Collectors.toList&lt;GrantedAuthority&gt;()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity.ok(SuccessfulSigninResponse(user.username, authorities)) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"User not found!"</span></span>), HttpStatus.BAD_REQUEST) } } <span class="hljs-meta"><span class="hljs-meta">@PostMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/signup"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Valid</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newUser: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">NewUser</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userCandidate: Optional &lt;User&gt; = userRepository.findByUsername(newUser.username!!) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(newUser.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!userCandidate.isPresent) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (usernameExists(newUser.username!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Username is already taken!"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (emailExists(newUser.email!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Email is already in use!"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Creating user's account val user = User( 0, newUser.username!!, newUser.firstName!!, newUser.lastName!!, newUser.email!!, encoder.encode(newUser.password), false ) user.roles = Arrays.asList(roleRepository.findByName("ROLE_USER")) val registeredUser = userRepository.save(user) emailService.sendRegistrationConfirmationEmail(registeredUser) } catch (e: Exception) { return ResponseEntity(ResponseMessage("Server error. Please, contact site owner"), HttpStatus.SERVICE_UNAVAILABLE) } return ResponseEntity(ResponseMessage("Please, follow the link in the confirmation email to complete the registration."), HttpStatus.OK) } else { return ResponseEntity(ResponseMessage("User already exists!"), HttpStatus.BAD_REQUEST) } } @PostMapping("/registrationConfirm") @CrossOrigin(origins = ["*"]) @Throws(UnsupportedEncodingException::class) fun confirmRegistration(request: HttpServletRequest, model: Model, @RequestParam("token") token: String): ResponseEntity&lt;*&gt; { when(userService.validateVerificationToken(token)) { TOKEN_VALID -&gt; return ResponseEntity.ok(ResponseMessage("Registration confirmed")) TOKEN_INVALID -&gt; return ResponseEntity(ResponseMessage("Token is invalid!"), HttpStatus.BAD_REQUEST) TOKEN_EXPIRED -&gt; return ResponseEntity(ResponseMessage("Token is invalid!"), HttpStatus.UNAUTHORIZED) } return ResponseEntity(ResponseMessage("Server error. Please, contact site owner"), HttpStatus.SERVICE_UNAVAILABLE) } @PostMapping("/logout") fun logout(response: HttpServletResponse): ResponseEntity&lt;*&gt; { val cookie: Cookie = Cookie(authCookieName, null) cookie.maxAge = 0 cookie.secure = isCookieSecure cookie.isHttpOnly = true cookie.path = "/" response.addCookie(cookie) return ResponseEntity.ok(ResponseMessage("Successfully logged")) } private fun emailExists(email: String): Boolean { return userRepository.findByUsername(email).isPresent } private fun usernameExists(username: String): Boolean { return userRepository.findByUsername(username).isPresent } }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, travaillons sur le frontend: </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©ez le composant </font></font><code>RegistrationConfirmPage.vue</code> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ajoutez un nouveau chemin </font></font><code>router.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec le param√®tre </font></font><code>:token</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/registration-confirm/:token'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'RegistrationConfirmPage'</span></span>, <span class="hljs-attr"><span class="hljs-attr">component</span></span>: RegistrationConfirmPage }</code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mise √† jour </font></font><code>SignUp.vue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- apr√®s avoir envoy√© avec succ√®s les donn√©es des formulaires, nous les informerons que pour terminer l'inscription, vous devez suivre le lien dans la lettre. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4 </font></font></b> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important:</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> h√©las, nous ne pouvons pas fournir de lien fixe vers un composant distinct qui validerait le jeton et signalerait un succ√®s ou un √©chec. </font><font style="vertical-align: inherit;">Des liens avec des barres obliques nous m√®neront tout de m√™me √† la page d'origine de l'application. </font><font style="vertical-align: inherit;">Mais nous pouvons indiquer √† notre application la n√©cessit√© de confirmer l'enregistrement en utilisant le param√®tre GET transmis </font></font><code>confirmRegistration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="javascript hljs">methods: { confirmRegistration() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$route.query.confirmRegistration === <span class="hljs-string"><span class="hljs-string">'true'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$route.query.token != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$router.push({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'RegistrationConfirmPage'</span></span>, <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { <span class="hljs-attr"><span class="hljs-attr">token</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$route.query.token}}); } }, ... mounted() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.confirmRegistration(); }</code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©ons un composant qui effectue la validation des jetons et rend compte du r√©sultat de la validation:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RegistrationConfirmPage.vue</font></font></b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;template&gt; &lt;div id="registration-confirm"&gt; &lt;div class="confirm-form"&gt; &lt;b-card title="Confirmation" tag="article" style="max-width: 20rem;" class="mb-2" &gt; &lt;div v-if="isSuccess"&gt; &lt;p class="success"&gt;Account is successfully verified!&lt;/p&gt; &lt;router-link to="/login"&gt; &lt;b-button variant="primary"&gt;Login&lt;/b-button&gt; &lt;/router-link&gt; &lt;/div&gt; &lt;div v-if="isError"&gt; &lt;p class="fail"&gt;Verification failed:&lt;/p&gt; &lt;p&gt;{{ errorMessage }}&lt;/p&gt; &lt;/div&gt; &lt;/b-card&gt; &lt;/div&gt; &lt;/div&gt; &lt;/template&gt; &lt;script&gt; import {AXIOS} from './http-common' export default { name: 'RegistrationConfirmPage', data() { return { isSuccess: false, isError: false, errorMessage: '' } }, methods: { executeVerification() { AXIOS.post(`/auth/registrationConfirm`, null, {params: { 'token': this.$route.params.token}}) .then(response =&gt; { this.isSuccess = true; console.log(response); }, error =&gt; { this.isError = true; this.errorMessage = error.response.data.message; }) .catch(e =&gt; { console.log(e); this.errorMessage = 'Server error. Please, report this error website owners'; }) } }, mounted() { this.executeVerification(); } } &lt;/script&gt; &lt;style scoped&gt; .confirm-form { margin-left: 38%; margin-top: 50px; } .success { color: green; } .fail { color: red; } &lt;/style&gt;</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sultat</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/0n/vj/os/0nvjosmit-f6n538uae6rsvwujo.png"><br></div></div><br><h3>  Au lieu d'une conclusion </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En conclusion de ce document, je voudrais faire une digression et dire que le concept m√™me de l'application discut√© dans cet article et l'article pr√©c√©dent n'√©tait pas nouveau au moment de la r√©daction. </font><font style="vertical-align: inherit;">T√¢che de </font><font style="vertical-align: inherit;">cr√©er rapidement une pile compl√®te d'applications au d√©marrage Spring en </font><font style="vertical-align: inherit;">utilisant JavaScript-cadres modernes angulaire / React / Vue.js r√©sout √©l√©gamment </font></font><a href="https://www.jhipster.tech/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hipster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cependant, les id√©es d√©crites dans cet article peuvent √™tre mises en ≈ìuvre m√™me en utilisant JHipster, donc j'esp√®re que les lecteurs qui viendront √† cet endroit trouveront ce mat√©riel utile m√™me comme aliment de r√©flexion.</font></font><br><br><a name="links"></a><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Liens utiles </font></font></h2><br><ul><li> <a href="https://github.com/DrLeprechaun/kotlin-spring-vue" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©p√¥t GitHub (jusqu'√† l'√©tape ¬´Migrer vers Gradle¬ª)</font></font></a> </li><li> <a href="https://github.com/DrLeprechaun/kotlin-spring-vue-gradle" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©f√©rentiel GitHub (apr√®s l'√©tape ¬´Migrer vers Gradle¬ª)</font></font></a> </li><li> <a href="https://kotlin-spring-vue-demo.herokuapp.com/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application (jusqu'√† l'√©tape ¬´Migrer vers Gradle¬ª)</font></font></a> </li><li> <a href="https://kotlin-spring-vue-gradle-demo.herokuapp.com/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application (apr√®s l'√©tape "Migration vers Gradle")</font></font></a> </li><li> <a href="https://vaadimblog.blogspot.com/p/kotlin-spring-boot-vuejs.html" rel="nofollow">  ,   ,    </a> </li><li> <a href="https://itnext.io/how-to-use-google-recaptcha-with-vuejs-7756244400da" rel="nofollow">How to use Google reCaptcha with Vuejs</a> </li><li> <a href="https://vuejsexamples.com/google-recaptcha-component-for-vue-js/" rel="nofollow">Google ReCAPTCHA component for Vue.js</a> </li><li> <a href="https://www.baeldung.com/spring-email" rel="nofollow">Guide to Spring Email</a> </li><li> <a href="https://medium.com/%40raviswapna1/send-email-using-spring-boot-and-thymeleaf-b0f62786bd8e" rel="nofollow">Send Email using Spring Boot and Thymeleaf</a> </li><li> <a href="https://docs.gradle.org/5.6.3/userguide/migrating_from_maven.html" rel="nofollow">Migrating Builds From Apache Maven</a> </li><li> <a href="https://guides.gradle.org/migrating-build-logic-from-groovy-to-kotlin/" rel="nofollow">Migrating build logic from Groovy to Kotlin</a> </li><li> <a href="https://ordina-jworks.github.io/architecture/2018/10/12/spring-boot-angular-gradle.html" rel="nofollow">Integrate Angular in Spring Boot Using Gradle</a> </li><li> <a href="https://devcenter.heroku.com/articles/getting-started-with-gradle-on-heroku" rel="nofollow">Getting Started with Gradle on Heroku</a> </li><li> <a href="https://devcenter.heroku.com/articles/deploying-gradle-apps-on-heroku" rel="nofollow">Deploying Gradle Apps on Heroku</a> </li><li> <a href="https://devcenter.heroku.com/articles/deploying-gradle-apps-on-heroku" rel="nofollow">Deploying multi-project builds</a> </li><li> <a href="https://www.rdegges.com/2018/please-stop-using-local-storage/" rel="nofollow">Please Stop Using Local Storage</a> </li><li> <a href="https://medium.com/%40jcbaey/authentication-in-spa-reactjs-and-vuejs-the-right-way-e4a9ac5cd9a3" rel="nofollow">Authentication in SPA (ReactJS and VueJS) the right way</a> </li><li> <a href="https://www.ninjadevcorner.com/2018/09/stateless-authentication-jwt-secure-spring-boot-rest-api.html" rel="nofollow">Stateless Authentication using JWT to secure a Spring Boot REST API</a> </li><li> <a href="https://www.baeldung.com/registration-verify-user-by-email" rel="nofollow">Registration ‚Äì Activate a New Account by Email</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482222/">https://habr.com/ru/post/fr482222/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482208/index.html">Cadeaux qui vous font manquer le Nouvel An</a></li>
<li><a href="../fr482210/index.html">Bot pour Tetris et animation d'ing√©nierie inverse. Analyse de la piste mobile du deuxi√®me championnat de programmation</a></li>
<li><a href="../fr482212/index.html">Tu parles de ... fromage?</a></li>
<li><a href="../fr482216/index.html">23 r√©ponses √† la d√©pression d'un psychiatre professionnel Maxim Malyavin (dpmmax)</a></li>
<li><a href="../fr482220/index.html">Localisation du marqueur Aruco</a></li>
<li><a href="../fr482224/index.html">Quand un designer doit √™tre un petit programmeur</a></li>
<li><a href="../fr482228/index.html">Nous √©crivons une ¬´calculatrice¬ª en C #. Partie I. Calcul de la valeur, d√©riv√©, simplification et autres oies</a></li>
<li><a href="../fr482230/index.html">La bataille des serveurs WEB. Partie 2 - Sc√©nario HTTPS r√©aliste:</a></li>
<li><a href="../fr482232/index.html">StackOverflow est plus qu'un simple r√©f√©rentiel de r√©ponses √† des questions stupides</a></li>
<li><a href="../fr482234/index.html">Mod√©lisation num√©rique √† analogique et mixte dans PADS Professional</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>