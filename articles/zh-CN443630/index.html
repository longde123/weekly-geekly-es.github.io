<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏑 ✏️ 🆙 如何在JavaScript中实现编程语言。 第1部分：解析器 🤦🏿 🤠 🥡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="你好 我向您介绍了用于实施JavaScript编程语言的指南的业余翻译-PL教程 。 
 来自翻译 


 我们将创建自己的编程语言-λ语言 （原始语言 -λanguage）。 在创建过程中，我们将使用许多有趣的技术，例如递归下降，控件传递样式和基本的优化技术。 将创建两个版本的解释器-常规和CPS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>如何在JavaScript中实现编程语言。 第1部分：解析器</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443630/"><p> 你好 我向您介绍了用于实施JavaScript编程语言的指南的业余翻译<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-PL教程</a> 。 </p><br><h1 id="ot-perevodchika"> 来自翻译 </h1><br><p> 我们将创建自己的编程语言<strong>-λ语言</strong> （原始<strong>语言</strong> -λanguage）。 在创建过程中，我们将使用许多有趣的技术，例如递归下降，控件传递样式和基本的优化技术。 将创建两个版本的解释器-常规和CPS解释器，即JavaScript中的反编译器。 </p><br><p> 原著的作者是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mihai Bazon</a> ，著名的UglifyJS库（一种用于最小化和格式化JS代码的工具）的作者。 </p><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">目录内容</b> <div class="spoiler_text"><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">如何在JavaScript中实现编程语言。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第1部分：解析器</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">如何在JavaScript中实现编程语言。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第2部分：翻译</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">如何在JavaScript中实现编程语言。</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第3部分：CPS解释器</a> </li><li> 如何在JavaScript中实现编程语言。 第4部分：JS中的反编译 </li></ol></div></div><br><h1 id="vstuplenie"> 参赛作品 </h1><br><p>如果您曾经编写过编译器或解释器，那么对您来说就没有什么新鲜的了。 但是，如果您使用正则表达式来<a href="">解析</a>类似于编程语言的内容，那么请阅读有关<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解析</a>的部分。 让我们编写更少错误的代码！ </p><br><p> 本文按“从简单到复杂”的顺序分为几部分。 我不建议您跳过本文的某些部分，除非您对主题非常了解。 如果您不了解某些内容，可以随时返回。 </p><br><p> 我们要学习什么： </p><br><ul><li> 什么是解析器，以及如何编写它。 </li><li> 如何编写口译员。 </li><li> 转移的续集及其重要性。 </li><li> 编写一个（trans）编译器。 </li><li> 延续转移风格。 </li><li> 一些基本的代码优化技术。 </li><li> 与JavaScript相比，我们的λ语言新功能示例。 </li></ul><br><p> 与此同时，我将展示为什么Lisp是一种很棒的编程语言。  <strong>但是，我们正在使用的语言不是Lisp。</strong> 它具有更丰富的语法（每个人都知道的经典后缀表示法），类似于Scheme（宏除外）。 好的与否，但是宏是Lisp的主要功能-其他语言（除了Lisp的方言）无法做到的和它一样。  （是的，我知道SweetJS ...关闭，但不是。） </p><br><p> 但是首先，让我们介绍一下我们的编程语言。 </p><br><a name="Language"></a><br><h1 id="zyk">  λ语言 </h1><br><p> 在做任何事情之前，我们必须清楚地知道我们想做什么。 编写语言语法的描述会很好，但是我将使其变得更容易-编写一个简单程序的示例，因此这里是λ语言的一些示例： </p><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   println("Hello World!"); println(2 + 3 * 4); #       `lambda`  `λ` fib = lambda (n) if n &lt; 2 then n else fib(n - 1) + fib(n - 2); println(fib(15)); print-range = λ(a, b) # `λ`     ,   `lambda` if a &lt;= b then { # `then`  ,      print(a); if a + 1 &lt;= b { print(", "); print-range(a + 1, b); } else println(""); #   }; print-range(1, 5);</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">关于变量名的注意</b> <div class="spoiler_text"><p> 请注意，标识符可能包含减号（ <code>print-range</code> ）。 这是一个品味问题。 我总是在运算符周围放置空格。 我真的不喜欢camelRegister和破折号胜过不可见的空格（“ _”）。 自己做某事时，您可以做的多么酷。 </p></div></div><br><p> 结论： </p><br><pre> <code class="plaintext hljs">Hello World! 14 610 1, 2, 3, 4, 5</code> </pre> <br><p> 该语言看起来与JavaScript类似，但总体而言并非如此。 首先，没有语句，只有表达式。 一个表达式必须返回一个值，并且可以在另一个表达式的任何地方使用。 需要分号来分隔表达式的“序列”中的表达式。 花括号<code>{</code>和<code>}</code>创建一个序列，该序列本身就是一个表达式，其值是该序列中的最后一个值。 以下程序是正确的： </p><br><pre> <code class="python hljs">a = { fib(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">#    ,      fib(15) #        }; print(a); #  610</span></span></code> </pre> <br><p> 使用<code>lambda</code>或<code>λ</code>关键字创建函数。 之后，括号中是参数名称（可能为空）列表，以逗号分隔。 函数的主体是一个表达式，但可以包含在序列<code>{...}</code> 。 还值得注意的是，没有<code>return</code>关键字。 该函数返回最后一个表达式的值。 </p><br><p> 另外，没有<code>var</code> 。 为了添加变量，您可以使用JavaScript程序员称为<code>IIFE</code> 。 使用<code>lambda</code> ，将变量声明为参数。 对于变量，作用域是一个函数，函数是闭包，如JavaScript [ 翻译：直至ES6。]。 </p><br><p> 即使是一个表达。  JavaScript使用三元运算符执行此操作： </p><br><pre> <code class="python hljs">a = foo() ? bar() : baz(); // JavaScript a = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> foo() then bar() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> baz(); <span class="hljs-comment"><span class="hljs-comment"># λ</span></span></code> </pre> <br><p> 如上所示，如果分支是序列（ <code>{...}</code> ）， <code>then</code>关键字是可选的。 在另一种情况下，这是必要的。 如果存在替代分支，则使用<code>else</code> 。 再一次， <code>then</code>表达式作为主体，但是您可以使用<code>{...}</code>将多个表达式组合为一个。 如果不存在<code>else</code>并且条件为<code>false</code> ，则所有<code>if</code>的结果为<code>false</code> 。 值得注意的是， <code>false</code>是表示值的关键字，该值是λ语言中唯一的错误值： </p><br><pre> <code class="plaintext hljs">if foo() then print("OK");</code> </pre> <br><p> 仅当<code>foo()</code>的结果<strong>不为</strong> <code>false</code>才会输出<code>OK</code> 。 另外，还有一个关键字<code>true</code> ，但是绝对不是<code>false</code>所有内容（在JavaScript中，运算符<code>===</code> ）在分支中都将视为<code>true</code> （包括数字<code>0</code>和空字符串<code>""</code> ）。 </p><br><p> 请注意，在<code>if</code> ，表达式之间不需要括号。 如果添加它们，那将不是一个错误，因为<code>(</code>表达式开始，但是它们只是多余的。 </p><br><p> 即使用括号括起来，也可以解析整个程序，因此应添加<code>;</code> 在每个表达式之后。 最后一个表达式是一个例外。 </p><br><p> 太好了，这是我们的小λ语言。 他并不完美。 语法看起来很漂亮，但是有缺陷。 有许多缺少的功能，例如对象和数组。 我们不关注它们，因为它们不是我们编程语言的基础。 </p><br><p> 接下来，我们将为我们的语言编写一个解析器。 </p><br><a name="Parsing"></a><br><h1 id="prevraschenie-koda-v-ast"> 代码转换为AST </h1><br><p> 创建解析器是一项艰巨的任务。 本质上，它应该花费一段代码并将其转换为AST（抽象语法树）。  AST是内存中程序的结构化表示，是抽象的，因为它不包含有关代码的完整信息，而仅包含语义。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">说明AST</a>在单独的部分中。 </p><br><p> 例如，我们有以下代码： </p><br><pre> <code class="python hljs">sum = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>(a, b) { a + b; }; print(sum(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>));</code> </pre> <br><p> 我们的解析器将生成一棵树作为JavaScript对象： </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">prog</span></span>: [ <span class="hljs-comment"><span class="hljs-comment">//  : { type: "assign", operator: "=", left: { type: "var", value: "sum" }, right: { type: "lambda", vars: [ "a", "b" ], body: { //     "prog",  ,  //     ,  //     . type: "binary", operator: "+", left: { type: "var", value: "a" }, right: { type: "var", value: "b" } } } }, //  : { type: "call", func: { type: "var", value: "print" }, args: [{ type: "call", func: { type: "var", value: "sum" }, args: [ { type: "num", value: 1 }, { type: "num", value: 2 } ] }] } ] }</span></span></code> </pre> <br><p> 创建解析器的主要困难是正确组织代码的困难。 与从字符串中读取字符相比，解析器应该在更高的层次上工作。 一些降低代码复杂性的准则： </p><br><ul><li> 编写很多小功能。 在每个功能中，都要做一件事并做好。 </li><li> 不要尝试使用正则表达式进行解析。 他们只是不工作。 它们在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">词法分析器中</a>可能很有用，但为简单起见，我们将不使用它们。 </li><li> 不要试图猜测。 如果不确定如何解析某些内容，请引发一个包含错误位置（行和列）的异常。 </li></ul><br><p> 为了使代码更简单，我们将其分为三部分，然后又分为许多小功能： </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">字符流</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">令牌流（令牌）</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解析器</a> </li></ul><br><a name="InputStream"></a><br><h1 id="potok-simvolov"> 字符流 </h1><br><p> 这是最简单的部分。 我们将创建一个流对象，该对象将表示从字符串中顺序读取字符的操作。 它包含四个功能： </p><br><ul><li>  <code>peek()</code> -返回下一个字符，而不从流中提取它。 </li><li>  <code>next()</code> -返回下一个字符，将其从流中提取出来。 </li><li>  <code>eof()</code> -如果流中没有更多字符，则返回<code>true</code> 。 </li><li>  <code>croak(msg)</code> -引发包含消息（ <code>msg</code> ）和流中当前位置的异常。 </li></ul><br><p> 需要最后一个函数，以便您可以简单地引发一个包含错误位置的异常。 </p><br><p> 这是此对象的完整代码（我们称其为<code>InputStream</code> ）。 它足够小，因此您不会遇到任何问题： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InputStream</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pos = <span class="hljs-number"><span class="hljs-number">0</span></span>, line = <span class="hljs-number"><span class="hljs-number">1</span></span>, col = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">next</span></span> : next, <span class="hljs-attr"><span class="hljs-attr">peek</span></span> : peek, <span class="hljs-attr"><span class="hljs-attr">eof</span></span> : eof, <span class="hljs-attr"><span class="hljs-attr">croak</span></span> : croak, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = input.charAt(pos++); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"\n"</span></span>) line++, col = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> col++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ch; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">peek</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> input.charAt(pos); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peek() == <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">croak</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(msg + <span class="hljs-string"><span class="hljs-string">" ("</span></span> + line + <span class="hljs-string"><span class="hljs-string">":"</span></span> + col + <span class="hljs-string"><span class="hljs-string">")"</span></span>); } }</code> </pre> <br><p> 请注意，这不是普通对象（通过<code>new</code>创建）。 要获得此对象，您需要： <code>var stream = InputStream(string)</code> 。 </p><br><p> 接下来，我们将编写以下抽象级别： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">令牌流（令牌）</a> 。 </p><br><a name="TokenStream"></a><br><h1 id="potok-tokenov-leksem"> 令牌流（令牌） </h1><br><p> 标记器（lexer）使用字符流并返回具有相同接口的对象，但是<code>peek()</code> / <code>next()</code>函数的返回值将是标记。 令牌是具有两个属性的<code>type</code> ： <code>type</code> ， <code>value</code> 。 以下是令牌的一些示例： </p><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"punc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">"("</span></span> } <span class="hljs-comment"><span class="hljs-comment">// . : , ,     . . { type: "num", value: 5 } //  { type: "str", value: "Hello World!" } //  { type: "kw", value: "lambda" } //   { type: "var", value: "a" } //  { type: "op", value: "!=" } // </span></span></code> </pre> <br><p> 只需跳过空格（空格，制表符，换行符）和注释。 </p><br><p> 要编写令牌生成器，我们需要仔细研究一下我们的语言。 这个想法是要注意，根据当前字符（ <code>input.peek()</code> ），我们可以决定读取哪个标记： </p><br><ul><li> 首先，跳过空格。 </li><li> 如果为<code>input.eof()</code> ，则返回<code>null</code> 。 </li><li> 如果它是<code>#</code>字符，则将所有字符跳过到该行的末尾（并返回下一个标记）。 </li><li> 如果这是引号，则读取字符串。 </li><li> 如果这是一个数字，请阅读该数字。 </li><li> 如果是字母，则我们读取单词，然后返回标识符或关键字。 </li><li> 如果这是特殊字符之一，则返回相应的标记。 </li><li> 如果这是运算符的符号之一，则我们返回相应的令牌。 </li><li> 如果以上都不适用，则使用<code>input.croak()</code>引发异常。 </li></ul><br><p> 我们将拥有<code>read_next</code>函数，这是分词器的主要功能： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ read_while(is_whitespace); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input.eof()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"#"</span></span>) { skip_comment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_next(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">'"'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_string(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_digit(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_number(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_id_start(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_ident(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"punc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : input.next() }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_op_char(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"op"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : read_while(is_op_char) }; input.croak(<span class="hljs-string"><span class="hljs-string">"Can't handle character: "</span></span> + ch); }</code> </pre> <br><p> 在这里，您可以看到许多其他函数，它们返回不同类型的令牌，例如<code>read_string()</code> ， <code>read_number()</code>等。...它们被放置在单独的函数中，因此代码看起来更简单，更漂亮。 </p><br><p> 另外，有趣的是我们不会一次删除所有符号：每次解析器要求下一个令牌时，我们都会读取一个令牌。 如果发生某种错误，我们甚至不会阅读所有字符。 </p><br><p>  <code>read_ident()</code>将读取可能是标识符（ <code>is_id()</code> ）一部分的所有字符。 标识符必须以字母<code>λ</code>或<code>_</code>开头，并且可以包含相同的字符，数字或以下任意一项： <code>?!-&lt;&gt;=</code> 。 因此， <code>foo-bar</code>不会被读取为三个令牌，而将被读取为一个（ <code>var</code> token）。 为了能够使用<code>is-pair?</code>名称定义函数，这是否必要<code>is-pair?</code> 或<code>string&gt;=</code> （对不起，我是Lisper）。 </p><br><p> 另外， <code>read_ident()</code>将检查已知关键字列表中是否存在标识符，如果存在，则将返回<code>kw</code>令牌而不是<code>var</code>令牌。 </p><br><p> 我认为代码说明了一切，因此这是我们语言的现成标记器： </p><br><div class="spoiler">  <b class="spoiler_title">整个代码</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TokenStream</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> current = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keywords = <span class="hljs-string"><span class="hljs-string">" if then else lambda λ true false "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">next</span></span> : next, <span class="hljs-attr"><span class="hljs-attr">peek</span></span> : peek, <span class="hljs-attr"><span class="hljs-attr">eof</span></span> : eof, <span class="hljs-attr"><span class="hljs-attr">croak</span></span> : input.croak }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_keyword</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> keywords.indexOf(<span class="hljs-string"><span class="hljs-string">" "</span></span> + x + <span class="hljs-string"><span class="hljs-string">" "</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_digit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-regexp"><span class="hljs-regexp">/[0-9]/i</span></span>.test(ch); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_id_start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-regexp"><span class="hljs-regexp">/[a-zλ_]/i</span></span>.test(ch); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_id</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_id_start(ch) || <span class="hljs-string"><span class="hljs-string">"?!-&lt;&gt;=0123456789"</span></span>.indexOf(ch) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_op_char</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"+-*/%=&amp;|&lt;&gt;!"</span></span>.indexOf(ch) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_punc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">",;(){}[]"</span></span>.indexOf(ch) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_whitespace</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">" \t\n"</span></span>.indexOf(ch) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_while</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">predicate</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> str = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof() &amp;&amp; predicate(input.peek())) str += input.next(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_number</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> has_dot = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> number = read_while(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"."</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (has_dot) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; has_dot = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_digit(ch); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(number) }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_ident</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = read_while(is_id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : is_keyword(id) ? <span class="hljs-string"><span class="hljs-string">"kw"</span></span> : <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : id }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_escaped</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">end</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> escaped = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, str = <span class="hljs-string"><span class="hljs-string">""</span></span>; input.next(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = input.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (escaped) { str += ch; escaped = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"\\"</span></span>) { escaped = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == end) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { str += ch; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> str; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_string</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: read_escaped(<span class="hljs-string"><span class="hljs-string">'"'</span></span>) }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_comment</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ read_while(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ch != <span class="hljs-string"><span class="hljs-string">"\n"</span></span> }); input.next(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ read_while(is_whitespace); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input.eof()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"#"</span></span>) { skip_comment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_next(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">'"'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_string(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_digit(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_number(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_id_start(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> read_ident(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"punc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : input.next() }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_op_char(ch)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"op"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : read_while(is_op_char) }; input.croak(<span class="hljs-string"><span class="hljs-string">"Can't handle character: "</span></span> + ch); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">peek</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current || (current = read_next()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = current; current = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok || read_next(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eof</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> peek() == <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre> </div></div><br><ul><li>  <code>next()</code>函数并不总是调用<code>read_next()</code> ，因为以前可能已经读取了一个令牌（使用<code>peek()</code>函数）。 为此，我们有一个包含当前标记的<code>current</code>变量。 </li><li> 常规表示法仅支持十进制数字（不支持1E5、0x等）。 但是，如果我们想增加他们的支持，我们只会更改<code>read_number()</code> 。 </li><li> 与JavaScript不同，唯一不能在字符串中转义的字符是引号和反斜杠。 行可以包含换行符，制表符和其他任何内容。 我们不解释诸如<code>\n</code> ， <code>\t</code>等标准组合。...重做（ <code>read_string()</code> ）非常容易。 </li></ul><br><p> 现在我们有了功能强大的工具，可以轻松编写<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解析器</a> ，但是首先，我建议您查看<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AST描述</a> 。 </p><br><a name="AST"></a><br><h1 id="opisanie-ast">  AST说明 </h1><br><p> 如上所述，解析器将构建一个结构，以显示程序的语义。  AST由节点组成。 每个节点都是一个常规JavaScript对象，该对象具有<code>type</code>属性，该属性确定节点的类型以及取决于该类型的其他信息。 </p><br><table><thead><tr><th> 型式 </th><th> 结构形式 </th></tr></thead><tbody><tr><td> 数 </td><td> <code>{ type: "num", value: NUMBER }</code> </td> </tr><tr><td> 力量 </td><td> <code>{ type: "str", value: STRING }</code> </td> </tr><tr><td> 布尔 </td><td> <code>{ type: "bool", value: true or false }</code> </td> </tr><tr><td> 变种 </td><td> <code>{ type: "var", value: NAME }</code> </td> </tr><tr><td> 拉姆达 </td><td> <code>{ type: "lambda", vars: [ NAME... ], body: AST }</code> </td> </tr><tr><td> 叫 </td><td> <code>{ type: "call", func: AST, args: [ AST... ] }</code> </td> </tr><tr><td> 如果 </td><td> <code>{ type: "if", cond: AST, then: AST, else: AST }</code> </td> </tr><tr><td> 分配 </td><td> <code>{ type: "assign", operator: "=", left: AST, right: AST }</code> </td> </tr><tr><td> 二元 </td><td> <code>{ type: "binary", operator: OPERATOR, left: AST, right: AST }</code> </td> </tr><tr><td> 编 </td><td> <code>{ type: "prog", prog: [ AST... ] }</code> </td> </tr><tr><td> 让 </td><td> <code>{ type: "let", vars: [ VARS... ], body: AST }</code> </td> </tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">例子</b> <div class="spoiler_text"><h5 id="chisla-num"> 数字（ <code>num</code> ）： </h5><br><pre> <code class="python hljs"><span class="hljs-number"><span class="hljs-number">123.5</span></span></code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">123.5</span></span> }</code> </pre> <br><h5 id="stroki-str"> 行（ <code>str</code> ）： </h5><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"Hello World"</span></span></code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"str"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">"Hello World!"</span></span> }</code> </pre> <br><h5 id="true-i-false-bool">  <code>true</code>与<code>false</code> （ <code>bool</code> ）： </h5><br><pre> <code class="python hljs">true false</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre> <br><h5 id="identifikatory-var"> 标识符（ <code>var</code> ）： </h5><br><pre> <code class="python hljs">foo</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span> }</code> </pre> <br><h5 id="funkcii-lambda"> 函数（ <code>lambda</code> ）： </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> (x) <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-comment"><span class="hljs-comment">#  λ (x) 10</span></span></code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"lambda"</span></span>, <span class="hljs-attr"><span class="hljs-attr">vars</span></span>: [ <span class="hljs-string"><span class="hljs-string">"x"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">body</span></span>: { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } }</code> </pre> <br><p> 稍后，我们将添加一个可选的参数<code>name</code>以支持带有名称的函数，但解析器的第一个版本将不支持它们。 </p><br><h5 id="vyzovy-funkciy-call"> 函数调用（ <code>call</code> ）： </h5><br><pre> <code class="python hljs">foo(a, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"call"</span></span>, <span class="hljs-string"><span class="hljs-string">"func"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span> }, <span class="hljs-string"><span class="hljs-string">"args"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> } ] }</code> </pre> <br><h5 id="vetvleniya-if"> 分支（ <code>if</code> ）： </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> foo then bar <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> baz</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"if"</span></span>, <span class="hljs-string"><span class="hljs-string">"cond"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span> }, <span class="hljs-string"><span class="hljs-string">"then"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"bar"</span></span> }, <span class="hljs-string"><span class="hljs-string">"else"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"baz"</span></span> } }</code> </pre> <br><h6 id="bez-else"> 没有<code>else</code> ： </h6><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> foo then bar</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"if"</span></span>, <span class="hljs-string"><span class="hljs-string">"cond"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"foo"</span></span> }, <span class="hljs-string"><span class="hljs-string">"then"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"bar"</span></span> } }</code> </pre> <br><h5 id="prisvaivanie-assign"> 作业： </h5><br><pre> <code class="python hljs">a = <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"assign"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } }</code> </pre> <br><h5 id="binarnye-operatory-binary"> 二进制运算符（ <code>binary</code> ）： </h5><br><pre> <code class="python hljs">x + y * z</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"+"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"x"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"y"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"z"</span></span> } } }</code> </pre> <br><h5 id="posledovtelnosti-prog"> 序列（ <code>prog</code> ）： </h5><br><pre> <code class="python hljs">{ a = <span class="hljs-number"><span class="hljs-number">5</span></span>; b = a * <span class="hljs-number"><span class="hljs-number">2</span></span>; a + b; }</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-string"><span class="hljs-string">"prog"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"assign"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"assign"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"="</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> } } }, { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"+"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span> } } ] }</code> </pre> <br><h5 id="peremennye-zaklyuchennye-v-bloki-let"> 包含在块中的变量（ <code>let</code> ）： </h5><br><pre> <code class="python hljs">let (a = <span class="hljs-number"><span class="hljs-number">10</span></span>, b = a * <span class="hljs-number"><span class="hljs-number">10</span></span>) { a + b; }</code> </pre> <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"let"</span></span>, <span class="hljs-string"><span class="hljs-string">"vars"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span>, <span class="hljs-string"><span class="hljs-string">"def"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } }, { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span>, <span class="hljs-string"><span class="hljs-string">"def"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"num"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> } } } ], <span class="hljs-string"><span class="hljs-string">"body"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"+"</span></span>, <span class="hljs-string"><span class="hljs-string">"left"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"a"</span></span> }, <span class="hljs-string"><span class="hljs-string">"right"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"var"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span> } } }</code> </pre> <br><p> 解析器的第一个版本不支持这种类型的节点；稍后我们将添加它。 </p></div></div><br><a name="Parser"></a><br><h1 id="parser"> 解析器 </h1><br><p> 解析器将构建上述树。 </p><br><p> 由于我们在令牌生成器中所做的工作，因此解析器可以处理令牌流而不是字符流。 这里还有许多其他功能可以简化结构。 我们将讨论主要的。 让我们从一个高级的解析器功能开始： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_lambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"lambda"</span></span>, <span class="hljs-attr"><span class="hljs-attr">vars</span></span>: delimited(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">","</span></span>, parse_varname), <span class="hljs-attr"><span class="hljs-attr">body</span></span>: parse_expression() }; }</code> </pre> <br><p> 当已经从令牌流中获取了<code>lambda</code>关键字时，将调用此函数，因此我们只需要获取参数的名称即可。 但是由于它们在方括号中并用逗号分隔，因此我们将使用定<code>delimited</code>函数来执行此操作，该函数采用以下参数： <code>start</code> ， <code>stop</code> ， <code>separator</code> ， <code>parser</code>函数，该函数分别解析每个元素。 在这种情况下，我们使用<code>parse_varname</code>函数，如果它注意到一些看起来不像变量的函数， <code>parse_varname</code>引发错误。 该函数的主体是一个表达式，因此我们可以通过<code>parse_expression</code>获得它。 </p><br><p>  <code>delimited</code>功能为较低级别： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delimited</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">start, stop, separator, parser</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = [], first = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; skip_punc(start); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(stop)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first) first = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> skip_punc(separator); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(stop)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      a.push(parser()); } skip_punc(stop); return a; }</span></span></code> </pre> <br><p> 如您所见，它使用了更多功能： <code>is_punc</code>和<code>skip_punc</code> 。 如果当前标记是给定的标点符号（不提取它），则第一个返回<code>true</code> ，而<code>skip_punc</code>将检查当前标记是否是给定的标点字符并提取它（否则抛出异常）。 </p><br><p> 解析整个程序的函数似乎是最简单的： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_toplevel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prog = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { prog.push(parse_expression()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!input.eof()) skip_punc(<span class="hljs-string"><span class="hljs-string">";"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">prog</span></span>: prog }; }</code> </pre> <br><p> 由于我们只有表达式，因此我们只需调用<code>parse_expression()</code>并读取表达式，直到读取所有内容。 使用<code>skip_punc(";")</code> ，我们可以做到<code>;</code> 每个表达式后必须输入。 </p><br><p> 另一个简单的示例是<code>parse_if()</code> ： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_if</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ skip_kw(<span class="hljs-string"><span class="hljs-string">"if"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cond = parse_expression(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_punc(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)) skip_kw(<span class="hljs-string"><span class="hljs-string">"then"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> then = parse_expression(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ret = { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"if"</span></span>, <span class="hljs-attr"><span class="hljs-attr">cond</span></span>: cond, <span class="hljs-attr"><span class="hljs-attr">then</span></span>: then }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"else"</span></span>)) { input.next(); ret.else = parse_expression(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }</code> </pre> <br><p> 她跳过<code>if</code>关键字（如果当前令牌不是<code>if</code>关键字， <code>if</code>抛出异常），使用<code>parse_expression()</code>读取条件。 如果符号<code>{</code>没有更进一步，则需要then关键字（如果没有它，语法看起来会不太好）。 分支只是表达式，因此我们再次对其使用<code>parse_expression()</code> 。  <code>else</code>分支是可选的，因此我们在解析关键字之前先检查该关键字的存在。 </p><br><p> 通过许多小的功能，我们可以使代码简单。 我们编写解析器的方式几乎与使用高级语言来解析语法的方式一样。 所有这些函数都是“相互递归”的，也就是说，我们有<code>parse_atom()</code> ，它根据当前标记调用其他函数。 其中之一是<code>parse_if()</code> （在当前标记为<code>if</code>调用），然后依次调用<code>parse_expression()</code> 。 但是<code>parse_expression()</code>调用<code>parse_atom()</code> 。 由于函数之一总是提取至少一个令牌，因此没有无限递归。 </p><br><p> 这种解析方法称为“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">递归下降法”</a> ，实际上，这是最容易编写的。 </p><br><h3 id="bolee-nizkiy-uroven-parse_atom-i-parse_expression"> 下层： <code>parse_atom()</code>和<code>parse_expression()</code> </h3><br><p>  <code>parse_atom()</code>函数调用另一个函数，具体取决于当前令牌： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_atom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(<span class="hljs-string"><span class="hljs-string">"("</span></span>)) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exp = parse_expression(); skip_punc(<span class="hljs-string"><span class="hljs-string">")"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exp; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_prog(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"if"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_if(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"true"</span></span>) || is_kw(<span class="hljs-string"><span class="hljs-string">"false"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_bool(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"lambda"</span></span>) || is_kw(<span class="hljs-string"><span class="hljs-string">"λ"</span></span>)) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_lambda(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tok.type == <span class="hljs-string"><span class="hljs-string">"var"</span></span> || tok.type == <span class="hljs-string"><span class="hljs-string">"num"</span></span> || tok.type == <span class="hljs-string"><span class="hljs-string">"str"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok; unexpected(); }); }</code> </pre> <br><p> 当她看到<code>parse_expression()</code>括号时，应该加上括号表达式，因此，跳过该方括号，该函数将调用<code>parse_expression()</code>并希望此后跳过该右方括号。 如果她看到某种关键字，则将调用相应的函数。 如果她看到一个常量或标识符，则按原样返回它。 如果什么都没有发生，它将调用<code>unexpected()</code> ，这将引发异常。 </p><br><p> 当看到<code>{</code> ，她调用<code>parse_prog</code>来解析表达式序列。 另外， <code>parse_prog</code>了一个简单的优化：如果<code>{</code>和<code>}</code>之间没有表达式，则返回<code>false</code> ；如果只有一个表达式，则仅返回它。 否则，将返回带有表达式数组的<code>prog</code>节点。 </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     FALSE   , //     . var FALSE = { type: "bool", value: false }; function parse_prog() { var prog = delimited("{", "}", ";", parse_expression); if (prog.length == 0) return FALSE; if (prog.length == 1) return prog[0]; return { type: "prog", prog: prog }; }</span></span></code> </pre> <br><p> 这是<code>parse_expression()</code>函数。 与<code>parse_atom()</code>不同，它将使用<code>maybe_binary()</code>解析尽可能多的表达式： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_expression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_binary(parse_atom(), <span class="hljs-number"><span class="hljs-number">0</span></span>); }); }</code> </pre> <br><h3 id="funkcii-maybe_"> 功能可能<code>maybe_*</code> </h3><br><p> 这些函数检查表达式之后的内容，并确定是将表达式包装在其节点中还是直接返回该节点。 </p><br><p>  <code>maybe_call()</code>函数非常简单：它获得了一个解析当前表达式的函数，如果遇到<code>(</code>在表达式之后，它将自身包装在<code>call</code> 。请注意<code>delimited()</code>如何适合解析参数列表： </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maybe_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ expr = expr(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_punc(<span class="hljs-string"><span class="hljs-string">"("</span></span>) ? parse_call(expr) : expr; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"call"</span></span>, <span class="hljs-attr"><span class="hljs-attr">func</span></span>: func, <span class="hljs-attr"><span class="hljs-attr">args</span></span>: delimited(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">","</span></span>, parse_expression) }; }</code> </pre> <br><h3 id="prioritet-operatorov"> 操作员优先 </h3><br><p>  <code>maybe_binary(left, my_prec)</code>函数用于组合诸如<code>1 + 2 * 3</code>表达式。   , ,    ,     : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PRECEDENCE = { <span class="hljs-string"><span class="hljs-string">"="</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"||"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"&amp;&amp;"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"=="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"!="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"+"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"-"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"*"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"/"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"%"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, };</code> </pre> <br><p>   ,  <code>*</code> "",  <code>+</code> , ,  <code>1 + 2 * 3</code>    <code>(1 + (2 * 3))</code>  <code>((1 + 2) * 3)</code> . </p><br><p>   ,      ( <code>read_atom</code> )     <code>maybe_binary()</code> ( ),     ( <code>my_prec</code> ).  <code>maybe_binary</code>  ,   .     ,     ,     . </p><br><p>   ,    ,   ,         <code>binary</code> ,  ,       ,      (*): </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maybe_binary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">left, my_prec</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = is_op(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tok) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> his_prec = PRECEDENCE[tok.value]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (his_prec &gt; my_prec) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> right = maybe_binary(parse_atom(), his_prec) <span class="hljs-comment"><span class="hljs-comment">// (*); var binary = { type : tok.value == "=" ? "assign" : "binary", operator : tok.value, left : left, right : right }; return maybe_binary(binary, my_prec); } } return left; }</span></span></code> </pre> <br><p>  ,  ,     ,    <code>maybe_binary</code> ,    ( <code>my_prec</code> ),  ,      ,     .  - ,    (,        ),     . </p><br><p> ,   ,  <code>my_prec</code>   0,         <code>binary</code> ( <code>assign</code>   <code>=</code> ). </p><br><p>      ,    . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> FALSE = { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PRECEDENCE = { <span class="hljs-string"><span class="hljs-string">"="</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"||"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"&amp;&amp;"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"&gt;="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"=="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"!="</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-string"><span class="hljs-string">"+"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"-"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"*"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"/"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"%"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_toplevel(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_punc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok &amp;&amp; tok.type == <span class="hljs-string"><span class="hljs-string">"punc"</span></span> &amp;&amp; (!ch || tok.value == ch) &amp;&amp; tok; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_kw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">kw</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok &amp;&amp; tok.type == <span class="hljs-string"><span class="hljs-string">"kw"</span></span> &amp;&amp; (!kw || tok.value == kw) &amp;&amp; tok; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_op</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">op</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.peek(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok &amp;&amp; tok.type == <span class="hljs-string"><span class="hljs-string">"op"</span></span> &amp;&amp; (!op || tok.value == op) &amp;&amp; tok; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_punc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(ch)) input.next(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> input.croak(<span class="hljs-string"><span class="hljs-string">"Expecting punctuation: \""</span></span> + ch + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_kw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">kw</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(kw)) input.next(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> input.croak(<span class="hljs-string"><span class="hljs-string">"Expecting keyword: \""</span></span> + kw + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skip_op</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">op</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_op(op)) input.next(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> input.croak(<span class="hljs-string"><span class="hljs-string">"Expecting operator: \""</span></span> + op + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unexpected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ input.croak(<span class="hljs-string"><span class="hljs-string">"Unexpected token: "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(input.peek())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maybe_binary</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">left, my_prec</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = is_op(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tok) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> his_prec = PRECEDENCE[tok.value]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (his_prec &gt; my_prec) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_binary({ <span class="hljs-attr"><span class="hljs-attr">type</span></span> : tok.value == <span class="hljs-string"><span class="hljs-string">"="</span></span> ? <span class="hljs-string"><span class="hljs-string">"assign"</span></span> : <span class="hljs-string"><span class="hljs-string">"binary"</span></span>, <span class="hljs-attr"><span class="hljs-attr">operator</span></span> : tok.value, <span class="hljs-attr"><span class="hljs-attr">left</span></span> : left, <span class="hljs-attr"><span class="hljs-attr">right</span></span> : maybe_binary(parse_atom(), his_prec) }, my_prec); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> left; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delimited</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">start, stop, separator, parser</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = [], first = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; skip_punc(start); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(stop)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first) first = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> skip_punc(separator); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(stop)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; a.push(parser()); } skip_punc(stop); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"call"</span></span>, <span class="hljs-attr"><span class="hljs-attr">func</span></span>: func, <span class="hljs-attr"><span class="hljs-attr">args</span></span>: delimited(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">","</span></span>, parse_expression), }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_varname</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name = input.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name.type != <span class="hljs-string"><span class="hljs-string">"var"</span></span>) input.croak(<span class="hljs-string"><span class="hljs-string">"Expecting variable name"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name.value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_if</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ skip_kw(<span class="hljs-string"><span class="hljs-string">"if"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cond = parse_expression(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_punc(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)) skip_kw(<span class="hljs-string"><span class="hljs-string">"then"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> then = parse_expression(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ret = { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"if"</span></span>, <span class="hljs-attr"><span class="hljs-attr">cond</span></span>: cond, <span class="hljs-attr"><span class="hljs-attr">then</span></span>: then, }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"else"</span></span>)) { input.next(); ret.else = parse_expression(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_lambda</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"lambda"</span></span>, <span class="hljs-attr"><span class="hljs-attr">vars</span></span>: delimited(<span class="hljs-string"><span class="hljs-string">"("</span></span>, <span class="hljs-string"><span class="hljs-string">")"</span></span>, <span class="hljs-string"><span class="hljs-string">","</span></span>, parse_varname), <span class="hljs-attr"><span class="hljs-attr">body</span></span>: parse_expression() }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_bool</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span> : <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span> : input.next().value == <span class="hljs-string"><span class="hljs-string">"true"</span></span> }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">maybe_call</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">expr</span></span></span><span class="hljs-function">) </span></span>{ expr = expr(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_punc(<span class="hljs-string"><span class="hljs-string">"("</span></span>) ? parse_call(expr) : expr; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_atom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(<span class="hljs-string"><span class="hljs-string">"("</span></span>)) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exp = parse_expression(); skip_punc(<span class="hljs-string"><span class="hljs-string">")"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exp; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_punc(<span class="hljs-string"><span class="hljs-string">"{"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_prog(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"if"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_if(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"true"</span></span>) || is_kw(<span class="hljs-string"><span class="hljs-string">"false"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_bool(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_kw(<span class="hljs-string"><span class="hljs-string">"lambda"</span></span>) || is_kw(<span class="hljs-string"><span class="hljs-string">"λ"</span></span>)) { input.next(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parse_lambda(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tok = input.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tok.type == <span class="hljs-string"><span class="hljs-string">"var"</span></span> || tok.type == <span class="hljs-string"><span class="hljs-string">"num"</span></span> || tok.type == <span class="hljs-string"><span class="hljs-string">"str"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tok; unexpected(); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_toplevel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prog = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!input.eof()) { prog.push(parse_expression()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!input.eof()) skip_punc(<span class="hljs-string"><span class="hljs-string">";"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">prog</span></span>: prog }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_prog</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prog = delimited(<span class="hljs-string"><span class="hljs-string">"{"</span></span>, <span class="hljs-string"><span class="hljs-string">"}"</span></span>, <span class="hljs-string"><span class="hljs-string">";"</span></span>, parse_expression); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prog.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FALSE; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prog.length == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prog[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"prog"</span></span>, <span class="hljs-attr"><span class="hljs-attr">prog</span></span>: prog }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_expression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> maybe_binary(parse_atom(), <span class="hljs-number"><span class="hljs-number">0</span></span>); }); } }</code> </pre> </div></div><br><h2 id="blagodarnosti">  </h2><br><p>   Marijn Haverbeke,   parse-js (Common Lisp),    ,   . ,        ,  JS,      . </p><br><p>  : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">     JavaScript.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第2部分：翻译</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN443630/">https://habr.com/ru/post/zh-CN443630/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN443618/index.html">浏览器中的80年代计算机模拟器</a></li>
<li><a href="../zh-CN443620/index.html">我们的依赖问题</a></li>
<li><a href="../zh-CN443624/index.html">Digital Works和VMware：VDI已死，VDI永无止境</a></li>
<li><a href="../zh-CN443626/index.html">欢迎来到2019顶级3D博览会</a></li>
<li><a href="../zh-CN443628/index.html">SymPy符号数学程序中的贝塞尔函数</a></li>
<li><a href="../zh-CN443636/index.html">莫尔斯·凯斯和克洛普费尔</a></li>
<li><a href="../zh-CN443638/index.html">Protonmail如何受到俄罗斯FSB的审查</a></li>
<li><a href="../zh-CN443640/index.html">水磨石</a></li>
<li><a href="../zh-CN443642/index.html">美国宇航局局长认为有可能使用商业火箭在月球的第一次航行中发送猎户座</a></li>
<li><a href="../zh-CN443644/index.html">用Unity卷鸡蛋</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>