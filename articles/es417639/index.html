<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§üüèΩ üêÖ üë©üèæ‚Äçü§ù‚Äçüë®üèΩ El reverso del neuromancer. Parte 4: Sonido, Animaci√≥n, Huffman, Github üë®üèº üí∑ üßì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola, como ya entendiste, esta es una continuaci√≥n de mi historia de ingenier√≠a inversa y portabilidad de Neuromant. 

 El reverso del neuromancer. Pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>El reverso del neuromancer. Parte 4: Sonido, Animaci√≥n, Huffman, Github</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417639/"><p>  Hola, como ya entendiste, esta es una continuaci√≥n de mi historia de ingenier√≠a inversa y portabilidad de Neuromant. </p><br><img src="https://habrastorage.org/webt/-g/ru/d_/-grud_xhetuzh4znt4rbkeakxyi.png"><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El reverso del neuromancer.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 1: Sprites</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El reverso del neuromancer.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2: Renderizar fuente</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El reverso del neuromancer.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 3: renderizado terminado, haz el juego</a> </blockquote><p>  Hoy, comencemos con dos buenas noticias: </p><br><ul><li>  en primer lugar, ya no estoy solo: el usuario de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">viiri</a> ya se ha unido al proyecto y ya ha hecho una contribuci√≥n significativa; </li><li>  En segundo lugar, ahora tenemos un repositorio abierto en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em>Github</em></a> . </li></ul><br><p>  En general, las cosas van muy bien, y quiz√°s pronto obtengamos al menos alguna construcci√≥n jugable.  Y debajo del corte, como de costumbre, hablemos sobre qu√© y <em>c√≥mo se</em> ha logrado en este momento. </p><a name="habracut"></a><br><hr><br><p>  Comenz√≥ a lidiar con el sonido.  Por desgracia, entre los recursos del juego no hab√≠a nada similar al audio, y como no ten√≠a idea de c√≥mo funciona la m√∫sica en <em>MS-DOS</em> , no estaba muy claro por d√≥nde empezar.  Despu√©s de leer un poco sobre todo tipo de <em>SoundBlaster</em> , lo mejor que se me ocurri√≥ es desplazar el c√≥digo desmontado con la esperanza de ver algunas firmas familiares.  Y quien busca, generalmente encuentra, incluso si no es exactamente lo que estaba buscando (comentarios de <em>Ida</em> ): </p><br><pre><code class="hljs vhdl">sub_20416: ... mov ax, [si+<span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ; <span class="hljs-number"><span class="hljs-number">8253</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov bx, [si+<span class="hljs-number"><span class="hljs-number">0</span></span>Ah] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> bl, <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ; PC/XT PPI <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> B bits: ; <span class="hljs-number"><span class="hljs-number">0</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> gate ‚ïê‚ï¶‚ïê‚ñ∫ <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>H=spkr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> data ‚ïê‚ïù <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>fcH=spkr OFF ; <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>=read high switches ; <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable RAM parity checking ; <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable I/O channel check ; <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=hold keyboard clock low ; <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable kbrd <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">0</span></span>FCh <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, bl <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ; PC/XT PPI <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> B bits: ; <span class="hljs-number"><span class="hljs-number">0</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> gate ‚ïê‚ï¶‚ïê‚ñ∫ <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>H=spkr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> data ‚ïê‚ïù <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>fcH=spkr OFF ; <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>=read high switches ; <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable RAM parity checking ; <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable I/O channel check ; <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=hold keyboard clock low ; <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable kbrd</code> </pre> <br><p>  Despu√©s de pasar por este <em>temporizador 8253-5,</em> me encontr√© con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un art√≠culo</a> que se convirti√≥ en la primera clave para comprender lo que estaba sucediendo.  A continuaci√≥n intentar√© explicar qu√© es qu√©. </p><br><p>  Entonces, en la era de <em>IBM-PC</em> , antes del advenimiento de las tarjetas de sonido asequibles, el dispositivo de reproducci√≥n de sonido m√°s com√∫n era el llamado <em>PC Speaker</em> , tambi√©n conocido como "beeper".  Este dispositivo no es m√°s que un altavoz normal conectado a la placa base, en la mayor√≠a de los casos, a trav√©s de un conector de cuatro pines.  La se√±al ac√∫stica, de acuerdo con la idea, hizo posible reproducir un pulso rectangular de dos niveles (correspondiente a dos niveles de voltaje, generalmente 0 V y + 5 V) y se control√≥ a trav√©s del puerto 61 del controlador <em>PPI (interfaz perif√©rica programable)</em> .  Espec√≠ficamente, los primeros dos bits del valor enviado al puerto son responsables de controlar el "altavoz" (ver comentarios en las l√≠neas <code>in al, 61h</code> y <code>out 61h, al</code> ). </p><br><p>  Como dije (en palabras un poco diferentes), nuestro orador puede estar en dos estados: <em>"dentro"</em> y <em>"fuera"</em> ( <em>"bajo" - "alto"</em> , <em>"apagado" - "encendido"</em> , <em>"apagado" - "encendido"</em> , lo que sea)  Para crear <em>un</em> impulso, es necesario cambiar el estado actual al opuesto y, despu√©s de un tiempo, volver.  Esto se puede hacer directamente manipulando el primer bit (recuento desde cero) del puerto 61, por ejemplo, as√≠: </p><br><pre> <code class="hljs vhdl">PULSE: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b ;    ... <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000010</span></span>b ;     ... ; ,        <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;    <span class="hljs-number"><span class="hljs-number">61</span></span>-  mov cx, <span class="hljs-number"><span class="hljs-number">100</span></span> ;   DELAY: <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> DELAY ;    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b ;     <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;    <span class="hljs-number"><span class="hljs-number">61</span></span>- </code> </pre> <br><p>  El resultado de ejecutar este c√≥digo se ver√° as√≠: </p><br><pre> <code class="hljs delphi"> loop DELAY +<span class="hljs-number"><span class="hljs-number">5</span></span>V +----------------------+ ! ! <span class="hljs-number"><span class="hljs-number">0</span></span>V ---+ +-------------------------- <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000010</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al</code> </pre> <br><p>  Repitiendo <em>PULSE</em> con un retraso, obtenemos una se√±al rectangular: </p><br><pre> <code class="hljs erlang-repl"> mov dx, <span class="hljs-number"><span class="hljs-number">100</span></span> ;  <span class="hljs-number"><span class="hljs-number">100</span></span>  PULSE: ... mov cx, <span class="hljs-number"><span class="hljs-number">100</span></span> WAIT: loop WAIT dec dx jnz PULSE PULSE +<span class="hljs-number"><span class="hljs-number">5</span></span>V +---------+ +---------+ +---------+ ! ! ! ! ! ! <span class="hljs-number"><span class="hljs-number">0</span></span>V ---+ +---------+ +---------+ +--- loop WAIT</code> </pre><br><p>  Si en el primer caso apenas hubi√©ramos escuchado algo, entonces en el segundo obtendremos un tono de frecuencia, dependiendo de la velocidad de la m√°quina en la que se ejecuta este c√≥digo.  Esto es genial, pero asociado con ciertas dificultades.  En cualquier caso, hay una forma m√°s conveniente de controlar el altavoz. </p><br><p>  Aqu√≠ viene el temporizador programable de tres canales del juego: <em>Intel 8253</em> , cuyo segundo canal (a partir de cero) est√° conectado al zumbador.  Este temporizador recibe una se√±al del reloj <em>Intel 8254</em> , que env√≠a 1193180 pulsos por segundo (~ 1.193 MHz), y puede programarse para una reacci√≥n espec√≠fica despu√©s de un n√∫mero espec√≠fico de pulsos.  Una de estas reacciones es enviar un pulso cuadrado al hablante.  En otras palabras, <em>8253</em> puede funcionar en forma de un generador de una se√±al rectangular de frecuencia ajustable, esto hace que sea relativamente f√°cil sintetizar varios efectos de sonido en el altavoz.  Y esto es lo que necesitas para esto: </p><br><ol><li>  Establezca el segundo canal del temporizador en el modo de generaci√≥n de se√±al rectangular.  Para hacer esto, escriba un valor especial de un solo byte en el puerto 43 ( <em>registro de modo / comando 8253</em> ).  En mi caso, esto es <code>10110110B</code> (m√°s detalles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ): </li></ol><br><pre> <code class="markdown hljs">Bits Usage 6 and 7 Select channel : 1 0 = Channel 2 4 and 5 Access mode : 1 1 = Access mode: lobyte/hibyte 1 to 3 Operating mode : 0 1 1 = Mode 3 (square wave generator) 0 BCD/Binary mode: 0 = 16-bit binary</code> </pre> <br><ol><li><p>  Establezca la frecuencia deseada en el segundo canal.  Para hacer esto, byte por bit, desde el m√°s joven hasta el m√°s viejo, enviamos al puerto 42 (puerto <em>de datos 8253 Canal 2</em> ) un valor igual a <code>1193180 / freq</code> , donde <code>freq</code> es el valor de frecuencia requerido en hercios. </p><br></li><li><p>  Permita que el altavoz reciba pulsos del temporizador.  Para hacer esto, establezca los dos primeros bits del valor en el puerto 61 ( <em>PPI</em> ) en la unidad.  El hecho es que si el bit cero se establece en 1, entonces el primero se interpreta como un "interruptor": </p><br></li></ol><br><pre> <code class="markdown hljs">Bit 0 Effect ----------------------------------------------------------------- 0 The state of the speaker will follow bit 1 of port 61h 1 The speaker will be connected to PIT channel 2, bit 1 is used as switch ie 0 = not connected, 1 = connected.</code> </pre> <br><p>  Como resultado, tenemos la siguiente imagen: </p><br><pre> <code class="hljs vhdl"> mov al, <span class="hljs-number"><span class="hljs-number">10110110</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span>h, al ;   mov ax, <span class="hljs-number"><span class="hljs-number">02E9</span></span>Bh ; <span class="hljs-number"><span class="hljs-number">1193180</span></span> / <span class="hljs-number"><span class="hljs-number">100</span></span> = ~<span class="hljs-number"><span class="hljs-number">0</span></span>x2E9B <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ;      mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ;      <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000011</span></span>b ;      <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;   ... ;       ~<span class="hljs-number"><span class="hljs-number">100</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;  </code> </pre> <br><p>  Y esto es exactamente lo que hace el c√≥digo que cit√© al principio (excepto para la inicializaci√≥n, pero lo encontr√© en otra funci√≥n): en <code>si + 8</code> hay un divisor de frecuencia enviado al puerto 42, y en <code>si + 0Ah</code> - estado del altavoz ( <em>"encendido" - "apagado"</em> ) grabado en el puerto 61. </p><br><p>  El mecanismo de reproducci√≥n es simple y directo, pero luego tuvo que lidiar con los tiempos.  Despu√©s de examinar el c√≥digo cercano, vi que en la misma funci√≥n en la que se inicializa el temporizador ( <code>sub_2037A</code> , en adelante - <code>init_8253</code> ), el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">octavo</a> controlador de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">interrupci√≥n</a> se reemplaza con la funci√≥n <code>sub_20416</code> (en adelante - <code>play_sample</code> ).  Pronto qued√≥ claro que esta interrupci√≥n se genera aproximadamente 18,2 veces por segundo y sirve para actualizar la hora del sistema.  Reemplazar el controlador de esta interrupci√≥n es una pr√°ctica com√∫n si necesita realizar alguna acci√≥n 18 veces por segundo (de hecho, el controlador original tambi√©n debe llamarse dentro del gancho, de lo contrario, la hora del sistema se detendr√°).  En base a esto, resulta que la siguiente frecuencia se carga al generador cada <code>(1 / 18.2) * 1000 ~ 55</code> . </p><br><p>  El plan era este: </p><br><ul><li>  ponga un punto de interrupci√≥n en la funci√≥n <code>play_sample</code> , en la l√≠nea donde se extrae el siguiente divisor de frecuencia; </li><li>  calcule la frecuencia de acuerdo con la f√≥rmula <code>freq = 1193180 / divisor</code> ; </li><li>  generar 55 ms de se√±al de frecuencia de frecuencia cuadrada en alg√∫n tipo de editor de audio (utilic√© <em>Adobe Audition</em> ); </li><li>  repita los primeros tres pasos hasta que se acumulen al menos 3 segundos. </li></ul><br><p>  As√≠ que obtuve el comienzo de la melod√≠a desde el men√∫ principal, pero tocando un tiempo 10 m√°s lento de lo necesario.  Luego reduje la duraci√≥n de la "muestra" de 55 ms a 5 ms; mejor√≥ mucho, pero a√∫n as√≠ no.  El problema de tiempo permaneci√≥ abierto hasta que encontr√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este art√≠culo</a> .  Result√≥ que la octava interrupci√≥n se genera al alimentar el mismo <em>8253</em> , cuyo canal cero est√° conectado al controlador de interrupci√≥n ( <em>PIC</em> ).  Cuando la m√°quina arranca, el <em>BIOS</em> establece el canal cero para generar pulsos con una frecuencia de ~ 18.2 Hz (es decir, se genera una interrupci√≥n cada ~ 54.9 ms).  Sin embargo, el canal cero se puede reprogramar para que genere pulsos con una frecuencia m√°s alta, para esto, por analog√≠a con el segundo canal, debe escribir un valor igual a <code>1193180 / freq</code> en el puerto 40, donde <code>freq</code> es el valor de frecuencia requerido en hercios.  Esto sucede en la funci√≥n <code>init_8253</code> , solo que inicialmente no le <code>init_8253</code> la debida atenci√≥n: </p><br><pre> <code class="hljs objectivec">init_8253: ... mov al, <span class="hljs-number"><span class="hljs-number">0</span></span>B6h ; <span class="hljs-number"><span class="hljs-number">10110110</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov ax, <span class="hljs-number"><span class="hljs-number">13</span></span>B1h <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>).</code> </pre> <br><p>  El valor <code>13B1h</code> traduce a la frecuencia: <code>1193180 / 13B1h ~ 236.7</code> , luego obtenemos aproximadamente <code>(1 / 236.7) * 1000 ~ 4.2</code> por "muestra".  El rompecabezas se ha desarrollado. </p><br><p>  Entonces es cuesti√≥n de tecnolog√≠a: implementar una funci√≥n que extraiga bandas sonoras del juego.  Pero aqu√≠ est√° la cosa, los valores de los divisores de frecuencia registrados en el puerto 42 no se almacenan expl√≠citamente.  Se calculan mediante un algoritmo complicado, cuyos datos de entrada y el √°rea de trabajo se encuentran directamente en el archivo ejecutable del juego (en el s√©ptimo segmento, seg√∫n <em>Ida</em> ).  Adem√°s, de las caracter√≠sticas, no hay signos del final de la pista, cuando no hay nada m√°s que reproducir, el algoritmo produce infinitamente un estado cero del altavoz.  Pero no me molest√© y, como en el caso del algoritmo de descompresi√≥n (la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primera parte</a> ), simplemente transfir√≠ al ensamblador de 64 bits la funci√≥n de configurar la pista para la reproducci√≥n y el algoritmo para obtener la siguiente frecuencia (y tom√© el s√©ptimo segmento por completo). </p><br><p>  Y funcion√≥.  Despu√©s de eso, implement√© las funciones de generaci√≥n de banda sonora para la pista seleccionada ( <em>PCM, 44100 Hz, 8 bits, mono</em> ; hice algo as√≠ como un generador utilizado en el emulador de altavoz en <em>DosBox</em> ).  Resolv√≠ el problema con el signo del fin con un simple contador de silencio: cont√© un segundo, completamos el algoritmo.  Envolviendo la pista resultante en el encabezado <em>WAV</em> y guardando el resultado en un archivo, obtuve exactamente la pista del men√∫ principal.  Y 13 pistas m√°s que puedes escuchar a continuaci√≥n <em>[o en el visor de recursos, que ahora tiene un reproductor incorporado y la capacidad de guardar cualquier pista en .WAV]</em> : </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://w.soundcloud.com/player/" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <em>[Al estudiar el tema, aprend√≠ sobre t√©cnicas m√°s avanzadas de "beeper", como el uso de modulaci√≥n de ancho de pulso para la reproducci√≥n de sonido PCM de baja calidad.</em>  <em>Al final de este art√≠culo, proporcionar√© una lista de materiales de los que puede obtener m√°s informaci√≥n.</em> </p><br><hr><br><p>  En la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">segunda parte</a> , cuando se consideraron varios formatos de recursos, suger√≠ que los archivos <em>.ANH contienen</em> animaciones para fondos de ubicaci√≥n (es decir, para im√°genes almacenadas en <em>.PIC</em> ).  <em>[Esto es as√≠.]</em> Habiendo terminado con el sonido, decid√≠ comprobarlo.  Simplemente asumiendo que la animaci√≥n se aplica directamente a la imagen de fondo almacenada en la memoria (no en la <em>memoria de video</em> , sino en la <em>cadena de sprites</em> ), decid√≠ volcar esta memoria, respectivamente, antes y despu√©s de aplicar la animaci√≥n (mira donde el cursor apunta a la parte superior cadena de letras 'S'): </p><br><p><img src="https://habrastorage.org/webt/zp/9a/qn/zp9aqnvcvi-gn3pp0t1puzvhpti.gif" width="32%" height="32%"><img src="https://habrastorage.org/webt/jz/9l/ig/jz9ligummo9j_xwwatid-s0vcri.png" width="32%" height="32%"><img src="https://habrastorage.org/webt/sz/pd/uy/szpduyzc7lgsqum_np9sbvrq4qo.png" width="32%" height="32%"></p><br><pre> <code class="markdown hljs">3DE6:0E26 03 B4 44 B3 ... ;   3DE6:0E26 03 BC CC B3 ... ;  </code> </pre> <br><p>  Exactamente lo que esperaba: el color rojo oscuro (0x4) cambi√≥ a rojo brillante (0xC).  Ahora puede intentar establecer el punto de interrupci√≥n para cambiar el valor en la direcci√≥n, por ejemplo, <code>3DE6:0E28</code> y, si tiene suerte, realizar un seguimiento inverso.  <em>[Tuve suerte.]</em> El punto de ruptura me llev√≥ a una l√≠nea que cambia directamente el valor en la direcci√≥n dada: <code>xor es:[bx], al</code> .  Despu√©s de examinar los alrededores, constru√≠ f√°cilmente una cadena de llamadas desde el bucle de nivel principal hasta este punto: <code>sub_1231E (xor es:[bx], al) &lt;- sub_12222 &lt;- sub_105F6 &lt;- sub_1038F ( )</code> . </p><br><p>  No entrar√© en detalles sobre exactamente c√≥mo revirt√≠ el proceso de animaci√≥n.  Este es un trabajo bastante rutinario y met√≥dico, pero no es muy dif√≠cil si los l√≠mites est√°n claramente delineados (el seguimiento recibido es estos l√≠mites).  Pero no puedo evitar hablar de lo que sucedi√≥ al final. </p><br><p>  Primero sobre el formato <em>.ANH</em> .  De hecho, es un conjunto de contenedores, y la primera palabra en el archivo <em>.ANH</em> es la cantidad de contenedores que contiene: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> anh_entries; <span class="hljs-comment"><span class="hljs-comment">/* first entry hdr */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>;</code> </pre> <br><p>  El contenedor en s√≠ es una animaci√≥n tomada por separado del elemento de fondo.  Puede seleccionar un encabezado para el contenedor que contenga su tama√±o de byte y el n√∫mero de cuadros en la animaci√≥n que representa.  Junto al encabezado se encuentran los valores de la duraci√≥n (retraso) del siguiente cuadro y el desplazamiento de bytes del cuadro en s√≠, en relaci√≥n con los bytes del primer cuadro.  El n√∫mero de tales pares es obviamente igual al n√∫mero de cuadros: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_entry_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> entry_size; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> total_frames; <span class="hljs-comment"><span class="hljs-comment">/* anh_frame_data_t first_frame_data */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* another frames data */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* anh_frame_hdr first_frame_hdr */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* another frames */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_frame_data_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_sleep; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_offset; } <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span> *hdr = (<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>*)anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span> *entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)(anh + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; anh-&gt;anh_entries; u++) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)entry; <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *first_frame_data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)(p + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_bytes = p + (entry-&gt;total_frames * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; entry-&gt;total_frames; k++) { <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *frame_data = first_frame_data + k; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *frame_bytes = first_frame_bytes + frame_data-&gt;frame_offset; ... } <span class="hljs-comment"><span class="hljs-comment">/* plus 2 bytes of padding */</span></span> p += (entry-&gt;entry_size + <span class="hljs-number"><span class="hljs-number">2</span></span>); entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)p; }</code> </pre><br><p>  Un cuadro separado est√° compuesto por un encabezado de cuatro bytes que contiene sus dimensiones lineales y desplazamientos relativos a la imagen de fondo, y los p√≠xeles del cuadro codificados por el algoritmo que ya me resulta familiar con <em>Run Length</em> : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_frame_hdr</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bg_x_offt; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bg_y_offt; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_width; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_height; <span class="hljs-comment"><span class="hljs-comment">/* rle encoded frame bytes */</span></span> };</code> </pre> <br><p>  La "superposici√≥n" del marco en el fondo puede verse as√≠: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *level_bg; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_pix[<span class="hljs-number"><span class="hljs-number">8192</span></span>]; anh_frame_hdr *hdr = (anh_frame_hdr*)frame_bytes; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_len = hdr-&gt;frame_width * hdr-&gt;frame_height; decode_rle(frame + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(anh_frame_hdr), frame_len, frame_pix); <span class="hljs-comment"><span class="hljs-comment">/* 0xFB4E - some magic value, have no idea what is it */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> bg_offt = (hdr-&gt;bg_y_offt * <span class="hljs-number"><span class="hljs-number">152</span></span>) + hdr-&gt;bg_x_offt + <span class="hljs-number"><span class="hljs-number">0xFB4E</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> bg_skip = <span class="hljs-number"><span class="hljs-number">152</span></span> - hdr-&gt;frame_width; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p1 = frame_pix, *p2 = level_bg; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> i = hdr-&gt;frame_height; i != <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> j = hdr-&gt;frame_width; j != <span class="hljs-number"><span class="hljs-number">0</span></span>; j--) { *p2++ ^= *p1++; } p2 += bg_skip; }</code> </pre> <br><p>  Este es el <em>formato .ANH</em> , pero hay otra estructura que hace que todo funcione: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bg_animation_control_table_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> total_frames; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_data; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_bytes; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sleep; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> curr_frame; } <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span>;</code> </pre> <br><p>  En el juego en s√≠, una serie de al menos cuatro estructuras de este tipo se declara globalmente.  Despu√©s de cargar el siguiente archivo <em>.ANH</em> , el n√∫mero de animaciones dentro tambi√©n se almacena en una variable global, y los elementos de la matriz se inicializan de la siguiente manera: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *anh; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> g_anim_amount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span> g_anim_ctl[<span class="hljs-number"><span class="hljs-number">4</span></span>]; ... <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span> *hdr = (<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>*)anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span> *entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)(anh + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>)); g_anim_amount = hdr-&gt;anh_entries; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; g_anim_amount; u++) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)entry; g_anim_ctl[u].total_frames = entry-&gt;total_frames; g_anim_ctl[u].first_frame_data = p + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>); g_anim_ctl[u].first_frame_bytes = g_anim_ctl[u].first_frame_data + (entry-&gt;total_frames * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>)); g_anim_ctl[u].sleep = *(<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>*)(g_animation_control[u].first_frame_data); g_anim_ctl[u].curr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* plus 2 bytes of padding */</span></span> p += (entry-&gt;entry_size + <span class="hljs-number"><span class="hljs-number">2</span></span>); entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)p; }</code> </pre><br><p>  Finalmente, aplique las animaciones: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; g_anim_amount; u++) { <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span> *anim = &amp;g_anim_ctl[u]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anim-&gt;sleep-- == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)anim-&gt;first_frame_data + anim-&gt;curr_frame; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (++anim-&gt;curr_frame == anim-&gt;total_frames) { anim-&gt;curr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>; data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)anim-&gt;first_frame_data; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { data++; } anim-&gt;sleep = data-&gt;frame_sleep; } }</code> </pre> <br><p>  Y obtenemos lo siguiente <em>[puede ver mucho m√°s en el visor de recursos]</em> : </p><br><div class="spoiler">  <b class="spoiler_title">R2.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/p7/lv/fn/p7lvfn5ytpjm5nsoctsumdncuaa.gif"></div></div><br><div class="spoiler">  <b class="spoiler_title">R6.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/j6/nb/xp/j6nbxpj29jlrikbmjl8f62s4xmc.gif"></div></div><br><p>  Hay un par de problemas con la animaci√≥n en este momento.  La primera es que en mi c√≥digo reproduzco todas las animaciones disponibles, pero el original comprueba algunas banderas globales que indican si desplazarse a trav√©s de la siguiente.  Y el segundo, debido al hecho de que algunas animaciones agregan objetos a la pantalla que originalmente no estaban all√≠.  Y dado que los cuadros "pelean" en el fondo, luego con un desplazamiento c√≠clico, en cada segundo c√≠rculo, el objeto simplemente desaparece.  Aqu√≠, por ejemplo, c√≥mo se ver√≠a: </p><br><div class="spoiler">  <b class="spoiler_title">R53.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/d3/5l/iu/d35liujvu6ash9gcdrecvoq9kuc.gif"></div></div><br><p>  Pero por ahora, dej√©moslo como est√°. </p><br><hr><br><p>  ¬øRecuerdas el algoritmo de descompresi√≥n desconocido de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primera parte</a> ?  Habiendo apenas conectado con el desarrollo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">viiri</a> no solo determin√≥ qu√© tipo de algoritmo era, sino que tambi√©n escribi√≥ su propia versi√≥n del decodificador, que reemplaz√≥ la terrible pieza de ensamblador de tres l√≠neas en la base del c√≥digo.  En este sentido, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">ped√≠</a> a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">viiri</a> que escribiera un breve ensayo sobre el trabajo realizado.  Lo que se hizo, pero antes de darlo, hay que decir algunas palabras sobre la teor√≠a. </p><br><p>  Para comprimir recursos, los desarrolladores <em>de Neuromancer</em> utilizaron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em>el c√≥digo Huffman</em></a> .  Este es uno de los primeros m√©todos efectivos para codificar informaci√≥n utilizando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em>c√≥digos de prefijo</em></a> .  En la teor√≠a de la codificaci√≥n, los c√≥digos con una palabra de longitud variable y aquellos en los que ninguna palabra de c√≥digo es un prefijo de otra se denominan c√≥digos de <em>prefijo</em> .  Es decir, si la palabra <em>"a"</em> est√° incluida en el c√≥digo del prefijo, entonces la palabra <em>"ab"</em> no existe en el c√≥digo.  Esta propiedad le permite dividir en palabras el mensaje codificado por dicho c√≥digo. </p><br><p>  La idea del algoritmo Huffman es que, conociendo la probabilidad de aparici√≥n de caracteres de un determinado alfabeto en el mensaje, podemos describir el procedimiento para construir c√≥digos de longitud variable, que consisten en un n√∫mero entero de bits.  A los s√≠mbolos con una probabilidad m√°s alta de ocurrencia se les asignan c√≥digos m√°s cortos, y los s√≠mbolos con una probabilidad m√°s baja, por el contrario, los m√°s largos.  En general, el procedimiento de codificaci√≥n se reduce a construir el √°rbol de c√≥digo √≥ptimo y, sobre la base, mapear el s√≠mbolo del mensaje con el c√≥digo correspondiente.  La propiedad de prefijo del c√≥digo recibido le permite decodificar de forma exclusiva el mensaje comprimido. </p><br><div class="spoiler">  <b class="spoiler_title">Huffman.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fa/is/hb/faishbcvf0flxiao-mfmnx3llvu.gif"></div></div><br><p>  El algoritmo tiene un inconveniente significativo (de hecho, no uno, pero ahora solo este es importante).  El hecho es que para recuperar el contenido de un mensaje comprimido, el decodificador debe conocer la tabla de frecuencias de aparici√≥n de caracteres utilizados por el codificador.  A este respecto, junto con el mensaje codificado, se debe transmitir una tabla de probabilidad o el √°rbol de c√≥digos (una opci√≥n utilizada en el juego).  El tama√±o de los datos adicionales puede ser relativamente grande, y esto afecta significativamente la eficiencia de la compresi√≥n. </p><br><p>  Algo sobre c√≥mo puede lidiar con esto, as√≠ como sobre su decodificador y el que se implementa en el juego, le dice a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">viiri</a> : </p><br><blockquote>  Vale la pena mencionar que todo el juego fue escrito completamente en Assembler, a mano, por lo que el c√≥digo contiene soluciones interesantes, trucos y optimizaciones. <br><br>  De acuerdo a los procedimientos.  La funci√≥n <code>sub_1ff94</code> ( <code>build_code_table</code> ) es necesaria para cargar un √°rbol Huffman comprimido desde un archivo.  Para decodificar un Huffman est√°tico (a veces <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">din√°mico</a> , y este requisito no se aplica a √©l), junto con el mensaje, se debe transmitir un √°rbol de c√≥digos, que es un mapeo de c√≥digos Huffman a c√≥digos de caracteres reales.  Este √°rbol es lo suficientemente grande y, por lo tanto, ser√≠a bueno almacenarlo de alguna manera eficiente.  La forma m√°s correcta es usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c√≥digos can√≥nicos</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MOAR</a> ).  Debido a sus propiedades, existe una forma muy interesante y efectiva de almacenar el √°rbol (utilizado en la implementaci√≥n del m√©todo de compresi√≥n <em>Deflate</em> del archivador <em>PKZip</em> ).  Pero en el juego, no se utilizan c√≥digos can√≥nicos, en su lugar se realiza un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recorrido directo del √°rbol</a> y para cada v√©rtice se escribe el bit 0 en la secuencia de salida si el nodo no es una hoja, o el bit 1 si el nodo es una hoja, y luego los siguientes 8 bits son el c√≥digo de caracteres en este nodo.  Al decodificar, se realiza un recorrido de √°rbol similar, que vemos en el juego.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hay</a> un ejemplo y alguna explicaci√≥n. </blockquote><br><div class="spoiler">  <b class="spoiler_title">build_code_table</b> <div class="spoiler_text"><pre> <code class="hljs sql">build_code_table proc near <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> getbit ;     jb short loc_1FFA9 ;   ... shl dx, 1 inc bx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> build_code_table ;  build_code_table    or dl, 1 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> build_code_table ;  build_code_table    shr dx, 1 dec bx ret loc_1FFA9: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> sub_1FFC2 ;      (8 ) ... ;     ret sub_1FF94 endp sub_1FFC2 proc near sub di, di mov ch, 8 loc_1FFC6: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> getbit rcl di, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dec</span></span> ch jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_1FFC6 retn sub_1FFC2 endp</code> </pre> </div></div><br><blockquote>  <code>getbit</code> ( <code>sub_1ffd0</code> ) lee un poco de la secuencia de entrada.  Su an√°lisis nos permite concluir que los bits individuales se extraen del registro <code>ax</code> 16 bits, cuyo valor se carga desde la memoria mediante la instrucci√≥n <code>lodsw</code> , que carga dos bytes de la secuencia, pero dado que el <em>procesador Intel</em> tiene un orden de bytes <em>little endian</em> , <code>xchg</code> reorganiza la mitad del registro.  Adem√°s, el orden de los bits en la secuencia es algo il√≥gico: el primero no es el menor, sino el m√°s significativo.   ,   <code>shl</code>      ,        <code>jb</code> . </blockquote><br><div class="spoiler"> <b class="spoiler_title">getbit</b> <div class="spoiler_text"><pre> <code class="hljs delphi">getbit proc <span class="hljs-keyword"><span class="hljs-keyword">near</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> cl, cl jz short loc_1FFD9 dec cl <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn loc_1FFD9: cmp si, <span class="hljs-number"><span class="hljs-number">27</span></span>B6h jz short loc_1FFE7 ;   lodsw xchg al, ah mov cl, <span class="hljs-number"><span class="hljs-number">0</span></span>Fh <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn loc_1FFE7: call sub_202FC ;      lodsw xchg al, ah mov cl, <span class="hljs-number"><span class="hljs-number">0</span></span>Fh <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn getbit endp</code> </pre> </div></div><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">viiri</a>  ,    : </p><br><div class="spoiler"> <b class="spoiler_title">huffman_decompress</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> value; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node_t</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">left</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">right</span></span></span><span class="hljs-class">;</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *g_src = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getbits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numbits)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getl_le</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*       4-    */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> node_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_tree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span> *node = (<span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>*)<span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getbits(<span class="hljs-number"><span class="hljs-number">1</span></span>)) { node-&gt;right = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; node-&gt;left = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; node-&gt;value = getbits(<span class="hljs-number"><span class="hljs-number">8</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { node-&gt;right = build_tree(); node-&gt;left = build_tree(); node-&gt;value = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">huffman_decompress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length, i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span> *root, *node; g_src = src; length = getl_le(); node = root = build_tree(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (i &lt; length) { node = getbits(<span class="hljs-number"><span class="hljs-number">1</span></span>) ? node-&gt;left : node-&gt;right; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!node-&gt;left) { dst[i++] = node-&gt;value; node = root; } } ... }</code> </pre></div></div><br><p>       : </p><br><blockquote>    <code>build_code_table</code>    .     ,         ,                .     ,                 .     ,           ,    ,       ‚Äî   (    <code>huffman_decompress</code> ). <br><br>     ? !       !  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> ,   .       ( <em> </em> ):          . ,         3- ,         <em>N</em>  ,  <em>(3 ‚Äî N)</em>     . </blockquote><p>       <code>ABCD</code> : <code>A - 0b, B - 10b, C - 110b, D - 111b</code> .       (  ),      ,     : </p><br><table><thead><tr><th>  C√≥digo </th><th>  </th><th>  </th></tr></thead><tbody><tr><td> <strong>0</strong> 00b </td><td>  1 </td><td>  Un </td></tr><tr><td> <strong>10</strong> 0b </td><td>  2 </td><td> B </td></tr><tr><td> <strong>110</strong> b </td><td>  3 </td><td>  C </td></tr><tr><td> <strong>111</strong> b </td><td>  3 </td><td>  D </td></tr></tbody></table><br><p>       ,               .  , , ,      <code>010b</code> ‚Äî     .       .  ,   'A'   <code>0b</code> ,     <em> </em>  ,    .     : </p><br><table><thead><tr><th>  </th><th>  C√≥digo </th><th>  </th><th>  </th></tr></thead><tbody><tr><td>  0 0 </td><td> <strong>0</strong> 00b </td><td>  1 </td><td>  Un </td></tr><tr><td>  1 </td><td> <strong>0</strong> 01b </td><td>  1 </td><td>  Un </td></tr><tr><td>  2 </td><td> <strong>0</strong> 10b </td><td>  1 </td><td>  Un </td></tr><tr><td>  3 </td><td> <strong>0</strong> 11b </td><td>  1 </td><td>  Un </td></tr><tr><td>  4 4 </td><td> <strong>10</strong> 0b </td><td>  2 </td><td> B </td></tr><tr><td>  5 5 </td><td> <strong>10</strong> 1b </td><td>  2 </td><td> B </td></tr><tr><td>  6 6 </td><td> <strong>110</strong> b </td><td>  3 </td><td>  C </td></tr><tr><td>  7 7 </td><td> <strong>111</strong> b </td><td>  3 </td><td>  D </td></tr></tbody></table><br><p> ,    <code>011010111b</code> : </p><br><ul><li>     : <code>011b</code> ; </li><li>  ,   <code>011b (3)</code> ,   <code>A</code> ,     ; </li><li>   <code>011b</code>    1, ,                 : <code>110b</code> ; </li><li>  ,   <code>110b (6)</code> ,   <code></code> ,     ; </li><li>   ,     . </li></ul><br><p>  ¬´¬ª     8- .      256 .          8 .   ,    ,  : </p><br><blockquote>           :      ‚Äî  ,          .   ,    .   4 ‚Äî   32- . </blockquote><p>     ,   .  . </p><br><hr><br><p>       ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><em>github</em></a> .     ,       ,     ,   -   <em>[ ,    README.md]</em> . </p><br><p>  ,    ,     2015- : </p><br><ul><li> <em>LibNeuroRoutines (, MASM)</em> ‚Äî ,       ,    .    ( <code>neuro_routines.h</code> )           ,   .     , : <br><ul><li>   ( <code>huffman_decompression.c</code> , <code>decompression.c</code> ); </li><li>    ( <code>cp437.c</code> ); </li><li>     ( <code>dialog.c</code> ); </li><li>    ( <code>audio.c</code> ). </li></ul></li><li> <em>NeuromancerWin64 ()</em> ‚Äî     .                .     ,       <em>¬´¬ª</em> ,    ,       .       <em>CSFML</em> ( <em>SFML</em>   <em>C</em> ). </li><li> <em>ResourceBrowser (C++)</em> ‚Äî  .    <em>MFC</em> -,         <em>.DAT</em> -.    : <br><ul><li>     <em>BMP (8bpp)</em>  ( <em>IMH</em> , <em>PIC</em> ); </li><li>   ( <em>ANH</em> ); </li><li>     <em>WAV (PCM, 44100Hz, 8bps, mono)</em>  ( <em>SOUND</em> ). </li></ul></li></ul><br><p>    <em>LibNeuroRoutines</em>   .    <em>LibNeuroRoutines</em>  <em>CSFML</em> ( <em>ResourceBrowser</em>   <em>SFML</em>   ). </p><br><p>       64- <em>Windows</em>     .   ,   <em>LibNeuroRoutines</em>  64- <em>MASM (Microsoft Macro Assembler)</em> .   ‚Äî    ,      64- . ,      <em>NASM</em>  <em>FASM</em> ,    ,             .      <em>VS 2015</em> ‚Äî <em>MASM</em>   . </p><br><p>      ,   .         <em>C</em> .     ,           (  ,   <em>MFC</em> ). </p><br><p>   ,       .   - ,      . </p><br><hr><br><p>           .  ? ,  .            ,   .    - ,      . ,    ,     ,     .  (). </p><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Make sound from the speaker using assembly</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Programming the PC Speaker</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PC Speaker</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Programmable Interval Timer</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Making C Sing</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Beyond Beep-Boop: Mastering the PC Speaker</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es417639/">https://habr.com/ru/post/es417639/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es417621/index.html">¬øQu√© pas√≥ cuando desciframos la exhibici√≥n?</a></li>
<li><a href="../es417627/index.html">Hyper CRM o Mini ERP? Negocio en mal estado</a></li>
<li><a href="../es417629/index.html">Edici√≥n comunitaria de Delphi y C ++ Builder</a></li>
<li><a href="../es417631/index.html">Tutorial de video CSS Grid</a></li>
<li><a href="../es417637/index.html">Desarrollo de un editor para crear sitios web / aterrizajes (experiencia)</a></li>
<li><a href="../es417641/index.html">10 cursos de aprendizaje autom√°tico de verano</a></li>
<li><a href="../es417643/index.html">Caballeros de la capa y rootkits: qu√© ver sobre los hackers. Programas de televisi√≥n</a></li>
<li><a href="../es417645/index.html">Concurso de programaci√≥n: Trading (Resultados provisionales y anuncios)</a></li>
<li><a href="../es417647/index.html">Un proyecto de ley sobre la protecci√≥n de datos personales presentado en Bielorrusia: lo que est√° "dentro" de √©l</a></li>
<li><a href="../es417649/index.html">OpenAI supera importantes limitaciones de IA para Dota 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>