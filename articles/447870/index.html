<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Conceptos b谩sicos del motor de JavaScript: optimizaci贸n de prototipos. Parte 1   ご</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos Cada vez queda menos tiempo hasta el lanzamiento del curso "Seguridad de los sistemas de informaci贸n" , por lo que hoy continuamos compar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conceptos b谩sicos del motor de JavaScript: optimizaci贸n de prototipos. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/447870/">  Hola a todos  Cada vez queda menos tiempo hasta el lanzamiento del curso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Seguridad de los sistemas de informaci贸n"</a> , por lo que hoy continuamos compartiendo publicaciones dedicadas al lanzamiento de este curso.  Por cierto, esta publicaci贸n es una continuaci贸n de estos dos art铆culos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Fundamentos de los motores de JavaScript: formularios generales y almacenamiento en cach茅 en l铆nea.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 1 "</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">" Conceptos b谩sicos de los motores de JavaScript: formularios generales y almacenamiento en cach茅 en l铆nea.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2 "</a> . <br><br>  El art铆culo describe los conceptos b谩sicos clave.  Son comunes a todos los motores de JavaScript, y no solo al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">V8 en el</a> que est谩n trabajando los autores ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Benedict</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Matthias</a> ).  Como desarrollador de JavaScript, puedo decir que una comprensi贸n m谩s profunda de c贸mo funciona el motor de JavaScript lo ayudar谩 a descubrir c贸mo escribir c贸digo eficiente. <br><br><img src="https://habrastorage.org/webt/sn/lh/zx/snlhzxtpzzs0ynrlywt0hvbfafw.png"><a name="habracut"></a><br><br>  En un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art铆culo anterior,</a> discutimos c贸mo los motores JavaScript optimizan el acceso a objetos y matrices utilizando formularios y cach茅s en l铆nea.  En este art铆culo, veremos c贸mo optimizar los compromisos de la tuber铆a y acelerar el acceso a las propiedades del prototipo. <br><br><blockquote>  Nota: si prefiere ver presentaciones que leer art铆culos, mire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este video</a> .  De lo contrario, s谩ltelo y siga leyendo. </blockquote><br><br>  <b>Niveles de optimizaci贸n y compensaciones</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La 煤ltima vez,</a> descubrimos que todos los motores JavaScript modernos, de hecho, tienen la misma tuber铆a: <br><br><img src="https://habrastorage.org/webt/dv/ni/m_/dvnim_h74jp64e3w2hyxmm9h1tu.png"><br><br>  Tambi茅n nos dimos cuenta de que a pesar del hecho de que las tuber铆as de alto nivel de motor a motor son similares en estructura, hay una diferencia en la tuber铆a de optimizaci贸n.  驴Por qu茅 es esto as铆?  驴Por qu茅 algunos motores tienen m谩s niveles de optimizaci贸n que otros?  La cuesti贸n es hacer un compromiso entre una transici贸n r谩pida a la etapa de ejecuci贸n del c贸digo o pasar un poco m谩s de tiempo para ejecutar el c贸digo con un rendimiento 贸ptimo. <br><br><img src="https://habrastorage.org/webt/ry/m5/cv/rym5cvxm6b5pwiaibki4jrtjqdq.png"><br><br>  El int茅rprete puede generar r谩pidamente bytecode, pero bytecode por s铆 solo no es lo suficientemente eficiente en t茅rminos de velocidad.  Involucrar a un compilador de optimizaci贸n en este proceso pasa una cierta cantidad de tiempo, pero permite un c贸digo de m谩quina m谩s eficiente. <br>  Echemos un vistazo a c贸mo el V8 maneja esto.  Recuerde que en V8 el int茅rprete se llama Ignition y se considera el int茅rprete m谩s r谩pido entre los motores existentes (en materia de velocidad de ejecuci贸n de bytecode sin formato).  El compilador de optimizaci贸n en V8 se llama TurboFan, y es 茅l quien genera un c贸digo de m谩quina altamente optimizado. <br><br><img src="https://habrastorage.org/webt/tr/jx/d7/trjxd74glsh5mmj9swifxkqukfk.png"><br><br>  La compensaci贸n entre el retraso de inicio y la velocidad de ejecuci贸n es la raz贸n por la cual algunos motores de JavaScript prefieren agregar niveles de optimizaci贸n adicionales entre los pasos.  Por ejemplo, SpiderMonkey agrega un nivel de l铆nea de base entre su int茅rprete y el compilador de optimizaci贸n completo de IonMonkey: <br><br><img src="https://habrastorage.org/webt/ey/ry/1w/eyry1w6rnodjaethbgmjhcfkjj4.png"><br><br>  El int茅rprete genera r谩pidamente bytecode, pero el bytecode en s铆 es relativamente lento.  La l铆nea de base genera c贸digo un poco m谩s, pero proporciona un rendimiento mejorado en tiempo de ejecuci贸n.  Finalmente, el compilador de optimizaci贸n IonMonkey pasa la mayor cantidad de tiempo generando c贸digo de m谩quina, pero dicho c贸digo es extremadamente eficiente. <br>  Veamos un ejemplo espec铆fico y veamos c贸mo las tuber铆as de varios motores abordan este problema.  Aqu铆 en el bucle activo, a menudo se repite el mismo c贸digo. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">4242424242</span></span>; ++i) { result += i; } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(result);</code> </pre> <br><br>  V8 comienza iniciando el c贸digo de bytes en el int茅rprete de encendido.  En alg煤n momento, el motor determina que el c贸digo est谩 activo y lanza la interfaz TurboFan, que integra datos de creaci贸n de perfiles y crea una representaci贸n de m谩quina b谩sica del c贸digo.  Luego se env铆a al optimizador TurboFan en otro hilo para una mejora adicional. <br><br><img src="https://habrastorage.org/webt/gy/zs/fb/gyzsfbelxi0ffbra0x2t-r6tm90.png"><br><br>  Mientras la optimizaci贸n est谩 en curso, V8 contin煤a ejecutando c贸digo en Ignition.  En alg煤n momento, cuando el optimizador ha terminado y hemos recibido el c贸digo de m谩quina ejecutable, inmediatamente pasa a la etapa de ejecuci贸n. <br>  SpyderMonkey tambi茅n comienza la ejecuci贸n de bytecode en el int茅rprete.  Pero tiene un nivel de l铆nea de base adicional, lo que significa que primero se env铆a el c贸digo activo.  El compilador de l铆nea de base genera c贸digo de l铆nea de base en el hilo principal y contin煤a la ejecuci贸n al final de su generaci贸n. <br><br><img src="https://habrastorage.org/webt/xe/4k/oy/xe4koybmve5b33fwgwef87b1a_u.png"><br><br>  Si el c贸digo de l铆nea de base se ha estado ejecutando durante alg煤n tiempo, SpiderMonkey finalmente lanza la interfaz IonMonkey (interfaz IonMonkey) y ejecuta el optimizador, el proceso es muy similar al V8.  Todo esto contin煤a funcionando al mismo tiempo en Baseline, mientras que IonMonkey se dedica a la optimizaci贸n.  Finalmente, cuando el optimizador termina su trabajo, se ejecuta el c贸digo optimizado en lugar del c贸digo de l铆nea de base. <br><br>  La arquitectura de Chakra es muy similar a SpiderMonkey, pero Chakra est谩 tratando de ejecutar m谩s procesos al mismo tiempo para evitar bloquear el hilo principal.  En lugar de ejecutar cualquier parte del compilador en el hilo principal, Chakra copia el bytecode y los datos de perfil que necesita el compilador y los env铆a al proceso dedicado del compilador. <br><br><img src="https://habrastorage.org/webt/3n/8x/op/3n8xopdh2_b-iobjurabjd6vj7m.png"><br><br>  Cuando el c贸digo generado est谩 listo, el motor ejecuta este c贸digo SimpleJIT en lugar del c贸digo de bytes.  Lo mismo sucede con FullJIT.  La ventaja de este enfoque es que la pausa que ocurre durante la copia suele ser mucho m谩s corta que iniciar un compilador completo (frontend).  Por otro lado, este enfoque tiene un inconveniente.  Se basa en el hecho de que la copia heur铆stica puede omitir alguna informaci贸n que ser谩 necesaria para la optimizaci贸n, por lo que podemos decir que, en cierta medida, la calidad del c贸digo se sacrifica en aras de acelerar el trabajo. <br><br>  En JavaScriptCore, todos los compiladores de optimizaci贸n funcionan completamente en paralelo con la ejecuci贸n b谩sica de JavaScript.  No hay fase de copia.  En cambio, el hilo principal simplemente comienza a compilarse en otro hilo.  Los compiladores utilizan un complejo esquema de bloqueo para acceder a los datos de creaci贸n de perfiles desde el hilo principal. <br><br><img src="https://habrastorage.org/webt/22/ih/lv/22ihlvsqxl_80pfo4qgivtksbqk.png"><br><br>  La ventaja de este enfoque es que reduce la cantidad de basura que aparece despu茅s de la optimizaci贸n en el hilo principal.  La desventaja de este enfoque es que requiere resolver problemas complejos de subprocesos m煤ltiples y algunos costos de bloqueo para diversas operaciones. <br>  Hablamos sobre las compensaciones entre la generaci贸n r谩pida de c贸digo mientras el int茅rprete est谩 en ejecuci贸n y la generaci贸n r谩pida de c贸digo utilizando el compilador de optimizaci贸n.  Pero hay un compromiso m谩s, y se refiere al uso de la memoria.  Para ilustrarlo, escrib铆 un programa simple de JavaScript que agrega dos n煤meros. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x + y; } add(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre> <br><br>  Mire el c贸digo de bytes que genera el int茅rprete de encendido para la funci贸n de agregar en V8. <br><br><pre> <code class="javascript hljs">StackCheck Ldar a1 Add a0, [<span class="hljs-number"><span class="hljs-number">0</span></span>] Return</code> </pre> <br><br>  No se preocupe por el c贸digo de bytes, no es necesario que pueda leerlo.  Aqu铆 es necesario prestar atenci贸n al hecho de que contiene <b>solo 4 instrucciones</b> . <br>  Cuando el c贸digo se calienta, TurboFan genera un c贸digo de m谩quina altamente optimizado, que se presenta a continuaci贸n: <br><br><pre> <code class="javascript hljs">leaq rcx,[rip+<span class="hljs-number"><span class="hljs-number">0x0</span></span>] movq rcx,[rcx<span class="hljs-number"><span class="hljs-number">-0x37</span></span>] testb [rcx+<span class="hljs-number"><span class="hljs-number">0xf</span></span>],<span class="hljs-number"><span class="hljs-number">0x1</span></span> jnz CompileLazyDeoptimizedCode push rbp movq rbp,rsp push rsi push rdi cmpq rsp,[r13+<span class="hljs-number"><span class="hljs-number">0xe88</span></span>] jna StackOverflow movq rax,[rbp+<span class="hljs-number"><span class="hljs-number">0x18</span></span>] test al,<span class="hljs-number"><span class="hljs-number">0x1</span></span> jnz Deoptimize movq rbx,[rbp+<span class="hljs-number"><span class="hljs-number">0x10</span></span>] testb rbx,<span class="hljs-number"><span class="hljs-number">0x1</span></span> jnz Deoptimize movq rdx,rbx shrq rdx, <span class="hljs-number"><span class="hljs-number">32</span></span> movq rcx,rax shrq rcx, <span class="hljs-number"><span class="hljs-number">32</span></span> addl rdx,rcx jo Deoptimize shlq rdx, <span class="hljs-number"><span class="hljs-number">32</span></span> movq rax,rdx movq rsp,rbp pop rbp ret <span class="hljs-number"><span class="hljs-number">0x18</span></span></code> </pre> <br><br>  Realmente hay muchos equipos aqu铆, especialmente en comparaci贸n con los cuatro que vimos en el c贸digo de bytes.  En general, el c贸digo de bytes es mucho m谩s amplio que el c贸digo de m谩quina y, en particular, el c贸digo de m谩quina optimizado.  Bytecode, por otro lado, es ejecutado por el int茅rprete, mientras que el c贸digo optimizado puede ser ejecutado directamente por el procesador. <br>  Esta es una de las razones por las cuales los motores de JavaScript no solo "optimizan todo".  Como vimos anteriormente, generar c贸digo de m谩quina optimizado lleva mucho tiempo y, por lo tanto, requiere m谩s memoria. <br><br><img src="https://habrastorage.org/webt/dn/h5/sm/dnh5smq1qva1g8udg583xeve85y.png"><br><br>  <b>Para resumir:</b> La raz贸n por la cual los motores de JavaScript tienen diferentes niveles de optimizaci贸n es para encontrar un compromiso entre la generaci贸n r谩pida de c贸digo usando el int茅rprete y la generaci贸n r谩pida de c贸digo usando el compilador de optimizaci贸n.  Agregar m谩s niveles de optimizaci贸n le permite tomar decisiones m谩s informadas, en funci贸n del costo de la complejidad y los gastos generales adicionales durante la ejecuci贸n.  Adem谩s, existe una compensaci贸n entre el nivel de optimizaci贸n y el uso de memoria.  Es por eso que los motores de JavaScript intentan optimizar solo las funciones activas. <br><br>  <b>Optimizar el acceso a las propiedades del prototipo</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La 煤ltima vez</a> hablamos sobre c贸mo los motores JavaScript optimizan la carga de las propiedades de los objetos mediante formularios y cach茅s en l铆nea.  Recuerde que los motores almacenan las formas de los objetos por separado de los valores del objeto. <br><br><img src="https://habrastorage.org/webt/mu/-x/t4/mu-xt4rt-iqzzutk8zaayg33acw.png"><br><br>  Los formularios le permiten utilizar la optimizaci贸n utilizando cach茅s en l铆nea o circuitos integrados abreviados.  Al trabajar juntos, los formularios y los circuitos integrados pueden acelerar el acceso repetido a las propiedades desde el mismo lugar en su c贸digo. <br><br><img src="https://habrastorage.org/webt/1i/sb/bh/1isbbh_xagsaucfsy5vjhmva1gs.png"><br><br>  As铆 que la primera parte de la publicaci贸n lleg贸 a su fin, y sobre las clases y la programaci贸n de prototipos se puede encontrar en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">segunda parte</a> .  Tradicionalmente, estamos esperando sus comentarios y discusiones tormentosas, as铆 como lo invitamos a una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">jornada de puertas abiertas</a> en el curso "Seguridad de los sistemas de informaci贸n". </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447870/">https://habr.com/ru/post/447870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447856/index.html">C贸mo vender una ventana sin emparejamiento o la importancia del posicionamiento antes de desarrollar un sitio</a></li>
<li><a href="../447860/index.html">Termodin谩mica de agujeros negros.</a></li>
<li><a href="../447862/index.html">Cisco Live 2019 EMEA. Sesiones t茅cnicas: simplificaci贸n externa con complicaci贸n interna</a></li>
<li><a href="../447864/index.html">Noticias de la semana: principales eventos en inform谩tica y ciencia</a></li>
<li><a href="../447868/index.html">M贸dulo de tel茅metro ultras贸nico submarino. Parte dos</a></li>
<li><a href="../447872/index.html">Alienware M15: port谩til para juegos compacto con amplias opciones de actualizaci贸n</a></li>
<li><a href="../447874/index.html">Entrop铆a informativa del caos</a></li>
<li><a href="../447876/index.html">Todo es muy malo o un nuevo tipo de intercepci贸n de tr谩fico.</a></li>
<li><a href="../447878/index.html">Comprobaci贸n de rdesktop y xrdp con PVS-Studio</a></li>
<li><a href="../447880/index.html">Validaci贸n de rdesktop y xrdp con el analizador PVS-Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>