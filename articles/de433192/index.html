<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö• üëö üêá Kubernetes: Eine erstaunlich erschwingliche pers√∂nliche Projektl√∂sung üßëüèΩ‚Äçü§ù‚Äçüßëüèª ü•î ‚èèÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Kollegen! 

 Im Januar haben wir endlich das lang erwartete Buch √ºber Kubernetes. Rede √ºber die ‚ÄûMastering Kubernetes 2nd Edition‚Äú von Gigi Saif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetes: Eine erstaunlich erschwingliche pers√∂nliche Projektl√∂sung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/433192/">  Hallo Kollegen! <br><br>  Im Januar haben wir endlich das lang erwartete Buch √ºber Kubernetes.  Rede √ºber die ‚ÄûMastering Kubernetes 2nd Edition‚Äú von Gigi Saifan: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mp/6r/pc/mp6rpcu9hby7scugehhegmzmtrs.jpeg"></div><br>  Wir haben es nicht gewagt, vor etwa einem Jahr ein Buch √ºber Kubernetes zu ver√∂ffentlichen, da die Technologie zu dieser Zeit definitiv wie ein Dreadnought f√ºr Superkonzerne aussah.  Die Situation √§ndert sich jedoch, wof√ºr wir empfehlen, einen gro√üen Artikel von Caleb Doxsey zu lesen, der √ºbrigens ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Buch</a> √ºber die Go-Sprache geschrieben hat.  Die Argumente von Herrn Doxy sind sehr interessant, und wir hoffen, dass Sie Kubernetes nach dem Lesen wirklich in der Praxis ausprobieren m√∂chten. <br><a name="habracut"></a><br>  Anfang dieses Jahres verbrachte ich einige Monate mit einer eingehenden Untersuchung von Kubernetes: Ich brauchte sie f√ºr ein Arbeitsprojekt.  Kubernetes ist eine umfassende Technologie f√ºr das Infrastrukturmanagement. Sie umfasst "alles, auch Batterien".  Kubernetes l√∂st eine Reihe von Problemen, auf die Sie bei der Entwicklung f√ºr gro√üe Unternehmen sto√üen m√ºssen.  Die √úberzeugung, dass Kubernetes eine √ºberm√§√üig ausgefeilte Technologie ist, die nur f√ºr die Verwaltung eines gro√üen Cluster von Maschinen relevant ist, wird jedoch wiederholt.  Angeblich ist die Betriebslast bei der Arbeit mit Kubernetes so gro√ü, dass die Verwendung f√ºr kleine Infrastrukturen, in denen die Maschine nicht in Dutzende geht, eine Kanone ist, die auf Spatzen feuert. <br>  Ich erlaube mir, damit nicht einverstanden zu sein.  Kubernetes eignet sich auch f√ºr kleine Projekte. Bereits heute k√∂nnen Sie sich Ihren eigenen Kubernetes-Cluster f√ºr weniger als <b>5 US-Dollar</b> pro Monat leisten. <br><br>  <b>Ein Wort zur Verteidigung von Kubernetes</b> <br><br>  Im Folgenden werde ich Ihnen zeigen, wie Sie Ihren eigenen Kubernetes-Cluster einrichten. Versuchen Sie jedoch zun√§chst zu erkl√§ren, warum Kubernetes in kleinen Projekten verwendet werden sollte: <br><br>  <i>Kubernetes ist gr√ºndlich</i> <br><br>  Ja, auf den ersten Blick scheint Kubernetes eine etwas redundante L√∂sung zu sein.  Es scheint einfacher zu sein, eine virtuelle Maschine zu erhalten und zu erhalten und Ihre eigene Anwendung nicht als Dienst zu konfigurieren. Warum nicht?  Wenn Sie diesen Pfad w√§hlen, m√ºssen Sie sich f√ºr einige L√∂sungen entscheiden, insbesondere: <br><br><ol><li>  Wie stelle ich die Anwendung bereit?  Einfach mit dem Server synchronisieren? </li><li>  Was ist mit Abh√§ngigkeiten?  Wenn Sie mit Python oder Ruby arbeiten, m√ºssen Sie diese auf dem Server installieren.  F√ºhren Sie die Befehle nur manuell aus? </li><li>  Wie werden Sie die Anwendung starten?  Einfach die Bin√§rdatei im Hintergrund ausf√ºhren und dann nicht mehr hochladen?  Dies ist wahrscheinlich nicht allzu gut. Wenn Sie also die Anwendung als Dienst organisieren, m√ºssen Sie systemd lernen? </li><li>  Wie werden Sie mit dem Betrieb vieler Anwendungen umgehen, wenn alle unterschiedliche Dom√§nennamen oder http-Pfade haben?  (Sie m√ºssen wahrscheinlich Haproxy oder Nginx daf√ºr konfigurieren) </li><li>  Angenommen, Sie haben Ihre Anwendung aktualisiert.  Wie werden Sie dann die √Ñnderungen einf√ºhren?  Dienst beenden, Code bereitstellen, Dienst neu starten?  Wie vermeide ich Ausfallzeiten? </li><li>  Was ist, wenn Sie die Bereitstellung sperren?  Gibt es M√∂glichkeiten zum Rollback?  (Symlink-Verzeichnis ...? Dieses einfache Skript scheint nicht mehr besonders einfach zu sein) </li><li>  Verwendet Ihre Anwendung andere Dienste, z. B. Redis?  Wie konfiguriere ich all diese Dienste? </li></ol><br>  Kubernetes l√∂st all diese Probleme.  Nat√ºrlich werden sie alle auf andere Weise gel√∂st, unter denen es bessere Optionen f√ºr Kubernetes gibt;  Wie viel besser ist es jedoch, √ºberhaupt nicht dar√ºber nachzudenken und sich auf die Anwendungsentwicklung zu konzentrieren. <br><br>  <i>Kubernetes ist zuverl√§ssig</i> <br><br>  Ein einzelner Server st√ºrzt immer ab.  Ja, das ist selten, vielleicht einmal im Jahr, aber nach einem solchen Ereignis treten echte Kopfschmerzen auf: wie man alles wieder in einen funktionierenden Zustand versetzt.  Dies gilt insbesondere dann, wenn Sie die gesamte Konfiguration manuell konfiguriert haben.  Erinnerst du dich an alle Teams, die das letzte Mal gelaufen sind?  Erinnerst du dich, was auf dem Server funktioniert hat?  Ich erinnere mich an ein Zitat von bashorg: <br><blockquote>  erno: Hmm.  Verlor den Computer ... ernsthaft, _lost_.  Er antwortet, funktioniert gut, ich wei√ü nur nicht, wohin er in der Wohnung gegangen ist. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">bash.org/?5273</a> </blockquote>  Genau das Gleiche ist mir k√ºrzlich in meinem eigenen Blog passiert.  Ich musste nur den Link aktualisieren, habe aber v√∂llig vergessen, wie das Blog bereitgestellt wird.  Pl√∂tzlich wurde aus einem zehnmin√ºtigen Fix ein ganzes Wochenende lang ein St√ºck Arbeit. <br><br>  Kubernetes verwendet ein <b>beschreibendes</b> Format, sodass Sie immer wissen, welche Dinge wann und wo sie ausgef√ºhrt werden sollten.  Dar√ºber hinaus sind alle Komponenten Ihres bereitgestellten Systems viel deutlicher sichtbar.  Dar√ºber hinaus wird in der Steuerebene der Knotenausfall sorgf√§ltig behandelt und die Herde werden automatisch neu verteilt.  Wenn Sie mit einem Dienst arbeiten, der den Status nicht beibeh√§lt, z. B. mit einer Webanwendung, k√∂nnen Sie wahrscheinlich Fehler ganz vergessen. <br><br>  <i>Kubernetes zu lernen ist nicht schwieriger als Alternativen</i> <br><br>  Kubernetes folgt nicht dem Unix-Modell.  Es passt nicht in das √ñkosystem der Werkzeuge.  Er ist keine dieser Entscheidungen, die "nur eine Sache tun und es gut machen".  Kubernetes ist eine umfassende L√∂sung f√ºr viele Probleme. Es kann eine Vielzahl von Tricks und Tools ersetzen, an die sich Entwickler bereits gew√∂hnt haben. <br><br>  Kubernetes hat eine eigene Terminologie, eigene Tools und ein eigenes Server-Handling-Paradigma, das sich erheblich vom traditionellen Unix-Ansatz unterscheidet.  Wenn Sie durch diese Systeme navigieren, erscheinen viele Funktionen von Kubernetes zuf√§llig und √ºberkompliziert, vielleicht sogar grausam.  Ich nehme an, es gibt gute Gr√ºnde, warum diese Komplexit√§t entstanden ist, aber hier sage ich nicht, dass Kubernetes einfach und elementar zu verstehen ist;  Ich sage, dass das Wissen von Kubernetes ausreicht, um eine Infrastruktur zu erstellen und zu unterst√ºtzen. <br><br>  Dies bedeutet nicht, dass jeder Systemadministrator √ºber einen ausreichenden Hintergrund in Unix verf√ºgt.  Zum Beispiel habe ich nach meinem College-Abschluss 5 Jahre im Windows-√ñkosystem gearbeitet.  Ich kann sagen, dass mein erster Job bei einem Startup, bei dem ich mich mit Linux befassen musste, eine schwierige Transformation erforderte.  Ich kannte die Befehle f√ºr den Speicher nicht und bin es nicht gewohnt, die Befehlszeile f√ºr fast alle Gelegenheiten zu verwenden.  Ich habe eine Weile gebraucht, um zu lernen, wie man mit der neuen Plattform arbeitet (obwohl ich zu diesem Zeitpunkt bereits Programmiererfahrung hatte), aber ich erinnere mich noch genau, wie viel ich gelitten habe. <br><br>  Mit Kubernetes k√∂nnen Sie alle Arbeiten von vorne beginnen.  In Kubernetes k√∂nnen Sie Dienste auch ohne SSH-Verbindung zum Server problemlos bereitstellen.  Sie m√ºssen systemd nicht lernen;  Es ist nicht erforderlich, die Runlevel zu verstehen oder zu wissen, welcher Befehl verwendet wurde: <code>groupadd</code> oder <code>addgroup</code> ;  Sie m√ºssen nicht lernen, mit <code>ps</code> oder, Gott bewahre, vim umzugehen.  All dieses Material ist n√ºtzlich und wichtig, nichts davon verschwindet irgendwo.  Ich habe gro√üen Respekt vor Sysadmins, die sich durch jede Unix-Umgebung arbeiten k√∂nnen.  Aber wie cool w√§re es, wenn Entwickler all diese Ressourcen produktiv erwerben k√∂nnten, ohne sich mit solchen Feinheiten der Verwaltung zu befassen? <br><br>  Ist es wirklich das: <br><br><pre> <code class="plaintext hljs">[Unit] Description=The NGINX HTTP and reverse proxy server After=syslog.target network.target remote-fs.target nss-lookup.target [Service] Type=forking PIDFile=/run/nginx.pid ExecStartPre=/usr/sbin/nginx -t ExecStart=/usr/sbin/nginx ExecReload=/usr/sbin/nginx -s reload ExecStop=/bin/kill -s QUIT $MAINPID PrivateTmp=true [Install] WantedBy=multi-user.target</code> </pre> <br>  Viel schwieriger als das? <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 1 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80</code> </pre> <br>  Und das ist immer noch ein relativ guter Fall.  Wenn Sie die Infrastruktur zu 100% remote verwalten, k√∂nnen Sie keine manuelle Serverunterst√ºtzung bereitstellen.  Dazu ben√∂tigen Sie ein Werkzeug: Ansible, Salz, Koch, Marionette usw.  Nat√ºrlich m√ºssen Sie viel lernen, um Kubernetes zu beherrschen und effektiv damit zu arbeiten, aber dies ist nicht schwieriger als der Umgang mit Alternativen. <br><br>  <b>Kubernetes Open Source</b> <br><br>  In Zeiten der gro√üen Beliebtheit serverloser Technologien zeichnet sich Kubernetes durch seine Unabh√§ngigkeit von bestimmten Anbietern aus.  Es gibt mindestens drei beliebte und einfach zu verwaltende Anbieter von Kubernetes (Google, Amazon, Microsoft), die in absehbarer Zeit nicht verschwinden werden.  Es gibt auch viele Unternehmen, die ihre eigenen Kubernetes-Cluster erfolgreich verwalten, und die Anzahl dieser Unternehmen vervielfacht sich jeden Tag.  Heute ist die Zusammenarbeit mit Kubernetes vom ersten Tag an f√ºr die meisten Startups eine offensichtliche L√∂sung. <br>  Kubernetes ist ein Open-Source-Projekt, das gut dokumentiert, stabil und beliebt ist. Probleme k√∂nnen beim Stackoverflow so detailliert wie m√∂glich behandelt werden.  Nat√ºrlich hat Kubernetes seine eigenen Fehler und technischen Herausforderungen, aber ich versichere Ihnen: Es gibt Leute auf der Welt, die Kubernetes mit unglaublichem K√∂nnen verbessern.  Ihre Arbeit ist Ihre Dividende;  In den n√§chsten Jahren wird diese Technologie nur noch verbessert. <br><br>  <b>Kubernetes Waage</b> <br><br>  Eine der mit der Unterst√ºtzung der Infrastruktur verbundenen Herausforderungen besteht darin, dass die Techniken, die bei der Bereitstellung kleiner Systeme n√ºtzlich sind, bei der Reproduktion in gr√∂√üeren Systemen selten erfolgreich sind.  Es ist auf jeden Fall praktisch, eine Bin√§rdatei per SCP an den Server zu binden, den Prozess abzubrechen und neu zu starten, wenn Sie nur einen Server haben.  Wenn Sie jedoch mehrere Server unterst√ºtzen und gleichzeitig √ºberwachen m√ºssen, kann sich eine solche Aufgabe als erstaunlich schwierig herausstellen.  Deshalb k√∂nnen Sie bei der Verwaltung einer solchen Infrastruktur nicht auf Tools wie Koch oder Marionette verzichten. <br><br>  Wenn Sie jedoch das falsche Werkzeug w√§hlen, kann es Sie im Laufe der Zeit in eine Ecke treiben.  Pl√∂tzlich stellt sich heraus, dass der f√ºhrende Chef-Server die Last von 1000 Servern nicht bew√§ltigen kann, die blau-gr√ºne Bereitstellung nicht in Ihr Modell passt und die Ausf√ºhrung der Capistrano-Aufgaben Stunden dauert.  Wenn die Infrastruktur eine bestimmte Gr√∂√üe erreicht, m√ºssen Sie alles, was bereits getan wurde, abrei√üen und von vorne beginnen.  Wie gro√üartig w√§re es, wenn Sie aus diesem ewigen Eichh√∂rnchenrad mit Infrastruktur ausbrechen und auf eine Technologie umsteigen k√∂nnten, die Ihren Anforderungen entspricht? <br><br>  Kubernetes √§hnelt einer SQL-Datenbank.  SQL ist das Ergebnis langj√§hriger harter Lektionen √ºber Datenspeicherung und effizientes Abfragen.  Wahrscheinlich ben√∂tigen Sie nicht einmal ein Zehntel der Funktionen, die in einer g√ºltigen SQL-Datenbank bereitgestellt werden.  M√∂glicherweise k√∂nnen Sie sogar ein effizienteres System entwerfen, das auf Ihrer eigenen Datenbank basiert.  In den allermeisten Situationen erf√ºllt die SQL-Datenbank jedoch nicht nur alle Ihre Anforderungen, sondern erweitert auch Ihre F√§higkeit, schnell vorgefertigte L√∂sungen herauszugeben.  SQL-Schemas und Indizierungen sind viel einfacher zu verwenden als native dateibasierte Datenstrukturen, da native Datenstrukturen mit ziemlicher Sicherheit veraltet sind, wenn Ihr Produkt mit der Zeit w√§chst und sich entwickelt.  Es ist jedoch wahrscheinlich, dass die SQL-Datenbank jedes unvermeidliche Refactoring √ºberlebt. <br><br>  Kubernetes wird auch √ºberleben.  Vielleicht wird Ihr Nebenprojekt nie so gro√ü, dass seine Probleme nur mit Kubernetes gel√∂st werden k√∂nnen, aber Kubernetes verf√ºgt √ºber absolut alle Tools f√ºr Probleme, und die F√§higkeiten, die Sie beim Umgang mit diesem Toolkit erwerben, k√∂nnen sich als solche herausstellen von unsch√§tzbarem Wert in zuk√ºnftigen Projekten. <br><br>  <b>Erstellen Sie Ihren eigenen Kubernetes-Cluster</b> <br><br>  Daher halte ich es f√ºr ratsam, Kubernetes in kleinen Projekten zu verwenden, aber nur, wenn die Einrichtung eines Clusters einfach und kosteng√ºnstig ist.  Es stellt sich heraus, dass beide erreichbar sind.  Es gibt von Kubernetes verwaltete Anbieter, die das gesamte Chaos selbst erledigen und die Steuerebene des Kubernetes-Hosts unterst√ºtzen.  Und die j√ºngsten Dumpingkriege in der Cloud-Infrastruktur haben zu einer erstaunlichen Reduzierung der Kosten solcher Dienste gef√ºhrt. <br>  Wir werden den n√§chsten Fall am Beispiel der Kubernetes-Engine von Google (GKE) analysieren. Sie k√∂nnen sich jedoch auch Angebote von Amazon (EKS) oder Microsoft (AKS) ansehen, wenn Google nicht zu Ihnen passt.  Um Ihren eigenen Kubernetes-Cluster aufzubauen, ben√∂tigen wir: <br><br><ul><li>  Domainname (~ 10 $ / Jahr, abh√§ngig von der Domain) </li><li>  Cloudflare DNS Hosting (kostenlos) </li><li>  Drei-Knoten-Cluster von GKE Kubernetes (~ 5 USD / Monat) </li><li>  Webanwendung, die als Docker-Container in die Google Container Registry (GCR) hochgeladen wurde (kostenlos) </li><li>  Eine Reihe von Yaml-Dateien f√ºr die Kubernetes-Konfiguration </li></ul><br>  F√ºr zus√§tzliche Einsparungen werden wir versuchen, auf einen Google Input Controller zu verzichten.  Stattdessen verwenden wir Nginx auf jedem Knoten als Daemon und erstellen einen eigenen Operator, der die externen IP-Adressen des Arbeitsknotens mit Cloudflare synchronisiert. <br><br>  <b>Google-Konfiguration</b> <br><br>  Gehen Sie zun√§chst zu console.cloud.google.com und erstellen Sie ein Projekt, falls Sie dies noch nicht getan haben.  Sie m√ºssen auch ein Abrechnungskonto erstellen.  Gehen Sie dann √ºber das Hamburger-Men√º zur Seite Kubernetes und erstellen Sie einen neuen Cluster.  Folgendes m√ºssen Sie als N√§chstes tun: <br><br><ul><li>  W√§hlen Sie als Standorttyp Zonal aus. </li><li>  Ich habe meinen Standort als us-central1-a angegeben </li><li>  W√§hlen Sie Ihre Version von Kubernetes </li><li>  Erstellen Sie einen Pool von 3 Knoten mit dem billigsten Instanztyp (f1-micro). </li><li>  Stellen Sie f√ºr diesen Knotenpool auf dem Bildschirm ‚ÄûErweitert‚Äú die Gr√∂√üe der Startdiskette auf 10 GB ein, aktivieren Sie extrudierte Knoten (sie sind billiger), aktivieren Sie die automatische Aktualisierung und die automatische Behandlung. </li><li>  Unter dem Knotenpool finden Sie eine Reihe zus√§tzlicher Optionen.  Wir m√∂chten den HTTP-Lastausgleich deaktivieren (Lastausgleich in GCP ist teuer) und auch die gesamte mit StackDriver verbundene Wirtschaftlichkeit deaktivieren (er kann auch teuer und meiner Erfahrung nach nicht sehr zuverl√§ssig sein).  Schalten Sie auch das Kubernetes-Anzeigefeld aus. </li></ul><br>  Nachdem Sie alle diese Optionen festgelegt haben, k√∂nnen Sie mit dem n√§chsten Schritt fortfahren: Erstellen eines Clusters.  So sparen Sie: <br><br><ul><li>  Kubernetes-Steuerebene: kostenlos, da Google keine Hostknoten berechnet </li><li>  Kubernetes-Arbeitsknoten: 5,04 US-Dollar / Monat, 3 Mikroknoten kosten in der Regel 11,65 US-Dollar pro Monat. Nachdem sie verdr√§ngt wurden, reduzieren wir diese Rate auf 7,67 US-Dollar pro Monat und bei ‚ÄûAlways Free‚Äú auf 5,04 US-Dollar. </li><li>  Lagerkosten: kostenlos.  Wir erhalten kostenlos 30 GB permanenten Speicherplatz, daher haben wir oben die Gr√∂√üe von 10 GB gew√§hlt. </li><li>  Kosten f√ºr den Lastenausgleich: Wir haben den HTTP-Lastenausgleich kostenlos deaktiviert, da wir nur 18 US-Dollar pro Monat ben√∂tigen w√ºrden.  F√ºhren Sie stattdessen auf jedem Knoten unsere eigenen HTTP-Proxys aus und leiten Sie den DNS an die √∂ffentliche IP weiter. </li><li>  Netzwerkkosten: kostenlos, die Ausgangsfunktion bleibt kostenlos, bis Sie 1 GB pro Monat ausw√§hlen.  (Als n√§chstes kostet jedes n√§chste Gigabyte 8 Cent) </li></ul><br>  Also haben wir einen Kubernetes-Cluster mit 3 Knoten eingerichtet, der uns den gleichen Preis kostet wie die einzige Digital Ocean-Maschine. <br><br>  Zus√§tzlich zur Konfiguration von GKE m√ºssen Sie einige Firewall-Regeln konfigurieren, damit Sie die HTTP-Ports unserer Hosts von au√üen erreichen k√∂nnen.  Suchen Sie den VPC-Netzwerkeintrag im Hamburger-Men√º, gehen Sie zu den Firewall-Regeln und f√ºgen Sie die Regeln f√ºr die TCP-Ports 80 und 443 mit dem IP-Adressbereich 0.0.0.0/0 hinzu. <br><br><img src="https://habrastorage.org/webt/if/ag/gz/ifaggzw5xpzfosqf_lxon8bqsdo.jpeg"><br><br>  Firewall-Regeln <br><br>  <b>Lokale Einstellung</b> <br><br>  Also haben wir den Cluster angehoben und gestartet und jetzt konfigurieren wir ihn.  Installieren Sie das <code>gcloud</code> Tool <code>gcloud</code> den Anweisungen unter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">cloud.google.com/sdk/docs</a> .  Nach der Installation k√∂nnen Sie wie folgt mit der Konfiguration fortfahren: <br><br><pre> <code class="plaintext hljs">gcloud auth login</code> </pre> <br>  Nat√ºrlich m√ºssen Sie Docker noch installieren und dann an den GCR binden, damit Sie Container senden k√∂nnen: <br><br><pre> <code class="plaintext hljs">gcloud auth configure-docker</code> </pre> <br>  Sie k√∂nnen <code>kubectl</code> auch installieren und konfigurieren, indem Sie die hier beschriebenen Anweisungen <code>kubectl</code> . <br><br>  Vereinfacht: <br><br><pre> <code class="plaintext hljs">gcloud components install kubectl gcloud config set project PROJECT_ID gcloud config set compute/zone COMPUTE_ZONE gcloud container clusters get-credentials CLUSTER_NAME</code> </pre> <br>  √úbrigens ist es nur ein M√§rchen, dass all dieses Toolkit unter Windows, OSX oder Linux funktioniert.  Als eine Person, die manchmal solche Dinge unter Windows getan hat, gebe ich zu, dass dies eine angenehme √úberraschung ist. <br><br>  <b>Erstellen von Webanwendungen</b> <br><br>  Eine Webanwendung kann in jeder Programmiersprache geschrieben werden.  Mit dem Container k√∂nnen Sie das Besondere abstrahieren.  Wir m√ºssen eine HTTP-Anwendung erstellen, die den Port √ºberwacht.  Ich bevorzuge Go f√ºr solche Zwecke, aber zur Abwechslung werden wir es mit Kristall versuchen.  Erstellen Sie die Datei <code>main.cr</code> : <br><br><pre> <code class="plaintext hljs"># crystal-www-example/main.cr require "http/server" Signal::INT.trap do exit end server = HTTP::Server.new do |context| context.response.content_type = "text/plain" context.response.print "Hello world from crystal-www-example! The time is #{Time.now}" end server.bind_tcp("0.0.0.0", 8080) puts "Listening on http://0.0.0.0:8080" server.listen</code> </pre> <br>  Wir brauchen auch eine Docker-Datei: <br><br><pre> <code class="plaintext hljs"># crystal-www-example/Dockerfile FROM crystallang/crystal:0.26.1 as builder COPY main.cr main.cr RUN crystal build -o /bin/crystal-www-example main.cr --release ENTRYPOINT [ "/bin/crystal-www-example" ]</code> </pre> <br>  F√ºhren Sie Folgendes aus, um unsere Anwendung zu erstellen und zu testen: <br><br><pre> <code class="plaintext hljs">docker build -t gcr.io/PROJECT_ID/crystal-www-example:latest . docker run -p 8080:8080 gcr.io/PROJECT_ID/crystal-www-example:latest</code> </pre> <br>  Und dann gehen Sie zum Browser bei localhost: 8080.  Nachdem wir diesen Mechanismus eingerichtet haben, k√∂nnen wir unsere Anwendung an GCR senden, indem wir Folgendes ausf√ºhren: <br><br><pre> <code class="plaintext hljs">docker push gcr.io/PROJECT_ID/crystal-www-example:latest</code> </pre> <br>  <b>Konfigurieren Sie Kubernetes</b> <br><br>  Meine Kubernetes-Konfiguration ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br>  In diesem Beispiel m√ºssen wir mehrere Yaml-Dateien erstellen, in denen unsere verschiedenen Dienste dargestellt werden, und dann kubectl apply ausf√ºhren, um sie im Cluster zu konfigurieren.  Die Konfiguration von Kubernetes ist beschreibend, und alle diese Yaml-Dateien teilen Kubernetes mit, welchen Status wir erhalten m√∂chten.  Im weitesten Sinne werden wir Folgendes tun: <br><br><ul><li>  Erstellen Sie Bereitstellung und Service f√ºr unsere Crystal-www-Beispiel-Webanwendung </li><li>  Erstellen Sie Daemon Set (Services Set) und Config Map (Konfigurations Map) f√ºr Nginx </li><li>  Wir starten unsere eigene Anwendung, um IP-Knoten mit Cloudflare for DNS zu synchronisieren </li></ul><br>  <b>Konfiguration der Webanwendung</b> <br><br>  Konfigurieren wir zun√§chst unsere Webanwendung: ( <code>PROJECT_ID</code> sicher, dass <code>PROJECT_ID</code> durch die ID Ihres Projekts ersetzt wird.) <br><br><pre> <code class="plaintext hljs"># kubernetes-config/crystal-www-example.yaml apiVersion: apps/v1 kind: Deployment metadata: name: crystal-www-example labels: app: crystal-www-example spec: replicas: 1 selector: matchLabels: app: crystal-www-example template: metadata: labels: app: crystal-www-example spec: containers: - name: crystal-www-example image: gcr.io/PROJECT_ID/crystal-www-example:latest ports: - containerPort: 8080 --- kind: Service apiVersion: v1 metadata: name: crystal-www-example spec: selector: app: crystal-www-example ports: - protocol: TCP port: 8080 targetPort: 8080</code> </pre> <br>  Dadurch wird eine Bereitstellung (erweiterte Konfiguration) erstellt, nach der Kubernetes einen einzelnen Container (unser Docker-Container funktioniert dort) und einen Dienst erstellen muss, mit dem wir Dienste in unserem Cluster finden.  F√ºhren Sie zum <code>kubernetes-config</code> dieser Konfiguration <code>kubernetes-config</code> aus (im <code>kubernetes-config</code> ): <br><br><pre> <code class="plaintext hljs">kubectl apply -f</code> </pre> <br>  Sie k√∂nnen es so testen: <br><br><pre> <code class="plaintext hljs">kubectl get pod #     : # crystal-www-example-698bbb44c5-l9hj9 1/1 Running 0 5m</code> </pre> <br><br>  Wir k√∂nnen auch eine Proxy-API f√ºr den Zugriff erstellen: <br><br><pre> <code class="plaintext hljs">kubectl proxy</code> </pre> <br>  Und dann gehen Sie zu: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">localhost</a> : 8001 / api / v1 / namespaces / default / services / Crystal-www-Beispiel / Proxy / <br><br>  <b>NGINX-Konfiguration</b> <br><br>  Bei der Arbeit mit HTTP-Diensten verwendet Kubernetes normalerweise einen Eingabecontroller.  Leider ist der HTTP-Load-Balancer von Google zu teuer, sodass wir ihn nicht verwenden, sondern unseren eigenen HTTP-Proxy verwenden und manuell konfigurieren (das klingt be√§ngstigend, ist aber in Wirklichkeit sehr einfach). <br><br>  Verwenden Sie dazu Daemon Set und Config Map.  Daemon Set ist eine Anwendung, die auf jedem Knoten ausgef√ºhrt wird.  Config Map ist im Prinzip eine kleine Datei, die wir in einen Container einbinden k√∂nnen.  Diese Datei speichert die Nginx-Konfiguration. <br>  Die yaml-Datei sieht ungef√§hr so ‚Äã‚Äãaus: <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: DaemonSet metadata: name: nginx labels: app: nginx spec: selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: hostNetwork: true dnsPolicy: ClusterFirstWithHostNet containers: - image: nginx:1.15.3-alpine name: nginx ports: - name: http containerPort: 80 hostPort: 80 volumeMounts: - name: "config" mountPath: "/etc/nginx" volumes: - name: config configMap: name: nginx-conf --- apiVersion: v1 kind: ConfigMap metadata: name: nginx-conf data: nginx.conf: | worker_processes 1; error_log /dev/stdout info; events { worker_connections 10; } http { access_log /dev/stdout; server { listen 80; location / { proxy_pass http://crystal-www-example.default.svc.cluster.local:8080; } } }</code> </pre> <br>  Auf diese Weise h√§ngen wir die Datei nginx.conf der Konfigurationskarte in den Nginx-Container ein.  Wir legen au√üerdem Werte f√ºr zwei weitere Felder fest: <code>hostNetwork: true</code> , damit Sie den Host-Port binden und von au√üen auf nginx und <code>dnsPolicy: ClusterFirstWithHostNet</code> damit Sie auf Dienste innerhalb des Clusters zugreifen k√∂nnen.  Wenn dies nicht getan wird, erhalten wir eine vollst√§ndig standardm√§√üige Konfiguration. <br><br>  Wenden Sie diese Ausdr√ºcke an und Sie k√∂nnen √ºber die √∂ffentliche IP-Adresse Ihrer Knoten auf nginx zugreifen. <br><br>  So k√∂nnen Sie dies √ºberpr√ºfen: <br><br><pre> <code class="plaintext hljs">kubectl get node -o yaml # look for: # - address: ... # type: ExternalIP</code> </pre><br>  Unsere Webanwendung ist jetzt √ºber das Internet zug√§nglich.  Es bleibt ein sch√∂ner Name f√ºr die Anwendung. <br><br>  <b>DNS-Verbindung</b> <br><br>  Es ist erforderlich, 3 A-DNS-Eintr√§ge f√ºr die Knoten unseres Clusters festzulegen: <br><br><img src="https://habrastorage.org/webt/1l/0t/xx/1l0txxf6dye-lyuxpbndghsw_ta.png"><br><br>  Eintr√§ge in der UI Cloudflare <br><br>  F√ºgen Sie dann einen CNAME-Datensatz hinzu, um auf diese A-Datens√§tze zu verweisen.  (z. B. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.example.com</a> CNAME f√ºr kubernetes.example.com).  Dies kann manuell erfolgen, jedoch besser - automatisch. Wenn wir also jemals Knoten in DNS-Eintr√§gen skalieren oder ersetzen m√ºssen, werden diese Informationen ebenfalls automatisch aktualisiert. <br><br>  Ich denke, dieses Beispiel zeigt auch gut, wie Sie einen Teil Ihrer Arbeit an Kubernetes delegieren k√∂nnen, ohne zu versuchen, sie zu √ºberwinden.  Kubernetes versteht Skripte und verf√ºgt √ºber eine leistungsstarke API. Sie k√∂nnen die vorhandenen Bereiche mit Ihren eigenen Komponenten f√ºllen, die nicht so schwer zu schreiben sind.  Zu diesem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zweck habe</a> ich auf Go eine kleine Anwendung bereitgestellt, die unter folgender Adresse verf√ºgbar ist: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">kubernetes-cloudflare-sync</a> . <br><br>  Zu Beginn habe ich einen Informanten erstellt: <br><br><pre> <code class="go hljs">factory := informers.NewSharedInformerFactory(client, time.Minute) lister := factory.Core().V1().Nodes().Lister() informer := factory.Core().V1().Nodes().Informer() informer.AddEventHandler(cache.ResourceEventHandlerFuncs{ AddFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, UpdateFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(oldObj, newObj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, DeleteFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, }) informer.Run(stop)</code> </pre> <br>  Es ruft meine Resync-Funktion auf, wenn sich ein Knoten √§ndert.  Dann synchronisiere ich die API mithilfe der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cloudflare-API-</a> Bibliothek. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ips []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, node := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> nodes { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, addr := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> node.Status.Addresses { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> addr.Type == core_v1.NodeExternalIP { ips = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(ips, addr.Address) } } } sort.Strings(ips) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, ip := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> ips { api.CreateDNSRecord(zoneID, cloudflare.DNSRecord{ Type: <span class="hljs-string"><span class="hljs-string">"A"</span></span>, Name: options.DNSName, Content: ip, TTL: <span class="hljs-number"><span class="hljs-number">120</span></span>, Proxied: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, }) }</code> </pre> <br>  Dann starten wir wie bei unserer Webanwendung diese Anwendung in Kubernetes als Bereitstellung: <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: kubernetes-cloudflare-sync labels: app: kubernetes-cloudflare-sync spec: replicas: 1 selector: matchLabels: app: kubernetes-cloudflare-sync template: metadata: labels: app: kubernetes-cloudflare-sync spec: serviceAccountName: kubernetes-cloudflare-sync containers: - name: kubernetes-cloudflare-sync image: gcr.io/PROJECT_ID/kubernetes-cloudflare-sync args: - --dns-name=kubernetes.example.com env: - name: CF_API_KEY valueFrom: secretKeyRef: name: cloudflare key: api-key - name: CF_API_EMAIL valueFrom: secretKeyRef: name: cloudflare key: email</code> </pre> <br>  Wir m√ºssen ein Kubernetes-Geheimnis erstellen, indem <code>cloudflare api</code> den <code>cloudflare api</code> Schl√ºssel und die Postanschrift <code>cloudflare api</code> : <br><br><pre> <code class="plaintext hljs">kubectl create secret generic cloudflare --from-literal=email='EMAIL' --from-literal=api-key='API_KEY'</code> </pre> <br>  Wir m√ºssen auch ein Dienstkonto erstellen (um unserer Bereitstellung Zugriff auf die Kubernetes-API zu gew√§hren, um Knoten abzurufen).  Erster Lauf (speziell f√ºr GKE): <br><br><pre> <code class="plaintext hljs">kubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user YOUR_EMAIL_ADDRESS_HERE</code> </pre> <br><br>  Und dann bewerben: <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: ServiceAccount metadata: name: kubernetes-cloudflare-sync --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: kubernetes-cloudflare-sync rules: - apiGroups: [""] resources: ["nodes"] verbs: ["list", "watch"] --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: kubernetes-cloudflare-sync-viewer roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: kubernetes-cloudflare-sync subjects: - kind: ServiceAccount name: kubernetes-cloudflare-sync namespace: default</code> </pre> <br>  Die Arbeit mit RBAC ist etwas m√ºhsam, aber ich hoffe, dass hier alles klar ist.  Wenn die Konfiguration fertig ist und unsere Anwendung mit Cloudflare arbeitet, kann diese Anwendung bei jeder √Ñnderung an einem der Knoten aktualisiert werden. <br><br>  <b>Fazit</b> <br><br>  Kubernetes soll das Flaggschiff f√ºr die Verwaltung gro√üer Systeme werden. ,   Kubernetes     ,    Kubernetes    ,    Kubernetes   ,      Kubernetes   . <br><br>    ,  Kubernetes       :      ,  .       ‚Äì   ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de433192/">https://habr.com/ru/post/de433192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de433180/index.html">L√∂sen von Datentypproblemen in Ruby oder Machen Sie Daten wieder zuverl√§ssig</a></li>
<li><a href="../de433182/index.html">Ist es m√∂glich, einen Agenten f√ºr den Handel an der B√∂rse mit Verst√§rkung auszubilden? Implementierung der R-Sprache</a></li>
<li><a href="../de433184/index.html">ASP.NET Core 2.2 ver√∂ffentlicht. Was gibt's Neues? (2 von 3)</a></li>
<li><a href="../de433186/index.html">Es reicht nicht aus, Polygone zu z√§hlen, um 3D-Modelle zu optimieren</a></li>
<li><a href="../de433188/index.html">Die Staatsduma legte einen Gesetzentwurf zur autonomen Arbeit von Runet vor</a></li>
<li><a href="../de433194/index.html">Geplantes Nachtlicht</a></li>
<li><a href="../de433196/index.html">Neujahrsgeschenkf√ºhrer</a></li>
<li><a href="../de433198/index.html">10 Dollar f√ºr Hosting: Vor 20 Jahren und heute</a></li>
<li><a href="../de433202/index.html">Auswahl der Architektur einer L√∂sung f√ºr einen Marktplatz f√ºr Frachtdienste</a></li>
<li><a href="../de433204/index.html">Wie lerne ich die Java-Entwicklung? Die Erfahrung des GeekUniversity-Studenten Nikita Chernetsov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>