<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçî üôå ü§≤ √Årvore B + em um projeto real üï¥üèΩ ‚öæÔ∏è üßúüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, examinaremos detalhadamente como a √°rvore B + √© feita em um banco de dados distribu√≠do do Apache Ignite . 




 J√° existem alguns artigo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√Årvore B + em um projeto real</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/413749/"><p>  Neste artigo, examinaremos detalhadamente como a √°rvore B + √© feita em um banco de dados distribu√≠do do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apache Ignite</a> . <br></p><br><img src="https://habrastorage.org/webt/mv/_t/zg/mv_tzg1o-c96a2ib19cf9umv67u.jpeg"><a name="habracut"></a><br><p>  J√° existem alguns artigos sobre √°rvores H em √°rvores B ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dois</a> ), mas s√£o mais prov√°veis ‚Äã‚Äãte√≥ricos e, mesmo que contenham uma implementa√ß√£o, n√£o est√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">prontos para produ√ß√£o</a> .  A partir disso, √© interessante observar a implementa√ß√£o usada na vida. </p><br><p>  Antes de ler o artigo, aconselho a assistir a uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">palestra de Maxim Babenko</a> , se voc√™ ainda n√£o sabe o que √© a √°rvore B em teoria.  Mas n√£o preciso conhecer profundamente o Java ou o projeto Apache Ignite - escreverei os detalhes explicitamente ou os ocultarei em spoilers. </p><br><p>  Ao ler fontes Ignite, aconselho que voc√™ pule os argumentos dos m√©todos em sua mente, cujo significado n√£o √© muito claro e leia os nomes das fun√ß√µes - √© muito mais f√°cil ler o corpo da fun√ß√£o se voc√™ souber com anteced√™ncia o que ela faz. </p><br><p>  Observe que eu n√£o sou o desenvolvedor principal do Apache Ignite e poderia ter entendido algo errado do c√≥digo.  Ent√£o, eu coloquei a frase ‚Äúat√© onde eu entendi‚Äù, que deveria ser acrescentada mentalmente antes de cada frase afirmativa. </p><br><h1 id="zachem-b-derevo-v-apache-ignite">  Por que a √°rvore B + no Apache Ignite </h1><br><p> O Apache Ignite √© um banco de dados na mem√≥ria, mas desde a vers√£o 2.1, ele possui um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">armazenamento de dados persistente</a> - uma fun√ß√£o para salvar dados em disco <em>(n√£o tem nada a ver com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estrutura de dados persistente</a> )</em> .  Portanto, fica claro por que uma estrutura √© necess√°ria para a mem√≥ria externa, resta entender por que eles n√£o escolheram outra. </p><br><p>  Para come√ßar, a √°rvore B + √© uma otimiza√ß√£o da √°rvore B, na qual os valores s√£o armazenados apenas nas folhas.  Nesta otimiza√ß√£o, mais chaves cabem em um n√≥, o que aumenta o grau de ramifica√ß√£o.  Portanto, n√£o h√° muitas raz√µes para usar a √°rvore B cl√°ssica. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">B *</a> e B + * - s√£o mais densos no disco, mas t√™m desempenho pior, porque  Como armazenamos dados da RAM, o desempenho √© mais importante para n√≥s. </p><br><p>  A julgar pelos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">benchmarks, uma</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√°rvore LSM √©</a> mais r√°pida na escrita, mas mais lenta na leitura.  Al√©m disso, a perda na leitura √© maior que o ganho na escrita, portanto, para um caso geral hipot√©tico, eu tamb√©m aceitaria a √°rvore B +. </p><br><p>  Existem tamb√©m <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√°rvores fractais</a> estranhas, no entanto, aparentemente, elas s√£o patenteadas e implementadas apenas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TokuDB</a> . </p><br><p>  Pessoalmente, estou mais interessado em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">saber</a> por que era imposs√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">usar um</a> back-end de disco pronto, como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LevelDB</a> ?  Uma resposta parcial √© que o PDS oferece suporte a armazenamento de terceiros. </p><br><h1 id="realizaciya-v-krupnuyu-kletku">  Implementa√ß√£o de grandes c√©lulas </h1><br><p> Inicialmente, o GridGain desenvolveu o Apache Ignite, mas antes de partir para o c√≥digo-fonte aberto tinha o nome da empresa; portanto, alguns nomes de componentes come√ßam com <code>Grid</code> e outros com <code>Ignite</code> .  Portanto <code>GridCursor</code> , mas <code>IgniteTree</code> .  N√£o h√° outra l√≥gica aqui. </p><br><p>  O c√≥digo do Apache Ignite √© escrito nos padr√µes de pr√°ticas recomendadas de Java e cada classe herda uma interface, se n√£o uma.  Na interface do <code>IgniteTree</code> e comece a dan√ßa.  Eu dou o c√≥digo sem javadoc, para abreviar. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T val)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key, Object x, InvokeClosure&lt;T&gt; c)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper, Object x)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findFirst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findLast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvokeClosure</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable T row)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">OperationType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operationType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> OperationType { NOOP, REMOVE, PUT } }</code> </pre> <br><p>  A interface do <code>IgniteTree</code> descreve um conjunto padr√£o de opera√ß√µes.  Observe que, para realizar uma pesquisa por faixa, √© necess√°rio tricotar folhas em uma lista.  O b√¥nus suporta uma opera√ß√£o de registro arbitr√°ria - <code>invoke</code> . </p><br><p>  A opera√ß√£o <code>put</code> usa apenas um argumento do tipo <code>T</code> sem uma chave.  Voc√™ n√£o encontrar√° uma explica√ß√£o para isso no <code>IgniteTree</code> , no entanto, a resposta est√° oculta no cabe√ßalho do <code>BPlusTree</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BPlusTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataStructure</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br><p>  Como voc√™ pode ver, o valor herda a chave, portanto, na opera√ß√£o de venda, a chave √© calculada a partir do valor.  Isso n√£o limita a funcionalidade da √°rvore.  Minha suposi√ß√£o √© que √© mais compacto armazenar conjuntos. </p><br><p>  Geralmente eles s√£o definidos fora do mapa, anexando uma constante de lixo ao valor.  No entanto, na √°rvore B +, <em>apenas as chaves s√£o</em> armazenadas nos n√≥s; se o valor tamb√©m armazena a chave, nas folhas √© suficiente armazenar <em>apenas os valores</em> .  E se a √°rvore √© um conjunto, acontece automaticamente que nas folhas haver√° apenas chaves sem valores de lixo. </p><br><p><img src="https://habrastorage.org/webt/gk/5a/mj/gk5amjeohtkej5assnsgyy791p4.png"></p><br><p>  Agora, vejamos o c√≥digo de pesquisa do elemento. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> g Get. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> IgniteCheckedException If failed. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doFind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Get g)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. g.init(); switch (findDown(g, g.rootId, 0L, g.rootLvl)) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; default: return; } } } /** * @param g Get. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result findDown(final Get g, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { long page = acquirePage(pageId); try { for (;;) { // Init args. g.pageId = pageId; g.fwdId = fwdId; Result res = read(pageId, page, search, g, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert g.pageId != pageId; assert g.fwdId != fwdId || fwdId == 0; // Go down recursively. res = findDown(g, g.pageId, g.fwdId, lvl - 1); switch (res) { case RETRY: checkInterrupted(); continue; // The child page got split, need to reread our page. default: return res; } case NOT_FOUND: assert lvl == 0 : lvl; g.row = null; // Mark not found result. return res; default: return res; } } } finally { if (g.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  A base do algoritmo de travessia da √°rvore B permaneceu inalterada: eles descem a √°rvore recursivamente para a folha desejada: se o valor estiver presente, retornam o resultado e, se n√£o, ent√£o <code>null</code> .  Aparentemente, a recurs√£o foi deixada por conveni√™ncia; as √°rvores B n√£o s√£o profundas. </p><br><p><img src="https://habrastorage.org/webt/tc/g3/0t/tcg30to_z-6fcrfegjfulubh0gq.jpeg"></p><br><p>  Fiquei surpreso porque havia uma instala√ß√£o clara em minha cabe√ßa: a recurs√£o √© sempre removida em um projeto real ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√£o h√° otimiza√ß√£o da recurs√£o final em Java</a> , a recurs√£o √© aceit√°vel em projetos em outras linguagens).  Mas, na verdade, a altura da √°rvore B √© medida em unidades, porque o tamanho do bloco de pedidos <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>10</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> 2 ^ {10} </script>  e o n√∫mero de dados do pedido <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-2"> 2 ^ {40} </script>  e a altura ser√° <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mn>4</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.975ex" height="2.901ex" viewBox="0 -935.7 10753.2 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-29" x="2962" y="0"></use></g><g transform="translate(5566,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-29" x="2962" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-3D" x="9196" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhhcV9jZDNbT_VpO1EFm2z6VCiRu4g#MJMAIN-34" x="10252" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup><mo stretchy="false">)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>10</mn></mrow></msup><mo stretchy="false">)</mo></mrow><mo>=</mo><mn>4</mn></math></span></span><script type="math/tex" id="MathJax-Element-3"> \ frac {log (2 ^ {40})} {log (2 ^ {10})} = 4 </script>  . </p><br><p>  O Apache Ignite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">adora simultaneidade</a> .  Portanto, a √°rvore suporta modifica√ß√µes competitivas.  No momento da opera√ß√£o, uma p√°gina √© bloqueada, mas outro encadeamento pode modificar o restante da √°rvore para que uma segunda leitura seja necess√°ria.  E assim o procedimento pode alcan√ßar a raiz. </p><br><p>  No come√ßo, n√£o entendi o significado dessa funcionalidade, porque o disco √© lento e um thread processa calmamente todas as opera√ß√µes de E / S.  √â claro que a pesquisa no n√≥ carregado a partir do disco custa um pouco e, durante esse tempo, voc√™ pode carregar o disco com outra opera√ß√£o, mas tentativas repetidas reduzir√£o o ganho.  No entanto, ocorreu-me que, nessa implementa√ß√£o, os n√≥s n√£o foram liberados imediatamente para o disco ap√≥s a modifica√ß√£o, mas ficaram na mem√≥ria por um tempo, para aplicar muitas modifica√ß√µes de uma s√≥ vez.  Nenhum dado √© perdido gra√ßas ao Write Ahead Log.  Mais sobre isso estar√° no final do artigo. </p><br><p>  Agora vamos ver o c√≥digo para adicionar um item. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> needOld)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ checkDestroyed(); Put p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Put(row, needOld); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. p.init(); Result res = putDown(p, p.rootId, 0L, p.rootLvl); switch (res) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; case FOUND: // We may need to insert split key into upper level here. if (!p.isFinished()) { // It must be impossible to have an insert higher than the current root, // because we are making decision about creating new root while keeping // write lock on current root, so it can't concurrently change. assert p.btmLvl &lt;= getRootLevel(); checkInterrupted(); continue; } return p.oldRow; default: throw new IllegalStateException("Result: " + res); } } } catch (IgniteCheckedException e) { throw new IgniteCheckedException("Runtime failure on row: " + row, e); } catch (RuntimeException e) { throw new IgniteException("Runtime failure on row: " + row, e); } catch (AssertionError e) { throw new AssertionError("Assertion error on row: " + row, e); } finally { checkDestroyed(); } } /** * @param p Put. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result putDown(final Put p, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { assert lvl &gt;= 0 : lvl; final long page = acquirePage(pageId); try { for (;;) { // Init args. p.pageId = pageId; p.fwdId = fwdId; Result res = read(pageId, page, search, p, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert lvl &gt; 0 : lvl; assert p.pageId != pageId; assert p.fwdId != fwdId || fwdId == 0; res = p.tryReplaceInner(pageId, page, fwdId, lvl); if (res != RETRY) // Go down recursively. res = putDown(p, p.pageId, p.fwdId, lvl - 1); if (res == RETRY_ROOT || p.isFinished()) return res; if (res == RETRY) checkInterrupted(); continue; // We have to insert split row to this level or it is a retry. case FOUND: // Do replace. assert lvl == 0 : "This replace can happen only at the bottom level."; return p.tryReplace(pageId, page, fwdId, lvl); case NOT_FOUND: // Do insert. assert lvl == p.btmLvl : "must insert at the bottom level"; assert p.needReplaceInner == FALSE : p.needReplaceInner + " " + lvl; return p.tryInsert(pageId, page, fwdId, lvl); default: return res; } } } finally { if (p.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  A √∫nica diferen√ßa √© que, ap√≥s a detec√ß√£o da posi√ß√£o, o c√≥digo bifurca-se na <code>replace</code> e <code>insert</code> .  O c√≥digo de <code>remove</code> n√£o pode mais ser assistido.  O mecanismo b√°sico √© que, com tentativas repetidas de percorrer recursivamente a √°rvore, junto com um objeto especial, dependendo da opera√ß√£o: <code>Get</code> , <code>Put</code> ou <code>Remove</code> . </p><br><p>  <code>Invoke</code> funciona da mesma maneira, apenas a opera√ß√£o ocorre com uma c√≥pia do registro, ent√£o seu tipo √© determinado: <code>NOOP</code> para leitura, <code>REMOVE</code> para excluir e <code>PUT</code> para atualizar ou adicionar e, em seguida, √© gerado o objeto <code>Put</code> ou <code>Remove</code> correspondente, que √© aplicado ao registro na √°rvore. </p><br><h1 id="ispolzovanie">  Use </h1><br><p>  Abaixo, examinarei mais de perto dois <code>BPlusTree</code> : <code>CacheDataTree</code> e <code>PendingEntriesTree</code> .  No exterior √© a implementa√ß√£o de √≠ndices - este √© um t√≥pico para uma discuss√£o separada, para a qual ainda n√£o estou pronto. </p><br><p>  Antes de <code>IgniteCache</code> , vou esclarecer que o mapa distribu√≠do local tem funcionalidade <code>IgniteCache</code> e √© chamado <code>IgniteCache</code> - a seguir, simplesmente um cache. </p><br><h2 id="cachedatatree"> <code>CacheDataTree</code> </h2> <br><p>  <code>CacheDataTree</code> √© um mapeamento de v√°rios <code>IgniteCache</code> para o disco.  A classifica√ß√£o √© multin√≠vel: primeiro classifique por ID do cache para agrupar chaves em um cache e depois por hashes. </p><br><p>  <code>CacheDataTree</code> n√£o itera no intervalo, pois os √≠ndices s√£o implementados nos herdeiros do <code>H2Tree extends BPlusTree</code> ; portanto, o tipo espec√≠fico de classifica√ß√£o n√£o √© importante: qualquer um √© suficiente para opera√ß√µes de <code>put</code> e <code>get</code> .  Comparar hashes √© mais r√°pido que objetos.  Mais importante, por√©m, um hash uniforme preencher√° a √°rvore mais densamente. </p><br><p>  As √°rvores se equilibram para que n√£o se degenerem em uma lista.  Mas se voc√™ adicionar chaves igualmente distribu√≠das √† √°rvore de pesquisa, ela ser√° automaticamente equilibrada.  Como as √°rvores B come√ßam a se equilibrar √† medida que surgem problemas, e os hashes misturam as chaves uniformemente, a classifica√ß√£o por hashes reduz a frequ√™ncia do equil√≠brio. </p><br><p>  O uso de hashes na √°rvore de pesquisa n√£o √© uma id√©ia t√£o estranha quanto parece, seu desenvolvimento l√≥gico levar√° a uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tentativa mapeada da matriz Hash</a> . </p><br><h2 id="pendingentriestree"> <code>PendingEntriesTree</code> </h2> <br><p>  <code>PendingEntriesTree</code> armazena chaves para dados ao longo do tempo e √© usado como definido.  A classifica√ß√£o √© multin√≠vel: primeiro classificada por ID de cache para agrupar chaves em um cache e depois por tempo de vida.  Em seguida, h√° outra rodada de compara√ß√£o - aparentemente, puramente t√©cnica, para distinguir entre elementos.  Ao classificar, √© f√°cil adivinhar que essa classe √© usada para pesquisar intervalos.  Essa √°rvore duplica as chaves de entrada do cache para preemp√ß√£o. </p><br><p>  Entenda como essa aventura separada funciona. </p><br><div class="spoiler">  <b class="spoiler_title">Aventura</b> <div class="spoiler_text"><p>  Em <code>IgniteCacheOffheapManagerImpl.expire()</code> pegue o cursor e exclua as entradas do <code>PendingEntriesTree</code> .  As entradas no <code>CacheDataTree</code> s√£o exclu√≠das no fechamento <code>c</code> , que √© passado nos par√¢metros. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( GridCacheContext cctx, IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount )</span></span></span></span></code> </pre> <br><p>  O Apache Ignite parou recentemente de suportar o Java 7, portanto, o fechamento √© criado por meio de uma classe an√¥nima. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; expireC = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GridCacheEntryEx entry, GridCacheVersion obsoleteVer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> touch = !entry.isNear(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.isTraceEnabled()) log.trace(<span class="hljs-string"><span class="hljs-string">"Trying to remove expired entry from cache: "</span></span> + entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entry.onTtlExpired(obsoleteVer)) touch = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (GridCacheEntryRemovedException ignore) { entry = entry.context().cache().entryEx(entry.key()); touch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (touch) entry.context().evicts().touch(entry, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } };</code> </pre><br><p>  O que estamos procurando √© no m√©todo <code>GridCacheMapEntry.onTtlExpired()</code> , onde a linha estimada est√° no bloco <code>finally</code> . </p><br><pre> <code class="java hljs">cctx.cache().removeEntry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre> </div></div><br><h1 id="detali-realizacii">  Detalhes da implementa√ß√£o </h1><br><h2 id="rabota-so-stranicami-v-offheap">  Trabalhar com p√°ginas no Offheap </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Offheap</a> √© uma t√©cnica para otimizar o gerenciamento manual de mem√≥ria em um idioma com um coletor de lixo. </p><br><p>  √â um mito que, por causa do coletor de lixo, tudo diminua, geralmente os coletores custam uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">porcentagem miser√°vel de desempenho</a> .  Mesmo grandes montes em si n√£o s√£o um problema, porque  os coletores trabalham competitivamente (por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CMS e G1</a> em Java) e os servidores possuem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dezenas de n√∫cleos</a> .  Obviamente, o coletor adiciona pausas imprevis√≠veis ao aplicativo, o que √© importante para jogos, mas toler√°vel para o banco de dados. </p><br><p>  Mas o que realmente ser√° o problema √© uma viola√ß√£o da hip√≥tese de gera√ß√£o em uma grande pilha. </p><br><div class="spoiler">  <b class="spoiler_title">Hip√≥teses de gera√ß√£o</b> <div class="spoiler_text"><p>  As otimiza√ß√µes de GC usam a hip√≥tese geracional.  Essa hip√≥tese existe em duas vers√µes: forte e fraca. </p><br><p>  <strong>Hip√≥tese geracional fraca: a</strong> maioria dos objetos morre jovem. </p><br><p>  <strong>Uma forte hip√≥tese sobre gera√ß√µes:</strong> quanto mais velho o objeto, mais ele viver√°. </p><br><p>  Uma hip√≥tese forte implica uma fraca, mas n√£o vice-versa.  Idealmente, o GC deveria se contentar em cumprir a hip√≥tese fraca, mas, na pr√°tica, n√£o √© assim. </p><br><p>  Confira a palestra de Alexey Shipilev sobre o novo GC em Java, se voc√™ quiser entender melhor o t√≥pico: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dois</a> . </p></div></div><br><p>  E aqui est√° o fato de que, antes do advento do PDS, o Apache Ignite era posicionado principalmente como um cache entre servi√ßos e um banco de dados em disco (por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hadoop</a> ).  Portanto, os mapas no Ignite s√£o chamados <code>IgniteCache</code> e t√™m a funcionalidade de extrus√£o correspondente.  E caches apenas violam a hip√≥tese geracional - neles, a probabilidade de um objeto ser exclu√≠do aumenta com o tempo.  Portanto, nesse caso, o Offheap para armazenar dados do usu√°rio melhora o desempenho. </p><br><p>  Mais b√¥nus: </p><br><ul><li>  A descompacta√ß√£o facilita a implementa√ß√£o de estruturas que cont√™m mais de elementos <code>Integer.MAX_VALUE</code> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Se voc√™ mantiver um monte de menos de 32 GB, os links ter√£o 4 bytes</a> , o que economiza alguns gigabytes. </li><li>  Como o coletor cria um gr√°fico de objetos, ele consome mem√≥ria proporcionalmente ao seu n√∫mero.  E o n√∫mero de objetos √© proporcional ao heap.  O coletor tamb√©m consome uma CPU, que √© melhor utilizada para compacta√ß√£o de dados, por exemplo. </li><li>  Em mont√µes muito grandes, mesmo que a hip√≥tese geracional n√£o seja violada como um todo, ainda haver√° muitos objetos antigos em valor absoluto que a violar√£o. </li></ul><br><p>  Como os dados s√£o ent√£o enviados para o disco, os objetos s√£o serializados na mem√≥ria diretamente por meio de <code>unsafe</code> , e essa √°rea de mem√≥ria √© usada para o buffer de E / S. </p><br><h2 id="write-ahead-log">  Gravar registro antecipado </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Write Ahead Log</a> √© um log de opera√ß√µes com uma estrutura linear, que acrescenta a ele uma constante, diferente de uma √°rvore.  A √°rvore √© atualizada com menos frequ√™ncia e, se os dados forem perdidos devido a uma queda, eles ser√£o restaurados do log aplicando opera√ß√µes a partir do √∫ltimo estado salvo.  O resultado √© um desempenho aprimorado sem comprometer a confiabilidade.  Aconselho que voc√™ d√™ uma olhada na interface <code>IgniteWriteAheadLogManager</code> - h√° documenta√ß√£o detalhada. </p><br><h2 id="obhod-uzla">  Desvio do n√≥ </h2><br><p>  Como os n√≥s nas √°rvores B n√£o s√£o pequenos, eles s√£o ignorados pela pesquisa bin√°ria.  Para isso, descendentes da classe <code>BPlusTree.GetPageHandler</code> s√£o <code>BPlusTree.GetPageHandler</code> e, para opera√ß√µes diferentes, s√£o diferentes. </p><br><div class="spoiler">  <b class="spoiler_title">Implementa√ß√£o de pesquisa bin√°ria</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findInsertionPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lvl, BPlusIO&lt;L&gt; io, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> low, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cnt, L row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shift)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> row != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> high = cnt - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (low &lt;= high) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cmp = compare(lvl, io, buf, mid, row); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift; <span class="hljs-comment"><span class="hljs-comment">// We need to fix the case when search row matches multiple data rows. //noinspection Duplicates if (cmp &lt; 0) low = mid + 1; else if (cmp &gt; 0) high = mid - 1; else return mid; // Found. } return -(low + 1); // Not found. }</span></span></code> </pre> <br><p>  O m√©todo de <code>compare</code> √© diferente para diferentes descendentes do <code>BPlusTree</code> .  Um √≠ndice negativo codifica a aus√™ncia de um elemento com a posi√ß√£o em que poderia estar.  <code>Collections.binarySearch</code> da biblioteca padr√£o faz o mesmo. </p><br><p>  Preste aten√ß√£o √†s seguintes linhas. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift;</code> </pre> <br><p>  Para a opera√ß√£o <code>findOne</code> , esse c√≥digo n√£o faz nada, porque  <code>shift</code> √© definido como zero, ou seja,  se as mesmas chaves estiverem na √°rvore, elas encontrar√£o uma arbitr√°ria. </p><br><p>  No entanto, se voc√™ procurar o intervalo dessa maneira, os elementos ser√£o perdidos; portanto, a <code>shift</code> √© definida como <code>1</code> .  Como resultado, a pesquisa <em>n√£o encontra o elemento, mesmo que esteja l√°</em> , mas n√£o √© importante pesquisar o intervalo. </p></div></div><br><h2 id="spisok-listov">  Lista de folhas </h2><br><p>  Para contornar o intervalo com efici√™ncia, as folhas s√£o vinculadas a uma lista.  <code>BPlusTree.ForwardCursor</code> , que passa de uma folha para outra, √© retornado como resultado da pesquisa.  Aparentemente, a passagem do cursor n√£o √© isolada de outras opera√ß√µes na √°rvore, porque  ao passar, o bloqueio √© realizado apenas em uma p√°gina.  N√£o encontrei um mecanismo de sincroniza√ß√£o que proteja o acesso aos m√©todos do cursor. </p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>  Como a √°rvore B + no Apache Ignite √© jovem em compara√ß√£o com outros bancos de dados relacionais, obtemos o conjunto necess√°rio para a √°rvore B + pronta para produ√ß√£o: </p><br><ul><li>  <strong>O WAL</strong> oferece seguran√ßa barata, como resultado, a √°rvore raramente √© atualizada no disco. </li><li>  <strong>Fora da pilha</strong> com dados em formato serializado. </li><li>  <strong>Concorr√™ncia</strong> - para partes da √°rvore carregadas na mem√≥ria. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413749/">https://habr.com/ru/post/pt413749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413739/index.html">Como digitalizamos toda a Internet e o que aprendemos</a></li>
<li><a href="../pt413741/index.html">O que era e como: impress√µes da equipe WWDC Redmadrobot</a></li>
<li><a href="../pt413743/index.html">Inicie o LAMP e centenas de outros aplicativos da web em apenas alguns cliques</a></li>
<li><a href="../pt413745/index.html">Um sistema de energia sem fio foi desenvolvido para todos os componentes eletr√¥nicos do corpo humano de uma s√≥ vez</a></li>
<li><a href="../pt413747/index.html">Passando por NULL</a></li>
<li><a href="../pt413751/index.html">Ruslan Cheremin e Maxim Gramin - trabalhem com o meio ambiente em jug.msk.ru</a></li>
<li><a href="../pt413753/index.html">Olho no c√©u: zang√£o-patrulha com reconhecimento da viol√™ncia em multid√µes e locais p√∫blicos</a></li>
<li><a href="../pt413757/index.html">Banco de dados em um projeto comercial: o que fazer?</a></li>
<li><a href="../pt413759/index.html">A curiosidade descobriu org√¢nicos em Marte, com bilh√µes de anos</a></li>
<li><a href="../pt413761/index.html">Como impedir que o Windows 10 seja reiniciado ap√≥s atualiza√ß√µes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>