<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôãüèª üôéüèæ üë®üèª‚Äçüíº Controlador de ar condicionado dom√©stico sem fio do OpenHAB via Modbus via RF24Network üö© üë®üèº‚Äçüé® üôãüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Depois do meu primeiro artigo sobre como controlar o ar condicionado com um controlador, passaram-se pouco mais de 2 anos. Durante esse per√≠odo, a id√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Controlador de ar condicionado dom√©stico sem fio do OpenHAB via Modbus via RF24Network</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384243/"><img align="left" src="https://habrastorage.org/files/1d4/8ed/b4b/1d48edb4b2b24079a0e2a7e7d5d7e584.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois do </font><font style="vertical-align: inherit;">meu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> artigo sobre como controlar o ar condicionado com um controlador, passaram-se pouco mais de 2 anos. </font><font style="vertical-align: inherit;">Durante esse per√≠odo, a id√©ia de controlar o ar condicionado remotamente n√£o me deixou e teve v√°rios renascimentos. </font><font style="vertical-align: inherit;">A principal condi√ß√£o era a aus√™ncia de fios no ar condicionado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, o controle do controlador deve ser sem fio.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro prot√≥tipo foi o Arduino UNO. Ela aceitou equipes no UART e sabia como ligar e desligar o ar condicionado. Porque havia pouco senso pr√°tico do arduinka conectado ao computador de trabalho, a cabe√ßa procurava constantemente a oportunidade de conectar o √∫ltimo ao servidor dom√©stico. N√£o havia visibilidade direta do servidor para o culpado de todos os quebra-cabe√ßas. O m√°ximo √© um soquete com uma LAN no mesmo computador de trabalho - j√° que fica quase em frente ao ar condicionado. Um escudo Ethernet n√£o estava dispon√≠vel. Mas lembrando que em algum lugar do zashashnik existe um modem DSL-2500U dsl d-link que n√£o √© usado h√° muito tempo, com apenas uma porta a bordo. O desejo de dar uma segunda vida ao peda√ßo de ferro levou √† pesquisa, que, por sua vez, miraculosamente levou ao artigo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transformando um modem ADSL em um escudo Ethernet para o Arduino / CraftDuino</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avan√ßando e pulando o interessante processo de cria√ß√£o de firmware personalizado, ainda consegui fazer o modem escutar na porta desejada e "encaminhar" o UART atrav√©s dele. </font><font style="vertical-align: inherit;">Assim, no servidor dom√©stico, eu poderia enviar um comando para ativar / desativar a porta para o endere√ßo do modem local, que ir√° para o arduino conectado a ela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas este artigo n√£o √© sobre isso. </font><font style="vertical-align: inherit;">A solu√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definitiva</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa o protocolo Modbus e a rede sem fio </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">RF24Network</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">E tudo √© controlado no OpenHAB.</font></font><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante esses dois anos, consegui encomendar muitos de todos os nishtyaks da China e a maioria deles estava esperando nos bastidores. </font><font style="vertical-align: inherit;">Esta lista inclu√≠a o m√≥dulo NRF24L01 +, comprado por um punhado para experimenta√ß√£o. </font><font style="vertical-align: inherit;">E ele teria ido mais longe em algum lugar do arm√°rio ocioso, se um dia eu n√£o tivesse encontrado uma s√©rie de artigos:</font></font><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como fazer amigos OpenHAB e Arduino</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino e Modbus</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino e OpenHAB</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
de  </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Borich</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obrigado por isso! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gra√ßas a eles, me familiarizei com o protocolo Modbus. </font><font style="vertical-align: inherit;">Mas o mais importante, eu descobri o OpenHAB para mim - o que venho procurando h√° muito tempo. </font><font style="vertical-align: inherit;">Isso me levou a come√ßar a implementar id√©ias de longa data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tendo brincado com exemplos dos artigos, decidi tentar separar o controlador e o servidor usando a blindagem Ethernet do modem descrito acima. </font><font style="vertical-align: inherit;">Essa solu√ß√£o nos permitiu realizar a tarefa proposta - o escudo e o controlador estavam localizados na √°rea de trabalho, sem usar um computador em funcionamento, ao mesmo tempo, o escudo est√° sempre conectado √† rede local e acess√≠vel a partir do servidor dom√©stico.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas essa decis√£o estava fadada ao fracasso.</font></font></b><div class="spoiler_text">     ModbusRtu over TCP   .    modpoll,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Arduino &amp; Modbus</a>  .     ‚Äî          192.168.1.110   3000  !<br>
<br>
    OpenHAB. ,  , Modbus Binding   ¬´RTU over TCP¬ª.        ‚Äî     ModbusRtu   c      TCP.            OpenHAB-(ethernet)--(UART)-.<br>
<br>
 ,   ?      Item  .      1 Item     .      ‚Äî      . ,   ,    TCP    Modbus Binding. ..              .<br>
<br>
   Modbus Binding     Item'   host-port-slaveID     .<br>
<br>
        ,     .                .       ,    .<br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Id√©ia</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o finalmente me estabeleci que precisava criar um controlador acess√≠vel por via a√©rea. </font><font style="vertical-align: inherit;">Os m√≥dulos NRF24L01 + n√£o devem desaparecer! .. √â verdade que isso requer pelo menos dois controladores - um desempenha um papel direto, o segundo desempenha o papel de um roteador. </font><font style="vertical-align: inherit;">O segundo deve estar conectado ao servidor e √© atrav√©s dele que √© realizada a comunica√ß√£o sem fio com os outros. </font><font style="vertical-align: inherit;">Ao conectar-se a ele, especificamos o ID do subordinado a quem o pacote se destina. </font><font style="vertical-align: inherit;">Acontece que muitos escravos est√£o dispon√≠veis em uma porta serial. </font><font style="vertical-align: inherit;">Sim - esta √© uma rede sem fio baseada em Modbus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Modbus, ali√°s, permitiu que um mestre constru√≠sse uma rede - muitos subordinados. </font><font style="vertical-align: inherit;">E a biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RF24Network</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para tornar tudo sem fio e at√© com roteamento autom√°tico entre n√≥s da rede.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desenvolvimento de bibliotecas para Arduino</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar essa solu√ß√£o, demorou um pouco para modificar a biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Master-Slave-for-Arduino</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para poder herdar dela e sobrecarregar alguns m√©todos. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minha implementa√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamb√©m </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">√©</font></a><font style="vertical-align: inherit;"> atualizada (library.properties √© adicionada, o arquivo da biblioteca √© dividido em cabe√ßalho e corpo) para o Arduino IDE 1.6.5 mais recente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-over-RF24Network-for-Arduino</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite implementar dois comportamentos poss√≠veis - Proxy e Escravo. </font><font style="vertical-align: inherit;">Exemplo O ModbusRF24Proxy √© na verdade uma implementa√ß√£o de um ‚Äúroteador‚Äù e n√£o requer outras modifica√ß√µes al√©m da configura√ß√£o dos pinos necess√°rios.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo de ModbusRF24Proxy</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24Network.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtu.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtuRF24.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> stlPin  13  <span class="hljs-comment">//     (   Arduino)</span></span><font></font>
<font></font>
<span class="hljs-comment">// nRF24L01(+) radio attached using Getting Started board </span><font></font>
<span class="hljs-function">RF24 <span class="hljs-title">radio</span><span class="hljs-params">(<span class="hljs-number">9</span>, <span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Network uses that radio</span><font></font>
<span class="hljs-function">RF24Network <span class="hljs-title">network</span><span class="hljs-params">(radio)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Address of our node</span><font></font>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-comment">//  ,   TX</span><font></font>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">proxy</span><span class="hljs-params">(network, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;<font></font>
<span class="hljs-keyword">int8_t</span> state = <span class="hljs-number">0</span>;<font></font>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> tempus;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<font></font>
    <span class="hljs-comment">//    </span><font></font>
    io_setup();<font></font>
    <span class="hljs-comment">//    </span><font></font>
<font></font>
    proxy.begin(<span class="hljs-number">57600</span>);<font></font>
<font></font>
    SPI.begin();<font></font>
    radio.begin();<font></font>
    network.begin(<span class="hljs-comment">/*channel*/</span> <span class="hljs-number">90</span>, <span class="hljs-comment">/*node address*/</span> this_node);<font></font>
<font></font>
    <span class="hljs-comment">//    100 </span><font></font>
    tempus = millis() + <span class="hljs-number">100</span>;<font></font>
    digitalWrite(stlPin, HIGH);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_setup</span><span class="hljs-params">()</span> </span>{<font></font>
    digitalWrite(stlPin, HIGH);<font></font>
    pinMode(stlPin, OUTPUT);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">// Pump the network regularly</span><font></font>
    network.update();<font></font>
<font></font>
    <span class="hljs-comment">//  </span><font></font>
    state = proxy.proxy();<font></font>
<font></font>
    <span class="hljs-comment">//      -    50  </span><font></font>
    <span class="hljs-keyword">if</span> (state &gt; <span class="hljs-number">4</span>) {<font></font>
        tempus = millis() + <span class="hljs-number">50</span>;<font></font>
        digitalWrite(stlPin, HIGH);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (millis() &gt; tempus) digitalWrite(stlPin, LOW);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um roteador ou proxy usa um formato especial de construtor:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  ,   TX</span><font></font>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">proxy</span><span class="hljs-params">(network, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e fun√ß√£o </font></font><br>
<pre><code class="cpp hljs">proxy.proxy();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para processar pacotes recebidos na porta serial, envie-os para a RF24Network, receba uma resposta da rede, envie o resultado de volta para a porta serial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta implementa√ß√£o, o proxy tem um endere√ßo RF24Network zero:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Address of our node</span><font></font>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = <span class="hljs-number">0</span>;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - ou seja, </font><font style="vertical-align: inherit;">este √© o dispositivo raiz da rede. </font><font style="vertical-align: inherit;">Se necess√°rio, a posi√ß√£o na topologia do controlador proxy pode ser alterada.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo de Modbus RF24Slave</font></font></b><div class="spoiler_text">    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Arduino &amp; Modbus</a>:<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24Network.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtu.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtuRF24.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ID   1      <span class="hljs-comment">//  </span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> btnPin  2   <span class="hljs-comment">//  ,   </span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ledPin  7  <span class="hljs-comment">//   </span></span><font></font>
<font></font>
<span class="hljs-comment">// nRF24L01(+) radio attached using Getting Started board </span><font></font>
<span class="hljs-function">RF24 <span class="hljs-title">radio</span><span class="hljs-params">(<span class="hljs-number">9</span>, <span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Network uses that radio</span><font></font>
<span class="hljs-function">RF24Network <span class="hljs-title">network</span><span class="hljs-params">(radio)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Address of our node</span><font></font>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = ID;<font></font>
<font></font>
<span class="hljs-comment">//  </span><font></font>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">slave</span><span class="hljs-params">(network, ID)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">//   modbus</span><font></font>
<span class="hljs-keyword">uint16_t</span> au16data[<span class="hljs-number">11</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_setup</span><span class="hljs-params">()</span> </span>{<font></font>
    digitalWrite(ledPin, LOW);<font></font>
    pinMode(ledPin, OUTPUT);<font></font>
    pinMode(btnPin, INPUT);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_poll</span><span class="hljs-params">()</span> </span>{<font></font>
    <span class="hljs-comment">// Coil[1]  Discrete[0]</span><font></font>
    au16data[<span class="hljs-number">0</span>] = au16data[<span class="hljs-number">1</span>];<font></font>
    <span class="hljs-comment">//   1.3   </span><font></font>
    digitalWrite(ledPin, bitRead(au16data[<span class="hljs-number">1</span>], <span class="hljs-number">3</span>));<font></font>
    <span class="hljs-comment">//     0.3</span><font></font>
    bitWrite(au16data[<span class="hljs-number">0</span>], <span class="hljs-number">3</span>, digitalRead(btnPin));<font></font>
    <span class="hljs-comment">// Holding[5,6,7]  Input[2,3,4]</span><font></font>
    au16data[<span class="hljs-number">2</span>] = au16data[<span class="hljs-number">5</span>];<font></font>
    au16data[<span class="hljs-number">3</span>] = au16data[<span class="hljs-number">6</span>];<font></font>
    au16data[<span class="hljs-number">4</span>] = au16data[<span class="hljs-number">7</span>];<font></font>
    <span class="hljs-comment">//    </span><font></font>
    au16data[<span class="hljs-number">8</span>] = slave.getInCnt();<font></font>
    au16data[<span class="hljs-number">9</span>] = slave.getOutCnt();<font></font>
    au16data[<span class="hljs-number">10</span>] = slave.getErrCnt();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<font></font>
    <span class="hljs-comment">//    </span><font></font>
    io_setup();<font></font>
<font></font>
    Serial.begin(<span class="hljs-number">57600</span>);<font></font>
    Serial.println(<span class="hljs-string">"RF24Network/examples/modbus_slave/"</span>);<font></font>
<font></font>
    SPI.begin();<font></font>
    radio.begin();<font></font>
    network.begin(<span class="hljs-comment">/*channel*/</span> <span class="hljs-number">90</span>, <span class="hljs-comment">/*node address*/</span> this_node);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">// Pump the network regularly</span><font></font>
    network.update();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (network.available()) {<font></font>
        slave.poll(au16data, <span class="hljs-number">11</span>);<font></font>
    }<font></font>
    <span class="hljs-comment">//    Modbus    </span><font></font>
    io_poll();<font></font>
}<font></font>
</code></pre><br>
<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O construtor neste caso j√° √© diferente:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  </span><font></font>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">slave</span><span class="hljs-params">(network, ID)</span></span>;<font></font>
</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estrutura de Registro Modbus</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s as primeiras tentativas bem-sucedidas de controlar o ar condicionado, a capacidade de ligar e desligar apenas meu apetite aumentou. </font><font style="vertical-align: inherit;">Agora isso j√° n√£o era suficiente e, como tenho a funcionalidade OpenHAB no meu aplicativo m√≥vel, ele deve fazer no m√≠nimo toda a funcionalidade do painel de controle nativo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso significa que aqui est√° uma lista de recursos pelo menos:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indica√ß√£o de status atual</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ligar e desligar o ar condicionado, modos individuais (O </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ioniza√ß√£o, modo silencioso);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sele√ß√£o do modo atual (autom√°tico, aquecimento, refrigera√ß√£o, drenagem, ventilador);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indica√ß√£o de temperatura e velocidade do ventilador para cada modo. </font><font style="vertical-align: inherit;">Para o modo de ventilador, apenas velocidade;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuste da cortina vertical (autom√°tico, 0 ¬∞, 15 ¬∞, 30 ¬∞, 45 ¬∞, 60 ¬∞);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configura√ß√£o de cortina horizontal (autom√°tico, "| |", "/ /", "/ |", "| \", "\ \");</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuste de hora (hora, minuto);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na configura√ß√£o do temporizador;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configura√ß√£o de desligamento do timer;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configura√ß√£o no hor√°rio (hora, minuto);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configura√ß√£o do tempo de desligamento (hora, minuto);</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante o processo de desenvolvimento, a estrutura dos registros mudou muitas vezes comigo. </font><font style="vertical-align: inherit;">A vers√£o atual est√° abaixo do spoiler.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registradores Modbus</font></font></b><div class="spoiler_text"><table>
<tbody><tr>
<th>Type</th>
<th>Byte</th>
<th>Bit</th>
<th>Name</th>
<th></th>
</tr>
<tr>
<td>Bit RO</td>
<td>0</td>
<td>0</td>
<td>CFG_OXYGEN</td>
<td>1 ‚Äî   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>1</td>
<td>CFG_ION</td>
<td>1 ‚Äî   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>2</td>
<td>CFG_QUIET</td>
<td>1 ‚Äî   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>3</td>
<td>CFG_TIMER</td>
<td>1 ‚Äî  /   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>4</td>
<td>CFG_DELAY</td>
<td>1 ‚Äî   /</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>5</td>
<td>CFG_SWING</td>
<td>1 ‚Äî   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>6</td>
<td>CFG_SWINGH</td>
<td>1 ‚Äî    </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>7</td>
<td>CFG_SWINGV</td>
<td>1 ‚Äî    </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>8</td>
<td>CFG_CLOCK</td>
<td>1 ‚Äî  </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>9</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>10</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>11</td>
<td>CFG_AUTO</td>
<td>1 ‚Äî   AUTO</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>12</td>
<td>CFG_COOL</td>
<td>1 ‚Äî   COOL</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>13</td>
<td>CFG_HEAT</td>
<td>1 ‚Äî   HEAT</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>14</td>
<td>CFG_DRY</td>
<td>1 ‚Äî   DRY</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>15</td>
<td>CFG_FAN</td>
<td>1 ‚Äî   FAN</td>
</tr>
<tr>
<td>Integer RO</td>
<td>1</td>
<td></td>
<td>CFG_TEMP</td>
<td>.  . : Min + Max*256</td>
</tr>
<tr>
<td>Integer RO</td>
<td>2</td>
<td></td>
<td>CFG_FAN_SPEED</td>
<td>  FAN</td>
</tr>
<tr>
<td>Bit RO</td>
<td>3</td>
<td>0</td>
<td>STATE_POWER</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>1</td>
<td>STATE_OXYGEN</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>2</td>
<td>STATE_ION</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>3</td>
<td>STATE_QUIET</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>4</td>
<td>STATE_TIMER</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>8</td>
<td>CONTROL_POWER</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>9</td>
<td>CONTROL_OXYGEN</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>10</td>
<td>CONTROL_ION</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>11</td>
<td>CONTROL_QUIET</td>
<td></td>
</tr>
<tr>
<td>Integer RO</td>
<td>4</td>
<td></td>
<td>RTC_HR_MI</td>
<td>0x1308</td>
</tr>
<tr>
<td>Integer RW</td>
<td>5</td>
<td></td>
<td>RTCW_HR_MI</td>
<td>0x1308</td>
</tr>
<tr>
<td>Integer RO</td>
<td>6</td>
<td></td>
<td>TEMPERATURE1</td>
<td> . INT16,   </td>
</tr>
<tr>
<td>Integer RO</td>
<td>7</td>
<td></td>
<td>TEMPERATURE2</td>
<td> . INT16,   </td>
</tr>
<tr>
<td>Bit RW</td>
<td>8</td>
<td>0</td>
<td>MODE_AUTO</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>MODE_COOL</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>MODE_HEAT</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>MODE_DRY</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>MODE_FAN</td>
<td></td>
</tr>
<tr>
<td>Integer RW</td>
<td>9</td>
<td></td>
<td>TEMP_AUTO</td>
<td> AUTO</td>
</tr>
<tr>
<td>Integer RW</td>
<td>10</td>
<td></td>
<td>TEMP_COOL</td>
<td> COOL</td>
</tr>
<tr>
<td>Integer RW</td>
<td>11</td>
<td></td>
<td>TEMP_HEAT</td>
<td> HEAT</td>
</tr>
<tr>
<td>Integer RW</td>
<td>12</td>
<td></td>
<td>TEMP_DRY</td>
<td> DRY</td>
</tr>
<tr>
<td>Integer RW</td>
<td>13</td>
<td></td>
<td>FAN_AUTO</td>
<td> AUTO. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>14</td>
<td></td>
<td>FAN_COOL</td>
<td> COOL. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>15</td>
<td></td>
<td>FAN_HEAT</td>
<td> HEAT. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>16</td>
<td></td>
<td>FAN_DRY</td>
<td> DRY. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>17</td>
<td></td>
<td>FAN_SPEED</td>
<td> FAN. 0: Auto</td>
</tr>
<tr>
<td>Bit RW</td>
<td>18</td>
<td>0</td>
<td>SWING_AUTO</td>
<td> </td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>SWINGV_0</td>
<td>   0¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>SWINGV_15</td>
<td>   15¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>SWINGV_30</td>
<td>   30¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>SWINGV_45</td>
<td>   45¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>5</td>
<td>SWINGV_60</td>
<td>   60¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td>19</td>
<td>0</td>
<td>SWINGH_AUTO</td>
<td> </td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>SWINGH_VV</td>
<td>  | &nbsp;|</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>SWINGH_LL</td>
<td>  / &nbsp;/</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>SWINGH_LV</td>
<td>  / &nbsp;|</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>SWINGH_VR</td>
<td>  | &nbsp;\</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>5</td>
<td>SWINGH_RR</td>
<td>  \ &nbsp;\</td>
</tr>
<tr>
<td>Bit RW</td>
<td>20</td>
<td>0</td>
<td>TIMER_ON</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>TIMER_OFF</td>
<td></td>
</tr>
<tr>
<td>Integer RW</td>
<td>21</td>
<td></td>
<td>TIME_ON_HOUR</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>22</td>
<td></td>
<td>TIME_ON_MINUTE</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>23</td>
<td></td>
<td>TIME_OFF_HOUR</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>24</td>
<td></td>
<td>TIME_OFF_MINUTE</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>25</td>
<td></td>
<td>DS18B20_ENV</td>
<td>. </td>
</tr>
<tr>
<td>Integer RW</td>
<td>26</td>
<td></td>
<td>DS18B20_NOZ</td>
<td>. </td>
</tr>
</tbody></table><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os registradores s√£o organizados de tal maneira que toda a matriz de dados √© inicializada na EEPROM quando o controlador √© iniciado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os tr√™s primeiros registros (CFG_ *) cont√™m a configura√ß√£o dos recursos, nunca mudam e s√£o inicializados pelo firmware da EEPROM. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os registros 3-7 sempre exibem o estado atual do controlador. Os bits altos do registro 3 s√£o usados ‚Äã‚Äãpara mudar de estado. Suas altera√ß√µes iniciam a ativa√ß√£o / desativa√ß√£o do ar condicionado e modos especiais. Depois que o comando √© executado, os bits de baixa ordem deste registrador s√£o copiados para os de alta ordem. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O registro 4 cont√©m o tempo atual do controlador, que √© lido no RTC. O valor √© salvo no formato BCD, de modo que, quando o registro √© exibido em nota√ß√£o hexadecimal, a hora √© lida como est√° - 12:34 √© 0x1234. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O registro 5 √© usado para alterar o hor√°rio do RTC.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os registros 6-7 cont√™m a temperatura dos sensores DS18B20. </font><font style="vertical-align: inherit;">O valor cont√©m um n√∫mero inteiro assinado e √© igual a T * 100, ou seja, </font><font style="vertical-align: inherit;">25,67 ¬∞ C = 2567. </font><font style="vertical-align: inherit;">√â fornecido um m√°ximo de 2 sensores, mas o n√∫mero pode ser facilmente alterado expandindo a tabela de registros para armazenar os endere√ßos dos sensores e suas temperaturas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os √∫ltimos 2 bytes do endere√ßo do sensor s√£o armazenados nos registros 25-26. </font><font style="vertical-align: inherit;">Ao trocar de sensor, redefina o registro de endere√ßo correspondente. </font><font style="vertical-align: inherit;">Quando um novo sensor √© detectado, seu endere√ßo √© verificado quanto √† presen√ßa nos registros 25-26. </font><font style="vertical-align: inherit;">Se o endere√ßo estiver na tabela, o valor da temperatura do sensor √© inserido no registro correspondente 6-7. </font><font style="vertical-align: inherit;">Se o endere√ßo n√£o estiver na tabela e a tabela tiver zero c√©lulas, o endere√ßo atual do sensor ser√° gravado em uma c√©lula livre. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os registros 8 a 26, quando modificados pelo usu√°rio, s√£o salvos na EEPROM.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gl√¢ndulas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O hardware consiste nos seguintes componentes:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Pro Mini. </font></font><div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><img src="https://habrastorage.org/files/e8a/460/33b/e8a46033b9cf45609d87e9a08f9f4ba9.png" alt="Arduino Pro Mini NEW"></div></div></li>
<li>NRF24L01+ ‚Äî   2.4</li>
<li>LM1117-3.3 ‚Äî  3.3  NRF24L01+</li>
<li>DS1302 ‚Äî RTC</li>
<li> 32768  RTC</li>
<li>DS18B20 ‚Äî  . 2</li>
<li> ‚Äî , , </li>
</ol><br>
<br>
<img src="https://habrastorage.org/files/b4f/6f2/357/b4f6f2357e044c78a3472d4d6b25ad07.jpg"><br>
<img src="https://habrastorage.org/files/025/6de/902/0256de902fed444682fc2e16f3e9be88.jpg"><br>
<img src="https://habrastorage.org/files/e45/604/4aa/e456044aabe0499c9b8016d908411434.jpg"><br>
<img src="https://habrastorage.org/files/3f2/818/d9a/3f2818d9af814ffba67ed9e271c1450d.jpg"><br>
<img src="https://habrastorage.org/files/f76/385/124/f76385124e4e4c2ca573b268365f5e40.jpg"><br>
<img src="https://habrastorage.org/files/be6/ded/b3c/be6dedb3c93a40fe9841a17dead1b723.jpg"><br>
<img src="https://habrastorage.org/files/80a/50c/1b7/80a50c1b7e154c87ae07296e704d6674.jpg"><br>
<img src="https://habrastorage.org/files/a5b/f61/96e/a5bf6196ee764f90bf535df517477363.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O feedback com o ar condicionado √© realizado conectando os acopladores √≥pticos aos LEDs correspondentes. Assim, √© garantido o isolamento galv√¢nico com o circuito el√©trico do ar condicionado. A corrente das entradas para os acopladores √≥pticos foi selecionada experimentalmente usando resistores, para que a sa√≠da do acoplador √≥ptico se abra e o brilho do LED principal no ar condicionado n√£o diminua. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um LED de infravermelho foi instalado pr√≥ximo ao receptor de infravermelho do ar condicionado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O controlador √© alimentado por carregamento mini-USB de algum tipo de milagre chin√™s. Os contatos de tens√£o da rede chinesa foram removidos do estojo de carregamento e os fios foram removidos. O carregamento se instalou nas entranhas do gabinete do ar-condicionado, conectado √† entrada 220 em paralelo. O controlador se conecta ao carregamento com um cabo USB AB comum.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O controlador "roteador" √© baseado no Arduino Mega2560 e NRF24L01 + com um LM1117-3.3 separado. </font><font style="vertical-align: inherit;">Al√©m de uma fonte de alimenta√ß√£o 3.3 separada, um eletr√≥lito √© conectado ao m√≥dulo sem fio (eu o encontrei em 470uf * 16v) ‚Äã‚Äãnas pernas de energia. </font><font style="vertical-align: inherit;">Como voc√™ sabe, o barramento de energia interno Mega2560 3.3V √© muito barulhento e o m√≥dulo se recusou a transmitir dados, embora tenha respondido corretamente. </font><font style="vertical-align: inherit;">Mas mesmo com uma fonte de alimenta√ß√£o separada sem capacitor, a conex√£o era muito inst√°vel. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que o mega2560 n√£o seja redefinido ao abrir a porta via USB, um eletr√≥lito de 10Œºf √© conectado ao pino de redefini√ß√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openhab</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artigo Arduino e OpenHAB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descreve um recurso do plug-in Modbus Binding, que a cada pesquisa do controlador, o plug-in envia um evento ao barramento, mesmo que nada tenha mudado. </font><font style="vertical-align: inherit;">Eu segui o exemplo e finalizei o plugin.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√£o do plugin de liga√ß√£o Modbus</font></font></b><div class="spoiler_text">#<br>
modbus:serial.ac_hall_state.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_state.id=1<br>
modbus:serial.ac_hall_state.start=48<br>
modbus:serial.ac_hall_state.length=5<br>
modbus:serial.ac_hall_state.type=discrete<br>
<br>
#<br>
modbus:serial.ac_hall_power.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_power.id=1<br>
modbus:serial.ac_hall_power.start=56<br>
modbus:serial.ac_hall_power.length=4<br>
modbus:serial.ac_hall_power.type=coil<br>
<br>
#<br>
modbus:serial.ac_hall_rtc.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_rtc.id=1<br>
modbus:serial.ac_hall_rtc.start=4<br>
modbus:serial.ac_hall_rtc.length=1<br>
modbus:serial.ac_hall_rtc.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_temperature.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_temperature.id=1<br>
modbus:serial.ac_hall_temperature.start=6<br>
modbus:serial.ac_hall_temperature.length=2<br>
modbus:serial.ac_hall_temperature.type=holding<br>
modbus:serial.ac_hall_temperature.valuetype=int16<br>
<br>
#<br>
modbus:serial.ac_hall_mode.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_mode.id=1<br>
modbus:serial.ac_hall_mode.start=8<br>
modbus:serial.ac_hall_mode.length=1<br>
modbus:serial.ac_hall_mode.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_temp.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_temp.id=1<br>
modbus:serial.ac_hall_temp.start=9<br>
modbus:serial.ac_hall_temp.length=4<br>
modbus:serial.ac_hall_temp.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_fan.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_fan.id=1<br>
modbus:serial.ac_hall_fan.start=13<br>
modbus:serial.ac_hall_fan.length=5<br>
modbus:serial.ac_hall_fan.type=holding<br>
<br>
#<br>
modbus:serial.ac_hall_swing.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_swing.id=1<br>
modbus:serial.ac_hall_swing.start=18<br>
modbus:serial.ac_hall_swing.length=2<br>
modbus:serial.ac_hall_swing.type=holding<br>
<br>
#<br>
modbus:serial.ac_hall_timer.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_timer.id=1<br>
modbus:serial.ac_hall_timer.start=320<br>
modbus:serial.ac_hall_timer.length=2<br>
modbus:serial.ac_hall_timer.type=coil<br>
<br>
# <br>
modbus:serial.ac_hall_timer_time.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_timer_time.id=1<br>
modbus:serial.ac_hall_timer_time.start=21<br>
modbus:serial.ac_hall_timer_time.length=4<br>
modbus:serial.ac_hall_timer_time.type=holding<br>
<br>
#  DS18B20<br>
modbus:serial.ac_hall_ds18b20.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_ds18b20.id=1<br>
modbus:serial.ac_hall_ds18b20.start=25<br>
modbus:serial.ac_hall_ds18b20.length=2<br>
modbus:serial.ac_hall_ds18b20.type=holding<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√µes de itens</font></font></b><div class="spoiler_text"><pre>Contact AC_HALL_STATE_POWER             "AC_HALL_STATE_POWER [MAP(air_cond.map):%s]"    (){modbus="ac_hall_state:0"}<font></font>
Contact AC_HALL_STATE_OXYGEN            "AC_HALL_STATE_OXYGEN [MAP(air_cond.map):%s]"   (){modbus="ac_hall_state:1"}<font></font>
Contact AC_HALL_STATE_ION               "AC_HALL_STATE_ION [MAP(air_cond.map):%s]"      (){modbus="ac_hall_state:2"}<font></font>
Contact AC_HALL_STATE_QUIET             "AC_HALL_STATE_QUIET [MAP(air_cond.map):%s]"    (){modbus="ac_hall_state:3"}<font></font>
Contact AC_HALL_STATE_TIMER             "[MAP(air_cond.map):%s]"                  (){modbus="ac_hall_state:4"}<font></font>
<font></font>
Switch  AC_HALL_CONTROL_POWER           ""                   &lt;climate&gt;       (){modbus="ac_hall_power:0"}<font></font>
Switch  AC_HALL_CONTROL_OXYGEN          " O2"                                  (){modbus="ac_hall_power:1"}<font></font>
Switch  AC_HALL_CONTROL_ION             ""                                     (){modbus="ac_hall_power:2"}<font></font>
Switch  AC_HALL_CONTROL_QUIET           " "                                   (){modbus="ac_hall_power:3"}<font></font>
<font></font>
Number  AC_HALL_RTC                     "RTC[%x]"                                       (){modbus="ac_hall_rtc:0"}<font></font>
String  AC_HALL_RTC_S                   " [%s]"         &lt;clock&gt;         ()<font></font>
<font></font>
Group   gAC_HALL_TEMPERATURE            "Living Room temp"<font></font>
<font></font>
Number  AC_HALL_TEMPERATURE_ENV         "[%d]"                                   (){modbus="ac_hall_temperature:0"}<font></font>
Number  AC_HALL_TEMPERATURE_NOZ         "[%d]"                                     (){modbus="ac_hall_temperature:1"}<font></font>
Number  AC_HALL_TEMPERATURE_ENVF        " [%.2f ¬∞C]"     &lt;temperature&gt;           (gAC_HALL_TEMPERATURE)<font></font>
Number  AC_HALL_TEMPERATURE_NOZF        " [%.2f ¬∞C]"       &lt;temperature&gt;           (gAC_HALL_TEMPERATURE)<font></font>
<font></font>
Number  AC_HALL_DS18B20_ENV             "ENV[%x]"                                       (){modbus="ac_hall_ds18b20:0"}<font></font>
Number  AC_HALL_DS18B20_NOZ             "NOZZLES[%x]"                                   (){modbus="ac_hall_ds18b20:1"}<font></font>
<font></font>
Number  AC_HALL_MODE                    ""                                              (){modbus="ac_hall_mode:0"}<font></font>
<font></font>
Number  AC_HALL_TEMP_AUTO               "[%d ¬∞C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:0"}<font></font>
Number  AC_HALL_TEMP_COOL               "[%d ¬∞C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:1"}<font></font>
Number  AC_HALL_TEMP_HEAT               "[%d ¬∞C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:2"}<font></font>
Number  AC_HALL_TEMP_DRY                "[%d ¬∞C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:3"}<font></font>
<font></font>
Number  AC_HALL_FAN_AUTO                "[%d]"                                  (){modbus="ac_hall_fan:0"}<font></font>
Number  AC_HALL_FAN_COOL                "[%d]"                                  (){modbus="ac_hall_fan:1"}<font></font>
Number  AC_HALL_FAN_HEAT                "[%d]"                                  (){modbus="ac_hall_fan:2"}<font></font>
Number  AC_HALL_FAN_DRY                 "[%d]"                                  (){modbus="ac_hall_fan:3"}<font></font>
Number  AC_HALL_FAN_SPEED               "[%d]"                                  (){modbus="ac_hall_fan:4"}<font></font>
<font></font>
Number  AC_HALL_SWINGV                  ""                                              (){modbus="ac_hall_swing:0"}<font></font>
Number  AC_HALL_SWINGH                  ""                                              (){modbus="ac_hall_swing:1"}<font></font>
<font></font>
Switch  AC_HALL_TIMER_ON                " "              &lt;clock&gt;         (){modbus="ac_hall_timer:0"}<font></font>
Switch  AC_HALL_TIMER_OFF               " "             &lt;clock&gt;         (){modbus="ac_hall_timer:1"}<font></font>
<font></font>
Number  AC_HALL_TIME_ON_HR              "[%02d]"                                     (){modbus="ac_hall_timer_time:0"}<font></font>
Number  AC_HALL_TIME_ON_MI              "[%02d]"                                  (){modbus="ac_hall_timer_time:1"}<font></font>
Number  AC_HALL_TIME_OFF_HR             "[%02d]"                                     (){modbus="ac_hall_timer_time:2"}<font></font>
Number  AC_HALL_TIME_OFF_MI             "[%02d]"                                  (){modbus="ac_hall_timer_time:3"}<font></font>
</pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As regras s√£o usadas para converter temperaturas inteiras em reais, bem como para formatar o tempo do controlador no formato HH: MM.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√µes de regras</font></font></b><div class="spoiler_text"><pre>import org.openhab.core.library.types.*<font></font>
import org.openhab.core.persistence.*<font></font>
import org.openhab.model.script.actions.*<font></font>
import java.io.File<font></font>
<font></font>
rule "Update AC_HALL ENV temp"<font></font>
        when<font></font>
                Item AC_HALL_TEMPERATURE_ENV received update<font></font>
        then<font></font>
                var Number T = AC_HALL_TEMPERATURE_ENV.state as DecimalType<font></font>
                var Number H = T/100<font></font>
                postUpdate(AC_HALL_TEMPERATURE_ENVF, H)<font></font>
end<font></font>
rule "Update AC_HALL NOZZLES temp"<font></font>
        when<font></font>
                Item AC_HALL_TEMPERATURE_NOZ received update<font></font>
        then<font></font>
                var Number T = AC_HALL_TEMPERATURE_NOZ.state as DecimalType<font></font>
                var Number H = T/100<font></font>
                postUpdate(AC_HALL_TEMPERATURE_NOZF, H)<font></font>
end<font></font>
rule "Update AC_HALL_RTC clock"<font></font>
        when<font></font>
                Item AC_HALL_RTC received update<font></font>
        then<font></font>
                var Number T = AC_HALL_RTC.state as DecimalType<font></font>
                var H = T.intValue / 256<font></font>
                var M = T.intValue % 256<font></font>
                var S = String::format("%02x:%02x",H,M)<font></font>
                postUpdate(AC_HALL_RTC_S, S)<font></font>
end<font></font>
</pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura√ß√µes de Sitemaps</font></font></b><div class="spoiler_text"><pre>sitemap demo label="Demo House"{<font></font>
        Frame label="HOME"{<font></font>
                Text label=" " icon="ac_cond"{<font></font>
                        Frame label="" {<font></font>
                                Switch item= AC_HALL_CONTROL_POWER labelcolor=[AC_HALL_STATE_POWER==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_OXYGEN labelcolor=[AC_HALL_STATE_OXYGEN==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_ION labelcolor=[AC_HALL_STATE_ION==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_QUIET labelcolor=[AC_HALL_STATE_QUIET==OPEN="blue"]<font></font>
                                Text item=AC_HALL_STATE_TIMER labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"] icon="clock-on"<font></font>
                                Text item=AC_HALL_RTC_S<font></font>
                                Text item=AC_HALL_TEMPERATURE_ENVF<font></font>
                                Text item=AC_HALL_TEMPERATURE_NOZF<font></font>
                        }<font></font>
<font></font>
                        Frame label=""{<font></font>
                                Selection item=AC_HALL_MODE label="" mappings=[1=AUTO, 2=COOL, 4=HEAT, 8=DRY, 16=FAN]<font></font>
                                Text item=AC_HALL_TEMP_AUTO visibility=[AC_HALL_MODE==1]<font></font>
                                Text item=AC_HALL_TEMP_COOL visibility=[AC_HALL_MODE==2]<font></font>
                                Text item=AC_HALL_TEMP_HEAT visibility=[AC_HALL_MODE==4]<font></font>
                                Text item=AC_HALL_TEMP_DRY visibility=[AC_HALL_MODE==8]<font></font>
<font></font>
                                Text item=AC_HALL_FAN_AUTO visibility=[AC_HALL_MODE==1]<font></font>
                                Text item=AC_HALL_FAN_COOL visibility=[AC_HALL_MODE==2]<font></font>
                                Text item=AC_HALL_FAN_HEAT visibility=[AC_HALL_MODE==4]<font></font>
                                Text item=AC_HALL_FAN_DRY visibility=[AC_HALL_MODE==8]<font></font>
                                Text item=AC_HALL_FAN_SPEED visibility=[AC_HALL_MODE==16]<font></font>
<font></font>
                                Selection item=AC_HALL_SWINGV label="" mappings=[1=AUTO, 2="0¬∞", 4="15¬∞", 8="30¬∞", 16="45¬∞", 32="60¬∞"]<font></font>
                                Selection item=AC_HALL_SWINGH label="" mappings=[1=AUTO, 4="/   /", 8="/   |", 2="|   |", 16="|   \\", 32="\\   \\"]<font></font>
<font></font>
                                Text label="" icon="settings"{<font></font>
                                        Frame label="AUTO"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_AUTO minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_AUTO mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="COOL"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_COOL minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_COOL mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="HEAT"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_HEAT minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_HEAT mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="DRY"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_DRY minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_DRY mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="FAN"{<font></font>
                                                Switch item=AC_HALL_FAN_SPEED mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label=""{<font></font>
                                                Text item=AC_HALL_DS18B20_ENV<font></font>
                                                Text item=AC_HALL_DS18B20_NOZ<font></font>
                                        }<font></font>
                                }<font></font>
                        }<font></font>
                        Frame label="" {<font></font>
                                Switch item= AC_HALL_TIMER_ON labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"]<font></font>
                                Setpoint item=AC_HALL_TIME_ON_HR minValue=0 maxValue=23 step=1<font></font>
                                Setpoint item=AC_HALL_TIME_ON_MI minValue=0 maxValue=50 step=5<font></font>
<font></font>
                                Switch item= AC_HALL_TIMER_OFF labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"]<font></font>
                                Setpoint item=AC_HALL_TIME_OFF_HR minValue=0 maxValue=23 step=1<font></font>
                                Setpoint item=AC_HALL_TIME_OFF_MI minValue=0 maxValue=50 step=5<font></font>
                        }<font></font>
                }<font></font>
                Text item=AC_HALL_RTC_S<font></font>
                Text item=AC_HALL_TEMPERATURE_ENVF{<font></font>
                        Frame label=" "{<font></font>
                                Chart item=gAC_HALL_TEMPERATURE period=h refresh=60000<font></font>
                        }<font></font>
                        Frame label=" 4 " {<font></font>
                                Chart item=gAC_HALL_TEMPERATURE period=4h refresh=600000<font></font>
                        }<font></font>
                }<font></font>
        }<font></font>
}<font></font>
</pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O resultado √© mais ou menos assim atrav√©s de um navegador:</font></font><br>
<img align="left" src="https://habrastorage.org/files/5c0/129/0f3/5c01290f365b47399e9b16123c21f6fa.png"><img align="left" src="https://habrastorage.org/files/634/45b/94b/63445b94b4ab47349482b85667313e10.png"><img align="left" src="https://habrastorage.org/files/09c/8cb/8ff/09c8cb8ffb8240349ce57e8c7ccc6629.png"><br clear="all">
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estou satisfeito com o resultado como um elefante. O controle do ar condicionado est√° agora dispon√≠vel para mim onde quer que haja Internet m√≥vel ou Wi-Fi. Usando um cliente VPN em um smartphone, o OpenHAB no meu servidor dom√©stico se torna acess√≠vel para mim por meio de um navegador e de um aplicativo m√≥vel. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A solu√ß√£o sem fio tornou poss√≠vel integrar estreitamente o controlador ao ar condicionado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A presen√ßa de feedback garante que o comando enviado foi recebido pelo ar condicionado e os sensores de temperatura demonstram isso claramente - ap√≥s alguns segundos, √© poss√≠vel observar uma altera√ß√£o na leitura da temperatura na sa√≠da do ar condicionado. Bem, depois de alguns minutos - e a temperatura ambiente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi interessante observar o perfil do ar condicionado ao se aproximar das condi√ß√µes dadas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sem d√∫vida, este n√£o ser√° o √∫nico controlador sem fio que pretendo usar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° planos de usar o receptor de infravermelho do pr√≥prio ar condicionado para ler os comandos do controle remoto nativo para atualizar as configura√ß√µes no controlador. </font><font style="vertical-align: inherit;">Al√©m disso, o pr√≥prio receptor de infravermelho j√° est√° conectado por meio de um acoplador √≥ptico ao controlador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leia at√© o final um agradecimento especial!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refer√™ncias</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioteca Arduino ModbusRtu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Master-Slave-for-Arduino</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioteca Arduino ModbusRtuRF24 Rede </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-over-RF24 para Arduino</font></font></a></li>
</ol></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt384243/">https://habr.com/ru/post/pt384243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt384229/index.html">Ap√≥s a leitura, aplique. 25 livros para o desenvolvedor de jogos</a></li>
<li><a href="../pt384231/index.html">Se ningu√©m precisa de ur√¢nio natural, como enriquecer?</a></li>
<li><a href="../pt384235/index.html">UAVs abrir√£o o c√©u russo at√© 2020</a></li>
<li><a href="../pt384239/index.html">Revis√£o do Sphero BB-8, um rob√¥ de Guerra nas Estrelas</a></li>
<li><a href="../pt384241/index.html">Emercoin: criptomoeda e uma chave digital em um</a></li>
<li><a href="../pt384247/index.html">Opini√µes: Twitter compartilha software para testes</a></li>
<li><a href="../pt384249/index.html">Uma sele√ß√£o de dispositivos √∫teis: 5 gadgets √∫teis no escrit√≥rio</a></li>
<li><a href="../pt384251/index.html">Rob√¥ e homem. Do conte√∫do para o formul√°rio</a></li>
<li><a href="../pt384253/index.html">Rede neural de girafas aprendeu a jogar xadrez no n√≠vel de um mestre internacional da FIDE em 72 horas</a></li>
<li><a href="../pt384257/index.html">Como os restaurantes criam sites: 4 solu√ß√µes de design</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>