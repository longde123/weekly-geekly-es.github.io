<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë©üèº üîô üàÅ C√≥mo iniciar sesi√≥n en NodeJS para que los ni√±os del patio respeten ü§òüèΩ üêµ üçß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQu√© es lo que m√°s te enfurece cuando intentas organizar registros legibles en tu aplicaci√≥n NodeJS? Personalmente, estoy extremadamente molesto por l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo iniciar sesi√≥n en NodeJS para que los ni√±os del patio respeten</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442452/"><p><img src="https://habrastorage.org/webt/5a/em/fo/5aemfoyk841-ll_xjint9es2kao.jpeg"></p><br><p>  ¬øQu√© es lo que m√°s te enfurece cuando intentas organizar registros legibles en tu aplicaci√≥n NodeJS?  Personalmente, estoy extremadamente molesto por la falta de est√°ndares maduros razonables para crear ID de rastreo.  En este art√≠culo, hablaremos sobre las opciones para crear un ID de rastreo, echemos un vistazo a c√≥mo funciona <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el almacenamiento local de continuaci√≥n o CLS</a> en nuestros dedos y recurramos a la fuerza de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proxy</a> para obtener todo con absolutamente cualquier registrador. </p><a name="habracut"></a><br><h2 id="pochemu-v-nodejs-voobsche-est-problema-s-sozdaniem-trace-id-dlya-kazhdogo-zaprosa">  ¬øPor qu√© hay alg√∫n problema en NodeJS con la creaci√≥n de un ID de rastreo para cada solicitud? </h2><br><p>  En los viejos, viejos, viejos tiempos, cuando los mamuts a√∫n caminaban por la tierra, los servidores de todo-todo-todo eran multihilo y creaban un nuevo hilo para una solicitud.  Dentro del marco de este paradigma, crear una identificaci√≥n de rastreo es trivial, porque  Existe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el almacenamiento local de subprocesos o TLS</a> , que le permite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">guardar</a> en la memoria algunos datos disponibles para cualquier funci√≥n en esta secuencia.  Al comienzo del procesamiento de la solicitud, puede canjear el ID de rastreo aleatorio, ponerlo en TLS y luego leerlo en cualquier servicio y hacer algo con √©l.  El problema es que esto no funcionar√° en NodeJS. </p><br><p>  NodeJS es de un solo subproceso (no del todo, dada la apariencia de los trabajadores, pero dentro del marco del problema con la identificaci√≥n de rastreo, los trabajadores no juegan ning√∫n papel), por lo que puede olvidarse de TLS.  Aqu√≠ el paradigma es diferente: hacer malabarismos con varias devoluciones de llamada diferentes dentro del mismo hilo, y tan pronto como la funci√≥n quiera hacer algo asincr√≥nico, env√≠e esta solicitud asincr√≥nica y dele tiempo al procesador a otra funci√≥n en la cola (si est√° interesado en c√≥mo funciona esta cosa, orgullosamente llamada Event Loop) debajo del cap√≥, recomiendo leer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esta serie de art√≠culos</a> ).  Si piensa en c√≥mo NodeJS entiende a qu√© devoluci√≥n de llamada llamar, puede suponer que cada uno de ellos debe corresponder a alg√∫n ID.  Adem√°s, NodeJS incluso tiene una API que proporciona acceso a estos ID.  Lo usaremos </p><br><p>  En la antig√ºedad, cuando los mamuts se extinguieron, pero la gente a√∫n no conoc√≠a los beneficios de las aguas residuales centrales (NodeJS v0.11.11) ten√≠amos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">addAsyncListener</a> .  Sobre esta base, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Forrest Norvell</a> cre√≥ la primera implementaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">almacenamiento local</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">continuaci√≥n o CLS</a> .  Pero no hablaremos sobre c√≥mo funcion√≥, ya que esta API (estoy hablando de addAsyncLustener) orden√≥ una larga vida.  √âl ya muri√≥ en NodeJS v0.12. </p><br><p>  Antes de NodeJS 8, no hab√≠a una forma oficial de realizar un seguimiento de la cola de eventos asincr√≥nicos.  Y finalmente, en la versi√≥n 8, los desarrolladores de NodeJS restauraron la justicia y nos presentaron la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API async_hooks</a> .  Si desea obtener m√°s informaci√≥n sobre async_hooks, le recomiendo que lea <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este art√≠culo</a> .  Basado en async_hooks, se realiz√≥ la refactorizaci√≥n de la implementaci√≥n anterior de CLS.  La biblioteca se llama <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cls-hooked</a> . </p><br><h2 id="cls-pod-kapotom">  CLS debajo del cap√≥ </h2><br><p>  En t√©rminos generales, el esquema de operaci√≥n de CLS se puede representar de la siguiente manera: </p><br><p><img src="https://habrastorage.org/webt/ix/xe/wj/ixxewjdn0xn7r5feuvgdl1vnjow.jpeg" alt="Resumen de CLS"></p><br><p>  Veamos un poco m√°s en detalle: </p><br><ol><li>  Supongamos que tenemos un servidor web <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Express</a> t√≠pico.  Primero, cree un nuevo espacio de nombres CLS.  Una vez y para toda la vida de la aplicaci√≥n. </li><li>  En segundo lugar, crearemos middleware, que crear√° nuestro propio contexto CLS para cada solicitud. </li><li>  Cuando llega una nueva solicitud, se llama a este middleware (Funci√≥n # 1). </li><li>  En esta funci√≥n, cree un nuevo contexto CLS (como una opci√≥n, puede usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Namespace.run</a> ).  En Namespace.run pasamos una funci√≥n que se ejecutar√° en el √°mbito de nuestro contexto. </li><li>  CLS agrega un contexto reci√©n creado a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Map</a> con contextos con la clave de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ID de ejecuci√≥n actual</a> . </li><li> Cada espacio de nombres CLS tiene una propiedad <code>active</code> .  CLS asigna a esta propiedad una referencia a nuestro contexto. </li><li>  En un √°mbito de contexto, realizamos alg√∫n tipo de consulta asincr√≥nica, por ejemplo, a la base de datos.  Pasamos la devoluci√≥n de llamada al controlador de la base de datos, que se llamar√° cuando se complete la solicitud. </li><li>  El gancho de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">arranque</a> as√≠ncrono se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dispara</a> .  Agrega el contexto actual al Mapa con contextos por ID as√≠ncrono (ID de la nueva operaci√≥n asincr√≥nica). </li><li>  Porque  nuestra funci√≥n ya no tiene instrucciones adicionales; completa la ejecuci√≥n. </li><li>  Un gancho as√≠ncrono <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">despu√©s funciona</a> para ella.  Asigna la propiedad <code>active</code> al espacio de nombres <code>undefined</code> (de hecho, no siempre, porque podemos tener varios contextos anidados, pero para el caso m√°s simple es). </li><li>  El anzuelo asincr√≥nico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">destruye incendios</a> para nuestra primera operaci√≥n asincr√≥nica.  Elimina el contexto del Mapa con contextos mediante el ID as√≠ncrono de esta operaci√≥n (es el mismo que el ID de ejecuci√≥n actual de la primera devoluci√≥n de llamada). </li><li>  La consulta en la base de datos se completa y se llama a la segunda devoluci√≥n de llamada. </li><li>  Gancho asincr√≥nico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">antes</a> .  Su ID de ejecuci√≥n actual es la misma que la ID as√≠ncrona de la segunda operaci√≥n (consulta de la base de datos).  A <code>active</code> propiedad <code>active</code> espacio de nombres se le asigna el contexto que se encuentra en el Mapa con contextos por ID de ejecuci√≥n actual.  Este es el contexto que creamos antes. </li><li>  Ahora se ejecuta la segunda devoluci√≥n de llamada.  Alg√∫n tipo de l√≥gica de negocios est√° funcionando, los demonios est√°n bailando, el vodka est√° vertiendo.  Dentro de esto, podemos obtener <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cualquier valor del contexto por clave</a> .  CLS intentar√° encontrar la clave dada en el contexto actual o volver√° <code>undefined</code> . </li><li>  El enlace <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">posterior</a> as√≠ncrono para esta devoluci√≥n de llamada se activa cuando se completa.  Establece la propiedad <code>active</code> del espacio de nombres en <code>undefined</code> . </li><li>  El gancho de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">disparo</a> as√≠ncrono <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">destruye</a> para esta operaci√≥n.  Elimina el contexto del Mapa con contextos mediante el ID as√≠ncrono de esta operaci√≥n (es el mismo que el ID de ejecuci√≥n actual de la segunda devoluci√≥n de llamada). </li><li>  El recolector de basura (GC) libera memoria asociada con el objeto de contexto, porque  en nuestra aplicaci√≥n no hay m√°s enlaces a ella. </li></ol><br><p>  Esta es una vista simplificada de lo que sucede debajo del cap√≥, pero cubre las fases y pasos principales.  Si desea profundizar un poco m√°s, le recomiendo que se familiarice con el <a href="">tipo</a> .  Solo hay 500 l√≠neas de c√≥digo. </p><br><h2 id="sozdanie-trace-id">  Crear ID de rastreo </h2><br><p>  Entonces, habiendo tratado con el CLS, intentaremos usar esto para el beneficio de la humanidad.  Creemos middleware, que para cada solicitud crea su propio contexto CLS, crea un ID de rastreo aleatorio y lo agrega al contexto utilizando la clave <code>traceID</code> .  Luego, dentro del ofigilliard de nuestros controladores y servicios, obtenemos esta identificaci√≥n de rastreo. </p><br><p>  Para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">express, un</a> middleware similar podr√≠a verse as√≠: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cls = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'cls-hooked'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uuidv4 = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'uuid/v4'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> clsNamespace = cls.createNamespace(<span class="hljs-string"><span class="hljs-string">'app'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> clsMiddleware = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// req  res -  event emitters.      CLS     clsNamespace.bind(req) clsNamespace.bind(res) const traceID = uuidv4() clsNamespace.run(() =&gt; { clsNamespace.set('traceID', traceID) next() }) }</span></span></code> </pre> <br><p>  Y en nuestro controlador o servicio, podemos obtener este traceID en una sola l√≠nea de c√≥digo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> controller = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> traceID = clsNamespace.get(<span class="hljs-string"><span class="hljs-string">'traceID'</span></span>) }</code> </pre> <br><p>  Es cierto que sin agregar esta identificaci√≥n de rastreo a los registros, se beneficia de ella, como de un quitanieves en el verano. </p><br><p>  Escribamos un formateador simple de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Winston</a> que agregar√° la identificaci√≥n de rastreo autom√°ticamente. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { createLogger, format, transports } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'winston'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> addTraceId = printf(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">info</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> message = info.message <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> traceID = clsNamespace.get(<span class="hljs-string"><span class="hljs-string">'taceID'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (traceID) { message = <span class="hljs-string"><span class="hljs-string">`[TraceID: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${traceID}</span></span></span><span class="hljs-string">]: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message}</span></span></span><span class="hljs-string">`</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message }) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> logger = createLogger({ <span class="hljs-attr"><span class="hljs-attr">format</span></span>: addTraceId, <span class="hljs-attr"><span class="hljs-attr">transports</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> transports.Console()], })</code> </pre> <br><p>  Y si todos los registradores admitieran formateadores personalizados en forma de funciones (muchos de ellos tienen razones para no hacerlo), entonces este art√≠culo probablemente no lo hubiera sido.  Entonces, ¬øc√≥mo podr√≠a agregar una identificaci√≥n de rastreo a los registros del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pino</a> adorado? </p><br><h2 id="vzyvaem-k-proxyhttpsdevelopermozillaorgen-usdocswebjavascriptreferenceglobal_objectsproxy-daby-podruzhit-lyuboy-loger-i-cls">  Hacemos un llamado a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Proxy</a> para hacer amigos CUALQUIER registrador y CLS </h2><br><p>  Algunas palabras sobre Proxy en s√≠: esto es algo que envuelve nuestro objeto original y nos permite redefinir su comportamiento en ciertas situaciones.  En una lista limitada de situaciones estrictamente definida (en ciencia se llaman <code>traps</code> ).  Puede encontrar la lista completa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> , solo estamos interesados ‚Äã‚Äãen trap <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">get</a> .  Nos da la oportunidad de anular el valor de retorno al acceder a la propiedad del objeto, es decir.  si tomamos el objeto <code>const a = { prop: 1 }</code> y lo envolvemos en Proxy, con la ayuda de trap <code>get</code> podemos devolver todo lo que queramos cuando llamamos <code>a.prop</code> . </p><br><p>  En el caso de <code>pino</code> idea es la siguiente: creamos un ID de rastreo aleatorio para cada solicitud, creamos una <a href="">instancia secundaria de pino</a> en la que pasamos este ID de rastreo y colocamos esta instancia secundaria en el CLS.  Luego envolvemos nuestro registrador de origen en Proxy, que usar√° esta misma instancia secundaria para el registro, si hay un contexto activo y hay un registrador secundario, o use el registrador original. </p><br><p>  Para tal caso, el proxy se ver√° as√≠: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pino = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'pino'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> logger = pino() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> loggerCls = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Proxy</span></span>(logger, { get(target, property, receiver) { <span class="hljs-comment"><span class="hljs-comment">//    CLS  ,   target = clsNamespace.get('loggerCls') || target return Reflect.get(target, property, receiver) }, })</span></span></code> </pre> <br><p>  Nuestro middleware se ver√° as√≠: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cls = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'cls-hooked'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> uuidv4 = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'uuid/v4'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> clsMiddleware = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// req  res -  event emitters.      CLS     clsNamespace.bind(req) clsNamespace.bind(res) const traceID = uuidv4() const loggerWithTraceId = logger.child({ traceID }) clsNamespace.run(() =&gt; { clsNamespace.set('loggerCls', loggerWithTraceId) next() }) }</span></span></code> </pre> <br><p>  Y podemos usar el registrador de esta manera: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> controller = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">) =&gt;</span></span> { loggerCls.info(<span class="hljs-string"><span class="hljs-string">'Long live rocknroll!'</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  // {"level":30,"time":1551385666046,"msg":"Long live rocknroll!","pid":25,"hostname":"eb6a6c70f5c4","traceID":"9ba393f0-ec8c-4396-8092-b7e4b6f375b5","v":1} }</span></span></code> </pre> <br><h2 id="cls-proxifyhttpsgithubcomkeenondrumscls-proxify">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cls-proxify</a> </h2><br><p>  Basado en la idea anterior, se cre√≥ una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">peque√±a biblioteca cls-proxify</a> .  Ella trabaja fuera de la caja con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">express</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">koa</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fastify</a> .  Adem√°s de crear trampa para <code>get</code> , crea <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">otras trampas</a> para dar al desarrollador m√°s libertad.  Debido a esto, podemos usar Proxy para ajustar funciones, clases y m√°s.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hay una demostraci√≥n en vivo sobre c√≥mo integrar pino y fastify, pino y express</a> . </p><br><p>  Espero que no hayas perdido el tiempo en vano, y el art√≠culo fue al menos un poco √∫til para ti.  Por favor patea y critica.  Aprenderemos a codificar mejor juntos. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/442452/">https://habr.com/ru/post/442452/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442442/index.html">Ingeniero Senior en busca de trabajo. Sobre tareas en entrevistas t√©cnicas y preguntas te√≥ricas</a></li>
<li><a href="../442444/index.html">Mitos de la f√≠sica popular moderna.</a></li>
<li><a href="../442446/index.html">Transformaci√≥n digital en el ejemplo del Call center de cualquier negocio.</a></li>
<li><a href="../442448/index.html">Concurrencia y patrones de error ocultos en el c√≥digo: punto muerto</a></li>
<li><a href="../442450/index.html">Blockchain y datos m√©dicos: c√≥mo funciona</a></li>
<li><a href="../442454/index.html">Magic Leap planea complementar el mundo real con capas digitales</a></li>
<li><a href="../442456/index.html">C√≥mo ahorrar recursos en el navegador y no romper la web. Informe Yandex</a></li>
<li><a href="../442458/index.html">Abismo o camino artificial desde un piloto RPA hasta la implementaci√≥n en toda la empresa</a></li>
<li><a href="../442460/index.html">Ayudando al proveedor queryable a ordenar cadenas interpoladas</a></li>
<li><a href="../442462/index.html">Errores t√≠picos al trabajar con PostgreSQL. Parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>