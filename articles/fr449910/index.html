<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😅 💲 🚛 GitLab Shell Runner. Lancement concurrentiel de services de test à l'aide de Docker Compose 😼 🤘🏿 👨🏾‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article intéressera à la fois les testeurs et les développeurs, mais il s'adresse davantage aux automates confrontés au problème de configuration ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GitLab Shell Runner. Lancement concurrentiel de services de test à l'aide de Docker Compose</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449910/"><p> <a href=""><img src="https://habrastorage.org/webt/ub/dc/bf/ubdcbfrlztg3eqofpqbs6w1u9sw.png"></a> </p><br><p> Cet article intéressera à la fois les testeurs et les développeurs, mais il s'adresse davantage aux automates confrontés au problème de configuration de GitLab CI / CD pour les tests d'intégration dans des conditions de ressources d'infrastructure insuffisantes et / ou de manque de plateforme d'orchestration de conteneurs.  Je vais vous expliquer comment configurer le déploiement d'environnements de test à l'aide de Docker Composer sur un seul exécuteur de shell GitLab et afin que lors du déploiement de plusieurs environnements, les services lancés n'interfèrent pas entre eux. </p><a name="habracut"></a><br><a name="toc"></a><br><h2 id="soderzhanie">  Table des matières </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Contexte</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gitlab shell runner</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Préparation de docker-compose.yml</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Préparation du Makefile</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Préparation de .gitlab-ci.yml</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exécutez des tests d'intégration</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nettoyage des coureurs</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Résultat</a> </li></ul><br><a name="prerequisites"></a><br><h2 id="predposylki">  Contexte </h2><br><ol><li><p>  Dans ma pratique, il arrivait souvent de «soigner» les tests d'intégration sur les projets.  Et souvent, le premier et le plus important problème est le pipeline CI, dans lequel les tests d'intégration des services <strong>développés</strong> sont effectués dans un environnement de développement / étape.  Cela a causé pas mal de problèmes: </p><br><ul><li>  En raison de défauts dans un service particulier lors des tests d'intégration, le circuit de test peut être corrompu par des données cassées.  Il y a eu des cas où l'envoi d'une demande avec un format JSON cassé a suspendu un service, ce qui a rendu le stand complètement inopérant. </li><li>  Ralentir la boucle de test avec la croissance des données de test.  Je pense que cela n'a aucun sens de décrire un exemple de nettoyage / restauration d'une base de données.  Dans ma pratique, je n'ai pas vu de projet où cette procédure s'est bien déroulée. </li><li>  Risque de perturber les performances du circuit de test lors du test des paramètres généraux du système.  Par exemple, utilisateur / groupe / mot de passe / stratégie d'application. </li><li>  Les données de test des autotests empêchent les testeurs manuels de vivre. </li></ul><br><p>  Quelqu'un dira que de bons autotests devraient nettoyer les données après eux-mêmes.  J'ai des arguments contre: </p><br><ul><li>  Les supports dynamiques sont très pratiques à utiliser. </li><li>  Tous les objets ne peuvent pas être supprimés du système via l'API.  Par exemple, un appel pour supprimer un objet n'est pas implémenté, car il contredit la logique métier. </li><li>  Lors de la création d'un objet via l'API, une énorme quantité de métadonnées peut être créée, ce qui est problématique à supprimer. </li><li>  Si les tests sont interdépendants, le processus de nettoyage des données une fois les tests terminés devient un casse-tête. </li><li>  Appels supplémentaires (et, à mon avis, non justifiés) à l'API. </li><li>  Et l'argument principal: lorsque les données de test commencent à être nettoyées directement de la base de données.  Il se transforme en véritable cirque PK / FK!  D'après les développeurs, il est audible: "J'ai seulement ajouté / supprimé / renommé la plaque signalétique, pourquoi les tests d'intégration 100500 ont-ils échoué?" </li></ul><br><p>  À mon avis, la solution la plus optimale est un environnement dynamique. </p><br></li><li>  Beaucoup de gens utilisent docker-compose pour exécuter un environnement de test, mais peu utilisent docker-compose lors des tests d'intégration dans CI / CD.  Et ici, je ne prends pas en compte les plates-formes kubernetes, swarm et autres conteneurs d'orchestration.  Toutes les entreprises n'en ont pas.  Ce serait bien si docker-compose.yml était universel. </li><li>  Même si nous avons notre propre runner QA, comment pouvons-nous nous assurer que les services lancés via docker-compose n'interfèrent pas entre eux? </li><li>  Comment collecter les logs des services testés? </li><li>  Comment nettoyer le coureur? </li></ol><br><p>  J'ai mon propre runner GitLab pour mes projets et je suis tombé sur ces problèmes lors du développement d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">client Java</a> pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TestRail</a> .  Ou plutôt, lors de l'exécution de tests d'intégration.  Ci-après, nous allons résoudre ces problèmes avec des exemples de ce projet. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vers le contenu</a> </p><br><a name="gitlab_shell_runner"></a><br><h3 id="gitlab-shell-runner">  Gitlab shell runner </h3><br><p>  Pour le coureur, je recommande une machine virtuelle Linux avec 4 vCPU, 4 Go de RAM, 50 Go de disque dur. <br>  Sur Internet, beaucoup d'informations sur la configuration de gitlab-runner, donc brièvement: </p><br><ul><li>  Nous allons à la machine sur SSH </li><li><p>  Si vous avez moins de 8 Go de RAM, je vous recommande de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">faire un échange de 10 Go</a> afin que le tueur OOM ne vienne pas et ne nous tue pas par manque de RAM.  Cela peut se produire lorsque plus de 5 tâches sont démarrées simultanément.  Les tâches seront plus lentes, mais stables. </p><br><div class="spoiler">  <b class="spoiler_title">Exemple de tueur OOM</b> <div class="spoiler_text"><p> Si vous voyez <code>bash: line 82: 26474 Killed</code> dans les journaux des tâches, exécutez simplement <code>sudo dmesg | grep 26474</code> <code>sudo dmesg | grep 26474</code> </p><br><pre> <code class="plaintext hljs">[26474] 1002 26474 1061935 123806 339 0 0 java Out of memory: Kill process 26474 (java) score 127 or sacrifice child Killed process 26474 (java) total-vm:4247740kB, anon-rss:495224kB, file-rss:0kB, shmem-rss:0kB</code> </pre> <br><p>  Et si l'image ressemble à quelque chose comme ça, alors ajoutez un swap ou supprimez de la RAM. </p><br></div></div><br></li></ul><br><ul><li>  Installez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gitlab-runner</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docker</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docker-compose</a> , make. </li><li>  Ajouter <code>gitlab-runner</code> utilisateur <code>gitlab-runner</code> au groupe de <code>docker</code> <br><pre> <code class="bash hljs">sudo groupadd docker sudo usermod -aG docker gitlab-runner</code> </pre> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Enregistrez</a> gitlab-runner. </li><li><p>  Ouvrez pour éditer <code>/etc/gitlab-runner/config.toml</code> et ajoutez </p><br><pre> <code class="plaintext hljs">concurrent=20 [[runners]] request_concurrency = 10</code> </pre> <br><p>  Cela vous permettra d'exécuter des tâches parallèles sur un seul coureur.  Lisez plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br>  Si votre machine est plus puissante, par exemple, 8 processeurs virtuels, 16 Go de RAM, ces chiffres peuvent être au moins 2 fois plus importants.  Mais tout dépend de ce qui sera lancé exactement sur ce coureur et en quelle quantité. </p><br></li></ul><br><p>  Ça suffit. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vers le contenu</a> </p><br><a name="docker_compose_yml_preparation"></a><br><h2 id="podgotovka-docker-composeyml">  Préparation de docker-compose.yml </h2><br><p>  La tâche principale est docker-compose.yml, qui sera utilisé à la fois localement et dans le pipeline CI. </p><br><p>  La variable <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">COMPOSE_PROJECT_NAME</a> sera utilisée pour démarrer plusieurs instances de l'environnement (voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">makefile</a> ). </p><br><p>  Un exemple de mon docker-compose.yml </p><br><pre> <code class="plaintext hljs">version: "3" #    web (php)  fmt , #      . #   ,   /var/www/testrail volumes: static-content: services: db: image: mysql:5.7.22 environment: MYSQL_HOST: db MYSQL_DATABASE: mydb MYSQL_ROOT_PASSWORD: 1234 SKIP_GRANT_TABLES: 1 SKIP_NETWORKING: 1 SERVICE_TAGS: dev SERVICE_NAME: mysql migration: image: registry.gitlab.com/touchbit/image/testrail/migration:latest links: - db depends_on: - db fpm: image: registry.gitlab.com/touchbit/image/testrail/fpm:latest container_name: "testrail-fpm-${CI_JOB_ID:-local}" volumes: - static-content:/var/www/testrail links: - db web: image: registry.gitlab.com/touchbit/image/testrail/web:latest #   TR_HTTP_PORT  TR_HTTPS_PORTS  , #     80  443  . ports: - ${TR_HTTP_PORT:-80}:80 - ${TR_HTTPS_PORT:-443}:443 volumes: - static-content:/var/www/testrail links: - db - fpm</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vers le contenu</a> </p><br><a name="makefile_preparation"></a><br><h2 id="podgotovka-makefile">  Préparation du Makefile </h2><br><p>  J'utilise Makefile, car il est très pratique pour la gestion locale de l'environnement et dans CI. </p><br><p>  D'autres commentaires sont en ligne </p><br><pre> <code class="plaintext hljs">#           `.indirect`, #     `docker-compose.yml` #  bash   pipefail # pipefail -   ,      SHELL=/bin/bash -o pipefail #   CI_JOB_ID   ifeq ($(CI_JOB_ID),) #   local CI_JOB_ID := local endif #    export COMPOSE_PROJECT_NAME = $(CI_JOB_ID)-testrail #    , , volumes docker-down: docker-compose -f .indirect/docker-compose.yml down #   docker-down () docker-up: docker-down #     docker-registry docker-compose -f .indirect/docker-compose.yml pull #   # force-recreate -    # renew-anon-volumes -   volumes   docker-compose -f .indirect/docker-compose.yml up --force-recreate --renew-anon-volumes -d #  ,   ,           docker ps #    docker-logs: mkdir -p ./logs docker logs $${COMPOSE_PROJECT_NAME}_web_1 &gt;&amp; logs/testrail-web.log || true docker logs $${COMPOSE_PROJECT_NAME}_fpm_1 &gt;&amp; logs/testrail-fpm.log || true docker logs $${COMPOSE_PROJECT_NAME}_migration_1 &gt;&amp; logs/testrail-migration.log || true docker logs $${COMPOSE_PROJECT_NAME}_db_1 &gt;&amp; logs/testrail-mysql.log || true #   docker-clean: @echo   testrail- docker kill $$(docker ps --filter=name=testrail -q) || true @echo    docker rm -f $$(docker ps -a -f --filter=name=testrail status=exited -q) || true @echo  dangling  docker rmi -f $$(docker images -f "dangling=true" -q) || true @echo  testrail  docker rmi -f $$(docker images --filter=reference='registry.gitlab.com/touchbit/image/testrail/*' -q) || true @echo    volume docker volume rm -f $$(docker volume ls -q) || true @echo   testrail  docker network rm $(docker network ls --filter=name=testrail -q) || true docker ps</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Vérifier le lancement local</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ make docker-up docker-compose -f .indirect/docker-compose.yml pull Pulling db ... done Pulling migration ... done Pulling fpm ... done Pulling web ... done docker-compose -f .indirect/docker-compose.yml up --force-recreate --renew-anon-volumes -d Creating network "local-testrail_default" with the default driver Recreating local-testrail_db_1 ... done Recreating local-testrail_migration_1 ... done Recreating local-testrail_fpm_1 ... done Recreating local-testrail_web_1 ... done docker ps CONTAINER ID NAMES 3b8f9d4af29c local-testrail_web_1 5622c7d742d5 local-testrail_fpm_1 b580e3392038 local-testrail_migration_1 e467630bd3a5 local-testrail_db_1</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Vérification du lancement de CI</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ export CI_JOB_ID=123456789 $ make docker-up docker-compose -f .indirect/docker-compose.yml pull Pulling db ... done Pulling migration ... done Pulling fpm ... done Pulling web ... done docker-compose -f .indirect/docker-compose.yml up --force-recreate --renew-anon-volumes -d Creating network "123456789-testrail_default" with the default driver Creating volume "123456789-testrail_static-content" with default driver Creating 123456789-testrail_db_1 ... done Creating 123456789-testrail_fpm_1 ... done Creating 123456789-testrail_migration_1 ... done Creating 123456789-testrail_web_1 ... done docker ps CONTAINER ID NAMES ccf1ad33d0e8 123456789-testrail_web_1 bc079964f681 123456789-testrail_fpm_1 10dc9d4d8f2a 123456789-testrail_migration_1 fe98d43c380e 123456789-testrail_db_1</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Vérifier la collecte des journaux</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ make docker-logs mkdir -p ./logs docker logs ${COMPOSE_PROJECT_NAME}_web_1 &gt;&amp; logs/testrail-web.log || true docker logs ${COMPOSE_PROJECT_NAME}_fpm_1 &gt;&amp; logs/testrail-fpm.log || true docker logs ${COMPOSE_PROJECT_NAME}_migration_1 &gt;&amp; logs/testrail-migration.log || true docker logs ${COMPOSE_PROJECT_NAME}_db_1 &gt;&amp; logs/testrail-mysql.log || true</code> </pre> <br><p><img src="https://habrastorage.org/webt/e0/jx/a2/e0jxa2mkfygvn7kn5fpu3xlcnl0.png"></p></div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vers le contenu</a> </p><br><a name="gitlab_ci_yml_preparation"></a><br><h2 id="podgotovka-gitlab-ciyml">  Préparation de .gitlab-ci.yml </h2><br><a name="integration_tests_run"></a><br><h3 id="zapusk-integracionnyh-testov">  Exécutez des tests d'intégration </h3><br><pre> <code class="plaintext hljs">Integration: stage: test tags: - my-shell-runner before_script: #   registry - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY} #   TR_HTTP_PORT  TR_HTTPS_PORT - export TR_HTTP_PORT=$(shuf -i10000-60000 -n1) - export TR_HTTPS_PORT=$(shuf -i10000-60000 -n1) script: #    - make docker-up #    jar (  ) - java -jar itest.jar --http-port ${TR_HTTP_PORT} --https-port ${TR_HTTPS_PORT} #    - docker run --network=testrail-network-${CI_JOB_ID:-local} --rm itest after_script: #   - make docker-logs #   - make docker-down artifacts: #   when: always paths: - logs expire_in: 30 days</code> </pre> <br><p>  À la suite de l'exécution d'une telle tâche dans les artefacts, le répertoire logs contiendra les journaux des services et des tests.  Ce qui est très pratique en cas d'erreur.  Pour moi, chaque test en parallèle écrit son propre journal, mais je vais en parler séparément. </p><br><p><img src="https://habrastorage.org/webt/xh/s2/yj/xhs2yjdigikkpaoxxi49ocdhink.png"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vers le contenu</a> </p><br><a name="clean_runner"></a><br><h3 id="ochistka-rannera">  Nettoyage des coureurs </h3><br><p>  La tâche sera exécutée uniquement dans les délais. </p><br><pre> <code class="plaintext hljs">stages: - clean - build - test Clean runner: stage: clean only: - schedules tags: - my-shell-runner script: - make docker-clean</code> </pre> <br><p>  Ensuite, accédez à notre projet GitLab -&gt; CI / CD -&gt; Horaires -&gt; Nouveau calendrier et ajoutez un nouveau calendrier </p><br><p> <a href=""><img src="https://habrastorage.org/webt/md/40/9y/md409yjzjctken7qcjh5gkj0u4y.png"></a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vers le contenu</a> </p><br><a name="result"></a><br><h3 id="rezultat">  Résultat </h3><br><p>  Exécutez 4 tâches dans GitLab CI <br> <a href=""><img src="https://habrastorage.org/webt/2t/yt/nt/2tytntlg2we6ikmh4ef3p6noxwe.png"></a> </p><br><p>  Dans les journaux de la dernière tâche avec des tests d'intégration, nous voyons des conteneurs de différentes tâches </p><br><pre> <code class="plaintext hljs">CONTAINER ID NAMES c6b76f9135ed 204645172-testrail-web_1 01d303262d8e 204645172-testrail-fpm_1 2cdab1edbf6a 204645172-testrail-migration_1 826aaf7c0a29 204645172-testrail-mysql_1 6dbb3fae0322 204645084-testrail-web_1 3540f8d448ce 204645084-testrail-fpm_1 70fea72aa10d 204645084-testrail-mysql_1 d8aa24b2892d 204644881-testrail-web_1 6d4ccd910fad 204644881-testrail-fpm_1 685d8023a3ec 204644881-testrail-mysql_1 1cdfc692003a 204644793-testrail-web_1 6f26dfb2683e 204644793-testrail-fpm_1 029e16b26201 204644793-testrail-mysql_1 c10443222ac6 204567103-testrail-web_1 04339229397e 204567103-testrail-fpm_1 6ae0accab28d 204567103-testrail-mysql_1 b66b60d79e43 204553690-testrail-web_1 033b1f46afa9 204553690-testrail-fpm_1 a8879c5ef941 204553690-testrail-mysql_1 069954ba6010 204553539-testrail-web_1 ed6b17d911a5 204553539-testrail-fpm_1 1a1eed057ea0 204553539-testrail-mysql_1</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Journal plus détaillé</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY} WARNING! Using --password via the CLI is insecure. Use --password-stdin. WARNING! Your password will be stored unencrypted in /home/gitlab-runner/.docker/config.json. Configure a credential helper to remove this warning. See https://docs.docker.com/engine/reference/commandline/login/#credentials-store Login Succeeded $ export TR_HTTP_PORT=$(shuf -i10000-60000 -n1) $ export TR_HTTPS_PORT=$(shuf -i10000-60000 -n1) $ mkdir ${CI_JOB_ID} $ cp .indirect/docker-compose.yml ${CI_JOB_ID}/docker-compose.yml $ make docker-up docker-compose -f ${CI_JOB_ID:-.indirect}/docker-compose.yml kill docker network rm testrail-network-${CI_JOB_ID:-local} || true Error: No such network: testrail-network-204645172 docker network create testrail-network-${CI_JOB_ID:-local} 0a59552b4464b8ab484de6ae5054f3d5752902910bacb0a7b5eca698766d0331 docker-compose -f ${CI_JOB_ID:-.indirect}/docker-compose.yml pull Pulling web ... done Pulling fpm ... done Pulling migration ... done Pulling db ... done docker-compose -f ${CI_JOB_ID:-.indirect}/docker-compose.yml up --force-recreate --renew-anon-volumes -d Creating volume "204645172-testrail_static-content" with default driver Creating 204645172-testrail-mysql_1 ... Creating 204645172-testrail-mysql_1 ... done Creating 204645172-testrail-migration_1 ... done Creating 204645172-testrail-fpm_1 ... done Creating 204645172-testrail-web_1 ... done docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES c6b76f9135ed registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of…" 13 seconds ago Up 1 second 0.0.0.0:51148-&gt;80/tcp, 0.0.0.0:25426-&gt;443/tcp 204645172-testrail-web_1 01d303262d8e registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi…" 16 seconds ago Up 13 seconds 9000/tcp 204645172-testrail-fpm_1 2cdab1edbf6a registry.gitlab.com/touchbit/image/testrail/migration:latest "docker-entrypoint.s…" 16 seconds ago Up 13 seconds 3306/tcp, 33060/tcp 204645172-testrail-migration_1 826aaf7c0a29 mysql:5.7.22 "docker-entrypoint.s…" 18 seconds ago Up 16 seconds 3306/tcp 204645172-testrail-mysql_1 6dbb3fae0322 registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of…" 36 seconds ago Up 22 seconds 0.0.0.0:44202-&gt;80/tcp, 0.0.0.0:20151-&gt;443/tcp 204645084-testrail-web_1 3540f8d448ce registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi…" 38 seconds ago Up 35 seconds 9000/tcp 204645084-testrail-fpm_1 70fea72aa10d mysql:5.7.22 "docker-entrypoint.s…" 40 seconds ago Up 37 seconds 3306/tcp 204645084-testrail-mysql_1 d8aa24b2892d registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of…" About a minute ago Up 53 seconds 0.0.0.0:31103-&gt;80/tcp, 0.0.0.0:43872-&gt;443/tcp 204644881-testrail-web_1 6d4ccd910fad registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi…" About a minute ago Up About a minute 9000/tcp 204644881-testrail-fpm_1 685d8023a3ec mysql:5.7.22 "docker-entrypoint.s…" About a minute ago Up About a minute 3306/tcp 204644881-testrail-mysql_1 1cdfc692003a registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of…" About a minute ago Up About a minute 0.0.0.0:44752-&gt;80/tcp, 0.0.0.0:23540-&gt;443/tcp 204644793-testrail-web_1 6f26dfb2683e registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi…" About a minute ago Up About a minute 9000/tcp 204644793-testrail-fpm_1 029e16b26201 mysql:5.7.22 "docker-entrypoint.s…" About a minute ago Up About a minute 3306/tcp 204644793-testrail-mysql_1 c10443222ac6 registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of…" 5 hours ago Up 5 hours 0.0.0.0:57123-&gt;80/tcp, 0.0.0.0:31657-&gt;443/tcp 204567103-testrail-web_1 04339229397e registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi…" 5 hours ago Up 5 hours 9000/tcp 204567103-testrail-fpm_1 6ae0accab28d mysql:5.7.22 "docker-entrypoint.s…" 5 hours ago Up 5 hours 3306/tcp 204567103-testrail-mysql_1 b66b60d79e43 registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of…" 5 hours ago Up 5 hours 0.0.0.0:56321-&gt;80/tcp, 0.0.0.0:58749-&gt;443/tcp 204553690-testrail-web_1 033b1f46afa9 registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi…" 5 hours ago Up 5 hours 9000/tcp 204553690-testrail-fpm_1 a8879c5ef941 mysql:5.7.22 "docker-entrypoint.s…" 5 hours ago Up 5 hours 3306/tcp 204553690-testrail-mysql_1 069954ba6010 registry.gitlab.com/touchbit/image/testrail/web:latest "nginx -g 'daemon of…" 5 hours ago Up 5 hours 0.0.0.0:32869-&gt;80/tcp, 0.0.0.0:16066-&gt;443/tcp 204553539-testrail-web_1 ed6b17d911a5 registry.gitlab.com/touchbit/image/testrail/fpm:latest "docker-php-entrypoi…" 5 hours ago Up 5 hours 9000/tcp 204553539-testrail-fpm_1 1a1eed057ea0 mysql:5.7.22 "docker-entrypoint.s…" 5 hours ago Up 5 hours 3306/tcp 204553539-testrail-mysql_1</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Toutes les tâches ont été exécutées avec succès</b> <div class="spoiler_text"><p>  Les artefacts de tâche contiennent des journaux de service et de test <br> <a href=""><img src="https://habrastorage.org/webt/xu/gp/kh/xugpkhzugu-9olo8bz5qyorlbdc.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/1h/cr/b8/1hcrb8n8awyjugdbbhvyn9axiv8.png"></a> </p></div></div><br><p>  Il semble que tout soit beau, mais il y a une nuance.  Le pipeline peut être annulé de force lors de l'exécution des tests d'intégration, auquel cas l'exécution des conteneurs ne sera pas arrêtée.  De temps en temps, vous devez nettoyer le coureur.  Malheureusement, la tâche de révision dans GitLab CE est toujours en statut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ouvert</a> </p><br><p>  Mais nous avons ajouté le lancement de tâche planifié, et personne ne nous interdit de le démarrer manuellement. <br>  Accédez à notre projet -&gt; CI / CD -&gt; Horaires et exécutez la tâche <code>Clean runner</code> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/sg/ia/nv/sgianvitqqnsknbmmgupakud62k.png"></a> </p><br><p>  Total: </p><br><ul><li>  Nous avons un coureur d'obus. </li><li>  Il n'y a aucun conflit entre les tâches et l'environnement. </li><li>  Nous avons un lancement parallèle de tâches avec des tests d'intégration. </li><li>  Vous pouvez exécuter des tests d'intégration à la fois localement et dans le conteneur. </li><li>  Les journaux des services et des tests sont collectés et attachés à la tâche de pipeline. </li><li>  Il est possible de nettoyer le coureur des anciennes images docker. </li></ul><br><p>  Le temps d'installation est d'environ 2 heures. <br>  En fait, c'est tout.  Je serai heureux de vos commentaires. </p><br><p>  PS <br>  Un merci spécial au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">freeseacher</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">vvasilenok</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ivanych</a> .  Vos commentaires ont été très précieux dans le contexte de la publication. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vers le contenu</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr449910/">https://habr.com/ru/post/fr449910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr449898/index.html">Nouvelles à l'envers</a></li>
<li><a href="../fr449902/index.html">Réseaux de télévision par câble pour les plus petits. Partie 2: Composition et forme d'onde</a></li>
<li><a href="../fr449904/index.html">Création d'une DLL de proxy pour les vérifications des opérations de DLL de piratage</a></li>
<li><a href="../fr449906/index.html">Serveur REST auto-documenté (Node.JS, TypeScript, Koa, Joi, Swagger)</a></li>
<li><a href="../fr449908/index.html">DDR3 ou DDR4? Pourquoi avons-nous offert le Dell R420 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps pour 99 $ aux Pays-Bas?</a></li>
<li><a href="../fr449916/index.html">5 façons de déployer du code PHP dans des conditions de surcharge</a></li>
<li><a href="../fr449918/index.html">Thermomètre infrarouge avec capteur MLX90614</a></li>
<li><a href="../fr449920/index.html">10 façons non standard de nuire au référencement lors du changement de CMS (+1 bonus)</a></li>
<li><a href="../fr449922/index.html">Essai routier nanoCAD SPDS Metalwork 1.2. 3e partie</a></li>
<li><a href="../fr449926/index.html">Le condensé de matières fraîches du monde du front-end de la dernière semaine n ° 362 (22-28 avril 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>