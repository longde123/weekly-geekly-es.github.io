<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’® ğŸš© ğŸ“£ postgres_exporterå¹¶ä½¿ç”¨å¤šä¸ªæ•°æ®åº“ç›‘è§†PostgreSQLå®ä¾‹ â¹ï¸ ğŸ“´ ğŸ–¼ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UPDï¼šè¯¥æ³¨é‡Šä¸0.8.0ç‰ˆæœ¬å¤±å»äº†è”ç³»ã€‚ æ‰€æœ‰åˆ›æ–°éƒ½å¯ä»¥åœ¨æ–‡ç« ä¸­æ‰¾åˆ°ï¼š ç”¨äºç›‘æ§PostgreSQLçš„postgres_exporterçš„æ–°åŠŸèƒ½ 


 ä¸‹åˆå¥½ï¼Œå“ˆä¼¯è¯»è€…ï¼ 


 æ™®ç½—ç±³ä¿®æ–¯åŠå…¶å‡ºå£å•†ï¼ˆä»£ç†å•†ï¼‰ç”Ÿæ€ç³»ç»Ÿæ˜¯ä»»ä½•ç®¡ç†å‘˜å’Œå¼€å‘äººå‘˜çš„å¥½å·¥å…·ã€‚ æ˜“äºäº¤ä»˜ï¼Œç®€å•ï¼ˆç›¸å¯¹ï¼‰è®¾ç½®ä»¥åŠä½¿ç”¨è‡ªåŠ¨æ£€æµ‹æœ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>postgres_exporterå¹¶ä½¿ç”¨å¤šä¸ªæ•°æ®åº“ç›‘è§†PostgreSQLå®ä¾‹</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468573/"><p> <strong>UPDï¼šè¯¥</strong>æ³¨é‡Šä¸0.8.0ç‰ˆæœ¬å¤±å»äº†è”ç³»ã€‚ æ‰€æœ‰åˆ›æ–°éƒ½å¯ä»¥åœ¨æ–‡ç« ä¸­æ‰¾åˆ°ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”¨äºç›‘æ§PostgreSQLçš„postgres_exporterçš„æ–°åŠŸèƒ½</a> </p><br><p> ä¸‹åˆå¥½ï¼Œå“ˆä¼¯è¯»è€…ï¼ </p><br><p> æ™®ç½—ç±³ä¿®æ–¯åŠå…¶å‡ºå£å•†ï¼ˆä»£ç†å•†ï¼‰ç”Ÿæ€ç³»ç»Ÿæ˜¯ä»»ä½•ç®¡ç†å‘˜å’Œå¼€å‘äººå‘˜çš„å¥½å·¥å…·ã€‚ æ˜“äºäº¤ä»˜ï¼Œç®€å•ï¼ˆç›¸å¯¹ï¼‰è®¾ç½®ä»¥åŠä½¿ç”¨è‡ªåŠ¨æ£€æµ‹æœåŠ¡çš„èƒ½åŠ›ã€‚ <br> ä½†è¿™ä¸Prometheusæ— å…³ï¼Œè€Œä¸è‘—åçš„ä»£ç†å•†ä¹‹ä¸€postgres_exporteræœ‰å…³ã€‚ å®ƒå…è®¸æ‚¨ä½¿ç”¨PostgreSQLæ”¶é›†æŒ‡æ ‡ã€‚ ä½†æ˜¯å¦‚æœä¸€åˆ‡éƒ½è¿™ä¹ˆç®€å•... </p><a name="habracut"></a><br><p> ä¸å¹¸çš„æ˜¯ï¼Œpostgres_exporteræ–‡æ¡£æ˜¯ç›¸å½“è‹¦è¡Œçš„ï¼Œåªå½±å“ä¸€èˆ¬æƒ…å†µã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æœ‰ä¸€ä¸ªåŒ…å«å¤šä¸ªæ•°æ®åº“çš„DBMSé›†ç¾¤å®ä¾‹ï¼Œå¹¶ä¸”/æˆ–è€…æƒ³ä¸€æ¬¡ä¸ºè¯¥é›†ç¾¤çš„å¤šä¸ªå®ä¾‹æ”¶é›†æŒ‡æ ‡ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ </p><br><h2 id="cel"> ç›®çš„ </h2><br><p> å®é™…ä¸Šï¼Œæ˜¯å…³äºæ–‡ç« çš„ç›®çš„æˆ–æ›´ç¡®åˆ‡åœ°è¯´æ˜¯æ³¨é‡Šã€‚ æˆ‘ç«‹å³æ³¨æ„åˆ°ï¼Œåœ¨è¿™é‡Œæˆ‘å°†ä¸æè¿°Prometheuså’Œpostgres_exporterçš„ç»„è£…æˆ–é…ç½®è¿‡ç¨‹ä»¥åŠå®ƒä»¬ä¹‹é—´çš„ç›¸äº’ä½œç”¨ã€‚ æ‰€æœ‰è¿™äº›éƒ½åœ¨æ–‡æ¡£å’Œè®¸å¤šå…¶ä»–æ¥æºä¸­è¿›è¡Œäº†æè¿°ã€‚ </p><br><p> æˆ‘æƒ³è°ˆè°ˆä½¿ç”¨postgres_exporterè§£å†³ç‰¹å®šé—®é¢˜çš„ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œå³ç”±ä¸€ä¸ªä»£ç†é€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¶é›†æŒ‡æ ‡ï¼š </p><br><ol><li> ä¸€ä¸ªå®ä¾‹ä¸­çš„å¤šä¸ªæ•°æ®åº“ï¼› </li><li> å‡ ä»½ï¼› </li><li> ä¸åŒå®ä¾‹ä¸Šçš„å¤šä¸ªæ•°æ®åº“ã€‚ </li></ol><br><h2 id="postgres_exporter">  postgres_exporter </h2><br><p> ä¸»è§‚ä¸Šï¼Œåˆ©å¼Šã€‚ </p><br><p> ä»ä¼˜ç‚¹ï¼š </p><br><ol><li> ç¬¬ä¸€ä¸ªä¹Ÿæ˜¯é‡è¦çš„ä¼˜åŠ¿æ˜¯æ˜“äºäº¤ä»˜å’Œé…ç½®ä»£ç†ã€‚ ä»£ç†-æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¯é€‰ï¼Œæ˜¯å…·æœ‰ä¸€ç»„ç”¨æˆ·æŒ‡æ ‡çš„yamlæ–‡ä»¶ï¼‰ã€‚ è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹å¿…éœ€çš„åˆ†å‘å’Œä½“ç³»ç»“æ„è¿›è¡Œç¼–è¯‘çš„è‡ªåŒ…å«åº”ç”¨ç¨‹åºï¼Œä¸éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…å…¶ä»–è½¯ä»¶åŒ…ã€‚ è¯¥ä»£ç†æ—¢å¯ä»¥å®‰è£…åœ¨ä¸ç¾¤é›†å®ä¾‹ç›¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå¯ä»¥å®‰è£…åœ¨å•ç‹¬çš„èŠ‚ç‚¹ä¸Šã€‚ </li><li> ä»£ç†ä½œä¸ºå¸¸è§„sqlå®¢æˆ·ç«¯è¿æ¥åˆ°DBMSã€‚ å¯ä»¥é€šè¿‡inetæˆ–é€šè¿‡unixå¥—æ¥å­—è¿›è¡Œè¿æ¥ï¼› </li><li> ä¸€ç§ä»£ç†ä»å¤šä¸ªå®ä¾‹å®ä¾‹å’Œ/æˆ–ä¸€ä¸ªå®ä¾‹çš„å¤šä¸ªæ•°æ®åº“æ¥æ”¶åº¦é‡çš„èƒ½åŠ›ï¼› </li><li> æ ¹æ®Prometheusæˆ–å…¶ä»–æ”¶é›†è€…çš„è¦æ±‚æ”¶é›†åº¦é‡æ ‡å‡†ï¼› </li><li> é€šè¿‡ç®€å•çš„HTTPè¯·æ±‚æ¥æ”¶æŒ‡æ ‡çš„èƒ½åŠ›ï¼› </li><li> ä»£ç†è‡ªåŠ¨æ¥æ”¶å•ä¸ªPostgreSQLå®ä¾‹ä¸Šçš„æ•°æ®åº“åˆ—è¡¨ï¼ˆå…·æœ‰postgres_exporter 0.5.0+ç‰ˆæœ¬ï¼‰åï¼Œå‡ºç°äº†--auto-discover-databasesé€‰é¡¹ã€‚ </li></ol><br><p> ç¼ºç‚¹ï¼š </p><br><ol><li> ç¼ºä¹æˆæƒï¼› </li><li> ä»…é€šè¿‡HTTPè¿›è¡Œæ•°æ®ä¼ è¾“ã€‚ æ‰€æœ‰æŒ‡æ ‡å°†ä»¥æ˜æ–‡å½¢å¼ä¼ è¾“ã€‚ è¿™å¾ˆä¸å¥½ï¼Œå› ä¸ºæ”»å‡»è€…åœ¨è¢«æ‹¦æˆªæ—¶å¯ä»¥è·å¾—å¯é çš„æ•°æ®åº“å’Œè§’è‰²åˆ—è¡¨ã€‚ </li><li> ä¸ç¼“å­˜æŒ‡æ ‡ã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå½“ä»£ç†å¯¹äºç½‘ç»œä¸å¯ç”¨æ—¶ï¼ŒPrometheuså°†ä¸ä¼šæ¥æ”¶ä¸å¯ç”¨æ—¶é—´æ®µçš„æ•°æ®ã€‚ </li><li> ä½¿ç”¨--auto-discover-databasesé€‰é¡¹æ—¶ï¼Œæ— æ³•ä»åˆ—è¡¨ä¸­æ’é™¤æŸäº›æ•°æ®åº“ã€‚ è¿™æ˜¯æš‚æ—¶çš„ï¼Œå› ä¸ºåœ¨ä¸‹ä¸€ä¸ªå‘è¡Œç‰ˆä¸­åº”è¯¥å·²ç»å‡ºç°äº†è¿™ç§å¯èƒ½æ€§ï¼ˆé€‰é¡¹--exclude-databasesï¼‰ã€‚ </li></ol><br><h3 id="neskolko-baz-dannyh-v-odnom-ekzemplyare"> ä¸€ä¸ªå®ä¾‹ä¸­çš„å¤šä¸ªæ•°æ®åº“ </h3><br><p> å¥½å§ï¼Œè®©æˆ‘ä»¬ç»§ç»­ç»ƒä¹ ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰å¤šä¸ªæ•°æ®åº“çš„PostgreSQLå®ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦ç»„ç»‡å®ä¾‹æŒ‡æ ‡å’Œæ‰€æœ‰æ•°æ®åº“çš„é›†åˆã€‚ <br> ä¸ºä»€ä¹ˆæˆ‘è¦åˆ†ç¦»æ•°æ®åº“æŒ‡æ ‡å’Œé›†ç¾¤å®ä¾‹çš„é›†åˆï¼Œä¸€åˆ‡éƒ½éå¸¸ç®€å•ï¼Œpostgres_exporteråœ¨åŒä¸€é›†ç¾¤ä¸Šä½¿ç”¨å¤šä¸ªæ•°æ®åº“çš„åœºæ™¯æš—ç¤ºäº†åœ¨ä¸åŒæ•°æ®åº“ä¸­æ‰§è¡ŒåŒä¸€ç»„sqlæŸ¥è¯¢ã€‚ ç»“æœï¼Œå½“å°è¯•ä»pg_stat_replicationï¼Œpg_stat_activityï¼Œpg_stat_statementè§†å›¾ç­‰ä¸­è·å–æŒ‡æ ‡æ—¶ã€‚ å¯¹äºé›†ç¾¤æ¥è¯´æ˜¯é€šç”¨çš„ï¼Œåœ¨ç†è§£postgres_exporterçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ€»æ˜¯å¾—åˆ°ç›¸åŒçš„åº¦é‡æ ‡å‡†é›†ï¼Œè¿™å°†å¯¼è‡´é‡å¤çš„é”®å’Œå€¼ï¼Œä»è€Œå¯¼è‡´é”™è¯¯ã€‚ <br> è®©æˆ‘ä»¬çœ‹çœ‹å®ƒåœ¨å®é™…ä¸­çš„å¤–è§‚ã€‚ </p><br><p> æˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰ä¸€ç»„æ•°æ®åº“çš„æµ‹è¯•å®ä¾‹ï¼š </p><br><pre><code class="plaintext hljs">List of databases Name | Owner | Encoding | Collate | Ctype | Access privileges -----------+----------+----------+------------+------------+----------------------- dbtest1 | postgres | UTF8 | en_US.utf8 | en_US.utf8 | dbtest2 | postgres | UTF8 | en_US.utf8 | en_US.utf8 | dbtest3 | postgres | UTF8 | en_US.utf8 | en_US.utf8 | postgres | postgres | UTF8 | en_US.utf8 | en_US.utf8 |</code> </pre> <br><p> æˆ‘ä»¬ä½¿ç”¨é€‰é¡¹--auto-discover-databaseså¯åŠ¨postgres_exporterï¼ˆå¦‚æœæœªåœ¨è¿æ¥å­—ç¬¦ä¸²ä¸­æŒ‡å®šæ•°æ®åº“åç§°ï¼Œåˆ™å°†ä½¿ç”¨ç”¨æˆ·åå»ºç«‹ä¸æ•°æ®åº“çš„è¿æ¥ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">$ DATA_SOURCE_NAME="postgresql://postgres@127.0.0.1:5432/?sslmode=disable" ./postgres_exporter --auto-discover-databases --log.format=logger:stdout</code> </pre> <br><ul><li>  DATA_SOURCE_NAME-ç¯å¢ƒå˜é‡ï¼ŒåŒ…å«ç”¨äºè¿æ¥åˆ°PostgreSQLå®ä¾‹çš„å‚æ•° </li></ul><br><p> åœ¨ä»£ç†çš„è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°ä¸€å¹…ç”°å›­è¯—èˆ¬çš„å›¾ç‰‡ï¼Œå®ƒå·²å¯åŠ¨å¹¶èƒ½å¤Ÿè¿æ¥åˆ°é›†ç¾¤ä¸­çš„æ‰€æœ‰æ•°æ®åº“ï¼ˆå°½ç®¡å®ƒä¸ä¼šå†™å…¥å“ªä¸ªæ•°æ®åº“ï¼Œä½†å¸Œæœ›å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">INFO[0000] Established new database connection to "127.0.0.1:5432". source="postgres_exporter.go:788" INFO[0000] Established new database connection to "127.0.0.1:5432". source="postgres_exporter.go:788" INFO[0000] Semantic Version Changed on "127.0.0.1:5432": 0.0.0 -&gt; 11.5.0 source="postgres_exporter.go:1251" INFO[0000] Semantic Version Changed on "127.0.0.1:5432": 0.0.0 -&gt; 11.5.0 source="postgres_exporter.go:1251" INFO[0000] Established new database connection to "127.0.0.1:5432". source="postgres_exporter.go:788" INFO[0000] Semantic Version Changed on "127.0.0.1:5432": 0.0.0 -&gt; 11.5.0 source="postgres_exporter.go:1251" INFO[0000] Established new database connection to "127.0.0.1:5432". source="postgres_exporter.go:788" INFO[0000] Semantic Version Changed on "127.0.0.1:5432": 0.0.0 -&gt; 11.5.0 source="postgres_exporter.go:1251" INFO[0000] Established new database connection to "127.0.0.1:5432". source="postgres_exporter.go:788" INFO[0000] Semantic Version Changed on "127.0.0.1:5432": 0.0.0 -&gt; 11.5.0 source="postgres_exporter.go:1251" INFO[0000] Starting Server: :9187 source="postgres_exporter.go:1490"</code> </pre> <br><p> æˆ‘è®¤ä¸ºç»†å¿ƒçš„è¯»è€…ä¼šæ³¨æ„åˆ°é›†ç¾¤ä¸­æœ‰å››ä¸ªåŸºç¡€ï¼ˆpostgresï¼Œdbtest1ï¼Œdbtest2å’Œdbtest3ï¼Œtemplate0å’Œtemplate1è¢«å¿½ç•¥ï¼‰ï¼Œå¹¶ä¸”æœ‰äº”ä¸ªè¿æ¥ã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œpostgres_exporteråˆ›å»ºåˆ°postgresæ•°æ®åº“çš„ä¸¤ä¸ªè¿æ¥ã€‚ ä½¿ç”¨æ­¤åŠŸèƒ½æ—¶ï¼Œæ‚¨éœ€è¦éå¸¸å°å¿ƒã€‚ æ€ä¹ˆäº† æˆ‘ä»¬å°†è¿›ä¸€æ­¥äº†è§£è¿™ä¸€ç‚¹ã€‚ </p><br><p> å¥½å§ï¼Œè®©æˆ‘ä»¬ç»§ç»­å°è¯•è·å–æŒ‡æ ‡ï¼š </p><br><pre> <code class="plaintext hljs">$ curl http://localhost:9178/metrics</code> </pre> <br><p> ç»“æœï¼Œåœ¨è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬æ”¶åˆ°æœ‰å…³â€œä»¥å‰ç”¨ç›¸åŒçš„åç§°å’Œæ ‡ç­¾å€¼æ”¶é›†çš„é‡å¤é¡¹â€çš„è­¦å‘Šï¼ˆä½†åœ¨postgres_exporteræ—¥å¿—ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹ä¸åˆ°è­¦å‘Šï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">... * collected metric pg_stat_activity_max_tx_duration label:&lt;name:"datname" value:"dbtest1" &gt; label:&lt;name:"server" value:"127.0.0.1:5432" &gt; label:&lt;name:"state" value:"fastpath function call" &gt; gauge:&lt;value:0 &gt; was collected before with the same name and label values * collected metric pg_stat_bgwriter_checkpoints_timed label:&lt;name:"server" value:"127.0.0.1:5432" &gt; counter:&lt;value:1 &gt; was collected before with the same name and label values ...</code> </pre> <br><p> æ‘†è„±é”™è¯¯çš„å”¯ä¸€æ–¹æ³•æ˜¯é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨æŒ‡æ ‡æ”¶é›†ã€‚ æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œï¼šé¦–å…ˆå°†ç¯å¢ƒå˜é‡PG_EXPORTER_DISABLE_DEFAULT_METRICSå’ŒPG_EXPORTER_DISABLE_SETTINGS_METRICSè®¾ç½®ä¸ºtrueæˆ–ä½¿ç”¨é€‰é¡¹--disable-default-metricså’Œ--disable-settings-metrics </p><br><p> ä½¿ç”¨å…¶ä»–é€‰é¡¹é‡æ–°å¯åŠ¨postgres_exporterï¼š </p><br><pre> <code class="plaintext hljs">$ DATA_SOURCE_NAME="postgresql://postgres@127.0.0.1:5432/?sslmode=disable" ./postgres_exporter --auto-discover-databases --log.format=logger:stdout --disable-default-metrics --disable-settings-metrics</code> </pre> <br><p> å°è¯•è·å–æŒ‡æ ‡ï¼š </p><br><pre> <code class="plaintext hljs">$ curl http://localhost:9178/metrics</code> </pre> <br><p> å› æ­¤ï¼Œä¸€åˆ‡éƒ½æŒ‰è®¡åˆ’è¿›è¡Œï¼Œä½†æ˜¯è¾“å‡ºä¸­æ²¡æœ‰ä¸PostgreSQLç›¸å…³çš„å•ä¸ªæŒ‡æ ‡ï¼š </p><br><pre> <code class="plaintext hljs"># HELP go_gc_duration_seconds A summary of the GC invocation durations. # TYPE go_gc_duration_seconds summary go_gc_duration_seconds{quantile="0"} 0 go_gc_duration_seconds{quantile="0.25"} 0 go_gc_duration_seconds{quantile="0.5"} 0 go_gc_duration_seconds{quantile="0.75"} 0 go_gc_duration_seconds{quantile="1"} 0 go_gc_duration_seconds_sum 0 go_gc_duration_seconds_count 0 ... # HELP process_virtual_memory_bytes Virtual memory size in bytes. # TYPE process_virtual_memory_bytes gauge process_virtual_memory_bytes 1.3832192e+07</code> </pre> <br><p> æ­¤å¤–ï¼Œä¸ºäº†è·å¾—æœ‰æ•ˆè´Ÿè½½ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ¥æè¿°æˆ‘ä»¬æƒ³è¦æ¥æ”¶çš„æŒ‡æ ‡ï¼ˆåˆ«å¿˜äº†ï¼Œæˆ‘ä»¬åªèƒ½æ”¶é›†ç‰¹å®šäºæ•°æ®åº“çš„æŒ‡æ ‡ï¼‰ã€‚ </p><br><p> å¯¹äºæµ‹è¯•ï¼Œæˆ‘ä»¬å°†ä»pg_statio_user_tableså…³ç³»ä¸­æ”¶é›†æŒ‡æ ‡ã€‚ ä¸ºæ­¤ï¼Œè¯·åˆ›å»ºä¸€ä¸ªå…·æœ‰ä»¥ä¸‹å†…å®¹çš„querys.yamlæ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs">pg_statio_user_tables: query: "SELECT current_database() as datname, schemaname, relname, heap_blks_read, heap_blks_hit FROM pg_statio_user_tables" metrics: - datname: usage: "LABEL" description: "Name of database" - schemaname: usage: "LABEL" description: "Name of the schema that this table is in" - relname: usage: "LABEL" description: "Name of this table" - heap_blks_read: usage: "COUNTER" description: "Number of disk blocks read from this table" - heap_blks_hit: usage: "COUNTER" description: "Number of buffer hits in this table"</code> </pre> <br><p> æˆ‘è®¤ä¸ºåœ¨è¿™é‡Œæœ‰å¿…è¦æ¾„æ¸…ä¸€ç‚¹ï¼Œå³æ·»åŠ è¦åœ¨å…¶ä¸­æ‰§è¡ŒæŸ¥è¯¢çš„æ•°æ®åº“çš„åç§°ã€‚ è¿™æ˜¯ä¸€é¡¹å¼ºåˆ¶æ€§è¦æ±‚ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸¤ä¸ªåŸå› ï¼š </p><br><ol><li> æ•°æ®åº“å¯èƒ½å…·æœ‰åŒåçš„è¡¨ï¼Œè¿™å°†ç”±äºé‡å¤åº¦é‡è€Œå¯¼è‡´é”™è¯¯ï¼› </li><li> å¦åˆ™ï¼Œæ‚¨å°†æ— æ³•ç¡®å®šæŒ‡æ ‡æ‰€å¼•ç”¨çš„æ•°æ®åº“ï¼Œè¿™å°†æŠŠæ”¶é›†åˆ°çš„æ•°æ®å˜æˆåƒåœ¾ã€‚ </li></ol><br><p> å› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨--extend.query-pathé€‰é¡¹å¯åŠ¨ä»£ç†ï¼ˆæ­¤å¤„æ˜¾ç¤ºäº†å¸¦æœ‰æŒ‡æ ‡æè¿°çš„yamlæ–‡ä»¶çš„è·¯å¾„ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">DATA_SOURCE_NAME="postgresql://postgres@127.0.0.1:5432?sslmode=disable" ./postgres_exporter --log.format=logger:stdout --auto-discover-databases --disable-default-metrics --disable-settings-metrics --extend.query-path=./queries.yaml</code> </pre> <br><p> æˆ‘ä»¬æ­£åœ¨å°è¯•è·å–æŒ‡æ ‡ï¼ˆä¸ºæ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬ä»…é‡‡ç”¨pg_statio_user_tables_heap_blks_hitï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">curl -s http://localhost:9187/metrics | grep pg_statio_user_tables_heap_blks_hit</code> </pre> <br><p> ç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ç»„å”¯ä¸€è§£é‡Šçš„æŒ‡æ ‡ï¼š </p><br><pre> <code class="plaintext hljs"># HELP pg_statio_user_tables_heap_blks_hit Number of buffer hits in this table # TYPE pg_statio_user_tables_heap_blks_hit counter pg_statio_user_tables_heap_blks_hit{datname="dbtest1",relname="t1",schemaname="public",server="127.0.0.1:5432"} 0 pg_statio_user_tables_heap_blks_hit{datname="dbtest1",relname="t2",schemaname="public",server="127.0.0.1:5432"} 0 pg_statio_user_tables_heap_blks_hit{datname="dbtest2",relname="t1",schemaname="public",server="127.0.0.1:5432"} 0 pg_statio_user_tables_heap_blks_hit{datname="dbtest2",relname="t2",schemaname="public",server="127.0.0.1:5432"} 0 pg_statio_user_tables_heap_blks_hit{datname="dbtest3",relname="t1",schemaname="public",server="127.0.0.1:5432"} 0 pg_statio_user_tables_heap_blks_hit{datname="dbtest3",relname="t2",schemaname="public",server="127.0.0.1:5432"} 0</code> </pre> <br><p> ç»“æœï¼Œæˆ‘ä»¬æœ‰æœºä¼šä½¿ç”¨--auto-discover-databasesé€‰é¡¹ä»é›†ç¾¤çš„ä¸€ä¸ªå®ä¾‹çš„æ‰€æœ‰æ•°æ®åº“ä¸­æ”¶é›†æŒ‡æ ‡ã€‚ ä¸€ä¸ªä¸é”™çš„å¥½å¤„æ˜¯ï¼Œå½“æ‚¨æ·»åŠ æ–°æ•°æ®åº“æ—¶ï¼Œæ— éœ€é‡æ–°å¯åŠ¨ä»£ç†ã€‚ <br> ä½†æ˜¯ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬ä»ç„¶æ²¡æœ‰å®ä¾‹æŒ‡æ ‡ã€‚ ç›®å‰ï¼Œè§£å†³æ–¹æ¡ˆåªæ˜¯ä¸€ç§-ä½¿ç”¨ä¸åŒçš„ä»£ç†æ¥æ”¶é›†æ•°æ®åº“å’Œå®ä¾‹æŒ‡æ ‡ã€‚ <br> å½“ç„¶ï¼Œå®ƒçœ‹èµ·æ¥ä¸å¤ªå¥½ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å¯¹ä»£ç†è¿›è¡Œåˆ†ç»„ä»¥æ”¶é›†æ¥è‡ªå¤šä¸ªå®ä¾‹çš„æŒ‡æ ‡æ¥æ¶ˆé™¤è¿™ç§éº»çƒ¦ã€‚ æˆ‘ä»¬å°†åœ¨ä¸‹é¢è€ƒè™‘è¿™å¦ä¸€ä¸ªæœ‰è¶£çš„æœºä¼šã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">â€œé¢å¤–â€è”ç³»ä¹‹è°œçš„ç­”æ¡ˆ</b> <div class="spoiler_text"><p> è¯·è®°ä½ï¼Œåœ¨ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬æè¯·æ³¨æ„â€œé¢å¤–â€è¿æ¥ï¼Œå› æ­¤ï¼Œè¿™æ˜¯postgres_exporterçš„åŠŸèƒ½ï¼Œå¸¦æœ‰--auto-discover-databasesé€‰é¡¹ã€‚ <br> ä½†æ˜¯ï¼Œä¸ºä»€ä¹ˆè¿™ä¼šå¼•èµ·å¾ˆå¤šéº»çƒ¦å‘¢ï¼Ÿ å®é™…ä¸Šï¼Œä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼Œå¹¶ä¸”å·²ç»åœ¨ä¸Šé¢è¿›è¡Œäº†æè¿°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé—®é¢˜åœ¨äºpostgres_exporterå°†ä¸¤æ¬¡ä»postgresæ•°æ®åº“æ”¶é›†åº¦é‡å¹¶å¼€å§‹å¤åˆ¶åº¦é‡ã€‚ åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œåªæœ‰--exclude-databasesé€‰é¡¹çš„å¤–è§‚æ‰æœ‰å¸®åŠ©ï¼ˆå› æ­¤æˆ‘ä»¬æœŸå¾…ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼‰ã€‚ <br> æ˜¯çš„ï¼Œå¦‚æœæ‚¨åœ¨postgresæ•°æ®åº“ä¸­æœ‰ç”¨æˆ·è¡¨ï¼Œé‚£ä¹ˆä¸Šé¢çš„ç¤ºä¾‹å°†ä¸èµ·ä½œç”¨ã€‚ </p></div></div><br><h3 id="neskolko-ekzemplyarov"> å¤šä¸ªå®ä¾‹ </h3><br><p> å¥½å§ï¼Œç»§ç»­å‰è¿›ã€‚ æˆ‘ä»¬æ‰¾åˆ°äº†å¦‚ä½•ä»å¤šä¸ªæ•°æ®åº“è·å–æŒ‡æ ‡çš„æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬å°†è€ƒè™‘ä½¿ç”¨ä¸€ä¸ªä»£ç†ç›‘è§†å¤šä¸ªå®ä¾‹çš„é€‰é¡¹ã€‚ éå¸¸ç®€å•ï¼Œä¸ºæ­¤åªéœ€åœ¨ç¯å¢ƒå˜é‡DATA_SOURCE_NAMEä¸­å°†å®ƒä»¬åˆ—å‡ºï¼Œå¹¶ç”¨é€—å·åˆ†éš”å°±å¯ä»¥äº†ï¼š </p><br><pre> <code class="plaintext hljs">$ DATA_SOURCE_NAME="postgresql://postgres@127.0.0.1:5432/postgres?sslmode=disable,postgresql://postgres@127.0.0.1:5434/postgres?sslmode=disable" ./postgres_exporter --log.format=logger:stdout</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è¿æ¥åˆ°åœ¨æœ¬åœ°èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ä¸¤ä¸ªä¸åŒçš„é›†ç¾¤å®ä¾‹ã€‚ è¿™æ˜¯æ—¥å¿—ä¸­çš„æ ·å­ï¼š </p><br><pre> <code class="plaintext hljs">INFO[0000] Established new database connection to "127.0.0.1:5432". source="postgres_exporter.go:788" INFO[0000] Semantic Version Changed on "127.0.0.1:5432": 0.0.0 -&gt; 11.5.0 source="postgres_exporter.go:1251" INFO[0000] Established new database connection to "127.0.0.1:5434". source="postgres_exporter.go:788" INFO[0000] Semantic Version Changed on "127.0.0.1:5434": 0.0.0 -&gt; 11.5.0 source="postgres_exporter.go:1251" INFO[0000] Starting Server: :9187 source="postgres_exporter.go:1490"</code> </pre> <br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•è·å–æŒ‡æ ‡ï¼ˆä¸ºæ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬å°†è‡ªå·±é™åˆ¶ä¸ºpg_stat_database_blk_read_timeæŒ‡æ ‡ï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">curl -s http://localhost:9187/metrics | grep pg_stat_database_blk_read_time</code> </pre> <br><p> ç»“æœï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªä»£ç†è·å–äº†ä¸¤ä¸ªå®ä¾‹çš„æŒ‡æ ‡ï¼š </p><br><pre> <code class="plaintext hljs"># HELP pg_stat_database_blk_read_time Time spent reading data file blocks by backends in this database, in milliseconds # TYPE pg_stat_database_blk_read_time counter pg_stat_database_blk_read_time{datid="1",datname="template1",server="127.0.0.1:5432"} 0 pg_stat_database_blk_read_time{datid="1",datname="template1",server="127.0.0.1:5434"} 0 pg_stat_database_blk_read_time{datid="13116",datname="template0",server="127.0.0.1:5432"} 0 pg_stat_database_blk_read_time{datid="13116",datname="template0",server="127.0.0.1:5434"} 0 pg_stat_database_blk_read_time{datid="13117",datname="postgres",server="127.0.0.1:5432"} 0 pg_stat_database_blk_read_time{datid="13117",datname="postgres",server="127.0.0.1:5434"} 0 pg_stat_database_blk_read_time{datid="16384",datname="dbtest1",server="127.0.0.1:5432"} 0 pg_stat_database_blk_read_time{datid="16385",datname="dbtest2",server="127.0.0.1:5432"} 0 pg_stat_database_blk_read_time{datid="16386",datname="dbtest3",server="127.0.0.1:5432"} 0</code> </pre><br><p> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€åˆ‡éƒ½æ¯”ä¸€ä¸ªå®ä¾‹ä¸Šçš„å¤šä¸ªæ•°æ®åº“è¦ç®€å•å¾—å¤šã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬ä»ç„¶æœ‰æœºä¼šä»æ‰€æœ‰å®ä¾‹æ¥æ”¶å…¨å±€æŒ‡æ ‡ã€‚ </p><br><h2 id="rezyume"> æ€»ç»“ </h2><br><p> å› æ­¤ï¼Œä¸ºè¾¾åˆ°ç›®çš„è€ŒæŒ‡å‡ºçš„ç¬¬ä¸‰ç§æƒ…å†µæ˜¯ä¸Šè¿°ä¸¤ç§æƒ…å†µçš„ç»“åˆï¼Œå› æ­¤æˆ‘è®¤ä¸ºæ²¡æœ‰ç†ç”±æå‡ºè¿™ä¸€ç‚¹ã€‚ </p><br><p> å› æ­¤ï¼Œæˆ‘è®¤ä¸ºæœ€é‡è¦çš„æ˜¯postgres_exporterï¼Œå®ƒæ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£ä¸”å¾ˆæœ‰å‰é€”çš„ç®¡ç†å‘˜å·¥å…·ï¼Œç”¨äºç›‘è§†PostgreSQLé›†ç¾¤å®ä¾‹å’Œåœ¨å…¶ä¸Šéƒ¨ç½²çš„æ•°æ®åº“ã€‚ ä½†æ˜¯ç”±äºå…¶å¹´ä»£ä¹…è¿œï¼Œå¹¶éæ²¡æœ‰ç¼ºç‚¹å¯ä»¥ç†è§£å’ŒåŸè°…ã€‚ </p><br><h2 id="istochniki"> èµ„æ–™æ¥æº </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">Prometheus</a> [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">1</a> ]æ˜¯ç”¨äºç›‘è§†å’Œè­¦æŠ¥äº‹ä»¶çš„å¼€æºåº”ç”¨ç¨‹åºã€‚ å®ƒå°†å®æ—¶æŒ‡æ ‡å†™å…¥åˆ°ä½¿ç”¨HTTPè¯·æ±‚æ¨¡å‹æ„å»ºçš„æ—¶é—´åºåˆ—æ•°æ®åº“ä¸­ï¼Œå¹¶å…·æœ‰çµæ´»çš„æŸ¥è¯¢å’Œå®æ—¶è­¦æŠ¥ã€‚ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">postgres_exporter</a>æ˜¯Prometheusçš„PostgreSQLæŒ‡æ ‡çš„å¯¼å‡ºå™¨ã€‚ </li></ul><br><p> æ’°å†™æœ¬æ–‡æ—¶ï¼Œç‰ˆæœ¬ä¸º0.5.1ã€‚ æ”¯æŒçš„PostgreSQL 9.4+ç‰ˆæœ¬ï¼ˆæºä»£ç ä¸­æ³¨æ˜äº†9.1+ç‰ˆæœ¬çš„é™åˆ¶ï¼‰ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN468573/">https://habr.com/ru/post/zh-CN468573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN468557/index.html">WEB 3.0-å°„å¼¹çš„ç¬¬äºŒç§æ–¹æ³•</a></li>
<li><a href="../zh-CN468559/index.html">å¤‡ä»½äº‘ï¼Œæœ‹å‹</a></li>
<li><a href="../zh-CN468561/index.html">å®‰å…¨å‘¨39ï¼šå®‰å…¨å’Œå¸¸è¯†é”™è¯¯</a></li>
<li><a href="../zh-CN468563/index.html">å®ˆæœ›è€…è§‚çœ‹ï¼šç©ºé—´è·Ÿè¸ªè®¾æ–½çš„ç°çŠ¶</a></li>
<li><a href="../zh-CN468565/index.html">ESP8266è§¦æ‘¸å±ä¸Šçš„è‡ªåˆ¶ç›–é©è®¡æ•°å™¨</a></li>
<li><a href="../zh-CN468577/index.html">Patch'ti-ä¸ç®—åœ¨å†…ï¼šé¢éƒ¨å’Œé¢œè‰²çš„è¡¥ä¸ç®¡ç†æ•…äº‹</a></li>
<li><a href="../zh-CN468579/index.html">ä¸å¼€å‘å¹¶è¡Œè¿›è¡Œé‡æ„ï¼šæˆ‘ä»¬çš„ç»éªŒå’Œä¸¤ä¸ªæ¸…å•</a></li>
<li><a href="../zh-CN468581/index.html">å¿«é€Ÿï¼Œå®Œæ•´åœ°åˆ†äº«ï¼Œé’“é±¼</a></li>
<li><a href="../zh-CN468583/index.html">â€œæŠ¢æ•‘â€å‘½ä»¤ä¸­çš„æ¸¸æˆç¤ºä¾‹ï¼ˆé€šè¿‡ç¤ºä¾‹åˆ†æåå¤šä¸ªäº‹ä»¶ï¼‰</a></li>
<li><a href="../zh-CN468589/index.html">å¦‚ä½•åœ¨é€šç”¨ç»„ä»¶åº“ä¸Šç»„ç»‡å·¥ä½œ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>