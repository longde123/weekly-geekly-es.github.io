<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úãüèæ üë®üèø‚Äçüé§ üîì C√≥mo creamos nuestra biblioteca de la Galer√≠a de Android para ver contenido multimedia üîé üõ§Ô∏è ‚ÜôÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! No hace mucho tiempo, en busca de aventuras, nuevos proyectos y tecnolog√≠as, yo  se convirti√≥ en un robot  Se instal√≥ en Redmadrobot. Tengo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo creamos nuestra biblioteca de la Galer√≠a de Android para ver contenido multimedia</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redmadrobot/blog/433076/"><p><img src="https://habrastorage.org/webt/fl/a3/rh/fla3rh2hkzl_guxybjkro7f8hua.png"><br><br>  Hola Habr!  No hace mucho tiempo, en busca de aventuras, nuevos proyectos y tecnolog√≠as, yo <del>  se convirti√≥ en un robot </del>  Se instal√≥ en Redmadrobot.  Tengo una silla, un monitor y un macbook, y un peque√±o proyecto interno para el calentamiento.  Era necesario terminar y publicar una biblioteca autoescrita para ver el contenido multimedia que usamos en nuestros proyectos.  En el art√≠culo, le dir√© c√≥mo comprender los eventos t√°ctiles en una semana, convertirse en un c√≥digo abierto, encontrar un error en el SDK de Android y publicar una biblioteca. </p><a name="habracut"></a><br><h2 id="nachalo">  Inicio </h2><br><p>  Una de las caracter√≠sticas importantes de las aplicaciones de nuestra tienda es la capacidad de ver videos y fotos de productos y servicios cerca y desde todos lados.  No quer√≠amos reinventar la rueda y fuimos a buscar una biblioteca terminada que se adaptara a nosotros. </p><br><p>  Planeamos encontrar una soluci√≥n para que el usuario pudiera: </p><br><ul><li>  ver fotos; </li><li>  Escala fotos usando pellizcar para hacer zoom y doble toque; </li><li>  Ver un video </li><li>  voltear contenido multimedia; </li><li>  cierre la tarjeta fotogr√°fica con un deslizamiento vertical (deslice para descartar). </li></ul><br><p>  Esto es lo que encontramos: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FrescoImageViewer</a> : admite la visualizaci√≥n y el desplazamiento a trav√©s de fotos y gestos b√°sicos, pero no admite la visualizaci√≥n de videos y est√° destinado a la biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Fresco</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PhotoView</a> : admite la visualizaci√≥n de fotos, la mayor√≠a de los principales gestos de control, excepto el desplazamiento, deslizar para descartar, no admite la visualizaci√≥n de videos. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PhotoDraweeView</a> : similar en funcionalidad a PhotoView, pero destinado a Fresco. </li></ul><br><p>  Como ninguna de las bibliotecas encontr√≥ que cumpl√≠a con los requisitos, tuvimos que escribir la nuestra. </p><br><h2 id="realizuem-biblioteku">  Nos damos cuenta de la biblioteca </h2><br><p>  Para obtener la funcionalidad necesaria, finalizamos las soluciones existentes de otras bibliotecas.  Decidieron dar el modesto nombre de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Android Gallery a</a> lo que sucedi√≥. </p><br><h3 id="realizuem-funkcionalnost">  Implementamos funcionalidad </h3><br><p>  <strong>Ver y ampliar fotos</strong> <br>  Para ver fotos, tomamos la biblioteca PhotoView, que admite el escalado de f√°brica. </p><br><p>  <strong>Ver video</strong> <br>  Para ver el video, tomaron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ExoPlayer</a> , que se reutiliza en <a href="">MediaPagerAdapter</a> .  Cuando un usuario abre un video por primera vez, se crea ExoPlayer.  Al cambiar a otro elemento, se pone en cola, por lo que la pr√≥xima vez que inicie el video, se utilizar√° la instancia de ExoPlayer ya creada.  Esto hace que la transici√≥n entre elementos sea m√°s suave. </p><br><p> <strong>Desplazamiento de contenido multimedia</strong> <br>  Aqu√≠ utilizamos <a href="">MultiTouchViewPager</a> de FrescoImageViewer, que no intercepta eventos multit√°ctiles, por lo que pudimos agregarle gestos para escalar la imagen. </p><br><p>  <strong>Desliza para descartar</strong> <br>  PhotoView no admit√≠a deslizar para descartar y eliminar el rebote (restaurar el tama√±o de la imagen original cuando la imagen se escala hacia arriba o hacia abajo). <br>  As√≠ es como logramos manejarlo. </p><br><h3 id="izuchaem-touch-events-dlya-realizacii-swipe-to-dismiss">  Aprendizaje de eventos t√°ctiles para implementar deslizar para descartar </h3><br><p> Antes de pasar a admitir deslizar para descartar, debe comprender c√≥mo funcionan los eventos t√°ctiles.  Cuando el usuario toca la pantalla, se llama al m√©todo <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> en la Actividad actual, donde llega <code>MotionEvent.ACTION_DOWN</code> .  Este m√©todo decide el destino del evento.  Puede pasar <code>motionEvent</code> a <code>onTouchEvent(motionEvent: MotionEvent)</code> para el procesamiento t√°ctil, o dejarlo ir m√°s all√°, de arriba a abajo, en la jerarqu√≠a Ver.  Ver, que est√° interesado en un evento y / o eventos posteriores antes de <code>ACTION_UP</code> , devuelve verdadero. </p><br><p>  Despu√©s de eso, todos los eventos del gesto actual caer√°n en esta Vista hasta que el gesto termine con el evento <code>ACTION_UP</code> o el ViewGroup padre tome el control (entonces el evento <code>ACTION_CANCELED</code> pasar√° a la Vista).  Si el evento recorri√≥ toda la jerarqu√≠a de Vista y nadie estaba interesado, volver√° a la Actividad en <code>onTouchEvent(motionEvent: MotionEvent)</code> . <br><br><img src="https://habrastorage.org/webt/yz/np/jd/yznpjdfaodnwmd3tzy_wldagyak.png"><br><br>  En nuestra biblioteca de Android Gallery, el primer evento <code>ACTION_DOWN</code> llega a <code>dispatchTouchEvent()</code> en PhotoView, donde <code>motionEvent</code> pasa a la implementaci√≥n <code>onTouch()</code> , que devuelve verdadero.  Adem√°s, todos los eventos pasan por la misma cadena hasta uno de: </p><br><ul><li>  <code>ACTION_UP</code> ; </li><li>  ViewPager intentar√° interceptar el evento para desplazarse; </li><li>  <a href="">VerticalDragLayout</a> intentar√° interceptar el evento para deslizar y descartar. </li></ul><br><p>  Solo ViewGroup en el <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> puede interceptar eventos.  Incluso si la Vista est√° interesada en cualquier MotionEvent, el evento en s√≠ pasar√° por el <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> toda la cadena ViewGroup anterior.  En consecuencia, los padres siempre "vigilan" a sus hijos.  Cualquier ViewGroup principal puede interceptar el evento y devolver verdadero en el <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> , luego todas las <code>MotionEvent.ACTION_CANCEL</code> secundarias recibir√°n <code>MotionEvent.ACTION_CANCEL</code> en <code>onTouchEvent(motionEvent: MotionEvent)</code> . </p><br><p>  Ejemplo: el usuario mantiene un dedo sobre un elemento en un RecyclerView, luego los eventos se procesan en el mismo elemento.  Pero tan pronto como comience a mover su dedo hacia arriba / abajo, RecyclerView interceptar√° los eventos, comenzar√° el desplazamiento y la Vista recibir√° el evento <code>ACTION_CANCEL</code> . <br><br><img src="https://habrastorage.org/webt/yp/x9/kf/ypx9kf8alvwtag0jfihj-jrzjmo.png"><br><br>  En la Galer√≠a de Android, VerticalDragLayout puede interceptar eventos para deslizar para descartar o ViewPager para desplazarse.  Pero View puede evitar que el padre <code>requestDisallowInterceptTouchEvent(true)</code> eventos llamando al m√©todo <code>requestDisallowInterceptTouchEvent(true)</code> .  Esto puede ser necesario si la Vista necesita realizar acciones cuya intercepci√≥n por parte del padre no es deseable para nosotros. </p><br><p>  Por ejemplo, cuando un usuario en un jugador salta una pista a un tiempo espec√≠fico.  Si el ViewPager padre interceptara un desplazamiento horizontal, habr√≠a una transici√≥n a la siguiente pista. </p><br><p>  Para manejar el deslizamiento para descartar, escribimos VerticalDragLayout, pero no recibi√≥ eventos t√°ctiles de PhotoView.  Para entender por qu√© sucede esto, tuve que descubrir c√≥mo se procesan los eventos t√°ctiles en PhotoView. </p><br><p>  Orden de procesamiento: </p><br><ol><li>  Cuando MotionEvent.ACTION_DOWN en VerticalDragLayout, <code>interceptTouchEvent()</code> activa <code>interceptTouchEvent()</code> , que devuelve falso, porque  este ViewGroup solo est√° interesado en ACTION_MOVE vertical.  La direcci√≥n ACTION_MOVE se define en <code>dispatchTouchEvent()</code> , despu√©s de lo cual el evento se pasa al m√©todo <code>super.dispatchTouchEvent()</code> en ViewGroup, donde el evento se pasa a la implementaci√≥n <code>interceptTouchEvent()</code> en VerticalDragLayout. <br><br><img src="https://habrastorage.org/webt/le/zg/xb/lezgxbf8n-_tnhdpqc96drpjqvm.png"><br><br></li><li>  Cuando el evento <code>ACTION_DOWN</code> alcanza el m√©todo <code>onTouch()</code> en PhotoView, la vista elimina la capacidad de interceptar la gesti√≥n de eventos.  Todos los eventos de gestos posteriores no entran en el m√©todo <code>interceptTouchEvent()</code> .  La capacidad de interceptar el control se otorga al padre solo si se completa el gesto o si <code>ACTION_MOVE</code> horizontal <code>ACTION_MOVE</code> en el borde derecho / izquierdo de la imagen. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScrollEdge == EDGE_BOTH || (mScrollEdge == EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mScrollEdge == EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p><img src="https://habrastorage.org/webt/kk/s3/pj/kks3pjkovqsyiyiaif64bc_qh3e.png"><br><br>  Dado que PhotoView permite al padre interceptar el control solo en el caso de <code>ACTION_MOVE</code> horizontal, y deslizar para descartar es <code>ACTION_MOVE</code> vertical, entonces VerticalDragLayout no puede interceptar el control de eventos para implementar un gesto.  Para solucionar esto, debe agregar la capacidad de interceptar el control en caso de <code>ACTION_MOVE</code> vertical. <br></p><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mHorizontalScrollEdge == HORIZONTAL_EDGE_BOTH || (mHorizontalScrollEdge == HORIZONTAL_EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mHorizontalScrollEdge == HORIZONTAL_EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>) || mVerticalScrollEdge == VERTICAL_EDGE_BOTH || (mVerticalScrollEdge == VERTICAL_EDGE_TOP &amp;&amp; dy &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mVerticalScrollEdge == VERTICAL_EDGE_BOTTOM &amp;&amp; dy &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p>  Ahora, en el caso de la primera <code>ACTION_MOVE</code> PhotoView vertical dar√° la oportunidad de interceptar al padre: <br><br><img src="https://habrastorage.org/webt/j7/ea/_z/j7ea_zwmamtooghpppzcyxl-bne.png"><br><br>  El siguiente <code>ACTION_MOVE</code> ser√° interceptado en VerticalDragLyout, y el evento <code>ACTION_CANCEL</code> volar√° a la Vista secundaria: <br><br><img src="https://habrastorage.org/webt/jb/ag/tz/jbagtzmul81dakmf0nujxzumw6u.png"><br><br>  Todos los dem√°s <code>ACTION_MOVE</code> volar√°n a VerticalDragLayout a lo largo de la cadena est√°ndar.  Es importante que despu√©s de que ViewGroup tome el control de los eventos de la Vista secundaria, la Vista secundaria no pueda recuperar el control. <br><br><img src="https://habrastorage.org/webt/ud/ql/yv/udqlyv7d4-aigffi5hdwypwfy5u.png"><br><br>  As√≠ que implementamos deslizar para descartar el soporte para la biblioteca PhotoView.  En nuestra biblioteca, utilizamos las fuentes modificadas de PhotoView extra√≠das en un m√≥dulo separado y creamos una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">solicitud de fusi√≥n</a> en el repositorio original de PhotoView. <br><br></p><h3 id="realizuem-debauns-v-photoview">  Implementamos debinds en PhotoView </h3><br><p>  Recuerde que un rebote es una restauraci√≥n de animaci√≥n de una escala aceptable cuando la imagen se escala m√°s all√° de sus l√≠mites. <br><br><img src="https://habrastorage.org/webt/op/rv/wb/oprvwbemhg9ikmrm1zfv45w6fvo.gif"><br><br>  No hab√≠a tal posibilidad en PhotoView.  Pero desde que comenzamos a cavar el c√≥digo abierto de otra persona, ¬øpor qu√© parar all√≠?  En PhotoView, puede establecer un l√≠mite de zoom.  Inicialmente, este es el m√≠nimo - x1 y el m√°ximo - x3.  La imagen no puede ir m√°s all√° de estos l√≠mites. </p><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> scaleFactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusY)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((getScale() &lt; mMaxScale || scaleFactor &lt; <span class="hljs-number"><span class="hljs-number">1f</span></span>) &amp;&amp; (getScale() &gt; mMinScale || scaleFactor &gt; <span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScaleChangeListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mScaleChangeListener.onScaleChange(scaleFactor, focusX, focusY); } mSuppMatrix.postScale(scaleFactor, scaleFactor, focusX, focusY); <span class="hljs-comment"><span class="hljs-comment">//      checkAndDisplayMatrix(); } }</span></span></code> </pre> <br><p>  Para empezar, decidimos eliminar la condici√≥n de "prohibici√≥n de escalar al alcanzar un m√≠nimo": simplemente eliminamos la condici√≥n <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code>  <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code> .  Y luego, de repente ... <br><br><img src="https://habrastorage.org/webt/z_/ra/xg/z_raxgeezaf7o0h0zprufgrtggq.jpeg"><br><br>  Debuns ganados!  Aparentemente, esto sucedi√≥ debido al hecho de que los creadores de la biblioteca decidieron jugar a lo seguro dos veces, lo que provoc√≥ un rechazo y una restricci√≥n en la escala.  En la implementaci√≥n del evento onTouch, es decir, en el caso de <code>MotionEvent.ACTION_UP</code> , si el usuario ha escalado m√°s / menos que el m√°ximo / m√≠nimo, <a href="">se</a> inicia <a href="">AnimatedZoomRunnable</a> , que devuelve la imagen a su tama√±o original. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v, MotionEvent ev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> handled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (ev.getAction()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MotionEvent.ACTION_UP: <span class="hljs-comment"><span class="hljs-comment">// If the user has zoomed less than min scale, zoom back // to min scale if (getScale() &lt; mMinScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMinScale, rect.centerX(), rect.centerY())); handled = true; } } else if (getScale() &gt; mMaxScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMaxScale, rect.centerX(), rect.centerY())); handled = true; } } break; } }</span></span></code> </pre> <br><p>  Adem√°s de deslizar para descartar, finalizamos PhotoView en las fuentes de nuestra biblioteca y creamos una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">solicitud de extracci√≥n</a> con la "adici√≥n" de un rebote al PhotoView original. </p><br><h3 id="ispravlyaem-vnezapnyy-bag-v-photoview">  Solucione un error repentino en PhotoView </h3><br><p>  PhotoView tiene un error muy desagradable.  Cuando el usuario desea ampliar la imagen con doble toque y <del>  tiene un ataque de epilepsia </del>  la imagen comienza a escalar, puede girar 180 grados verticalmente.  Este error se puede encontrar incluso en aplicaciones populares de Google Play, por ejemplo, en Cyan. <br><br><img src="https://habrastorage.org/webt/m7/y1/hm/m7y1hmgkwqachpwst660vkrilwa.gif"><br><br>  Despu√©s de una larga b√∫squeda, todav√≠a localizamos este error: a veces un factor de escala negativo se alimenta a la matriz de entrada para escalar la imagen para escalar, lo que hace que la imagen se voltee. </p><br><p>  <a href="">CustomGestureDetector</a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ScaleGestureDetector detector)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -   scaleFactor &lt; 0 //      float scaleFactor = detector.getScaleFactor(); if (Float.isNaN(scaleFactor) || Float.isInfinite(scaleFactor)) return false; //    scaleFactor   callback //      mListener.onScale(scaleFactor, detector.getFocusX(), detector.getFocusY()); return true; }</span></span></code> </pre> <br><p>  Para escalar desde Android ScaleGestureDetector, <a href="">obtenemos</a> scaleFactor, que se calcula de la siguiente manera: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getScaleFactor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inAnchoredScaleMode()) { <span class="hljs-comment"><span class="hljs-comment">// Drag is moving up; the further away from the gesture // start, the smaller the span should be, the closer, // the larger the span, and therefore the larger the scale final boolean scaleUp = (mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &lt; mPrevSpan)) || (!mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &gt; mPrevSpan)); final float spanDiff = (Math.abs(1 - (mCurrSpan / mPrevSpan)) * SCALE_FACTOR); return mPrevSpan &lt;= 0 ? 1 : scaleUp ? (1 + spanDiff) : (1 - spanDiff); } return mPrevSpan &gt; 0 ? mCurrSpan / mPrevSpan : 1; }</span></span></code> </pre> <br><p>  Si anula este m√©todo con registros de depuraci√≥n, puede rastrear en qu√© valores particulares de las variables se obtiene un scaleFactor negativo: </p><br><pre> <code class="plaintext hljs">mEventBeforeOrAboveStartingGestureEvent is true; SCALE_FACTOR is 0.5; mCurrSpan: 1075.4398; mPrevSpan 38.867798; scaleUp: false; spanDiff: 13.334586; eval result is -12.334586</code> </pre> <br><p>  Existe la sospecha de que intentaron resolver este problema multiplicando spanDiff por SCALE_FACTOR == 0.5.  Pero esta soluci√≥n no ayudar√° si la diferencia entre mCurrSpan y mPrevSpan es m√°s de tres veces.  Ya se ha iniciado un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ticket</a> para este error, pero a√∫n no se ha solucionado. <br><del>  Muleta </del>  La soluci√≥n m√°s f√°cil a este problema es simplemente omitir los valores negativos de scaleFactor.  En la pr√°ctica, el usuario no notar√° que la imagen a veces se acerca un poco menos de lo normal. </p><br><h1 id="vmesto-zaklyucheniya">  En lugar de una conclusi√≥n </h1><br><h3 id="sudba-pull-rekvestov">  El destino de las solicitudes de extracci√≥n </h3><br><p>  Hicimos una soluci√≥n local y creamos la √∫ltima <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">solicitud</a> de extracci√≥n en PhotoView.  A pesar del hecho de que algunos RP han estado colgados all√≠ durante un a√±o, nuestros RP se han agregado a la rama maestra e incluso se ha lanzado una nueva versi√≥n de PhotoView.  Despu√©s de lo cual decidimos cortar el m√≥dulo local de la Galer√≠a de Android y extraer las fuentes oficiales de PhotoView.  Para hacer esto, tuve que agregar soporte para AndroidX, que se agreg√≥ a PhotoView en la versi√≥n <a href="">2.1.3</a> . </p><br><h3 id="gde-nayti-biblioteku">  Donde encontrar la biblioteca </h3><br><p>  Busque el c√≥digo fuente de la biblioteca de la Galer√≠a de Android aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/redmadrobot-spb/android-gallery</a> , junto con las instrucciones de uso.  Y para apoyar proyectos que todav√≠a usan la Biblioteca de soporte, creamos una versi√≥n separada de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">android-gallery-obsoleto</a> .  Pero tenga cuidado, porque en un a√±o la biblioteca de soporte se convertir√° en una calabaza. </p><br><h3 id="chto-dalshe">  Que sigue </h3><br><p>  Ahora la biblioteca nos satisface completamente, pero en el proceso de desarrollo surgieron nuevas ideas.  Aqu√≠ hay algunos de ellos: </p><br><ul><li>  la capacidad de usar la biblioteca en cualquier dise√±o, y no solo en un FragmentDialog separado; </li><li>  la capacidad de personalizar la interfaz de usuario; </li><li>  la capacidad de reemplazar a Gilde y ExoPlayer; </li><li>  la capacidad de usar algo en lugar de ViewPager. </li></ul><br><h3 id="ssylki">  Referencias </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El sistema t√°ctil Android desde una perspectiva ligeramente diferente</a> : un muy buen art√≠culo sobre el tema con enlaces a otros excelentes art√≠culos y videos, que detalla c√≥mo funciona el Sistema Android Touch. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dominio de gestos en Android</a> : art√≠culo sobre el sistema Android Touch en ruso. </li></ul><br><h3 id="upd">  UPD </h3><br><p>  Mientras escrib√≠a un art√≠culo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sali√≥</a> una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">biblioteca</a> similar de los desarrolladores de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FrescoImageViewer</a> .  Agregaron soporte para la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">animaci√≥n de transici√≥n</a> , pero hasta ahora solo tenemos soporte de video.  :) </p></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433076/">https://habr.com/ru/post/es433076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433064/index.html">Gesti√≥n de incidentes: "no puede darse por vencido" o el arte de colocar comas</a></li>
<li><a href="../es433066/index.html">HighLoad Cup # 2. Campeonato para desarrolladores de back-end de nuevo en servicio</a></li>
<li><a href="../es433070/index.html">C√≥mo distinguir champ√∫ de champi√±ones y brochetas de champ√°n ... Elasticsearch: busque productos en las bases de datos de la tienda</a></li>
<li><a href="../es433072/index.html">C√≥mo hackear la protecci√≥n de copia de la consola Sega Dreamcast</a></li>
<li><a href="../es433074/index.html">Cambiar a Kotlin en un proyecto de Android: consejos y trucos</a></li>
<li><a href="../es433078/index.html">Escribimos robots comerciales utilizando el marco gr√°fico StockSharp. Parte 2</a></li>
<li><a href="../es433082/index.html">Bombear las cuentas de otras personas se ha convertido en un delito penal en Corea del Sur</a></li>
<li><a href="../es433084/index.html">Lecci√≥n abierta "Ingenier√≠a de caracter√≠sticas en el ejemplo del cl√°sico conjunto de datos Titanic"</a></li>
<li><a href="../es433086/index.html">Tinkoff y todo, todo, todo: IoT, an√°lisis y vigilancia para bancos</a></li>
<li><a href="../es433088/index.html">¬øQu√© le parece, Elon Musk: BMW y Porsche han desarrollado una carga que agrega 100 km de viaje en 3 minutos?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>