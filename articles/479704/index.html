<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçó üè¥ üë¥üèø Escalada de privilegios en el cliente EA Origin Windows (CVE-2019-19247 y CVE-2019-19248) üêí üö≠ ü§µüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saludos a todos los que decidieron leer mi nuevo art√≠culo sobre an√°lisis de vulnerabilidad. La √∫ltima vez, en una breve serie de tres art√≠culos, habl√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escalada de privilegios en el cliente EA Origin Windows (CVE-2019-19247 y CVE-2019-19248)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pm/blog/479704/">  Saludos a todos los que decidieron leer mi nuevo art√≠culo sobre an√°lisis de vulnerabilidad.  La √∫ltima vez, en una breve serie de tres art√≠culos, habl√© sobre las vulnerabilidades de Steam ( <a href="https://habr.com/ru/company/pm/blog/462479/">1</a> , <a href="https://habr.com/ru/company/pm/blog/464367/">2</a> y <a href="https://habr.com/ru/company/pm/blog/469507/">3</a> ).  En este art√≠culo hablar√© sobre las vulnerabilidades de un producto similar: Origin, que tambi√©n es un iniciador para juegos.  Las vulnerabilidades descubiertas se numeraron CVE-2019-19247 y CVE-2019-19248. <br><br><img src="https://habrastorage.org/webt/bi/b8/vt/bib8vt2hmgqzkyfv39xm5ri8wxk.jpeg"><br><br>  Esta vez no habr√° juego con anban banana.  La historia de la comunicaci√≥n con la divisi√≥n de seguridad de Electronic Arts Inc inicialmente fue profesional.  Cuando me contactaron, me dieron un n√∫mero de registro, los informes fueron cuidadosamente examinados y confirmados.  Ninguno de mis correos electr√≥nicos fue ignorado, y para una peque√±a discusi√≥n se organiz√≥ una confkall.  El mantenimiento de estos informes fue muy simple para m√≠, por lo que muchas gracias a Adrian Stone, Elise Murphy y otros empleados de EA que trabajaron con mis informes.  <a href="https://www.ea.com/security/news/origin-security-update-in-collaboration-with-external-security-researchers">Publicaci√≥n de blog de seguridad</a> y <a href="https://www.ea.com/security/news/easec-2019-001-elevation-of-privilege-vulnerability-in-origin-client">asesoramiento</a> . <br><br>  Ahora a las vulnerabilidades.  Encontr√© dos vulnerabilidades como "escalada de privilegios" (lpe - escalada de privilegios locales o eop - escalada de privilegios) en el cliente de Origin Windows.  Este tipo de vulnerabilidad permite que cualquier usuario de Windows obtenga m√°s derechos que los emitidos originalmente por el administrador.  En este caso, estamos hablando de dos mejoras "t√≠picas": de cualquier usuario a NT AUTHORITY \ SYSTEM (una cuenta con permisos m√°ximos en el sistema operativo).  La primera vulnerabilidad es bastante aburrida, por lo que en la siguiente secci√≥n la describir√© brevemente.  Pero el segundo fue bastante interesante, en su secci√≥n te dir√© exactamente c√≥mo la busqu√©. <br><a name="habracut"></a><br><h2>  <font color="orange">CVE-2019-19248</font> </h2><br>  Esta vulnerabilidad consta de dos partes: <br><br><ol><li> Crear una carpeta en una ruta arbitraria (con derechos de Acceso total); </li><li>  Use la cl√°usula 1 para obtener los privilegios NT AUTHORITY \ SYSTEM. </li></ol><br>  Ahora sobre el primer punto con m√°s detalle: <br><br><h3>  Preparaci√≥n del medio ambiente </h3><br>  Es necesario cerrar el cliente de Origin y detener el Servicio de cliente de Origin (en teor√≠a, el servicio en s√≠ se detendr√° si cierra el cliente, pero por las dudas). <br><br>  Para la carpeta "C: \ ProgramData \ Origin", los derechos son "Acceso total", lo que nos permite eliminar completamente su contenido. <br><br><h3>  Link Building </h3><br>  Ahora crea un par de enlaces.  El primer enlace ser√° del tipo NTFS Reparse Point (NTFS Mount Point), el tipo de enlaces que apuntan de una carpeta a otra: ‚ÄúC: \ ProgramData \ Origin‚Äù &lt;-&gt; ‚Äú\ RPC Control‚Äù.  Para crear puntos de an√°lisis no necesita derechos de administrador.  Solo es necesario que la carpeta de origen est√© vac√≠a y que el usuario tenga permisos de escritura (se borraron en el √∫ltimo paso, los derechos se verificaron all√≠).  "\ RPC Control" no es una carpeta en el sistema de archivos, sino un tipo especial de carpeta: un directorio de objetos.  No puede verlo con un explorador habitual, pero puede hacer un punto de an√°lisis all√≠, aparentemente debido a las abstracciones comunes que se usan en las entra√±as de Windows. <br><br>  Ahora crearemos el enlace simb√≥lico habitual "\ RPC Control \ CatalogCache" &lt;-&gt; "C: \ Path \ To \ Target \ Folder".  En el sistema de archivos, est√° prohibido crear enlaces simb√≥licos sin derechos de administrador, pero esta regla no se aplica a los directorios de objetos.  Por lo tanto, nuestro enlace se crear√° con √©xito.  Como resultado de una combinaci√≥n de estos dos enlaces, las llamadas a "C: \ ProgramData \ Origin \ CatalogCache" se redirigir√°n a "C: \ Path \ To \ Target \ Folder". <br><br>  Lea m√°s sobre dichos enlaces <a href="https://github.com/googleprojectzero/symboliclink-testing-tools/blob/master/CreateSymlink/CreateSymlink_readme.txt">aqu√≠</a> .  En el mismo repositorio, <a href="https://github.com/googleprojectzero/symboliclink-testing-tools/releases">puede descargar</a> utilidades para trabajar con enlaces. <br><br><h3>  Lanzamiento </h3><br>  En el √∫ltimo paso, ejecute el cliente.  Al comienzo de su trabajo, lanzar√° el "Servicio de cliente de Origin" y, al encontrar que no hay una carpeta "C: \ ProgramData \ Origin \ CatalogCache", intentar√° crearlo.  Como resultado de navegar a trav√©s de enlaces simb√≥licos, crear√° "C: \ Ruta \ A \ Destino \ Carpeta" y le dar√° a esta carpeta derechos de "Acceso total". <br><br>  Lo que se requer√≠a obtener en el primer punto de operaci√≥n.  Pasemos a la segunda. <br><br><h3>  La operaci√≥n de crear una carpeta en una ruta arbitraria </h3><br>  Aqu√≠ puedes trabajar de muchas maneras. <br><br>  Simple y bastante confiable es crear la carpeta "C: \ Windows \ system32 \ LogonUI.exe.local".  "LogonUI.exe" (una aplicaci√≥n que se ejecuta desde NT AUTHORITY \ SYSTEM, es responsable del funcionamiento de la pantalla de selecci√≥n de usuario y la pantalla de bloqueo) gracias al mecanismo .local-redirection ("redirecci√≥n dotlocal"), cargar√° la biblioteca desde la ruta "C: \ Windows \ system32 \ LogonUI.exe.local \ amd64_microsoft.windows.common-controls_6595b64144ccf1df_6.0.17134.648_none_fb45a0e93062a6d2 \ comctl32.dll ".  En general, el mecanismo en s√≠ es bastante com√∫n, por lo que puede tener muchos objetivos. <br><br>  Una forma larga pero interesante es restar el hash de la contrase√±a del administrador mediante fraudes especiales.  M√°s detalles <a href="https://googleprojectzero.blogspot.com/2017/08/windows-exploitation-tricks-arbitrary.html">aqu√≠</a> . <br><br><h3>  Total </h3><br>  La vulnerabilidad se explota con bastante facilidad, solo necesita trabajar un poco en el segundo punto: encontrar el objetivo y escribir un archivo dll adecuado.  Adem√°s, Matt Nelson tambi√©n inform√≥ esta vulnerabilidad, y su escritura se puede encontrar <a href="https://enigma0x3.net/2019/12/10/cve-2019-19248-local-privilege-escalation-in-eas-origin-client/">aqu√≠</a> . <br><br><h2>  <font color="orange">CVE-2019-19247</font> </h2><br>  Esta es una de mis vulnerabilidades favoritas.  Muestra cu√°n cuidadosamente necesita relacionarse con la criptograf√≠a utilizada. <br><br>  Todo comenz√≥ con el hecho de que instal√© el juego a trav√©s de Origin.  Todo sali√≥ de alguna manera demasiado bien: se pueden iniciar un par de clics y despu√©s de unos minutos de descargar el juego.  No de inmediato, pero entend√≠ cu√°l era el problema: el juego se instal√≥ a lo largo de la ruta "C: \ Archivos de programa \ Nombre del juego", pero no hizo una sola pregunta a trav√©s de UAC.  R√°pidamente verifiqu√© los derechos, todo era est√°ndar: un usuario com√∫n no pod√≠a escribir en "C: \ Archivos de programa".  Un poco m√°s de investigaci√≥n y descubr√≠ que el juego no est√° "prescrito" por el propio cliente de Origin, sino por su Servicio de cliente de Origin. <br><br>  Comenc√© a hacer suposiciones sobre c√≥mo el cliente transmite informaci√≥n al servicio para verificar si algo puede ser explotado. <br><br>  El m√©todo de transmisi√≥n de informaci√≥n result√≥ ser simple: una tuber√≠a con nombre.  Aprend√≠ sobre esto a partir de los registros de instalaci√≥n: en texto plano se indic√≥ que la tuber√≠a OriginClientService estaba aceptando comandos para trabajar con archivos y carpetas. <br><br>  Abri√≥ IDA, subi√≥ el cliente all√≠. <br><br>  <b>* trabajo realizado en IDA: 1 *</b> <br><br>  Bastante r√°pido, descubr√≠ que los comandos se enviaron a la tuber√≠a en general en forma de texto.  Cerca de all√≠ encontr√© una lista de comandos y, sin m√°s pre√°mbulos, envi√© un comando del tipo "copy" C: \ test \ payload.dll "" C: \ Windows \ pwn.dll "a la tuber√≠a.  En previsi√≥n de un resultado r√°pido, verifico la carpeta "C: \ Windows" y no encuentro nada nuevo en ella.  Pero hay algo nuevo en los registros: algunas palabras sobre el hecho de que el cliente en la tuber√≠a no pas√≥ la verificaci√≥n de firma digital. <br><br>  Abri√≥ IDA, sub√≠ el servicio all√≠. <br><br>  <b>* trabajo realizado en IDA: 2 *</b> <br><br>  Descubr√≠ que de todos modos no se esperan equipos de nadie.  Cuando se conecta a una tuber√≠a, el servicio verifica qui√©n est√° conectado a ella.  El proceso pid se extrae de la conexi√≥n, la ruta al archivo ejecutable se extrae del pid, se verifica que la firma sea correcta y EA la emite. <br>  Suena bien, pero no lo suficiente.  Puede tomar el "Origin.exe" legal (archivo ejecutable del cliente), copiarlo en alg√∫n lugar de su carpeta.  Coloque algunos dll de la lista de importaci√≥n "Origin.exe" en esta carpeta.  Por ejemplo, surgi√≥ version.dll.  Llam√© a este enfoque "inyecci√≥n dll inversa": en una inyecci√≥n dll normal, copiamos el dll en el archivo exe, pero ahora hemos hecho lo contrario.  Escribo r√°pidamente proxy dll para version.dll, agrego c√≥digo enviando el comando a la tuber√≠a.  La carga √∫til todav√≠a no se copia.  Leemos los registros: "¬øQu√© significa que no se pueda descifrar el comando?".  Me salt√© el cifrado. <br><br>  Abri√≥ IDA, subi√≥ el cliente all√≠. <br><br>  <b>* trabajos realizados en IDA: 3, bypass de firma: 1 *</b> <br><br>  Como el cliente env√≠a comandos cifrados en su trabajo habitual, entonces puedo.  All√≠ mir√©, luego mir√©, el resultado es este: cifrado AES, inicializando un vector constante, la clave se lee del archivo.  Pr√°cticamente copiamos esta pieza e IDA en el c√≥digo, compilamos, verificamos.  De nuevo nada.  Pero los registros nuevamente proporcionan informaci√≥n √∫til: no puede especificar Archivos de programa como la ruta de destino. <br><br>  Abri√≥ IDA, sub√≠ el servicio all√≠. <br><br>  <b>* trabajo realizado en IDA: 4, omisi√≥n de firma: 1, omisi√≥n de cifrado: 1 *</b> <br><br>  Entonces, es cierto que hay comprobaciones para obtener un comando que resulta que los archivos no se pueden copiar en todas partes.  Y las rutas con "\ .. \" no se pueden escribir.  Nos fijamos en lo que otros equipos son. <br>  Trabajando con el registro: nuevamente hay muchas restricciones.  Pero lanzar archivos parece interesante.  Al menos los controles no son particularmente visibles.  Edite el c√≥digo, env√≠e el comando "ExecuteProcess" C: \ test \ payload.exe "".  Bueno, entiendes ... nada. <br><br>  Los registros vuelven a hablar sobre la firma.  Oh, ya lo ganamos.  Indicamos en el c√≥digo que llamamos a nuestro Origin.exe copiado para cargar nuestro proxy dll nuevamente, pero con derechos del sistema.  Agregue controles y ejecute la consola.  Comenzamos y aparece la consola con los derechos NT AUTHORITY \ SYSTEM, por fin todo funcion√≥. <br><br>  <b>* trabajo realizado en IDA: 4, omisi√≥n de firma: 2, omisi√≥n de cifrado: 1 *</b> <br><br>  Por lo tanto, debe reiniciar, realizar una ejecuci√≥n final y a√∫n admirar la consola con los m√°ximos derechos.  Reiniciar, verificar y ... nada.  ¬øC√≥mo es eso?  Simplemente funcion√≥. <br><br>  Los diagn√≥sticos muestran que el servicio de cliente de Origin no se ha iniciado, por lo que lo estoy iniciando.  Pero no comienza.  M√°s precisamente, comienza, pero se cierra inmediatamente.  Inicio el cliente de Origin y el servicio se inicia normalmente.  Despu√©s de eso, el exploit funciona correctamente de nuevo.  Ser√≠a posible detenerse all√≠, pero este no es mi camino: quiero que el exploit funcione por completo. <br><br>  Abri√≥ IDA, sub√≠ el servicio all√≠. <br><br>  <b>* trabajo realizado en IDA: 5, omitir firma: 2, omitir cifrado: 1 *</b> <br><br>  Resulta que al inicio comprueba con qu√© par√°metros comenz√≥ el servicio.  No hay nada directamente interesante all√≠.  Base64 del pid cifrado del proceso cuyo archivo se verifica mediante la firma.  Suena complicado, pero ya hemos pasado por alto el cifrado y la firma tambi√©n.  Estamos escribiendo un c√≥digo y un exploit est√° listo. <br><br><h3>  Total </h3><br>  El exploit est√° funcionando.  El trabajo se realiz√≥ en IDA: 5 veces, omisi√≥n de firma: 3 veces, cifrado de omisi√≥n: 2 veces. <br><br><h2>  <font color="orange">Conclusi√≥n</font> </h2><br>  Vulnerabilidades solucionadas: los desarrolladores de EA introdujeron un modo de operaci√≥n restringido especial para el cliente, que establece restricciones serias para trabajar con carpetas y canalizaciones de Origin. <br><br>  Vulnerabilidades de la l√≠nea de tiempo: <br><br>  <b>1 de abril de 2019</b> : informe de vulnerabilidad de informes con tuber√≠a; <br><br>  <b>7 de abril de 2019</b> : env√≠o de un informe de vulnerabilidad con una carpeta arbitraria; <br><br>  ... MUCHAS LETRAS (cont√© 40) ... <br><br>  <b>10 de diciembre de 2019</b> : divulgaci√≥n acordada. <br><br>  Gracias a todos por su atenci√≥n, les deseo los mismos agentes de seguridad. <br><br>  <a href="https://amonitoring.ru/article/origin_lpe_disclosure/">Este art√≠culo en ingl√©s.</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/479704/">https://habr.com/ru/post/479704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../479690/index.html">Zork y Z-Machine: c√≥mo los desarrolladores transfirieron el juego de mainframes a computadoras hogare√±as de 8 bits</a></li>
<li><a href="../479692/index.html">Indexaci√≥n de miles de millones de vectores de texto</a></li>
<li><a href="../479696/index.html">Algunas palabras sobre Alter Table, o c√≥mo no hacerlo</a></li>
<li><a href="../479700/index.html">CIMON-2: (un) Doomsday, o c√≥mo IBM Watson subi√≥ por encima de las nubes</a></li>
<li><a href="../479702/index.html">Tostadora, Mi c√≠rculo y Freelansim se convierten en parte de Habr</a></li>
<li><a href="../479708/index.html">Publicaci√≥n no oficial sobre el cambio de marca de Habr + Competition</a></li>
<li><a href="../479712/index.html">Aprendizaje autom√°tico como asistente de monitoreo inteligente</a></li>
<li><a href="../479714/index.html">Unificaci√≥n de componentes visuales. Parte 1. Estilos</a></li>
<li><a href="../479716/index.html">Otra "primera en el mundo" SuperApp</a></li>
<li><a href="../479718/index.html">Creaci√≥n de una aplicaci√≥n de entorno arduino utilizando CI github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>