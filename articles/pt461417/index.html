<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úçüèæ üöµüèæ üöê Como recusei o db4o em um sistema industrial üêÉ üëø üïç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Somos um departamento de uma grande empresa que desenvolve um importante sistema Java SE / MS SQL / db4o. Por v√°rios anos, o projeto mudou de um prot√≥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como recusei o db4o em um sistema industrial</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461417/"><p><img src="https://habrastorage.org/webt/ql/p2/ye/qlp2yevkdo5rbywpveackt_fm7s.jpeg" alt="imagem"></p><br><p>  Somos um departamento de uma grande empresa que desenvolve um importante sistema Java SE / MS SQL / db4o.  Por v√°rios anos, o projeto mudou de um prot√≥tipo para opera√ß√£o industrial e o db4o se transformou em um freio de c√°lculo. Eu queria mudar do db4o para a moderna tecnologia noSQL.  Tentativa e erro levaram muito longe do plano original - o db4o foi abandonado com sucesso, mas √† custa de um compromisso.  Sob o gato reflex√µes e detalhes de implementa√ß√£o. </p><a name="habracut"></a><br><h2 id="tehnologiya-db4o-umerla">  A tecnologia db4o est√° morta? </h2><br><p>  No Habr√©, √© poss√≠vel encontrar poucas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">publica√ß√µes</a> sobre o db4o.  No Stackoverflow, algum tipo de atividade residual √© como um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">novo coment√°rio sobre uma pergunta antiga</a> ou uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pergunta n√£o respondida</a> .  O Wiki geralmente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">acredita</a> que a vers√£o est√°vel atual √© de 2011. </p><br><p>  Isso forma uma impress√£o geral: a tecnologia √© irrelevante.  Houve at√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma confirma√ß√£o oficial</a> : a Actian decidiu n√£o continuar e promover ativamente a oferta comercial de produtos db4o para novos clientes. </p><br><h2 id="kak-db4o-popala-v-raschet">  Como o db4o foi calculado </h2><br><p>  O artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Introdu√ß√£o aos bancos de dados orientados a objetos</a> fala sobre o principal recurso do db4o - a completa aus√™ncia de um esquema de dados.  Voc√™ pode criar qualquer objeto </p><br><pre><code class="plaintext hljs">User user1 = new User("Vasya", "123456", 25);</code> </pre> <br><p>  e ent√£o apenas escreva no arquivo do banco de dados </p><br><pre> <code class="plaintext hljs">db.Store(user1)</code> </pre> <br><p>  O objeto gravado pode ser recuperado usando o m√©todo Query.execute () no formato em que foi salvo. </p><br><p>  No in√≠cio do projeto, isso tornou poss√≠vel garantir rapidamente a exibi√ß√£o da trilha de auditoria com todos os dados enviados, sem se preocupar com a estrutura das tabelas relacionais.  Isso ajudou o projeto a sobreviver.  Havia poucos recursos na sandbox e, imediatamente ap√≥s o final do c√°lculo de hoje, os dados para amanh√£ come√ßaram a carregar no MS SQL.  Tudo estava mudando constantemente - descubra o que exatamente era servido automaticamente √† noite.  E o arquivo db4o pode ser acessado <br>  na depura√ß√£o, extraia um instant√¢neo do dia desejado e responda √† pergunta "enviamos todos os dados, mas voc√™ n√£o solicitou nada". </p><br><p>  Com o tempo, o problema da sobreviv√™ncia desapareceu, o projeto decolou, o trabalho com as solicita√ß√µes dos usu√°rios mudou.  Abra um arquivo db4o na depura√ß√£o e analise uma pergunta dif√≠cil para um desenvolvedor que est√° sempre ocupado.  Em vez disso, h√° uma multid√£o de analistas, munidos de uma descri√ß√£o da l√≥gica da ordem e capazes de usar apenas a parte vis√≠vel dos dados dos usu√°rios.  Logo o db4o come√ßou a ser usado apenas para exibir o hist√≥rico do c√°lculo.  Assim como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pareto</a> - uma pequena parte dos recursos fornece a carga principal. </p><br><p>  Em opera√ß√£o de combate, o arquivo hist√≥rico leva ~ 35 GB / dia, o descarregamento leva cerca de uma hora.  O arquivo em si compacta bem (1:10), mas por algum motivo a biblioteca com.db4o.ObjectContainer n√£o executa compacta√ß√£o.  No norte do CentOS, a biblioteca com.db4o.query.Query grava / l√™ um arquivo exclusivamente em um fluxo.  Velocidade √© um gargalo. </p><br><h1 id="principialnaya-shema-ustroystva">  Diagrama esquem√°tico do dispositivo </h1><br><p>  O modelo de informa√ß√µes do sistema √© a hierarquia dos objetos A, B, C e D. A hierarquia n√£o √© uma √°rvore; os links C1 -&gt; B1 s√£o necess√°rios para a opera√ß√£o. </p><br><pre> <code class="plaintext hljs">ROOT || | ==&gt;A1 | || | | ==&gt; B1 &lt;------ | | || | | | | ======&gt; C1 | | | | | | | ===&gt; C1.$D | | =======&gt; C2 | | | | ==&gt; B2 ==&gt; C2.$D | | ===&gt;A2 =======&gt; C3 | | ==&gt; B3 ===&gt; C3.$D | ======&gt; C4 | ===&gt; C4.$D</code> </pre> <br><p>  O usu√°rio interage com o servidor por meio da interface do usu√°rio (GUI), fornecida por com.sun.net.httpserver.HttpsServer, o cliente e o servidor trocam documentos XML.  Na primeira exibi√ß√£o, o servidor atribui um identificador ao n√≠vel do usu√°rio, que n√£o muda mais.  Se o usu√°rio precisar de um hist√≥rico de algum n√≠vel, a GUI envia ao servidor um identificador agrupado em XML.  O servidor determina os valores das chaves para pesquisar no banco de dados, varre o arquivo db4o pelo dia desejado e recupera o objeto solicitado na mem√≥ria, al√©m de todos os objetos aos quais se refere.  Constr√≥i uma apresenta√ß√£o XML do n√≠vel extra√≠do e a retorna ao cliente. </p><br><p>  Ao digitalizar um arquivo, o db40, por padr√£o, l√™ todos os objetos filhos at√© uma certa profundidade, extraindo uma hierarquia bastante grande junto com o objeto desejado.  O tempo de leitura pode ser reduzido definindo a profundidade m√≠nima de ativa√ß√£o para a classe Foo desnecess√°ria com conf.common (). ObjectClass (Foo.class) .maximumActivationDepth (1). </p><br><p>  O uso de classes an√¥nimas leva √† cria√ß√£o de refer√™ncias impl√≠citas √† classe anexa a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">$ 0</a> .  O Db4o processa e restaura esses links corretamente (mas lentamente). </p><br><h1 id="0-ideya">  0. Id√©ia </h1><br><p>  Portanto, os administradores t√™m uma express√£o estranha no que diz respeito ao suporte ou administra√ß√£o do db4o.  A extra√ß√£o de dados √© lenta, a tecnologia n√£o √© muito animada.  Tarefa: em vez de db4o, aplique a tecnologia NoSQL atual.  Um par de Spring Data + MongoDB chamou minha aten√ß√£o. </p><br><h1 id="1-lobovoy-podhod">  1. Abordagem frontal </h1><br><p>  Meu primeiro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pensamento</a> foi usar org.springframework.data.mongodb.core.MongoOperations e o m√©todo save (), porque se parece com com.db4o.ObjectContainer.db.Store (user1).  A documenta√ß√£o do MongoDB diz que os documentos s√£o armazenados em cole√ß√µes; √© l√≥gico apresentar os objetos de sistema necess√°rios como documentos das cole√ß√µes correspondentes.  Tamb√©m existem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">anota√ß√µes @ DBRef</a> que permitem implementar relacionamentos entre documentos em geral, no esp√≠rito da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">3NF</a> .  Vamos l√° </p><br><h2 id="11-vygruzka-ssylochnyy-tip-klyucha">  1.1  Descarregando.  Tipo de refer√™ncia de chave </h2><br><p>  O sistema consiste em classes POJO projetadas h√° muito tempo e sem levar em conta todas essas novas tecnologias.  Os campos do tipo Mapa &lt;POJO, POJO&gt; s√£o usados, existe uma l√≥gica ramificada de trabalhar com eles.  Salve este campo, recebo um erro </p><br><pre> <code class="plaintext hljs">org.springframework.data.mapping.MappingException: Cannot use a complex object as a key value.</code> </pre> <br><p>  Nesta ocasi√£o, apenas a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">correspond√™ncia de 2011 foi encontrada</a> , na qual foi proposto o desenvolvimento do MappingMongoConverter fora do padr√£o.  Observamos at√© agora os campos problem√°ticos @ Transient, continuo.  Acabou economizando, estudando o resultado. </p><br><p>  O salvamento ocorre na cole√ß√£o, cujo nome coincide com o nome da classe salva.  Ainda n√£o usei anota√ß√µes do @DBRef, portanto, existe apenas uma cole√ß√£o, pois os documentos JSON s√£o bastante grandes e ramificados.  Percebo que, quando voc√™ salva o objeto, o MongoOperations passa por todos os links n√£o vazios (herdados) e os grava como um documento anexado. </p><br><h2 id="12-vygruzka-imenovannoe-pole-ili-massiv">  1.2  Descarregando.  Campo ou matriz nomeado? </h2><br><p>  O modelo do sistema √© tal que a classe C pode conter uma refer√™ncia √† mesma classe D v√°rias vezes.  Em um campo defaultMode separado e entre outros links em ArrayList, algo como isto <br></p><pre> <code class="plaintext hljs">public class C { private D defaultMode; private List&lt;D&gt; listOfD = new ArrayList&lt;D&gt;(); public class D { .. } public C(){ this.defaultMode = new D(); listOfD.add(defaultMode); } }</code> </pre> <br><p>  Ap√≥s o descarregamento, o documento JSON ter√° duas c√≥pias: um documento anexado chamado defaultMode e um elemento sem nome da matriz de documentos.  No primeiro caso, o documento pode ser acessado pelo nome, no segundo - pelo nome da matriz com um √≠ndice.  Voc√™ pode pesquisar cole√ß√µes do MongoDB nos dois casos.  Trabalhando apenas com o Spring Data e o MongoDB, cheguei √† conclus√£o de que voc√™ pode usar ArrayList, se cuidadosamente;  Eu n√£o notei nenhuma restri√ß√£o no uso de matrizes.  Os recursos apareceram mais tarde, no n√≠vel do MongoDB Connector for BI. </p><br><h2 id="13-zagruzka-argumenty-konstruktora">  1.3  Baixar  Argumentos do construtor </h2><br><p>  Estou tentando ler um documento salvo usando o m√©todo MongoOperations.findOne ().  Carregar o objeto A do banco de dados lan√ßa uma exce√ß√£o </p><br><pre> <code class="plaintext hljs">"No property name found on entity class A to bind constructor parameter to!"</code> </pre> <br><p>  Verificou-se que a classe possui um campo corpName e o construtor possui um par√¢metro String name, e this.corpName = name √© atribu√≠do no corpo do construtor.  MongoOperations requer que os nomes de campo nas classes correspondam aos nomes dos argumentos do construtor.  Se houver v√°rios construtores, voc√™ precisar√° selecionar um com a anota√ß√£o @PersistenceConstructor.  Trago os nomes dos campos e par√¢metros em correspond√™ncia. </p><br><h2 id="14-zagruzka-sd-i-this0">  1.4  Baixar  Com $ D e este $ 0 </h2><br><p>  A classe aninhada interna D encapsula o comportamento padr√£o da classe C e n√£o faz sentido separadamente da classe C.  Uma inst√¢ncia de D √© criada para cada inst√¢ncia de C e vice-versa - para cada inst√¢ncia de D existe uma inst√¢ncia de C. A classe D ainda possui descendentes que implementam comportamentos alternativos e podem ser armazenados em listOfD.  O construtor das classes descendentes de D requer a presen√ßa de um objeto C. j√° existente. </p><br><p>  Al√©m das classes internas aninhadas, o sistema usa classes internas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">an√¥nimas</a> .  Como voc√™ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sabe</a> , os dois cont√™m uma refer√™ncia impl√≠cita a uma inst√¢ncia de uma classe envolvente.  Ou seja, como parte de cada inst√¢ncia do objeto CD, o compilador cria um link como $ 0, que aponta para o objeto pai C. </p><br><p>  Mais uma vez, tento ler o documento salvo da cole√ß√£o e obtenho uma exce√ß√£o </p><br><pre> <code class="plaintext hljs">"No property this$0 found on entity class $D to bind constructor parameter to!"</code> </pre> <br><p>  Lembro-me de que os m√©todos da classe D usam as refer√™ncias C.this.fieldOfClassC com poder e principal, e os descendentes da classe D exigem que o construtor seja instanciado com C como argumento.  Ou seja, preciso fornecer uma certa ordem de cria√ß√£o de objetos no MongoOperations para que o objeto pai C possa ser especificado no construtor D. Novamente, o MappingMongoConverter n√£o padr√£o? </p><br><p>  Talvez n√£o usando classes an√¥nimas e normalizando as classes internas?  Refinar, ou melhor, refinar a arquitetura de um sistema j√° implementado √© uma tarefa uau ... </p><br><h1 id="2-podhod-so-storony-3nfdbref">  2. Abordagem da 3NF / @ DBRef </h1><br><p>  Eu tento ir por outro lado, salvar cada classe da minha cole√ß√£o e fazer conex√µes entre elas no esp√≠rito da 3NF. </p><br><h2 id="21-vygruzka-dbref---eto-krasivo">  2.1  Descarregando.  @DBRef is beautiful </h2><br><p>  A classe C cont√©m v√°rias refer√™ncias a D. Se os links defaultMode e ArrayList estiverem marcados como @DBRef, o tamanho do documento diminuir√°. Em vez de grandes documentos anexados, haver√° links legais.  No campo, o documento json da cole√ß√£o C √© exibido <br></p><pre> <code class="plaintext hljs">"defaultMode" : DBRef("D", ObjectId("5c496eed2c9c212614bb8176"))</code> </pre> <br><p>  No banco de dados MongoDB, uma cole√ß√£o D √© criada automaticamente e um documento com um campo </p><br><pre> <code class="plaintext hljs">"_id" : ObjectId("5c496eed2c9c212614bb8176")</code> </pre> <br><p>  Tudo √© simples e bonito. </p><br><h2 id="22-zagruzka-konstuktor-klassa-d">  2.2  Baixar  Construtor Classe D </h2><br><p>  Ao trabalhar com links, o objeto C sabe que o objeto D padr√£o √© criado exatamente uma vez.  Se voc√™ precisar ignorar todos os objetos D, exceto o padr√£o, basta comparar os links: </p><br><pre> <code class="plaintext hljs">private D defaultMode; private ArrayList&lt;D&gt; listOfD; for (D currentD: listOfD){ if (currentD == defaultMode) continue; doSomething(currentD); }</code> </pre> <br><p>  Eu chamo findOne (), estudo minha classe C. Acontece que o MongoOperations l√™ um documento json e chama o construtor D para cada anota√ß√£o @DBRef que encontra, sempre que cria um novo objeto.  Eu recebo uma constru√ß√£o estranha - duas refer√™ncias diferentes para D no campo defaultMode e na matriz listOfD, onde o link deve ser o mesmo. </p><br><p>  Aprendendo com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">comunidade</a> : "Na minha opini√£o, o Dbref deve ser evitado ao trabalhar com o mongodb."  Outra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">considera√ß√£o</a> na mesma linha da documenta√ß√£o oficial: o modelo de dados desnormalizados onde os dados relacionados s√£o armazenados em um √∫nico documento ser√° ideal para resolver DBRefs, seu aplicativo deve executar consultas adicionais para retornar os documentos referenciados. </p><br><p>  A p√°gina de documenta√ß√£o mencionada diz bem no in√≠cio: "Para muitos casos de uso no MongoDB, o modelo de dados desnormalizados onde os dados relacionados s√£o armazenados em um √∫nico documento ser√° ideal".  Est√° escrito para mim? </p><br><p>  O foco no designer sugere que voc√™ n√£o precisa pensar em um DBMS relacional.  A escolha √©: </p><br><ul><li>  se voc√™ especificar @DBRef: <br><ul><li>  o construtor de cada anota√ß√£o ser√° chamado e v√°rios objetos id√™nticos ser√£o criados; </li><li>  O MongoOperations encontrar√° e ler√° todos os documentos de todas as cole√ß√µes relacionadas.  Haver√° uma solicita√ß√£o para o √≠ndice por ObjectId e, em seguida, a leitura de muitas cole√ß√µes de um banco de dados (grande); </li></ul></li><li>  se voc√™ n√£o especificar, o json "anormal" ser√° salvo com repeti√ß√µes dos mesmos dados. </li></ul><br><p>  Observo por mim mesmo: voc√™ n√£o pode confiar no @DBRef, mas use um campo do tipo ObjectId, preenchendo-o manualmente.  Nesse caso, em vez de </p><br><pre> <code class="plaintext hljs">"defaultMode" : DBRef("D", ObjectId("5c496eed2c9c212614bb8176"))</code> </pre> <br><p>  documento json conter√° </p><br><pre> <code class="plaintext hljs">"defaultMode" : ObjectId("5c496eed2c9c212614bb8176")</code> </pre> <br><p>  N√£o haver√° carregamento autom√°tico - o MongoOperations n√£o sabe em qual cole√ß√£o procurar um documento.  O documento precisar√° ser carregado em uma solicita√ß√£o separada (pregui√ßosa) indicando a cole√ß√£o e o ObjectId.  Uma √∫nica consulta deve retornar o resultado rapidamente; al√©m disso, um √≠ndice autom√°tico √© criado para cada cole√ß√£o pelo ObjectId. </p><br><h2 id="23-nu-i-chto-teper">  2.3  E agora? </h2><br><p>  Subtotais.  N√£o foi poss√≠vel implementar r√°pida e facilmente a funcionalidade db4o no MongoDB: </p><br><ul><li>  N√£o est√° claro como usar um POJO personalizado como chave da lista Chave - Valor; </li><li>  N√£o est√° claro como definir a ordem na qual os objetos s√£o criados no MappingMongoConverter; </li><li>  n√£o est√° claro se √© necess√°rio fazer upload de um documento "n√£o normalizado" sem o DBRef e se √© necess√°rio criar seu pr√≥prio mecanismo para inicializa√ß√£o lenta. </li></ul><br><p>  Voc√™ pode adicionar carregamento lento.  Voc√™ pode tentar fazer o MappingMongoConverter.  Voc√™ pode modificar construtores / campos / listas existentes.  Mas h√° muitos anos em camadas da l√≥gica de neg√≥cios - n√£o uma altera√ß√£o fraca e o risco de nunca ser testado. </p><br><p>  Solu√ß√£o de compromisso: criar um novo mecanismo para salvar dados para o problema que est√° sendo resolvido, mantendo o mecanismo para interagir com a GUI. </p><br><h1 id="3-popytka-tretya-opyt-pervyh-dvuh">  3. A terceira tentativa, a experi√™ncia dos dois primeiros </h1><br><p>  Pareto sugere que resolver problemas com a velocidade dos usu√°rios significar√° o sucesso de toda a tarefa.  A tarefa √© a seguinte: voc√™ precisa aprender como salvar e restaurar rapidamente os dados de apresenta√ß√£o do usu√°rio sem o db4o. </p><br><p>  Isso perder√° a capacidade de examinar o objeto salvo na depura√ß√£o.  Por um lado, isso √© ruim.  Por outro lado, essas tarefas raramente ocorrem e, no git, todas as entregas de combate s√£o marcadas.  Para toler√¢ncia a falhas, antes de descarregar, o sistema serializa o c√°lculo em um arquivo.  Se voc√™ precisar examinar um objeto na depura√ß√£o, poder√° realizar a serializa√ß√£o, clonar o conjunto do sistema correspondente e restaurar o c√°lculo. </p><br><h2 id="31-dannye-polzovatelskih-prezentaciy">  3.1  Dados de apresenta√ß√£o personalizados </h2><br><p>  Para criar apresenta√ß√µes dos n√≠veis do usu√°rio, o sistema possui uma classe Visualizador especial.  O m√©todo Viewer.getXML () recebe um n√≠vel como entrada, extrai dele os valores num√©ricos e de sequ√™ncia necess√°rios e gera XML. </p><br><p>  Se o usu√°rio pediu para mostrar o n√≠vel do c√°lculo de hoje, o n√≠vel ser√° encontrado na RAM.  Para mostrar um c√°lculo do passado, o m√©todo com.db4o.query.Query.execute () encontrar√° o n√≠vel no arquivo.  O n√≠vel do arquivo quase n√£o √© diferente do n√≠vel criado e o Viewer criar√° a apresenta√ß√£o sem perceber a substitui√ß√£o. </p><br><p>  Para resolver meu problema, preciso de um intermedi√°rio entre o n√≠vel de c√°lculo e sua apresenta√ß√£o - a estrutura de apresenta√ß√£o (Quadro), que armazenar√° dados e se basear√° nos dados XML dispon√≠veis.  A cadeia de a√ß√µes para criar a apresenta√ß√£o ficar√° mais longa, sempre que um quadro for gerado e o quadro ir√° gerar XML: </p><br><pre> <code class="plaintext hljs"> : &lt; &gt; -&gt; Viewer.getXML() : &lt; &gt; -&gt; Viewer.getFrame() -&gt; Frame.getXML()</code> </pre> <br><p>  Ao salvar a hist√≥ria, voc√™ precisar√° criar quadros de todos os n√≠veis e gravar no banco de dados. </p><br><h2 id="32-vygruzka">  3.2  Descarregando </h2><br><p>  A tarefa era relativamente simples e n√£o havia problemas.  Repetindo a estrutura da apresenta√ß√£o XML, o quadro recebeu um dispositivo recursivo na forma de uma hierarquia de elementos com os campos String, Inteiro e Duplo.  O quadro solicita getXML () de todos os seus elementos, o coleta em um √∫nico documento e retorna.  O MongoOperations fez um √≥timo trabalho com a natureza recursiva do quadro e n√£o fez novas perguntas √† medida que avan√ßava. </p><br><p>  Finalmente, tudo decolou!  Por padr√£o, o mecanismo WiredTiger <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compacta as</a> cole√ß√µes de documentos do MongoDB; no sistema de arquivos, o descarregamento leva cerca de 3,5 GB por dia.  Uma diminui√ß√£o de dez vezes em rela√ß√£o ao db4o n√£o √© ruim. </p><br><p>  No in√≠cio, o descarregamento era organizado de maneira simples - uma travessia recursiva da √°rvore de n√≠veis, MongoOperations.save () para cada um.  Esse descarregamento levou 5,5 horas, e isso apesar do fato de a constru√ß√£o de apresenta√ß√µes envolver apenas a leitura de objetos.  Eu adiciono multithreading: atravesse recursivamente a √°rvore de n√≠veis, divida todos os n√≠veis dispon√≠veis em pacotes de um determinado tamanho, crie implementa√ß√µes Callable.call () de acordo com o n√∫mero de pacotes, transfira cada pacote para nosso pr√≥prio pacote e fa√ßa tudo isso atrav√©s de ExecutorService.invokeAll (). </p><br><p>  O MongoOperations novamente n√£o fez perguntas e fez um √≥timo trabalho com o modo multiencadeado.  Empiricamente selecionado o tamanho da embalagem, oferecendo a melhor velocidade de descarga.  Foram 15 minutos para um pacote de 1000 n√≠veis. </p><br><h2 id="33-mongo-bi-connector-ili-kak-lyudyam-s-etim-rabotat">  3.3  Mongo BI Connector, ou como as pessoas trabalham com ele </h2><br><p>  A linguagem de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">consulta do</a> MongoDB √© grande e poderosa; eu inevitavelmente adquiri experi√™ncia trabalhando com ela, chegando a esse lugar.  O console <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">suporta</a> JavaScript, voc√™ pode escrever designs bonitos e poderosos.  Este √© um lado.  Por outro lado, posso quebrar o c√©rebro de uma boa metade dos colegas analistas com um pedido </p><br><pre> <code class="plaintext hljs">db.users.find( { numbers: { $in: [ 390, 754, 454 ] } } );</code> </pre> <br><p>  em vez do habitual </p><br><pre> <code class="plaintext hljs">SELECT * FROM users WHERE numbers IN (390, 754, 454)</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O MongoDB Connector for BI</a> vem em socorro, atrav√©s do qual voc√™ pode apresentar documentos de cole√ß√£o em forma de tabela.  O banco de dados MongoDB √© chamado de banco de dados baseado em documentos, n√£o sabe como apresentar uma hierarquia de campos / documentos em forma de tabela.  Para o conector funcionar, √© necess√°rio descrever a estrutura da tabela futura em um arquivo .drdl separado, cujo formato √© muito semelhante ao yaml.  No arquivo, voc√™ deve especificar a correspond√™ncia entre o campo da tabela relacional na sa√≠da e o caminho para o campo do documento JSON na entrada. </p><br><h2 id="34--osobennosti-ispolzovanie-massivov">  3.4  Recursos usando matrizes </h2><br><p>  Foi dito acima que para o pr√≥prio MongoDB n√£o h√° diferen√ßa especial entre uma matriz e um campo.  Da perspectiva do conector, uma matriz √© muito diferente de um campo nomeado;  Eu at√© tive que refatorar a classe Frame conclu√≠da.  Uma matriz de documentos deve ser usada apenas quando for necess√°rio colocar parte das informa√ß√µes em uma tabela vinculada. </p><br><p>  Se o documento JSON for uma hierarquia de campos nomeados, qualquer campo poder√° ser acessado especificando o caminho da raiz do documento por um per√≠odo, por exemplo, xy. Se a correspond√™ncia xy =&gt; fieldXY for especificada no arquivo DRDL, a tabela de sa√≠da ter√° o n√∫mero de linhas que houver documentos na cole√ß√£o na entrada.  Se em algum documento n√£o houver um campo xy, NULL estar√° na linha correspondente da tabela. </p><br><p>  Suponha que tenhamos um banco de dados do MongoDB chamado Frames, existe uma cole√ß√£o A no banco de dados e o MongoOperations gravou duas inst√¢ncias da classe A. para essa cole√ß√£o. Estes s√£o os documentos: first </p><br><pre> <code class="plaintext hljs">{ "_id": ObjectId("5cdd51e2394faf88a01bd456"), "x": { "y": "xy string value 1"}, "days": [{ "k": "0", "v": 0.0 }, { "k": "1", "v": 0.1 }], "_class": "A" }</code> </pre> <br><p>  e segundo (ObjectId difere pelo √∫ltimo d√≠gito): </p><br><pre> <code class="plaintext hljs">{ "_id": ObjectId("5cdd51e2394faf88a01bd457"), "x": { "y": "xy string value 2"}, "days": [{ "k": "0", "v": 0.3 }, { "k": "1", "v": 0.4 }], "_class": "A" }</code> </pre> <br><p>  O conector de BI n√£o pode acessar os elementos da matriz por √≠ndice e √© simplesmente imposs√≠vel extrair, por exemplo, o campo days [1] .v da matriz para a tabela.  Em vez disso, o conector pode representar cada elemento da matriz de dias como uma linha em uma tabela separada usando o operador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">$ unbind</a> .  Essa tabela separada ser√° associada ao relacionamento um para muitos original por meio do identificador de linha.  No nosso exemplo, as tabelas tableA s√£o definidas para documentos de cole√ß√£o e tableA_days para documentos da matriz de dias.  O arquivo .drdl aparece assim: </p><br><pre> <code class="plaintext hljs">schema: - db: Frames tables: - table: tableA collection: A pipeline: [] columns: - Name: _id MongoType: bson.ObjectId SqlName: _id SqlType: objectid - Name: xy MongoType: string SqlName: fieldXY SqlType: varchar - table: tableA_days collection: A pipeline: - $unwind: path: $days columns: - Name: _id #   MongoType: bson.ObjectId SqlName: tableA_id SqlType: objectid - Name: days.k MongoType: string SqlName: tableA_dayNo SqlType: varchar - Name: days.v MongoType: string SqlName: tableA_dayVal SqlType: varchar</code> </pre> <br><p>  O conte√∫do das tabelas ser√°: table tableA </p><br><div class="scrollable-table"><table><thead><tr><th>  _id </th><th>  fieldXY </th></tr></thead><tbody><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  valor da cadeia xy 1 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  valor da string xy 2 </td></tr></tbody></table></div><br><p>  e tabela tableA_days </p><br><div class="scrollable-table"><table><thead><tr><th>  tableA_id </th><th>  tableA_dayNo </th><th>  tableA_dayVal </th></tr></thead><tbody><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  0 0 </td><td>  0,0 </td></tr><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  1 </td><td>  0,1 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  0 0 </td><td>  0,3 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  1 </td><td>  0,4 </td></tr></tbody></table></div><br><h1 id="itogo">  Total </h1><br><p>  N√£o foi poss√≠vel implementar a tarefa na formula√ß√£o original; voc√™ n√£o pode simplesmente pegar e substituir o db4o pelo MongoDB.  O MongoOperations n√£o pode restaurar automaticamente nenhum objeto como o db4o.  Provavelmente, voc√™ pode fazer isso, mas os custos de m√£o-de-obra n√£o ser√£o compar√°veis ‚Äã‚Äãa chamar os m√©todos de armazenamento / consulta da biblioteca db4o. </p><br><p>  Trilha de auditoria.  O Db4o √© uma ferramenta muito √∫til no in√≠cio de um projeto.  Voc√™ pode simplesmente escrever o objeto, depois restaur√°-lo e, ao mesmo tempo, sem preocupa√ß√µes e tabelas.  Tudo isso com uma ressalva importante: se voc√™ precisar alterar a hierarquia de classes (adicione a classe E entre A e B), todas as informa√ß√µes armazenadas anteriormente se tornar√£o ileg√≠veis.  Mas, para iniciar um projeto, isso n√£o √© muito importante, desde que n√£o haja uma grande matriz acumulada de arquivos antigos. </p><br><p>  Quando havia experi√™ncia suficiente com o MongoOperations, a grava√ß√£o do upload n√£o causava problemas.  Escrever um novo c√≥digo para a estrutura √© muito mais f√°cil do que refazer o antigo, que tamb√©m √© colocado em produ√ß√£o. </p><p></p><p></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461417/">https://habr.com/ru/post/pt461417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461401/index.html">O que voc√™ √©, Event Loop? Ou como o loop de eventos funciona no navegador Chrome</a></li>
<li><a href="../pt461403/index.html">Como escrever m√∫sicas usando OOP</a></li>
<li><a href="../pt461405/index.html">Como tomei o CFA N√≠vel 1</a></li>
<li><a href="../pt461407/index.html">Da hist√≥ria do feriado - AdminFest 2011 em Rostov do Don</a></li>
<li><a href="../pt461413/index.html">N√£o apenas o Wi-Fi 6: como a Huawei desenvolver√° tecnologias de rede</a></li>
<li><a href="../pt461421/index.html">Como se proteger contra poss√≠veis perdas ao investir na bolsa: produtos estruturais</a></li>
<li><a href="../pt461423/index.html">11 dicas: como apresentar o trabalho da interface do usu√°rio / UX para "n√£o designers"</a></li>
<li><a href="../pt461425/index.html">Como se tornar gerente de produtos e crescer ainda mais</a></li>
<li><a href="../pt461431/index.html">‚ÄúAma e n√£o gosta‚Äù: DNS sobre HTTPS</a></li>
<li><a href="../pt461433/index.html">Usando o Identity Server 4 no Net Core 3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>