<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍⚖️ 🏳️ 🧡 Penakluk bayangan lain di Phaser, atau penggunaan sepeda 🤚🏼 🍂 🐆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dua tahun lalu, saya sudah bereksperimen dengan zat bayangan di Phaser 2D. Pada Ludum Dare terakhir, kami tiba-tiba memutuskan untuk membuat kengerian...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Penakluk bayangan lain di Phaser, atau penggunaan sepeda</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434370/">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dua tahun lalu,</a> saya sudah bereksperimen dengan <s>zat</s> bayangan di Phaser 2D.  Pada Ludum Dare terakhir, kami tiba-tiba memutuskan untuk membuat kengerian, dan betapa mengerikannya tanpa bayangan dan cahaya!  Saya memecahkan buku-buku jari saya ... <br><br>  ... dan bukan hal yang tepat waktu untuk LD.  Dalam permainan, tentu saja, ada sedikit cahaya dan bayangan, tetapi ini adalah kemiripan yang menyedihkan dari apa yang seharusnya terjadi. <br><br>  Setelah kembali ke rumah setelah mengirim permainan ke kontes, saya memutuskan untuk "menutup gestalt" dan menyelesaikan bayang-bayang malang ini.  Apa yang terjadi - Anda bisa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">merasakan di dalam game</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bermain di demo</a> , melihat gambar, dan membaca di artikel. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m3/if/35/m3if351xwaowt3lxcayun-cuzak.png"></div><br><a name="habracut"></a>  Seperti biasa dalam kasus seperti itu, tidak masuk akal untuk mencoba menulis solusi umum, Anda perlu fokus pada situasi tertentu.  Dunia permainan dapat direpresentasikan dalam bentuk segmen - setidaknya entitas yang membuat bayangan.  Dinding adalah persegi panjang, orang persegi panjang, hanya diputar, spoiler infernal adalah sebuah lingkaran, tetapi dalam model cut-off dapat disederhanakan menjadi panjang diameter yang selalu tegak lurus terhadap sinar cahaya. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dh/gq/id/dhgqidngehzo_pn9vgr9eirsgna.png"></div><br>  Ada beberapa sumber cahaya (20-30), dan semuanya berbentuk lingkaran (lampu sorot) dan terletak bersyarat lebih rendah dari objek yang diterangi (sehingga bayangan dapat menjadi tak terbatas). <br><br>  Saya melihat di kepala saya cara-cara berikut untuk menyelesaikan masalah: <br><br><ol><li>  Untuk setiap sumber cahaya, kami membangun tekstur ukuran layar (baik, atau 2-4 kali lebih kecil).  Pada tekstur ini, kita cukup menggambar BCC'D 'trapesium, di mana A adalah sumber cahaya, BC adalah segmennya, B'C' adalah proyeksi segmen ke tepi tekstur.  Setelah itu, tekstur ini dikirim ke shader, di mana mereka dicampur menjadi satu gambar. <br><br>  Penulis platformer Celeste melakukan sesuatu seperti ini, yang ditulis dengan baik dalam artikelnya di media: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">medium.com/@NoelFB/remaking-celestes-lighting-3478d6f10bf</a> <br><br>  Masalah: 20-30 tekstur ukuran layar yang perlu digambar ulang hampir setiap frame dan dimuat ke dalam GPU.  Saya ingat bahwa ini adalah proses yang sangat, sangat tidak cepat. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z2/ve/ya/z2veyaflrtcpobcfkkdecuqpkpa.png"></div><br></li><li>  Metode yang dijelaskan dalam posting di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">habr</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">habr.com/post/272233</a> .  Untuk setiap sumber cahaya, kami membangun "peta kedalaman", mis.  tekstur seperti itu, di mana x = sudut "balok" dari sumber cahaya, y = jumlah sumber cahaya, dan warna == jarak dari sumber ke rintangan terdekat.  Jika kita mengambil langkah 0,7 derajat (360/512), dan 32 sumber cahaya, kita mendapatkan satu tekstur 512x32, yang belum diperbarui begitu lama. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/aq/ew/_x/aqew_xze8rbkwvhj-68t3d4glz4.png"></div>  <sup>(contoh tekstur untuk langkah 45 derajat)</sup> <br></li><li>  Cara rahasia yang akan saya jelaskan di bagian paling akhir </li></ol><br>  Pada akhirnya, saya memilih metode 2. Namun, yang dijelaskan dalam artikel itu tidak cocok untuk saya sampai akhir.  Di sana, tekstur juga dibangun di shader menggunakan rakecast - shader dalam siklus pergi dari sumber cahaya ke arah balok dan mencari penghalang.  Dalam eksperimen saya yang lalu, saya juga membuat rakecast di shader, dan harganya sangat mahal, meskipun bersifat universal. <br><br>  “Kami hanya memiliki segmen dalam model,” saya pikir, “dan 10-20 segmen jatuh ke jari-jari sumber cahaya apa pun.  Tidak bisakah saya dengan cepat menghitung peta jarak berdasarkan ini? " <br><br>  Jadi saya memutuskan untuk melakukannya. <br><br>  Untuk mulai dengan, saya hanya ditampilkan di layar dinding, "karakter utama" bersyarat dan sumber cahaya.  Di sekitar sumber cahaya, lingkaran cahaya bening murni memotong dalam kegelapan.  Untuk mendapatkan ini: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yl/jh/y4/yljhy4kuzvmkdqscqjuzsbqfjms.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">demo</a> )</sup> <br><br>  Saya segera mulai melakukannya dengan shader agar tidak rileks.  Itu perlu untuk masuk ke dalamnya untuk setiap sumber cahaya koordinat dan jari-jarinya tindakan (di luar yang cahaya tidak mencapai), ini dilakukan hanya melalui array yang seragam.  Dan kemudian dalam shader (yang terpisah-pisah, yang dilakukan untuk setiap piksel pada layar), tetap untuk memahami apakah piksel saat ini berada di lingkaran kita yang diterangi atau tidak. <br><pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleLightShader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phaser</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Filter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(game) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(game); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lightsArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(MAX_LIGHTS*<span class="hljs-number"><span class="hljs-number">4</span></span>); lightsArray.fill(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, lightsArray.length); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lightsCount = {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'1i'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lights = {<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'4fv'</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: lightsArray}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fragmentSrc = <span class="hljs-string"><span class="hljs-string">` precision highp float; uniform int lightsCount; uniform vec4 lights[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MAX_LIGHTS}</span></span></span><span class="hljs-string">]; void main() { float lightness = 0.; for (int i = 0; i &lt; </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${MAX_LIGHTS}</span></span></span><span class="hljs-string">; i++) { if (i &gt;= lightsCount) break; vec4 light = lights[i]; lightness += step(length(light.xy - gl_FragCoord.xy), light.z); } lightness = clamp(0., 1., lightness); gl_FragColor = mix(vec4(0,0,0,0.5), vec4(0,0,0,0), lightness); } `</span></span>; } updateLights(lightSources) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lightsCount.value = lightSources.length; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> array = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.uniforms.lights.value; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> light <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> lightSources) { array[i++] = light.x; array[i++] = game.world.height - light.y; array[i++] = light.radius; i++; } } }</code> </pre> <br>  Sekarang kita perlu memahami untuk setiap sumber cahaya segmen mana yang akan memberikan bayangan.  Sebaliknya, bagian mana dari segmen - pada gambar di bawah ini kita tidak tertarik pada bagian "merah" dari segmen, karena  cahaya masih tidak mencapai mereka. <br><br>  <i>Catatan: definisi persimpangan adalah semacam optimisasi awal.</i>  <i>Ini diperlukan untuk mengurangi waktu pemrosesan lebih lanjut, menghilangkan potongan-potongan besar segmen di luar radius sumber cahaya.</i>  <i>Ini masuk akal ketika kita memiliki banyak segmen yang panjangnya jauh lebih besar dari jari-jari "cahaya".</i>  <i>Jika ini bukan masalahnya, dan kami memiliki banyak segmen pendek, mungkin benar untuk tidak membuang waktu menentukan persimpangan dan memproses seluruh segmen, karena</i>  <i>menghemat waktu masih tidak berfungsi.</i> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cb/93/mb/cb93mbs6zzyyqwvfx633ppxbtzg.png"></div><br>  Untuk melakukan ini, saya menggunakan rumus terkenal untuk menemukan persimpangan garis lurus dan lingkaran, yang diingat oleh semua orang dari pelajaran sekolah dalam geometri ... di dunia imajiner seseorang.  Saya tidak mengingatnya, jadi saya harus mencari di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">google</a> . <br><br>  Kami menyandikan, lihat apa yang terjadi. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_0/up/go/_0upgoezkyggo7sfkntejosckg0.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">demo</a> )</sup> <br>  Tampaknya menjadi norma.  Sekarang kita tahu segmen mana yang dapat memberikan bayangan dan dapat melakukan rakecast. <br><br>  Di sini kami juga memiliki opsi: <br><br><ol><li>  Kami hanya berputar-putar, melempar sinar dan mencari persimpangan.  Jarak ke persimpangan terdekat adalah nilai yang kita butuhkan </li><li>  Anda hanya bisa pergi ke sudut-sudut yang masuk dalam segmen.  Lagi pula, kita sudah tahu poinnya, tidak sulit untuk menghitung sudutnya. </li><li>  Selanjutnya, jika kita berjalan di sepanjang ruas, maka kita tidak perlu melempar sinar dan menghitung persimpangan - kita bisa bergerak di sepanjang ruas dengan langkah yang diinginkan.  Begini cara kerjanya: </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9w/db/yp/9wdbyph5wjrn9dolovyhf_5y6-w.png"></div><br>  Di sini <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>A</mi><mi>B</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.507ex" height="2.057ex" viewBox="0 -780.1 1510 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-41" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-42" x="750" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi><mi>B</mi></math></span></span><script type="math/tex" id="MathJax-Element-1"> AB </script>  - segmen (dinding), <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.766ex" height="2.057ex" viewBox="0 -780.1 760.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-43" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> C </script>  Apakah pusat sumber cahaya, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.982ex" height="2.057ex" viewBox="0 -780.1 1284 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-64" x="760" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> Cd </script>  - tegak lurus ke segmennya. <br><br>  Biarkan <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>x</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.455ex" viewBox="0 -520.7 572.5 626.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-78" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>x</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> x </script>  - sudut ke normal, di mana Anda perlu mencari tahu jarak dari sumber ke segmen, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.979ex" height="2.298ex" viewBox="0 -780.1 1282.4 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMAIN-31" x="1171" y="-213"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-5"> X_1 </script>  - tunjuk pada segmen <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>A</mi><mi>B</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.507ex" height="2.057ex" viewBox="0 -780.1 1510 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-41" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-42" x="750" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>A</mi><mi>B</mi></math></span></span><script type="math/tex" id="MathJax-Element-6"> AB </script>  di mana sinar itu jatuh.  Segitiga <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>D</mi><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.669ex" height="2.298ex" viewBox="0 -780.1 2871.4 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-44" x="760" y="0"></use><g transform="translate(1589,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMAIN-31" x="1171" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>D</mi><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-7"> CDX_1 </script>  - persegi panjang <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.982ex" height="2.057ex" viewBox="0 -780.1 1284 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-64" x="760" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-8"> Cd </script>  - Kaki, dan panjangnya diketahui dan konstan untuk segmen ini, <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.298ex" viewBox="0 -780.1 2042.9 989.6" role="img" focusable="false" style="vertical-align: -0.487ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-43" x="0" y="0"></use><g transform="translate(760,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMAIN-31" x="1171" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-9"> CX_1 </script>  - panjang yang diinginkan. <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>C</mi><mi>D</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy=&quot;false&quot;>(</mo><mi>x</mi><mo stretchy=&quot;false&quot;>)</mo></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.042ex" height="2.66ex" viewBox="0 -832 9921 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-43" x="0" y="0"></use><g transform="translate(760,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-58" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMAIN-31" x="1171" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMAIN-3D" x="2320" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-66" x="3626" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-72" x="4177" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-61" x="4628" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-63" x="5158" y="0"></use><g transform="translate(5591,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-43" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-44" x="760" y="0"></use></g><g transform="translate(7180,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-63" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-6F" x="433" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-73" x="919" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMAIN-28" x="1388" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-78" x="1778" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMAIN-29" x="2350" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>C</mi><msub><mi>X</mi><mn>1</mn></msub><mo>=</mo><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>C</mi><mi>D</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></math></span></span><script type="math/tex" id="MathJax-Element-10"> CX_1 = \ frac {CD} {cos (x)} </script>  .  Jika Anda mengetahui langkah sebelumnya (dan kami tahu itu), maka Anda dapat menghitung awal tabel cosinus terbalik dan mencari jarak dengan sangat cepat. <br><br>  Saya akan memberikan contoh kode untuk tabel seperti itu.  Hampir semua pekerjaan dengan sudut digantikan oleh kerja dengan indeks, yaitu  bilangan bulat dari 0 hingga N, di mana N = jumlah langkah dalam lingkaran (mis. langkah sudut = <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>2</mn><mtext>&amp;#xA0;</mtext><mi>p</mi><mi>i</mi></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>N</mi></mrow></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.923ex" height="2.419ex" viewBox="0 -780.1 4703 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMAIN-32" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-70" x="750" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-69" x="1254" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://habr.com/ru/post/434370/&amp;usg=ALkJrhiFH-CIFkLqohsfJLi-dOE5jOGwJg#MJMATHI-4E" x="3814" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mn>2</mn><mtext>&nbsp;</mtext><mi>p</mi><mi>i</mi></mrow><mrow class="MJX-TeXAtom-ORD"><mi>N</mi></mrow></math></span></span><script type="math/tex" id="MathJax-Element-11"> \ frac {2 \ pi} {N} </script>  ) <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HypTable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(steps = 512, stepAngle = 2*Math.PI/steps) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.perAngleStep = [<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; steps/<span class="hljs-number"><span class="hljs-number">4</span></span>; i++) { <span class="hljs-comment"><span class="hljs-comment">//   pi/2 let ang = i*stepAngle; this.perAngleStep[i] = 1/Math.cos(ang); } this.stepAngle = stepAngle; } /** * @param distancesMap -  ,    * @param angle1 -           * @param angle2 -           * @param normalFromLight - ,      */ fillDistancesForArc(distancesMap, angle1, angle2, normalFromLight) { const D = Math.hypot(normalFromLight.x, normalFromLight.y); const normalAngle = Phaser.Math.normalizeAngle(Math.atan2(normalFromLight.y, normalFromLight.x)); const normalAngleIndex = (normalAngle / this.stepAngle)|0; const index1 = (angle1 / this.stepAngle)|0; const index2 = (angle2 / this.stepAngle)|0; for (let angleIndex = index1; angleIndex &lt;= index2; angleIndex++) { let distanceForAngle = D * this.perAngleStep[normalize(angleIndex - normalAngleIndex)]; distancesMap.set(angleIndex, distanceForAngle); } } }</span></span></code> </pre><br>  Tentu saja, metode ini memperkenalkan kesalahan untuk kasus-kasus di mana ACD sudut awal bukan kelipatan langkah.  Tapi untuk 512 langkah, saya tidak melihat perbedaan secara visual. <br><br>  Jadi apa yang sudah kita ketahui bagaimana melakukannya: <br><ol><li>  Temukan segmen dalam kisaran sumber cahaya yang dapat membuat bayangan <br></li><li>  Untuk langkah t, buat tabel dist (sudut), melewati setiap segmen dan menghitung jarak. </li></ol><br><br>  Seperti apa tabel ini jika Anda menggambarnya dalam sinar. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kh/5m/17/kh5m17zbgdyq22dfeoys5borlbe.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">demo</a> )</sup> <br><br>  Dan berikut ini tampilannya 10 sumber cahaya, jika ditulis dalam tekstur. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bg/ex/3-/bgex3-jcfuohb9_egfv_4ul-x2e.png"></div><br>  Di sini, setiap piksel horizontal bersesuaian dengan sudut, dan warna dengan jarak dalam piksel. <br>  Itu ditulis dalam js seperti ini menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">imageData</a> <br><pre> <code class="javascript hljs"> fillBitmap(data, index) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> total = index + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.steps*<span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> d1, d2; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//data[index] = Red //data[index+1] = Green //data[index+2] = Blue //data[index+3] = Alpha for (; index &lt; total; index+=4, i++) { //  512,    R     2. d1 = (this.distances[i]/2)|0; data[index] = d1; d1 = this.distances[i] - d1*2; d2 = (d1*128)|0; //   G -     2. data[index+1] = d2; //  B  A  255,     . data[index+2] = 255; data[index+3] = 255; } }</span></span></code> </pre><br><br>  Sekarang kami meneruskan tekstur ke shader kami, yang sudah memiliki koordinat dan jari-jari sumber cahaya.  Dan prosesnya seperti ini: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      uniform sampler2D iChannel0; #define STRENGTH 0.3 #define MAX_DARK 0.7 #define M_PI 3.141592653589793 #define M_PI2 6.283185307179586 //       float decodeDist(vec4 color) { return color.r*255.*2. + color.g*2.; } float getShadow(int i, float angle, float distance) { //   x   ==  float u = angle/M_PI2; //   y   ==     float v = float(i)/${MAX_LIGHTS}.; float shadowAfterDistance = decodeDist(texture2D(iChannel0, vec2(u, v))); //  1   ,  0  . return step(shadowAfterDistance, distance); } void main() { float lightness = 0.; for (int i = 0; i &lt; ${MAX_LIGHTS}; i++) { if (i &gt;= lightsCount) break; vec4 light = lights[i]; //       vec2 light2point = gl_FragCoord.xy - light.xy; float radius = light.z; float distance = length(light2point); float inLight = step(distance, radius); //      ,       //  . //      , //    ,          //           //     ,    if (inLight == 0.) continue; float angle = mod(-atan(light2point.y, light2point.x), M_PI2); // 1     0   float thisLightness = (1. - getShadow(i, angle, distance)); //,   “”  ,   ,  //    lightness += thisLightness*STRENGTH; } lightness = clamp(0., 1., lightness); gl_FragColor = mix(vec4(0,0,0,MAX_DARK), vec4(0,0,0,0), lightness); }</span></span></code> </pre> <br><br>  Hasil: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f9/0l/hj/f90lhj2yepescdli2qndmyx-xkq.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">demo</a> )</sup> <br>  Sekarang kamu bisa menghadirkan sedikit keindahan.  Biarkan cahaya memudar dengan jarak, dan bayangan akan buram. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1s/op/sg/1sopsggdgrpurmn0qsui8rcfhne.png"></div><br>  Untuk kabur, saya melihat sudut yang berdekatan, + - langkah, seperti ini: <br><br><pre> <code class="cpp hljs">thisLightness = (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle, distance)) * <span class="hljs-number"><span class="hljs-number">0.4</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle-SMOOTH_STEP, distance)) * <span class="hljs-number"><span class="hljs-number">0.2</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle+SMOOTH_STEP, distance)) * <span class="hljs-number"><span class="hljs-number">0.2</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle-SMOOTH_STEP*<span class="hljs-number"><span class="hljs-number">2.</span></span>, distance)) * <span class="hljs-number"><span class="hljs-number">0.1</span></span> + (<span class="hljs-number"><span class="hljs-number">1.</span></span> - getShadow(i, angle+SMOOTH_STEP*<span class="hljs-number"><span class="hljs-number">2.</span></span>, distance)) * <span class="hljs-number"><span class="hljs-number">0.1</span></span>;</code> </pre><br><br>  Jika Anda menggabungkan semuanya dan mengukur FPS, hasilnya seperti ini: <br><br><ul><li>  Pada kartu video built-in - semuanya buruk (&lt;30-40), bahkan untuk contoh sederhana <br></li><li>  Segala sesuatu yang lain baik-baik saja, selama sumber cahaya tidak terlalu kuat.  Artinya, jumlah sumber cahaya per piksel penting, bukan jumlah total. <br></li></ul><br><br>  Hasil ini cukup cocok untukku.  Anda masih bisa bermain dengan warna pencahayaan, tetapi saya tidak.  Setelah memutar sedikit dan menambahkan beberapa peta normal, saya mengunggah versi NOPE yang diperbarui.  Dia tampak seperti ini sekarang: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/nw/4o/cqnw4opdblgnm6ebys-lgbtvnt4.gif"></div><br><br>  Kemudian dia mulai menyiapkan artikel.  Saya melihat gif dan pemikiran seperti itu. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ct/de/zr/ctdezrcsaztxtgxx9jyioatirds.gif"></div><br>  “Jadi ini hampir mirip pseudo-3D, seperti di Wolfenstein,” seruku (ya, aku punya imajinasi yang bagus).  Dan faktanya - jika kita mengasumsikan bahwa semua dinding memiliki ketinggian yang sama, maka jarak peta akan cukup bagi kita untuk membangun pemandangan.  Kenapa tidak mencobanya? <br><br>  Adegan harus terlihat seperti ini. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lg/5v/-s/lg5v-sk8cmojfurrj_pnrg3xw0k.png"></div><br><br>  Jadi tugas kita: <br><br><ol><li>  Pada titik di layar, dapatkan koordinat dunia untuk kasing ketika tidak ada dinding. <br><br>  Kami akan mempertimbangkan ini: <br><ul><li>  Pertama, kita menormalkan koordinat titik di layar sehingga ada titik (0,0) di tengah layar, dan di sudut (-1, -1) dan (1,1), masing-masing <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/l9/ki/fu/l9kifubvfwn50ust9lhtsik2f_k.png"></div></li><li>  Koordinat x menjadi sudut dari arah pandang, Anda hanya perlu mengalikannya dengan A / 2, di mana A adalah sudut pandangnya <br></li><li>  Koordinat y menentukan jarak dari pengamat ke titik, dalam kasus umum d ~ 1 / y.  Untuk titik di tepi bawah layar, jarak = 1, untuk titik di tengah layar, jarak = tak terhingga. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8e/ua/4b/8eua4bycfatkegaiwbyu_eohxky.png"></div></li><li>  Jadi, jika Anda tidak memperhitungkan dinding, maka untuk setiap titik yang terlihat di dunia akan ada 2 titik di layar - satu di atas tengah (di "langit-langit") dan yang lainnya di bawah (di "lantai") <br></li></ul></li><li>  Sekarang kita bisa melihat tabel jarak.  Jika ada dinding yang lebih dekat dari titik kami, maka Anda perlu menggambar dinding.  Jika tidak, itu berarti lantai atau langit-langit <br></li></ol><br>  Kami mendapatkan sesuai pesanan: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qp/gj/lu/qpgjluavcmsuba51v0iovqdccc0.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">demo</a> )</sup> <br>  Tambahkan pencahayaan - dengan cara yang sama, beralih ke sumber cahaya dan periksa koordinat dunia.  Dan - sentuhan terakhir - tambahkan tekstur.  Untuk melakukan ini, dalam tekstur dengan jarak, Anda juga perlu menulis offset u untuk tekstur dinding pada titik ini.  Di sinilah saluran b berguna. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kn/ai/ay/knaiayi9epavp3cr8u6wcd4x2ss.png"></div>  <sup>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">demo</a> )</sup> <br>  Sempurna <br><br>  Hanya bercanda <br><br>  Tidak sempurna, tentu saja.  Tapi sial, saya masih membaca tentang bagaimana membuat Wolfenstein saya melalui rakecast sekitar 15 tahun yang lalu, dan saya ingin melakukan semuanya, dan inilah kesempatan seperti itu! <br><br><h4>  Alih-alih sebuah kesimpulan </h4><br>  Di awal artikel, saya menyebutkan metode rahasia lain.  Ini dia: <br><br><blockquote>  <b>Ambil saja mesin yang sudah tahu caranya.</b> </blockquote><br>  Bahkan, jika Anda perlu membuat game, maka ini akan menjadi cara yang paling benar dan tercepat.  Mengapa Anda perlu memagari sepeda dan memecahkan masalah lama? <br><br>  Tapi kenapa. <br><br>  Di kelas 10, saya pindah ke sekolah lain dan mengalami masalah dalam matematika.  Saya tidak ingat contoh persisnya, tetapi itu adalah persamaan dengan derajat, yang dalam segala hal perlu disederhanakan, tetapi itu tidak berhasil.  Putus asa, saya berkonsultasi dengan saudara perempuan saya, dan dia berkata: "jadi tambahkan x <sup>2</sup> di kedua sisi, dan semuanya akan terurai."  Dan itu solusinya: tambahkan apa yang tidak ada. <br><br>  Ketika, jauh kemudian, saya membantu teman saya membangun rumah saya, saya harus meletakkan blok pada ambang pintu - untuk mengisi ceruk.  Dan di sini saya berdiri dan memilah pinggiran jeruji.  Seseorang tampaknya cocok, tetapi tidak cukup.  Lainnya jauh lebih kecil.  Saya sedang berpikir tentang cara mengumpulkan kata kebahagiaan di sini, dan seorang teman mengatakan: "jadi mereka meminum lekukan di tempat melingkar tempat itu mengganggu".  Dan sekarang bar besar sudah berdiri diam. <br><br>  Kisah-kisah ini disatukan oleh efek seperti itu, yang saya sebut "efek inventaris".  Ketika Anda mencoba membuat keputusan dari bagian yang ada, tanpa melihat materi yang dapat diproses dan disempurnakan di bagian ini.  Angka adalah kayu, uang, atau kode. <br><br>  Banyak kali saya mengamati efek yang sama dengan rekan kerja dalam pemrograman.  Tidak merasa percaya diri pada materi, mereka terkadang menyerah ketika perlu untuk melakukan, katakanlah, kontrol non-standar.  Atau tambahkan tes unit ke tempat mereka tidak.  Atau mereka mencoba menyediakan segalanya, semuanya saat merancang kelas, dan kemudian kita mendapatkan dialog seperti: <br>  - Ini tidak perlu sekarang <br>  - Bagaimana jika itu perlu? <br>  - Lalu kita akan menambahkan.  Tinggalkan poin ekspansi, itu saja.  Kode bukan granit, melainkan plastisin. <br><br>  Dan untuk belajar melihat dan merasakan materi yang kami kerjakan, kami juga membutuhkan sepeda. <br><br>  Ini bukan hanya latihan untuk pikiran atau pelatihan.  Ini adalah cara untuk mencapai tingkat pekerjaan yang berbeda secara kualitatif dengan kode. <br><br>  Terima kasih sudah membaca. <br><br>  Tautan, jika Anda lupa mengklik di suatu tempat: <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Semua demo bersama</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kode demo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sebenarnya game LD dengan bayangan</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id434370/">https://habr.com/ru/post/id434370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id434358/index.html">Substitusi impor sistem operasi. Bagaimana cara melihat OS domestik</a></li>
<li><a href="../id434360/index.html">Penjelasan pembicaraan tentang pemrograman asinkron dalam Javascript</a></li>
<li><a href="../id434362/index.html">BUKAN perkiraan untuk 2019</a></li>
<li><a href="../id434364/index.html">Dukungan Antrian Hangfire</a></li>
<li><a href="../id434368/index.html">Pembelajaran Mesin untuk Menemukan Kesalahan dalam Kode: Bagaimana Saya Magang di JetBrains Research</a></li>
<li><a href="../id434374/index.html">Memeriksa RBAC di Kubernetes</a></li>
<li><a href="../id434380/index.html">Dasar-dasar Injeksi Ketergantungan</a></li>
<li><a href="../id434382/index.html">Porting Alpine Linux ke RISC-V</a></li>
<li><a href="../id434384/index.html">Atas tanggung jawab pemain</a></li>
<li><a href="../id434386/index.html">Douglas Engelbart: "Menambah Kecerdasan Manusia: Kerangka Konseptual"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>