<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêà üïñ üí± Como transformar um smartphone em uma mesa de caixa completa ü¶Ü üëåüèø üë∑üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todos os dias nas lojas, vemos diferentes balc√µes - todos os tipos de solu√ß√µes incorporadas com bot√µes misteriosos. Atr√°s de tais mesas de caixa h√° ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como transformar um smartphone em uma mesa de caixa completa</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/moysklad/blog/462993/"><p>  Todos os dias nas lojas, vemos diferentes balc√µes - todos os tipos de solu√ß√µes incorporadas com bot√µes misteriosos.  Atr√°s de tais mesas de caixa h√° caixas que gritam "Galya, n√≥s cancelamos".  Isso √© inconveniente para caixas e compradores. </p><br><p>  A interface do checkout se torna mais amig√°vel ao longo do tempo, e o Gali j√° √© menos necess√°rio, mas o checkout ainda permanece um artefato complicado e complexo. </p><br><p><img src="https://habrastorage.org/webt/zq/bc/ia/zqbcia27fpbw0x-pgb09nk2khtw.png"></p><br><p>  Meu nome √© Vladimir Sarbeev, sou desenvolvedor Android no MySklad.  E tenho certeza de que a caixa registradora pode ser compacta e conveniente.  Al√©m disso, voc√™ pode transformar seu smartphone em uma caixa. </p><a name="habracut"></a><br><p>  No MyStore, criamos o aplicativo m√≥vel Kassa MyStore.  Esta √© uma bilheteria completa dentro do smartphone. </p><br><p>  Funciona assim: ap√≥s a autoriza√ß√£o, o caixa pode abrir e fechar turnos, vender mercadorias diretamente ou mediante reserva, levar em considera√ß√£o o dinheiro.  Voc√™ pode conectar dispositivos necess√°rios para trabalhar no Caixa.  Eles est√£o na foto: </p><br><p><img src="https://habrastorage.org/webt/wp/_t/8k/wp_t8kkm69mpwtht7fb7d6a36nq.png"><br>  <em>1 - bilheteria Atol Sigma 10;</em>  <em>2 - o aplicativo n√£o √© suportado, integra√ß√£o com funcion√°rios</em> <br>  <em>3 - bilheteria Atol 11F;</em>  <em>4 - Verifone VX820 terminal;</em>  <em>5 - terminal PAX S90</em> <br>  <em>6 - bilheteria Shtrikh-Nano-F;</em>  <em>7 - bilheteria Atol 15F;</em>  <em>8 - bilheteria Bar-ON-LINE</em> <br>  <em>9 - scanner de c√≥digo de barras;</em>  <em>10 - terminal PayMe;</em>  <em>11 - balc√£o de caixa MSPOS-K</em> </p><br><p>  O smartphone em si n√£o pode imprimir recibos de dinheiro e aceitar pagamentos com cart√£o de cr√©dito; portanto, s√£o necess√°rios balc√µes e terminais de pagamento.  √â necess√°rio um scanner de hardware se a c√¢mera do smartphone n√£o for adequada para a substitui√ß√£o completa do scanner de c√≥digo de barras. </p><br><h2 id="vsevidyaschee-oko">  Olho que tudo v√™ </h2><br><p>  Mesmo antes do lan√ßamento do MySklad, o Cash desk, decidimos que a c√¢mera √© uma c√¢mera, mas o usu√°rio pode ter um scanner de c√≥digo de barras de hardware que ele deseja usar. </p><br><p>  Podemos trabalhar com scanners na forma de um HID comum (dispositivo de interface humana).  Depois de ler o c√≥digo de barras, obtemos uma sequ√™ncia de caracteres no scanner.  Esta √© talvez a integra√ß√£o mais f√°cil.  O mais simples, se n√£o dois "buts". </p><br><p>  Em primeiro lugar, estando ‚Äúpronto para uso‚Äù, um scanner pode n√£o transmitir o que deveria.  Em segundo lugar, nem todos os modelos de scanner nos sinalizam que a leitura do c√≥digo de barras est√° completa. </p><br><p>  O primeiro ‚Äúmas‚Äù √© resolvido simplesmente: se o scanner come√ßar a transmitir n√£o o que deve digitalizar, voc√™ precisar√° encontrar as instru√ß√µes para o scanner e configur√°-lo usando os c√≥digos de barras de servi√ßo.  Normalmente, as instru√ß√µes s√£o completas em papel ou em formato eletr√¥nico do fabricante.  Depois de descrever as configura√ß√µes dispon√≠veis, ele cont√©m c√≥digos de barras que s√£o digitalizados na sequ√™ncia desejada.  Assim, voc√™ pode configurar o scanner conforme necess√°rio. </p><br><p>  O segundo "mas" √© um problema mais s√©rio.  O zool√≥gico de scanners √© extenso e nem todos os dispositivos mostram o fim de uma linha de leitura.  Existem duas op√ß√µes para resolver esse problema.  A primeira √© usar os mesmos c√≥digos de barras de servi√ßo para definir uma configura√ß√£o que transmitir√° o caractere de quebra de linha ap√≥s a leitura.  Se voc√™ n√£o tiver sorte com o modelo e a primeira op√ß√£o n√£o for adequada, poder√° definir o sufixo do scanner.  Usando os c√≥digos de barras de servi√ßo, adicione um caractere no final da sequ√™ncia de leitura, pelo qual voc√™ pode capturar o final da entrada. </p><br><h2 id="podklyuchaem-kassu">  Eu conecto mesa de dinheiro </h2><br><p> Portanto, o aplicativo est√° l√°, o scanner de c√≥digo de barras est√° conectado, mas ainda n√£o conseguimos imprimir o cheque.  Para isso, precisamos da bilheteria.  No MySklad, apoiamos o KKT Atol e o Shtrikh, tamb√©m o MSPOS, vou falar sobre isso em outro artigo. </p><br><p>  No que diz respeito √† integra√ß√£o com o caixa, a quantidade de c√≥digo de ferro come√ßou a crescer inexoravelmente.  Decidimos colocar todo o trabalho com o equipamento conectado em uma biblioteca separada.  O pr√≥prio aplicativo de caixa registradora se tornou um cliente puxando uma biblioteca atrav√©s do gradle. </p><br><p>  Dependendo do modelo, voc√™ pode conectar via USB, Bluetooth ou Wi-Fi.  E tamb√©m de acordo com o protocolo UART, que √© um acoplamento r√≠gido da caixa registradora e um dispositivo Android em um caso.  Al√©m disso, diferentes fornecedores diferem radicalmente na implementa√ß√£o da conex√£o do cliente ao checkout.  Wrapper Java sobre as bibliotecas nativas .so, um complemento sobre a biblioteca jPOS de c√≥digo aberto e at√© o n√∫cleo fiscal acessado por meio de um servi√ßo com uma interface AIDL (linguagem de defini√ß√£o de interface do Android). </p><br><p>  Nas primeiras tentativas de integrar um dispositivo de um fabricante, ficamos satisfeitos com o esquema de intera√ß√£o do dispositivo KKM: </p><br><p><img src="https://habrastorage.org/webt/jz/tz/my/jztzmyluw0ilashos-8utonzj9m.png"></p><br><p>  Mas, levando em considera√ß√£o o n√∫mero de implementa√ß√µes de driver, m√©todos de conex√£o e uniformidade de funcionalidade, decidimos repensar o trabalho com hardware.  Como resultado, o esquema anterior chegou a este formul√°rio: </p><br><p><img src="https://habrastorage.org/webt/5s/l1/sz/5sl1szcf5jfdhbrvs0r7uebkpek.png"></p><br><p>  <em>T √© um wrapper de driver de baixo n√≠vel espec√≠fico</em> </p><br><p>  O Gerenciador de dispositivos oculta a implementa√ß√£o da conex√£o do cliente.  Basta criar um assistente de conex√£o, que requer que voc√™ selecione sequencialmente o fabricante, o tipo de conex√£o e especifique as configura√ß√µes.  No caso de uma conex√£o bem-sucedida, ele nos retorna um objeto que implementa a interface KKMDevice. </p><br><p>  O KKMDevice oculta os detalhes do trabalho com um driver de fornecedor individual.  Os inv√≥lucros de cada fabricante espec√≠fico cont√™m um link para o driver T e os delegados que implementam certos conjuntos de fun√ß√µes.  Por exemplo, FiscalDelegate, NonFiscalDelegate, DeviceInfoDelegate. </p><br><p>  Vou observar alguns pontos gerais de integra√ß√£o: </p><br><ul><li>  Fique atento √†s atualiza√ß√µes do driver.  Al√©m de corre√ß√µes de bugs e maior velocidade, ocorrem frequentemente saltos de qualidade.  Acredite, a transi√ß√£o de comandos HEX de baixo n√≠vel para uma interface semelhante a Java e dela para tarefas json facilita muito o trabalho e torna o c√≥digo mais compreens√≠vel. </li><li>  Durante a dura√ß√£o das opera√ß√µes, bloqueie a interface do usu√°rio com uma barra de progresso.  A placa diz que o bot√£o "Pagar" pressionado v√°rias vezes seguidas com um PCC conectado √© um pren√∫ncio de cr√≠ticas no rastreador de tarefas. </li><li>  Verifique se as opera√ß√µes com o CCP s√£o executadas estritamente em sequ√™ncia.  Uma corrida de fluxo ‚Äúbem-sucedida‚Äù pode desligar o KKT, enquanto a barra de progresso girando ao mesmo tempo tamb√©m √© uma aplica√ß√£o. </li><li>  Se voc√™ precisar configurar a transfer√™ncia de dados para o operador de dados fiscais, aconselho a selecionar o n√∫mero m√°ximo de par√¢metros em uma lista predefinida.  Como inserir dados manualmente com uma unidade fiscal militar √© uma √≥tima maneira de dar um tiro no p√©, mas no lado do usu√°rio ao usar o aplicativo. </li></ul><br><p>  Uma unidade fiscal √© um dispositivo que coleta e processa informa√ß√µes sobre opera√ß√µes de negocia√ß√£o.  Pode custar mais do que as pr√≥prias bilheterias.  Se a unidade n√£o estiver configurada corretamente, pode ser necess√°rio zerar o processo.  Para fazer isso, abra a bilheteria e imediatamente a garantia voa. </p><br><h2 id="ekvayring">  Aquisi√ß√£o </h2><br><p>  Portanto, temos a interface do caixa, podemos digitalizar as mercadorias por c√≥digo de barras e imprimir o cheque.  Resta acrescentar a capacidade de pagar com cart√£o. </p><br><p>  Nosso aplicativo integra suporte para terminais PayMe e Inpas.  Os primeiros s√£o conectados via Bluetooth, enquanto os √∫ltimos podem ser conectados via USB ou Wi-Fi. </p><br><p>  O esquema de conex√£o para terminais de pagamento √© muito semelhante √† conex√£o de um PCC, a menos que seja necess√°ria autoriza√ß√£o adicional. </p><br><p>  Mas existem diferen√ßas s√©rias - ao lidar com o comportamento anormal do dispositivo.  Portanto, no PCC, qualquer opera√ß√£o foi aprovada com √™xito ou n√£o.  Se a opera√ß√£o falhar, voc√™ pode tentar novamente ou cancel√°-lo.  Tudo o resto acontece sem interven√ß√£o. </p><br><p>  No caso de terminais, √© necess√°rio monitorar poss√≠veis interrup√ß√µes do processo de pagamento a qualquer momento.  Um cart√£o banc√°rio pode n√£o ser considerado ou haver√° fundos insuficientes no cart√£o.  Voc√™ n√£o pode esperar por uma resposta do banco ou aguardar, mas obtenha um c√≥digo HTTP 5xx em resposta.  E em qualquer um dos est√°gios, a conex√£o pode simplesmente cair. </p><br><p>  Al√©m disso, voc√™ n√£o poder√° liberar um aplicativo que funcione adequadamente com o suporte do terminal Inpas sem certifica√ß√£o.  A certifica√ß√£o inclui a verifica√ß√£o da disponibilidade e a opera√ß√£o correta de todas as opera√ß√µes do usu√°rio do terminal e o processamento de eventos, como desconex√£o da rede depois que o comprador j√° anexou um cart√£o ao terminal. </p><br><p>  Ao testar o terminal, √© necess√°rio considerar com qual banco ou sistema de pagamento ele est√° associado.  Em alguns casos, mesmo no modo de desenvolvimento, o dinheiro √© reembolsado apenas atrav√©s da conta pessoal da conta, e n√£o automaticamente. </p><br><p>  Voc√™ tamb√©m precisa se lembrar de que o banco tamb√©m participa do processo de pagamento.  Por exemplo, a aus√™ncia de um cheque-slip pode ocorrer se n√£o houver uma configura√ß√£o necess√°ria na conta pessoal do banco. </p><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  Conectar v√°rios dispositivos a um aplicativo Android √© um processo complicado, mas interessante.  Conversamos sobre ele como um todo, para descrever todos os obst√°culos, √© claro, n√£o √© realista. </p><br><p>  Se voc√™ tiver alguma d√∫vida, terei prazer em respond√™-las nos coment√°rios.  Se as perguntas forem digitadas em um artigo separado, escreva :) </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt462993/">https://habr.com/ru/post/pt462993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt462977/index.html">Acelere os processos rotineiros de RH com RPA e BluePrism</a></li>
<li><a href="../pt462979/index.html">Folha de dicas para um trainee: solu√ß√£o passo a passo de problemas em uma entrevista no Google</a></li>
<li><a href="../pt462983/index.html">Voice for game dev: como desenvolvemos a busca por voz "Lovecraft World"</a></li>
<li><a href="../pt462989/index.html">BERT de conversa√ß√£o - Aprenda redes neurais no idioma das m√≠dias sociais</a></li>
<li><a href="../pt462991/index.html">Navegando na onda 3.0</a></li>
<li><a href="../pt462997/index.html">Mitap da Sociedade de Testadores An√¥nimos # 7 - relat√≥rio da reuni√£o</a></li>
<li><a href="../pt463001/index.html">Testando sua infraestrutura como c√≥digo com Pulumi. Parte 1</a></li>
<li><a href="../pt463005/index.html">Seguran√ßa ASMR</a></li>
<li><a href="../pt463009/index.html">Evolu√ß√£o de vendas na empresa N</a></li>
<li><a href="../pt463011/index.html">N√£o jogue fora a ac√∫stica antiga Nova vida da ac√∫stica antiga</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>