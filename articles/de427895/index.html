<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèº üéµ üê¢ Entfernen von Daten aus einer Shardable-Datenbank üïì üåÑ ‚èπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ein Artikel zur L√∂sung des Problems der Optimierung des L√∂schvorgangs von Dateien aus einem Sharded-System. Es geht um ein Projekt zum Teilen und Arbe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Entfernen von Daten aus einer Shardable-Datenbank</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427895/"> Ein Artikel zur L√∂sung des Problems der Optimierung des L√∂schvorgangs von Dateien aus einem Sharded-System.  Es geht um ein Projekt zum Teilen und Arbeiten mit Dateien.  Das System war vor ungef√§hr 8 Jahren ein Startup, dann wurde es erfolgreich gedreht und mehrmals verkauft.  Das Projekt hat 4 Entwickler, die von Anfang an mit dem Projekt besch√§ftigt sind, was sehr wertvoll ist.  Die Dokumentation hatte traditionell entweder keine Zeit zum Schreiben oder ist nicht sehr relevant. <br><br>  Warum w√ºrdest du das lesen und warum habe ich das alles geschrieben?  Ich m√∂chte √ºber einen Rechen sprechen, der sorgf√§ltig im System liegt und so schl√§gt, dass die Sterne aus den Augen austreten. <br><br>  Ich m√∂chte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Hanna_Hlushakova</a> ein gro√ües Dankesch√∂n f√ºr die Zusammenarbeit sagen, das Projekt zum Ende bringen und bei der Vorbereitung des Artikels helfen.  Grunds√§tzlich finden Sie Beschreibungen des Problems und des von uns verwendeten Algorithmus zur L√∂sung. Es gibt keine Beispiele f√ºr Code, Datenstrukturen oder andere notwendige Dinge.  Ich wei√ü nicht, ob meine Erfahrung Ihnen hilft, einen Rechen zu Hause zu vermeiden, aber ich hoffe, Sie bekommen etwas N√ºtzliches.  Vielleicht ist dieser Artikel ein absolut unwiderruflicher Verlust an wertvoller Zeit. <br><br><img src="https://habrastorage.org/webt/lb/p2/s5/lbp2s5dnlsusssfxqfd3zf9aoyk.png"><br><a name="habracut"></a><br><h3>  √úber das Projekt </h3><br>  Das Projekt ist eines der f√ºhrenden Unternehmen auf dem Gartner-Platz, hat Kundenunternehmen mit mehr als 300.000 Mitarbeitern in den USA und in Europa und mehrere Milliarden Dateien f√ºr die Wartung. <br><br>  Die folgenden Technologien werden im Projekt verwendet: Microsoft, C # .net-Server, MS SQL-Datenbank, 14 aktive Server + 14 im Datenspiegelungsmodus. <br><br>  Das Datenvolumen betr√§gt bis zu 4 TB, die konstante Auslastung in Gesch√§ftszeiten betr√§gt ca. 400.000 Anfragen pro Minute. <br><br>  Die Datenbank enth√§lt viele Gesch√§ftslogiken: <br>  450 Tische <br>  1000 gespeicherte Prozeduren <br>  80.000 Zeilen SQL-Code <br>  Traditionell hatten sie entweder keine Zeit, die Dokumentation zu schreiben, oder sie ist nicht relevant. <br><br><h3>  √úber die Aufgabe </h3><br>  Die Aufgabe besteht darin, das L√∂schen von Dateien aus dem Speicher zu wiederholen, die bereits von Clients gel√∂scht wurden, und die Speicherdauer gel√∂schter Dateien ist abgelaufen, falls sie wiederhergestellt werden sollen.  In der aktuellen Version wurden nach den Berechnungen des Unternehmens selbst die vor einem Jahr gel√∂schten Dateien auf den Servern gespeichert, obwohl sie laut Gesch√§ftsbedingungen nur einen Monat h√§tten gespeichert werden m√ºssen.  Da einige der Dateien in S3 gespeichert sind, hat das Unternehmen f√ºr die zus√§tzlichen Daten bezahlt, und Kunden, die den On-Premises-Speicher verwendet haben, haben sich gefragt, warum die Dateien mehr Speicherplatz beanspruchen als sie sollten. <br><br>  Datenbanken Shardovany f√ºr den Firmenkunden. <br><br><h3>  Wie hat das Entfernen fr√ºher funktioniert? </h3><br><br><img src="https://habrastorage.org/webt/wy/zx/dq/wyzxdqqakclb2u1kjmtbzl3v39y.png"><br><br>  Auf einem globalen Server mit Informationen zu allen Dateien im System wurden Bereiche von 15.000 Dateikennungen gebildet. <br><br>  Anschlie√üend wurde gem√§√ü dem Zeitplan eine Serverumfrage f√ºr eine Reihe von Dateikennungen gestartet. <br>  Die Grenzen des Bereichs wurden auf jeden Splitter √ºbertragen. <br><br>  Shard hat als Antwort gefundene Dateien aus dem Bereich gesendet. <br><br>  Der Hauptserver f√ºgte die fehlenden Dateien der Warteschlangentabelle zum L√∂schen in seiner Datenbank hinzu. <br>  Anschlie√üend erhielt der Dienst zum L√∂schen physischer Dateien aus der Warteschlangentabelle eine Reihe von Kennungen zum L√∂schen. Anschlie√üend wurde eine Best√§tigung gesendet, dass die Dateien gel√∂scht werden sollen, und f√ºr alle Shards wurde gepr√ºft, ob diese Dateien dort verwendet wurden. <br>  Mit zunehmender Anzahl von Dateien begann dieser Ansatz sehr langsam zu funktionieren, da es mehrere Milliarden Dateien gab und die Anzahl der Bereiche signifikant zunahm.  Gel√∂schte Dateien blieben immer noch weniger als 5% im Vergleich zur Gesamtzahl. Es ist sehr ineffizient, Milliarden von Dateien zu sortieren, um mehrere Millionen gel√∂schter Dateien zu finden. <br><br>  Wenn ein Benutzer eine Datei l√∂scht, sollte sie beispielsweise 1 Monat lang gespeichert werden, falls sie wiederhergestellt werden muss.  Nach diesem Zeitraum sollte die Datei vom Programm aus dem Repository gel√∂scht werden.  Bei der aktuellen Anzahl von Dateien, der Anzahl von Bereichen und der Geschwindigkeit der Bereichsumgehung w√ºrde es 1 Jahr dauern, bis der Server alle Bereiche vollst√§ndig umgeht. <br>  Es ist klar, dass der Ort nicht freigegeben wurde, und dies f√ºhrte zu Unzufriedenheit der Benutzer, da ihre Server viel mehr Dateien gespeichert haben, als gemeldet werden sollten.  Das Dienstleistungsunternehmen selbst bezahlte einen zus√§tzlichen Platz auf S3, was f√ºr ihn ein direkter Verlust war. <br><br>  Nur auf S3 wurden zu Beginn der Arbeit 2 Petabyte gel√∂schter Dateien gespeichert, und dies ist nur in der Cloud.  Dar√ºber hinaus gab es Clients, deren Dateien auf ihren dedizierten Servern gespeichert waren, die das gleiche Problem hatten: Der Speicherplatz des Servers wurde von Dateien belegt, die von Benutzern gel√∂scht, aber nicht vom Server gel√∂scht wurden. <br><br><h3>  Was hast du beschlossen zu tun? </h3><br>  Wir haben uns entschlossen, die Entfernungsereignisse zu verfolgen: <br><br><ul><li>  Der Client hat die Datei gel√∂scht und ist dann abgelaufen. </li><li>  Der Benutzer hat die Datei sofort ohne die M√∂glichkeit einer Wiederherstellung gel√∂scht. </li></ul><br>  Beim L√∂schen einer Datei aus einer Sharded-Datenbank haben wir uns f√ºr einen optimistischen Ansatz entschieden und eine der √úberpr√ºfungen zur Verwendung entfernt.  Wir wussten, dass 99% der Dateien nur innerhalb eines Shards verwendet werden.  Wir haben uns entschlossen, die Datei sofort zur L√∂schwarteschlange hinzuzuf√ºgen und den Rest der Shards nicht auf die Verwendung dieser Datei zu √ºberpr√ºfen, da die √úberpr√ºfung erneut durchgef√ºhrt wird, wenn das L√∂schen aus dem Speicher den Dienst best√§tigt. <br><br>  Au√üerdem haben sie den aktuellen Job verlassen, der gel√∂schte Dateien nach Bereichen √ºberpr√ºft hat, um Dateien hinzuzuf√ºgen, die vor der Ver√∂ffentlichung der neuen Version gel√∂scht wurden. <br><br>  Alles, was auf dem Shard gel√∂scht wurde, wird in einer Tabelle gesammelt und dann mit Informationen zu allen Dateien auf einen einzelnen Server √ºbertragen. <br><br>  Auf diesem Server wird es an die L√∂schwarteschlangentabelle gesendet. <br><br>  In der Tabelle zum L√∂schen vor dem L√∂schen wird √ºberpr√ºft, ob die Datei nicht f√ºr alle Shards verwendet wird.  Dieser Teil der √úberpr√ºfung war vor der Code√§nderung hier und sie beschlossen, ihn nicht zu ber√ºhren. <br><br><h4>  Was mussten Sie im Code √§ndern? </h4><br>  Auf jedem der Shards wurde eine Tabelle hinzugef√ºgt, in die die Kennung der gel√∂schten Datei geschrieben werden soll. <br><br>  Wir haben alle Verfahren zum L√∂schen von Dateien aus der Datenbank gefunden, es gab nur 2. Nachdem der Benutzer die Datei gel√∂scht hat, liegt die Datei noch einige Zeit in der Datenbank. <br><br>  Beim L√∂schen einer Datei aus der Datenbank haben wir dieser lokalen Tabelle einen Eintrag mit gel√∂schten Dateien hinzugef√ºgt. <br><br>  Auf dem globalen Server mit Dateien haben sie einen Job erstellt, der eine Liste von Dateien aus Shard-Datenbanken herunterl√§dt.  Wenn Sie nur eine Prozedur aus einer Shardable-Datenbank aufrufen, wird eine DELETE-Datei erstellt und eine Liste der Dateien in OUTPUT angezeigt.  In MS SQL Server ist das Ziehen von einem Remoteserver viel schneller als das Einf√ºgen in einen Remoteserver.  All dies geschieht in Bl√∂cken. <br>  Diese Dateien werden dann zur L√∂schwarteschlangentabelle auf dem globalen Server hinzugef√ºgt. <br>  Der Warteschlangentabelle wurde eine Tabelle mit einer Shard-ID hinzugef√ºgt, um festzustellen, woher das L√∂schereignis stammt. <br><br><h3>  Wie hat es jeder getestet? </h3><br>  Es gibt 3 Umgebungen: <br><br>  Dev ist eine Entwicklungsumgebung.  Der Code stammt aus dem Entwicklungszweig des Gith.  Es ist m√∂glich, eine andere Version des Codes auf IIS bereitzustellen und mehrere Orchestrierungsversionen zu erstellen.  Es wird vom Client in VPN eine Verbindung zur Entwicklungsumgebung hergestellt.  Bis vor kurzem bestand die Unannehmlichkeit nur bei Datenbanken, da alle √Ñnderungen an der Datenbank die Arbeit anderer Teile des Systems beeintr√§chtigen k√∂nnen.  Dann wurden die Basen lokal gemacht.  Bereits laufender Code kann auf Entwickler-Server mit Datenbanken √ºbertragen werden, um nicht die Arbeit aller zu ruinieren.  In einer Entwicklungsumgebung befinden sich 3 statt 12 Shards auf dem Produkt. Dies reicht jedoch normalerweise aus, um die Interaktion zu testen. <br><br>  Staging - Die Umgebung ist mit dem Produkt entsprechend der Version des Codes identisch (fast das gleiche, wie es selten vorkommt, aber die Administratoren √§ndern das Produkt direkt auf dem Produkt).  Eine Kopie des Codes aus dem Hauptzweig.  Manchmal wurden einige Unterschiede zum Code auf dem Produkt in der Datenbank festgestellt, aber im Allgemeinen sind sie identisch.  Es gibt auch 3 Scherben auf der Inszenierung sowie auf der Jungfrau.  Sowohl die Inszenierung als auch die Entwicklung sind nicht belastet.  Hier k√∂nnen Sie Integrationstests bereits vollst√§ndig ausf√ºhren, da der Code mit dem Produkt √ºbereinstimmt.  Alle Tests m√ºssen bestanden sein. Dies ist eine Voraussetzung, bevor Sie zur Bereitstellung gehen. <br><br>  Perf Lab, wo Tests unter Last durchgef√ºhrt werden.  Die Last wird mit einem Jmeter erzeugt, zehnmal weniger als auf dem Produkt, und es gibt nur einen Splitter, was manchmal zu Unannehmlichkeiten f√ºhrt.  Verkaufsdaten werden erfasst, anonymisiert und im Perf Lab verwendet.  Alle Server haben die gleiche Konfiguration wie auf prod. <br><br>  Die Last ist 10-mal geringer, da angenommen wird, dass dies eine ungef√§hre Last ist, die f√ºr 1 Scherbe zum Sto√ü kommt.  Der Nachteil ist, dass die globale Basis im Gegensatz zum Verkauf sehr wenig ausgelastet ist.  Und wenn die √Ñnderungen haupts√§chlich die globale Datenbank mit Dateien betreffen, k√∂nnen Sie sich nur ann√§hernd auf die Testergebnisse verlassen - auf dem Produkt funktioniert dies m√∂glicherweise nicht so.  Obwohl perf lab die Last nicht ideal auf das Produkt abstimmt, hilft die M√∂glichkeit, unter der Last zu testen, bereits dabei, viele Fehler zu erkennen, bevor sie auf dem Produkt bereitgestellt werden. <br><br>  Es gibt auch einen Sicherungsserver, auf dem Sie die Daten aus dem Verkauf anzeigen k√∂nnen, um einige F√§lle abzufangen.  Im Allgemeinen arbeitet das Unternehmen unter einer Lizenz, die Entwicklern den Zugriff auf Verkaufsdaten und dem Zugriff des Verwaltungs- und Supportteams (Operations) auf die Entwicklung untersagt. Sie m√ºssen daher die Datenbankadministratoren um Hilfe bitten.  Verkaufsdaten machen das Testen sehr einfach, da einige F√§lle nur bei Produktdaten auftreten und es sehr n√ºtzlich ist, die Daten in einem realen System zu untersuchen, um zu verstehen, wie das System f√ºr den Benutzer funktioniert. <br><br>  Bei Tests im Perf Lab stellte sich heraus, dass das Laden von Dateien aus dem Speicher √ºberhaupt nicht durch das Wort realisiert wurde.  Bei der Implementierung von Lasttests haben wir h√§ufigere Anforderungen von Client-Software ausgew√§hlt, von denen einige nicht in die Bereinigung des Speichers einbezogen wurden.  Da es sich um eine Datenbank handelt, wurde ein vereinfachter Test f√ºr alle ge√§nderten Objekte durchgef√ºhrt, wobei die ge√§nderten Prozeduren manuell f√ºr verschiedene Daten aufgerufen wurden.  (√ºber die Optionen, die ich kannte). <br>  Dar√ºber hinaus wurde bei Integrations- und Perfektionstests der Schwerpunkt auf die beliebteste Art der Dateispeicherung gelegt. <br><br>  Ein zus√§tzliches Merkmal des Perf-Labors, das nicht sofort herausgefunden wurde, ist die Nicht√ºbereinstimmung der Datenmenge in einigen Tabellen zu Produkt und Perf.  In dem Sinne, dass alle Verkaufsjobs an der Perf arbeiten, die Daten generieren, aber es gibt nicht immer etwas, das die in der Tabelle generierten Daten verarbeitet.  Und zum Beispiel ist die oben erw√§hnte Tabellenwarteschlange zum L√∂schen auf dem Perf viel gr√∂√üer als auf dem Produkt - 20 Millionen Datens√§tze auf dem Perf und 200.000 Datens√§tze auf dem Produkt. <br><br><h4>  Bereitstellungsprozess </h4><br>  Der Bereitstellungsprozess ist ziemlich Standard.  Es gab keine √Ñnderungen im Anwendungscode f√ºr diese Aufgabe, alle √Ñnderungen sind nur in der Datenbank.  Ein DBA wird immer in die Datenbank gerollt, dieser Prozess ist nicht automatisiert.  Es werden 2 Versionen von Skripten vorbereitet - zum Anwenden von √Ñnderungen und zum Zur√ºcksetzen von √Ñnderungen, und eine Anweisung f√ºr DBA wird geschrieben.  Es werden immer 2 Versionen von Skripten erstellt, die notwendigerweise auf Rollback und Rollback von √Ñnderungen getestet werden.  Dieselben Skripte werden verwendet, um √Ñnderungen an Staging und Perf Lab vorzunehmen, bevor die Integration und die Lasttests gestartet werden. <br><br><h3>  Was ist nach dem Einsatz passiert? </h3><br>  In den ersten 5 Stunden nach der Bereitstellung kam es zu 1 Million Ereignissen, bei denen die Client-Software beim Versuch, die Datei herunterzuladen, einen Fehler erhielt.  Das Ereignis "Datei besch√§digt".  Dies bedeutet, dass der Client versucht, die Datei herunterzuladen, die Datei jedoch nicht im Repository gefunden wurde.  Normalerweise sind diese Ereignisse entweder gar nicht oder sie werden mit 1 - 2 Tausend pro Tag gemessen. <br><br>  Ich muss sofort sagen, dass es mindestens 1 Woche gedauert hat, um die Ursache des Fehlers in einem Team von 3 und manchmal 5 Personen (einschlie√ülich mir) zu finden. <br><br>  Wir haben die gesamte Liste der Dateien gesammelt, f√ºr die das Ereignis "Datei besch√§digt" aufgetreten ist. <br><br>  Trotz der Tatsache, dass es mehr als 1 Million Ereignisse gab und alle von verschiedenen Benutzern und Unternehmen stammten, enthielt diese Liste nur 250 eindeutige Dateien. <br><br>  Der DBA auf dem Sicherungsserver wurde ausgel√∂st, um Datenbanksicherungen zum Zeitpunkt des Eintreffens der Ereignisse zu untersuchen.  In den Projektbasen gibt es einige Tabellen mit allen Arten von Protokollen, die bei der Analyse hilfreich waren.  Selbst wenn Informationen aus der Datenbank gel√∂scht werden, wird ein Protokoll zu dem hinzugef√ºgt, was gel√∂scht wurde und von welchem ‚Äã‚ÄãEreignis.  Auf dem Produkt werden solche Datens√§tze 1 Woche lang gespeichert und dann auf dem Archivserver zusammengef√ºhrt. <br><br>  Und ebenso die Tabellen mit Protokollen, die bei der Analyse der Ereignisse sehr hilfreich waren: <br>  Auf jedem Shard wird ein vollst√§ndiges Protokoll mit Clientereignissen gef√ºhrt <br><br>  Auf dem globalen Server: <br><br><ul><li>  Protokoll der Anforderungen zum Herunterladen aller Dateien durch Benutzer </li><li>  Protokollieren Sie das Hochladen von Dateien von Benutzern auf das System </li><li>  FileCorrupt-Ereignisprotokoll </li><li>  Protokolldatei, um das L√∂schen aus dem Speicher abzubrechen </li><li>  Protokoll der gel√∂schten Dateien aus der Datenbank </li></ul><br>  Zus√§tzlich war ein ELK mit Anwendungsprotokollen verf√ºgbar. <br><br>  Wir haben es geschafft, den Fehler in der Entwicklungsumgebung zu wiederholen, was die Richtigkeit der Annahme best√§tigte.  Anfangs nahm niemand diese Hypothese ernst, da es sehr schwer zu glauben war, dass so viele Faktoren gleichzeitig zusammenfielen und so viele Benutzer zu dieser bestimmten Zeit kamen. <br><br><h3>  Was ist schief gelaufen? </h3><br>  Es stellte sich heraus, dass das System ungef√§hr 250 (zum Vergleich Milliarden von Dateien im System) Super-Duper-Mega-Dateien hatte.  250 ja! <br><br>  Diese Dateien waren noch sehr alt.  Zum Zeitpunkt des Hochladens dieser Dateien auf das System wurde ein anderes System zum Generieren des Dateischl√ºssels f√ºr den Speicher verwendet. <br><br>  Es stellte sich heraus, dass sich die Methode zum physischen Entfernen aus dem physischen Speicher f√ºr diesen Schl√ºsseltyp anders verh√§lt als f√ºr andere Dateien. <br><br>  In der Klasse mit L√∂schung gibt es einen Codeblock mit einer Bedingung speziell f√ºr Dateien mit dem alten Schl√ºssel.  Das System verschiebt diese alte Datei zum Zeitpunkt des L√∂schens an einen anderen Speicherort, bevor √ºberpr√ºft wird, ob sich die Datei nicht auf Shards befindet.  Nun, das hat nicht geklappt. <br><br>  Und es stellte sich heraus, dass in dem Moment, in dem die Datei verschoben wurde (und ich werde daran erinnern, dass sie sehr beliebt ist), wenn einer der Benutzer versucht, ihm neue Benutzerrechte zu erteilen, die Client-Software in den Speicher f√ºr diese Datei wechselt, die Datei jedoch nicht am richtigen Ort ist.  Da es verschoben wird, klappt das also nicht.  Und die Client-Software sendet eine Nachricht, dass die Datei besch√§digt ist.  In der Datenbank wird es als defekt markiert.  Und alle Informationen werden aus der Datenbank gel√∂scht (fast alle). <br><br>  In der Zwischenzeit stellt unsere Shard-Check-Routine fest, dass die Datei verwendet wird.  Und sendet eine Antwort, die Sie zur√ºckgeben m√ºssen.  Alle Informationen wurden jedoch bereits aus der Datenbank gel√∂scht, und es ist unm√∂glich, sie zur√ºckzugeben. <br><br>  Lustig, oder? <br><br>  Das hei√üt, als die Datei gel√∂scht wurde, befand sich der Benutzer in dem Zeitraum, in dem die Datei verschoben, die Shards √ºberpr√ºft wurden, und zu diesem Zeitpunkt schickte der Benutzer eine Anforderung zum Herunterladen. <br><br>  Hier ist es - Highload in Aktion, wenn die unglaublichsten Spiele, die Sie treffen. <br><br><img src="https://habrastorage.org/webt/_y/m6/me/_ym6meu2s43ds32d1ngjzspn67k.png"><br><br>  Nachdem wir uns von der √úberraschung erholt und alles zur√ºckgesetzt hatten, stellten wir sicher, dass die Dateien der Benutzer lebendig sind, da sie von den Festplatten anderer Clients wiederhergestellt wurden. <br><br>  Bei den Tests war nat√ºrlich alles in Ordnung, da w√§hrend des Tests neuere Dateien mit einem neuen Schl√ºsseltyp gel√∂scht wurden, der in den letzten 5 Jahren verwendet wurde. Solche Dateien werden zum Zeitpunkt des L√∂schens nicht an einen anderen Speicherort √ºbertragen. <br><br>  Unser Optimismus lie√ü nach und wir beschlossen, nicht den optimistischsten Weg zu gehen. <br><br><h3>  R√ºckblick </h3><br>  Wir haben beschlossen, dass wir Tests f√ºr verschiedene Arten von Speichern hinzuf√ºgen m√ºssen <br>  F√ºgen Sie perf lab eine Last hinzu, die Anrufe verwendet, wenn sie aus dem Speicher entfernt werden <br>  Schlie√üen Sie ber√ºhmte Rennbedingungen <br>  √úberwachung hinzuf√ºgen (obwohl dies in den Pl√§nen vorgesehen w√§re, aber nicht in den urspr√ºnglichen Umfang passt) <br><br><h3>  √úber die √úberwachung </h3><br>  Sie beschlossen, sofort zu √ºberwachen, aber dann trat er in den Hintergrund, da eine schnellere Bereitstellung erforderlich war. <br><br>  F√ºr die √úberwachung verwendete das Projekt Zabbix, ELK, Grafana, NewRelic, SQL Sentry und eine Testversion von AppDynamics. <br><br>  Davon befanden sich auf pef lab NewRelic und SQL Sentry. <br><br>  Wir haben bereits alle Systemmetriken gemessen und wollten daher Gesch√§ftsmetriken messen.  Ich hatte Erfahrung mit der Organisation einer solchen √úberwachung durch Zabbix - wir haben uns dazu entschlossen, dasselbe zu tun. <br><br>  Das Schema ist in der Datenbank sehr einfach, um eine Tabelle zu erstellen, in die die erforderlichen Metriken per Job erfasst werden k√∂nnen, und eine Prozedur, mit der die gesammelten Metriken nach Zabbix hochgeladen werden. <br><br>  Metriken: <br><br><ul><li>  Die Anzahl der Dateien in der Warteschlange, die global gel√∂scht werden sollen </li><li>  Anzahl der vom Server in die Warteschlange gestellten Dateien </li><li>  Die Anzahl der Dateien, die vom Repository an das Deinstallationsprogramm gesendet wurden </li><li>  Anzahl der gel√∂schten Dateien </li><li>  Anzahl der FileCorrupt-Ereignisse </li><li>  Die Anzahl der Dateien, die auf jedem Shard gel√∂scht werden sollen </li></ul><br>  Die √úberwachung wurde separat implementiert und auf dem Produkt bereitgestellt, bevor mit der Bereitstellung einer neuen Implementierung des L√∂schvorgangs begonnen wurde. <br><br><h3>  Neue L√∂sung </h3><br>  Im Allgemeinen entschieden wir, dass es besser ist, zu viel zu essen als nicht zu schlafen, und machten einen neuen Plan. <br><br><ol><li>  √úberpr√ºfen Sie auf demselben Shard, dass niemand die Datei mehr sicher verwendet, und √ºbertragen Sie nur nicht verwendete Dateien auf den Server. </li><li>  Sammeln Sie beim √úbertragen auf den Server alle Dateien in der Tabelle und stellen Sie sicher, dass die Dateien nicht f√ºr Shards verwendet werden, bevor Sie sie in die Warteschlangentabelle der Warteschlange stellen. </li><li>  Wenn Sie eine Datei verwenden und im System danach suchen, markieren Sie die Warteschlange in der Tabelle als eine Datei, die √ºberpr√ºft werden muss. </li><li>  Geben Sie nur Dateien zur√ºck, f√ºr die keine Suche durchgef√ºhrt wurde. </li><li>  Dateien, die durchsucht wurden, erneut auf Scherben pr√ºfen; </li><li>  Entfernen Sie im Allgemeinen die Pr√ºfung in der Prozedur, mit der die Datei gel√∂scht wird, da sie schnell funktionieren sollte - und die verwendete Datei sie im Prinzip nicht erreichen sollte. </li><li>  Ber√ºcksichtigen Sie bei der Prozedur, dass alles durch die geschlagene Datei gel√∂scht wird, die gerade gel√∂scht wird, und l√∂schen Sie keine Informationen dar√ºber. </li></ol><br>  Punkt 6 w√§hrend des Einsatzes beinhaltete das Entfernen des Schecks in mehreren Schritten.  Zuerst lie√üen sie den Scheck, dann eine Woche sp√§ter wurde der Scheck in den Akten der Mitarbeiter des Unternehmens deaktiviert, nach 2 Wochen schalteten sie den Scheck √ºberhaupt aus. <br><br><h3>  Was mussten Sie im Code √§ndern? </h3><br>  Auch hier gelten alle √Ñnderungen nur f√ºr die Datenbank. <br><br>  Das Ausma√ü der √Ñnderungen war auf dem globalen Server am gr√∂√üten: <br>  F√ºgen Sie eine Zwischentabelle hinzu, in die alle von Shards heruntergeladenen Dateien eingef√ºgt werden sollen. <br>  Erstellen Sie einen Job, der die Dateien in der Zwischentabelle √ºberpr√ºft, dass sie nicht f√ºr Shards verwendet werden. <br><br>  F√ºgen Sie in der Warteschlange der gel√∂schten Dateien ein Feld mit dem Datum hinzu, an dem zuletzt auf die Datei zugegriffen wurde, und f√ºgen Sie einen Index hinzu. <br><br>  Finden Sie alle Prozeduren mit Zugriff auf die Datei - es stellte sich heraus, 5 Prozeduren.  F√ºgen Sie ihnen einen Block hinzu, der das Datum der letzten Verwendung in der Warteschlangentabelle √§ndert.  Das Datum √§ndert sich jedes Mal, unabh√§ngig davon, ob es gef√ºllt wurde oder nicht. <br><br>  F√ºgen Sie das L√∂schprogramm zu den Verfahren zur Ausgabe von Dateien hinzu, sodass nur Dateien mit einem leeren Verwendungsdatum angezeigt werden. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºgen Sie einen Job hinzu, der alle Dateien mit dem Verwendungsdatum sammelt und pr√ºft (mit einer Verz√∂gerung von 10 Minuten, die erforderlich ist, damit die Client-Software die Datei zum Shard hinzuf√ºgen kann, dauert es im Allgemeinen bis zu 2 Minuten, entscheidet sich jedoch, auf Nummer sicher zu gehen). Verwenden Sie die Datei f√ºr alle Shards. Nach Abschluss der Pr√ºfung wird das Verwendungsdatum auf Null zur√ºckgesetzt, wenn die Datei nicht gefunden wird. Andernfalls wird die Datei aus der Warteschlange gel√∂scht. Wenn sich das Verwendungsdatum w√§hrend des √úberpr√ºfungsprozesses ge√§ndert hat, √§ndern sich die Daten nicht, da davon ausgegangen wird, dass die Datei w√§hrend der √úberpr√ºfung auf den Shard hochgeladen werden konnte, auf dem die √úberpr√ºfung bereits abgeschlossen war und ein neuer √úberpr√ºfungszyklus f√ºr die Datei erforderlich war. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auf Scherben:</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bei der Prozedur, bei der Dateien mit gel√∂schten Dateien aus der Tabelle gel√∂scht werden, musste √ºberpr√ºft werden, ob die Datei nicht verwendet wurde. </font><font style="vertical-align: inherit;">Das Verfahren hat seine Einfachheit und Sch√∂nheit nicht sehr verloren - in DELETE mit Ausgabe haben sie einfach NOT EXISTS hinzugef√ºgt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben einen JOB hinzugef√ºgt, der im Hintergrund von den auf dem Server verwendeten Tabellendateien abweicht.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tests </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Den Integrationstests wurden Szenarien zur Verwendung aller Speicheroptionen hinzugef√ºgt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie haben auch neue F√§lle geschrieben, um neue Funktionen zum Entfernen von Dateien zu testen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perf Lab hat dem globalen Server eine zus√§tzliche Last hinzugef√ºgt. </font><font style="vertical-align: inherit;">Zus√§tzlich haben wir eine Last hinzugef√ºgt, die dem L√∂schen von Dateien aus dem Speicher entspricht.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bereitstellen </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skripte wurden f√ºr die Anwendung und das Rollback von √Ñnderungen f√ºr die Datenbank vorbereitet. DBA rollte Skripte und es stellte sich heraus, dass sie beim Auslastungstest die Sperren von Warteschlangentabellen zum L√∂schen von Dateien nicht beachteten. Infolgedessen haben wir den Index nicht festgelegt, was nicht der optimalste war. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aus diesem Grund war es erforderlich, die JOB-Pr√ºfungen nach Bereichen zu deaktivieren und Kennungen gel√∂schter Dateien manuell nach Dateien zu analysieren und hinzuzuf√ºgen, die vor der Bereitstellung des neuen Codes im System gel√∂scht wurden.</font></font><br><br><h3>  Ergebnisse </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infolgedessen werden aufgrund der Bereitstellung neue gel√∂schte Dateien innerhalb von 24 Stunden aus dem Speicher gel√∂scht. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dateien, die vor dem Start des neuen Systems gel√∂scht wurden, wurden bei der Sicherung erstellt und der Warteschlange f√ºr Produkte hinzugef√ºgt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infolgedessen wurden √ºbersch√ºssige Daten zu S3 in H√∂he von 2 Petabyte gel√∂scht. </font><font style="vertical-align: inherit;">Dasselbe geschah mit Dateien auf dedizierten Client-Servern, und jetzt stimmt ihr Platz auf dem Server mit dem Platz √ºberein, der auf ihren Clients angezeigt wird. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der gekr√ºmmte Index in der Warteschlangentabelle lebt immer noch von prod, der Aufgabe, den Index im Backlog zu √§ndern, wird jedoch aufgrund von Aufgaben mit h√∂herer Priorit√§t leicht verschoben.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de427895/">https://habr.com/ru/post/de427895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de427879/index.html">Wie ich von Python zu Julia gewechselt bin (und warum)</a></li>
<li><a href="../de427883/index.html">Einf√ºhrung in Virtualisierung, Container und Kubernetes: 18 Cloud-Ressourcen</a></li>
<li><a href="../de427889/index.html">Falsch, falsch, falsch! Methoden zur DDoS-Minderung</a></li>
<li><a href="../de427891/index.html">Millionen von Menschen k√∂nnen durch Sicherheitsl√ºcken in der Cisco WebEx Conference Platform angegriffen werden</a></li>
<li><a href="../de427893/index.html">Bloody Lola auf Omega 2 oder Python an Halloween w√ºrgen</a></li>
<li><a href="../de427897/index.html">Analyse eines Magnetresonanztomographen II: Metamaterialien in der MRT</a></li>
<li><a href="../de427899/index.html">JsonWriterSax - eine Bibliothek zum Erstellen von JSON</a></li>
<li><a href="../de427901/index.html">So verwenden Sie die Node.js Stream-API nicht</a></li>
<li><a href="../de427905/index.html">Food Mining oder Crossroads mit den Augen eines Hackers</a></li>
<li><a href="../de427907/index.html">Drohnenschie√üen, Rechen, Life Hacks, Selbstentwicklung und Karriere eines Fotografen / Videografen: neuer GLPH-Podcast</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>