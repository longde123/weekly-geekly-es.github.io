<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧛🏾 🚍 👩🏾‍🚀 Implémentation de type entier dans CPython 👃🏿 🐦 🍕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y avait déjà des articles sur Habré sur les détails d'implémentation du gestionnaire de mémoire de CPython, Pandas , j'ai écrit un article sur l' i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implémentation de type entier dans CPython</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455114/"> Il y avait déjà des articles sur Habré sur les détails d'implémentation du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gestionnaire de mémoire</a> de CPython, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pandas</a> , j'ai écrit un article sur l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">implémentation du dictionnaire</a> . <br><br>  Il semblerait que vous pouvez écrire sur un type entier régulier?  Cependant, tout n'est pas si simple et le type entier n'est pas si évident. <br><br>  Si vous vous demandez pourquoi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">x * 2 est plus rapide que x &lt;&lt; 1</a> . <br><br>  Et comment lancer l'astuce suivante: <br><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-number"><span class="hljs-number">42</span></span> == <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> + <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  Alors vous devriez lire cet article. <br><a name="habracut"></a><br>  Il n'y a pas de types primitifs en python - toutes les variables sont des objets et sont allouées dans la mémoire dynamique.  Dans le même temps, les entiers sont représentés par un seul type (nous ne considérons pas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">décimal</a> ) - PyLongObject.  L'implémentation et les déclarations se trouvent dans les fichiers longobject.h, longintrepr.h et longobject.c. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">longobject</span></span></span><span class="hljs-class"> {</span></span> PyObject_VAR_HEAD <span class="hljs-comment"><span class="hljs-comment">//       digit ob_digit[1]; //   };</span></span></code> </pre><br>  Dans tout objet dans CPython, il y a deux champs: ob_refcnt - compteur de références à l'objet et ob_type - pointeur vers le type de l'objet; pour les objets qui peuvent changer leur longueur, le champ ob_size est ajouté - la taille allouée actuelle (utilisée peut être inférieure). <br><br>  Ainsi, un type entier est représenté par un tableau de longueur variable à partir de chiffres séparés, donc python prêt à l'emploi prend en charge l'arithmétique longue, dans la deuxième version du langage il y avait un type distinct d'entiers «ordinaires». Les entiers «longs» ont été créés en utilisant la lettre L ou, si le résultat des opérations a provoqué un débordement par des ordinaires, dans la troisième version il a été décidé de le refuser. <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># python2 num1 = 42 print num1, type(num1) # 42 &lt;type 'int'&gt; num2 = 42L print num2, type(num2) # 42 &lt;type 'long'&gt; num3 = 2 ** 100 print num3, type(num3) # 1267650600228229401496703205376 &lt;type 'long'&gt;</span></span></code> </pre><br>  La valeur entière stockée par la structure _longobject est égale à: <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>u</mi><msubsup><mi>m</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>a</mi><mi>b</mi><mi>s</mi><mo stretchy=&quot;false&quot;>(</mo><mi>o</mi><mi>b</mi><msub><mtext>&amp;#xA0;</mtext><mi>s</mi></msub><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy=&quot;false&quot;>)</mo><mo>&amp;#x2212;</mo><mn>1</mn></mrow></msubsup><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>o</mi><mi>b</mi><msub><mtext>&amp;#xA0;</mtext><mi>d</mi></msub><mi>i</mi><mi>g</mi><mi>i</mi><msub><mi>t</mi><mi>i</mi></msub><mo>&amp;#x2217;</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>S</mi><mi>H</mi><mi>I</mi><mi>F</mi><mi>T</mi><mo>&amp;#x2217;</mo><mi>i</mi></mrow></msup></mrow></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="34.768ex" height="3.624ex" viewBox="0 -1143.2 14969.4 1560.2" role="img" focusable="false" style="vertical-align: -0.969ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-73" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-75" x="719" y="0"></use><g transform="translate(1292,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-6D" x="0" y="0"></use><g transform="translate(878,521)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-62" x="529" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-73" x="959" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-28" x="1428" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-6F" x="1818" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-62" x="2303" y="0"></use><g transform="translate(1932,0)"><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-73" x="499" y="-213"></use></g><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-69" x="3518" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-7A" x="3864" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-65" x="4332" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-29" x="4799" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-2212" x="5188" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-31" x="5967" y="0"></use></g><g transform="translate(878,-308)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-69" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-3D" x="345" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-30" x="1124" y="0"></use></g></g><g transform="translate(6843,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-6F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-62" x="485" y="0"></use><g transform="translate(915,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-64" x="353" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-69" x="1635" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-67" x="1980" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-69" x="2461" y="0"></use><g transform="translate(2806,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-69" x="511" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-2217" x="3734" y="0"></use><g transform="translate(4457,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-53" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-48" x="645" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-49" x="1534" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-46" x="2038" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-54" x="2788" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMAIN-2217" x="3492" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjSei7_THXMOf0rg0P8LF2zm13yXw#MJMATHI-69" x="3993" y="0"></use></g></g></g></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtext>&nbsp;</mtext><mi>s</mi><mi>u</mi><msubsup><mi>m</mi><mrow class="MJX-TeXAtom-ORD"><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mrow class="MJX-TeXAtom-ORD"><mi>a</mi><mi>b</mi><mi>s</mi><mo stretchy="false">(</mo><mi>o</mi><mi>b</mi><msub><mtext>&nbsp;</mtext><mi>s</mi></msub><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo><mo>−</mo><mn>1</mn></mrow></msubsup><mrow class="MJX-TeXAtom-ORD"><mi>o</mi><mi>b</mi><msub><mtext>&nbsp;</mtext><mi>d</mi></msub><mi>i</mi><mi>g</mi><mi>i</mi><msub><mi>t</mi><mi>i</mi></msub><mo>∗</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mi>S</mi><mi>H</mi><mi>I</mi><mi>F</mi><mi>T</mi><mo>∗</mo><mi>i</mi></mrow></msup></mrow></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> \ sum_ {i = 0} ^ {abs (ob \ _size) -1} {ob \ _digit_i * 2 ^ {SHIFT * i}} </script></p><br>  En tant que bit, le type non signé 32 bits (uint32_t) sur les systèmes 64 bits et le type court non signé 16 bits sur les systèmes 32 bits sont utilisés. <br><br>  Les algorithmes utilisés dans l'implémentation imposent des restrictions strictes sur le SHIFT de la formule précédente, en particulier, il doit être divisé par 15, donc maintenant cpython prend en charge deux valeurs: 30 et 15, respectivement, pour les systèmes 64 et 32 ​​bits.  Pour les valeurs négatives, ob_size a une valeur négative, zéro est donné par un nombre pour lequel ob_size = 0. <br><br>  Lors de l'exécution d'opérations arithmétiques, l'interpréteur vérifie la longueur actuelle des opérandes, si les deux se composent d'un seul bit, alors l'arithmétique standard est effectuée. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PyObject * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">long_add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyLongObject *a, PyLongObject *b)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">//   -     if (Py_ABS(Py_SIZE(a)) &lt;= 1 &amp;&amp; Py_ABS(Py_SIZE(b)) &lt;= 1) { //      return PyLong_FromLong(MEDIUM_VALUE(a) + MEDIUM_VALUE(b)); } ... };</span></span></code> </pre><br>  La multiplication a une structure similaire, en plus, l'interpréteur implémente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'algorithme de Karatsuba</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la quadrature rapide</a> , cependant, ils ne sont pas effectués pour chaque "longue multiplication", mais seulement pour des nombres suffisamment grands, le nombre de chiffres dans lequel sont donnés par deux constantes: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//     #define KARATSUBA_CUTOFF 70 //      #define KARATSUBA_SQUARE_CUTOFF (2 * KARATSUBA_CUTOFF)</span></span></code> </pre><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PyObject * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">long_mul</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyLongObject *a, PyLongObject *b)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">//   -     if (Py_ABS(Py_SIZE(a)) &lt;= 1 &amp;&amp; Py_ABS(Py_SIZE(b)) &lt;= 1) { // stwodigits -  ,    // int64_t  64-   long  32-. stwodigits v = (stwodigits)(MEDIUM_VALUE(a)) * MEDIUM_VALUE(b); return PyLong_FromLongLong((long long)v); } ... // ""    O(N^2),     . i = a == b ? KARATSUBA_SQUARE_CUTOFF : KARATSUBA_CUTOFF; if (asize &lt;= i) { if (asize == 0) return (PyLongObject *)PyLong_FromLong(0); else return x_mul(a, b); } ... };</span></span></code> </pre><br>  Cependant, les commandes shift n'ont pas de contrôle pour le cas des entiers "courts", elles sont toujours exécutées pour le cas de l'arithmétique longue.  Par conséquent, la multiplication par 2 est plus rapide que le décalage.  Il est intéressant de noter que la division est plus lente que le décalage à droite, ce qui ne vérifie pas non plus le cas des entiers à un chiffre.  Mais la division est plus compliquée: il existe une méthode qui calcule d'abord le quotient, puis le reste, NULL lui est transmis, si vous devez calculer une chose, c'est-à-dire que la méthode doit également vérifier ce cas, tout cela augmente les frais généraux. <br><br>  La fonction de comparaison n'a pas non plus de cas particulier pour les entiers «courts». <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">long_compare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyLongObject *a, PyLongObject *b)</span></span></span><span class="hljs-function"> </span></span>{ Py_ssize_t sign; <span class="hljs-comment"><span class="hljs-comment">// ,        //        if (Py_SIZE(a) != Py_SIZE(b)) { sign = Py_SIZE(a) - Py_SIZE(b); } else { Py_ssize_t i = Py_ABS(Py_SIZE(a)); //  ""        while (--i &gt;= 0 &amp;&amp; a-&gt;ob_digit[i] == b-&gt;ob_digit[i]) ; if (i &lt; 0) sign = 0; else { sign = (sdigit)a-&gt;ob_digit[i] - (sdigit)b-&gt;ob_digit[i]; if (Py_SIZE(a) &lt; 0) sign = -sign; } } return sign &lt; 0 ? -1 : sign &gt; 0 ? 1 : 0; }</span></span></code> </pre><br><h3>  Tableaux (listes) de nombres </h3><br>  Lors de la création d'une variable de type entier, l'interpréteur doit allouer une zone suffisante dans la mémoire dynamique, puis définir le compteur de référence (type ssize_t), un pointeur pour taper PyLongObject, la taille actuelle du tableau de bits (également ssize_t) et initialiser le tableau lui-même.  Pour les systèmes 64 bits, la taille de structure minimale est: 2 * ssize_t + pointeur + chiffre = 2 * 8 + 8 + 4 = 28 octets.  Des problèmes supplémentaires apparaissent lors de la création de listes de nombres: étant donné que les nombres ne sont pas de type primitif et que les listes en python stockent des références à des objets, les objets ne sont pas séquentiellement en mémoire dynamique. <br><br>  Cette disposition ralentit l'itération sur le tableau: en fait, un accès aléatoire est effectué, ce qui rend impossible de prédire les transitions. <br><br>  Afin d'éviter une allocation excessive de mémoire dynamique, ce qui ralentit le temps de fonctionnement et contribue à la fragmentation de la mémoire, l'optimisation est implémentée en cpython: lors de la phase de démarrage, un tableau de petits entiers est pré-alloué: de -5 à 256. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> NSMALLPOSINTS #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NSMALLPOSINTS 257 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     python    . #endif #ifndef NSMALLNEGINTS #define NSMALLNEGINTS 5 #endif</span></span></span></span></code> </pre><br>  Par conséquent, la liste des nombres en cpython est représentée en mémoire comme suit: <br><br><img src="https://habrastorage.org/webt/k2/1m/hj/k21mhjawz4oerssjqvnhpdz3pq4.png"><br><br>  Il est possible d'accéder à la liste présélectionnée de petits entiers du script, armée de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> et du module ctypes standard: <br><br>  Avertissement: Le code suivant est fourni tel quel, l'auteur n'assume aucune responsabilité et ne peut garantir l'état de l'interprète, ainsi que la santé mentale de vous et de vos collègues, après avoir exécuté ce code. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ctypes <span class="hljs-comment"><span class="hljs-comment">#  PyLongObject class IntStruct(ctypes.Structure): #   _fields_ = [("ob_refcnt", ctypes.c_long), ("ob_type", ctypes.c_void_p), ("ob_size", ctypes.c_long), ("ob_digit", ctypes.c_int)] def __repr__(self): return ("IntStruct(ob_digit={self.ob_digit}, ob_size={self.ob_size}, " "refcount={self.ob_refcnt})").format(self=self) if __name__ == '__main__': #    42 int42 = IntStruct.from_address(id(42)) print(int42) int_minus_2 = IntStruct.from_address(id(-2)) print(int_minus_2) # ob_digit=2, ob_size=-1 #       int42.ob_digit = 4 print(4 == 42) # True print(1 + 41) # 4</span></span></code> </pre><br>  Honest PyLongObject est stocké dans cette liste, c'est-à-dire qu'ils ont un compteur de référence, par exemple, vous pouvez savoir combien de zéros votre script et l'interpréteur utilisent. <br><br>  De l'implémentation interne d'entiers, il s'ensuit que l'arithmétique en cpython ne peut pas être rapide, où d'autres langages itèrent séquentiellement sur le tableau, lisant des nombres dans des registres et appelant directement plusieurs instructions de processeur, cpython est balisé dans toute la mémoire, exécutant des méthodes plutôt compliquées.  Dans le cas le plus simple des entiers mono-bit, dans lequel il suffirait d'appeler une instruction, l'interpréteur doit comparer les tailles, puis créer un objet en mémoire dynamique, remplir les champs de service, et lui renvoyer un pointeur; de plus, ces actions nécessitent un verrou GIL.  Vous comprenez maintenant pourquoi la bibliothèque numpy est née et pourquoi elle est si populaire. <br><br>  Je voudrais terminer l'article sur le type entier en cpython, soudainement, avec des informations sur le type booléen. <br><br>  Le fait est que pendant longtemps en python il n'y avait pas de type séparé pour les variables booléennes, toutes les fonctions logiques retournaient 0 et 1. Cependant, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ils ont décidé d'introduire un</a> nouveau type.  Dans le même temps, il a été mis en œuvre comme un type enfant à l'ensemble. <br><br><pre> <code class="cpp hljs">PyTypeObject PyBool_Type = { PyVarObject_HEAD_INIT(&amp;PyType_Type, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//       // ,       //     ob_size "bool", //   sizeof(struct _longobject), //    ... &amp;PyLong_Type, //   ... bool_new, //  };</span></span></code> </pre><br>  De plus, chacune des valeurs du type booléen est un singleton, une variable booléenne est un pointeur vers une instance de True ou False (None est implémenté de manière similaire). <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">longobject</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Py_FalseStruct</span></span></span><span class="hljs-class"> = {</span></span> PyVarObject_HEAD_INIT(&amp;PyBool_Type, <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-number"><span class="hljs-number">0</span></span> } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">longobject</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Py_TrueStruct</span></span></span><span class="hljs-class"> = {</span></span> PyVarObject_HEAD_INIT(&amp;PyBool_Type, <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-number"><span class="hljs-number">1</span></span> } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PyObject * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool_new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyTypeObject *type, PyObject *args, PyObject *kwds)</span></span></span><span class="hljs-function"> </span></span>{ PyObject *x = Py_False; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> ok; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_PyArg_NoKeywords(<span class="hljs-string"><span class="hljs-string">"bool"</span></span>, kwds)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!PyArg_UnpackTuple(args, <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;x)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ok = PyObject_IsTrue(x); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ok &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PyBool_FromLong(ok); } <span class="hljs-function"><span class="hljs-function">PyObject *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PyBool_FromLong</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ok)</span></span></span><span class="hljs-function"> </span></span>{ PyObject *result; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ok) result = Py_True; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> result = Py_False; Py_INCREF(result); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br>  PyObject_IsTrue (x) est un mécanisme délicat pour calculer une valeur booléenne, vous pouvez le voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> dans la section sur la fonction booléenne ou dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . <br><br>  Un tel héritage conduit à des effets amusants, tels que l'égalité exacte de True et 1, l'incapacité d'avoir True et 1 comme clés dans le dictionnaire et l'ensemble, et l'admissibilité des opérations arithmétiques sur le type booléen: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">True</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; {<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-string"><span class="hljs-string">"one"</span></span>} {<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-string"><span class="hljs-string">'one'</span></span>} &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> / (<span class="hljs-number"><span class="hljs-number">5</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) - (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">-6.0</span></span> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> &lt; <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre><br>  Le langage python est magnifique pour sa flexibilité et sa lisibilité, cependant, il faut garder à l'esprit que tout cela a un prix, par exemple, sous la forme d'abstractions et de frais généraux superflus, auxquels nous ne pensons ou ne devinons pas souvent.  J'espère que cet article vous a permis de dissiper un peu le «brouillard de guerre» sur le code source de l'interprète, peut-être même de vous inciter à l'étudier.  Le code de l'interpréteur est très facile à lire, presque comme le code sur python lui-même, et l'étudier vous permettra non seulement d'apprendre comment l'interpréteur est implémenté, mais aussi d'intéressantes solutions algorithmiques et système, ainsi que d'écrire éventuellement du code plus efficace ou de devenir développeur de cpython lui-même. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455114/">https://habr.com/ru/post/fr455114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455102/index.html">Connexion d'interfaces série sur IP</a></li>
<li><a href="../fr455104/index.html">BotAuth - connexion et enregistrement à l'aide de bots</a></li>
<li><a href="../fr455106/index.html">Développement logiciel. Tendances 2019</a></li>
<li><a href="../fr455110/index.html">Le bonheur des employés dépend-il de tâches intéressantes? Dites à Badoo, SKB Kontur, Dodo Pizza, Staply et Alternativa Games</a></li>
<li><a href="../fr455112/index.html">Bitrix24: "Rapidement levé n'est pas considéré comme tombé"</a></li>
<li><a href="../fr455118/index.html">Vers l'avenir avec l'intégration des services Jenkins et Oracle APEX</a></li>
<li><a href="../fr455120/index.html">Le Wi-Fi n'est pas pour tout le monde. Comment autoriser par la loi les étrangers dans le réseau?</a></li>
<li><a href="../fr455122/index.html">Alternative de réflexion Java plus rapide</a></li>
<li><a href="../fr455128/index.html">Comment nous modérons les annonces</a></li>
<li><a href="../fr455130/index.html">3 outils populaires pour organiser le déploiement continu (déploiement continu)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>