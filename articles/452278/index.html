<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê® üå∂Ô∏è üé∂ Bluetooth LE no da tanto miedo, ni c√≥mo mejorar la experiencia del usuario sin mucho esfuerzo üçÉ üêÅ üïã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, a nuestro equipo se le ocurri√≥ e implement√≥ la funci√≥n de transferir dinero por aire utilizando la tecnolog√≠a Bluetooth LE. Quiero cont...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bluetooth LE no da tanto miedo, ni c√≥mo mejorar la experiencia del usuario sin mucho esfuerzo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/452278/">  Recientemente, a nuestro equipo se le ocurri√≥ e implement√≥ la funci√≥n de transferir dinero por aire utilizando la tecnolog√≠a Bluetooth LE.  Quiero contarte c√≥mo lo hicimos y qu√© nos proporciona Apple a partir de las herramientas.  Muchos desarrolladores piensan que Bluetooth es dif√≠cil, porque es un protocolo de bajo nivel y no hay muchos expertos en √©l.  Pero no todo es tan aterrador, y de hecho, ¬°usar esta funci√≥n es muy simple!  Y esas funciones que pueden implementarse usando Bluetooth LE son ciertamente interesantes y posteriormente resaltar√°n su aplicaci√≥n entre los competidores. <br><br><img src="https://habrastorage.org/webt/97/vu/bb/97vubbbho3z3z4dx_fwnztumh9u.png"><br><a name="habracut"></a><br>  Primero, comprendamos qu√© tipo de tecnolog√≠a es y cu√°l es su diferencia con el Bluetooth cl√°sico. <br><br><h3>  ¬øQu√© es Bluetooth LE? </h3><br>  ¬øPor qu√© los desarrolladores de Bluetooth nombraron esta tecnolog√≠a, a saber, Low Energy?  Despu√©s de todo, con cada nueva versi√≥n de Bluetooth, el consumo de energ√≠a ya era muchas veces menor.  La respuesta est√° en esta bater√≠a. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ce/qb/65/ceqb65oxhimqzgzovufqysqvsqk.png"></div><br>  Su di√°metro es de solo 2 cm y la capacidad es de aproximadamente 220 mA * h.  Cuando los ingenieros desarrollaron Bluetooth LE, quer√≠an que el dispositivo con dicha bater√≠a funcionara durante varios a√±os.  ¬°Y lo hicieron!  Los dispositivos Bluetooth LE con dicha bater√≠a pueden funcionar durante un a√±o.  ¬øCu√°ntos de ustedes todav√≠a apagan el Bluetooth en su tel√©fono a la antigua usanza para ahorrar energ√≠a, como lo hicieron en 2000?  En vano haces esto: los ahorros ser√°n menos de 10 segundos del tel√©fono por d√≠a.  Y deshabilita una funcionalidad muy grande, como Handoff, AirDrop y otros. <br><br>  ¬øQu√© lograron los ingenieros al desarrollar Bluetooth LE?  ¬øHan refinado el protocolo cl√°sico?  ¬øLo hizo m√°s eficiente energ√©ticamente?  ¬øAcaba de optimizar todos los procesos?  No  Redise√±aron por completo la arquitectura de la pila Bluetooth y lograron el hecho de que ahora, para ser visible para todos los dem√°s dispositivos, necesita menos tiempo para estar en el aire y ocupar el canal.  A su vez, esto permiti√≥ un buen ahorro en el consumo de energ√≠a.  Y con la nueva arquitectura, cualquier dispositivo nuevo ahora se puede estandarizar, gracias a lo cual los desarrolladores de todo el mundo pueden comunicarse con el dispositivo y, por lo tanto, escribir f√°cilmente nuevas aplicaciones para administrarlo.  Adem√°s, el principio de autodescubrimiento se establece en la arquitectura: cuando se conecta a un dispositivo, no necesita ingresar ning√∫n c√≥digo PIN, y si su aplicaci√≥n puede comunicarse con este dispositivo, la conexi√≥n toma unos milisegundos. <br><br><ul><li>  Menos tiempo en el aire. </li><li>  Menos consumo de energ√≠a. </li><li>  Nueva arquitectura </li><li>  Tiempo de conexi√≥n reducido. </li></ul><br>  <b>¬øC√≥mo lograron los ingenieros dar un salto tan grande en eficiencia energ√©tica?</b> <br><br>  La frecuencia se mantuvo igual: 2,4 GHz, no certificada y gratuita para su uso en muchos pa√≠ses.  Pero el retraso de la conexi√≥n se ha reducido: 15-30 ms en lugar de 100 ms con Bluetooth cl√°sico.  La distancia de trabajo se mantuvo igual, 100 m. El intervalo de transmisi√≥n no fue fuerte, pero cambi√≥, en lugar de 0.625 ms, se convirti√≥ en 3 ms. <br><br>  Pero debido a esto, el consumo de energ√≠a no se pudo reducir diez veces.  Por supuesto, algo tuvo que sufrir.  Y esta es la velocidad: en lugar de 24 Mbps, se convirti√≥ en 0.27 Mbps.  Probablemente dir√°s que esta es una velocidad rid√≠cula para 2018. <br><br><h3>  ¬øD√≥nde se usa Bluetooth LE? </h3><br><img src="https://habrastorage.org/webt/bz/0r/ca/bz0rcanj9nvdu_gijz0f6ip3h18.png"><br><br>  Esta tecnolog√≠a no es joven, apareci√≥ por primera vez en el iPhone 4s.  Y ya logr√≥ conquistar muchas √°reas.  Bluetooth LE se utiliza en todos los dispositivos dom√©sticos inteligentes y dispositivos electr√≥nicos port√°tiles.  Ahora incluso hay chips del tama√±o de granos de caf√©. <br><br><img src="https://habrastorage.org/webt/ex/0c/go/ex0cgowkyn9nhzx_c5vnwvn7v3g.png"><br><br>  <b>¬øY c√≥mo se aplica esta tecnolog√≠a en el software?</b> <br><br>  Dado que Apple fue el primero en integrar Bluetooth en su dispositivo y comenzar a usarlo, ahora han hecho un buen progreso e integrado la tecnolog√≠a en su ecosistema.  Y ahora puede conocer esta tecnolog√≠a en servicios como AirDrop, inicio r√°pido de dispositivos, compartir contrase√±as, traspaso.  E incluso las notificaciones en el reloj se realizan a trav√©s de Bluetooth LE.  Adem√°s, Apple ha puesto a disposici√≥n del p√∫blico documentaci√≥n sobre c√≥mo asegurarse de que las notificaciones de todas las aplicaciones lleguen a sus propios dispositivos.  ¬øCu√°les son los roles de los dispositivos dentro de Bluetooth LE? <br><br><img src="https://habrastorage.org/webt/vd/gk/85/vdgk85ww_wcqq_jykxexwqidgcw.png"><br><br>  <b>Brodcaster</b>  Env√≠a mensajes a todos los que est√°n cerca, no puede conectarse a este dispositivo.  Seg√∫n este principio, iBeacons y la navegaci√≥n interior funcionan. <br><br>  <b>Observador</b>  Escucha lo que sucede y recibe datos solo de mensajes p√∫blicos.  No crea conexiones. <br><br>  Pero con <b>Central</b> y <b>Perif√©rico</b> m√°s interesante.  ¬øPor qu√© no fueron llamados simplemente Servidor-Cliente?  L√≥gicamente, a juzgar por el nombre.  Pero no <br><br>  Porque Perif√©rico en realidad act√∫a como un servidor.  Este es un dispositivo perif√©rico que consume menos energ√≠a y se conecta a la Central m√°s poderosa.  Peripheral puede informarle que est√° cerca y qu√© servicios tiene.  Solo un dispositivo puede conectarse a √©l, y Peripheral tiene algunos datos.  Y Central puede escanear el aire en busca de dispositivos, enviar solicitudes de conexi√≥n, conectarse a cualquier n√∫mero de dispositivos, puede leer, escribir y suscribirse a los datos de Peripheral. <br><br>  ¬øA qu√© tenemos acceso los desarrolladores en el ecosistema de Apple? <br><br><h3>  ¬øQu√© hay disponible para nosotros? </h3><br>  <b>iOS / Mac OS:</b> <br><br><ul><li>  Perif√©rico y Central. </li><li>  Modo de fondo </li><li>  Recuperaci√≥n del estado. </li><li>  Intervalo de conexi√≥n 15 ms. </li></ul><br>  <b>watchOS / tvOS:</b> <br><br><ul><li>  watchOS 4+ / tvOS 9+. </li><li>  Central solamente. </li><li>  M√°ximo dos conexiones. </li><li>  Apple watch series 2+ / AppleTv 4+. </li><li>  Apagar al ingresar al fondo. </li><li>  Intervalo de conexi√≥n 30 ms. </li></ul><br>  La diferencia m√°s importante es el intervalo de conexi√≥n.  ¬øA qu√© afecta?  Para responder a esta pregunta, primero debe comprender c√≥mo funciona el protocolo Bluetooth LE y por qu√© una diferencia tan peque√±a en los valores absolutos es muy importante. <br><br><h3>  Como funciona el protocolo </h3><br>  ¬øC√≥mo es el proceso de b√∫squeda y conexi√≥n? <br><br>  Peripheral anuncia su presencia en la frecuencia del intervalo de publicidad, su paquete es muy peque√±o y contiene solo unos pocos identificadores de servicio proporcionados por el dispositivo, as√≠ como el nombre del dispositivo.  El intervalo puede ser bastante grande y puede variar seg√∫n el estado actual del dispositivo, el modo de ahorro de energ√≠a y otras configuraciones.  Apple aconseja a los desarrolladores de dispositivos externos que unan la longitud del intervalo al aceler√≥metro: aumente el intervalo si no se usa el dispositivo y, cuando est√© activo, disminuya para encontrarlo r√°pidamente.  El intervalo de publicidad no se correlaciona con el intervalo de conexi√≥n y lo determina el propio dispositivo, seg√∫n el consumo de energ√≠a y su configuraci√≥n.  Es inaccesible y desconocido para nosotros en el ecosistema de Apple; est√° completamente controlado por el sistema. <br><br><img src="https://habrastorage.org/webt/na/_v/66/na_v662ojn9_xtvkdfma2wxyfaa.png"><br><br>  Despu√©s de encontrar el dispositivo, enviamos una solicitud de conexi√≥n, y aqu√≠ el intervalo de conexi√≥n entra en escena, el tiempo despu√©s del cual el segundo dispositivo puede responder a la solicitud.  Pero esto es cuando se conecta, pero ¬øqu√© sucede al leer / escribir? <br><br><img src="https://habrastorage.org/webt/iq/mv/hg/iqmvhgecmnlikziagjsbda4vxe0.png"><br><br>  El intervalo de conexi√≥n tambi√©n aparece cuando se leen datos; reducirlo 2 veces aumenta la velocidad de transferencia de datos.  Pero debe comprender que si ambos dispositivos no admiten el mismo intervalo, se seleccionar√° el m√°ximo de ellos. <br><br>  Veamos en qu√© consiste un paquete de informaci√≥n que pasa Peripheral. <br><br>  La MTU (unidad de transmisi√≥n m√°xima) de dicho paquete se determina durante el proceso de conexi√≥n y var√≠a de un dispositivo a otro y dependiendo del sistema operativo.  En la versi√≥n 4.0 del protocolo, la MTU era de aproximadamente 30 y el tama√±o de la carga √∫til no superaba los 20 bytes.  En la versi√≥n 4.2, todo ha cambiado, ahora puede transferir unos 520 bytes.  Pero, desafortunadamente, solo los dispositivos m√°s j√≥venes que el iPhone 5s admiten esta versi√≥n del protocolo.  El tama√±o de la sobrecarga, independientemente del tama√±o de la MTU, es de 7 bytes: esto incluye encabezados ATT y L2CAP.  Con el registro, en general, una situaci√≥n similar. <br><br><img src="https://habrastorage.org/webt/gp/zi/ho/gpzihocxxa6po-lfmmlqyl5e7wu.png"><br><br>  Solo hay dos modos: con respuesta y sin ella.  El modo sin respuesta acelera significativamente la transferencia de datos, ya que no hay intervalo de espera antes de la pr√≥xima grabaci√≥n.  Pero este modo no siempre est√° disponible, no en todos los dispositivos ni en todos los sistemas.  El acceso a este modo de grabaci√≥n puede estar limitado por el propio sistema, ya que se considera menos eficiente energ√©ticamente.  En iOS, hay un m√©todo en el que puede verificar antes de grabar si este modo est√° disponible. <br><br>  Ahora veamos en qu√© consiste el protocolo. <br><br><img src="https://habrastorage.org/webt/um/mh/um/ummhumgo7y_x3aeeu03wcv9shiy.png"><br><br>  El protocolo consta de 5 niveles.  <b>La capa de aplicaci√≥n</b> es su l√≥gica, descrita en la parte superior de CoreBluetooth.  <b>GATT (Generic Attributes Layer)</b> se usa para intercambiar servicios y caracter√≠sticas que est√°n en los dispositivos.  <b>ATT (Capa de atributos) se</b> utiliza para administrar sus caracter√≠sticas y transferir sus datos.  <b>L2CAP</b> es un protocolo de intercambio de datos de bajo nivel.  <b>El controlador</b> es el chip BT en s√≠. <br><br>  <b>Probablemente se pregunte qu√© es GATT y c√≥mo podemos trabajar con √©l.</b> <br><br>  GATT consta de caracter√≠sticas y servicios.  Una caracter√≠stica es un objeto en el que se almacenan sus datos, como una variable.  Y un servicio es un grupo en el que se ubican sus caracter√≠sticas, como un espacio de nombres.  El servicio tiene un nombre: UUID, lo eliges t√∫ mismo.  Un servicio puede contener un servicio subsidiario. <br><br><img src="https://habrastorage.org/webt/qs/cr/8k/qscr8kzsigratdfk7boemuqz_ri.png"><br><br>  La caracter√≠stica tambi√©n tiene su propio <b>UUID</b> , de hecho, un nombre.  <b>El valor de la</b> caracter√≠stica es NSData, aqu√≠ puede registrar y almacenar datos.  <b>Los descriptores</b> son una descripci√≥n de su caracter√≠stica, puede describir qu√© datos espera de esta caracter√≠stica o qu√© significan.  Hay muchos descriptores en el protocolo Bluetooth, pero hasta ahora solo dos est√°n disponibles en los sistemas Apple: la descripci√≥n humana y el formato de datos.  Tambi√©n hay permisos para su funci√≥n: <br><br><img src="https://habrastorage.org/webt/xz/zh/kz/xzzhkzptblzhshwvso6kiiygtwe.png"><br><br><h3>  Prob√©moslo t√∫ mismo </h3><br>  Tuvimos la idea de hacer posible transferir dinero por v√≠a a√©rea sin requerir nada del destinatario.  Imag√≠nese, est√° desconcertando una tarea muy interesante, escribiendo el c√≥digo perfecto, y aqu√≠ un colega sugiere ir a tomar un caf√©.  Y te apasiona tanto la tarea que no puedes irte, y p√≠dele que te compre una taza de delicioso capuchino.  √âl te trae caf√©, y debes devolverle el dinero.  Puede traducir por n√∫mero de tel√©fono, funciona bien.  Pero aqu√≠ hay una situaci√≥n inc√≥moda: no sabes su n√∫mero.  Bueno, as√≠, has estado trabajando durante tres a√±os, pero no han intercambiado n√∫meros :) <br><br>  Por lo tanto, decidimos hacer posible transferir dinero a los que est√°n cerca, sin ingresar ning√∫n dato de usuario.  Como en AirDrop.  Simplemente seleccione un usuario y env√≠e la cantidad que necesita.  Veamos qu√© necesitamos para esto. <br><br><img src="https://habrastorage.org/webt/kp/tc/vs/kptcvsdcwhwapavwoxyq7h20nq4.png"><br><br><h3>  EMPUJAR mapeo </h3><br>  Necesitamos el remitente: <br><br><ol><li>  Podr√≠a encontrar todos los dispositivos que est√°n cerca y que admiten nuestro servicio. </li><li>  Pod√≠a leer los detalles. </li><li>  Y podr√≠a enviar un mensaje al destinatario que le hab√≠a enviado con √©xito el dinero. </li></ol><br>  El destinatario, a su vez, debe poder informar a los remitentes de los alrededores que tiene un servicio con los datos necesarios y poder recibir mensajes del remitente.  Creo que no vale la pena describir c√≥mo se lleva a cabo el proceso de transferencia de dinero por detalles en nuestro banco.  Ahora intentemos implementar esto. <br><br>  Primero debe encontrar los nombres de nuestro servicio y caracter√≠sticas.  Como dije, este es el UUID.  Simplemente los generamos y los guardamos en Peripheral y Central para que sean iguales en ambos dispositivos. <br><br><img src="https://habrastorage.org/webt/xp/bd/xi/xpbdxioazo7xd4wbnnluhmncbk4.png"><br><br>  Usted es libre de usar cualquier UUID, excepto los que terminan as√≠: XXXXXXXX- <b>icsoft1000-8000-00805F9B34FB</b> : est√°n reservados para diferentes compa√±√≠as.  Usted mismo puede comprar ese n√∫mero y nadie lo usar√°.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Costar√°</a> $ 2500. <br><br>  Luego, necesitaremos crear gerentes: uno para transferir fondos y el otro para recibir.  Solo necesita especificar delegados.  Transmitiremos Central, recibiremos Perif√©rico.  Creamos ambos, porque tanto el emisor como el receptor pueden ser una persona en diferentes momentos. <br><br><img src="https://habrastorage.org/webt/m3/vl/ta/m3vltagqi_tzwe8r6ayu70j3wyg.png"><br><br>  Ahora tenemos que hacer posible detectar al destinatario y anotar los detalles del destinatario en nuestra caracter√≠stica. <br><br><img src="https://habrastorage.org/webt/ui/nf/hb/uinfhboh_hqspuyugii1xkukh1a.png"><br><br>  Primero, crea un servicio.  Registraremos el UUID e indicaremos que es primario, es decir, el servicio es el principal para este dispositivo.  Un buen ejemplo: un monitor de frecuencia card√≠aca, para el cual la frecuencia card√≠aca actual ser√° el servicio principal, y el estado de la bater√≠a es informaci√≥n secundaria. <br><br>  A continuaci√≥n, creamos dos caracter√≠sticas: una para leer los detalles del destinatario, la segunda para escribir para que el destinatario pueda aprender sobre el env√≠o de dinero.  Los registramos en nuestro servicio, luego los agregamos al administrador, iniciamos el descubrimiento e indicamos el UUID del servicio para que todos los dispositivos que est√©n cerca puedan conocer nuestro servicio antes de conectarse.  Estos datos se colocan en el paquete que Central env√≠a durante la transmisi√≥n. <br><br>  El destinatario est√° listo, dir√≠jase al remitente.  Ejecute la b√∫squeda y con√©ctese. <br><br><img src="https://habrastorage.org/webt/zq/d6/6j/zqd66jsw2k8gyb-chlj778dx_u8.png"><br><br>  Cuando activa el administrador, comenzamos la b√∫squeda de dispositivos con nuestro servicio.  Cuando los encontramos, los obtenemos en el m√©todo delegado e inmediatamente nos conectamos.  Importante: debe mantener un v√≠nculo fuerte con todos los perif√©ricos con los que trabaja, de lo contrario, se filtrar√°n. <br><br><img src="https://habrastorage.org/webt/ll/ce/nf/llcenfrfgkrgdgxxy0wh2usf9-q.png"><br><br>  Despu√©s de una conexi√≥n exitosa, configuramos el delegado que trabajar√° con este dispositivo y obtenemos el servicio que necesitamos del dispositivo. <br><br><img src="https://habrastorage.org/webt/j3/f0/lh/j3f0lh82sza1lncds8ujfd4yoac.png"><br><br>  Nos hemos conectado con √©xito al destinatario, ahora necesita leer sus detalles. <br><br>  Despu√©s de conectarnos, ya hemos solicitado todos los servicios del dispositivo.  Y despu√©s de recibirlos, se llamar√° al m√©todo delegado, que enumerar√° todos los servicios disponibles en este dispositivo.  Encontramos el correcto y solicitamos sus caracter√≠sticas.  El UUID puede encontrar el resultado en el m√©todo delegado, que almacena los datos para la traducci√≥n.  Intentamos leerlos y obtenemos lo deseado nuevamente en el m√©todo delegado.  Todos los servicios, caracter√≠sticas y sus valores son almacenados en cach√© por el sistema, por lo que no es necesario solicitarlos m√°s tarde cada vez. <br><br><img src="https://habrastorage.org/webt/cn/e8/qh/cne8qh7dtbbir7q76abbpil4ywk.png"><br><br>  Eso es todo, enviamos dinero para el caf√©, es hora de mostrarle al destinatario un aviso hermoso para que espere rublos en su cuenta.  Para hacer esto, debe implementar el proceso de enviar un mensaje. <br><br>  Obtenemos la caracter√≠stica que necesitamos del remitente, en este caso la tomamos del valor almacenado.  Pero antes de eso, debe obtenerlo del dispositivo, como lo hicimos antes.  Y luego simplemente escriba los datos a la caracter√≠stica deseada. <br><br>  Despu√©s de eso, en el otro dispositivo, recibimos una solicitud de escritura en el m√©todo delegado.  Aqu√≠ puede leer los datos que se le env√≠an, responder a cualquier error, por ejemplo, no hay acceso o esta caracter√≠stica no existe.  Todo funcionar√°, pero solo si ambos dispositivos est√°n encendidos y las aplicaciones est√°n activas.  ¬°Y tenemos que trabajar en segundo plano! <br><br><img src="https://habrastorage.org/webt/3n/3x/4n/3n3x4no4wu9c95ej5nlmxrfc5g8.png"><br><br>  Apple te permite usar Bluetooth en segundo plano.  Para hacer esto, debe indicar en info.plist la clave en qu√© modo queremos usar, en Perif√©rico o Central. <br><br><img src="https://habrastorage.org/webt/e8/sk/ns/e8skns2rwruttrhvy1wagrcoppq.png"><br><br>  A continuaci√≥n, en el administrador, debe especificar la clave de recuperaci√≥n y crear un m√©todo delegado.  Ahora el modo de fondo est√° disponible para nosotros.  Si la aplicaci√≥n se queda dormida o se descarga de la memoria, cuando encuentre el perif√©rico deseado o cuando Central est√© conectada, se activar√° y el administrador se restaurar√° con su clave. <br><br><img src="https://habrastorage.org/webt/7y/lz/xd/7ylzxdqlziqkiiqyby2ppkbcfws.png"><br><br>  Todo est√° bien, listo para ser lanzado.  Pero aqu√≠ los dise√±adores vienen corriendo y nos dicen: "Queremos insertar fotos de los usuarios para que les sea m√°s f√°cil encontrarse".  Que hacer  En nuestra caracter√≠stica, puede escribir solo unos 500 bytes, pero en algunos dispositivos en general 20 :( <br><br><img src="https://habrastorage.org/webt/cu/dd/_l/cudd_lekcmzrpsmf-mz-9w7is0m.png"><br><br><h3>  Ir m√°s profundo </h3><br>  Para resolver este problema, tuvimos que profundizar. <br><br><img src="https://habrastorage.org/webt/rt/bf/8h/rtbf8hlexfy42goqfvxs8mojyig.png"><br><br>  Ahora hablamos con dispositivos en el nivel GATT / ATT.  Pero en iOS 11, tenemos acceso al protocolo L2CAP.  Sin embargo, en este caso, deber√° hacerse cargo de la transferencia de datos usted mismo.  Los paquetes se env√≠an con MTU de 2 Kb, no es necesario volver a codificar nada, se aplica NSStream normal.  Velocidades de datos de hasta 394 Kbps, seg√∫n Apple. <br><br>  Suponga que transfiere cualquier dato de su servicio de Perif√©rico a Central en forma de caracter√≠sticas normales.  Y me llev√≥ abrir el canal.  Lo abres en Peripheral, a cambio obtienes PSM: este es el n√∫mero del canal al que puedes conectarte, y debes transferirlo a Central usando las mismas caracter√≠sticas.  El n√∫mero es din√°mico, el sistema mismo elige qu√© PSM abrir en este momento.  Despu√©s de la transferencia, ya puede conectarse a Peripheral en Central e intercambiar datos en un formato conveniente para usted.  Veamos c√≥mo hacer esto. <br><br>  Primero, abra el puerto encriptado en Peripheral.  Puede hacerlo sin cifrado, esto acelerar√° un poco la transferencia. <br><br><img src="https://habrastorage.org/webt/ov/yd/ku/ovydkugm5hgyddaroucpcdjmaq0.png"><br><br>  Luego, en el m√©todo delegado, obtenemos el PSM y lo enviamos a otro dispositivo. <br><br><img src="https://habrastorage.org/webt/tm/5g/bv/tm5gbvpsr1dbn8_x3jhg1btpth4.png"><br><br>  Despu√©s de conectar otro dispositivo, se nos llamar√° un m√©todo en el cual podemos obtener el NSStream que necesitamos para la transmisi√≥n desde el canal. <br><br><img src="https://habrastorage.org/webt/nf/ec/kw/nfeckwjotne6tgzochcost5dr5g.png"><br><br>  Central es a√∫n m√°s f√°cil, solo nos conectamos al canal con el n√∫mero deseado ... <br><br><img src="https://habrastorage.org/webt/oi/tm/hg/oitmhgdbpty9nmathmdnbhsisok.png"><br><br>  ... y despu√©s de eso obtenemos las transmisiones que necesitamos.  En ellos, puede transferir absolutamente cualquier informaci√≥n de cualquier tama√±o y construir su protocolo sobre L2CAP.  Entonces nos dimos cuenta de la transferencia de las fotos de los destinatarios. <br><br><img src="https://habrastorage.org/webt/fq/hq/ha/fqhqha7vfucpkksx4whppmay_du.png"><br><br>  Pero hay escollos, donde prescindir de ellos. <br><br><h3>  Trampas </h3><br>  Echemos un vistazo a las dificultades al trabajar en segundo plano.  Dado que los roles de Perif√©rico y Central est√°n disponibles para usted, puede pensar.  que en el fondo puede determinar qu√© dispositivos est√°n cerca en el fondo y cu√°les est√°n activos.  En teor√≠a, deber√≠a haberlo sido, pero Apple introdujo una restricci√≥n: los tel√©fonos que est√°n en segundo plano, ya sean centrales o perif√©ricos, no est√°n disponibles para otros tel√©fonos que tambi√©n est√°n en segundo plano.  Adem√°s, los tel√©fonos que est√°n en segundo plano no son visibles desde dispositivos que no son iOS.  Veamos por qu√© sucede esto. <br><br>  Cuando su dispositivo est√° activo, env√≠a un paquete de difusi√≥n regular, que puede contener el nombre del dispositivo y una lista de servicios.  que proporciona este dispositivo.  Y los datos de desbordamiento es todo lo que no encajaba. <br><br><img src="https://habrastorage.org/webt/si/ca/ri/sicarigcdlr017kg1zpesa15psc.png"><br><br>  Cuando el dispositivo pasa a segundo plano, no transmite el nombre y transfiere la lista de servicios admitidos a datos desbordados.  Si la aplicaci√≥n est√° activa, cuando escanea desde un dispositivo iOS, lee estos datos y, al pasar a segundo plano, los ignora.  Por lo tanto, al cambiar al fondo, no podr√° ver las aplicaciones que tambi√©n est√°n en segundo plano.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otros sistemas operativos de Apple siempre ignoran los datos de desbordamiento, por lo que si busca dispositivos que admitan su servicio, obtendr√° una matriz vac√≠a. </font><font style="vertical-align: inherit;">Y si se conecta a cada dispositivo que est√° cerca y solicita servicios compatibles, entonces la lista puede contener su servicio y puede trabajar con √©l. </font></font><br><br><img src="https://habrastorage.org/webt/nj/qc/s5/njqcs5ytnn4czeiumbsvwiqb3cu.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego nos est√°bamos preparando para enviar pruebas, corregimos errores menores y nos dedicamos a la optimizaci√≥n. </font><font style="vertical-align: inherit;">Y de repente, en alg√∫n momento, comenzamos a recibir este error en la consola:</font></font><br><br><pre><code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">124</span></span></code> </pre> <br>  Lo peor fue que no se llam√≥ a ning√∫n m√©todo delegado, ni siquiera pudimos superar este error para el usuario.  Solo un mensaje en el registro, y silencio, todo se congel√≥.  No se realizaron cambios importantes, por lo que comenzamos a retroceder en los commits.  Y descubrieron que una vez optimizaron el c√≥digo y rehicieron la forma de escribir datos.  El problema era que no todos los clientes se actualizaron, por lo que se produjo este error. <br><br><pre> <code class="javascript hljs">.write != .writeWithoutResponse</code> </pre> <br>  Estamos contentos de haberlo arreglado todo, m√°s bien pasamos a pasarlo a prueba, y casi de inmediato nos respondieron: ‚ÄúTus fotos de moda no funcionan.  Todos vienen subcargados.  Comenzamos a intentarlo, y es cierto que a veces, en diferentes dispositivos, las fotos rotas vienen en diferentes momentos.  Comenzaron a buscar una raz√≥n. <br><br>  Y luego nuevamente vieron el error anterior.  Inmediatamente pens√© que estaba en diferentes versiones.  Pero despu√©s de la eliminaci√≥n completa de la versi√≥n anterior de todos los dispositivos de prueba, el error a√∫n se reproduce.  Est√°bamos tristes ... <br><br><pre> <code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">722</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">249</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">312</span></span></code> </pre> <br>  Comenzamos a buscar una herramienta de depuraci√≥n.  Lo primero que encontramos fue el Apple Bluetooth Explorer.  Un programa poderoso, puede hacer muchas cosas, pero para depurar el protocolo Bluetooth LE, hay una peque√±a pesta√±a con la b√∫squeda de dispositivos y la obtenci√≥n de caracter√≠sticas.  Y necesit√°bamos analizar L2CAP. <br><br>  Luego encontraron LightBlue Explorer.  Result√≥ ser un programa bastante decente, aunque con un dise√±o de iOS 7. Puede hacer lo mismo que Bluetooth Explorer, y tambi√©n sabe c√≥mo suscribirse a las especificaciones.  Y funciona m√°s estable.  Todo est√° bien, pero de nuevo sin L2CAP. <br><br>  Y luego recordamos el conocido sniffer WireShark. <br><br>  Result√≥ que estaba familiarizado con Bluetooth LE: puede leer L2CAP, pero solo bajo Windows.  Aunque no da miedo que no encontremos Windows o algo as√≠.  El mayor inconveniente: el programa solo funciona con un dispositivo espec√≠fico.  Es decir, ten√≠a que encontrar el dispositivo en alg√∫n lugar de la tienda oficial.  Y usted mismo comprende que es poco probable que una gran empresa apruebe la compra de un dispositivo incomprensible en un mercado de pulgas.  Incluso comenzamos a navegar en tiendas en l√≠nea en el extranjero. <br><br>  Pero aqu√≠ encontraron el programa PacketLogger en Herramientas adicionales de Xcode.  Le permite ver el tr√°fico que va en el dispositivo OS X.  ¬øPor qu√© no reescribir nuestro MoneyDrop en OS X?  Ya ten√≠amos una biblioteca separada.  Acabamos de reemplazar UIImage con NSImage, todo comenz√≥ despu√©s de 10 minutos. <br><br><img src="https://habrastorage.org/webt/vm/tn/z3/vmtnz3yw28-g7zsb8-cf6nldt6o.png"><br><br>  Finalmente, podr√≠amos leer los paquetes intercambiados entre dispositivos.  De inmediato se hizo evidente que en el momento de la transmisi√≥n de datos a trav√©s de L2CAP se registr√≥ una de las caracter√≠sticas.  Y debido al hecho de que el canal estaba completamente ocupado con la transferencia de fotos, iOS ignor√≥ la grabaci√≥n y el remitente despu√©s de ignorar rompi√≥ el canal.  Despu√©s de solucionar los problemas con la transferencia de la foto no fue as√≠. <br><br><img src="https://habrastorage.org/webt/ig/gw/sn/iggwsno_4bqfunmdzy0pigsn77i.png"><br><br>  Eso es todo, gracias por leer :) <br><br><h3>  <b>Enlaces utiles</b> </h3><br>  <b>WWDC / CoreBluetooth:</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://developer.apple.com/videos/play/wwdc2017/712/</a> </li><li>  WWDC 2012 Sesi√≥n 703 Core Bluetooth 101 </li><li>  WWDC 2012 Sesi√≥n 705 Advanced Core Bluetooth </li></ul><br>  <b>Bluetooth</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.bluetooth.com/specifications/gatt</a> </li><li>  Comenzando con Bluetooth Low Energy O'Reilly </li></ul><br>  <b>YouTube</b> <br><br><ul><li>  Arrow Electronics ‚Üí Serie Bluetooth de baja energ√≠a </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/452278/">https://habr.com/ru/post/452278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452266/index.html">Bastidores sin servidor</a></li>
<li><a href="../452268/index.html">Ventana anal√≥gica de C # WPF. ShowDialog () o tratar con DispatcherFrame</a></li>
<li><a href="../452270/index.html">La documentaci√≥n de la API de Xamarin ahora est√° disponible p√∫blicamente</a></li>
<li><a href="../452272/index.html">Chica bajo la cascada</a></li>
<li><a href="../452276/index.html">Ingenier√≠a inversa del cliente de Dropbox</a></li>
<li><a href="../452280/index.html">PostgreSQL 11: la evoluci√≥n de la partici√≥n de Postgres 9.6 a Postgres 11</a></li>
<li><a href="../452282/index.html">Elemental, Watson: te integras con Voximplant</a></li>
<li><a href="../452284/index.html">Clasificaci√≥n de la cobertura del suelo utilizando eo-learn. Parte 1</a></li>
<li><a href="../452288/index.html">Situaci√≥n: operadores m√≥viles estadounidenses acusados ‚Äã‚Äãde comercio ilegal de geodatos de suscriptores</a></li>
<li><a href="../452290/index.html">Lo que los hackers extra√±an cuando quiebran un banco en PHDays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>