<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüé§ üîÄ üë®üèΩ‚Äçüè´ Opera√ß√£o TA505, parte quatro. G√™meos üêâ ‚úÖ ‚ùóÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuamos a falar sobre as atividades do grupo de hackers TA505. A conhecida frase ‚Äúo novo √© o velho esquecido‚Äù √© a mais adequada como ep√≠grafe para...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Opera√ß√£o TA505, parte quatro. G√™meos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/475328/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/79/gv/mv/79gvmv2kznpjzybycyw7scp5zus.jpeg"></a> <br><br>  Continuamos a falar sobre as atividades do grupo de hackers TA505.  A conhecida frase ‚Äúo novo √© o velho esquecido‚Äù √© a mais adequada como ep√≠grafe para o pr√≥ximo cap√≠tulo da hist√≥ria sobre o grupo TA505.  √â verdade que desta vez o "velho" n√£o √© tanto "esquecido", como √© retrabalhado e aprimorado. <br><br>  No in√≠cio de setembro, descobrimos v√°rios downloaders maliciosos fornecidos com um PE-packer de grupo especial, sobre o qual <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escrevemos anteriormente</a> .  √Ä primeira vista, pareciam os bem conhecidos estagi√°rios de backdoor FlawedAmmyy.  Mas uma an√°lise mais profunda mostrou que n√£o √© assim.  As t√©cnicas mais avan√ßadas para escrever c√≥digo n√£o nos levaram a cargas radicalmente opostas em termos de qualidade de execu√ß√£o. <br><br>  Neste artigo, examinaremos mais de perto as ferramentas encontradas e tra√ßaremos paralelos com o que j√° √© conhecido. <a name="habracut"></a><br><br><h2>  Carregador de inicializa√ß√£o twein </h2><br>  Primeiro, o seguinte √© curioso: de todas as amostras do gerenciador de inicializa√ß√£o que conseguimos coletar, apenas uma possui uma assinatura digital: <br><br><img src="https://habrastorage.org/webt/im/iu/-a/imiu-af4otgk3nhalsj7mhe3hwy.jpeg"><br><br>  <i>Fig.</i>  <i>1. Assinatura digital do gerenciador de inicializa√ß√£o</i> <br><br>  Certificado emitido em nome de PEAR SOLUTIONS LTD.  A prop√≥sito, n√£o √© a primeira vez que um grupo assina suas ferramentas, passando-as como um software leg√≠timo de organiza√ß√µes fict√≠cias.  Aqui est√£o alguns outros nomes que usaram o TA505 para outras fam√≠lias de malware: <br><br><ul><li>  ET HOMES LTD, </li><li>  FIT AND FLEX LIMITED, </li><li>  MISHA LONDON LTD, </li><li>  SATOJI KAIDA MB, </li><li>  MUITO TELE LIMITADO. </li></ul><br>  Como os gerenciadores de inicializa√ß√£o detectados n√£o diferem entre si, selecionamos o assinado acima e nos detemos com mais detalhes. <br><br>  Durante todo o trabalho do malware, quase todas as a√ß√µes s√£o acompanhadas da grava√ß√£o no arquivo de log e na sa√≠da de depura√ß√£o de tudo o que acontece: <br><br><img src="https://habrastorage.org/webt/dm/7f/1j/dm7f1jjwkhlfkj8k987uvp8ixjw.jpeg"><br><br>  <i>Fig.</i>  <i>2. Sa√≠da e registro de depura√ß√£o</i> <br><br>  Esse rastreamento n√£o apenas simplifica a an√°lise est√°tica do arquivo, mas tamb√©m ajuda a descobrir o que h√° de errado nos sistemas de an√°lise din√¢mica: <br><br><img src="https://habrastorage.org/webt/d4/g1/kg/d4g1kgeiovdgo-ecz3ytg5ki26c.jpeg"><br><br>  <i>Fig.</i>  <i>3. Sa√≠da de depura√ß√£o no analisador online ANY.RUN</i> <br><br>  Troyan verifica o layout do idioma do teclado - e n√£o funciona na R√∫ssia e nos pa√≠ses vizinhos: <br><br><img src="https://habrastorage.org/webt/bz/hr/my/bzhrmynjo9dlc50xi_nucjdpuf4.jpeg"><br><br>  <i>Fig.</i>  <i>4. Verificando o layout do idioma do teclado</i> <br>  Em seguida, ele cria o mutex <code>Global\system32_mutant_service</code> e verifica a disponibilidade da Internet usando uma solicita√ß√£o HTTP GET para google.com.  Depois disso, determina a maneira de acessar a rede (endere√ßo dedicado ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NAT</a> ), determinando o endere√ßo IP externo pelos servi√ßos myexternalip.com, ipecho.net e ifconfig.me e comparando o valor obtido com o especificado nos par√¢metros de rede do sistema: <br><br><img src="https://habrastorage.org/webt/ld/80/7w/ld807wry4cgdc1qzj3mwjogabf8.jpeg"><br><br>  <i>Fig.</i>  <i>5. Compara√ß√£o de endere√ßos IP internos e externos</i> <br><br>  Em seguida, o malware determina a vers√£o da biblioteca <code>%SystemRoot%\system32\crypt32.dll</code> e, se o n√∫mero da compila√ß√£o e o n√∫mero da revis√£o forem menores que <code>7601</code> e <code>18741</code> respectivamente, baixa e instala a atualiza√ß√£o <code>KB3033929</code> acordo com a vers√£o do sistema operacional: <br><br><img src="https://habrastorage.org/webt/su/zu/ig/suzuighncp_psgtfbtnbvcdbb1y.jpeg"><br><br>  <i>Fig.</i>  <i>6. Baixe e instale atualiza√ß√µes do sistema</i> <br><br>  Os atacantes do TA505 cuidam da v√≠tima e corrigem o sistema conforme necess√°rio?  Nem um pouco.  A instala√ß√£o da atualiza√ß√£o est√° associada ao t√©rmino do suporte para certificados de seguran√ßa de c√≥digo assinado usando o SHA-1 e seu abandono em favor do algoritmo SHA-2.  Provavelmente, os hackers j√° tiveram dificuldade em executar cargas √∫teis assinadas em sistemas n√£o atualizados.  Curiosamente, depois de instalar a atualiza√ß√£o, o trojan envia o log de a√ß√µes gerado ao servidor de gerenciamento, interrompe seu trabalho e se limpa, limpando os tra√ßos restantes. <br><br><img src="https://habrastorage.org/webt/k6/jk/-y/k6jk-yijoanmpjtwath42fioh10.jpeg"><br><br>  <i>Fig.</i>  <i>7. Desligar ap√≥s instalar uma atualiza√ß√£o do sistema</i> <br><br>  Se a instala√ß√£o da atualiza√ß√£o n√£o for necess√°ria, o carregador de inicializa√ß√£o coleta e envia as seguintes informa√ß√µes ao servidor de gerenciamento: <br><br><ul><li>  informa√ß√µes do sistema </li><li>  informa√ß√µes sobre o software instalado, </li><li>  informa√ß√µes sobre software assinado nos diret√≥rios% ProgramFiles% e% ProgramFiles (x86)% (se houver), </li><li>  Informa√ß√µes sobre drivers assinados no diret√≥rio% SystemRoot% \ drivers. </li></ul><br>  Observe que um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digo leg√≠timo</a> foi usado para obter informa√ß√µes sobre assinaturas. <br><br><img src="https://habrastorage.org/webt/z4/1o/p_/z41op_q3q8pzlli3zlapjreaxd0.jpeg"><br><br>  <i>Fig.</i>  <i>8. Obtendo informa√ß√µes do certificado</i> <br><br>  Depois disso, o carregador de inicializa√ß√£o cria o diret√≥rio <code>C:\Windows\Logs\diag</code> e inicia um encadeamento no qual rastreia as altera√ß√µes no diret√≥rio, enviando notifica√ß√µes para o servidor de gerenciamento: <br><br><img src="https://habrastorage.org/webt/ra/rh/-g/rarh-gd4x8yafwiipdft7r9duiq.jpeg"><br><br>  <i>Fig.</i>  <i>9. Monitorando Altera√ß√µes no Diret√≥rio</i> <br><br>  Em seguida, prepara as informa√ß√µes existentes e ausentes sobre o sistema (nome de usu√°rio, vers√£o do sistema, dom√≠nio, endere√ßo IP, informa√ß√µes sobre a placa de v√≠deo, conex√£o de rede - NAT ou n√£o NAT) e gera um arquivo JSON desse tipo: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"adm"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bid"</span></span>: <span class="hljs-string"><span class="hljs-string">"M3xwwhqLH/AUOhmU2+W55A=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bit"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bnet"</span></span>: <span class="hljs-string"><span class="hljs-string">"ldr"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cam"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cis"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dmn"</span></span>: <span class="hljs-string"><span class="hljs-string">"WORKGROUP"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash_r"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lip"</span></span>: <span class="hljs-string"><span class="hljs-string">"192.168.100.153"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lvl"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nat"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osb"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osv"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows 7 Professional"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pc"</span></span>: <span class="hljs-string"><span class="hljs-string">"USER-PC"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_c"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_n"</span></span>: <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rep"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmt"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ver"</span></span>: <span class="hljs-string"><span class="hljs-string">"163"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"video"</span></span>: <span class="hljs-string"><span class="hljs-string">"Standard VGA Graphics Adapter,"</span></span> }</code> </pre> <br>  Posteriormente, esses dados ser√£o criptografados com RC4 (a chave de criptografia <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code> √© criptografada no corpo do Trojan), codificada com Base64 e enviada por uma solicita√ß√£o HTTP POST ao servidor de gerenciamento: <br><br><img src="https://habrastorage.org/webt/wu/4p/x8/wu4px8dxpkvy5mshywjkrskevlm.jpeg"><br><br>  <i>Fig.</i>  <i>10. Solicita√ß√£o HTTP POST para o servidor de gerenciamento</i> <br><br><img src="https://habrastorage.org/webt/uv/lw/bg/uvlwbgwcx0ejyfndmzdybhtqrsy.jpeg"><br><br>  <i>Fig.</i>  <i>11. A lista de servidores de controle no gerenciador de inicializa√ß√£o</i> <br><br>  A resposta do servidor √© descriptografada pelo RC4 (a chave de criptografia √© a mesma usada para enviar os dados) e verificada: os dois primeiros bytes devem corresponder √† linha MZ, que √© um sinal do arquivo PE.  J√° conhecemos essa sequ√™ncia anteriormente quando analisamos outro carregador de grupo que entregou o FlawedAmmyy RAT: <br><br><img src="https://habrastorage.org/webt/pb/oe/hi/pboehibfeoivvna7bl6xkumibuo.jpeg"><br><br>  <i>Fig.</i>  <i>12. Um c√≥digo semelhante para descriptografar e verificar o arquivo baixado do gerenciador de inicializa√ß√£o em quest√£o (√† esquerda) e do gerenciador de inicializa√ß√£o FlawedAmmyy RAT (√† direita)</i> <br><br>  O carregamento da carga √∫til ocorre n√£o apenas no encadeamento principal, mas tamb√©m em um criado separadamente.  Em outras palavras, existem duas cargas √∫teis.  Em um caso, o mutex Global \ system32_host_service √© pr√©-verificado e, no caso de sua aus√™ncia, um componente √© carregado, que √© referido nas informa√ß√µes de depura√ß√£o como carga √∫til ou bot.  Curiosamente, ap√≥s receber uma resposta do servidor, o arquivo PE n√£o inicia de forma alguma.  Em vez disso, seu corpo √© gravado no registro na se√ß√£o <code>HKEY_LOCAL_MACHINE\SYSTEM</code> na chave <code>0x228028</code> .  Em seguida, o carregador de inicializa√ß√£o desativa o redirecionamento do sistema de arquivos WoW64 para aplicativos de 32 bits usando <code>Wow64DisableWow64FsRedirection</code> e inicia o processo <code>%SystemRoot%\System32\services.exe</code> com o par√¢metro -ww.  O uso desse par√¢metro n√£o faz sentido, mas isso completa a cadeia de instala√ß√£o da carga √∫til resultante. <br><br><img src="https://habrastorage.org/webt/bn/eb/w1/bnebw1pcir-t8io211poejmlzbe.jpeg"><br><br>  <i>Fig.</i>  <i>13. Definindo a carga √∫til</i> <br><br>  Falaremos sobre a segunda carga √∫til mais tarde. <br><br><h2>  Plugins Twein </h2><br>  Examinando o Trojan discutido acima, notamos uma fun√ß√£o que remove dois arquivos do diret√≥rio <code>%SystemRoot%</code> - <code>twein_32.dll</code> e <code>twein_64.dll</code> : <br><br><img src="https://habrastorage.org/webt/hk/v2/ht/hkv2ht9lipkhgz-ydz622exxzds.jpeg"><br><br>  <i>Fig.</i>  <i>14. Removendo os arquivos twein_32.dll e twein_64.dll</i> <br><br>  Esses arquivos n√£o s√£o encontrados em nenhum outro lugar, eles n√£o aparecem na l√≥gica do carregador de inicializa√ß√£o.  No entanto, os nomes das bibliotecas nos lembraram outro grupo de malware, que consideraremos agora. <br>  Dois meses antes, encontramos um Trojan do grupo TA505, com aproximadamente 9 MB de tamanho.  O arquivo √© empacotado pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UPX</a> .  O cavalo de Troia √© instalado no sistema como um servi√ßo <code>WMDICToss</code> .  Os recursos cont√™m tr√™s arquivos: <code>systemdiron.bat</code> , <code>twein__32.dll</code> e <code>twein__64.dll</code> , criptografados com o XOR linear. <br><br><img src="https://habrastorage.org/webt/tj/op/xh/tjopxhpvsrbmlstkvm2fidukk7w.jpeg"><br><br>  <i>Fig.</i>  <i>15. Descriptografia de um dos recursos do conta-gotas</i> <br><br>  Observe que os nomes dos dois arquivos quase coincidem com os j√° mencionados anteriormente: a diferen√ßa est√° apenas no n√∫mero de sublinhados. <br><br>  Espera-se que um dos recursos descriptografados com o nome <code>systemdiron.bat</code> seja um script de comando que forne√ßa o lan√ßamento de outros componentes, dependendo da capacidade do sistema: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> defined PROCESSOR_ARCHITEW6432 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==IA64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==AMD64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==x86 (goto LABEL_X86) goto LABEL_NON :LABEL_X64 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x64 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__64.dll,Install copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_X86 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x86 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_NON <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: undefined goto LABEL_END :LABEL_END pause</code> </pre> <br>  Ambas as bibliotecas twein agem de maneira semelhante.  Embalado com o empacotador caracter√≠stico do grupo TA505.  Nomes originais da biblioteca: <code>av_block.dll</code> .  A an√°lise √© significativamente complicada pelo uso de um ofuscador, e a propor√ß√£o de c√≥digo ofuscado √© de cerca de 80%.  Como resultado, a execu√ß√£o do programa √© saturada com in√∫meras transi√ß√µes, decodifica√ß√£o das pr√≥ximas etapas do c√≥digo, chamadas de fun√ß√£o n√£o lineares. <br><br>  As bibliotecas cont√™m uma lista impressionante de cadeias do tipo Base64, descriptografadas da seguinte maneira: <br><br>  1. A sequ√™ncia de entrada √© dividida em blocos de 4 bytes; <br>  2. Cada bloco √© decodificado usando o algoritmo de substitui√ß√£o e deslocamento: <br><br><pre> <code class="bash hljs">import binascii def block_decode(input_str, len_of_block): alphabet = <span class="hljs-string"><span class="hljs-string">'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x00\x00\x00\x3F\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x00\x00\x00\x00\x00\x00\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F\x30\x31\x32\x33\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span> int_result = 0 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len_of_block): alph = ord(alphabet[ord(input_str[i])]) alph &lt;&lt;= 0x6 * i int_result += alph str_result = hex(int_result)[2:] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(str_result) % 2 != 0: str_result = <span class="hljs-string"><span class="hljs-string">'0'</span></span> + str_result <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> binascii.unhexlify(str_result).decode(<span class="hljs-string"><span class="hljs-string">'latin1'</span></span>)[::-1]</code> </pre> <br><br>  3) os blocos s√£o coletados em uma √∫nica linha; <br>  4) o resultado √© descriptografado pelo algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">eexec</a> com uma chave de byte duplo, passado como par√¢metro: <br><br><img src="https://habrastorage.org/webt/qs/mj/ah/qsmjah4gzyqwizgrothw1hlbkdc.jpeg"><br><br>  <i>Fig.</i>  <i>16. Implementa√ß√£o do algoritmo eexec</i> <br><br>  A maioria das linhas s√£o os nomes e caminhos dos arquivos dos produtos antiv√≠rus, no entanto, alguns deles n√£o pertencem a ferramentas de seguran√ßa: MS Exchange Server, MySQL Server, SAP, Apache, PostgreSQL, Elasticsearch, etc. Havia at√© mesmo caminhos √∫nicos: <br><br><ul><li>  C: \ Users \ tislam \ Desktop \ aplicativo salik \ Aye_salik_data \ Aye_salik_data \ bin \ Debug \ Aye_salik_data.exe </li><li>  C: \ oem13c \ agent13c \ agent_13.2.0.0.0 \ perl \ bin \ perl.exe </li><li>  C: \ Usu√°rios \ adadmin \ Ubiquiti UniFi \ bin \ mongod.exe </li><li>  C: \ Usu√°rios \ sakella \ AppData \ Local \ Microsoft \ OneDrive \ OneDrive.exe </li><li>  Teste D: \ Add-ons \ IMI_CREDIT_POLICY v 02.01 \ IMI_CREDIT_POLICY.exe </li></ul><br>  Se um software for encontrado no sistema a partir da lista, os arquivos e diret√≥rios ser√£o exclu√≠dos. <br><br>  Para se protegerem no sistema, as bibliotecas se definem como a interface do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Windows Sockets</a> Service Provider (SPI), denominada Intel e IntelFiltr.  Al√©m disso, eles alteram a ordem dos manipuladores na cadeia de protocolos para serem o primeiro SPI a manipular a solicita√ß√£o do cliente. <br><br>  Em 2015, nossos colegas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FireEye</a> introduziram a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">an√°lise de</a> bot <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LatentBot</a> .  √â curioso que o algoritmo de criptografia de string no LatentBot e as bibliotecas twein revisadas sejam completamente iguais.  Al√©m disso, o LatentBot usa um m√≥dulo de seguran√ßa como um dos plug-ins, que procura ferramentas de seguran√ßa no sistema usando os caminhos e nomes de produtos especificados, embora esteja limitado a verificar a disponibilidade. <br><br><h2>  Rootkit twein </h2><br>  De volta ao gerenciador de inicializa√ß√£o, ou seja, a segunda carga √∫til.  Nas linhas de depura√ß√£o da tentativa de abrir o rootkit ... e o Driver% S instalado, √© f√°cil adivinhar o formato da pr√≥xima carga √∫til.  Ap√≥s o carregamento bem-sucedido, o driver ser√° gravado no <code>%SystemRoot%\System32\drivers</code> com um nome formado de maneira pseudo-aleat√≥ria a partir dos nomes de outros arquivos leg√≠timos.  Em seguida, o servi√ßo ser√° criado e lan√ßado: <br><br><img src="https://habrastorage.org/webt/hw/dp/vi/hwdpvipfgx2-rra5iqecj2o5t8w.jpeg"><br><br>  <i>Fig.</i>  <i>17. Instalando e iniciando o servi√ßo</i> <br><br>  Na fase final de seu trabalho, o carregador configurar√° o driver para ser inclu√≠do na lista negra nas chaves do Registro: os nomes dos processos antiv√≠rus, ferramentas de an√°lise e fornecedores de prote√ß√£o nas assinaturas de arquivos digitais ser√£o inseridos nos valores num√©ricos especificados das chaves da ramifica√ß√£o <code>HKEY_LOCAL_MACHINE\SYSTEM</code> : <br><br><img src="https://habrastorage.org/webt/u2/fw/zj/u2fwzjlb_hjgmabjwa4filz9fn4.jpeg"><br><br>  <i>Fig.</i>  <i>18. configura√ß√£o do driver na lista negra</i> <br><br>  No processo de pesquisa do gerenciador de inicializa√ß√£o, n√£o conseguimos obter uma amostra de driver do servidor de gerenciamento.  No entanto, descobrimos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">men√ß√£o de um rootkit</a> que foi implementado por outro gerenciador de inicializa√ß√£o semelhante. <br><br>  O driver √© assinado digitalmente em nome da <code>Lizas Limited</code> com <code>administrator@lizaslimited.site</code> como email: <br><br><img src="https://habrastorage.org/webt/o_/tm/yy/o_tmyyrx3dayywf-jnfkoijecvm.jpeg"><br><br>  <i>Fig.</i>  <i>19. driver assinado digitalmente</i> <br><br>  Durante a pesquisa, encontramos muito em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">comum</a> com o conhecido rootkit da botnet Necurs, que foi usado ativamente pelo grupo TA505 para enviar spam e espalhar malware.  Vamos considerar com mais detalhes as caracter√≠sticas mais interessantes de seu trabalho. <br><br>  O driver registra manipuladores de eventos para iniciar processos e carregar imagens de PE usando <code>PsSetCreateProcessNotifyRoutine</code> e <code>PsSetLoadImageNotifyRoutine</code> .  Em outras palavras, isso permite que o driver controle o lan√ßamento de todos os novos processos e servi√ßos.  Usando as listas negras mencionadas anteriormente, o rootkit finaliza processos indesejados com o ZwTerminateProcess e impede que outros drivers potencialmente perigosos sejam carregados, substituindo o valor do ponto de entrada nas instru√ß√µes: <br><br><pre> <code class="bash hljs">mov eax, 0C0000001 retn 8</code> </pre> <br>  Como resultado, o servi√ßo ser√° descarregado com o erro <code>STATUS_UNSUCCESSFULL</code> . <br><br><img src="https://habrastorage.org/webt/td/l7/ea/tdl7ea03jvxszqftk9rks9wqgqc.jpeg"><br><br>  <i>Fig.</i>  <i>20. Conclus√£o do processo</i> <br><br><img src="https://habrastorage.org/webt/va/6k/bb/va6kbbjuepdp1x99ktenowebmc0.jpeg"><br><br>  <i>Fig.</i>  <i>21. Substituindo pontos de entrada do driver</i> <br><br>  Por meio de CmRegisterCallback, o driver intercepta eventos de acesso ao registro do sistema.  Em particular, seu trabalho adicional √© parametrizado pelos valores num√©ricos das chaves que s√£o acessadas em eventos interceptados. <br><br><img src="https://habrastorage.org/webt/af/ka/b6/afkab6erynqiphtoyzztal2wjq8.jpeg"><br><br>  <i>Fig.</i>  <i>22. Gerenciamento de rootkits de acessos √† chave do Registro</i> <br><br>  Curiosamente, em algumas vers√µes do rootkit Necurs, os mesmos valores num√©ricos foram usados ‚Äã‚Äãcomo c√≥digos de solicita√ß√£o ioctl. <br><br><img src="https://habrastorage.org/webt/nn/vx/rh/nnvxrhxmoftlziclt9dgak73ydk.jpeg"><br><br>  <i>Fig.</i>  <i>23. Gerenciando um rootkit Necurs usando consultas ioctl</i> <br><br>  Esse truque pode ser considerado um passo em dire√ß√£o a um maior sigilo: o acesso ao registro causa menos suspeitas do que as solicita√ß√µes ioctl para DeviceObject. <br><br>  O corpo do rootkit cont√©m uma biblioteca DLL auxiliar criptografada com XOR de byte √∫nico.  Ao criar um novo processo, o driver injeta a biblioteca junto com outro arquivo PE, que √© extra√≠do do registro e descriptografado novamente com um XOR de um byte. <br><br><img src="https://habrastorage.org/webt/nu/ze/03/nuze03jkif4-7sl9mux_j8_roz8.jpeg"><br><br>  <i>Fig.</i>  <i>24. Descriptografia e inje√ß√£o da biblioteca auxiliar no processo criado</i> <br><br>  O componente auxiliar √© um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">carregador reflexivo</a> personalizado que coloca corretamente o segundo arquivo PE na mem√≥ria, que atua como uma carga √∫til, e transfere o controle para ele.  Agora fica claro como exatamente a carga √∫til que foi gravada no registro pelo gerenciador de inicializa√ß√£o da primeira parte do artigo come√ßa a funcionar. <br><br><img src="https://habrastorage.org/webt/wa/zr/c3/wazrc3yxq9pul3vzf3jjbgsdeyg.jpeg"><br><br>  <i>Fig.</i>  <i>25. Preenchendo a Tabela de Importa√ß√£o com uma Biblioteca Auxiliar</i> <br><br><h2>  Conclus√£o </h2><br>  No artigo, nos familiarizamos com as caracter√≠sticas do trabalho de muitos trojans g√™meos.  Por que g√™meos?  O gerenciador de inicializa√ß√£o mal-intencionado com o qual iniciamos nossa pesquisa √© muito semelhante ao conhecido gerenciador de inicializa√ß√£o backdoor FlawedAmmyy na qualidade da escrita de c√≥digo e das nuances de implementa√ß√£o.  As bibliotecas twein que ele est√° tentando remover do sistema provavelmente s√£o as que examinaremos a seguir.  As bibliotecas s√£o muito semelhantes ao plug-in de seguran√ßa LatentBot.  Uma das cargas √∫teis do carregador de inicializa√ß√£o √© um driver derivado do popular rootkit Necurs. <br><br>  Algumas fam√≠lias de malware t√™m mais de 5 anos; no entanto, os invasores continuam a atualiz√°-las e melhor√°-las, levando em considera√ß√£o o desenvolvimento de sistemas operacionais e ferramentas de seguran√ßa. <br><br>  <b>Autores</b> : Alexey Vishnyakov e Daniil Koloskov, Positive Technologies <br><br><div class="spoiler">  <b class="spoiler_title">COI</b> <div class="spoiler_text">  a28a54abc30805cc6ea2ce0732989287 - Carregador de inicializa√ß√£o Twein <br>  f6b6526b8d494dce14568e3703368432 - conta-gotas do plugin twein <br>  983dd279722154a12093410067fe070e - rootkit Twein <br></div></div><br><h2>  Artigos anteriores da s√©rie: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Opera√ß√£o TA505: como analisamos as novas ferramentas dos criadores do Trojan Dridex, do ransomware Locky e da botnet Neutrino.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Opera√ß√£o TA505: Aprendendo o backdoor do ServHelper com o NetSupport RAT.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 2</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Opera√ß√£o TA505: Agrupando infraestrutura de rede.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 3</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt475328/">https://habr.com/ru/post/pt475328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt475314/index.html">Eco-fantasia para proteger o planeta</a></li>
<li><a href="../pt475320/index.html">Recomenda√ß√µes da Microsoft para desativar a expira√ß√£o de senha: consequ√™ncias e conclus√µes</a></li>
<li><a href="../pt475322/index.html">Osso de pr√≥ximo n√≠vel - Sound Aftershokz Aeropex Review</a></li>
<li><a href="../pt475324/index.html">Programa√ß√£o funcional do ponto de vista do EcmaScript. Composi√ß√£o, Caril, Aplica√ß√£o Parcial</a></li>
<li><a href="../pt475326/index.html">Como os golpistas fazem isso. Ferramentas de trapa√ßa</a></li>
<li><a href="../pt475330/index.html">Concurso de plug-ins da plataforma Miro com pr√™mio de US $ 21.000</a></li>
<li><a href="../pt475332/index.html">3. Projeto de rede corporativa em switches extremos</a></li>
<li><a href="../pt475338/index.html">Se voc√™ n√£o possui Python, mas existe um modelo Keras e Java</a></li>
<li><a href="../pt475340/index.html">A AMD apresentou os processadores Threadripper - as CPUs de desktop mais r√°pidas</a></li>
<li><a href="../pt475342/index.html">Andrey Sebrant (Yandex): Neg√≥cios na era da intelig√™ncia artificial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>