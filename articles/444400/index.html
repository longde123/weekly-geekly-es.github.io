<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¨ üë®üèº‚Äçüéì ‚ùé C√≥mo reescrib√≠ un motor de b√∫squeda de vuelos de PHP a NodeJS üê∞ üèúÔ∏è üï†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Mi nombre es Andrey, soy estudiante de posgrado en una de las universidades t√©cnicas de Mosc√∫ y a tiempo parcial  muy modesto  Emprendedor y desa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo reescrib√≠ un motor de b√∫squeda de vuelos de PHP a NodeJS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444400/"><p>  Hola  Mi nombre es Andrey, soy estudiante de posgrado en una de las universidades t√©cnicas de Mosc√∫ y a tiempo parcial <del>  muy modesto </del>  Emprendedor y desarrollador novato.  En este art√≠culo, decid√≠ compartir mi experiencia de cambiar de PHP (que una vez me gust√≥ por su simplicidad, pero eventualmente me odiaron; explico por qu√© bajo el corte) a NodeJS.  Aqu√≠ se pueden dar tareas muy triviales y aparentemente elementales, que, sin embargo, ten√≠a curiosidad personal por resolver durante mi conocimiento de NodeJS y las caracter√≠sticas del desarrollo del lado del servidor en JavaScript.  Tratar√© de explicar y demostrar claramente que PHP finalmente ha entrado en la puesta del sol y ha dado paso a NodeJS.  Tal vez incluso sea √∫til para alguien aprender algunas caracter√≠sticas de la representaci√≥n de p√°ginas HTML en Node, que originalmente no est√° adaptado a esto de la palabra. </p><a name="habracut"></a><br><h2 id="vvedenie">  Introduccion </h2><br><p>  Mientras escrib√≠a el motor, utilic√© las t√©cnicas m√°s simples.  Sin gestores de paquetes, sin enrutamiento.  Solo carpetas hardcore, cuyo nombre coincide con la ruta solicitada, e <strong>index.php</strong> en cada una de ellas, configuradas por PHP-FPM para admitir el grupo de procesos.  M√°s tarde se hizo necesario usar Composer y Laravel, que fue el colmo para m√≠.  Antes de pasar a la historia de por qu√© incluso decid√≠ reescribir todo, desde PHP hasta NodeJS, te contar√© un poco sobre los antecedentes. </p><br><h3 id="menedzher-paketov">  Administrador de paquetes </h3><br><p>  A finales de 2018, pas√© a trabajar con un proyecto escrito en Laravel.  Fue necesario corregir varios errores, realizar cambios en la funcionalidad existente, agregar algunos botones nuevos en la interfaz.  El proceso comenz√≥ instalando el paquete y el administrador de dependencias.  En PHP, Composer se usa para esto.  Luego, el cliente proporcion√≥ un servidor con 1 n√∫cleo y 512 megabytes de RAM y esta fue mi primera experiencia con Composer.  Al instalar dependencias en un servidor privado virtual con 512 megabytes de memoria, el proceso se bloque√≥ debido a la falta de memoria. </p><br><p><img src="https://habrastorage.org/webt/pg/jm/hh/pgjmhhg0efngekrokj1yryvdzxg.png" alt="Wut?"></p><br><p> Para m√≠, como persona familiarizada con Linux y con experiencia trabajando con Debian y Ubuntu, la soluci√≥n a este problema era obvia: instalar un archivo SWAP (archivo de intercambio) para aquellos que no est√°n familiarizados con la administraci√≥n de Linux).  Un desarrollador inexperto novato que instal√≥ su primera distribuci√≥n de Laravel en Digital Ocean, por ejemplo, solo va al panel de control y aumenta la tarifa hasta que la instalaci√≥n de dependencias se detiene con un error de segmentaci√≥n de memoria.  ¬øQu√© hay de NodeJS? <br>  Y NodeJS tiene su propio administrador de paquetes: npm.  Es mucho m√°s f√°cil de usar, m√°s compacto, puede funcionar incluso en un entorno con una cantidad m√≠nima de RAM.  En general, no hay nada que culpar a Composer contra NPM, sin embargo, en caso de errores al instalar paquetes, Composer se bloquear√° como una aplicaci√≥n PHP normal y nunca sabr√° qu√© parte del paquete se instal√≥ y si se instal√≥ al final termina  En general, para el administrador de Linux, la instalaci√≥n <code>dpkg --configure -a</code> = flashbacks en modo de rescate y <code>dpkg --configure -a</code> .  Para cuando me sorprendieron tales "sorpresas", no me gustaba PHP, pero estos fueron los √∫ltimos clavos en el ata√∫d de mi gran amor por PHP. </p><br><h2 id="long-term-support-i-problema-versionirovaniya">  Soporte a largo plazo y problemas de versiones </h2><br><p>  ¬øRecuerdas qu√© tipo de exageraci√≥n y asombro caus√≥ PHP7 cuando los desarrolladores lo presentaron por primera vez?  ¬°Aumente la productividad en m√°s de 2 veces, y en algunos componentes hasta 5 veces!  ¬øRecuerdas cuando naci√≥ la s√©ptima versi√≥n de PHP?  ¬°Y qu√© tan r√°pido gan√≥ WordPress!  Era diciembre de 2015.  ¬øSab√≠a que PHP 7.0 ahora se considera una versi√≥n obsoleta de PHP y se recomienda actualizarlo ... No, no a la versi√≥n 7.1, sino a la versi√≥n 7.2.  Seg√∫n los desarrolladores, la versi√≥n 7.1 ya est√° privada de soporte activo y solo recibe actualizaciones de seguridad.  Y despu√©s de 8 meses, esto se detendr√°.  Cesar√°, junto con el soporte activo y la versi√≥n 7.2.  Resulta que para fines de este a√±o, PHP solo tendr√° una versi√≥n actual: 7.3. </p><br><p><img src="https://habrastorage.org/webt/zd/0p/me/zd0pmebltmchxqafrdw5yfpdfta.png" alt="Versiones PHP actuales"></p><br><p>  De hecho, esto no ser√≠a una trampa y no atribuir√≠a esto a las razones de mi partida de PHP si los proyectos que escrib√≠ en PHP 7.0. * Ya no caus√≥ una advertencia de desaprobaci√≥n cuando lo abr√≠.  Volvamos al proyecto donde se bloque√≥ la instalaci√≥n de dependencias.  Este fue un proyecto escrito en 2015 en Laravel 4 con PHP 5.6.  Parec√≠a que solo hab√≠an pasado 4 a√±os, pero no: un mont√≥n de advertencias de desaprobaci√≥n, m√≥dulos obsoletos, la incapacidad de actualizar a Laravel 5 normalmente debido a un mont√≥n de actualizaciones del motor ra√≠z. </p><br><p>  Y esto se aplica no solo a Laravel.  Intente escribir cualquier aplicaci√≥n PHP durante el soporte activo de las primeras versiones de PHP 7.0 y prep√°rese para pasar la noche buscando soluciones a los problemas que surgieron en m√≥dulos PHP obsoletos.  Finalmente, un hecho interesante: el soporte para PHP 7.0 se suspendi√≥ antes que el soporte para PHP 5.6.  Por un segundo </p><br><p>  ¬øQu√© hay de NodeJS?  No dir√≠a que aqu√≠ todo es mucho mejor y que los per√≠odos de soporte para NodeJS son fundamentalmente diferentes de PHP.  No, es casi lo mismo aqu√≠: cada versi√≥n LTS es compatible durante 3 a√±os.  Pero NodeJS tiene un poco m√°s de estas versiones m√°s actuales. </p><br><p><img src="https://habrastorage.org/webt/ff/xf/x_/ffxfx_rhvieo0jmad4wnabdrwuy.png" alt="Versiones actuales de NodeJS"></p><br><p>  Si necesita implementar una aplicaci√≥n escrita en 2016, aseg√∫rese de que no tendr√° absolutamente ning√∫n problema con esto.  Por cierto, la versi√≥n 6. * ya no ser√° compatible solo en abril de este a√±o.  Y en frente hay 8, 10, 11 y los pr√≥ximos 12. </p><br><h2 id="o-trudnostyah-i-syurprizah-pri-perehode-na-nodejs">  Dificultades y sorpresas al cambiar a NodeJS </h2><br><p>  Comenzar√©, tal vez, con la pregunta m√°s emocionante para m√≠ sobre c√≥mo representar p√°ginas HTML en NodeJS.  Pero primero recordemos c√≥mo se hace esto en PHP: </p><br><ol><li>  Incruste HTML directamente en el c√≥digo PHP.  Tambi√©n lo hacen todos los novatos que a√∫n no han llegado a MVC.  Y as√≠ se hace en WordPress, lo cual es absolutamente horrible. </li><li>  Use MVC, que deber√≠a simplificar la interacci√≥n del desarrollador y proporcionar alg√∫n tipo de divisi√≥n del proyecto en partes, pero en realidad este enfoque solo complica todo a veces. </li><li>  Utiliza un motor de plantillas.  La opci√≥n m√°s conveniente, pero no en PHP.  Solo mire la sintaxis sugerida en Twig or Blade con llaves y porcentajes. </li></ol><br><p>  Soy un ardiente oponente de combinar o fusionar varias tecnolog√≠as juntas.  HTML debe existir por separado, los estilos para √©l por separado, JavaScript por separado (en React, esto generalmente parece monstruoso: HTML y JavaScript est√°n mezclados).  Es por eso que la opci√≥n ideal para desarrolladores con preferencias como la m√≠a es un motor de plantillas.  No tuve que buscarlo para una aplicaci√≥n web en NodeJS durante mucho tiempo y opt√© por Jade (PugJS).  Simplemente aprecie la simplicidad de su sintaxis: </p><br><pre> <code class="plaintext hljs"> div.row.links div.col-lg-3.col-md-3.col-sm-4 h4.footer-heading . div.copyright div.copy-text 2017 - #{current_year} . div.contact-link span : a(href='mailto:hello@flaut.ru') hello@flaut.ru</code> </pre> <br><p>  Aqu√≠ todo es bastante simple: escrib√≠ una plantilla, la descargu√© en la aplicaci√≥n, la compil√© una vez y luego la utilic√© en cualquier lugar conveniente en cualquier momento conveniente.  En mi opini√≥n, el rendimiento de PugJS es aproximadamente 2 veces mejor que la representaci√≥n al incrustar HTML en el c√≥digo PHP.  Si anteriormente en PHP el servidor gener√≥ una p√°gina est√°tica en aproximadamente 200-250 milisegundos, ahora esta vez es de aproximadamente 90-120 milisegundos (no estamos hablando de la representaci√≥n en PugJS, sino del tiempo tomado desde la solicitud de la p√°gina hasta la respuesta del servidor al cliente con HTML listo) )  As√≠ es como se ve la carga y compilaci√≥n de plantillas y sus componentes en la etapa de inicio de la aplicaci√≥n: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pugs = {} fs.readdirSync(__dirname + <span class="hljs-string"><span class="hljs-string">'/templates/'</span></span>).forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(file.endsWith(<span class="hljs-string"><span class="hljs-string">'.pug'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filepath = __dirname + <span class="hljs-string"><span class="hljs-string">'/templates/'</span></span> + file pugs[file.split(<span class="hljs-string"><span class="hljs-string">'.pug'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]] = pug.compile(fs.readFileSync(filepath, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>), { <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: filepath }) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(e) } } }) <span class="hljs-comment"><span class="hljs-comment">//       return pugs.tickets({ ...config })</span></span></code> </pre> <br><p>  Parece incre√≠blemente simple, pero con Jade hubo una peque√±a complejidad en la etapa de trabajar con HTML ya compilado.  El hecho es que para implementar scripts en la p√°gina, se utiliza una funci√≥n asincr√≥nica, que toma todos los archivos <code>.js</code> del directorio y agrega la fecha de su √∫ltimo cambio a cada uno de ellos.  La funci√≥n tiene la siguiente forma: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; files.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> period = files[i].lastIndexOf(<span class="hljs-string"><span class="hljs-string">'.'</span></span>) <span class="hljs-comment"><span class="hljs-comment">// get last dot in filename let filename = files[i].substring(0, period) let extension = files[i].substring(period + 1) if(extension === 'js') { let fullFilename = filename + '.' + extension if(env === 'production') { scripts.push({ path: paths.production.web + fullFilename, mtime: await getMtime(paths.production.code + fullFilename)}) } else { if(files[i].startsWith('common') || files[i].startsWith('search')) { scripts.push({ path: paths.developer.scripts.web + fullFilename, mtime: await getMtime(paths.developer.scripts.code + fullFilename)}) } else { scripts.push({ path: paths.developer.vendor.web + fullFilename, mtime: await getMtime(paths.developer.vendor.code + fullFilename)}) } } } }</span></span></code> </pre> <br><p>  En la salida, obtenemos una matriz de objetos con dos propiedades: la ruta al archivo y la hora en que se edit√≥ por √∫ltima vez en la marca de tiempo (para actualizar el cach√© del cliente).  El problema es que incluso en la etapa de recopilaci√≥n de archivos de secuencia de comandos de un directorio, todos se cargan en la memoria estrictamente alfab√©ticamente (ya que se encuentran en el directorio en s√≠ y los archivos se recopilan de arriba a abajo, desde el primero hasta el √∫ltimo).  Esto condujo al hecho de que el archivo <strong>app.js</strong> se carg√≥ al principio, y despu√©s vino el archivo <strong>core.min.js</strong> con polyfills y vendor.min.js al final.  Este problema se resolvi√≥ de manera bastante simple: clasificaci√≥n muy banal: </p><br><pre> <code class="javascript hljs">scripts.sort(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(a.path.includes(<span class="hljs-string"><span class="hljs-string">'core.min.js'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(a.path.includes(<span class="hljs-string"><span class="hljs-string">'vendor.min.js'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> })</code> </pre> <br><p>  En PHP, todo ten√≠a una apariencia monstruosa en forma de rutas a archivos JS previamente escritos en una cadena.  Simple pero poco pr√°ctico. </p><br><h3 id="nodejs-derzhit-svoyo-prilozhenie-v-operativnoy-pamyati">  NodeJS mantiene su aplicaci√≥n en RAM </h3><br><p>  Esta es una gran ventaja.  Todo est√° organizado para m√≠, de modo que en el servidor en paralelo e independientemente el uno del otro, hay dos sitios separados: la versi√≥n para el desarrollador y la versi√≥n de producci√≥n.  Imagine que hice algunos cambios en los archivos PHP en el sitio de desarrollo y necesito implementar estos cambios en producci√≥n.  Para hacer esto, debe detener el servidor o colocar un trozo de "lo siento, trabajo t√©cnico" y, en este momento, copiar los archivos individualmente de la carpeta del desarrollador a la carpeta de producci√≥n.  Esto provoca alg√∫n tipo de tiempo de inactividad y puede provocar la p√©rdida de conversiones.  La ventaja de la <strong>aplicaci√≥n</strong> en <strong>memoria</strong> en NodeJS es para m√≠ que todos los cambios en los archivos del motor se realizar√°n solo despu√©s de que se reinicie.  Esto es muy conveniente, porque puede copiar todos los archivos necesarios con los cambios y solo luego reiniciar el servidor.  El proceso no lleva m√°s de 1-2 segundos y no causa tiempo de inactividad. <br>  El mismo enfoque se usa en nginx, por ejemplo.  Primero edita la configuraci√≥n, <code>nginx -t</code> con <code>nginx -t</code> y solo luego realice cambios con el <code>service nginx reload</code> </p><br><h3 id="klasterizaciya-nodejs-prilozheniya">  Agrupaci√≥n de una aplicaci√≥n NodeJS </h3><br><p>  NodeJS tiene una herramienta muy conveniente: el <strong>administrador de</strong> procesos <strong>pm2</strong> .  ¬øC√≥mo solemos ejecutar aplicaciones en Node?  Entramos en la consola y escribimos el <code>node index.js</code> .  Tan pronto como cerramos la consola, la aplicaci√≥n se cierra.  Al menos esto es lo que sucede en un servidor con Ubuntu.  Para evitar esto y mantener la aplicaci√≥n ejecut√°ndose siempre, simplemente agr√©guela a <strong>pm2 con el</strong> simple comando de <code>pm2 start index.js --name production</code> .  Pero eso no es todo.  La herramienta permite el monitoreo ( <code>pm2 monit</code> ) y la agrupaci√≥n de aplicaciones. </p><br><p>  Recordemos c√≥mo se organizan los procesos en PHP.  Supongamos que tenemos nginx sirviendo solicitudes http y necesitamos pasar la solicitud a PHP.  Puede hacer esto directamente y luego con cada solicitud se generar√° un nuevo proceso PHP, y cuando se complete, se eliminar√°.  O puede usar un servidor fastcgi.  Creo que todos saben lo que es y no hay necesidad de entrar en detalles, pero por si acaso, aclarar√© que PHP-FPM se usa con mayor frecuencia como fastcgi y su tarea es generar muchos procesos PHP que est√°n listos para aceptar y procesar una nueva solicitud en cualquier momento.  ¬øCu√°l es la desventaja de este enfoque? </p><br><p>  La primera es que nunca se sabe cu√°nta memoria consumir√° su aplicaci√≥n.  En segundo lugar, siempre estar√° limitado en el n√∫mero m√°ximo de procesos y, en consecuencia, con un salto brusco en el tr√°fico, su aplicaci√≥n PHP usar√° toda la memoria disponible y se bloquear√°, o descansar√° contra el l√≠mite permitido de procesos y comenzar√° a eliminar los viejos.  Esto se puede evitar estableciendo No recuerdo qu√© par√°metro del archivo de configuraci√≥n PHP-FPM es <strong>din√°mico</strong> y luego se generar√°n tantos procesos como sea necesario en este momento.  Pero de nuevo, un ataque DDoS elemental consumir√° toda la RAM y pondr√° su servidor.  O, por ejemplo, un script de error consumir√° toda la RAM y el servidor se congelar√° por alg√∫n tiempo (hubo precedentes en el proceso de desarrollo). </p><br><p>  La diferencia fundamental en NodeJS es que la aplicaci√≥n no puede consumir m√°s de 1,5 gigabytes de RAM.  No hay restricciones de proceso; solo hay un l√≠mite de memoria.  Esto lo alienta a escribir programas lo m√°s livianos posible.  Adem√°s, es muy simple calcular la cantidad de cl√∫steres que podemos permitirnos, dependiendo del recurso de CPU disponible.  Se recomienda que no se cuelgue m√°s de un cl√∫ster en cada n√∫cleo (exactamente como en nginx, no m√°s de un trabajador por n√∫cleo de CPU). </p><br><p><img src="https://habrastorage.org/webt/rk/z4/hp/rkz4hp9g8jkptpmq_tbc-_gpdpu.png" alt="Agrupaci√≥n en PM2"></p><br><p>  Una ventaja de este enfoque es que PM2 recarga todos los cl√∫steres a su vez.  Volviendo al p√°rrafo anterior, que hablaba del tiempo de inactividad de 1-2 segundos durante el reinicio.  En el modo de cl√∫ster, cuando reinicia el servidor, su aplicaci√≥n no experimentar√° un milisegundo de tiempo de inactividad. </p><br><h3 id="nodejs---eto-horoshiy-shveycarskiy-nozh">  NodeJS es un buen cuchillo suizo </h3><br><p>  Ahora existe tal situaci√≥n cuando PHP act√∫a como un lenguaje para escribir sitios, y Python act√∫a como una herramienta para rastrear estos sitios.  NodeJS es 2 en 1, por un lado es un tenedor, por el otro es una cuchara.  Puede escribir aplicaciones y rastreadores web r√°pidos y potentes en el mismo servidor dentro de la misma aplicaci√≥n.  Suena tentador  Pero, ¬øc√≥mo se puede realizar esto, preguntas?  Google mismo lanz√≥ la API oficial de Chromium: Puppeteer.  Puede iniciar Headless Chrome (un navegador sin interfaz de usuario, Chrome "sin cabeza") y obtener el mayor acceso posible a la API del navegador para rastrear p√°ginas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">La forma m√°s sencilla y accesible de trabajar con Puppeteer</a> . </p><br><p>  Por ejemplo, en nuestro grupo VKontakte hay una publicaci√≥n regular de descuentos y ofertas especiales a varios destinos desde las ciudades de la CEI.  Generamos im√°genes para publicaciones en modo autom√°tico, y para que sean hermosas, necesitamos bellas im√°genes.  No me gusta vincularme a varias API y crear cuentas en docenas de sitios, por lo que escrib√≠ una aplicaci√≥n simple que imita a un usuario com√∫n con el navegador Google Chrome que recorre el sitio con im√°genes de archivo y recoge al azar la imagen encontrada por la palabra clave.  Sol√≠a ‚Äã‚Äãusar Python y BeautifulSoup para esto, pero ahora esto ya no es necesario.  Y la caracter√≠stica principal y la ventaja de Puppeteer es que puede enga√±ar f√°cilmente incluso a los sitios de SPA, porque tiene a su disposici√≥n un navegador completo que comprende y ejecuta el c√≥digo JavaScript en los sitios.  Es dolorosamente simple: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch({<span class="hljs-attr"><span class="hljs-attr">headless</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">args</span></span>:[<span class="hljs-string"><span class="hljs-string">'--no-sandbox'</span></span>]}) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> page = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.pages())[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.goto(<span class="hljs-string"><span class="hljs-string">`https://pixabay.com/photos/search/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${imageKeyword}</span></span></span><span class="hljs-string">/?cat=buildings&amp;orientation=horizontal`</span></span>, { <span class="hljs-attr"><span class="hljs-attr">waitUntil</span></span>: <span class="hljs-string"><span class="hljs-string">'networkidle0'</span></span> })</code> </pre> <br><p>  Entonces, en 3 l√≠neas de c√≥digo, lanzamos el navegador y abrimos la p√°gina del sitio con im√°genes de archivo.  Ahora podemos seleccionar un bloque aleatorio con la imagen en la p√°gina y agregarle una clase, en la que luego podemos acceder de la misma manera e ir directamente a la p√°gina con la imagen para cargar m√°s: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> imagesLength = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.evaluate(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> photos = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'.search_results &gt; .item'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(photos.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { photos[<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * photos.length)].className += <span class="hljs-string"><span class="hljs-string">' --anomaly_selected'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> photos.length })</code> </pre> <br><p>  Recuerde cu√°nto c√≥digo se necesitar√≠a para escribir esto en PhantomJS (que, por cierto, cerr√≥ y entr√≥ en estrecha colaboraci√≥n con el equipo de desarrollo de Puppeteer).  ¬øPuede una herramienta tan maravillosa evitar que alguien cambie a NodeJS? </p><br><h3 id="v-nodejs-zalozhena-asinhronnost-na-fundamentalnom-urovne">  NodeJS proporciona asincron√≠a fundamental </h3><br><p>  Esto puede considerarse una gran ventaja de NodeJS y JavaScript, especialmente con el advenimiento de async / wait en ES2017.  A diferencia de PHP, donde cualquier llamada se realiza sincr√≥nicamente.  Dar√© un ejemplo simple.  Anteriormente, en el motor de b√∫squeda, las p√°ginas se generaban en el servidor, pero algo ten√≠a que mostrarse en la p√°gina que ya estaba en el cliente usando JavaScript, pero en ese momento Yandex a√∫n no pod√≠a usar JavaScript en los sitios web y tuvo que implementar un mecanismo de instant√°nea (instant√°neas de p√°gina) espec√≠ficamente para √©l. usando Prerender.  Las instant√°neas se almacenaron en nuestro servidor y se enviaron al robot a pedido.  El dilema era que estas im√°genes se generaban en 3-5 segundos, lo cual es completamente inaceptable y puede afectar la clasificaci√≥n del sitio en los resultados de b√∫squeda.  Para resolver este problema, se invent√≥ un algoritmo simple: cuando el robot solicita alguna p√°gina, una instant√°nea de la que ya tenemos, simplemente le damos la instant√°nea existente, despu√©s de lo cual realizamos la operaci√≥n para crear una nueva instant√°nea en segundo plano y reemplazarla. Ya disponible.  C√≥mo se hizo en PHP: </p><br><pre> <code class="php hljs">exec(<span class="hljs-string"><span class="hljs-string">'/usr/bin/php '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/snapshot.php -a '</span></span> . $affiliation_type . <span class="hljs-string"><span class="hljs-string">' -l '</span></span> . urlencode($full_uri) . <span class="hljs-string"><span class="hljs-string">' &gt; /dev/null 2&gt;/dev/null &amp;'</span></span>);</code> </pre> <br><p>  Nunca hagas eso. <br>  En NodeJS, esto se puede lograr llamando a la funci√≥n asincr√≥nica: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveSnapshot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ getSnapshot().then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">) =&gt;</span></span> { db.saveSnapshot().then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(status.err) <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(err) }) }) } <span class="hljs-comment"><span class="hljs-comment">/** *     await * ..    resolve()   */</span></span> saveSnapshot()</code> </pre> <br><p>  En resumen, no est√° tratando de evitar el sincronismo, pero decide cu√°ndo usar la ejecuci√≥n de c√≥digo s√≠ncrono y cu√°ndo usarlo de forma as√≠ncrona.  Y es realmente conveniente.  Especialmente cuando conoces las posibilidades de <strong>Promise.all ()</strong> </p><br><p>  El motor de b√∫squeda de vuelos en s√≠ est√° dise√±ado de tal manera que env√≠a una solicitud a un segundo servidor que recopila y agrega datos, y luego recurre a √©l para obtener datos listos para emitir.  Las p√°ginas de direcci√≥n se utilizan para atraer tr√°fico org√°nico. </p><br><p>  Por ejemplo, para la consulta "Vuelos Mosc√∫ San Petersburgo" se emitir√° una p√°gina con la direcci√≥n <em>/ tickets / moscow / saint-petersburg /</em> , y necesita datos: </p><br><ol><li>  Precios de las aerol√≠neas en esta direcci√≥n para el mes actual </li><li>  Precios de las aerol√≠neas en esta direcci√≥n para el pr√≥ximo a√±o (precio promedio de cada mes durante los pr√≥ximos 12 meses) </li><li>  Programe vuelos en esta direcci√≥n </li><li>  Destinos populares desde la ciudad de despacho - desde Mosc√∫ (para vincular) </li><li>  Los destinos populares de la ciudad de llegada son desde San Petersburgo (para vincular) </li></ol><br><p>  En PHP, todas estas solicitudes se ejecutaron sincr√≥nicamente, una tras otra.  El tiempo promedio de respuesta de la API por solicitud es de 150-200 milisegundos.  Multiplicamos 200 por 5 y obtenemos, en promedio, un segundo solo para cumplir con las solicitudes al servidor con datos.  NodeJS tiene una gran funci√≥n <strong>llamada Promise.all</strong> , que ejecuta todas las solicitudes en paralelo, pero escribe el resultado uno por uno.  Por ejemplo, el c√≥digo de ejecuci√≥n para las cinco solicitudes anteriores se ver√≠a as√≠: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> [montlyPrices, yearlyPrices, flightsSchedule, originPopulars, destPopulars] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([ getMontlyPrices(), getYearlyPrices(), getFlightSchedule(), getOriginPopulars(), getDestPopulars() ])</code> </pre> <br><p>  Y obtenemos todos los datos en 200-300 milisegundos, reduciendo el tiempo de generaci√≥n de datos para la p√°gina de 1-1.5 segundos a ~ 500 milisegundos. </p><br><h3 id="zaklyuchenie">  Conclusi√≥n </h3><br><p>  El cambio de PHP a NodeJS me ayud√≥ a familiarizarme con JavaScript asincr√≥nico, aprender a trabajar con promesas y async / wait.  Despu√©s de que el motor fue reescrito, la velocidad de carga de la p√°gina se optimiz√≥ y difiri√≥ dr√°sticamente de los resultados que mostr√≥ el motor en PHP.  En este art√≠culo, tambi√©n podr√≠amos hablar sobre c√≥mo se usan los m√≥dulos simples para trabajar con el cach√© (Redis) y pg-promise (PostgreSQL) en NodeJS y compararlos con Memcached y php-pgsql, pero este art√≠culo result√≥ ser bastante voluminoso.  Y conociendo mi "talento" para escribir, tambi√©n result√≥ estar mal estructurada.  El prop√≥sito de este art√≠culo es atraer la atenci√≥n de los desarrolladores que todav√≠a est√°n trabajando con PHP y no est√°n al tanto de las delicias de NodeJS y el desarrollo de aplicaciones basadas en la web utilizando un ejemplo de un proyecto de la vida real que alguna vez se escribi√≥ en PHP, pero debido a las preferencias su due√±o fue a otra plataforma. </p><br><p>  Espero haber podido transmitir mis pensamientos y m√°s o menos estructurado para expresarlos en este material.  Al menos lo intent√© :) </p><br><p>  Escriba cualquier comentario, amigable o enojado.  Contestar√© a cualquier constructivo. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/444400/">https://habr.com/ru/post/444400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444390/index.html">Sistema DeviceLock 8.3 DLP: ha pasado un a√±o, Billy, pero no has cambiado nada</a></li>
<li><a href="../444392/index.html">Radiaci√≥n: riesgos, seguridad, protecci√≥n.</a></li>
<li><a href="../444394/index.html">Linux Foundation lanza un nuevo proyecto DevOps con Jenkins y Spinnaker</a></li>
<li><a href="../444396/index.html">Stand de Epson en ISE 2019: la exposici√≥n ha pasado, las impresiones permanecen</a></li>
<li><a href="../444398/index.html">¬øPor qu√© las tiendas no alimentarias necesitan una organizaci√≥n de autoservicio?</a></li>
<li><a href="../444402/index.html">C√≥digo de reacci√≥n dividido en 2019</a></li>
<li><a href="../444404/index.html">¬øPor qu√© tenemos miedo a los robots?</a></li>
<li><a href="../444406/index.html">Italia digital. Que y como funciona</a></li>
<li><a href="../444408/index.html">Apple lanz√≥ ayer nuevos iPads y tiene preguntas.</a></li>
<li><a href="../444410/index.html">Mapas de red. Una breve descripci√≥n del software para construir mapas de red</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>