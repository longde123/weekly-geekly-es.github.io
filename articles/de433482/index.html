<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§üüèº üåà üí† Django unter dem Mikroskop üíí üåò üëè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wenn sie nach dem Bericht von Artyom Malyshev ( Proofit404 ) einen Film machen, dann ist der Regisseur Quentin Tarantino - er hat bereits einen Film √º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Django unter dem Mikroskop</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/433482/">  Wenn sie nach dem Bericht von Artyom Malyshev ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Proofit404</a> ) einen Film machen, dann ist der Regisseur Quentin Tarantino - er hat bereits einen Film √ºber Django gedreht, er wird auch den zweiten drehen.  Alle Details aus der Lebensdauer der internen Django-Mechanismen vom ersten Byte der HTTP-Anforderung bis zum letzten Byte der Antwort.  Die Extravaganz von Parser-Formularen, die actionreiche Kompilierung von SQL, Spezialeffekte bei der Implementierung der Template-Engine f√ºr HTML.  Wer verwaltet den Verbindungspool und wie?  All dies in chronologischer Reihenfolge der Verarbeitung von WSGI-Objekten.  Auf allen Bildschirmen des Landes - die Dekodierung "Django unter dem Mikroskop". <br><br><img src="https://habrastorage.org/webt/np/fq/rq/npfqrqbbgfwn2lktbgdq9h4xhgg.jpeg"><br><br>  <strong>√úber den Sprecher: Artyom Malyshev</strong> ist der Gr√ºnder des Dry Python-Projekts und der Hauptentwickler von Django Channels Version 1.0.  Er schreibt seit 5 Jahren Python und hat bei der Organisation von Python Rannts Treffen in Nischni Nowgorod mitgewirkt.  Artyom ist Ihnen m√∂glicherweise unter dem Spitznamen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">PROOFIT404 bekannt</a> .  Die Pr√§sentation des Berichts wird <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> gespeichert. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/AvGl7Vi2yT4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Es war einmal, wir haben die alte Version von Django ver√∂ffentlicht.  Dann sah sie unheimlich und traurig aus. <br><br><img src="https://habrastorage.org/webt/yv/i5/a9/yvi5a9ueicvuhwgsyf8npzvojne.jpeg"><br><br>  Sie haben gesehen, dass <code>self_check</code> bestanden hat, wir haben alles korrekt installiert, alles hat funktioniert und jetzt k√∂nnen Sie Code schreiben.  Um dies alles zu erreichen, mussten wir den <code>django-admin runserver</code> . <br><br><pre> <code class="plaintext hljs">$ django-admin runserver Performing system checks‚Ä¶ System check identified no issues (0 silenced). You have unapplied migrations; your app may not work properly until they are applied. Run 'python manage.py migrate1 to apply them. August 21, 2018 - 15:50:53 Django version 2.1, using settings 'mysite.settings' Starting development server at http://127.0.0.1:8000/Quit the server with CONTROL-C.</code> </pre><br>  Der Prozess startet, verarbeitet HTTP-Anforderungen und all die Magie geschieht im Inneren und der gesamte Code, den wir Benutzern als Site anzeigen m√∂chten, wird ausgef√ºhrt. <br><br><h2>  Installation <br></h2><br>  <code>django-admin</code> auf dem System angezeigt, wenn wir Django beispielsweise mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">pip, dem Paketmanager,</a> installieren. <br><br><pre> <code class="python hljs">$ pip install Django <span class="hljs-comment"><span class="hljs-comment"># setup.py from setuptools import find_packages, setup setup( name='Django', entry_points={ 'console_scripts': [ 'django-admin = django.core.management:execute_from_command_line' ] }, )</span></span></code> </pre><br>  <code>entry_points setuptools</code> angezeigt, das auf die Funktion <code>execute_from_command_line</code> verweist.  Diese Funktion ist ein Einstiegspunkt f√ºr jede Operation mit Django f√ºr jeden aktuellen Prozess. <br><br><h3>  Bootstrap <br></h3><br>  Was passiert innerhalb einer Funktion?  <strong>Bootstrap</strong> , der in zwei Iterationen unterteilt ist. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management django.setup().</span></span></code> </pre><br><h4>  Einstellungen konfigurieren <br></h4><br>  Das erste ist das <strong>Lesen von Konfigurationen</strong> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> django.conf.global_settings import_module(os.environ[<span class="hljs-string"><span class="hljs-string">"DJANGO_SETTINGS_MODULE"</span></span>])</code> </pre><br>  Die Standardeinstellungen <code>global_settings</code> . Anschlie√üend versuchen wir, aus der Umgebungsvariablen das Modul mit <code>DJANGO_SETTINGS_MODULE</code> zu finden, das der Benutzer geschrieben hat.  Diese Einstellungen werden in einem Namensraum zusammengefasst. <br><br>  Jeder, der in Django mindestens "Hallo Welt" schreibt, wei√ü, dass es <code>INSTALLED_APPS</code> - wo wir den Benutzercode schreiben. <br><br><h4>  Apps f√ºllen <br></h4><br>  Im zweiten Teil werden alle diese Anwendungen, im Wesentlichen Pakete, einzeln iteriert.  Wir erstellen f√ºr jede Konfiguration, importieren Modelle f√ºr die Arbeit mit einer Datenbank und √ºberpr√ºfen Modelle auf Integrit√§t.  Au√üerdem f√ºhrt das Framework <code>Check</code> , dh es √ºberpr√ºft, ob jedes Modell einen Prim√§rschl√ºssel hat, alle Fremdschl√ºssel auf vorhandene Felder verweisen und dass das Nullfeld nicht in das BooleanField geschrieben ist, sondern das NullBooleanField verwendet wird. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> settings.INSTALLED_APPS: cfg = AppConfig.create(entry) cfg.import_models()</code> </pre><br>  Dies ist die Mindestpr√ºfung f√ºr Modelle, f√ºr das Admin-Panel und f√ºr alles andere - ohne Verbindung zur Datenbank, ohne etwas sehr Kompliziertes und Spezifisches.  Zu diesem Zeitpunkt wei√ü Django noch nicht, welchen Befehl Sie ausf√ºhren sollen, <code>runserver</code> unterscheidet die <code>migrate</code> von <code>runserver</code> oder <code>shell</code> . <br><br>  Dann befinden wir uns in einem Modul, das versucht, anhand von Befehlszeilenargumenten zu erraten, welchen Befehl wir ausf√ºhren m√∂chten und in welcher Anwendung er liegt. <br><br><h2>  Verwaltungsbefehl <br></h2><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management subcommand = sys.argv[1] app_name = find(pkgutils.iter_modules(settings.INSTALLED_APPS)) module = import_module( '%s.management.commands.%s' % (app_name, subcommand) ) cmd = module.Command() cmd.run_from_argv(self.argv)</span></span></code> </pre><br>  In diesem Fall verf√ºgt das Runserver-Modul √ºber ein integriertes <code>django.core.management.commands.runserver</code> Modul.  Nach dem Import des Moduls wird gem√§√ü Konvention die globale Klasse <code>Command</code> aufgerufen, instanziiert und wir sagen: " <em>Ich habe Sie gefunden, hier haben Sie die Befehlszeilenargumente, die der Benutzer √ºbergeben hat, machen Sie etwas mit ihnen</em> ." <br><br>  Als n√§chstes gehen wir zum Runserver-Modul und sehen, dass <b>Django aus "Regexp und Sticks" besteht</b> , wor√ºber ich heute ausf√ºhrlich sprechen werde: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management.commands.runserver naiveip_re = re.compile(r"""^(?: (?P&lt;addr&gt; (?P&lt;ipv4&gt;\d{1,3}(?:\.\d{1,3}){3}) | # IPv4 address (?P&lt;ipv6&gt;\[[a-fA-F0-9:]+\]) | # IPv6 address (?P&lt;fqdn&gt;[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*) # FQDN ):)?(?P&lt;port&gt;\d+)$""", re.X)</span></span></code> </pre><br><h3>  Befehle <br></h3><br>  Scrollen Sie eineinhalb Bildschirme nach unten - schlie√ülich kommen wir zur Definition unseres Teams, das den Server startet. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.management.commands.runserver class Command(BaseCommand): def handle(self, *args, **options): httpd = WSGIServer(*args, **options) handler = WSGIHandler() httpd.set_app(handler) httpd.serve_forever()</span></span></code> </pre><br>  <code>BaseCommand</code> f√ºhrt eine minimale <code>BaseCommand</code> von Operationen aus, damit Befehlszeilenargumente zu Argumenten f√ºr den Aufruf der <code>**options</code> <code>*args</code> und <code>**options</code> .  Wir sehen, dass hier die WSGI-Serverinstanz erstellt wird, der globale WSGIHandler auf diesem WSGI-Server installiert ist - genau das ist <strong>God Object Django</strong> .  Wir k√∂nnen sagen, dass dies die einzige Instanz des Frameworks ist.  Die Instanz wird global auf dem Server installiert - √ºber die <code>set application</code> und lautet: "In Ereignisschleife drehen, Anforderungen ausf√ºhren." <br><br><blockquote>  Es gibt immer irgendwo eine Ereignisschleife und einen Programmierer, der ihm Aufgaben gibt. <br></blockquote><br><h2>  WSGI-Server <br></h2><br>  Was ist <strong>WSGIHandler</strong> ?  WSGI ist eine Schnittstelle, mit der Sie HTTP-Anforderungen mit einem Mindestabstraktionsgrad verarbeiten k√∂nnen. Sie sieht aus wie eine Funktion. <br><br><h3>  WSGI-Handler <br></h3><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.wsgi class WSGIHandler: def __call__(self, environ, start_response): signals.request_started.send() request = WSGIRequest(environ) response = self.get_response(request) start_response(response.status, response.headers) return response</span></span></code> </pre><br>  Hier ist es beispielsweise eine Instanz einer Klasse, f√ºr die ein <code>call</code> definiert ist.  Er wartet auf seinen W√∂rterbucheintrag, in dem Header als Bytes und als File-Handler dargestellt werden.  Der Handler wird ben√∂tigt, um den <code>&lt;body&gt;</code> der Anforderung zu lesen.  Der Server selbst gibt auch <code>start_response</code> damit wir <code>response.headers</code> und seinen Header, z. B. status, in einem Bundle senden k√∂nnen. <br><br>  Au√üerdem k√∂nnen wir den Antworttext √ºber das Antwortobjekt an den Server √ºbergeben.  <strong>Response</strong> ist ein Generator, √ºber den Sie iterieren k√∂nnen. <br><br>  Alle Server, die f√ºr WSGI geschrieben wurden - Gunicorn, uWSGI, Waitress - arbeiten an dieser Schnittstelle und sind austauschbar.  Wir ziehen jetzt einen Server f√ºr die Entwicklung in Betracht, aber jeder Server kommt zu dem Punkt, dass er in Django die Umgebung und den R√ºckruf durchbricht. <br><br><h2>  Was ist in Gott Objekt? <br></h2><br>  Was passiert in dieser globalen Gottobjektfunktion in Django? <br><br><ul><li>  ANFRAGE. </li><li>  MITTELWAREN. </li><li>  ROUTING-Anfrage zum Anzeigen. </li><li>  VIEW - Benutzercode-Verarbeitung in der Ansicht. </li><li>  FORMULAR - mit Formularen arbeiten. </li><li>  ORM. </li><li>  SCHABLONE </li><li>  ANTWORT. </li></ul><br>  Alle Maschinen, die wir von Django wollen, finden in einer einzigen Funktion statt, die √ºber das gesamte Framework verteilt ist. <br><br><h3>  Anfrage <br></h3><br>  Wir verpacken die WSGI-Umgebung, bei der es sich um ein einfaches W√∂rterbuch handelt, in ein spezielles Objekt, um die Arbeit mit der Umgebung zu vereinfachen.  Zum Beispiel ist es bequemer, die L√§nge einer Benutzeranforderung durch Arbeiten mit etwas √§hnlichem wie einem W√∂rterbuch herauszufinden, als mit einer Byte-Zeichenfolge, die analysiert werden muss, und darin nach Schl√ºsselwerteintr√§gen zu suchen.  Wenn ich mit Cookies arbeite, m√∂chte ich auch nicht manuell berechnen, ob die Speicherdauer abgelaufen ist oder nicht, und sie irgendwie interpretieren. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.wsgi class WSGIRequest(HttpRequest): @cached_property def GET(self): return QueryDict(self.environ['QUERY_STRING']) @property def POST(self): self._load_post_and_files() return self._post @cached_property def COOKIES(self): return parse_cookie(self.environ['HTTP_COOKIE'])</span></span></code> </pre><br>  Die Anforderung enth√§lt Parser sowie eine Reihe von Handlern zur Steuerung der Verarbeitung des Hauptteils der POST-Anforderung: ob es sich um eine Datei im Speicher oder um eine tempor√§re Datei im Speicher auf der Festplatte handelt.  Alles wird innerhalb der Anfrage entschieden.  Request in Django ist auch ein Aggregatorobjekt, in das alle Middlewares die Informationen einf√ºgen k√∂nnen, die wir √ºber die Sitzung, Authentifizierung und Benutzerautorisierung ben√∂tigen.  Wir k√∂nnen sagen, dass dies auch ein Gottobjekt ist, aber kleiner. <br><br>  Weitere Anfrage geht an Middleware. <br><br><h3>  Middlewares <br></h3><br>  <strong>Middleware</strong> ist ein Wrapper, der andere Funktionen wie einen Dekorateur umschlie√üt.  Bevor wir die Kontrolle √ºber die Middleware aufgeben, geben wir in der Aufrufmethode eine Antwort oder rufen eine bereits verpackte Middleware auf. <br><br>  So sieht Middleware aus Sicht eines Programmierers aus. <br><br><h4>  Einstellungen <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># settings.py MIDDLEWARE = [ 'django.middleware.security.SecurityMiddleware', 'django.middleware.csrf.CsrfViewMiddleware', 'django.contrib.sessions.middleware.SessionMiddleware', 'django.contrib.auth.middleware.AuthenticationMiddleware', ]</span></span></code> </pre><br><h4>  Definieren <br></h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Middleware</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, get_response=None)</span></span></span><span class="hljs-function">:</span></span> self.get_response = get_response <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__call__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.get_response(request)</code> </pre><br>  Aus der Sicht von Django sehen Middlewares wie eine Art Stapel aus: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.base def load_middleware(self): handler = convert_exception_to_response(self._get_response) for middleware_path in reversed(settings.MIDDLEWARE): middleware = import_string(middleware_path) instance = middleware(handler) handler = convert_exception_to_response(instance) self._middleware_chain = handler</span></span></code> </pre><br><h4>  Bewerben <br></h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> set_urlconf(settings.ROOT_URLCONF) response = self._middleware_chain(request) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response</code> </pre><br>  Wir nehmen die anf√§ngliche Funktion <code>get_response</code> und verpacken sie in einen Handler, der beispielsweise <code>permission error</code> und <code>not found error</code> in den richtigen HTTP-Code √ºbersetzt.  Wir verpacken alles in die Middleware selbst aus der Liste.  Der Middlewares-Stapel w√§chst und jeder n√§chste schlie√üt den vorherigen ein.  Dies ist sehr √§hnlich zum Anwenden des gleichen Stapels von Dekorateuren auf alle Ansichten in einem Projekt, nur zentral.  Sie m√ºssen nicht herumgehen und die Wrapper mit Ihren H√§nden entsprechend dem Projekt anordnen, alles ist bequem und logisch. <br><br>  Wir gingen durch 7 Kreise von Middlewares, unsere Anfrage √ºberlebte und beschloss, sie im Blick zu verarbeiten.  Weiter kommen wir zum Routing-Modul. <br><br><h3>  Routing <br></h3><br>  Hier entscheiden wir, welcher Handler f√ºr eine bestimmte Anfrage aufgerufen werden soll.  Und das ist gel√∂st: <br><br><ul><li>  basierend auf URL; </li><li>  in der WSGI-Spezifikation, in der request.path_info aufgerufen wird. </li></ul><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.core.handlers.base def _get_response(self, request): resolver = get_resolver() view, args, kwargs = resolver.resolve(request.path_info) response = view(request, *args, **kwargs) return response</span></span></code> </pre><br><h4>  Urls <br></h4><br>  Wir nehmen den Resolver, geben ihm die aktuelle Anforderungs-URL und erwarten, dass er die Ansichtsfunktion selbst zur√ºckgibt, und von derselben URL erhalten wir die Argumente, mit denen view aufgerufen werden soll.  Dann ruft <code>get_response</code> view auf, behandelt Ausnahmen und macht etwas damit. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># urls.py urlpatterns = [ path('articles/2003/', views.special_case_2003), path('articles/&lt;int:year&gt;/', views.year_archive), path('articles/&lt;int:year&gt;/&lt;int:month&gt;/', views.month_archive) ]</span></span></code> </pre><br><h4>  Resolver <br></h4><br>  So sieht der Resolver aus: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.urls.resolvers _PATH_RE = re.compile( r'&lt;(?:(?P&lt;converter&gt;[^&gt;:]+):)?(?P&lt;parameter&gt;\w+)&gt;' ) def resolve(self, path): for pattern in self.url_patterns: match = pattern.search(path) if match: return ResolverMatch( self.resolve(match[0]) ) raise Resolver404({'path': path})</span></span></code> </pre><br>  Dies ist ebenfalls regul√§r, aber rekursiv.  Es geht in Teile der URL, sucht nach dem, was der Benutzer will: andere Benutzer, Beitr√§ge, Blogs oder ist es eine Art Konverter, zum Beispiel ein bestimmtes Jahr, das aufgel√∂st, Argumente eingegeben und in int umgewandelt werden muss. <br><br>  Es ist charakteristisch, dass die Rekursionstiefe der Aufl√∂sungsmethode immer gleich der Anzahl der Argumente ist, mit denen view aufgerufen wird.  Wenn ein Fehler aufgetreten ist und wir keine bestimmte URL gefunden haben, tritt ein nicht gefundener Fehler auf. <br><br>  Dann kommen wir endlich in Sicht - der Code, den der Programmierer geschrieben hat. <br><br><h3>  Anzeigen <br></h3><br>  In seiner einfachsten Darstellung ist es eine Funktion, die eine Anfrage von einer Antwort zur√ºckgibt, aber darin f√ºhren wir logische Aufgaben aus: "f√ºr, wenn, eines Tages" - viele sich wiederholende Aufgaben.  Django bietet uns eine klassenbasierte Ansicht, in der Sie bestimmte Details angeben k√∂nnen. Das gesamte Verhalten wird von der Klasse selbst im richtigen Format interpretiert. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.views.generic.edit class ContactView(FormView): template_name = 'contact.html' form_class = ContactForm success_url = '/thanks/'</span></span></code> </pre><br><h4>  Methodenflussdiagramm <br></h4><br><pre> <code class="python hljs">self.dispatch() self.post() self.get_form() self.form_valid() self.render_to_response()</code> </pre><br>  Die <code>dispatch</code> dieser Instanz befindet sich bereits in der URL-Zuordnung anstelle einer Funktion.  Der Versand basierend auf dem HTTP-Verb versteht, welche Methode aufgerufen werden soll: POST kam zu uns und wir m√∂chten h√∂chstwahrscheinlich das Formularobjekt instanziieren. Wenn das Formular g√ºltig ist, speichern Sie es in der Datenbank und zeigen Sie die Vorlage an.  Dies alles geschieht durch die gro√üe Anzahl von Mixins, aus denen diese Klasse besteht. <br><br><h3>  Formular <br></h3><br>  Das Formular muss aus dem Socket gelesen werden, bevor es in die Django-Ansicht gelangt - √ºber denselben Datei-Handler, der sich in der WSGI-Umgebung befindet.  Formulardaten sind ein Bytestream, in dem Trennzeichen beschrieben werden - wir k√∂nnen diese Bl√∂cke lesen und etwas daraus machen.  Es kann eine Schl√ºssel-Wert-Entsprechung sein. Wenn es sich um ein Feld, einen Teil einer Datei oder ein anderes Feld handelt, ist alles gemischt. <br><br><pre> <code class="python hljs">Content-Type: multipart/form-data;boundary=<span class="hljs-string"><span class="hljs-string">"boundary"</span></span> --boundary name=<span class="hljs-string"><span class="hljs-string">"field1"</span></span> value1 --boundary name=<span class="hljs-string"><span class="hljs-string">"field2"</span></span>; value2</code> </pre><br><h4>  Parser <br></h4><br>  Der Parser besteht aus 3 Teilen. <br><br>  Der Chunk-Iterator, der die erwarteten Messwerte aus dem Bytestream erstellt, wird zu einem Iterator, der <code>boundaries</code> erzeugen kann.  Es garantiert, dass wenn etwas zur√ºckkehrt, es eine Grenze ist.  Dies ist erforderlich, damit im Parser der Verbindungsstatus nicht gespeichert, vom Socket gelesen oder nicht gelesen werden muss, um die Logik der Datenverarbeitung zu minimieren. <br><br>  Als n√§chstes wird der Generator in <strong>LazyStream eingeschlossen</strong> , der erneut eine Objektdatei daraus erstellt, jedoch mit dem erwarteten Messwert.  Der Parser kann also bereits Byte-Teile durchlaufen und daraus einen Schl√ºsselwert erstellen. <br><br>  <strong>Feld und Daten hier sind immer Zeichenfolgen</strong> .  Wenn wir eine Datenzeit im ISO-Format erhalten haben, erh√§lt das Django-Formular (das vom Programmierer geschrieben wurde) unter Verwendung bestimmter Felder, z. B. Zeitstempel. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.http.multipartparser self._post = QueryDict(mutable=True) stream = LazyStream(ChunkIter(self._input_data)) for field, data in Parser(stream): self._post.append(field, force_text(data))</span></span></code> </pre><br>  Au√üerdem m√∂chte sich das Formular h√∂chstwahrscheinlich in einer Datenbank speichern, und hier beginnt Django ORM. <br><br><h3>  ORM <br></h3><br>  Ungef√§hr durch solche DSL werden Anforderungen f√ºr ORM ausgef√ºhrt: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># models.py Entry.objects.exclude( pub_date__gt=date(2005, 1, 3), headline='Hello', )</span></span></code> </pre><br>  Mit Schl√ºsseln k√∂nnen Sie √§hnliche SQL-Ausdr√ºcke erfassen: <br><br><pre> <code class="python hljs">SELECT * WHERE NOT (pub_date &gt; <span class="hljs-string"><span class="hljs-string">'2005-1-3'</span></span> AND headline = <span class="hljs-string"><span class="hljs-string">'Hello'</span></span>)</code> </pre><br>  Wie l√§uft das <br><br><h4>  Abfragesatz <br></h4><br>  Die <code>exclude</code> hat ein <code>Query</code> unter der Haube.  Dem Objekt werden Argumente an die Funktion √ºbergeben, und es wird eine Hierarchie von Objekten erstellt, von denen jedes sich selbst als Zeichenfolge in ein separates Teil der SQL-Abfrage verwandeln kann. <br><br>  Beim Durchlaufen des Baums fragt jeder der Abschnitte seine untergeordneten Knoten ab, empf√§ngt verschachtelte SQL-Abfragen, und als Ergebnis k√∂nnen wir SQL als Zeichenfolge erstellen.  Beispielsweise ist der Schl√ºsselwert kein separates SQL-Feld, sondern wird mit dem Wertwert verglichen.  Die Verkettung und Ablehnung von Abfragen funktioniert genauso wie eine rekursive Baumdurchquerung, f√ºr die f√ºr jeden Knoten eine Umwandlung in SQL aufgerufen wird. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.models.query sql.Query(Entry).where.add( ~Q( Q(F('pub_date') &gt; date(2005, 1, 3)) &amp; Q(headline='Hello') ) )</span></span></code> </pre><br><h4>  Compiler <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.models.expressions class Q(tree.Node): AND = 'AND' OR = 'OR' def as_sql(self, compiler, connection): return self.template % self.field.get_lookup('gt')</span></span></code> </pre><br><h3>  Ausgabe <br></h3><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>Q(headline=<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># headline = 'Hello' &gt;&gt;&gt; F('pub_date') # pub_date &gt;&gt;&gt; F('pub_date') &gt; date(2005, 1, 3) # pub_date &gt; '2005-1-3' &gt;&gt;&gt; Q(...) &amp; Q(...) # ... AND ... &gt;&gt;&gt; ~Q(...) # NOT ‚Ä¶</span></span></code> </pre><br>  An diese Methode wird ein kleiner Helfer-Compiler √ºbergeben, der den MySQL-Dialekt von PostgreSQL unterscheiden und den syntaktischen Zucker, der im Dialekt einer bestimmten Datenbank verwendet wird, korrekt anordnen kann. <br><br><h3>  DB-Routing <br></h3><br>  Wenn wir die SQL-Abfrage erhalten haben, klopft das Modell an das DB-Routing und fragt, in welcher Datenbank es sich befindet.  In 99% der F√§lle handelt es sich um die Standarddatenbank, in den restlichen 1% um eine eigene. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.utils class ConnectionRouter: def db_for_read(self, model, **hints): if model._meta.app_label == 'auth': return 'auth_db'</span></span></code> </pre><br>  Durch das Umschlie√üen eines Datenbanktreibers mit einer bestimmten Bibliotheksschnittstelle wie Python MySQL oder Psycopg2 wird ein universelles Objekt erstellt, mit dem Django arbeiten kann.  Es gibt einen Wrapper f√ºr Cursor, einen Wrapper f√ºr Transaktionen. <br><br><h4>  Pool verbinden <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.db.backends.base.base class BaseDatabaseWrapper: def commit(self): self.validate_thread_sharing() self.validate_no_atomic_block() with self.wrap_database_errors: return self.connection.commit()</span></span></code> </pre><br>  In diesem speziellen Zusammenhang senden wir Anforderungen an den Socket, der an die Datenbank klopft, und warten auf die Ausf√ºhrung.  Der Wrapper √ºber der Bibliothek liest die menschliche Antwort aus der Datenbank in Form eines Datensatzes, und Django sammelt die Modellinstanz aus diesen Daten in Python-Typen.  Dies ist keine komplizierte Iteration. <br><br>  Wir haben etwas in die Datenbank geschrieben, etwas gelesen und beschlossen, dem Benutzer √ºber die HTML-Seite davon zu erz√§hlen.  Zu diesem Zweck verf√ºgt Django √ºber eine Community-unbeliebte Vorlagensprache, die nur in einer HTML-Datei wie eine Programmiersprache aussieht. <br><br><h3>  Vorlage <br></h3><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.template.loader <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render_to_string render_to_string(<span class="hljs-string"><span class="hljs-string">'my_template.html'</span></span>, {<span class="hljs-string"><span class="hljs-string">'entries'</span></span>: ...})</code> </pre><br><h4>  Code <br></h4><br><pre> <code class="python hljs">&lt;ul&gt; {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> entries %} &lt;li&gt;{{ entry.name }}&lt;/li&gt; {% endfor %} &lt;/ul&gt;</code> </pre><br><h4>  Parser <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.base BLOCK_TAG_START = '{%' BLOCK_TAG_END = '%}' VARIABLE_TAG_START = '{{' VARIABLE_TAG_END = '}}' COMMENT_TAG_START = '{#' COMMENT_TAG_END = '#}' tag_re = (re.compile('(%s.*?%s|%s.*?%s|%s.*?%s)' % (re.escape(BLOCK_TAG_START), re.escape(BLOCK_TAG_END), re.escape(VARIABLE_TAG_START), re.escape(VARIABLE_TAG_END), re.escape(COMMENT_TAG_START), re.escape(COMMENT_TAG_END))))</span></span></code> </pre><br>  √úberraschung - wieder regexp.  Erst am Ende sollte ein Komma stehen, und die Liste wird weit unten stehen.  Dies ist wahrscheinlich der schwierigste regul√§re Ausdruck, den ich in diesem Projekt gesehen habe. <br><br><h3>  Lexer <br></h3><br>  Der Template-Handler und der Interpreter sind ziemlich einfach.  Es gibt einen Lexer, der Regexp verwendet, um Text in eine Liste kleiner Token zu √ºbersetzen. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.base def tokenize(self): for bit in tag_re.split(template_string): lineno += bit.count('\n') yield bit</span></span></code> </pre><br>  Wir durchlaufen die Liste der Token und schauen: ‚ÄûWer bist du?  Wickle dich in einen Tag-Knoten. ‚Äú  Wenn dies beispielsweise der Beginn eines <code>if</code> oder <code>for</code> oder <code>for</code> , √ºbernimmt der Tag-Handler den entsprechenden Handler.  Der <code>for</code> Handler selbst teilt dem Parser erneut mit: "Lesen Sie mir eine Liste der Token bis zum schlie√üenden Tag vor." <br><br>  Die Operation geht wieder zum Parser. <br><br><blockquote>  Ein Knoten, ein Tag und ein Parser sind gegenseitig rekursive Elemente, und die Tiefe der Rekursion entspricht normalerweise der Verschachtelung der Vorlage selbst durch Tags. <br></blockquote><br><h4>  Parser <br></h4><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> tokens: token = tokens.pop() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> token.startswith(BLOCK_TAG_START): <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> TagNode(token) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> token.startswith(VARIABLE_TAG_START): ...</code> </pre><br>  Der Tag-Handler gibt uns einen bestimmten Knoten, beispielsweise mit einer <code>for</code> Schleife, f√ºr die die <code>render</code> angezeigt wird. <br><br><h4>  F√ºr Schleife <br></h4><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># django.template.defaulttags @register.tag('for') def do_for(parser, token): args = token.split_contents() body = parser.parse(until=['endfor']) return ForNode(args, body)</span></span></code> </pre><br><h4>  F√ºr Knoten <br></h4><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForNode</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Node)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, context)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> context.push(): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.args: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> self.body.render(context)</code> </pre><br>  Die <code>render</code> ist ein Renderbaum.  Jeder obere Knoten kann zu einem Tochterknoten gehen und ihn zum Rendern auffordern.  Programmierer sind es gewohnt, einige Variablen in dieser Vorlage anzuzeigen.  Dies geschieht im <code>context</code> - es wird in Form eines regul√§ren W√∂rterbuchs dargestellt.  Dies ist ein Stapel von W√∂rterb√ºchern zum Emulieren eines Bereichs, wenn wir ein Tag eingeben.  Wenn der <code>context</code> selbst ein anderes Tag in der <code>for</code> Schleife √§ndert, werden die √Ñnderungen beim Verlassen der Schleife r√ºckg√§ngig gemacht.  Dies ist praktisch, da es schwierig ist, zu arbeiten, wenn alles global ist. <br><br><h3>  Antwort <br></h3><br>  Endlich haben wir unsere Zeile mit der HTTP-Antwort erhalten: <br><br><blockquote>  Hallo Welt! <br></blockquote><br>  Wir k√∂nnen dem Benutzer die Leitung geben. <br><br><ul><li>  Gibt diese Antwort aus der Ansicht zur√ºck. </li><li>  View listet Middleware auf. </li><li>  Middlewares diese Reaktion modifizieren, erg√§nzen und verbessern. </li><li>  Die Antwort beginnt innerhalb von WSGIHandler zu iterieren, wird teilweise in den Socket geschrieben und der Browser erh√§lt eine Antwort von unserem Server. </li></ul><br>  Alle ber√ºhmten Startups, die in Django geschrieben wurden, wie Bitbucket oder Instagram, begannen mit einem so kleinen Zyklus, den jeder Programmierer durchlief. <br><br>  All dies und eine Pr√§sentation bei Moscow Python Conf ++ sind erforderlich, damit Sie besser verstehen, was sich in Ihren H√§nden befindet und wie Sie es verwenden.  In jeder Magie gibt es einen gro√üen Teil des regul√§ren Ausdrucks, den Sie kochen m√ºssen. <br><br><blockquote>  Artyom Malyshev und 23 weitere gro√üartige Redner werden uns <strong>am 5. April</strong> auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Moskauer Python Conf ++ -</a> Konferenz erneut viele Denkanst√∂√üe und Diskussionen zum Thema Python geben.  Studieren Sie den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zeitplan</a> und nehmen Sie am Erfahrungsaustausch teil, um eine Vielzahl von Problemen mit Python zu l√∂sen. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de433482/">https://habr.com/ru/post/de433482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de433472/index.html">Unity 2018.3 ver√∂ffentlicht</a></li>
<li><a href="../de433474/index.html">Pylint von innen nach au√üen. Wie macht er das?</a></li>
<li><a href="../de433476/index.html">50 Selleriet√∂ne</a></li>
<li><a href="../de433478/index.html">Warum Django im Tinkoff Magazine ausgew√§hlt wird</a></li>
<li><a href="../de433480/index.html">Holivarny Geschichte √ºber Linter</a></li>
<li><a href="../de433486/index.html">Was nochmal? Die Wiederbelebung von Nicht-Bank-Debitkarten</a></li>
<li><a href="../de433488/index.html">Christmas Scrum Meetup UPD Broadcast Mitap</a></li>
<li><a href="../de433490/index.html">Creality CR-X 3D-Drucker√ºberpr√ºfung</a></li>
<li><a href="../de433494/index.html">10 englische Redewendungen, die Sie nie kennen werden</a></li>
<li><a href="../de433496/index.html">Staatliche Unternehmen verpflichten sich, bis 2022 auf inl√§ndische Software umzusteigen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>