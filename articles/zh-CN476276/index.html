<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ• ğŸ˜° ğŸš¨ åœ¨Goä¸Šç¼–å†™ä¸€ä¸ªç®€å•çš„å¹³è¡¡å™¨ â²ï¸ ğŸ‘Ÿ ğŸš¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è´Ÿè½½å¹³è¡¡å™¨åœ¨Webä½“ç³»ç»“æ„ä¸­èµ·ç€å…³é”®ä½œç”¨ã€‚ å®ƒä»¬ä½¿æ‚¨å¯ä»¥åœ¨å¤šä¸ªåç«¯ä¹‹é—´åˆ†é…è´Ÿè½½ï¼Œä»è€Œæé«˜å¯ä¼¸ç¼©æ€§ã€‚ å¹¶ä¸”ç”±äºæˆ‘ä»¬é…ç½®äº†å¤šä¸ªåç«¯ï¼Œå› æ­¤è¯¥æœåŠ¡å˜å¾—é«˜åº¦å¯ç”¨ï¼Œå› ä¸ºå¦‚æœä¸€å°æœåŠ¡å™¨å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆå¹³è¡¡å™¨å¯ä»¥é€‰æ‹©å¦ä¸€å°æ­£å¸¸å·¥ä½œçš„æœåŠ¡å™¨ã€‚ 

 åœ¨ä¸NGINXç­‰ä¸“ä¸šå¹³è¡¡å™¨ä¸€èµ·ç©è¿‡ä¹‹åï¼Œæˆ‘å°è¯•åˆ›å»ºä¸€ä¸ªç®€å•çš„å¹³è¡¡å™¨ä»¥æ±‚...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨Goä¸Šç¼–å†™ä¸€ä¸ªç®€å•çš„å¹³è¡¡å™¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/476276/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/t8/nm/ze/t8nmzevaswfyxtitu7xpx3ml-ho.jpeg"></div><br> è´Ÿè½½å¹³è¡¡å™¨åœ¨Webä½“ç³»ç»“æ„ä¸­èµ·ç€å…³é”®ä½œç”¨ã€‚ å®ƒä»¬ä½¿æ‚¨å¯ä»¥åœ¨å¤šä¸ªåç«¯ä¹‹é—´åˆ†é…è´Ÿè½½ï¼Œä»è€Œæé«˜å¯ä¼¸ç¼©æ€§ã€‚ å¹¶ä¸”ç”±äºæˆ‘ä»¬é…ç½®äº†å¤šä¸ªåç«¯ï¼Œå› æ­¤è¯¥æœåŠ¡å˜å¾—é«˜åº¦å¯ç”¨ï¼Œå› ä¸ºå¦‚æœä¸€å°æœåŠ¡å™¨å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆå¹³è¡¡å™¨å¯ä»¥é€‰æ‹©å¦ä¸€å°æ­£å¸¸å·¥ä½œçš„æœåŠ¡å™¨ã€‚ <br><br> åœ¨ä¸NGINXç­‰ä¸“ä¸šå¹³è¡¡å™¨ä¸€èµ·ç©è¿‡ä¹‹åï¼Œæˆ‘å°è¯•åˆ›å»ºä¸€ä¸ªç®€å•çš„å¹³è¡¡å™¨ä»¥æ±‚ä¹è¶£ã€‚ æˆ‘åœ¨Goä¸Šç¼–å†™äº†å®ƒï¼Œå®ƒæ˜¯æ”¯æŒå®Œå…¨å¹¶è¡Œæ€§çš„ç°ä»£è¯­è¨€ã€‚  Goä¸­çš„æ ‡å‡†åº“å…·æœ‰è®¸å¤šåŠŸèƒ½ï¼Œå¯è®©æ‚¨ç”¨æ›´å°‘çš„ä»£ç ç¼–å†™é«˜æ€§èƒ½çš„åº”ç”¨ç¨‹åºã€‚ å¦å¤–ï¼Œä¸ºäº†ä¾¿äºåˆ†å‘ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ <br><a name="habracut"></a><br><h2> æˆ‘ä»¬çš„å¹³è¡¡å™¨å¦‚ä½•è¿ä½œ </h2><br> ä½¿ç”¨ä¸åŒçš„ç®—æ³•åœ¨åç«¯ä¹‹é—´åˆ†é…è´Ÿè½½ã€‚ ä¾‹å¦‚ï¼š <br><br><ul><li>  Round Robin-è€ƒè™‘åˆ°æœåŠ¡å™¨çš„ç›¸åŒè®¡ç®—èƒ½åŠ›ï¼Œè´Ÿè½½å°†å¹³å‡åˆ†é…ã€‚ </li><li> åŠ æƒå¾ªç¯æ³•-æ ¹æ®å¤„ç†èƒ½åŠ›ï¼Œå¯ä»¥ä¸ºæœåŠ¡å™¨åˆ†é…ä¸åŒçš„æƒé‡ã€‚ </li><li> æœ€å°‘çš„è¿æ¥-è´Ÿè½½åˆ†å¸ƒåœ¨æ´»åŠ¨è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ä¹‹é—´ã€‚ </li></ul><br> åœ¨æˆ‘ä»¬çš„å¹³è¡¡å™¨ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†æœ€ç®€å•çš„ç®—æ³•-å¾ªç¯ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b3e/35c/751/b3e35c7510dc44451088756d14739161.png"></div><br><br><h2> å¾ªç¯èµ›é€‰æ‹” </h2><br> å¾ªç¯ç®—æ³•å¾ˆç®€å•ã€‚ å®ƒä¸ºæ‰€æœ‰è¡¨æ¼”è€…æä¾›äº†å®Œæˆä»»åŠ¡çš„æœºä¼šã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3b3/4a7/861/3b34a78610b7c1e2d22b85f0419700d2.png"></div><br>  <i>åœ¨Round Robinä¸­é€‰æ‹©æœåŠ¡å™¨ä»¥å¤„ç†ä¼ å…¥çš„è¯·æ±‚ã€‚</i> <br><br> å¦‚å›¾æ‰€ç¤ºï¼Œè¯¥ç®—æ³•å‘¨æœŸæ€§åœ°é€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨ã€‚ ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½<i>ç›´æ¥</i>é€‰æ‹©å®ƒä»¬ï¼Œå¯¹å§ï¼Ÿ <br><br> å¦‚æœæœåŠ¡å™¨åœ¨è¯´è°ï¼Ÿ æˆ‘ä»¬å¯èƒ½ä¸éœ€è¦å‘å…¶å‘é€æµé‡ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æˆ‘ä»¬å°†æœåŠ¡å™¨ç½®äºæ‰€éœ€çŠ¶æ€ä¹‹å‰ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨è¯¥æœåŠ¡å™¨ã€‚ å¿…é¡»å°†æµé‡ä»…å®šå‘åˆ°å·²å¯åŠ¨å¹¶æ­£åœ¨è¿è¡Œçš„æœåŠ¡å™¨ã€‚ <br><br><h2> å®šä¹‰ç»“æ„ </h2><br> æˆ‘ä»¬éœ€è¦è·Ÿè¸ªä¸åç«¯ç›¸å…³çš„æ‰€æœ‰è¯¦ç»†ä¿¡æ¯ã€‚ æ‚¨éœ€è¦çŸ¥é“ä»–æ˜¯å¦è¿˜æ´»ç€ï¼Œå¹¶è·Ÿè¸ªURLã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»¥ä¸‹ç»“æ„ï¼š <br><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Backend <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { URL *url.URL Alive <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> mux sync.RWMutex ReverseProxy *httputil.ReverseProxy }</code> </pre> <br> ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘å°†åœ¨åç«¯è§£é‡Šè¿™äº›å­—æ®µçš„å«ä¹‰ã€‚ <br><br> ç°åœ¨ï¼Œåœ¨å¹³è¡¡å™¨ä¸­ï¼Œæ‚¨éœ€è¦ä»¥æŸç§æ–¹å¼è·Ÿè¸ªæ‰€æœ‰åç«¯ã€‚ ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨Sliceå’Œå˜é‡è®¡æ•°å™¨ã€‚ åœ¨ServerPoolä¸­å®šä¹‰å®ƒï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ServerPool <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { backends []*Backend current <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span> }</code> </pre> <br><h2> ä½¿ç”¨åå‘ä»£ç† </h2><br> æ­£å¦‚æˆ‘ä»¬å·²ç»ç¡®å®šçš„é‚£æ ·ï¼Œå¹³è¡¡å™¨çš„æœ¬è´¨æ˜¯å°†æµé‡åˆ†é…åˆ°ä¸åŒçš„æœåŠ¡å™¨å¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚ æ­£å¦‚Goæ–‡æ¡£æ‰€è¿°ï¼š <br><br>  <i>ReverseProxyæ˜¯ä¸€ä¸ªHTTPå¤„ç†ç¨‹åºï¼Œå®ƒæ¥æ”¶ä¼ å…¥çš„è¯·æ±‚å¹¶å°†å…¶å‘é€åˆ°å¦ä¸€å°æœåŠ¡å™¨ï¼Œå°†å“åº”ä»£ç†å›ç»™å®¢æˆ·ç«¯ã€‚</i> <br><br> æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„ã€‚ æ— éœ€é‡æ–°å‘æ˜è½®å­ã€‚ æ‚¨å¯ä»¥ç®€å•åœ°é€šè¿‡<code>ReverseProxy</code>æµå¼ä¼ è¾“æˆ‘ä»¬çš„è¯·æ±‚ã€‚ <br><br><pre> <code class="go hljs">u, _ := url.Parse(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080"</span></span>) rp := httputil.NewSingleHostReverseProxy(u) <span class="hljs-comment"><span class="hljs-comment">// initialize your server and add this as handler http.HandlerFunc(rp.ServeHTTP)</span></span></code> </pre> <br> ä½¿ç”¨<code>httputil.NewSingleHostReverseProxy(url)</code>æ‚¨å¯ä»¥åˆå§‹åŒ–<code>ReverseProxy</code> ï¼Œè¯¥<code>httputil.NewSingleHostReverseProxy(url)</code>å°†å¹¿æ’­è¯·æ±‚åˆ°ä¼ é€’çš„<code>url</code> ã€‚ åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å‘é€åˆ°äº†æœ¬åœ°ä¸»æœºï¼š8080ï¼Œç»“æœè¢«å‘é€åˆ°äº†å®¢æˆ·ç«¯ã€‚ <br><br> å¦‚æœæŸ¥çœ‹ServeHTTPæ–¹æ³•çš„ç­¾åï¼Œåˆ™å¯ä»¥åœ¨å…¶ä¸­æ‰¾åˆ°HTTPå¤„ç†ç¨‹åºçš„ç­¾åã€‚ å› æ­¤ï¼Œæ‚¨å¯ä»¥å°†å…¶ä¼ é€’ç»™<code>http</code> <code>HandlerFunc</code> ã€‚ <br><br> å…¶ä»–ç¤ºä¾‹åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://golang.org/pkg/net/http/">æ–‡æ¡£ä¸­</a> ã€‚ <br><br> å¯¹äºæˆ‘ä»¬çš„å¹³è¡¡å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<code>Backend</code>çš„å…³è”<code>URL</code>æ¥å¯åŠ¨<code>ReverseProxy</code> ï¼Œä»¥ä¾¿ReverseProxyå°†è¯·æ±‚è·¯ç”±åˆ°<code>URL</code> ã€‚ <br><br><h2> æœåŠ¡å™¨é€‰æ‹©è¿‡ç¨‹ </h2><br> åœ¨ä¸‹ä¸€ä¸ªæœåŠ¡å™¨é€‰æ‹©æœŸé—´ï¼Œæˆ‘ä»¬éœ€è¦è·³è¿‡åŸºç¡€æœåŠ¡å™¨ã€‚ ä½†æ˜¯æ‚¨éœ€è¦ç»„ç»‡è®¡æ•°ã€‚ <br><br> è®¸å¤šå®¢æˆ·ç«¯å°†è¿æ¥åˆ°å¹³è¡¡å™¨ï¼Œå¹¶ä¸”å½“æ¯ä¸ªå®¢æˆ·ç«¯è¦æ±‚ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¼ è¾“æµé‡æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°ç«äº‰çŠ¶å†µã€‚ ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>mutex</code>é˜»æ­¢<code>ServerPool</code> ã€‚ ä½†è¿™å°†æ˜¯å¤šä½™çš„ï¼Œé™¤äº†æˆ‘ä»¬æ ¹æœ¬ä¸æƒ³é˜»å¡<code>ServerPool</code>ä¹‹å¤–ã€‚ æˆ‘ä»¬åªéœ€è¦å°†è®¡æ•°å™¨å¢åŠ ä¸€å³å¯ã€‚ <br><br> æ»¡è¶³è¿™äº›è¦æ±‚çš„æœ€ä½³è§£å†³æ–¹æ¡ˆæ˜¯åŸå­å¢é‡ã€‚  Goæ”¯æŒ<code>atomic</code>åŒ…ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *ServerPool)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NextIndex</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(atomic.AddUint64(&amp;s.current, <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) % <span class="hljs-keyword"><span class="hljs-keyword">uint64</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(s.backends))) }</code> </pre> <br> æˆ‘ä»¬ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼å¢åŠ 1ï¼Œç„¶åé€šè¿‡æ›´æ”¹æ•°ç»„çš„é•¿åº¦æ¥è¿”å›ç´¢å¼•ã€‚ è¿™æ„å‘³ç€è¯¥å€¼åº”å§‹ç»ˆåœ¨ä»0åˆ°æ•°ç»„é•¿åº¦çš„èŒƒå›´å†…ã€‚ æœ€åï¼Œæˆ‘ä»¬å°†å¯¹ç‰¹å®šç´¢å¼•è€Œä¸æ˜¯æ•´ä¸ªè®¡æ•°å™¨æ„Ÿå…´è¶£ã€‚ <br><br><h2> é€‰æ‹©å®æ—¶æœåŠ¡å™¨ </h2><br> æˆ‘ä»¬å·²ç»çŸ¥é“æˆ‘ä»¬çš„è¯·æ±‚åœ¨æ‰€æœ‰æœåŠ¡å™¨ä¸Šå¾ªç¯è½®æ¢ã€‚ è€Œä¸”æˆ‘ä»¬åªéœ€è¦è·³è¿‡ç©ºé—²çŠ¶æ€ã€‚ <br><br>  <code>GetNext()</code>å§‹ç»ˆè¿”å›ä¸€ä¸ªä»‹äº0åˆ°æ•°ç»„é•¿åº¦ä¹‹é—´çš„å€¼ã€‚ åœ¨ä»»ä½•æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœå®ƒæ˜¯ä¸æ´»åŠ¨çš„ï¼Œåˆ™éœ€è¦åœ¨æ•°ç»„ä¸­è¿›ä¸€æ­¥æœç´¢ä½œä¸ºå¾ªç¯çš„ä¸€éƒ¨åˆ†ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9c1/7a7/fc5/9c17a7fc56f9bf6c9e4583c29127aa55.png"></div><br>  <i>æˆ‘ä»¬éå†æ•°ç»„ã€‚</i> <br><br> å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æƒ³ä»ä¸‹ä¸€ä¸ªèŠ‚ç‚¹åˆ°åˆ—è¡¨çš„æœ«å°¾ã€‚ è¿™å¯ä»¥ä½¿ç”¨<code>next + length</code> ã€‚ ä½†æ˜¯è¦é€‰æ‹©ç´¢å¼•ï¼Œæ‚¨éœ€è¦å°†å…¶é™åˆ¶ä¸ºæ•°ç»„çš„é•¿åº¦ã€‚ ä½¿ç”¨ä¿®æ”¹æ“ä½œå¯ä»¥è½»æ¾å®Œæˆæ­¤æ“ä½œã€‚ <br><br> åœ¨æœç´¢è¿‡ç¨‹ä¸­æ‰¾åˆ°å¯ç”¨çš„æœåŠ¡å™¨åï¼Œåº”å°†å…¶æ ‡è®°ä¸ºå½“å‰æœåŠ¡å™¨ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// GetNextPeer returns next active peer to take a connection func (s *ServerPool) GetNextPeer() *Backend { // loop entire backends to find out an Alive backend next := s.NextIndex() l := len(s.backends) + next // start from next and move a full cycle for i := next; i &lt; l; i++ { idx := i % len(s.backends) // take an index by modding with length // if we have an alive backend, use it and store if its not the original one if s.backends[idx].IsAlive() { if i != next { atomic.StoreUint64(&amp;s.current, uint64(idx)) // mark the current one } return s.backends[idx] } } return nil }</span></span></code> </pre><br><h2> é¿å…åç«¯ç»“æ„ä¸­çš„ç«äº‰çŠ¶å†µ </h2><br> åœ¨è¿™é‡Œï¼Œæ‚¨éœ€è¦è®°ä½ä¸€ä¸ªé‡è¦çš„é—®é¢˜ã€‚  <code>Backend</code>ç»“æ„åŒ…å«ä¸€ä¸ªå˜é‡ï¼Œå¤šä¸ªgoroutineå¯ä»¥åŒæ—¶ä¿®æ”¹æˆ–æŸ¥è¯¢è¯¥å˜é‡ã€‚ <br><br> æˆ‘ä»¬çŸ¥é“ï¼Œgoroutineså¯¹å˜é‡çš„è¯»å–è¦æ¯”å¯¹å˜é‡çš„å†™å…¥è¦å¤šã€‚ å› æ­¤ï¼Œè¦åºåˆ—åŒ–å¯¹<code>Alive</code>è®¿é—®<code>Alive</code>æˆ‘ä»¬é€‰æ‹©<code>RWMutex</code> ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// SetAlive for this backend func (b *Backend) SetAlive(alive bool) { b.mux.Lock() b.Alive = alive b.mux.Unlock() } // IsAlive returns true when backend is alive func (b *Backend) IsAlive() (alive bool) { b.mux.RLock() alive = b.Alive b.mux.RUnlock() return }</span></span></code> </pre><br><h2> å¹³è¡¡è¦æ±‚ </h2><br> ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¶å®šä¸€ç§ç®€å•çš„æ–¹æ³•æ¥å¹³è¡¡æˆ‘ä»¬çš„è¯·æ±‚ã€‚ ä»…å½“æ‰€æœ‰æœåŠ¡å™¨éƒ½å´©æºƒæ—¶ï¼Œå®ƒæ‰ä¼šå¤±è´¥ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// lb load balances the incoming request func lb(w http.ResponseWriter, r *http.Request) { peer := serverPool.GetNextPeer() if peer != nil { peer.ReverseProxy.ServeHTTP(w, r) return } http.Error(w, "Service not available", http.StatusServiceUnavailable) }</span></span></code> </pre> <br> è¯¥æ–¹æ³•å¯ä»¥ç®€å•åœ°ä½œä¸º<code>HandlerFunc</code>ä¼ é€’ç»™HTTPæœåŠ¡å™¨ã€‚ <br><br><pre> <code class="go hljs">server := http.Server{ Addr: fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">":%d"</span></span>, port), Handler: http.HandlerFunc(lb), }</code> </pre><br><h2> æˆ‘ä»¬ä»…å°†æµé‡è·¯ç”±åˆ°æ­£åœ¨è¿è¡Œçš„æœåŠ¡å™¨ </h2><br> æˆ‘ä»¬çš„å¹³è¡¡å™¨æœ‰ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ã€‚ æˆ‘ä»¬ä¸çŸ¥é“æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚ è¦æ‰¾å‡ºç­”æ¡ˆï¼Œæ‚¨éœ€è¦æ£€æŸ¥æœåŠ¡å™¨ã€‚ æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼š <br><br><ul><li> æ´»åŠ¨ï¼šæ‰§è¡Œå½“å‰è¯·æ±‚ï¼Œæˆ‘ä»¬å‘ç°æ‰€é€‰æœåŠ¡å™¨æ²¡æœ‰å“åº”ï¼Œå¹¶å°†å…¶æ ‡è®°ä¸ºç©ºé—²ã€‚ </li><li> è¢«åŠ¨ï¼šæ‚¨å¯ä»¥æ¯éš”ä¸€æ®µæ—¶é—´å¯¹æœåŠ¡å™¨è¿›è¡Œpingæ“ä½œå¹¶æ£€æŸ¥çŠ¶æ€ã€‚ </li></ul><br><h2> ç§¯ææ£€æŸ¥æ­£åœ¨è¿è¡Œçš„æœåŠ¡å™¨ </h2><br> å¦‚æœ<code>ReverseProxy</code>ä»»ä½•é”™è¯¯<code>ReverseProxy</code>å¯åŠ¨<code>ErrorHandler</code>å›è°ƒå‡½æ•°ã€‚ è¿™å¯ä»¥ç”¨æ¥æ£€æµ‹æ•…éšœï¼š <br><br><pre> <code class="go hljs">proxy.ErrorHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(writer http.ResponseWriter, request *http.Request, e error)</span></span></span></span> { log.Printf(<span class="hljs-string"><span class="hljs-string">"[%s] %s\n"</span></span>, serverUrl.Host, e.Error()) retries := GetRetryFromContext(request) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> retries &lt; <span class="hljs-number"><span class="hljs-number">3</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> &lt;-time.After(<span class="hljs-number"><span class="hljs-number">10</span></span> * time.Millisecond): ctx := context.WithValue(request.Context(), Retry, retries+<span class="hljs-number"><span class="hljs-number">1</span></span>) proxy.ServeHTTP(writer, request.WithContext(ctx)) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-comment"><span class="hljs-comment">// after 3 retries, mark this backend as down serverPool.MarkBackendStatus(serverUrl, false) // if the same request routing for few attempts with different backends, increase the count attempts := GetAttemptsFromContext(request) log.Printf("%s(%s) Attempting retry %d\n", request.RemoteAddr, request.URL.Path, attempts) ctx := context.WithValue(request.Context(), Attempts, attempts+1) lb(writer, request.WithContext(ctx)) }</span></span></code> </pre> <br> åœ¨å¼€å‘æ­¤é”™è¯¯å¤„ç†ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†é—­åŒ…çš„åŠŸèƒ½ã€‚ è¿™ä½¿æˆ‘ä»¬å¯ä»¥å°†å¤–éƒ¨å˜é‡ï¼ˆä¾‹å¦‚æœåŠ¡å™¨URLï¼‰æ•è·åˆ°æˆ‘ä»¬çš„æ–¹æ³•ä¸­ã€‚ å¤„ç†ç¨‹åºæ£€æŸ¥é‡è¯•è®¡æ•°å™¨ï¼Œå¦‚æœå°äº3ï¼Œåˆ™æˆ‘ä»¬å†æ¬¡å°†åŒä¸€è¯·æ±‚å‘é€åˆ°åŒä¸€æœåŠ¡å™¨ã€‚ è¿™æ˜¯å› ä¸ºç”±äºä¸´æ—¶é”™è¯¯ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šä¸¢å¼ƒæˆ‘ä»¬çš„è¯·æ±‚ï¼Œä½†å¾ˆå¿«å°±ä¼šå˜å¾—å¯ç”¨ï¼ˆæœåŠ¡å™¨å¯èƒ½æ²¡æœ‰ç”¨äºæ–°å®¢æˆ·ç«¯çš„ç©ºé—²å¥—æ¥å­—ï¼‰ã€‚ å› æ­¤ï¼Œæ‚¨éœ€è¦åœ¨å¤§çº¦10æ¯«ç§’åä¸ºæ–°çš„å°è¯•è®¾ç½®å»¶è¿Ÿè®¡æ—¶å™¨ã€‚ å¯¹äºæ¯ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½ä¼šå¢åŠ å°è¯•æ¬¡æ•°ã€‚ <br><br> æ¯æ¬¡å°è¯•å¤±è´¥åï¼Œæˆ‘ä»¬å°†æœåŠ¡å™¨æ ‡è®°ä¸ºç©ºé—²ã€‚ <br><br> ç°åœ¨ï¼Œæ‚¨éœ€è¦ä¸ºåŒä¸€è¯·æ±‚åˆ†é…ä¸€ä¸ªæ–°æœåŠ¡å™¨ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨<code>context</code>åŒ…ä¸­çš„å°è¯•è®¡æ•°å™¨æ¥å®Œæˆæ­¤æ“ä½œã€‚ å¢åŠ å°è¯•æ¬¡æ•°åï¼Œæˆ‘ä»¬å°†å…¶ä¼ é€’ç»™<code>lb</code>ä»¥é€‰æ‹©æ–°æœåŠ¡å™¨æ¥å¤„ç†è¯·æ±‚ã€‚ <br><br> æˆ‘ä»¬ä¸èƒ½æ— é™æœŸåœ°æ‰§è¡Œæ­¤æ“ä½œï¼Œå› æ­¤åœ¨ç»§ç»­å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥<code>lb</code>æ˜¯å¦å·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ã€‚ <br><br> æ‚¨å¯ä»¥ç®€å•åœ°ä»è¯·æ±‚ä¸­è·å–å°è¯•è®¡æ•°å™¨ï¼Œå¦‚æœå°è¯•è®¡æ•°å™¨è¾¾åˆ°æœ€å¤§å€¼ï¼Œæˆ‘ä»¬å°†ä¸­æ–­è¯·æ±‚ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// lb load balances the incoming request func lb(w http.ResponseWriter, r *http.Request) { attempts := GetAttemptsFromContext(r) if attempts &gt; 3 { log.Printf("%s(%s) Max attempts reached, terminating\n", r.RemoteAddr, r.URL.Path) http.Error(w, "Service not available", http.StatusServiceUnavailable) return } peer := serverPool.GetNextPeer() if peer != nil { peer.ReverseProxy.ServeHTTP(w, r) return } http.Error(w, "Service not available", http.StatusServiceUnavailable) }</span></span></code> </pre> <br> è¿™æ˜¯ä¸€ä¸ªé€’å½’å®ç°ã€‚ <br><br><h2> ä½¿ç”¨ä¸Šä¸‹æ–‡åŒ… </h2><br>  <code>context</code>åŒ…å…è®¸æ‚¨åœ¨HTTPè¯·æ±‚ä¸­å­˜å‚¨æœ‰ç”¨çš„æ•°æ®ã€‚ æˆ‘ä»¬å°†ç§¯æåœ°ä½¿ç”¨å®ƒæ¥è·Ÿè¸ªä¸è¯·æ±‚ç›¸å…³çš„æ•°æ®- <code>Attempt</code>å’Œ<code>Retry</code>è®¡æ•°å™¨ã€‚ <br><br> é¦–å…ˆï¼Œæ‚¨éœ€è¦è®¾ç½®ä¸Šä¸‹æ–‡çš„é”®ã€‚ å»ºè®®ä¸è¦ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œè€Œåº”ä½¿ç”¨å”¯ä¸€çš„æ•°å€¼ã€‚  Goæœ‰ä¸€ä¸ªç”¨äºå¢é‡å®ç°å¸¸é‡çš„<code>iota</code>å…³é”®å­—ï¼Œæ¯ä¸ªå¸¸é‡éƒ½åŒ…å«ä¸€ä¸ªå”¯ä¸€å€¼ã€‚ è¿™æ˜¯å®šä¹‰æ•°å­—é”®çš„ç»ä½³è§£å†³æ–¹æ¡ˆã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ( Attempts <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = <span class="hljs-literal"><span class="hljs-literal">iota</span></span> Retry )</code> </pre> <br> ç„¶åï¼Œæ‚¨å¯ä»¥æå–å€¼ï¼Œå°±åƒæˆ‘ä»¬é€šå¸¸ä½¿ç”¨<code>HashMap</code> ã€‚ é»˜è®¤å€¼å¯èƒ½å–å†³äºå½“å‰æƒ…å†µã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// GetAttemptsFromContext returns the attempts for request func GetRetryFromContext(r *http.Request) int { if retry, ok := r.Context().Value(Retry).(int); ok { return retry } return 0 }</span></span></code> </pre><br><h2> è¢«åŠ¨æœåŠ¡å™¨éªŒè¯ </h2><br> è¢«åŠ¨æ£€æŸ¥å¯è¯†åˆ«å¹¶æ¢å¤æ‰è½çš„æœåŠ¡å™¨ã€‚ æˆ‘ä»¬ä»¥ä¸€å®šçš„æ—¶é—´é—´éš”å¯¹å…¶è¿›è¡Œpingæ“ä½œä»¥ç¡®å®šå…¶çŠ¶æ€ã€‚ <br><br> è¦pingé€šï¼Œè¯·å°è¯•å»ºç«‹TCPè¿æ¥ã€‚ å¦‚æœæœåŠ¡å™¨å“åº”ï¼Œåˆ™å°†å…¶æ ‡è®°ä¸ºå·¥ä½œã€‚ è¯¥æ–¹æ³•å¯ä»¥é€‚åº”äºè°ƒç”¨ç‰¹å®šç«¯ç‚¹ï¼Œä¾‹å¦‚<code>/status</code> ã€‚ ç¡®ä¿åœ¨åˆ›å»ºè¿æ¥åå…³é—­è¯¥è¿æ¥ï¼Œä»¥å‡å°‘æœåŠ¡å™¨ä¸Šçš„é¢å¤–è´Ÿè½½ã€‚ å¦åˆ™ï¼Œä»–å°†å°è¯•ç»´æŒè¿™ç§è¿æ¥ï¼Œå¹¶æœ€ç»ˆè€—å°½å…¶èµ„æºã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// isAlive checks whether a backend is Alive by establishing a TCP connection func isBackendAlive(u *url.URL) bool { timeout := 2 * time.Second conn, err := net.DialTimeout("tcp", u.Host, timeout) if err != nil { log.Println("Site unreachable, error: ", err) return false } _ = conn.Close() // close it, we dont need to maintain this connection return true }</span></span></code> </pre> <br> ç°åœ¨ï¼Œæ‚¨å¯ä»¥è¿­ä»£æœåŠ¡å™¨å¹¶æ ‡è®°å…¶çŠ¶æ€ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// HealthCheck pings the backends and update the status func (s *ServerPool) HealthCheck() { for _, b := range s.backends { status := "up" alive := isBackendAlive(b.URL) b.SetAlive(alive) if !alive { status = "down" } log.Printf("%s [%s]\n", b.URL, status) } }</span></span></code> </pre> <br> è¦å®šæœŸè¿è¡Œæ­¤ä»£ç ï¼Œå¯ä»¥åœ¨Goä¸­è¿è¡Œè®¡æ—¶å™¨ã€‚ å®ƒå°†å…è®¸æ‚¨æ”¶å¬é¢‘é“ä¸­çš„äº‹ä»¶ã€‚ <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// healthCheck runs a routine for check status of the backends every 2 mins func healthCheck() { t := time.NewTicker(time.Second * 20) for { select { case &lt;-tC: log.Println("Starting health check...") serverPool.HealthCheck() log.Println("Health check completed") } } }</span></span></code> </pre> <br> åœ¨æ­¤ä»£ç ä¸­ï¼Œ <code>&lt;-tC</code>é€šé“å°†æ¯20ç§’è¿”å›ä¸€ä¸ªå€¼ã€‚  <code>select</code>å…è®¸æ‚¨å®šä¹‰æ­¤äº‹ä»¶ã€‚ åœ¨æ²¡æœ‰<code>default</code>æƒ…å†µçš„<code>default</code>ä¸‹ï¼Œå®ƒå°†ç­‰å¾…ç›´åˆ°è‡³å°‘å¯ä»¥æ‰§è¡Œä¸€ç§æƒ…å†µã€‚ <br><br> ç°åœ¨ï¼Œåœ¨å•ç‹¬çš„goroutineä¸­è¿è¡Œä»£ç ï¼š <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> healthCheck()</code> </pre><br><h2> ç»“è®º </h2><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ç ”ç©¶äº†è®¸å¤šé—®é¢˜ï¼š <br><br><ul><li> å¾ªç¯ç®—æ³• </li><li> æ¥è‡ªæ ‡å‡†åº“çš„ReverseProxy </li><li> äº’æ–¥ä½“ </li><li> åŸå­æ“ä½œ </li><li> çŸ­è·¯ </li><li> å›å‘¼ </li><li> é€‰æ‹©æ“ä½œ </li></ul><br> è¿˜æœ‰è®¸å¤šæ”¹è¿›å¹³è¡¡å™¨çš„æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼š <br><br><ul><li> ä½¿ç”¨å †å¯¹æ´»åŠ¨æœåŠ¡å™¨è¿›è¡Œæ’åºä»¥ç¼©å°æœç´¢èŒƒå›´ã€‚ </li><li> æ”¶é›†ç»Ÿè®¡ä¿¡æ¯ã€‚ </li><li> ç”¨æœ€å°‘çš„è¿æ¥æ•°å®ç°åŠ æƒè½®è¯¢ç®—æ³•ã€‚ </li><li> æ·»åŠ å¯¹é…ç½®æ–‡ä»¶çš„æ”¯æŒã€‚ </li></ul><br> ä¾æ­¤ç±»æ¨ã€‚ <br><br> æºä»£ç åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a> ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN476276/">https://habr.com/ru/post/zh-CN476276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN476264/index.html">ç”¨äºå­¦ä¹ å¤–è¯­çš„ç”µæŠ¥æœºå™¨äººï¼šä»å¡«å­—æ¸¸æˆåˆ°è¯´è¯</a></li>
<li><a href="../zh-CN476266/index.html">åœ¨Mars Digital Technologieså®ä¹ ã€‚ æˆ‘ä»¬å¦‚ä½•åœ¨Mï¼†M'såº”ç”¨æ·±åº¦å­¦ä¹ </a></li>
<li><a href="../zh-CN476268/index.html">PVS-Studioå›¢é˜Ÿåœ¨2018-2019å¹´ä¼šè®®ä¸Šæä¾›çš„Bugå‘ç°æŒ‘æˆ˜è§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="../zh-CN476270/index.html">æˆ‘ä»¬çš„èƒœåˆ©ï¼šTopCoder Open 2019</a></li>
<li><a href="../zh-CN476272/index.html">åœ¨2018-2019å¹´ä¼šè®®çš„PVS-Studioå±•ä½ä¸Šå›ç­”ä»»åŠ¡</a></li>
<li><a href="../zh-CN476278/index.html">é»‘å¸½ç¾å›½ä¼šè®®ã€‚ è‡´å¯Œæˆ–ä¸§å‘½ï¼šä½¿ç”¨Black Hatåœ¨äº’è”ç½‘ä¸Šèµšé’±ã€‚ ç¬¬ä¸‰éƒ¨åˆ†</a></li>
<li><a href="../zh-CN476280/index.html">ä»è†æ£˜åˆ°DOSï¼šæ”¹å˜ä¸–ç•Œçš„å››å¼ è½¯ç›˜</a></li>
<li><a href="../zh-CN476284/index.html">æˆ‘ä»¬åˆ¶å®šäº†åº”å¯¹Reactä¸­é”™è¯¯çš„ç­–ç•¥</a></li>
<li><a href="../zh-CN476286/index.html">2020å¹´ç”¨äºå‰ç«¯å¼€å‘çš„5ä¸ªJSæ¡†æ¶ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN476288/index.html">2020å¹´ç”¨äºå‰ç«¯å¼€å‘çš„5ä¸ªJSæ¡†æ¶ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>