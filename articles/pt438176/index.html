<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí© üë®üèæ‚Äçüéì ü§© Vis√£o geral do IPSec no Mikrotik üèÇüèΩ üë¶üèø üë©‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IPSec (IP Security) - um conjunto de protocolos e algoritmos para criptografar dados em redes IPv4 e IPv6. N√£o parece complicado, mas o IPSec n√£o esta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vis√£o geral do IPSec no Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438176/"><p>  IPSec (IP Security) - um conjunto de protocolos e algoritmos para criptografar dados em redes IPv4 e IPv6.  N√£o parece complicado, mas o IPSec n√£o estabelece regras claras para criptografar o tr√°fego; em vez disso, os desenvolvedores implementam um conjunto de ferramentas (protocolos e algoritmos), usando o qual o administrador cria um canal seguro para os dados. </p><br><p>  Quero abordar o IPSec no RouterOS um pouco mais profundo do que um simples HOWTO, com teoria e exemplos m√≠nimos sobre como configurar e depurar o IPSec.  Este n√£o √© um guia e, sem a pr√°tica em um banco de testes, n√£o √© recomend√°vel come√ßar a configurar t√∫neis reais e servidores VPN. </p><a name="habracut"></a><br><h3 id="preimuschestva-i-nedostatki-ipsec">  Vantagens e desvantagens do IPSec </h3><br><p>  Pontos fortes: </p><br><ul><li>  Funciona no n√≠vel da rede do modelo OSI </li><li>  Ele pode criptografar o pacote de origem totalmente ou a partir da camada de transporte e </li><li>  Existe um mecanismo para superar o NAT </li><li>  Uma ampla variedade de algoritmos de criptografia e hash de tr√°fego para escolher </li><li>  IPSec - um conjunto de padr√µes abertos e extens√≠veis </li><li>  No caso do Mikrotik, ele n√£o exige a compra de taxas ou licen√ßas adicionais </li></ul><br><p>  Fraquezas: </p><br><ul><li>  Dificuldade </li><li>  Diferentes ferramentas de terminologia e configura√ß√£o para diferentes fornecedores </li><li>  O uso de algoritmos de criptografia fortes requer um bom poder de computa√ß√£o. </li><li>  DPI f√°cil de detectar </li></ul><br><h3 id="protokoly-v-sostave-ipsec">  Protocolos em IPSec </h3><br><p><img src="https://habrastorage.org/webt/nd/k6/0m/ndk60mwkllka7jpnl2flzdqt8ce.png"></p><br><p>  Globalmente, todos os protocolos com os quais voc√™ lidar√° durante a configura√ß√£o podem ser divididos em dois grupos: protocolos de troca de chaves e protocolos de prote√ß√£o de dados. </p><br><p>  <strong>Protocolos de troca de chaves (IKE)</strong> <br>  A principal tarefa √© autenticar os participantes na conex√£o e concordar com os par√¢metros e chaves de criptografia para proteger as informa√ß√µes transmitidas. </p><br><ul><li>  IKE (Internet Key Exchange) - definido em 1998.  Muitos recursos (por exemplo, ponte NAT) foram adicionados posteriormente como complementos e podem n√£o ser implementados com v√°rios fornecedores.  A base da negocia√ß√£o principal √© ISAKMP. </li><li>  IKEv2 (Internet Key Exchange vers√£o 2) - √∫ltima revis√£o de 2014.  √â um desenvolvimento do protocolo IKE, no qual alguns problemas foram resolvidos, o mecanismo principal do contrato foi simplificado e as extens√µes (NAT-T, Keepalives, Mode Config) passaram a fazer parte do protocolo. </li></ul><br><p>  Na pr√°tica, a maioria das conex√µes IPSec √© implementada usando o IKE devido a equipamentos desatualizados ou √† relut√¢ncia dos administradores em mudar alguma coisa. </p><br><p>  <strong>Protocolos de prote√ß√£o de dados (ESP, AH)</strong> <br>  A principal tarefa √© proteger os dados do usu√°rio. </p><br><ul><li>  ESP (Encapsulating Security Payload) - criptografa e autentica parcialmente os dados transmitidos </li><li>  AH (cabe√ßalho de autentica√ß√£o) - autentica todo o pacote (exceto para campos mut√°veis), n√£o criptografa dados, mas permite garantir que o pacote n√£o foi alterado durante a transmiss√£o pela rede </li></ul><br><h3 id="poryadok-ustanovki-ipsec-soedineniya">  Procedimento de instala√ß√£o da conex√£o IPSec </h3><br><p><img src="https://habrastorage.org/webt/lu/rv/ps/lurvpsvrdub2tcgkmpx8ut5ep58.png"></p><br><p>  Os participantes de uma conex√£o IPSec s√£o geralmente chamados de pares, o que indica sua equival√™ncia na conex√£o estabelecida.  √â poss√≠vel uma configura√ß√£o pr√≥xima ao cliente-servidor, mas ao criar t√∫neis IPSec permanentes, qualquer um dos pares pode ser um inicializador. </p><br><ol><li>  Um dos pares inicia uma conex√£o IPSec </li><li>  H√° uma troca de informa√ß√µes importantes, autentica√ß√£o de pares, coordena√ß√£o dos par√¢metros de conex√£o </li><li>  Com base nas informa√ß√µes-chave recebidas, um t√∫nel criptografado auxiliar √© formado </li><li>  Usando um t√∫nel criptografado, os pares determinam os par√¢metros de criptografia de dados e trocam informa√ß√µes para gerar chaves </li><li>  O resultado da fase anterior √© um conjunto de regras e chaves para prote√ß√£o de dados (SA) </li><li>  Os pares periodicamente atualizam as chaves de criptografia </li></ol><br><p>  Um dos principais conceitos do IPSec √© o SA (Security Association) - um conjunto de algoritmos de criptografia para criptografar e hash informa√ß√µes, bem como chaves de criptografia, acordadas pelos pares. </p><br><p>  √Äs vezes voc√™ pode encontrar uma divis√£o em: </p><br><ul><li>  ISAKMP SA - par√¢metros e chaves relacionados ao t√∫nel auxiliar </li><li>  Data SA (ou simplesmente SA) - par√¢metros e chaves relacionados √† criptografia de tr√°fego </li></ul><br><h3 id="poryadok-raboty-protokolov-soglasovaniya-klyuchey">  Protocolos principais de contrato </h3><br><p>  O protocolo IKE pode funcionar em dois modos: principal (principal) e agressivo (agressivo), o protocolo IKEv2 cont√©m um modo. </p><br><h4 id="ike-main">  IKE Principal </h4><br><p><img src="https://habrastorage.org/webt/zw/jb/yv/zwjbyvrpmup5t7nfgaol329rudi.png"></p><br><p>  A primeira fase consiste em seis pacotes: <br>  1-2: Alinhamento das configura√ß√µes de criptografia do t√∫nel secund√°rio e v√°rias op√ß√µes IPSec <br>  3-4: Compartilhando informa√ß√µes para gerar uma chave secreta <br>  5-6: Autentica√ß√£o de mesmo n√≠vel usando o canal criptografado auxiliar </p><br><p>  A segunda fase consiste em tr√™s pacotes: <br>  1-3: Usando um canal auxiliar criptografado.  Coordena√ß√£o de par√¢metros de prote√ß√£o de tr√°fego, troca de informa√ß√µes para gerar uma chave secreta </p><br><h3 id="ike-aggressive">  IKE Agressivo </h3><br><p><img src="https://habrastorage.org/webt/xu/wz/qu/xuwzqu4qle5lxlcvb-hnvuhqehg.png"></p><br><p>  A primeira fase consiste em tr√™s pacotes: <br>  1: Enviando uma oferta para instalar um canal criptografado auxiliar e informa√ß√µes para gerar uma chave privada <br>  2: Resposta √† oferta, informa√ß√µes para gerar a chave secreta, dados para autentica√ß√£o <br>  3: Dados de autentica√ß√£o </p><br><p>  A segunda fase consiste em tr√™s pacotes: <br>  1-3: Usando um canal auxiliar criptografado.  Coordena√ß√£o de par√¢metros de prote√ß√£o de tr√°fego, troca de informa√ß√µes para gerar uma chave secreta </p><br><p>  No modo agressivo, o iniciador envia apenas um conjunto de par√¢metros na senten√ßa.  A troca de informa√ß√µes para autentica√ß√£o de pares ocorre antes da instala√ß√£o de um t√∫nel auxiliar seguro.  O modo agressivo √© consistente mais r√°pido, mas menos seguro. </p><br><h3 id="ikev2">  IKEv2 </h3><br><p><img src="https://habrastorage.org/webt/ev/mq/ni/evmqnimq5_sdeybuz63x3ddssbu.png"></p><br><p>  No IKEv2, as fases s√£o nomeadas: IKE_SA_INIT e IKE_AUTH.  <em>Mas se eu estou falando sobre a Fase 1 e a Fase 2 posteriormente no texto, isso tamb√©m se aplica √†s fases do IKEv2.</em> </p><br><p>  Cada fase do IKEv2 consiste em dois pacotes: <br>  IKE_SA_INIT: Coordena√ß√£o dos par√¢metros de criptografia do t√∫nel auxiliar, troca de informa√ß√µes para gerar uma chave privada </p><br><p>  IKE_AUTH: usando o canal auxiliar criptografado.  Autentica√ß√£o de pares, coordena√ß√£o de par√¢metros de prote√ß√£o de tr√°fego, troca de informa√ß√µes para gerar uma chave secreta </p><br><h3 id="security-assotiations-database-sad">  Banco de dados de associa√ß√µes de seguran√ßa (SAD) </h3><br><p>  O resultado do IKE (e IKEv2) s√£o Security Assotiations (SA), que definem configura√ß√µes de prote√ß√£o de tr√°fego e chaves de criptografia.  Cada SA √© unidirecional e a conex√£o IPSec cont√©m um par de SAs.  Todas as SAs s√£o armazenadas no banco de dados do SAD e s√£o acess√≠veis ao administrador para visualiza√ß√£o e redefini√ß√£o. </p><br><h3 id="inkapsulyaciya-dannyh">  Encapsulamento de dados </h3><br><p><img src="https://habrastorage.org/webt/3z/3k/aa/3z3kaaj2rwmnx59apvueigp3lno.png"></p><br><p>  O IPSec fornece duas op√ß√µes para encapsular dados: </p><br><ul><li>  Modo de transporte - somente a carga √∫til do pacote √© protegida, deixando o cabe√ßalho original.  Para construir t√∫neis, o modo de transporte geralmente √© usado em conjunto com o ipip ou gre, cuja carga √∫til j√° cont√©m todo o pacote de origem. </li><li>  Modo de encapsulamento - encapsula totalmente o pacote original em um novo (semelhante ao gre ou ipip).  Mas para o t√∫nel ipsec, uma interface expl√≠cita n√£o √© criada no sistema, isso pode ser um problema se o roteamento est√°tico din√¢mico ou complexo for usado. </li></ul><br><h3 id="security-policy-database-spd">  Banco de Dados de Pol√≠ticas de Seguran√ßa (SPD) </h3><br><p>  Um banco de dados de regras que determinam qual tr√°fego deve ser criptografado, protocolo de prote√ß√£o de dados, tipo de encapsulamento e v√°rios outros par√¢metros. <br>  A posi√ß√£o de verifica√ß√£o do SPD pode ser exibida no diagrama de fluxo de pacotes. </p><br><p><img src="https://habrastorage.org/webt/nh/jo/rm/nhjorm-je866yymx0_cxwdnyop8.png"></p><br><h3 id="preodolenie-nat">  Ponte NAT </h3><br><p>  O IPSec usa protocolos da camada de rede para transferir dados que o NAT n√£o pode manipular.  Para resolver o problema, o protocolo NAT-T √© usado (uma extens√£o no IKE e parte do IKEv2).  A ess√™ncia do NAT-T est√° no encapsulamento adicional de pacotes IPSec em pacotes UDP que o NAT processa. </p><br><h3 id="ipsec-v-mikrotik">  IPSec na Mikrotik </h3><br><p>  O IPSec est√° dispon√≠vel gratuitamente em qualquer dispositivo executando o RouterOS com o pacote de seguran√ßa instalado. </p><br><h3 id="apparatnoe-shifrovanie">  Criptografia de hardware </h3><br><p>  Para descarregar a CPU, a acelera√ß√£o de criptografia por hardware √© adicionada a alguns modelos de roteadores MikroTik; uma lista completa pode ser encontrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no wiki</a> . <br>  Mais op√ß√µes de or√ßamento: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RB750Gr3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RB3011</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HAP AC ^ 2</a> . </p><br><p>  Por conta pr√≥pria, verifiquei a velocidade do IPSec entre dois RB1100AHx2 e entre dois RB750Gr3. </p><br><p>  Para alcan√ßar o m√°ximo de resultados no RB1100AHx2, voc√™ deve: </p><br><ul><li>  Use a porta 11 diretamente conectada √† CPU e configure um n√∫cleo da CPU para lidar com o tr√°fego de 11 portas </li><li>  Use apenas filas de hardware nas interfaces, desative o RPS </li><li>  Ative o Layer3 FastPath (cerca de 800mb / s) ou exclua o tr√°fego IPSec do conntrack (cerca de 700mb / s) <br>  Sem as manipula√ß√µes descritas na porta mais lenta (ether13), √© poss√≠vel obter ~ 170 Mb / s, nos ~ 400 Mb / s usuais. </li></ul><br><p>  No RB750Gr3 sem otimiza√ß√µes de cerca de 200 Mb / s. </p><br><p>  Os roteadores single-core da Qualcomm mostram um resultado de 10 a 40 mb / s, dependendo do modelo, otimiza√ß√µes e carga de trabalho de outros processos. </p><br><p>  Eu recomendo que voc√™ se familiarize com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">apresenta√ß√£o</a> do funcion√°rio da mikrotik, eles abordaram t√≥picos de otimiza√ß√£o de configura√ß√µes para reduzir a carga na CPU e aumentar a velocidade, que n√£o adicionei ao texto. </p><br><h3 id="razlichiya-642x-i-643x">  Diferen√ßas 6.42.X e 6.43.X </h3><br><p>  Dependendo da vers√£o do RouterOS que voc√™ est√° usando, o menu de configura√ß√£o IPSec varia. </p><br><p><img src="https://habrastorage.org/webt/6q/pz/5c/6qpz5cgthate04bihl8gq2zr9t8.png"></p><br><p><img src="https://habrastorage.org/webt/ng/ug/hi/ngughirhx6nwd1v8mjaa9omfb7g.png"></p><br><p><img src="https://habrastorage.org/webt/kv/ow/3-/kvow3-bmivzfr_tf6bqnywr5wu8.png"></p><br><p>  J√° existem novas altera√ß√µes na vers√£o de teste, portanto, leia as Notas da vers√£o antes de atualizar. </p><br><p><img src="https://habrastorage.org/webt/ri/rd/gu/rirdgucrebbf1ucxjqbj65gzf-s.png"></p><br><h3 id="konfiguraciya-ipsec">  Configura√ß√£o IPsec </h3><br><p><img src="https://habrastorage.org/webt/r6/lf/j5/r6lfj5hlclkbx9qmph0owsqf_ak.png"><br>  O menu [IP] -&gt; [IPSec] n√£o √© t√£o assustador quanto parece √† primeira vista.  O diagrama mostra que os principais itens de configura√ß√£o s√£o: Pares e perfis. <br>  As guias Remote Peers e SAs instalados s√£o informativas. </p><br><h4 id="peers-i-peers-profiles">  Pares e perfis de pares </h4><br><p>  Configura√ß√£o de pares IPSec para estabelecer uma conex√£o IKE e criar um t√∫nel seguro auxiliar. </p><br><p><img src="https://habrastorage.org/webt/e2/kj/e1/e2kje1zwzhubqsyriypavj3bmfm.png" alt="imagem"></p><br><p>  <strong>Configurar pares remotos IPSec</strong> </p><br><p><img src="https://habrastorage.org/webt/pq/9d/cv/pq9dcvyqrf64pdklohgf1eapoze.png"></p><br><div class="spoiler">  <b class="spoiler_title">Anota√ß√µes</b> <div class="spoiler_text"><ul><li>  A partir do 6.43, o RouterOS jura ao usar o PSK sem autentica√ß√£o adicional.  Se voc√™ n√£o desejar configurar adicionalmente chaves, certificados ou xAuth, poder√° mudar para IKEv2 ou ignorar o aviso. </li><li>  Como pares, voc√™ pode especificar IPs ou sub-redes espec√≠ficos (relevantes para a VPN cliente-servidor) </li><li>  Se houver regras conflitantes, uma regra com uma sub-rede mais precisa ser√° usada para conectar-se ao par (semelhante √†s rotas) </li><li>  Autentica√ß√£o de chave XAuth e rsa n√£o funciona no IKEv2 </li><li>  Para o IKEv2, o Mikrotik tornou a implementa√ß√£o do xAuth incompat√≠vel com outras plataformas </li><li>  O modo passivo geralmente √© usado para criar uma VPN cliente-servidor (configura√ß√£o do modo L2TP / IPsec ou IKEv2), mas pode ser √∫til ao conectar um grande n√∫mero de t√∫neis site a site em um √∫nico ponto, para reduzir o tr√°fego falso. </li><li>  Se voc√™ planeja usar o xAuth, o "servidor" deve ser passivo.  Os usu√°rios do servidor s√£o criados em [IPSec] -&gt; [Usu√°rios] </li><li>  Ao usar a pol√≠tica Gerar, selecione o modo restrito de porta </li></ul></div></div><br><p>  <strong>Estabelecimento de perfis (propostas) para harmoniza√ß√£o Fase 1</strong> </p><br><p><img src="https://habrastorage.org/webt/w8/s9/vj/w8s9vjxiguir63a_hfpci1ih1bi.png" alt="imagem"></p><br><p><img src="https://habrastorage.org/webt/_v/x3/ff/_vx3ff1ogwsxjggebdjqazfqhve.png"></p><br><div class="spoiler">  <b class="spoiler_title">Anota√ß√µes</b> <div class="spoiler_text"><ul><li>  Op√ß√µes adicionais para o IKE se tornam parte do IKEv2, as configura√ß√µes s√£o ignoradas </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Correla√ß√£o de grupos DH com seus n√∫meros</a> (os n√∫meros de grupo s√£o usados ‚Äã‚Äãpor outros fornecedores) </li><li>  Ao enviar propostas, o sistema classifica o algoritmo de pares + grupo dh de mais persistente para menos persistente <br><img src="https://habrastorage.org/webt/7i/h8/fj/7ih8fjegurxodmq-daxuwxfhpii.png"></li></ul></div></div><br><h4 id="policies-i-policy-proposals">  Pol√≠ticas e propostas de pol√≠ticas </h4><br><p>  Os pol√≠ticos verificam os pacotes aprovados quanto √† conformidade com as condi√ß√µes e aplicam as a√ß√µes especificadas.  Se voc√™ voltar ao fluxo de pacotes, os blocos com a pol√≠tica IPSec ser√£o a reconcilia√ß√£o com as pol√≠ticas.  As a√ß√µes especificam: protocolo de seguran√ßa IPSec (ESP ou AH), propostas para negocia√ß√£o de SA, modo de encapsulamento. <br><img src="https://habrastorage.org/webt/tp/bk/1n/tpbk1nrkowlvaqdnrfvgpvbaxg0.png" alt="imagem"></p><br><p>  O pacote passa a pol√≠tica uma a uma at√© corresponder √†s condi√ß√µes de uma delas. </p><br><p>  <strong>Configura√ß√£o de diretiva</strong> <br><img src="https://habrastorage.org/webt/yw/cp/nj/ywcpnjdyjonrxpnfel79irfov4g.png"></p><br><div class="spoiler">  <b class="spoiler_title">Anota√ß√µes</b> <div class="spoiler_text"><ul><li>  Geralmente, nenhum Src espec√≠fico √© necess√°rio.  e Dst.  Porta, mas em geral, a capacidade de criptografar o tr√°fego de um aplicativo individual √© interessante </li><li>  Nem todos os protocolos IP s√£o apresentados na lista Protocolos (por exemplo, n√£o h√° gre), voc√™ pode especificar manualmente o n√∫mero do protocolo necess√°rio. </li><li>  Modelos n√£o s√£o pol√≠ticos!  Eles s√£o usados ‚Äã‚Äãse a pol√≠tica de gera√ß√£o estiver definida na configura√ß√£o de mesmo n√≠vel. </li><li>  O que fazer se n√£o foram encontradas SAs espec√≠ficas para uma pol√≠tica.  Anteriormente, havia um problema com o L2TP / IPSec quando v√°rios clientes n√£o podiam se conectar devido ao mesmo NAT (ao usar o IKE), esse erro era resolvido (supondo que esses clientes n√£o fossem janelas) se voc√™ definir level = unique.  Caso contr√°rio, mude para IKEv2 </li><li>  Ao configurar pol√≠ticas, use [Modo de seguran√ßa], um movimento estranho e voc√™ corre o risco de perder o acesso ao roteador usando o Level3 </li></ul></div></div><br><p>  <strong>Configurar propostas para aprova√ß√£o de SA</strong> <br><img src="https://habrastorage.org/webt/mh/yf/cd/mhyfcd2-2nsxbouuxhgbecj3kyu.png"></p><br><p><img src="https://habrastorage.org/webt/0n/xk/tw/0nxktwxmxyu2quyanfw-rco-yqa.png"></p><br><h4 id="groups">  Grupos </h4><br><p>  Usado para associar modelos e pares de pol√≠ticas. </p><br><p><img src="https://habrastorage.org/webt/do/r7/gc/dor7gc6s4zuwlo2mmz5irrc3alm.png" alt="imagem"></p><br><p>  Em uma das vers√µes mais antigas do RouterOS, havia um erro no grupo padr√£o que n√£o funcionava. </p><br><h4 id="mode-config">  Configura√ß√£o do modo </h4><br><p>  Enviando e recebendo par√¢metros IP sem usar protocolos adicionais.  Permite que voc√™ crie um IPSec de VPN de cliente para servidor independente. </p><br><p><img src="https://habrastorage.org/webt/sr/s2/dl/srs2dl4tcpixxiwi2mrletlguva.png"></p><br><p><img src="https://habrastorage.org/webt/os/r2/gg/osr2ggrnm_0-vqtoukxb5hnzfjs.png"></p><br><h4 id="keys-i-users">  Chaves e usu√°rios </h4><br><p>  Usado para autentica√ß√£o avan√ßada de pares. <br>  <strong>Chaves</strong> <br>  Chaves RSA: gera√ß√£o, importa√ß√£o, exporta√ß√£o.  N√£o suportado no IKEv2. </p><br><p><img src="https://habrastorage.org/webt/ec/7z/j4/ec7zj4doiqkdgwe4soh7lrk21f8.png"></p><br><p>  <strong>Utilizadores</strong> <br>  Banco de dados do usu√°rio XAuth para o "servidor".  O cliente especifica as configura√ß√µes do xAuth na configura√ß√£o de mesmo n√≠vel.  √â poss√≠vel encaminhar a autentica√ß√£o xAuth para um servidor RADIUS. </p><br><p><img src="https://habrastorage.org/webt/pi/wl/vq/piwlvq80v1cnndmhyjg91jzrqle.png"></p><br><h4 id="remote-peers">  Pares remotos </h4><br><p>  Lista de todos os pares que instalam e instalam um t√∫nel auxiliar (Fase 1).  Voc√™ pode remover pares para atualizar as chaves do t√∫nel auxiliar. </p><br><p><img src="https://habrastorage.org/webt/j2/-g/ct/j2-gct_8wrf7bl2zgtzqsswwbgk.png" alt="imagem"></p><br><p><img src="https://habrastorage.org/webt/2k/37/3m/2k373mg8qxox4y-ruph-jza_d0m.png" alt="imagem"></p><br><h4 id="installed-sas">  SAs instaladas </h4><br><p>  Banco de dados SAD ou uma lista de todas as SAs negociadas.  Voc√™ pode ver os algoritmos e chaves de prote√ß√£o de dados usados. </p><br><p><img src="https://habrastorage.org/webt/jw/jb/su/jwjbsuorsms85vw656xfgvcneuc.png" alt="imagem"></p><br><p><img src="https://habrastorage.org/webt/wd/8x/gr/wd8xgrc-h0ngxcfq77qun4ymuhk.png" alt="imagem"></p><br><p>  O sinalizador AEAD de hardware indica o uso de criptografia de hardware. </p><br><p><img src="https://habrastorage.org/webt/jz/5-/yv/jz5-yv-xaw_a8gx5zrxz1hlesye.png" alt="imagem"></p><br><p>  Um administrador pode redefinir o SA, mas apenas todos do mesmo tipo (esp ou ah) ao mesmo tempo. </p><br><h4 id="ipsec-i-firewall">  IPSec e firewall </h4><br><p>  No Firewall, voc√™ pode verificar se o tr√°fego √© uma pol√≠tica IPSec de entrada ou sa√≠da.  Um aplicativo √≥bvio √© o L2TP / IPSec; voc√™ pode proibir a instala√ß√£o de conex√µes L2TP se o tr√°fego n√£o tiver sido criptografado anteriormente. </p><br><p><img src="https://habrastorage.org/webt/xt/06/sw/xt06swif3vlsv_vjcyywb1lepf0.png"></p><br><p>  <strong>Protocolos e portas usados ‚Äã‚Äãno IPSec</strong> </p><br><ul><li>  IKE - UDP: 500 </li><li>  IKEv2 - UDP: 4500 </li><li>  NAT-T - UDP: 4500 </li><li>  ESP - ipsec-esp (50) </li><li>  AH - ipsec-ah (51) </li></ul><br><h3 id="ipsec-i-endpoinds">  IPSec e Endpoinds </h3><br><p>  E agora sobre a ferida ... <br>  O wiki mikrotik possui tabelas com algoritmos de hash e criptografia para: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Windows</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">iOS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OS-X</a> . </p><br><p>  N√£o encontrei informa√ß√µes sobre o cliente vpn android interno, mas em geral ele trabalha com propostas do Windows.  N√£o h√° suporte para IKEv2 no Android, voc√™ deve usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StrongSwan</a> . </p><br><h3 id="primery-konfiguracii">  Exemplos de configura√ß√£o </h3><br><p>  Esquema e configura√ß√£o b√°sica para exemplos com t√∫neis site a site: </p><br><p><img src="https://habrastorage.org/webt/bn/a7/xu/bna7xud0pazv4ipia2k0083wqom.png"></p><br><pre><code class="plaintext hljs">#Mikrotik1 /ip address add address=10.10.10.10/24 interface=ether1 network=10.10.10.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.10.10.1 dst-address=0.0.0.0/0 #Mikrotik2 /ip address add address=10.20.20.20/24 interface=ether1 network=10.20.20.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.20.20.1 dst-address=0.0.0.0/0</code> </pre> <br><h4 id="ipsec-v-tunnelnom-rezhime">  IPSec no modo de t√∫nel </h4><br><p><img src="https://habrastorage.org/webt/wy/cg/ad/wycgadjksxuyftckhoctoxciub4.png"></p><br><p>  Configura√ß√£o passo a passo: </p><br><ol><li>  Criar propostas para IKE Phase1 </li><li>  Crie um banquete.  Indicamos o endere√ßo, propostas, modo de troca, tecla PSK.  Eu escolhi o IKEv2, voc√™ pode usar main / agressive conforme desejado </li><li>  Criar propostas para o SA </li><li>  Especifique as sub-redes entre as quais criamos o t√∫nel </li><li>  Especifique endere√ßos SA, modo de encapsulamento e propostas para criptografia de tr√°fego </li><li>  Editando a regra NAT </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/c2/tg/at/c2tgatfqb3bgw5qer0u6lvi_jt0.png"></a> </p><br><p>  Op√ß√£o de console: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=192.168.200.0/24 proposal=ipsec-tunnel-sa sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10 src-address=192.168.100.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/je/5y/gq/je5ygqbnhfjklyqxu8pg1kf2saq.png"></a> </p><br><p>  Op√ß√£o de console: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=192.168.100.0/24 proposal=tets-ipsec-sa sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20 src-address=192.168.200.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">E aqui NAT?</b> <div class="spoiler_text"><p>  Para trabalhar no modo de encapsulamento, voc√™ precisa de uma rota falsa para a sub-rede remota ou uma rota padr√£o; caso contr√°rio, os pacotes n√£o ir√£o al√©m da decis√£o de roteamento.  Geralmente, n√£o h√° problemas com a primeira op√ß√£o, mas com a rota padr√£o e o NAT de origem (o primeiro e o segundo est√£o presentes na grande maioria dos roteadores dom√©sticos e de escrit√≥rio), haver√° problemas. </p><br><p>  Recuperar fluxo de pacotes.  Os pacotes passam pelo NAT de origem mais cedo do que as pol√≠ticas IPSec, a regra com disfarce n√£o sabe nada sobre o tr√°fego destinado ao t√∫nel "ef√™mero" e transmitir√° os cabe√ßalhos de pacotes a serem enviados ao IPSec quando o pacote com o cabe√ßalho alterado for verificado no endere√ßo de origem de Pol√≠ticas em o cabe√ßalho n√£o se ajustar√° √† regra e o pacote voar√° para a rota padr√£o que, tendo visto o endere√ßo de destino da rede privada, provavelmente o eliminar√°. </p><br><p>  Existem v√°rias solu√ß√µes para o problema: </p><br><ul><li>  Usando rota falsa </li><li>  Usando uma regra de aceita√ß√£o opcional antes do SourceNAT </li><li>  Sujeite src-nat apenas aos pacotes para os quais n√£o h√° pol√≠ticas IPSec (no exemplo) </li><li>  Excluir tr√°fego do rastreamento de conex√£o usando RAW </li></ul></div></div><br><p>  <strong>Verifique a conex√£o estabelecida</strong> <br><img src="https://habrastorage.org/webt/no/xd/cn/noxdcnqrsbftj6mfsxlmpruizmq.png" alt="imagem"></p><br><ol><li>  Vemos um vizinho em Remote Peers </li><li>  Vemos o SA instalado (os contadores de tr√°fego n√£o ser√£o alterados at√© voc√™ inici√°-lo) </li><li>  Em pol√≠tica, status estabelecido e bandeira (A) </li></ol><br><h4 id="ipipipsec">  IPIP / IPSec </h4><br><p><img src="https://habrastorage.org/webt/2b/hy/1d/2bhy1d1tnwd57iyppymvb8dbkww.png"></p><br><p>  T√∫nel IPIP predefinido: </p><br><pre> <code class="plaintext hljs">#Mikrotik1 #  ipip /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.20.20.20 # ip   ipip  /ip address add address=10.30.30.1/30 interface=ipip-vpn #     /ip route add distance=1 dst-address=192.168.200.0/24 gateway=10.30.30.2 #Mikrotik2 # ,      /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.10.10.10 /ip address add address=10.30.30.2/30 interface=ipip-vpn /ip route add distance=1 dst-address=192.168.100.0/24 gateway=10.30.30.1</code> </pre> <br><p>  Configura√ß√£o passo a passo do IPSec: </p><br><ol><li>  Criar propostas para IKE Phase1 </li><li>  Crie um banquete.  Indique o endere√ßo, propostas, modo de troca, tecla PSK </li><li>  Criar propostas para o SA </li><li>  Especifique as sub-redes entre as quais criamos o t√∫nel </li><li>  Especificamos os endere√ßos da SA, o tipo de tr√°fego que criptografaremos e as propostas </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/5e/mf/_w/5emf_wcxb3ulnjv3fykuino9stg.png"></a> </p><br><p>  Op√ß√£o de console: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=10.20.20.20/32 proposal=ipsec-tunnel-sa protocol=ipencap src-address=10.10.10.10/32 sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/9o/dk/oy/9odkoy8krqem4mck9rkfibhm220.png"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=10.10.10.10/32 proposal=tets-ipsec-sa protocol=ipencap src-address=10.20.20.20/32 sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20</code> </pre> </div></div><br><p>  Para desatento, a diferen√ßa real na configura√ß√£o do modo de t√∫nel e transporte nas pol√≠ticas IPSec: <br><img src="https://habrastorage.org/webt/5v/ka/fg/5vkafg3ca8vilvv0s-lv1tdbxhw.png" alt="imagem"></p><br><p>  A verifica√ß√£o da conex√£o √© semelhante ao modo de t√∫nel. </p><br><h4 id="l2tpipsec">  L2TP / IPSec </h4><br><p>  Os exemplos anteriores s√£o adequados para criar VPNs permanentes entre dois pares, com endere√ßos IP externos est√°ticos. </p><br><p>  Se o endere√ßo de um dos pares for din√¢mico (e geralmente estiver localizado atr√°s do NAT), voc√™ dever√° usar outra VPN de cliente para servidor. <br><img src="https://habrastorage.org/webt/ms/l5/3a/msl53ahdcdv8fl2vd-62m1exdmk.png" alt="imagem"></p><br><p>  Pr√©-configura√ß√£o L2TP: </p><br><pre> <code class="plaintext hljs">#     /ip pool add name=pool-l2tp ranges=192.168.77.10-192.168.77.20 #    /ppp profile add change-tcp-mss=yes local-address=192.168.77.1 name=l2tp-ipsec only-one=yes remote-address=pool-l2tp use-compression=no use-encryption=no use-mpls=no use-upnp=no #   /ppp secret add name=user1 password=test1 profile=l2tp-ipsec service=l2tp add name=user2 password=test2 profile=l2tp-ipsec service=l2tp add name=user3 password=test3 profile=l2tp-ipsec service=l2tp #  L2TP (  ipsec) /interface l2tp-server server set authentication=chap,mschap2 default-profile=l2tp-ipsec enabled=yes</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Por que ignoro o ajuste autom√°tico de IPsec</b> <div class="spoiler_text"><p>  Na configura√ß√£o do ipip, gre, eoip, l2tp, h√° uma configura√ß√£o autom√°tica da conex√£o ipsec; na verdade, o sistema cria regras din√¢micas para pares e pol√≠ticas para voc√™, mas primeiro n√£o procuramos maneiras f√°ceis e, segundo, ao atualizar de 6.42 para 6,43, t√∫neis criados automaticamente quebrou e n√£o o fato de que isso n√£o acontecer√° novamente. </p></div></div><br><p>  Configura√ß√£o passo a passo do IPSec: </p><br><ol><li>  Crie um novo grupo (voc√™ pode usar o padr√£o) </li><li>  Criar propostas para IKE Phase1 </li><li>  Criamos um banquete, ou melhor, uma sub-rede.  Jura pela chave PSK, mas se estamos lidando com o Windows como cliente, temos uma op√ß√£o: Certificados ou PSK. </li><li>  Defina passivo = yes e send-init-contact = n√£o, em generate-policy = port-strict (aceitar porta do cliente) </li><li>  Criar propostas para o SA </li><li>  Crie um modelo para gerar pol√≠ticas </li><li>  Especificar proposta para SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o Mikrotik</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/ua/a8/ph/uaa8phm-3iy-qvrxuc6m4kbirr8.png" alt="imagem"></a> <br>  <em>Na captura de tela, o erro √© especificar dst.</em>  <em>porta e src.</em>  <em>porta n√£o √© necess√°ria</em> </p><br><p>  Op√ß√£o de console: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec policy group add name=l2tp-ipsec #2 /ip ipsec peer profile add dh-group=modp1024 enc-algorithm=aes-256 hash-algorithm=sha256 name=l2tp-ipsec-ike #3-4 /ip ipsec peer add address=0.0.0.0/0 generate-policy=port-strict passive=yes policy-template-group=l2tp-ipsec profile=l2tp-ipsec-ike secret=secret-ipsec-pass send-initial-contact=no #5 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=l2tp-ipsec-sa pfs-group=none #6-7 /ip ipsec policy add dst-address=0.0.0.0/0 group=l2tp-ipsec proposal=l2tp-ipsec-sa protocol=udp src-address=0.0.0.0/0 template=yes</code> </pre> </div></div><br><p>  <strong>Configura√ß√£o de firewall para criar conex√µes L2TP somente ap√≥s IPSec</strong> </p><br><pre> <code class="plaintext hljs">/ip firewall filter # IKE, NAT-T  ipsec-esp add chain=input protocol=17 dst-port=500,4500 action=accept add chain=input protocol=50 action=accept # L2TP,     ipsec    add chain=input protocol=17 dst-port=1701 ipsec-policy=in,ipsec action=accept add chain=input protocol=17 dst-port=1701 action-drop</code> </pre> <br><h4 id="ikev2-vpn">  VPN IKEv2 </h4><br><p>  A op√ß√£o L2TP √© popular, mas, gra√ßas √† configura√ß√£o do modo, voc√™ pode configurar o servidor VPN usando apenas IPSec.  Este √© um tipo promissor de VPN, mas at√© agora raramente usado. Al√©m de configurar o lado do servidor, darei um exemplo de configura√ß√£o do cliente strongSwan no Android. </p><br><p><img src="https://habrastorage.org/webt/el/un/fu/elunfukm2k6qajijslvcfd-zvuy.png" alt="imagem"></p><br><p>  Claro, nem tudo √© t√£o r√≥seo.  A maioria dos sistemas operacionais "usu√°rios" (em particular Windows e Android) concorda em trabalhar com essa VPN somente se eles forem autenticados por certificados ou EAP. </p><br><p>  <em>Certificados s√£o meu ponto fraco, se algu√©m souber como gerar corretamente um certificado autoassinado que o Windows importa e utilizar√° na conex√£o, escreva nos coment√°rios.</em> </p><br><p>  Gera√ß√£o preliminar de certificados: </p><br><pre> <code class="plaintext hljs">#Root CA   /certificate add name=ca common-name="IKEv2 CA" days-valid=6928 /certificate sign ca ca-crl-host=&lt;IP &gt; #   vpn /certificate add common-name=&lt;IP &gt; subject-alt-name=IP:&lt;IP &gt; key-usage=tls-server name=vpn days-valid=6928 #   /certificate sign vpn ca=ca #   #       ,       #     Revoke   /certificate add common-name=client key-usage=tls-client name=client days-valid=6928 #   /certificate sign client ca=ca</code> </pre> <br><p>  Configura√ß√£o passo a passo da VPN IKEv2: </p><br><ol><li>  Criamos um conjunto de endere√ßos para distribui√ß√£o aos clientes </li><li>  Crie um perfil de configura√ß√£o de modo para distribuir par√¢metros IP aos clientes </li><li>  Crie grupos para vincular modelos de pares e pol√≠ticas </li><li>  Criar propostas para IKE Phase1 </li><li>  Crie um perfil para conectar pares.  Autentica√ß√£o de certificado, Protocolo IKEv2, Modo passivo </li><li>  Especifique o perfil de configura√ß√£o do modo, um grupo de 3 etapas e ative a gera√ß√£o de pol√≠ticas </li><li>  Criar propostas para o SA </li><li>  Crie um modelo para gerar pol√≠ticas </li><li>  Especificar propostas para SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Configurar Mikrotik</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/1r/8w/vj/1r8wvjsgjjwhijje2dhwb90qv78.png" alt="imagem"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip pool add name=pool-ike ranges=192.168.77.10-192.168.77.20 #2 /ip ipsec mode-config add address-pool=pool-ike address-prefix-length=32 name=ikev2-vpn static-dns=77.88.8.8 system-dns=no #3 /ip ipsec policy group add name=ikev2-vpn #4 /ip ipsec peer profile add enc-algorithm=aes-256,aes-128 hash-algorithm=sha256 name=ikev2-vpn #5-6 /ip ipsec peer add address=0.0.0.0/0 auth-method=rsa-signature certificate=vpn exchange-mode=ike2 generate-policy=port-strict mode-config=ikev2-vpn passive=yes policy-template-group=ikev2-vpn profile=ikev2-vpn send-initial-contact=no #7 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=ikev2-vpn #8-9 /ip ipsec policy add dst-address=0.0.0.0/0 group=ikev2-vpn proposal=ikev2-vpn src-address= 0.0.0.0/0 template=yes</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Configura√ß√£o do StrongSwan no android.</b> <div class="spoiler_text"><p>  <em>Primeiro, voc√™ precisa transferir os certificados de cliente e ca para o telefone.</em> <br>  <a href="">https://habrastorage.org/webt/tp/pk/ad/tppkadaifd1k7xi6hf3jxgg7vcs.png</a> </p><br><p>  <em>Para olhos grandes: uma cruz perto de wi-fi significa</em>  <em>a maioria dos aplicativos do sistema √© bloqueada pelo AFWall +.</em> </p></div></div><br><p>  Se a conex√£o for bem-sucedida, voc√™ ver√°: pol√≠tica din√¢mica, gravando em pares remotos e um par de SA. </p><br><p><img src="https://habrastorage.org/webt/89/ov/4w/89ov4wsqvw7r-dvsoz2crontmlk.png" alt="imagem"></p><br><p><img src="https://habrastorage.org/webt/cc/b2/ic/ccb2icr_nqz32btmghwptrz7svc.png" alt="imagem"></p><br><p><img src="https://habrastorage.org/webt/sl/cn/gz/slcngz0e3objej8x3fw4-m3wypc.png" alt="imagem"></p><br><p>  <em>As licen√ßas de demonstra√ß√£o do RouterOS x86 n√£o t√™m restri√ß√µes quanto ao n√∫mero de t√∫neis IPSec, incluindo a VPN IKEv2.</em>  <em>Voc√™ pode implantar a demonstra√ß√£o do RouterOS x86 (n√£o confunda com o RouterOS CHR gr√°tis, tudo fica triste) no VPS e obter um servidor VPN pessoal com o m√≠nimo de esfor√ßo administrativo, sem comprar uma licen√ßa para o RouterOS ou o RouterOS CHR.</em> </p><br><h3 id="para-slov-pro-analiz-logov-ipsec">  Algumas palavras sobre a an√°lise de log IPSec </h3><br><p>  Os logs no Mikrotik s√£o uma hist√≥ria separada, √†s vezes s√£o detalhados o suficiente para analisar problemas, mas a falta de recursos banais: limpar, copiar, encontrar obriga a instalar um servidor syslog separado. </p><br><p>  Quanto ao IPSec, aqui est√° uma op√ß√£o de an√°lise r√°pida de log (deixamos apenas o necess√°rio em uma guia separada): </p><br><p><img src="https://habrastorage.org/webt/05/rz/_g/05rz_grffjd7zz1r-a8zhsi87cy.png" alt="imagem"></p><br><pre> <code class="plaintext hljs">/system logging action add memory-lines=100000 name=ipsec target=memory /system logging add action=ipsec topics=ipsec,error add action=ipsec topics=ipsec,debug,!packet add action=ipsec topics=ipsec,info</code> </pre> <br><p>  E alguns exemplos de problemas t√≠picos de configura√ß√£o IPSec: </p><br><div class="spoiler">  <b class="spoiler_title">Problema de consist√™ncia das propostas na fase 1</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bp/jm/y1/bpjmy12i4eieobnfhrnj3hlvpcq.png" alt="imagem"></p><br><ol><li>  Leia a mensagem de erro.  O problema √© quando reconciliar propostas na primeira fase. </li><li>  Observamos acima, o pr√≥prio roteador sugere que ele enviou um banquete e o que est√° configurado localmente </li></ol></div></div><br><div class="spoiler">  <b class="spoiler_title">Problema de reconcilia√ß√£o de problema IKE_SA_INIT</b> <div class="spoiler_text"><p>  Nos logs, voc√™ ver√° algo como o seguinte: </p><br><p><img src="https://habrastorage.org/webt/8i/d9/gh/8id9ghqgdgxsjjsfhn3zcn5_vtq.png"></p><br><p>  Analisando tr√°fego </p><br><p>  Na solicita√ß√£o, voc√™ pode ver as propostas do banquete: </p><br><p><img src="https://habrastorage.org/webt/pw/u2/ib/pwu2ibw3dyxswemrr74wcbphcoy.png"></p><br><p>  Na resposta, vemos que nenhuma proposta adequada foi encontrada: </p><br><p><img src="https://habrastorage.org/webt/q2/lb/qk/q2lbqkcr8qvtd1hgia4fj0hrb44.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Problema de reconcilia√ß√£o de propostas para SA</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/2y/yg/7m/2yyg7ma7ko4lce5vsyef4nmojdi.png"><br>  O roteador solicita o erro de propostas na fase2 e mostra o que est√° configurado localmente e o que √© remoto. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Problema de reconcilia√ß√£o das propostas IKE_AUTH</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bn/pk/vn/bnpkvnfazxyqmpbvdg78e26mfgy.png"><br>  Vemos que houve uma conex√£o e autentica√ß√£o de pares, mas ainda existe um erro de proposta.  Voc√™ tamb√©m n√£o ver√° detalhes na depura√ß√£o, no wireshark (o tr√°fego IKE_AUTH √© criptografado). </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Erro de autentica√ß√£o PSK</b> <div class="spoiler_text"><p>  Para IKE: </p><br><p><img src="https://habrastorage.org/webt/cp/wm/b5/cpwmb55qp8qyjmba_xijboxmiwa.png"></p><br><p>  Para IKEv2: <br><img src="https://habrastorage.org/webt/ks/fn/k0/ksfnk0qdgmgizzusfsyrlwxvcfs.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Modo IKE incorreto</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/md/fb/ll/mdfbllmvedawn5ptdd-yvjcsrpw.png" alt="imagem"><br>  Vemos que a Fase 1 interrompe o tempo limite, embora os pacotes passem entre pares.  Mas o tamanho do pacote recebido √© muito maior; se analisarmos atrav√©s do wireshark, veremos que o ponto remoto usa o modo agressivo. </p><br><p><img src="https://habrastorage.org/webt/3g/ke/ii/3gkeiidaj8m-fs0ky7ucxqjxx6k.png"><br>  Vemos que os pacotes s√£o enviados por n√≥s para o UDP: 500 e eles chegam ao UDP: 4500 e s√£o bastante grandes.  Aqui, o ponto remoto possui o modo IKEv2. </p></div></div><br><p>  Por fim, leia a se√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">de solu√ß√£o de problemas do wiki</a> .  E todo o material sobre o IPSec √© desej√°vel para o conhecido, descrevi apenas o conjunto b√°sico de ferramentas e configura√ß√µes. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438176/">https://habr.com/ru/post/pt438176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438166/index.html">Intera√ß√£o entre um site em um navegador e um programa em execu√ß√£o local</a></li>
<li><a href="../pt438168/index.html">Como quebrar uma c√¢mera cara para que sua esposa n√£o o mate</a></li>
<li><a href="../pt438170/index.html">Pr√™mio nomeado ap√≥s Ilya Segalovich. Hist√≥ria sobre Ci√™ncia da Computa√ß√£o e Publica√ß√µes de Lan√ßamento</a></li>
<li><a href="../pt438172/index.html">Apple incapaz de transferir a produ√ß√£o de seus dispositivos para os EUA</a></li>
<li><a href="../pt438174/index.html">Amarelo - V√°cuo - Nuvem</a></li>
<li><a href="../pt438178/index.html">Criando seu primeiro aplicativo ARCore</a></li>
<li><a href="../pt438180/index.html">Registrar uma transa√ß√£o imobili√°ria on-line</a></li>
<li><a href="../pt438182/index.html">O estudo constatou os benef√≠cios da pirataria moderada para produtores e distribuidores de conte√∫do</a></li>
<li><a href="../pt438196/index.html">Se o projeto for "Teatro", use atores ...</a></li>
<li><a href="../pt438198/index.html">Vamos aprofundar a hist√≥ria: onde crescem as pernas dos quadroc√≥pteros</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>