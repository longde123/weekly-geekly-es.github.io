<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚èÆÔ∏è üë∂üèø üòµ Comment j'ai refus√© DB4O dans un syst√®me industriel üèáüèΩ ü§∏üèæ üëø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous sommes un d√©partement de grande entreprise d√©veloppant un important syst√®me Java SE / MS SQL / db4o. Pendant plusieurs ann√©es, le projet est pass...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai refus√© DB4O dans un syst√®me industriel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461417/"><p><img src="https://habrastorage.org/webt/ql/p2/ye/qlp2yevkdo5rbywpveackt_fm7s.jpeg" alt="image"></p><br><p>  Nous sommes un d√©partement de grande entreprise d√©veloppant un important syst√®me Java SE / MS SQL / db4o.  Pendant plusieurs ann√©es, le projet est pass√© d'un prototype √† une exploitation industrielle et db4o s'est transform√© en frein de calcul, j'ai voulu passer de db4o √† la technologie noSQL moderne.  Les essais et les erreurs ont conduit loin du plan d'origine - il √©tait possible de refuser db4o, mais au prix d'un compromis.  Sous les r√©flexions du chat et les d√©tails d'impl√©mentation </p><a name="habracut"></a><br><h2 id="tehnologiya-db4o-umerla">  La technologie db4o est-elle morte? </h2><br><p>  Sur Habr√©, il est possible de trouver moins de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">publications</a> sur db4o.  Sur Stackoverflow, une sorte d'activit√© r√©siduelle est comme un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nouveau commentaire sur une ancienne question</a> ou une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nouvelle question sans r√©ponse</a> .  Wiki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pense</a> g√©n√©ralement que la version stable actuelle est dat√©e de 2011. </p><br><p>  Cela donne une impression g√©n√©rale: la technologie n'est pas pertinente.  Il y a m√™me eu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">une confirmation officielle</a> : Actian a d√©cid√© de ne plus poursuivre et promouvoir activement l'offre commerciale de produits db4o aupr√®s de nouveaux clients. </p><br><h2 id="kak-db4o-popala-v-raschet">  Comment db4o a-t-il √©t√© calcul√© </h2><br><p>  L'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Introduction aux bases de donn√©es orient√©es objet</a> parle de la principale caract√©ristique de db4o - l'absence totale d'un sch√©ma de donn√©es.  Vous pouvez cr√©er n'importe quel objet </p><br><pre><code class="plaintext hljs">User user1 = new User("Vasya", "123456", 25);</code> </pre> <br><p>  puis il suffit de l'√©crire dans le fichier de base de donn√©es </p><br><pre> <code class="plaintext hljs">db.Store(user1)</code> </pre> <br><p>  L'objet enregistr√© peut ensuite √™tre r√©cup√©r√© √† l'aide de la m√©thode Query.execute () sous la forme dans laquelle il a √©t√© enregistr√©. </p><br><p>  Au d√©but du projet, cela a permis d'assurer rapidement l'affichage de la piste d'audit avec toutes les donn√©es soumises, sans se soucier de la structure des tables relationnelles.  Cela a aid√© le projet √† survivre.  Ensuite, il y avait peu de ressources dans le bac √† sable, et imm√©diatement apr√®s la fin du calcul d'aujourd'hui, les donn√©es de demain ont commenc√© √† se charger dans MS SQL.  Tout changeait constamment - allez d√©couvrir ce qui √©tait servi automatiquement la nuit.  Et le fichier db4o est accessible <br>  lors du d√©bogage, extrayez un instantan√© du jour souhait√© et r√©pondez √† la question "nous avons soumis toutes les donn√©es, mais vous n'avez rien command√©". </p><br><p>  Au fil du temps, le probl√®me de survie a disparu, le projet a d√©coll√©, le travail avec les demandes des utilisateurs a chang√©.  Ouvrez un fichier db4o en d√©bogage et analysez une question difficile pour un d√©veloppeur toujours occup√©.  Au lieu de cela, il y a une foule d'analystes, arm√©s d'une description de la logique de commande et capables d'utiliser uniquement la partie visible par l'utilisateur des donn√©es.  Bient√¥t, db4o a commenc√© √† √™tre utilis√© uniquement pour afficher l'historique du calcul.  Tout comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pareto</a> - une petite partie des capacit√©s fournit la charge principale. </p><br><p>  En op√©ration de combat, le fichier historique prend ~ 35 Go / jour, le d√©chargement prend environ une heure.  Le fichier lui-m√™me se comprime bien (1:10), mais pour une raison quelconque, la biblioth√®que com.db4o.ObjectContainer n'effectue pas de compression.  Au nord de CentOS, la biblioth√®que com.db4o.query.Query √©crit / lit un fichier exclusivement dans un flux.  La vitesse est un goulot d'√©tranglement. </p><br><h1 id="principialnaya-shema-ustroystva">  Sch√©ma de principe de l'appareil </h1><br><p>  Le mod√®le d'information du syst√®me est la hi√©rarchie des objets A, B, C et D. La hi√©rarchie n'est pas un arbre; les liens C1 -&gt; B1 sont n√©cessaires pour le fonctionnement. </p><br><pre> <code class="plaintext hljs">ROOT || | ==&gt;A1 | || | | ==&gt; B1 &lt;------ | | || | | | | ======&gt; C1 | | | | | | | ===&gt; C1.$D | | =======&gt; C2 | | | | ==&gt; B2 ==&gt; C2.$D | | ===&gt;A2 =======&gt; C3 | | ==&gt; B3 ===&gt; C3.$D | ======&gt; C4 | ===&gt; C4.$D</code> </pre> <br><p>  L'utilisateur interagit avec le serveur via l'interface utilisateur (GUI), qui est fournie par com.sun.net.httpserver.HttpsServer, le client et le serveur √©changent des documents XML.  Lors du premier affichage, le serveur attribue un identifiant au niveau utilisateur, qui ne change plus.  Si l'utilisateur a besoin d'un historique d'un certain niveau, l'interface graphique envoie au serveur un identificateur envelopp√© XML.  Le serveur d√©termine les valeurs des cl√©s de recherche dans la base de donn√©es, analyse le fichier db4o pour le jour souhait√© et r√©cup√®re l'objet demand√© en m√©moire ainsi que tous les objets auxquels il se r√©f√®re.  Construit une pr√©sentation XML du niveau extrait et la renvoie au client. </p><br><p>  Lors de l'analyse d'un fichier, db40 lit par d√©faut tous les objets enfants √† une certaine profondeur, en extrayant une hi√©rarchie assez large avec l'objet souhait√©.  Le temps de lecture peut √™tre r√©duit en d√©finissant la profondeur d'activation minimale pour la classe Foo inutile avec conf.common (). ObjectClass (Foo.class) .maximumActivationDepth (1). </p><br><p>  L'utilisation de classes anonymes conduit √† la cr√©ation de r√©f√©rences implicites √† la classe englobante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">this $ 0</a> .  Db4o traite et restaure ces liens correctement (mais lentement). </p><br><h1 id="0-ideya">  0. Id√©e </h1><br><p>  Ainsi, les administrateurs ont une expression √©trange sur leur visage lorsqu'il s'agit de soutenir ou d'administrer db4o.  L'extraction des donn√©es est lente, la technologie n'est pas tr√®s vivante.  T√¢che: au lieu de db4o, appliquez la technologie NoSQL actuelle.  Une paire de Spring Data + MongoDB a attir√© mon attention. </p><br><h1 id="1-lobovoy-podhod">  1. Approche frontale </h1><br><p>  Ma premi√®re <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pens√©e a</a> √©t√© d'utiliser org.springframework.data.mongodb.core.MongoOperations et la m√©thode save (), car elle ressemble √† com.db4o.ObjectContainer.db.Store (user1).  La documentation MongoDB indique que les documents sont stock√©s dans des collections, il est logique de pr√©senter les objets syst√®me n√©cessaires en tant que documents des collections correspondantes.  Il existe √©galement des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">annotations @ DBRef</a> qui vous permettent d'impl√©menter les relations entre les documents en g√©n√©ral dans l'esprit de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3NF</a> .  Allons-y. </p><br><h2 id="11-vygruzka-ssylochnyy-tip-klyucha">  1.1.  D√©chargement.  Type de r√©f√©rence de cl√© </h2><br><p>  Le syst√®me se compose de classes POJO con√ßues depuis longtemps et sans prendre en compte toutes ces nouvelles technologies.  Des champs de type Map &lt;POJO, POJO&gt; sont utilis√©s, il y a une logique branch√©e de travailler avec eux.  J'enregistre ce champ, j'obtiens une erreur </p><br><pre> <code class="plaintext hljs">org.springframework.data.mapping.MappingException: Cannot use a complex object as a key value.</code> </pre> <br><p>  A cette occasion, seule la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">correspondance de 2011 a √©t√© trouv√©e</a> , dans laquelle il √©tait propos√© de d√©velopper le MappingMongoConverter non standard.  A not√© jusqu'ici les champs probl√©matiques @ Transitoire, je continue.  Il s'est av√©r√© sauver, en √©tudiant le r√©sultat. </p><br><p>  L'enregistrement se produit dans la collection, dont le nom co√Øncide avec le nom de la classe enregistr√©e.  Je n'ai pas encore utilis√© d'annotations @DBRef, donc il n'y a qu'une seule collection, les documents JSON sont assez volumineux et ramifi√©s.  Je remarque que lorsque vous enregistrez l'objet, MongoOperations parcourt tous les liens (y compris h√©rit√©s) non vides et les √©crit en tant que document joint. </p><br><h2 id="12-vygruzka-imenovannoe-pole-ili-massiv">  1.2.  D√©chargement.  Champ ou tableau nomm√©? </h2><br><p>  Le mod√®le de syst√®me est tel que la classe C peut contenir plusieurs fois une r√©f√©rence √† la m√™me classe D.  Dans un champ defaultMode distinct et parmi d'autres liens dans ArrayList, quelque chose comme ceci <br></p><pre> <code class="plaintext hljs">public class C { private D defaultMode; private List&lt;D&gt; listOfD = new ArrayList&lt;D&gt;(); public class D { .. } public C(){ this.defaultMode = new D(); listOfD.add(defaultMode); } }</code> </pre> <br><p>  Apr√®s le d√©chargement, le document JSON en aura deux copies: un document joint nomm√© defaultMode et un √©l√©ment sans nom du tableau de documents.  Dans le premier cas, le document est accessible par nom, dans le second - par le nom du tableau avec un index.  Vous pouvez rechercher des collections MongoDB dans les deux cas.  En travaillant uniquement avec Spring Data et MongoDB, je suis arriv√© √† la conclusion que vous pouvez utiliser ArrayList, si vous le faites avec soin;  Je n'ai pas remarqu√© les restrictions d'utilisation des tableaux  Les fonctionnalit√©s sont apparues plus tard, au niveau du connecteur MongoDB pour BI. </p><br><h2 id="13-zagruzka-argumenty-konstruktora">  1.3.  T√©l√©chargez  Arguments du constructeur </h2><br><p>  J'essaie de lire un document enregistr√© en utilisant la m√©thode MongoOperations.findOne ().  Le chargement de l'objet A √† partir de la base de donn√©es l√®ve une exception </p><br><pre> <code class="plaintext hljs">"No property name found on entity class A to bind constructor parameter to!"</code> </pre> <br><p>  Il s'est av√©r√© que la classe a un champ corpName, et le constructeur a un param√®tre String name, et this.corpName = name est assign√© dans le corps du constructeur.  MongoOperations requiert que les noms de champ dans les classes correspondent aux noms des arguments du constructeur.  S'il existe plusieurs constructeurs, vous devez en s√©lectionner un avec l'annotation @PersistenceConstructor.  J'apporte les noms des champs et des param√®tres en correspondance. </p><br><h2 id="14-zagruzka-sd-i-this0">  1.4.  T√©l√©chargez  Avec $ D et ce $ 0 </h2><br><p>  La classe int√©rieure imbriqu√©e D encapsule le comportement par d√©faut de la classe C et n'a pas de sens s√©par√©ment de la classe C.  Une instance de D est cr√©√©e pour chaque instance de C et vice versa - pour chaque instance de D, il existe une instance de C qui l'a g√©n√©r√©e. La classe D a des descendants qui impl√©mentent des comportements alternatifs et peuvent √™tre stock√©s dans listOfD.  Le constructeur des classes descendantes de D n√©cessite la pr√©sence d'un objet C d√©j√† existant. </p><br><p>  En plus des classes internes imbriqu√©es, le syst√®me utilise <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des</a> classes internes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">anonymes</a> .  Comme vous le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">savez</a> , les deux contiennent une r√©f√©rence implicite √† une instance d'une classe englobante.  Autrement dit, dans le cadre de chaque instance de l'objet CD, le compilateur cr√©e un lien ce $ 0, qui pointe vers l'objet parent C. </p><br><p>  Encore une fois, j'essaie de lire le document enregistr√© de la collection et d'obtenir une exception </p><br><pre> <code class="plaintext hljs">"No property this$0 found on entity class $D to bind constructor parameter to!"</code> </pre> <br><p>  Je rappelle que les m√©thodes de la classe D utilisent les r√©f√©rences C.this.fieldOfClassC avec might et main, et les descendants de la classe D n√©cessitent que le constructeur soit instanci√© avec C comme argument.  Autrement dit, je dois fournir un certain ordre de cr√©ation d'objets dans MongoOperations afin que l'objet parent C puisse √™tre sp√©cifi√© dans le constructeur D. Encore une fois, le MappingMongoConverter non standard? </p><br><p>  Peut-√™tre ne pas utiliser de classes anonymes et rendre les classes internes normales?  Affiner, ou plut√¥t affiner l'architecture d'un syst√®me d√©j√† impl√©ment√© est une t√¢che √©patante ... </p><br><h1 id="2-podhod-so-storony-3nfdbref">  2. Approche de 3NF / @ DBRef </h1><br><p>  D'un autre c√¥t√©, j'essaie d'aller, de sauvegarder chaque classe de ma collection et de faire des liens entre elles dans l'esprit de 3NF. </p><br><h2 id="21-vygruzka-dbref---eto-krasivo">  2.1.  D√©chargement.  @DBRef is beautiful </h2><br><p>  La classe C contient plusieurs r√©f√©rences √† D. Si les liens defaultMode et ArrayList sont marqu√©s comme @DBRef, la taille du document diminuera, au lieu d'√©normes documents joints, il y aura des liens soign√©s.  Dans le champ json, le document de la collection C appara√Æt <br></p><pre> <code class="plaintext hljs">"defaultMode" : DBRef("D", ObjectId("5c496eed2c9c212614bb8176"))</code> </pre> <br><p>  Dans la base de donn√©es MongoDB, une collection D est automatiquement cr√©√©e et un document avec un champ dedans </p><br><pre> <code class="plaintext hljs">"_id" : ObjectId("5c496eed2c9c212614bb8176")</code> </pre> <br><p>  Tout est simple et beau. </p><br><h2 id="22-zagruzka-konstuktor-klassa-d">  2.2.  T√©l√©chargez  Constructeur de classe D </h2><br><p>  Lorsque vous travaillez avec des liens, l'objet C sait que l'objet D par d√©faut est cr√©√© exactement une fois.  Si vous devez contourner tous les objets D sauf celui par d√©faut, comparez simplement les liens: </p><br><pre> <code class="plaintext hljs">private D defaultMode; private ArrayList&lt;D&gt; listOfD; for (D currentD: listOfD){ if (currentD == defaultMode) continue; doSomething(currentD); }</code> </pre> <br><p>  J'appelle findOne (), j'√©tudie ma classe C. Il s'av√®re que MongoOperations lit un document json et appelle le constructeur D pour chaque annotation @DBRef qu'il rencontre, cr√©ant √† chaque fois un nouvel objet.  J'obtiens une construction √©trange - deux r√©f√©rences diff√©rentes √† D dans le champ defaultMode et dans le tableau listOfD, o√π le lien doit √™tre le m√™me. </p><br><p>  Apprendre de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">communaut√©</a> : "Dbref √† mon avis devrait √™tre √©vit√© lorsque vous travaillez avec mongodb."  Une autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">consid√©ration</a> dans la m√™me veine de la documentation officielle: le mod√®le de donn√©es d√©normalis√© o√π les donn√©es connexes sont stock√©es dans un seul document sera optimal pour r√©soudre les DBRefs, votre application doit effectuer des requ√™tes suppl√©mentaires pour renvoyer les documents r√©f√©renc√©s. </p><br><p>  La page de documentation mentionn√©e indique au tout d√©but: "Pour de nombreux cas d'utilisation dans MongoDB, le mod√®le de donn√©es d√©normalis√© o√π les donn√©es associ√©es sont stock√©es dans un seul document sera optimal."  Est-ce √©crit pour moi? </p><br><p>  Concentrez-vous avec le concepteur sugg√®re que vous n'avez pas besoin de penser comme dans un SGBD relationnel.  Le choix est: </p><br><ul><li>  si vous sp√©cifiez @DBRef: <br><ul><li>  le constructeur de chaque annotation sera appel√© et plusieurs objets identiques seront cr√©√©s; </li><li>  MongoOperations trouvera et lira tous les documents de toutes les collections associ√©es.  Il y aura une demande √† l'index par ObjectId, puis la lecture de nombreuses collections d'une (grande) base de donn√©es; </li></ul></li><li>  si vous ne sp√©cifiez pas, le json "anormal" sera enregistr√© avec des r√©p√©titions des m√™mes donn√©es. </li></ul><br><p>  Je note par moi-m√™me: vous ne pouvez pas compter sur @DBRef, mais utilisez un champ de type ObjectId, en le remplissant manuellement.  Dans ce cas, au lieu de </p><br><pre> <code class="plaintext hljs">"defaultMode" : DBRef("D", ObjectId("5c496eed2c9c212614bb8176"))</code> </pre> <br><p>  le document json contiendra </p><br><pre> <code class="plaintext hljs">"defaultMode" : ObjectId("5c496eed2c9c212614bb8176")</code> </pre> <br><p>  Il n'y aura pas de chargement automatique - MongoOperations ne sait pas dans quelle collection rechercher un document.  Le document devra √™tre charg√© dans une demande distincte (paresseuse) indiquant la collection et ObjectId.  Une seule requ√™te doit retourner le r√©sultat rapidement, en outre, un index automatique est cr√©√© pour chaque collection par ObjectId. </p><br><h2 id="23-nu-i-chto-teper">  2.3.  Et maintenant? </h2><br><p>  Sous-totaux.  Il n'a pas √©t√© possible d'impl√©menter rapidement et facilement la fonctionnalit√© db4o sur MongoDB: </p><br><ul><li>  Il n'est pas clair comment utiliser un POJO personnalis√© comme cl√© - Liste de valeurs; </li><li>  On ne sait pas comment d√©finir l'ordre dans lequel les objets sont cr√©√©s dans MappingMongoConverter; </li><li>  il n'est pas clair s'il faut t√©l√©charger un document "non normalis√©" sans DBRef et s'il est n√©cessaire de trouver son propre m√©canisme pour l'initialisation paresseuse. </li></ul><br><p>  Vous pouvez ajouter un chargement paresseux.  Vous pouvez essayer de faire MappingMongoConverter.  Vous pouvez modifier les constructeurs / champs / listes existants.  Mais il y a de nombreuses ann√©es de stratification de la logique m√©tier - pas une alt√©ration faible et le risque de ne jamais √™tre test√©. </p><br><p>  Solution de compromis: cr√©er un nouveau m√©canisme d'enregistrement des donn√©es pour le probl√®me r√©solu, tout en conservant le m√©canisme d'interaction avec l'interface graphique. </p><br><h1 id="3-popytka-tretya-opyt-pervyh-dvuh">  3. La troisi√®me tentative, l'exp√©rience des deux premiers </h1><br><p>  Pareto sugg√®re que r√©soudre des probl√®mes avec la vitesse des utilisateurs signifiera le succ√®s de toute la t√¢che.  La t√¢che est la suivante: vous devez apprendre √† enregistrer et restaurer rapidement les donn√©es de pr√©sentation utilisateur sans db4o. </p><br><p>  Cela perdra la possibilit√© d'examiner l'objet enregistr√© lors du d√©bogage.  D'une part, c'est mauvais.  D'un autre c√¥t√©, de telles t√¢ches se produisent rarement, et dans git toutes les livraisons de combat sont marqu√©es.  Pour la tol√©rance aux pannes, √† chaque fois avant le d√©chargement, le syst√®me s√©rialise le calcul dans un fichier.  Si vous devez examiner un objet lors du d√©bogage, vous pouvez prendre la s√©rialisation, cloner l'assembly syst√®me correspondant et restaurer le calcul. </p><br><h2 id="31-dannye-polzovatelskih-prezentaciy">  3.1.  Donn√©es de pr√©sentation personnalis√©es </h2><br><p>  Pour cr√©er des pr√©sentations de niveaux utilisateur, le syst√®me dispose d'une classe Viewer sp√©ciale.  La m√©thode Viewer.getXML () re√ßoit un niveau en entr√©e, en extrait les valeurs num√©riques et de cha√Æne n√©cessaires et g√©n√®re du XML. </p><br><p>  Si l'utilisateur a demand√© d'afficher le niveau du calcul d'aujourd'hui, alors le niveau sera trouv√© dans la RAM.  Pour afficher un calcul du pass√©, la m√©thode com.db4o.query.Query.execute () trouvera le niveau dans le fichier.  Le niveau du fichier n'est presque pas diff√©rent du niveau qui vient d'√™tre cr√©√© et Viewer construira la pr√©sentation sans remarquer la substitution. </p><br><p>  Pour r√©soudre mon probl√®me, j'ai besoin d'un interm√©diaire entre le niveau de calcul et sa pr√©sentation - le cadre de pr√©sentation (Frame), qui stockera les donn√©es et s'appuiera sur les donn√©es XML disponibles.  La cha√Æne d'actions pour la construction de la pr√©sentation s'allongera, chaque fois qu'un cadre sera g√©n√©r√© et que le cadre g√©n√©rera du XML: </p><br><pre> <code class="plaintext hljs"> : &lt; &gt; -&gt; Viewer.getXML() : &lt; &gt; -&gt; Viewer.getFrame() -&gt; Frame.getXML()</code> </pre> <br><p>  Lors de l'enregistrement de l'histoire, vous devrez cr√©er des cadres de tous les niveaux et √©crire dans la base de donn√©es. </p><br><h2 id="32-vygruzka">  3.2.  D√©chargement </h2><br><p>  La t√¢che √©tait relativement simple et ne posait aucun probl√®me.  R√©p√©tant la structure de la pr√©sentation XML, le cadre a re√ßu un dispositif r√©cursif sous la forme d'une hi√©rarchie d'√©l√©ments avec les champs String, Integer et Double.  Le cadre demande getXML () √† tous ses √©l√©ments, le recueille dans un seul document et retourne.  MongoOperations a fait un excellent travail avec la nature r√©cursive du cadre et n'a pas pos√© de nouvelles questions √† mesure qu'il progressait. </p><br><p>  Enfin, tout a d√©coll√©!  Le moteur WiredTiger <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compresse</a> par d√©faut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les</a> collections de documents MongoDB; sur le syst√®me de fichiers, le d√©chargement prenait environ 3,5 Go par jour.  Une diminution de dix fois par rapport √† db4o n'est pas mauvaise. </p><br><p>  Au d√©but, le d√©chargement √©tait organis√© simplement - une travers√©e r√©cursive de l'arbre de niveau, MongoOperations.save () pour chacun.  Un tel d√©chargement a pris 5,5 heures, et ce malgr√© le fait que la construction de pr√©sentations implique uniquement la lecture d'objets.  J'ajoute le multithreading: parcourir r√©cursivement l'arborescence des niveaux, diviser tous les niveaux disponibles en packages d'une certaine taille, cr√©er des impl√©mentations Callable.call () en fonction du nombre de packages, transf√©rer chaque package vers notre propre package et tout faire via ExecutorService.invokeAll (). </p><br><p>  MongoOperations n'a de nouveau pos√© aucune question et a fait un excellent travail avec le mode multi-thread.  Empiriquement s√©lectionn√© la taille de l'emballage, donnant la meilleure vitesse de d√©chargement.  Il s'est av√©r√© 15 minutes pour un package de 1000 niveaux. </p><br><h2 id="33-mongo-bi-connector-ili-kak-lyudyam-s-etim-rabotat">  3.3.  Mongo BI Connector, ou comment les gens travaillent avec lui </h2><br><p>  Le langage de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">requ√™te</a> MongoDB est grand et puissant, j'ai in√©vitablement acquis une exp√©rience de travail avec lui, atteignant cet endroit.  La console <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prend en charge</a> JavaScript, vous pouvez √©crire des designs magnifiques et puissants.  Ceci est un c√¥t√©.  De l'autre, je peux briser le cerveau d'une bonne moiti√© de coll√®gues analystes avec une demande </p><br><pre> <code class="plaintext hljs">db.users.find( { numbers: { $in: [ 390, 754, 454 ] } } );</code> </pre> <br><p>  au lieu de l'habituel </p><br><pre> <code class="plaintext hljs">SELECT * FROM users WHERE numbers IN (390, 754, 454)</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MongoDB Connector for BI</a> vient √† la rescousse, √† travers lequel vous pouvez pr√©senter des documents de collection sous forme de tableau.  La base de donn√©es MongoDB est appel√©e base de donn√©es documentaire, elle ne sait pas pr√©senter une hi√©rarchie de champs / documents sous forme tabulaire.  Pour que le connecteur fonctionne, il est n√©cessaire de d√©crire la structure de la future table dans un fichier .drdl distinct, dont le format est tr√®s similaire √† yaml.  Dans le fichier, vous devez sp√©cifier la correspondance entre le champ de la table relationnelle en sortie et le chemin d'acc√®s au champ du document JSON en entr√©e. </p><br><h2 id="34--osobennosti-ispolzovanie-massivov">  3.4.  Fonctionnalit√©s utilisant des tableaux </h2><br><p>  Il a √©t√© dit plus haut que pour MongoDB lui-m√™me, il n'y a pas de diff√©rence particuli√®re entre un tableau et un champ.  Du point de vue du connecteur, un tableau est tr√®s diff√©rent d'un champ nomm√©;  J'ai m√™me d√ª refactoriser la classe Frame termin√©e.  Un tableau de documents ne doit √™tre utilis√© que lorsqu'il est n√©cessaire de placer une partie des informations dans un tableau li√©. </p><br><p>  Si le document JSON est une hi√©rarchie de champs nomm√©s, n'importe quel champ est accessible en sp√©cifiant le chemin depuis la racine du document jusqu'√† un point, par exemple xy. Si la correspondance xy =&gt; fieldXY est sp√©cifi√©e dans le fichier DRDL, la table de sortie aura autant de lignes qu'il y a de documents dans la collection √† l'entr√©e.  Si dans certains documents, il n'y a pas de champ xy, NULL sera dans la ligne correspondante du tableau. </p><br><p>  Supposons que nous ayons une base de donn√©es MongoDB appel√©e Frames, il y a une collection A dans la base de donn√©es et MongoOperations a √©crit deux instances de classe A dans cette collection. Ce sont les documents: d'abord </p><br><pre> <code class="plaintext hljs">{ "_id": ObjectId("5cdd51e2394faf88a01bd456"), "x": { "y": "xy string value 1"}, "days": [{ "k": "0", "v": 0.0 }, { "k": "1", "v": 0.1 }], "_class": "A" }</code> </pre> <br><p>  et deuxi√®me (ObjectId diff√®re par le dernier chiffre): </p><br><pre> <code class="plaintext hljs">{ "_id": ObjectId("5cdd51e2394faf88a01bd457"), "x": { "y": "xy string value 2"}, "days": [{ "k": "0", "v": 0.3 }, { "k": "1", "v": 0.4 }], "_class": "A" }</code> </pre> <br><p>  Le connecteur BI n'est pas en mesure d'acc√©der aux √©l√©ments du tableau par index, et il est tout simplement impossible d'extraire, par exemple, le champ days [1] .v du tableau dans le tableau.  Au lieu de cela, le connecteur peut repr√©senter chaque √©l√©ment du tableau jours sous la forme d'une ligne dans une table distincte √† l'aide de l'op√©rateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">$ unwind</a> .  Cette table distincte sera associ√©e √† la relation un-√†-plusieurs d'origine via l'identificateur de ligne.  Dans notre exemple, les tables tableA sont d√©finies pour les documents de collection et tableA_days pour les documents du tableau jours.  Le fichier .drdl ressemble √† ceci: </p><br><pre> <code class="plaintext hljs">schema: - db: Frames tables: - table: tableA collection: A pipeline: [] columns: - Name: _id MongoType: bson.ObjectId SqlName: _id SqlType: objectid - Name: xy MongoType: string SqlName: fieldXY SqlType: varchar - table: tableA_days collection: A pipeline: - $unwind: path: $days columns: - Name: _id #   MongoType: bson.ObjectId SqlName: tableA_id SqlType: objectid - Name: days.k MongoType: string SqlName: tableA_dayNo SqlType: varchar - Name: days.v MongoType: string SqlName: tableA_dayVal SqlType: varchar</code> </pre> <br><p>  Le contenu des tableaux sera: table tableA </p><br><div class="scrollable-table"><table><thead><tr><th>  _id </th><th>  fieldXY </th></tr></thead><tbody><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  valeur de cha√Æne xy 1 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  valeur de cha√Æne xy 2 </td></tr></tbody></table></div><br><p>  et table tableA_days </p><br><div class="scrollable-table"><table><thead><tr><th>  tableA_id </th><th>  tableA_dayNo </th><th>  tableA_dayVal </th></tr></thead><tbody><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  0 </td><td>  0,0 </td></tr><tr><td>  5cdd51e2394faf88a01bd456 </td><td>  1 </td><td>  0,1 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  0 </td><td>  0,3 </td></tr><tr><td>  5cdd51e2394faf88a01bd457 </td><td>  1 </td><td>  0,4 </td></tr></tbody></table></div><br><h1 id="itogo">  Total </h1><br><p>  Il n'a pas √©t√© possible d'impl√©menter la t√¢che dans la formulation d'origine; vous ne pouvez pas simplement prendre et remplacer db4o par MongoDB.  MongoOperations n'est pas en mesure de restaurer automatiquement un objet tel que db4o.  Vous pouvez probablement le faire, mais les co√ªts de main-d'≈ìuvre ne seront pas comparables √† l'appel des m√©thodes store / query de la biblioth√®que db4o. </p><br><p>  Piste d'audit.  Db4o est un outil tr√®s utile au d√©but d'un projet.  Vous pouvez simplement √©crire l'objet, puis le restaurer et en m√™me temps sans soucis ni tableaux.  Tout cela avec une mise en garde importante: si vous devez changer la hi√©rarchie des classes (ajoutez la classe E entre A et B), alors toutes les informations pr√©c√©demment stock√©es deviennent illisibles.  Mais pour d√©marrer un projet, ce n'est pas tr√®s important, tant qu'il n'y a pas de grand tableau accumul√© d'anciens fichiers. </p><br><p>  Lorsqu'il y avait suffisamment d'exp√©rience avec MongoOperations, l'√©criture du t√©l√©chargement n'a pas caus√© de probl√®mes.  Il est beaucoup plus facile d'√©crire un nouveau code pour le framework que de refaire l'ancien, qui est √©galement mis en production. </p><p></p><p></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461417/">https://habr.com/ru/post/fr461417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461401/index.html">Que faites-vous, boucle d'√©v√©nement? Ou comment fonctionne la boucle d'√©v√©nements dans le navigateur Chrome</a></li>
<li><a href="../fr461403/index.html">Comment √©crire de la musique en utilisant OOP</a></li>
<li><a href="../fr461405/index.html">Comment j'ai pris le CFA niveau 1</a></li>
<li><a href="../fr461407/index.html">De l'histoire des vacances - AdminFest 2011 √† Rostov-sur-le-Don</a></li>
<li><a href="../fr461413/index.html">Pas seulement le Wi-Fi 6: comment Huawei d√©veloppera les technologies de r√©seau</a></li>
<li><a href="../fr461421/index.html">Comment vous assurer contre d'√©ventuelles pertes lors d'un investissement en bourse: produits structurels</a></li>
<li><a href="../fr461423/index.html">11 conseils: comment pr√©senter le travail UI / UX √† des ¬´non-concepteurs¬ª</a></li>
<li><a href="../fr461425/index.html">Comment devenir chef de produit et √©voluer</a></li>
<li><a href="../fr461431/index.html">¬´Aime et n'aime pas¬ª: DNS sur HTTPS</a></li>
<li><a href="../fr461433/index.html">Utilisation d'Identity Server 4 dans Net Core 3.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>