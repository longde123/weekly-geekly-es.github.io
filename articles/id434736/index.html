<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎼 🔨 👸🏻 Menggunakan database log Mikrotik untuk menekan kekerasan 🤲🏿 🙌🏻 ☠️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang 

 Dalam publikasi sebelumnya , saya berbicara tentang bagaimana, dengan mudah dan alami, Anda dapat mengkonfigurasi pengumpulan metadat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menggunakan database log Mikrotik untuk menekan kekerasan</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434736/"> Selamat siang <br><br>  Dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">publikasi</a> sebelumnya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">,</a> saya berbicara tentang bagaimana, dengan mudah dan alami, Anda dapat mengkonfigurasi pengumpulan metadata lalu lintas jaringan pada router Mikrotik dalam database. <br><br>  Sekarang saatnya mengajar server kami untuk melakukan analisis elementer dari data yang diterima dan mengirim perintah kembali. <br><br>  <b>Tujuan:</b> Kontrol dinamis aturan firewall Mikrotik untuk menekan serangan jaringan dengan menebak kata sandi. <br><br>  <b>Berarti:</b> Distribusi Linux segar dengan rsyslogd v8, crond, mariadb DBMS dan router Mikrotik itu sendiri. <br><br>  <b>Mekanika:</b> Menggunakan tugas yang diberikan, kueri SQL dijalankan dalam database dengan akumulasi dan data lalu lintas yang diperbarui dan mengembalikan daftar alamat IP keluar, skrip bash yang diluncurkan oleh mahkota menghasilkan perintah Mikrotik dan, menggunakan koneksi ssh, mengisi kembali daftar alamat untuk aturan pemblokiran yang ada. <br><a name="habracut"></a><br>  Ini akan tentang melindungi port TCP terbuka.  Ini bisa berupa port yang memasuki Mikrotik dan diteruskan ke jaringan lokal. <br><br>  Untuk memulainya, kami menunjukkan di mana mungkin ada kelemahan: <br><br><ul><li>  Protokol kontrol ssh, telnet, web, router winbox </li><li>  Layanan email smtp, pop, imap </li><li>  Layanan web apa pun yang disediakan di luar </li><li>  Remote Desktop MS RDP, VNC, dll. </li><li>  Ada lagi yang menurut pertimbangan Anda </li></ul><br>  <b>Menulis kueri SQL untuk mencari brute force</b> <br><br>  Organisasi kami memiliki server terminal terbuka ke luar melalui port non-prioritas. <br>  Di DNAT Mikrotik saya menyalakan logging aturan yang diperlukan dengan menambahkan awalan RDP_DNAT.  Dengan awalan ini kami akan mencari: <br><br><pre><code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime&gt;<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'RDP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">having</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport)&gt;<span class="hljs-number"><span class="hljs-number">50</span></span>; +<span class="hljs-comment"><span class="hljs-comment">-----------------+-------+---------------------------------------+ | src | dport |   | +-----------------+-------+---------------------------------------+ | 185.156.177.58 | 12345 | 118 | | 185.156.177.59 | 12345 | 267 | | 193.238.46.12 | 12345 | 318 | | 193.238.46.13 | 12345 | 319 | | 193.238.46.99 | 12345 | 342 | | 194.113.106.150 | 12345 | 67 | | 194.113.106.152 | 12345 | 167 | | 194.113.106.153 | 12345 | 190 | | 194.113.106.154 | 12345 | 192 | | 194.113.106.155 | 12345 | 190 | | 194.113.106.156 | 12345 | 216 | | 194.113.106.158 | 12345 | 124 | +-----------------+-------+---------------------------------------+ 12 rows in set (0.06 sec)</span></span></code> </pre> <br>  Permintaan ini menunjukkan alamat ip (dari mana serangan itu datang), port tempat koneksi dibuat (nomor port diubah) dan jumlah upaya koneksi, dengan pengelompokan awal dengan src dan pemilihan garis, dengan jumlah upaya lebih dari 50 di masa lalu, dari saat saat ini, hari. <br><br>  Dalam kasus saya, alamat ini dapat dilarang dengan aman, karena jumlah koneksi dengan klien "baik" kurang, tidak lebih dari 5-10 per hari dari satu ip. <br><br>  Permintaan berfungsi dengan baik, cepat, tapi agak panjang.  Untuk penggunaan lebih lanjut, saya mengusulkan untuk membuat tampilan, yang akan menyalin lebih sedikit di masa depan: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> rdp_brute_day <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src, dport, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime&gt;<span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'RDP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">having</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport)&gt;<span class="hljs-number"><span class="hljs-number">50</span></span>; Query OK, 0 rows affected (0.23 sec)</code> </pre><br>  Mari kita periksa bagaimana cara kerjanya: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rdp_brute_day; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 185.156.177.58 | 11 | +----------------+--------------+ 1 row in set (0.09 sec)</span></span></code> </pre> <br>  Bagus <br><br>  <b>Kami menambahkan pengguna Mikrotik dengan otorisasi dengan kunci dsa</b> <br><br>  Di konsol linux, kami membuat kunci dsa, di bawah pengguna atas nama siapa tugas yang dijadwalkan akan diluncurkan, saya buat dari root: <br><br><pre> <code class="bash hljs">root@monix:~<span class="hljs-comment"><span class="hljs-comment"># ssh-keygen -t dsa Generating public/private dsa key pair. Enter file in which to save the key (/root/.ssh/id_dsa): Enter passphrase (empty for no passphrase): Enter same passphrase again: Your identification has been saved in /root/.ssh/id_dsa. Your public key has been saved in /root/.ssh/id_dsa.pub. ...</span></span></code> </pre> <br>  Frasa sandi tidak diperlukan.  Kami menyalin kunci publik /root/.ssh/id_dsa.pub ke Mikrotik dengan cara apa pun yang memungkinkan.  Saya membawanya keluar dengan perintah cat, menyalin teks dari jendela dempul ke dalam file teks, menyimpannya dan menyeretnya ke jendela file winbox. <br><br>  Saya tidak tahu mengapa, tetapi selama operasi berikut melalui antarmuka winbox terjadi kesalahan.  Saat terhubung dari server melalui ssh, Mikrotik juga meminta kata sandi dari saya.  Setelah saya menghapus pengguna yang dibuat dan melakukan semua operasi melalui konsol, koneksi dsa berfungsi.  Apakah kira-kira seperti yang dijelaskan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . <br><br>  Secara umum, saya menerima entri selamat datang tanpa kata sandi menggunakan kunci dsa dan menjalankan perintah verifikasi: <br><br><pre> <code class="bash hljs">root@monix:/<span class="hljs-comment"><span class="hljs-comment"># ssh rsyslogger@192.168.0.230 /system resource print uptime: 2w1d5h22m43s version: 6.43.2 (stable) ...</span></span></code> </pre> <br>  Bagus <br><br>  <b>Menulis skrip bash</b> <br><br>  Scriptnya tidak rumit: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mikrotik_cmd_list</span></span></span></span>(){ brute_src_list=$(mysql --skip-column-names traflog -e <span class="hljs-string"><span class="hljs-string">'select src from rdp_brute_day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$brute_src_list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"ip firewall address-list add address=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$src</span></span></span><span class="hljs-string"> list=rdp_banlist timeout=1d"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> } mikrotik_cmd_list | ssh -T rsyslogger@192.168.0.230</code> </pre> <br>  Untuk mentransfer semua perintah dalam koneksi ssh yang sama, saya perlu menjelaskan fungsi mikrotik_cmd_list (), di mana permintaan pertama kali dilakukan dengan menyimpan alamat ip ke variabel brute_src_list, kemudian dalam loop variabel ini secara berurutan menghasilkan perintah untuk Mikrotik.  Setelah memanggil fungsi, output dialihkan melalui pipa ke ssh. <br><br>  Jangan lupa untuk menutup hak akses skrip untuk semua orang kecuali root dan membuat file tersebut dapat dieksekusi. <br>  Perintah yang dihasilkan skrip akan menambahkan alamat ip ke rdp_banlist selama 1 hari, setelah waktu ini akan dihapus dari daftar itu sendiri.  Jika Anda ingin meninggalkannya selamanya, hapus opsi batas waktu. <br><br>  <b>Tambahkan aturan ke firewall</b> <br><br>  Saya datang dengan dua opsi untuk bagaimana menggunakan rdp_banlist: <br><br>  <b>Opsi satu:</b> tambahkan rdp_banlist dengan tanda seru ke aturan NAT dengan awalan RDP_DNAT. <br><br><pre> <code class="bash hljs">add action=dst-nat chain=dstnat comment=<span class="hljs-string"><span class="hljs-string">"..."</span></span> dst-address=1.2.3.4 dst-port=12345 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix=RDP_DNAT protocol=tcp src-address-list=\ !rdp_banlist to-addresses=192.168.200.181 to-ports=3389</code> </pre> <br>  Sesuatu seperti itu.  Yaitu, kami melakukan semuanya, kecuali apa yang ada di rdp_banlist. <br><br>  Dalam opsi ini, ada plus dan minus. <br><br>  Kelebihannya adalah koneksi akan segera berhenti. <br><br>  Kelemahannya adalah bahwa ip ini tidak akan lagi masuk ke database traflog dan setelah sehari, ketika batas waktu penyimpanan dalam daftar hitam telah berlalu, ia akan mulai omong kosong lagi. <br><br>  <b>Opsi dua:</b> tambahkan rdp_banlist dengan tanda seru ke aturan firewall rantai maju, di mana kami mengizinkan lalu lintas melewati TCP 3389, mirip dengan cara dalam metode pertama. <br><br><pre> <code class="bash hljs">add action=accept chain=forward comment=<span class="hljs-string"><span class="hljs-string">"..."</span></span> dst-port=3389 <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>=yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-prefix=ACCEPT_RDP protocol=tcp src-address-list=\ !rdp_banlist to-ports=3389</code> </pre> <br>  Sesuatu seperti itu.  Kami mengizinkan semuanya kecuali yang ada dalam daftar larangan. <br><br>  Ada juga yang plus dan minus. <br><br>  Plus.  Log dengan awalan RDP_DNAT akan terus di-stream dalam database traflog, yang dengannya kami menentukan tanda serangan.  Akibatnya, ketika batas waktu larangan untuk host tertentu yang melanjutkan upaya brute force berakhir, itu akan ditambahkan ke daftar larangan lagi setelah peluncuran tugas yang dijadwalkan berikutnya. <br><br>  Kelemahannya adalah bahwa hal itu terus terjadi di tabel DSTNAT, membuat rekor baru dengan setiap koneksi, meskipun sementara. <br><br>  Secara umum, keputusan ada di tangan Anda, saya memilih keduanya :) (pada kenyataannya, hanya yang pertama yang bekerja dalam kasus ini), karena yang kedua dihidupkan sebelumnya dan mekanika berbeda di sana, berdasarkan entri berurutan dalam daftar stage1, stage2, stage3, banlist ... yah, Anda mengerti maksudnya.  Trik lama dan tidak terlalu dapat diandalkan, ini dapat dengan mudah melarang klien "baik" dan pada saat yang sama melewatkan yang "buruk" yang dengan sopan menghitung batas waktu stage1. <br><br>  <b>Crontab pekerjaan yang dijadwalkan</b> <br><br>  Tetap menambahkan tugas yang ditugaskan ke crontab: <br><br><pre> <code class="bash hljs">root@monix:/root<span class="hljs-comment"><span class="hljs-comment"># echo '12 * * * * root /usr/share/traflog/scripts/rdp_brute.sh &gt;/dev/null 2&gt;&amp;1' &gt;&gt; /etc/crontab</span></span></code> </pre><br>  Catatan seperti itu akan menjalankan skrip setiap jam dalam 12 menit. <br><br>  Harus saya akui, saya baru saja selesai mengerjakan mekanik ini hari ini dan dengan tingkat probabilitas tinggi, ada yang tidak beres.  Menurut keadaan saya akan melengkapi dan memperbaiki kesalahan.  Saya ingin <s>minum untuk</s> tidur nyenyak di liburan Tahun Baru, itu sebabnya saya terburu-buru untuk menyelesaikannya. <br>  Itu mungkin saja. <br><br>  Terima kasih atas perhatian dan Selamat Tahun Baru! <br><br>  Referensi: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi Mysql</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi firewall mikrotik</a> <br>  Terima kasih kepada Andrey Smirnov untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel</a> tentang koneksi dsa. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id434736/">https://habr.com/ru/post/id434736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id434726/index.html">Kesulitan dalam mengidentifikasi perangkat Android</a></li>
<li><a href="../id434728/index.html">Orang dan proses: mengapa udalenka tidak cocok untuk setiap perusahaan?</a></li>
<li><a href="../id434730/index.html">Database dalam memori: aplikasi, penskalaan dan penambahan penting</a></li>
<li><a href="../id434732/index.html">Hidup di 6200 DPI. Ulasan Inti HyperX Pulsefire</a></li>
<li><a href="../id434734/index.html">Transformasi Fourier. Cepat dan geram</a></li>
<li><a href="../id434738/index.html">Penguatan Pembelajaran dengan Python</a></li>
<li><a href="../id434740/index.html">Jaringan saraf diajarkan untuk mendeteksi panel surya dalam gambar satelit dan memprediksi tingkat distribusinya</a></li>
<li><a href="../id434742/index.html">Bagian 2: Menggunakan pengontrol PSBC UDB Cypress untuk mengurangi jumlah interupsi dalam printer 3D</a></li>
<li><a href="../id434744/index.html">Samsung SSD 860 QVO 1 TB dan 4 TB: konsumen pertama SATA QLC (2 bagian)</a></li>
<li><a href="../id434746/index.html">BLE di bawah mikroskop 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>