<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§“ğŸ¾ ğŸ•µğŸ½ â™Šï¸ Goä¸­çš„bytes.Bufferï¼šæ— æ•ˆçš„ä¼˜åŒ– ğŸ§¡ â¬œï¸ ğŸ‘¨ğŸ¾â€âš–ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è®¸å¤šGoç¨‹åºå‘˜ç†Ÿæ‚‰bytes.Buffer ã€‚ å®ƒçš„ä¼˜ç‚¹ä¹‹ä¸€æ˜¯ï¼Œå®ƒä½¿æ‚¨å¯ä»¥é¿å…åƒâ€œ å°ç¼“å†²åŒº/å¤§å°ä¼˜åŒ– â€ä¸€æ ·åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼š 


type Buffer struct { bootstrap [64]byte // // ... }  


 åªæœ‰ä¸€ä¸ªé—®é¢˜ã€‚ æ­¤ä¼˜åŒ–æ— æ•ˆ ã€‚ 


 åˆ°æœ¬æ–‡ç»“å°¾ï¼Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Goä¸­çš„bytes.Bufferï¼šæ— æ•ˆçš„ä¼˜åŒ–</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/intel/blog/422447/"><p> è®¸å¤š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Go</a>ç¨‹åºå‘˜ç†Ÿæ‚‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">bytes.Buffer</a> ã€‚ å®ƒçš„ä¼˜ç‚¹ä¹‹ä¸€æ˜¯ï¼Œå®ƒä½¿æ‚¨å¯ä»¥é¿å…åƒâ€œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å°ç¼“å†²åŒº/å¤§å°ä¼˜åŒ–</a> â€ä¸€æ ·åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼š </p><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Buffer <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { bootstrap [<span class="hljs-number"><span class="hljs-number">64</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> <span class="hljs-comment"><span class="hljs-comment">//        // ...   }</span></span></code> </pre> <br><p> åªæœ‰ä¸€ä¸ªé—®é¢˜ã€‚ æ­¤ä¼˜åŒ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ— æ•ˆ</a> ã€‚ </p><br><p> åˆ°æœ¬æ–‡ç»“å°¾ï¼Œæ‚¨å°†äº†è§£ä¸ºä»€ä¹ˆæ­¤ä¼˜åŒ–æ— æ•ˆçš„åŸå› ä»¥åŠæˆ‘ä»¬å¯ä»¥é‡‡å–çš„æªæ–½ã€‚ </p><a name="habracut"></a><br><h1 id="kak-bylo-po-zadumke-small-buffer-optimization"> å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œâ€œå°ç¼“å†²åŒºä¼˜åŒ–â€ </h1><br><p> è®©æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹<code>bytes.Buffer</code>çš„ç¨å¾®ç®€åŒ–çš„å®šä¹‰ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> smallBufSize <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Buffer <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { bootstrap [smallBufSize]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> buf []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> }</code> </pre> <br><p> ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬å¯¹<code>Buffer</code>æ‰§è¡Œæ“ä½œæ—¶ï¼Œè°ƒç”¨<code>Buffer.Write</code>æ–¹æ³•ï¼Œè¯¥è®°å½•å§‹ç»ˆåœ¨<code>buf</code> ï¼Œä½†æ˜¯ï¼Œåœ¨æ­¤è®°å½•ä¹‹å‰ï¼Œåœ¨æ¯ä¸ªç±»ä¼¼æ–¹æ³•å†…å¯åŠ¨<code>Buffer.grow(n)</code> ï¼Œä»¥ç¡®ä¿æ­¤sliceä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—´ç”¨äºæ¥ä¸‹æ¥çš„<code>n</code>ä¸ªå­—èŠ‚ã€‚ </p><br><p> æˆé•¿å¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *Buffer)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">grow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//         bytes.Buffer. l := len(b.buf) //   Buffer need := n + l have := cap(b.buf) - l if have &gt;= need { b.buf = b.buf[:need] return } if need &lt;= smallBufSize { //     , //   . b.buf = b.bootstrap[:] } else { // growFactor -     . //     need  need*2. newBuf := make([]byte, need, growFactor(need)) copy(newBuf, b.buf) b.buf = newBuf } }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">æˆ‘ä»¬çš„Buffer.growå®ç°ä¸­ä½¿ç”¨çš„å‡è®¾</b> <div class="spoiler_text"><hr><br><p> æˆ‘ä»¬å‡è®¾<code>len(b.buf)</code>æ˜¯Bufferä¸­çš„å®é™…æ•°æ®é•¿åº¦ï¼Œè¿™å°†è¦æ±‚<code>Write</code>ä½¿ç”¨appendæ–¹æ³•å°†æ–°å­—èŠ‚æ·»åŠ åˆ°ç‰‡ä¸­ã€‚ æ ‡å‡†åº“ä¸­çš„<code>bytes.Buffer</code>ä¸æ˜¯è¿™ç§æƒ…å†µï¼Œä½†æ˜¯ä½œä¸ºç¤ºä¾‹ï¼Œè¿™æ˜¯ä¸ç›¸å…³çš„å®ç°ç»†èŠ‚ã€‚ </p><br><hr></div></div><br><p> å¦‚æœ<code>b</code>åœ¨å †æ ˆä¸Šåˆ†é…çš„ï¼Œåˆ™å®ƒå†…éƒ¨çš„<code>bootstrap</code>å°†åœ¨å †æ ˆä¸Šåˆ†é…ï¼Œè¿™æ„å‘³ç€ç‰‡<code>b.buf</code>å°†åœ¨ä¸éœ€è¦é™„åŠ åˆ†é…çš„æƒ…å†µä¸‹é‡ç”¨<code>b</code>å†…éƒ¨çš„å†…å­˜ã€‚ </p><br><p> å½“<code>grow</code>æ­ç¤º<code>bootstrap</code>æ•°ç»„å·²ç»ä¸è¶³æ—¶ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°çš„â€œçœŸå®â€åˆ‡ç‰‡ï¼Œåœ¨è¯¥åˆ‡ç‰‡ä¸­ï¼Œå°†å¤åˆ¶è¿‡å»å­˜å‚¨ï¼ˆæ¥è‡ªâ€œå°ç¼“å†²åŒºâ€ï¼‰ä¸­çš„å…ƒç´ ã€‚ ä¹‹åï¼Œ <code>Buffer.bootstrap</code>å°†å¤±å»å…¶ç›¸å…³æ€§ã€‚ å¦‚æœ<code>Buffer.Reset</code> ï¼Œåˆ™<code>cap(b.buf)</code>å°†ä¿æŒä¸å˜ï¼Œå¹¶ä¸”ä¸å†éœ€è¦<code>bootstrap</code>æ•°ç»„ã€‚ </p><br><h1 id="pamyat-ubegayuschaya-v-heap"> å†…å­˜åœ¨å †ä¸­è€—å°½ </h1><br><p> å¯ä»¥è¿›ä¸€æ­¥æœŸæœ›è¯»è€…è‡³å°‘å¯¹Goè¯­è¨€ä¸­çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è½¬ä¹‰åˆ†æ</a>æœ‰æ‰€äº†è§£ã€‚ </p><br><p> è¯·è€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼š </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">f</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Buffer</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b bytes.Buffer <span class="hljs-comment"><span class="hljs-comment">// leak.go:11:6: moved to heap: b return &amp;b // leak.go:12:9: &amp;b escapes to heap }</span></span></code> </pre> <br><p> è¿™é‡Œ<code>b</code>å°†åˆ†é…åœ¨å †ä¸Šã€‚ è¿™æ ·åšçš„åŸå› æ˜¯æŒ‡å‘<code>b</code>æŒ‡é’ˆæ³„æ¼ï¼š </p><br><pre> <code class="bash hljs">$ go tool compile -m leak.go leak.go:12:9: &amp;b escapes to heap leak.go:11:6: moved to heap: b</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">æœ¯è¯­å­¦</b> <div class="spoiler_text"><hr><br><p> åœ¨æœ¬æ–‡ä¸­ï¼Œâ€œæ³„æ¼â€å’Œâ€œè½¬ä¹‰â€å‡ ä¹æ˜¯åŒä¹‰è¯ã€‚ </p><br><p> ç¼–è¯‘å™¨æœ¬èº«å­˜åœ¨ä¸€äº›å·®å¼‚ï¼Œä¾‹å¦‚ï¼Œå€¼â€œè½¬ä¹‰ä¸ºè½¬ä¹‰â€ï¼Œä½†å‡½æ•°å‚æ•°ä¸ºâ€œæ³„æ¼å‚æ•°xâ€ã€‚ </p><br><p> å‚æ•°æ³„æ¼æ„å‘³ç€ä¼ é€’ç»™è¯¥å‚æ•°çš„å‚æ•°å°†åœ¨å †ä¸Šåˆ†é…ã€‚ æ¢å¥è¯è¯´ï¼Œæ³„æ¼å‚æ•°ä½¿å‚æ•°é€ƒé€¸åˆ°å †ä¸­ã€‚ </p><br><hr></div></div><br><p> ä¸Šé¢æ˜¯ä¸€ä¸ªæ˜æ˜¾çš„ä¾‹å­ï¼Œä½†æ˜¯è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b bytes.Buffer b.WriteString(<span class="hljs-string"><span class="hljs-string">"1"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b.Len() }</code> </pre> <br><p> è¿™é‡Œæˆ‘ä»¬åªéœ€è¦1ä¸ªå­—èŠ‚ï¼Œä¸€åˆ‡éƒ½é€‚åˆ<code>bootstrap</code> ï¼Œç¼“å†²åŒºæœ¬èº«æ˜¯å±€éƒ¨çš„ï¼Œä¸ä¼šä»å‡½æ•°ä¸­â€œè½¬ä¹‰â€ã€‚ æ‚¨å¯èƒ½ä¼šæ„Ÿåˆ°æƒŠè®¶ï¼Œä½†æ˜¯ç»“æœæ˜¯ç›¸åŒçš„ï¼Œåœ¨å †ä¸Šåˆ†é…<code>b</code> ã€‚ </p><br><img src="https://habrastorage.org/webt/_d/3w/jr/_d3wjrildbyauunsvvv5oq7zqpo.jpeg"><br><p> å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åŸºå‡†è¿›è¡Œæ£€æŸ¥ï¼š </p><br><pre> <code class="hljs powershell">BenchmarkLength<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">20000000</span></span> <span class="hljs-number"><span class="hljs-number">90.1</span></span> ns/op <span class="hljs-number"><span class="hljs-number">112</span></span> B/op <span class="hljs-number"><span class="hljs-number">1</span></span> allocs/op</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">åŸºå‡†æ¸…å•</b> <div class="spoiler_text"><hr><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"bytes"</span></span> <span class="hljs-string"><span class="hljs-string">"testing"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b bytes.Buffer b.WriteString(<span class="hljs-string"><span class="hljs-string">"1"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b.Len() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkLength</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { _ = length() } }</code> </pre> <br><hr></div></div><br><div class="spoiler">  <b class="spoiler_title">è¯´æ˜112 B / op</b> <div class="spoiler_text"><hr><br><p> å½“è¿è¡Œæ—¶å‘åˆ†é…å™¨è¯¢é—®<code>N</code>ä¸ªå­—èŠ‚æ—¶ï¼Œä¸å¿…ç²¾ç¡®åˆ†é…<code>N</code>ä¸ªå­—èŠ‚ã€‚ </p><br><blockquote> ä»¥ä¸‹æ‰€æœ‰ç»“æœå‡é’ˆå¯¹<code>GOOS=linux</code>å’Œ<code>GOARCH=AMD64</code> ã€‚ </blockquote><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> benchmark <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"testing"</span></span> <span class="hljs-comment"><span class="hljs-comment">//go:noinline func alloc9() []byte { return make([]byte, 9) } func BenchmarkAlloc9(b *testing.B) { for i := 0; i &lt; bN; i++ { _ = alloc9() } }</span></span></code> </pre> <br><p> å¦‚æœè¿è¡Œï¼Œ <code>go test -bench=. -benchmem</code>  <code>go test -bench=. -benchmem</code>ä¸æ­¤æµ‹è¯•ï¼š </p><br><pre> <code class="hljs powershell">BenchmarkAlloc9<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">50000000</span></span> <span class="hljs-number"><span class="hljs-number">33.5</span></span> ns/op <span class="hljs-number"><span class="hljs-number">16</span></span> B/op <span class="hljs-number"><span class="hljs-number">1</span></span> allocs/op</code> </pre> <br><p> è¯·æ±‚äº†9ä¸ªå­—èŠ‚ï¼Œåˆ†é…äº†16ä¸ªå­—èŠ‚ï¼Œç°åœ¨åˆå›åˆ°<code>bytes.Buffer</code> ï¼š </p><br><pre> <code class="go hljs">fmt.Println(unsafe.Sizeof(bytes.Buffer{})) =&gt; <span class="hljs-number"><span class="hljs-number">104</span></span></code> </pre> <br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<a href="">$ GOROOT / src / runtime / sizeclasses.go</a> ï¼š </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ class bytes/obj</span></span> bytes/span objects tail waste max waste /<span class="hljs-regexp"><span class="hljs-regexp">/ 1 8 8192 1024 0 87.50% /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 2 16 8192 512 0 43.75% /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 3 32 8192 256 0 46.88% /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 4 48 8192 170 32 31.52% /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 5 64 8192 128 0 23.44% /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 6 80 8192 102 32 19.07% /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 7 96 8192 85 32 15.95% /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 8 112 8192 73 16 13.56% /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ... </span></span></code> </pre> <br><p> å®ƒä¸é€‚åˆ96å­—èŠ‚ï¼Œå·²é€‰æ‹©112ã€‚ </p><br><hr></div></div><br><p> ä½†æ˜¯ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ </p><br><h1 id="chto-proishodit-i-pochemu"> å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆ </h1><br><p> åœ¨ä¸€å¼€å§‹æåˆ°çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é—®é¢˜</a>ä¸­å¯ä»¥æ‰¾åˆ°å¯¹è¿™ç§æƒ…å†µçš„ä¸€äº›åˆ†æã€‚ <br> è¿˜æœ‰ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç®€å•çš„å¤åˆ¶å™¨</a> ã€‚ </p><br><p> é—®é¢˜æ‰€åœ¨ä»…åœ¨èµ‹å€¼<code>b.buf = b.bootstrap[:]</code> ã€‚ æ­¤ä»£ç ä½¿è½¬ä¹‰åˆ†æå‡å®š<code>b.bootstrap</code> â€œè¿è¡Œâ€ï¼Œå¹¶ä¸”ç”±äºå®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå› æ­¤å­˜å‚¨åœ¨å¯¹è±¡æœ¬èº«å†…éƒ¨ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰<code>b</code>å¿…é¡»åˆ†é…åœ¨å †ä¸Šã€‚ </p><br><p> å¦‚æœå¼•å¯¼ç¨‹åºæ˜¯åˆ‡ç‰‡ï¼Œè€Œä¸æ˜¯æ•°ç»„ï¼Œåˆ™ä¸ä¼šå‘ç”Ÿï¼Œå› ä¸ºå­˜åœ¨é’ˆå¯¹å°†åˆ‡ç‰‡ä»å¯¹è±¡åˆ†é…ç»™å¯¹è±¡æœ¬èº«çš„ç‰¹åˆ«ä¼˜åŒ–ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">//   ,     , // object      . object.buf1 = object.buf2[a:b]</span></span></code> </pre> <br><p> ä¸ºä»€ä¹ˆè¿™ç§ä¼˜åŒ–ä¸é€‚ç”¨äºæ•°ç»„çš„ç­”æ¡ˆå·²ç»åœ¨ä¸Šé¢æå‡ºï¼Œä½†è¿™æ˜¯ä»<a href="">esc.goï¼ƒL835-L866æœ¬èº«</a>çš„æŒ¤å‹ï¼ˆæ•´ä¸ªä¼˜åŒ–ä»£ç é€šè¿‡å‚è€ƒçªå‡ºæ˜¾ç¤ºï¼‰ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Note, this optimization does not apply to OSLICEARR, // because it does introduce a new pointer into b that was not already there // (pointer to b itself). After such assignment, if b contents escape, // b escapes as well. If we ignore such OSLICEARR, we will conclude // that b does not escape when b contents do.</span></span></code> </pre> <br><p> å€¼å¾—åœ¨è¿™é‡Œæ·»åŠ çš„æ˜¯ï¼Œå¯¹äºæŒ‡é’ˆåˆ†æå™¨ï¼Œæœ‰å¤šä¸ªçº§åˆ«çš„â€œæ³„æ¼â€ï¼Œå…¶ä¸­ä¸»è¦æ˜¯ï¼š </p><br><ol><li> å¯¹è±¡æœ¬èº«è½¬ä¹‰ï¼ˆbè½¬ä¹‰ï¼‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹è±¡æœ¬èº«éœ€è¦åœ¨å †ä¸Šåˆ†é…ã€‚ </li><li> å¯¹è±¡çš„å…ƒç´ ï¼ˆbå†…å®¹è½¬ä¹‰ï¼‰è½¬ä¹‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹è±¡ä¸­çš„æŒ‡é’ˆè¢«è®¤ä¸ºæ˜¯è½¬ä¹‰çš„ã€‚ </li></ol><br><p> æ•°ç»„çš„æƒ…å†µå¾ˆç‰¹æ®Šï¼Œå¦‚æœæ•°ç»„æ³„æ¼ï¼ŒåŒ…å«å®ƒçš„å¯¹è±¡ä¹Ÿå¿…é¡»æ³„æ¼ã€‚ </p><br><p> è½¬ä¹‰åˆ†æä»…æ ¹æ®è¢«åˆ†æå‡½æ•°ä¸»ä½“ä¸­å¯ç”¨çš„ä¿¡æ¯æ¥å†³å®šæ˜¯å¦å¯ä»¥å°†å¯¹è±¡æ”¾ç½®åœ¨å †æ ˆä¸Šã€‚  <code>Buffer.grow</code>æ–¹æ³•æŒ‰æŒ‡é’ˆå–<code>b</code> ï¼Œå› æ­¤éœ€è¦è®¡ç®—ä¸€ä¸ªåˆé€‚çš„æ”¾ç½®ä½ç½®ã€‚ ç”±äºåœ¨æ•°ç»„çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ— æ³•å°†<code>"b escape"</code>ä¸<code>"b contents escape"</code>åŒºåˆ†å¼€ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æ›´åŠ æ‚²è§‚ï¼Œå¹¶å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼š <code>b</code>ä¸å®‰å…¨åœ°æ”¾ç½®åœ¨å †æ ˆä¸Šã€‚ </p><br><p> å‡è®¾ç›¸åï¼Œ <code>self-assignment</code>æ¨¡å¼å¯¹æ•°ç»„çš„è§£æä¸å¯¹åˆ‡ç‰‡çš„è§£æç›¸åŒï¼š </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> example <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sink <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> bad <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { array [<span class="hljs-number"><span class="hljs-number">10</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> slice []<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *bad)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { b.slice = b.array[:] <span class="hljs-comment"><span class="hljs-comment">// ignoring self-assignment to b.slice sink = b.array // b.array escapes to heap // b does not escape }</span></span></code> </pre> <br><p> åœ¨è¿™ç§æƒ…å†µä¸‹å°†<code>b</code>æ”¾ç½®åœ¨å †æ ˆä¸Šçš„å†³å®šå°†å¯¼è‡´ç¾éš¾ï¼šé€€å‡ºé€€å‡ºåœ¨å…¶ä¸­åˆ›å»º<code>b</code>çš„å‡½æ•°ä¹‹åï¼Œæ¥æ”¶<code>sink</code>å°†å¼•ç”¨çš„å†…å­˜å°†ä¸è¿‡æ˜¯åƒåœ¾ã€‚ </p><br><h1 id="ukazateli-na-massivy"> æ•°ç»„æŒ‡é’ˆ </h1><br><p> æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„<code>Buffer</code>å£°æ˜æœ‰æ‰€ä¸åŒï¼š </p><br><pre> <code class="diff hljs">const smallBufSize int = 64 type Buffer struct { - bootstrap [smallBufSize]byte + bootstrap *[smallBufSize]byte buf []byte }</code> </pre> <br><p> ä¸å¸¸è§„æ•°ç»„ä¸åŒï¼ŒæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆä¸ä¼šå°†æ‰€æœ‰å…ƒç´ å­˜å‚¨åœ¨<code>Buffer</code>è‡ªèº«å†…éƒ¨ã€‚ è¿™æ„å‘³ç€ï¼Œå¦‚æœå †ä¸Šçš„<code>bootstrap</code>åˆ†é…ä¸è¦æ±‚å †ä¸Šçš„<code>Buffer</code>åˆ†é…ã€‚ ç”±äºè½¬ä¹‰åˆ†æå¯ä»¥åœ¨å¯èƒ½çš„æƒ…å†µä¸‹åœ¨å †æ ˆä¸Šåˆ†é…æŒ‡é’ˆå­—æ®µï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å‡å®šè¿™æ ·çš„<code>Buffer</code>å®šä¹‰ä¼šæ›´æˆåŠŸã€‚ </p><br><p> ä½†è¿™æ˜¯ç†è®ºä¸Šçš„ã€‚ å®é™…ä¸Šï¼ŒæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆæ²¡æœ‰å¤ªå¤šå¤„ç†ï¼Œå¹¶ä¸”ä¸å¸¸è§„æ•°ç»„ä¸­çš„åˆ‡ç‰‡å±äºåŒä¸€ç±»åˆ«ï¼Œè¿™å¹¶ä¸å®Œå…¨æ­£ç¡®ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CL133375ï¼šcmd / compile / internal / gcï¼šåœ¨esc.goä¸­å¤„ç†æ•°ç»„åˆ‡ç‰‡è‡ªåˆ†é…çš„</a>ç›®çš„æ˜¯çº æ­£è¿™ç§æƒ…å†µã€‚ </p><br><p> å‡è®¾æ­¤æ›´æ”¹å·²è¢«Goç¼–è¯‘å™¨æ¥å—ã€‚ </p><br><h1 id="zero-value-kotoryy-my-poteryali"> é›¶å€¼æˆ‘ä»¬å¤±å»äº† </h1><br><p> ä¸å¹¸çš„æ˜¯ï¼Œä»<code>[64]byte</code>åˆ°<code>*[64]byte</code>å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šç°åœ¨æˆ‘ä»¬ä¸èƒ½åœ¨æ²¡æœ‰æ˜¾å¼åˆå§‹åŒ–çš„æƒ…å†µä¸‹ä½¿ç”¨<code>bootstrap</code> ï¼Œ <code>Buffer</code>çš„é›¶å€¼ä¸å†æœ‰ç”¨ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ å‡½æ•°ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewBuffer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Buffer</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Buffer{bootstrap: <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(*[smallBufSize]<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)} }</code> </pre> <br><p> æˆ‘ä»¬è¿”å›<code>Buffer</code>è€Œä¸æ˜¯<code>*Buffer</code> ï¼Œä»¥é¿å…æŒ‡é’ˆåˆ†æå‡ºç°é—®é¢˜ï¼ˆåœ¨Goä¸­éå¸¸ä¿å®ˆï¼‰ï¼Œå¹¶è€ƒè™‘åˆ°<code>NewBuffer</code>å§‹ç»ˆå†…ç½®åœ¨è°ƒç”¨ä½ç½®è¿™ä¸€äº‹å®ï¼Œå› æ­¤ä¸ä¼šæœ‰ä¸å¿…è¦çš„å¤åˆ¶ã€‚ </p><br><p> åœ¨å°†<code>NewBuffer</code>ä¸»ä½“åµŒå…¥åˆ°è°ƒç”¨ä½ç½®ä¹‹åï¼Œè½¬ä¹‰åˆ†æå¯ä»¥å°è¯•è¯æ˜<code>new(*[smallBufSize]byte)</code>æ²¡æœ‰è¶…è¿‡è°ƒç”¨å®ƒçš„å‡½æ•°çš„æ¡†æ¶çš„ç”Ÿå­˜æœŸã€‚ å¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™åˆ†é…å°†åœ¨å †æ ˆä¸Šã€‚ </p><br><h1 id="intel-bytebuf"> è‹±ç‰¹å°”å­—èŠ‚ç¼“å†² </h1><br><p> ä¸Šé¢æè¿°çš„ä¼˜åŒ–åº”ç”¨äº<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">intel-go / bytebufåŒ…ä¸­</a> ã€‚ </p><br><p> è¯¥åº“å¯¼å‡º<code>bytebuf.Buffer</code>ç±»å‹ï¼Œè¯¥ç±»å‹é‡å¤99.9ï¼… <code>bytes.Buffer</code> ã€‚ æ‰€æœ‰æ›´æ”¹éƒ½ç®€åŒ–ä¸ºå¼•å…¥äº†æ„é€ å‡½æ•°ï¼ˆ <code>bytebuf.New</code> ï¼‰å’ŒæŒ‡å‘æ•°ç»„è€Œä¸æ˜¯å¸¸è§„æ•°ç»„çš„æŒ‡é’ˆï¼š </p><br><pre> <code class="diff hljs">type Buffer struct { buf []byte // contents are the bytes buf[off : len(buf)] off int // read at &amp;buf[off], write at &amp;buf[len(buf)] - bootstrap [64]byte // helps small buffers avoid allocation. + bootstrap *[64]byte // helps small buffers avoid allocation. lastRead readOp // last read operation (for Unread*). }</code> </pre> <br><p> è¿™æ˜¯ä¸<code>bytes.Buffer</code>çš„æ€§èƒ½æ¯”è¾ƒï¼š </p><br><pre> <code class="hljs powershell">name old time/op new time/op delta String/empty<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">138</span></span>ns Â±<span class="hljs-number"><span class="hljs-number">13</span></span>% <span class="hljs-number"><span class="hljs-number">24</span></span>ns Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-82</span></span>.<span class="hljs-number"><span class="hljs-number">94</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">8</span></span>) String/<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">186</span></span>ns Â±<span class="hljs-number"><span class="hljs-number">11</span></span>% <span class="hljs-number"><span class="hljs-number">60</span></span>ns Â± <span class="hljs-number"><span class="hljs-number">1</span></span>% <span class="hljs-literal"><span class="hljs-literal">-67</span></span>.<span class="hljs-number"><span class="hljs-number">82</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">225</span></span>ns Â±<span class="hljs-number"><span class="hljs-number">10</span></span>% <span class="hljs-number"><span class="hljs-number">108</span></span>ns Â± <span class="hljs-number"><span class="hljs-number">6</span></span>% <span class="hljs-literal"><span class="hljs-literal">-52</span></span>.<span class="hljs-number"><span class="hljs-number">26</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">128</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">474</span></span>ns Â±<span class="hljs-number"><span class="hljs-number">17</span></span>% <span class="hljs-number"><span class="hljs-number">338</span></span>ns Â±<span class="hljs-number"><span class="hljs-number">13</span></span>% <span class="hljs-literal"><span class="hljs-literal">-28</span></span>.<span class="hljs-number"><span class="hljs-number">57</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">1024</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">889</span></span>ns Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">740</span></span>ns Â± <span class="hljs-number"><span class="hljs-number">1</span></span>% <span class="hljs-literal"><span class="hljs-literal">-16</span></span>.<span class="hljs-number"><span class="hljs-number">78</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) name old alloc/op new alloc/op delta String/empty<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">112</span></span>B Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">0</span></span>B <span class="hljs-literal"><span class="hljs-literal">-100</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">117</span></span>B Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">5</span></span>B Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-95</span></span>.<span class="hljs-number"><span class="hljs-number">73</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">176</span></span>B Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">64</span></span>B Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-63</span></span>.<span class="hljs-number"><span class="hljs-number">64</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">128</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">368</span></span>B Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">256</span></span>B Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-30</span></span>.<span class="hljs-number"><span class="hljs-number">43</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">1024</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">2.16</span></span>kB Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">2.05</span></span>kB Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-5</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) name old allocs/op new allocs/op delta String/empty<span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">1.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">0.00</span></span> <span class="hljs-literal"><span class="hljs-literal">-100</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">2.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">1.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-50</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">2.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">1.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-50</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">128</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">3.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">2.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-33</span></span>.<span class="hljs-number"><span class="hljs-number">33</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>) String/<span class="hljs-number"><span class="hljs-number">1024</span></span><span class="hljs-literal"><span class="hljs-literal">-8</span></span> <span class="hljs-number"><span class="hljs-number">3.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">2.00</span></span> Â± <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-literal"><span class="hljs-literal">-33</span></span>.<span class="hljs-number"><span class="hljs-number">33</span></span>% (p=<span class="hljs-number"><span class="hljs-number">0.000</span></span> n=<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>)</code> </pre> <br><p> æ‰€æœ‰å…¶ä»–ä¿¡æ¯éƒ½å¯ä»¥åœ¨<a href="">READMEä¸­è·å¾—</a> ã€‚ </p><br><p> ç”±äºæ— æ³•ä½¿ç”¨é›¶å€¼å¹¶ä¸”æ— æ³•ç»‘å®šåˆ°æ„é€ å‡½æ•°<code>New</code> ï¼Œå› æ­¤æ— æ³•å°†æ­¤ä¼˜åŒ–åº”ç”¨äº<code>bytes.Buffer</code> ã€‚ </p><br><p> è¿™æ˜¯åˆ¶ä½œæ›´å¿«çš„<code>bytes.Buffer</code>çš„å”¯ä¸€æ–¹æ³•å—ï¼Ÿ ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ ä½†è¿™ç»å¯¹æ˜¯åœ¨å®ç°ä¸Šéœ€è¦æœ€å°‘æ›´æ”¹çš„æ–¹æ³•ã€‚ </p><br><h1 id="plany-na-escape-analysis"> è½¬ä¹‰åˆ†æè®¡åˆ’ </h1><br><p> æŒ‰ç…§ç›®å‰çš„å½¢å¼ï¼ŒGoä¸­çš„è½¬ä¹‰åˆ†æéå¸¸è–„å¼±ã€‚ å‡ ä¹æ‰€æœ‰å¸¦æœ‰æŒ‡é’ˆå€¼çš„æ“ä½œéƒ½ä¼šå¯¼è‡´åœ¨å †ä¸Šè¿›è¡Œåˆ†é…ï¼Œå³ä½¿è¿™ä¸æ˜¯ä¸€ä¸ªåˆç†çš„å†³å®šã€‚ </p><br><p> æˆ‘å°†å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">golang / go</a>é¡¹ç›®ä¸Šï¼Œä»¥è§£å†³è¿™äº›é—®é¢˜ï¼Œå› æ­¤åœ¨å³å°†å‘å¸ƒçš„ç‰ˆæœ¬ï¼ˆ1.12ï¼‰ä¸­å¯èƒ½ä¼šè¿›è¡Œä¸€äº›æ”¹è¿›ã€‚ </p><br><p> æ‚¨å¯ä»¥åœ¨æˆ‘çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­äº†è§£ç¼–è¯‘å™¨è¿™ä¸€éƒ¨åˆ†çš„ç»“æœå’Œå†…éƒ¨ç»“æ„çš„è¯¦ç»†ä¿¡æ¯ã€‚ æˆ‘å°†å°è¯•æä¾›ä¸€ç»„å»ºè®®ï¼Œè¿™äº›å»ºè®®åœ¨æŸäº›æƒ…å†µä¸‹å°†æœ‰åŠ©äºç»“æ„åŒ–ä»£ç ï¼Œä»è€Œå‡å°‘ä¸å¿…è¦çš„å†…å­˜åˆ†é…ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN422447/">https://habr.com/ru/post/zh-CN422447/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN422437/index.html">ç”¨æˆ·ä½“éªŒæ¸¸æˆä»¥åŠç½‘ç«™å’Œåº”ç”¨ç¨‹åºçš„é€Ÿåº¦</a></li>
<li><a href="../zh-CN422439/index.html">ä¸Yandexçš„æ–—äº‰ï¼šæˆ‘å¦‚ä½•èŠ±äº†ä¸€å¹´å¤šçš„æ—¶é—´å°†ç½‘ç«™æ¨å‘æœ€é«˜ç‚¹</a></li>
<li><a href="../zh-CN422441/index.html">æ‰¾åˆ°äº†æ— ç—›è¿‡æ¸¡åˆ°.Net Coreçš„å…¬å¼</a></li>
<li><a href="../zh-CN422443/index.html">Corona SDKç²¾ç¡®è®¡æ—¶å™¨</a></li>
<li><a href="../zh-CN422445/index.html">BottomAppBarå®ç°ã€‚ ç¬¬3éƒ¨åˆ†ï¼šAndroidè¡Œä¸º</a></li>
<li><a href="../zh-CN422449/index.html">å‚è®®å‘˜ä¸äºšé©¬é€Šï¼šåœ¨çº¿å•†åº—åšäº†ä»€ä¹ˆ</a></li>
<li><a href="../zh-CN422451/index.html">9æœˆ26æ—¥åœ¨VShBIä¸Šè†å¬æ¸¸æˆè¥é”€å’Œç¼–å‰§åœ¨æ¸¸æˆè¡Œä¸šä¸­çš„åœ°ä½</a></li>
<li><a href="../zh-CN422453/index.html">SmartData 2018ï¼šé¦–æ¬¡å–æ¶ˆJUG.ruå°ç»„ä¼šè®®</a></li>
<li><a href="../zh-CN422455/index.html">EPAM +å¤§å­¦ï¼šæˆ‘ä»¬å¦‚ä½•ä¸ä¹Œå…‹å…°å¤§å­¦åˆä½œ</a></li>
<li><a href="../zh-CN422457/index.html">â€œä½¿ç”¨Retrofitå¯¹æˆ‘ä»¬æ¥è¯´æ¯«æ— æ„ä¹‰â€ï¼šå…³äºSberbank Onlineçš„Androidå¼€å‘</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>