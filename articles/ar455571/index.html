<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐๐ฝ ๐ค ๐ฐ ูุคุดุฑุงุช ุงูุฏูุณูุจู ูู ุงูุนููุฏุฉ ๐๐ผ ๐๐ผ ๐คฒ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุจุงุณุชุฎุฏุงู ุงููุคุดุฑุงุช ุ ููููู ุงุณุชูุงู ุฏูุนุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุนุงูุฌุฉ ูููุฉ ูุจูุฑุฉ ูู ุงูุจูุงูุงุช ุฏูู ุฅุถุงุนุฉ ุฐุงูุฑุฉ ุงูุชุทุจูู. ุฃูุง ูุชุฃูุฏ ูู ุฃู ูู ูุทูุฑ ููุจ ูุงุฌู ูููุฉ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ูุคุดุฑุงุช ุงูุฏูุณูุจู ูู ุงูุนููุฏุฉ</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/455571/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/a_/l9/rc/a_l9rcqm9ubhpc_gstic1u-rxtq.jpeg" alt="ุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ุงููุคุดุฑุงุช ุ ููููู ุงุณุชูุงู ุฏูุนุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุนุงูุฌุฉ ูููุฉ ูุจูุฑุฉ ูู ุงูุจูุงูุงุช ุฏูู ุฅุถุงุนุฉ ุฐุงูุฑุฉ ุงูุชุทุจูู.  ุฃูุง ูุชุฃูุฏ ูู ุฃู ูู ูุทูุฑ ููุจ ูุงุฌู ูููุฉ ููุงุซูุฉ ูุฑุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู ุ ูููุณ ูุฑุฉ ูุงุญุฏุฉ ููุท ุฃูุงูู.  ุณูู ุฃุฎุจุฑู ูู ูุฐู ุงูููุงูุฉ ุจุงูููุงู ุงููููุฉ ุงูุชู ูููู ุฃู ุชููู ูุคุดุฑุงุช ูููุฏุฉ ุจูุง ุ ูุณุฃูุฏู ูู ุชุนูููุงุช ุจุฑูุฌูุฉ ุฌุงูุฒุฉ ููุนูู ูุนูู ูู PHP + Doctrine ุจุงุณุชุฎุฏุงู ูุซุงู PostrgeSQL. </p><a name="habracut"></a><br><h3 id="problema" style=";text-align:right;direction:rtl">  ุงููุดููุฉ </h3><br><p style=";text-align:right;direction:rtl">  ุฏุนููุง ูุชุฎูู ุฃู ูุฏููุง ูุดุฑูุน PHP ุ ูุจูุฑ ูุซููู.  ุจุงูุชุฃููุฏ ุ ููุฏ ูุชุจ ุจูุณุงุนุฏุฉ ุจุนุถ ุงูุฃุทุฑ.  ุนูู ุณุจูู ุงููุซุงู ุ Symfony.  ููุง ุฃูู ูุณุชุฎุฏู ูุงุนุฏุฉ ุจูุงูุงุช ุ ุนูู ุณุจูู ุงููุซุงู ุ PostgreSQL ุ ููุงุนุฏุฉ ุงูุจูุงูุงุช ุชุญุชูู ุนูู ููุญุฉ ุชุถู 2ุ000ุ000 ุณุฌู ุชุญุชูู ุนูู ูุนูููุงุช ุญูู ุงูุทูุจุงุช.  ูุงููุดุฑูุน ููุณู ูู ูุงุฌูุฉ ููุฐู ุงูุทูุจุงุช ุ ูุงูุชู ูููู ุนุฑุถูุง ูุชุตููุชูุง.  ูุงุณูุญูุง ูู ุฃู ุฃููู ุ ูุฐุง ูู ุญุงูุฉ ุฌูุฏุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุงูุขู ุทููุจ ููุง (ูู ุชุชู ูุทุงูุจุชู ุจุนุฏุ ุณููุทูุจ ูููู ุจุงูุชุฃููุฏ) ุชุญููู ูุชูุฌุฉ ุชุตููุฉ ุงูุทูุจุงุช ูู ููู Excel.  ุฏุนูุง ูุถุบุท ุฒุฑูุง ูุน ุฃููููุฉ ุฌุฏูู ุ ูุงูุชู ุณูู ุชูุซุฑ ููููุง ูุน ุฃูุงูุฑ ูููุณุชุฎุฏู. </p><br><h3 id="kak-obychno-reshayut-i-chem-eto-ploho" style=";text-align:right;direction:rtl">  ููู ูุชู ุชุญุฏูุฏ ุฐูู ุนุงุฏุฉ ุ ูููุงุฐุง ูู ุณูุกุ </h3><br><p style=";text-align:right;direction:rtl">  ููู ูููู ูููุจุฑูุฌ ุงูุฐู ูู ููุงุฌู ูุฐู ุงููููุฉ ุญุชู ุงูุขูุ  ุฅูู ูุฌุนู SELECT ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุ ูููุฑุฃ ูุชุงุฆุฌ ุงูุงุณุชุนูุงู ุ ููููู ุจุชุญููู ุงูุงุณุชุฌุงุจุฉ ุฅูู ููู Excel ููุนุทููุง ููุชุตูุญ ุงููุณุชุฎุฏู.  ุงููููุฉ ุชุนูู ุ ูุชู ุงูุงูุชูุงุก ูู ุงูุงุฎุชุจุงุฑ ุ ูููู ุงููุดุงูู ุชุจุฏุฃ ูู ุงูุฅูุชุงุฌ. </p><br><p style=";text-align:right;direction:rtl"> ุจุงูุชุฃููุฏ ุ ููุฏ ูุถุนูุง ุญุฏูุง ูุฐุงูุฑุฉ PHP ูู ุจุนุถ ุงููุนููู (ูููู ุงูููู) 1 ุบูุบุงุจุงูุช ููู ุนูููุฉ ุ ูุจูุฌุฑุฏ ุฃู ูุฐู ุงูุฎุทูุท 2 ููููู ูู ุชุนุฏ ุตุงูุญุฉ ูู ูุฐุง ุฌูุฌุงุจุงูุช ุ ููุงุตู ูู ุดูุก.  ุชุนุทู PHP ุจุณุจุจ ุฎุทุฃ "ููุงุฏ ุงูุฐุงูุฑุฉ" ุ ููุดูู ุงููุณุชุฎุฏููู ูู ุนุฏู ุชุญููู ุงูููู.  ูุญุฏุซ ูุฐุง ูุฃููุง ุงุฎุชุฑูุง ุทุฑููุฉ ุณุงุฐุฌุฉ ุฅูู ุญุฏ ูุง ูุฅูุบุงุก ุชุญููู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ูุชู ููููุง ุฌููุนูุง ูู ุฐุงูุฑุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุงููุฑุต ุงูููุฌูุฏ ุชุญุชูุง) ุฅูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู ุงูุฎุงุตุฉ ุจุนูููุฉ PHP ุ ุซู ุชุชู ูุนุงูุฌุชูุง ูุชุญููููุง ุฅูู ุงููุณุชุนุฑุถ. </p><br><p style=";text-align:right;direction:rtl">  ุญุชู ูุชู ูุถุน ุงูุจูุงูุงุช ุฏุงุฆููุง ูู ุงูุฐุงูุฑุฉ ุ ููุฒูู ุฃุฎุฐูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนูู ุดูู ุฃุฌุฒุงุก.  ุนูู ุณุจูู ุงููุซุงู ุ ุชูุช ูุฑุงุกุฉ 10000 ุณุฌู ููุนุงูุฌุชูุง ููุชุงุจุชูุง ูู ููู ุ ููุฑุงุช ุนุฏูุฏุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุญุณูุง ุ ูุนุชูุฏ ุงููุจุฑูุฌ ุงูุฐู ุงูุชูู ูููุชูุง ูุฃูู ูุฑุฉ.  ุจุนุฏ ุฐูู ุ ุณุฃููู ุจุนูู ุญููุฉ ููุฑุบ ูุชุงุฆุฌ ุงูุงุณุชุนูุงู ุฅูู ุฃุฌุฒุงุก ุ ููุง ูุดูุฑ ุฅูู LIMIT ู OFFSET.  ุฅูู ูุนูู ุ ูููู ุนูููุฉ ููููุฉ ููุบุงูุฉ ููุงุนุฏุฉ ุงูุจูุงูุงุช ุ ูุจุงูุชุงูู ูุฅู ุชุญููู ุงูุชูุฑูุฑ ูุง ูุจุฏุฃ ูู 30 ุซุงููุฉ ุ ูููู 30 ุฏูููุฉ (ููุณ ุณูุฆูุง ุฌุฏูุง!).  ุจุงูููุงุณุจุฉ ุ ุฅุฐุง ูู ููู ููุงู ุดูุก ูู ุนูู ูุจุฑูุฌ ุ ุจุบุถ ุงููุธุฑ ุนู OFFSET ูู ูุฐู ุงููุญุธุฉ ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง ูุฒุงู ููุงู ุงูุนุฏูุฏ ูู ุงูุทุฑู ูุชุญููู</a> ุฐูู ุฏูู ุงุบุชุตุงุจ ูุงุนุฏุฉ ุงูุจูุงูุงุช. </p><br><p style=";text-align:right;direction:rtl">  ูู ุงูููุช ููุณู ุ ุชุชูุชุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุณูุง ุจูุฏุฑุฉ ูุถููุฉ ุนูู ูุคุดุฑ ุชุฑุงุจุท ูุฑุงุกุฉ ุงูุจูุงูุงุช ููู - ุงููุคุดุฑุงุช. </p><br><h3 id="kursory" style=";text-align:right;direction:rtl">  ุงููุคุดุฑุงุช </h3><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุคุดุฑ</a> ูู ูุคุดุฑ ุฅูู ุณุทุฑ ูู ูุชุงุฆุฌ ุงุณุชุนูุงู ูุนูุด ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.  ุนูุฏ ุงุณุชุฎุฏุงููุง ุ ูุง ูููููุง ุฅุฌุฑุงุก SELECT ูู ูุถุน ุชูุฒูู ุงูุจูุงูุงุช ุงูููุฑู ุ ูููููุง ููุชุญ ุงููุคุดุฑ ุจุงุณุชุฎุฏุงู ูุฐุง ุงูุชุญุฏูุฏ.  ุจุนุฏ ุฐูู ุ ูุจุฏุฃ ูู ุชููู ุชุฏูู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃุซูุงุก ุชุญุฑู ุงููุคุดุฑ ููุฃูุงู.  ูุฐุง ูุนุทููุง ููุณ ุงููุชูุฌุฉ: ููุฑุฃ ุงูุจูุงูุงุช ุฌุฒุฆููุง ุ ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุง ุชููู ุจููุณ ุงููููุฉ ูุฅูุฌุงุฏ ุงูุณุทุฑ ุงูุฐู ูุฌุจ ุฃู ุชุจุฏุฃ ุจู ุ ููุง ูู ุงูุญุงู ูุน OFFSET. </p><br><p style=";text-align:right;direction:rtl">  ูุชู ูุชุญ ุงููุคุดุฑ ููุท ุฏุงุฎู ุงููุนุงููุฉ ููุณุชูุฑ ุฅูู ุฃู ุชุตุจุญ ุงููุนุงููุฉ ุญูุฉ (ููุงู ุงุณุชุซูุงุก ุ ุงูุธุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">WITH HOLD</a> ).  ูุฐุง ูุนูู ุฃููุง ุฅุฐุง ูุฑุฃูุง ุจุจุทุก ุงููุซูุฑ ูู ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุ ูุณูุญุตู ุนูู ูุนุงููุฉ ุทูููุฉ.  ูุฐุง ุฃูุฑ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุณูุก ูู ุจุนุถ ุงูุฃุญูุงู</a> ุ ุชุญุชุงุฌ ุฅูู ููู ููุจูู ูุฐุง ุงูุฎุทุฑ. </p><br><h3 id="kursory-v-doctrine" style=";text-align:right;direction:rtl">  ุงููุคุดุฑุงุช ูู ุงูุนููุฏุฉ </h3><br><p style=";text-align:right;direction:rtl">  ุฏุนููุง ูุญุงูู ุชูููุฐ ุงูุนูู ูุน ุงููุคุดุฑุงุช ูู ุงูุนููุฏุฉ.  ุฃููุงู ุ ููู ูุจุฏู ุทูุจ ูุชุญ ุงููุคุดุฑุ </p><br><pre style=";text-align:right;direction:rtl"><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> mycursor1 <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> huge_table );</code> </pre> <br><p style=";text-align:right;direction:rtl">  DECLARE ููุดุฆ ูููุชุญ ุงููุคุดุฑ ูุงุณุชุนูุงู SELECT ุงููุญุฏุฏ.  ุจุนุฏ ุฅูุดุงุก ุงููุคุดุฑ ุ ููููู ุงูุจุฏุก ูู ูุฑุงุกุฉ ุงูุจูุงูุงุช ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs">FETCH FORWARD 10000 FROM mycursor1; &lt; 10 000 &gt; FETCH FORWARD 10000 FROM mycursor1; &lt;  10 000 &gt; ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูููุฐุง ุ ุฅูู ุฃู ุชุนูุฏ FETCH ูุงุฆูุฉ ูุงุฑุบุฉ.  ูุฐุง ุณูู ูุนูู ุฃููู ุงูุชูููุง ุฅูู ุงูููุงูุฉ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุถุน ุงูุฎุทูุท ุงูุนุฑูุถุฉ ููุฆุฉ ูุชูุงููุฉ ูุน ุงูุนููุฏุฉ ุงูุชู ุณุชุฎุชุชู ุงูุนูู ูุน ุงููุคุดุฑ.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุญู 80ูช ูู ุงููุดููุฉ ูู 20ูช ูู ุงูููุช</a> ุ ุณุชุนูู ููุท ูุน ุงุณุชุนูุงูุงุช Native.  ูุฐูู ุฏุนููุง ูุณูููุง ุ PgSqlNativeQueryCursor. </p><br><p style=";text-align:right;direction:rtl">  ุงููุตูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NativeQuery $query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query = $query; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection = $query-&gt;getEntityManager()-&gt;getConnection(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName = uniqid(<span class="hljs-string"><span class="hljs-string">'cursor_'</span></span>); assert(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;getDriver() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> PDOPgSqlDriver); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃูุง ููุง ุชูููุฏ ุงุณู ูููุคุดุฑ ูู ุงููุณุชูุจู. </p><br><p style=";text-align:right;direction:rtl">  ูุธุฑูุง ูุฃู ุงููุตู ูุฏูู ููุฏ SQL ุฎุงุต ุจู PostgreSQL ูู ุงููุตู ุ ููู ุงูุฃูุถู ุงูุชุญูู ูู ุฃู ุณุงุฆููุง ูู PG. </p><br><p style=";text-align:right;direction:rtl">  ูู ุงููุตู ูุญุชุงุฌ ุฅูู ุซูุงุซุฉ ุฃุดูุงุก: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฃู ุชููู ูุงุฏุฑุฉ ุนูู ูุชุญ ุงููุคุดุฑ. </li><li style=";text-align:right;direction:rtl">  ุฃู ุชููู ูุงุฏุฑุฉ ุนูู ุฅุฑุฌุงุน ุงูุจูุงูุงุช ุฅูููุง. </li><li style=";text-align:right;direction:rtl">  ุฃู ุชููู ูุงุฏุฑุฉ ุนูู ุฅุบูุงู ุงููุคุดุฑ. </li></ol><br><p style=";text-align:right;direction:rtl">  <strong>ุงูุชุญ ุงููุคุดุฑ:</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openCursor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;getTransactionNestingLevel() === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \BadMethodCallException(<span class="hljs-string"><span class="hljs-string">'Cursor must be used inside a transaction'</span></span>); } $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'DECLARE %s CURSOR FOR (%s)'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName), <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query-&gt;getSQL() )); $query-&gt;execute(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query-&gt;getParameters()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ููุช ุ ุงููุคุดุฑุงุช ููุชูุญุฉ ูู ุงูุตููุฉ.  ูุฐูู ุ ุฃุชุญูู ููุง ูู ุฃููุง ูู ููุณู ุฅุฌุฑุงุก ููุงููุฉ ููุฐู ุงูุทุฑููุฉ ุฏุงุฎู ูุนุงููุฉ ููุชูุญุฉ ุจุงููุนู.  (ุงูุญูุฏ ููู ุ ููุฏ ูุฑ ุงูููุช ุงูุฐู ุณูุชู ููู ุณุญุจ ุฅุฌุฑุงุก ูุนุงููุฉ ููุง!) </p><br><p style=";text-align:right;direction:rtl">  ูุชุจุณูุท ูููุฉ ุฅูุดุงุก ูุชููุฆุฉ NativeQuery ุฌุฏูุฏุฉ ุ ุฃูุง ูุฌุฑุฏ ุงุณุชูุณุงุฎ ุงูุฐู ุชู ุชุบุฐูุชู ูู ุงูููุดุฆ ูููู ูู DECLARE ... CURSOR FOR (here_original_query).  ุฃูุง ุฃุญูููุง. </p><br><p style=";text-align:right;direction:rtl">  <strong>ููุฌุนู ุทุฑููุฉ getFetchQuery.</strong>  ูู ููุฑุฌุน ุงูุจูุงูุงุช ุ ูููู ุทูุจูุง ุขุฎุฑ ูููู ุงุณุชุฎุฏุงูู ููุง ุชุฑูุฏ ููุญุตูู ุนูู ุงูุจูุงูุงุช ุงููุทููุจุฉ ูู ุฏูุนุงุช ูุนููุฉ.  ูุฐุง ูุนุทู ุฑูุฒ ุงูุฏุนูุฉ ุงููุฒูุฏ ูู ุงูุญุฑูุฉ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setParameters([]); $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH FORWARD %d FROM %s'</span></span>, $count, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุญุชูู ุงูุทุฑููุฉ ุนูู ูุนููุฉ ูุงุญุฏุฉ - ูุฐุง ูู ุญุฌู ุงูุญุฒูุฉ ุ ูุงูุชู ุณุชุตุจุญ ุฌุฒุกูุง ูู ุงูุทูุจ ุงูุฐู ูุชู ุฅุฑุฌุงุนู ุจูุงุณุทุฉ ูุฐู ุงูุทุฑููุฉ.  ุฃุทุจู ููุณ ุงูุฎุฏุนุฉ ุจุงุณุชุฎุฏุงู ุงุณุชูุณุงุฎ ุงูุงุณุชุนูุงู ุ ูุงููุชุงุจุฉ ููู ุงููุนููุงุช ููู ูุงุณุชุจุฏุงู SQL ุจู FETCH ... FROM ...ุ </p><br><p style=";text-align:right;direction:rtl">  ููู ูุง ุชูุณู ูุชุญ ุงููุคุดุฑ ูุจู ุฃูู ููุงููุฉ ุฅูู getFetchQuery () (ูุฌุฃุฉ ูู ุฃุญุตู ุนูู ูุณุท ูุงูู ูู ุงูููู) ุ ุณุฃููู ุจูุชุญ ุถููู ููู ูุจุงุดุฑุฉู ูู ุทุฑููุฉ getFetchQuery (): </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;openCursor(); } โฆ</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุณุชููู ุทุฑููุฉ openCursor () ููุณูุง ุฎุงุตุฉ.  ูุง ุฃุฑู ุญุงูุงุช ุนูู ุงูุฅุทูุงู ุนูุฏูุง ุฃุญุชุงุฌ ุฅูู ุงูุงุชุตุงู ุจูุง ุตุฑุงุญุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุฏุงุฎู getFetchQuery () ุ ููุช ุจุชุฑููุฒ FORWARD ุงูุซุงุจุช ูุชุญุฑูู ุงููุคุดุฑ ุฅูู ุงูุฃูุงู ูุนุฏุฏ ูุนูู ูู ุงูุฎุทูุท.  ููู ุฃูุถุงุน ุงุณุชุฏุนุงุก ุฌูุจ ูุฎุชููุฉ ูุซูุฑุฉ.  ุฏุนูุง ูุถูููู ุฃูุถุงุ </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_NEXT = <span class="hljs-string"><span class="hljs-string">'NEXT'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_PRIOR = <span class="hljs-string"><span class="hljs-string">'PRIOR'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_FIRST = <span class="hljs-string"><span class="hljs-string">'FIRST'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_LAST = <span class="hljs-string"><span class="hljs-string">'LAST'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DIRECTION_ABSOLUTE = <span class="hljs-string"><span class="hljs-string">'ABSOLUTE'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// with count const DIRECTION_RELATIVE = 'RELATIVE'; // with count const DIRECTION_FORWARD = 'FORWARD'; // with count const DIRECTION_FORWARD_ALL = 'FORWARD ALL'; const DIRECTION_BACKWARD = 'BACKWARD'; // with count const DIRECTION_BACKWARD_ALL = 'BACKWARD ALL';</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุจู ูุตููู ุนุฏุฏ ุงูุฃุณุทุฑ ูู ุงููุนููุฉ ุ ุจูููุง ูุง ููุจู ุงููุตู ุงูุขุฎุฑ.  ุฅูููู ูุง ุญุตูุช ุนููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFetchQuery</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $count = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, string $direction = self::DIRECTION_FORWARD)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NativeQuery</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;openCursor(); } $query = <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;query; $query-&gt;setParameters([]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_ABSOLUTE || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_RELATIVE || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_FORWARD || $direction == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::DIRECTION_BACKWARD ) { $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH %s %d FROM %s'</span></span>, $direction, $count, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $query-&gt;setSQL(sprintf( <span class="hljs-string"><span class="hljs-string">'FETCH %s FROM %s'</span></span>, $direction, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName) )); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $query; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  <strong>ุฃุบูู ุงููุคุดุฑ</strong> ูุน CLOSE ุ ูููุณ ูู ุงูุถุฑูุฑู ุงูุงูุชุธุงุฑ ุญุชู ุชูุชูู ุงููุนุงููุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;exec(<span class="hljs-string"><span class="hljs-string">'CLOSE '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connection-&gt;quoteIdentifier(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cursorName)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงููุฏูุฑ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isOpen) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;close(); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง ูู ุงููุตู ุจุฃูููู</a> .  ุฏุนููุง ูุญุงูู ูู ุงูุนููุ </p><br><p style=";text-align:right;direction:rtl">  ุฃูุง ูุชุญ ุจุนุถ ุงููุงุชุจ ุงูุดุฑุทู ูู ุจุนุถ XLSX ุงูุดุฑุทู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs">$writer-&gt;openToFile($targetFile);</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ุฃุญุตู ุนูู NativeQuery ูุณุญุจ ูุงุฆูุฉ ุงูุทูุจุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> NativeQuery $query */</span></span> $query = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getOrdersRepository($em) -&gt;getOrdersFiltered($dateFrom, $dateTo, $filters);</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจูุงุกู ุนูู ูุฐุง ุงูุงุณุชุนูุงู ุ ุฃุนูู ุงููุคุดุฑ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs">$cursor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PgSqlNativeQueryCursor($query);</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุจุงููุณุจุฉ ูู ุ ุฃุญุตู ุนูู ุทูุจ ูุชููู ุงูุจูุงูุงุช ุนูู ุฏูุนุงุช ูู 10000 ุณุทุฑ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs">$fetchQuery = $cursor-&gt;getFetchQuery(<span class="hljs-number"><span class="hljs-number">10000</span></span>);</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃูุฑุฑ ุญุชู ุฃุญุตู ุนูู ูุชูุฌุฉ ูุงุฑุบุฉ.  ูู ูู ุชูุฑุงุฑ ุ ุฃููู ุจุฅุฌุฑุงุก FETCH ุ ููุนุงูุฌุฉ ุงููุชูุฌุฉ ุ ูุงููุชุงุจุฉ ุฅูู ููู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $result = $fetchQuery-&gt;getArrayResult(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($result <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { $writer-&gt;addRow(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;toXlsxRow($row)); } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($result);</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃุบูู ุงููุคุดุฑ ูุงููุงุชุจ. </p><br><pre style=";text-align:right;direction:rtl"> <code class="php hljs">$cursor-&gt;close(); $writer-&gt;close();</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃูุชุจ ุงูููู ุฅูู ุงููุฑุต ูู ุฏููู ูููููุงุช ุงููุคูุชุฉ ุ ูุจุนุฏ ุงูุชูุงู ุงูุชุณุฌูู ุ ุฃุฑุณูู ุฅูู ุงููุชุตูุญ ูุชุฌูุจ ูุฑุฉ ุฃุฎุฑู ุงูุชุฎุฒูู ุงููุคูุช ูู ุงูุฐุงูุฑุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุชูุฑูุฑ ุฌุงูุฒ!  ุงุณุชุฎุฏููุง ูููุฉ ุซุงุจุชุฉ ูู ุงูุฐุงูุฑุฉ ูู PHP ููุนุงูุฌุฉ ุฌููุน ุงูุจูุงูุงุช ููู ูุนุฐุจ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน ุณูุณูุฉ ูู ุงูุงุณุชูุณุงุฑุงุช ุงูุซูููุฉ.  ุงุณุชุบุฑู ุงูุชูุฑูุบ ููุณู ููุชูุง ุฃูุซุฑ ููููุงู ูู ุงููุงุนุฏุฉ ุงููุทููุจุฉ ููููุงุก ุจุงูุทูุจ. </p><br><p style=";text-align:right;direction:rtl">  ุชุนุฑู ุนูู ูุง ุฅุฐุง ูุงูุช ููุงู ุฃูุงูู ูู ูุดุงุฑูุนู ูููููุง ุชุณุฑูุน / ุญูุธ ุงูุฐุงูุฑุฉ ุจุงุณุชุฎุฏุงู ุงููุคุดุฑุ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar455571/">https://habr.com/ru/post/ar455571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar455555/index.html">ูุทุนุฉ ูููุฏูุฑ ุงููููุงููููุฉ</a></li>
<li><a href="../ar455559/index.html">ููู ูููู ููููุจููุชุฑ ุงูููููู ุงูุชุญุงู ุฃูุธูุฉ ุงูุชุดููุฑ ุงูุญุฏูุซุฉ ูุฎูุถ ุชูููุฉ ุฅูุชุงุฌ ุงูุฃููููุงุ</a></li>
<li><a href="../ar455563/index.html">ุงูุฃุนูุงู ุงูุตุบูุฑุฉ: ุฃุชูุชุฉ ุฃู ูุงุ</a></li>
<li><a href="../ar455565/index.html">ูููู ููุนูู ููููุฉ ุงููููุ</a></li>
<li><a href="../ar455569/index.html">ูุฏุนูู ูุญุถูุฑ ูุคุชูุฑ Tarantool ูู 17 ููููู</a></li>
<li><a href="../ar455575/index.html">ุงููุทุงุจูุฉ ุงูุนุตุจูุฉ: ููููุฉ ุชูููู ุงููุญุชูู ูุน ุญูุงุฆู ุฌูุฌู</a></li>
<li><a href="../ar455577/index.html">ุฏุฑูุณ SDL 2: ุงูุฏุฑุณ 3 - ุงูุฃุญุฏุงุซ</a></li>
<li><a href="../ar455579/index.html">ุชุซุจุฑูุฑ: ููุณุจูู ุงููุงุชู Kubernetesุ</a></li>
<li><a href="../ar455580/index.html">ูุฌุจ ุฃู ูููู ุชุทุจูู ุฑุณูู ูุชุญุฑูุฉ ููุฌูุงู</a></li>
<li><a href="../ar455582/index.html">ุงูุชููู ูู ุงููุชุฌุฑ: ูู ุฎูุงู ุงููุงูุน ุงููุนุฒุฒ ุฅูู ุงูุฑู ุงููุทููุจ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>