<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßìüèº üâê ‚ô£Ô∏è SObjectizer-5.6.0: corte ao vivo para crescer ainda mais üëºüèΩ ‚ûï üö¥üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No terceiro dia, uma nova vers√£o do SObjectizer ficou dispon√≠vel : 5.6.0 . Sua principal caracter√≠stica √© a rejei√ß√£o da compatibilidade com o ramo est...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SObjectizer-5.6.0: corte ao vivo para crescer ainda mais</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453256/"><p><img src="https://habrastorage.org/webt/vp/ah/jx/vpahjx-dkpsauwtfzyeiktnsfp4.jpeg"></p><br><p>  No terceiro dia, uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">nova vers√£o do SObjectizer</a> ficou dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">: 5.6.0</a> .  Sua principal caracter√≠stica √© a rejei√ß√£o da compatibilidade com o ramo est√°vel anterior 5.5, que vem se desenvolvendo constantemente ao longo de quatro anos e meio. </p><br><p>  Os princ√≠pios b√°sicos de opera√ß√£o do SObjectizer-5 permaneceram os mesmos.  Comunica√ß√µes, agentes, coopera√ß√µes e despachantes ainda est√£o conosco.  Mas algo mudou seriamente, algo geralmente foi jogado fora.  Portanto, apenas pegar o SO-5.6.0 e recompilar seu c√≥digo falhar√°.  Algo precisa ser reescrito.  Algo pode ter que ser redesenhado. </p><br><p>  Por que cuidamos da compatibilidade por v√°rios anos e depois decidimos levar e quebrar tudo?  E o que quebrou mais completamente? </p><br><p>  Vou tentar falar sobre isso neste artigo. </p><br><h1 id="zachem-voobsche-potrebovalos-chto-to-lomat">  Por que voc√™ precisou quebrar alguma coisa? </h1><br><p>  √â simples assim. </p><a name="habracut"></a><br><p>  O SObjectizer-5.5 durante seu desenvolvimento absorveu tantas coisas diferentes e diversas que n√£o foram originalmente planejadas que, como resultado, formou muitas muletas e adere√ßos dentro.  A cada nova vers√£o, adicionar algo novo ao SO-5.5 ficava cada vez mais dif√≠cil.  E, finalmente, √† pergunta "Por que precisamos de tudo isso?"  Nenhuma resposta adequada foi encontrada. </p><br><p>  Portanto, a primeira raz√£o √© a re-complica√ß√£o das crian√ßas do SObjectizer. </p><br><p>  A segunda raz√£o √© que estamos estupidamente cansados ‚Äã‚Äãde focar nos antigos compiladores C ++.  A filial 5.5 come√ßou em 2014, quando t√≠nhamos, se n√£o me engano, gcc-4.8 e MSVS2013.  E nesse n√≠vel, continuamos a manter a barra de requisitos para o n√≠vel de suporte do padr√£o C ++. </p><br><p>  Inicialmente, t√≠nhamos "interesse ego√≠sta" nisso.  Al√©m disso, por algum tempo, consideramos os baixos requisitos para a qualidade do suporte ao padr√£o C ++ como nossa "vantagem competitiva". </p><br><p>  Mas o tempo passa, o "interesse ego√≠sta" acabou.  Alguns benef√≠cios dessa "vantagem competitiva" n√£o s√£o vis√≠veis.  Talvez eles fossem, se trabalhassemos com o C ++ 98, estar√≠amos interessados ‚Äã‚Äãem uma empresa sangrenta.  Mas o sangrento empreendimento daqueles como n√≥s, em princ√≠pio, n√£o est√° interessado.  Portanto, foi decidido parar de nos limitar e tomar algo mais fresco.  Ent√£o, pegamos o mais novo do est√°bulo no momento: C ++ 17. </p><br><p>  Obviamente, nem todo mundo vai gostar dessa solu√ß√£o, afinal, para muitos C ++ 17, essa √© agora uma vantagem inating√≠vel, que ainda est√° muito, muito distante. </p><br><p>  No entanto, decidimos esse risco.  Mesmo assim, o processo de populariza√ß√£o do SObjectizer n√£o est√° indo r√°pido; portanto, quando o SObjectizer se tornar mais ou menos amplamente procurado, o C ++ 17 n√£o ser√° mais uma "vanguarda".  Em vez disso, ele ser√° tratado da mesma maneira que √© agora no C ++ 11. </p><br><p>  Em geral, em vez de continuar construindo muletas usando um subconjunto do C ++ 11, decidimos refazer seriamente as partes internas do SObjectizer usando o C ++ 17.  Construir uma base sobre a qual o SObjectizer possa se desenvolver progressivamente nos pr√≥ximos quatro ou cinco anos. </p><br><h1 id="chto-serezno-pomenyalos-v-sobjectizer-56">  O que mudou seriamente no SObjectizer-5.6? </h1><br><p>  Agora, vamos examinar brevemente algumas das mudan√ßas mais marcantes. </p><br><h2 id="u-kooperaciy-agentov-bolshe-net-strokovyh-imen">  As coopera√ß√µes do agente n√£o t√™m mais nomes de sequ√™ncia </h2><br><h3 id="problema">  O problema </h3><br><p>  Desde o in√≠cio, o SObjectizer-5 exigiu que cada coopera√ß√£o tivesse seu pr√≥prio nome de string exclusivo.  Esse recurso foi herdado do quinto SObjectizer do quarto SObjectizer anterior. </p><br><p>  Consequentemente, o SObjectizer precisava armazenar os nomes das coopera√ß√µes registradas.  Verifique sua singularidade no registro.  Procure coopera√ß√£o por nome durante o cancelamento de registro, etc., etc. </p><br><p>  Desde as primeiras vers√µes, um esquema simples foi usado no SObjectzer-5: um √∫nico dicion√°rio de coopera√ß√µes registradas protegidas por mutex.  Ao registrar uma coopera√ß√£o, o mutex √© capturado, a exclusividade do nome da coopera√ß√£o, a presen√ßa de um pai, etc.  Ap√≥s a verifica√ß√£o, o dicion√°rio √© modificado, ap√≥s o qual o mutex √© liberado.  Isso significa que, ao mesmo tempo em que o registro / cancelamento de registro de v√°rias coopera√ß√µes come√ßa ao mesmo tempo, em alguns momentos eles param e esperam at√© que uma das opera√ß√µes conclua o trabalho com o dicion√°rio cooperativo.  Por esse motivo, as opera√ß√µes cooperativas n√£o foram bem dimensionadas. </p><br><p>  Era disso que eu queria me livrar, a fim de melhorar a situa√ß√£o com a velocidade do registro das coopera√ß√µes. </p><br><h3 id="reshenie">  Solu√ß√£o </h3><br><p>  Duas maneiras principais de resolver esse problema foram consideradas. </p><br><p>  Primeiramente, armazenando nomes de strings, mas alterando a maneira como o dicion√°rio √© armazenado para que a opera√ß√£o de registro de coopera√ß√£o possa ser dimensionada.  Por exemplo, compartilhamento de dicion√°rio, ou seja,  quebrando-o em v√°rios peda√ßos, cada um dos quais seria protegido por seu mutex. </p><br><p>  Em segundo lugar, uma rejei√ß√£o completa dos nomes das strings e o uso de alguns identificadores atribu√≠dos pelo SObjectizer. </p><br><p> Como resultado, escolhemos o segundo m√©todo e abandonamos completamente o nome das cooperativas.  Agora, no SObjectizer, existe algo como <code>coop_handle</code> , ou seja,  um identificador cujo conte√∫do est√° oculto do usu√°rio, mas que pode ser comparado com <code>std::weak_ptr</code> . </p><br><p>  O SObjectizer retorna <code>coop_handle</code> ao registrar uma colabora√ß√£o: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> coop = env.make_coop(); ... <span class="hljs-comment"><span class="hljs-comment">//    . auto coop_id = env.register_coop(std::move(coop)); // . //   coop_id    .</span></span></code> </pre> <br><p>  Esse identificador deve ser usado para cancelar o registro da coopera√ß√£o: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> coop = env.make_coop(); ... <span class="hljs-comment"><span class="hljs-comment">//    . auto coop_id = env.register_coop(std::move(coop)); // . //   coop_id    . ... // - . // ,     . //       . env.deregister_coop(coop_id, ...);</span></span></code> </pre> <br><p>  Al√©m disso, esse identificador deve ser usado ao estabelecer um relacionamento pai-filho: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   . auto parent = env.make_coop(); ... //  parent . auto parent_id = env.register_coop(std::move(parent)); //  . ... //      ,    . auto child = env.make_coop(parent_id); ...</span></span></code> </pre> <br><p>  A estrutura do reposit√≥rio para coopera√ß√£o no SObjectizer Environment tamb√©m mudou drasticamente.  Se antes da vers√£o 5.5 inclusive era um dicion√°rio comum, agora cada coopera√ß√£o √© um reposit√≥rio de links para coopera√ß√µes filho.  I.e.  As cooperativas formam uma √°rvore com uma raiz em uma cooperativa de raiz especial oculta ao usu√°rio. </p><br><p>  Essa estrutura torna poss√≠vel dimensionar as <code>deregister_coop</code> <code>register_coop</code> e <code>deregister_coop</code> muito melhor: o bloqueio m√∫tuo de opera√ß√µes paralelas ocorre apenas se ambas pertencerem √† mesma coopera√ß√£o dos pais.  Para maior clareza, eis o resultado do lan√ßamento de uma <a href="" rel="nofollow">refer√™ncia especial</a> que mede o desempenho das opera√ß√µes com coopera√ß√µes no meu laptop antigo com o Ubuntu 16.04 e GCC-7.3: </p><br><pre> <code class="plaintext hljs">_test.bench.so_5.parallel_parent_child -r 4 -l 7 -s 5 Configuration: roots: 4, levels: 7, level-size: 5 parallel_parent_child: 15.69s 488280 488280 488280 488280 Total: 1953120</code> </pre> <br><p>  I.e.  a vers√£o 5.6.0 lidou com quase 2 milh√µes de coopera√ß√µes em ~ 15,5 segundos. </p><br><p>  E aqui est√° a vers√£o 5.5.24.4, a √∫ltima da ramifica√ß√£o 5.5 no momento: </p><br><pre> <code class="plaintext hljs">_test.bench.so_5.parallel_parent_child -r 4 -l 7 -s 5 Configuration: roots: 4, levels: 7, level-size: 5 parallel_parent_child: 46.856s 488280 488280 488280 488280 Total: 1953120</code> </pre> <br><p>  O mesmo cen√°rio, mas o resultado √© tr√™s vezes pior. </p><br><h2 id="ostalsya-vsego-odin-vid-dispetcherov">  Resta apenas um tipo de despachante </h2><br><p>  Os expedidores s√£o uma das pedras angulares do SObjectizer.  S√£o os despachantes que determinam onde e como os agentes processar√£o suas mensagens.  Portanto, sem a id√©ia de despachantes, provavelmente n√£o haveria um SObjectizer. </p><br><p>  No entanto, os pr√≥prios despachantes evolu√≠ram, evolu√≠ram e evolu√≠ram a um ponto em que n√£o era dif√≠cil para n√≥s criar um novo despachante para o SObjectizer-5.5.  Mas muito problem√°tico.  No entanto, vamos lev√°-lo em ordem. </p><br><p>  Inicialmente, todos os despachantes necess√°rios ao aplicativo s√≥ podiam ser criados no in√≠cio do SObjectizer: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { <span class="hljs-comment"><span class="hljs-comment">/* -   */</span></span> }, <span class="hljs-comment"><span class="hljs-comment">//    SObjectizer-. []( so_5::environment_params_t &amp; params ) { p.add_named_dispatcher("active_obj", so_5::disp::active_obj::create_disp()); p.add_named_dispatcher("shutdowner", so_5::disp::active_obj::create_disp()); p.add_named_dispatcher("groups", so_5::disp::active_group::create_disp()); ... } );</span></span></code> </pre> <br><p>  Eu n√£o criei o expedidor necess√°rio antes do in√≠cio - tudo, √© minha culpa, voc√™ n√£o pode mudar nada. </p><br><p>  Est√° claro que isso √© inconveniente e, √† medida que os cen√°rios de uso do SObjectizer se expandiam, era necess√°rio resolver esse problema.  Portanto, o m√©todo <code>add_dispatcher_if_not_exists</code> , que verificava a presen√ßa de um expedidor e, se n√£o houvesse, permitia criar uma nova inst√¢ncia: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . env.add_dispatcher_if_not_exists( "extra_dispatcher", []{ return so_5::disp::active_obj::create_disp(); } ); }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Esses despachantes foram chamados de p√∫blicos.  Os expedidores p√∫blicos tinham nomes √∫nicos.  E usando esses nomes, os agentes estavam vinculados aos despachantes: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . env.add_dispatcher_if_not_exists( "extra_dispatcher", []{ return so_5::disp::active_obj::create_disp(); } ); //         //    . auto coop = env.create_coop( "ping_pong", //     extra_dispatcher. so_5::disp::active_obj::create_disp_binder( "extra_dispatcher" ) ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Mas os despachantes p√∫blicos tinham uma caracter√≠stica desagrad√°vel.  Eles come√ßaram a trabalhar imediatamente ap√≥s serem adicionados ao SObjectizer Environment e continuaram a trabalhar at√© o SObjectizer Environment concluir seu trabalho. </p><br><p>  Mais uma vez, com o tempo, come√ßou a interferir.  Era necess√°rio garantir que os despachantes pudessem ser adicionados conforme necess√°rio e que os despachantes que se tornassem desnecess√°rios fossem exclu√≠dos automaticamente. </p><br><p>  Portanto, havia despachantes "particulares".  Esses despachantes n√£o tinham nomes e viveram enquanto houvesse refer√™ncias a eles.  Despachantes particulares podem ser criados a qualquer momento ap√≥s iniciar o SObjectizer Environment, eles s√£o destru√≠dos automaticamente. </p><br><p>  Em geral, os despachantes privados acabaram sendo um elo de muito sucesso na evolu√ß√£o dos despachantes, mas trabalhar com eles foi muito diferente de trabalhar com despachantes p√∫blicos: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . auto disp = so_5::disp::active_obj::create_private_disp(env); //         //    . auto coop = env.create_coop( "ping_pong", //      . disp-&gt;binder() ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><p>  Ainda mais despachantes p√∫blicos e privados diferiram na implementa√ß√£o.  Portanto, para n√£o duplicar o c√≥digo e escrever separadamente o despachante p√∫blico e privado do mesmo tipo, tive que usar constru√ß√µes bastante complexas com modelos e heran√ßa. </p><br><p>  Como resultado, eu estava cansado de acompanhar toda essa variedade e no SObjectizer-5.6 havia apenas um tipo de despachante.  De fato, este √© um an√°logo de despachantes particulares.  Mas apenas sem men√ß√£o expl√≠cita √† palavra "particular".  Ent√£o agora o fragmento mostrado acima ser√° escrito como: </p><br><pre> <code class="cpp hljs">so_5::launch( []( so_5::<span class="hljs-keyword"><span class="hljs-keyword">environment_t</span></span> &amp; env ) { ... <span class="hljs-comment"><span class="hljs-comment">// - . //     . auto disp = so_5::disp::active_obj::make_dispatcher(env); //         //    . auto coop = env.create_coop( "ping_pong", //      . disp.binder() ); coop-&gt;make_agent&lt; a_pinger_t &gt;(...); coop-&gt;make_agent&lt; a_ponger_t &gt;(...); ... }, //    SObjectizer-. []( so_5::environment_params_t &amp; params ) {...} );</span></span></code> </pre> <br><h2 id="ostalis-tolko-svobodnye-funkcii-send-send_delayed-i-send_periodic">  Existem apenas fun√ß√µes gratuitas send, send_delayed e send_periodic left </h2><br><p>  O desenvolvimento da API para enviar mensagens para o SObjectizer √© provavelmente o exemplo mais impressionante de como o SObjectizer mudou √† medida que o suporte ao C ++ 11 melhorou nos compiladores dispon√≠veis para n√≥s. </p><br><p>  Primeiro, as mensagens foram enviadas assim: </p><br><pre> <code class="cpp hljs">mbox-&gt;deliver_message(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> my_message(...));</code> </pre> <br><p>  Ou, se voc√™ seguir as "recomenda√ß√µes dos melhores criadores de c√£es" (c): </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;my_message&gt; msg(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> my_message(...)); mbox-&gt;deliver_message(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(msg));</code> </pre> <br><p>  No entanto, chegamos √† nossa disposi√ß√£o os compiladores com suporte para modelos variados e fun√ß√µes de envio.  Tornou-se poss√≠vel escrever assim: </p><br><pre> <code class="cpp hljs">send&lt;my_message&gt;(target, ...);</code> </pre> <br><p>  √â verdade que demorou mais tempo para uma fam√≠lia inteira <code>send_to_agent</code> com um simples <code>send</code> , incluindo <code>send_to_agent</code> , <code>send_delayed_to_agent</code> etc.  E ent√£o, para tornar essa fam√≠lia mais restrita ao conjunto familiar de <code>send</code> , <code>send_delayed</code> e <code>send_periodic</code> . </p><br><p>  Mas, apesar de a fam√≠lia de fun√ß√µes de envio ter sido formada h√° muito tempo e ter sido a maneira recomendada de enviar mensagens por v√°rios anos, m√©todos antigos como <code>deliver_message</code> , <code>schedule_timer</code> e <code>single_timer</code> ainda estavam dispon√≠veis para o usu√°rio. </p><br><p>  Mas na vers√£o 5.6.0, apenas as fun√ß√µes de <code>send</code> gratuito, <code>send_delayed</code> e <code>send_periodic</code> foram salvas na API p√∫blica do SObjectizer.  Todo o resto foi exclu√≠do por completo ou transferido para espa√ßos de nomes internos do SObjectizer. </p><br><p>  Portanto, no SObjectizer-5.6, a interface para o envio de mensagens finalmente se tornou o que teria sido se tiv√©ssemos compiladores com suporte normal ao C ++ 11 desde o in√≠cio.  Bem, al√©m disso, se tiv√©ssemos experi√™ncia em usar esse C ++ 11 muito normal. </p><br><h2 id="edinyy-format-send_delayed-i-send_periodic">  Formato √∫nico send_delayed e send_periodic </h2><br><p>  Com as <code>send_periodic</code> e <code>send_periodic</code> nas vers√µes anteriores do SObjectizer, houve outro incidente. </p><br><p>  Para usar o timer, voc√™ deve ter acesso ao SObjectizer Environment.  Dentro do agente, h√° um link para o SObjectizer Environment.  E dentro do mchain existe esse link.  Mas dentro da mbox ela n√£o estava l√°.  Portanto, se uma mensagem pendente foi enviada para um agente ou para o mchain, a chamada <code>send_delayed</code> com: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(target_agent, pause, ...); send_delayed&lt;my_message&gt;(target_mchain, pause, ...);</code> </pre> <br><p>  Para o caso da mbox, tivemos que pegar um link para o SObjectizer Environment de outro lugar: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;so_environment(), target_mbox, pause, ...);</code> </pre> <br><p>  Esse recurso de <code>send_delayed</code> e <code>send_periodic</code> foi uma pequena lasca.  O que n√£o interfere muito, mas √© irritante.  E tudo porque, inicialmente, n√£o come√ßamos a armazenar o link para o SObjectizer Environment no mbox-ahs. </p><br><p>  A viola√ß√£o da compatibilidade com vers√µes anteriores foi um bom motivo para se livrar dessa lasca. </p><br><p>  Agora voc√™ pode descobrir na mbox para que ambiente do SObjectizer foi criado.  E isso possibilitou o uso dos <code>send_periodic</code> e <code>send_periodic</code> para qualquer tipo de destinat√°rio da mensagem de timer: </p><br><pre> <code class="cpp hljs">send_delayed&lt;my_message&gt;(target_agent, pause, ...); send_delayed&lt;my_message&gt;(target_mchain, pause, ...); send_delayed&lt;my_message&gt;(target_mbox, pause, ...);</code> </pre> <br><p>  No sentido literal, "um pouco, mas legal". </p><br><h2 id="net-bolshe-ad-hoc-agentov">  N√£o h√° mais agentes ad-hoc </h2><br><p>  Como diz o ditado, "Todo acidente tem um nome, nome do meio e sobrenome".  No caso de agentes ad-hoc, esse √© meu primeiro nome, nome do meio e sobrenome :( </p><br><p>  O ponto √© este.  Quando come√ßamos a falar sobre o SObjectizer-5 em p√∫blico, ouvimos muitas cr√≠ticas pela veracidade do c√≥digo nos exemplos do SObjectizer.  E, pessoalmente, essa verbosidade me pareceu um problema s√©rio com o qual preciso lidar seriamente. </p><br><p>  Uma fonte de verbosidade √© a necessidade de os agentes herdarem do tipo base especial <code>agent_t</code> .  E a partir disso, ao que parece, n√£o h√° escapat√≥ria.  Ou n√£o? </p><br><p>  Portanto, havia agentes ad-hoc, ou seja,  agentes, para os quais n√£o era necess√°rio escrever uma classe separada, bastava definir a rea√ß√£o √†s mensagens na forma de fun√ß√µes lambda.  Por exemplo, o exemplo cl√°ssico de pingue-pongue em agentes ad-hoc pode ser escrito assim: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pinger = coop-&gt;define_agent(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ponger = coop-&gt;define_agent(); pinger .on_start( [ponger]{ so_5::send&lt; msg_ping &gt;( ponger ); } ) .event&lt; msg_pong &gt;( pinger, [ponger]{ so_5::send&lt; msg_ping &gt;( ponger ); } ); ponger .event&lt; msg_ping &gt;( ponger, [pinger]{ so_5::send&lt; msg_pong &gt;( pinger ); } );</code> </pre> <br><p>  I.e.  sem classes pr√≥prias.  Apenas chamamos <code>define_agent()</code> na coopera√ß√£o e obtemos algum tipo de objeto agente, que voc√™ pode assinar nas mensagens recebidas. </p><br><p>  Portanto, no SObjectizer-5 houve uma separa√ß√£o entre agentes regulares e ad-hoc. </p><br><p>  O que n√£o trouxe b√¥nus vis√≠veis, apenas os custos trabalhistas extras para acompanhar essa separa√ß√£o.  E, com o tempo, ficou claro que os agentes ad-hoc s√£o como uma mala sem al√ßa: √© dif√≠cil de carregar e √© uma pena sair.  Mas enquanto trabalhava no SObjectizer-5.6, foi decidido sair. </p><br><p>  Ao mesmo tempo, tamb√©m foi aprendida outra li√ß√£o, talvez ainda mais importante: em qualquer discuss√£o p√∫blica sobre a ferramenta na Internet, um grande n√∫mero de pessoas participar√°, indiferentes ao que √© a ferramenta, por que √© necess√°ria, por que √© como deveria ser usada etc.  √â simplesmente importante que eles expressem sua opini√£o forte.  No segmento da Internet em l√≠ngua russa, al√©m disso, ainda √© muito importante transmitir aos desenvolvedores da ferramenta como eles s√£o est√∫pidos e sem instru√ß√£o e quanto o resultado de seu trabalho n√£o √© necess√°rio. </p><br><p>  Portanto, voc√™ deve ter muito cuidado com o que lhe disseram.  E voc√™ pode ouvir (e depois com cuidado) apenas o que √© dito aqui neste sentido: "Tentei fazer isso no seu instrumento e n√£o gosto de quanto c√≥digo ele chegou aqui".  Mesmo esses desejos devem ser tratados com muito cuidado: "Eu aceitaria seu desenvolvimento se fosse mais f√°cil aqui e aqui". </p><br><p>  Infelizmente, a habilidade de "filtragem" dita por "simpatizantes" na Internet h√° cerca de cinco anos era muito menor do que agora.  Portanto, um experimento espec√≠fico como agentes ad-hoc no SObjectizer. </p><br><h2 id="sobjectizer-56-bolshe-ne-podderzhivaet-sinhronnogo-vzaimodeystviya-agentov">  SObjectizer-5.6 n√£o oferece mais suporte √† intera√ß√£o sincronizada de agentes </h2><br><p>  O t√≥pico da intera√ß√£o sincronizada entre agentes √© muito antigo e dolorido. </p><br><p>  Tudo come√ßou nos dias do SObjectizer-4.  E no SObjectizer-5 continuou.  At√© agora, finalmente, o chamado  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">solicita√ß√µes de servi√ßo</a> .  Que inicialmente, reconhecidamente, era assustador como a morte.  Mas ent√£o eu consegui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">dar a eles uma apar√™ncia mais ou menos decente</a> . </p><br><p>  Mas esse acabou sendo o caso quando a primeira panqueca saiu irregular :( </p><br><p>  No SObjectizer, eu tive que implementar a entrega e o processamento de mensagens regulares de uma maneira, e a entrega e o processamento de solicita√ß√µes s√≠ncronas de outra.  √â especialmente triste que esses recursos tenham que ser levados em considera√ß√£o, inclusive ao implementar suas pr√≥prias mbox-s. </p><br><p>  E depois que a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">funcionalidade das mensagens de envelope</a> foi adicionada ao SObjectizer, tornou-se necess√°rio examinar com mais frequ√™ncia e profundidade as diferen√ßas entre mensagens regulares e solicita√ß√µes s√≠ncronas. </p><br><p>  Em geral, com solicita√ß√µes s√≠ncronas durante a manuten√ß√£o / desenvolvimento do SObjectizer, havia muita dor de cabe√ßa.  Tanto que, a princ√≠pio, havia um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">desejo concreto de se livrar dessas solicita√ß√µes muito s√≠ncronas</a> .  E ent√£o esse desejo foi realizado. </p><br><p>  E assim, no SObjectizer-5.6, os agentes podem interagir novamente apenas atrav√©s de mensagens ass√≠ncronas. </p><br><p>  E, como √†s vezes ainda √© necess√°rio algo como intera√ß√£o s√≠ncrona, o suporte para esse tipo de intera√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">foi enviado ao projeto so5extra que o acompanha</a> : </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    "-". using my_request_reply = so_5::extra::sync::request_reply_t&lt;my_request, my_reply&gt;; ... //  ,    . class request_handler final : public so_5::agent_t { ... //  .      . void on_request(typename my_request_reply::request_mhood_t cmd) { ... //  . //      cmd-&gt;request(). //   . cmd-&gt;make_reply(...); //      my_reply. } ... void so_define_agent() override { //       . so_subscribe_self().event(&amp;request_handler::on_request); } }; ... //     . so_5::mbox_t handler_mbox = ...; //        15s. //    ,    . my_reply reply = my_request_reply::ask_value(handler_mbox, 15s, ...); //       my_request.</span></span></code> </pre> <br><p>  I.e.  Agora, trabalhar com solicita√ß√µes s√≠ncronas √© fundamentalmente diferente, pois o manipulador de solicita√ß√µes n√£o retorna um valor do m√©todo manipulador, como era antes.  Em vez disso, o m√©todo <code>make_reply</code> √© <code>make_reply</code> . </p><br><p>  A nova implementa√ß√£o √© boa, pois a solicita√ß√£o e a resposta s√£o enviadas dentro do SObjectizer como mensagens ass√≠ncronas regulares.  De fato, <code>make_reply</code> √© uma implementa√ß√£o de <code>send</code> um pouco mais espec√≠fica. </p><br><p>  E, o mais importante, a nova implementa√ß√£o nos permitiu obter funcionalidades anteriormente inating√≠veis: </p><br><ul><li>  solicita√ß√µes s√≠ncronas (ou seja <code>request_reply_t&lt;Request, Reply&gt;</code> objetos <code>request_reply_t&lt;Request, Reply&gt;</code> ) agora podem ser salvas e / ou encaminhadas para outros manipuladores.  O que torna poss√≠vel implementar v√°rios esquemas de balanceamento de carga; </li><li>  Voc√™ pode fazer com que a resposta √† solicita√ß√£o seja enviada em uma mbox comum do agente que est√° iniciando a solicita√ß√£o.  E o agente iniciador processar√° a resposta da maneira usual, como qualquer outra mensagem; </li><li>  Voc√™ pode enviar v√°rias solicita√ß√µes para diferentes destinat√°rios ao mesmo tempo e analisar as respostas na ordem em que foram recebidas: </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> first_dialog = so_5::extra::sync::<span class="hljs-keyword"><span class="hljs-keyword">request_reply_t</span></span>&lt;first_request, first_reply&gt;; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> second_dialog = so_5::extra::sync::<span class="hljs-keyword"><span class="hljs-keyword">request_reply_t</span></span>&lt;second_request, second_reply&gt;; <span class="hljs-comment"><span class="hljs-comment">//         . auto reply_ch = create_mchain(env); //     . first_dialog::initiate_with_custom_reply_to( one_service, reply_ch, so_5::extra::sync::do_not_close_reply_chain, ...); second_dialog::initiate_with_custom_reply_to( another_service, reply_ch, so_5::extra::sync::do_not_close_reply_chain, ...); //    . receive(from(reply_ch).handle_n(2).empty_timeout(15s), [](typename first_dialog::reply_mhood_t cmd) {...}, [](typename second_dialog::reply_mhood_t cmd) {...});</span></span></code> </pre> <br><p>  Portanto, podemos dizer que, com a intera√ß√£o s√≠ncrona no SObjectizer, aconteceu o seguinte: </p><br><ul><li>  por um longo tempo ele se foi por raz√µes ideol√≥gicas; </li><li>  ent√£o foi adicionado e descobriu-se que √†s vezes essa intera√ß√£o √© √∫til; </li><li>  mas a experi√™ncia mostrou que a primeira implementa√ß√£o n√£o √© muito bem-sucedida; </li><li>  a antiga implementa√ß√£o foi completamente descartada e uma nova implementa√ß√£o foi proposta em troca. </li></ul><br><p>  Eles trabalharam com seus pr√≥prios erros, em geral. </p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>  Este artigo, brevemente, falou sobre v√°rias altera√ß√µes no SObjectizer-5.6.0 e os motivos por tr√°s dessas altera√ß√µes. </p><br><p>  Uma lista mais completa de altera√ß√µes pode ser encontrada <a href="" rel="nofollow">aqui</a> . </p><br><p>  Concluindo, gostaria de oferecer √†queles que ainda n√£o experimentaram o SObjectizer, aceitem e experimentem.  E compartilhe conosco seus sentimentos: o que voc√™ gostou, o que voc√™ n√£o gostou, o que estava faltando. </p><br><p>  Ouvimos atentamente todos os coment√°rios / sugest√µes construtivas.  Al√©m disso, nos √∫ltimos anos, apenas o que algu√©m precisa est√° inclu√≠do no SObjectizer.  Portanto, se voc√™ n√£o nos disser o que gostaria de ter no SObjectizer, isso n√£o aparecer√°.  E se voc√™ me disser, quem sabe ...;) </p><br><p>  O projeto agora vive e se desenvolve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">aqui</a> .  E para aqueles que est√£o acostumados a usar apenas o GitHub, h√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">espelho do GitHub</a> .  Esse espelho √© completamente novo, para que voc√™ possa ignorar a falta de estrelas. </p><br><p>  PS.  Voc√™ pode acompanhar as not√≠cias relacionadas ao SObjectizer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">neste grupo do Google</a> .  L√°, voc√™ pode levantar quest√µes relacionadas ao SObjectizer. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453256/">https://habr.com/ru/post/pt453256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453242/index.html">Playground para eventos de ver√£o</a></li>
<li><a href="../pt453246/index.html">ERP - Sistema de Degrada√ß√£o Cont√≠nua</a></li>
<li><a href="../pt453248/index.html">Miss√£o Lunar Artemis - lan√ßada a produ√ß√£o do elemento principal da esta√ß√£o orbital lunar Lunar Gateway</a></li>
<li><a href="../pt453252/index.html">Como fizemos o programa do clube Sportmaster</a></li>
<li><a href="../pt453254/index.html">Sobre o c√≥digo do GOST, Grasshopper, seu SBox e sementes perdidas</a></li>
<li><a href="../pt453258/index.html">Fazendo um pedal de reverbera√ß√£o usando chips PT2399 (parte 1)</a></li>
<li><a href="../pt453260/index.html">Recursos de configura√ß√£o de DPI</a></li>
<li><a href="../pt453262/index.html">Onde est√£o suas constantes armazenadas no microcontrolador CortexM (usando o compilador C ++ IAR como exemplo)</a></li>
<li><a href="../pt453264/index.html">Virtuali-tee: uma "camiseta m√©dica" que n√£o cobre, mas exp√µe</a></li>
<li><a href="../pt453272/index.html">Patrocinadores do GitHub: uma nova maneira de contribuir com o c√≥digo aberto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>