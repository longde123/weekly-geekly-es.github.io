<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏼‍🤝‍🧑🏼 🔳 🐍 在InfoWatch Traffic Monitor上配置负载平衡 🛀🏻 📟 👟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="如果一台服务器的功能不足以处理所有请求，并且软件制造商未提供负载平衡，该怎么办？ 有很多选择-从购买负载平衡器到限制请求数量。 哪一种是正确的，您需要在考虑现有条件的情况下查看情况。 在本文中，我们将告诉您如果预算有限并且有可用的免费服务器该怎么办。 


 作为必须减少其中一台服务器上的负载的系统...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>在InfoWatch Traffic Monitor上配置负载平衡</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ntc-vulkan/blog/484964/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/4w/ol/wf/4wolwfpah48j6egm8hqmcn4we5o.png"></div><br><p> 如果一台服务器的功能不足以处理所有请求，并且软件制造商未提供负载平衡，该怎么办？ 有很多选择-从购买负载平衡器到限制请求数量。 哪一种是正确的，您需要在考虑现有条件的情况下查看情况。 在本文中，我们将告诉您如果预算有限并且有可用的免费服务器该怎么办。 </p><a name="habracut"></a><br><p> 作为必须减少其中一台服务器上的负载的系统，我们选择了InfoWatch DLP（信息泄漏预防系统）。 该实现的一个功能是将平衡器功能放置在其中一台“战斗”服务器上。 </p><br><p> 我们遇到的问题之一是无法使用源NAT（SNAT）。 对于需要什么以及如何解决问题，我们将进一步描述。 </p><br><p> 因此，现有系统的初始逻辑图如下： </p><br><img src="https://habrastorage.org/webt/jn/p_/w1/jnp_w1x4tilvkrdpsk98z0ikwxo.jpeg"><br><p> 来自用户计算机的ICAP流量，SMTP，事件是在流量监控器（TM）服务器上处理的。 同时，数据库服务器在处理TM上的事件后可以轻松应对负载，但是TM本身的负载很大。 在设备监视器（DM）服务器上出现消息队列，以及在TM上加载处理器和内存，就可以证明这一点。 </p><br><p> 乍一看，如果我们向该方案添加另一个TM服务器，则可以将ICAP或DM切换到该方案，但是由于降低了容错能力，因此我们决定不使用此方法。 </p><br><h1> 解决方案说明 </h1><br><p> 在寻找正确解决方案的过程中，我们与<a href="http://www.linuxvirtualserver.org/">LVS</a>一起选择了<a href="http://www.keepalived.org/">keepalived</a>免费软件。 由于keepalived解决了创建故障转移群集的问题，因此它也可以管理LVS平衡器。 </p><br><p> 我们想要达到的目标（减少TM上的负载并保持当前的容错水平）应根据以下方案工作： </p><br><img src="https://habrastorage.org/webt/kr/yh/lz/kryhlzufx39kmzvq9ndepj_gpxi.jpeg"><br><p> 检查性能时，结果发现服务器上安装的自定义RedHat程序集不支持SNAT。 在我们的例子中，我们计划使用SNAT，以便从相同的IP地址发送传入的数据包和对它们的答复，否则将得到以下图片： </p><br><img src="https://habrastorage.org/webt/hl/zt/oa/hlztoaeuk5itpyjn_iv5kncmumw.jpeg"><br><p> 这是不可接受的。 例如，将数据包发送到虚拟IP（VIP）地址的代理服务器将等待VIP的响应，但在这种情况下，它将来自IP2，用于发送到备份的会话。 找到了解决方案：有必要在备份上创建另一个路由表，并将两个TM服务器连接到单独的网络，如下所示： </p><br><img src="https://habrastorage.org/webt/24/bf/vp/24bfvpitjgkba5nxbqaftdeglhu.jpeg"><br><h1> 设定值 </h1><br><p> 我们实现了两台服务器的方案，其中两台服务器具有ICAP，SMTP，TCP 9100服务和一个负载平衡器。 </p><br><p>我们有两个RHEL6服务器，从中删除了标准存储库和部分软件包。 </p><br><p> 我们需要平衡的服务： </p><br><p>  •ICAP-TCP 1344； </p><br><p>  •SMTP-TCP 25。 </p><br><p>  DM流量服务-TCP 9100。 </p><br><p> 首先，我们需要规划网络。 </p><br><p> 虚拟IP地址（VIP）： </p><br><p>  •IP：10.20.20.105。 </p><br><p> 服务器TM6_1： </p><br><p>  •外部IP：10.20.20.101； </p><br><p>  •内部IP：192.168.1.101。 </p><br><p> 服务器TM6_2： </p><br><p>  •外部IP：10.20.20.102； </p><br><p>  •内部IP：192.168.1.102。 </p><br><p> 然后在两个TM服务器上启用IP转发。  <a href="https://rhel7tutorial.wordpress.com/how-to-enable-ip-forwarding/">这里</a>介绍<a href="https://rhel7tutorial.wordpress.com/how-to-enable-ip-forwarding/">了</a>如何在RedHat上进行操作。 </p><br><p> 我们决定哪些服务器将拥有主服务器，以及哪些服务器-备用服务器。 假设master为TM6_1，备份为TM6_2。 </p><br><p> 在备份时，创建一个新的平衡器路由表和路由规则： </p><br><pre><code class="plaintext hljs">[root@tm6_2 ~]echo 101 balancer &gt;&gt; /etc/iproute2/rt_tables [root@tm6_2 ~]ip rule add from 192.168.1.102 table balancer [root@tm6_2 ~]ip route add default via 192.168.1.101 table balancer</code> </pre> <br><p> 以上命令一直有效，直到系统重新引导。 要在重新引导后保留路由，可以在<em>/etc/rc.d/rc.local中</em>输入它们，但最好通过设置文件<em>/ etc / sysconfig / network-scripts / route-eth1</em>输入它们（注意：这使用了不同的语法）。 </p><br><p> 在两个TM服务器上安装keepalived。 作为分发源，我们使用了rpmfind.net： </p><br><pre> <code class="plaintext hljs">[root@tm6_1 ~]#yum install https://rpmfind.net/linux/centos/6.10/os/x86_64/Packages/keepalived-1.2.13-5.el6_6.x86_64.rpm</code> </pre> <br><p> 在keepalived设置中，我们分配一个主服务器，另一个分配备用服务器。 然后，我们设置VIP和服务以实现负载平衡。 设置文件通常位于以下位置： <em>/etc/keepalived/keepalived.conf</em> 。 </p><br><div class="spoiler">  <b class="spoiler_title">TM1服务器的设置</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">vrrp_sync_group VG1 { group { VI_1 } } vrrp_instance VI_1 { state MASTER interface eth0 lvs_sync_daemon_inteface eth0 virtual_router_id 51 priority 151 advert_int 1 authentication { auth_type PASS auth_pass example } virtual_ipaddress { 10.20.20.105 } } virtual_server 10.20.20.105 1344 { delay_loop 6 lb_algo wrr lb_kind NAT protocol TCP real_server 192.168.1.101 1344 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 1344 nb_get_retry 3 delay_before_retry 3 } } real_server 192.168.1.102 1344 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 1344 nb_get_retry 3 delay_before_retry 3 } } } virtual_server 10.20.20.105 25 { delay_loop 6 lb_algo wrr lb_kind NAT protocol TCP real_server 192.168.1.101 25 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 25 nb_get_retry 3 delay_before_retry 3 } } real_server 192.168.1.102 25 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 25 nb_get_retry 3 delay_before_retry 3 } } } virtual_server 10.20.20.105 9100 { delay_loop 6 lb_algo wrr lb_kind NAT protocol TCP real_server 192.168.1.101 9100 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 9100 nb_get_retry 3 delay_before_retry 3 } } real_server 192.168.1.102 9100 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 9100 nb_get_retry 3 delay_before_retry 3 } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">TM2服务器的设置</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">vrrp_sync_group VG1 { group { VI_1 } } vrrp_instance VI_1 { state BACKUP interface eth0 lvs_sync_daemon_inteface eth0 virtual_router_id 51 priority 100 advert_int 1 authentication { auth_type PASS auth_pass example } virtual_ipaddress { 10.20.20.105 } }</code> </pre> </div></div><br><p> 在主LVS上安装，这将平衡流量。 对于第二台服务器，没有必要安装平衡器，因为在配置中我们只有两台服务器。 </p><br><pre> <code class="plaintext hljs">[root@tm6_1 ~]##yum install https://rpmfind.net/linux/centos/6.10/os/x86_64/Packages/ipvsadm-1.26-4.el6.x86_64.rpm</code> </pre> <br><p> 平衡器将由我们已经配置的keepalived管理。 </p><br><p> 要完成此操作，请在两台服务器上将keepalived添加为自动运行： </p><br><pre> <code class="plaintext hljs">[root@tm6_1 ~]#chkconfig keepalived on</code> </pre> <br><h1> 结论 </h1><br><p>  <em>检查结果</em> </p><br><p> 在两台服务器上运行keepalived： </p><br><pre> <code class="plaintext hljs">service keepalived start</code> </pre> <br><p>  <em>验证VRRP虚拟地址可用性</em> </p><br><p> 确保VIP在主机上： </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/ki/w_/gikiw_8kvn4oasjpykqljrpnjha.jpeg"></div><br><p> 备份中没有VIP： </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/p7/8x/6o/p78x6o9prduqmsyknrjazt9lcoe.jpeg"></div><br><p> 使用ping命令，检查VIP的可用性： </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1n/ev/b2/1nevb23tpstycsrbokowdm34-lk.jpeg"></div><br><p> 现在，您可以关闭master并再次运行<code>ping</code>命令。 </p><br><p> 结果应该保持不变，在备份时，我们将看到VIP： </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ny/ga/mg/nygamghufaycljxfyxamf6ixspk.jpeg"></div><br><p>  <em>检查服务平衡</em> </p><br><p> 以SMTP为例。 同时运行到10.20.20.105的两个连接： </p><br><pre> <code class="plaintext hljs">telnet 10.20.20.105 25</code> </pre> <br><p> 在主服务器上，我们应该看到两个连接都处于活动状态并连接到不同的服务器： </p><br><pre> <code class="plaintext hljs">[root@tm6_1 ~]#watch ipvsadm –Ln</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/54/uw/og/54uwogp1mozyhstfkkxfx1pc5ck.jpeg"></div><br><p> 因此，我们在其中一台TM服务器上安装了平衡器，从而实现了TM服务的故障安全配置。 对于我们的系统，这将TM的负载减少了一半，这使我们能够通过系统解决缺少水平缩放的问题。 </p><br><p> 在大多数情况下，此解决方案可以快速实施且无需支付额外费用，但有时在设置时（例如在平衡UDP流量时）存在许多限制和困难。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN484964/">https://habr.com/ru/post/zh-CN484964/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN484944/index.html">我的ACID是什么或不适合我们</a></li>
<li><a href="../zh-CN484946/index.html">GPR建模</a></li>
<li><a href="../zh-CN484948/index.html">NEC发布了海底电缆，记录了20对光纤记录</a></li>
<li><a href="../zh-CN484952/index.html">用Observable和React Hooks替换Redux</a></li>
<li><a href="../zh-CN484954/index.html">Kubernetes的视觉故障排除指南</a></li>
<li><a href="../zh-CN484966/index.html">使用Spring进行测试的现成模板</a></li>
<li><a href="../zh-CN484968/index.html">WPF数据网格。 为模板而战</a></li>
<li><a href="../zh-CN484972/index.html">Wine 5.0发布</a></li>
<li><a href="../zh-CN484974/index.html">图灵机仿真王砖</a></li>
<li><a href="../zh-CN484978/index.html">PubSub几乎是免费的：PostgreSQL中的NOTIFY功能</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>