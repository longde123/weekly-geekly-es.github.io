<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî™ üßëüèª üìÖ Conectamos un medidor de agua a una casa inteligente ü§¥üèø üåº üéöÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Una vez que los sistemas de automatizaci√≥n del hogar, o como a menudo se les llama "hogar inteligente", eran terriblemente caros y solo las personas r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conectamos un medidor de agua a una casa inteligente</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/411259/">  Una vez que los sistemas de automatizaci√≥n del hogar, o como a menudo se les llama "hogar inteligente", eran terriblemente caros y solo las personas ricas pod√≠an pagarlos.  Hoy en el mercado puede encontrar kits bastante econ√≥micos con sensores, botones / interruptores y actuadores para controlar la iluminaci√≥n, los enchufes, la ventilaci√≥n, el suministro de agua y otros consumidores.  E incluso el bricolaje <s>shr m√°s krivoruky</s> puede unirse a los hermosos y coleccionar dispositivos para un hogar inteligente a bajo costo. <br><br><img src="https://habrastorage.org/webt/-a/k2/x6/-ak2x6li6an5gyqbrg2ett_-_au.jpeg"><br><br>  Como regla general, los dispositivos propuestos son sensores o actuadores.  Facilitan la implementaci√≥n de escenarios como "encender la luz cuando se activa el sensor de movimiento" o "el interruptor en la salida apaga la luz en todo el apartamento".  Pero la telemetr√≠a de alguna manera no funcion√≥.  En el mejor de los casos, este es un gr√°fico de temperatura y humedad, o potencia instant√°nea en una salida particular. <br><br>  Recientemente instal√© un medidor de agua con salida de pulso.  Se activa un interruptor de l√°minas a trav√©s de cada litro a trav√©s del medidor y cierra el contacto.  Lo √∫nico que queda es aferrarse a los cables e intentar obtener ganancias de √©l.  Por ejemplo, analice el consumo de agua por hora y d√≠a de la semana.  Bueno, si hay varios tubos ascendentes para el agua en el apartamento, entonces es m√°s conveniente ver todos los indicadores actuales en una pantalla que escalar nichos dif√≠ciles de alcanzar con una linterna. <br><br>  Bajo el corte, mi versi√≥n del dispositivo se basa en el ESP8266, que cuenta los pulsos de los medidores de agua y env√≠a lecturas al servidor dom√©stico inteligente a trav√©s de MQTT.  Programaremos en micropython usando la biblioteca uasyncio.  Al crear el firmware, me encontr√© con varias dificultades interesantes, que tambi√©n discutir√© en este art√≠culo.  Vamos! <br><a name="habracut"></a><br><h3>  Esquema </h3><br><img src="https://habrastorage.org/webt/i-/w2/o7/i-w2o7b8mfsommteri_mss88oa8.png"><br><br>  El coraz√≥n de todo el circuito es el m√≥dulo en el microcontrolador ESP8266.  ESP-12 fue originalmente planeado, pero el m√≠o result√≥ ser defectuoso.  Ten√≠a que estar contento con el m√≥dulo ESP-07, que estaba disponible.  Afortunadamente, son iguales tanto en conclusiones como en funcionalidad, la diferencia est√° solo en la antena: el ESP-12 lo tiene incorporado y el ESP-07 tiene uno externo.  Sin embargo, incluso sin una antena WiFi, la se√±al en mi ba√±o se capta normalmente. <br><br>  El enlace del m√≥dulo es est√°ndar: <br><br><ul><li>  bot√≥n de reinicio con un tirante y un condensador (aunque ambos ya est√°n dentro del m√≥dulo) </li><li>  Se√±al de habilitaci√≥n (CH_PD) activada </li><li>  GPIO15 tirado al suelo.  Esto solo es necesario al principio, pero todav√≠a no tengo nada a lo que aferrarme m√°s. </li></ul><br>  Para poner el m√≥dulo en modo firmware, debe cerrar el GPIO2 a tierra, y para que sea m√°s conveniente, he proporcionado el bot√≥n de inicio.  En condiciones normales, este pin se tira al poder. <br><br>  El estado de la l√≠nea GPIO2 se verifica solo al comienzo del trabajo, cuando se aplica energ√≠a o inmediatamente despu√©s de un reinicio.  Por lo tanto, el m√≥dulo se carga como de costumbre o entra en modo firmware.  Despu√©s de cargar, esta salida se puede usar como GPIO normal.  Bueno, dado que ya hay un bot√≥n all√≠, puedes ponerle alguna funci√≥n √∫til. <br><br>  Para la programaci√≥n y la depuraci√≥n, usar√© el UART, que trajo al peine.  Cuando sea necesario, solo conecto un adaptador USB-UART.  Solo necesita recordar que el m√≥dulo est√° alimentado por 3.3V.  Si olvida cambiar el adaptador a este voltaje y aplica 5V, lo m√°s probable es que el m√≥dulo se queme. <br><br>  No tengo problemas con la electricidad en el ba√±o: el tomacorriente se encuentra a aproximadamente un metro de los medidores, por lo que lo alimentar√© desde 220V.  Como fuente de energ√≠a, trabajar√© en un peque√±o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bloque de HLK-PM03</a> de Tenstar Robot.  Personalmente, estoy familiarizado con la electr√≥nica anal√≥gica y de potencia, pero aqu√≠ hay una fuente de alimentaci√≥n terminada en una caja peque√±a. <br><br>  Para se√±alar los modos de funcionamiento, proporcion√© un LED conectado a GPIO2.  Sin embargo, no comenc√© a soldarlo, porque  el m√≥dulo ESP-07 ya tiene un LED, adem√°s, conectado al mismo GPIO2.  Pero d√©jelo estar en el tablero; de repente, quiero llevar este LED a la carcasa. <br><br>  Pasamos a lo m√°s interesante.  Los medidores de agua no tienen l√≥gica; no se les puede pedir lecturas actuales.  Lo √∫nico que est√° disponible para nosotros son los pulsos: cerrar los contactos del interruptor de l√°minas cada litro.  Las conclusiones de los interruptores de l√°minas se configuran en GPIO12 / GPIO13.  Encender√© la resistencia pull-up mediante programaci√≥n dentro del m√≥dulo. <br><br>  Inicialmente, olvid√© proporcionar resistencias R8 y R9, y en mi versi√≥n de la placa no lo son.  Pero como ya estoy poniendo el esquema en exhibici√≥n p√∫blica, vale la pena corregir este descuido.  Se necesitan resistencias para no quemar el puerto si el firmware tiene errores y pone la unidad en el pin, y el interruptor de l√°minas corta esta l√≠nea a tierra (un m√°ximo de 3.3V / 1000Ohm = 3.3mA fluir√° con la resistencia). <br><br>  Es hora de pensar qu√© hacer si se corta la electricidad.  La primera opci√≥n es solicitar al servidor los contadores iniciales al inicio.  Pero esto requerir√≠a una complicaci√≥n significativa del protocolo de intercambio.  Adem√°s, la operatividad del dispositivo en este caso depende del estado del servidor.  Si, despu√©s de apagar la luz, el servidor no se inicia (o comienza m√°s tarde), el medidor de agua no podr√° solicitar los valores iniciales y funcionar√° incorrectamente. <br><br>  Por lo tanto, decid√≠ implementar el almacenamiento de valores de contador en un chip de memoria conectado a trav√©s de I2C.  No tengo requisitos especiales para el tama√±o de la memoria flash: necesito guardar solo 2 n√∫meros (la cantidad de litros por medidor de agua fr√≠a y caliente).  Incluso el m√≥dulo m√°s peque√±o servir√°.  Pero en el n√∫mero de ciclos de grabaci√≥n, debe prestar atenci√≥n.  Para la mayor√≠a de los m√≥dulos, esto es 100 mil ciclos, para algunos hasta un mill√≥n. <br><br>  Parecer√≠a que un mill√≥n es mucho.  Pero durante 4 a√±os viviendo en mi departamento, consum√≠ un poco m√°s de 500 metros c√∫bicos de agua, ¬°eso es 500 mil litros!  Y 500 mil entradas en el flash.  Y esto es solo agua fr√≠a.  Por supuesto, puede soldar el chip cada dos a√±os, pero result√≥ que hay chips FRAM.  Desde el punto de vista de la programaci√≥n, esta es la misma EEPROM I2C, pero con una gran cantidad de ciclos de reescritura (cientos de millones).  Eso es solo hasta que todo llegue a la tienda con tales chips de alguna manera, por lo que por ahora el 24LC512 habitual se mantendr√°. <br><br><h3>  Placa de circuito </h3><br>  Inicialmente, planeaba hacer una tarifa en casa.  Por lo tanto, el tablero fue dise√±ado como unilateral.  Pero despu√©s de una larga hora con una plancha de l√°ser y una m√°scara de soldadura (sin que de alguna manera se convirtiera en algo falso), todav√≠a decid√≠ pedir tablas a los chinos. <br><br><img src="https://habrastorage.org/webt/en/si/rz/ensirzhmczp3bs9n7a6a8plmzl4.png"><br><br>  Casi antes de ordenar la placa, me di cuenta de que, adem√°s del chip de memoria flash en el bus I2C, puede recoger algo m√°s √∫til, como una pantalla.  Todav√≠a es una pregunta qu√© dar exactamente a conocer, pero debe reproducirse en el tablero.  Bueno, ya que iba a pedir las tablas en la f√°brica, no ten√≠a sentido limitarme a una tabla de un solo lado, por lo que las l√≠neas en I2C son las √∫nicas en la parte posterior de la placa. <br><br>  Una jamba grande tambi√©n se asoci√≥ con el cableado unilateral.  Porque  la placa se dibuj√≥ en un lado, las pistas y los componentes SMD se planearon para colocar en un lado, y los componentes de salida, los conectores y la fuente de alimentaci√≥n en el otro.  Cuando recib√≠ las placas en un mes, me olvid√© del plan inicial y descomprim√≠ todos los componentes en la parte frontal.  Y solo cuando se trataba de soldar la fuente de alimentaci√≥n, result√≥ que los m√°s y menos estaban divorciados por el contrario.  Tuve que explotar granjas colectivas con puentes.  En la imagen de arriba, ya cambi√© el cableado, pero el suelo se lanza de una parte de la placa a la otra a trav√©s de las salidas del bot√≥n Boot (aunque ser√≠a posible dibujar una pista en la segunda capa). <br><br>  Result√≥ as√≠ <br><br><img src="https://habrastorage.org/webt/au/-d/cs/au-dcsvpehh9p5g9iqyob5hjslu.jpeg"><br><br><h3>  Vivienda </h3><br>  El siguiente paso es la vivienda.  Con una impresora 3D, esto no es un problema.  No me molest√© mucho: simplemente dibuj√© una caja del tama√±o correcto e hice recortes en los lugares correctos.  La cubierta est√° unida al cuerpo con peque√±os tornillos. <br><br><img src="https://habrastorage.org/webt/qq/lu/zp/qqluzptanq4d24dsv4jdlb9uif8.png"><br><br>  Ya mencion√© que el bot√≥n de inicio se puede usar como un bot√≥n de uso general; aqu√≠ lo traemos al panel frontal.  Para hacer esto, dibuj√© un "pozo" especial donde vive el bot√≥n. <br><br><img src="https://habrastorage.org/webt/dv/xg/gn/dvxggnexv-fiqy0jqtptpdk1dvy.png"><br><br>  Dentro de la caja tambi√©n hay tocones en los que la placa se instala y se fija con un solo tornillo M3 (no hab√≠a m√°s espacio en la placa) <br><br>  La pantalla se seleccion√≥ cuando imprim√≠ la primera versi√≥n de la carcasa.  El est√°ndar de dos l√≠neas no encajaba en este caso, pero se encontr√≥ una pantalla OLED SSD1306 de 128x32 en el card√°n.  Es peque√±o, pero no tengo que mirarlo todos los d√≠as: rodar√°. <br><br>  Estimando en ambos sentidos y c√≥mo se colocar√°n los cables de √©l, decid√≠ pegar la pantalla en el medio del estuche.  Ergonom√≠a, por supuesto, debajo de la placa base: un bot√≥n en la parte superior, una pantalla en la parte inferior.  Pero ya dije que la idea de arruinar la pantalla lleg√≥ demasiado tarde y era demasiado flojo reorganizar el tablero para mover el bot√≥n. <br><br>  El dispositivo est√° completo.  El m√≥dulo de visualizaci√≥n est√° pegado a las boquillas de fusi√≥n en caliente. <br><br><img src="https://habrastorage.org/webt/sn/qr/xf/snqrxfyyihzqwiwwwf-1yly545m.jpeg"><br><br><img src="https://habrastorage.org/webt/ow/bh/2o/owbh2oguwv4tiez2basnv11hgvw.jpeg"><br><br>  El resultado final se puede ver en KDPV <br><br><h3>  Firmware </h3><br>  Pasemos a la parte del software.  Para estas manualidades peque√±as, me gusta mucho usar el lenguaje Python ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">micropython</a> ): el c√≥digo es muy compacto y comprensible.  Afortunadamente, no hay necesidad de bajar al nivel de registros para exprimir microsegundos: todo se puede hacer desde Python. <br><br>  Parece ser todo simple, pero no muy: varias funciones independientes se describen en el dispositivo: <br><br><ul><li>  El usuario presiona un bot√≥n y mira la pantalla </li><li>  Los litros marcan y actualizan los valores en la memoria flash </li><li>  El m√≥dulo monitorea la se√±al WiFi y se vuelve a conectar si es necesario. </li><li>  Bueno, sin una luz parpadeante, no puedes hacerlo </li></ul><br>  Es imposible suponer que una funci√≥n no funcion√≥ si la otra es est√∫pida por alguna raz√≥n.  Ya com√≠ cactus en otros proyectos y ahora veo fallas en el estilo de "perd√≠ otro litro, porque en ese momento la pantalla se actualiz√≥" o "el usuario no puede hacer nada mientras el m√≥dulo se conecta a WiFi".  Por supuesto, algunas cosas se pueden hacer a trav√©s de interrupciones, pero puede encontrar una limitaci√≥n en la duraci√≥n, anidamiento de llamadas o cambio no at√≥mico de variables.  Bueno, el c√≥digo que hace todo e inmediatamente se convierte en un desastre. <br><br>  En el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proyecto,</a> utilic√© la multitarea preventiva cl√°sica y FreeRTOS con m√°s seriedad, pero en este caso el modelo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">corutinas y la biblioteca uasync</a> resultaron ser mucho m√°s adecuados.  Adem√°s, la implementaci√≥n de la corutina en Pitonovskiy es solo una bomba: para el programador, todo se hace de manera simple y conveniente.  Simplemente escribe tu propia l√≥gica, solo dime en qu√© lugares puedes cambiar entre hilos. <br><br>  Sugiero explorar las diferencias entre el desplazamiento y la multitarea competitiva opcionalmente.  Ahora, finalmente pasemos al c√≥digo. <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Counter class - implements a single water counter on specified pin ##################################### class Counter(): debounce_ms = const(25) def __init__(self, pin_num, value_storage): self._value_storage = value_storage self._value = self._value_storage.read() self._value_changed = False self._pin = Pin(pin_num, Pin.IN, Pin.PULL_UP) loop = asyncio.get_event_loop() loop.create_task(self._switchcheck()) # Thread runs forever</span></span></code> </pre> <br>  Cada contador es procesado por una instancia de la clase Counter.  En primer lugar, el valor inicial del contador se resta de la EEPROM (value_storage): as√≠ es como se implementa la recuperaci√≥n de una falla de energ√≠a. <br><br>  El pin se inicializa con un pull-up incorporado a la alimentaci√≥n: si el interruptor de l√°minas est√° cerrado, es cero en la l√≠nea, si la l√≠nea est√° abierta, la l√≠nea se conecta a la alimentaci√≥n y el controlador lee una. <br><br>  Adem√°s, aqu√≠ se inicia una tarea separada, que sondear√° el pin.  Cada contador ejecutar√° su propia tarea.  Aqu√≠ est√° su c√≥digo <br><br><pre> <code class="python hljs"> <span class="hljs-string"><span class="hljs-string">""" Poll pin and advance value when another litre passed """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_switchcheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> last_checked_pin_state = self._pin.value() <span class="hljs-comment"><span class="hljs-comment"># Get initial state # Poll for a pin change while True: state = self._pin.value() if state != last_checked_pin_state: # State has changed: act on it now. last_checked_pin_state = state if state == 0: self._another_litre_passed() # Ignore further state changes until switch has settled await asyncio.sleep_ms(Counter.debounce_ms)</span></span></code> </pre> <br>  Se necesita un retraso de 25 ms para filtrar el rebote de contacto y, al mismo tiempo, regula la frecuencia con la que la tarea se despierta (mientras esta tarea est√° inactiva, otras tareas funcionan).  Cada 25 ms, la funci√≥n se activa, verifica el pin y si los contactos del interruptor de l√°minas est√°n cerrados, entonces otro litro ha pasado por el contador y esto debe procesarse. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_another_litre_passed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._value += <span class="hljs-number"><span class="hljs-number">1</span></span> self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self._value_storage.write(self._value)</code> </pre> <br>  Procesar el siguiente litro es trivial: el contador simplemente aumenta.  Bueno, un nuevo valor ser√≠a bueno para escribir en una unidad flash. <br><br>  Para facilitar su uso, se proporcionan "accesorios". <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> self._value = value self._value_changed = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br>  Bueno, ahora aprovecharemos los placeres de Python y la biblioteca uasync y haremos que el objeto del contador sea esperable (¬øc√≥mo se puede traducir esto al ruso? ¬øEl que se puede esperar?) <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__await__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self._value_changed: <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.value() __iter__ = __await__</code> </pre> <br>  Esta es una funci√≥n tan conveniente que espera hasta que se actualice el valor del contador: la funci√≥n se activa de vez en cuando y comprueba el indicador _value_changed.  La broma de esta funci√≥n es que el c√≥digo de llamada puede quedarse dormido en una llamada a esta funci√≥n y dormir hasta que se reciba un nuevo valor. <br><br><div class="spoiler">  <b class="spoiler_title">¬øPero qu√© hay de las interrupciones?</b> <div class="spoiler_text">  S√≠, en este lugar puedes trollearme, diciendo que √©l mismo dijo acerca de las interrupciones, pero en realidad organiz√≥ una est√∫pida encuesta sobre el alfiler.  De hecho, las interrupciones son lo primero que prob√©.  En ESP8266, puede organizar una interrupci√≥n en el borde e incluso escribir un controlador para esta interrupci√≥n en Python.  En esta interrupci√≥n, puede actualizar el valor de una variable.  Probablemente, esto ser√≠a suficiente si el contador fuera un dispositivo esclavo, uno que espera hasta que se le solicite este valor. <br><br>  Desafortunadamente (¬øo afortunadamente?) Mi dispositivo est√° activo, debe enviar mensajes utilizando el protocolo MQTT y escribir datos en la EEPROM.  Y aqu√≠ ya entran las restricciones: no puede asignar memoria y usar una gran pila en las interrupciones, lo que significa que puede olvidarse de enviar mensajes a trav√©s de la red.  Hay bollos como micropython.schedule () que le permiten ejecutar alg√∫n tipo de funci√≥n "tan pronto como sea posible", pero la pregunta es "¬øcu√°l es el punto?".  De repente, estamos enviando alg√∫n tipo de mensaje en este momento, y aqu√≠ la interrupci√≥n se rompe y estropea los valores de las variables.  O, por ejemplo, un nuevo valor de contador lleg√≥ del servidor mientras todav√≠a no escribimos el anterior.  En general, necesita cercar la sincronizaci√≥n o salir de alguna manera diferente. <br><br>  Y de vez en cuando, RuntimeError se bloquea: la pila de programaci√≥n est√° llena y ¬øqui√©n sabe por qu√©? <br><br>  Con una encuesta expl√≠cita y uasync, en este caso es de alguna manera m√°s hermosa y m√°s confiable. <br></div></div><br>  Sal√≠ a trabajar con EEPROM en una clase peque√±a <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EEPROM</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> i2c_addr = const(<span class="hljs-number"><span class="hljs-number">80</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, i2c)</span></span></span><span class="hljs-function">:</span></span> self.i2c = i2c self.i2c_buf = bytearray(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Avoid creation/destruction of the buffer on each call def read(self, eeprom_addr): self.i2c.readfrom_mem_into(self.i2c_addr, eeprom_addr, self.i2c_buf, addrsize=16) return ustruct.unpack_from("&lt;I", self.i2c_buf)[0] def write(self, eeprom_addr, value): ustruct.pack_into("&lt;I", self.i2c_buf, 0, value) self.i2c.writeto_mem(self.i2c_addr, eeprom_addr, self.i2c_buf, addrsize=16)</span></span></code> </pre> <br>  En python, trabajar con bytes directamente es dif√≠cil, pero son los bytes que se escriben en la memoria.  Tuve que arreglar la conversi√≥n entre entero y bytes usando la biblioteca ustruct. <br><br>  Para no transferir el objeto I2C y la direcci√≥n de la celda de memoria cada vez, lo envolv√≠ todo en un cl√°sico peque√±o y conveniente <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EEPROMValue</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">()</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, i2c, eeprom_addr)</span></span></span><span class="hljs-function">:</span></span> self._eeprom = EEPROM(i2c) self._eeprom_addr = eeprom_addr <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._eeprom.read(self._eeprom_addr) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> self._eeprom.write(self._eeprom_addr, value)</code> </pre> <br>  El objeto I2C mismo se crea con dichos par√°metros. <br><br><pre> <code class="python hljs">i2c = I2C(freq=<span class="hljs-number"><span class="hljs-number">400000</span></span>, scl=Pin(<span class="hljs-number"><span class="hljs-number">5</span></span>), sda=Pin(<span class="hljs-number"><span class="hljs-number">4</span></span>))</code> </pre> <br>  Nos acercamos a lo m√°s interesante: la implementaci√≥n de la comunicaci√≥n con el servidor a trav√©s de MQTT.  Bueno, el protocolo en s√≠ no necesita ser implementado: se encontr√≥ una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">implementaci√≥n asincr√≥nica lista</a> para usar en Internet.  Aqu√≠ lo usaremos. <br><br>  Todo lo m√°s interesante se recopila en la clase CounterMQTTClient, que se basa en la biblioteca MQTTClient.  Empecemos desde la periferia <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Class handles both counters and sends their status to MQTT ##################################### class CounterMQTTClient(MQTTClient): blue_led = Pin(2, Pin.OUT, value = 1) button = Pin(0, Pin.IN) hot_counter = Counter(12, EEPROMValue(i2c, EEPROM_ADDR_HOT_VALUE)) cold_counter = Counter(13, EEPROMValue(i2c, EEPROM_ADDR_COLD_VALUE))</span></span></code> </pre> <br>  Aqu√≠, se crean y configuran pines de bombillas y botones, as√≠ como objetos de medidores de agua fr√≠a y caliente. <br><br>  Con la inicializaci√≥n, no todo es tan trivial <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.internet_outages = <span class="hljs-number"><span class="hljs-number">0</span></span> self.internet_outage_start = ticks_ms() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"config.txt"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> config_file: config[<span class="hljs-string"><span class="hljs-string">'ssid'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'wifi_pw'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'server'</span></span>] = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'client_id'</span></span>] = config_file.readline().rstrip() self._mqtt_cold_water_theme = config_file.readline().rstrip() self._mqtt_hot_water_theme = config_file.readline().rstrip() self._mqtt_debug_water_theme = config_file.readline().rstrip() config[<span class="hljs-string"><span class="hljs-string">'subs_cb'</span></span>] = self.mqtt_msg_handler config[<span class="hljs-string"><span class="hljs-string">'wifi_coro'</span></span>] = self.wifi_connection_handler config[<span class="hljs-string"><span class="hljs-string">'connect_coro'</span></span>] = self.mqtt_connection_handler config[<span class="hljs-string"><span class="hljs-string">'clean'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> config[<span class="hljs-string"><span class="hljs-string">'clean_init'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> super().__init__(config) loop = asyncio.get_event_loop() loop.create_task(self._heartbeat()) loop.create_task(self._counter_coro(self.cold_counter, self._mqtt_cold_water_theme)) loop.create_task(self._counter_coro(self.hot_counter, self._mqtt_hot_water_theme)) loop.create_task(self._display_coro())</code> </pre> <br>  Para establecer los par√°metros de la biblioteca mqtt_as, se utiliza un gran diccionario de diferentes configuraciones: config.  La mayor√≠a de las configuraciones predeterminadas nos convienen, pero muchas configuraciones deben establecerse expl√≠citamente.  Para no registrar la configuraci√≥n directamente en el c√≥digo, la almaceno en el archivo de texto config.txt.  Esto le permite cambiar el c√≥digo independientemente de la configuraci√≥n, as√≠ como remachar varios dispositivos id√©nticos con diferentes par√°metros. <br><br>  El √∫ltimo bloque de c√≥digo ejecuta varias corutinas para cumplir diversas funciones del sistema.  Aqu√≠ hay un ejemplo de rutina que sirve para mostradores <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_counter_coro</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, counter, topic)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Publish initial value value = counter.value() await self.publish(topic, str(value)) # Publish each new value while True: value = await counter await self.publish_msg(topic, str(value))</span></span></code> </pre> <br>  En un ciclo, Corutin espera un nuevo valor de contador y tan pronto como aparece, env√≠a un mensaje utilizando el protocolo MQTT.  El primer fragmento de c√≥digo env√≠a el valor inicial incluso si el agua no fluye a trav√©s del contador. <br><br>  La clase base MQTTClient se sirve sola, inicia una conexi√≥n WiFi y se vuelve a conectar cuando se pierde la conexi√≥n.  Cuando el estado de la conexi√≥n WiFi cambia, la biblioteca nos informa llamando a wifi_connection_handler <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi_connection_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, state)</span></span></span><span class="hljs-function">:</span></span> self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> state <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> state: self.dprint(<span class="hljs-string"><span class="hljs-string">'WiFi is up.'</span></span>) duration = ticks_diff(ticks_ms(), self.internet_outage_start) // <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.publish_debug_msg(<span class="hljs-string"><span class="hljs-string">'ReconnectedAfter'</span></span>, duration) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: self.internet_outages += <span class="hljs-number"><span class="hljs-number">1</span></span> self.internet_outage_start = ticks_ms() self.dprint(<span class="hljs-string"><span class="hljs-string">'WiFi is down.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  La funci√≥n es honestamente lamida de los ejemplos.  En este caso, considera el n√∫mero de desconexiones (internet_outage) y su duraci√≥n.  Cuando se restaura una conexi√≥n, el tiempo de inactividad se env√≠a al servidor. <br><br>  Por cierto, el √∫ltimo sue√±o solo se necesita para que la funci√≥n se vuelva as√≠ncrona: en la biblioteca se llama v√≠a de espera, y solo se pueden llamar las funciones en el cuerpo del que hay otra espera. <br><br>  Adem√°s de conectarse a WiFi, tambi√©n debe establecer una conexi√≥n con el agente MQTT (servidor).  La biblioteca tambi√©n hace esto, pero tenemos la oportunidad de hacer algo √∫til cuando se establece la conexi√≥n. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_connection_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, client)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.subscribe(self._mqtt_cold_water_theme) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> client.subscribe(self._mqtt_hot_water_theme)</code> </pre> <br>  Aqu√≠ nos suscribimos a varios mensajes: el servidor ahora tiene la capacidad de establecer los valores de contador actuales enviando el mensaje apropiado. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt_msg_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, topic, msg)</span></span></span><span class="hljs-function">:</span></span> topicstr = str(topic, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>) self.dprint(<span class="hljs-string"><span class="hljs-string">"Received MQTT message topic={}, msg={}"</span></span>.format(topicstr, msg)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> topicstr == self._mqtt_cold_water_theme: self.cold_counter.set_value(int(msg)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> topicstr == self._mqtt_hot_water_theme: self.hot_counter.set_value(int(msg))</code> </pre> <br>  Esta funci√≥n procesa los mensajes entrantes y, seg√∫n el tema (nombre del mensaje), los valores de uno de los contadores se actualizan <br><br>  Un par de funciones auxiliares <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># Publish a message if WiFi and broker is up, else discard async def publish_msg(self, topic, msg): self.dprint("Publishing message on topic {}: {}".format(topic, msg)) if not self.internet_outage: await self.publish(topic, msg) else: self.dprint("Message was not published - no internet connection")</span></span></code> </pre> <br>  Esta funci√≥n env√≠a mensajes si se establece una conexi√≥n.  Si no hay conexi√≥n, el mensaje se ignora. <br><br>  Y esta es solo una funci√≥n conveniente que genera y env√≠a mensajes de depuraci√≥n. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_debug_msg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, subtopic, msg)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.publish_msg(<span class="hljs-string"><span class="hljs-string">"{}/{}"</span></span>.format(self._mqtt_debug_water_theme, subtopic), str(msg))</code> </pre><br>  Mucho texto, pero no hemos parpadeado un LED.  Aqui <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># Blink flash LED if WiFi down async def _heartbeat(self): while True: if self.internet_outage: self.blue_led(not self.blue_led()) # Fast blinking if no connection await asyncio.sleep_ms(200) else: self.blue_led(0) # Rare blinking when connected await asyncio.sleep_ms(50) self.blue_led(1) await asyncio.sleep_ms(5000)</span></span></code> </pre> <br>  He proporcionado 2 modos de parpadeo.  Si se pierde la conexi√≥n (o se est√° estableciendo), el dispositivo parpadear√° r√°pidamente.  Si se establece la conexi√≥n, el dispositivo parpadea una vez cada 5 segundos.  Si es necesario, aqu√≠ puede implementar otros modos de parpadeo. <br><br>  Pero el LED es tan mimador.  Todav√≠a saludamos a la pantalla. <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_display_coro</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> display = SSD1306_I2C(<span class="hljs-number"><span class="hljs-number">128</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>, i2c) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: display.poweron() display.fill(<span class="hljs-number"><span class="hljs-number">0</span></span>) display.text(<span class="hljs-string"><span class="hljs-string">"COLD: {:.3f}"</span></span>.format(self.cold_counter.value() / <span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) display.text(<span class="hljs-string"><span class="hljs-string">"HOT: {:.3f}"</span></span>.format(self.hot_counter.value() / <span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) display.show() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) display.poweroff() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self.button(): <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>)</code> </pre> <br>  De esto es de lo que habl√©: cu√°n simple y conveniente con las corutinas.  Esta peque√±a funci√≥n describe TODA la interacci√≥n del usuario.  Corutin solo espera que presione un bot√≥n y enciende la pantalla durante 3 segundos.  La pantalla muestra las lecturas actuales del medidor. <br><br>  Todav√≠a hay un par de peque√±as cosas.  Aqu√≠ est√° la funci√≥n que ejecuta toda la granja (re).  El ciclo principal solo trata con el env√≠o de informaci√≥n de depuraci√≥n una vez por minuto.  En general, lo cito tal como est√°, especialmente el comentario, creo que no es necesario <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self._connect_to_WiFi() <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self._run_main_loop() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: self.dprint(<span class="hljs-string"><span class="hljs-string">'Global communication failure: '</span></span>, e) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_connect_to_WiFi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.dprint(<span class="hljs-string"><span class="hljs-string">'Connecting to WiFi and MQTT'</span></span>) sta_if = network.WLAN(network.STA_IF) sta_if.connect(config[<span class="hljs-string"><span class="hljs-string">'ssid'</span></span>], config[<span class="hljs-string"><span class="hljs-string">'wifi_pw'</span></span>]) conn = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> conn: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> self.connect() conn = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.dprint(<span class="hljs-string"><span class="hljs-string">'Connected!'</span></span>) self.internet_outage = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_run_main_loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Loop forever mins = 0 while True: gc.collect() # For RAM stats. mem_free = gc.mem_free() mem_alloc = gc.mem_alloc() try: await self.publish_debug_msg("Uptime", mins) await self.publish_debug_msg("Repubs", self.REPUB_COUNT) await self.publish_debug_msg("Outages", self.internet_outages) await self.publish_debug_msg("MemFree", mem_free) await self.publish_debug_msg("MemAlloc", mem_alloc) except Exception as e: self.dprint("Exception occurred: ", e) mins += 1 await asyncio.sleep(60)</span></span></code> </pre> <br>  Bueno, un par de configuraciones y constantes m√°s para completar la descripci√≥n <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">##################################### # Constants and configuration ##################################### config['keepalive'] = 60 config['clean'] = False config['will'] = ('/ESP/Wemos/Water/LastWill', 'Goodbye cruel world!', False, 0) MQTTClient.DEBUG = True EEPROM_ADDR_HOT_VALUE = const(0) EEPROM_ADDR_COLD_VALUE = const(4)</span></span></code> </pre> <br>  Comienza todo este camino <br><br><pre> <code class="python hljs">client = CounterMQTTClient() loop = asyncio.get_event_loop() loop.run_until_complete(client.main())</code> </pre> <br><br><h3>  Algo con mi memoria se ha convertido </h3><br>  Entonces, todo el c√≥digo est√° ah√≠.  Sub√≠ los archivos usando la utilidad ampy: permite que se carguen en la unidad flash interna (la que est√° en ESP-07) y luego se accede desde el programa como archivos normales.  All√≠ cargu√© las bibliotecas mqtt_as, uasyncio, ssd1306 y colecciones (usadas dentro de mqtt_as) que uso. <br><br>  Comenzamos y ... Recibimos MemoryError.  Adem√°s, cuanto m√°s intentaba entender exactamente d√≥nde estaba perdiendo la memoria, m√°s arreglaba la depuraci√≥n de las impresiones, antes se produc√≠a este error.  Un breve gugelezh me llev√≥ a comprender que, en principio, el microcontrolador solo tiene 30 kb de memoria en la que 65 kb de c√≥digo (junto con las bibliotecas) no se ajusta de ninguna manera. <br><br>  Pero hay un camino.  Resulta que micropython no ejecuta c√≥digo directamente desde el archivo .py; este archivo se compila primero.  Y se compila directamente en el microcontrolador, se convierte en bytecode, que luego se almacena en la memoria.  Bueno, para que el compilador funcione, tambi√©n necesitas una cierta cantidad de RAM. <br><br>  El truco consiste en salvar el microcontrolador de la compilaci√≥n intensiva en recursos.  Puede compilar archivos en una computadora grande y completar el c√≥digo de bytes terminado en el microcontrolador.  Para hacer esto, descargue el firmware de micropython y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cree la utilidad mpy-cross</a> . <br><br>  No escrib√≠ un Makefile, pero revis√© y compil√© manualmente todos los archivos necesarios (incluidas las bibliotecas) como este <br><br><pre> <code class="bash hljs">mpy-cross water_counter.py</code> </pre> <br>  Solo queda cargar archivos con la extensi√≥n .mpy, sin olvidar eliminar primero el correspondiente .py del sistema de archivos del dispositivo. <br><br>  Realic√© todo el desarrollo en el programa (IDE?) ESPlorer.  Le permite cargar scripts en el microcontrolador e inmediatamente ejecutarlos.  En mi caso, toda la l√≥gica y la creaci√≥n de todos los objetos se encuentran en el archivo water_counter.py (.mpy).  Pero para que todo esto se inicie autom√°ticamente, al principio debe haber otro archivo llamado main.py.  Y debe ser exactamente .py, y no un .mpy precompilado.  Aqu√≠ est√° su contenido trivial <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> water_counter</code> </pre> <br>  Comenzamos, todo funciona.  Pero hay peligrosamente poca memoria libre, aproximadamente 1kb.  Todav√≠a tengo planes para expandir la funcionalidad del dispositivo, y este kilobyte obviamente no ser√° suficiente para m√≠.  Pero result√≥ que hay una salida para este caso. <br><br>  Aqu√≠ est√° la cosa.  Aunque los archivos se compilan en bytecode y se encuentran en el sistema de archivos interno, de hecho todav√≠a se cargan en la RAM y se ejecutan desde all√≠.  Pero resulta que micropython es capaz de ejecutar bytecode directamente desde la memoria flash, pero para esto necesita incrustarlo directamente en el firmware.  Esto no es dif√≠cil, aunque me llev√≥ una cantidad de tiempo decente en mi netbook (solo all√≠ obtuve Linux). <br><br>  El algoritmo es el siguiente: <br><br><ul><li>  Descargue e instale el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ESP Open SDK</a> .  Esto crea un compilador y bibliotecas para programas bajo ESP8266.  Se ensambla de acuerdo con las instrucciones de la p√°gina principal del proyecto (eleg√≠ la configuraci√≥n STANDALONE = yes) </li><li>  Descargar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Micropython Sorts</a> </li><li>  Coloque las bibliotecas necesarias en los puertos / esp8266 / modules dentro del √°rbol de micropython </li><li>  Ensamblamos el firmware de acuerdo con las instrucciones en el <a href="">archivo ports / esp8266 / README.md</a> </li><li>  Vierta el firmware en el microcontrolador (hago esto en Windows con los programas ESP8266Flasher o Python esptool) </li></ul><br>  Eso es todo, ahora 'import ssd1306' elevar√° el c√≥digo directamente desde el firmware y no se gastar√° RAM para esto.  Con este truco, descargu√© solo el c√≥digo de la biblioteca en el firmware, mientras que el c√≥digo del programa principal se ejecuta desde el sistema de archivos.  Esto le permite modificar f√°cilmente el programa sin volver a compilar el firmware.  Por el momento tengo alrededor de 8.5kb de RAM libre.  Esto permitir√° implementar muchas funcionalidades √∫tiles diferentes en el futuro.  Bueno, si no hay suficiente memoria, entonces tambi√©n puede insertar el programa principal en el firmware. <br><br><h3>  ¬øY qu√© hacer con eso ahora? </h3><br>  Ok, el hardware est√° soldado, el firmware est√° escrito, la caja est√° impresa, el dispositivo est√° pegado a la pared y parpadea alegremente con una bombilla.  Pero si bien todo esto es una caja negra (en el sentido literal y figurado) y el sentido a√∫n no es suficiente.  Es hora de hacer algo con los mensajes MQTT que se env√≠an al servidor. <br><br>  Mi "casa inteligente" est√° girando en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el sistema Majordomo</a> .  El m√≥dulo MQTT est√° listo para usar o se puede instalar f√°cilmente desde el mercado de complementos; ya no recuerdo de d√≥nde vino.  La cosa MQTT no es autosuficiente: la llamada  broker: un servidor que recibe, clasifica y redirige los mensajes MQTT a los clientes.  Yo uso mosquitto, que (como el mayordomo) se ejecuta todo en el mismo netbook. <br><br>  Despu√©s de que el dispositivo env√≠e un mensaje al menos una vez, el valor aparecer√° inmediatamente en la lista. <br><br><img src="https://habrastorage.org/webt/hf/ip/db/hfipdb1coxh_lsaaz600mi-39y0.png"><br><br>  Estos valores ahora pueden asociarse con objetos del sistema, pueden usarse en scripts de automatizaci√≥n y someterse a diversos an√°lisis; todo esto est√° fuera del alcance de este art√≠culo.  Quien est√© interesado en el sistema majordomo, puedo recomendar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el canal Electronics In Lens</a> : un amigo tambi√©n construye una casa inteligente y habla de manera inteligible sobre la configuraci√≥n del sistema. <br><br>  Solo mostrar√© un par de gr√°ficos.  Este es un gr√°fico simple de valores diarios. <br><br><img src="https://habrastorage.org/webt/km/hw/xr/kmhwxruql1fk0kmykb1gpcpci_0.png"><br>  Se puede ver que casi nadie usa agua por la noche.  Un par de veces alguien fue al ba√±o, y parece que un filtro de √≥smosis inversa absorbe un par de litros por noche.  Por la ma√±ana, el consumo aumenta significativamente.  Por lo general, uso agua de una caldera, pero luego quer√≠a ba√±arme y cambiar temporalmente a agua caliente de la ciudad; esto tambi√©n es claramente visible en el gr√°fico inferior. <br><br>  De este cronograma, aprend√≠ que ir al ba√±o es de 6 a 7 litros de agua, ducharse, 20-30 litros, lavar los platos unos 20 litros y ba√±arse, se necesitan 160 litros.  Por un d√≠a, mi familia consume alrededor de 500-600l. <br><br>  Para los m√°s curiosos, puede mirar las entradas para cada valor individual <br><br><img src="https://habrastorage.org/webt/8l/8i/su/8l8isu_aiaswajdeeuexytpwffi.png"><br><br>  Desde aqu√≠ aprend√≠ que con el grifo abierto, el agua fluye a una velocidad de aproximadamente 1 litro en 5 segundos. <br><br>  Pero de esta forma, las estad√≠sticas probablemente no sean muy convenientes de ver.  En majordomo todav√≠a existe la oportunidad de ver gr√°ficos de consumo por d√≠a, semana y mes.  Por ejemplo, un gr√°fico de consumo en columnas <br><br><img src="https://habrastorage.org/webt/m3/wa/sf/m3wasfzbvxb2tz1yhemod2ewwdy.png"><br><br>  Hasta ahora solo tengo datos para una semana.  En un mes, este cuadro ser√° m√°s indicativo: una columna separada corresponder√° a cada d√≠a.  Los ajustes a los valores que ingreso manualmente estropean un poco la imagen (la columna m√°s grande).  Y a√∫n no est√° claro si configur√© incorrectamente los primeros valores casi un cubo menos, o si esto es un error en el firmware y no todos los litros entraron en la compensaci√≥n.  Toma m√°s tiempo <br><br>  Todav√≠a es necesario conjurar sobre los propios gr√°ficos, blanquear, colorear.  Quiz√°s tambi√©n construya un gr√°fico de consumo de memoria con fines de depuraci√≥n; de repente, algo se filtra por ah√≠.  Quiz√°s de alguna manera mostrar√© per√≠odos en los que Internet no estaba disponible.  Si bien todo esto gira a nivel de ideas. <br><br><h3>  Conclusi√≥n </h3><br>  Hoy, mi apartamento se ha vuelto un poco m√°s inteligente.  Con un dispositivo tan peque√±o, ser√° m√°s conveniente para m√≠ controlar el consumo de agua en la casa.  Si antes estaba indignado "nuevamente consumieron mucha agua en un mes", ahora puedo encontrar la fuente de este consumo. <br><br>  A alguien le parecer√≠a extra√±o ver las lecturas en la pantalla si est√° a un metro del medidor.  Pero en un futuro no muy lejano, planeo mudarme a otro departamento, donde habr√° varios elevadores, y los medidores probablemente estar√°n ubicados en el rellano.  Por lo tanto, un dispositivo de lectura remota ser√≠a muy √∫til. <br><br>  Tambi√©n planeo expandir la funcionalidad del dispositivo.  Ya estoy mirando las v√°lvulas motorizadas.  Ahora, para cambiar el agua de la ciudad de la caldera, necesito girar 3 grifos en un nicho inaccesible.  Ser√≠a mucho m√°s conveniente hacer esto con un bot√≥n con la indicaci√≥n adecuada.  Bueno, por supuesto, vale la pena implementar protecci√≥n contra fugas. <br><br>  En el art√≠culo le dije a mi versi√≥n del dispositivo basado en ESP8266.  En mi opini√≥n, obtuve una versi√≥n muy interesante del firmware de micropython usando coroutine, simple y bonita.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trat√© de describir los muchos matices y escuelas que encontr√© con la campa√±a. </font><font style="vertical-align: inherit;">Quiz√°s describ√≠ todo con demasiado detalle, para m√≠ personalmente, como lector, es m√°s f√°cil derrochar demasiado que pensar en lo que no se dijo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como siempre, estoy abierto a la cr√≠tica constructiva. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Circuito de </font></a></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo fuente </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font></a> <font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">modelo de caja de </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">placa</font></a></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es411259/">https://habr.com/ru/post/es411259/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es411249/index.html">C√≥mo hice mi Yandex. Transporte con horarios y autobuses.</a></li>
<li><a href="../es411251/index.html">Los usuarios resienten los archivos de escaneo de Chrome en la unidad local</a></li>
<li><a href="../es411253/index.html">La fusi√≥n de las estrellas de neutrones puso fin a las alternativas de la materia oscura y la energ√≠a oscura.</a></li>
<li><a href="../es411255/index.html">Aplicaciones descentralizadas para millones de usuarios en Ethereum</a></li>
<li><a href="../es411257/index.html">En los EE. UU., Crean un sistema l√°ser que asustar√° al enemigo con sonido</a></li>
<li><a href="../es411261/index.html">Respuesta a la vibraci√≥n en pr√≥tesis: una nueva forma de mejorar el control de las extremidades bi√≥nicas</a></li>
<li><a href="../es411263/index.html">Bot√≥n m√°gico para LED en ATtiny4</a></li>
<li><a href="../es411265/index.html">Casos de esp√≠as (Parte 3)</a></li>
<li><a href="../es411267/index.html">¬øQui√©n est√° realmente detr√°s de los nuevos tel√©fonos inteligentes con la marca Nokia?</a></li>
<li><a href="../es411269/index.html">Los tres componentes de "LOAD"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>