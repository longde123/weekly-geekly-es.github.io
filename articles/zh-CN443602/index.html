<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ†š ğŸ• ğŸ’š ä»€ä¹ˆæ˜¯ä¸¥æ ¼åˆ«åï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å…³å¿ƒï¼Ÿ ç¬¬äºŒéƒ¨åˆ† ğŸˆ ğŸ“´ ğŸ’³</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ï¼ˆæˆ–å¤æ€ªçš„æ‰“å­—ï¼Œå«ç³Šçš„è¡Œä¸ºå’Œå¯¹é½æ–¹å¼ï¼Œå“¦ï¼Œå¤©å“ªï¼ï¼‰ 

 æœ‹å‹ï¼Œåœ¨â€œ C ++å¼€å‘äººå‘˜â€è¯¾ç¨‹ä¸Šå¯åŠ¨æ–°çº¿ç¨‹ä¹‹å‰ï¼Œå‰©ä¸‹çš„æ—¶é—´å¾ˆå°‘ã€‚ ç°åœ¨æ˜¯æ—¶å€™å‘å¸ƒè¯¥ææ–™ç¬¬äºŒéƒ¨åˆ†çš„è¯‘æ–‡äº†ï¼Œå®ƒè®²è¿°äº†åŒå…³è¯­çš„è¾“å…¥ã€‚ 

 ä»€ä¹ˆæ˜¯åŒå…³è¯­ï¼Ÿ 

 æˆ‘ä»¬åˆ°äº†ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ­¥ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬å¯èƒ½æ ¹æœ¬éœ€è¦å‡åï¼Ÿ é€šå¸¸ç”¨äºæ‰§è¡ŒåŒå…³è¯­æ‰“å­—ï¼Œtk...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä»€ä¹ˆæ˜¯ä¸¥æ ¼åˆ«åï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å…³å¿ƒï¼Ÿ ç¬¬äºŒéƒ¨åˆ†</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/443602/">  <b><i>ï¼ˆæˆ–å¤æ€ªçš„æ‰“å­—ï¼Œå«ç³Šçš„è¡Œä¸ºå’Œå¯¹é½æ–¹å¼ï¼Œå“¦ï¼Œå¤©å“ªï¼ï¼‰</i></b> <br><br> æœ‹å‹ï¼Œåœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">â€œ C ++å¼€å‘äººå‘˜â€</a>è¯¾ç¨‹ä¸Šå¯åŠ¨æ–°çº¿ç¨‹ä¹‹å‰ï¼Œå‰©ä¸‹çš„æ—¶é—´å¾ˆå°‘ã€‚ ç°åœ¨æ˜¯æ—¶å€™å‘å¸ƒè¯¥ææ–™ç¬¬äºŒéƒ¨åˆ†çš„è¯‘æ–‡äº†ï¼Œå®ƒè®²è¿°äº†åŒå…³è¯­çš„è¾“å…¥ã€‚ <br><br>  <b>ä»€ä¹ˆæ˜¯åŒå…³è¯­ï¼Ÿ</b> <br><br> æˆ‘ä»¬åˆ°äº†ä¸€ä¸ªå¥‡æ€ªçš„åœ°æ­¥ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬å¯èƒ½æ ¹æœ¬éœ€è¦å‡åï¼Ÿ é€šå¸¸ç”¨äºæ‰§è¡ŒåŒå…³è¯­æ‰“å­—ï¼Œtkã€‚ ç»å¸¸ä½¿ç”¨çš„æ–¹æ³•è¿åäº†ä¸¥æ ¼çš„åˆ«åè§„åˆ™ã€‚ <br><br><img src="https://habrastorage.org/webt/dz/u-/cd/dzu-cdwp2tjct7bc-stnxfnptpe.png"><br><br> æœ‰æ—¶æˆ‘ä»¬æƒ³ç»•è¿‡ç±»å‹ç³»ç»Ÿå¹¶å°†å¯¹è±¡è§£é‡Šä¸ºå¦ä¸€ç§ç±»å‹ã€‚ å°†å†…å­˜æ®µé‡æ–°è§£é‡Šä¸ºå¦ä¸€ç§ç±»å‹ç§°ä¸ºç±»å‹<i>punning pun</i> ã€‚ é”®å…¥åŒå…³è¯­å¯¹äºéœ€è¦è®¿é—®å¯¹è±¡çš„åŸºæœ¬è¡¨ç¤ºä»¥æŸ¥çœ‹ï¼Œä¼ è¾“æˆ–æ“çºµæä¾›çš„æ•°æ®çš„ä»»åŠ¡å¾ˆæœ‰ç”¨ã€‚ æˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°ä½¿ç”¨åŒå…³è¯­çš„å…¸å‹é¢†åŸŸï¼šç¼–è¯‘å™¨ï¼Œåºåˆ—åŒ–ï¼Œç½‘ç»œä»£ç ç­‰ã€‚ <a name="habracut"></a><br> ä¼ ç»Ÿä¸Šï¼Œè¿™æ˜¯é€šè¿‡è·å–å¯¹è±¡çš„åœ°å€ï¼Œå°†å…¶å¼ºåˆ¶è½¬æ¢ä¸ºæŒ‡å‘æˆ‘ä»¬è¦è§£é‡Šçš„ç±»å‹çš„æŒ‡é’ˆï¼Œç„¶åè®¿é—®è¯¥å€¼æˆ–ä½¿ç”¨åˆ«åæ¥å®ç°çš„ã€‚ ä¾‹å¦‚ï¼š <br><br><pre><code class="bash hljs">int x = 1 ; //   C <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> *fp = (<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>*)&amp;x ; //   //  C++ <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> *fp = reinterpret_cast&lt;<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>*&gt;(&amp;x) ; //   <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>( â€œ%f\nâ€, *fp ) ;</code> </pre> <br> å¦‚å‰æ‰€è¿°ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„åˆ«åï¼Œè¿™å°†å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚ ä½†æ˜¯ä¼ ç»Ÿä¸Šï¼Œç¼–è¯‘å™¨å¹¶ä¸ä½¿ç”¨ä¸¥æ ¼çš„åˆ«åè§„åˆ™ï¼Œè€Œè¿™ç§ç±»å‹çš„ä»£ç é€šå¸¸åªèƒ½å·¥ä½œï¼Œè€Œä¸”ä¸å¹¸çš„æ˜¯ï¼Œå¼€å‘äººå‘˜ä¹ æƒ¯äºå…è®¸è¿™ç§äº‹æƒ…ã€‚ ä¸€ç§å¸¸è§çš„æ›¿ä»£åŒæ‰“ç±»å‹æ–¹æ³•æ˜¯é€šè¿‡å¹¶é›†ï¼ˆunionï¼‰ï¼Œè¯¥æ–¹æ³•åœ¨Cè¯­è¨€ä¸­æœ‰æ•ˆï¼Œä½†ä¼šåœ¨C ++ä¸­å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯·å‚è§ç¤ºä¾‹</a> ï¼‰ï¼š <br><br><pre> <code class="bash hljs">union u1 { int n; <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> f; } ; union u1 u; uf = 1.0f; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>( <span class="hljs-string"><span class="hljs-string">"%d\nâ€, un ); // UB(undefined behaviour)  C++ â€œn is not the active memberâ€</span></span></code> </pre> <br> è¿™åœ¨C ++ä¸­æ˜¯ä¸å¯æ¥å—çš„ï¼Œå¹¶ä¸”ä¸€äº›äººè®¤ä¸ºè”åˆä»…ç”¨äºå®ç°å˜é‡ç±»å‹ï¼Œå¹¶è®¤ä¸ºä½¿ç”¨è”åˆé”®å…¥åŒå…³è¯­æ˜¯ä¸€ç§æ»¥ç”¨ã€‚ <br><br>  <b>å¦‚ä½•å®æ–½åŒå…³è¯­ï¼Ÿ</b> <br><br> åœ¨Cå’ŒC ++ä¸­é”®å…¥åŒå…³è¯­çš„æ ‡å‡†åŠ æŒæ–¹æ³•æ˜¯memcpyã€‚ è¿™ä¼¼ä¹æœ‰äº›å¤æ‚ï¼Œä½†æ˜¯ä¼˜åŒ–ç¨‹åºéœ€è¦è¯†åˆ«åŒå…³è¯­å¯¹memcpyçš„ä½¿ç”¨ï¼Œå¯¹å…¶è¿›è¡Œä¼˜åŒ–å¹¶ç”Ÿæˆä¸€ä¸ªå¯„å­˜å™¨æ¥è®°å½•ç§»åŠ¨ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“int64_tä¸doubleå¤§å°ç›¸åŒï¼š <br><br><pre> <code class="bash hljs">static_assert( sizeof( double ) == sizeof( int64_t ) ); // C++17   </code> </pre> <br> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>memcpy</code> ï¼š <br><br><pre> <code class="bash hljs">void func1( double d ) { std::int64_t n; std::memcpy(&amp;n, &amp;d, sizeof d); //â€¦</code> </pre><br> æœ‰äº†è¶³å¤Ÿçš„ä¼˜åŒ–æ°´å¹³ï¼Œä»»ä½•ä½“é¢çš„ç°ä»£ç¼–è¯‘å™¨éƒ½ä¼šç”Ÿæˆä¸å‰é¢æåˆ°çš„reinterpret_castæ–¹æ³•æˆ–joinæ–¹æ³•ç›¸åŒçš„ä»£ç ï¼Œä»¥å¾—åˆ°åŒå…³è¯­ã€‚ ç ”ç©¶ç”Ÿæˆçš„ä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒä»…ä½¿ç”¨movå¯„å­˜å™¨ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¤ºä¾‹</a> ï¼‰ã€‚ <br><br>  <b>åŒå…³è¯­ç±»å‹å’Œæ•°ç»„</b> <br><br> ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å°†ä¸€ä¸ªæ— ç¬¦å·charæ•°ç»„çš„åŒå…³å®ç°ä¸ºä¸€ç³»åˆ—æ— ç¬¦å·intï¼Œç„¶åå¯¹æ¯ä¸ªæ— ç¬¦å·intå€¼æ‰§è¡Œä¸€ä¸ªè¿ç®—ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨memcpyå°†æ— ç¬¦å·çš„charæ•°ç»„è½¬æ¢ä¸ºä¸´æ—¶çš„éå•intç±»å‹ã€‚ ä¼˜åŒ–å™¨ä»ç„¶å¯ä»¥é€šè¿‡memcpyæŸ¥çœ‹æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¼˜åŒ–ä¸´æ—¶å¯¹è±¡å’Œå‰¯æœ¬ï¼Œå¹¶ç›´æ¥ä½¿ç”¨åŸºç¡€æ•°æ®ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¾‹å¦‚</a> ï¼‰ï¼š <br><br><pre> <code class="bash hljs">//  ,    int foo( unsigned int x ) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> x ; } // ,  len  sizeof(unsigned int) int bar( unsigned char *p, size_t len ) { int result = 0; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( size_t index = 0; index &lt; len; index += sizeof(unsigned int) ) { unsigned int ui = 0; std::memcpy( &amp;ui, &amp;p[index], sizeof(unsigned int) ); result += foo( ui ) ; } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> result; }</code> </pre><br> åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨<code>char*p</code> ï¼Œå‡è®¾å®ƒæŒ‡å‘å‡ ä¸ª<code>sizeof(unsigned int)</code>æ•°æ®ç‰‡æ®µï¼Œå°†æ¯ä¸ªæ•°æ®ç‰‡æ®µè§£é‡Šä¸º<code>unsigned int</code> ï¼Œä¸ºpunçš„æ¯ä¸ªç‰‡æ®µè®¡ç®—<code>foo()</code> ï¼Œå°†å…¶æ±‚å’Œï¼Œç„¶åè¿”å›æœ€ç»ˆå€¼ã€‚ <br><br> å¾ªç¯ä¸»ä½“çš„ç¨‹åºé›†æ˜¾ç¤ºï¼Œä¼˜åŒ–å™¨å°†ä¸»ä½“è½¬æ¢ä¸ºå¯¹<code>unsigned char</code>åŸºæ•°ç»„çš„ç›´æ¥è®¿é—®ï¼Œå¹¶å°†å…¶ä½œä¸º<code>unsigned int</code>å¹¶å°†å…¶ç›´æ¥æ·»åŠ åˆ°<code>eax</code> ï¼š <br><br><pre> <code class="bash hljs">add eax, dword ptr [rdi + rcx]</code> </pre> <br> ç›¸åŒçš„ä»£ç ï¼Œä½†æ˜¯ä½¿ç”¨<code>reinterpret_cast</code>å®ç°åŒå…³è¯­ï¼ˆè¿åä¸¥æ ¼çš„åˆ«åï¼‰ï¼š <br><br><pre> <code class="bash hljs">// ,  len  sizeof(unsigned int) int bar( unsigned char *p, size_t len ) { int result = 0; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( size_t index = 0; index &lt; len; index += sizeof(unsigned int) ) { unsigned int ui = *reinterpret_cast&lt;unsigned int*&gt;(&amp;p[index]); result += foo( ui ); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> result; }</code> </pre> <br>  <b>C ++ 20å’Œbit_cast</b> <br><br> åœ¨C ++ 20ä¸­ï¼Œæˆ‘ä»¬æœ‰<code>bit_cast</code> ï¼Œå®ƒæä¾›äº†ä¸€ç§ç®€å•è€Œå®‰å…¨çš„è§£é‡Šæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥åœ¨<code>constexpr</code>çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ã€‚ <br><br> ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨<code>bit_cast</code>è§£é‡Š<code>float</code>çš„æ— ç¬¦å·æ•´æ•°çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¤ºä¾‹</a> ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¤ºä¾‹</a> ï¼‰ï¼š <br><br><pre> <code class="bash hljs">std::cout &lt;&lt; bit_cast&lt;<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>&gt;(0x447a0000) &lt;&lt; <span class="hljs-string"><span class="hljs-string">"\n"</span></span> ; //,  sizeof(<span class="hljs-built_in"><span class="hljs-built_in">float</span></span>) == sizeof(unsigned int)</code> </pre> <br> å¦‚æœç±»å‹Toå’ŒFromçš„å¤§å°ä¸åŒï¼Œåˆ™éœ€è¦æˆ‘ä»¬ä½¿ç”¨ä¸­é—´ç»“æ„ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç»“æ„ï¼Œè¯¥ç»“æ„åŒ…å«ä¸€ä¸ªå­—ç¬¦æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„<code>sizeof(unsigned int)</code>ä¸º<code>sizeof(unsigned int)</code> ï¼ˆå‡å®šä¸º4å­—èŠ‚æ— ç¬¦å·intï¼‰ï¼Œä½œä¸ºFromç±»å‹ï¼Œè€Œ<code>unsigned int</code>ä½œä¸ºToã€‚ <br><br><pre> <code class="bash hljs">struct uint_chars { unsigned char arr[sizeof( unsigned int )] = {} ; //  sizeof( unsigned int ) == 4 }; //  len  4 int bar( unsigned char *p, size_t len ) { int result = 0; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( size_t index = 0; index &lt; len; index += sizeof(unsigned int) ) { uint_chars f; std::memcpy( f.arr, &amp;p[index], sizeof(unsigned int)); unsigned int result = bit_cast&lt;unsigned int&gt;(f); result += foo( result ); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> result ; }</code> </pre> <br> ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è¿™ç§ä¸­é—´ç±»å‹-è¿™æ˜¯å½“å‰çš„<code>bit_cast</code>é™åˆ¶ã€‚ <br><br>  <b>å¯¹é½æ–¹å¼</b> <br><br> åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿åä¸¥æ ¼çš„åˆ«åè§„åˆ™ä¼šå¯¼è‡´åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­æ’é™¤å­˜å‚¨ã€‚ è¿åä¸¥æ ¼çš„æ··å ä¹Ÿå¯èƒ½å¯¼è‡´è¿åå¯¹é½è¦æ±‚ã€‚  Cæ ‡å‡†å’ŒC ++éƒ½è¯´å¯¹è±¡è¦ç¬¦åˆå¯¹é½è¦æ±‚ï¼Œä»è€Œé™åˆ¶äº†å¯¹è±¡å¯ä»¥æ”¾ç½®ï¼ˆåœ¨å†…å­˜ä¸­ï¼‰å¹¶å› æ­¤å¯ä»¥è®¿é—®çš„ä½ç½®ã€‚  <i>C11ç¬¬6.2.8èŠ‚â€œå¯¹è±¡å¯¹é½çŠ¶æ€â€</i> ï¼š <br><br> å®Œæ•´ç±»å‹çš„å¯¹è±¡å…·æœ‰å¯¹é½è¦æ±‚ï¼Œè¿™äº›è¦æ±‚å¯¹å¯æ”¾ç½®æ­¤ç±»å‹å¯¹è±¡çš„åœ°å€æ–½åŠ äº†é™åˆ¶ã€‚ å¯¹é½æ˜¯å®ç°å®šä¹‰çš„æ•´æ•°å€¼ï¼Œè¡¨ç¤ºå¯ä»¥æ”¾ç½®æ­¤å¯¹è±¡çš„è¿ç»­åœ°å€ä¹‹é—´çš„å­—èŠ‚æ•°ã€‚ å¯¹è±¡çš„ç±»å‹å¯¹è¿™ç§ç±»å‹çš„æ¯ä¸ªå¯¹è±¡éƒ½è¦æ±‚æœ‰å¯¹é½è¦æ±‚ï¼šå¯ä»¥ä½¿ç”¨<code>_Alignas</code>è¯·æ±‚æ›´ä¸¥æ ¼çš„å¯¹é½æ–¹å¼ã€‚ <br><br>  <b>ç¬¬1èŠ‚[basic.align]ä¸­çš„C ++ 17é¡¹ç›®æ ‡å‡†</b> ï¼š <br><br> å¯¹è±¡ç±»å‹å…·æœ‰å¯¹é½è¦æ±‚ï¼ˆ6.7.1ï¼Œ6.7.2ï¼‰ï¼Œè¯¥è¦æ±‚å¯¹å¯æ”¾ç½®æ­¤ç±»å‹å¯¹è±¡çš„åœ°å€æ–½åŠ äº†é™åˆ¶ã€‚ å¯¹é½æ˜¯å®ç°å®šä¹‰çš„æ•´æ•°å€¼ï¼Œè¡¨ç¤ºå¯ä»¥æ”¾ç½®ç»™å®šå¯¹è±¡çš„è¿ç»­åœ°å€ä¹‹é—´çš„å­—èŠ‚æ•°ã€‚ å¯¹è±¡ç±»å‹å¯¹è¿™ç§ç±»å‹çš„æ¯ä¸ªå¯¹è±¡éƒ½è¦æ±‚å¯¹é½è¦æ±‚ï¼› å¯ä»¥ä½¿ç”¨æ¯”å¯¹è¯´æ˜ç¬¦ï¼ˆ10.6.2ï¼‰è¦æ±‚æ›´ä¸¥æ ¼çš„æ¯”å¯¹ã€‚ <br><br>  C99å’ŒC11éƒ½æ˜ç¡®æŒ‡å‡ºå¯¼è‡´æŒ‡é’ˆæœªå¯¹é½çš„è½¬æ¢æ˜¯æœªå®šä¹‰çš„è¡Œä¸ºï¼Œç¬¬6.3.2.3èŠ‚ã€‚  <i>æŒ‡é’ˆ</i>è¯´ï¼š <br><blockquote> æŒ‡å‘å¯¹è±¡æˆ–éƒ¨åˆ†ç±»å‹çš„æŒ‡é’ˆå¯ä»¥è½¬æ¢ä¸ºæŒ‡å‘å¦ä¸€ä¸ªå¯¹è±¡æˆ–éƒ¨åˆ†ç±»å‹çš„æŒ‡é’ˆã€‚ å¦‚æœç”Ÿæˆçš„æŒ‡é’ˆæœªé’ˆå¯¹æŒ‡é’ˆç±»å‹æ­£ç¡®å¯¹é½ï¼Œåˆ™è¡Œä¸ºæœªå®šä¹‰ã€‚  ... <br></blockquote> å°½ç®¡C ++ä¸å¤ªæ˜æ˜¾ï¼Œä½†æˆ‘è®¤ä¸ºç¬¬1æ¬¾<code>[basic.align]</code>ä¸­çš„è¿™ä¸€å¥è¯<code>[basic.align]</code>è¶³å¤Ÿäº†ï¼š <br><blockquote>  ...å¯¹è±¡çš„ç±»å‹å¯¹è¿™ç§ç±»å‹çš„æ¯ä¸ªå¯¹è±¡éƒ½è¦æ±‚å¯¹é½è¦æ±‚ï¼›  ... </blockquote>  <i><b>ä¾‹å­</b></i> <br><br> å› æ­¤ï¼Œæˆ‘ä»¬å‡è®¾ï¼š <br><br><ul><li>  alignofï¼ˆcharï¼‰å’Œalignofï¼ˆintï¼‰åˆ†åˆ«ä¸º1å’Œ4 </li><li>  sizeofï¼ˆintï¼‰æ˜¯4 </li></ul><br> å› æ­¤ï¼Œå°†å¤§å°ä¸º4çš„charæ•°ç»„è§£é‡Šä¸º<code>int</code>è¿åä¸¥æ ¼çš„åˆ«åï¼Œå¦‚æœæ•°ç»„çš„å¯¹é½æ–¹å¼ä¸º1æˆ–2ä¸ªå­—èŠ‚ï¼Œä¹Ÿå¯èƒ½è¿åå¯¹é½è¦æ±‚ã€‚ <br><br><pre> <code class="bash hljs">char arr[4] = { 0x0F, 0x0, 0x0, 0x00 }; //        1  2  int x = *reinterpret_cast&lt;int*&gt;(arr); // Undefined behavior  </code> </pre> <br> åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é™ä½æˆ–æ€»çº¿é”™è¯¯ã€‚ è€Œä½¿ç”¨alignaså¼ºåˆ¶å¯¹intä¸­çš„æ•°ç»„è¿›è¡Œç›¸åŒçš„å¯¹é½å°†é˜²æ­¢å¯¹é½è¦æ±‚è¢«ç ´åï¼š <br><br><pre> <code class="bash hljs">alignas(alignof(int)) char arr[4] = { 0x0F, 0x0, 0x0, 0x00 }; int x = *reinterpret_cast&lt;int*&gt;(arr);</code> </pre> <br>  <i><b>åŸå­æ€§</b></i> <br><br> å¯¹äºä¸å¹³è¡¡è®¿é—®çš„å¦ä¸€ä¸ªæ„å¤–æƒ©ç½šæ˜¯ï¼Œå®ƒè¿åäº†æŸäº›æ¶æ„çš„åŸå­æ€§ã€‚ å¦‚æœx86ä¸­çš„å…¶ä»–çº¿ç¨‹æœªå¯¹é½ï¼Œåˆ™åŸå­å­˜å‚¨å¯èƒ½ä¸ä¼šæ˜¾ç¤ºä¸ºåŸå­ã€‚ <br><br>  <b>æ•è·ä¸¥æ ¼çš„æ··å è¿è§„</b> <br><br> æˆ‘ä»¬æ²¡æœ‰å¾ˆå¤šå¥½çš„å·¥å…·æ¥è·Ÿè¸ªC ++ä¸­çš„ä¸¥æ ¼åˆ«åã€‚ æˆ‘ä»¬æ‹¥æœ‰çš„å·¥å…·å°†æ•è·æŸäº›è¿è§„æƒ…å†µä»¥åŠæŸäº›ä¸æ­£ç¡®çš„åŠ è½½å’Œå­˜å‚¨æƒ…å†µã€‚ <br><br>  gccä½¿ç”¨<code>-fstrict-aliasing</code>å’Œ<code>-Wstrict-aliasing</code>æ ‡å¿—å¯ä»¥æ•è·æŸäº›æƒ…å†µï¼Œå°½ç®¡å¹¶éæ²¡æœ‰è¯¯æŠ¥/éº»çƒ¦ã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹æƒ…å†µå°†åœ¨gccä¸­äº§ç”Ÿè­¦å‘Šï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">example</a> ï¼‰ï¼š <br><br><pre> <code class="bash hljs">int a = 1; short j; <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> f = 1.f; //   ,   TIS ,         <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, j = *(reinterpret_cast&lt;short*&gt;(&amp;a))); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, j = *(reinterpret_cast&lt;int*&gt;(&amp;f)));</code> </pre> <br> å°½ç®¡ä»–ä¸ä¼šé‡åˆ°è¿™ç§é¢å¤–çš„æƒ…å†µï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¾‹å¦‚</a> ï¼‰ï¼š <br><br><pre> <code class="bash hljs">int *p; p=&amp;a; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, j = *(reinterpret_cast&lt;short*&gt;(p)));</code> </pre><br> å°½ç®¡<code>clang</code>è§£æäº†è¿™äº›æ ‡å¿—ï¼Œä½†å®ƒä¼¼ä¹å¹¶æœªçœŸæ­£å®ç°è­¦å‘Šã€‚ <br><br> æˆ‘ä»¬æ‹¥æœ‰çš„å¦ä¸€ä¸ªå·¥å…·æ˜¯ASanï¼Œå®ƒå¯ä»¥æ•è·æœªå¯¹é½çš„è®°å½•å’Œå­˜å‚¨ã€‚ å°½ç®¡å®ƒä»¬å¹¶éç›´æ¥è¿åä¸¥æ ¼çš„åˆ«åï¼Œä½†è¿™æ˜¯ç›¸å½“æ™®éçš„ç»“æœã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹æƒ…å†µå°†åœ¨ä½¿ç”¨<code>-fsanitize=address</code> clangè¿›è¡Œæ±‡ç¼–çš„è¿‡ç¨‹ä¸­ç”Ÿæˆè¿è¡Œæ—¶é”™è¯¯ <br><br><pre> <code class="bash hljs">int *x = new int[2]; // 8 : [0,7]. int *u = (int*)((char*)x + 6); //     x    *u = 1; //    [6-9] <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>( <span class="hljs-string"><span class="hljs-string">"%d\n"</span></span>, *u ); //    [6-9]</code> </pre> <br> æˆ‘æ¨èçš„æœ€åä¸€ä¸ªå·¥å…·æ˜¯ç‰¹å®šäºC ++çš„ï¼Œå®é™…ä¸Šï¼Œä¸ä»…æ˜¯ä¸€ç§å·¥å…·ï¼Œè€Œä¸”æ˜¯ä¸å…è®¸Cé£æ ¼è½¬æ¢çš„ç¼–ç å®è·µï¼Œ <code>gcc</code>å’Œ<code>clang</code>éƒ½å°†ä½¿ç”¨<code>-Wold-style-cast</code>å¯¹C <code>-Wold-style-cast</code>è¿›è¡Œè¯Šæ–­ã€‚ <code>-Wold-style-cast</code> ã€‚ è¿™å°†å¼ºåˆ¶æ‰€æœ‰æœªå®šä¹‰çš„åŒå…³è¯­ä½¿ç”¨reinterpret_castã€‚ é€šå¸¸ï¼Œ <code>reinterpret_cast</code>åº”è¯¥æ˜¯å¯¹ä»£ç è¿›è¡Œæ›´å½»åº•åˆ†æçš„ä¿¡æ ‡ã€‚ <br> åœ¨ä»£ç åº“ä¸­æœç´¢<code>reinterpret_cast</code>æ¥æ‰§è¡Œå®¡æ ¸ä¹Ÿæ›´åŠ å®¹æ˜“ã€‚ <br><br> å¯¹äºCï¼Œæˆ‘ä»¬å·²ç»æè¿°äº†æ‰€æœ‰å·¥å…·ï¼Œè¿˜æ‹¥æœ‰<code>tis-interpreter</code> ï¼ˆé™æ€åˆ†æå™¨ï¼‰ï¼Œå¯ä»¥å¯¹ç¨‹åºçš„å¤§é‡Cè¯­è¨€å­é›†è¿›è¡Œè¯¦å°½çš„åˆ†æï¼Œåœ¨ä¸Šä¸€ä¸ªç¤ºä¾‹çš„Cç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨-fstrict-aliasingä¼šè·³è¿‡ä¸€ç§æƒ…å†µï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¤ºä¾‹</a> ï¼‰ <br><br><pre> <code class="bash hljs">int a = 1; short j; <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> f = 1.0 ; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, j = *((short*)&amp;a)); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, j = *((int*)&amp;f)); int *p; p=&amp;a; <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%i\n"</span></span>, j = *((short*)p));</code> </pre><br>  TISè§£é‡Šå™¨å¯ä»¥æ‹¦æˆªå…¨éƒ¨ä¸‰ä¸ªï¼Œä¸‹é¢çš„ç¤ºä¾‹å°†TISå†…æ ¸ç§°ä¸ºTISè§£é‡Šå™¨ï¼ˆä¸ºç®€æ´èµ·è§å¯¹è¾“å‡ºè¿›è¡Œäº†ç¼–è¾‘ï¼‰ï¼š <br><br><pre> <code class="bash hljs">./bin/tis-kernel -sa example1.c ... example1.c:9:[sa] warning: The pointer (short *)(&amp; a) has <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> short *. It violates strict aliasing rules by accessing a cell with effective <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> int. ... example1.c:10:[sa] warning: The pointer (int *)(&amp; f) has <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> int *. It violates strict aliasing rules by accessing a cell with effective <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>. Callstack: main ... example1.c:15:[sa] warning: The pointer (short *)p has <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> short *. It violates strict aliasing rules by accessing a cell with effective <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> int.</code> </pre> <br> æœ€åæ˜¯æ­£åœ¨å¼€å‘çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TySan</a> ã€‚ è¯¥æ¸…ç†ç¨‹åºå°†ç±»å‹æ£€æŸ¥ä¿¡æ¯æ·»åŠ åˆ°å½±å­å†…å­˜æ®µï¼Œå¹¶æ£€æŸ¥è®¿é—®ä»¥ç¡®å®šå®ƒä»¬æ˜¯å¦è¿ååˆ«åè§„åˆ™ã€‚ è¯¥å·¥å…·å¯èƒ½åº”è¯¥èƒ½å¤Ÿè·Ÿè¸ªæ‰€æœ‰æ··å è¿è§„è¡Œä¸ºï¼Œä½†æ˜¯åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰å¾ˆå¤§çš„å¼€é”€ã€‚ <br><br>  <b>ç»“è®º</b> <br><br> æˆ‘ä»¬äº†è§£äº†Cå’ŒC ++ä¸­çš„åˆ«åè§„åˆ™ï¼Œè¿™æ„å‘³ç€ç¼–è¯‘å™¨å¸Œæœ›æˆ‘ä»¬ä¸¥æ ¼éµå®ˆè¿™äº›è§„åˆ™ï¼Œå¹¶æ¥å—ä¸å±¥è¡Œè¿™äº›è§„åˆ™çš„åæœã€‚ æˆ‘ä»¬å·²ç»äº†è§£äº†ä¸€äº›å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¯†åˆ«å‡åæ»¥ç”¨è¡Œä¸ºçš„å·¥å…·ã€‚ æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œåˆ«åçš„é€šå¸¸ç”¨æ³•æ˜¯å…¸å‹çš„åŒå…³è¯­ã€‚ æˆ‘ä»¬è¿˜å­¦ä¹ äº†å¦‚ä½•æ­£ç¡®å®æ–½å®ƒã€‚ <br><br> ä¼˜åŒ–å™¨æ­£åœ¨é€æ­¥æ”¹è¿›åŸºäºç±»å‹çš„åˆ«ååˆ†æï¼Œå¹¶ä¸”å·²ç»ç ´åäº†ä¸€äº›åŸºäºä¸¥æ ¼åˆ«åå†²çªçš„ä»£ç ã€‚ æˆ‘ä»¬å¯ä»¥æœŸæœ›ä¼˜åŒ–ä¼šå˜å¾—æ›´å¥½ï¼Œå¹¶ç ´åæ›´å¤šçš„ä»£ç ã€‚ <br><br> æˆ‘ä»¬æœ‰æ ‡å‡†çš„ç°æˆå…¼å®¹æ–¹æ³•æ¥è§£é‡Šç±»å‹ã€‚ æœ‰æ—¶ï¼Œå¯¹äºè°ƒè¯•ç‰ˆæœ¬ï¼Œè¿™äº›æ–¹æ³•åº”è¯¥æ˜¯å…è´¹çš„æŠ½è±¡ã€‚ æˆ‘ä»¬æœ‰å‡ ç§æ£€æµ‹ä¸¥é‡æ··å è¿è§„çš„å·¥å…·ï¼Œä½†æ˜¯å¯¹äºC ++ï¼Œå®ƒä»¬ä»…æ•è·ä¸€å°éƒ¨åˆ†æƒ…å†µï¼Œå¯¹äºä½¿ç”¨tisè§£é‡Šå™¨çš„Cï¼Œæˆ‘ä»¬å¯ä»¥è·Ÿè¸ªå¤§å¤šæ•°è¿è§„ã€‚ <br><br> æ„Ÿè°¢é‚£äº›å¯¹æœ¬æ–‡å‘è¡¨è¯„è®ºçš„äººï¼šJF Bastienï¼ŒChristopher Di Bellaï¼ŒPascal Quocï¼ŒMatt P. Dziubinskiï¼ŒPatrice Royå’ŒOlafur Vaage <br> å½“ç„¶ï¼Œæœ€åæ‰€æœ‰é”™è¯¯å‡å½’ä½œè€…æ‰€æœ‰ã€‚ <br><br> å› æ­¤ï¼Œç›¸å½“å¤§çš„ææ–™çš„ç¿»è¯‘å·¥ä½œå·²ç»ç»“æŸï¼Œå¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>é˜…è¯»å…¶ç¬¬ä¸€éƒ¨åˆ†ã€‚ ä¼ ç»Ÿä¸Šï¼Œæˆ‘ä»¬é‚€è¯·æ‚¨å‚åŠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¼€æ”¾æ—¥</a> ï¼Œè¯¥æ—¥ç”±Ramblerï¼†Co- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Dmitry Shebordaev</a>çš„æŠ€æœ¯å¼€å‘éƒ¨é—¨è´Ÿè´£äººäº3æœˆ14æ—¥ä¸¾è¡Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ã€‚</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><br></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN443602/">https://habr.com/ru/post/zh-CN443602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN443590/index.html">æ•°æ®ç§‘å­¦ï¼šé¢„æµ‹ä¸šåŠ¡äº‹ä»¶ä»¥æ”¹å–„æœåŠ¡</a></li>
<li><a href="../zh-CN443592/index.html">æ—§çš„FMæ¥æ”¶å™¨å’Œç”µæ¢¯æ‚ç‰©äº§ç”Ÿçš„RFIDå‰ç«¯æ ‡å‡†ISO 11785</a></li>
<li><a href="../zh-CN443594/index.html">æµ‹è¯•ä¸æ¶æ„çš„åå­—è·¯å£ï¼šå°¼å°”Â·ç¦ç‰¹è®¿è°ˆ</a></li>
<li><a href="../zh-CN443598/index.html">ä»å„ç§CAå¤§é‡æ’¤æ¶ˆäº†TLSè¯ä¹¦ï¼Œè¿™æ˜¯é”™è¯¯åœ°åœ¨63ä½RNGè€Œé64ä½RNGä¸Šç”Ÿæˆçš„</a></li>
<li><a href="../zh-CN443600/index.html">MWC 2019çš„æœ€ä½³å’Œæœ€åè¶‹åŠ¿</a></li>
<li><a href="../zh-CN443604/index.html">è¡ŒåŠ¨ç¬¬ä¸€ï¼šOZONçš„Hackathon</a></li>
<li><a href="../zh-CN443606/index.html">Jenkins for Androidä½¿ç”¨Dockeræ„å»º</a></li>
<li><a href="../zh-CN443608/index.html">Lazuriteçš„æ™ºèƒ½å®¶å±…/æ›´æ–°</a></li>
<li><a href="../zh-CN443612/index.html">æˆ‘ä»¬ä½¿ç”¨æ—§çš„åç¡¬ç›˜</a></li>
<li><a href="../zh-CN443614/index.html">YouTrack 2019.1ï¼šé€‰æ‹©æ•æ·æ¿ï¼Œæ•æ·æ¿ä¸Šçš„å¯è‡ªå®šä¹‰å¡å­—æ®µç­‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>