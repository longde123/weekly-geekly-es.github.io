<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õëÔ∏è ü§∞üèΩ üòá Ingenier√≠a inversa de arcade: grabar Michael Jordan en NBA Jam üî¨ üí™üèº üëü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El verano pasado fui invitado a una fiesta en Sunnyvale. Result√≥ que los propietarios en el garaje tienen una m√°quina arcade NBA JAM Tournament Editio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ingenier√≠a inversa de arcade: grabar Michael Jordan en NBA Jam</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473660/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7e1/f90/849/7e1f90849dee7927ad904dca4f68bf2d.png" width="150%"></div><br>  El verano pasado fui invitado a una fiesta en Sunnyvale.  Result√≥ que los propietarios en el garaje tienen una m√°quina arcade NBA JAM Tournament Edition para cuatro jugadores.  A pesar de que el juego ya tiene m√°s de 25 a√±os (fue lanzado en 1993), todav√≠a es muy interesante jugarlo, especialmente para los fan√°ticos entusiastas. <br><br>  Me sorprendi√≥ la lista de jugadores de los Chicago Bulls que no inclu√≠a a Michael Jordan.  Seg√∫n las fuentes <sup>[1]</sup> , MJ recibi√≥ su propia licencia y no form√≥ parte del acuerdo que Midway hizo con la NBA. <br><br>  Despu√©s de preguntarle al propietario de la m√°quina, supe que los piratas inform√°ticos lanzaron un mod para SNES "NBA Jam 2K17", que permite que jueguen nuevos jugadores y MJ, pero nadie estaba analizando c√≥mo funcionaba la versi√≥n arcade.  Por lo tanto, definitivamente tuve que mirar dentro. <br><a name="habracut"></a><br><h2>  Antecedentes </h2><br>  La historia del NBA Jam comienza no con el baloncesto, sino con Jean-Claude Van Damme.  Casi al mismo tiempo que se lanz√≥ Universal Soldier, Midway Games desarroll√≥ tecnolog√≠a para manipular sprites fotorrealistas, digitalizados y grandes que conservan un parecido con actores reales.  Fue un gran avance tecnol√≥gico: animaciones con 60 cuadros por segundo, sprites sin precedentes de 100x100 p√≠xeles de tama√±o, cada uno de los cuales ten√≠a su propia paleta de 256 colores. <br><br>  La compa√±√≠a utiliz√≥ esta tecnolog√≠a con gran √©xito en el popular juego de disparos "Terminator 2: Judgment Day" <sup>[2]</sup> , pero no pudo adquirir una licencia para "Universal Soldier" (las condiciones financieras de JCVD ‚Äã‚Äãeran inaceptables para Midway <sup>[3]</sup> ).  Cuando las negociaciones terminaron en un fracaso, Midway cambi√≥ de rumbo y comenz√≥ a desarrollar un mega juego de lucha de Capcom de 1991 llamado Street Fighter II: The World Warrior. <br><br>  Se form√≥ un equipo de cuatro (Ed Boone escribi√≥ el c√≥digo, John Tobias estuvo involucrado en el arte y las secuencias de comandos, John Vogel dibuj√≥ gr√°ficos y Dan Forden era un ingeniero de sonido).  Despu√©s de un a√±o de arduo trabajo <sup>[4]</sup> Midway lanz√≥ Mortal Kombat en 1992. <br><br>  El estilo visual era muy diferente del pixel art habitual, y el dise√±o del juego era, por decir lo menos, "controvertido".  El juego con litros de sangre en la pantalla y empujones incre√≠blemente crueles, la "fatalidad" se convirti√≥ instant√°neamente en un √©xito mundial y gan√≥ casi mil millones de d√≥lares en un a√±o <sup>[5]</sup> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b3b/39e/38c/b3b39e38c2dc236966ea48153bd2c9fc.png"></div><br>  <i>SF2: 384 √ó 224 con 4.096 colores.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8fa/ecc/af5/8faeccaf515916b68f8b63e8a08357e9.png"></div><br>  <i>MK: 400 √ó 254 con 32.768 colores.</i> <br><br>  <u><b>Dato interesante:</b></u> como en el modo VGA 0x13 en PC, en estos juegos los p√≠xeles no eran cuadrados.  Aunque el b√∫fer de cuadros de Mortal Kombat tiene un tama√±o de 400 √ó 254, se extiende a una pantalla CRT de relaci√≥n 4: 3, proporcionando una resoluci√≥n de 400 √ó 300 <sup>[6]</sup> <br><br><h2>  Equipo de unidad T intermedia </h2><br>  El hardware desarrollado por Midway para Mortal Kombat result√≥ ser muy bueno.  Tan bueno que le dieron su propio nombre T-Unit y lo reutilizaron en otros juegos. <br><br><ul><li>  Mortal Kombat. </li><li>  Mortal Kombat II. </li><li>  NBA Jam. </li><li>  NBA Jam Tournament Edition. </li><li>  Juez Dredd (no ha sido puesto en libertad). </li></ul><br>  La unidad T consta de dos tableros.  La mayor√≠a de ellos se ocupa de la l√≥gica y los gr√°ficos del juego. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/753/893/a37/753893a376a67cef13cef49846d2ae82.png" width="100%"></div><br>  <i>Placa de procesador NBA JAM TE Edition (aproximadamente 40x40 cm, o 15 pulgadas).</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/300/f9c/fb4/300f9cfb461f4833a340ad1028f9f389.png" width="55%"></div><br>  La otra placa es menos complicada, pero tambi√©n capaz de mucho.  Est√° dise√±ado para audio, pero puede reproducir no solo m√∫sica usando s√≠ntesis FM, sino tambi√©n sonido digital. <br><br>  La tarjeta de sonido est√° conectada a una fuente de alimentaci√≥n y una tarjeta gr√°fica instalada en la parte posterior.  Presta atenci√≥n al enorme radiador ubicado en la esquina superior izquierda. <br><br>  Juntas, estas dos placas contienen m√°s de doscientos chips, resistencias y EPROM.  Entender todo esto solo sobre la base de los n√∫meros de serie llevar√≠a mucho tiempo.  Pero, sorprendentemente, a veces en dispositivos de los a√±os 90 se descubre accidentalmente documentaci√≥n.  Y en el caso de NBA Jam, ella era simplemente genial. <br><br><h2>  Arquitectura Midway T-Unit </h2><br>  Buscando datos, me encontr√© con un NBA Jam Kit.  El nivel de detalle de este documento es sorprendente <sup>[7]</sup> .  Entre otras cosas, logr√© encontrar una descripci√≥n detallada de las conexiones de cableado, incluidas las EPROM y los chips. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e2/f43/ef7/3e2f43ef76224de29c2376514fdfea3b.jpg" width="100%"></div><br>  La informaci√≥n del documento nos permiti√≥ dibujar un diagrama de los tableros y determinar la funci√≥n de cada parte.  Para ayudar en la b√∫squeda de componentes, el tablero tiene coordenadas con un comienzo en la esquina inferior derecha (UA0), que aumenta a la esquina superior izquierda (UJ26). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/552/c6d/525/552c6d5257527f5a7c8655eb51acfdd9.svg" width="100%"></div><br>  El coraz√≥n de la placa principal es Texas Instrument TMS34010 (UB21) con una frecuencia de 50 MHz y con un c√≥digo de 1 mebibyte en EPROMs y 512 kibibytes DRAM <sup>[8]</sup> .  34010 es un chip de 32 bits con un bus de 16 bits, que tiene instrucciones gr√°ficas tan notables como PIXT y PIXBLT <sup>[9]</sup> .  A principios de los 90, este chip se us√≥ en varias tarjetas de aceleraci√≥n de hardware <sup>[10]</sup> , y pens√© que maneja una cantidad considerable de efectos gr√°ficos.  Sorprendentemente, solo se ocupa de la l√≥gica del juego y no dibuja nada. <br><br>  De hecho, el chip UE13 llamado "DMA2" result√≥ ser un monstruo gr√°fico.  Seg√∫n los diagramas de la documentaci√≥n, tiene un impresionante (en ese momento) bus de datos de 32 bits y bus de direcciones de 32 bits, por lo que se convirti√≥ en el chip m√°s grande de la placa.  Este circuito integrado especializado (ASIC) es capaz de muchas operaciones gr√°ficas, que analizar√© a continuaci√≥n. <br><br>  Todos los chips (RAM del sistema, EPROM GFX, SDRAM de paleta, c√≥digo, bancos de video) se asignan a un espacio de direcciones de 32 bits y se conectan al mismo bus.  No pude encontrar ninguna informaci√≥n sobre el protocolo del bus, por lo que si sabe algo al respecto, escriba al correo electr√≥nico. <br><br>  Preste atenci√≥n a un truco: un componente EPROM (marcado en azul) se usa para crear otro sistema de almacenamiento (y ahorrar dinero).  Estas EPROM de 512 kb tienen pines de direcci√≥n de 32 bits y pines de datos de 8 bits.  Para 34010, que requiere un bus de datos de 16 bits, dos EPROM (J12 y G12) est√°n conectadas con una doble alternancia de direcciones, creando una memoria de 1 mebibyte.  Del mismo modo, los recursos gr√°ficos est√°n conectados con una alternancia cu√°druple de direcciones para formar una direcci√≥n de 32 bits con un sistema de almacenamiento de 32 bits que contiene 8 mebibytes. <br><br>  Aunque en este art√≠culo considerar√© principalmente la tuber√≠a de gr√°ficos, no puedo resistir la tentaci√≥n y, por lo tanto, hablar√© brevemente sobre el sistema de audio. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/26b/07c/c13/26b07cc13020639a04bc7f25b5ef0117.svg" width="55%"></div><br>  El diagrama de la tarjeta de sonido muestra el Motorola 6809 (U4 con una frecuencia de 2 MHz), que recibe instrucciones de una EPROM (U3) para controlar la m√∫sica y los efectos de sonido. <br><br>  El chip de s√≠ntesis FM 2151 de Yamaha (3.5 MHz) genera m√∫sica directamente a partir de las instrucciones recibidas de 6809 (la m√∫sica usa un ancho de banda bastante peque√±o). <br><br>  OKI6295 (1 MHz) es responsable de reproducir audio digital en formato ADPCM (por ejemplo, el legendario "Boomshakalaka" <sup>[11]</sup> Tim Kittsrow). <br><br>  Tenga en cuenta que en la placa principal, la misma EPROM 32a / 8d azul de 512 kbytes se usa en un sistema de 16 bits con doble intercalaci√≥n de direcciones para almacenar voces digitalizadas, pero para las instrucciones de 8 bits, los datos / direcciones de Motorola 6809 no se entrelazan. <br><br><h2>  Vida del marco </h2><br>  Toda la pantalla NBA Jam est√° indexada en una paleta de 16 bits.  Los colores se almacenan en formato xRGB 1555 en una paleta de 64 kbytes.  La paleta se divide en 128 bloques (256 * 16 bits) de 512 bytes.  Los sprites almacenados en EPROM est√°n marcados como "GFX".  Cada sprite tiene su propia paleta de colores de hasta 256x16 bits.  Un sprite a menudo usa un bloque de paleta completo, pero nunca m√°s de uno.  Se transmite una se√±al CRT al monitor utilizando RAMDAC, que para cada p√≠xel lee el √≠ndice de los bancos de DRAM de video y realiza una b√∫squeda de color en la paleta. <br><br>  La vida de cada fotograma de un video de NBA Jam procede de la siguiente manera: <br><br><ol><li>  La l√≥gica del juego consiste en un flujo de instrucciones de 16 bits transmitidas desde J12 / G12 a 34010. </li><li>  34010 lee la entrada del jugador, calcula el estado del juego y luego dibuja una pantalla. </li><li>  Para dibujar en la pantalla, 34010 primero encuentra un bloque no utilizado en la paleta y escribe all√≠ la paleta de sprites (las paletas de sprites se almacenan junto con las instrucciones 34010 en J12 / G12). </li><li>  34010 realiza una solicitud a DMA2, que incluye la direcci√≥n y el tama√±o del sprite, el bloque de paleta de 8 bits utilizado, el truncamiento, el escalado, el m√©todo de procesamiento de p√≠xeles transparentes, etc. </li><li>  DMA2 lee √≠ndices de sprites de 8 bits del chip ROM GFX J14-G23, combina este valor con el √≠ndice de un bloque de paleta de 8 bits y escribe un √≠ndice de 16 bits en bancos de video.  DRAM2 puede considerarse un blitter que lee valores de 8 bits de GFX EPROM y escribe valores de 16 bits en bancos de video </li><li>  Los pasos 3-5 se repiten hasta que se completen todas las solicitudes para dibujar sprites. </li><li>  Cuando se trata de actualizar la pantalla, RAMDAC convierte los datos en los bancos de video en una se√±al que un monitor CRT puede entender.  Para que el ancho de banda sea suficiente para convertir el √≠ndice de 16 bits a RGB de 16 bits, la paleta se almacena en una SRAM extremadamente costosa y extremadamente r√°pida. </li></ol><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f95/cca/564/f95cca564f1eb585bce4cf20470590b1.jpg" width="30%"></div><br>  <u><b>Un hecho interesante: el</b></u> firmware flash EPROM no es un proceso tan simple.  Antes de escribir en el chip, debe borrar completamente todo su contenido. <br><br>  Para hacer esto, el chip debe irradiarse con luz UV.  Primero debe despegar la etiqueta de la parte superior de la EPROM para abrir su diagrama.  Luego, la EPROM se coloca en un dispositivo de borrador especial en el que hay una l√°mpara UV. <br><br>  Despu√©s de 20 minutos, la EPROM se llenar√° con ceros y estar√° lista para grabar. <br><br><h2>  Documentaci√≥n MAME </h2><br>  Despu√©s de descubrir el equipo, me di cuenta de qu√© conjunto de EPROM se pod√≠a escribir a Michael Jordan (la paleta se almacena en las EPROM de c√≥digo y los √≠ndices en las EPROM de GFX).  Sin embargo, todav√≠a no sab√≠a la ubicaci√≥n exacta o el formato utilizado. <br><br>  Falta la documentaci√≥n encontrada en MAME. <br><br>  En caso de que no sepa c√≥mo funciona este incre√≠ble emulador, lo explicar√© brevemente.  MAME se basa en el concepto de "controladores", que son una imitaci√≥n de la placa.  Cada controlador est√° compuesto por componentes que imitan (generalmente) cada chip.  En el caso de Midway T-Unit, estamos interesados ‚Äã‚Äãen los siguientes archivos: <br><br><pre>  mame / incluye / midtunit.h
 mame / src / mame / video / midtunit.cpp
 mame / src / mame / drivers / midtunit.cpp
 mame / src / mame / machine / midtunit.cpp
 cpu / tms34010 / tms34010.h </pre><br>  Si observa drivers / midtunit.cpp, veremos que cada chip de memoria es parte de un √∫nico espacio de direcciones de 32 bits.  Se puede ver en el c√≥digo fuente del controlador que la paleta comienza en 0x01800000, gfxrom comienza en 0x02000000 y el chip DMA2 comienza en 0x01a80000.  Para seguir la ruta de datos, debemos seguir las funciones de C ++ ejecutadas cuando el objeto de la operaci√≥n de lectura o escritura es la direcci√≥n de memoria. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> midtunit_state::main_map(address_map &amp;<span class="hljs-built_in"><span class="hljs-built_in">map</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>.unmap_value_high(); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x00000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x003fffff</span></span>).rw(m_video, FUNC(midtunit_vram_r), FUNC(midtunit_vram_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x013fffff</span></span>).ram(); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01400000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0141ffff</span></span>).rw(FUNC(midtunit_cmos_r), FUNC(midtunit_cmos_w)).share(<span class="hljs-string"><span class="hljs-string">"nvram"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01480000</span></span>, <span class="hljs-number"><span class="hljs-number">0x014fffff</span></span>).w(FUNC(midtunit_cmos_enable_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01600000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0160000f</span></span>).portr(<span class="hljs-string"><span class="hljs-string">"IN0"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01600010</span></span>, <span class="hljs-number"><span class="hljs-number">0x0160001f</span></span>).portr(<span class="hljs-string"><span class="hljs-string">"IN1"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01600020</span></span>, <span class="hljs-number"><span class="hljs-number">0x0160002f</span></span>).portr(<span class="hljs-string"><span class="hljs-string">"IN2"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01600030</span></span>, <span class="hljs-number"><span class="hljs-number">0x0160003f</span></span>).portr(<span class="hljs-string"><span class="hljs-string">"DSW"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01800000</span></span>, <span class="hljs-number"><span class="hljs-number">0x0187ffff</span></span>).ram().w(m_palette, FUNC(write16)).share(<span class="hljs-string"><span class="hljs-string">"palette"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01a80000</span></span>, <span class="hljs-number"><span class="hljs-number">0x01a800ff</span></span>).rw(m_video, FUNC(midtunit_dma_r), FUNC(midtunit_dma_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01b00000</span></span>, <span class="hljs-number"><span class="hljs-number">0x01b0001f</span></span>).w(m_video, FUNC(midtunit_control_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01d00000</span></span>, <span class="hljs-number"><span class="hljs-number">0x01d0001f</span></span>).r(FUNC(midtunit_sound_state_r)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01d01020</span></span>, <span class="hljs-number"><span class="hljs-number">0x01d0103f</span></span>).rw(FUNC(midtunit_sound_r), FUNC(midtunit_sound_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01d81060</span></span>, <span class="hljs-number"><span class="hljs-number">0x01d8107f</span></span>).w(<span class="hljs-string"><span class="hljs-string">"watchdog"</span></span>, FUNC(watchdog_timer_device::reset16_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x01f00000</span></span>, <span class="hljs-number"><span class="hljs-number">0x01f0001f</span></span>).w(m_video, FUNC(midtunit_control_w)); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x02000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x07ffffff</span></span>).r(m_video, FUNC(midtunit_gfxrom_r)).share(<span class="hljs-string"><span class="hljs-string">"gfxrom"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0x1f800000</span></span>, <span class="hljs-number"><span class="hljs-number">0x1fffffff</span></span>).rom().region(<span class="hljs-string"><span class="hljs-string">"maincpu"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* mirror used by MK*/</span></span> <span class="hljs-built_in"><span class="hljs-built_in">map</span></span>(<span class="hljs-number"><span class="hljs-number">0xff800000</span></span>, <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span>).rom().region(<span class="hljs-string"><span class="hljs-string">"maincpu"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br>  Al final del mismo archivo "drivers / midtunit.cpp", vemos c√≥mo los contenidos de las EPROM se cargan en la RAM.  En el caso de los recursos gr√°ficos "gfxrom" (asociados con la direcci√≥n 0x02000000), podemos ver que abarcaron 8 mebibytes de espacio de direcciones en bloques de chips con alternancia cu√°druple de direcciones.  Tenga en cuenta que los nombres de los archivos corresponden a la ubicaci√≥n de los chips (por ejemplo, UJ12 / UG12).  El conjunto de estos archivos EPROM en el mundo de los emuladores se conoce mejor como "ROM". <br><br><pre> <code class="cpp hljs">ROM_START( nbajamte ) ROM_REGION( <span class="hljs-number"><span class="hljs-number">0x50000</span></span>, <span class="hljs-string"><span class="hljs-string">"adpcm:cpu"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/* sound CPU*/</span></span> ROM_LOAD( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_u3_sound_rom.u3"</span></span>, <span class="hljs-number"><span class="hljs-number">0x010000</span></span>, <span class="hljs-number"><span class="hljs-number">0x20000</span></span>, NO_DUMP) ROM_RELOAD( <span class="hljs-number"><span class="hljs-number">0x030000</span></span>, <span class="hljs-number"><span class="hljs-number">0x20000</span></span> ) ROM_REGION( <span class="hljs-number"><span class="hljs-number">0x100000</span></span>, <span class="hljs-string"><span class="hljs-string">"adpcm:oki"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/* ADPCM*/</span></span> ROM_LOAD( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_u12_sound_rom.u12"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_u13_sound_rom.u13"</span></span>, <span class="hljs-number"><span class="hljs-number">0x080000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_REGION16_LE( <span class="hljs-number"><span class="hljs-number">0x100000</span></span>, <span class="hljs-string"><span class="hljs-string">"maincpu"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-comment"><span class="hljs-comment">/* 34010 code*/</span></span> ROM_LOAD16_BYTE( <span class="hljs-string"><span class="hljs-string">"l4_nba_jam_tournament_game_rom_uj12.uj12"</span></span>, <span class="hljs-number"><span class="hljs-number">0x00000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD16_BYTE( <span class="hljs-string"><span class="hljs-string">"l4_nba_jam_tournament_game_rom_ug12.ug12"</span></span>, <span class="hljs-number"><span class="hljs-number">0x00001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_REGION( <span class="hljs-number"><span class="hljs-number">0xc00000</span></span>, <span class="hljs-string"><span class="hljs-string">"gfxrom"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug14.ug14"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj14.uj14"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug19.ug19"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000002</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj19.uj19"</span></span>, <span class="hljs-number"><span class="hljs-number">0x000003</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug16.ug16"</span></span>, <span class="hljs-number"><span class="hljs-number">0x200000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj16.uj16"</span></span>, <span class="hljs-number"><span class="hljs-number">0x200001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug20.ug20"</span></span>, <span class="hljs-number"><span class="hljs-number">0x200002</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj20.uj20"</span></span>, <span class="hljs-number"><span class="hljs-number">0x200003</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug17.ug17"</span></span>, <span class="hljs-number"><span class="hljs-number">0x400000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj17.uj17"</span></span>, <span class="hljs-number"><span class="hljs-number">0x400001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug22.ug22"</span></span>, <span class="hljs-number"><span class="hljs-number">0x400002</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj22.uj22"</span></span>, <span class="hljs-number"><span class="hljs-number">0x400003</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug18.ug18"</span></span>, <span class="hljs-number"><span class="hljs-number">0x600000</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj18.uj18"</span></span>, <span class="hljs-number"><span class="hljs-number">0x600001</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_ug23.ug23"</span></span>, <span class="hljs-number"><span class="hljs-number">0x600002</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_LOAD32_BYTE( <span class="hljs-string"><span class="hljs-string">"l1_nba_jam_tournament_game_rom_uj23.uj23"</span></span>, <span class="hljs-number"><span class="hljs-number">0x600003</span></span>, <span class="hljs-number"><span class="hljs-number">0x80000</span></span>, NO_DUMP) ROM_END</code> </pre> <br>  <b><u>Un hecho interesante:</u></b> en el ejemplo de c√≥digo anterior, el √∫ltimo par√°metro de la funci√≥n se reemplaz√≥ con "NO_DUMP" para poder cargar las EPROM modificadas.  Estos campos suelen ser <sup>[12]</sup> un hash CRC / SHA1 del contenido de la EPROM.  As√≠ es como MAME determina qu√© juego pertenece a la ROM y le permite saber que una de las ROM del conjunto falta o est√° da√±ada. <br><br><h2>  Motor de video del coraz√≥n: DMA2 </h2><br>  La clave para comprender el formato gr√°fico es la funci√≥n que procesa la escritura / lectura de DMA en 256 registros DMA2, ubicados en direcciones de 0x01a80000 a 0x01a800ff.  Los desarrolladores de MAME ya han hecho todo el trabajo duro de la ingenier√≠a inversa.  Incluso se tomaron el tiempo para documentar excelentemente el formato del comando. <br><br><pre>  Registros DMA
  ------------------

   Registrarse |  Bit |  Solicitud
  ---------- + - FEDCBA9876543210 - + ------------
      0 |  xxxxxxxx -------- |  p√≠xeles descartados al comienzo de cada fila
            El |  -------- xxxxxxxx |  p√≠xeles descartados al final de cada fila
      1 |  x --------------- |  habilitar la grabaci√≥n (o borrar si es cero)
            El |  -421 ------------ |  im√°genes bpp (0 = 8)
            El |  ---- 84 ---------- |  tama√±o de pase despu√©s de = (1 &lt;&lt; x)
            El |  ------ 21 -------- |  tama√±o de pase hasta = (1 &lt;&lt; x)
            El |  -------- 8 ------- |  habilitar omitir antes / despu√©s
            El |  --------- 4 ------ |  habilitar el truncamiento
            El |  ---------- 2 ----- |  y reflejando
            El |  ----------- 1 ---- |  x reflejo
            El |  ------------ 8 --- |  transferir p√≠xeles distintos de cero como colores
            El |  ------------- 4-- |  transmitiendo cero p√≠xeles como colores
            El |  -------------- 2- |  transmisi√≥n de p√≠xeles distintos de cero
            El |  --------------- 1 |  transmisi√≥n de cero p√≠xeles
      2 |  xxxxxxxxxxxxxxxx |  direcci√≥n de origen palabra baja
      3 |  xxxxxxxxxxxxxxxx |  direcci√≥n de origen de palabra alta
      4 |  ------- xxxxxxxxx |  x destinatario
      5 |  ------- xxxxxxxxx |  y destinatario
      6 |  ------ xxxxxxxxxx |  columnas de imagen
      7 |  ------ xxxxxxxxxx |  lineas de imagen
      8 |  xxxxxxxxxxxxxxxx |  paleta
      9 |  xxxxxxxxxxxxxxxx |  color
     10 |  --- xxxxxxxxxxxxx |  escala x
     11 |  --- xxxxxxxxxxxxx |  escala y
     12 |  ------- xxxxxxxxx |  Recorte superior / izquierda
     13  ------- xxxxxxxxx |  Recorte inferior / derecha
     14  ---------------- |  la prueba
     15 |  xxxxxxxx -------- |  byte de detecci√≥n cero
            El |  -------- 8 ------- |  p√°gina adicional
            El |  --------- 4 ------ |  tama√±o del destinatario
            El |  ---------- 2 ----- |  selecci√≥n del borde superior / inferior o izquierdo / derecho para el registro 12/13 </pre><br>  Incluso hay una funci√≥n de depuraci√≥n que le permite guardar los sprites originales en el proceso de transferirlos a DMA2 (la funci√≥n fue escrita por un participante de mucho tiempo en el proyecto MAME, Ryan Holtz <sup>[13]</sup> ).  Fue suficiente para m√≠ simplemente jugar el juego para que todos los archivos con metadatos se guardaran en el disco. <br><br>  Result√≥ que los sprites est√°n formados por elementos simples de una paleta de 16 bits sin compresi√≥n.  Sin embargo, no todos los sprites tienen el mismo n√∫mero de colores.  Algunos sprites usan solo 16 colores con √≠ndices de color de 4 bits, mientras que otros usan 256 colores y requieren √≠ndices de color de 8 bits. <br><br><h2>  Parche </h2><br>  Ahora s√© la ubicaci√≥n y el formato de los sprites, por lo que queda por realizar la cantidad m√≠nima de ingenier√≠a inversa.  Escrib√≠ un peque√±o programa en Golang para eliminar la alternancia de EPROM "c√≥digo" y "gfx".  Al eliminar las rayas, es f√°cil buscar ASCII o valores conocidos, porque trabaj√© exactamente con el aspecto de RAM durante la ejecuci√≥n del programa. <br><br>  Despu√©s de eso, puedes encontrar f√°cilmente las caracter√≠sticas del jugador.  Result√≥ que todos estaban almacenados uno tras otro en un formato big-endian sin signo de 16 bits (lo cual es muy l√≥gico, porque 34010 funciona con big-endian).  Agregu√© un parche para modificar los atributos del jugador.  No estoy realmente interesado en el baloncesto, ingres√© SPEED = 9, 3 PTS = 9, DUNKS = 9, PASS = 9, POWER = 9, STEAL = 9, BLOCK = 9 y CLTCH = 9. <br><br>  Tambi√©n escrib√≠ el c√≥digo para parchar el juego con nuevos sprites con la √∫nica restricci√≥n: los nuevos sprites deben tener el mismo tama√±o que los reemplazables.  Para la foto de MJ, cre√© un PNG indexado de 256 colores (puede verlo <a href="">aqu√≠</a> ). <br><br>  Finalmente, agregu√© c√≥digo para convertir el formato intermedio al formato intercalado para escribir en archivos EPROM individuales. <br><br><h2>  Comienza el juego </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ca2/427/e60/ca2427e606192878c8c2a116b73e821e.png" width="49%"></div><br>  Despu√©s de parchear el contenido de la EPROM, la herramienta de diagn√≥stico NBAJam mostr√≥ que el contenido de algunos chips est√° marcado como "MALO".  Lo esperaba porque solo parche√© el contenido de las EPROM, pero no me molest√© en buscar el formato CRC e incluso su ubicaci√≥n de almacenamiento. <br><br>  Las EPROM GFX est√°n marcadas en rojo (UG16 / UJ16, UG17 / UJ17, UG18 / UJ18, UG20 / UJ20, UG22 / UJ22 y UG23 / UJ23), porque contienen im√°genes que cambi√©.  Las dos EPROM en las que se almacenan las instrucciones (UG12 y UJ12) tambi√©n son rojas, porque hay paletas. <br><br>  Afortunadamente, aqu√≠ los CRC no se usan para proteger contra el contenido modificado y solo son necesarios para verificar la integridad de los chips.  El juego ha comenzado.  Y ganado! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e0e/341/ad0/e0e341ad08eaace26ce47cae7a7758cb.png" width="100%"></div><br><h2>  Hasta La Vista, beb√©! </h2><hr><br>  Al terminar con dificultades t√©cnicas, r√°pidamente perd√≠ inter√©s en la herramienta y dej√© de desarrollarla.  Ideas para aquellos que quieren jugar con el c√≥digo: <br><br><ul><li>  A√±adir a la Conferencia Este Toronto Raptors. </li><li>  Agregue la capacidad de cambiar los nombres de los jugadores.  Desafortunadamente, no consisten en ASCII, sino que son im√°genes pregeneradas. </li></ul><br><h2>  Libro sobre NBA Jam </h2><br>  Si eres fan√°tico de la NBA Jam, entonces Reyan Ali escribi√≥ un libro completo sobre ella <sup>[14]</sup> .  Puedes comprarlo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br><h2>  C√≥digo fuente </h2><br>  Si desea contribuir o simplemente ver c√≥mo funciona todo, entonces la fuente completa se carga en github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br><h2>  Referencias </h2><br>  [1] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">'NJA Jam' de Reyan Ali</a> <br><br>  [2] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">'NJA Jam' de Reyan Ali</a> <br><br>  [3] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">'NJA Jam' de Reyan Ali</a> <br><br>  [4] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mortal Kombat 1 Detr√°s de escena</a> <br><br>  [5] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">'NJA Jam' de Reyan Ali</a> <br><br>  [6] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">4: 3 versus p√≠xeles cuadrados</a> <br><br>  [7] Comentario: Desafortunadamente, la era de tan excelente documentaci√≥n ha pasado mucho tiempo <br><br>  [8] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pantalla de inicio de Mame NBA Jam</a> <br><br>  [9] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">conjunto de instrucciones TMS34010</a> <br><br>  [10] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Gu√≠a del usuario de T34010</a> <br><br>  [11] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NBA Jam - video de BoomShakaLaka</a> <br><br>  [12] Fuente: <a href="">MAME T-Unit driver.cpp</a> <br><br>  [13] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Commit 'midtunit.cpp: se agreg√≥ un visor opcional DMA-blitter'</a> <br><br>  [14] Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">'NBA JAM Book' por Reyan Ali</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/473660/">https://habr.com/ru/post/473660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../473648/index.html">El caballo est√° muerto - llora: transici√≥n de tslint a eslint</a></li>
<li><a href="../473652/index.html">Crear una API REST con Node.js y una Base de datos Oracle. Parte 5</a></li>
<li><a href="../473654/index.html">PHP Composer: arregla las dependencias sin dolor</a></li>
<li><a href="../473656/index.html">Experiencia de generador de sitio est√°tico de Hugo</a></li>
<li><a href="../473658/index.html">Manejo de errores en Go 1.13</a></li>
<li><a href="../473664/index.html">Experiencia de aprendizaje de primera mano. Yandex.Practicum - Analista de datos</a></li>
<li><a href="../473666/index.html">Como escritor de ciencia ficci√≥n, Arthur Clark casi cierra la revista Tech - Youth</a></li>
<li><a href="../473668/index.html">Por qu√© Bitrix - Bitrix</a></li>
<li><a href="../473670/index.html">Stoloto: como presentar un m√≥vil a la loter√≠a</a></li>
<li><a href="../473672/index.html">¬øPor qu√©, Bitrix? O el mundo de las hadas 1C</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>