<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèπ üë©‚Äçüé® ‚ò™Ô∏è √âcrire des milliards de chansons avec C # et Deep Learning üÜì ‚≠êÔ∏è üë®‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je vais expliquer comment cr√©er un site Web ASP.NET Core , qui utilise l'IA pour g√©n√©rer des paroles de chansons uniques en un seul ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√âcrire des milliards de chansons avec C # et Deep Learning</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453232/">  Dans cet article, je vais expliquer comment cr√©er un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">site Web ASP.NET Core</a> , qui utilise l'IA pour g√©n√©rer des paroles de chansons uniques en un seul clic, et permet aux utilisateurs de voter pour les meilleures chansons. <br><a name="habracut"></a><br><h1>  Le r√©seau neuronal </h1><br>  Il y a environ 2,5 mois, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">OpenAI a</a> publi√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">un article de blog</a> , o√π ils ont d√©montr√© presque impossible: un mod√®le d'apprentissage en profondeur, qui peut √©crire des articles, indiscernables de ceux √©crits par des humains.  Le texte qu'il a g√©n√©r√© √©tait si impressionnant, que j'ai d√ª v√©rifier le calendrier pour m'assurer que ce n'√©tait pas une blague de poisson d'avril (rappelez-vous que c'√©tait en f√©vrier et que Seattle √©tait couverte de neige). <br><br><p><img src="https://habrastorage.org/webt/df/ok/nc/dfoknc5wbfxrkyvigyygtz9kctw.png" alt="Exemple de texte GPT-2"></p><br><p> Ils n'ont pas publi√© le plus grand r√©seau de neurones avec plus d'un milliard de param√®tres qu'ils ont construits √† ce jour (une d√©cision tr√®s controvers√©e), mais ils ont ouvert une version plus petite de 117 millions de param√®tres <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">sur GitHub</a> sous licence MIT.  Le mod√®le porte un nom tr√®s inoubliable: <b>GPT-2</b> . </p><br><p>  Il y a environ un mois, alors que j'essayais de penser au projet cool que je pouvais faire avec TensorFlow, ce r√©seau est devenu le point de d√©part.  S'il pouvait d√©j√† g√©n√©rer du texte anglais, il n'aurait pas d√ª √™tre trop difficile de le <i>r√©gler</i> avec pr√©cision pour g√©n√©rer les paroles des chansons, s'il existe un ensemble de donn√©es suffisamment volumineux. </p><br><h2>  Comment fonctionne GPT-2? </h2><br><p>  Il existe plusieurs r√©alisations importantes dans la recherche sur l'apprentissage en profondeur, qui ont rendu possible le GPT-2: </p><br><h3>  Apprentissage auto-supervis√© </h3><br><p>  Cette technique a obtenu son nom finalis√© par Yan LeCunn quelques jours seulement apr√®s avoir √©crit la premi√®re version de cet article.  C'est une technique tr√®s puissante, qui peut √™tre appliqu√©e √† pratiquement n'importe quel type de donn√©es du monde r√©el.  Pour former GPT-2, OpenAI a collect√© des <i>dizaines de gigaoctets d'articles</i> provenant de diverses sources, qui ont √©t√© vot√©s sur Reddit. </p><br><p>  Classiquement, il faudrait avoir un √™tre humain pour parcourir tous ces articles et, par exemple, les marquer comme ¬´positifs¬ª ou ¬´n√©gatifs¬ª.  Ensuite, ils enseigneraient un r√©seau de neurones de mani√®re supervis√©e pour classer ces articles de la m√™me mani√®re qu'un humain. </p><br><p><img src="https://habrastorage.org/webt/cn/sl/_2/cnsl_21o1f-vio39rn5auufl_lw.jpeg" alt="RECAPTCHA: trouver des signes stree"></p><br><p>  La nouvelle id√©e ici est que pour cr√©er un mod√®le d'apprentissage en profondeur, qui a une compr√©hension de haut niveau de vos donn√©es, vous corrompez simplement les donn√©es et chargez le mod√®le de restaurer l'original.  Cela permet au mod√®le de comprendre les connexions entre les √©l√©ments de donn√©es et leurs contextes environnants. </p><br><p>  Prenons le texte comme exemple.  GPT-2 prend un √©chantillon du texte d'origine, s√©lectionne 15% des jetons √† corrompre, puis en masque 80% (par exemple, remplace par un jeton de masque sp√©cial, g√©n√©ralement ___), remplace 10% par un autre jeton al√©atoire du dictionnaire, et conserve les 10% restants intacts.  Prenez <i>j'ai lanc√© une balle et elle est tomb√©e dans l'herbe</i> .  Apr√®s la corruption, cela pourrait ressembler √† ceci: <i>j'ai jet√© une balle de voiture et ___ dans l'herbe</i> .  En termes simples, pour que le r√©seau r√©tablisse l'original, il doit apprendre que quelque chose sera probablement tomb√© et que la balle de voiture est quelque chose de tr√®s rare dans le contexte. </p><br><p>  Un mod√®le form√© comme √ßa est bon pour g√©n√©rer / compl√©ter des donn√©es partielles, mais les fonctionnalit√©s de haut niveau qu'il a apprises (en tant que sorties de couches internes) peuvent √™tre utilis√©es √† d'autres fins en ajoutant une couche ou deux au-dessus et en affinant <b>seulement cette nouvelle derni√®re couche</b> sur un ensemble de donn√©es r√©el, <b>plus petit</b> et marqu√© par l'homme d'une mani√®re conventionnelle. </p><br><h3>  Peu d'attention </h3><br><p>  GPT-2 utilise ce que l'on appelle l'auto-attention clairsem√©e.  En substance, c'est une technique qui permet au r√©seau de neurones traitant de grandes entr√©es de se concentrer sur certaines parties de celui-ci plus que sur d'autres.  Et le r√©seau apprend o√π il doit ¬´regarder¬ª pendant la formation.  Le m√©canisme d'attention est mieux expliqu√© dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ce billet de blog</a> . </p><br><p>  La partie <i>clairsem√©e</i> du titre de cette section fait r√©f√©rence √† une restriction sur les segments d'entr√©e dans lesquels le m√©canisme d'attention peut choisir.  L'attention initiale pourrait choisir parmi l'ensemble de l'entr√©e.  Cela a provoqu√© sa matrice de poids √† O (input_size ^ 2), qui cro√Æt tr√®s rapidement avec la taille de l'entr√©e.  Une attention limit√©e restreint g√©n√©ralement cela d'une certaine mani√®re.  Pour plus d'informations √† ce sujet, consultez un autre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">article de blog OpenAI</a> . </p><br><p>  L'attention dans GPT-2 est <i>multi-t√™te</i> .  Imaginez que vous puissiez avoir un ou deux yeux suppl√©mentaires que vous pourriez utiliser pour v√©rifier ce qui √©tait dans le dernier paragraphe sans arr√™ter la lecture de l'actuel. </p><br><h3>  Beaucoup plus </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Connexions r√©siduelles</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">codage de paire d'octets</a> , pr√©diction de la phrase suivante et bien d'autres. </p><br><h2>  Portage de GPT-2 (et conversion de Python en g√©n√©ral) </h2><br><p>  Le code du mod√®le d'origine est en Python, mais je suis un gars C #.  Heureusement, le code source est assez lisible, et le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">n≈ìud de celui</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">ci</a> est en seulement 5 fichiers, peut-√™tre 500 lignes au total.  J'ai donc cr√©√© un nouveau projet .NET Standard, install√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Gradient</a> (une liaison TensorFlow pour .NET) et converti ces fichiers ligne par ligne en C #.  Cela m'a pris environ 2 heures.  La seule chose pythonique restante dans le code √©tait l'utilisation du module regex Python de pip (le gestionnaire de packages le plus couramment utilis√© pour Python), car je ne voulais pas perdre de temps √† apprendre les subtilit√©s des expressions r√©guli√®res Python ( <i>comme si cela ne suffisait pas). pour traiter d√©j√† ceux .NET</i> ). </p><br><p>  La conversion consistait principalement √† d√©finir des classes similaires, √† ajouter des types et √† r√©√©crire les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">compr√©hensions de liste</a> Python dans les constructions LINQ correspondantes.  En plus de LINQ de la biblioth√®que standard, j'ai utilis√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">MoreLinq</a> , qui √©tend l√©g√®rement ce que LINQ peut faire. Par exemple: </p><br><p></p><pre><code class="python hljs">bs = list(range(ord(<span class="hljs-string"><span class="hljs-string">"!"</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"~"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)) + list(range(ord(<span class="hljs-string"><span class="hljs-string">"¬°"</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"¬¨"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)) + list(range(ord(<span class="hljs-string"><span class="hljs-string">""</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"√ø"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br><p>  transform√© en: </p><br><p></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bs = Range(<span class="hljs-string"><span class="hljs-string">'!'</span></span>, <span class="hljs-string"><span class="hljs-string">'~'</span></span> - <span class="hljs-string"><span class="hljs-string">'!'</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>) .Concat(Range(<span class="hljs-string"><span class="hljs-string">'¬°'</span></span>, <span class="hljs-string"><span class="hljs-string">'¬¨'</span></span> -<span class="hljs-string"><span class="hljs-string">'¬°'</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>)) .Concat(Range(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'√ø'</span></span> - <span class="hljs-string"><span class="hljs-string">''</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>)) .ToList();</code> </pre> <br><p>  Une autre chose avec laquelle je devais me battre √©tait une divergence entre la fa√ßon dont Python g√®re les plages et les nouvelles fonctionnalit√©s des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">plages et des index</a> dans le prochain C # 8, que j'ai d√©couvert lors du d√©bogage de mes ex√©cutions initiales: en C # 8, la fin de la plage est <b>inclusive</b> , tandis qu'en Python il est <b>exclusif</b> (pour inclure le tout dernier √©l√©ment en Python, vous devez omettre le c√¥t√© droit de <i>..</i> expression). </p><br><blockquote>  Il y a deux choses difficiles en informatique: l'invalidation du cache, le nommage des choses et les erreurs ponctuelles. </blockquote><br><p>  Malheureusement, le drop source d'origine ne contenait aucune formation ni m√™me de code de r√©glage fin, mais <b>Neil Shepperd a</b> fourni un simple r√©glage fin sur son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">GitHub</a> , que je devais √©galement porter.  Quoi qu'il en soit, le r√©sultat de cet effort est un <b>code C #</b> , qui peut √™tre utilis√© <b>pour jouer avec GPT-2</b> , fait maintenant partie du r√©f√©rentiel des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">√©chantillons</a> de d√©grad√©. </p><br><p>  Le but de l'exercice de portage est double: apr√®s le portage, on peut <b>jouer avec le code du mod√®le dans son IDE C # pr√©f√©r√©</b> et montrer <b>qu'il est d√©sormais possible d'obtenir des mod√®les d'apprentissage en profondeur de pointe fonctionnant en mode personnalis√©. Les projets .NET</b> peu de temps apr√®s la sortie (entre la chute de code de GPT-2 et la premi√®re version de Billion Songs - un peu plus d'un mois). </p><br><h2>  Affiner les paroles des chansons </h2><br><p>  Il existe plusieurs fa√ßons d'obtenir un grand corpus de paroles de chansons.  Vous pouvez gratter l'un des sites Internet qui l'h√©bergent avec un analyseur HTML, le retirer de votre collection de karaok√© ou des fichiers mp3.  Heureusement, quelqu'un l'a fait pour nous.  J'ai trouv√© pas mal de jeux de donn√©es de paroles pr√©par√©s sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Kaggle</a> .  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Chaque chanson que vous avez entendue</a> ¬ª semblait √™tre la plus importante.  En essayant d'affiner GPT-2, j'ai rencontr√© deux probl√®mes. </p><br><h3>  Lecture CSV </h3><br><p>  Oui, vous l'avez lu correctement, l' <i>analyse CSV √©tait un probl√®me</i> .  Au d√©part, je voulais utiliser ML.NET, la nouvelle biblioth√®que Microsoft pour l'apprentissage automatique, pour lire le fichier.  Cependant, apr√®s avoir parcouru la documentation et l'avoir configur√©e, je me suis rendu compte qu'elle ne pouvait pas traiter correctement les sauts de ligne dans les chansons.  Peu importe ce que j'ai fait, il a eu du mal apr√®s quelques centaines d'exemples et a commenc√© √† m√©langer des morceaux de paroles avec des titres et des artistes. </p><br><p>  J'ai donc d√ª recourir √† une biblioth√®que de niveau inf√©rieur, avec laquelle j'avais auparavant une meilleure exp√©rience: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">CsvHelper</a> .  Il fournit une interface de type <i>DataReader</i> .  Vous pouvez voir le code en l'utilisant <a href="" rel="nofollow">ici</a> .  Essentiellement, vous ouvrez un fichier, configurez un <i>CsvReader</i> , puis entrelacez l'appel √† <i>.Read ()</i> avec les appels √† <i>.GetField (fieldName)</i> . </p><br><h3>  Chansons courtes </h3><br><p>  La plupart des chansons sont courtes par rapport √† un article moyen du jeu de donn√©es original utilis√© par OpenAI.  La formation GPT-2 est plus efficace sur de gros morceaux de texte, j'ai donc d√ª regrouper plusieurs chansons en morceaux de texte continus pour les transmettre au formateur.  OpenAI semblait √©galement utiliser cette technique, ils ont donc eu un jeton sp√©cial <i>&lt;| endoftext |&gt;</i> , qui agit comme un s√©parateur entre les textes complets au sein d'un morceau, et sert √©galement de jeton de d√©but.  J'ai regroup√© des chansons jusqu'√† ce qu'un certain nombre de jetons soit atteint, puis j'ai renvoy√© le morceau entier √† inclure dans les donn√©es d'entra√Ænement.  Le code correspondant est <a href="" rel="nofollow">ici</a> . </p><br><h3>  Configuration mat√©rielle requise pour le r√©glage </h3><br><p>  M√™me la version plus petite de GPT-2 est grande.  Avec <b>12 Go de RAM GPU,</b> je ne pouvais <b>que d√©finir la taille du lot √† 2</b> (par exemple, former sur deux morceaux √† la fois, des tailles de lot plus grandes am√©liorent les performances du GPU et les r√©sultats de la formation).  3 jetterait <i>de m√©moire</i> dans CUDA.  Et il a fallu une demi-journ√©e pour r√©gler les performances souhait√©es sur mon V100.  Le bonus est que vous pouvez voir la progression, car de temps en temps le code de formation g√©n√®re des √©chantillons g√©n√©r√©s, qui commencent sous forme de texte simple et ressemblent de plus en plus aux paroles des chansons au fur et √† mesure que la formation progresse. </p><br><p>  Je ne l'ai pas essay√©, mais la <b>formation sur le CPU sera probablement tr√®s lente</b> . </p><br><h3>  Mod√®le pr√©-r√©gl√© </h3><br><p>  Alors que je pr√©parais ce billet de blog, j'ai r√©alis√© qu'il valait mieux ne pas forcer tout le monde √† passer des heures √† affiner le <b>mod√®le des</b> <b>paroles</b> , j'ai donc <b>publi√© un</b> <b>pr√©-r√©gl√©</b> sur le <a href="" rel="nofollow">r√©f√©rentiel Billion Songs</a> .  Si vous essayez simplement d'ex√©cuter Billion Songs, vous n'avez m√™me pas besoin de le t√©l√©charger manuellement.  Le projet le fera par d√©faut pour vous. </p><br><div class="spoiler">  <b class="spoiler_title">mannequin semi-form√© jouant HAL9000 sur moi</b> <div class="spoiler_text">  Je te jure, je suis cens√© t'√©crire <br>  Et je te jure, je jure <br>  Tu l'as ruin√© maintenant, j'esp√®re que tu y arriveras <br>  Et j'esp√®re que tu r√™ves, j'esp√®re que tu r√™ves, j'esp√®re que tu r√™ves J'esp√®re que tu r√™ves J'esp√®re que tu r√™ves <br>  √Ä propos <br>  ce que je vais.  Je m'en vais.  Je m'en vais.  Je vais, je vais, je vais, je vais, je vais, je vais, je vais, <br>  Je vais, je vais, je vais ... </div></div><br><h1>  Cr√©er un site Web </h1><br><p>  OK!  Cela ressemble √† une chanson (en quelque sorte), faisons maintenant un site web! </p><br><p>  Comme je ne pr√©vois pas de fournir d'API, je choisis le mod√®le Razor Pages par opposition √† MVC.  J'ai √©galement activ√© l'autorisation, car nous autoriserons les utilisateurs √† voter pour les meilleures paroles et √† avoir un top 10. </p><br><p>  En pr√©cipitant le MVP, je suis all√© de l'avant et j'ai cr√©√© une page Web Song.cshtml, dont l'objectif pour l'instant sera d'appeler simplement GPT-2 et d'obtenir une chanson au hasard.  La mise en page de la page est triviale et se compose essentiellement de la chanson et de son titre: </p><br><pre> <code class="xml hljs">@page "/song/{id}" @model BillionSongs.Pages.SongModel<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @{ ViewData["Title"] = @Model.Song.Title ?? "Untitled"; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">article</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align: center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>@(Model.Song.Title ?? "Untitled")<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span>@Model.Song.Lyrics<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">article</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><p>  Maintenant parce que j'aime mon code r√©utilisable, j'ai cr√©√© une interface, qui me permettra de brancher diff√©rents g√©n√©rateurs de paroles plus tard, qui seront inject√©s par ASP.NET dans SongModel. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ILyricsGenerator</span></span> { <span class="hljs-function"><span class="hljs-function">Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateLyrics</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> song, CancellationToken cancellation</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><p>  En omettant le titre du morceau pour l'instant, tout ce que nous devons faire est d'enregistrer <i>Gpt2LyricsGenerator</i> dans le <i>d√©marrage, de configurer les services</i> et de l'appeler √† partir du <i>SongModel</i> .  Commen√ßons donc par le g√©n√©rateur.  Et la premi√®re chose que nous devons nous assurer, c'est que nous avons </p><br><h2>  G√©n√©ration de paroles r√©p√©tables </h2><br><p>  Parce que j'ai fait une d√©claration audacieuse dans le titre, qu'il va y avoir plus d'un milliard de chansons, ne pensez m√™me pas √† les g√©n√©rer et √† les stocker toutes.  Tout d'abord, sans m√©tadonn√©es, cela prendrait √† lui seul plus de 1 To d'espace disque.  Deuxi√®mement, il faut environ 3 minutes sur mon nettop pour g√©n√©rer une nouvelle chanson, il faudra donc une √©ternit√© pour les g√©n√©rer toutes.  Et je veux pouvoir transformer ce milliard en quintillion en passant √† <i>Int64</i> si n√©cessaire!  Imaginez que nous pourrions faire 1 cent par chanson, sur 1 quintillion de chansons?  Ce serait plus que le PIB annuel mondial actuel! </p><br><p>  Au lieu de cela, ce que nous devons faire est de nous assurer que GPT-2 g√©n√®re encore et encore le m√™me morceau, √©tant donn√© son <i>identifiant</i> , que je sp√©cifie dans l'itin√©raire.  √Ä cet effet, TensorFlow donne la possibilit√© de d√©finir la graine de son g√©n√©rateur de nombres interne √† tout moment via la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">tf.set_random_seed</a> comme ceci: <i>tf.set_random_seed (songNumber)</i> .  Ensuite, je voulais simplement appeler <i>Gpt2Sampler.SampleSequence</i> , pour obtenir le texte du morceau encod√©, le d√©coder et retourner le r√©sultat, compl√©tant ainsi <i>Gpt2LyricsGenerator</i> . </p><br><p>  Malheureusement, au premier essai, cela n'a pas fonctionn√© comme pr√©vu.  Chaque fois que je cliquais sur le bouton d'actualisation, un nouveau texte unique √©tait renvoy√© sur la page.  Apr√®s pas mal de d√©bogage, j'ai finalement d√©couvert que TensorFlow 1.X avait des probl√®mes de reproductibilit√© importants: de nombreuses op√©rations ont des √©tats internes, qui ne sont pas affect√©s par <i>set_random_seed</i> et sont difficiles √† atteindre pour r√©initialiser. </p><br><p>  La r√©initialisation des variables du mod√®le a permis de compenser ce probl√®me, mais a √©galement signifi√© que la session devait √™tre recr√©√©e et que les poids du mod√®le devaient √™tre recharg√©s √† chaque appel.  Le rechargement d'une session de cette taille a provoqu√© une fuite de m√©moire g√©ante.  Pour √©viter de rechercher sa cause dans le code source TensorFlow C ++, au lieu de g√©n√©rer un processus de g√©n√©ration de texte, j'ai d√©cid√© de g√©n√©rer un nouveau processus avec <i>Process.Start</i> , de g√©n√©rer du texte √† cet <i>endroit</i> et de le lire √† partir de la sortie standard.  Jusqu'√† ce qu'un moyen de r√©initialiser l'√©tat du mod√®le dans TensorFlow soit stabilis√©, ce serait la voie √† suivre. </p><br><p>  Je me suis donc retrouv√© avec deux classes: <a href="" rel="nofollow">Gpt2LyricsGenerator</a> , qui impl√©mente <i>ILyricsGenerator</i> d'en haut en <i>g√©n√©rant</i> une nouvelle instance de BillionSongs.exe avec des param√®tres de ligne de commande, qui incluent l'identifiant du morceau, et finalement instancie <a href="" rel="nofollow">Gpt2TextGenerator</a> , qui appelle en fait GPT-2 pour g√©n√©rer des paroles, et l'imprime simplement. </p><br><p>  Maintenant, rafra√Æchir la page m'a toujours donn√© le m√™me texte. </p><br><h2>  G√©rer 3 minutes pour g√©n√©rer une chanson </h2><br><p>  Quelle exp√©rience utilisateur horrible ce serait!  Vous allez sur un site Web, cliquez sur ¬´Cr√©er une nouvelle chanson¬ª, et <b>absolument rien ne se passe pendant 3 (!) Minutes</b> pendant que mon nettop prend son temps pour g√©n√©rer les paroles des chansons que vous avez demand√©es. </p><br><p>  J'ai r√©solu ce probl√®me √† plusieurs niveaux: </p><br><h3>  Chansons pr√©g√©n√©rantes </h3><br><p>  Comme mentionn√© ci-dessus, vous ne pouvez pas pr√©-g√©n√©rer toutes les chansons et les servir √† partir d'une base de donn√©es.  Et vous ne pouvez pas simplement g√©n√©rer √† la demande, car cela ralentit.  Alors, que pouvez-vous faire? </p><br><p>  C'est simple!  √âtant donn√© que le principal moyen pour les utilisateurs de voir une nouvelle chanson est de cliquer sur le bouton ¬´Cr√©er au hasard¬ª, pr√©parons √† l'avance un grand nombre de chansons, les mettons dans une <i>file d'attente simultan√©e</i> et laissons ¬´Make Random¬ª faire appara√Ætre des chansons.  Bien que le nombre de visiteurs soit faible, le serveur mettra du temps entre eux pour g√©n√©rer des chansons, qui seront ensuite facilement accessibles. </p><br><p>  Une autre astuce que j'ai utilis√©e consiste √† boucler cette file d'attente plusieurs fois, afin que de nombreux utilisateurs puissent voir la m√™me chanson pr√©g√©n√©r√©e.  Il suffit de garder un √©quilibre entre l'utilisation de la RAM et le nombre de fois qu'un utilisateur doit cliquer sur ¬´Cr√©er au hasard¬ª pour voir quelque chose qu'il a d√©j√† vu.  J'ai simplement choisi 50 000 chansons comme un nombre raisonnable, ce qui prendrait seulement 50 Mo de RAM, tout en fournissant un assez grand nombre de clics. </p><br><p>  J'ai impl√©ment√© cette fonctionnalit√© dans la classe <a href="" rel="nofollow">PregeneratedSongProvider</a> : <i>IRandomSongProvider</i> (l'interface est inject√©e dans le code, responsable de la gestion du bouton ¬´Make Random¬ª). </p><br><h3>  Mise en cache </h3><br><p>  Les chansons pr√©-g√©n√©r√©es sont mises en cache dans la m√©moire, mais j'ai √©galement d√©fini l'en-t√™te du <i>cache</i> HTTP sur <i>public</i> pour laisser le navigateur, et CDN (j'utilise CloudFlare) le mettre en cache pour √©viter d'√™tre touch√© par un afflux d'utilisateurs. </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ResponseCache(VaryByHeader = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"User-Agent"</span></span></span><span class="hljs-meta">, Duration = 3*60*60)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SongModel</span></span>: <span class="hljs-title"><span class="hljs-title">PageModel</span></span> { ‚Ä¶ }</code> </pre><br><h3>  Retourner des chansons populaires </h3><br><p>  La plupart des chansons g√©n√©r√©es par le GPT-2 affin√© de cette mani√®re sont assez ennuyeuses, sinon rudimentaires.  Pour rendre les clics sur ¬´Make Random¬ª plus attrayants, j'ai ajout√© une probabilit√© de 25%, qu'au lieu d'une chanson compl√®tement al√©atoire, vous obtiendrez une chanson, qui a √©t√© pr√©c√©demment vot√©e par d'autres utilisateurs.  En plus d'augmenter l'engagement, cela augmente les chances que vous demandiez une chanson, mise en cache soit dans le CDN, soit en m√©moire. </p><br><p>  Toutes les astuces ci-dessus sont c√¢bl√©es ensemble √† l'aide de l'injection de d√©pendance ASP.NET dans la classe de <a href="" rel="nofollow">d√©marrage</a> . </p><br><h2>  Vote </h2><br><p>  La mise en ≈ìuvre du vote n'a rien de sp√©cial.  Il y a <a href="" rel="nofollow">SongVoteCache</a> , qui maintient les comptes √† jour.  Et un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">iframe h√©bergeant le bouton de vote</a> sur la page de la chanson, ce qui permet de mettre en cache la partie essentielle de la page - le titre et les paroles, tandis que le d√©compte des votes et le statut de connexion sont charg√©s plus tard. </p><br><h1>  Les r√©sultats finaux </h1><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/aw/c7/wf/awc7wfzablt9gotcrrv8nsihrvu.png" alt="√âchantillon de chanson g√©n√©r√©"></a> <br></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Une version de d√©monstration</a> fonctionnant sur <s>mon nettop, dirig√©e par CloudFlare (donnez-lui du mou, son Core i3) est</s> maintenant fig√©e et d√©plac√©e vers le niveau gratuit d'Azure App Service. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Le r√©f√©rentiel GitHub</a> , contenant le code source et les instructions pour ex√©cuter le site Web et r√©gler le mod√®le. </p><br><h1>  Plans pour l'avenir / exercices </h1><br><h2>  G√©n√©rer des titres </h2><br><p>  GPT-2 est tr√®s facile √† affiner.  On pourrait lui faire g√©n√©rer des titres de chansons en ajoutant ou en suffixant chaque √©chantillon de paroles de l'ensemble de donn√©es avec un jeton artificiel comme <i>&lt;| startoftitle |&gt;</i> , suivi du titre du m√™me ensemble de donn√©es. </p><br><p>  Alternativement, les utilisateurs pourraient √™tre autoris√©s √† sugg√©rer et / ou voter pour des titres. </p><br><h2>  G√©n√©rer de la musique </h2><br><p>  √Ä mi-chemin du d√©veloppement de Billion Songs, j'ai pens√© que ce serait cool de t√©l√©charger un tas de fichiers MIDI (c'est un format de musique old-school, qui est beaucoup plus proche du texte que des mp3), et de former GPT-2 sur eux pour en g√©n√©rer plus .  Certains de ces fichiers avaient m√™me du texte int√©gr√©, <b>vous pouvez donc obtenir la g√©n√©ration de karaok√©</b> . </p><br><p>  Je sais que la g√©n√©ration musicale de cette fa√ßon est tr√®s possible, car hier, <b>OpenAI a en fait publi√© une impl√©mentation de cette id√©e</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">sur son blog</a> .  Mais hourra, <b>ils n'ont pas fait le karaok√©!</b>  J'ai trouv√© qu'il √©tait possible de gratter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">http://www.midi-karaoke.info</a> √† cet effet. </p><br><h2>  Gradient aka TensorFlow pour .NET </h2><br>  Veuillez consulter notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">blog</a> pour toute mise √† jour. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453232/">https://habr.com/ru/post/fr453232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453216/index.html">Syst√®mes de surveillance du trafic dans les r√©seaux VoIP. Deuxi√®me partie - Principes d'organisation</a></li>
<li><a href="../fr453218/index.html">L'essentiel avec YaC 2019: une centaine de drones sur les routes, Yandex.Module, food, smart home</a></li>
<li><a href="../fr453220/index.html">13 erreurs de marketing par courriel √† √©viter pour un meilleur engagement</a></li>
<li><a href="../fr453222/index.html">SphinxSearch-meetup SuperJob</a></li>
<li><a href="../fr453228/index.html">Horloge Nixie sur indicateurs IN-18</a></li>
<li><a href="../fr453234/index.html">R√©tro-ing√©nierie du protocole d'√©change dans les √©quipements EOS</a></li>
<li><a href="../fr453236/index.html">Prototypage d'un jeu mobile, par o√π commencer et comment le faire. 2e partie</a></li>
<li><a href="../fr453238/index.html">Feux de circulation sur relais</a></li>
<li><a href="../fr453242/index.html">Aire de jeux pour les √©v√©nements d'√©t√©</a></li>
<li><a href="../fr453246/index.html">ERP - Syst√®me de d√©gradation continue</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>