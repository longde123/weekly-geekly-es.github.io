<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ≤Ô∏è üêë ü§õüèø Detalles del accidente de Cloudflare 2 de julio de 2019 üìñ ü¶í ü§ì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace casi 9 a√±os, Cloudflare era una peque√±a empresa, pero no trabaj√© en ella, solo era un cliente. Un mes despu√©s de lanzar Cloudflare, recib√≠ una no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Detalles del accidente de Cloudflare 2 de julio de 2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/460863/"><p><img src="https://habrastorage.org/webt/dx/yb/5r/dxyb5rids6_8tahyhactypl4rwm.png"></p><br><p>  Hace casi 9 a√±os, Cloudflare era una peque√±a empresa, pero no trabaj√© en ella, solo era un cliente.  Un mes despu√©s de lanzar Cloudflare, recib√≠ una notificaci√≥n de que DNS no parece estar funcionando en mi sitio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">web</a> jgc.org.  Cloudflare hizo un cambio en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Protocol Buffers</a> y hubo un DNS roto. </p><a name="habracut"></a><br><p>  Inmediatamente le escrib√≠ a Matthew Prince, encabezando la carta "¬øD√≥nde est√° mi DNS?", Y √©l envi√≥ una respuesta larga, llena de detalles t√©cnicos ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lea toda la correspondencia aqu√≠</a> ), a lo que respond√≠: </p><br><blockquote>  De: John Graham Cumming <br>  Fecha: 7 de octubre de 2010 9:14 <br>  Asunto: Re: ¬øD√≥nde est√° mi DNS? <br>  Para: Matthew Prince <br><br>  Buen informe, gracias.  Definitivamente llamar√© si hay problemas.  Probablemente valga la pena escribir una publicaci√≥n sobre esto cuando recopiles toda la informaci√≥n t√©cnica.  Creo que a la gente le gustar√° una historia abierta y honesta.  Especialmente si le adjuntas gr√°ficos para mostrar c√≥mo creci√≥ el tr√°fico despu√©s del lanzamiento. <br><br>  Tengo un buen monitoreo en el sitio y recibo un SMS sobre cada falla.  El monitoreo muestra que la falla fue de 13:03:07 a 14:04:12.  Las pruebas se realizan cada cinco minutos. <br><br>  Estoy seguro de que lo descubrir√°s.  ¬øDefinitivamente no necesitas tu propia persona en Europa?  :-) </blockquote><p>  Y √©l respondi√≥: </p><br><blockquote>  De: Matthew Prince <br>  Fecha: 7 de octubre de 2010, 9:57 <br>  Asunto: Re: ¬øD√≥nde est√° mi DNS? <br>  Para: John Graham Cumming <br><br>  Gracias  Respondimos a todos los que escribieron.  Voy a la oficina ahora, y escribiremos algo en el blog o publicaremos una publicaci√≥n oficial en nuestro tabl√≥n de anuncios.  Estoy completamente de acuerdo, la honestidad es nuestro todo. </blockquote><p>  Ahora Cloudflare es una compa√±√≠a realmente grande, trabajo en ella y ahora tengo que escribir abiertamente sobre nuestro error, sus consecuencias y nuestras acciones. </p><br><h3 id="sobytiya-2-iyulya">  2 de julio eventos </h3><br><p>  El 2 de julio, implementamos una nueva regla en reglas administradas para WAF, debido a qu√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recursos de procesador se agotaron</a> en cada n√∫cleo de procesador que procesa el tr√°fico HTTP / HTTPS en la red Cloudflare en todo el mundo.  Mejoramos constantemente las reglas administradas para WAF en respuesta a nuevas vulnerabilidades y amenazas.  En mayo, por ejemplo, nos apresuramos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">agregar una regla</a> para protegernos de una vulnerabilidad grave en SharePoint.  El objetivo de nuestro WAF es la capacidad de implementar reglas de manera r√°pida y global. </p><br><p>  Desafortunadamente, la actualizaci√≥n del jueves pasado conten√≠a una expresi√≥n regular que gastaba demasiados recursos de procesador dedicados a HTTP / HTTPS en el seguimiento.  Esto afect√≥ nuestras funciones principales de proxy, CDN y WAF.  El gr√°fico muestra que los recursos del procesador para atender el tr√°fico HTTP / HTTPS alcanzan casi el 100% en los servidores de nuestra red. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/au/xp/dz/auxpdz0pbethhc_hka-nvzmmsmo.png"></a> <br>  <em>Usar los recursos del procesador en uno de los puntos de presencia durante un incidente</em> </p><br><p>  Como resultado, nuestros clientes (y los clientes de nuestros clientes) se encontraron con una p√°gina con un error 502 en los dominios de Cloudflare.  Los servidores web front-end Cloudflare generaron 502 errores, que todav√≠a ten√≠an n√∫cleos libres, pero no pudieron contactar con los procesos que procesan el tr√°fico HTTP / HTTPS. </p><br><p><img src="https://habrastorage.org/webt/mn/36/v_/mn36v_x1bbtqofu8l9lzpjty-pm.png"></p><br><p>  Sabemos cu√°ntos inconvenientes esto caus√≥ a nuestros clientes.  Estamos terriblemente avergonzados.  Y esta falla nos impidi√≥ lidiar efectivamente con el incidente. </p><br><p> Si fueras uno de estos clientes, probablemente te asust√≥, enoj√≥ y molest√≥.  Adem√°s, no hemos tenido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fallas globales</a> durante 6 a√±os.  El alto consumo de CPU se debi√≥ a una regla WAF con una expresi√≥n regular mal formulada, lo que condujo a un retroceso excesivo.  Aqu√≠ est√° la expresi√≥n culpable: <code>(?:(?:\"|'|\]|\}|\\|\d|(?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\-|\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </p><br><p>  Aunque es interesante en s√≠ mismo (y le contar√© m√°s al respecto a continuaci√≥n), el servicio Cloudflare se cort√≥ durante 27 minutos, no solo debido a la expresi√≥n regular no apta.  Nos tom√≥ un tiempo describir la secuencia de eventos que llevaron al fracaso, por lo que no respondimos r√°pidamente.  Al final de la publicaci√≥n, describir√© el retroceso en expresi√≥n regular y le dir√© qu√© hacer al respecto. </p><br><h3 id="chto-sluchilos">  Que paso </h3><br><p>  Comencemos en orden.  Todo el tiempo se indica aqu√≠ en UTC. </p><br><p>  A las 13:42, un ingeniero del equipo de firewall realiz√≥ un peque√±o cambio en las reglas para detectar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">XSS</a> mediante un proceso autom√°tico.  En consecuencia, se cre√≥ un ticket de solicitud de cambio.  Gestionamos estos tickets a trav√©s de Jira (captura de pantalla a continuaci√≥n). </p><br><p>  Despu√©s de 3 minutos, apareci√≥ la primera p√°gina PagerDuty, informando un problema con WAF.  Fue una prueba sint√©tica que verifica la funcionalidad de WAF (tenemos cientos de ellas) fuera de Cloudflare para monitorear el funcionamiento normal.  Luego, inmediatamente hubo p√°ginas con notificaciones de fallas de otras pruebas de extremo a extremo de los servicios de Cloudflare, problemas de tr√°fico global, errores generalizados 502 y un mont√≥n de informes de nuestros puntos de presencia (PoP) en ciudades de todo el mundo que indicaban una falta de recursos de procesador. </p><br><p><img src="https://habrastorage.org/webt/fh/iw/ja/fhiwjas8c3-qfcwo-11nks3lld4.png"></p><br><p><img src="https://habrastorage.org/webt/fs/g7/xo/fsg7xokybw-svzn8tn-uyhuj7dm.jpeg"></p><br><p>  Recib√≠ varias de esas notificaciones, me sal√≠ de la reuni√≥n y ya estaba caminando hacia la mesa cuando el jefe de nuestro departamento de desarrollo de soluciones dijo que perdimos el 80% del tr√°fico.  Me encontr√© con nuestros ingenieros de SRE que ya estaban trabajando en el problema.  Al principio pensamos que era alg√∫n tipo de ataque desconocido. </p><br><p><img src="https://habrastorage.org/webt/-r/ox/mw/-roxmwj33bvn_n-xyww8xhfwpmw.jpeg"></p><br><p>  Los ingenieros de Cloudflare SRE est√°n dispersos por todo el mundo y monitorean la situaci√≥n durante todo el d√≠a.  Por lo general, tales alertas le notifican problemas locales espec√≠ficos de alcance limitado, se monitorean en paneles internos y se resuelven muchas veces al d√≠a.  Pero tales p√°ginas y notificaciones indicaron algo realmente serio, y los ingenieros de SRE anunciaron de inmediato el nivel de gravedad P0 y recurrieron a los ingenieros de administraci√≥n y sistemas. </p><br><p>  Nuestros ingenieros de Londres en ese momento estaban escuchando una conferencia en la sala principal.  La conferencia tuvo que ser interrumpida, todos se reunieron en una gran sala de conferencias y se invit√≥ a m√°s expertos.  Este no era un problema com√∫n que SRE pudiera resolver por s√≠ mismos.  Era urgente conectar a los especialistas correctos. </p><br><p>  A las 14:00 determinamos que hab√≠a un problema con WAF y que no hubo ataque.  El departamento de rendimiento recuper√≥ los datos del procesador y se hizo evidente que la culpa era de WAF.  Otro colaborador confirm√≥ esta teor√≠a con strace.  Alguien m√°s vio en los registros que el problema con WAF.  A las 14:02, todo el equipo se acerc√≥ a m√≠ cuando se me propuso usar la destrucci√≥n global, un mecanismo integrado en Cloudflare que desactiva un componente en todo el mundo. </p><br><p>  La forma en que matamos globalmente a WAF es una historia aparte.  No es tan simple.  Usamos nuestros propios productos, y dado que nuestro servicio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acceso</a> no funcionaba, no pod√≠amos autenticarnos e ingresar al panel de control interno (cuando todo fue reparado, supimos que algunos miembros del equipo perdieron el acceso debido a una caracter√≠stica de seguridad que deshabilita las credenciales si No use el panel de control interno por mucho tiempo). </p><br><p>  Y no pudimos acceder a nuestros servicios internos, como Jira o el sistema de compilaci√≥n.  Necesit√°bamos una soluci√≥n alternativa, que us√°bamos con poca frecuencia (esto tambi√©n deber√≠a resolverse).  Finalmente, un ingeniero pudo cortar WAF a las 14:07, y a las 14:09 el nivel de tr√°fico y procesador en todas partes volvi√≥ a la normalidad.  El resto de los mecanismos de defensa de Cloudflare funcionaron como se esperaba. </p><br><p>  Luego nos pusimos a restaurar WAF.  La situaci√≥n era fuera de lo com√∫n, por lo que realizamos pruebas negativas (pregunt√°ndonos si el problema realmente era este cambio) y positivas (asegur√°ndonos de que la reversi√≥n funcion√≥) en una ciudad usando tr√°fico separado, transfiriendo clientes pagados desde all√≠. </p><br><p>  A las 2:52 p.m., est√°bamos convencidos de que entend√≠amos el motivo, hicimos una correcci√≥n y volvimos a encender el WAF. </p><br><h3 id="kak-rabotaet-cloudflare">  C√≥mo funciona Cloudflare </h3><br><p>  Cloudflare tiene un equipo de ingenieros que administran las reglas administradas para WAF.  Intentan aumentar la tasa de detecci√≥n, reducir la cantidad de falsos positivos y responder r√°pidamente a las nuevas amenazas a medida que surgen.  En los √∫ltimos 60 d√≠as, se han procesado 476 solicitudes de cambio para reglas administradas por WAF (en promedio, una cada 3 horas). </p><br><p>  Este cambio en particular necesitaba implementarse en modo de simulaci√≥n, donde el tr√°fico real del cliente pasa a trav√©s de la regla, pero nada est√° bloqueado.  Utilizamos este modo para verificar la efectividad de las reglas y medir la proporci√≥n de resultados falsos positivos y falsos negativos.  Pero incluso en modo de simulaci√≥n, las reglas deben ejecutarse realmente, y en este caso, la regla conten√≠a una expresi√≥n regular que consum√≠a demasiados recursos de procesador. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/1p/sc/90/1psc90ccs9enwxvdyvu4thq30eo.png"></a> </p><br><p>  Como puede ver en la solicitud de cambio anterior, tenemos un plan de implementaci√≥n, un plan de reversi√≥n y un enlace al procedimiento operativo est√°ndar interno (SOP) para este tipo de implementaci√≥n.  El SOP para cambiar una regla permite publicarlo globalmente.  De hecho, en Cloudflare, todo est√° organizado de manera completamente diferente, y SOP requiere primero enviar el software para pruebas y uso interno a un punto de presencia interno (PoP) (que usan nuestros empleados), luego a un peque√±o n√∫mero de clientes en un lugar aislado, luego a un gran n√∫mero de clientes, y solo entonces a todo el mundo </p><br><p>  As√≠ es como se ve.  Usamos git en el sistema interno a trav√©s de BitBucket.  Los ingenieros de cambio env√≠an el c√≥digo que compilan a TeamCity, y cuando la compilaci√≥n pasa, se asignan revisores.  Cuando se aprueba la solicitud del grupo, se recopila el c√≥digo y se realizan una serie de pruebas (nuevamente). </p><br><p>  Si el ensamblaje y las pruebas tienen √©xito, se crea una solicitud de cambio en Jira, y el cambio debe ser aprobado por el supervisor apropiado o el especialista principal.  Despu√©s de la aprobaci√≥n, se despliega en la llamada "casa de fieras PoP": PERRO, CERDO y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Canario</a> (perro, paperas y canario). </p><br><p>  DOG PoP es Cloudflare PoP (como cualquier otra de nuestras ciudades), que solo usan los empleados de Cloudflare.  PoP para uso interno le permite detectar problemas incluso antes de que la soluci√≥n comience a recibir tr√°fico de clientes.  Cosa √∫til </p><br><p>  Si la prueba DOG tiene √©xito, el c√≥digo pasa a la etapa PIG (conejillo de indias).  Este es Cloudflare PoP, donde una peque√±a cantidad de tr√°fico de cliente libre fluye a trav√©s del nuevo c√≥digo. <br>  Si todo est√° bien, el c√≥digo va a Canarias.  Tenemos tres PoP Canarios en diferentes partes del mundo.  El tr√°fico de clientes pagos y gratuitos pasa a trav√©s del nuevo c√≥digo en ellos, y esta es la √∫ltima comprobaci√≥n de errores. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ew/d_/0h/ewd_0hfzquucy07y15qbgbckaao.png"></a> <br>  <em>Proceso de lanzamiento del software Cloudflare</em> </p><br><p>  Si el c√≥digo est√° bien en Canarias, lo publicamos.  Pasar por todas las etapas (DOG, PIG, Canary, todo el mundo) lleva varias horas o d√≠as, dependiendo del cambio de c√≥digo.  Debido a la diversidad de la red y los clientes de Cloudflare, probamos a fondo el c√≥digo antes de un lanzamiento global para todos los clientes.  Pero WAF no sigue espec√≠ficamente este proceso porque las amenazas deben ser respondidas r√°pidamente. </p><br><p>  Amenazas WAF <br>  En los √∫ltimos a√±os, ha habido muchas m√°s amenazas en las aplicaciones convencionales.  Esto se debe a la mayor disponibilidad de herramientas de prueba de software.  Por ejemplo, recientemente escribimos sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fuzzing</a> ). </p><br><p><img src="https://habrastorage.org/webt/br/lu/mp/brlumpkugkwhpdfq3zb0fb5vixm.png"><br>  <em>Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  Muy a menudo, se crea una confirmaci√≥n del concepto y se publica inmediatamente en Github para que los equipos que dan servicio a la aplicaci√≥n puedan probarla r√°pidamente y asegurarse de que est√© adecuadamente protegida.  Por lo tanto, Cloudflare necesita la capacidad de responder a nuevos ataques lo m√°s r√°pido posible para que los clientes tengan la oportunidad de arreglar su software. </p><br><p>  Un gran ejemplo de la respuesta r√°pida de Cloudflare es la implementaci√≥n de la protecci√≥n contra vulnerabilidades de SharePoint en mayo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lea aqu√≠</a> ).  Casi inmediatamente despu√©s de la publicaci√≥n de los anuncios, notamos una gran cantidad de intentos de aprovechar la vulnerabilidad en las instalaciones de SharePoint de nuestros clientes.  Nuestros muchachos constantemente monitorean nuevas amenazas y escriben reglas para proteger a nuestros clientes. </p><br><p>  La regla que caus√≥ el problema el jueves fue proteger contra las secuencias de comandos entre sitios (XSS).  Tambi√©n ha habido muchos m√°s ataques de este tipo en los √∫ltimos a√±os. </p><br><p><img src="https://habrastorage.org/webt/tr/jy/oz/trjyozwk_k4raviofhzgeskwf2s.png"><br>  <em>Fuente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  El procedimiento est√°ndar para modificar una regla administrada para WAF requiere pruebas de integraci√≥n continua (CI) antes de la implementaci√≥n global.  El jueves pasado lo hicimos y ampliamos las reglas.  A las 13:31, un ingeniero envi√≥ una solicitud de grupo aprobada con un cambio. </p><br><p><img src="https://habrastorage.org/webt/uz/xj/jo/uzxjjo5648f52t8x-tnu66tuvku.png"></p><br><p>  A las 13:37, TeamCity reuni√≥ las reglas, realiz√≥ las pruebas y dio el visto bueno.  El conjunto de pruebas WAF prueba la funcionalidad central de WAF y consta de una gran cantidad de pruebas unitarias para funciones individuales.  Despu√©s de las pruebas unitarias, verificamos las reglas para WAF con una gran cantidad de solicitudes HTTP.  Las solicitudes HTTP verifican qu√© solicitudes debe bloquear WAF (para interceptar el ataque) y cu√°les se pueden omitir (para no bloquear todo y evitar falsos positivos).  Pero no realizamos pruebas para el uso excesivo de los recursos del procesador, y el estudio de los registros de ensamblajes WAF anteriores muestra que el tiempo de ejecuci√≥n de la prueba con la regla no aument√≥, y era dif√≠cil sospechar que no hab√≠a suficientes recursos. </p><br><p>  Se aprobaron las pruebas y TeamCity comenz√≥ a implementar autom√°ticamente el cambio a las 13:42. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/8-/s2/gd/8-s2gd8pw8j5zhxukadhwh77xr4.png"></a> </p><br><h3 id="quicksilver">  Mercurio </h3><br><p>  Las reglas de WAF abordan la eliminaci√≥n urgente de amenazas, por lo que las implementamos utilizando los pares de clave-valor distribuidos Quicksilver, que distribuye los cambios a nivel mundial en segundos.  Todos nuestros clientes usan esta tecnolog√≠a cuando cambian la configuraci√≥n en el tablero o a trav√©s de la API, y es gracias a eso que respondemos a los cambios con la velocidad del rayo. </p><br><p>  Hablamos un poco sobre Quicksilver.  Sol√≠amos usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kyoto Tycoon</a> como un repositorio distribuido globalmente de pares clave-valor, pero hab√≠a problemas operativos con √©l, y escribimos nuestro repositorio replicado en m√°s de 180 ciudades.  Ahora, con Quicksilver, enviamos cambios en la configuraci√≥n del cliente, actualizamos las reglas de WAF y distribuimos el c√≥digo JavaScript escrito por los clientes en Cloudflare Workers. </p><br><p>  Solo toma unos segundos para que una configuraci√≥n d√© la vuelta al mundo presionando un bot√≥n en un tablero o llamando a una API para hacer cambios en la configuraci√≥n.  Los clientes adoran esta configuraci√≥n de velocidad.  Y Workers les proporciona una implementaci√≥n de software global casi instant√°nea.  En promedio, Quicksilver distribuye alrededor de 350 cambios por segundo. </p><br><p>  Y Quicksilver es muy r√°pido.  En promedio, alcanzamos el percentil 99 de 2.29 para propagar los cambios a todas las computadoras del mundo.  Por lo general, la velocidad es buena.  Despu√©s de todo, cuando enciende una funci√≥n o borra el cach√©, ocurre casi al instante y en todas partes.  El env√≠o de c√≥digo a trav√©s de Cloudflare Workers es a la misma velocidad.  Cloudflare promete a sus clientes actualizaciones r√°pidas en el momento adecuado. </p><br><p>  Pero en este caso, la velocidad nos jug√≥ una mala pasada, y las reglas cambiaron en todas partes en cuesti√≥n de segundos.  Probablemente hayas notado que el c√≥digo WAF usa Lua.  Cloudflare hace un uso extensivo de Lua en el entorno de producci√≥n y ya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hemos discutido los</a> detalles de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lua en WAF</a> .  Lua WAF utiliza <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PCRE</a> internamente y aplica el seguimiento posterior para la coincidencia.  No tiene mecanismos de defensa contra expresiones que est√°n fuera de control.  A continuaci√≥n hablar√© m√°s sobre esto y lo que estamos haciendo con √©l. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/zd/qq/yo/zdqqyof00zszstm3indwngi26_8.png"></a> </p><br><p>  Antes de que se implementaran las reglas, todo transcurri√≥ sin problemas: la solicitud del grupo se cre√≥ y aprob√≥, la canalizaci√≥n de CI / CD compil√≥ y prob√≥ el c√≥digo, la solicitud de cambio se envi√≥ de acuerdo con el SOP, que regula el despliegue y la reversi√≥n, y el despliegue se complet√≥. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/5t/47/ar/5t47art0hduaaxywv3io5_71z8a.png"></a> <br>  <em>Proceso de implementaci√≥n de CloudFare WAF</em> </p><br><p>  Que sali√≥ mal <br>  Como dije antes, implementamos docenas de nuevas reglas WAF cada semana, y tenemos muchos sistemas de protecci√≥n contra las consecuencias negativas de tal implementaci√≥n.  Y cuando algo sale mal, generalmente es una combinaci√≥n de varias circunstancias.  Si encuentra una sola raz√≥n, esto, por supuesto, es tranquilizador, pero no siempre es cierto.  Estas son las razones que juntas llevaron a la falla de nuestro servicio HTTP / HTTPS. </p><br><ol><li>  El ingeniero escribi√≥ una expresi√≥n regular que podr√≠a conducir a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">retroceso</a> excesivo. </li><li>  Una herramienta que podr√≠a evitar el uso excesivo de los recursos del procesador utilizados por la expresi√≥n regular se elimin√≥ por error durante la refactorizaci√≥n de WAF unas semanas antes; se necesitaba refactorizar para que WAF consumiera menos recursos. </li><li>  El motor regex no ten√≠a garant√≠as de complejidad. </li><li>  El conjunto de pruebas no pudo revelar un consumo excesivo de CPU. </li><li>  El procedimiento SOP permite el despliegue global de cambios de reglas no urgentes sin un proceso de varios pasos. </li><li>  El plan de reversi√≥n requiri√≥ un ensamblaje WAF completo dos veces, lo que llev√≥ mucho tiempo. </li><li>  La primera alerta de alerta de tr√°fico global funcion√≥ demasiado tarde. </li><li>  Retrasamos la actualizaci√≥n de la p√°gina de estado. </li><li>  Tuvimos problemas para acceder a los sistemas debido a un bloqueo, y la soluci√≥n no se resolvi√≥ lo suficientemente bien. </li><li>  Los ingenieros de SRE han perdido el acceso a algunos sistemas porque sus credenciales han expirado por razones de seguridad. </li><li>  Nuestros clientes no ten√≠an acceso al panel o API de Cloudflare porque atraviesan la regi√≥n de Cloudflare. </li></ol><br><h3 id="chto-izmenilos-s-proshlogo-chetverga">  Lo que ha cambiado desde el jueves pasado </h3><br><p>  Primero, detuvimos completamente todo el trabajo en lanzamientos para WAF y hacemos lo siguiente: </p><br><ol><li>  Reintroduciendo la protecci√≥n contra los recursos excesivos del procesador que eliminamos.  (Hecho) </li><li>  Compruebe manualmente todas las reglas 3868 en las reglas administradas para que WAF encuentre y repare otros casos potenciales de retroceso excesivo.  (Verificaci√≥n completada) </li><li>  Incluimos perfiles de rendimiento para todas las reglas en el conjunto de pruebas.  (Esperado: 19 de julio) </li><li>  Cambiamos al motor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">re2</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Rust</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">regex</a> , ambos brindan garant√≠as en el tiempo de ejecuci√≥n.  (Esperado: 31 de julio) </li><li>  Reescribimos SOP para implementar las reglas en etapas, como otro software en Cloudflare, pero al mismo tiempo tenemos la capacidad de una implementaci√≥n global de emergencia si los ataques ya han comenzado. </li><li>  Estamos desarrollando la posibilidad de retirar urgentemente el panel de control de Cloudflare y la API de la regi√≥n de Cloudflare. </li><li>  Estamos automatizando la actualizaci√≥n de la p√°gina de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estado de Cloudflare</a> . </li></ol><br><p>  A la larga, estamos abandonando Lua WAF, que escrib√≠ hace varios a√±os.  Migramos WAF al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nuevo sistema de firewall</a> .  Entonces WAF ser√° m√°s r√°pido y recibir√° un nivel adicional de protecci√≥n. </p><br><h3 id="zaklyuchenie">  Conclusi√≥n </h3><br><p>  Esta falla nos caus√≥ problemas a nosotros y a nuestros clientes.  R√°pidamente reaccionamos para corregir la situaci√≥n, y ahora estamos trabajando en fallas en los procesos que causaron la falla, y tambi√©n profundizando a√∫n m√°s para protegernos de posibles problemas con expresiones regulares en el futuro, cambiando a una nueva tecnolog√≠a. </p><br><p>  Estamos muy avergonzados de este fracaso, y nos disculpamos con nuestros clientes.  Esperamos que estos cambios garanticen que esto no vuelva a suceder. </p><br><h3 id="prilozhenie-bektreking-regulyarnyh-vyrazheniy">  Solicitud  Seguimiento de expresiones regulares </h3><br><p>  Para entender c√≥mo la expresi√≥n: </p><br><pre> <code class="plaintext hljs">(?:(?:\"|'|\]|\}|\\|\d (?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\- |\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </pre> <br><p>  Si se comen todos los recursos del procesador, necesita saber un poco sobre c√≥mo funciona el motor regex est√°ndar.  El problema aqu√≠ es el patr√≥n <code>.*(?:.*=.*)</code> .  <code>(?:</code> y el correspondiente <code>)</code> no es un grupo emocionante (es decir, la expresi√≥n entre par√©ntesis se agrupa como una expresi√≥n). </p><br><p>  En el contexto del consumo excesivo de recursos del procesador, este patr√≥n puede designarse como <code>.*.*=.*</code> .  Como tal, el patr√≥n parece innecesariamente complejo.  Pero lo m√°s importante, en el mundo real, tales expresiones (similares a las expresiones complejas en las reglas WAF) que le piden al motor que coincida con un fragmento, seguido de otro fragmento, pueden conducir a un retroceso catastr√≥fico.  Y aqu√≠ est√° el por qu√©. </p><br><p><img src="https://habrastorage.org/webt/wr/7g/ec/wr7gec__o2lld5uwyz5ir6vfolm.png"></p><br><p>  En expresi√≥n regular <code>.</code>  significa que debe coincidir con un car√°cter. <code>.*</code> : coincide con cero o m√°s caracteres "con avidez", es decir, captura un m√°ximo de caracteres, por lo tanto <code>.*.*=.*</code> significa coincide con cero o m√°s caracteres, luego coincide con cero o m√°s caracteres, encuentre car√°cter literal =, coincide con cero o m√°s caracteres. </p><br><p>  Tome la l√≠nea de prueba <code>x=x</code> .  Coincide con la expresi√≥n <code>.*.*=.*. .*.*</code>  <code>.*.*=.*. .*.*</code> hasta el signo igual corresponde a la primera <code>x</code> (uno de los grupos <code>.*</code> corresponde a <code>x</code> , y el segundo a cero caracteres).  <code>.*</code> after = coincide con la √∫ltima <code>x</code> . </p><br><p>  Para tal comparaci√≥n, se necesitan 23 pasos.  El primer grupo <code>.*</code> <code>.*.*=.*</code> Act√∫a "con avidez" y coincide con toda la l√≠nea <code>x=x</code> .  El motor se mueve al siguiente grupo <code>.*</code> .  Ya no tenemos caracteres para hacer coincidir, por lo que el segundo grupo <code>.*</code> Coincide con cero caracteres (esto est√° permitido).  Entonces el motor va al signo <code>=</code> .  No hay m√°s caracteres (el primer grupo <code>.*</code> Se us√≥ la expresi√≥n completa <code>x=x</code> ), no se produce ninguna coincidencia. </p><br><p>  Y aqu√≠ el motor de expresi√≥n regular vuelve al principio.  √âl va al primer grupo <code>.*</code> Y lo compara <code> x=</code> (en lugar de <code>x=x</code> ), y luego toma el segundo grupo <code>.*</code> .  El segundo grupo <code>.*</code> asigna a la segunda <code>x</code> , y nuevamente no nos quedan caracteres.  Y cuando el motor alcanza <code>=</code> v <code>.*.*=.*</code> Nuevamente, no pasa nada.  Y vuelve a dar marcha atr√°s. </p><br><p>  Esta vez, el grupo <code>.*</code> Todav√≠a coincide con <code>x=</code> , pero el segundo grupo <code>.*</code> Ya no es <code>x</code> , sino cero caracteres.  El motor intenta encontrar el s√≠mbolo literal <code>=</code> en el patr√≥n <code>.*.*=.*</code> , Pero no sale (despu√©s de todo, el primer grupo ya lo ha ocupado <code>.*</code> ).  Y vuelve a dar marcha atr√°s. </p><br><p>  Esta vez el primer grupo <code>.*</code> Toma solo la primera x.  Pero el segundo grupo <code>.*</code> "Codicioso" captura <code>=x</code> .  ¬øYa has adivinado lo que suceder√°?  El motor intenta hacer coincidir literal <code>=</code> , falla y realiza el siguiente retroceso. </p><br><p>   <code>.*</code>     <code>x</code> .  <code>.*</code>   <code>=</code> . ,      <code>=</code> ,       <code>.*</code> .   .         ! </p><br><p>     <code>.*</code>     <code>x</code> ,  <code>.*</code> ‚Äî   ,      <code>=</code>   <code> =</code>  .    <code>.*</code>    <code>x</code> . </p><br><p> 23    <code>x=x</code> .      Perl <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Regexp::Debugger</a> ,  ,     . </p><br><p><img src="https://habrastorage.org/webt/a7/do/2n/a7do2nizluizhm1h2q2shajnvgs.gif"></p><br><p>    ,     <code>x=x</code>    <code>x=xx</code> ?  33 .   <code>x=xxx</code> ? 45.   .      <code>x=x</code>  <code>x=xxxxxxxxxxxxxxxxxxxx</code> (20 <code>x</code>  <code>=</code> ).    20 x  <code>=</code> ,     555 ! ( ,     <code>x=</code>      20 <code>x</code> ,   4067 ,  ,   ). </p><br><p><img src="https://habrastorage.org/webt/t-/1m/l4/t-1ml4up0y5w262eye_cyjmlik4.png"></p><br><p>         <code>x=xxxxxxxxxxxxxxxxxxxx</code> : </p><br><p><img src="https://habrastorage.org/webt/t8/oz/wq/t8ozwqwv1otujwl5_bebeglitpe.gif"></p><br><p>   ,         .      ,     . ,     <code>.*.*=.*</code> ; (         ). ,     ,  <code>foo=bar;</code>  . </p><br><p>       .   <code>x=x</code>  90 ,   23.     .   <code>x=</code>  20 <code>x</code> ,  5353 .  .      <code>Y</code>     . </p><br><p><img src="https://habrastorage.org/webt/kn/n9/ex/knn9exewj9a48-fkxyayefzexeu.png"></p><br><p>  ,   5353    <code>x=xxxxxxxxxxxxxxxxxxxx</code>  <code>.*.*=.*;</code> </p><br><p><img src="https://habrastorage.org/webt/d3/gg/ra/d3ggrayopot2-l7vivzm0fqfnmq.gif"></p><br><p>   ¬´¬ª,   ¬´¬ª ,    .      <code>.*?.*?=.*?</code> ,   <code>x=x</code>  11  (  23).    <code>x=xxxxxxxxxxxxxxxxxxxx</code> .  ,  <code>?</code>  <code>.*</code>      ,    . </p><br><p>  ¬´¬ª      .     <code>.*.*=.*;</code>  <code>.*?.*?=.*?;</code> ,    . <code>x=x</code>    555 ,  <code>x=</code>  20 <code>x</code> ‚Äî 5353. </p><br><p> ,    (      ) ‚Äî         .        . </p><br><p>       1968 ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Programming Techniques: Regular expression search algorithm</a> (¬´ :    ¬ª).    ,         ,          ,        . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fd/nn/ri/fdnnril2lmr0udityqylanfzahk.png"></a> </p><br><blockquote> <strong>  <br>     <br>   (Ken Thompson)</strong> <br> Bell Telephone Laboratories, Inc., -,  - <br><br>                 .             IBM 7094    .               ,         .    ,   . <br><br> <strong></strong> <br>      ,       . <br><br>        .      .     ‚Äî                  . <br>              . ,        . ,           . <br> ,           IBM 7094. <br><br> <strong></strong> <br>       .   ‚Äî   ,       .       ¬´¬∑¬ª    .         .      .  2  ,       . </blockquote><p>         ,           ALGOL-60,       IBM 7094.  ,     . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fx/se/9x/fxse9xv8le3pgp2quvsrufznvb8.png"></a> </p><br><blockquote>   .    ‚äï      . <br>   1          .      ‚Äî a, b, c,      S[i]   NNODE. <br><br> NNODE   ,          (. . 5) </blockquote><p>       <code>.*.*=.*</code> ,   ,      . </p><br><p><img src="https://habrastorage.org/webt/mt/_5/lc/mt_5lcklo-jw2x6zmt8nwjg8hpy.png"></p><br><p>  En la fig. 0   ,   0,  3 ,     1, 2  3.      <code>.*</code>   . 3      .    <code>=</code>    <code>=</code> .  4  .    ,    . </p><br><p>  ,           <code>.*.*=.*</code> ,     <code>x=x</code> .     0,    .  1) </p><br><p><img src="https://habrastorage.org/webt/tx/a6/cl/txa6cltpurcbwxzrxk1v9ypkec4.png"></p><br><p>    ,        .        . </p><br><p>      ,       (1  2),    .  2) </p><br><p><img src="https://habrastorage.org/webt/ve/pb/nj/vepbnjljx-0cinc-eapaz17mths.png"></p><br><p>  En la fig. 2 ,  ,     <code>x</code>  <code>x=x</code> . <code>x</code>     ,    1     1.  <code>x</code>     ,    2     2. </p><br><p>    <code>x</code>  <code>x=x</code>  -   1  2.      3  4,       <code>=</code> . </p><br><p>    <code>=</code>  <code>x=x</code> .   x  ,              1    1    2   2,        <code>=</code>     2   3 (  4).    .  3) </p><br><p><img src="https://habrastorage.org/webt/0b/x8/7f/0bx87fp1aquszmn-wjp7ta3b4i0.png"></p><br><p>      <code>x</code>  <code>x=x</code> .   1  2        1  2.   3 <code>x</code>           3. </p><br><p>      <code>x=x</code> ,      4,     .     ,          .   . </p><br><p> ,     4 (   <code>x=</code> )    ,    ,    <code>x</code> . </p><br><p>        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460863/">https://habr.com/ru/post/460863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460851/index.html">SamsPcbGuide, Parte 10: Tecnolog√≠a - Soldadura de componentes sin plomo</a></li>
<li><a href="../460855/index.html">¬øC√≥mo usar PHP para implementar microservicios?</a></li>
<li><a href="../460857/index.html">C√≥mo Namecoin Blockchain Research predijo ataques cibern√©ticos RTM</a></li>
<li><a href="../460859/index.html">IThink # 3 conferencia en Jarkov - basada en WWDC 2019</a></li>
<li><a href="../460861/index.html">Alcance y cierre l√©xico de JavaScript</a></li>
<li><a href="../460865/index.html">La gente en la luna. Fuentes</a></li>
<li><a href="../460867/index.html">Sourcery para convertir autom√°ticamente a estructuras de objetos Realm</a></li>
<li><a href="../460869/index.html">Reconocimiento de objetos en tiempo real en iOS usando YOLOv3</a></li>
<li><a href="../460873/index.html">Por qu√© Turok: Dinosaur Hunter para N64 est√° a√±os adelantado a su tiempo</a></li>
<li><a href="../460875/index.html">C√≥mo en QIWI llegamos a un estilo com√∫n de interacci√≥n entre View y ViewModel dentro de MVVM</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>