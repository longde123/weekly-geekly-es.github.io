<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍🚒 🧝 ⌚️ [Javawatch Live] L'histoire d'une demande de tirage. `os.version` dans SubstrateVM 🆚 🤷🏼 👩🏾‍✈️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un an s'est écoulé depuis la réussite de l'astuce précédente: publier une vidéo sur YouTube au lieu d'un article. «Discours honteux sur singleton» a g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[Javawatch Live] L'histoire d'une demande de tirage. `os.version` dans SubstrateVM</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/420455/">  Un an s'est écoulé depuis la réussite de l'astuce précédente: publier une vidéo sur YouTube au lieu d'un article.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«Discours honteux sur singleton» a</a> gagné 7 000 vues sur YouTube et deux fois plus sur Habré dans la version texte.  Pour un article écrit dans un état complètement têtu et parlant de l'ancien accordéon à boutons - c'est un peu un succès. <br><br>  Aujourd'hui, j'ai installé une nouvelle version toute la nuit.  Cette fois, le sujet est beaucoup plus récent: l'histoire du commit à la technologie expérimentale - SubstrateVM.  Mais le degré de ténacité a atteint un nouveau niveau. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/f0nD_8G1uB0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Au plaisir de vos commentaires!  Je vous rappelle que si vous voulez vraiment améliorer quelque chose dans ce post, il est préférable de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">déposer celui-ci sur Github</a> .  Je voudrais dire "aimez et abonnez-vous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">à la nouvelle chaîne</a> , mais toutes ses versions seront-elles de toute façon dans votre hub Java?" <br><br>  Techniquement: la vidéo a un collage plus proche de la fin.  Je viens d'écrire une vidéo non compressée et mon ssd m2 de seulement cinq cents gigaoctets a rapidement débordé.  Et aucun autre disque dur ne pourrait résister à une telle pression de données.  Par conséquent, j'ai dû me déconnecter pendant une demi-heure et je me suis mis en quatre pour trouver cinquante concerts supplémentaires pour enregistrer les dernières minutes.  Cela a été réalisé en supprimant les fichiers <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">compilés par GoogleChrome</a> .  J'ai écrit sur le logiciel d'enregistrement dans le FB <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">juste au moment de l'enregistrement</a> , il y a beaucoup de douleur. <br><br>  Un autre des aspects techniquement intéressants: YouTube pour une raison quelconque m'a bloqué la diffusion en direct.  Dans le même temps, il n'y a pas une seule grève et stigmatisation sur le compte.  Espérons que ce n'est qu'un jambage, et après 90 jours, tout sera retourné. <br><a name="habracut"></a><br><blockquote>  Cet article citera un code appartenant à Oracle.  Vous ne pouvez pas utiliser ce code pour vous-même (à moins que vous n'ayez lu la licence d'origine et qu'il ne l'autorise dans les conditions, par exemple, de la GPL).  Ce n'est pas une blague.  Olso, j'ai prévenu. <br></blockquote><br><h1>  Prikazka (et un conte de fées sera à venir) </h1><br>  Beaucoup ont déjà entendu des histoires selon lesquelles «le nouveau Java sera écrit en Java» et se demandent comment cela pourrait être.  Il y a un document de politique de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Project Metropolis</a> et une lettre correspondante de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">John Rose</a> , mais tout y est assez vague. <br><br>  Cela ressemble à une sorte de magie effrayante et sanglante.  Dans la même chose que vous pouvez essayer en ce moment, non seulement il n'y a pas de magie, mais tout est stupide comme le dos d'une pelle lorsque vous enlevez vos dents avec.  Bien sûr, il y a quelques nuances, mais ce sera un jour très tard. <br><br>  Je vais le montrer sur l'exemple d'une histoire instructive qui s'est produite pendant l'été.  Comment ils écrivent l'essai «Comment j'ai passé l'été» dans les écoles. <br><br>  Pour commencer une petite remarque.  Le projet en cours de compilation Ahead-of-Time dans Oracle Labs est GraalVM.  Le composant qui, en fait, fait nishtyaki et transforme le code Java en un fichier exécutable (en un exécutable) est SubstrateVM ou SVM pour faire court.  Ne confondez pas cela avec la même abréviation utilisée par les satanistes de données (support vector machine).  Il s'agit de SVM, en tant que partie clé, nous parlerons plus loin. <br><br><h1>  Énoncé du problème </h1><br>  Donc, "comment j'ai passé l'été."  Je me suis assis en vacances, j'ai passé deux F5 sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Graal</a> et je suis tombé sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">celui-ci</a> : <br><br><img src="https://habrastorage.org/webt/uy/pg/ig/uypgig4krayn8dmvfzif_rd3em0.png"><br><br>  Une personne veut que <code>os.version</code> donne la bonne valeur. <br><br>  Eh bien cho, je voulais corriger le bug?  Le garçon a dit - le garçon l'a fait. <br><br>  Nous allons vérifier si notre client ment. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(System.getProperty(<span class="hljs-string"><span class="hljs-string">"os.version"</span></span>)); } }</code> </pre><br>  Tout d'abord, à quoi ressemble l'échappement en vrai Java: <code>4.15.0-32-generic</code> .  Oui, c'est une nouvelle version d'Ubuntu LTS Bionic. <br><br>  Essayez maintenant de faire de même sur SVM: <br><br><pre> <code class="bash hljs">$ ls Main.java $ javac -cp . Main.java $ ls Main.class Main.java $ native-image Main Build on Server(pid: 18438, port: 35415) classlist: 151.77 ms (<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>): 1,662.32 ms setup: 1,880.78 ms error: Basic header file missing (&lt;zlib.h&gt;). Make sure libc and zlib headers are available on your system. Error: Processing image build request failed</code> </pre><br>  Et bien oui.  En effet, j'ai créé une toute nouvelle machine virtuelle spécialement pour le test «propre». <br><br><pre> <code class="bash hljs">$ sudo apt-get install zlib1g-dev libc6 libc6-dev $ native-image Main Build on Server(pid: 18438, port: 35415) classlist: 135.17 ms (<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>): 877.34 ms setup: 1,253.49 ms (typeflow): 4,103.97 ms (objects): 1,441.97 ms (features): 41.74 ms analysis: 5,690.63 ms universe: 252.43 ms (parse): 1,024.49 ms (inline): 819.27 ms (compile): 4,243.15 ms compile: 6,356.02 ms image: 632.29 ms write: 236.99 ms [total]: 14,591.30 ms</code> </pre><br>  Les chiffres absolus d'exécution peuvent être horribles.  Mais, d’abord, c’est ce qu’on voulait faire: des optimisations très infernales sont appliquées ici.  Et deuxièmement, c'est une machine virtuelle fragile que vous voulez. <br><br>  Et enfin, le moment de vérité: <br><br><pre> <code class="hljs cs">$ ./main <span class="hljs-literal"><span class="hljs-literal">null</span></span></code> </pre><br>  Il semble que notre invité n'a pas menti, ne fonctionne vraiment pas. <br><br><h1>  Première approche: voler les propriétés de l'hôte </h1><br>  Ensuite, j'ai recherché <code>os.version</code> dans le <code>os.version</code> et <code>os.version</code> constaté que toutes ces propriétés se <code>SystemPropertiesSupport</code> dans la classe <code>SystemPropertiesSupport</code> . <br><br>  Je n'écrirai pas le chemin complet du fichier, car la possibilité de générer les projets corrects pour IntelliJ IDEA et Eclipse est intégrée directement dans SVM.  C'est très cool et ne rappelle pas du tout le tourment que la plupart du temps OpenJDK doit vivre.  Laissez l'IDE ouvrir des classes pour nous.  Donc: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemPropertiesSupport</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] HOSTED_PROPERTIES = { <span class="hljs-string"><span class="hljs-string">"java.version"</span></span>, ImageInfo.PROPERTY_IMAGE_KIND_KEY, <span class="hljs-string"><span class="hljs-string">"line.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"path.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"file.separator"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.arch"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"file.encoding"</span></span>, <span class="hljs-string"><span class="hljs-string">"sun.jnu.encoding"</span></span>, }; <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre><br>  Ensuite, sans inclure la tête du tout, je <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">suis</a> simplement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">allé ajouter</a> une autre variable à cet ensemble: <br><br><pre> <code class="java hljs"><span class="hljs-string"><span class="hljs-string">"os.arch"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"os.version"</span></span></code> </pre><br>  Je reconstruis, je cours, j'obtiens la ligne convoitée <code>4.15.0-32-generic</code> .  Hourra! <br><br>  Mais voici le problème: maintenant sur <em>chaque</em> machine où ce code est exécuté, il émet toujours <code>4.15.0-32-generic</code> .  Même là où <code>uname -a</code> rend la version précédente du bucket, sur l'ancien Ubunt. <br><br>  Il devient clair que ces variables sont écrites dans le fichier source au moment de la compilation. <br>  Et vraiment, vous devez lire attentivement les commentaires: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** System properties that are taken from the VM hosting the image generator. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] HOSTED_PROPERTIES</code> </pre><br>  D'autres méthodes doivent être appliquées. <br><br><h2>  Conclusions </h2><br><ul><li>  Si vous voulez qu'une propriété système de «Java principal» apparaisse dans SVM, c'est très simple.  Nous écrivons la propriété souhaitée au bon endroit, c'est tout. </li><li>  Vous pouvez travailler dans l'IDE, qui prend en charge Java et Python en même temps.  Par exemple, dans IntelliJ IDEA Ultimate avec un plugin Python ou le même dans Eclipse. </li></ul><br><h1>  Deuxième approche </h1><br>  Si vous fouillez dans le <code>SystemPropertiesSupport</code> SystemPropertiesSupport, nous trouvons une chose beaucoup plus raisonnable: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** System properties that are lazily computed at run time on first access. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Map&lt;String, Supplier&lt;String&gt;&gt; lazyRuntimeValues;</code> </pre><br>  Entre autres choses, l'utilisation de ces propriétés ne bloque toujours pas le processus de construction d'un exécutable.  Il est clair que si nous <code>HOSTED_PROPERTIES</code> beaucoup dans <code>HOSTED_PROPERTIES</code> , alors tout ralentira. <br><br>  L'enregistrement des propriétés paresseuses se produit de manière évidente, par référence à une méthode qui renvoie: <br><br><pre> <code class="hljs kotlin">lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.name"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userNameValue); lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.home"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userHomeValue); lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"user.dir"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::userDirValue);</code> </pre><br>  De plus, toutes ces références de méthode sont des interfaces, et la même <code>this::userDirValue</code> est implémentée pour chacune des plateformes prises en charge.  Dans ce cas, ce sont <code>PosixSystemPropertiesSupport</code> et <code>WindowsSystemPropertiesSupport</code> . <br><br>  Si nous sortons par curiosité d'une implémentation pour Windows, nous verrons la triste chose: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userDirValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"C:\\Users\\somebody"</span></span>; }</code> </pre><br>  Comme vous pouvez le voir, Windows n'est pas encore pris en charge :-) Cependant, le vrai problème est que la génération d'exécutables pour Windows n'est pas encore terminée, donc la prise en charge de ces méthodes serait en fait des efforts complètement inutiles. <br><br>  Autrement dit, vous devez implémenter la méthode suivante: <br><br><pre> <code class="java hljs">lazyRuntimeValues.put(<span class="hljs-string"><span class="hljs-string">"os.version"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::osVersionValue);</code> </pre><br>  Et puis le prendre en charge dans deux ou trois interfaces disponibles. <br><br>  Mais quoi y écrire? <br><br><h2>  Conclusions </h2><br><ul><li>  Si vous souhaitez ajouter une nouvelle propriété calculée en runtime, il s'agit d'écrire une méthode.  Le résultat peut dépendre du système d'exploitation actuel, le mécanisme de commutation fonctionne déjà et ne le demande pas. </li></ul><br><h1>  Un peu d'archéologie </h1><br>  La première chose qui me vient à l'esprit est de jeter un œil à une implémentation dans OpenJDK et de copier-coller effrontément.  Un peu d'archéologie et de pillages n'empêcheront jamais un courageux explorateur! <br><br>  N'hésitez pas à ouvrir n'importe quel projet Java dans l'Idea, à y écrire <code>System.getProperty("os.version")</code> et, en <code>System.getProperty("os.version")</code> + clic, accédez à l'implémentation de la méthode <code>getProperty()</code> .  Il s'avère que tout cela se trouve bêtement dans les <code>Properties</code> . <br><br>  Il semblerait, juste copier-coller l'endroit où ces <code>Properties</code> sont remplies, et rire avec ferveur, s'enfuir dans le vide.  Malheureusement, nous rencontrons un problème: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> Properties </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Properties props)</span></span></span></span>;</code> </pre><br>  Noooooooooooooo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d4d/ca9/698/d4dca9698ffccaf0de2944194698e857.gif"><br><br>  Mais tout a si bien commencé. <br><br><h1>  Y avait-il un garçon? </h1><br>  Comme nous le savons, l'utilisation de C ++ est mauvaise.  Le C ++ est-il utilisé dans SVM? <br><br>  Comme ça!  Il existe même un package spécial pour cela: <code>src/com.oracle.svm.native</code> . <br><br>  Et dans ce paquet, horror-horror, se trouve le fichier <code>getEnviron.c</code> avec quelque chose comme ceci: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **environ; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> **</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getEnviron</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> environ; }</code> </pre><br><h1>  Il est temps de jouer avec C ++ </h1><br>  Maintenant, plongez un peu plus et ouvrez toutes les sources OpenJDK. <br><br>  Si quelqu'un ne les a pas déjà, vous pouvez les <a href="">consulter sur le Web</a> ou les télécharger.  Je vous préviens, ils <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">se</a> balancent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d'ici</a> , toujours avec l'aide de Mercurial, et cela prendra encore environ une demi-heure. <br><br>  Le fichier dont nous avons besoin se trouve dans <code>src/java.base/share/native/libjava/System.c</code> . <br><br>  Avez-vous remarqué qu'il s'agit du chemin d'accès au fichier, et pas seulement du nom?  C'est vrai, vous pouvez pousser votre nouvelle idée à la mode brillante, achetée 200 $ par an.  Vous pouvez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">essayer CLion</a> , mais afin d'éviter des dommages mentaux irréversibles, il est préférable de simplement prendre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Visual Studio Code</a> .  Il met déjà en évidence quelque chose, mais ne comprend toujours pas ce qu'il a vu (il ne raye pas tout en rouge). <br><br>  Relecture courte de <code>System.c</code> : <br><br><pre> <code class="hljs lisp">java_props_t *sprops = GetJavaProperties(<span class="hljs-name"><span class="hljs-name">env</span></span>)<span class="hljs-comment"><span class="hljs-comment">; PUTPROP(props, "os.version", sprops-&gt;os_version);</span></span></code> </pre><br>  À leur tour, ils sont pris dans <code>src/java.base/unix/native/libjava/java_props_md.c</code> . <br>  Chaque plate-forme a son propre fichier, ils passent par <code>#define</code> . <br><br>  Et ici ça commence.  Il existe de nombreuses plateformes.  Toute nécrophilie comme AIX peut être notée, car GraalVM ne la prend pas officiellement en charge (pour autant que je sache, GNU-Linux, macOS et Windows sont prévus au début).  GNU / Linux et Windows prennent en charge l'utilisation de <code>&lt;sys/utsname.h&gt;</code> , qui a des méthodes prédéfinies pour obtenir le nom et la version du système d'exploitation. <br><br>  Mais macOS a un <a href="">terrible morceau de govnokod</a> . <br><br><ul><li>  Le nom «Mac OS X» y est enduit dur (bien qu'il ait longtemps été macOS); </li><li>  Cela dépend de la version de makoshi.  Avant la version 10.9, le SDK n'avait pas de fonction <code>operatingSystemVersion</code> et vous deviez lire <code>SystemVersion.plist</code> main; </li><li>  Pour cette soustraction, il utilise l'extension ObjC quelque chose comme ceci: </li></ul><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// Fallback if running on pre-10.9 Mac OS if (osVersionCStr == NULL) { NSDictionary *version = [NSDictionary dictionaryWithContentsOfFile : @"/System/Library/CoreServices/SystemVersion.plist"]; if (version != NULL) { NSString *nsVerStr = [version objectForKey : @"ProductVersion"]; if (nsVerStr != NULL) { osVersionCStr = strdup([nsVerStr UTF8String]); } } }</span></span></code> </pre><br>  Si au départ il y avait une idée de réécrire manuellement dans un bon style, alors ça s'est rapidement écrasé dans la réalité.  Et si je déconne quelque part dans la jungle de ces nouilles de ifs, quelqu'un le cassera et me suspendra sur la place centrale?  Eh bien nafig.  <strong>Il est nécessaire de copier-coller.</strong> <br><br><h2>  Conclusions </h2><br><ul><li>  L'IDE n'est pas nécessaire; </li><li>  Toute communication avec C ++ est douloureuse, désagréable, incomprise à première vue. </li></ul><br><h1>  Le copier-coller est la norme? </h1><br>  C'est une question importante dont dépend la quantité de tourments supplémentaires.  Je ne voulais vraiment pas réécrire manuellement, mais aller en justice pour avoir violé des licences est encore pire.  Je suis donc allé au github et j'ai directement demandé à Codrut Stancu.  Voici ce qu'il a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">répondu</a> : <br><br>  <em>»La réutilisation du code OpenJDK, par exemple, le copier-coller est une chose normale du point de vue des licences.</em>  <em>Cependant, il y a une très bonne raison à cela.</em>  <em>Si une fonctionnalité peut être implémentée en réutilisant le code JDK sans copier, par exemple en le patchant avec une substitution, ce sera bien mieux. "</em> <br><br>  Cela ressemble à une autorisation officielle de copier-coller! <br><br><h1>  Nous avons parlé normalement ... </h1><br>  J'ai commencé à porter ce morceau de code, mais j'ai rencontré ma paresse.  Pour tester macOS pour différentes versions, vous devez en trouver au moins un avec le Mountain Lion nécrophile 10.8.  J'ai deux de mes appareils Apple disponibles et un d'un ami, et je peux le déployer sur un VMWare d'essai. <br><br>  Mais la paresse.  Et cette paresse m'a sauvé. <br><br>  Je suis allé dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">salle de chat</a> et j'ai demandé à Chris Seaton quelle chaîne d'outils était la plus appropriée pour l'assemblage.  Quelle version du système d'exploitation est prise en charge, compilateur C ++, etc. <br><br>  En réponse, il a reçu un silence surpris de la conversation et Chris a répondu qu'il ne comprenait pas l'essence du problème. <br><br>  Il a fallu un peu de temps pour que Chris puisse comprendre ce que je voulais faire et lui a demandé de <strong>ne plus jamais le faire</strong> . <br><blockquote>  Il manque vraiment l'idée de SVM.  SVM est pur Java, il n'est pas censé y avoir du code à partir d'OpenJDK.  Vous pouvez le lire, le convertir en Java, mais personne ne veut de code C ++ d'OpenJDK.  C'est la dernière chose que nous voulons. <br></blockquote><br>  L'exemple des bibliothèques de mathématiques ne l'a pas convaincu.  Au minimum, ils sont écrits en C, et l'inclusion de C ++ signifierait la connexion d'un tout nouveau langage à la base de code.  Et celui qui est fufufu. <br><br>  Que faut-il faire?  Écrivez en <strong>Java système</strong> . <br><br>  Et si les appels au SDK de la plateforme C / C ++ ne peuvent pas être évités, il doit s'agir d'un appel système unique encapsulé dans l'API C.  Les données sont extraites en Java, puis la logique métier est écrite strictement en Java, même si le Kit de développement Platform SDK dispose de méthodes prêtes à l'emploi pratiques pour le faire différemment du côté C ++. <br><br>  J'ai soupiré et j'ai commencé à étudier le code source pour comprendre comment cela peut être fait différemment. <br><br><h2>  Conclusions </h2><br><ul><li>  Discutez avec les gens du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chat de</a> tout détail obscur.  Ils répondent si les questions ne sont pas complètement idiotes.  Bien que cet exemple montre que Chris est prêt à discuter de questions idiotes, même si cela ne lui fait pas gagner du temps personnellement; </li><li>  C ++ n'est pas du tout présent dans le projet.  Il n'y a aucune raison de croire que quelqu'un le laissera le traîner sous le plancher; </li><li>  Au lieu de cela, vous devez écrire dans System Java en utilisant C en dernier recours (par exemple, lors de l'appel du SDK de la plate-forme). </li></ul><br><h1>  Le violoniste n'est pas nécessaire </h1><br><blockquote>  Un violoniste n'est pas nécessaire, cher.  Il ne mange que trop de carburant. <br></blockquote><br>  Ensuite, j'ai été submergé de tristesse, car regardez ici.  Si sous Windows, nous avons <code>&lt;sys/utsname.h&gt;</code> , et nous espérons bêtement pour sa réponse - c'est facile et simple. <br><br>  Mais s'il n'est pas là, que devra-t-il faire? <br><br><ul><li>  Appeler les commandes intégrées cmd ou les utilitaires Windows?  Publier du texte en russe qui doit être analysé.  C'est tout en bas, et cela peut ne pas coïncider avec ce que le vrai OpenJDK répondra à cet endroit. </li><li>  Prendre du registre?  Même ici, il y a des nuances, par exemple, lors du passage de Windows 7 à 10, la méthode de stockage des numéros numériques dans le Registre a changé, et dans Windows 10, la version doit être collée avec les mains des composants majeurs et mineurs, ou simplement répondre qu'il s'agit de Windows 10 à un chiffre.  Laquelle de ces méthodes est la plus correcte (ne fera pas repentir les culs des utilisateurs) n'est pas claire. </li></ul><br>  Heureusement, mon angoisse a été <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interrompue par la</a> quête de traction de Paul Woegerer, qui a tout réglé. <br><br>  Fait intéressant, au début, tout a été réparé dans l'assistant ( <code>os.version</code> cessé de donner la valeur <code>null</code> dans le test), et ce n'est qu'alors que j'ai remarqué une pull pull.  Le problème est que ce commit n'est pas marqué sur le github comme une requête de pull - c'est un commit simple avec l'inscription <code>PullRequest: graal/1885</code> dans le commentaire.  Le fait est que les mecs d'Oracle Labs n'utilisent pas Github, ils en ont seulement besoin pour interagir avec des committers externes.  Tous ceux d'entre nous qui n'ont pas eu la chance de travailler chez Oracle Labs doivent s'abonner aux notifications de nouveaux commits dans le référentiel et les lire tous. <br><br>  Mais maintenant, vous pouvez vous détendre et voir comment implémenter <em>correctement</em> cette fonctionnalité. <br><br>  Voyons de quel genre de bête il s'agit, System Java. <br><br>  Comme je l'ai dit plus tôt, tout est simple, comme le dos d'une pelle, quand ils essaient de vous casser les dents.  Et tout aussi douloureux.  Jetez un œil à la citation de la piscine: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">osVersionValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (osVersionValue != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue; } <span class="hljs-comment"><span class="hljs-comment">/* On OSX Java returns the ProductVersion instead of kernel release info. */</span></span> CoreFoundation.CFDictionaryRef dict = CoreFoundation._CFCopyServerVersionDictionary(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dict.isNull()) { dict = CoreFoundation._CFCopySystemVersionDictionary(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dict.isNull()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue = <span class="hljs-string"><span class="hljs-string">"Unknown"</span></span>; } CoreFoundation.CFStringRef dictKeyRef = DarwinCoreFoundationUtils.toCFStringRef(<span class="hljs-string"><span class="hljs-string">"MacOSXProductVersion"</span></span>); CoreFoundation.CFStringRef dictValue = CoreFoundation.CFDictionaryGetValue(dict, dictKeyRef); CoreFoundation.CFRelease(dictKeyRef); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dictValue.isNull()) { dictKeyRef = DarwinCoreFoundationUtils.toCFStringRef(<span class="hljs-string"><span class="hljs-string">"ProductVersion"</span></span>); dictValue = CoreFoundation.CFDictionaryGetValue(dict, dictKeyRef); CoreFoundation.CFRelease(dictKeyRef); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dictValue.isNull()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue = <span class="hljs-string"><span class="hljs-string">"Unknown"</span></span>; } osVersionValue = DarwinCoreFoundationUtils.fromCFStringRef(dictValue); CoreFoundation.CFRelease(dictValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> osVersionValue; }</code> </pre><br>  En d'autres termes, nous écrivons en Java mot pour mot ce que nous écririons en C. <br><br>  <code>DarwinExecutableName</code> à l' <code>DarwinExecutableName</code> : <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Find out how long the executable path is. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CIntPointer sizePointer = StackValue.get(CIntPointer.class); sizePointer.write(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DarwinDyld._NSGetExecutablePath(WordFactory.nullPointer(), sizePointer) != -<span class="hljs-number"><span class="hljs-number">1</span></span>) { VMError.shouldNotReachHere(<span class="hljs-string"><span class="hljs-string">"DarwinExecutableName.getExecutableName: Executable path length is 0?"</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/* Allocate a correctly-sized buffer and ask again. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] byteBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[sizePointer.read()]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (PinnedObject pinnedBuffer = PinnedObject.create(byteBuffer)) { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CCharPointer bufferPointer = pinnedBuffer.addressOfArrayElement(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DarwinDyld._NSGetExecutablePath(bufferPointer, sizePointer) == -<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* Failure to find executable path. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String executableString = CTypeConversion.toJavaString(bufferPointer); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String result = realpath(executableString); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br>  Tous ces <code>CIntPointer</code> , <code>CCharPointer</code> , <code>PinnedObject</code> , quoi. <br><br>  À mon goût, c'est inconfortable et moche.  Vous devez travailler manuellement avec des pointeurs qui ressemblent à des classes Java.  Vous devez appeler la <code>release</code> appropriée à temps pour que la mémoire ne coule pas. <br><br>  Mais s'il vous semble que ce sont <em>des</em> mesures <em>injustifiées</em> , alors vous pouvez regarder à nouveau l' <a href="">implémentation de GC dans .NET</a> et être horrifié de ce à quoi mène le C ++ si vous n'arrêtez pas à temps.  Je vous rappelle qu'il s'agit d'un énorme fichier CPP plus grand qu'un mégaoctet.  Il existe <a href="">quelques descriptions de</a> son travail, mais elles sont clairement insuffisantes pour être comprises par un contributeur externe.  Le code ci-dessus, bien qu'assez méchant, est tout à fait compréhensible et analysé au moyen d'une analyse statique pour Java. <br><br>  Quant à l'essence du commit, j'ai des questions pour lui.  Et au moins le support de Windows n'y est pas implémenté.  Lorsqu'un codegen apparaît pour Windows, je vais essayer de me charger de cette tâche. <br><br><h2>  Conclusions </h2><br><ul><li>  Besoin d'écrire en Java système.  Louange, appelle le pain sucré.  Il n'y a toujours pas d'options; </li><li>  Abonnez-vous aux notifications du référentiel sur GitHub et lisez les commits, sinon les PR importants passeront; </li><li>  Si possible, renseignez-vous sur toute caractéristique importante de ceux qui sont responsables de ce domaine.  Il y a beaucoup de choses qui sont mises en œuvre, mais elles ne sont pas encore connues du grand public.  Il y a une chance d'inventer un vélo, et bien pire que celui fabriqué par les gars d'Oracle Labs; </li><li>  Lorsque vous abordez une fonctionnalité, assurez-vous d'en informer le responsable du github.  S'il ne répond pas - écrivez une lettre, les adresses de tous les membres de l'équipe sont facilement googlé. </li></ul><br><h1>  Épilogue </h1><br>  Cette bataille se termine, mais pas la guerre du tout. <br><br>  Combattant, attendez avec sensibilité les nouveaux articles sur Habré et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rentrez dans nos rangs</a> ! <br><br>  Je tiens à vous rappeler qu'Oleg Shelaev, le seul évangéliste <strong>officiel</strong> GraalVM d'Oracle, viendra à la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prochaine conférence Joker</a> .  Pas seulement "le seul russophone", mais "le seul en général".  Le titre du rapport ( <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«Compilation Java à l'avance avec GraalVM»</a></em> ) indique que SubstrateVM ne peut pas s'en passer. <br><br>  Soit dit en passant, Oleg a récemment reçu une arme de service - un compte rendu sur Habré, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">shelajev-oleg</a> .  Il n'y a pas encore de messages, mais vous pouvez lancer ce nom d'utilisateur. <br><br>  Vous pouvez parler avec Oleg et Oleg dans notre chat room-chat en Telegram: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@graalvm_ru</a> .  Contrairement à ishshuyev sur Github, vous pouvez y communiquer sous n'importe quelle forme, et personne ne sera interdit ( <em>mais ce n'est pas exact</em> ). <br><br>  Je vous rappelle également que chaque semaine, avec le podcast Debriefing, nous faisons la sortie du Java Digest.  Par exemple, c'était le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dernier condensé</a> .  De temps en temps, les informations sur GraalVM sautent là-bas (en fait, je ne transforme pas le problème en un communiqué de presse GraalVM juste pour le respect du public :-) <br><br>  Merci d'avoir lu ceci - et à bientôt! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr420455/">https://habr.com/ru/post/fr420455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr420441/index.html">Les 10 erreurs de sécurité les plus courantes en Python et comment les éviter</a></li>
<li><a href="../fr420443/index.html">Des experts en cybersécurité ont créé un détecteur d'écumoire - SkimReaper</a></li>
<li><a href="../fr420447/index.html">Computer History Museum - l'endroit où l'informatique est enregistrée</a></li>
<li><a href="../fr420451/index.html">Serveur dans les nuages: se préparer au lancement</a></li>
<li><a href="../fr420453/index.html">Webinaires Skillbox Friday: développement et tout ce qui s'y rapporte</a></li>
<li><a href="../fr420457/index.html">Présentation du logiciel d'impression 3D Simplify3D</a></li>
<li><a href="../fr420459/index.html">Icône avec un compteur dans la barre d'outils supérieure: un exemple d'une variété d'approches pour une tâche</a></li>
<li><a href="../fr420461/index.html">10 citations de mauvais designers</a></li>
<li><a href="../fr420463/index.html">ICO à juste titre en déclin, mais ils ont une chance de changer</a></li>
<li><a href="../fr420465/index.html">Variables Nginx avec njs: simples, indolores et via JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>