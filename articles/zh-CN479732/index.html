<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🔬 👩‍🌾 🤸 停止发出其他内容作为内存泄漏 😘 ➡️ 🕤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="迄今为止，已经写了 很多 文章 ， 您需要取消订阅 Observable RxJS订阅，否则会发生内存泄漏 。 对于大多数此类文章的读者来说，坚定的规则是“签名？-签名！”。 但是，不幸的是，此类文章中的信息经常会失真或无法协商，甚至在替换概念时更糟。 我们将讨论这个。 





 以这篇文章为例...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>停止发出其他内容作为内存泄漏</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479732/"><p>迄今为止，已经写<a href="https://habr.com/ru/post/425959/">了</a> <a href="https://medium.com/alexonozor/angular-rxjs-please-always-unsubscribe-86ca55ba7f12" rel="nofollow">很多</a> <a href="https://habr.com/ru/post/351338/">文章</a> ， <a href="https://medium.com/ngx/why-do-you-need-unsubscribe-ee0c62b5d21f" rel="nofollow">您需要取消订阅</a> Observable RxJS订阅，否则会发生<strong>内存泄漏</strong> 。 对于大多数此类文章的读者来说，坚定的规则是“签名？-签名！”。 但是，不幸的是，此类文章中的信息经常会失真或无法协商，甚至在替换概念时更糟。 我们将讨论这个。 </p><br><p><img src="https://habrastorage.org/webt/oa/f5/pf/oaf5pfujlesdzjavtjopl6z4_gi.jpeg"></p><a name="habracut"></a><br><p> 以这篇文章为例： <a href="https://medium.com/ngx/why-do-you-need-unsubscribe-ee0c62b5d21f" rel="nofollow">https</a> : <a href="https://medium.com/ngx/why-do-you-need-unsubscribe-ee0c62b5d21f" rel="nofollow">//medium.com/ngx/why-do-you-need-unsubscribe-ee0c62b5d21f</a> </p><br><p><img src="https://habrastorage.org/webt/n2/av/hm/n2avhmxwuemrtc0tvv7noyhl2za.png"></p><br><p> 当他们对我说“ <strong>可能</strong>会降低生产率的机会”时，我立即想到了<a href="http://optimization.guide/" rel="nofollow">过早的优化</a> 。 </p><br><p><img src="https://habrastorage.org/webt/on/__/rg/on__rgsm7admmp7p1u9t2gok4mu.png"></p><br><p><img src="https://habrastorage.org/webt/hw/rz/rw/hwrzrwkwlzlxmdhi3d2uusuj7sa.png"></p><br><p> 我们继续阅读该人的昵称，是<strong>Reactive Fox</strong> ： <br><img src="https://habrastorage.org/webt/fn/6j/qn/fn6jqnrypjv7e1zo_v9kg43jkv4.png"></p><br><p><img src="https://habrastorage.org/webt/ue/w2/mg/uew2mga3qjig9rint74jn7i0q0q.png"></p><br><p> 此外，还有有用的信息和提示。 我同意您应该始终退订<strong>RxJS中无尽的流</strong> 。 但我只关注有害信息（我认为）。 <br><img src="https://habrastorage.org/webt/e1/ep/rz/e1eprzkk7depkecysfapwnlmhkc.png"></p><br><p> 哇...赶上了恐怖。 目前这种缺乏事实根据的威胁（没有指标，数字……）导致了这样一个事实，即对于大量前端用户而言，缺乏取消订阅就像是公牛的一块红布。 当他们偶然发现这一点时，除了这块破布，他们再也看不到其他东西了。 <br><img src="https://habrastorage.org/webt/1i/-o/c_/1i-oc_a48-jwxjp7xyfgofkajpe.jpeg"></p><br><p> 文章的作者甚至进行了演示应用程序，试图证明他的想法： <br>  <a href="https://stackblitz.com/edit/why-you-have-to-unsubscribe-from-observable-material" rel="nofollow">https://stackblitz.com/edit/why-you-have-to-unsubscribe-from-observable-material</a> </p><br><p> 确实，在他的立场上，您可以看到处理器如何执行不必要的工作（当我没有单击任何东西时）以及内存消耗如何增加（小的变化）： </p><br><p> <a href="" rel="nofollow"><img src="https://habrastorage.org/webt/lm/4r/p_/lm4rp_3sl0zqb11rf5dsufwdole.png"></a> </p><br><p> 为了确认您<strong>始终</strong>需要取消订阅Observable <strong>HttpClient</strong>请求这一事实，他添加了一个请求拦截器，该请求拦截器在控制台中显示“仍然活跃...仍然活跃...仍然活跃...”： <br><img src="https://habrastorage.org/webt/cs/m-/tz/csm-tzst2fx6prkarqwx_dfc_k4.png"><br> 即 这个人截取了最后的数据流，将其设为<strong>无限</strong> （在发生错误的情况下，会重复请求，但错误总是会发生），并以此作为证据，表明您需要退订最终的数据流。 </p><br><p>  <strong>StackBlitz</strong>不太适合测量应用程序性能，因为 升级过程中会自动进行同步，并且会占用资源。 所以我做了测试应用程序： <a href="https://github.com/andchir/test-angular-app" rel="nofollow">https</a> : <a href="https://github.com/andchir/test-angular-app" rel="nofollow">//github.com/andchir/test-angular-app</a> </p><br><p> 那里有两个窗户。 当您打开每个文件时，都会将请求发送到<strong>action.php</strong> ，其中模仿了非常耗费资源的操作，其中有3秒的延迟。 而且<strong>action.php</strong>会将所有请求记录到<strong>log.txt</strong>文件中。 </p><br><div class="spoiler">  <b class="spoiler_title">Action.php代码</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> header(<span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logging</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($str, $fileName = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'log.txt'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array($str)) { $str = json_encode($str); } $rootPath = <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span>; $logFilePath = $rootPath . DIRECTORY_SEPARATOR . $fileName; $options = [ <span class="hljs-string"><span class="hljs-string">'max_log_size'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">200</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_dir(dirname($logFilePath))) { mkdir(dirname($logFilePath)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (file_exists($logFilePath) &amp;&amp; filesize($logFilePath) &gt;= $options[<span class="hljs-string"><span class="hljs-string">'max_log_size'</span></span>]) { unlink($logFilePath); } $fp = fopen( $logFilePath, <span class="hljs-string"><span class="hljs-string">'a'</span></span> ); $dateFormat = <span class="hljs-string"><span class="hljs-string">'d/m/YH:i:s'</span></span>; $str = PHP_EOL . PHP_EOL . date($dateFormat) . PHP_EOL . $str; fwrite( $fp, $str ); fclose( $fp ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } $actionName = <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]) &amp;&amp; !is_array($_GET[<span class="hljs-string"><span class="hljs-string">'a'</span></span>]) ? $_GET[<span class="hljs-string"><span class="hljs-string">'a'</span></span>] : <span class="hljs-string"><span class="hljs-string">'1'</span></span>; logging(<span class="hljs-string"><span class="hljs-string">"STARTED-{$actionName}"</span></span>); sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>);<span class="hljs-comment"><span class="hljs-comment">// Very resource-intensive operation that takes 3 seconds logging("COMPLETED-{$actionName}"); echo json_encode([ 'success' =&gt; true, 'data' =&gt; ['name' =&gt; 'test', 'title' =&gt; 'This is a test'] ]);</span></span></code> </pre> </div></div><br><p> 但是首先是一个小题外话。 在下面的图片（可单击）中，您可以看到一个简单的示例，说明JavaScript垃圾收集器如何在Chrome浏览器中工作。 发生了PUSH，但是setTimeout并未阻止垃圾收集器清除内存。 <br> <a href="" rel="nofollow"><img src="https://habrastorage.org/webt/ly/r0/1w/lyr01wmysa9pphmphoj8aa39aaq.png"></a> </p><br><p> 实验时，请不要忘记按一下按钮来调用垃圾收集器。 <br><img src="https://habrastorage.org/webt/ir/k4/j4/irk4j4izd09-npb06n2zysccpum.png"></p><br><p> 让我们回到我的测试应用程序。 这是两个窗口的代码： </p><br><div class="spoiler">  <b class="spoiler_title">BadModalComponent代码</b> <div class="spoiler_text"><pre> <code class="javascript hljs">@Component({ <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: <span class="hljs-string"><span class="hljs-string">'app-bad-modal'</span></span>, <span class="hljs-attr"><span class="hljs-attr">templateUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'./bad-modal.component.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">styleUrls</span></span>: [<span class="hljs-string"><span class="hljs-string">'./bad-modal.component.css'</span></span>], <span class="hljs-attr"><span class="hljs-attr">providers</span></span>: [HttpClient] }) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BadModalComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnDestroy</span></span></span><span class="hljs-class"> </span></span>{ loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; largeData: number[] = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">new</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1000000</span></span></span></span></span><span class="hljs-function">)).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">destroyed$</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Subject</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">void</span></span></span><span class="hljs-function">&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataInterface</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">constructor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> private http: HttpClient, private bsModalRef: BsModalRef </span></span></span><span class="hljs-function">) { } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ngOnInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">void</span></span></span><span class="hljs-function"> { // </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">For</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">example</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">only</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">not</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">production</span></span></span><span class="hljs-function">. </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loading</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">true</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">const</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">subscription</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">http</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">get</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataInterface</span></span></span><span class="hljs-function">&gt;(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'/action.php?a=2'</span></span></span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pipe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> takeUntil(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.destroyed$</span></span></span><span class="hljs-function">), </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">catchError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(err</span></span></span><span class="hljs-function">) =&gt;</span></span> throwError(err.message)), finalize(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'FINALIZE'</span></span>)) ) .subscribe({ <span class="hljs-attr"><span class="hljs-attr">next</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">) =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'LOADED'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = res; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'ERROR - SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'ERROR - SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, error); }, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'COMPLETED - SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'COMPLETED - SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'COMPLETED'</span></span>); } }); } close(event?: MouseEvent): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event) { event.preventDefault(); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bsModalRef.hide(); } ngOnDestroy() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'DESTROY'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.destroyed$.next(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.destroyed$.complete(); } }</code> </pre> </div></div><br><p> 如您所见，有一个取消订阅（takeUntil）。  “老师”所建议的一切。 还有很多。 </p><br><div class="spoiler">  <b class="spoiler_title">GoodModalComponent代码</b> <div class="spoiler_text"><pre> <code class="javascript hljs">@Component({ <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: <span class="hljs-string"><span class="hljs-string">'app-good-modal'</span></span>, <span class="hljs-attr"><span class="hljs-attr">templateUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'./good-modal.component.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">styleUrls</span></span>: [<span class="hljs-string"><span class="hljs-string">'./good-modal.component.css'</span></span>] }) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GoodModalComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnDestroy</span></span></span><span class="hljs-class"> </span></span>{ loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; largeData: number[] = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">new</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">Array</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1000000</span></span></span></span></span><span class="hljs-function">)).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fill</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataInterface</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">constructor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> private http: HttpClient, private bsModalRef: BsModalRef </span></span></span><span class="hljs-function">) { } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ngOnInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">void</span></span></span><span class="hljs-function"> { // </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">For</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">example</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">only</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">not</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">production</span></span></span><span class="hljs-function">. </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loading</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">true</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">const</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">subscription</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">http</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">get</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DataInterface</span></span></span><span class="hljs-function">&gt;(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'/action.php?a=1'</span></span></span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pipe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> catchError((err</span></span></span><span class="hljs-function">) =&gt;</span></span> throwError(err.message)), finalize(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'FINALIZE'</span></span>)) ) .subscribe({ <span class="hljs-attr"><span class="hljs-attr">next</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">) =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'LOADED'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = res; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">) =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'ERROR - SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'ERROR - SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, error); }, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(subscription.closed ? <span class="hljs-string"><span class="hljs-string">'COMPLETED - SUBSCRIPTION IS CLOSED'</span></span> : <span class="hljs-string"><span class="hljs-string">'COMPLETED - SUBSCRIPTION IS NOT CLOSED!'</span></span>); }, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'COMPLETED'</span></span>); } }); } close(event?: MouseEvent): <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event) { event.preventDefault(); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bsModalRef.hide(); } ngOnDestroy() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'DESTROY'</span></span>); } }</code> </pre> </div></div><br><p> 具有大数组的属性完全相同，但没有答复。 这并不能阻止我称这个窗口为好窗口。 为什么-稍后。 </p><br><p> 观看视频： </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/jQ5qLosbnOY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p> 如您所见，在两种情况下，切换到第二个组件后，垃圾收集器都成功地将内存恢复为正常值。 是的，关闭窗口后也可以清除内存，但这在我们的实验中并不重要。 事实证明，“老师”说的是错误的： </p><br><blockquote> 例如，您提出了一个请求，但是当答案尚未从后端到达时，您将不必要地破坏该组件，那么<strong>您的订阅将保留该组件的链接</strong> ，从而造成潜在的内存泄漏。 </blockquote><p> 是的，他在谈论<strong>“潜在”</strong>泄漏。 但是，如果流是有限的，那么就不会有内存泄漏。 </p><br><p> 我预见到这种“老师”的愤慨感叹。 他们肯定会告诉我们这样的消息： <em>“好的，没有内存泄漏，但是通过<strong>取消订阅</strong>我们也<strong>取消了请求</strong> ，这意味着我们将确保在收到服务器的响应后不再执行任何代码</em> 。 <em>”</em> 首先，我并不是说退订<strong>总是</strong>不好的，我只是说您正在<strong>替换概念</strong> 。 是的，答案到达后将执行更多无用的操作的事实是不好的，但是<strong>您只能通过取消订阅</strong> （在这种情况下）来保护自己免受<strong>实际内存泄漏的影响</strong> ，并且可以通过<strong>其他方式</strong>保护自己免受<strong>其他不良影响</strong> 。 无需恐吓读者并强加他们自己的代码编写风格。 </p><br><p> 如果用户改变主意，我们是否总是需要取消请求？ 并非总是如此！ 不要忘记您取消了该请求， <strong>但不要取消服务器上的操作</strong> 。 假设用户打开了一个组件，很长时间以来一直在加载某些东西，而他正在切换到另一个组件。  <strong>服务器</strong>可能<strong>已加载并且无法处理</strong>所有请求和操作。 在这种情况下，由于<strong>请求不会在服务器端停止</strong> （在大多数情况下），因此用户可以疯狂地导航中的所有链接并<strong>在服务器上</strong>创建<strong>更大的负载</strong> 。 </p><br><p> 观看以下视频： </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/uAEka7a5_eA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p> 我让用户等待答案。 在大多数情况下，答案很快就会到来，并且不会给用户带来任何不便。  <strong>但是通过这种方式，我们将避免服务器执行重复的繁重操作（如果有）。</strong> </p><br><p> 总结： </p><br><ul><li> 我并不是说<strong>您</strong>不需要取消订阅HttpClient请求的RxJS订阅。 我只是说有时候没有必要。 无需替换概念。 如果您正在谈论内存泄漏，请显示此泄漏。 不是您无尽的<strong>console.log</strong> ，即泄漏。 内存量是多少？ 手术时间是多少？ 这是需要显示的。 </li><li> 我没有将我在测试应用程序中应用的解决方案称为“银弹”。  <strong>相反，我敦促给予追随者更多的自由。</strong> 让他决定如何编写他的代码。 无需恐吓他并强加自己的发展风格。 </li><li> 我反对狂热主义和过早的优化。 我最近看到的太多了。 </li><li> 该浏览器具有比我展示的方法更高级的查找内存泄漏的方法。 我认为这种简单方法的应用就足够了。 但我建议您更详细地熟悉该主题，例如，在本文中： <a href="https://habr.com/ru/post/309318/">https</a> : <a href="https://habr.com/ru/post/309318/">//habr.com/en/post/309318/</a> 。 </li></ul><br><p>  <strong>UPD＃1</strong> <br> 目前，该职位下降了将近一天。 起初他去了利弊，然后评估从零开始。 这意味着观众被精确地分为两个阵营。 我不知道这是好是坏。 </p><br><p>  <strong>UPD＃2</strong> <br> 在评论中，出现了Jet Fox（正在分析的文章的作者）。 起初他感谢我，他很有礼貌。 但是，看到观众的消极情绪，他开始施压。 他说我应该道歉。 即 他撒了谎（谎言在上面用黄色框勾勒出），我应该道歉。 <br> 最初，我认为他在演示应用程序中编写的具有无限重复（很好的重复2-3次）的流的拦截器仅用于测试和通知。 但事实证明，他<a href="https://habr.com/ru/post/479732/">认为</a>他是生活中的榜样。 即 阻塞窗口的按钮- <a href="https://habr.com/ru/post/479732/">这</a>是<a href="https://habr.com/ru/post/479732/">不可能的</a> 。 并创建此类拦截器，违反SOLID原则，违反应用程序的模块化（模块和组件必须彼此独立），让您的单元（组件，服务）的单元测试通过林-您可以。 想象一下情况：您编写了一个组件，并为其编写了单元测试。 然后出现了这样的Fox，在您的应用程序中添加了类似的拦截器，并且您的测试变得无用。 然后他仍然对您说：“您为什么不预测我可能要添加这样的拦截器。那么，请更正您的代码。” 也许在他的团队中这可能是现实，但是我不认为应该鼓励或对此视而不见。 </p><br><p>  <strong>UPD＃3</strong> <br> 这些评论主要讨论订阅和退订。 是否有一个名为“退订邪恶”的帖子？ 不行 我不敦促您不要退订。 像以前一样做。 但是您必须了解为什么要这样做。 退订不是过早的优化。 但是，踏上防范潜在威胁的道路（正如所分析文章的作者所说的那样），您可以越界。 然后，您的代码可能变得超载并且难以维护。 <br> 这篇文章是关于狂热的，它导致未验证信息的分发。 在某些情况下，有必要更加冷静地解决取消订阅的问题（您需要清楚地了解特定情况下是否存在问题）。 </p><br><p>  <strong>UPD＃4</strong> </p><br><blockquote> 相反，我敦促给予追随者更多的自由。 让他决定如何编写他的代码。 </blockquote><p> 在这里您需要澄清。 我追求标准。 但这标准可以由图书馆的作者或他的团队来设置，而事实并非如此（在文档和正式文件中）。 例如，Symfony框架文档的“ <a href="https://symfony.com/doc/current/best_practices.html" rel="nofollow">最佳实践”</a>部分。 如果RxJS文档中的内容相同并且会显示“ signed-unsubscribe”，那么我就不想与他争论。 </p><br><p>  <strong>UPD＃5</strong> <br> 重要评论以及知名人士的回答： <br>  <a href="https://habr.com/ru/post/479732/">https://habr.com/cn/post/479732/#comment_21012620</a> <br>  RxJS开发人员提出的履行<strong>“签署-取消订阅”</strong>合同的建议是<strong>存在的</strong> ，但这是非正式的。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479732/">https://habr.com/ru/post/zh-CN479732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479716/index.html">另一个“世界第一”的SuperApp</a></li>
<li><a href="../zh-CN479718/index.html">使用CI github构建arduino环境应用程序</a></li>
<li><a href="../zh-CN479724/index.html">Tru黑客已经结束</a></li>
<li><a href="../zh-CN479726/index.html">Vladimir aka wowik：“ OpenStreetMap需要在其他系统中无法实现的想法”</a></li>
<li><a href="../zh-CN479728/index.html">如何组织成功的启动？</a></li>
<li><a href="../zh-CN479736/index.html">相机或激光</a></li>
<li><a href="../zh-CN479738/index.html">像Youtube和Instagram：国际化和本地化Python应用程序</a></li>
<li><a href="../zh-CN479742/index.html">后院-多云和混合基础架构之上的自动化服务网格</a></li>
<li><a href="../zh-CN479744/index.html">Python内存管理：关于内存碎片的一些知识</a></li>
<li><a href="../zh-CN479746/index.html">企业软件使您的员工更酷。 需要吗</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>