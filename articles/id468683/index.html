<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤳🏼 🛎️ ❣️ Teori dan praktik standardisasi layanan Docker 🕎 💦 🔼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Informasi tentang topik arsitektur aplikasi microservice, yang telah berhasil mengisi keunggulannya, cukup hari ini untuk memutuskan apakah itu sesuai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teori dan praktik standardisasi layanan Docker</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/antiplagiat/blog/468683/"><p>  Informasi tentang topik arsitektur aplikasi microservice, yang telah berhasil mengisi keunggulannya, cukup hari ini untuk memutuskan apakah itu sesuai dengan produk Anda atau tidak.  Dan sama sekali bukan rahasia bahwa perusahaan yang telah memutuskan untuk memilih jalan ini harus menghadapi banyak tantangan teknik dan budaya.  Salah satu sumber masalah adalah overhead yang berkembang biak di mana-mana, dan ini juga berlaku untuk rutin yang terkait dengan proses produksi. </p><br><p><img src="https://habrastorage.org/webt/6g/-f/o5/6g-fo54hrcctez4vg4-avzkijc0.jpeg"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sumber Gambar:</a></em></sub> </p><br><p>  Seperti yang bisa Anda tebak, Anti-plagiarisme adalah perusahaan seperti itu, di mana pemahaman secara bertahap datang bahwa kami sedang dalam perjalanan dengan layanan-layanan mikro.  Tetapi sebelum mulai memakan kaktus, kami memutuskan untuk membersihkan dan memasaknya.  Dan karena semua satu-satunya solusi yang benar dan benar untuk masing-masing adalah unik, daripada slide DevOps universal dengan panah indah, kami memutuskan untuk hanya berbagi pengalaman kami sendiri dan mengatakan bagaimana kami telah membahas sebagian besar dari jalur khusus kami untuk, saya harap, sukses. </p><a name="habracut"></a><br><p>  Jika Anda membuat produk yang benar-benar unik, jauh dan luas yang terdiri dari pengetahuan, hampir tidak ada peluang untuk menghindari jalur khusus ini, karena ini dibentuk oleh banyak jalur pribadi: mulai dari budaya dan data historis yang telah dikembangkan di perusahaan, diakhiri dengan kekhususan sendiri dan tumpukan teknologi yang digunakan. . </p><br><p>  Salah satu tugas untuk setiap perusahaan dan tim adalah menemukan keseimbangan optimal antara kebebasan dan aturan, dan layanan-layanan mikro membawa masalah ini ke tingkat yang baru.  Ini mungkin tampak bertentangan dengan gagasan layanan mikro, yang menyiratkan kebebasan luas dalam pilihan teknologi, tetapi jika Anda tidak fokus langsung pada masalah arsitektur dan teknologi, tetapi melihat masalah produksi secara keseluruhan, maka risiko berada di suatu tempat dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">plot</a> “Taman Kegembiraan Dunia” cukup nyata. . </p><br><p> Namun, dalam buku "Creating Microservices" Sam Newman menawarkan solusi untuk masalah ini, di mana secara harfiah dari halaman pertama ia berbicara tentang perlunya membatasi kreativitas tim dalam kerangka perjanjian teknis.  Jadi salah satu kunci keberhasilan, terutama dalam konteks sumber daya tangan bebas yang terbatas, adalah standardisasi segala sesuatu yang hanya dapat dinegosiasikan dan tidak ada yang benar-benar ingin melakukannya sepanjang waktu.  Dengan menyusun perjanjian, kami membuat aturan main yang jelas untuk semua peserta dalam produksi dan pengoperasian komponen sistem.  Dan mengetahui aturan mainnya, Anda harus setuju, memainkannya harus lebih mudah dan lebih menyenangkan.  Namun, mengikuti aturan-aturan ini sendiri dapat menjadi rutin dan menyebabkan ketidaknyamanan bagi para peserta, yang secara langsung mengarah pada semua jenis penyimpangan dari mereka dan, sebagai akibatnya, kegagalan seluruh gagasan.  Dan jalan keluar yang paling jelas adalah dengan memasukkan semua perjanjian dalam kode, karena tidak ada satu peraturan pun yang dapat melakukan otomasi dan alat yang mudah digunakan, yang penggunaannya intuitif dan alami. </p><br><p>  Bergerak ke arah ini, kami dapat mengotomatisasi semakin banyak, dan semakin kuat proses kami menjadi seperti konveyor ujung-ke-ujung untuk produksi perpustakaan dan layanan mikro (atau tidak demikian). </p><br><p></p><div class="spoiler">  <b class="spoiler_title">Penafian</b> <div class="spoiler_text">  Teks ini bukan upaya untuk menunjukkan "sebagaimana mestinya", tidak ada solusi universal, hanya deskripsi posisi kita di jalur evolusi dan arah yang dipilih.  Semua hal di atas mungkin tidak cocok untuk semua orang, tetapi dalam kasus kami ini masuk akal karena: <br><br>  - Pengembangan di perusahaan dalam 90% kasus dilakukan dalam C #; <br>  - Tidak perlu memulai dari awal, bagian dari standar, pendekatan dan teknologi yang diterima - ini adalah hasil dari pengalaman atau hanya warisan sejarah; <br>  - Repositori dengan proyek .NET, tidak seperti tim, lusinan (dan akan ada lebih banyak); <br>  - Kami ingin menggunakan pipa CI yang sangat sederhana, menghindari vendor lock-in sebanyak mungkin; <br>  - Untuk pengembang .NET biasa, kata-kata "container", "docker" dan "Linux" masih dapat menyebabkan serangan horor eksistensial, tetapi saya tidak ingin mematahkan siapa pun melalui lutut. </div></div><br><h2 id="nemnogo-predystorii">  Sedikit latar belakang </h2><br><p>  Pada musim semi 2017, Microsoft memperkenalkan pratinjau .NET Core 2.0 kepada dunia, dan tahun ini para astrolog C # bergegas untuk mendeklarasikan Tahun Linux, jadi ... </p><br><p><img src="https://habrastorage.org/webt/ex/zm/0r/exzm0rw_jaawe48lclqgweok1rq.png"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sumber Gambar:</a></em></sub> </p><br><p>  Untuk beberapa waktu kami, tidak mempercayai sulap, mengumpulkan dan menguji semuanya pada Windows dan Linux, menerbitkan artefak dengan beberapa skrip SSH, mencoba mengonfigurasi pipa CI / CD lama dalam mode pisau Swiss.  Tetapi setelah beberapa waktu mereka menyadari bahwa kami melakukan sesuatu yang salah.  Selain itu, referensi ke layanan-layanan dan wadah mikro semakin sering terdengar.  Jadi kami juga memutuskan untuk naik gelombang hype dan menjelajahi arah ini. </p><br><p>  Sudah pada tahap refleksi tentang kemungkinan masa depan layanan mikro kami, sejumlah pertanyaan muncul, mengabaikan yang, kami mengambil risiko dalam masalah baru di masa depan yang akan kami buat untuk diri kami sendiri dengan imbalan yang sudah diselesaikan. </p><br><p>  Pertama, ketika melihat sisi operasi dunia microservice teoretis tanpa aturan, kami takut dengan prospek kekacauan dengan semua konsekuensi yang terjadi, termasuk tidak hanya kualitas hasil yang tidak dapat diprediksi, tetapi juga konflik antara tim atau pengembang dan insinyur.  Dan mencoba memberikan beberapa rekomendasi, tidak dapat memastikan kepatuhan dengan mereka, segera tampak seperti usaha kosong. </p><br><p>  Kedua, tidak ada yang benar-benar tahu cara membuat wadah dengan benar dan menulis file docker, yang, bagaimanapun, sudah mulai ramai di repositori kami.  Selain itu, banyak "membaca di suatu tempat" yang semuanya tidak begitu sederhana di sana.  Jadi, seseorang harus menyelam lebih dalam dan mencari tahu, lalu kembali dengan praktik perakitan kontainer terbaik.  Tetapi prospek mengambil peran sebagai buruh pelabuhan buruh pelabuhan penuh waktu, dibiarkan sendiri dengan tumpukan file buruh pelabuhan, untuk beberapa alasan tidak menginspirasi siapa pun di perusahaan.  Selain itu, ternyata, menyelam sekali jelas tidak cukup, dan bahkan terlihat baik dan benar pada pandangan pertama, itu bisa berubah menjadi salah atau tidak terlalu bagus. </p><br><p>  Dan ketiga, saya ingin memastikan bahwa gambar yang diperoleh dengan layanan tidak hanya benar dari sudut pandang praktik wadah, tetapi juga dapat diprediksi dalam perilaku mereka dan akan memiliki semua sifat dan atribut yang diperlukan untuk menyederhanakan kontrol wadah yang diluncurkan.  Dengan kata lain, saya ingin mendapatkan gambar dengan aplikasi yang sama-sama dikonfigurasi dan menulis log, menyediakan antarmuka tunggal untuk mendapatkan metrik, memiliki satu set label yang konsisten, dan sejenisnya.  Penting juga bahwa perakitan di komputer pengembang menghasilkan hasil yang sama dengan perakitan di sistem CI apa pun, termasuk lulus tes dan menghasilkan artefak. </p><br><p>  Dengan demikian, lahir pemahaman bahwa beberapa proses akan diperlukan untuk mengelola dan memusatkan pengetahuan, praktik, dan standar baru, dan jalur dari komitmen pertama ke citra buruh pelabuhan yang sepenuhnya siap untuk infrastruktur produk harus disatukan dan seotomatis mungkin, tidak melampaui persyaratan awal dengan kata terus menerus. </p><br><h2 id="cli-vs-gui">  CLI vs.  GUI </h2><br><p>  Titik awal untuk komponen baru, baik itu layanan atau perpustakaan, adalah membuat repositori.  Tahap ini dapat dibagi menjadi dua bagian: membuat dan mengkonfigurasi repositori di hosting sistem kontrol versi (kami memiliki Bitbucket) dan menginisialisasi dengan membuat struktur file.  Untungnya, sejumlah persyaratan sudah ada untuk keduanya.  Oleh karena itu, memformalkannya dalam kode adalah tugas yang logis. </p><br><p>  Jadi, apa yang seharusnya menjadi gudang kami: </p><br><ul><li>  Terletak di salah satu proyek, di mana nama, hak akses, kebijakan untuk menerima permintaan tarik, dll.; </li><li>  Berisi file dan direktori yang diperlukan, seperti: <br><ul><li> file dengan konfigurasi dan informasi tentang repositori <code>SolutionInfo.props</code> (lebih lanjut tentang itu di bawah); </li><li>  kode sumber proyek di direktori <code>src</code> ; </li><li>  <code>.gitignore</code> , <code>README.md</code> , dll.; </li></ul></li><li>  Berisi submodula Git yang diperlukan; </li><li>  Proyek harus berasal dari salah satu templat. </li></ul><br><p>  Karena Bitbucket REST API memberikan kontrol penuh atas konfigurasi repositori, sebuah utilitas khusus diciptakan untuk berinteraksi dengannya - generator repositori.  Dalam mode tanya jawab, ia menerima dari pengguna semua data yang diperlukan dan membuat repositori yang sepenuhnya memenuhi semua persyaratan kami, yaitu: </p><br><ul><li>  Menentukan proyek di Bitbucket untuk dipilih; </li><li>  Memvalidasi nama sesuai dengan perjanjian kami; </li><li>  Membuat semua pengaturan yang diperlukan yang tidak dapat diwarisi dari proyek; </li><li>  Memperbarui daftar templat khusus (kami menggunakan <a href="">dotnet templating</a> ) untuk proyek dan menyarankan untuk memilihnya; </li><li>  Mengisi informasi minimum yang diperlukan tentang repositori dalam file konfigurasi dan dalam <code>*.md</code> dokumen; </li><li>  Ini menghubungkan submodul dengan konfigurasi pipa CI / CD (dalam kasus kami adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bamboo Specs</a> ) dan skrip perakitan. </li></ul><br><p>  Dengan kata lain, pengembang, memulai proyek baru, meluncurkan utilitas, mengisi beberapa bidang, memilih jenis proyek dan menerima, misalnya, "Halo dunia!"  layanan yang sudah terhubung ke sistem CI, dari mana layanan itu bahkan dapat diterbitkan jika Anda membuat komit yang mengubah versi menjadi nol. </p><br><p>  Langkah pertama telah diambil.  Tidak ada pekerjaan manual dan kesalahan, mencari dokumentasi, registrasi dan SMS.  Sekarang mari kita beralih ke apa yang dihasilkan di sana. </p><br><h2 id="struktura">  Struktur </h2><br><p>  Standarisasi struktur repositori telah berakar bersama kami untuk waktu yang lama dan diperlukan untuk menyederhanakan perakitan, integrasi dengan sistem CI dan lingkungan pengembangan.  Awalnya, kami mulai dari gagasan bahwa pipa di CI harus sesederhana dan, seperti yang Anda duga, standar, yang akan memastikan portabilitas dan reproduktifitas perakitan.  Artinya, hasil yang sama dapat dengan mudah diperoleh baik di sistem CI apa pun dan di tempat kerja pengembang.  Oleh karena itu, segala sesuatu yang tidak berhubungan dengan fitur-fitur lingkungan integrasi berkesinambungan spesifik disampaikan ke submodule Git khusus dan merupakan sistem pembangunan mandiri.  Lebih tepatnya, sistem standarisasi perakitan.  Pipa itu sendiri, dengan perkiraan minimum, seharusnya hanya menjalankan skrip <code>build.sh</code> , mengambil laporan tentang tes dan memulai penyebaran, jika perlu.  Untuk kejelasan, mari kita lihat apa yang terjadi jika Anda membuat repositori <em>SampleService</em> dalam proyek dengan nama <em>Sandbox</em> . </p><br><pre> <code class="plaintext hljs">. ├── [bamboo-specs] ├── [devops.build] │ ├── build.sh │ └── ... ├── [docs] ├── [.scripts] ├── [src] │ ├── [CodeAnalysis] │ ├── [Sandbox.SampleService] │ ├── [Sandbox.SampleService.Bootstrap] │ ├── [Sandbox.SampleService.Client] │ ├── [Sandbox.SampleService.Tests] │ ├── Directory.Build.props │ ├── NLog.config │ ├── NuGet.Config │ └── Sandbox.SampleService.sln ├── .gitattributes ├── .gitignore ├── .gitmodules ├── CHANGELOG.md ├── README.md └── SolutionInfo.props</code> </pre> <br><p>  Dua direktori pertama adalah Git submodules.  <code>bamboo-specs</code> adalah “Pipeline as Code” untuk sistem Atlassian Bamboo CI (mungkin ada beberapa Jenkinsfile sebagai gantinya), <code>devops.build</code> adalah sistem build kami, yang akan saya bahas secara lebih rinci di bawah ini.  Direktori <code>.scripts</code> juga <code>.scripts</code> .  Proyek .NET itu sendiri terletak di <code>src</code> : <code>NuGet.Config</code> berisi konfigurasi repositori <acronym>NuGet</acronym> pribadi, <code>NLog.config</code> konfigurasi dev-time <acronym>NLog</acronym> .  Seperti yang Anda duga, menggunakan NLog di perusahaan juga merupakan salah satu standar.  Yang menarik di sini adalah file <code>Directory.Build.props</code> hampir ajaib.  Untuk beberapa alasan, beberapa orang tahu tentang kemungkinan seperti itu dalam proyek .NET, seperti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kustomisasi perakitan</a> .  Singkatnya, file dengan nama <code>Directory.Build.props</code> dan <code>Directory.Build.targets</code> otomatis diimpor ke proyek Anda dan memungkinkan Anda untuk mengonfigurasi properti umum untuk semua proyek di satu tempat.  Sebagai contoh, ini adalah bagaimana kami menghubungkan penganalisa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">StyleCop.Analyzers</a> dan konfigurasinya dari direktori <code>CodeAnalysis</code> ke semua proyek bergaya kode, menetapkan aturan versi dan beberapa atribut umum untuk pustaka dan paket ( <em>Perusahaan</em> , <em>Hak Cipta</em> , dll.), Dan juga terhubung melalui <code>&lt;Import&gt;</code> file <code>SolutionInfo.props</code> , yang tepatnya merupakan file konfigurasi repositori yang sama, yang telah dibahas di atas.  Ini sudah berisi versi saat ini, informasi tentang penulis, URL repositori dan deskripsinya, serta beberapa properti yang mempengaruhi perilaku sistem perakitan dan artefak yang dihasilkan. </p><br><div class="spoiler">  <b class="spoiler_title">Contoh `SolutionInfo.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"devops.build/SolutionInfo.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product name --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product version. Version 0.0.0 wouldn't be published! --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project name which contains Main() --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService.Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Exposed port --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span>4000/tcp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- DOTNET_SYSTEM_GLOBALIZATION_INVARIANT value. See https://github.com/dotnet/corefx/blob/master/Documentation/architecture/globalization-invariant-mode.md --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Documentation URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/browse/README.md<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Your name here --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span>User Name &amp;lt;username@contoso.com&amp;gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project description --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span>The sample service for demo purposes.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Bamboo plan key (required for Bamboo Specs --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span>SMPL<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Contoh `Directory.Build.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Exists('..\SolutionInfo.props')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..\SolutionInfo.props"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Link</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CopyToOutputDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Never"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StyleCop.Analyzers"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PrivateAssets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"all"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span>$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.ruleset<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable XML docs generating--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable C# 7.x features --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span>latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default base version --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BaseVersion)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default build number and format --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BuildNumber)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.String]::Format('{0:0000}',$(BuildNumber)))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default version suffix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>local<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- empty version suffix instead of 'prod' --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == 'prod'"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- format version prefix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span>$(BaseVersion).$(BuildNumber)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- disable IsPackable by default --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span>$(RepositoryUrl)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span>Contoso<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span>Copyright $([System.DateTime]::Now.Date.Year) Contoso Ltd<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h2 id="sborka">  Majelis </h2><br><p>  Perlu disebutkan langsung bahwa saya dan kolega saya sudah memiliki pengalaman yang cukup sukses dalam menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sistem pembangunan yang</a> berbeda.  Dan alih-alih menimbang alat yang ada dengan fungsi yang sama sekali tidak seperti biasanya, diputuskan untuk membuat yang lain, khusus untuk proses baru kami, dan meninggalkan yang lama sendirian untuk melakukan tugasnya sebagai bagian dari proyek warisan.  Ide perbaikannya adalah keinginan untuk mendapatkan alat yang akan mengubah kode menjadi gambar buruh pelabuhan yang memenuhi semua persyaratan kami, menggunakan proses standar tunggal, sambil menghilangkan kebutuhan pengembang untuk menyelami seluk-beluk perakitan, tetapi mempertahankan kemungkinan beberapa penyesuaian. </p><br><p>  Pemilihan kerangka kerja yang sesuai telah dimulai.  Berdasarkan persyaratan reproduksibilitas hasil, baik pada mesin yang dibangun dengan Linux maupun pada mesin Windows dari pengembang mana pun, lintas platform nyata dan minimum ketergantungan yang ditetapkan menjadi syarat utama.  Pada waktu yang berbeda, saya berhasil mengenal beberapa kerangka kerja perakitan untuk pengembang .NET dengan cukup baik: dari MSBuild dan konfigurasi XML yang mengerikan, yang kemudian diterjemahkan ke dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Psake</a> (Powershell), ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">FAKE</a> eksotis (F #).  Tapi kali ini aku menginginkan sesuatu yang segar dan terang.  Selain itu, sudah diputuskan bahwa perakitan dan pengujian harus dilakukan sepenuhnya dalam lingkungan wadah yang terisolasi, jadi saya tidak berencana untuk menjalankan apa pun selain perintah Docker CLI dan Git, yaitu, sebagian besar proses seharusnya dijelaskan dalam Dockerfile. <br>  Pada saat itu, FAKE 5 dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Cake</a> untuk .NET Core masih belum siap, jadi dengan cross-platform, proyek-proyek ini begitu-begitu.  Tapi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PowerShell 6 Core</a> saya yang terkasih sudah dirilis, dan saya menggunakannya sepenuhnya.  Oleh karena itu, saya memutuskan untuk beralih ke Psake lagi, dan ketika saya berbalik, saya menemukan sebuah proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Invoke-Build yang menarik</a> , yang merupakan pemikiran ulang dari Psake dan, seperti yang penulis tunjukkan, adalah sama, hanya lebih baik dan lebih mudah.  Begitulah.  Saya tidak akan membahasnya secara terperinci dalam kerangka artikel ini, saya hanya akan mencatat bahwa kekompakan menyuap saya di dalamnya jika semua fungsi dasar untuk kelas produk ini tersedia: </p><br><ul><li>  Urutan tindakan dijelaskan oleh serangkaian tugas yang saling terkait (tugas), yang dapat dikontrol menggunakan saling ketergantungan mereka dan kondisi tambahan. </li><li>  Ada beberapa bantuan praktis, misalnya, exec {} untuk menangani kode keluar aplikasi konsol dengan benar. </li><li>  Pengecualian atau berhenti menggunakan Ctrl + C akan diproses dengan benar di blok Exit-Build built-in khusus.  Misalnya, di sana Anda dapat menghapus semua file sementara, lingkungan pengujian, atau menggambar laporan yang enak dipandang. </li></ul><br><p><img src="https://habrastorage.org/webt/nw/sg/0g/nwsg0gzd3fo0a-ep6b60pfqce98.png"></p><br><h2 id="universalnyy-dockerfile">  Dockerfile Umum </h2><br><p>  Dockerfile sendiri dan perakitan yang menggunakan <code>docker build</code> memberikan kemampuan parameterisasi yang cukup lemah, dan fleksibilitas alat-alat ini hampir tidak sedikit lebih tinggi dari pada pegangan sekop.  Selain itu, ada banyak cara untuk membuat gambar yang "salah", terlalu besar, terlalu tidak aman, terlalu tidak intuitif, atau hanya tidak dapat diprediksi.  Untungnya, <a href="">dokumentasi Microsoft</a> sudah menawarkan beberapa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">contoh Dockerfile</a> , yang memungkinkan Anda untuk dengan cepat memahami konsep dasar dan membuat Dockerfile pertama Anda, secara bertahap memperbaikinya nanti.  Dia sudah menggunakan pola <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">multi-tahap</a> dan membangun gambar " <a href="">Test Runner</a> " khusus untuk menjalankan tes. </p><br><h2 id="multi-stage-pattern-i-argumenty">  Pola dan argumen multi-tahap </h2><br><p>  Langkah pertama adalah memecah tahap perakitan menjadi yang lebih kecil dan menambahkan yang baru.  Jadi, perlu menyoroti peluncuran <code>dotnet build</code> sebagai tahap terpisah, karena untuk proyek yang hanya berisi pustaka, tidak masuk akal untuk menjalankan <code>dotnet publish</code> .  Sekarang, atas kebijakan kami, kami hanya dapat menjalankan tahapan perakitan yang diperlukan menggunakan <br> <code>dotnet build --target &lt;name&gt;</code> <br>  Misalnya, di sini kami mengumpulkan proyek yang hanya berisi perpustakaan.  Artefak di sini hanya paket NuGet, yang berarti tidak masuk akal untuk mengumpulkan gambar runtime. </p><br><p><img src="https://habrastorage.org/webt/vn/_a/a3/vn_aa3w7oodzrpythwrixomkhs8.png"></p><br><p>  Atau kita sudah membangun layanan, tetapi dari cabang fitur.  Kami tidak memerlukan artefak dari perakitan semacam itu sama sekali, hanya penting untuk lulus tes dan pemeriksaan kesehatan. </p><br><p><img src="https://habrastorage.org/webt/fo/ua/l1/foual199bsvqf2u7mk6xgjzbw9q.png"></p><br><p>  Hal selanjutnya yang harus dilakukan adalah parameterisasi penggunaan gambar dasar.  Untuk beberapa waktu sekarang, di Dockerfile, arahan <code>ARG</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dapat ditempatkan di</a> luar tahap build, dan nilai yang ditransfer dapat digunakan atas nama gambar dasar. </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG BUILD_BASE=mcr.microsoft.com/dotnet/core/sdk:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/runtime:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${BUILD_BASE} AS restore ... FROM ${RUNTIME_BASE} AS runtime ...</code> </pre> <br><p>  Jadi kami mendapat kesempatan baru dan pada pandangan pertama, dan tidak jelas.  Pertama, jika kita ingin membangun sebuah gambar dengan aplikasi ASP.NET Core, maka gambar runtime akan membutuhkan yang berbeda: <code>mcr.microsoft.com/dotnet/core/aspnet</code> .  Parameter dengan gambar dasar non-standar harus disimpan dalam konfigurasi repositori <code>SolutionInfo.props</code> dan meneruskannya sebagai argumen selama perakitan.  Kami juga mempermudah pengembang untuk menggunakan versi lain dari .NET Core images: preview, misalnya, atau bahkan yang khusus (Anda tidak pernah tahu!). </p><br><p>  Kedua, kemampuan untuk "memperluas" Dockerfile bahkan lebih menarik, setelah membuat bagian dari operasi di perakitan lain, yang hasilnya akan diambil sebagai dasar saat menyiapkan gambar runtime.  Sebagai contoh, beberapa layanan kami menggunakan JavaScript dan Vue.js, kode yang akan kami siapkan dalam gambar terpisah, cukup menambahkan Dockerfile "yang meluas" ke repositori: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM node:alpine AS install WORKDIR /build COPY package.json . RUN npm install FROM install AS src COPY [".babelrc", ".eslintrc.js", ".stylelintrc", "./"] COPY ClientApp ./ClientApp FROM src AS publish RUN npm run build-prod FROM ${RUNTIME_BASE} AS appbase COPY --from=publish /build/wwwroot/ /app/wwwroot/</code> </pre> <br><p>  Mari kumpulkan gambar ini dengan tag, yang akan kami sampaikan ke tahap perakitan gambar runtime dari layanan ASP.NET sebagai argumen untuk RUNTIME_BASE.  Jadi, Anda dapat memperluas perakitan sebanyak yang Anda suka, termasuk, Anda bisa membuat parameter apa yang tidak bisa Anda lakukan hanya dalam <code>docker build</code> .  Ingin mengukur parameter penambahan Volume?  Mudah: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${RUNTIME_BASE} AS runtime ARG VOLUME VOLUME ${VOLUME}</code> </pre> <br><p>  Kami memulai perakitan Dockerfile ini sebanyak yang kami ingin tambahkan arahan VOLUME.  Kami menggunakan gambar yang dihasilkan sebagai basis untuk layanan. </p><br><h2 id="zapusk-testov">  Menjalankan tes </h2><br><p>  Alih-alih menjalankan tes langsung di tahap perakitan, lebih tepat dan lebih mudah untuk melakukan ini dalam wadah "Test Runner" khusus.  Secara singkat menyampaikan inti dari pendekatan ini, saya perhatikan bahwa ini memungkinkan Anda untuk: </p><br><ul><li>  Lakukan semua peluncuran terjadwal, bahkan jika salah satu dari itu crash; </li><li>  Pasang direktori sistem file host ke dalam wadah untuk menerima laporan pengujian, yang sangat penting ketika membangun sistem CI; </li><li>  Jalankan pengujian dalam lingkungan sementara dengan mengirimkan nama jaringannya ke <code>docker run --network &lt;test_network_name&gt;</code> . </li></ul><br><p>  Paragraf terakhir berarti bahwa kita sekarang dapat menjalankan tidak hanya tes unit, tetapi juga tes integrasi.  Kami menggambarkan lingkungan, misalnya, di <code>docker-compose.yaml</code> , dan menjalankannya untuk seluruh build.  Sekarang Anda dapat memeriksa interaksi dengan database atau layanan kami yang lain, dan menyimpan log dari mereka jika Anda membutuhkannya untuk analisis. </p><br><p>  Kami selalu memeriksa gambar runtime yang dihasilkan untuk melewati pemeriksaan kesehatan, yang juga merupakan semacam tes.  Lingkungan pengujian sementara mungkin berguna di sini jika layanan yang diuji memiliki ketergantungan pada lingkungannya. </p><br><p>  Saya juga mencatat bahwa pendekatan dengan wadah pelari berkumpul di panggung dengan <code>dotnet build</code> akan berfungsi dengan baik untuk meluncurkan <code>dotnet publish</code> , <code>dotnet pack</code> <code>dotnet nuget push</code> dan <code>dotnet nuget push</code> .  Ini akan memungkinkan kami untuk menyimpan artefak rakitan secara lokal. </p><br><h2 id="healthcheck-i-zavisimosti-os">  Pemeriksaan Kesehatan dan Dependensi OS </h2><br><p>  Cukup cepat menjadi jelas bahwa layanan standar kami akan tetap unik dengan caranya sendiri.  Mereka mungkin memiliki persyaratan berbeda untuk paket yang sudah diinstal dari sistem operasi di dalam gambar dan cara yang berbeda untuk memeriksa cek kesehatan.  Dan jika curl cocok untuk memeriksa status aplikasi Web, maka untuk backend gRPC atau, apalagi, layanan tanpa kepala, itu tidak akan berguna, dan itu juga akan menjadi paket tambahan dalam wadah. </p><br><p>  Untuk memberi pengembang kesempatan untuk menyesuaikan gambar dan memperluas konfigurasinya, kami menggunakan perjanjian pada beberapa skrip khusus yang dapat didefinisikan ulang dalam repositori: </p><br><pre> <code class="plaintext hljs">.scripts ├── healthcheck.sh ├── run.sh └── runtime-deps.sh</code> </pre> <br><p>  Skrip <code>healthcheck.sh</code> berisi perintah yang diperlukan untuk memeriksa status: </p><br><ul><li><p>  Untuk web menggunakan curl: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set –e curl -sIf -o /dev/null -w "%{http_code}\n" 127.0.0.1/health || exit 1</span></span></code> </pre> <br></li><li><p>  Layanan lain yang menggunakan utilitas klien kami sendiri: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set –e healthcheck || exit 1</span></span></code> </pre> <br></li></ul><br><p>  Menggunakan <code>runtime-deps.sh</code> , dependensi diinstal dan, jika diperlukan, tindakan lain apa pun pada OS dasar dilakukan yang diperlukan untuk fungsi normal aplikasi di dalam wadah.  Contoh umum: </p><br><ul><li><p>  Untuk aplikasi web: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache curl icu-libs</span></span></code> </pre> <br></li><li><p>  Untuk layanan gRPC: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache libc6-compat</span></span></code> </pre> <br></li></ul><br><p>  Dengan demikian, cara untuk mengelola dependensi dan memeriksa keadaan adalah standar, tetapi ada ruang untuk fleksibilitas.  Adapun <code>run.sh</code> , maka itu lebih jauh. </p><br><h2 id="entrypoint-skript">  Script entrypoint </h2><br><p>  Saya yakin bahwa setiap orang yang setidaknya sekali menulis Dockerfile mereka bertanya-tanya arahan mana yang harus digunakan - <code>CMD</code> atau <code>ENTRYPOINT</code> .  Selain itu, tim-tim ini juga memiliki dua opsi sintaks, yang secara dramatis mempengaruhi hasil.  Saya tidak akan menjelaskan perbedaannya secara rinci, mengulangi setelah mereka yang telah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mengklarifikasi semuanya</a> .  Saya hanya menyarankan mengingat bahwa dalam 99% situasi sudah benar untuk menggunakan ENTRYPOINT dan sintaks exec: </p><br><p>  ENTRYPOINT ["/ path / to / executable"] </p><br><p>  Jika tidak, aplikasi yang diluncurkan tidak akan dapat memproses perintah OS dengan benar, seperti SIGTERM, dll., Dan Anda juga bisa mendapat masalah dalam bentuk proses zombie dan semua yang terkait dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">masalah PID 1</a> .  Tetapi bagaimana jika Anda ingin memulai wadah tanpa meluncurkan aplikasi?  Ya, Anda dapat mengganti titik masuk: <br> <code>docker run --rm -it --entrypoint ash &lt;image_name&gt; &lt;params&gt;</code> <br>  Itu tidak terlihat terlalu nyaman dan intuitif, bukan?  Tetapi ada kabar baik: Anda bisa berbuat lebih baik!  Yaitu, gunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">skrip entrypoint</a> .  Skrip semacam itu memungkinkan Anda untuk melakukan inisialisasi kompleks ( <a href="">contoh</a> ) sewenang-wenang, pemrosesan parameter, dan apa pun yang Anda inginkan. </p><br><p>  Dalam kasus kami, secara default, skenario fungsional paling sederhana, tetapi pada saat yang sama digunakan: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -e if [ ! -z "$1" ] &amp;&amp; $(command -v $1 &gt;/dev/null 2&gt;&amp;1) then exec $@ else exec /usr/bin/dotnet /app/${ENTRY_PROJECT}.dll $@ fi</span></span></code> </pre> <br><p>  Ini memungkinkan Anda untuk mengontrol peluncuran wadah dengan sangat intuitif: <br>  <code>docker run &lt;image&gt; env</code> - hanya mengeksekusi env dalam gambar, menunjukkan variabel lingkungan. <br>  <code>docker run &lt;image&gt; -param1 value1</code> - memulai layanan dengan argumen yang ditentukan. </p><br><p>  Secara terpisah, Anda perlu memperhatikan perintah <code>exec</code> : kehadirannya sebelum memanggil aplikasi yang dapat dieksekusi akan memastikan bahwa ia bekerja dengan PID 1 yang didambakan dalam wadah Anda. </p><br><h2 id="chto-esche">  Apa lagi </h2><br><p>  Tentu saja, lebih dari satu setengah tahun penggunaan, sistem build telah mengakumulasikan banyak fungsi yang berbeda.  Selain mengelola kondisi peluncuran berbagai tahap, bekerja dengan penyimpanan artefak, versi, dan fitur lainnya, "standar" wadah kami juga dikembangkan.  Itu diisi dengan atribut penting yang membuatnya lebih mudah diprediksi dan secara administratif nyaman: </p><br><ul><li>  Semua label gambar yang diperlukan diinstal: versi, angka revisi, tautan ke dokumentasi, penulis dan lain-lain. </li><li>  Dalam wadah runtime, konfigurasi NLog didefinisikan ulang sehingga setelah publikasi semua log segera disajikan dalam bentuk terstruktur menggunakan json, versi yang diversi. </li><li>  Aturan analisis statis dan standar lainnya secara otomatis diperbarui. </li></ul><br><p>  Alat seperti itu, tentu saja, selalu dapat ditingkatkan dan dikembangkan.  Itu semua tergantung kebutuhan dan imajinasi.  Sebagai contoh, selain segalanya, dimungkinkan untuk mengemas utilitas klien tambahan ke dalam gambar.  Pengembang dapat dengan mudah menempatkan mereka di gambar, menentukan dalam file konfigurasi hanya nama utilitas yang diperlukan dan nama proyek .NET dari mana ia harus dirakit (misalnya, <code>healthcheck</code> kami). </p><br><h2 id="zaklyuchenie">  Kesimpulan </h2><br><p>  Dijelaskan di sini hanya bagian dari pendekatan terpadu untuk standardisasi.     ,     ,        ,      ,      ,    .        .          ,  . </p><br><p>             ,      Linux    ,   -      .       , ,          . , ,  ,    Code Style,      ,           . </p><br><p> ,    !   ,    «  »,       ,             .      ,    Docker        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id468683/">https://habr.com/ru/post/id468683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id468663/index.html">Pendekatan End2 End dalam Tugas Pengenalan Ucapan Otomatis</a></li>
<li><a href="../id468665/index.html">Tetapi apakah sudah waktunya untuk membeli irigasi?</a></li>
<li><a href="../id468673/index.html">Lokakarya "Memastikan keamanan data pribadi" - 3 Oktober, St. Petersburg</a></li>
<li><a href="../id468677/index.html">Pengumuman smartphone Xiaomi Mi Mix Alpha</a></li>
<li><a href="../id468679/index.html">ABC Keamanan di Kubernetes: Otentikasi, Otorisasi, Audit</a></li>
<li><a href="../id468687/index.html">Kami menganalisis inisiatif baru Bank Sentral untuk mengatur pasar saham: 3 kelompok investor, pembatasan untuk pemula</a></li>
<li><a href="../id468689/index.html">Mendaftarkan bisnis TI Anda di Singapura: apa yang harus saya lakukan?</a></li>
<li><a href="../id468691/index.html">Driver pihak ketiga berbahaya pada sistem Anda atau LOLDrivers</a></li>
<li><a href="../id468693/index.html">Bagaimana otomasi menghancurkan karyawan Walmart</a></li>
<li><a href="../id468695/index.html">Retasan pertama saya: situs yang memungkinkan Anda mengatur kata sandi pengguna apa pun</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>