<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öæÔ∏è üöô üî• C√≥mo le ense√±√© a la IA a jugar Tetris para NES. Parte 1: an√°lisis del c√≥digo del juego. üê∑ ‚ò†Ô∏è üíè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, explorar√© la mec√°nica aparentemente simple de Nintendo Tetris, y en la segunda parte explicar√© c√≥mo cre√© una IA que explota estas me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo le ense√±√© a la IA a jugar Tetris para NES. Parte 1: an√°lisis del c√≥digo del juego.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420725/">  En este art√≠culo, explorar√© la mec√°nica aparentemente simple de Nintendo Tetris, y en la segunda parte explicar√© c√≥mo cre√© una IA que explota estas mec√°nicas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/48f/1a4/9b8/48f1a49b87860e6139e8d298e1fe6188.png"></div><br><h2>  Pru√©balo t√∫ mismo </h2><br><h3>  Sobre el proyecto </h3><br>  Para aquellos que carecen de la perseverancia, la paciencia y el tiempo necesarios para dominar Nintendo Tetris, cre√© una IA que puede jugar por s√≠ sola.  Finalmente puedes llegar al nivel 30 e incluso m√°s.  Ver√° c√≥mo obtener el n√∫mero m√°ximo de puntos y observar√° el cambio sin fin de contadores de filas, niveles y estad√≠sticas.  Aprender√° qu√© colores aparecen en niveles por encima de los cuales una persona no podr√≠a escalar.  Mira hasta d√≥nde puedes llegar. <br><a name="habracut"></a><br><h3>  Requisitos </h3><br>  Para ejecutar la IA, necesita un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">emulador</a> universal NES / Famicom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FCEUX</a> .  La inteligencia artificial fue desarrollada para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FCEUX 2.2.2</a> , la versi√≥n m√°s nueva del emulador en el momento de la escritura. <br><br>  Tambi√©n necesitar√°s el archivo ROM de Nintendo Tetris (versi√≥n estadounidense).  Intenta buscarlo en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Google</a> . <br><br><h3>  Descargar </h3><br>  Descomprima <code>lua/NintendoTetrisAI.lua</code> de este <a href="">archivo zip de origen</a> . <br><br><h3>  Lanzamiento </h3><br>  Lanzamiento de FCEUX.  Desde el men√∫, seleccione Archivo |  Abrir ROM ... En el cuadro de di√°logo Abrir archivo, selecciona el archivo ROM de Nintendo Tetris y haz clic en Abrir.  El juego comenzar√°. <br><br>  Desde el men√∫, seleccione Archivo |  Lua  Nueva ventana de Lua Script ... En la ventana de Lua Script, ingrese la ruta a <code>NintendoTetrisAI.lua</code> o haga clic en el bot√≥n Examinar para encontrarla.  Despu√©s de eso, haga clic en Ejecutar. <br><br>  El script en Lua lo redireccionar√° a la primera pantalla del men√∫.  Deje el tipo de juego A-Type, y puede elegir cualquier m√∫sica.  En computadoras lentas, la m√∫sica puede reproducirse muy bruscamente, entonces debes apagarla.  Presione Inicio (Entrar) para ir a la siguiente pantalla de men√∫.  En el segundo men√∫, puede usar las teclas de flecha para cambiar el nivel de inicio.  Haz clic en Iniciar para comenzar el juego.  Y aqu√≠ la IA tomar√° el control. <br><br>  Si despu√©s de seleccionar un nivel en la segunda pantalla del men√∫, mantenga presionado el bot√≥n A del gamepad (puede cambiar la distribuci√≥n del teclado en el men√∫ Config | Entrada ...) y presione Inicio, entonces el nivel inicial ser√° 10 m√°s que el valor seleccionado.  El nivel de entrada m√°ximo es el decimonoveno. <br><br><h3>  Configuracion </h3><br>  Para que el juego se ejecute m√°s r√°pido, abra el script Lua en un editor de texto.  Al comienzo del archivo, busque la siguiente l√≠nea. <br><br> <code>PLAY_FAST = false</code> <br> <br>  Reemplace <code>false</code> con <code>true</code> como se muestra a continuaci√≥n. <br><br> <code>PLAY_FAST = true</code> <br> <br>  Guarda el archivo.  Luego haga clic en el bot√≥n Reiniciar en la ventana Lua Script. <br><br><h2>  Mec√°nica de Nintendo Tetris </h2><br><h3>  Descripci√≥n del Tetrimino </h3><br>  Cada figura tetrimino corresponde a un nombre de una letra que se asemeja a su forma. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/975/440/5ed/9754405ed7b3d83a47181edef3de6913.png"></div><br>  Los dise√±adores de Nintendo Tetris establecen arbitrariamente el orden de tetrimino que se muestra arriba.  Las figuras se muestran en la orientaci√≥n en la que aparecen en la pantalla, y el circuito crea una imagen casi sim√©trica (quiz√°s por eso se elige este orden).  El √≠ndice de secuencia le da a cada tetrimino una identificaci√≥n num√©rica √∫nica.  Los identificadores de secuencia y tipo son importantes a nivel de programaci√≥n;  Adem√°s, se manifiestan en el orden de las cifras que se muestran en el campo de estad√≠sticas (ver m√°s abajo). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc2/35d/778/dc235d778c47654e1abbc5896581fd6a.png"></div><br>  Las 19 orientaciones utilizadas en el Nintendo Tetris tetrimino est√°n codificadas en una tabla ubicada en <code>$8A9C</code> de la memoria de la consola NES.  Cada figura se representa como una secuencia de 12 bytes que se puede dividir en triples <code>(Y, tile, X)</code> que describen cada cuadrado de la figura.  Los valores hexadecimales anteriores de las coordenadas superiores a <code>$7F</code> denotan enteros negativos ( <code>$FF= ‚àí1</code> y <code>$FE = ‚àí2</code> ). <br><br> <code>; Y0 T0 X0 Y1 T1 X1 Y2 T2 X2 Y3 T3 X3 <br> <br> 8A9C: 00 7B FF 00 7B 00 00 7B 01 FF 7B 00 ; 00: T up <br> 8AA8: FF 7B 00 00 7B 00 00 7B 01 01 7B 00 ; 01: T right <br> 8AB4: 00 7B FF 00 7B 00 00 7B 01 01 7B 00 ; 02: T down (spawn) <br> 8AC0: FF 7B 00 00 7B FF 00 7B 00 01 7B 00 ; 03: T left <br> <br> 8ACC: FF 7D 00 00 7D 00 01 7D FF 01 7D 00 ; 04: J left <br> 8AD8: FF 7D FF 00 7D FF 00 7D 00 00 7D 01 ; 05: J up <br> 8AE4: FF 7D 00 FF 7D 01 00 7D 00 01 7D 00 ; 06: J right <br> 8AF0: 00 7D FF 00 7D 00 00 7D 01 01 7D 01 ; 07: J down (spawn) <br> <br> 8AFC: 00 7C FF 00 7C 00 01 7C 00 01 7C 01 ; 08: Z horizontal (spawn) <br> 8B08: FF 7C 01 00 7C 00 00 7C 01 01 7C 00 ; 09: Z vertical <br> <br> 8B14: 00 7B FF 00 7B 00 01 7B FF 01 7B 00 ; 0A: O (spawn) <br> <br> 8B20: 00 7D 00 00 7D 01 01 7D FF 01 7D 00 ; 0B: S horizontal (spawn) <br> 8B2C: FF 7D 00 00 7D 00 00 7D 01 01 7D 01 ; 0C: S vertical <br> <br> 8B38: FF 7C 00 00 7C 00 01 7C 00 01 7C 01 ; 0D: L right <br> 8B44: 00 7C FF 00 7C 00 00 7C 01 01 7C FF ; 0E: L down (spawn) <br> 8B50: FF 7C FF FF 7C 00 00 7C 00 01 7C 00 ; 0F: L left <br> 8B5C: FF 7C 01 00 7C FF 00 7C 00 00 7C 01 ; 10: L up <br> <br> 8B68: FE 7B 00 FF 7B 00 00 7B 00 01 7B 00 ; 11: I vertical <br> 8B74: 00 7B FE 00 7B FF 00 7B 00 00 7B 01 ; 12: I horizontal (spawn) <br> <br> 8B80: 00 FF 00 00 FF 00 00 FF 00 00 FF 00 ; 13: Unused</code> <br> <br>  En la parte inferior de la tabla hay un registro no utilizado, que potencialmente brinda la oportunidad de agregar otra orientaci√≥n.  Sin embargo, en varias partes del c√≥digo, <code>$13</code> indica que el identificador de orientaci√≥n del tetrimino activo no tiene asignado un valor. <br><br>  Para facilitar la lectura, las coordenadas de los cuadrados en decimal se muestran a continuaci√≥n. <br><br> <code>-- { { X0, Y0 }, { X1, Y1 }, { X2, Y2 }, { X3, Y3 }, }, <br> <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 0, -1 }, }, -- 00: T up <br> { { 0, -1 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 01: T right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 02: T down (spawn) <br> { { 0, -1 }, { -1, 0 }, { 0, 0 }, { 0, 1 }, }, -- 03: T left <br> <br> { { 0, -1 }, { 0, 0 }, { -1, 1 }, { 0, 1 }, }, -- 04: J left <br> { { -1, -1 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 05: J up <br> { { 0, -1 }, { 1, -1 }, { 0, 0 }, { 0, 1 }, }, -- 06: J right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 1, 1 }, }, -- 07: J down (spawn) <br> <br> { { -1, 0 }, { 0, 0 }, { 0, 1 }, { 1, 1 }, }, -- 08: Z horizontal (spawn) <br> { { 1, -1 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 09: Z vertical <br> <br> { { -1, 0 }, { 0, 0 }, { -1, 1 }, { 0, 1 }, }, -- 0A: O (spawn) <br> <br> { { 0, 0 }, { 1, 0 }, { -1, 1 }, { 0, 1 }, }, -- 0B: S horizontal (spawn) <br> { { 0, -1 }, { 0, 0 }, { 1, 0 }, { 1, 1 }, }, -- 0C: S vertical <br> <br> { { 0, -1 }, { 0, 0 }, { 0, 1 }, { 1, 1 }, }, -- 0D: L right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { -1, 1 }, }, -- 0E: L down (spawn) <br> { { -1, -1 }, { 0, -1 }, { 0, 0 }, { 0, 1 }, }, -- 0F: L left <br> { { 1, -1 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 10: L up <br> <br> { { 0, -2 }, { 0, -1 }, { 0, 0 }, { 0, 1 }, }, -- 11: I vertical <br> { { -2, 0 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 12: I horizontal (spawn)</code> <br> <br>  Todas las orientaciones se colocan en una matriz de 5 √ó 5. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ca/435/322/8ca435322ee85d07cc631640c11a9aee.png"></div><br>  En la figura anterior, el cuadrado blanco indica el centro de la matriz, el punto de referencia para la rotaci√≥n de la figura. <br><br>  La tabla de orientaci√≥n se presenta gr√°ficamente a continuaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b18/4e0/f0e/b184e0f0ea182222b58d151c09217567.png"></div><br>  El identificador de orientaci√≥n (√≠ndice de la tabla) se muestra en hexadecimal en la esquina superior derecha de cada matriz.  Y la mnemotecnia inventada para este proyecto se muestra en la esquina superior izquierda.  <code>u</code> , <code>r</code> , <code>d</code> , <code>l</code> , <code>h</code> y <code>v</code> son abreviaturas de "arriba, derecha, abajo, izquierda, horizontal y vertical".  Por ejemplo, es m√°s f√°cil denotar la orientaci√≥n de <code>Jd</code> lugar de <code>$07</code> . <br><br>  Las matrices que contienen las orientaciones de las figuras durante la creaci√≥n est√°n marcadas con un marco blanco. <br><br>  Tetrimino I, S y Z podr√≠an recibir 4 orientaciones separadas, pero los creadores de Nintendo Tetris decidieron limitarse a dos.  Adem√°s, <code>Zv</code> y <code>Sv</code> no son im√°genes especulares ideales entre s√≠.  Ambos se crean girando en sentido antihorario, lo que conduce a un desequilibrio. <br><br>  La tabla de orientaci√≥n tambi√©n contiene valores de mosaico para cada cuadrado en cada figura orientada.  Sin embargo, con un estudio cuidadoso, queda claro que los valores para un tipo de tetrimino son siempre los mismos. <br><br><div class="scrollable-table"><table><tbody><tr><th>  T </th><th>  J </th><th>  Z </th><th>  O </th><th>  S </th><th>  L </th><th>  Yo </th></tr><tr><td> <code>7B</code> </td> <td> <code>7D</code> </td> <td> <code>7C</code> </td> <td> <code>7B</code> </td> <td> <code>7D</code> </td> <td> <code>7C</code> </td> <td> <code>7B</code> </td> </tr></tbody></table></div><br>  Los valores de mosaico son los √≠ndices de la tabla (pseudo-color) del patr√≥n que se muestra a continuaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e00/97a/713/e0097a713f629afaf73936d3192820e3.png"></div><br>  Los mosaicos de <code>$7B</code> , <code>$7C</code> y <code>$7D</code> se encuentran directamente debajo de "ATIS" de la palabra "ESTAD√çSTICAS".  Estos son los tres tipos de cuadrados a partir de los cuales se hace el tetrimino. <br><br>  Para los curiosos, dir√© que las avestruces y los ping√ºinos se usan al final del modo de tipo B.  Este tema se trata en detalle en la secci√≥n "Final". <br><br>  A continuaci√≥n se muestra el resultado de modificar la ROM despu√©s de reemplazar <code>$7B</code> por <code>$29</code> .  El coraz√≥n es el mosaico debajo del s√≠mbolo P en la tabla de patrones para todas las orientaciones T. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5fa/551/215/5fa55121523b443f8f3b6daa2bd46ad8.png"></div><br>  Las fichas de coraz√≥n permanecen en el campo de juego incluso despu√©s de que los Ts modificados se bloqueen en su lugar.  Como se indica a continuaci√≥n en la secci√≥n "Creaci√≥n de Tetrimino", esto significa que el campo de juego almacena los valores reales de los √≠ndices de mosaico del Tetrimino jugado. <br><br>  Los programadores de juegos permitieron usar 4 fichas separadas para cada figura, y no solo un tipo invariable de cuadrados.  Esta es una caracter√≠stica √∫til que puede usarse para modificar la apariencia del juego.  La tabla de patrones tiene mucho espacio vac√≠o para nuevos mosaicos que pueden dar a cada tetrimino un aspecto √∫nico. <br><br>  Las coordenadas de los cuadrados son muy f√°ciles de manipular.  Por ejemplo, a continuaci√≥n se muestra una versi√≥n modificada de los primeros cuatro triples en la tabla de orientaci√≥n. <br><br> <code>8A9C: FE 7B FE FE 7B 02 02 7B FE 02 7B 02 ; 00: T up</code> <br> <br>  Este cambio es similar al siguiente: <br><br> <code>{ { -2, -2 }, { 2, -2 }, { -2, 2 }, { 2, 2 }, }, -- 00: T up</code> <br> <br>  El resultado es un tetrimino dividido. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a6/ab5/86d/3a6ab586d06a57b92208bd612b755109.png"></div><br>  Al mover un tetrimino dividido, sus cuadrados no pueden ir m√°s all√° de los l√≠mites del campo de juego y no pueden pasar a trav√©s de figuras previamente bloqueadas.  Adem√°s, el juego proh√≠be la rotaci√≥n en esta orientaci√≥n si conduce a que una casilla caiga fuera de los l√≠mites del campo de juego o al hecho de que la casilla se superpone a una casilla ya tendida. <br><br>  El tetrimino dividido se bloquea en su lugar cuando hay soporte para cualquiera de sus cuadrados.  Si la figura est√° bloqueada, los cuadrados que cuelgan en el aire contin√∫an colgando. <br><br>  El juego maneja tetriminos divididos como cualquier figura normal.  Esto nos hace comprender que no hay una tabla adicional que almacene los metadatos de las figuras.  Por ejemplo, podr√≠a haber una tabla que almacene el tama√±o del cuadro delimitador de cada orientaci√≥n para verificar las colisiones con el per√≠metro del campo de juego.  Pero esa tabla no se usa.  En cambio, el juego simplemente verifica los cuatro cuadrados justo antes de manipular la forma. <br><br>  Adem√°s, las coordenadas de los cuadrados pueden ser cualquier valor;  no se limitan al intervalo <code>[‚àí2, 2]</code> .  Por supuesto, los valores que exceden en gran medida este intervalo nos dar√°n cifras inaplicables que no pueden caber en el campo de juego.  M√°s importante a√∫n, como se indic√≥ en la secci√≥n "Estados de juego y modos de renderizado", cuando una figura est√° bloqueada en su lugar, el mecanismo para limpiar l√≠neas rellenas escanea solo los desplazamientos de filas de ‚àí2 a 1 desde el cuadrado central de la figura;  un cuadrado con una coordenada <code>y</code> fuera de este intervalo no se reconocer√°. <br><br><h3>  Rotaci√≥n Tetrimino </h3><br>  En una ilustraci√≥n gr√°fica de la tabla de orientaci√≥n, la rotaci√≥n consiste en pasar de una matriz a una de las matrices a la izquierda o a la derecha con la transferencia de la serie si es necesario.  Este concepto est√° codificado en una tabla a <code>$88EE</code> . <br><br> <code>; CCW CW <br> 88EE: 03 01 ; Tl Tr <br> 88F0: 00 02 ; Tu Td <br> 88F2: 01 03 ; Tr Tl <br> 88F4: 02 00 ; Td Tu <br> 88F6: 07 05 ; Jd Ju <br> 88F8: 04 06 ; Jl Jr <br> 88FA: 05 07 ; Ju Jd <br> 88FC: 06 04 ; Jr Jl <br> 88FE: 09 09 ; Zv Zv <br> 8900: 08 08 ; Zh Zh <br> 8902: 0A 0A ; OO <br> 8904: 0C 0C ; Sv Sv <br> 8906: 0B 0B ; Sh Sh <br> 8908: 10 0E ; Lu Ld <br> 890A: 0D 0F ; Lr Ll <br> 890C: 0E 10 ; Ld Lu <br> 890E: 0F 0D ; Ll Lr <br> 8910: 12 12 ; Ih Ih <br> 8912: 11 11 ; Iv Iv</code> <br> <br>  Para hacerlo m√°s claro, moveremos cada columna de esta tabla a la fila de la tabla a continuaci√≥n. <br><div class="scrollable-table"><table><tbody><tr><th></th><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><th>  En sentido antihorario </th><td> <code>Tl</code> </td> <td> <code>Tu</code> </td> <td> <code>Tr</code> </td> <td> <code>Td</code> </td> <td> <code>Jd</code> </td> <td> <code>Jl</code> </td> <td> <code>Ju</code> </td> <td> <code>Jr</code> </td> <td> <code>Zv</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sv</code> </td> <td> <code>Sh</code> </td> <td> <code>Lu</code> </td> <td> <code>Lr</code> </td> <td> <code>Ld</code> </td> <td> <code>Ll</code> </td> <td> <code>Ih</code> </td> <td> <code>Iv</code> </td> </tr><tr><th>  En sentido horario </th><td> <code>Tr</code> </td> <td> <code>Td</code> </td> <td> <code>Tl</code> </td> <td> <code>Tu</code> </td> <td> <code>Ju</code> </td> <td> <code>Jr</code> </td> <td> <code>Jd</code> </td> <td> <code>Jl</code> </td> <td> <code>Zv</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sv</code> </td> <td> <code>Sh</code> </td> <td> <code>Ld</code> </td> <td> <code>Ll</code> </td> <td> <code>Lu</code> </td> <td> <code>Lr</code> </td> <td> <code>Ih</code> </td> <td> <code>Iv</code> </td> </tr></tbody></table></div><br>  La mnemotecnia en los encabezados anteriores se puede interpretar como un √≠ndice de secuencia o clave de distribuci√≥n.  Por ejemplo, girando en sentido antihorario <code>Tu</code> nos da <code>Tl</code> , y girando en sentido horario <code>Tu</code> da <code>Tr</code> . <br><br>  La tabla de rotaci√≥n codifica secuencias enlazadas en cadena de ID de orientaci√≥n;  por lo tanto, podemos modificar las grabaciones para que la rotaci√≥n transforme un tipo de tetrimino en otro.  Esta t√©cnica puede utilizarse potencialmente para aprovechar una fila no utilizada en la tabla de orientaci√≥n. <br><br>  Delante de la tabla de rotaci√≥n hay un c√≥digo para acceder a ella. <br><br> <code>88AB: LDA $0042 <br> 88AD: STA $00AE ; originalOrientationID = orientationID; <br> <br> 88AF: CLC <br> 88B0: LDA $0042 <br> 88B2: ASL <br> 88B3: TAX ; index = 2 * orientationID; <br> <br> 88B4: LDA $00B5 <br> 88B6: AND #$80 ; if (not just pressed button A) { <br> 88B8: CMP #$80 ; goto aNotPressed; <br> 88BA: BNE $88CF ; } <br> <br> 88BC: INX <br> 88BD: LDA $88EE,X <br> 88C0: STA $0042 ; orientationID = rotationTable[index + 1]; <br> <br> 88C2: JSR $948B ; if (new orientation not valid) { <br> 88C5: BNE $88E9 ; goto restoreOrientationID; <br> ; } <br> <br> 88C7: LDA #$05 <br> 88C9: STA $06F1 ; play rotation sound effect; <br> 88CC: JMP $88ED ; return; <br> <br> aNotPressed: <br> <br> 88CF: LDA $00B5 <br> 88D1: AND #$40 ; if (not just pressed button B) { <br> 88D3: CMP #$40 ; return; <br> 88D5: BNE $88ED ; } <br> <br> 88D7: LDA $88EE,X <br> 88DA: STA $0042 ; orientationID = rotationTable[index]; <br> <br> 88DC: JSR $948B ; if (new orientation not valid) { <br> 88DF: BNE $88E9 ; goto restoreOrientationID; <br> ; } <br> <br> 88E1: LDA #$05 <br> 88E3: STA $06F1 ; play rotation sound effect; <br> 88E6: JMP $88ED ; return; <br> <br> restoreOrientationID: <br> <br> 88E9: LDA $00AE <br> 88EB: STA $0042 ; orientationID = originalOrientationID; <br> <br> 88ED: RTS ; return;</code> <br> <br>  Para la rotaci√≥n en sentido antihorario, el √≠ndice de la tabla de rotaci√≥n se resta duplicando la ID de orientaci√≥n.  Al agregarle 1, obtenemos el √≠ndice de rotaci√≥n en el sentido de las agujas del reloj. <br><br>  Las coordenadas <code>x</code> , <code>y</code> ID de orientaci√≥n del tetrimino actual se almacenan en las direcciones <code>$0040</code> , <code>$0041</code> y <code>$0042</code> respectivamente. <br><br>  El c√≥digo usa una variable temporal para hacer una copia de seguridad del ID de orientaci√≥n.  M√°s tarde, despu√©s de cambiar la orientaci√≥n, el c√≥digo verifica que los cuatro cuadrados est√©n dentro de los l√≠mites del campo de juego y que ninguno de ellos se superponga con los cuadrados ya existentes (el c√≥digo de verificaci√≥n se encuentra en <code>$948B</code> , debajo del fragmento de c√≥digo que se muestra arriba).  Si la nueva orientaci√≥n es incorrecta, se restaura la original, sin permitir que el jugador gire la figura. <br><br>  Contando con una cruz, el controlador NES tiene ocho botones, cuyo estado est√° representado por el bit de direcci√≥n <code>$00B6</code> . <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>7</code> </th> <th> <code>6</code> </th> <th> <code>5</code> </th> <th> <code>4</code> </th> <th> <code>3</code> </th> <th> <code>2</code> </th> <th> <code>1</code> </th> <th> <code>0</code> </th> </tr><tr><td>  Un </td><td>  B </td><td>  Seleccione </td><td>  Inicio </td><td>  Arriba </td><td>  Abajo </td><td>  A la izquierda </td><td>  A la derecha </td></tr></tbody></table></div><br>  Por ejemplo, <code>$00B6</code> contendr√° el valor <code>$81</code> mientras el jugador mantiene A e Izquierda. <br><br>  Por otro lado, <code>$00B5</code> informa cuando se presionaron los botones;  los bits <code>$00B5</code> son verdaderos solo durante una iteraci√≥n del bucle del juego (1 cuadro procesado).  El c√≥digo usa <code>$00B5</code> para responder a presionar A y B. Cada uno de ellos necesita ser liberado antes de ser usado nuevamente. <br><br>  <code>$00B5</code> y <code>$00B6</code> son espejos de <code>$00F5</code> y <code>$00F6</code> .  El c√≥digo en las siguientes secciones usa estas direcciones indistintamente. <br><br><h3>  Crea Tetrimino </h3><br>  El campo de juego Nintendo Tetris consiste en una matriz con 22 filas y 10 columnas para que las dos primeras filas est√©n ocultas para el jugador. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e1/0dc/33b/6e10dc33b40eaa5dec35bc6e7bf42c5f.png"></div><br>  Como se muestra en el siguiente c√≥digo, al crear una figura de Tetrimino, siempre se encuentra en las coordenadas <code>(5, 0)</code> campo de juego. <br><br> <code>98BA: LDA #$00 <br> 98BC: STA $00A4 <br> 98BE: STA $0045 <br> 98C0: STA $0041 ; Tetrimino Y = 0 <br> 98C2: LDA #$01 <br> 98C4: STA $0048 <br> 98C6: LDA #$05 <br> 98C8: STA $0040 ; Tetrimino X = 5</code> <br> <br>  A continuaci√≥n se muestra una matriz de 5 √ó 5 superpuesta sobre este punto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fcf/d3b/d94/fcfd3bd94514779d6e967770a1f216cb.png"></div><br>  Ninguna de las matrices de creaci√≥n tiene cuadrados por encima del punto de partida.  Es decir, al crear un tetrimino, sus cuatro cuadrados se vuelven visibles de inmediato para el jugador.  Sin embargo, si el jugador gira r√°pidamente la pieza antes de que tenga tiempo de soltarla, parte de la pieza se ocultar√° temporalmente en las dos primeras l√≠neas del campo de juego. <br><br>  Por lo general, pensamos que el juego termina cuando el mont√≥n llega a la cima.  Pero, de hecho, esto no es del todo cierto.  El juego termina cuando ya no es posible crear la siguiente pieza.  Es decir, antes de la aparici√≥n de la figura, las cuatro celdas del campo de juego correspondientes a las posiciones de los cuadrados del tetrimino creado deber√≠an estar libres.  La figura puede estar bloqueada en su lugar de tal manera que parte de sus cuadrados aparezca en l√≠neas numeradas negativamente y el juego no termine;  sin embargo, en Nintendo Tetris, las l√≠neas negativas son una abstracci√≥n relacionada solo con el tetrimino activo.  Despu√©s de que la figura se bloquea (se convierte en mentira), solo se escriben en el campo cuadrados en l√≠neas desde cero y m√°s.  Conceptualmente, resulta que las l√≠neas numeradas negativamente se borran autom√°ticamente despu√©s del bloqueo.  Pero en realidad, el juego simplemente no almacena estos datos, cortando las partes superiores de las figuras. <br><br>  El √°rea visible del campo de juego 20 √ó 10 se almacena en <code>$0400</code> l√≠nea por l√≠nea, cada byte contiene el valor del mosaico de fondo.  Las celdas vac√≠as se denotan con el mosaico <code>$EF</code> , un cuadrado negro s√≥lido. <br><br>  Al crear una forma, se utilizan tres tablas de b√∫squeda.  Si hay una ID de orientaci√≥n arbitraria, la tabla en <code>$9956</code> nos da la ID de orientaci√≥n al crear el tipo correspondiente de tetrimino. <br><br> <code>9956: 02 02 02 02 ; Td <br> 995A: 07 07 07 07 ; Jd <br> 995E: 08 08 ; Zh <br> 9960: 0A ; O <br> 9961: 0B 0B ; Sh <br> 9963: 0E 0E 0E 0E ; Ld <br> 9967: 12 12 ; Ih</code> <br> <br>  Es m√°s f√°cil mostrar esto en la tabla. <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Zh</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sh</code> </td> <td> <code>Sh</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ih</code> </td> <td> <code>Ih</code> </td> </tr></tbody></table></div><br>  Por ejemplo, todas las orientaciones de J est√°n unidas a <code>Jd</code> . <br><br>  La tabla en <code>$993B</code> contiene el tipo Tetrimino para la ID de orientaci√≥n dada. <br><br> <code>993B: 00 00 00 00 ; T <br> 993F: 01 01 01 01 ; J <br> 9943: 02 02 ; Z <br> 9945: 03 ; O <br> 9946: 04 04 ; S <br> 9948: 05 05 05 05 ; L <br> 994C: 06 06 ; I</code> <br> <br>  Para mayor claridad, mostrar√© todo en forma de tabla. <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>Z</code> </td> <td> <code>Z</code> </td> <td> <code>O</code> </td> <td> <code>S</code> </td> <td> <code>S</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>I</code> </td> <td> <code>I</code> </td> </tr></tbody></table></div><br>  Veremos la tercera tabla de b√∫squeda en la siguiente secci√≥n. <br><br><h3>  Selecci√≥n de tetrimino </h3><br>  Nintendo Tetris utiliza un registro de desplazamiento de retroalimentaci√≥n lineal de 16 bits (LFSR) como su generador de n√∫meros pseudoaleatorios (PRNG) en su configuraci√≥n de Fibonacci.  El valor de 16 bits se almacena como big-endian en las direcciones <code>$0017</code> - <code>$0018</code> .  Se utiliza un n√∫mero arbitrario de <code>$8988</code> como semilla. <br><br> <code>80BC: LDX #$89 <br> 80BE: STX $0017 <br> 80C0: DEX <br> 80C1: STX $0018</code> <br> <br>  Cada n√∫mero pseudoaleatorio posterior se genera de la siguiente manera: el valor se percibe como un n√∫mero de 17 bits, y el bit m√°s significativo se obtiene realizando XOR para los bits 1 y 9. Luego, el valor se desplaza hacia la derecha, descartando el bit menos significativo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a0/45d/3f2/3a045d3f2d64a94aa272aa15f351ac7a.png"></div><br>  Este proceso ocurre en <code>$AB47</code> . <br><br> <code>AB47: LDA $00,X <br> AB49: AND #$02 <br> AB4B: STA $0000 ; extract bit 1 <br> <br> AB4D: LDA $01,X <br> AB4F: AND #$02 ; extract bit 9 <br> <br> AB51: EOR $0000 <br> AB53: CLC <br> AB54: BEQ $AB57 <br> AB56: SEC ; XOR bits 1 and 9 together <br> <br> AB57: ROR $00,X <br> AB59: INX <br> AB5A: DEY ; right shift <br> AB5B: BNE $AB57 ; shifting in the XORed value <br> <br> AB5D: RTS ; return</code> <br> <br>  Curiosamente, los par√°metros de la subrutina anterior se pueden configurar para que la funci√≥n de llamada pueda especificar el ancho del registro de desplazamiento y la direcci√≥n en la que se puede encontrar en la memoria.  Sin embargo, los mismos par√°metros se usan en todas partes, por lo que podemos suponer que los desarrolladores tomaron prestado este c√≥digo en alguna parte. <br><br>  Para aquellos que quieran modificar a√∫n m√°s el algoritmo, lo escrib√≠ en Java. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNextPseudorandomNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit1 = (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit9 = (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> leftmostBit = bit1 ^ bit9; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (leftmostBit &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) | (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Y todo este c√≥digo puede exprimirse en una sola l√≠nea. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNextPseudorandomNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((((value &gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) ^ ((value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>)) &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) | (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Este PRNG genera continua y determin√≠sticamente 32,767 valores √∫nicos, comenzando cada ciclo desde la semilla original.  Este es uno menos de la mitad de los n√∫meros posibles que pueden caber en el registro, y cualquier valor en este conjunto puede usarse como semilla.  Muchos de los valores fuera del conjunto crean una cadena que eventualmente conduce a un n√∫mero del conjunto.  Sin embargo, algunos n√∫meros iniciales dan como resultado una secuencia infinita de ceros. <br><br>  Para evaluar aproximadamente el rendimiento de este PRNG, gener√© una representaci√≥n gr√°fica de los valores que crea en base a una oraci√≥n con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RANDOM.ORG</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/254/477/bef/254477befbd14f540925a6d3169e5179.png"></div><br>  Al crear la imagen, PRNG se utiliz√≥ como generador de n√∫meros pseudoaleatorios, en lugar de enteros de 16 bits.  Cada p√≠xel se colorea seg√∫n el valor del bit 0. La imagen tiene un tama√±o de 128 √ó 256, es decir, cubre toda la secuencia. <br><br>  Adem√°s de las rayas apenas perceptibles en los lados superior e izquierdo, parece aleatorio.  No aparecen patrones obvios. <br><br>  Despu√©s de comenzar, el PRNG cambia constantemente el registro, trabajando al menos una vez por cuadro.  Esto no sucede no solo en la pantalla de inicio y en las pantallas de men√∫, sino tambi√©n cuando el tetrimino se encuentra entre las operaciones de creaci√≥n de formas.  Es decir, la figura que aparece a continuaci√≥n depende del n√∫mero de fotogramas que el jugador toma para colocar la figura.  De hecho, el juego se basa en la aleatoriedad de las acciones de la persona que interact√∫a con √©l. <br><br>  Durante la creaci√≥n de la figura, el c√≥digo se ejecuta en la direcci√≥n <code>$9907</code> , que selecciona el tipo de la nueva figura. <br><br> <code>9907: INC $001A ; spawnCount++; <br> <br> 9909: LDA $0017 ; index = high byte of randomValue; <br> <br> 990B: CLC <br> 990C: ADC $001A ; index += spawnCount; <br> <br> 990E: AND #$07 ; index &amp;= 7; <br> <br> 9910: CMP #$07 ; if (index == 7) { <br> 9912: BEQ $991C ; goto invalidIndex; <br> ; } <br> <br> 9914: TAX <br> 9915: LDA $994E,X ; newSpawnID = spawnTable[index]; <br> <br> 9918: CMP $0019 ; if (newSpawnID != spawnID) { <br> 991A: BNE $9938 ; goto useNewSpawnID; <br> ; } <br> <br> invalidIndex: <br> <br> 991C: LDX #$17 <br> 991E: LDY #$02 <br> 9920: JSR $AB47 ; randomValue = generateNextPseudorandomNumber(randomValue); <br> <br> 9923: LDA $0017 ; index = high byte of randomValue; <br> <br> 9925: AND #$07 ; index &amp;= 7; <br> <br> 9927: CLC <br> 9928: ADC $0019 ; index += spawnID; <br> <br> 992A: CMP #$07 <br> 992C: BCC $9934 <br> 992E: SEC <br> 992F: SBC #$07 <br> 9931: JMP $992A ; index %= 7; <br> <br> 9934: TAX <br> 9935: LDA $994E,X ; newSpawnID = spawnTable[index]; <br> <br> useNewSpawnID: <br> <br> 9938: STA $0019 ; spawnID = newSpawnID; <br> <br> 993A: RTS ; return;</code> <br> <br>  En la direcci√≥n <code>$001A</code> almacena un contador del n√∫mero de figuras creadas con el encendido.  El incremento del contador se realiza mediante la primera l√≠nea de la subrutina, y dado que es un contador de un solo byte, despu√©s de cada 256 piezas vuelve a cero.  Como el contador no se reinicia entre juegos, el historial de juegos anteriores afecta el proceso de selecci√≥n de figuras.  Esta es otra forma en que el juego usa al jugador como fuente de aleatoriedad. <br><br>  La rutina convierte el byte m√°s significativo del n√∫mero pseudoaleatorio ( <code>$0017</code> ) a un tipo tetrimino y lo usa como el √≠ndice de la tabla ubicada en <code>$994E</code> para convertir el tipo a la ID de orientaci√≥n de creaci√≥n de forma. <br><br> <code>994E: 02 ; Td <br> 994F: 07 ; Jd <br> 9950: 08 ; Zh <br> 9951: 0A ; O <br> 9952: 0B ; Sh <br> 9953: 0E ; Ld <br> 9954: 12 ; Ih</code> <br> <br>  En la primera etapa de conversi√≥n, el contador de figuras creadas se agrega al byte superior.  Luego se aplica una m√°scara para guardar solo los 3 bits inferiores.  Si el resultado no es 7, entonces este es el tipo correcto de tetrimino, y si no es el mismo que la figura seleccionada anteriormente, entonces el n√∫mero se usa como √≠ndice en la tabla para crear figuras.  De lo contrario, se genera el siguiente n√∫mero pseudoaleatorio y la m√°scara se aplica para obtener los 3 bits inferiores del byte superior, y luego se agrega la ID de orientaci√≥n de creaci√≥n de forma anterior.  Finalmente, se realiza una operaci√≥n de m√≥dulo para obtener el tipo correcto de tetrimino, que se utiliza como √≠ndice en la tabla de creaci√≥n de formas. <br><br>  Como el procesador no admite la divisi√≥n con el resto, este operador se emula restando repetidamente 7 hasta que el resultado sea menor que 7. La divisi√≥n con el resto se aplica a la suma del byte superior con la m√°scara aplicada y al ID de creaci√≥n de orientaci√≥n anterior.  El valor m√°ximo de esta suma es 25. Es decir, para reducirlo al resto de 4, solo se requieren 3 iteraciones. <br><br>  Al comienzo de cada juego, el ID de orientaci√≥n de creaci√≥n de forma ( <code>$0019</code> ) se inicializa con un valor de <code>Tu</code> ( <code>$00</code> ).  Este valor podr√≠a usarse potencialmente a <code>$9928</code> durante la creaci√≥n de la primera forma. <br><br>  Cuando se usa la ID de orientaci√≥n anterior para crear una figura, en lugar del tipo anterior, Tetrimino agrega distorsi√≥n, porque los valores de la ID de orientaci√≥n no se distribuyen uniformemente.  Esto se muestra en la tabla: <br><br><div class="scrollable-table"><table><tbody><tr><th>  $ 00 </th><th> <code>$02</code> </th> <th> <code>$07</code> </th> <th> <code>$08</code> </th> <th> <code>$0A</code> </th> <th> <code>$0B</code> </th> <th> <code>$0E</code> </th> <th> <code>$12</code> </th> </tr><tr><th>  0 0 </th><td>  2 </td><td>  0 0 </td><td>  1 </td><td>  3 </td><td>  4 4 </td><td>  0 0 </td><td>  4 4 </td></tr><tr><th>  1 </th><td>  3 </td><td>  1 </td><td>  2 </td><td>  4 4 </td><td>  5 5 </td><td>  1 </td><td>  5 5 </td></tr><tr><th>  2 </th><td>  4 4 </td><td>  2 </td><td>  3 </td><td>  5 5 </td><td>  6 6 </td><td>  2 </td><td>  6 6 </td></tr><tr><th>  3 </th><td>  5 5 </td><td>  3 </td><td>  4 4 </td><td>  6 6 </td><td>  0 0 </td><td>  3 </td><td>  0 0 </td></tr><tr><th>  4 4 </th><td>  6 6 </td><td>  4 4 </td><td>  5 5 </td><td>  0 0 </td><td>  1 </td><td>  4 4 </td><td>  1 </td></tr><tr><th>  5 5 </th><td>  0 0 </td><td>  5 5 </td><td>  6 6 </td><td>  1 </td><td>  2 </td><td>  5 5 </td><td>  2 </td></tr><tr><th>  6 6 </th><td>  1 </td><td>  6 6 </td><td>  0 0 </td><td>  2 </td><td>  3 </td><td>  6 6 </td><td>  3 </td></tr><tr><th>  7 7 </th><td>  2 </td><td>  0 0 </td><td>  1 </td><td>  3 </td><td>  4 4 </td><td>  0 0 </td><td>  4 4 </td></tr></tbody></table></div><br>  Cada celda contiene un tipo de tetrimino, calculado al agregar el ID de orientaci√≥n de la figura (columna) creada a un valor de 3 bits (fila), y luego aplicar el resto de la divisi√≥n por 7 a la suma. Cada fila contiene duplicados, porque <code>$07</code> y <code>$0E</code> dividen de manera uniforme a las 7, mientras que <code>$0B</code> y <code>$12</code> tienen un saldo com√∫n.  Las l√≠neas 0 y 7 son iguales porque est√°n a una distancia de 7. <br><br>  Hay 56 combinaciones de entrada posibles, y si los tipos de tetrimino resultantes se distribuyen uniformemente, entonces podemos esperar que en la tabla anterior, cada tipo aparezca exactamente 8 veces.  Pero como se muestra a continuaci√≥n, este no es el caso. <br><br><div class="scrollable-table"><table><tbody><tr><th>  Tipo </th><th>  Frecuencia </th></tr><tr><td>  T </td><td>  9 9 </td></tr><tr><td>  J </td><td>  8 </td></tr><tr><td>  Z </td><td>  8 </td></tr><tr><td>  O </td><td>  8 </td></tr><tr><td>  S </td><td>  9 9 </td></tr><tr><td>  L </td><td>  7 7 </td></tr><tr><td>  Yo </td><td>  7 7 </td></tr></tbody></table></div><br>  T y S aparecen con m√°s frecuencia, y L e I, con menos frecuencia.  Pero el c√≥digo sesgado que usa el ID de orientaci√≥n no se ejecuta cada vez que se llama a la subrutina. <br><br>  Suponga que PRNG crea una secuencia de valores estad√≠sticos independientes distribuidos uniformemente.  Esto es realmente una suposici√≥n justa, dada la forma en que el juego intenta obtener la aleatoriedad correcta de las acciones del jugador.  Agregar el n√∫mero de figuras creadas a la direcci√≥n <code>$990C</code> no afectar√° la distribuci√≥n, porque el n√∫mero aumenta de manera uniforme entre llamadas.  Usar la m√°scara de bits a <code>$990E</code> similar a aplicar la divisi√≥n por 8 con el resto, lo que tampoco afecta la distribuci√≥n.  Por lo tanto, la comprobaci√≥n a <code>$9910</code> va a <code>invalidIndex</code> en 1/8 de todos los casos.  Y la probabilidad de golpear cuando se verifica en la direcci√≥n <code>$9918</code> , donde se compara la cifra reci√©n seleccionada con la cifra anterior, es 7/8, con una probabilidad de coincidencia de 1/7.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto significa que hay una posibilidad adicional de </font></font><code>7/8 √ó 1/7 = 1/8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estar adentro </font></font><code>invalidIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En general, hay un 25% de probabilidad de usar un c√≥digo sesgado y un 75% de probabilidad de usar un c√≥digo que seleccione Tetrimino de manera uniforme. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En un conjunto de 224 tetriminos creados, la expectativa matem√°tica es de 32 instancias para cada tipo. </font><font style="vertical-align: inherit;">Pero en realidad el c√≥digo crea la siguiente distribuci√≥n:</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Tipo </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Frecuencia </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> T </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 33 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J </font></font></td><td>  32 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Z </font></font></td><td>  32 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O </font></font></td><td>  32 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 33 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L </font></font></td><td>  31 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yo </font></font></td><td>  31 </td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es decir, despejando 90 l√≠neas y alcanzando el nivel 9, el jugador recibir√° una T y S extra y una L e I menos de lo que se espera estad√≠sticamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetrimino se eligen con las siguientes probabilidades:</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Tipo </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Probabilidad </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> T </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,73% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Z </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,73% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13,84% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yo </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13,84% </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parece que en la declaraci√≥n de que el "palo largo" nunca aparece cuando es necesario, hay parte de la verdad (al menos para Nintendo Tetris). </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino Shift </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nintendo Tetris utiliza el cambio autom√°tico retardado (DAS). </font><font style="vertical-align: inherit;">Al hacer clic en "Izquierda" o "Derecha", el tetrimino se mueve instant√°neamente una celda horizontalmente. </font><font style="vertical-align: inherit;">Mientras mantiene presionado uno de estos botones de direcci√≥n, el juego cambia autom√°ticamente la figura cada 6 cuadros con un retraso inicial de 16 cuadros. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este tipo de movimiento horizontal est√° controlado por el c√≥digo en la direcci√≥n </font></font><code>$89AE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como en el c√≥digo de rotaci√≥n, aqu√≠ se usa una variable temporal para hacer una copia de seguridad de las coordenadas </font><font style="vertical-align: inherit;">en caso de que la nueva posici√≥n sea incorrecta. </font><font style="vertical-align: inherit;">Tenga en cuenta que la comprobaci√≥n le impide mover la pieza mientras el jugador presiona Abajo.</font></font><br><br> <code>89AE: LDA $0040 <br> 89B0: STA $00AE ; originalX = tetriminoX; <br> <br> 89B2: LDA $00B6 ; if (pressing down) { <br> 89B4: AND #$04 ; return; <br> 89B6: BNE $8A09 ; } <br> <br> 89B8: LDA $00B5 ; if (just pressed left/right) { <br> 89BA: AND #$03 ; goto resetAutorepeatX; <br> 89BC: BNE $89D3 ; } <br> <br> 89BE: LDA $00B6 ; if (not pressing left/right) { <br> 89C0: AND #$03 ; return; <br> 89C2: BEQ $8A09 ; } <br> <br> 89C4: INC $0046 ; autorepeatX++; <br> 89C6: LDA $0046 ; if (autorepeatX &lt; 16) { <br> 89C8: CMP #$10 ; return; <br> 89CA: BMI $8A09 ; } <br> <br> 89CC: LDA #$0A <br> 89CE: STA $0046 ; autorepeatX = 10; <br> 89D0: JMP $89D7 ; goto buttonHeldDown; <br> <br> resetAutorepeatX: <br> <br> 89D3: LDA #$00 <br> 89D5: STA $0046 ; autorepeatX = 0; <br> <br> buttonHeldDown: <br> <br> 89D7: LDA $00B6 ; if (not pressing right) { <br> 89D9: AND #$01 ; goto notPressingRight; <br> 89DB: BEQ $89EC ; } <br> <br> 89DD: INC $0040 ; tetriminoX++; <br> 89DF: JSR $948B ; if (new position not valid) { <br> 89E2: BNE $8A01 ; goto restoreX; <br> ; } <br> <br> 89E4: LDA #$03 <br> 89E6: STA $06F1 ; play shift sound effect; <br> 89E9: JMP $8A09 ; return; <br> <br> notPressingRight: <br> <br> 89EC: LDA $00B6 ; if (not pressing left) { <br> 89EE: AND #$02 ; return; <br> 89F0: BEQ $8A09 ; } <br> <br> 89F2: DEC $0040 ; tetriminoX--; <br> 89F4: JSR $948B ; if (new position not valid) { <br> 89F7: BNE $8A01 ; goto restoreX; <br> ; } <br> <br> 89F9: LDA #$03 <br> 89FB: STA $06F1 ; play shift sound effect; <br> 89FE: JMP $8A09 ; return; <br> <br> restoreX: <br> <br> 8A01: LDA $00AE <br> 8A03: STA $0040 ; tetriminoX = originalX; <br> <br> 8A05: LDA #$10 <br> 8A07: STA $0046 ; autorepeatX = 16; <br> <br> 8A09: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>x</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lanzando Tetrimino </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La velocidad del descenso autom√°tico de Tetrimino es una funci√≥n del n√∫mero de nivel. </font><font style="vertical-align: inherit;">Las velocidades se codifican como el n√∫mero de cuadros renderizados para el descenso en la tabla ubicada en </font></font><code>$898E</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como NES opera a 60.0988 cuadros / s, puede calcular el per√≠odo entre descensos y la velocidad.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nivel </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Marcos de descenso </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Periodo (s / descenso) </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Velocidad (celdas / s) </font></font></th></tr><tr><td>  0 0 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 48 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .799 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,25 </font></font></td></tr><tr><td>  1 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 43 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .715 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,40 </font></font></td></tr><tr><td>  2 </td><td>  38 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .632 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,58 </font></font></td></tr><tr><td>  3 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 33 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .549 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,82 </font></font></td></tr><tr><td>  4 4 </td><td>  28 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .466 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2,15 </font></font></td></tr><tr><td>  5 5 </td><td>  23 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .383 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2,61 </font></font></td></tr><tr><td>  6 6 </td><td>  18 a√±os </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .300 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3,34 </font></font></td></tr><tr><td>  7 7 </td><td>  13 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .216 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4.62 </font></font></td></tr><tr><td>  8 </td><td>  8 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .133 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7.51 </font></font></td></tr><tr><td>  9 9 </td><td>  6 6 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .100 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10.02 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10-12 </font></font></td><td>  5 5 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .083 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12.02 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13-15 </font></font></td><td>  4 4 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .067 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 15.05 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16-18 </font></font></td><td>  3 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .050 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 20/03 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 19‚Äì28 </font></font></td><td>  2 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .033 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 30.05 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 29+ </font></font></td><td>  1 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .017 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 60,10 </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tabla tiene un total de 30 entradas. Despu√©s del nivel 29, el valor de cuadros para el descenso es siempre 1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un n√∫mero entero de cuadros para el descenso no es una forma muy detallada de describir la velocidad. Como se muestra en el gr√°fico a continuaci√≥n, la velocidad aumenta exponencialmente con cada nivel. De hecho, el nivel 29 es dos veces m√°s r√°pido que el nivel 28.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddd/18c/a29/ddd18ca2950f9055bd5f82108a4d3ddc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con 1 cuadro / descenso, el jugador no tiene m√°s de 1/3 de segundo para colocar la figura, despu√©s de lo cual comenzar√° a moverse. A esta velocidad de descenso, DAS evita que la figura llegue a los bordes del campo de juego hasta que se bloquee en su lugar, lo que para la mayor√≠a de las personas significa un final r√°pido del juego. Sin embargo, algunos jugadores, especialmente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thor Akerlund</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lograron derrotar a DAS con la r√°pida vibraci√≥n de los botones cruzados ( </font></font><code>D-pad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). En el c√≥digo de cambio que se muestra arriba, se puede ver que mientras el bot√≥n de direcci√≥n horizontal se suelta a trav√©s del cuadro, es posible cambiar el tetrimino en los niveles 29 y superiores con media frecuencia. Este es un m√°ximo te√≥rico, pero cualquier vibraci√≥n del pulgar por encima de 3.75 golpes / s puede vencer el retraso original de 16 cuadros.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el descenso autom√°tico y controlado por el jugador (presionando "Abajo") coinciden y ocurren en un cuadro, el efecto no suma. Cualquiera o ambos de estos eventos hacen que la forma baje exactamente una celda en este cuadro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La l√≥gica de control del disparador se encuentra en </font></font><code>$8914</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La tabla del marco de descenso est√° debajo de la etiqueta </font><font style="vertical-align: inherit;">. Como se mencion√≥ anteriormente, en el nivel 29 y superior, la velocidad es constantemente igual a 1 obturador / marco. </font><font style="vertical-align: inherit;">(direcci√≥n </font><font style="vertical-align: inherit;">) comienza el descenso cuando llega a </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">). El incremento </font><font style="vertical-align: inherit;">se realiza en una direcci√≥n </font><font style="vertical-align: inherit;">fuera de este fragmento de c√≥digo. Durante el descenso autom√°tico o controlado, se restablece a 0. La </font><font style="vertical-align: inherit;">variable </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) se inicializa con el valor </font><font style="vertical-align: inherit;">(en la direcci√≥n</font></font><br><br> <code>8914: LDA $004E ; if (autorepeatY &gt; 0) { <br> 8916: BPL $8922 ; goto autorepeating; <br> ; } else if (autorepeatY == 0) { <br> ; goto playing; <br> ; } <br> <br> ; game just started <br> ; initial Tetrimino hanging at spawn point <br> <br> 8918: LDA $00B5 ; if (not just pressed down) { <br> 891A: AND #$04 ; goto incrementAutorepeatY; <br> 891C: BEQ $8989 ; } <br> <br> ; player just pressed down ending startup delay <br> <br> 891E: LDA #$00 <br> 8920: STA $004E ; autorepeatY = 0; <br> 8922: BNE $8939 <br> <br> playing: <br> <br> 8924: LDA $00B6 ; if (left or right pressed) { <br> 8926: AND #$03 ; goto lookupDropSpeed; <br> 8928: BNE $8973 ; } <br> <br> ; left/right not pressed <br> <br> 892A: LDA $00B5 <br> 892C: AND #$0F ; if (not just pressed only down) { <br> 892E: CMP #$04 ; goto lookupDropSpeed; <br> 8930: BNE $8973 ; } <br> <br> ; player exclusively just presssed down <br> <br> 8932: LDA #$01 <br> 8934: STA $004E ; autorepeatY = 1; <br> <br> 8936: JMP $8973 ; goto lookupDropSpeed; <br> <br> autorepeating: <br> <br> 8939: LDA $00B6 <br> 893B: AND #$0F ; if (down pressed and not left/right) { <br> 893D: CMP #$04 ; goto downPressed; <br> 893F: BEQ $894A ; } <br> <br> ; down released <br> <br> 8941: LDA #$00 <br> 8943: STA $004E ; autorepeatY = 0 <br> 8945: STA $004F ; holdDownPoints = 0 <br> 8947: JMP $8973 ; goto lookupDropSpeed; <br> <br> downPressed: <br> <br> 894A: INC $004E ; autorepeatY++; <br> 894C: LDA $004E <br> 894E: CMP #$03 ; if (autorepeatY &lt; 3) { <br> 8950: BCC $8973 ; goto lookupDropSpeed; <br> ; } <br> <br> 8952: LDA #$01 <br> 8954: STA $004E ; autorepeatY = 1; <br> <br> 8956: INC $004F ; holdDownPoints++; <br> <br> drop: <br> <br> 8958: LDA #$00 <br> 895A: STA $0045 ; fallTimer = 0; <br> <br> 895C: LDA $0041 <br> 895E: STA $00AE ; originalY = tetriminoY; <br> <br> 8960: INC $0041 ; tetriminoY++; <br> 8962: JSR $948B ; if (new position valid) { <br> 8965: BEQ $8972 ; return; <br> ; } <br> <br> ; the piece is locked <br> <br> 8967: LDA $00AE <br> 8969: STA $0041 ; tetriminoY = originalY; <br> <br> 896B: LDA #$02 <br> 896D: STA $0048 ; playState = UPDATE_PLAYFIELD; <br> 896F: JSR $9CAF ; updatePlayfield(); <br> <br> 8972: RTS ; return; <br> <br> lookupDropSpeed: <br> <br> 8973: LDA #$01 ; tempSpeed = 1; <br> <br> 8975: LDX $0044 ; if (level &gt;= 29) { <br> 8977: CPX #$1D ; goto noTableLookup; <br> 8979: BCS $897E ; } <br> <br> 897B: LDA $898E,X ; tempSpeed = framesPerDropTable[level]; <br> <br> noTableLookup: <br> <br> 897E: STA $00AF ; dropSpeed = tempSpeed; <br> <br> 8980: LDA $0045 ; if (fallTimer &gt;= dropSpeed) { <br> 8982: CMP $00AF ; goto drop; <br> 8984: BPL $8958 ; } <br> <br> 8986: JMP $8972 ; return; <br> <br> incrementAutorepeatY: <br> <br> 8989: INC $004E ; autorepeatY++; <br> 898B: JMP $8972 ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>lookupDropSpeed</code><font style="vertical-align: inherit;"></font><br><br> <code>fallTimer</code><font style="vertical-align: inherit;"></font><code>$0045</code><font style="vertical-align: inherit;"></font><code>dropSpeed</code><font style="vertical-align: inherit;"></font><code>$00AF</code><font style="vertical-align: inherit;"></font><code>fallTimer</code><font style="vertical-align: inherit;"></font><code>$8892</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>autorepeatY</code><font style="vertical-align: inherit;"></font><code>$004E</code><font style="vertical-align: inherit;"></font><code>$0A</code><font style="vertical-align: inherit;"></font><code>$8739</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que se interpreta como ‚àí96. Una condici√≥n al principio causa un retraso inicial. El primer Tetrimino permanece suspendido en el aire en el punto de creaci√≥n hasta </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que aumenta a 0, lo que lleva 1.6 segundos. Sin embargo, cuando presiona Abajo en esta fase, se le </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asigna instant√°neamente 0. Es interesante que pueda mover y rotar la figura en esta fase del retraso inicial sin cancelarla. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El incremento </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se realiza mientras se mantiene presionado. Cuando llega a 3, se produce un descenso controlado por el hombre (descenso "suave") y se le </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asigna 1. Por lo tanto, el descenso suave inicial requiere 3 cuadros, pero luego se repite en cada cuadro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumenta de 0 a 1 solo cuando el juego reconoce que el jugador acaba de hacer clic en Abajo (en</font></font><code>$00B5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), pero no reconoce mantener presionado. Esto es importante porque se </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restablece a 0 cuando se crea un tetrimino (en la direcci√≥n </font></font><code>$98E8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), lo que crea una caracter√≠stica importante: si el jugador mismo baja la figura y se bloquea, y contin√∫a presionando "Abajo" al crear la siguiente figura, que a menudo ocurre en niveles altos, entonces Esto no conducir√° a un suave descenso de la nueva figura. Para que esto suceda, el jugador debe soltar "Abajo" y luego presionar el bot√≥n nuevamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El descenso potencialmente suave puede aumentar los puntos. </font></font><code>holdDownPoints</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$004F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) aumenta con cada descenso, pero cuando se suelta, "Abajo" se restablece a 0. Por lo tanto, para ganar puntos, es necesario bajar el tetrimino en la cerradura con un descenso suave. El descenso suave a corto plazo, que puede ocurrir en el camino de la figura, no afecta los puntos. La cuenta se actualiza en</font></font><code>$9BFE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pero se </font></font><code>holdDownPoints</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restablece a 0 poco despu√©s, en la direcci√≥n </font></font><code>$9C2F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La verificaci√≥n, que evita que el jugador realice un descenso suave con un desplazamiento horizontal de la figura, complica el conjunto de puntos. Significa que el √∫ltimo movimiento antes de bloquear la pieza en su lugar debe ser "Abajo". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando ocurre el descenso, </font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0041</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) se copia a </font></font><code>originalY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$00AE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Si la nueva posici√≥n creada por el incremento </font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resulta ser incorrecta (es decir, la figura empuja a trav√©s del piso del campo de juego o se superpone en cuadrados ya existentes), entonces el tetrimino permanece en la posici√≥n anterior. En este caso, se restaura</font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y la figura se considera bloqueada. </font><font style="vertical-align: inherit;">Esto significa que el retraso antes del bloqueo (el n√∫mero m√°ximo de cuadros que espera un tetrimino, que se mantiene en el aire antes del bloqueo) es igual al retraso en el descenso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El descenso r√≠gido (ca√≠da instant√°nea) no es compatible con Nintendo Tetris.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Deslizamiento y desplazamiento </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El manual de Nintendo Tetris tiene un ejemplo ilustrativo de deslizamiento: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f6f/4bb/647/f6f4bb647937094d3d68fae530b0bfd4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El deslizamiento consiste en desplazarse a lo largo de la superficie de otras figuras o en el piso del campo de juego. </font><font style="vertical-align: inherit;">Por lo general, se usa para empujar una figura debajo de un cuadrado saliente. </font><font style="vertical-align: inherit;">El deslizamiento se puede realizar hasta que el temporizador de ca√≠da alcance la velocidad de descenso, despu√©s de lo cual la figura se bloquear√° en su lugar. </font><font style="vertical-align: inherit;">Un ejemplo animado se muestra a continuaci√≥n.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/9f5/022/efe9f502248d4185409fc20db3a47647.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Por otro lado, el desplazamiento le permite empujar figuras en espacios que son inalcanzables de otra manera (ver m√°s abajo). </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c53/ca5/350/c53ca53509826b9f2c462c0290ffa9c9.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al igual que el deslizamiento, el desplazamiento no es posible sin un retraso de bloqueo. </font><font style="vertical-align: inherit;">Pero m√°s all√° de eso, el desplazamiento explota la forma en que el juego manipula las formas. </font><font style="vertical-align: inherit;">Antes de mover o rotar la figura, el juego verifica que despu√©s de cambiar la posici√≥n todos los cuadrados tetriminos estar√°n en celdas vac√≠as dentro de los l√≠mites del campo de juego. </font><font style="vertical-align: inherit;">Tal verificaci√≥n, como se muestra a continuaci√≥n, no impide la rotaci√≥n a trav√©s de bloques llenos cercanos. </font><font style="vertical-align: inherit;">Como se indic√≥ en la secci√≥n Descripci√≥n de Tetrimino, cada fila de la tabla de orientaci√≥n contiene 12 bytes; </font><font style="vertical-align: inherit;">por lo tanto, el √≠ndice en esta tabla se calcula multiplicando el ID de orientaci√≥n del tetrimino activo por 12. Como se muestra a continuaci√≥n, todas las multiplicaciones en la rutina se realizan utilizando cambios y sumas.</font></font><br><br> <code>948B: LDA $0041 <br> 948D: ASL <br> 948E: STA $00A8 <br> 9490: ASL <br> 9491: ASL <br> 9492: CLC <br> 9493: ADC $00A8 <br> 9495: ADC $0040 <br> 9497: STA $00A8 <br> <br> 9499: LDA $0042 <br> 949B: ASL <br> 949C: ASL <br> 949D: STA $00A9 <br> 949F: ASL <br> 94A0: CLC <br> 94A1: ADC $00A9 <br> 94A3: TAX ; index = 12 * orientationID; <br> 94A4: LDY #$00 <br> <br> 94A6: LDA #$04 <br> 94A8: STA $00AA ; for(i = 0; i &lt; 4; i++) { <br> <br> 94AA: LDA $8A9C,X ; squareY = orientationTable[index]; <br> 94AD: CLC <br> 94AE: ADC $0041 ; cellY = squareY + tetriminoY; <br> 94B0: ADC #$02 ; if (cellY &lt; -2 || cellY &gt;= 20) { <br> 94B2: CMP #$16 ; return false; <br> 94B4: BCS $94E9 ; } <br> <br> 94B6: LDA $8A9C,X <br> 94B9: ASL <br> 94BA: STA $00AB <br> 94BC: ASL <br> 94BD: ASL <br> 94BE: CLC <br> 94BF: ADC $00AB <br> 94C1: CLC <br> 94C2: ADC $00A8 <br> 94C4: STA $00AD <br> <br> 94C6: INX <br> 94C7: INX ; index += 2; <br> <br> 94C8: LDA $8A9C,X ; squareX = orientationTable[index]; <br> 94CB: CLC <br> 94CC: ADC $00AD <br> 94CE: TAY ; cellX = squareX + tetriminoX; <br> 94CF: LDA ($B8),Y ; if (playfield[10 * cellY + cellX] != EMPTY_TILE) { <br> 94D1: CMP #$EF ; return false; <br> 94D3: BCC $94E9 ; } <br> <br> 94D5: LDA $8A9C,X <br> 94D8: CLC <br> 94D9: ADC $0040 ; if (cellX &lt; 0 || cellX &gt;= 10) { <br> 94DB: CMP #$0A ; return false; <br> 94DD: BCS $94E9 ; } <br> <br> 94DF: INX ; index++; <br> 94E0: DEC $00AA <br> 94E2: BNE $94AA ; } <br> <br> 94E4: LDA #$00 <br> 94E6: STA $00A8 <br> 94E8: RTS ; return true; <br> <br> 94E9: LDA #$FF <br> 94EB: STA $00A8 <br> 94ED: RTS</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>index = (orientationID &lt;&lt; 3) + (orientationID &lt;&lt; 2); // index = 8 * orientationID + 4 * orientationID; <br> <br> (cellY &lt;&lt; 3) + (cellY &lt;&lt; 1) // 8 * cellY + 2 * cellY</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada iteraci√≥n del ciclo desplaza la posici√≥n del tetrimino por las coordenadas relativas de uno de los cuadrados de la tabla de orientaci√≥n para obtener la ubicaci√≥n de la celda correspondiente en el campo de juego. Luego verifica que las coordenadas de la celda est√©n dentro de los l√≠mites del campo de juego y que la celda en s√≠ est√© vac√≠a. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los comentarios describen m√°s claramente c√≥mo verificar el espacio entre l√≠neas. </font><font style="vertical-align: inherit;">Adem√°s de las celdas en las l√≠neas visibles, el c√≥digo considera las dos l√≠neas ocultas sobre el campo de juego como las posiciones legales de los cuadrados sin usar una condici√≥n compuesta. Esto funciona porque en el </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">c√≥digo adicional los</font></a><font style="vertical-align: inherit;"> n√∫meros negativos representados por las variables de un solo byte son equivalentes a valores mayores que 127. En este caso, el valor m√≠nimo </font><font style="vertical-align: inherit;">es ‚àí2, que se almacena como</font></font><br><br> <code>94AA: LDA $8A9C,X ; squareY = orientationTable[index]; <br> 94AD: CLC <br> 94AE: ADC $0041 ; cellY = squareY + tetriminoY; <br> 94B0: ADC #$02 ; if (cellY + 2 &gt;= 22) { <br> 94B2: CMP #$16 ; return false; <br> 94B4: BCS $94E9 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>cellY</code><font style="vertical-align: inherit;"></font><code>$FE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(254 en notaci√≥n decimal). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El √≠ndice del campo de juego es la suma </font></font><code>cellY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multiplicada por 10 y </font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sin embargo, cuando </font></font><code>cellY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚àí1 ( </font></font><code>$FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 255) o ‚àí2 ( </font></font><code>$FE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 254), el producto produce ‚àí10 ( </font></font><code>$F6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 246) y ‚àí20 ( </font></font><code>$EC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 236). Al estar en el intervalo, no </font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede ser m√°s de 9, lo que da un √≠ndice m√°ximo de 246 + 9 = 255, y esto est√° mucho m√°s all√° del final del campo de juego. Sin embargo, el juego se inicializa </font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>$04FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un valor </font></font><code>$EF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(de un mosaico vac√≠o), creando otros 56 bytes adicionales de espacio vac√≠o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extra√±o ese chequeo de intervalo</font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realizado despu√©s de examinar la celda del campo de juego. </font><font style="vertical-align: inherit;">Pero funciona correctamente en cualquier orden. </font><font style="vertical-align: inherit;">Adem√°s, verificar el intervalo evita la condici√≥n compuesta, como se indica en el comentario a continuaci√≥n. </font><font style="vertical-align: inherit;">Los ejemplos de desplazamiento que se muestran a continuaci√≥n son posibles debido a la forma en que este c√≥digo verifica las posiciones.</font></font><br><br> <code>94D5: LDA $8A9C,X <br> 94D8: CLC <br> 94D9: ADC $0040 ; if (cellX &gt;= 10) { <br> 94DB: CMP #$0A ; return false; <br> 94DD: BCS $94E9 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/45f/c2d/dc0/45fc2ddc0d156d534aad4fd065b86aa4.gif"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/15f/185/0db/15f1850dbfca0b491498e8d81ab03877.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como se muestra a continuaci√≥n, incluso puede realizar el deslizamiento con desplazamiento. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08f/74c/c78/08f74cc7825cd53d5a8002b8e33c4612.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AI aprovecha al m√°ximo las capacidades de movimiento de Nintendo Tetris, incluidos el desplazamiento y el desplazamiento. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nivel 30 y superior </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Despu√©s de alcanzar el nivel 30, parece que el nivel se restablece a cero. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/feb/fee/b1f/febfeeb1faafda1a70f5da385c2276ac.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pero el nivel 31 muestra que algo m√°s est√° sucediendo: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/26e/057/20c/26e05720ca15aa302a0b61e09498e5a0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los valores de nivel mostrados se encuentran en la tabla en la direcci√≥n </font></font><code>$96B8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <code>96B8: 00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como se muestra a continuaci√≥n, la tabla de patrones se ordena de manera que las baldosas con </font></font><code>$00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el </font></font><code>$0F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">son s√≠mbolos de glifos </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en </font></font><code>F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Esto significa que cuando se muestra un d√≠gito decimal o hexadecimal, el valor del d√≠gito en s√≠ mismo se usa como √≠ndice de la tabla de patrones. En nuestro caso, los valores de nivel se almacenan como decimal codificado en binario (BCD); cada mordisco de cada byte en la secuencia es un valor de mosaico.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e00/97a/713/e0097a713f629afaf73936d3192820e3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desafortunadamente, parece que los dise√±adores del juego asumieron que nadie pasar√≠a el nivel 29 y, por lo tanto, decidieron insertar solo 30 entradas en la tabla. Los valores extra√±os mostrados son bytes diferentes despu√©s de la tabla. Solo </font></font><code>$0044</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se </font><font style="vertical-align: inherit;">usa un byte (en la direcci√≥n </font><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">para indicar el n√∫mero de nivel </font><font style="vertical-align: inherit;">, raz√≥n por la cual el juego gira lentamente alrededor de los 256 valores que se muestran a continuaci√≥n.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code>00</code> </th> <th> <code>0</code> </th> <th> <code>1</code> </th> <th> <code>2</code> </th> <th> <code>3</code> </th> <th> <code>4</code> </th> <th> <code>5</code> </th> <th> <code>6</code> </th> <th> <code>7</code> </th> <th> <code>8</code> </th> <th> <code>9</code> </th> <th> <code>A</code> </th> <th> <code>B</code> </th> <th> <code>C</code> </th> <th> <code>D</code> </th> <th> <code>E</code> </th> <th> <code>F</code> </th> </tr><tr><th> <code>0</code> </th> <td> <code>00</code> </td> <td> <code>01</code> </td> <td> <code>02</code> </td> <td> <code>03</code> </td> <td> <code>04</code> </td> <td> <code>05</code> </td> <td> <code>06</code> </td> <td> <code>07</code> </td> <td> <code>08</code> </td> <td> <code>09</code> </td> <td> <code>10</code> </td> <td> <code>11</code> </td> <td> <code>12</code> </td> <td> <code>13</code> </td> <td> <code>14</code> </td> <td> <code>15</code> </td> </tr><tr><th> <code>1</code> </th> <td> <code>16</code> </td> <td> <code>17</code> </td> <td> <code>18</code> </td> <td> <code>19</code> </td> <td> <code>20</code> </td> <td> <code>21</code> </td> <td> <code>22</code> </td> <td> <code>23</code> </td> <td> <code>24</code> </td> <td> <code>25</code> </td> <td> <code>26</code> </td> <td> <code>27</code> </td> <td> <code>28</code> </td> <td> <code>29</code> </td> <td> <code>00</code> </td> <td> <code>0A</code> </td> </tr><tr><th> <code>2</code> </th> <td> <code>14</code> </td> <td> <code>1E</code> </td> <td> <code>28</code> </td> <td> <code>32</code> </td> <td> <code>3C</code> </td> <td> <code>46</code> </td> <td> <code>50</code> </td> <td> <code>5A</code> </td> <td> <code>64</code> </td> <td> <code>6E</code> </td> <td> <code>78</code> </td> <td> <code>82</code> </td> <td> <code>8C</code> </td> <td> <code>96</code> </td> <td> <code>A0</code> </td> <td> <code>AA</code> </td> </tr><tr><th> <code>3</code> </th> <td> <code>B4</code> </td> <td> <code>BE</code> </td> <td> <code>C6</code> </td> <td> <code>20</code> </td> <td> <code>E6</code> </td> <td> <code>20</code> </td> <td> <code>06</code> </td> <td> <code>21</code> </td> <td> <code>26</code> </td> <td> <code>21</code> </td> <td> <code>46</code> </td> <td> <code>21</code> </td> <td> <code>66</code> </td> <td> <code>21</code> </td> <td> <code>86</code> </td> <td> <code>21</code> </td> </tr><tr><th> <code>4</code> </th> <td> <code>A6</code> </td> <td> <code>21</code> </td> <td> <code>C6</code> </td> <td> <code>21</code> </td> <td> <code>E6</code> </td> <td> <code>21</code> </td> <td> <code>06</code> </td> <td> <code>22</code> </td> <td> <code>26</code> </td> <td> <code>22</code> </td> <td> <code>46</code> </td> <td> <code>22</code> </td> <td> <code>66</code> </td> <td> <code>22</code> </td> <td> <code>86</code> </td> <td> <code>22</code> </td> </tr><tr><th> <code>5</code> </th> <td> <code>A6</code> </td> <td> <code>22</code> </td> <td> <code>C6</code> </td> <td> <code>22</code> </td> <td> <code>E6</code> </td> <td> <code>22</code> </td> <td> <code>06</code> </td> <td> <code>23</code> </td> <td> <code>26</code> </td> <td> <code>23</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>29</code> </td> <td> <code>F0</code> </td> <td> <code>4A</code> </td> <td> <code>4A</code> </td> </tr><tr><th> <code>6</code> </th> <td> <code>4A</code> </td> <td> <code>4A</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>29</code> </td> <td> <code>0F</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>60</code> </td> <td> <code>A6</code> </td> <td> <code>49</code> </td> <td> <code>E0</code> </td> </tr><tr><th> <code>7</code> </th> <td> <code>15</code> </td> <td> <code>10</code> </td> <td> <code>53</code> </td> <td> <code>BD</code> </td> <td> <code>D6</code> </td> <td> <code>96</code> </td> <td> <code>A8</code> </td> <td> <code>8A</code> </td> <td> <code>0A</code> </td> <td> <code>AA</code> </td> <td> <code>E8</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> </tr><tr><th> <code>8</code> </th> <td> <code>20</code> </td> <td> <code>CA</code> </td> <td> <code>A5</code> </td> <td> <code>BE</code> </td> <td> <code>C9</code> </td> <td> <code>01</code> </td> <td> <code>F0</code> </td> <td> <code>1E</code> </td> <td> <code>A5</code> </td> <td> <code>B9</code> </td> <td> <code>C9</code> </td> <td> <code>05</code> </td> <td> <code>F0</code> </td> <td> <code>0C</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> </tr><tr><th> <code>9</code> </th> <td> <code>96</code> </td> <td> <code>38</code> </td> <td> <code>E9</code> </td> <td> <code>02</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>4C</code> </td> <td> <code>67</code> </td> <td> <code>97</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>0C</code> </td> </tr><tr><th> <code>A</code> </th> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>4C</code> </td> <td> <code>67</code> </td> <td> <code>97</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>06</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>A2</code> </td> </tr><tr><th> <code>B</code> </th> <td> <code>0A</code> </td> <td> <code>B1</code> </td> <td> <code>B8</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>C8</code> </td> <td> <code>CA</code> </td> <td> <code>D0</code> </td> <td> <code>F7</code> </td> <td> <code>E6</code> </td> <td> <code>49</code> </td> <td> <code>A5</code> </td> <td> <code>49</code> </td> <td> <code>C9</code> </td> <td> <code>14</code> </td> </tr><tr><th> <code>C</code> </th> <td> <code>30</code> </td> <td> <code>04</code> </td> <td> <code>A9</code> </td> <td> <code>20</code> </td> <td> <code>85</code> </td> <td> <code>49</code> </td> <td> <code>60</code> </td> <td> <code>A5</code> </td> <td> <code>B1</code> </td> <td> <code>29</code> </td> <td> <code>03</code> </td> <td> <code>D0</code> </td> <td> <code>78</code> </td> <td> <code>A9</code> </td> <td> <code>00</code> </td> <td> <code>85</code> </td> </tr><tr><th> <code>D</code> </th> <td> <code>AA</code> </td> <td> <code>A6</code> </td> <td> <code>AA</code> </td> <td> <code>B5</code> </td> <td> <code>4A</code> </td> <td> <code>F0</code> </td> <td> <code>5C</code> </td> <td> <code>0A</code> </td> <td> <code>A8</code> </td> <td> <code>B9</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>A5</code> </td> <td> <code>BE</code> </td> </tr><tr><th> <code>E</code> </th> <td> <code>C9</code> </td> <td> <code>01</code> </td> <td> <code>D0</code> </td> <td> <code>0A</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>06</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>4C</code> </td> <td> <code>BD</code> </td> <td> <code>97</code> </td> <td> <code>A5</code> </td> <td> <code>B9</code> </td> </tr><tr><th> <code>F</code> </th> <td> <code>C9</code> </td> <td> <code>04</code> </td> <td> <code>D0</code> </td> <td> <code>0A</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>38</code> </td> <td> <code>E9</code> </td> <td> <code>02</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>4C</code> </td> <td> <code>BD</code> </td> <td> <code>97</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> </tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los primeros 20 valores ordinales son en realidad otra tabla que almacena las compensaciones en el campo de juego para cada una de las 20 filas. </font><font style="vertical-align: inherit;">Dado que el campo de juego comienza con </font><font style="vertical-align: inherit;">y cada l√≠nea contiene 10 celdas, la direcci√≥n de una celda arbitraria es: </font><font style="vertical-align: inherit;">Dado que el procesador no admite la multiplicaci√≥n directamente, esta tabla de b√∫squeda proporciona una forma extremadamente r√°pida de obtener el producto. </font><font style="vertical-align: inherit;">La tabla correspondiente ocupa los siguientes 40 bytes. </font><font style="vertical-align: inherit;">Contiene 20 direcciones en formato little endian para la tabla de nombres 0 (un √°rea de memoria VRAM que contiene los valores de los mosaicos de fondo). </font><font style="vertical-align: inherit;">Son punteros a las l√≠neas de desplazamiento del campo de juego </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Los bytes restantes de los que se componen los valores de nivel mostrados son instrucciones.</font></font><br><br> <code>96D6: 00 ; 0 <br> 96D7: 0A ; 10 <br> 96D8: 14 ; 20 <br> 96D9: 1E ; 30 <br> 96DA: 28 ; 40 <br> 96DB: 32 ; 50 <br> 96DC: 3C ; 60 <br> 96DD: 46 ; 70 <br> 96DE: 50 ; 80 <br> 96DF: 5A ; 90 <br> 96E0: 64 ; 100 <br> 96E1: 6E ; 110 <br> 96E2: 78 ; 120 <br> 96E3: 82 ; 130 <br> 96E4: 8C ; 140 <br> 96E5: 96 ; 150 <br> 96E6: A0 ; 160 <br> 96E7: AA ; 170 <br> 96E8: B4 ; 180 <br> 96E9: BE ; 190</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0400</code><font style="vertical-align: inherit;"></font><br><br> <code>$0400 + 10 * y + x</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>$0400 + [$96D6 + y] + x</code> <br> <br><font style="vertical-align: inherit;"></font><code>$06</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Filas y estad√≠sticas </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El n√∫mero de filas completadas y estad√≠sticas de tetrimino ocupan 2 bytes cada una en las siguientes direcciones. </font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Direcciones </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cantidad </font></font></th></tr><tr><td> <code>0050</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>0051</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rangos </font></font></td></tr><tr><td> <code>03F0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F1</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> T </font></font></td></tr><tr><td> <code>03F2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F3</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J </font></font></td></tr><tr><td> <code>03F4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F5</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Z </font></font></td></tr><tr><td> <code>03F6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F7</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O </font></font></td></tr><tr><td> <code>03F8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F9</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S </font></font></td></tr><tr><td> <code>03FA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03FB</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L </font></font></td></tr><tr><td> <code>03FC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03FD</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yo </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De hecho, estos valores se almacenan como BCD peque√±os endian empaquetados de 16 bits. </font><font style="vertical-align: inherit;">Por ejemplo, el n√∫mero de filas se muestra a continuaci√≥n, que es 123. Los bytes se cuentan de derecha a izquierda para que los d√≠gitos decimales est√©n en orden.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f4/68b/c0e/4f468bc0e6f22afe40d74f1711bad46e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, los dise√±adores de juegos asumieron que ninguno de los valores ser√≠a mayor que 999. Por lo tanto, la l√≥gica de visualizaci√≥n procesa correctamente el primer byte como un BCD empaquetado, donde cada mordisco se usa como un valor de mosaico. </font><font style="vertical-align: inherit;">Pero todo el segundo byte se usa realmente como el d√≠gito decimal superior. </font><font style="vertical-align: inherit;">Cuando los d√≠gitos inferiores van de </font></font><code>99</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font><code>00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se produce el incremento normal del segundo byte. </font><font style="vertical-align: inherit;">Como resultado, el segundo byte recorre los 256 mosaicos. </font><font style="vertical-align: inherit;">Un ejemplo de esto se muestra a continuaci√≥n.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c7/b4a/d52/6c7b4ad52a59641b8c2e04971415f0df.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de borrar la l√≠nea, se ejecuta el siguiente c√≥digo para incrementar el n√∫mero de filas. </font><font style="vertical-align: inherit;">Se realizan verificaciones para los d√≠gitos medio e inferior para que permanezcan entre 0 y 9. Pero el d√≠gito superior se puede aumentar infinitamente. </font><font style="vertical-align: inherit;">Si despu√©s del incremento del n√∫mero de filas, el d√≠gito inferior es 0, entonces esto significa que el jugador acaba de completar un conjunto de 10 l√≠neas y necesita aumentar el n√∫mero de nivel. Como puede ver en el siguiente c√≥digo, se realiza una verificaci√≥n adicional antes del incremento de nivel. </font><font style="vertical-align: inherit;">La segunda verificaci√≥n est√° relacionada con el nivel de entrada seleccionado. Para ir a un cierto nivel </font><font style="vertical-align: inherit;">, independientemente del nivel inicial, el jugador debe borrar</font></font><br><br> <code>9BA8: INC $0050 ; increment middle-lowest digit pair <br> 9BAA: LDA $0050 <br> 9BAC: AND #$0F <br> 9BAE: CMP #$0A ; if (lowest digit &gt; 9) { <br> 9BB0: BMI $9BC7 <br> 9BB2: LDA $0050 <br> 9BB4: CLC <br> 9BB5: ADC #$06 ; set lowest digit to 0, increment middle digit <br> 9BB7: STA $0050 <br> 9BB9: AND #$F0 <br> 9BBB: CMP #$A0 ; if (middle digit &gt; 9) { <br> 9BBD: BCC $9BC7 <br> 9BBF: LDA $0050 <br> 9BC1: AND #$0F <br> 9BC3: STA $0050 ; set middle digit to 0 <br> 9BC5: INC $0051 ; increment highest digit <br> ; } <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>9BC7: LDA $0050 <br> 9BC9: AND #$0F <br> 9BCB: BNE $9BFB ; if (lowest digit == 0) { <br> 9BCD: JMP $9BD0 <br> <br> 9BD0: LDA $0051 <br> 9BD2: STA $00A9 <br> 9BD4: LDA $0050 <br> 9BD6: STA $00A8 ; copy digits from $0050-$0051 to $00A8-$00A9 <br> <br> 9BD8: LSR $00A9 <br> 9BDA: ROR $00A8 <br> 9BDC: LSR $00A9 <br> 9BDE: ROR $00A8 <br> 9BE0: LSR $00A9 <br> 9BE2: ROR $00A8 ; treat $00A8-$00A9 as a 16-bit packed BCD value <br> 9BE4: LSR $00A9 ; and right-shift it 4 times <br> 9BE6: ROR $00A8 ; this leaves the highest and middle digits in $00A8 <br> <br> 9BE8: LDA $0044 <br> 9BEA: CMP $00A8 ; if (level &lt; [$00A8]) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; } <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>X</code><font style="vertical-align: inherit;"></font><code>10X</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l√≠neas Por ejemplo, si un jugador comienza en el nivel 5, permanecer√° en √©l hasta que haya despejado 60 l√≠neas, despu√©s de lo cual ir√° al nivel 6. Despu√©s de eso, cada 10 l√≠neas adicionales conducir√°n a un aumento en el n√∫mero de nivel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para realizar esta verificaci√≥n, el valor de las filas rellenas se copia de </font></font><code>$0050</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$0051</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$00A9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Luego, la copia se desplaza a la derecha 4 veces, lo que para un BCD empaquetado es similar a dividir por 10. El d√≠gito decimal m√°s peque√±o se descarta, y los d√≠gitos m√°s altos y medios se desplazan por una posici√≥n, lo que da como resultado mordiscos </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e4/c0b/2e7/8e4c0b2e7d53a33d54cea8717a872a65.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, en la direcci√≥n, </font></font><code>$9BEA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el n√∫mero de nivel se compara directamente con el valor empaquetado del BCD </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">No hay b√∫squeda en la tabla para convertir el valor BCD a decimal, y este es un claro error. </font><font style="vertical-align: inherit;">Por ejemplo, en la imagen de arriba, el n√∫mero de nivel debe compararse con </font></font><code>$12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(18 en decimal) y no con 12. Por lo tanto, si un jugador decide comenzar en el nivel 17, el nivel en realidad ir√° a 120 filas, porque 18 es m√°s que 17. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tabla muestra el n√∫mero esperado de filas requeridas para la transici√≥n en cada nivel inicial. </font><font style="vertical-align: inherit;">Se compara con lo que realmente sucede debido a un error.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code> </code> </th> <td>  0 0 </td><td>  1 </td><td>  2 </td><td>  3 </td><td>  4 4 </td><td>  5 5 </td><td>  6 6 </td><td>  7 7 </td><td>  8 </td><td>  9 9 </td><td>  10 </td><td>  11 </td><td>  12 </td><td>  13 </td><td>  14 </td><td>  15 </td><td>  16 </td><td>  17 </td><td>  18 a√±os </td><td>  19 </td></tr><tr><th> <code>  </code> </th> <td>  10 </td><td>  20 </td><td>  30 </td><td>  40 </td><td>  50 </td><td>  60 60 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 70 </font></font></td><td>  80 </td><td>  90 </td><td>  100 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 110 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 120 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 130 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 140 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 150 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 160 </font></font></td><td>  170 </td><td>  180 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 190 </font></font></td><td>  200 </td></tr><tr><th> <code>    </code> </th> <td>  10 </td><td>  20 </td><td>  30 </td><td>  40 </td><td>  50 </td><td>  60 60 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 70 </font></font></td><td>  80 </td><td>  90 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 110 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 120 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 130 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 140 </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La cantidad esperada es la misma que la verdadera para los niveles iniciales 0‚Äì9. </font><font style="vertical-align: inherit;">De hecho, la coincidencia para el nivel de entrada 9 es aleatoria; </font><font style="vertical-align: inherit;">10-15 tambi√©n va al siguiente nivel con 100 filas, porque </font></font><code>$10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- esto es 16 en forma decimal. </font><font style="vertical-align: inherit;">La mayor diferencia entre lo esperado y lo real es de 60 filas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sospecho que el error se debe a cambios de dise√±o en las √∫ltimas etapas de desarrollo. </font><font style="vertical-align: inherit;">Mire la pantalla del men√∫, permitiendo al jugador elegir un nivel de entrada.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/858/51e/019/85851e019d65bf00d265fa4ea277b8c2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No hay una explicaci√≥n sobre c√≥mo comenzar desde los niveles superiores a 9. Pero en el folleto de Nintendo Tetris, se revela este secreto: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c20/cee/c3b/c20ceec3b4b30879812be109b6666b79.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parece que esta caracter√≠stica oculta fue inventada en el √∫ltimo momento. Tal vez se agreg√≥ muy cerca de la fecha de lanzamiento, lo que no permiti√≥ probarlo por completo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De hecho, la comprobaci√≥n de la serie inicial contiene un segundo error relacionado con la salida de valores para el intervalo. A continuaci√≥n hay comentarios en el c√≥digo que explican mejor lo que sucede en un nivel bajo. </font><font style="vertical-align: inherit;">La comparaci√≥n se realiza restando y verificando el signo del resultado. Pero un n√∫mero con signo de un solo byte se limita a ‚àí128 a 127. Si la diferencia es menor que ‚àí128, el n√∫mero se transfiere y el resultado se convierte en un n√∫mero positivo. Este principio se explica en los comentarios sobre el c√≥digo. </font><font style="vertical-align: inherit;">Al verificar que la diferencia est√° en este intervalo, se debe tener en cuenta que el n√∫mero de nivel, cuando se incrementa a valores superiores a 255, realiza la transferencia a 0, y</font></font><br><br> <code>9BE8: LDA $0044 <br> 9BEA: CMP $00A8 ; if (level - [$00A8] &lt; 0) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>9BE8: LDA $0044 ; difference = level - [$00A8]; <br> 9BEA: CMP $00A8 ; if (difference &lt; 0 &amp;&amp; difference &gt;= -128) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">potencialmente puede contener cualquier valor, porque se toma su mordisco superior </font></font><code>$0051</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cuyo incremento puede ocurrir infinitamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estos efectos se superponen, creando per√≠odos en los que el n√∫mero de nivel permanece sin cambios por error. </font><font style="vertical-align: inherit;">Los per√≠odos ocurren a intervalos regulares de 2,900 filas, comenzando en 2,190 filas, y duran 800 filas. </font><font style="vertical-align: inherit;">Por ejemplo, de 2190 ( </font></font><code>L90</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) a 2990 ( </font></font><code>T90</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), el nivel permanece igual a </font></font><code>$DB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>96</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), como se muestra a continuaci√≥n.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/055/e15/8de/055e158de2ecde24e0f052cd325bef32.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El siguiente per√≠odo pasa de 5090 a 5890, el nivel es constantemente igual a </font></font><code>$AD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Adem√°s, durante estos per√≠odos, la paleta de colores tampoco cambia.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Colorear Tetrimino </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cada nivel, a los azulejos tetrimino se les asignan 4 colores √∫nicos. </font><font style="vertical-align: inherit;">Los colores se toman de la tabla ubicada en </font></font><code>$984C</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sus registros se reutilizan cada 10 niveles. </font><font style="vertical-align: inherit;">De izquierda a derecha: las columnas de la tabla correspondientes a las √°reas negra, blanca, azul y roja de la imagen a continuaci√≥n.</font></font><br><br> <code>984C: 0F 30 21 12 ; level 0 <br> 9850: 0F 30 29 1A ; level 1 <br> 9854: 0F 30 24 14 ; level 2 <br> 9858: 0F 30 2A 12 ; level 3 <br> 985C: 0F 30 2B 15 ; level 4 <br> 9860: 0F 30 22 2B ; level 5 <br> 9864: 0F 30 00 16 ; level 6 <br> 9868: 0F 30 05 13 ; level 7 <br> 986C: 0F 30 16 12 ; level 8 <br> 9870: 0F 30 27 16 ; level 9</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68e/fc4/7d7/68efc47d771e9c673b003d76810d74fb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Los valores corresponden a la paleta de colores NES. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e80/c0a/8b6/e80c0a8b624b90261042d71eb21d50db.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los primeros 2 colores de cada entrada son siempre en blanco y negro. Sin embargo, el primer color se ignora realmente; independientemente del valor, se considera un color transparente a trav√©s del cual se asoma un fondo negro s√≥lido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El acceso a la tabla de colores se realiza en la rutina en </font></font><code>$9808</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El √≠ndice de la tabla de colores se basa en el n√∫mero de nivel dividido por un resto de 10. El ciclo copia la entrada a las tablas de paleta en VRAM. </font><font style="vertical-align: inherit;">La divisi√≥n con el resto se emula mediante una resta constante de 10 hasta que el resultado sea menor que 10. El comienzo de la subrutina con comentarios se muestra a continuaci√≥n.</font></font><br><br> <code>9808: LDA $0064 <br> 980A: CMP #$0A <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A <br> 9811: JMP $980A ; index = levelNumber % 10; <br> <br> 9814: ASL <br> 9815: ASL <br> 9816: TAX ; index *= 4; <br> <br> 9817: LDA #$00 <br> 9819: STA $00A8 ; for(i = 0; i &lt; 32; i += 16) { <br> <br> 981B: LDA #$3F <br> 981D: STA $2006 <br> 9820: LDA #$08 <br> 9822: CLC <br> 9823: ADC $00A8 <br> 9825: STA $2006 ; palette = $3F00 + i + 8; <br> <br> 9828: LDA $984C,X <br> 982B: STA $2007 ; palette[0] = colorTable[index + 0]; <br> <br> 982E: LDA $984D,X <br> 9831: STA $2007 ; palette[1] = colorTable[index + 1]; <br> <br> 9834: LDA $984E,X <br> 9837: STA $2007 ; palette[2] = colorTable[index + 2]; <br> <br> 983A: LDA $984F,X <br> 983D: STA $2007 ; palette[3] = colorTable[index + 3]; <br> <br> 9840: LDA $00A8 <br> 9842: CLC <br> 9843: ADC #$10 <br> 9845: STA $00A8 <br> 9847: CMP #$20 <br> 9849: BNE $981B ; } <br> <br> 984B: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> 980A: CMP #$0A ; while(index &gt;= 10) { <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A ; index -= 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, como se indic√≥ en la secci√≥n anterior, la resta y la ramificaci√≥n basadas en el signo de diferencia se usan en comparaci√≥n. </font><font style="vertical-align: inherit;">Un n√∫mero con signo de un solo byte est√° limitado a ‚àí128 a 127. Los comentarios actualizados a continuaci√≥n reflejan este principio. </font><font style="vertical-align: inherit;">Los comentarios a continuaci√≥n se simplifican a√∫n m√°s. </font><font style="vertical-align: inherit;">Esta redacci√≥n revela un error en el c√≥digo. </font><font style="vertical-align: inherit;">La operaci√≥n de divisi√≥n restante se omite por completo para niveles de 138 y superiores. </font><font style="vertical-align: inherit;">En cambio, el √≠ndice se asigna directamente al n√∫mero de nivel, que proporciona acceso a bytes mucho m√°s all√° del final de la tabla de colores. </font><font style="vertical-align: inherit;">Como se muestra a continuaci√≥n, esto incluso puede conducir a un tetrimino casi invisible.</font></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> ; difference = index - 10; <br> 980A: CMP #$0A ; while(difference &gt;= 0 &amp;&amp; difference &lt;= 127) { <br> 980C: BMI $9814 <br> 980E: SEC ; index -= 10; <br> 980F: SBC #$0A ; difference = index - 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> 980A: CMP #$0A ; while(index &gt;= 10 &amp;&amp; index &lt;= 137) { <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A ; index -= 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6ed/2e5/2c6/6ed2e52c6a20dc9c8c1ffd1bf13d9b37.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A continuaci√≥n se muestran los colores de los 256 niveles. </font><font style="vertical-align: inherit;">Los mosaicos se organizan en 10 columnas para enfatizar el uso c√≠clico de la tabla de colores, violada en el nivel 138. Las filas y columnas en los encabezados se indican en decimal.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/423/6f0/ed6/4236f0ed6a508633b746d773a530fe90.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de 255, el n√∫mero de nivel vuelve a 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, como se mencion√≥ en la secci√≥n anterior, algunos niveles no cambian hasta que se eliminan 800 filas. </font><font style="vertical-align: inherit;">Durante estos largos niveles, los colores permanecen sin cambios.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modo de juego </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El modo de juego almacenado en la direcci√≥n </font></font><code>$00C0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">determina cu√°l de las diversas pantallas y men√∫s se muestran actualmente al usuario.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Valor </th><th>  Descripci√≥n </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pantalla de informaci√≥n legal </font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pantalla de bienvenida </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Men√∫ de tipo de juego </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Men√∫ de niveles y alturas. </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Juego / puntuaci√≥n m√°s alta / final / pausa </font></font></td></tr><tr><td> <code>05</code> </td> <td>  Demo </td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como se muestra arriba, el juego tiene una rutina ingeniosamente escrita que act√∫a como una declaraci√≥n de cambio usando la peque√±a tabla de navegaci√≥n endian ubicada inmediatamente despu√©s de la llamada. </font><font style="vertical-align: inherit;">La lista anterior muestra las direcciones de todos los modos de juego. Tenga en cuenta que los modos "Juego" y "Demostraci√≥n" usan el mismo c√≥digo. </font><font style="vertical-align: inherit;">Esta rutina nunca regresa. En cambio, el c√≥digo usa la direcci√≥n de retorno; generalmente apunta a la instrucci√≥n que sigue inmediatamente a la llamada al salto a la subrutina (menos 1 byte), pero en este caso apunta a la tabla de salto. La direcci√≥n de retorno se saca de la pila y se almacena en </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. Despu√©s de guardar la direcci√≥n de la tabla de salto, el c√≥digo usa el valor en el registro A como √≠ndice y realiza la transici√≥n correspondiente.</font></font><br><br> <code>8161: LDA $00C0 <br> 8163: JSR $AC82 ; switch(gameMode) { <br> 8166: 00 82 ; case 0: goto 8200; //     <br> 8168: 4F 82 ; case 1: goto 824F; //   <br> 816A: D1 82 ; case 2: goto 82D1; //    <br> 816C: D7 83 ; case 3: goto 83D7; //     <br> 816E: 5D 81 ; case 4: goto 815D; //  /   /  /  <br> 8170: 5D 81 ; case 5: goto 815D; //  <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$0000</code><font style="vertical-align: inherit;"></font><code>$0001</code><font style="vertical-align: inherit;"></font><br><br> <code>AC82: ASL <br> AC83: TAY <br> AC84: INY <br> <br> AC85: PLA <br> AC86: STA $0000 <br> AC88: PLA ; pop return address off of stack <br> AC89: STA $0001 ; and store it at $0000-$0001 <br> <br> AC8B: LDA ($00),Y <br> AC8D: TAX <br> AC8E: INY <br> AC8F: LDA ($00),Y <br> AC91: STA $0001 <br> AC93: STX $0000 <br> AC95: JMP ($0000) ; goto Ath 16-bit address <br> ; in table at [$0000-$0001]</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El c√≥digo puede usar esta rutina de cambio siempre que los √≠ndices est√©n cerca de 0 y no haya espacios o pocos entre los posibles casos. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pantalla de informaci√≥n legal </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El juego comienza con una pantalla que muestra un aviso legal. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/4e2/d4b/5244e2d4b26989579afaad64838c0962.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la parte inferior de la pantalla, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aleksey Pazhitnov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es mencionado </font><font style="vertical-align: inherit;">como el inventor, dise√±ador y programador del primer Tetris. En 1984, trabajando como desarrollador de computadoras en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el Dorodnitsyn Computing Center</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (un instituto de investigaci√≥n l√≠der de la Academia de Ciencias de Rusia en Mosc√∫), desarroll√≥ un prototipo del juego en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Electronics-60</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (clon sovi√©tico DEC </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSI-11</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Se desarroll√≥ un prototipo para un modo de texto monocromo verde en el que los cuadrados se indican mediante pares de corchetes </font></font><code>[]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Con la ayuda del ni√±o de 16 a√±os </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vadim Gerasimov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y el ingeniero inform√°tico Dmitry Pavlovsky unos d√≠as despu√©s de la invenci√≥n del juego, el prototipo fue trasladado a una PC IBM con MS DOS y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turbo Pascal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En el transcurso de dos a√±os, perfeccionaron el juego juntos, agregando caracter√≠sticas como colores de tetrimino, estad√≠sticas y, lo que es m√°s importante, un c√≥digo de tiempo y gr√°ficos que permiti√≥ que el juego funcionara en una variedad de modelos de PC y clones. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desafortunadamente, debido a las peculiaridades de la Uni√≥n Sovi√©tica en ese momento, sus intentos de monetizar el juego no tuvieron √©xito y al final decidieron compartir la versi√≥n para PC con sus amigos de forma gratuita. A partir de ese momento, "Tetris" comenz√≥ a extenderse viralmente en todo el pa√≠s y m√°s all√°, copiado de un disco a otro. Pero dado que el juego fue desarrollado por empleados de una agencia gubernamental, el estado lo pose√≠a, y en 1987 la organizaci√≥n responsable del comercio internacional de tecnolog√≠as electr√≥nicas se hizo cargo de la licencia del juego ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Electronorgtekhnika (ELORG)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) La abreviatura V / O en la pantalla de informaci√≥n legal puede ser abreviada para Version Originale. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La compa√±√≠a brit√°nica de software </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andromeda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> intent√≥ obtener los derechos de Tetris y, antes de completar la transacci√≥n, otorg√≥ la licencia del juego a otros proveedores, por ejemplo, el editor brit√°nico de juegos de computadora </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mirrorsoft</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mirrorsoft, a su vez, lo sublicencia a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , una subsidiaria de Atari Games. Tengen otorg√≥ a Bullet-Proof Software los derechos para desarrollar un juego para computadoras y consolas en Jap√≥n, lo que result√≥ en Tetris para Nintendo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Famicom</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A continuaci√≥n se muestra su pantalla de informaci√≥n legal.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/750/b96/6c0/750b966c0d526110e504b409b3f1a1af.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curiosamente, en esta versi√≥n, el escolar Vadim Gerasimov es llamado el dise√±ador y programador original. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intentando asegurar la versi√≥n port√°til de la pr√≥xima consola Game Boy, Nintendo us√≥ el software Bullet-Proof para concluir un acuerdo exitoso directamente con ELORG. En el proceso de concluir el acuerdo, ELORG revis√≥ su contrato con Andromeda, agregando que Andromeda solo obtuvo derechos para juegos para computadoras y m√°quinas recreativas. Debido a esto, Bullet-Proof Software tuvo que pagar regal√≠as ELORG por todos los cartuchos vendidos a Famicom, porque los derechos que recibi√≥ de Tengen resultaron ser falsos. Pero a trav√©s de la reconciliaci√≥n con ELORG, Bullet-Proof Software finalmente logr√≥ obtener los derechos mundiales de juegos de consola para Nintendo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bullet-Proof Software otorg√≥ la licencia de los derechos de juegos port√°tiles de Nintendo y juntos desarrollaron Game Boy Tetris, que se refleja en la pantalla de informaci√≥n legal a continuaci√≥n.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0dc/d28/e4c/0dcd28e4c4f7b3da1a0259fcdbcf9b70.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con los derechos de juego de la consola global, Nintendo ha desarrollado la versi√≥n Tetris para NES que estamos explorando en este art√≠culo. Luego, Bullet-Proof Software otorg√≥ la licencia de los derechos de Nintendo, lo que le permiti√≥ continuar vendiendo cartuchos para Famicom en Jap√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto fue seguido por una compleja batalla legal. Tanto Nintendo como Tengen exigieron que la parte contraria dejara de producir y vender su versi√≥n del juego. Como resultado, Nintendo gan√≥ y cientos de miles de cartuchos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengen Tetris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fueron destruidos. El veredicto judicial tambi√©n prohibi√≥ a otras compa√±√≠as como Mirrorsoft crear versiones de consola. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pajitnov nunca recibi√≥ ninguna deducci√≥n de ELORG o del estado sovi√©tico. Sin embargo, en 1991 se mud√≥ a los EE. UU. Y en 1996 con el apoyo del propietario del software Bullet-Proof</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Henka Rogers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cofund√≥ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Tetris Company</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que le permiti√≥ beneficiarse de versiones para dispositivos m√≥viles y consolas modernas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es interesante mirar la pantalla de informaci√≥n legal como una ventana que da una idea del origen modesto del juego y las batallas subsiguientes por los derechos de propiedad intelectual, porque para la mayor√≠a de los jugadores esta pantalla es solo un obst√°culo molesto, cuya desaparici√≥n parece tener que esperar para siempre. El retraso se establece en dos contadores, contando secuencialmente de 255 a 0. La primera fase no se puede omitir, y la segunda se omite presionando el bot√≥n Iniciar. Por lo tanto, la pantalla de informaci√≥n legal se muestra al menos 4,25 segundos y no m√°s de 8,5 segundos. Sin embargo, creo que la mayor√≠a de los jugadores se rinden y dejan de presionar Start durante el primer intervalo, y debido a esto est√°n esperando su finalizaci√≥n completa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El momento de las fases, as√≠ como el resto del juego, se rige por un controlador de interrupci√≥n desenmascarado llamado al comienzo de cada intervalo de supresi√≥n vertical, un corto per√≠odo de tiempo entre la representaci√≥n de cuadros de televisi√≥n. Es decir, cada 16.6393 milisegundos, el siguiente c√≥digo interrumpe la ejecuci√≥n normal del programa. </font><font style="vertical-align: inherit;">El controlador comienza pasando los valores de los registros principales a la pila y recuper√°ndolos despu√©s de la finalizaci√≥n para no interferir con la tarea interrumpida. La llamada </font><font style="vertical-align: inherit;">actualiza VRAM, convirtiendo la descripci√≥n del modelo de memoria a lo que se muestra en la pantalla. Adem√°s, el controlador reduce el valor del contador de la pantalla de informaci√≥n legal si es mayor que cero. Desaf√≠o</font></font><br><br> <code>8005: PHA <br> 8006: TXA <br> 8007: PHA <br> 8008: TYA <br> 8009: PHA ; save A, X, Y <br> <br> 800A: LDA #$00 <br> 800C: STA $00B3 <br> 800E: JSR $804B ; render(); <br> <br> 8011: DEC $00C3 ; legalScreenCounter1--; <br> <br> 8013: LDA $00C3 <br> 8015: CMP #$FF ; if (legalScreenCounter1 &lt; 0) { <br> 8017: BNE $801B ; legalScreenCounter1 = 0; <br> 8019: INC $00C3 ; } <br> <br> 801B: JSR $AB5E ; initializeOAM(); <br> <br> 801E: LDA $00B1 <br> 8020: CLC <br> 8021: ADC #$01 <br> 8023: STA $00B1 <br> 8025: LDA #$00 <br> 8027: ADC $00B2 <br> 8029: STA $00B2 ; frameCounter++; <br> <br> 802B: LDX #$17 <br> 802D: LDY #$02 <br> 802F: JSR $AB47 ; randomValue = generateNextPseudorandomNumber(randomValue); <br> <br> 8032: LDA #$00 <br> 8034: STA $00FD <br> 8036: STA $2005 ; scrollX = 0; <br> 8039: STA $00FC <br> 803B: STA $2005 ; scrollY = 0; <br> <br> 803E: LDA #$01 <br> 8040: STA $0033 ; verticalBlankingInterval = true; <br> <br> 8042: JSR $9D51 ; pollControllerButtons(); <br> <br> 8045: PLA <br> 8046: TAY <br> 8047: PLA <br> 8048: TAX <br> 8049: PLA ; restore A, X, Y <br> <br> 804A: RTI ; resume interrupted task</code> <br> <br><font style="vertical-align: inherit;"></font><code>render()</code><font style="vertical-align: inherit;"></font><code>initializeOAM()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realiza el paso requerido por el equipo de generaci√≥n de cuadros. El controlador contin√∫a trabajando incrementando el contador de trama, el peque√±o valor endian de 16 bits almacenado en la direcci√≥n </font></font><code>$00B1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>$00B2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que utiliza en diferentes lugares para controlar el tiempo. Despu√©s de eso, se genera el siguiente n√∫mero pseudoaleatorio; como se mencion√≥ anteriormente, esto sucede independientemente del modo al menos una vez por cuadro. El </font></font><code>$8040</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicador de intervalo de supresi√≥n vertical se establece </font><font style="vertical-align: inherit;">en la direcci√≥n </font><font style="vertical-align: inherit;">, lo que significa que el controlador acaba de ejecutarse. Finalmente, se sondean los botones del controlador; El comportamiento de esta rutina se describe a continuaci√≥n en la secci√≥n Demo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La bandera es </font></font><code>verticalBlankingInterval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilizada por la rutina discutida anteriormente. Contin√∫a hasta que comienza la ejecuci√≥n del controlador de interrupciones.</font></font><br><br> <code>AA2F: JSR $E000 ; updateAudio(); <br> <br> AA32: LDA #$00 <br> AA34: STA $0033 ; verticalBlankingInterval = false; <br> <br> AA36: NOP <br> <br> AA37: LDA $0033 <br> AA39: BEQ $AA37 ; while(!verticalBlankingInterval) { } <br> <br> AA3B: LDA #$FF <br> AA3D: LDX #$02 <br> AA3F: LDY #$02 <br> AA41: JSR $AC6A ; fill memory page 2 with all $FF's <br> <br> AA44: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta rutina de bloqueo es utilizada por dos etapas de sincronizaci√≥n de la pantalla de informaci√≥n legal, que se ejecutan una tras otra. </font><font style="vertical-align: inherit;">El script Lua AI evita este retraso al establecer ambos contadores en 0.</font></font><br><br> <code>8236: LDA #$FF <br> 8238: JSR $A459 <br> <br> ... <br> <br> A459: STA $00C3 ; legalScreenCounter1 = 255; <br> <br> A45B: JSR $AA2F ; do { <br> A45E: LDA $00C3 ; waitForVerticalBlankingInterval(); <br> A460: BNE $A45B ; } while(legalScreenCounter1 &gt; 0); <br> <br> A462: RTS ; return;</code> <br> <br> <code>823B: LDA #$FF <br> 823D: STA $00A8 ; legalScreenCounter2 = 255; <br> <br> ; do { <br> <br> 823F: LDA $00F5 ; if (just pressed Start) { <br> 8241: CMP #$10 ; break; <br> 8243: BEQ $824C ; } <br> <br> 8245: JSR $AA2F ; waitForVerticalBlankingInterval(); <br> <br> 8248: DEC $00A8 ; legalScreenCounter2--; <br> 824A: BNE $823F ; } while(legalScreenCounter2 &gt; 0); <br> <br> 824C: INC $00C0 ; gameMode = TITLE_SCREEN;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><h3>  Demo </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La demostraci√≥n muestra unos 80 segundos de juego pregrabado. No solo muestra el archivo de video, sino que usa el mismo motor que en el juego. Durante la reproducci√≥n, se utilizan dos tablas. El primero, ubicado en la direcci√≥n </font></font><code>$DF00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contiene la siguiente secuencia de creaci√≥n de tetrimino: </font></font><br><br> <code>TJTSZJTSZJSZLZJTTSITO JSZLZLIOLZLIOJTSITOJ</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al crear una figura, se selecciona al azar o se lee de la tabla, seg√∫n el modo. El cambio ocurre en la direcci√≥n </font></font><code>$98EB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El tipo Tetrimino se extrae de los bits 6, 5 y 4 de cada byte. De vez en cuando, esta operaci√≥n nos da un valor </font><font style="vertical-align: inherit;">: el tipo incorrecto. Sin embargo, la tabla de la creaci√≥n de formas ( </font><font style="vertical-align: inherit;">) utilizado para una conversi√≥n de tipo en Tetrimino orientaci√≥n ID se encuentra realmente entre las dos tablas vinculadas: </font><font style="vertical-align: inherit;">Significado</font></font><br><br> <code>98EB: LDA $00C0 <br> 98ED: CMP #$05 <br> 98EF: BNE $9903 ; if (gameMode == DEMO) { <br> <br> 98F1: LDX $00D3 <br> 98F3: INC $00D3 <br> 98F5: LDA $DF00,X ; value = demoTetriminoTypeTable[++demoIndex]; <br> <br> 98F8: LSR <br> 98F9: LSR <br> 98FA: LSR <br> 98FB: LSR <br> 98FC: AND #$07 <br> 98FE: TAX ; tetriminoType = bits 6,5,4 of value; <br> <br> 98FF: LDA $994E,X <br> 9902: RTS ; return spawnTable[tetriminoType]; <br> ; } else { <br> ; pickRandomTetrimino(); <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$07</code><font style="vertical-align: inherit;"></font><code>$994E</code><font style="vertical-align: inherit;"></font><br><br> <code>993B: 00 00 00 00 ; T <br> 993F: 01 01 01 01 ; J <br> 9943: 02 02 ; Z <br> 9945: 03 ; O <br> 9946: 04 04 ; S <br> 9948: 05 05 05 05 ; L <br> 994C: 06 06 ; I</code> <br> <br> <code>994E: 02 ; Td <br> 994F: 07 ; Jd <br> 9950: 08 ; Zh <br> 9951: 0A ; O <br> 9952: 0B ; Sh <br> 9953: 0E ; Ld <br> 9954: 12 ; Ih</code> <br> <br> <code>9956: 02 02 02 02 ; Td <br> 995A: 07 07 07 07 ; Jd <br> 995E: 08 08 ; Zh <br> 9960: 0A ; O <br> 9961: 0B 0B ; Sh <br> 9963: 0E 0E 0E 0E ; Ld <br> 9967: 12 12 ; Ih</code> <br> <br><font style="vertical-align: inherit;"></font><code>$07</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lo obliga a leer m√°s all√° del final de la tabla, en el siguiente, que da </font></font><code>Td</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debido a este efecto, este esquema puede darnos una secuencia ilimitada pero reproducible de ID pseudoaleatorios de la orientaci√≥n de las figuras creadas. El c√≥digo funcionar√° porque cualquier direcci√≥n arbitraria en una secuencia cambiante de bytes no nos permite determinar d√≥nde termina la tabla. De hecho, la secuencia en la direcci√≥n </font></font><code>$DF00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede ser parte de algo completamente ajeno a esto, especialmente teniendo en cuenta que la asignaci√≥n de los 5 bits restantes que no son cero no est√° clara, y la secuencia generada demuestra repetibilidad. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durante la inicializaci√≥n del modo de demostraci√≥n, el √≠ndice de la tabla ( </font></font><code>$00D3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) se restablece a la direcci√≥n </font></font><code>$872B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La segunda tabla de la demostraci√≥n contiene un registro de los botones del gamepad codificados en pares de bytes. </font><font style="vertical-align: inherit;">Los bits del primer byte corresponden a los botones.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code>7</code> </th> <th> <code>6</code> </th> <th> <code>5</code> </th> <th> <code>4</code> </th> <th> <code>3</code> </th> <th> <code>2</code> </th> <th> <code>1</code> </th> <th> <code>0</code> </th> </tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> B </font></font></td><td>  Seleccione </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicio </font></font></td><td>  Arriba </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Abajo </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A la izquierda </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A la derecha </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El segundo byte almacena el n√∫mero de cuadros durante los cuales se presiona una combinaci√≥n de botones. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tabla toma direcciones </font></font><code>$DD00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>$DEFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y consta de 256 pares. El acceso a √©l se realiza mediante la subrutina en la direcci√≥n </font></font><code>$9D5B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dado que la tabla de botones de demostraci√≥n tiene una longitud de 512 bytes, se requiere un √≠ndice de dos bytes para acceder a ella. El √≠ndice se almacena como little endian en </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. Se inicializa con el valor de la direcci√≥n de la tabla </font><font style="vertical-align: inherit;">, y su incremento se realiza mediante el siguiente c√≥digo. </font><font style="vertical-align: inherit;">Los programadores dejaron el procesamiento de entrada del jugador en el c√≥digo, lo que nos permite ver el proceso de desarrollo y reemplazar la demostraci√≥n con otro registro. El modo de grabaci√≥n de demostraci√≥n se activa cuando </font><font style="vertical-align: inherit;">se asigna un valor.</font></font><br><br> <code>9D5B: LDA $00D0 ; if (recording mode) { <br> 9D5D: CMP #$FF ; goto recording; <br> 9D5F: BEQ $9DB0 ; } <br> <br> 9D61: JSR $AB9D ; pollController(); <br> 9D64: LDA $00F5 ; if (start button pressed) { <br> 9D66: CMP #$10 ; goto startButtonPressed; <br> 9D68: BEQ $9DA3 ; } <br> <br> 9D6A: LDA $00CF ; if (repeats == 0) { <br> 9D6C: BEQ $9D73 ; goto finishedMove; <br> ; } else { <br> 9D6E: DEC $00CF ; repeats--; <br> 9D70: JMP $9D9A ; goto moveInProgress; <br> ; } <br> <br> finishedMove: <br> <br> 9D73: LDX #$00 <br> 9D75: LDA ($D1,X) <br> 9D77: STA $00A8 ; buttons = demoButtonsTable[index]; <br> <br> 9D79: JSR $9DE8 ; index++; <br> <br> 9D7C: LDA $00CE <br> 9D7E: EOR $00A8 <br> 9D80: AND $00A8 <br> 9D82: STA $00F5 ; setNewlyPressedButtons(difference between heldButtons and buttons); <br> <br> 9D84: LDA $00A8 <br> 9D86: STA $00CE ; heldButtons = buttons; <br> <br> 9D88: LDX #$00 <br> 9D8A: LDA ($D1,X) <br> 9D8C: STA $00CF ; repeats = demoButtonsTable[index]; <br> <br> 9D8E: JSR $9DE8 ; index++; <br> <br> 9D91: LDA $00D2 ; if (reached end of demo table) { <br> 9D93: CMP #$DF ; return; <br> 9D95: BEQ $9DA2 ; } <br> <br> 9D97: JMP $9D9E ; goto holdButtons; <br> <br> moveInProgress: <br> <br> 9D9A: LDA #$00 <br> 9D9C: STA $00F5 ; clearNewlyPressedButtons(); <br> <br> holdButtons: <br> <br> 9D9E: LDA $00CE <br> 9DA0: STA $00F7 ; setHeldButtons(heldButtons); <br> <br> 9DA2: RTS ; return; <br> <br> startButtonPressed: <br> <br> 9DA3: LDA #$DD <br> 9DA5: STA $00D2 ; reset index; <br> <br> 9DA7: LDA #$00 <br> 9DA9: STA $00B2 ; counter = 0; <br> <br> 9DAB: LDA #$01 <br> 9DAD: STA $00C0 ; gameMode = TITLE_SCREEN; <br> <br> 9DAF: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00D1</code><font style="vertical-align: inherit;"></font><code>$00D2</code><font style="vertical-align: inherit;"></font><code>$872D</code><font style="vertical-align: inherit;"></font><br><br> <code>9DE8: LDA $00D1 <br> 9DEA: CLC ; increment [$00D1] <br> 9DEB: ADC #$01 ; possibly causing wrap around to 0 <br> 9DED: STA $00D1 ; which produces a carry <br> <br> 9DEF: LDA #$00 <br> 9DF1: ADC $00D2 <br> 9DF3: STA $00D2 ; add carry to [$00D2] <br> <br> 9DF5: RTS ; return</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00D0</code><font style="vertical-align: inherit;"></font><code>$FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En este caso, se inicia el siguiente c√≥digo, destinado a escribir en la tabla de botones para la demostraci√≥n. </font><font style="vertical-align: inherit;">Sin embargo, la tabla se almacena en el PRG-ROM. </font><font style="vertical-align: inherit;">Intentar escribir en √©l no afectar√° los datos guardados. </font><font style="vertical-align: inherit;">En cambio, cada operaci√≥n de escritura activa un cambio de banco, lo que resulta en el efecto de falla que se muestra a continuaci√≥n.</font></font><br><br> <code>recording: <br> <br> 9DB0: JSR $AB9D ; pollController(); <br> <br> 9DB3: LDA $00C0 ; if (gameMode != DEMO) { <br> 9DB5: CMP #$05 ; return; <br> 9DB7: BNE $9DE7 ; } <br> <br> 9DB9: LDA $00D0 ; if (not recording mode) { <br> 9DBB: CMP #$FF ; return; <br> 9DBD: BNE $9DE7 ; } <br> <br> 9DBF: LDA $00F7 ; if (getHeldButtons() == heldButtons) { <br> 9DC1: CMP $00CE ; goto buttonsNotChanged; <br> 9DC3: BEQ $9DE4 ; } <br> <br> 9DC5: LDX #$00 <br> 9DC7: LDA $00CE <br> 9DC9: STA ($D1,X) ; demoButtonsTable[index] = heldButtons; <br> <br> 9DCB: JSR $9DE8 ; index++; <br> <br> 9DCE: LDA $00CF <br> 9DD0: STA ($D1,X) ; demoButtonsTable[index] = repeats; <br> <br> 9DD2: JSR $9DE8 ; index++; <br> <br> 9DD5: LDA $00D2 ; if (reached end of demo table) { <br> 9DD7: CMP #$DF ; return; <br> 9DD9: BEQ $9DE7 ; } <br> <br> 9DDB: LDA $00F7 <br> 9DDD: STA $00CE ; heldButtons = getHeldButtons(); <br> <br> 9DDF: LDA #$00 <br> 9DE1: STA $00CF ; repeats = 0; <br> <br> 9DE3: RTS ; return; <br> <br> buttonsNotChanged: <br> <br> 9DE4: INC $00CF ; repeats++; <br> <br> 9DE6: RTS <br> 9DE7: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a07/66a/261/a0766a261967e1ee2e7d4a61d3367ee6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto sugiere que los desarrolladores podr√≠an ejecutar el programa parcial o totalmente en RAM. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para sortear este obst√°culo, cre√© </font></font><code>lua/RecordDemo.lua</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uno ubicado en un </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zip con c√≥digo fuente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Despu√©s de cambiar al modo de grabaci√≥n de demostraci√≥n, redirige las operaciones de escritura a la tabla en la consola Lua. </font><font style="vertical-align: inherit;">A partir de √©l, los bytes se pueden copiar y pegar en la ROM.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para grabar su propia demostraci√≥n, ejecute FCEUX y descargue el archivo ROM de Nintendo Tetris (Archivo | Abrir ROM ...). Luego abra la ventana Lua Script (Archivo | Lua | Nueva ventana Lua Script ...), busque el archivo o ingrese la ruta. Presione el bot√≥n Ejecutar para iniciar el modo de grabaci√≥n de demostraci√≥n y luego haga clic en la ventana FCEUX para cambiar el enfoque. Puede controlar las formas hasta que la tabla de botones est√© llena. Despu√©s de eso, el juego volver√° autom√°ticamente al protector de pantalla. Haga clic en Detener en la ventana Lua Script para detener el script. Los datos grabados aparecer√°n en la Consola de salida, como se muestra en la figura a continuaci√≥n.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f2e/3cd/f61/f2e3cdf61589005f2e1cae0659f66467.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seleccione todos los contenidos y c√≥pielos en el portapapeles (Ctrl + C). </font><font style="vertical-align: inherit;">Luego ejecute el Editor Hex (Depuraci√≥n | Editor Hex ...). </font><font style="vertical-align: inherit;">En el men√∫ Editor hexadecimal, seleccione Ver | </font><font style="vertical-align: inherit;">Archivo ROM y luego Archivo | </font><font style="vertical-align: inherit;">Ir a la direcci√≥n. </font><font style="vertical-align: inherit;">En el cuadro de di√°logo Ir a, ingrese 5D10 (direcci√≥n de la tabla de botones de demostraci√≥n en el archivo ROM) y haga clic en Aceptar. </font><font style="vertical-align: inherit;">Luego pegue el contenido del portapapeles (Ctrl + V).</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bef/599/392/bef599392455c773652e850de13f6413.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, en el men√∫ FCEUX, seleccione NES | </font><font style="vertical-align: inherit;">Restablecer </font><font style="vertical-align: inherit;">Si logr√≥ repetir todos estos pasos, la demostraci√≥n debe ser reemplazada por su propia versi√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si desea guardar los cambios, seleccione Archivo | </font><font style="vertical-align: inherit;">Guardar Rom como ... e ingrese el nombre del archivo ROM modificado, y luego haga clic en Guardar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De manera similar, puede ajustar la secuencia de tetriminos creados.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pantalla de la muerte </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como se mencion√≥ anteriormente, la mayor√≠a de los jugadores no pueden hacer frente a la velocidad del descenso de figuras en el nivel 29, lo que r√°pidamente lleva a la finalizaci√≥n del juego. Por lo tanto, los jugadores se asociaron con el nombre de "pantalla de la muerte". Pero desde un punto de vista t√©cnico, la pantalla de muerte no permite que el jugador vaya m√°s all√° debido a un error en el que un descenso r√°pido en realidad no es un error, sino una caracter√≠stica. Los dise√±adores fueron tan amables que permitieron que el juego continuara mientras el jugador pod√≠a soportar la velocidad sobrehumana. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aparece una verdadera pantalla de muerte en aproximadamente 1550 filas retra√≠das. Se manifiesta de diferentes maneras. A veces el juego se reinicia. En otros casos, la pantalla se vuelve negra. Por lo general, un juego se congela ("congela") inmediatamente despu√©s de eliminar una fila, como se muestra a continuaci√≥n. Dichos efectos suelen ir precedidos de artefactos gr√°ficos aleatorios.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09d/7fe/4f3/09d7fe4f3ec1e77057c7ee5e252d8d75.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La pantalla de muerte es el resultado de un error en el c√≥digo que agrega puntos al eliminar filas. La cuenta de seis caracteres se almacena como un peque√±o BCD endian empaquetado de 24 bits y se encuentra en </font></font><code>$0053</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$0055</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Para realizar conversiones entre el n√∫mero de filas despejadas y los puntos obtenidos, se utiliza una tabla; cada entrada es un peque√±o valor endian BCD empaquetado de 16 bits. </font><font style="vertical-align: inherit;">Despu√©s de incrementar el n√∫mero total de filas, y posiblemente el nivel, el valor en esta lista se multiplica por el n√∫mero de nivel m√°s uno, y el resultado se agrega a los puntos. Esto se demuestra claramente en la tabla del manual de Nintendo Tetris:</font></font><br><br> <code>9CA5: 00 00 ; 0: 0 <br> 9CA7: 40 00 ; 1: 40 <br> 9CA9: 00 01 ; 2: 100 <br> 9CAB: 00 03 ; 3: 300 <br> 9CAD: 00 12 ; 4: 1200</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34b/a36/7cf/34ba367cfefad47e493306fa6ef8fe3e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como se muestra a continuaci√≥n, la multiplicaci√≥n se simula mediante un ciclo que agrega puntos a la puntuaci√≥n. Se ejecuta despu√©s de bloquear la forma, incluso si no se borran las filas. </font><font style="vertical-align: inherit;">Desafortunadamente, el </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Ricoh 2A03</font></a><font style="vertical-align: inherit;"> no tiene un modo decimal binario 6502; √©l podr√≠a simplificar enormemente el cuerpo del ciclo. En cambio, la adici√≥n se realiza en pasos usando el modo binario. Cualquier d√≠gito que exceda 9 despu√©s de la suma se obtiene esencialmente restando 10 e incrementando los d√≠gitos de la izquierda. Por ejemplo, </font><font style="vertical-align: inherit;">eso se convierte a </font><font style="vertical-align: inherit;">. Pero tal esquema no est√° completamente protegido. Tomar </font><font style="vertical-align: inherit;">: un cheque no puede convertir el resultado a</font></font><br><br> <code>9C31: LDA $0044 <br> 9C33: STA $00A8 <br> 9C35: INC $00A8 ; for(i = 0; i &lt;= level; i++) { <br> <br> 9C37: LDA $0056 <br> 9C39: ASL <br> 9C3A: TAX <br> 9C3B: LDA $9CA5,X ; points[0] = pointsTable[2 * completedLines]; <br> <br> 9C3E: CLC <br> 9C3F: ADC $0053 <br> 9C41: STA $0053 ; score[0] += points[0]; <br> <br> 9C43: CMP #$A0 <br> 9C45: BCC $9C4E ; if (upper digit of score[0] &gt; 9) { <br> <br> 9C47: CLC <br> 9C48: ADC #$60 <br> 9C4A: STA $0053 ; upper digit of score[0] -= 10; <br> 9C4C: INC $0054 ; score[1]++; <br> ; } <br> <br> 9C4E: INX <br> 9C4F: LDA $9CA5,X ; points[1] = pointsTable[2 * completedLines + 1]; <br> <br> 9C52: CLC <br> 9C53: ADC $0054 <br> 9C55: STA $0054 ; score[1] += points[1]; <br> <br> 9C57: AND #$0F <br> 9C59: CMP #$0A <br> 9C5B: BCC $9C64 ; if (lower digit of score[1] &gt; 9) { <br> <br> 9C5D: LDA $0054 <br> 9C5F: CLC ; lower digit of score[1] -= 10; <br> 9C60: ADC #$06 ; increment upper digit of score[1]; <br> 9C62: STA $0054 ; } <br> <br> 9C64: LDA $0054 <br> 9C66: AND #$F0 <br> 9C68: CMP #$A0 <br> 9C6A: BCC $9C75 ; if (upper digit of score[1] &gt; 9) { <br> <br> 9C6C: LDA $0054 <br> 9C6E: CLC <br> 9C6F: ADC #$60 <br> 9C71: STA $0054 ; upper digit of score[1] -= 10; <br> 9C73: INC $0055 ; score[2]++; <br> ; } <br> <br> 9C75: LDA $0055 <br> 9C77: AND #$0F <br> 9C79: CMP #$0A <br> 9C7B: BCC $9C84 ; if (lower digit of score[2] &gt; 9) { <br> <br> 9C7D: LDA $0055 <br> 9C7F: CLC ; lower digit of score[2] -= 10; <br> 9C80: ADC #$06 ; increment upper digit of score[2]; <br> 9C82: STA $0055 ; } <br> <br> 9C84: LDA $0055 <br> 9C86: AND #$F0 <br> 9C88: CMP #$A0 <br> 9C8A: BCC $9C94 ; if (upper digit of score[2] &gt; 9) { <br> <br> 9C8C: LDA #$99 <br> 9C8E: STA $0053 <br> 9C90: STA $0054 <br> 9C92: STA $0055 ; max out score to 999999; <br> ; } <br> <br> 9C94: DEC $00A8 <br> 9C96: BNE $9C37 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>$07 + $07 = $0E</code><font style="vertical-align: inherit;"></font><code>$14</code><font style="vertical-align: inherit;"></font><code>$09 + $09 = $12</code><font style="vertical-align: inherit;"></font><code>$18</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para compensar esto, ninguno de los d√≠gitos decimales en las entradas en el cuadro de mando supera 6. Adem√°s, para poder usarlo, el √∫ltimo d√≠gito de todas las entradas es siempre 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se necesita tiempo para completar este ciclo largo y complicado. </font><font style="vertical-align: inherit;">A niveles altos, una gran cantidad de iteraciones afecta el momento del juego, ya que lleva m√°s de 1/60 de segundo generar cada cuadro. </font><font style="vertical-align: inherit;">Todo esto como resultado conduce a diversas manifestaciones de la "pantalla de la muerte". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El script Lua AI limita el n√∫mero de iteraciones en un bucle a 30, el valor m√°ximo que los dise√±adores podr√≠an lograr seg√∫n lo dise√±ado por los dise√±adores, lo que elimina la pantalla de la muerte.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finales </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En el folleto de Nintendo Tetris, el juego tipo A se describe de la siguiente manera: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c53/f16/5ea/c53f165ea675badb06f75f6409f6c836.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El juego recompensa a los jugadores que obtuvieron un n√∫mero suficientemente grande de puntos en una de las cinco animaciones de los finales. La elecci√≥n del final se basa completamente en los dos d√≠gitos m√°s a la izquierda de la puntuaci√≥n de seis d√≠gitos. Como se muestra a continuaci√≥n, para obtener uno de los finales, el jugador debe anotar al menos 30,000 puntos. </font><font style="vertical-align: inherit;">Vale la pena se√±alar que </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">es un espejo de direcciones </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. La cuenta est√° duplicada en las direcciones </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Despu√©s de pasar la primera prueba, la siguiente animaci√≥n de cambio selecciona la animaci√≥n final.</font></font><br><br> <code>9A4D: LDA $0075 <br> 9A4F: CMP #$03 <br> 9A51: BCC $9A5E ; if (score[2] &gt;= $03) { <br> <br> 9A53: LDA #$80 <br> 9A55: JSR $A459 <br> 9A58: JSR $9E3A <br> 9A5B: JMP $9A64 ; select ending; <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0060</code><font style="vertical-align: inherit;"></font><code>$007F</code><font style="vertical-align: inherit;"></font><code>$0040</code><font style="vertical-align: inherit;"></font><code>$005F</code><font style="vertical-align: inherit;"></font><code>$0073</code><font style="vertical-align: inherit;"></font><code>$0075</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>A96E: LDA #$00 <br> A970: STA $00C4 <br> A972: LDA $0075 ; if (score[2] &lt; $05) { <br> A974: CMP #$05 ; ending = 0; <br> A976: BCC $A9A5 ; } <br> <br> A978: LDA #$01 <br> A97A: STA $00C4 <br> A97C: LDA $0075 ; else if (score[2] &lt; $07) { <br> A97E: CMP #$07 ; ending = 1; <br> A980: BCC $A9A5 ; } <br> <br> A982: LDA #$02 <br> A984: STA $00C4 <br> A986: LDA $0075 ; else if (score[2] &lt; $10) { <br> A988: CMP #$10 ; ending = 2; <br> A98A: BCC $A9A5 ; } <br> <br> A98C: LDA #$03 <br> A98E: STA $00C4 <br> A990: LDA $0075 ; else if (score[2] &lt; $12) { <br> A992: CMP #$12 ; ending = 3; <br> A994: BCC $A9A5 ; } <br> <br> A996: LDA #$04 ; else { <br> A998: STA $00C4 ; ending = 4; <br> ; }</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al final, se lanzan cohetes de tama√±o creciente desde la plataforma de lanzamiento junto a la Catedral de San Basilio. </font><font style="vertical-align: inherit;">En el cuarto final, se muestra la nave espacial Buran, la versi√≥n sovi√©tica del transbordador espacial estadounidense. </font><font style="vertical-align: inherit;">En el mejor final, la catedral se eleva en el aire, y un ovni cuelga sobre la plataforma de lanzamiento. </font><font style="vertical-align: inherit;">A continuaci√≥n se muestra una imagen de cada final y el puntaje asociado.</font></font><br><div class="scrollable-table"><table><tbody><tr><td> <code>30000‚Äì49999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/0b9/b73/4b4/0b9b734b43dae52eccafaa71e3c1441d.png"></div></td><td> <code>50000‚Äì69999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/ade/f93/f39/adef93f395eb2bef2c1fd71562857c39.png"></div></td><td> <code>70000‚Äì99999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/df3/480/b63/df3480b63de128a70b7c9e4dd7cec81f.png"></div></td></tr><tr><td> <code>100000‚Äì119999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/8e3/91a/658/8e391a6581df6e7ec0c08134b6a6d5bf.png"></div></td><td> <code>120000+</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/3e1/2bd/42f/3e12bd42ffc331742d809325db418f78.png"></div></td><td></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En el modo de juego B-Type, se implementa otra prueba, que se describe en el folleto de Nintendo Tetris de la siguiente manera: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0aa/929/624/0aa929624f41a68ea1388b6ba9013dd3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el jugador borra con √©xito 25 filas, el juego muestra el final, seg√∫n el nivel inicial. Los finales para los niveles 0‚Äì8 consisten en animales y objetos que vuelan o corren en el cuadro, pasando misteriosamente detr√°s de la Catedral de San Basilio. El OVNI del mejor final del modo tipo A aparece en el final 3. En el final 4, aparecen pterosaurios voladores extintos, y en el final 7 se muestran los m√≠ticos dragones voladores. En las terminaciones 2 y 6, se muestran aves sin alas: ping√ºinos corriendo y avestruces. Al final de 5, el cielo se llena de BUENAS aeronaves (que no debe confundirse con las aeronaves Goodyear). Y al final de 8, muchos "Buranas" barren la pantalla, aunque en realidad solo hab√≠a uno. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La altura inicial (m√°s 1) se utiliza como multiplicador, recompensando al jugador con una gran cantidad de animales / objetos por su mayor complejidad.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el mejor final del tipo B, se muestra un castillo lleno de personajes del universo de Nintendo: la princesa Peach aplaude, Kid Icarus toca el viol√≠n, Donkey Kong toca el gran tambor, Mario y Luigi bailan, Bowser toca el acorde√≥n, Samus toca el violonchelo, Link - en una flauta, mientras las c√∫pulas de la Catedral de San Basilio se elevan en el aire. La cantidad de estos elementos que se muestran en el final depende de la altura inicial. A continuaci√≥n se muestran im√°genes de las 10 terminaciones.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d9/c8e/525/5d9c8e525177613cb3fcd59c7c6aa53a.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ade/2fc/f3d/ade2fcf3d389b67e5d4b3d7e8c5c1ea0.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ec9/bd3/9dd/ec9bd39dd26529013d7d408f6a4e855b.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fdb/125/132/fdb125132ecaed550966562b5e08f169.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/22b/758/028/22b75802841a3b558f8fae476f2d2598.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43e/710/858/43e710858220b08e1860da00a309c665.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dda/332/1d5/dda3321d5e5246d2aa92eafb69f3cf5d.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6f/2d0/843/c6f2d0843995d294393bbbf277b83bdf.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/572/3b8/f29/5723b8f2919ac35746b52923d59dbf41.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/639/938/9df/6399389dfff187a8db7ac92f1dc815e3.png"></div></td><td></td><td></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AI puede borrar r√°pidamente las 25 filas requeridas en el modo Tipo B en cualquier nivel y altura iniciales, lo que le permite ver cualquiera de las terminaciones. Tambi√©n vale la pena evaluar qu√© tan genial maneja grandes montones de bloques al azar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En las terminaciones 0‚Äì8, se pueden mover hasta 6 objetos en el cuadro. Las coordenadas y de los objetos se almacenan en una tabla ubicada en at </font></font><code>$A7B7</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Las distancias horizontales entre los objetos se almacenan en una tabla en la direcci√≥n </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Una secuencia de valores con un signo en la direcci√≥n </font><font style="vertical-align: inherit;">determina la velocidad y la direcci√≥n de los objetos. </font><font style="vertical-align: inherit;">Los √≠ndices de sprites se almacenan en </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">De hecho, cada objeto consta de dos sprites con √≠ndices adyacentes. Para obtener el segundo √≠ndice, debe agregar 1. Por ejemplo, un drag√≥n consta de</font></font><br><br> <code>A7B7: 98 A8 C0 A8 90 B0 ; 0 <br> A7BD: B0 B8 A0 B8 A8 A0 ; 1 <br> A7C3: C8 C8 C8 C8 C8 C8 ; 2 <br> A7C9: 30 20 40 28 A0 80 ; 3 <br> A7CF: A8 88 68 A8 48 78 ; 4 <br> A7D5: 58 68 18 48 78 38 ; 5 <br> A7DB: C8 C8 C8 C8 C8 C8 ; 6 <br> A7E1: 90 58 70 A8 40 38 ; 7 <br> A7E7: 68 88 78 18 48 A8 ; 8</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A77B</code><font style="vertical-align: inherit;"></font><br><br> <code>A77B: 3A 24 0A 4A 3A FF ; 0 <br> A781: 22 44 12 32 4A FF ; 1 <br> A787: AE 6E 8E 6E 1E 02 ; 2 <br> A78D: 42 42 42 42 42 02 ; 3 <br> A793: 22 0A 1A 04 0A FF ; 4 <br> A799: EE DE FC FC F6 02 ; 5 <br> A79F: 80 80 80 80 80 FF ; 6 <br> A7A5: E8 E8 E8 E8 48 FF ; 7 <br> A7AB: 80 AE 9E 90 80 02 ; 8</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A771</code><font style="vertical-align: inherit;"></font><br><br> <code>A771: 01 ; 0: 1 <br> A772: 01 ; 1: 1 <br> A773: FF ; 2: -1 <br> A774: FC ; 3: -4 <br> A775: 01 ; 4: 1 <br> A776: FF ; 5: -1 <br> A777: 02 ; 6: 2 <br> A778: 02 ; 7: 2 <br> A779: FE ; 8: -1</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A7F3</code><font style="vertical-align: inherit;"></font><br><br> <code>A7F3: 2C ; 0: dragonfly <br> A7F4: 2E ; 1: dove <br> A7F5: 54 ; 2: penguin <br> A7F6: 32 ; 3: UFO <br> A7F7: 34 ; 4: pterosaur <br> A7F8: 36 ; 5: blimp <br> A7F9: 4B ; 6: ostrich <br> A7FA: 38 ; 7: dragon <br> A7FB: 3A ; 8: Buran</code> <br> <br><font style="vertical-align: inherit;"></font><code>$38</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>$39</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Los mosaicos para estos sprites est√°n contenidos en las tablas de patrones a continuaci√≥n.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/524/373/86d5243738d9c3e34db5318889c4f894.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d82/2d1/229/d822d122984b77a0973f08feac962647.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d8a/3c1/9b5/d8a3c19b513fb9f7338e250b97fdeac1.png"></div></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examinamos la tabla central del patr√≥n de arriba, se usa para mostrar el tetrimino y el campo de juego. </font><font style="vertical-align: inherit;">Curiosamente, contiene el alfabeto completo, mientras que otros contienen solo una parte para ahorrar espacio. </font><font style="vertical-align: inherit;">Pero a√∫n m√°s interesantes son los sprites de aviones y helic√≥pteros en la tabla de patrones a la izquierda; </font><font style="vertical-align: inherit;">no aparecen en los finales ni en otras partes del juego. </font><font style="vertical-align: inherit;">Result√≥ que el avi√≥n y el helic√≥ptero tienen √≠ndices de sprites </font></font><code>$30</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>$16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y se puede cambiar la tabla mostrada anteriormente, para verlos en acci√≥n.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/04e/2e2/203/04e2e2203b1581876d99736ad9b56fd6.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/445/153/3b4/4451533b43874485cb5a0cdfd9df0c58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Desafortunadamente, las monturas de helic√≥pteros no se muestran, pero los rotores principal y de cola est√°n bellamente animados. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2 jugadores contra </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nintendo Tetris contiene un modo incompleto para dos jugadores que puedes habilitar cambiando la cantidad de jugadores ( </font></font><code>$00BE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) a 2. Como se muestra a continuaci√≥n, aparecen dos campos de juego en el fondo del modo para un jugador.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/418/6e7/2af/4186e72af40c6c617996ca2f8d39a72c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No hay borde entre los campos porque la regi√≥n central del fondo es negro s√≥lido. Los valores que se </font></font><code>003</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muestran arriba de los campos de juego indican el n√∫mero de filas despejadas por cada jugador. La √∫nica figura com√∫n para dos jugadores aparece en el mismo lugar que en el modo para un jugador. Desafortunadamente, se encuentra en el campo de juego correcto. Los cuadrados y otros mosaicos est√°n coloreados incorrectamente. Y cuando el jugador pierde el juego se reinicia. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero si ignora estos problemas, entonces el modo es bastante jugable. Cada jugador puede controlar independientemente las piezas en el campo de juego correspondiente. Y cuando un jugador escribe Doble, Triple o Tetris (es decir, borra dos, tres o cuatro filas), aparecen filas de basura con un cuadrado faltante en la parte inferior del campo de juego del oponente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un campo adicional se encuentra en </font></font><code>$0500</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A </font></font><code>$0060</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$007F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espejo que normalmente forman </font></font><code>$0040</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$005F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se utiliza para el segundo jugador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablemente, este modo interesante fue abandonado debido a un programa de desarrollo ocupado. O tal vez lo dejaron sin terminar intencionalmente. Una de las razones por las que se eligi√≥ a Tetris como el juego incluido con Nintendo Game Boy fue porque alent√≥ la compra de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Game Link Cable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- un accesorio que conecta a dos Game Boys para lanzar 2 jugadores contra el modo. </font><font style="vertical-align: inherit;">Este cable agreg√≥ un elemento de "socialidad" al sistema: alent√≥ a los amigos a comprar un Game Boy para unirse a la diversi√≥n. </font><font style="vertical-align: inherit;">Quiz√°s Nintendo tem√≠a que si la versi√≥n de consola del juego tuviera 2 jugadores versus modo, entonces el poder "publicitario" de Tetris, que estimul√≥ la compra de Game Boy, podr√≠a debilitarse.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Musica y efectos de sonido </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La m√∫sica de fondo se activa cuando </font></font><code>$06F5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se asigna uno de los valores enumerados en la tabla.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Valor </th><th>  Descripci√≥n </th></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica de pantalla de bienvenida no utilizada </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Objetivo de modo B-Type alcanzado </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-1 </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-2 </font></font></td></tr><tr><td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-3 </font></font></td></tr><tr><td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-1 allegro </font></font></td></tr><tr><td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-2 allegro </font></font></td></tr><tr><td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-3 allegro </font></font></td></tr><tr><td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pantalla de felicitaciones </font></font></td></tr><tr><td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finales </font></font></td></tr><tr><td> <code>0B</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Objetivo de modo B-Type alcanzado </font></font></td></tr></tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede escuchar m√∫sica no utilizada desde el protector de pantalla </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En el juego en s√≠, no suena nada durante la pantalla del protector de pantalla. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Music-1 es una versi√≥n de " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dance of the Dragee Fairy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", m√∫sica para la bailarina del tercer acto del </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas de deux</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> waltz </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"El cascanueces" de</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tchaikovsky. La m√∫sica final es una variaci√≥n de los " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versos del torero</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", un aria de la √≥pera </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carmen</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Georges Bizet. Estas composiciones son arregladas por el compositor del resto de la m√∫sica de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hirokazu Tanaka</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Music-2 se inspir√≥ en las canciones tradicionales rusas del folklore. Music-3 es misterioso, futurista y tierno; Durante un tiempo, fue el tono de llamada de atenci√≥n al cliente de Nintendo of America.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para ayudar al jugador a caer en un estado de p√°nico cuando la altura del mont√≥n se acerca al techo del campo de juego, una versi√≥n de m√∫sica de fondo comienza a reproducirse a un ritmo r√°pido ( </font></font><code>$06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curiosamente, entre las composiciones musicales no hay " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapman</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", un tema famoso que suena en Game Boy Tetris. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los efectos de sonido se activan al grabar </font></font><code>$06F0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>$06F1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de acuerdo con la siguiente tabla.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  La direccion </th><th>  Valor </th><th>  Descripci√≥n </th></tr><tr><td> <code>06F0</code> </td> <td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El tel√≥n del final del juego. </font></font></td></tr><tr><td> <code>06F0</code> </td> <td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cohete al final </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Selecci√≥n de opciones de men√∫ </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Selecci√≥n de pantalla de men√∫ </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino Shift </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetris recibido </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rotaci√≥n Tetrimino </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nuevo nivel </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cerradura Tetrimino </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Piar </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Limpieza de la fila </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fila llena </font></font></td></tr></tbody></table></div><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estados de juego y modos de renderizado </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durante el juego, el estado actual del juego est√° representado por un n√∫mero entero en la direcci√≥n </font></font><code>$0048</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">La mayor√≠a de las veces tiene un significado </font></font><code>$01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que indica que el jugador controla el tetrimino activo. </font><font style="vertical-align: inherit;">Sin embargo, cuando la pieza est√° bloqueada en su lugar, el juego pasa gradualmente de un estado </font></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a otro </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, como se muestra en la tabla.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Condici√≥n </th><th>  Descripci√≥n </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ID de orientaci√≥n no asignada </font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El jugador controla el tetrimino activo </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino lock en el campo de juego </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comprobaci√≥n de filas llenas </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mostrar animaci√≥n de limpieza de fila </font></font></td></tr><tr><td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Actualizaci√≥n de filas y estad√≠sticas </font></font></td></tr><tr><td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comprobaci√≥n del objetivo del modo B-Type </font></font></td></tr><tr><td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No utilizado </font></font></td></tr><tr><td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crear siguiente Tetrimino </font></font></td></tr><tr><td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No utilizado </font></font></td></tr><tr><td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Actualizaci√≥n de la cortina del juego </font></font></td></tr><tr><td> <code>0B</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Incremento de estado de juego </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La ramificaci√≥n del c√≥digo, seg√∫n el estado del juego, se produce en la siguiente direcci√≥n </font></font><code>$81B2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">en el estado de </font><font style="vertical-align: inherit;">cambio, salta al c√≥digo que asigna un </font><font style="vertical-align: inherit;">valor </font><font style="vertical-align: inherit;">que indica que la orientaci√≥n no est√° especificada. </font><font style="vertical-align: inherit;">El manejador nunca se llama; sin embargo, el estado del juego </font><font style="vertical-align: inherit;">sirve como se√±al para otras partes del c√≥digo. </font><font style="vertical-align: inherit;">El estado </font><font style="vertical-align: inherit;">permite al jugador cambiar, rotar y bajar el tetrimino activo: </font><font style="vertical-align: inherit;">como se indic√≥ en las secciones anteriores, las rutinas de cambio, rotaci√≥n y descenso de la figura antes de ejecutar el c√≥digo verifican las nuevas posiciones del tetrimino. La √∫nica forma de bloquear una forma en la posici√≥n incorrecta es crearla encima de una forma existente. En este caso, el juego termina. Como se muestra a continuaci√≥n, el c√≥digo de estado realiza esta verificaci√≥n.</font></font><br><br> <code>81B2: LDA $0048 <br> 81B4: JSR $AC82 ; switch(playState) { <br> 81B7: 2F 9E ; case 00: goto 9E2F; // Unassign orientationID <br> 81B9: CF 81 ; case 01: goto 81CF; // Player controls active Tetrimino <br> 81BB: A2 99 ; case 02: goto 99A2; // Lock Tetrimino into playfield <br> 81BD: 6B 9A ; case 03: goto 9A6B; // Check for completed rows <br> 81BF: 39 9E ; case 04: goto 9E39; // Display line clearing animation <br> 81C1: 58 9B ; case 05: goto 9B58; // Update lines and statistics <br> 81C3: F2 A3 ; case 06: goto A3F2; // B-Type goal check; Unused frame for A-Type <br> 81C5: 03 9B ; case 07: goto 9B03; // Unused frame; Execute unfinished 2 player mode logic <br> 81C7: 8E 98 ; case 08: goto 988E; // Spawn next Tetrimino <br> 81C9: 39 9E ; case 09: goto 9E39; // Unused <br> 81CB: 11 9A ; case 0A: goto 9A11; // Update game over curtain <br> 81CD: 37 9E ; case 0B: goto 9E37; // Increment play state <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><code>orientationID</code><font style="vertical-align: inherit;"></font><code>$13</code><font style="vertical-align: inherit;"></font><br><br> <code>9E2F: LDA #$13 <br> 9E31: STA $0042 ; orientationID = UNASSIGNED; <br> <br> 9E33: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$01</code><font style="vertical-align: inherit;"></font><br><br> <code>81CF: JSR $89AE ; shift Tetrimino; <br> 81D2: JSR $88AB ; rotate Tetrimino; <br> 81D5: JSR $8914 ; drop Tetrimino; <br> <br> 81D8: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si la posici√≥n bloqueada es correcta, marca las 4 celdas asociadas del campo de juego como ocupadas. De lo contrario, ella hace la transici√≥n a un estado </font><font style="vertical-align: inherit;">: la ominosa cortina del final del juego.</font></font><br><br> <code>99A2: JSR $948B ; if (new position valid) { <br> 99A5: BEQ $99B8 ; goto updatePlayfield; <br> ; } <br> <br> 99A7: LDA #$02 <br> 99A9: STA $06F0 ; play curtain sound effect; <br> <br> 99AC: LDA #$0A <br> 99AE: STA $0048 ; playState = UPDATE_GAME_OVER_CURTAIN; <br> <br> 99B0: LDA #$F0 <br> 99B2: STA $0058 ; curtainRow = -16; <br> <br> 99B4: JSR $E003 ; updateAudio(); <br> <br> 99B7: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0A</code><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b1b/7c0/a46/b1b7c0a4637995c25423a07984bce24e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La cortina se dibuja desde la parte superior del campo de juego hacia abajo, descendiendo una l√≠nea cada 4 cuadros. </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0058</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) se inicializa con un valor de ‚àí16, creando un retraso adicional de 0.27 segundos entre el bloqueo final y el inicio de la animaci√≥n. En la direcci√≥n </font></font><code>$9A21</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el estado del </font></font><code>$0A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo que se muestra a continuaci√≥n, se accede a la tabla de multiplicaci√≥n, que se muestra err√≥neamente como n√∫meros de nivel. Esto se hace para escalar </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en 10. Adem√°s, como se muestra arriba, el c√≥digo en la direcci√≥n </font></font><code>$9A51</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comienza la animaci√≥n final si la puntuaci√≥n del jugador no es inferior a 30,000 puntos; de lo contrario, espera hacer clic en Inicio. </font><font style="vertical-align: inherit;">El c√≥digo se completa asignando un valor al estado del juego </font><font style="vertical-align: inherit;">, pero no se llama al controlador correspondiente porque el juego se ha completado.</font></font><br><br> <code>9A11: LDA $0058 ; if (curtainRow == 20) { <br> 9A13: CMP #$14 ; goto endGame; <br> 9A15: BEQ $9A47 ; } <br> <br> 9A17: LDA $00B1 ; if (frameCounter not divisible by 4) { <br> 9A19: AND #$03 ; return; <br> 9A1B: BNE $9A46 ; } <br> <br> 9A1D: LDX $0058 ; if (curtainRow &lt; 0) { <br> 9A1F: BMI $9A3E ; goto incrementCurtainRow; <br> ; } <br> <br> 9A21: LDA $96D6,X <br> 9A24: TAY ; rowIndex = 10 * curtainRow; <br> <br> 9A25: LDA #$00 <br> 9A27: STA $00AA ; i = 0; <br> <br> 9A29: LDA #$13 <br> 9A2B: STA $0042 ; orientationID = NONE; <br> <br> drawCurtainRow: <br> <br> 9A2D: LDA #$4F <br> 9A2F: STA ($B8),Y ; playfield[rowIndex + i] = CURTAIN_TILE; <br> 9A31: INY <br> 9A32: INC $00AA ; i++; <br> 9A34: LDA $00AA <br> 9A36: CMP #$0A ; if (i != 10) { <br> 9A38: BNE $9A2D ; goto drawCurtainRow; <br> ; } <br> <br> 9A3A: LDA $0058 <br> 9A3C: STA $0049 ; vramRow = curtainRow; <br> <br> incrementCurtainRow: <br> <br> 9A3E: INC $0058 ; curtainRow++; <br> <br> 9A40: LDA $0058 ; if (curtainRow != 20) { <br> 9A42: CMP #$14 ; return; <br> 9A44: BNE $9A46 ; } <br> <br> 9A46: RTS ; return; <br> <br> endGame: <br> <br> 9A47: LDA $00BE <br> 9A49: CMP #$02 <br> 9A4B: BEQ $9A64 ; if (numberOfPlayers == 1) { <br> <br> 9A4D: LDA $0075 <br> 9A4F: CMP #$03 <br> 9A51: BCC $9A5E ; if (score[2] &gt;= $03) { <br> <br> 9A53: LDA #$80 <br> 9A55: JSR $A459 <br> 9A58: JSR $9E3A <br> 9A5B: JMP $9A64 ; select ending; <br> ; } <br> <br> 9A5E: LDA $00F5 ; if (not just pressed Start) { <br> 9A60: CMP #$10 ; return; <br> 9A62: BNE $9A6A ; } <br> ; } <br> <br> 9A64: LDA #$00 <br> 9A66: STA $0048 ; playState = INITIALIZE_ORIENTATION_ID; <br> 9A68: STA $00F5 ; clear newly pressed buttons; <br> <br> 9A6A: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las l√≠neas del campo de juego se copian de forma incremental en VRAM para mostrarlas. </font><font style="vertical-align: inherit;">El √≠ndice de la fila actual a copiar est√° contenido en </font></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0049</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Se </font></font><code>$9A3C</code> <code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asigna </font><font style="vertical-align: inherit;">un </font><font style="vertical-align: inherit;">valor </font><font style="vertical-align: inherit;">en la direcci√≥n </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, lo que finalmente hace que esta l√≠nea sea visible cuando se procesa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las manipulaciones con VRAM se producen durante un intervalo de supresi√≥n vertical, que es reconocido por el controlador de interrupciones descrito en la secci√≥n "Pantalla de informaci√≥n legal". </font><font style="vertical-align: inherit;">Llama a la subrutina que se muestra a continuaci√≥n (marcada en los comentarios del controlador de interrupciones como </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">El modo de renderizado es similar al modo de juego. </font><font style="vertical-align: inherit;">Se almacena en la direcci√≥n </font><font style="vertical-align: inherit;">y puede tener uno de los siguientes valores:</font></font><br><br> <code>804B: LDA $00BD <br> 804D: JSR $AC82 ; switch(renderMode) { <br> 8050: B1 82 ; case 0: goto 82B1; // Legal and title screens <br> 8052: DA 85 ; case 1: goto 85DA; // Menu screens <br> 8054: 44 A3 ; case 2: goto A344; // Congratulations screen <br> 8056: EE 94 ; case 3: goto 94EE; // Play and demo <br> 8058: 95 9F ; case 4: goto 9F95; // Ending animation <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00BD</code><font style="vertical-align: inherit;"></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Valor </th><th>  Descripci√≥n </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pantalla con legal </font><font style="vertical-align: inherit;">informaci√≥n y protector de pantalla</font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pantallas de men√∫ </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pantalla de felicitaciones </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Juego y demo </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finalizando la animaci√≥n </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte del modo de representaci√≥n se </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muestra a continuaci√≥n. </font><font style="vertical-align: inherit;">Como puede ver a continuaci√≥n, </font><font style="vertical-align: inherit;">pasa en VRAM una l√≠nea del campo de juego con un √≠ndice </font><font style="vertical-align: inherit;">. Si es </font><font style="vertical-align: inherit;">mayor que 20, la rutina no hace nada. </font><font style="vertical-align: inherit;">La tabla </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) contiene las direcciones VRAM en formato little endian, correspondientes a las l√≠neas mostradas del campo de juego, desplazadas por 6 en modo normal y por ‚àí2 y 12 para el campo de juego en modo inacabado 2 Player Versus. Los bytes de esta tabla son parte de la lista de valores que se muestran err√≥neamente como n√∫meros de nivel despu√©s del nivel 29. Los bytes adyacentes inferior y superior de cada direcci√≥n se obtienen por separado y se combinan esencialmente en una direcci√≥n de 16 bits que se utiliza en el ciclo de copia. </font><font style="vertical-align: inherit;">Se ejecuta un incremento al final de la subrutina.</font></font><br><br> <code>952A: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 952D: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 9530: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 9533: JSR $9725 ; copyPlayfieldRowToVRAM();</code> <br> <br><font style="vertical-align: inherit;"></font><code>copyPlayfieldRowToVRAM()</code><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><br><br> <code>9725: LDX $0049 ; if (vramRow &gt; 20) { <br> 9727: CPX #$15 ; return; <br> 9729: BPL $977E ; } <br> <br> 972B: LDA $96D6,X <br> 972E: TAY ; playfieldAddress = 10 * vramRow; <br> <br> 972F: TXA <br> 9730: ASL <br> 9731: TAX <br> 9732: INX ; high = vramPlayfieldRows[vramRow * 2 + 1]; <br> 9733: LDA $96EA,X <br> 9736: STA $2006 <br> 9739: DEX <br> <br> 973A: LDA $00BE <br> 973C: CMP #$01 <br> 973E: BEQ $975E ; if (numberOfPlayers == 2) { <br> <br> 9740: LDA $00B9 <br> 9742: CMP #$05 <br> 9744: BEQ $9752 ; if (leftPlayfield) { <br> <br> 9746: LDA $96EA,X <br> 9749: SEC <br> 974A: SBC #$02 <br> 974C: STA $2006 ; low = vramPlayfieldRows[vramRow * 2] - 2; <br> <br> 974F: JMP $9767 ; } else { <br> <br> 9752: LDA $96EA,X <br> 9755: CLC <br> 9756: ADC #$0C <br> 9758: STA $2006 ; low = vramPlayfieldRows[vramRow * 2] + 12; <br> <br> 975B: JMP $9767 ; } else { <br> <br> 975E: LDA $96EA,X <br> 9761: CLC <br> 9762: ADC #$06 ; low = vramPlayfieldRows[vramRow * 2] + 6; <br> 9764: STA $2006 ; } <br> <br> ; vramAddress = (high &lt;&lt; 8) | low; <br> <br> 9767: LDX #$0A <br> 9769: LDA ($B8),Y <br> 976B: STA $2007 <br> 976E: INY ; for(i = 0; i &lt; 10; i++) { <br> 976F: DEX ; vram[vramAddress + i] = playfield[playfieldAddress + i]; <br> 9770: BNE $9769 ; } <br> <br> 9772: INC $0049 ; vramRow++; <br> 9774: LDA $0049 ; if (vramRow &lt; 20) { <br> 9776: CMP #$14 ; return; <br> 9778: BMI $977E ; } <br> <br> 977A: LDA #$20 <br> 977C: STA $0049 ; vramRow = 32; <br> <br> 977E: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>vramPlayfieldRows</code><font style="vertical-align: inherit;"></font><code>$96EA</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Si el valor llega a 20, se le asigna un valor de 32, lo que significa que la copia est√° completamente completa. Como se muestra arriba, solo se copian 4 l√≠neas por fotograma. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El controlador de estado </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es responsable de reconocer las l√≠neas completadas y eliminarlas del campo de juego. Durante 4 llamadas separadas, escanea los desplazamientos de l√≠nea </font></font><code>[‚àí2, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cerca del centro del tetrimino (ambas coordenadas de todos los cuadrados del tetrimino est√°n en este intervalo). Los √≠ndices de las filas completadas se almacenan en </font></font><code>$004A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$004D</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; el √≠ndice registrado 0 se usa para indicar que no se encontraron filas completas en esta pasada. El controlador se muestra a continuaci√≥n. </font><font style="vertical-align: inherit;">La comprobaci√≥n </font><font style="vertical-align: inherit;">al principio no permite que el controlador se ejecute al transferir l√≠neas del campo de juego a VRAM (controlador de estado</font></font><br><br> <code>9A6B: LDA $0049 <br> 9A6D: CMP #$20 ; if (vramRow &lt; 32) { <br> 9A6F: BPL $9A74 ; return; <br> 9A71: JMP $9B02 ; } <br> <br> 9A74: LDA $0041 ; rowY = tetriminoY - 2; <br> 9A76: SEC <br> 9A77: SBC #$02 ; if (rowY &lt; 0) { <br> 9A79: BPL $9A7D ; rowY = 0; <br> 9A7B: LDA #$00 ; } <br> <br> 9A7D: CLC <br> 9A7E: ADC $0057 <br> 9A80: STA $00A9 ; rowY += lineIndex; <br> <br> 9A82: ASL <br> 9A83: STA $00A8 <br> 9A85: ASL <br> 9A86: ASL <br> 9A87: CLC <br> 9A88: ADC $00A8 <br> 9A8A: STA $00A8 ; rowIndex = 10 * rowY; <br> <br> 9A8C: TAY <br> 9A8D: LDX #$0A <br> 9A8F: LDA ($B8),Y <br> 9A91: CMP #$EF ; for(i = 0; i &lt; 10; i++) { <br> 9A93: BEQ $9ACC ; if (playfield[rowIndex + i] == EMPTY_TILE) { <br> 9A95: INY ; goto rowNotComplete; <br> 9A96: DEX ; } <br> 9A97: BNE $9A8F ; } <br> <br> 9A99: LDA #$0A <br> 9A9B: STA $06F1 ; play row completed sound effect; <br> <br> 9A9E: INC $0056 ; completedLines++; <br> <br> 9AA0: LDX $0057 <br> 9AA2: LDA $00A9 <br> 9AA4: STA $4A,X ; lines[lineIndex] = rowY; <br> <br> 9AA6: LDY $00A8 <br> 9AA8: DEY <br> 9AA9: LDA ($B8),Y <br> 9AAB: LDX #$0A <br> 9AAD: STX $00B8 <br> 9AAF: STA ($B8),Y <br> 9AB1: LDA #$00 <br> 9AB3: STA $00B8 <br> 9AB5: DEY ; for(i = rowIndex - 1; i &gt;= 0; i--) { <br> 9AB6: CPY #$FF ; playfield[i + 10] = playfield[i]; <br> 9AB8: BNE $9AA9 ; } <br> <br> 9ABA: LDA #$EF <br> 9ABC: LDY #$00 <br> 9ABE: STA ($B8),Y <br> 9AC0: INY ; for(i = 0; i &lt; 10; i++) { <br> 9AC1: CPY #$0A ; playfield[i] = EMPTY_TILE; <br> 9AC3: BNE $9ABE ; } <br> <br> 9AC5: LDA #$13 <br> 9AC7: STA $0042 ; orientationID = UNASSIGNED; <br> <br> 9AC9: JMP $9AD2 ; goto incrementLineIndex; <br> <br> rowNotComplete: <br> <br> 9ACC: LDX $0057 <br> 9ACE: LDA #$00 <br> 9AD0: STA $4A,X ; lines[lineIndex] = 0; <br> <br> incrementLineIndex: <br> <br> 9AD2: INC $0057 ; lineIndex++; <br> <br> 9AD4: LDA $0057 ; if (lineIndex &lt; 4) { <br> 9AD6: CMP #$04 ; return; <br> 9AD8: BMI $9B02 ; } <br> <br> 9ADA: LDY $0056 <br> 9ADC: LDA $9B53,Y <br> 9ADF: CLC <br> 9AE0: ADC $00BC <br> 9AE2: STA $00BC ; totalGarbage += garbageLines[completedLines]; <br> <br> 9AE4: LDA #$00 <br> 9AE6: STA $0049 ; vramRow = 0; <br> 9AE8: STA $0052 ; clearColumnIndex = 0; <br> <br> 9AEA: LDA $0056 <br> 9AEC: CMP #$04 <br> 9AEE: BNE $9AF5 ; if (completedLines == 4) { <br> 9AF0: LDA #$04 ; play Tetris sound effect; <br> 9AF2: STA $06F1 ; } <br> <br> 9AF5: INC $0048 ; if (completedLines &gt; 0) { <br> 9AF7: LDA $0056 ; playState = DISPLAY_LINE_CLEARING_ANIMATION; <br> 9AF9: BNE $9B02 ; return; <br> ; } <br> <br> 9AFB: INC $0048 ; playState = UPDATE_LINES_AND_STATISTICS; <br> <br> 9AFD: LDA #$07 <br> 9AFF: STA $06F1 ; play piece locked sound effect; <br> <br> 9B02: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llamado en cada cuadro). Si se detectan filas llenas, se </font></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restablece a 0, lo que fuerza una transferencia completa. </font></font><br><br> <code>lineIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$00A9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) se inicializa con un valor de 0 y su incremento se realiza en cada pasada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A diferencia del estado del juego </font></font><code>$0A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y la rutina de copia del campo del juego, que usa la tabla de multiplicaci√≥n de direcciones </font></font><code>$96D6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, un bloque que comienza con </font></font><code>$9A82</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multiplica </font></font><code>rowY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por 10 usando turnos y adiciones: </font></font><br><br> <code>rowIndex = (rowY &lt;&lt; 1) + (rowY &lt;&lt; 3); // rowIndex = 2 * rowY + 8 * rowY;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto se hace solo porque est√° </font></font><code>rowY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limitado por el intervalo </font></font><code>[0, 20]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y la tabla de multiplicaci√≥n solo cubre </font></font><code>[0, 19]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El escaneo de filas puede extenderse m√°s all√° del final del campo de juego. Sin embargo, como se dijo anteriormente, el juego se inicializa </font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>$04FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un valor</font></font><code>$EF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(mosaico vac√≠o), creando m√°s de 5 l√≠neas ocultas vac√≠as adicionales debajo del piso del campo de juego. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un bloque que comienza </font></font><code>$9ADA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es parte del modo incompleto de 2 Player Versus. Como se mencion√≥ anteriormente, despejar las filas agrega escombros al campo de juego del oponente. La tabla en la direcci√≥n determina el n√∫mero de filas de basura </font></font><code>$9B53</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">el ciclo en la direcci√≥n </font><font style="vertical-align: inherit;">desplaza el material sobre la fila llena una l√≠nea hacia abajo. Aprovecha el hecho de que cada l√≠nea en una secuencia continua est√° separada de la otra por 10 bytes. El siguiente ciclo borra la l√≠nea superior. </font><font style="vertical-align: inherit;">La animaci√≥n de eliminaci√≥n de filas se realiza durante el estado del juego </font><font style="vertical-align: inherit;">, pero como se muestra a continuaci√≥n, no ocurre en el controlador del estado del juego, que est√° completamente vac√≠o.</font></font><br><br> <code>9B53: 00 ; no cleared lines <br> 9B54: 00 ; Single <br> 9B55: 01 ; Double <br> 9B56: 02 ; Triple <br> 9B57: 04 ; Tetris</code> <br> <br><font style="vertical-align: inherit;"></font><code>$9AA6</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$04</code><font style="vertical-align: inherit;"></font><br><br> <code>9E39: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cambio, durante el estado del juego </font></font><code>$04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, se realiza la siguiente ramificaci√≥n del modo de representaci√≥n </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">y los valores reflejados son necesarios para el modo inacabado 2 Player Versus. </font><font style="vertical-align: inherit;">La subrutina se muestra a continuaci√≥n </font><font style="vertical-align: inherit;">. Se llama en cada cuadro, pero la condici√≥n al principio permite que se ejecute solo en cada cuarto cuadro. En cada pasada, recorre la lista de √≠ndices de filas completadas y borra 2 columnas en estas filas, movi√©ndose desde la columna central hacia afuera. </font><font style="vertical-align: inherit;">Una direcci√≥n VRAM de 16 bits se construye de la misma manera que se muestra en la rutina de campo de copia. Sin embargo, en este caso, realiza un desplazamiento por el √≠ndice de columna obtenido de la tabla a continuaci√≥n.</font></font><br><br> <code>94EE: LDA $0068 <br> 94F0: CMP #$04 <br> 94F2: BNE $9522 ; if (playState == DISPLAY_LINE_CLEARING_ANIMATION) { <br> <br> 94F4: LDA #$04 <br> 94F6: STA $00B9 ; leftPlayfield = true; <br> <br> 94F8: LDA $0072 <br> 94FA: STA $0052 <br> 94FC: LDA $006A <br> 94FE: STA $004A <br> 9500: LDA $006B <br> 9502: STA $004B <br> 9504: LDA $006C <br> 9506: STA $004C <br> 9508: LDA $006D <br> 950A: STA $004D <br> 950C: LDA $0068 <br> 950E: STA $0048 ; mirror values; <br> <br> 9510: JSR $977F ; updateLineClearingAnimation(); <br> <br> ; ... <br> ; }</code> <br> <br> <code>leftPlayfield</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>updateLineClearingAnimation()</code><font style="vertical-align: inherit;"></font><br><br> <code>977F: LDA $00B1 ; if (frameCounter not divisible by 4) { <br> 9781: AND #$03 ; return; <br> 9783: BNE $97FD ; } <br> <br> 9785: LDA #$00 ; for(i = 0; i &lt; 4; i++) { <br> 9787: STA $00AA ; rowY = lines[i]; <br> 9789: LDX $00AA ; if (rowY == 0) { <br> 978B: LDA $4A,X ; continue; <br> 978D: BEQ $97EB ; } <br> <br> 978F: ASL <br> 9790: TAY <br> 9791: LDA $96EA,Y <br> 9794: STA $00A8 ; low = vramPlayfieldRows[2 * rowY]; <br> <br> 9796: LDA $00BE ; if (numberOfPlayers == 2) { <br> 9798: CMP #$01 ; goto twoPlayers; <br> 979A: BNE $97A6 ; } <br> <br> 979C: LDA $00A8 <br> 979E: CLC <br> 979F: ADC #$06 <br> 97A1: STA $00A8 ; low += 6; <br> <br> 97A3: JMP $97BD ; goto updateVRAM; <br> <br> twoPlayers: <br> <br> 97A6: LDA $00B9 <br> 97A8: CMP #$04 <br> 97AA: BNE $97B6 ; if (leftPlayfield) { <br> <br> 97AC: LDA $00A8 <br> 97AE: SEC <br> 97AF: SBC #$02 <br> 97B1: STA $00A8 ; low -= 2; <br> <br> 97B3: JMP $97BD ; } else { <br> <br> 97B6: LDA $00A8 <br> 97B8: CLC <br> 97B9: ADC #$0C ; low += 12; <br> 97BB: STA $00A8 ; } <br> <br> updateVRAM: <br> <br> 97BD: INY <br> 97BE: LDA $96EA,Y <br> 97C1: STA $00A9 <br> 97C3: STA $2006 <br> 97C6: LDX $0052 ; high = vramPlayfieldRows[2 * rowY + 1]; <br> 97C8: LDA $97FE,X <br> 97CB: CLC ; rowAddress = (high &lt;&lt; 8) | low; <br> 97CC: ADC $00A8 <br> 97CE: STA $2006 ; vramAddress = rowAddress + leftColumns[clearColumnIndex]; <br> 97D1: LDA #$FF <br> 97D3: STA $2007 ; vram[vramAddress] = 255; <br> <br> 97D6: LDA $00A9 <br> 97D8: STA $2006 <br> 97DB: LDX $0052 ; high = vramPlayfieldRows[2 * rowY + 1]; <br> 97DD: LDA $9803,X <br> 97E0: CLC ; rowAddress = (high &lt;&lt; 8) | low; <br> 97E1: ADC $00A8 <br> 97E3: STA $2006 ; vramAddress = rowAddress + rightColumns[clearColumnIndex]; <br> 97E6: LDA #$FF <br> 97E8: STA $2007 ; vram[vramAddress] = 255; <br> <br> 97EB: INC $00AA <br> 97ED: LDA $00AA <br> 97EF: CMP #$04 <br> 97F1: BNE $9789 ; } <br> <br> 97F3: INC $0052 ; clearColumnIndex++; <br> 97F5: LDA $0052 ; if (clearColumnIndex &lt; 5) { <br> 97F7: CMP #$05 ; return; <br> 97F9: BMI $97FD ; } <br> <br> 97FB: INC $0048 ; playState = UPDATE_LINES_AND_STATISTICS; <br> <br> 97FD: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>97FE: 04 03 02 01 00 ; left columns <br> 9803: 05 06 07 08 09 ; right columns</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para limpiar la animaci√≥n, se requieren 5 pases. Luego, el c√≥digo pasa al siguiente estado del juego. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El controlador de estado del juego </font></font><code>$05</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contiene el c√≥digo descrito en la secci√≥n "Filas y estad√≠sticas". El controlador termina con este c√≥digo: la </font><font style="vertical-align: inherit;">variable </font><font style="vertical-align: inherit;">no se restablece hasta el final del estado del juego </font><font style="vertical-align: inherit;">, despu√©s de lo cual se usa para actualizar el n√∫mero total de filas y la puntuaci√≥n. Esta secuencia permite ejecutar un error interesante. En el modo de demostraci√≥n, debe esperar hasta que el juego recoja la fila completa y luego presione r√°pidamente Iniciar hasta que la animaci√≥n para borrar la serie haya terminado. El juego volver√° al protector de pantalla, pero si elige el momento adecuado, se </font><font style="vertical-align: inherit;">guardar√° </font><font style="vertical-align: inherit;">el valor </font><font style="vertical-align: inherit;">. Ahora puedes iniciar el juego en modo A-Type. Cuando est√° bloqueado en lugar de la primera figura, el controlador de estado del juego</font></font><br><br> <code>9C9E: LDA #$00 <br> 9CA0: STA $0056 ; completedLines = 0; <br> <br> 9CA2: INC $0048 ; playState = B_TYPE_GOAL_CHECK; <br> <br> 9CA4: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>completedLines</code><font style="vertical-align: inherit;"></font><code>$05</code><font style="vertical-align: inherit;"></font><code>completedLines</code><font style="vertical-align: inherit;"></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comienza a escanear filas completadas. No los encontrar√°, pero los dejar√° </font></font><code>completedLines</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sin cambios. Finalmente, cuando se cumple el estado del juego, el </font></font><code>$05</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√∫mero total de filas y la puntuaci√≥n aumentar√°n, como si las hubiera puntuado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La forma m√°s f√°cil de hacer esto es obtener la mayor cantidad, esperando que la demostraci√≥n recolecte Tetris (habr√° 2 de ellos en la demostraci√≥n). Tan pronto como vea el parpadeo de la pantalla, haga clic en Inicio.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a8/80a/091/2a880a09173c42fb8c5256f9921a635b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de comenzar un nuevo juego, la pantalla continuar√° parpadeando. Todo esto gracias al siguiente c√≥digo llamado por el controlador de interrupciones. </font><font style="vertical-align: inherit;">De hecho, si deja que la primera figura descienda autom√°ticamente al piso del campo de juego, la puntuaci√≥n aumentar√° en un valor a√∫n mayor, porque </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) tambi√©n guardar√° su valor de la demostraci√≥n. Esto es cierto incluso en los casos en que la demostraci√≥n no llen√≥ una sola fila. </font><font style="vertical-align: inherit;">No se restablece hasta que se presiona el bot√≥n "Abajo". </font><font style="vertical-align: inherit;">Adem√°s, si presiona Iniciar durante la animaci√≥n de borrar la serie de combinaciones de Tetris en el modo de demostraci√≥n, y luego espera a que la demostraci√≥n comience nuevamente, no solo se contar√°n los puntos para Tetris en la demostraci√≥n, sino que todo el tiempo se mezclar√°. Como resultado, la demo perder√° el juego. Despu√©s de cortar el final del juego, puede volver al protector de pantalla haciendo clic en Inicio.</font></font><br><br> <code>9673: LDA #$3F <br> 9675: STA $2006 <br> 9678: LDA #$0E <br> 967A: STA $2006 ; prepare to modify background tile color; <br> <br> 967D: LDX #$00 ; color = DARK_GRAY; <br> <br> 967F: LDA $0056 <br> 9681: CMP #$04 <br> 9683: BNE $9698 ; if (completedLines == 4) { <br> <br> 9685: LDA $00B1 <br> 9687: AND #$03 <br> 9689: BNE $9698 ; if (frameCounter divisible by 4) { <br> <br> 968B: LDX #$30 ; color = WHITE; <br> <br> 968D: LDA $00B1 <br> 968F: AND #$07 <br> 9691: BNE $9698 ; if (frameCounter divisible by 8) { <br> <br> 9693: LDA #$09 <br> 9695: STA $06F1 ; play clear sound effect; <br> <br> ; } <br> ; } <br> ; } <br> <br> 9698: STX $2007 ; update background tile color;</code> <br> <br><font style="vertical-align: inherit;"></font><code>holdDownPoints</code><font style="vertical-align: inherit;"></font><code>$004F</code><font style="vertical-align: inherit;"></font><code>holdDownPoints</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado del juego </font></font><code>$06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realiza una comprobaci√≥n de objetivos para los juegos de tipo B. </font><font style="vertical-align: inherit;">En el modo de tipo A, es esencialmente un marco no utilizado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado del juego </font></font><code>$07</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contiene exclusivamente la l√≥gica incompleta de 2 jugadores contra. </font><font style="vertical-align: inherit;">En el modo de un jugador, se comporta como un marco no utilizado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado del juego se </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trata en las secciones "Creaci√≥n de Tetrimino" y "Elecci√≥n de Tetrimino". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado del juego </font></font><code>$09</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se usa. </font></font><code>$0B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumenta el estado del juego, pero tambi√©n se ve sin usar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y finalmente, el ciclo principal del juego:</font></font><br><br> <code>; while(true) { <br> <br> 8138: JSR $8161 ; branchOnGameMode(); <br> <br> 813B: CMP $00A7 ; if (vertical blanking interval wait requested) { <br> 813D: BNE $8142 ; waitForVerticalBlankingInterval(); <br> 813F: JSR $AA2F ; } <br> <br> 8142: LDA $00C0 <br> 8144: CMP #$05 <br> 8146: BNE $815A ; if (gameMode == DEMO) { <br> <br> 8148: LDA $00D2 <br> 814A: CMP #$DF <br> 814C: BNE $815A ; if (reached end of demo table) { <br> <br> 814E: LDA #$DD <br> 8150: STA $00D2 ; reset demo table index; <br> <br> 8152: LDA #$00 <br> 8154: STA $00B2 ; clear upper byte of frame counter; <br> <br> 8156: LDA #$01 <br> 8158: STA $00C0 ; gameMode = TITLE_SCREEN; <br> ; } <br> ; } <br> 815A: JMP $8138 ; }</code> </div> </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es420725/">https://habr.com/ru/post/es420725/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es420707/index.html">El inicio de JITX usa IA para automatizar el desarrollo de placas de circuito impreso complejas</a></li>
<li><a href="../es420709/index.html">T2F: un proyecto para convertir texto en dibujo facial con aprendizaje profundo</a></li>
<li><a href="../es420711/index.html">Mosc√∫ Data Science Major: anuncio y registro</a></li>
<li><a href="../es420713/index.html">C√≥mo invent√≥ Chuck Hull la impresi√≥n 3D</a></li>
<li><a href="../es420715/index.html">La dura verdad sobre la severidad del aprendizaje.</a></li>
<li><a href="../es420729/index.html">Abrir webinar "Clasificador Naive Bayes"</a></li>
<li><a href="../es420731/index.html">Zabbix con esteroides: c√≥mo funciona la plataforma de monitoreo unificado de Sbertech</a></li>
<li><a href="../es420735/index.html">Te invitamos a la final del marat√≥n Find Yourself in Digital en la oficina de Mail.Ru Group</a></li>
<li><a href="../es420737/index.html">Mini ai cup 2 o casi AgarIO: ¬øqu√© se puede hacer para ganar?</a></li>
<li><a href="../es420739/index.html">La caja todav√≠a est√° en el mango: por qu√© en 2018 todav√≠a necesitas aprender idiomas t√∫ mismo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>