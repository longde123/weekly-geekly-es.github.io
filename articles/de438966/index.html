<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüíº üî¥ üê∂ Haproxy-Dokumentation, die den Verlauf durchl√§uft, oder worauf bei der Konfiguration zu achten ist üêß üë©üèø‚Äçü§ù‚Äçüë©üèΩ ‚öóÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo nochmal! 

 Beim letzten Mal haben wir dar√ºber gesprochen, in Ostrovok.ru ein Tool auszuw√§hlen, mit dem das Problem gel√∂st werden kann, dass ein...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Haproxy-Dokumentation, die den Verlauf durchl√§uft, oder worauf bei der Konfiguration zu achten ist</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/438966/">  Hallo nochmal! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Beim letzten Mal haben</a> wir dar√ºber gesprochen, in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ostrovok.ru</a> ein Tool auszuw√§hlen, mit dem das Problem gel√∂st werden kann, dass eine gro√üe Anzahl von Anfragen an externe Dienste weitergeleitet wird, ohne dass gleichzeitig jemand eingestellt wird.  Der Artikel endete mit einer Auswahl von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Haproxy</a> .  Heute werde ich die Nuancen teilen, mit denen ich bei der Verwendung dieser L√∂sung konfrontiert war. <br><br><img src="https://habrastorage.org/webt/ns/mz/sb/nsmzsbtu2c1rgib_avecisgyrlk.jpeg"><br><a name="habracut"></a><br><h3>  Haproxy-Konfiguration </h3><br>  Die erste Schwierigkeit bestand darin, dass die Option <code>maxconn</code> je nach Kontext unterschiedlich ist: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">maxconn (Leistungsoptimierung);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">maxconn (Bindungsoptionen);</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">maxconn (Server- und Standardserveroptionen).</a> </li></ul><br>  Aus Gewohnheit habe ich nur die erste Option ( <code>performance tuning</code> ) eingestellt.  In der Dokumentation zu dieser Option hei√üt es: <br><blockquote>  Legt die maximale Anzahl gleichzeitiger Verbindungen pro Prozess auf &lt;Nummer&gt; fest.  Es <br>  entspricht dem Befehlszeilenargument "-n".  Proxies werden nicht mehr akzeptiert <br>  Verbindungen, wenn diese Grenze erreicht ist. <br></blockquote><br>  Es scheint, dass das, was ben√∂tigt wird.  Als ich jedoch auf die Tatsache stie√ü, dass neue Verbindungen zum Proxy nicht sofort hergestellt wurden, begann ich, die Dokumentation genauer zu lesen, und dort fand ich bereits den zweiten Parameter ( <code>bind options</code> ): <br><blockquote>  Begrenzt die Sockets auf diese Anzahl gleichzeitiger Verbindungen.  Fremd <br>  Verbindungen bleiben im R√ºckstand des Systems, bis eine Verbindung hergestellt wird <br>  freigegeben.  Wenn nicht angegeben, entspricht das Limit dem maxconn des Frontends. <br></blockquote><br>  Also, <code>frontends maxconn</code> gehen und dann nach <code>frontends maxconn</code> suchen <code>frontends maxconn</code> : <br><blockquote>  Legen Sie die maximale Anzahl gleichzeitiger Verbindungen auf einem Frontend fest <br>  ... <br>  Standardm√§√üig ist dieser Wert auf 2000 eingestellt. <br></blockquote><br>  Gro√üartig, was du brauchst.  Zur Konfiguration hinzuf√ºgen: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 ... defaults mode http maxconn 524288</code> </pre><br>  Der n√§chste Knebel war, dass Haproxy Single-Threaded ist.  Ich bin sehr an das Modell in Nginx gew√∂hnt, daher hat mich diese Nuance immer deprimiert.  Aber verzweifeln Sie nicht - <i>Willy Tarreau</i> ( <i>Haproxy-Entwickler</i> ) verstand, was er tat, und f√ºgte die Option hinzu - <code>nbproc</code> . <br><br>  In der Dokumentation hei√üt es jedoch direkt: <br><blockquote>  VERWENDUNG MEHRERER PROZESSE <br>  Ist schwerer zu debuggen und ist wirklich entmutigt. <br></blockquote>  Diese Option kann in F√§llen, in denen Sie Folgendes ben√∂tigen, wirklich Kopfschmerzen verursachen: <br><br><ul><li>  Begrenzen Sie die Anzahl der Anforderungen / Verbindungen zu Servern (da Sie bereits nicht einen Prozess mit einem Z√§hler, sondern viele Prozesse haben und jeder seinen eigenen Z√§hler hat). </li><li>  Sammeln Sie Statistiken aus dem Haproxy-Verwaltungssocket </li><li>  Backends √ºber die Steuerbuchse aktivieren / deaktivieren; </li><li>  ... vielleicht noch etwas.  ¬Ø \ _ („ÉÑ) _ / ¬Ø </li></ul><br>  Trotzdem haben uns die G√∂tter Multi-Core-Prozessoren gegeben, deshalb m√∂chte ich sie maximal nutzen.  In meinem Fall gab es vier Kerne in zwei physischen Kernen.  F√ºr Haproxy habe ich den ersten Kern ausgew√§hlt und es sah so aus: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">nbproc</span></span> 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3</code> </pre><br>  Mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">cpu-map</a> binden wir Haproxy-Prozesse an einen bestimmten Kern.  Der OS-Scheduler muss nicht mehr dar√ºber nachdenken, wo er Haproxy planen soll, wodurch der <code>content switch</code> k√ºhl und der CPU-Cache warm bleibt. <br><br><h4>  Es gibt viele Puffer, aber in unserem Fall nicht </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tune.bufsize</a> - In unserem Fall war es nicht erforderlich, es auszuf√ºhren. Wenn Sie jedoch Fehler mit dem Code <code>400 (Bad Request)</code> , ist dies wahrscheinlich Ihr Fall. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhiG8UjB5laMf7C77KXE_syVH7bPhQ#tune.">tune.http.cookielen</a> - Wenn Sie gro√üe Cookies an Benutzer verteilen, kann es sinnvoll sein, diesen Puffer ebenfalls zu erh√∂hen, um Sch√§den w√§hrend der √úbertragung √ºber das Netzwerk zu vermeiden. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhiG8UjB5laMf7C77KXE_syVH7bPhQ#tune.">tune.http.maxhdr</a> ist eine weitere m√∂gliche Quelle f√ºr 400 Antwortcodes, wenn Sie zu viele Header haben. </li></ul><br><h4>  Betrachten Sie nun das Zeug der unteren Ebene </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tune.rcvbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tune.rcvbuf.server</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tune.sndbuf.client</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tune.sndbuf.server</a> - In der Dokumentation hei√üt es: <br><blockquote>  Es sollte normalerweise nie festgelegt werden, und die Standardgr√∂√üe (0) erm√∂glicht es dem Kernel, diesen Wert abh√§ngig von der Menge des verf√ºgbaren Speichers automatisch abzustimmen. <br></blockquote><br>  Aber f√ºr mich ist das Offensichtliche besser als das Implizite, deshalb habe ich die Werte dieser Optionen gezwungen, morgen sicher zu sein. <br><br>  Ein weiterer Parameter, der nicht mit Puffern zusammenh√§ngt, aber sehr wichtig ist, ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">tune.maxaccept</a> . <br><blockquote>  Legt die maximale Anzahl aufeinanderfolgender Verbindungen fest, die ein Prozess in a akzeptieren darf <br>  Zeile vor dem Wechsel zu anderen Arbeiten.  Im Einzelprozessmodus h√∂here Zahlen <br>  Bessere Leistung bei hohen Verbindungsraten.  Jedoch in Multi-Prozess <br>  Modi ist es besser, ein bisschen Fairness zwischen den Prozessen zu halten <br>  Leistung steigern. <br></blockquote><br>  In unserem Fall werden ziemlich viele Proxy-Anfragen generiert, daher habe ich diesen Wert erh√∂ht, um mehr Anfragen gleichzeitig zu akzeptieren.  Wie in der Dokumentation angegeben, lohnt es sich jedoch zu testen, ob die Last im Multithread-Modus so gleichm√§√üig wie m√∂glich auf die Prozesse verteilt wird. <br><br>  Alle Parameter zusammen: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">tune</span></span>.bufsize 16384 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432</code> </pre><br><h4>  Was nie passiert, sind Auszeiten.  Was w√ºrden wir ohne sie tun? </h4><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Timeout-Verbindung</a> - Zeit zum Herstellen einer Verbindung mit dem Backend.  Wenn die Verbindung zum Backend nicht sehr gut ist, ist es besser, sie bis zu diesem Zeitpunkt zu deaktivieren, bis das Netzwerk wieder normal ist. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Timeout-Client</a> - Zeit√ºberschreitung f√ºr die √úbertragung der ersten Datenbytes.  Es hilft, diejenigen zu trennen, die Anfragen "in Reserve" stellen. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Kulstory √ºber HTTP-Client in Go</b> <div class="spoiler_text">  Go verf√ºgt √ºber einen regul√§ren HTTP-Client, der einen Pool von Verbindungen zu Servern verwalten kann.  So geschah eine interessante Geschichte, an der das oben beschriebene Timeout und der Verbindungspool im HTTP-Client teilnahmen.  Einmal beschwerte sich ein Entwickler, dass er regelm√§√üig 408 Fehler von einem Proxy hat.  Wir haben uns den Client-Code angesehen und dort die folgende Logik gesehen: <br><br><ul><li>  Wir versuchen, eine kostenlose Verbindung aus dem Pool herzustellen. </li><li>  Wenn dies nicht funktioniert, starten Sie die Installation einer neuen Verbindung in Goroutine. </li><li>  √úberpr√ºfen Sie den Pool erneut. </li><li>  Wenn der Pool frei ist - wir nehmen ihn und legen den neuen in den Pool, wenn nicht - verwenden Sie den neuen. </li></ul><br>  Schon verstanden, was das Salz ist? <br><br>  Wenn der Client eine neue Verbindung hergestellt, diese jedoch nicht verwendet hat, schlie√üt der Server sie nach f√ºnf Sekunden und der Fall ist beendet.  Der Client f√§ngt dies nur ab, wenn er die Verbindung bereits aus dem Pool erh√§lt und versucht, sie zu verwenden.  Es lohnt sich, dies zu ber√ºcksichtigen. <br></div></div><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Timeout-Server</a> - Maximale Wartezeit auf eine Antwort vom Server. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Timeout Client-Fin</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Timeout Server-Fin</a> - hier sch√ºtzen wir uns vor halb geschlossenen Verbindungen, um sie nicht in der Betriebssystemtabelle zu akkumulieren. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhiG8UjB5laMf7C77KXE_syVH7bPhQ#timeout%20">Timeout http-Anfrage</a> ist eines der am besten geeigneten Timeouts.  Erm√∂glicht das Abschneiden langsamer Clients, die in der ihnen zugewiesenen Zeit keine HTTP-Anforderung stellen k√∂nnen. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=http://cbonte.github.io/haproxy-dconv/1.9/configuration.html&amp;usg=ALkJrhiG8UjB5laMf7C77KXE_syVH7bPhQ#timeout%20">Zeit√ºberschreitung http-keep-alive</a> - speziell in unserem Fall, wenn eine <code>keep-alive</code> Verbindung l√§nger als 50 Sekunden ohne Anforderungen h√§ngt, ist h√∂chstwahrscheinlich ein Fehler aufgetreten und die Verbindung kann geschlossen werden, wodurch Speicher f√ºr etwas Neues frei wird Licht. </li></ul><br>  Alle Auszeiten zusammen: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">defaults</span></span> mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s</code> </pre><br><h4>  Protokollierung  Warum ist es so kompliziert? </h4><br>  Wie ich bereits geschrieben habe, verwende ich bei meinen Entscheidungen meistens Nginx. Daher bin ich von seiner Syntax und der Einfachheit des √Ñnderns von Protokollformaten verw√∂hnt.  Ich mochte besonders die Killer-Feature-Format-Protokolle in Form von JSON, um sie dann mit jeder Standardbibliothek zu analysieren. <br><br>  Was haben wir bei Haproxy?  Es gibt eine solche M√∂glichkeit, nur Sie k√∂nnen ausschlie√ülich in Syslog schreiben, und die Konfigurationssyntax ist etwas umfangreicher. <br>  Ich gebe Ihnen eine Beispielkonfiguration mit Kommentaren: <br><br><pre> <code class="apache hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,     ,    (   # error.log  nginx) log 127.0.0.1:2514 len 8192 local1 notice emerg #    -  access.log log 127.0.0.1:2514 len 8192 local7 info</span></span></code> </pre><br>  Besondere Schmerzen werden durch solche Momente verursacht: <br><ul><li>  kurze Variablennamen und insbesondere deren Kombinationen wie% HU oder% fp </li><li>  Das Format kann nicht in mehrere Zeilen unterteilt werden, daher m√ºssen Sie Fu√üt√ºcher in eine Zeile schreiben.  Es ist schwierig, neue / unn√∂tige Elemente hinzuzuf√ºgen / zu entfernen </li><li>  Damit einige Variablen funktionieren, m√ºssen sie explizit √ºber den Erfassungsanforderungsheader deklariert werden </li></ul><br>  Um etwas Interessantes zu bekommen, muss man ein solches Fu√ütuch haben: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">log</span></span>-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}'</code> </pre><br><h4>  Nun, es scheint, kleine Dinge, aber sch√∂n </h4><br>  Ich habe das Format des Protokolls oben beschrieben, aber nicht so einfach.  Um einige Elemente darin abzulegen, wie zum Beispiel: <br><br><ul><li>  http_host </li><li>  http_referer, </li><li>  http_user_agent, </li></ul><br>  Zuerst m√ºssen Sie diese Daten aus der Anforderung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erfassen</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">erfassen</a> ) und in ein Array von erfassten Werten einf√ºgen. <br><br>  Hier ist ein Beispiel: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128</code> </pre><br>  Infolgedessen k√∂nnen wir jetzt auf folgende Weise auf die ben√∂tigten Elemente zugreifen: <br>  <code>%[capture.req.hdr(N)]</code> , wobei N die Sequenznummer der Capture-Gruppendefinition ist. <br>  Im obigen Beispiel befindet sich der Host-Header auf Nummer 0 und der User-Agent auf Nummer 2. <br><br>  Haproxy hat eine Besonderheit: Es l√∂st die DNS-Adressen der Backends beim Start auf und, wenn es keine der Adressen aufl√∂sen kann, f√§llt der Tod des Mutigen. <br><br>  In unserem Fall ist dies nicht sehr praktisch, da es viele Backends gibt, wir sie nicht verwalten und es besser ist, 503 von Haproxy zu erhalten, als der gesamte Proxyserver aufgrund eines Anbieters den Start verweigert.  Die folgende Option hilft uns dabei: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">init-addr</a> . <br><br>  Eine Zeile direkt aus der Dokumentation erm√∂glicht es uns, alle verf√ºgbaren Methoden zum Aufl√∂sen einer Adresse durchzugehen und im Falle einer Datei diese Angelegenheit einfach auf sp√§ter zu verschieben und weiter zu gehen: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">default</span></span>-server init-addr last,libc,none</code> </pre> <br>  Und schlie√ülich mein Favorit: Backend-Auswahl. <br>  Die Syntax f√ºr die Haproxy-Backend-Auswahlkonfiguration ist allen bekannt: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">use_backend</span></span> &lt;backend1_name&gt; if &lt;condition1&gt; use_backend &lt;backend2_name&gt; if &lt;condition2&gt; default-backend &lt;backend3&gt;</code> </pre><br>  Aber richtig, es ist irgendwie nicht sehr.  Ich habe bereits alle Backends automatisiert beschrieben (siehe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorherigen Artikel</a> ), es w√§re auch hier m√∂glich, <code>use_backend</code> zu generieren, das schlechte Gesch√§ft ist nicht knifflig, aber ich wollte nicht.  Als Ergebnis wurde ein anderer Weg gefunden: <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">capture</span></span> request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 #   host_present      Host acl host_present hdr(host) -m len gt 0 #    ,     use_backend %[req.hdr(host),lower,field(1,'.')] if host_present #      ,    default_backend default backend default mode http server no_server 127.0.0.1:65535</code> </pre><br>  Daher haben wir die Namen der Backends und URLs standardisiert, √ºber die Sie zu ihnen gelangen k√∂nnen. <br><br>  Nun kompilieren Sie aus den obigen Beispielen eine Datei: <br><br><div class="spoiler">  <b class="spoiler_title">Vollversion der Konfiguration</b> <div class="spoiler_text"><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">global</span></span> daemon maxconn 524288 nbproc 4 cpu-map 1 0 cpu-map 2 1 cpu-map 3 2 cpu-map 4 3 tune.bufsize 16384 tune.comp.maxlevel 1 tune.http.cookielen 63 tune.http.maxhdr 101 tune.maxaccept 256 tune.rcvbuf.client 33554432 tune.rcvbuf.server 33554432 tune.sndbuf.client 33554432 tune.sndbuf.server 33554432 stats socket /run/haproxy.sock mode 600 level admin log /dev/stdout local0 debug defaults mode http maxconn 524288 timeout connect 5s timeout client 10s timeout server 120s timeout client-fin 1s timeout server-fin 1s timeout http-request 10s timeout http-keep-alive 50s default-server init-addr last,libc,none log 127.0.0.1:2514 len 8192 local1 notice emerg log 127.0.0.1:2514 len 8192 local7 info log-format '{<span class="hljs-string"><span class="hljs-string">"status"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ST"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_read"</span></span>:<span class="hljs-string"><span class="hljs-string">"%B"</span></span>,<span class="hljs-string"><span class="hljs-string">"bytes_uploaded"</span></span>:<span class="hljs-string"><span class="hljs-string">"%U"</span></span>,<span class="hljs-string"><span class="hljs-string">"hostname"</span></span>:<span class="hljs-string"><span class="hljs-string">"%H"</span></span>,<span class="hljs-string"><span class="hljs-string">"method"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HM"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_uri"</span></span>:<span class="hljs-string"><span class="hljs-string">"%HU"</span></span>,<span class="hljs-string"><span class="hljs-string">"handshake_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Th"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_idle_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ti"</span></span>,<span class="hljs-string"><span class="hljs-string">"request_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%TR"</span></span>,<span class="hljs-string"><span class="hljs-string">"response_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Tr"</span></span>,<span class="hljs-string"><span class="hljs-string">"timestamp"</span></span>:<span class="hljs-string"><span class="hljs-string">"%Ts"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"%ci"</span></span>,<span class="hljs-string"><span class="hljs-string">"client_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%cp"</span></span>,<span class="hljs-string"><span class="hljs-string">"frontend_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"%fp"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_request"</span></span>:<span class="hljs-string"><span class="hljs-string">"%r"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_ciphers"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslc"</span></span>,<span class="hljs-string"><span class="hljs-string">"ssl_version"</span></span>:<span class="hljs-string"><span class="hljs-string">"%sslv"</span></span>,<span class="hljs-string"><span class="hljs-string">"date_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"%t"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_host"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(0)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_referer"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(1)]"</span></span>,<span class="hljs-string"><span class="hljs-string">"http_user_agent"</span></span>:<span class="hljs-string"><span class="hljs-string">"%[capture.req.hdr(2)]"</span></span>}' frontend http bind *:80 http-request del-header X-Forwarded-For http-request del-header X-Forwarded-Port http-request del-header X-Forwarded-Proto capture request header Host len 32 capture request header Referer len 128 capture request header User-Agent len 128 acl host_present hdr(host) -m len gt 0 use_backend %[req.hdr(host),lower,field(1,'.')] if host_present default_backend default backend default mode http server no_server 127.0.0.1:65535 resolvers dns hold valid 1s timeout retry 100ms nameserver dns1 127.0.0.1:53</code> </pre><br></div></div><br>  Vielen Dank an diejenigen, die bis zum Ende gelesen haben.  Dies ist jedoch nicht alles.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das n√§chste Mal werden</a> wir uns mit untergeordneten Dingen befassen, die mit der Optimierung des Systems selbst zusammenh√§ngen, in dem Haproxy arbeitet, damit es und sein Betriebssystem sich wohlf√ºhlen und es genug Eisen f√ºr alle gibt. <br><br>  Bis dann! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de438966/">https://habr.com/ru/post/de438966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de438956/index.html">Magnetitis in den Z√§hnen: Sequenzierung der Transkriptome des Gewebes der Muschel-Mollusken-Radula</a></li>
<li><a href="../de438958/index.html">ILV best√§tigte die Existenz seiner "Raumstation"</a></li>
<li><a href="../de438960/index.html">Wie ich Ruby zugunsten von Python aufgegeben habe, als ich an einem Backend gearbeitet habe</a></li>
<li><a href="../de438962/index.html">Zum gr√∂√üten Teil ein positiver Ausblick f√ºr die Zukunft der Chips</a></li>
<li><a href="../de438964/index.html">Wer steht wirklich hinter den beliebten kostenlosen VPNs?</a></li>
<li><a href="../de438968/index.html">Schuhe in Russland markieren: Der Markt ist noch nicht fertig, muss aber funktionieren</a></li>
<li><a href="../de438970/index.html">Haskell soll eine Sprache f√ºr Genies und Akademiker sein. Richtig?</a></li>
<li><a href="../de438972/index.html">Das Gehirn von innen (Visualisierung des Durchgangs des Musters durch das k√ºnstliche neuronale Netzwerkmodell)</a></li>
<li><a href="../de438974/index.html">Virtuelle Realit√§t hilft bei psychischen St√∂rungen</a></li>
<li><a href="../de438976/index.html">Das Buch "Fr√ºhling. Alle Designmuster ¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>