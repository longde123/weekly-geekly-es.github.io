<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕴🏾 👩🏼‍🚒 💠 Architecture d'application Exchange SPA en 2019 🛌🏽 🚄 🦆</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salutations, Khabrovites! 


 Je lis cette ressource depuis sa fondation, mais le temps d'écrire un article n'est apparu que maintenant, ce qui signif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Architecture d'application Exchange SPA en 2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450360/"><p>  Salutations, Khabrovites! </p><br><p>  Je lis cette ressource depuis sa fondation, mais le temps d'écrire un article n'est apparu que maintenant, ce qui signifie qu'il est temps de partager notre expérience avec la communauté.  Pour les développeurs débutants, j'espère que cet article contribuera à améliorer la qualité de la conception, et pour les expérimentés, il servira de liste de contrôle afin de ne pas oublier les éléments importants au stade architectural.  Pour les impatients, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dépôt</a> final et la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">démo</a> . </p><br><a name="habracut"></a><br><p>  Supposons que vous soyez dans une «entreprise de rêve» - l'un des échanges avec un libre choix de technologies et de ressources pour tout faire «comme il se doit».  Pour le moment, tout ce que la société possède est </p><br><h3>  Affectation commerciale </h3><br><p>  Développer une application SPA pour l'interface de trading, dans laquelle vous pouvez: </p><br><ul><li>  voir une liste des paires de trading regroupées par devise; </li><li>  lorsque vous cliquez sur une paire de trading pour voir les informations au cours actuel, un changement en 24 heures, un «verre d'ordres»; </li><li>  changer la langue de l'application en anglais / russe; </li><li>  changez le thème en foncé / clair. </li></ul><br><p>  La tâche est assez courte, ce qui vous permettra de vous concentrer sur l'architecture, plutôt que d'écrire de gros volumes de fonctionnalités métier.  Le résultat des efforts initiaux devrait être un code logique et réfléchi qui vous permet de procéder directement à la mise en œuvre de la logique métier. </p><br><p>  Puisqu'il n'y a aucune exigence technique dans l'énoncé de travail du client, laissez-le être à l'aise pour le développement: </p><br><ul><li>  <b>compatibilité entre navigateurs</b> : 2 dernières versions de navigateurs populaires (sans IE); </li><li>  <b>largeur de l'écran</b> :&gt; = 1240px; </li><li>  <b>conception</b> : par analogie avec d'autres échanges, comme  Le designer n'a pas encore été embauché. </li></ul><br><p>  Il est maintenant temps de déterminer quels outils et bibliothèques sont utilisés.  Je serai guidé par les principes du développement "clé en main" et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">KISS</a> , c'est-à-dire que je ne prendrai que les bibliothèques opensource qui nécessiteraient un temps insuffisant pour une mise en œuvre indépendante, y compris le temps de former les futurs collègues développeurs. </p><br><ul><li>  <b>système de contrôle de version</b> : Git + Github; </li><li>  <b>backend</b> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API</a> CoinGecko; </li><li>  <b>montage / transport</b> : Webpack + Babel; </li><li>  <b>installateur de packages</b> : Yarn (npm 6 dépendances incorrectement mises à jour); </li><li>  <b>contrôle de la qualité du code</b> : ESLint + Prettier + Stylelint; </li><li>  <b>vue</b> : Réagissez (voyons à quel point les crochets sont pratiques); </li><li>  <b>magasin</b> : MobX; </li><li>  <b>autotests</b> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cypress.io</a> (une solution javascript complète au lieu d'un assemblage modulaire comme Mocha / Karma + Chai + Sinon + Selenium + Webdriver / Protractor); </li><li>  <b>styles</b> : SCSS via PostCSS (flexibilité de configuration, amis avec Stylelint); </li><li>  <b>graphiques</b> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighStock</a> (la configuration est beaucoup plus facile que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TradingView</a> , mais pour une application réelle, je prendrais ce dernier); </li><li>  rapport d' <b>erreur</b> : Sentry; </li><li>  <b>Utilitaires</b> : Lodash (gain de temps); </li><li>  <b>routage</b> : clé en main; </li><li>  <b>localisation</b> : clé en main; </li><li>  <b>travailler avec des demandes</b> : clé en main; </li><li>  <b>mesures de performance</b> : clé en main; </li><li>  <b>typification</b> : pas à mon quart de travail. </li></ul><br><p>  Ainsi, seuls React, MobX, HighStock, Lodash et Sentry proviendront des bibliothèques du fichier d'application final.  Je pense que cela est justifié, car ils ont une excellente documentation, des performances et sont familiers à de nombreux développeurs. </p><br><h3>  Contrôle qualité du code </h3><br><p>  Je préfère diviser les dépendances dans <i>package.json</i> en parties sémantiques, donc la première étape après avoir lancé le référentiel git est de regrouper tout ce qui concerne le style de code dans le dossier <i>./eslint-custom</i> , en spécifiant dans <i>package.json</i> : </p><br><pre><code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"upd"</span></span>: <span class="hljs-string"><span class="hljs-string">"yarn install --no-lockfile"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"eslint-custom"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:./eslint-custom"</span></span> } }</code> </pre> <br><p>  L' <code>yarn install</code> normale de <code>yarn install</code> ne vérifiera pas si les dépendances dans <i>eslint-custom</i> ont changé, donc j'utiliserai la mise <code>yarn upd</code> .  En général, cette pratique semble plus universelle, car les développeurs n'auront pas à modifier la recette de déploiement si les développeurs doivent changer la méthode d'installation des packages. </p><br><p>  Il n'y a aucun intérêt à utiliser le <i>fichier</i> yarn.lock, car toutes les dépendances seront sans "couvertures" (sous la forme de <code>"react": "16.8.6"</code> ).  L'expérience a montré qu'il vaut mieux mettre à jour manuellement les versions et les tester soigneusement dans le cadre de tâches individuelles que de s'appuyer sur un fichier de verrouillage, donnant aux auteurs de packages la possibilité de casser l'application avec une mise à jour mineure à tout moment (les chanceux qui ne l'ont pas rencontré). </p><br><p>  Le <i>package eslint-custom</i> aura les dépendances suivantes: </p><br><div class="spoiler">  <b class="spoiler_title">eslint-custom / package.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"eslint-custom"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Custom linter rules for this project"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"MIT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"babel-eslint"</span></span>: <span class="hljs-string"><span class="hljs-string">"10.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.16.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-config-prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"4.1.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-plugin-import"</span></span>: <span class="hljs-string"><span class="hljs-string">"2.17.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-plugin-prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-plugin-react"</span></span>: <span class="hljs-string"><span class="hljs-string">"7.12.4"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"eslint-plugin-react-hooks"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.6.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.17.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"prettier-eslint"</span></span>: <span class="hljs-string"><span class="hljs-string">"8.8.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stylelint"</span></span>: <span class="hljs-string"><span class="hljs-string">"10.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stylelint-config-prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.1.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stylelint-prettier"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stylelint-scss"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.6.0"</span></span> } }</code> </pre></div></div><br><p>  Pour connecter les trois outils, il a fallu 5 packages auxiliaires ( <i>eslint-plugin-prettier, eslint-config-prettier, stylelint-prettier, stylelint-config-prettier, prettier-eslint</i> ) - vous devez payer un tel prix aujourd'hui.  Pour une commodité maximale, seul le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tri</a> automatique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des importations n'est</a> pas suffisant, mais, malheureusement, ce plugin perd des lignes lors du reformatage d'un fichier. </p><br><p>  Les fichiers de configuration pour tous les outils seront au format <i>* .js</i> ( <i>eslint.config.js</i> , <i>stylelint.config.js</i> ) afin que la mise en forme du code fonctionne sur eux.  Les règles peuvent être au format <i>* .yaml</i> , ventilées par modules sémantiques.  Les versions complètes des configurations et des règles se trouvent dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">référentiel</a> . </p><br><p>  Il reste à ajouter les commandes dans le <i>package</i> principal.json ... </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"upd"</span></span>: <span class="hljs-string"><span class="hljs-string">"yarn install --no-lockfile"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"format:js"</span></span>: <span class="hljs-string"><span class="hljs-string">"eslint --ignore-path .gitignore --ext .js -c ./eslint-custom/eslint.config.js --fix"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"format:style"</span></span>: <span class="hljs-string"><span class="hljs-string">"stylelint --ignore-path .gitignore --config ./eslint-custom/stylelint.config.js --fix"</span></span> } }</code> </pre><br><p>  ... et configurez votre IDE pour appliquer le formatage lors de l'enregistrement du fichier actuel.  Pour garantir cela, lors de la création d'un commit, vous devez utiliser un hook git qui vérifiera et formatera tous les fichiers du projet.  Pourquoi pas seulement ceux qui sont présents dans le commit?  Pour le principe de responsabilité collective pour l'ensemble de la base de code, afin que personne ne soit tenté de contourner la validation.  Pour ce faire, lors de la création d'une validation, tous les avertissements de linter seront considérés comme des erreurs en utilisant <code>--max-warnings=0</code> . </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"husky"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hooks"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"pre-commit"</span></span>: <span class="hljs-string"><span class="hljs-string">"npm run format:js -- --max-warnings=0 ./ &amp;&amp; npm run format:style ./**/*.scss"</span></span> } } }</code> </pre><br><h3>  Assemblage / Transport </h3><br><p>  Encore une fois, je vais utiliser l'approche modulaire et supprimer tous les paramètres de Webpack et Babel dans le dossier ./webpack-custom.  La configuration s'appuiera sur la structure de fichiers suivante: </p><br><pre> <code class="pgsql hljs">. |<span class="hljs-comment"><span class="hljs-comment">-- webpack-custom | |-- config | |-- loaders | |-- plugins | |-- rules | |-- utils | `-- package.json | `-- webpack.config.js</span></span></code> </pre><br><p>  Un constructeur correctement configuré fournira: </p><br><ul><li>  la capacité d'écrire du code en utilisant la syntaxe et les capacités de la dernière spécification EcmaScript, y compris des propositions pratiques (les décorateurs de classe et leurs propriétés pour MobX sont certainement utiles ici); </li><li>  serveur local avec rechargement à chaud; </li><li>  mesures des performances de l'assemblage; </li><li>  vérification des dépendances cycliques; </li><li>  analyse de la structure et de la taille du fichier résultant; </li><li>  optimisation et minification pour l'assemblage de production; </li><li>  interprétation des fichiers <i>* .scss</i> modulaires et possibilité de <i>supprimer</i> <i>les</i> fichiers <i>* .css</i> terminés d'un ensemble; </li><li>  fichiers <i>insérés en</i> ligne <i>* .svg</i> ; </li><li>  préfixes polyfill / style pour les navigateurs cibles; </li><li>  résoudre le problème de la mise en cache des fichiers en production. </li></ul><br><p>  Il sera également configuré de manière pratique.  Je vais résoudre ce problème à l'aide de deux <i>exemples de</i> fichiers <i>* .env</i> : </p><br><div class="spoiler">  <b class="spoiler_title">.frontend.env.example</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">AGGREGATION_TIMEOUT=0 BUNDLE_ANALYZER=false BUNDLE_ANALYZER_PORT=8889 CIRCULAR_CHECK=true CSS_EXTRACT=false DEV_SERVER_PORT=8080 HOT_RELOAD=true NODE_ENV=development SENTRY_URL=false SPEED_ANALYZER=false PUBLIC_URL=false # https://webpack.js.org/configuration/devtool DEV_TOOL=cheap-module-source-map</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">.frontend.env.prod.example</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">AGGREGATION_TIMEOUT=0 BUNDLE_ANALYZER=false BUNDLE_ANALYZER_PORT=8889 CIRCULAR_CHECK=false CSS_EXTRACT=true DEV_SERVER_PORT=8080 HOT_RELOAD=false NODE_ENV=production SENTRY_URL=false SPEED_ANALYZER=false PUBLIC_URL=/exchange_habr/dist # https://webpack.js.org/configuration/devtool DEV_TOOL=false</code> </pre></div></div><br><p>  Ainsi, pour démarrer l'assemblage, vous devez créer un fichier avec le nom <i>.frontend.env</i> et la présence obligatoire de tous les paramètres.  Cette approche résoudra plusieurs problèmes à la fois: pas besoin de créer des fichiers de configuration séparés pour Webpack et de maintenir leur cohérence;  localement, vous pouvez configurer combien un développeur particulier en a besoin;  les développeurs de déploiement copient uniquement le fichier de l'assemblage de production ( <code>cp .frontend.env.prod.example .frontend.env</code> ), enrichissant les valeurs du référentiel, les développeurs frontaux ont donc la possibilité de gérer la recette via des variables sans utiliser d'administrateurs.  De plus, il sera possible de faire un exemple de configuration pour les stands (par exemple, avec des cartes sources). </p><br><p>  Pour séparer les styles en fichiers avec <i>CSS_EXTRACT</i> activé, <i>j'utiliserai</i> le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin mini-css-extract-</a> il vous permet d'utiliser le rechargement à chaud.  Autrement dit, si vous activez <i>HOT_RELOAD</i> et <i>CSS_EXTRACT</i> pour le développement local, puis avec <br>  seuls les styles seront rechargés lors de la modification des fichiers de styles - mais, malheureusement, tout, pas seulement le fichier modifié.  Avec <i>CSS_EXTRACT</i> désactivé, seul le module de style modifié sera mis à jour. </p><br><p>  HMR pour travailler avec React Hooks est inclus assez standard: </p><br><ul><li>  <code>webpack.HotModuleReplacementPlugin</code> dans les plugins; </li><li>  <code>hot: true</code> dans les paramètres <i>webpack-dev-server</i> ; </li><li>  <code>react-hot-loader/babel</code> dans les plugins <i>babel-loader</i> ; </li><li>  <code>options.hmr: true</code> dans <i>mini-css-extract-plugin</i> ; </li><li>  <code>export default hot(App)</code> dans le composant principal de l'application; </li><li>  <i>@ hot-loader / react-dom</i> au lieu du <i>react-dom</i> habituel (commodément via <code>resolve.alias: { 'react-dom': '@hot-loader/react-dom' }</code> ); </li></ul><br><p>  La version actuelle de <i>react-hot-loader</i> ne prend pas en charge la mémorisation de composants à l'aide de <code>React.memo</code> , donc lors de l'écriture de décorateurs pour MobX, vous devrez en tenir compte pour la commodité du développement local.  Un autre inconvénient causé par cela est que lorsque <i>Highlight Updates</i> est activé dans React Developer Tools, tous les composants sont mis à jour lors de toute interaction avec l'application.  Par conséquent, lorsque vous travaillez localement sur l'optimisation des performances, le paramètre <i>HOT_RELOAD</i> doit être désactivé. </p><br><p>  L'optimisation de build dans Webpack 4 est effectuée automatiquement lorsque le <code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mode</a> : 'development' | 'production'</code>  <code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mode</a> : 'development' | 'production'</code> .  Dans ce cas, je me fie à l'optimisation standard (+ inclusion du paramètre <code>keep_fnames: true</code> dans le <i>plugin terser-webpack-</i> pour enregistrer le nom des composants), car il est déjà bien réglé. </p><br><p>  La séparation des morceaux et le contrôle de la mise en cache du client méritent une attention particulière.  Pour un fonctionnement correct, vous avez besoin de: </p><br><ul><li>  dans output.filename pour les fichiers js et css, spécifiez <code>isProduction ? '[name].[contenthash].js' : '[name].js'</code>  <code>isProduction ? '[name].[contenthash].js' : '[name].js'</code> (avec l'extension .css respectivement) afin que le nom du fichier soit basé sur son contenu; </li><li>  dans l'optimisation, changez les paramètres en <code>chunkIds: 'named', moduleIds: 'hashed'</code> afin que le compteur de module interne dans webpack ne change pas; </li><li>  mettre le runtime dans un bloc séparé; </li><li>  déplacer les groupes de cache vers splitChunks (quatre points suffisent pour cette application - lodash, sentinelle, highcharts et vendeur pour les autres dépendances de <i>node_modules</i> ).  Étant donné que les trois premiers seront rarement mis à jour, ils resteront dans le cache du navigateur du client aussi longtemps que possible. </li></ul><br><div class="spoiler">  <b class="spoiler_title">webpack-custom / config / configOptimization.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/** * @docs: https://webpack.js.org/configuration/optimization * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TerserPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'terser-webpack-plugin'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">runtimeChunk</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'runtime'</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">chunkIds</span></span>: <span class="hljs-string"><span class="hljs-string">'named'</span></span>, <span class="hljs-attr"><span class="hljs-attr">moduleIds</span></span>: <span class="hljs-string"><span class="hljs-string">'hashed'</span></span>, <span class="hljs-attr"><span class="hljs-attr">mergeDuplicateChunks</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">splitChunks</span></span>: { <span class="hljs-attr"><span class="hljs-attr">cacheGroups</span></span>: { <span class="hljs-attr"><span class="hljs-attr">lodash</span></span>: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules\\lodash'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">sentry</span></span>: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules\\@sentry'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'sentry'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">highcharts</span></span>: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules\\highcharts'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'highcharts'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">vendor</span></span>: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">priority</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'vendor'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, }, }, <span class="hljs-attr"><span class="hljs-attr">minimizer</span></span>: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TerserPlugin({ <span class="hljs-attr"><span class="hljs-attr">terserOptions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">keep_fnames</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, }), ], };</code> </pre></div></div><br><p>  Pour accélérer l'assemblage dans ce projet, j'utilise un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chargeur de threads</a> - lorsqu'il est parallélisé à 4 processus, il a donné une accélération de 90% à l'assemblage, ce qui est mieux que happypack avec les mêmes paramètres. </p><br><p>  Les paramètres pour les chargeurs, y compris pour babel, dans des fichiers séparés (comme <i>.babelrc</i> ) à <i>éteindre</i> , je pense, ne sont pas nécessaires.  Mais la configuration multi-navigateur est plus pratique à conserver dans le paramètre Browserslist du <i>package.json</i> principal, car il est également utilisé pour les styles de préfixe automatique. </p><br><p>  Pour la commodité de travailler avec Prettier, j'ai créé le paramètre <i>AGGREGATION_TIMEOUT</i> , qui vous permet de définir le délai entre la détection des changements dans les fichiers et la reconstruction de l'application en mode dev-server.  Puisque j'ai configuré le reformatage des fichiers lors de l'enregistrement dans l'IDE, cela provoque 2 reconstructions - la première pour enregistrer le fichier d'origine, la seconde pour terminer le formatage.  2000 millisecondes suffisent généralement au webpack pour attendre la version finale du fichier. </p><br><p>  Le reste de la configuration ne mérite pas une attention particulière, car il est divulgué dans des centaines de supports de formation pour les débutants, vous pouvez donc procéder à la conception de l'architecture de l'application. </p><br><h3>  Thèmes de style </h3><br><p>  Auparavant, pour créer des thèmes, vous deviez créer plusieurs versions des fichiers <i>* .css</i> et recharger la page lors du changement de thème, en chargeant le jeu de styles souhaité.  Maintenant, tout est facilement résolu en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des propriétés CSS personnalisées</a> .  Cette technologie est prise en charge par tous les navigateurs cibles de l'application actuelle, mais il existe également des polyfills pour IE. </p><br><p>  Disons qu'il y a 2 thèmes - clair et foncé, dont les jeux de couleurs seront </p><br><div class="spoiler">  <b class="spoiler_title">styles / themes.scss</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">.light { --n0: rgb(255, 255, 255); --n100: rgb(186, 186, 186); --n10: rgb(249, 249, 249); --n10a3: rgba(249, 249, 249, 0.3); --n20: rgb(245, 245, 245); --n30: rgb(221, 221, 221); --n500: rgb(136, 136, 136); --n600: rgb(102, 102, 102); --n900: rgb(0, 0, 0); --b100: rgb(219, 237, 251); --b300: rgb(179, 214, 252); --b500: rgb(14, 123, 249); --b500a3: rgba(14, 123, 249, 0.3); --b900: rgb(32, 39, 57); --g400: rgb(71, 215, 141); --g500: rgb(61, 189, 125); --g500a1: rgba(61, 189, 125, 0.1); --g500a2: rgba(61, 189, 125, 0.2); --r400: rgb(255, 100, 100); --r500: rgb(255, 0, 0); --r500a1: rgba(255, 0, 0, 0.1); --r500a2: rgba(255, 0, 0, 0.2); } .dark { --n0: rgb(25, 32, 48); --n100: rgb(114, 126, 151); --n10: rgb(39, 46, 62); --n10a3: rgba(39, 46, 62, 0.3); --n20: rgb(25, 44, 74); --n30: rgb(67, 75, 111); --n500: rgb(117, 128, 154); --n600: rgb(255, 255, 255); --n900: rgb(255, 255, 255); --b100: rgb(219, 237, 251); --b300: rgb(39, 46, 62); --b500: rgb(14, 123, 249); --b500a3: rgba(14, 123, 249, 0.3); --b900: rgb(32, 39, 57); --g400: rgb(0, 220, 103); --g500: rgb(0, 197, 96); --g500a1: rgba(0, 197, 96, 0.1); --g500a2: rgba(0, 197, 96, 0.2); --r400: rgb(248, 23, 1); --r500: rgb(221, 23, 1); --r500a1: rgba(221, 23, 1, 0.1); --r500a2: rgba(221, 23, 1, 0.2); }</code> </pre></div></div><br><p>  Pour que ces variables soient appliquées globalement, elles doivent être écrites dans <code>document.documentElement</code> , respectivement, un petit analyseur est nécessaire pour convertir ce fichier en objet javascript.  Plus tard, je vous dirai pourquoi c'est plus pratique que de le stocker immédiatement en javascript. </p><br><div class="spoiler">  <b class="spoiler_title">webpack-custom / utils / sassVariablesLoader.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertSourceToJsObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">source</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themesObject = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fullThemesArray = source.match(<span class="hljs-regexp"><span class="hljs-regexp">/\.([^}]|\s)*}/g</span></span>) || []; fullThemesArray.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fullThemeStr</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> theme = fullThemeStr .match(<span class="hljs-regexp"><span class="hljs-regexp">/\.\w+\s{/g</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\W/g</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); themesObject[theme] = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> variablesMatches = fullThemeStr.match(<span class="hljs-regexp"><span class="hljs-regexp">/--(.*:[^;]*)/g</span></span>) || []; variablesMatches.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">varMatch</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [key, value] = varMatch.split(<span class="hljs-string"><span class="hljs-string">': '</span></span>); themesObject[theme][key] = value; }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> themesObject; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkThemesEquality</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">themes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themesArray = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(themes); themesArray.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">themeStr</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themeObject = themes[themeStr]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> otherThemesArray = themesArray.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> t !== themeStr); <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(themeObject).forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">variableName</span></span></span><span class="hljs-function"> =&gt;</span></span> { otherThemesArray.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">otherThemeStr</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> otherThemeObject = themes[otherThemeStr]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!otherThemeObject[variableName]) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>( <span class="hljs-string"><span class="hljs-string">`checkThemesEquality: theme </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${otherThemeStr}</span></span></span><span class="hljs-string"> has no variable </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${variableName}</span></span></span><span class="hljs-string">`</span></span> ); } }); }); }); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sassVariablesLoader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">source</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themes = convertSourceToJsObject(source); checkThemesEquality(themes); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`module.exports = </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">JSON</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.stringify(themes)}</span></span></span><span class="hljs-string">`</span></span>; };</code> </pre></div></div><br><p>  Ici, la cohérence est vérifiée par cela - c'est-à-dire la correspondance complète de l'ensemble de variables, avec la différence de laquelle l'assemblage tombe. </p><br><p>  Lorsque vous utilisez ce chargeur, un assez bel objet avec des paramètres est obtenu, et quelques lignes pour l'utilitaire de changement de thème suffisent: </p><br><div class="spoiler">  <b class="spoiler_title">src / utils / setTheme.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> themes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'styles/themes.scss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> root = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.documentElement; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setTheme</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">theme</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(themes[theme]).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[key, value]</span></span></span><span class="hljs-function">) =&gt;</span></span> { root.style.setProperty(key, value); }); }</code> </pre></div></div><br><p>  Je préfère traduire ces variables css en variables standard pour <i>* .scss</i> : </p><br><div class="spoiler">  <b class="spoiler_title">src / styles / constants.scss</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/py/b5/jf/pyb5jfs2g07r-ypnnkoudkdxe7s.png"><br></div></div><br><p>  L'IDE WebStorm, comme le montre la capture d'écran, affiche les couleurs dans le panneau de gauche et en cliquant sur la couleur, une palette s'ouvre où vous pouvez la modifier.  La nouvelle couleur est automatiquement substituée dans <i>themes.scss</i> , Hot Reload fonctionnera et l'application sera instantanément transformée.  C'est exactement le niveau de commodité de développement attendu en 2019. </p><br><h3>  Principes d'organisation du code </h3><br><p>  Dans ce projet, je m'en tiendrai aux noms de dossier en double pour les composants, les fichiers et les styles, par exemple: </p><p></p><pre> <code class="pgsql hljs">. |<span class="hljs-comment"><span class="hljs-comment">-- components | |-- Chart | | `-- Chart.js | | `-- Chart.scss | | `-- package.json</span></span></code> </pre><br><p>  En conséquence, <i>package.json</i> aura le contenu <code>{ "main": "Chart.js" }</code> .  Pour les composants avec plusieurs exportations nommées (par exemple, les utilitaires), le nom du fichier principal commencera par un trait de soulignement: </p><br><pre> <code class="pgsql hljs">. |<span class="hljs-comment"><span class="hljs-comment">-- utils | `-- _utils.js | `-- someUtil.js | `-- anotherUtil.js | `-- package.json</span></span></code> </pre><br><p>  Et le reste des fichiers sera exporté en tant que: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./someUtil'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./anotherUtil'</span></span>;</code> </pre><br><p>  Cela vous permettra de vous débarrasser des noms de fichiers en double afin de ne pas vous perdre dans les dix premiers <i>index.js</i> / <i>style.scss ouverts</i> .  Vous pouvez résoudre ce problème avec les plugins IDE, mais pourquoi pas de manière universelle. </p><br><p>  Je vais regrouper les composants page par page, à l'exception des composants généraux comme Message / Lien, et aussi, si possible, utiliser des exportations nommées (sans <code>export default</code> ) pour maintenir l'uniformité des noms, la facilité de refactorisation et la recherche de projet. </p><br><h3>  Configurer le rendu et le stockage MobX </h3><br><p>  Le fichier qui sert de point d'entrée pour Webpack ressemblera à ceci: </p><br><div class="spoiler">  <b class="spoiler_title">src / app.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./polyfill'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./styles/reset.scss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./styles/global.scss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { initSentry, renderToDOM } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { initAutorun } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./autorun'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { store } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'stores'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> App <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'components/App'</span></span>; initSentry(); initAutorun(store); renderToDOM(App);</code> </pre></div></div><br><p>  Puisque lorsque vous travaillez avec des observables, la console affiche quelque chose comme <code>Proxy {0: "btc", 1: "eth", 2: "usd", 3: "test", Symbol(mobx administration): ObservableArrayAdministration}</code> , en polyfills Je vais faire un utilitaire de standardisation: </p><br><div class="spoiler">  <b class="spoiler_title">src / polyfill.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { toJS } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.js = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consoleJsCustom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(...args.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arg</span></span></span><span class="hljs-function"> =&gt;</span></span> toJS(arg))); };</code> </pre></div></div><br><p>  De plus, les styles globaux et la normalisation des styles pour différents navigateurs sont connectés dans le fichier principal, s'il existe une clé pour Sentry dans .env.fr, les erreurs commencent à se connecter, le stockage MobX est créé, le suivi des changements de paramètres avec l'exécution automatique est <i>lancé et le</i> composant enveloppé dans <i>react-hot-loader</i> est monté dans le DOM. </p><br><p>  Le référentiel lui-même sera une classe non observable dont les paramètres sont des classes non observables avec des paramètres observables.  Ainsi, il est entendu que l'ensemble des paramètres ne sera pas dynamique - par conséquent, l'application sera plus prévisible.  C'est l'un des rares endroits où JSDoc est utile pour activer l'auto-complétion dans l'EDI. </p><br><div class="spoiler">  <b class="spoiler_title">src / stores / RootStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { I18nStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./I18nStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { RatesStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RatesStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { GlobalStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./GlobalStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { RouterStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RouterStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { CurrentTPStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./CurrentTPStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { MarketsListStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./MarketsListStore'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * @name RootStore */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RootStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i18n = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> I18nStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rates = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RatesStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.global = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GlobalStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouterStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentTP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrentTPStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.marketsList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MarketsListStore(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre></div></div><br><p>  Un exemple de magasin MobX peut être analysé à l'aide de l'exemple de GlobalStore, qui n'aura pour le moment que le but - de stocker et de définir le thème de style actuel. </p><br><div class="spoiler">  <b class="spoiler_title">src / stores / GlobalStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable, setTheme } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> themes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'styles/themes.scss'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> themesList = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(themes); @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GlobalStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; setTheme(themesList[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } themesList = themesList; currentTheme = <span class="hljs-string"><span class="hljs-string">''</span></span>; setTheme(theme) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentTheme = theme; setTheme(theme); } }</code> </pre></div></div><br><p>  Parfois, les paramètres et la méthode de la classe définissent manuellement le type à l'aide de décorateurs, par exemple: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GlobalStore</span></span></span><span class="hljs-class"> </span></span>{ @observable currentTheme = <span class="hljs-string"><span class="hljs-string">''</span></span>; @action.bound setTheme(theme) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentTheme = theme; setTheme(theme); } }</code> </pre><br><p>  Mais je ne vois aucun intérêt à cela, car les anciens décorateurs de classe de proposition prennent en charge leur transformation automatique, l'utilitaire suivant suffit donc: </p><br><div class="spoiler">  <b class="spoiler_title">src / utils / makeObservable.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { action, computed, decorate, observable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeObservable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *   -   this +    *     * *   -   computed * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> classPrototype = target.prototype; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> methodsAndGetters = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyNames(classPrototype).filter( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">methodName</span></span></span><span class="hljs-function"> =&gt;</span></span> methodName !== <span class="hljs-string"><span class="hljs-string">'constructor'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> methodName <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> methodsAndGetters) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> descriptor = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyDescriptor( classPrototype, methodName ); descriptor.value = decorate(classPrototype, { [methodName]: <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> descriptor.value === <span class="hljs-string"><span class="hljs-string">'function'</span></span> ? action.bound : computed, }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...constructorArguments</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">/** * ,   rootStore,   * observable * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> target(...constructorArguments); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> staticProperties = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(store); staticProperties.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">propName</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (propName === <span class="hljs-string"><span class="hljs-string">'rootStore'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> descriptor = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyDescriptor(store, propName); <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty( store, propName, observable(store, propName, descriptor) ); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> store; }; }</code> </pre></div></div><br><p>  Pour l'utiliser, vous devez ajuster les plugins dans <i>loaderBabel.js</i> : <code>['@babel/plugin-proposal-decorators', { legacy: true }], ['@babel/plugin-proposal-class-properties', { loose: true }]</code> , et dans les paramètres ESLint, définissez <code>parserOptions.ecmaFeatures.legacyDecorators: true</code> conséquence.  Sans ces paramètres, seul le descripteur de classe sans prototype est transmis au décorateur cible, et malgré des recherches minutieuses de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version actuelle de Proposition</a> , je n'ai pas trouvé de moyen d'envelopper les méthodes et les propriétés statiques. </p><br><p>  En général, la configuration du stockage est terminée, mais il serait bien de libérer le potentiel de l'exécution automatique de MobX.  À cet effet, les tâches comme «attendre une réponse du serveur d'autorisation» ou «télécharger les traductions du serveur», puis écrire les réponses sur le serveur et rendre directement l'application dans le DOM, sont les mieux adaptées.  Par conséquent, je vais courir un peu dans le futur et créer un magasin avec localisation: </p><br><div class="spoiler">  <b class="spoiler_title">src / stores / I18nStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ru <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'localization/ru.json'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> en <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'localization/en.json'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> languages = { ru, en, }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> languagesList = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(languages); @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">I18nStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setLocalization(<span class="hljs-string"><span class="hljs-string">'ru'</span></span>); }, <span class="hljs-number"><span class="hljs-number">500</span></span>); } i18n = {}; languagesList = languagesList; currentLanguage = <span class="hljs-string"><span class="hljs-string">''</span></span>; setLocalization(language) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentLanguage = language; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i18n = languages[language]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore.global.shouldAppRender = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre></div></div><br><p>  Comme vous pouvez le voir, il existe des fichiers <i>* .json</i> avec des traductions, et le chargement asynchrone utilisant setTimeout est émulé dans le constructeur de classe.  Lorsqu'il est exécuté, le GlobalStore récemment créé est marqué avec <code>this.rootStore.global.shouldAppRender = true</code> . </p><br><p>  Ainsi, depuis <i>app.js,</i> vous devez transférer la fonction de rendu dans le fichier <i>autorun.js</i> : </p><br><div class="spoiler">  <b class="spoiler_title">src / autorun.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* eslint-disable no-unused-vars */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { autorun } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { renderToDOM } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> App <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'components/App'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> loggingEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logReason</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">autorunName, reaction</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!loggingEnabled || reaction.observing.length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> logString = reaction.observing.reduce( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str, { name, value }</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${str}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${name}</span></span></span><span class="hljs-string"> changed to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${value}</span></span></span><span class="hljs-string">; `</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span> ); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`autorun-</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${autorunName}</span></span></span><span class="hljs-string">`</span></span>, logString); } <span class="hljs-comment"><span class="hljs-comment">/** * @param store {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initAutorun</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">store</span></span></span><span class="hljs-function">) </span></span>{ autorun(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">reaction</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (store.global.shouldAppRender) { renderToDOM(App); } logReason(<span class="hljs-string"><span class="hljs-string">'shouldAppRender'</span></span>, reaction); }); }</code> </pre></div></div><br><p>  Dans la fonction <i>initAutorun</i> , <i>il</i> peut <i>y</i> avoir un certain nombre de constructions à <i>exécution</i> <i>automatique</i> avec des rappels qui ne fonctionneront que lorsqu'elles initieront et modifieront elles-mêmes une variable à l'intérieur d'un rappel particulier.  Dans ce cas, <code>autorun-shouldAppRender GlobalStore@3.shouldAppRender changed to true;</code>  et a provoqué le rendu de l'application dans le DOM.  Un outil puissant qui vous permet d'enregistrer toutes les modifications dans le magasin et d'y répondre en conséquence. </p><br><h3>  Localisation et réactivité des crochets </h3><br><p>  La traduction dans d'autres langues est l'une des tâches les plus volumineuses, dans les petites entreprises, elle est souvent sous-estimée des dizaines de fois, et dans les grandes entreprises, elle est inutilement trop compliquée.  En fonction de sa mise en œuvre, combien de nerfs et de temps ne seront pas perdus à la fois dans plusieurs départements de l'entreprise.  Je ne mentionnerai dans l'article que la partie client avec un backlog pour une future intégration avec d'autres systèmes. </p><br><p>  Pour la commodité du développement frontal, vous devez être capable de: </p><br><ul><li>  définir des noms sémantiques pour les constantes; </li><li>  Insérer des variables dynamiques </li><li>  indiquer singulier / pluriel; </li><li>      —   -; </li><li>         ; </li><li>       /  ; </li><li>  ; </li><li> ()   ; </li><li> ()         ,         . </li></ul><br><p>    ,  ,  :         <i>messages.js</i>      (      )      .         .             (     / ),    .    ( , , )  .   . </p><br><p>       ,    <i>currentLanguage</i>   <i>i18n</i>    ,   ,     . </p><br><div class="spoiler"> <b class="spoiler_title">src/components/TestLocalization.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useLocalization } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> messages = { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'  {count} {count: ,,}'</span></span>, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestLocalization</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getLn = useLocalization(__filename, messages); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{getLn(messages.hello, { count: 1 })}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TestLocalizationConnected = observer(TestLocalization);</code> </pre></div></div><br><p>        ,       MobX-     ,  , Connected. ,       ESLint,       . </p><br><p>  observer     <code>mobx-react-lite/useObserver</code> ,    <i>HOT_RELOAD</i>      <i>React.memo</i> (  <i>PureMixin</i> / <i>PureComponent</i> ),       <i>useObserver</i>   : </p><br><div class="spoiler"> <b class="spoiler_title">src/utils/observer.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useObserver } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mobx-react-lite'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copyStaticProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">base, target</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> hoistBlackList = { <span class="hljs-attr"><span class="hljs-attr">$$typeof</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">render</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">compare</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(base).forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (base.hasOwnProperty(key) &amp;&amp; !hoistBlackList[key]) { <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty( target, key, <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.getOwnPropertyDescriptor(base, key) ); } }); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">observer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">baseComponent, options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> baseComponentName = baseComponent.displayName || baseComponent.name; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrappedComponent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props, ref</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> useObserver(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyObserver</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> baseComponent(props, ref); }, baseComponentName); } wrappedComponent.displayName = baseComponentName; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> memoComponent = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HOT_RELOAD === <span class="hljs-string"><span class="hljs-string">'true'</span></span>) { memoComponent = wrappedComponent; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (options.forwardRef) { memoComponent = React.memo(React.forwardRef(wrappedComponent)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { memoComponent = React.memo(wrappedComponent); } copyStaticProperties(baseComponent, memoComponent); memoComponent.displayName = baseComponentName; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> memoComponent; }</code> </pre></div></div><br><p>     <code>displayName</code>   ,   React-     ( stack trace   ). </p><br><p>      RootStore: </p><br><div class="spoiler"> <b class="spoiler_title">src/hooks/useStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { store } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'stores'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> storeContext = React.createContext(store); <span class="hljs-comment"><span class="hljs-comment">/** * @returns {RootStore} * */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">useStore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> React.useContext(storeContext); }</code> </pre></div></div><br><p>       ,   observer: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestComponent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = useStore(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{store.i18n.currentLanguage}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TestComponentConnected = observer(TestComponent);</code> </pre><br><p>      TestLocalization —     useLocalization: </p><br><div class="spoiler"> <b class="spoiler_title">src/hooks/useLocalization.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { declOfNum } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./useStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> showNoTextMessage = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceDynamicParams</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">values, formattedMessage</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_.isPlainObject(values)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> formattedMessage; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> messageWithValues = formattedMessage; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(values).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[paramName, value]</span></span></span><span class="hljs-function">) =&gt;</span></span> { messageWithValues = formattedMessage.replace(<span class="hljs-string"><span class="hljs-string">`{</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-string">}`</span></span>, value); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> messageWithValues; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacePlurals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">values, formattedMessage</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_.isPlainObject(values)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> formattedMessage; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> messageWithPlurals = formattedMessage; <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(values).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[paramName, value]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pluralPattern = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(<span class="hljs-string"><span class="hljs-string">`{</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-string">:\\s([^}]*)}`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pluralMatch = formattedMessage.match(pluralPattern); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pluralMatch &amp;&amp; pluralMatch[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { messageWithPlurals = formattedMessage.replace( pluralPattern, declOfNum(value, pluralMatch[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">','</span></span>)) ); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> messageWithPlurals; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">useLocalization</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">filename, messages</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-attr"><span class="hljs-attr">i18n</span></span>: { i18n, currentLanguage }, } = useStore(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text, values</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> key = _.findKey(messages, message =&gt; message === text); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> localizedText = _.get(i18n, [filename, key]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!localizedText &amp;&amp; showNoTextMessage) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error( <span class="hljs-string"><span class="hljs-string">`useLocalization: no localization for lang '</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${currentLanguage}</span></span></span><span class="hljs-string">' in </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${filename}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${key}</span></span></span><span class="hljs-string">`</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> formattedMessage = localizedText || text; formattedMessage = replaceDynamicParams(values, formattedMessage); formattedMessage = replacePlurals(values, formattedMessage); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> formattedMessage; }; }</code> </pre></div></div><br><p>  <i>replaceDynamicParams</i>  <i>replacePlurals</i>     —            , ,    , ,  ,      .. </p><br><p>         Webpack — <i>__filename</i> —    ,   ,       .         ,       —        ,       ,     .     ,     : </p><br><pre> <code class="javascript hljs">useLocalization: no localization <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> lang <span class="hljs-string"><span class="hljs-string">'ru'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> src\components\TestLocalization\TestLocalization.js hello</code> </pre><br><p>         <i>ru.json</i> : </p><br><div class="spoiler"> <b class="spoiler_title">src/localization/ru.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"src\\components\\TestLocalization\\TestLocalization.js"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"hello"</span></span>: <span class="hljs-string"><span class="hljs-string">"  {count} {count: ,,}"</span></span> } }</code> </pre></div></div><br><p>   ,   .      <i>src/localization/en.json</i>       « »    <i>setLocalization</i>  I18nStore. </p><br><p>    «»   React  Message: </p><br><div class="spoiler"> <b class="spoiler_title">src/components/Message/Message.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useLocalization } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Message</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { filename, messages, text, values } = props; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getLn = useLocalization(filename, messages); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getLn(text, values); } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ConnectedMessage = observer(Message); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">filename, messages</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MessageHoc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fullProps = { filename, messages, ...props }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ConnectedMessage</span></span></span></span><span class="xml"><span class="hljs-tag"> {</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">...fullProps</span></span></span></span><span class="xml"><span class="hljs-tag">} /&gt;</span></span></span><span class="xml">; }; }</span></span></code> </pre></div></div><br><p>        __filename (    id     ),       ,   : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Message = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'components/Message'</span></span>).init( __filename, messages ); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Message</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">text</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{messages.hello}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">values</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">count:</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">1</span></span></span></span><span class="xml"><span class="hljs-tag"> }} /&gt;</span></span></span></span></code> </pre><br><p>   —      <i>useLocalization</i>       (      <i>currentLanguage</i> ,     Message —   .    ,          ,      . </p><br><p>     ,           (    ,       ,      ,  /              production).       id      ,          <i>messages.js</i>   <i>*.json</i>     ,    .               (      / ),      production.       ,    ,   . </p><br><p>     MobX + Hooks    .     ,   backend,    ,    ,   . </p><br><h3>   API </h3><br><p>         ( backend,      ) —   ,   ,     .        ,      .     : </p><br><div class="spoiler"> <b class="spoiler_title">src/stores/CurrentTPStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { apiRoutes, request } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'api'</span></span>; @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentTPStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; } id = <span class="hljs-string"><span class="hljs-string">''</span></span>; symbol = <span class="hljs-string"><span class="hljs-string">''</span></span>; fullName = <span class="hljs-string"><span class="hljs-string">''</span></span>; currency = <span class="hljs-string"><span class="hljs-string">''</span></span>; tradedCurrency = <span class="hljs-string"><span class="hljs-string">''</span></span>; low24h = <span class="hljs-number"><span class="hljs-number">0</span></span>; high24h = <span class="hljs-number"><span class="hljs-number">0</span></span>; lastPrice = <span class="hljs-number"><span class="hljs-number">0</span></span>; marketCap = <span class="hljs-number"><span class="hljs-number">0</span></span>; change24h = <span class="hljs-number"><span class="hljs-number">0</span></span>; change24hPercentage = <span class="hljs-number"><span class="hljs-number">0</span></span>; fetchSymbol(params) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { tradedCurrency, id } = params; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { marketsList } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> requestParams = { id, <span class="hljs-attr"><span class="hljs-attr">localization</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">community_data</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">developer_data</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">tickers</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request(apiRoutes.symbolInfo, requestParams) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetchSymbolSuccess(data, tradedCurrency)) .catch(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetchSymbolError); } fetchSymbolSuccess(data, tradedCurrency) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { id, symbol, name, <span class="hljs-attr"><span class="hljs-attr">market_data</span></span>: { high_24h, low_24h, price_change_24h_in_currency, price_change_percentage_24h_in_currency, market_cap, current_price, }, } = data; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.symbol = symbol; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fullName = name; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currency = symbol; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tradedCurrency = tradedCurrency; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastPrice = current_price[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.high24h = high_24h[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.low24h = low_24h[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.change24h = price_change_24h_in_currency[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.change24hPercentage = price_change_percentage_24h_in_currency[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.marketCap = market_cap[tradedCurrency]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); } fetchSymbolError(error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); } }</code> </pre></div></div><br><p>  ,  ,      .      <i>fetchSymbol</i> ,    id    ,    .     ,   —        (       <code>@action.bound</code> ),       Sentry     : </p><br><div class="spoiler"> <b class="spoiler_title">src/utils/initSentry.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Sentry <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@sentry/browser'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initSentry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SENTRY_URL !== <span class="hljs-string"><span class="hljs-string">'false'</span></span>) { Sentry.init({ <span class="hljs-attr"><span class="hljs-attr">dsn</span></span>: SENTRY_URL, }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> originalErrorLogger = <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">consoleErrorCustom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...args</span></span></span><span class="hljs-function">) </span></span>{ Sentry.captureException(...args); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> originalErrorLogger(...args); }; } }</code> </pre></div></div><br><p>    ,        : </p><br><div class="spoiler"> <b class="spoiler_title">src/api/_api.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { omitParam, validateRequestParams, makeRequestUrl, makeRequest, validateResponse, } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'api/utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve() .then(validateRequestParams(route, params)) .then(makeRequestUrl(route, params)) .then(makeRequest) .then(validateResponse(route, params)); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> apiRoutes = { <span class="hljs-attr"><span class="hljs-attr">symbolInfo</span></span>: { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">params</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">`https://api.coingecko.com/api/v3/coins/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${params.id}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: omitParam, <span class="hljs-attr"><span class="hljs-attr">localization</span></span>: _.isBoolean, <span class="hljs-attr"><span class="hljs-attr">community_data</span></span>: _.isBoolean, <span class="hljs-attr"><span class="hljs-attr">developer_data</span></span>: _.isBoolean, <span class="hljs-attr"><span class="hljs-attr">tickers</span></span>: _.isBoolean, }, <span class="hljs-attr"><span class="hljs-attr">responseObject</span></span>: { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">symbol</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">genesis_date</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">v</span></span></span><span class="hljs-function"> =&gt;</span></span> _.isString(v) || _.isNil(v), <span class="hljs-attr"><span class="hljs-attr">last_updated</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">country_origin</span></span>: _.isString, <span class="hljs-attr"><span class="hljs-attr">coingecko_rank</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">coingecko_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">community_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">developer_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">liquidity_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">market_cap_rank</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">block_time_in_minutes</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">public_interest_score</span></span>: _.isNumber, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: _.isPlainObject, <span class="hljs-attr"><span class="hljs-attr">links</span></span>: _.isPlainObject, <span class="hljs-attr"><span class="hljs-attr">description</span></span>: _.isPlainObject, <span class="hljs-attr"><span class="hljs-attr">market_data</span></span>: _.isPlainObject, localization(value, requestParams) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestParams.localization === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isPlainObject(value); }, community_data(value, requestParams) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestParams.community_data === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isPlainObject(value); }, developer_data(value, requestParams) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestParams.developer_data === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isPlainObject(value); }, <span class="hljs-attr"><span class="hljs-attr">public_interest_stats</span></span>: _.isPlainObject, tickers(value, requestParams) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (requestParams.tickers === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isArray(value); }, <span class="hljs-attr"><span class="hljs-attr">categories</span></span>: _.isArray, <span class="hljs-attr"><span class="hljs-attr">status_updates</span></span>: _.isArray, }, }, };</code> </pre></div></div><br><p>    request : </p><br><ol><li>    apiRoutes    ; </li><li>     ,   route.params,     ,    <i>omitParam</i> ; </li><li>   URL    <code>route.url</code> —   ,      ,   —    get-  URL; </li><li>     fetch,     JSON; </li><li>     ,   <code>route.responseObject</code>  <code>route.responseArray</code> (     ).       ,   —   ,     ; </li><li>      /  /   /       ,      (   <i>fetchSymbolError</i> )  . </li></ol><br><p>               . ,     Sentry,         response: </p><br><p><img src="https://habrastorage.org/webt/mk/7y/8s/mk7y8sh2cushkehhykrrufsvkre.png"></p><br><p>        —            (       ),    . </p><br><h3>    </h3><br><p>    ,       ,        . ,    : </p><br><ul><li>          ; </li><li>    pathname  search; </li><li>      / ; </li><li>   location     ; </li><li>      beforeEnter,      isLoading,   ; </li><li>      :   ,    ,   ,   beforeEnter,     ; </li><li>     /   ; </li><li>   /        ; </li><li>     . </li></ul><br><p>     «»,            -,     —     .       : </p><br><div class="spoiler"> <b class="spoiler_title">src/routes.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routes = { <span class="hljs-attr"><span class="hljs-attr">marketDetailed</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'marketDetailed'</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/market/:market/:pair'</span></span>, <span class="hljs-attr"><span class="hljs-attr">masks</span></span>: { <span class="hljs-attr"><span class="hljs-attr">pair</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/^[a-zA-Z]{3,5}-[a-zA-Z]{3}$/</span></span>, <span class="hljs-attr"><span class="hljs-attr">market</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/^[a-zA-Z]{3,4}$/</span></span>, }, beforeEnter(route, store) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { pair, market }, } = route; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [symbol, tradedCurrency] = pair.split(<span class="hljs-string"><span class="hljs-string">'-'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> prevMarket = store.marketsList.currentMarket; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">optimisticallyUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ store.marketsList.currentMarket = market; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve() .then(optimisticallyUpdate) .then(store.marketsList.fetchSymbolsList) .then(store.rates.fetchRates) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> store.marketsList.fetchMarketList(market, prevMarket)) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> store.currentTP.fetchSymbol({ symbol, tradedCurrency, }) ) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); }); }, }, <span class="hljs-attr"><span class="hljs-attr">error404</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'error404'</span></span>, <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/error404'</span></span>, }, };</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">src/routeComponents.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { MarketDetailed } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'pages/MarketDetailed'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Error404 } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'pages/Error404'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routeComponents = { <span class="hljs-attr"><span class="hljs-attr">marketDetailed</span></span>: MarketDetailed, <span class="hljs-attr"><span class="hljs-attr">error404</span></span>: Error404, };</code> </pre></div></div><br><p> ,  ,          —         <code>&lt;Link route={routes.marketDetailed}&gt;</code> ,    . Webpack       ,      . </p><br><p>   ,    location      . </p><br><div class="spoiler"> <b class="spoiler_title">src/stores/RouterStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { routes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'routes'</span></span>; @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RouterStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._fillRouteSchemaFromUrl(); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'popstate'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._fillRouteSchemaFromUrl(); }); } currentRoute = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _fillRouteSchemaFromUrl() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pathnameArray = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.pathname.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routeName = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._getRouteNameMatchingUrl(pathnameArray); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!routeName) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> currentRoute = routes.error404; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, currentRoute.path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentRoute; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> route = routes[routeName]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routePathnameArray = route.path.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> params = {}; routePathnameArray.forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pathParam, i</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> urlParam = pathnameArray[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathParam.indexOf(<span class="hljs-string"><span class="hljs-string">':'</span></span>) === <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> paramName = pathParam.replace(<span class="hljs-string"><span class="hljs-string">':'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); params[paramName] = urlParam; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, route, { params, <span class="hljs-attr"><span class="hljs-attr">isLoading</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); } _getRouteNameMatchingUrl(pathnameArray) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.findKey(routes, route =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> routePathnameArray = route.path.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (routePathnameArray.length !== pathnameArray.length) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; routePathnameArray.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pathParam = routePathnameArray[i]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> urlParam = pathnameArray[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathParam.indexOf(<span class="hljs-string"><span class="hljs-string">':'</span></span>) !== <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathParam !== urlParam) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> paramName = pathParam.replace(<span class="hljs-string"><span class="hljs-string">':'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> paramMask = _.get(route.masks, paramName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paramMask &amp;&amp; !paramMask.test(urlParam)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }); } replaceDynamicParams(route, params) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(params).reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pathname, [paramName, value]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pathname.replace(<span class="hljs-string"><span class="hljs-string">`:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-string">`</span></span>, value); }, route.path); } goTo(route, params) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (route.name === <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute.name) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_.isEqual(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute.params, params)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute.isLoading = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute.params = params; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPathname = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replaceDynamicParams(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute, params); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, newPathname); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> newPathname = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replaceDynamicParams(route, params); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.history.pushState(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, newPathname); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentRoute = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._fillRouteSchemaFromUrl(); } }</code> </pre></div></div><br><p>     —         <i>routes.js</i>       .          —       404. ,       «          »,     ,      ,   — ,        'test-test'. </p><br><p>   <i>currentRoute</i>   ,   <i>params</i> (   URL)  <code>isLoading: true</code> .      React- Router: </p><br><div class="spoiler"> <b class="spoiler_title">src/components/Router.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { routeComponents } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'routeComponents'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRouteComponent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, isLoading</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Component = routeComponents[route.name]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Component) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error( <span class="hljs-string"><span class="hljs-string">`getRouteComponent: component for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ route.name }</span></span></span><span class="hljs-string"> is not defined in routeComponents`</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Component</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">isLoading</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{isLoading}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">; } function useBeforeEnter() { const store = useStore(); const { currentRoute } = store.router; React.useEffect(() =&gt; { if (currentRoute.isLoading) { const beforeEnter = _.get(currentRoute, 'beforeEnter'); if (_.isFunction(beforeEnter)) { Promise.resolve() .then(() =&gt; beforeEnter(currentRoute, store)) .then(() =&gt; { currentRoute.isLoading = false; }) .catch(error =&gt; console.error(error)); } else { currentRoute.isLoading = false; } } }); return currentRoute.isLoading; } function Router() { const { router: { currentRoute }, } = useStore(); const isLoading = useBeforeEnter(); return getRouteComponent(currentRoute, isLoading); } export const RouterConnected = observer(Router);</span></span></code> </pre></div></div><br><p>    ,        ,     <code>currentRoute == null</code> .    —      <code>isLoading === true</code> ,           false   ,    <code>route.beforeEnter</code> ( ).            <code>console.error</code> ,    ,     . </p><br><p>  ,    —     ,   .  React-  2 : </p><br><ol><li>    componentWillMount / componentDidMount / useEffect  ,     ,   .        —     ,          «».   —       —        ; </li><li>    ( )        ,   .  —      —  ,          .   —      /  —   real-time   ,     /    . </li></ol><br><p>       ,         —      (  ,  ,            ..),         . </p><br><p>        <i>beforeEnter</i> ,  : « »,     ( , ,      ),    —    (         —    500 ;          ;   ,       ;        ..).   «»     ,        MVP   . </p><br><p>        : </p><br><div class="spoiler"> <b class="spoiler_title">src/components/Link.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkRouteParamsWithMasks</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (route.masks) { <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(route.masks).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[paramName, paramMask]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> value = _.get(params, paramName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paramMask &amp;&amp; !paramMask.test(value)) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error( <span class="hljs-string"><span class="hljs-string">`checkRouteParamsWithMasks: wrong param for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-string"> in Link to </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ route.name }</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${value}</span></span></span><span class="hljs-string">`</span></span> ); } }); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Link</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = useStore(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { currentRoute } = store.router; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { route, params, children, onClick, ...otherProps } = props; checkRouteParamsWithMasks(route, params); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> filledPath = store.router.replaceDynamicParams(route, params); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{filledPath}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{e</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> { e.preventDefault(); if (currentRoute.isLoading) { return false; } store.router.goTo(route, params); if (onClick) { onClick(); } }} {...otherProps} &gt; {children} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LinkConnected = observer(Link);</code> </pre></div></div><br><p>     <i>route</i> ,    <i>params</i> ( )     (        )   <i>href</i>  .  ,           <i>beforeEnter</i> ,    .      «,  »,       ,           —    . </p><br><h3>  Mesures </h3><br><p>  - (  ,   ,   ,   ,    )     .     .                 . </p><br><p>     —         ,   —  ,       .        : </p><br><div class="spoiler"> <b class="spoiler_title">src/api/utils/metrics.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> metricsArray = []; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> sendMetricsCallback = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startMetrics</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, apiRoutes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">promiseCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ clearTimeout(sendMetricsCallback); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> apiRouteName = _.findKey(apiRoutes, route); metricsArray.push({ <span class="hljs-attr"><span class="hljs-attr">id</span></span>: apiRouteName, <span class="hljs-attr"><span class="hljs-attr">time</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime(), }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; }; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopMetrics</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, apiRoutes</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">promiseCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> apiRouteName = _.findKey(apiRoutes, route); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> metricsData = _.find(metricsArray, [<span class="hljs-string"><span class="hljs-string">'id'</span></span>, apiRouteName]); metricsData.time = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime() - metricsData.time; clearTimeout(sendMetricsCallback); sendMetricsCallback = setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Metrics sent:'</span></span>, metricsArray); metricsArray = []; }, <span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; }; }</code> </pre></div></div><br><p>     middleware   <i>request</i> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">route, params</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve() .then(startMetrics(route, apiRoutes)) .then(validateRequestParams(route, params)) .then(makeRequestUrl(route, params)) .then(makeRequest) .then(validateResponse(route, params)) .then(stopMetrics(route, apiRoutes)) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { stopMetrics(route, apiRoutes)(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> error; }); }</code> </pre><br><p>  ,   ,       2 ,       (    )  .        —      ,       —          ,     ( )     ,    . </p><br><p>      -   —   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>     . </p><br><h3>   </h3><br><p>     end-to-end   ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>    Cypress.       :  ;    ,     ;    Continious Integration. </p><br><p>             javascript    Chai / Sinon ,       .       ,      ,    — ./tests,  <i>package.json</i>     — <code>"dependencies": { "cypress": "3.2.0" }</code> </p><br><p>            .          Webpack    : </p><br><div class="spoiler"> <b class="spoiler_title">tests/cypress/plugins/index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../../node_modules/@cypress/webpack-preprocessor'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../../webpack-custom/webpack.config'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> options = webpack.defaultOptions; options.webpackOptions.module = webpackConfig.module; options.webpackOptions.resolve = webpackConfig.resolve; on(<span class="hljs-string"><span class="hljs-string">'file:preprocessor'</span></span>, webpack(options)); };</code> </pre></div></div><br><p>           .    <i>module</i> (   )  <i>resolve</i> (          ).   ESLint      ( <i>describe</i> , <i>cy</i> )    <i>eslint-plugin-cypress</i> .    ,       : </p><br><div class="spoiler"> <b class="spoiler_title">tests/cypress/integration/mixed.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">describe(<span class="hljs-string"><span class="hljs-string">'Market Listing good scenarios'</span></span>, () =&gt; { it(<span class="hljs-string"><span class="hljs-string">'Lots of mixed tests'</span></span>, () =&gt; { cy.visit(<span class="hljs-string"><span class="hljs-string">'/market/usd/bch-usd'</span></span>); cy.location(<span class="hljs-string"><span class="hljs-string">'pathname'</span></span>).should(<span class="hljs-string"><span class="hljs-string">'equal'</span></span>, <span class="hljs-string"><span class="hljs-string">'/market/usd/bch-usd'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    ,       cy.wait('@symbolsList') .its('response.body') .should(data =&gt; { expect(data).to.be.an('array'); }); //    cy.wait('@rates'); cy.wait('@marketsList'); cy.wait('@symbolInfo'); cy.wait('@chartData'); //       cy.get('#marketTab-eth').click(); cy.location('pathname').should('equal', '/market/eth/bch-usd'); cy.wait('@rates'); cy.wait('@marketsList'); //    cy.contains(''); cy.get('#langSwitcher-en').click(); cy.contains('Markets list'); //    cy.get('body').should('have.class', 'light'); cy.get('#themeSwitcher-dark').click(); cy.get('body').should('have.class', 'dark'); }); });</span></span></code> </pre></div></div><br><p>      Cypress    fetch,   ,      : </p><br><div class="spoiler"> <b class="spoiler_title">tests/cypress/support/index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { apiRoutes } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'api'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> polyfill = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; before(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> polyfillUrl = <span class="hljs-string"><span class="hljs-string">'https://unpkg.com/unfetch/dist/unfetch.umd.js'</span></span>; cy.request(polyfillUrl).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> =&gt;</span></span> { polyfill = response.body; }); }); Cypress.on(<span class="hljs-string"><span class="hljs-string">'window:before:load'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">window</span></span> =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.fetch; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.eval(polyfill); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.fetch = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.unfetch; }); before(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { cy.server(); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.symbolsList.url}</span></span></span><span class="hljs-string">**`</span></span>).as(<span class="hljs-string"><span class="hljs-string">'symbolsList'</span></span>); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.rates.url}</span></span></span><span class="hljs-string">**`</span></span>).as(<span class="hljs-string"><span class="hljs-string">'rates'</span></span>); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.marketsList.url}</span></span></span><span class="hljs-string">**`</span></span>).as(<span class="hljs-string"><span class="hljs-string">'marketsList'</span></span>); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.symbolInfo.url({ id: </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'bitcoin-cash'</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> }</span></span></span><span class="hljs-string">)}**`</span></span>).as( <span class="hljs-string"><span class="hljs-string">'symbolInfo'</span></span> ); cy.route(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${apiRoutes.chartData.url}</span></span></span><span class="hljs-string">**`</span></span>).as(<span class="hljs-string"><span class="hljs-string">'chartData'</span></span>); });</code> </pre></div></div><br><p>  ,       . </p><br><h3>  ,  ? </h3><br><p> ,      - .         ,      ,   -    / - / . </p><br><p>    ,    ,          , - ,   -   ,       (real-time ,  serviceWorker,   CI,   ,       ,  -,  ,     ..). </p><br><p>    ( Gzip)  : </p><br><p><img src="https://habrastorage.org/webt/p6/im/fk/p6imfkqh0-lf8zlr2apy_8zjqcm.png"></p><br><p>     React Developer Tools   : </p><br><p><img src="https://habrastorage.org/webt/im/jn/_l/imjn_lzweyq7yijk7ohnlafcpgo.png"></p><br><p>      React Hooks + MobX   ,   Redux. ,          .           ,  ,      ,          .       .   ! </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> </p><br><br><h3> Update 13.07.2019 </h3><br><p>       ,          ,   : </p><br><p> 1.  <i>yarn.lock</i>      ,    <code>yarn install --force</code> ,      <code>"upd": "yarn install &amp;&amp; yarn add file:./eslint-custom &amp;&amp; yarn add file:./webpack-custom"</code> .             ESLint  Webpack. </p><br><p> 2.     webpack-custom/config/configOptimization.js,   ,   </p><br><pre> <code class="javascript hljs">lodash: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.context.indexOf(<span class="hljs-string"><span class="hljs-string">'node_modules\\lodash'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }</code> </pre><br><p>   </p><br><pre> <code class="javascript hljs">lodash: { <span class="hljs-attr"><span class="hljs-attr">test</span></span>: <span class="hljs-regexp"><span class="hljs-regexp">/node_modules[\\/]lodash/</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>, <span class="hljs-attr"><span class="hljs-attr">chunks</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-attr"><span class="hljs-attr">enforce</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }</code> </pre><br><p> 3.          <code>useLocalization(__filename, messages)</code> ,  —      </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> messages = { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: { <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-string"><span class="hljs-string">'  {count} {count: ,,}'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"src/components/TestLocalization/TestLocalization.hello"</span></span>, } };</code> </pre><br><p> ,    </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> messagesDefault = { <span class="hljs-attr"><span class="hljs-attr">hello</span></span>: <span class="hljs-string"><span class="hljs-string">'  {count} {count: ,,}'</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> messages = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.keys(messagesDefault).reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">acc, key</span></span></span><span class="hljs-function">) =&gt;</span></span> { acc[key] = { <span class="hljs-attr"><span class="hljs-attr">value</span></span>: messagesDefault[key], <span class="hljs-attr"><span class="hljs-attr">name</span></span>: __dirname.toLowerCase().replace(<span class="hljs-regexp"><span class="hljs-regexp">/\\\\/g</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>) + <span class="hljs-string"><span class="hljs-string">'.'</span></span> + key, }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> acc; }, {});</code> </pre><br><p>     IDE      ,       Webpack: </p><br><div class="spoiler"> <b class="spoiler_title">webpack-custom/utils/messagesLoader.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">messagesLoader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">source</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (source.indexOf(<span class="hljs-string"><span class="hljs-string">'export const messages = messagesDefault;'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> source.replace( <span class="hljs-string"><span class="hljs-string">'export const messages = messagesDefault;'</span></span>, <span class="hljs-string"><span class="hljs-string">` export const messages = Object.keys(messagesDefault).reduce((acc, key) =&gt; { acc[key] = { value: messagesDefault[key], name: __dirname.toLowerCase().replace(/\\\\/g, '/') + '.' + key, }; return acc; }, {}); `</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> source; };</code> </pre></div></div><br><p> ,  <i>messages.js</i>   : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> messagesDefault = { <span class="hljs-attr"><span class="hljs-attr">someText</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> messages = messagesDefault;</code> </pre><br><p>          ,   <i>app.js</i> ,      <i>messages.js</i>  ,      <i>*.json</i>  : </p><br><div class="spoiler"> <b class="spoiler_title">src/utils/checkLocalization.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ru <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'localization/ru.json'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> showNoTextMessage = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkLocalization</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> context = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.context(<span class="hljs-string"><span class="hljs-string">'../'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, /messages\.js/); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> messagesFiles = context.keys(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> notLocalizedObject = {}; messagesFiles.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">path</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fileExports = context(path); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { messages } = fileExports; _.values(messages).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ name, value }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ru[name] == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { notLocalizedObject[name] = value; } }); }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (showNoTextMessage &amp;&amp; _.size(notLocalizedObject) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-string"><span class="hljs-string">'No localization for lang ru:'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(notLocalizedObject, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) ); } }</code> </pre></div></div><br><p>  ,      </p><br><pre> <code class="plaintext hljs">No localization for lang ru: { "src/components/TestLocalization/TestLocalization.hello": "  {count} {count: ,,}" }</code> </pre><br><p>       <i>*.json</i>  — ,           ,     . </p><br><p> 3.       Lodash  <code>someResponseParam: _.isString</code>   ,             .       : </p><br><div class="spoiler"> <b class="spoiler_title">src/utils/validateObjects.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { createError } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./createError'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { errorsNames } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'const'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> validators = { isArray(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isArray(v); }, isString(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isString(v); }, isNumber(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isNumber(v); }, isBoolean(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isBoolean(v); }, isPlainObject(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isPlainObject(v); }, isArrayNotRequired(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isArray(v) || _.isNil(v); }, isStringNotRequired(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isString(v) || _.isNil(v); }, isNumberNotRequired(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isNumber(v) || _.isNil(v); }, isBooleanNotRequired(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isBoolean(v) || _.isNil(v); }, isPlainObjectNotRequired(v) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.isPlainObject(v) || _.isNil(v); }, omitParam() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }, }; validators.isArray.notRequired = validators.isArrayNotRequired; validators.isString.notRequired = validators.isStringNotRequired; validators.isNumber.notRequired = validators.isNumberNotRequired; validators.isBoolean.notRequired = validators.isBooleanNotRequired; validators.isPlainObject.notRequired = validators.isPlainObjectNotRequired; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> { validatorsObject, targetObject, prefix }, otherArg </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_.isPlainObject(validatorsObject)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">`validateObjects: validatorsObject is not an object`</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_.isPlainObject(targetObject)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">`validateObjects: targetObject is not an object`</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.entries(validatorsObject).forEach(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[paramName, validator]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> paramValue = targetObject[paramName]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!validator(paramValue, otherArg)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> validatorName = _.findKey(validators, v =&gt; v === validator); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> createError( errorsNames.VALIDATION, <span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${prefix || </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">''</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${paramName}</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ _.isString(validatorName) ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">` [</span></span></span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${validatorName}</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">]`</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">''</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> }</span></span></span><span class="hljs-string">`</span></span> ); } }); }</code> </pre></div></div><br><p>           — , <code>     someResponseParam [isString]</code> ,   ,    .    <code>someResponseParam: validators.isString.notRequired</code> ,    .          ,         ,      <code>someResponseArray: arrayShape({ someParam: isString })</code> ,       . </p><br><p> 5. ,   ,   .   —      (  <code>body</code>  <code>isEntering</code> , <code>isLeaving</code>   )          beforeLeave ( Prompt  <i>react-router</i> ),           false-  ,  </p><br><pre> <code class="javascript hljs">somePage: { <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/some-page'</span></span>, beforeLeave(store) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> store.modals.raiseConfirm(<span class="hljs-string"><span class="hljs-string">'    ?'</span></span>); }, }</code> </pre><br><p>     ,               - . ,       : </p><br><p> —    <code>/some/long/auth/path</code>  beforeEnter    <code>/auth</code> <br> — beforeEnter  <code>/auth</code>  ,     —    <code>/profile</code> <br> — beforeEnter  <code>/profile</code>    ,   ,      ,   <code>/profile/edit</code> </p><br><p>      ,          —    <code>window.history.pushState</code>  <code>location.replace</code> .      ,           .    «    »     «    componentDidMount »,         ,          . </p><br><p> 6.           (,   )    : </p><br><div class="spoiler"> <b class="spoiler_title">src/utils/withState.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">withState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target, fnName, fnDescriptor</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> original = fnDescriptor.value; fnDescriptor.value = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fnWithState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.executions[fnName]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve() .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.executions[fnName] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> original.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, args)) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.executions[fnName] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; }) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.executions[fnName] = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> error; }); }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fnDescriptor; }</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">src/stores/CurrentTPStore.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { makeObservable, withState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { apiRoutes, request } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'api'</span></span>; @makeObservable <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentTPStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * @param rootStore {RootStore} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(rootStore) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rootStore = rootStore; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.executions = {}; } @withState fetchSymbol() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request(apiRoutes.symbolInfo) .then(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetchSymbolSuccess) .catch(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetchSymbolError); } fetchSymbolSuccess(data) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(); } fetchSymbolError(error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(error); } }</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">src/components/TestComponent.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { observer } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'utils'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { useStore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'hooks'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestComponent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = useStore(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-attr"><span class="hljs-attr">currentTP</span></span>: { executions } } = store; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{executions.fetchSymbol ? '...' : ''}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TestComponentConnected = observer(TestComponent);</code> </pre></div></div><br><p>         ,   . </p><br><p>        ,    ,        .        —      ,     ,  , ,    - . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450360/">https://habr.com/ru/post/fr450360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450344/index.html">Un message de drapeau blanc, ou Comment j'ai sauvé votre cours vidéo d'apparaître sur le tracker</a></li>
<li><a href="../fr450346/index.html">Berceau du cottage de Newton</a></li>
<li><a href="../fr450350/index.html">La fine ligne rouge de mon projet</a></li>
<li><a href="../fr450354/index.html">Annonce des compétences Windows Vision (préversion)</a></li>
<li><a href="../fr450358/index.html">Améliorations du service de distribution de Visual Studio App Center</a></li>
<li><a href="../fr450362/index.html">Comptez les agents "examinateur"</a></li>
<li><a href="../fr450368/index.html">Obtenez des taux absolus à partir des taux de change de devises croisées</a></li>
<li><a href="../fr450372/index.html">Comment les algorithmes d'Amazon déterminent qui il est temps de rejeter</a></li>
<li><a href="../fr450374/index.html">Carte d'extension de RAM pour Apple IIgs</a></li>
<li><a href="../fr450376/index.html">Comment Yandex.Taxi recherche des voitures quand elles ne le sont pas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>