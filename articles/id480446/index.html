<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍💻 🚉 🕤 Menulis reverse proxy Grafana on Go 👩🏿‍🚒 👰🏾 🏛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya benar-benar ingin menamai artikel "Proxy-service on Go dalam 3 baris", tapi saya di atasnya. 


 Bahkan, memang, logika utama bisa masuk dalam ti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menulis reverse proxy Grafana on Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ispsystem/blog/480446/"><p><img src="https://habrastorage.org/webt/u_/7z/hb/u_7zhbnc2fqmavgkimjqnbt_mcy.png"></p><br><p>  Saya benar-benar ingin menamai artikel "Proxy-service on Go dalam 3 baris", tapi saya di atasnya. </p><br><p>  Bahkan, memang, logika utama bisa masuk dalam tiga baris.  Untuk yang tidak sabar dan mereka yang ingin melihat esensi: </p><br><pre><code class="go hljs">proxy := httputil.NewSingleHostReverseProxy(url) r.Header.Set(header, value) proxy.ServeHTTP(w, r)</code> </pre> <br><p>  Di bawah kucing adalah cerita yang lebih rinci untuk pendatang baru ke bahasa Golang dan mereka yang perlu membuat proxy terbalik dalam waktu sesingkat mungkin. </p><br><p>  Mari kita cari tahu mengapa layanan proxy diperlukan, bagaimana menerapkannya dan apa yang ada di bawah kap perpustakaan standar. </p><a name="habracut"></a><br><h2 id="obratnyy-proksi">  Membalikkan proxy </h2><br><p>  Proksi terbalik adalah jenis server proxy yang menerima permintaan dari klien, mengarahkannya ke satu atau lebih server, dan meneruskan tanggapan kembali. </p><br><p>  Fitur khas dari proxy terbalik adalah bahwa itu adalah titik masuk untuk menghubungkan pengguna ke server dengan mana proxy itu sendiri terhubung oleh logika bisnis.  Ini menentukan server mana permintaan klien akan dikirim.  Logika membangun jaringan di belakang proxy tetap tersembunyi dari pengguna. </p><br><p><img src="https://habrastorage.org/webt/gr/v7/h0/grv7h0y6ednzlip-31n2bvvmdti.png"><br>  <em>Membalikkan Proksi</em> </p><br><p>  Sebagai perbandingan, proxy reguler menghubungkan kliennya ke server mana pun yang mereka butuhkan.  Dalam hal ini, proksi ada di depan pengguna dan hanyalah perantara dalam pelaksanaan permintaan. </p><br><p><img src="https://habrastorage.org/webt/ts/in/_m/tsin_mlkn8_o_yxo_4eb3mmnht4.png"><br>  <em>Proxy normal (Teruskan Proxy)</em> </p><br><p>  <strong>Mengapa menggunakan</strong> <br>  Konsep reverse proxy dapat diterapkan dalam berbagai situasi: <br>  - load balancing, <br>  - Pengujian A / B <br>  - caching sumber daya, <br>  - kompresi data permintaan, <br>  - penyaringan lalu lintas, <br>  - otorisasi. </p><br><p>  Tentu saja, cakupannya tidak terbatas pada enam poin ini.  Fakta dari kemungkinan memproses permintaan baik sebelum dan sesudah proxy memberikan banyak ruang untuk kreativitas.  Dalam artikel ini, kami akan membahas penggunaan proxy terbalik untuk otorisasi. </p><br><h2 id="zadacha">  Tantangan </h2><br><p>  Kami sedang mengembangkan panel kontrol virtualisasi VMmanager 6. Suatu hari, kami memutuskan untuk memberi pengguna lebih banyak kebebasan dalam memantau dan memvisualisasikan kluster ini.  Untuk tujuan ini, mereka memilih <a href="https://grafana.com/">Grafana</a> . </p><br><p>  Agar Grafana dapat bekerja dengan data kami, perlu untuk mengonfigurasi otorisasi.  Tidak sulit untuk melakukan ini, jika bukan untuk tiga "tetapi." </p><br><ol><li>  Kami sudah memiliki satu titik masuk - layanan otorisasi. </li><li>  Kami tidak ingin memulai dan mengizinkan pengguna di Grafana. </li><li>  Kami tidak ingin memberi pengguna akses ke Grafana secara langsung. </li></ol><br><p>  Untuk memenuhi persyaratan, kami memutuskan untuk menempatkan Grafana di jaringan internal dan menulis proksi terbalik.  Dia akan memeriksa hak dalam layanan otorisasi dan hanya setelah itu mentransfer permintaan ke Grafana. </p><br><h2 id="ideya">  Ide </h2><br><p>  Gagasan utamanya adalah mengalihkan tanggung jawab untuk otorisasi di Grafana ke server proxy terbalik ( <a href="https://grafana.com/docs/auth/auth-proxy/">dokumentasi resmi</a> ).  Grafana akan menerima permintaan apa pun yang diizinkan jika berisi tajuk tertentu.  Sebelum mengganti judul ini, kami harus memastikan bahwa pengguna saat ini memiliki hak untuk bekerja dengan Grafana. </p><br><p><img src="https://habrastorage.org/webt/ug/2e/ty/ug2etyp6pa5pz0j7batplzwjmbm.png"><br>  <em>Rantai panggilan "Grafana-proxy, atau Round-trip"</em> </p><br><h2 id="realizaciya">  Implementasi </h2><br><p>  Fungsi utamanya cukup standar.  Kami memulai http-server, yang akan menerima koneksi pada 4000 port dan memproses setiap alamat "/" yang dengannya koneksi tersebut terjadi. </p><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { http.HandleFunc(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handlerProxy) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := http.ListenAndServe(<span class="hljs-string"><span class="hljs-string">":4000"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>(err) } }</code> </pre> <br><p>  Sebagian besar pekerjaan terjadi di penangan permintaan. </p><br><div class="spoiler">  <b class="spoiler_title">[kode lengkap terpotong]</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handlerProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> { fmt.Println(r.URL.Host) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> strings.HasPrefix(r.URL.String(), <span class="hljs-string"><span class="hljs-string">"/api"</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//     } url, err := url.Parse(fmt.Sprintf("http://%s/", grafanaHost)) if err != nil { SendJSONError(w, err.Error()) return } proxy := httputil.NewSingleHostReverseProxy(url) fmt.Println(r.URL.Host) r.Header.Set(grafanaHeader, grafanaUser) proxy.ServeHTTP(w, r) }</span></span></code> </pre> </div></div><br><p>  Mari kita lihat parameternya.  Variabel utama dalam contoh ini saya masukkan ke dalam konstanta: </p><br><pre> <code class="go hljs">grafanaUser = <span class="hljs-string"><span class="hljs-string">"admin"</span></span> <span class="hljs-comment"><span class="hljs-comment">//,      grafanaHost = "grafana:3000" //  grafana grafanaHeader = "X-GRAFANA-AUTH" //Header,     </span></span></code> </pre> <br><p>  Sebagai contoh, ini sudah cukup, dalam praktiknya, Anda mungkin perlu mempreset nilai-nilai ini.  Anda bisa memberikan mereka proksi sebagai parameter baris perintah, lalu menggunakan <a href="https://golang.org/pkg/flag/">flag</a> atau paket yang lebih canggih untuk menguraikannya.  Lingkungan kontainer juga sering menggunakan variabel lingkungan untuk mengkonfigurasi layanan, <a href="https://gobyexample.com/environment-variables">os.Getenv</a> akan membantu Anda di sepanjang jalan. </p><br><p>  Berikutnya adalah cek otorisasi: </p><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> strings.HasPrefix(r.URL.String(), <span class="hljs-string"><span class="hljs-string">"/api"</span></span>) { err := CheckRights(r.Header) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { SendJSONError(w, err.Error()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } }</code> </pre> <br><p>  Jika permintaan masuk ke grafana.host/api, kami memeriksa hak pengguna saat ini untuk menggunakan Grafana.  Diperlukan verifikasi agar setiap permintaan GET dari skrip JS atau ikon PNG tidak mengganggu titik otorisasi.  Kami akan proksi konten statis tanpa pemeriksaan tambahan.  Untuk melakukan ini, kami meneruskan peta dengan header yang berisi sesi pengguna ke layanan otorisasi.  Ini mungkin permintaan GET biasa.  Perangkat layanan otorisasi tidak masalah di sini.  Jika data otorisasi tidak sesuai, tutup koneksi, kembalikan kesalahan. </p><br><p>  Setelah pemeriksaan, kami membentuk objek jalur dasar: </p><br><pre> <code class="go hljs">url, err := url.Parse(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://%s/"</span></span>, grafanaHost))</code> </pre> <br><p>  Menggunakan paket <a href="httputil/">httputil</a> standar, yang memperluas paket http, kami membentuk objek ReverseProxy. </p><br><pre> <code class="go hljs">proxy := httputil.NewSingleHostReverseProxy(url)</code> </pre> <br><p>  ReverseProxy adalah penangan permintaan yang akan menerima permintaan yang masuk, mengirimkannya ke Grafana dan meneruskan respons kembali ke klien. </p><br><p>  Ini akan meneruskan semua permintaan ke alamat "jalur dasar + url yang diminta".  Jika pengguna datang ke alamat proxy: 4000 / api / something, permintaannya akan berubah menjadi grafana: 3000 / api / something, di mana <em>grafana: 3000</em> adalah jalur dasar yang dilewatkan ke NewSingleHostReverseProxy, dan <em>/ api / something</em> adalah permintaan yang masuk. </p><br><p>  Tambahkan tajuk otorisasi untuk Grafana dan panggil metode ServeHTTP, yang akan melakukan sebagian besar pemrosesan permintaan. </p><br><pre> <code class="go hljs">r.Header.Set(grafanaHeader, grafanaUser) proxy.ServeHTTP(w, r)</code> </pre> <br><p>  Di bawah tenda, ServeHTTP melakukan sedikit pekerjaan, misalnya, memproses tajuk X-Forwarded-For atau 101 server terhadap perubahan protokol.  Pekerjaan utama metode ini adalah mengirim permintaan ke alamat gabungan dan mentransfer jawaban yang diterima ke ResponseWriter. </p><br><p><img src="https://habrastorage.org/webt/xv/wd/1m/xvwd1mvdn4fomd2s9kjw6iev4ws.png"><br>  <em>Hasil</em> </p><br><p>  Semua kode <a href="https://github.com/460s/grafana_proxy">tersedia di github</a> . </p><br><h1 id="proverka">  Periksa </h1><br><p>  Tiru sistem kami menggunakan Docker.  Mari kita buat dua kontainer - proxy dan Grafana dalam satu jaringan.  Kami tidak akan membuat titik otorisasi, kami percaya bahwa itu selalu menjawab dengan tegas.  Wadah Grafana tidak akan tersedia offline, wadah proxy tersedia di port tertentu. </p><br><p>  Buat jaringan: </p><br><pre> <code class="bash hljs">docker network create --driver=bridge --subnet=192.168.0.0/16 gnet</code> </pre> <br><p>  Naikkan wadah Grafana dengan mode otorisasi yang dikonfigurasi melalui header: </p><br><pre> <code class="bash hljs">docker run -d --name=grafana --network=gnet -e <span class="hljs-string"><span class="hljs-string">"GF_AUTH_PROXY_ENABLED=true"</span></span> -e <span class="hljs-string"><span class="hljs-string">"GF_AUTH_PROXY_HEADER_NAME=X-GRAFANA-AUTH"</span></span> grafana/grafana</code> </pre> <br><p>  Harap dicatat bahwa ini adalah demo dan bukan konfigurasi final.  Minimal, Anda harus menetapkan kata sandi administrator dan melarang pendaftaran pengguna otomatis. </p><br><p>  Naikkan proxy terbalik: </p><br><pre> <code class="bash hljs">docker run -d --name proxy -p 4000:4000 --network=gnet grafana_proxy:latest</code> </pre> <br><p>  Di browser, buka localhost: 4000. </p><br><p>  Hebat, kami memiliki Grafana resmi di depan kami. </p><br><p>  Dockerfile untuk membangun wadah dengan proxy dan instruksi yang lebih rinci tentang mengangkat wadah ada di <a href="https://github.com/460s/grafana_proxy">github</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id480446/">https://habr.com/ru/post/id480446/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id480428/index.html">Metode steno paling sederhana. Alfabet dan font untuknya.</a></li>
<li><a href="../id480430/index.html">Cara kerja codec video. Bagian 2. Apa, mengapa, bagaimana</a></li>
<li><a href="../id480432/index.html">Masalah penampil pertama, atau sulitnya konversi aliran video WebRTC ke HLS</a></li>
<li><a href="../id480440/index.html">Acara digital di St. Petersburg dari 16 hingga 22 Desember</a></li>
<li><a href="../id480444/index.html">Detektif Habra: 24 jam dari kehidupan 24 publikasi</a></li>
<li><a href="../id480452/index.html">Pertemuan # 9 OWASP Moscow: Catatan Kinerja</a></li>
<li><a href="../id480454/index.html">Hack The Box - Smasher2 Walkthrough Labu, WAF, dan LPE melalui driver pwn</a></li>
<li><a href="../id480460/index.html">Solusi mendasar dari sistem persamaan linear. Tampak samping</a></li>
<li><a href="../id480462/index.html">Bagaimana saya memperdebatkan daftar tertaut ganda untuk O (1)</a></li>
<li><a href="../id480466/index.html">Spesifikasi dialyzer: jalan Jedi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>