<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîö ‚¨úÔ∏è üö† Allez √† Go! Comment l'√©quipe PHP a pris en charge l'√©criture de microservices üôçüèΩ üì† üçé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! Je m'appelle Alexey Skorobogaty, je suis architecte syst√®me chez Lamoda. En f√©vrier 2019, j'ai pris la parole lors de Go Meetup tout e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Allez √† Go! Comment l'√©quipe PHP a pris en charge l'√©criture de microservices</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/478740/"><p>  Bonjour √† tous!  Je m'appelle Alexey Skorobogaty, je suis architecte syst√®me chez Lamoda.  En f√©vrier 2019, j'ai pris la parole lors de Go Meetup tout en restant dans la position de chef d'√©quipe de l'√©quipe principale.  Aujourd'hui, je veux pr√©senter une transcription de mon rapport, que vous pouvez √©galement <a href="https://www.youtube.com/watch%3Fv%3DF5IVE0IpGJY%26t%3D4s">voir.</a> </p><br><p>  Notre √©quipe s'appelle Core pour une raison: le domaine de responsabilit√© comprend tout ce qui concerne les commandes dans la plateforme de commerce √©lectronique.  L'√©quipe √©tait form√©e de d√©veloppeurs PHP et de sp√©cialistes de notre traitement des commandes, qui √† l'√©poque √©tait un monolithe unique.  Nous √©tions engag√©s et continuons √† g√©rer sa d√©composition en microservices. </p><br><p><img src="https://habrastorage.org/webt/qu/71/2m/qu712m7duwr6k_fcoworp0io0go.png" alt="image"></p><a name="habracut"></a><br><p>  Une commande dans notre syst√®me se compose de composants associ√©s: il y a une unit√© de livraison et un panier, des unit√©s de remise et de paiement, et √† la fin il y a un bouton qui envoie la commande √† retirer √† l'entrep√¥t.  C'est √† ce moment que commence le travail du syst√®me de traitement des commandes, o√π toutes les donn√©es de commande seront valid√©es et les informations agr√©g√©es. </p><br><p><img src="https://habrastorage.org/webt/pm/va/0h/pmva0huzhbmc7szecb-088cnlz8.png" alt="image"></p><br><p>  √Ä l'int√©rieur de tout cela, il y a une logique multicrit√®re complexe.  Les blocs interagissent les uns avec les autres et s'influencent mutuellement.  Les changements continus et constants de l'entreprise ajoutent √† la complexit√© des crit√®res.  De plus, nous avons diff√©rentes plateformes √† travers lesquelles les clients peuvent cr√©er des commandes: site web, applications, centre d'appels, plateforme B2B.  Ainsi que des crit√®res SLA / MTTI / MTTR rigoureux (mesures d'enregistrement et r√©solution des incidents).  Tout cela n√©cessite une grande flexibilit√© et stabilit√© du service. </p><br><h3 id="arhitekturnoe-nasledie">  Patrimoine architectural </h3><br><p>  Comme je l'ai d√©j√† dit, au moment de la formation de notre √©quipe, le syst√®me de traitement des commandes √©tait un monolithe - pr√®s de 100 000 lignes de code qui d√©crivaient directement la logique m√©tier.  La partie principale a √©t√© √©crite en 2011 en utilisant l'architecture MVC multicouche classique.  Il √©tait bas√© sur PHP (le framework ZF1), qui a √©t√© progressivement envahi par des adaptateurs et des composants symfony pour interagir avec divers services.  Au cours de son existence, le syst√®me comptait plus de 50 contributeurs, et bien que nous ayons r√©ussi √† maintenir un style unifi√© d'√©criture de code, cela a √©galement impos√© ses limites.  En outre, un grand nombre de contextes mixtes sont apparus - pour diverses raisons, certains m√©canismes ont √©t√© mis en ≈ìuvre dans le syst√®me qui n'√©taient pas directement li√©s au traitement des commandes.  Tout cela a conduit au fait que nous avons actuellement une base de donn√©es MySQL sup√©rieure √† 1 t√©raoctet. </p><br><p> Sch√©matiquement, l'architecture initiale peut √™tre repr√©sent√©e comme suit: </p><br><p><img src="https://habrastorage.org/webt/go/cd/ht/gocdht4rqheqf9wgfglpwbfqir4.png" alt="image"></p><br><p>  L'ordre, bien s√ªr, √©tait sur chacune des couches - mais en plus de l'ordre, il y avait d'autres contextes.  Nous avons commenc√© par d√©finir le contexte d√©limit√© de la commande et l'appeler la Commande Client, car en plus de la commande elle-m√™me, il y a les m√™mes blocs que j'ai mentionn√©s au d√©but: livraison, paiement, etc.  √Ä l'int√©rieur du monolithe, tout cela √©tait difficile √† g√©rer: tout changement entra√Ænait une augmentation des d√©pendances, le code √©tait livr√© au prod depuis tr√®s longtemps, et la probabilit√© d'erreurs et de d√©faillances du syst√®me augmentait tout le temps.  Mais nous parlons de cr√©er une commande, la m√©trique principale d'une boutique en ligne - si les commandes ne sont pas cr√©√©es, le reste n'est pas si important.  Une d√©faillance du syst√®me entra√Æne une baisse imm√©diate des ventes. </p><br><p>  Par cons√©quent, nous avons d√©cid√© de transf√©rer le contexte de commande client du syst√®me de traitement des commandes vers un microservice distinct, appel√© Gestion des commandes. </p><br><p><img src="https://habrastorage.org/webt/dh/ce/sc/dhcesca21xejoakcoz4doqe6-qy.png" alt="image"></p><br><h3 id="trebovaniya-i-instrumentariy">  Exigences et outils </h3><br><p>  Apr√®s avoir d√©termin√© le contexte que nous avons d√©cid√© de retirer du monolithe en premier lieu, nous avons form√© les exigences pour notre futur service: </p><br><ul><li>  Performances </li><li>  Coh√©rence des donn√©es </li><li>  Durabilit√© </li><li>  Pr√©visibilit√© </li><li>  La transparence </li><li>  Incr√©ment de changement </li></ul><br><p>  Nous voulions que le code soit aussi clair et facile √† modifier que possible, afin que la prochaine g√©n√©ration de d√©veloppeurs puisse rapidement apporter les modifications n√©cessaires √† l'entreprise. </p><br><p>  En cons√©quence, nous sommes arriv√©s √† une certaine structure que nous utilisons dans tous les nouveaux microservices: </p><br><p>  <strong>Contexte d√©limit√©</strong> .  Chaque nouveau microservice, √† commencer par la gestion des commandes, nous cr√©ons en fonction des besoins de l'entreprise.  Il doit y avoir des explications sp√©cifiques sur quelle partie du syst√®me et pourquoi il est n√©cessaire de le placer dans un microservice s√©par√©. </p><br><p>  <strong>Infrastructure et outils existants.</strong>  Nous ne sommes pas la premi√®re √©quipe de Lamoda √† commencer √† impl√©menter Go; avant nous, il y avait des pionniers - l'√©quipe Go elle-m√™me, qui a pr√©par√© l'infrastructure et les outils: </p><br><ol><li>  Gogi (swagger) est un g√©n√©rateur de sp√©cification de swagger. </li><li>  Gonkey (testing) - pour les tests fonctionnels. </li><li>  Nous utilisons Json-rpc et g√©n√©rons une liaison client / serveur par swagger.  Nous d√©ployons √©galement tout cela sur Kubernetes, collectons des m√©triques dans Prometheus, utilisons ELK / Jaeger pour le tra√ßage - tout cela est inclus dans le bundle que Gogi cr√©e pour chaque nouveau microservice par sp√©cification. </li></ol><br><p>  Voici √† quoi ressemble notre nouveau microservice de gestion des commandes: </p><br><p><img src="https://habrastorage.org/webt/dl/1o/qk/dl1oqkgxhptthhlh-3wgn55q2jm.png" alt="image"></p><br><p>  En entr√©e, nous avons des donn√©es, nous les agr√©gons, les validons, interagissons avec des services tiers, prenons des d√©cisions et transf√©rons les r√©sultats au traitement des commandes - le m√™me monolithe qui est grand, instable et gourmand en ressources.  Cela doit √©galement √™tre pris en compte lors de la cr√©ation d'un microservice. </p><br><h3 id="sdvig-paradigmy">  Changement de paradigme </h3><br><p>  En choisissant Go, nous avons imm√©diatement obtenu plusieurs avantages: </p><br><ul><li>  <strong>Le typage fort statique</strong> coupe imm√©diatement une certaine gamme de bogues possibles. </li><li>  <strong>Le mod√®le de concurrence</strong> correspond bien √† nos t√¢ches, car nous devons nous d√©placer et interroger simultan√©ment plusieurs services. </li><li>  <strong>La composition et les interfaces</strong> nous aident <strong>√©galement</strong> dans les tests. </li><li>  <strong>La ¬´simplicit√©¬ª de l'√©tude</strong> - c'est ici que non seulement des avantages √©vidents ont √©t√© d√©couverts, mais aussi des probl√®mes. </li></ul><br><p>  La langue de Go limite l'imagination du d√©veloppeur.  Cela est devenu une pierre d'achoppement pour notre √©quipe, habitu√©e √† PHP lorsque nous sommes pass√©s au d√©veloppement sur Go.  Nous sommes confront√©s √† un v√©ritable changement de paradigme.  Nous avons d√ª passer par plusieurs √©tapes et comprendre certaines choses: </p><br><ol><li>  Il est difficile de construire des abstractions. </li><li>  On peut dire que go est bas√© sur un objet, mais pas un langage orient√© objet, car il n'y a pas d'h√©ritage direct et d'autres choses. </li><li>  Go aide √† √©crire explicitement, plut√¥t que de cacher des objets derri√®re des abstractions. </li><li>  Allez a pipelining.  Cela nous a inspir√© pour construire des cha√Ænes de processeurs de donn√©es. </li></ol><br><p>  En cons√©quence, nous avons compris que <strong>Go est un langage de programmation proc√©dural.</strong> <br><img src="https://habrastorage.org/webt/i7/yl/hb/i7ylhb2z0jpa2xivzfbwr6vbj-o.png" alt="image"></p><br><h3 id="data-first">  Les donn√©es d'abord </h3><br><p>  Je pensais comment visualiser le probl√®me auquel nous √©tions confront√©s et suis tomb√© sur cette image: </p><br><p><img src="https://habrastorage.org/webt/7j/4d/i8/7j4di8db5uuv2swuxpwdqg3nalg.png" alt="image"></p><br><p>  Il s'agit d'une vision ¬´orient√©e objet¬ª du monde o√π nous construisons des abstractions et fermons des objets derri√®re elles.  Par exemple, voici non seulement une porte, mais un initialiseur de session int√©rieure.  Pas l'√©l√®ve, mais l'interface du moniteur de visiteurs - et ainsi de suite. </p><br><p>  Nous avons abandonn√© cette approche et mis les entit√©s en premier lieu, sans devenir obscurcis par les abstractions. </p><br><p>  En raisonnant de cette fa√ßon, nous avons mis les donn√©es en premier lieu et avons mis un tel Pipelining dans le service: </p><br><p><img src="https://habrastorage.org/webt/-2/nv/nb/-2nvnbuuplectds4ysnfddoae-c.png" alt="image"></p><br><p>  Initialement, nous d√©finissons un mod√®le de donn√©es qui entre dans le pipeline du gestionnaire.  Les donn√©es sont modifiables et les modifications peuvent se produire de mani√®re s√©quentielle et simultan√©e.  Avec cela, nous gagnons en vitesse. </p><br><h3 id="nazad-v-buduschee">  Retour vers le futur </h3><br><p>  Du coup, en d√©veloppant des microservices, nous sommes arriv√©s au mod√®le de programmation des ann√©es 70.  Apr√®s les ann√©es 70, de grands monolithes d'entreprise sont apparus, o√π la programmation orient√©e objet est apparue, et la programmation fonctionnelle - de grandes abstractions qui ont permis de conserver le code dans ces monolithes.  Dans les microservices, nous n'avons pas besoin de tout cela, et nous pouvons utiliser l'excellent mod√®le de CSP ( <em>communicating sequential process</em> ), dont l'id√©e a √©t√© <a href="https://www.cs.cmu.edu/~crary/819-f09/Hoare78.pdf">avanc√©e juste dans les ann√©es 70 par Charles Choir.</a> <a href="https://www.cs.cmu.edu/~crary/819-f09/Hoare78.pdf"><br></a> </p><br><p>  Nous utilisons √©galement Sequence / Selection / Interation - un paradigme de programmation structurelle selon lequel tout le code de programme peut √™tre compos√© des structures de contr√¥le correspondantes. </p><br><p>  Eh bien, la programmation proc√©durale, qui √©tait le courant dominant dans les ann√©es 70 :) </p><br><h3 id="struktura-proekta">  Structure du projet </h3><br><p><img src="https://habrastorage.org/webt/oe/xr/kj/oexrkjhvj4sf1zrx_kuyhvytb58.png" alt="image"></p><br><p>  Comme je l'ai dit, en premier lieu, nous avons mis les donn√©es.  De plus, nous avons remplac√© la construction du projet ¬´√† partir de l'infrastructure¬ª par une construction √† vocation commerciale.  Pour que le d√©veloppeur, en entrant le code du projet, voit imm√©diatement ce que fait le service - c'est la transparence m√™me que nous avons identifi√©e comme l'une des exigences de base pour la structure de nos microservices. </p><br><p>  En cons√©quence, nous avons une architecture plate: une petite couche API et des mod√®les de donn√©es.  Et toute la logique (qui est limit√©e dans notre contexte par les exigences m√©tier d'un microservice) est stock√©e dans des processeurs (gestionnaires). </p><br><p>  Nous essayons de ne pas cr√©er de nouveaux microservices s√©par√©s sans une demande claire de l'entreprise - c'est ainsi que nous contr√¥lons la granularit√© de l'ensemble du syst√®me.  S'il existe une logique √©troitement li√©e au microservice existant, mais se r√©f√©rant essentiellement √† un contexte diff√©rent, nous la concluons d'abord dans les soi-disant services.  Et seulement lorsque survient un besoin commercial constant, nous le retirons dans un microservice distinct, auquel nous nous tournons ensuite en utilisant un appel rpc. </p><br><p>  Afin de contr√¥ler la granularit√© et de ne pas produire de microservices sans r√©fl√©chir, nous concluons une logique qui n'est pas directement li√©e √† ce contexte, mais qui est √©troitement li√©e √† ce microservice, dans la couche services.  Et puis, s'il y a un besoin commercial, nous le prenons dans un microservice distinct - puis nous l'utilisons avec l'appel rpc pour y acc√©der. </p><br><p><img src="https://habrastorage.org/webt/yh/ra/yp/yhraypbd9hd2b6uxu6t83cxgjh4.png" alt="image"></p><br><p>  Ainsi, pour l'API interne dans les processeurs du service, l'interaction ne change en rien. </p><br><h3 id="ustoychivost">  Durabilit√© </h3><br><p>  Nous avons d√©cid√© de ne pas prendre de biblioth√®ques tierces √† l'avance, car les donn√©es avec lesquelles nous travaillons sont assez sensibles.  Nous avons donc fait un peu de v√©lo :) Par exemple, nous avons nous-m√™mes impl√©ment√© des m√©canismes classiques - pour Idempotency, Queue-worker, Fault Tolerance, Compensating transactions.  Notre prochaine √©tape consiste √† essayer de le r√©utiliser.  Enveloppez-vous dans des biblioth√®ques, peut-√™tre des conteneurs lat√©raux dans des pods Kubernetes.  Mais maintenant, nous pouvons appliquer ces mod√®les. </p><br><p>  Nous mettons en ≈ìuvre dans nos syst√®mes un sch√©ma appel√© d√©gradation gracieuse: le service doit continuer √† fonctionner, quels que soient les appels externes dans lesquels nous agr√©gons les informations.  Sur l'exemple de la cr√©ation d'une commande: si la demande est entr√©e dans le service, nous cr√©erons une commande dans tous les cas.  M√™me si le service voisin tombe, qui est responsable d'une partie des informations que nous devons agr√©ger ou valider.  De plus - nous ne perdrons pas la commande, m√™me si nous ne pouvons pas √† court terme refuser le traitement de la commande, o√π nous devons transf√©rer.  C'est √©galement l'un des crit√®res par lesquels nous d√©cidons de mettre la logique dans un service s√©par√©.  Si un service ne peut pas fournir son travail lorsque les services suivants ne sont pas disponibles sur le r√©seau, vous devez soit le reconcevoir, soit vous demander s'il doit √™tre retir√© du monolithe. </p><br><h3 id="go-v-go">  Allez √† Go! </h3><br><p>  Lorsque vous venez d'√©crire des microservices de produits orient√©s m√©tier √† partir d'une architecture classique orient√©e services, en particulier PHP, vous rencontrez un changement de paradigme.  Et il doit √™tre adopt√©, sinon vous pouvez monter sur le r√¢teau sans fin.  La structure commerciale du projet nous permet de ne pas compliquer √† nouveau le code et de contr√¥ler la granularit√© du service. </p><br><p>  L'une de nos t√¢ches principales √©tait d'augmenter la stabilit√© du service.  Bien s√ªr, Go n'offre pas une stabilit√© accrue juste √† la sortie de la bo√Æte.  Mais, √† mon avis, dans l'√©cosyst√®me Go, il s'est av√©r√© plus facile de cr√©er tout le kit de fiabilit√© n√©cessaire, m√™me de vos propres mains, sans avoir recours √† des biblioth√®ques tierces. </p><br><p>  Une autre t√¢che importante consistait √† accro√Ætre la flexibilit√© du syst√®me.  Et ici, je peux certainement dire que le taux d'introduction des changements requis par l'entreprise a consid√©rablement augment√©.  Gr√¢ce √† l'architecture des nouveaux microservices, le d√©veloppeur se retrouve seul avec des fonctionnalit√©s m√©tier; il n'a pas besoin de penser √† la construction de clients, √† l'envoi de surveillance, √† l'envoi de suivi et √† la configuration de la journalisation.  Nous laissons au d√©veloppeur exactement la couche d'√©criture de la logique m√©tier, lui permettant de ne pas penser √† l'ensemble du bundle d'infrastructure. </p><br><p>  Allons-nous tout r√©√©crire sur Go et abandonner PHP? </p><br><p>  Non, puisque nous nous √©loignons des besoins des entreprises, et il existe certains contextes dans lesquels PHP s'int√®gre tr√®s bien - il n'a pas besoin d'une telle vitesse et de la bo√Æte √† outils Go-go enti√®re.  Toute automatisation des op√©rations pour la livraison des commandes et la gestion du studio photo se fait en PHP.  Mais, par exemple, dans la plateforme e-commerce c√¥t√© client, on r√©√©crit presque tout sur Go, car l√† c'est justifi√©. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr478740/">https://habr.com/ru/post/fr478740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr478720/index.html">Diffusions publiques de Heisenbug et Mobius</a></li>
<li><a href="../fr478722/index.html">Six recettes pour un chef d'√©quipe d√©butant: comment suivre tout et d√©velopper une √©quipe</a></li>
<li><a href="../fr478726/index.html">Meetup OWASP Moscou # 9</a></li>
<li><a href="../fr478734/index.html">Boutons de forme personnalis√©s dans l'interface utilisateur Unity</a></li>
<li><a href="../fr478736/index.html">L'avenir de l'intelligence artificielle dans le syst√®me √©ducatif: tout ce qu'il faut savoir</a></li>
<li><a href="../fr478750/index.html">Biblioth√®ques de visualisation de donn√©es r√©elles pour les d√©veloppeurs React</a></li>
<li><a href="../fr478752/index.html">Histoire des syst√®mes de contr√¥le de version</a></li>
<li><a href="../fr478758/index.html">Grand guide des balises UTM: comment savoir d'o√π viennent les utilisateurs</a></li>
<li><a href="../fr478760/index.html">L'enfer "z√©ro" et comment s'en sortir</a></li>
<li><a href="../fr478764/index.html">Erreurs JavaScript: correction, traitement, r√©paration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>