<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòä üíö üö≤ RobotDyn Strikes Double: Mega + ESP8266 üë®üèæ‚Äçüåæ üë¶üèº üë∞üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Que fait un d√©veloppeur dans de rares heures de loisirs? C'est vrai, parcourant les listes de prix des magasins de fer. Il y avait une minute gratuite...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RobotDyn Strikes Double: Mega + ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402429/"><img src="https://habrastorage.org/files/07a/66b/52f/07a66b52ff5d4326bcef6a7fd2749aef.jpg" alt="RobotDyn Mega + ESP8266"><br>  Que fait un d√©veloppeur dans de rares heures de loisirs?  C'est vrai, parcourant les listes de prix des magasins de fer.  Il y avait une minute gratuite et j'ai d√©cid√© de parcourir les pages des boutiques en ligne populaires - l'ennui, rien d'int√©ressant, nous avons d√©j√† vu tout cela ... et puis soudain mes yeux tombent sur le prochain Mega.  Bah!  Oui, ce n'est pas seulement Mega, mais combin√© √† l'ESP8266 bien-aim√© de tout le monde et soigneusement √©quip√© de commutateurs pour que deux contr√¥leurs fonctionnent ensemble - c√¢bl√©s (en utilisant Ethernet Shield) avec beaucoup de GPIO et Wi-Fi pour les communications sans fil. <br><br>  Pas mal!  J'ai pens√© et me suis souvenu de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AMS</a> - vous pouvez y installer deux serveurs - c√¢bl√©s et sans fil et les connecter en un seul syst√®me - ESP8266 recevra 54 broches num√©riques et 16 broches analogiques, et Mega recevra le contr√¥le sans fil via Wi-Fi et tous les petits pains ESP8266.  Il y a longtemps, je ne suis pas tomb√© sur un tableau aussi int√©ressant. <br><br>  - Bonjour!  Avez-vous une carte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mega + ESP8266</a> ? <br>  - Oui, mais il n'en reste qu'un. <br>  "Pourquoi un seul?" <br>  - Le reste a √©t√© d√©mont√©. <br>  "R√©servez-la, s'il vous pla√Æt, pour moi." <br><a name="habracut"></a><br><h2>  Quelques mots sur l'entreprise </h2><br>  J'ai aim√© RobotDyn deux choses: la premi√®re - avec ses solutions technologiques.  Il n'est pas n√©cessaire d'aller loin, un excellent exemple est la carte Mega + ESP8266 √† l'√©tude.  Quelque chose comme √ßa que je n'ai pas vu dans nos magasins en ligne (et pas dans le n√¥tre, mais je ne l'ai pas vraiment cherch√© ici).  Et ce n'est pas le seul exemple, il y a toujours l'option Uno + ESP8266 et l'entreprise ne va clairement pas s'arr√™ter l√†, apparemment il y a encore beaucoup d'appareils int√©ressants qui nous attendent. <br><br>  Et le second est sa politique de prix.  Je ne m'attarderai pas sur cette question ici en d√©tail, mais je dirai que les prix m'ont agr√©ablement surpris - la devise de la soci√©t√© est "Les prix sont comme sur Aliexpress". <br><br>  En un mot, j'ai d√©crit le contexte sur lequel tous les √©v√©nements ult√©rieurs se d√©rouleront, maintenant nous allons directement aux d√©tails techniques et √† une description de la carte et comment travailler avec elle. <br><br><h2>  Le conseil lui-m√™me </h2><br>  En g√©n√©ral, une carte ordinaire, pas tr√®s diff√©rente de beaucoup de cartes similaires, sinon pour une petite partie, √† savoir la puce ESP8266EX int√©gr√©e dans la carte.  Cela transf√®re imm√©diatement la carte dans la cat√©gorie des solutions extraordinaires.  Je veux attirer votre attention sur un d√©tail suppl√©mentaire - la carte n'int√®gre pas un module standard tel que l'ESP-12, mais la puce et tout le c√¢blage sont effectu√©s sur la carte elle-m√™me, ce qui fait allusion de mani√®re transparente au niveau des d√©veloppeurs.  Je tiens √©galement √† noter que la carte a √† la fois une antenne imprim√©e et un connecteur pour connecter une antenne externe, ce qui dans de nombreux cas peut √™tre tr√®s utile. <br><img src="https://habrastorage.org/files/1d1/cee/155/1d1cee155967488581228289df3b6f28.jpg" alt="RobotDyn Mega + ESP8266"><br>  Il y a des connecteurs √† broches sur la carte pour la connexion aux bornes ESP8266 et plusieurs commutateurs, qui m√©ritent d'√™tre mentionn√©s un peu plus.  L'id√©e principale de l'utilisation de la carte est qu'en utilisant les commutateurs, vous pouvez configurer l'interaction de ses trois composants de diff√©rentes mani√®res: la puce Atmega2560, la puce ESP8266EX et le convertisseur CH340G USB-TTL.  Des connexions simples et complexes sont possibles, ce qui vous permet d'organiser de nombreuses options pour l'interaction de toutes les parties de la carte.  Cela ouvre de grandes opportunit√©s pour la construction de divers appareils, mais plus √† ce sujet plus tard. <br><br><img src="https://habrastorage.org/files/cb4/2f4/819/cb42f4819ba940369ad71818bbc7ff03.jpg" alt="ESP8266 broches"><br><br>  Je veux √©galement noter la capacit√© de charge d√©cente de la carte.  √Ä en juger par les inscriptions, il est capable de fournir un courant de charge de 1,6 A sur un canal de 5 volts et de 1 A sur un 3,3 volts.  Ce qui est tr√®s bon, surtout dans l'ensemble. <br><br>  Il n'y a plus rien √† dire sur la carte, nous nous tournons vers l'installation du logiciel et son test. <br><br><h2>  Test de carte </h2><br>  √âtant donn√© que la carte est int√©gr√©e et qu'il n'y a pratiquement pas d'espace libre sur elle, et que le c√¢blage de la partie haute fr√©quence de l'ESP8266EX est fait dessus, au d√©but, des doutes ont surgi sur le fonctionnement correct et sans probl√®me de toute cette √©conomie. <br><br>  Pour l'avenir, je dirai que malgr√© mes pr√©occupations, tout fonctionne de mani√®re stable et comme pr√©vu.  Nous connectons les commutateurs de la carte Atmega2560 √† USB - nous obtenons l'Arduino Mega, nous connectons l'ESP8266EX √† USB - nous obtenons l'ESP8266, nous passons au mode de connexion de l'Atmega2560 avec l'ESP8266EX nous obtenons la connexion entre les puces via l'interface s√©rie.  Tout fonctionne exactement comme d√©crit dans la documentation et exactement comme pr√©vu intuitivement. <br><br>  Un √©norme avantage de cette solution est que les d√©veloppeurs ont pris soin de faire correspondre les niveaux de signal logique de tous les composants du syst√®me.  Quiconque a essay√© manuellement de configurer le module ESP8266 et de connecter correctement toutes les r√©sistances de pull-up me comprendra.  Il n'y a pas de tels probl√®mes, tout votre travail est r√©duit √† cliquer sur les commutateurs de la carte conform√©ment aux instructions du fabricant. <br><br><h2>  Test de charge </h2><br>  Comment tester la planche?  Vous pouvez t√©l√©charger un croquis standard, mais ce sera un test pour rien.  Cette option peut fonctionner correctement et dans des conditions de combat, le syst√®me √©chouera.  Par cons√©quent, le travail des deux parties sous le contr√¥le des versions correspondantes de l'Arduino Mega Server a √©t√© choisi comme test de charge dure.  Pour Mega - Arduino Mega Server pour Mega et pour ESP8266 - Arduino Mega Server pour ESP8266 dans la version M1. <br><br>  Le kit de distribution M1 a √©t√© choisi en raison du fait que seulement 1 Mo de m√©moire flash pour ESP8266 est install√© sur la carte.  √Ä mon avis, c'est presque la seule erreur pour les d√©veloppeurs - dans les futures r√©visions de la carte, je recommanderais de mettre des puces de m√©moire de 4 Mo.  La diff√©rence de prix est faible et les possibilit√©s d'utilisation de la version avec 4 Mo sont bien plus importantes.  Mais comme il existe une version AMS pour les syst√®mes de 1 Mo, je n'ai pas pr√™t√© beaucoup d'attention √† ce point et j'ai continu√© les tests. <br><br>  Que dire?  Nous allumons la carte, remplissons le logiciel et obtenons deux serveurs ind√©pendants.  Un c√¢bl√© sur Ethernet Shield et un sans fil sur Wi-Fi.  La beaut√©! <br><br>  Je voudrais √©galement noter que m√™me l'ajout d'un bouclier Ethernet avec un lecteur de carte √† ce syst√®me d√©j√† sophistiqu√© n'a pas caus√© de conflits ou de pannes - tout a simplement fonctionn√© comme il se doit.  Et dans certains cas, c'est encore mieux que d'habitude - c'est la premi√®re carte sur laquelle le micrologiciel en direct ESP8266 a r√©ussi dans 100% des cas, sur toutes les autres cartes et modules, il y a des √©checs de temps en temps avec un tel clignotement. <br><br>  Et deux serveurs tournent, chargent la planche, remplissent leurs fonctions et ... c'est tout.  Tout fonctionne, il n'y a rien √† dire, mais c'est probablement le meilleur √©loge pour tout syst√®me technique. <br><br><h2>  Le plus int√©ressant </h2><br>  Ce que j'ai d√©crit ici est int√©ressant d'un point de vue purement acad√©mique: une planche int√©ressante, une solution technique int√©ressante, mais bien s√ªr nous nous int√©ressons √† son application pratique.  Quel est son point fort pratique et appliqu√©? <br><br>  Le fait est qu'avec un interrupteur sur la carte, vous pouvez connecter deux de ses pi√®ces (Mega et ESP) en une seule unit√© et ainsi, d'une part, obtenir un nouveau syst√®me de qualit√© et, d'autre part, compenser les d√©fauts inh√©rents √† chacune de ses pi√®ces individuelles. <br><br>  Commen√ßons par l'ESP8266.  Le principal inconv√©nient de cette excellente solution est le manque catastrophique de broches GPIO.  Comme on dit, un, deux et mal calcul√©.  Il est difficile de dire ce que les d√©veloppeurs de cette puce pensaient, mais avant la sortie de l'ESP32, ils avaient un peu plus de temps pour r√©fl√©chir et ils ont corrig√© cette lacune dans la nouvelle puce.  Mais nous traitons sp√©cifiquement du 8266. <br><br>  Cette carte vous permet de faire bouger un cheval et d'utiliser toute la puissance de Mega, et ce, entre autres, 54 sorties num√©riques et 16 sorties analogiques dans l'ESP8266.  Autrement dit, notre ESP branlant obtient soudainement de grandes opportunit√©s pour travailler avec des capteurs, des actionneurs et d'autres p√©riph√©riques.  Il s'av√®re, pour ainsi dire, b√©b√© ESP sous st√©ro√Ødes. <br><br>  Ce n'est qu'une des options possibles pour utiliser la planche, allong√©e √† la surface. <br><br>  Voyons maintenant Mega.  Elle n'interf√®re pas avec l'interface sans fil et la capacit√© d'interagir avec les appareils Wi-Fi, ce qui peut lui permettre de s'int√©grer √† la partie ESP du syst√®me.  Et en m√™me temps, la possibilit√© d'un fonctionnement en parall√®le via une interface Ethernet filaire demeure. <br><br>  Et ce n'est √©galement qu'une des applications possibles de cette planche, allong√©e en surface. <br><br>  Eh bien, diverses options de pont: Ethernet - Wi-Fi, nRF24 - Ethernet, nRF24 - Wi-Fi, nRF24 (1) - nRF24 (2), nooLite - Wi-Fi, nooLite - Ethernet, nooLite (1) - nooLite (2 ), etc., etc. √† l'infini.  Vous pouvez acheminer les signaux de dizaines de sous-syst√®mes avec lesquels l'Arduino Mega Server fonctionne entre les deux parties de la carte et les interfaces qui leur sont connect√©es. <br><br>  Je ne sais m√™me pas quoi dire.  Tr√®s cool. <br><br><h2>  D√©tails techniques </h2><br>  Maintenant, un peu sur les d√©tails techniques.  Vous voyez un tableau dans lequel tous les modes de fonctionnement possibles de la carte sont pr√©sent√©s et toutes les positions possibles des interrupteurs sur celle-ci sont affich√©es.  Examinons bri√®vement chaque mode. <br><br><img src="https://habrastorage.org/files/a51/cc7/874/a51cc7874a274215b06fc93c7d7dbd4d.png" alt="Tableau des modes de fonctionnement de la carte RobotDyn"><br><br><h4>  Arduino Mega 2560 </h4><br>  Le mode de fonctionnement le plus simple de la carte, dans le tableau, il est d√©sign√© comme mode 3. Si vous r√©glez les commutateurs 3 et 4 sur la position ON, et le reste sur la position OFF, nous obtenons l'Arduino Mega 2560 habituel. Rien d'int√©ressant, pour cela, cela ne valait pas la peine d'acheter cette carte, vous pouvez √©tait d'acheter le Mega habituel. <br><br><h4>  ESP8266 </h4><br>  Ce n'est pas non plus un mode de fonctionnement tr√®s int√©ressant.  Dans le tableau, il est divis√© en deux sous-modes, d√©sign√©s par 1 (chargement de l'esquisse dans ESP) et 2 (mode de connexion ESP √† USB).  C'est toute la fonctionnalit√© de l'ESP8266 standard et pour une telle utilisation, cela ne valait pas la peine d'acheter cette carte, vous pouvez vous en tirer avec le module ESP habituel. <br><br><h4>  Tous sont ind√©pendants </h4><br>  Nous ne consid√©rons pas non plus cette option au num√©ro 6, car en elle toutes les connexions entre les parties de la carte sont rompues et elle ne peut certainement nous √™tre utile pour rien. <br><br><h4>  La connexion entre Mega et ESP </h4><br>  Dans ce mode, d√©sign√© par 5, la communication est √©tablie entre Mega et ESP via une interface s√©rie, mais il n'y a pas de communication avec le convertisseur USB-TTL.  ESP utilise Serial standard, tandis que Mega n'utilise pas moins Serial3 standard.  La connexion fonctionne de mani√®re stable et transparente √† une vitesse de 115200. Il s'agit d'un mode de fonctionnement plut√¥t sp√©cifique lorsqu'aucun contr√¥leur n'a de connexion USB.  Et donc il n'est pas non plus tr√®s int√©ressant pour nous. <br><br><h4>  Communication entre Mega et ESP et Mega et USB en m√™me temps </h4><br>  Mais c'est ce qu'on appelle un atout.  Nous avons tout √† la fois - la connexion Mega USB et la possibilit√© de t√©l√©charger des croquis sur Mega et de contr√¥ler son fonctionnement via le m√™me USB, la possibilit√© de communication entre Mega et ESP et la possibilit√© de t√©l√©charger des croquis sur l'ESP8266 et de contr√¥ler son fonctionnement dans l'interface USB ... Mega!  C'est-√†-dire une farce compl√®te, sans quitter directement la caisse. <br><br>  Il s'agit du seul mode de fonctionnement correct r√©pertori√© dans le tableau.  Rappelez-vous son num√©ro gagnant, qui est quatre.  Dans la configuration des commutateurs sur la carte, il est √©galement magnifique - 1, 2, 3, 4 sont en position ON, les autres sont OFF. <br><br>  Un lecteur attentif vous demandera: comment t√©l√©charger des croquis sur l'ESP8266 si le port USB est occup√© √† se connecter √† la m√©ga-partie du syst√®me?  Et c'est la bonne question, la r√©ponse n'est pas possible.  Et pourquoi, alors, √©crivez-vous que dans cette configuration, nous pouvons t√©l√©charger des croquis sur ESP8266?  Parce que l'Arduino Mega Server a la possibilit√© de t√©l√©charger des croquis en direct directement √† partir de l'IDE Arduino en appuyant sur quelques boutons, donc c'est vrai - nous avons un rembourrage complet, tout fonctionne imm√©diatement. <br><br>  Mais qu'en est-il de ceux qui veulent utiliser la carte sans Arduino Mega Server?  Il n'y a que deux options: cliquez constamment sur les commutateurs ou ajoutez la possibilit√© de t√©l√©charger des croquis dans les airs dans vos conceptions.  Personnellement, j'aime davantage la deuxi√®me option. <br><br><h2>  Param√®tres IDE Arduino </h2><br>  Les param√®tres Arduino IDE pour Mega ne posent pas de questions, tout y est standard, et pour ESP8266 je donnerai une capture d'√©cran du menu avec les param√®tres pour une impl√©mentation sp√©cifique de la partie ESP sur la carte RobotDyn.  Vous devez d√©finir les m√™mes param√®tres pour vous-m√™me, √† l'exception du num√©ro de port - sur votre syst√®me, il aura tr√®s probablement une valeur diff√©rente. <br><br><img src="https://habrastorage.org/files/e1f/d98/bac/e1fd98bacc664b7e931699cb65b1c6ae.png" alt="Param√®tres ESP8266 dans Arduino IDE"><br><br><h2>  Arduino Mega Server pour RobotDyn Mega + ESP8266 </h2><br>  Pour cette carte, une version sp√©ciale double du Arduino Mega Server a √©t√© publi√©e, qui contient deux serveurs √† la fois, optimis√©s sp√©cifiquement pour cette carte.  C'est l'ext√©rieur de la question, ces deux serveurs contiennent des fonctionnalit√©s standard et peuvent √™tre utilis√©s pour n'importe lequel de vos projets. <br><br>  Vous pouvez utiliser ces deux serveurs ind√©pendamment sur la m√™me carte, ou vous pouvez ajouter les fonctionnalit√©s dont vous avez besoin et les utiliser en tandem et en mode pont entre deux r√©seaux et toutes les interfaces connect√©es aux serveurs. <br><br>  Le premier assemblage Arduino Mega Server pour la carte RobotDyn Mega + ESP8266 contient un exemple de test de l'interaction de deux contr√¥leurs via une interface s√©rie.  Il s'agit d'une d√©monstration des capacit√©s de la technologie sur la base de laquelle vous pouvez d√©velopper vos propres solutions. <br><br>  Maintenant, un peu plus sur le d√©veloppement d'un protocole pour l'interaction de deux contr√¥leurs via l'interface s√©rie en g√©n√©ral et sur cette carte en particulier. <br><br><h2>  D√©veloppement de protocoles </h2><br>  Que devons-nous construire une maison?  Besoin de d√©velopper un protocole d'interaction entre les deux parties du syst√®me via l'interface s√©rie?  - nous allons d√©velopper, ici l'essentiel est de d√©finir clairement et correctement la t√¢che.  Pour d√©montrer le fonctionnement en tandem du syst√®me, nous affichons les indicateurs de fonctionnement ¬´partenaire¬ª dans le tableau de bord de chaque serveur. <br><br>  <em><strong>Un peu de terminologie.</strong></em>  <em>Pour Mega, le ¬´partenaire¬ª est ESP8266, pour ESP8266, respectivement, Mega.</em> <br><br>  Lorsque le partenaire travaille, l'indicateur devient vert, lorsqu'il ne fonctionne pas, rouge et gris lorsque l'√©tat n'est pas d√©fini.  C'est tr√®s pratique - pendant le fonctionnement, vous verrez imm√©diatement l'√©tat de l'alter ego de votre syst√®me. <br><br>  Pour une solution pratique √† ce probl√®me, il y a exactement un million de fa√ßons, nous choisirons les suivantes: les blocs de communication des deux parties du syst√®me seront identiques, l'interaction se produira en mode duplex int√©gral, les blocs d'informations auront un format simple et compr√©hensible: <br><br><pre><code class="java hljs">?=</code> </pre> <br>  ou <br><br><pre> <code class="java hljs">?</code> </pre><br>  Ceci est juste un exemple de test pour r√©soudre la t√¢che, vous pouvez modifier ce protocole d'interaction ou √©crire le v√¥tre, adapt√© √† vos t√¢ches.  Mais sur le protocole d√©j√† impl√©ment√©, vous pouvez non seulement surveiller l'√©tat du partenaire, mais aussi l'utiliser √† de nombreuses autres fins, par exemple pour transmettre l'√©tat des broches du contr√¥leur, l'√©tat des capteurs ou envoyer des commandes de contr√¥le au partenaire. <br><br>  Plus pr√©cis√©ment, dans notre syst√®me, les √©quipes ressembleront √† ceci: <br><br>  <strong>? mega = 1</strong> - Mega envoie des donn√©es sur ses performances.  Param√®tre "m√©ga", valeur "1". <br><br>  <strong>? esp = 1</strong> - ESP8266 envoie des donn√©es sur sa sant√©.  Le param√®tre est "esp", la valeur est "1". <br><br>  Par exemple, consid√©rons la mise en ≈ìuvre du protocole pour la m√©ga-partie du syst√®me. <br><br>  De mani√®re standard, nous initialisons le module AMS et le mat√©riel Serial3 Mega √† une vitesse de 115200. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">robotdynInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial3.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>); modulRobotdyn = MODUL_ENABLE; started(<span class="hljs-string"><span class="hljs-string">"RobotDyn"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }</code> </pre><br>  Nous v√©rifions l'√©tat du port Serial3 et dans le cas des donn√©es du partenaire, nous formons la variable cha√Æne serialReq contenant les donn√©es ou commandes re√ßues. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSerial</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial3.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sFlag) { serialReq = <span class="hljs-string"><span class="hljs-string">""</span></span>; sFlag = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = Serial3.read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">10</span></span>) { sFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; parseSerialStr(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">13</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// skip } else { if (serialReq.length() &lt; MAX_SERIAL_REQ) { serialReq += c; } } // if } // while (Serial3.available() &gt; 0) } // checkSerial()</span></span></code> </pre><br>  Nous analysons les commandes et les donn√©es, et en cas d'informations sur l'√©tat du partenaire, nous prenons des mesures sous forme de modification de l'√©tat de la variable esp. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseSerialCmd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String command, parameter; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"?"</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pBegin = serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"?"</span></span>)) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pParam = serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)); command = serialReq.substring(pBegin, pParam); parameter = serialReq.substring(pParam + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { command = serialReq.substring(pBegin); parameter = <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command != F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { Serial.print(F(<span class="hljs-string"><span class="hljs-string">"command/parameter: "</span></span>)); Serial.print(command); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"/"</span></span>)); Serial.println(parameter); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter == F(<span class="hljs-string"><span class="hljs-string">"1"</span></span>)) { esp = <span class="hljs-number"><span class="hljs-number">1</span></span>; espTimer = millis(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } } <span class="hljs-comment"><span class="hljs-comment">// if (request.indexOf(F("?")) &gt;= 0) } // parseSerialCmd()</span></span></code> </pre><br>  Vous pouvez facilement ajouter le traitement de toute autre commande en modifiant et en ajoutant √† la section de code correspondante. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter == F(<span class="hljs-string"><span class="hljs-string">"1"</span></span>)) { esp = <span class="hljs-number"><span class="hljs-number">1</span></span>; espTimer = millis(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Si vous utilisez beaucoup de commandes et de donn√©es dans vos propres projets et analyses, cette section de code est pr√©f√©rable de concevoir sous la forme de fonctions correspondantes. <br><br>  Il ne reste plus qu'√† consid√©rer la fonction standard du module AMS, qui est responsable de son travail.  Tout d'abord, l'√©tat du port est v√©rifi√©, puis toutes les quatre secondes, une commande est envoy√©e au partenaire que Mega est en vie et fonctionne, et le temps √©coul√© depuis la r√©ception des derni√®res donn√©es du partenaire est v√©rifi√©, et s'il d√©passe 8 secondes, il est conclu que le partenaire ne fonctionne pas. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">robotdynWork</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ checkSerial(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle4s) { Serial3.println(F(<span class="hljs-string"><span class="hljs-string">"?mega=1"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - espTimer &gt; <span class="hljs-number"><span class="hljs-number">8000</span></span>) { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } }</code> </pre><br>  C‚Äôest de la magie.  C'est vrai, rien de compliqu√©? <br><br><div class="spoiler">  <b class="spoiler_title">Code complet du module responsable des communications intersyst√®mes entre Mega 2560 et ESP8266</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* Modul RobotDyn part of Arduino Mega Server project */</span></span> #ifdef ROBOTDYN_FEATURE bool sFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> espTimer = millis(); <span class="hljs-comment"><span class="hljs-comment">// Serial request #define MAX_SERIAL_REQ 32 String serialReq = ""; void robotdynInit() { Serial3.begin(115200); modulRobotdyn = MODUL_ENABLE; started("RobotDyn", true); } void printSerialStr() { Serial.print("["); Serial.print(serialReq); Serial.println("]"); } void parseSerialCmd() { String command, parameter; if (serialReq.indexOf(F("?")) &gt;= 0) { int pBegin = serialReq.indexOf(F("?")) + 1; if (serialReq.indexOf(F("=")) &gt;= 0) { int pParam = serialReq.indexOf(F("=")); command = serialReq.substring(pBegin, pParam); parameter = serialReq.substring(pParam + 1); } else { command = serialReq.substring(pBegin); parameter = ""; } // if (command != F("esp")) { Serial.print(F("command/parameter: ")); Serial.print(command); Serial.print(F("/")); Serial.println(parameter); //} if (command == F("esp")) { if (parameter == F("1")) { esp = 1; espTimer = millis(); } else { esp = 0; } } } // if (request.indexOf(F("?")) &gt;= 0) } // parseSerialCmd() void parseSerialStr() { if (serialReq[0] == '?') { parseSerialCmd(); } else { printSerialStr(); } } void checkSerial() { while (Serial3.available() &gt; 0) { if (sFlag) { serialReq = ""; sFlag = false; } char c = Serial3.read(); if (c == 10) { sFlag = true; parseSerialStr(); } else if (c == 13) { // skip } else { if (serialReq.length() &lt; MAX_SERIAL_REQ) { serialReq += c; } } // if } // while (Serial3.available() &gt; 0) } // checkSerial() void robotdynWork() { checkSerial(); if (cycle4s) { Serial3.println(F("?mega=1")); if (millis() - espTimer &gt; 8000) { esp = 0; } } } #endif // ROBOTDYN_FEATURE</span></span></code> </pre><br></div></div><br><h2>  A quoi ressemble la sortie sur le moniteur s√©rie </h2><br>  Dans le moniteur s√©rie Mega 2560, la sortie, les donn√©es et les commandes de la partie ESP du syst√®me ressemblent exactement √† la sienne.  Afin de distinguer la sortie du partenaire de la sortie de Mega, ses donn√©es sont entour√©es de guillemets carr√©s.  Dans ce cas, vous pouvez voir le red√©marrage de l'ESP8266 et le journal de d√©marrage AMS dans le moniteur s√©rie de Mega. <br><br><img src="https://habrastorage.org/files/a03/904/3b8/a039043b86d442d7a54e10bb73b314c7.png" alt="Sortie ESP8266 vers un moniteur de la s√©rie Mega 2560"><br><br>  Et le journal de l'√©change r√©el de commandes entre les deux parties du syst√®me via l'interface s√©rie.  Vous voyez la sortie de l'ESP8266 avec des informations sur le d√©codage des donn√©es d'√©tat Mega dans l'interface s√©rie de Mega, entre guillemets carr√©s. <br><br><img src="https://habrastorage.org/files/b5f/444/6cf/b5f4446cf54c4c048fa568f1e3418823.png" alt="Sortie ESP8266 sur le d√©codage Mega Command"><br><h2>  La beaut√© dans l'interface </h2><br>  Maintenant, un peu sur la fa√ßon dont tout cela ressemble √† l'interface Arduino Mega Server.  Pour commencer, je vais donner des captures d'√©cran des deux parties du syst√®me au travail. <br><br><img src="https://habrastorage.org/files/774/faf/c92/774fafc92eb54ba29905a6ec201501da.png" alt="Arduino Mega Server pour RobotDyn Mega + ESP8266"><br><br>  Les points de suspension sont entour√©s d'inscriptions identifiant le contr√¥leur et la partie du syst√®me avec laquelle vous travaillez actuellement.  Les cercles sont entour√©s d'indicateurs qui indiquent le statut du partenaire.  Pour le moment, tout est en ordre, les deux parties du syst√®me fonctionnent normalement et interagissent normalement entre elles via l'interface interne.  Si quelque chose ne va pas, vous le saurez apr√®s un maximum de 8 secondes. <br><br><img src="https://habrastorage.org/files/f49/7ef/a1f/f497efa1ff1f427a860d4e61cdc5e13d.png" alt="Quelque chose a mal tourn√©"><br><br>  Quelque chose a mal tourn√©.  L'ESP8266 a re√ßu une mise √† jour du firmware par voie a√©rienne et la m√©ga-partie du syst√®me a enregistr√© le moment de son red√©marrage.  Apr√®s quelques secondes, la partie ESP du syst√®me reprendra et le voyant s'√©teindra en rouge. <br><br>  Pour plus de commodit√©, lorsque vous survolez l'indicateur d'√©tat du partenaire, un indice appara√Æt et vous pouvez cliquer dessus et dans une fen√™tre distincte, l'interface de la deuxi√®me partie du syst√®me, dans ce cas la partie ESP, s'ouvre.  Cela se fait par commodit√©, vous pouvez √† tout moment ouvrir en un clic l'interface de la deuxi√®me partie du syst√®me. <br><br><img src="https://habrastorage.org/files/d00/a61/a28/d00a61a28c6b439086a42e4510e896cb.png" alt="Info-bulle pour AMS"><br><br><h2>  Id√©es de projets </h2><br>  Maintenant, un peu sur ce que vous pouvez faire de tout cela, avoir un peu d'imagination.  La planche habituelle, compl√®tement discr√®te √† premi√®re vue, vous permet de faire beaucoup de choses compl√®tement inhabituelles et int√©ressantes.  Cela est particuli√®rement vrai de la combinaison avec l'Arduino Mega Server. <br><br>  Donc, la premi√®re chose qui me vient √† l'esprit: <br><br>  <strong>Transf√©rer les donn√©es des capteurs entre les contr√¥leurs.</strong>  Des deux c√¥t√©s et en quantit√©s illimit√©es.  C'est un syst√®me qui a les avantages de ses deux parties, et les possibilit√©s ne s'ajoutent pas seulement, mais ce qu'on appelle un effet synergique est observ√©. <br><br>  <strong>Le pont entre les interfaces.</strong>  Arduino Mega Server peut fonctionner avec de nombreuses interfaces et ce syst√®me vous permet d'acheminer des donn√©es et des commandes entre toutes les interfaces filaires et sans fil connect√©es. <br><br>  <strong>Travaillez sur le m√™me r√©seau</strong> lorsque Mega via Ethernet Shield et ESP8266 via Wi-Fi communiquent avec des appareils c√¢bl√©s et sans fil sur le m√™me r√©seau. <br><br>  <strong>Fonctionne dans diff√©rents r√©seaux</strong> lorsque Mega est connect√© √† Ethernet c√¢bl√© et ESP8266 via Wi-Fi √† un autre r√©seau et que le syst√®me achemine les commandes et les donn√©es d'un r√©seau √† un autre. <br><br>  <strong>La sortie d'une partie du syst√®me dans l'interface d'une autre.</strong>  Via Ethernet √† l'aide de flux Web standard ou via une connexion s√©rie interne. <br><br>  <strong>D√©bogage</strong>  Une partie du syst√®me peut agir comme d√©bogueur et testeur d'une autre partie du syst√®me selon votre programme. <br><br>  <strong>Minuteur de surveillance.</strong>  Chaque contr√¥leur peut agir comme une sorte de chien de garde par rapport √† un autre. <br><br>  <strong>√âchecs de journalisation.</strong>  Chaque contr√¥leur peut garder des journaux du travail de son partenaire, compiler des statistiques et rapporter des situations alarmantes. <br><br>  <strong>Base de donn√©es pour ESP8266.</strong>  En utilisant ce syst√®me, vous pouvez organiser quelque chose comme une base de donn√©es SQL sur Mega pour ESP8266.  ESP fait son travail, et Mega agit comme un syst√®me de stockage (jusqu'√† 32 Go). <br><br>  <strong>Se clignotant.</strong>  Les contr√¥leurs peuvent reflasher dynamiquement les uns les autres conform√©ment √† la logique int√©gr√©e ou √† l'arriv√©e d'une commande de contr√¥le externe. <br><br>  <strong>Connecter les modules.</strong>  Les contr√¥leurs peuvent se connecter √† divers p√©riph√©riques qui ont des probl√®mes de connexion √† une partie du syst√®me. <br><br>  Et ainsi de suite et ainsi de suite, je pense qu'un lecteur curieux sera en mesure de trouver ind√©pendamment de nombreuses fa√ßons non moins int√©ressantes d'utiliser ce syst√®me. <br><br><h2>  Conclusion </h2><br>  √Ä mon avis, c'est une solution tr√®s int√©ressante, et nous devons dire un grand merci √† RobotDyn pour des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">frais aussi</a> int√©ressants.  Je le dis au moins sinc√®rement. <br><br>  T√©l√©chargez le kit de distribution Arduino Mega Server pour RobotDyn Mega + ESP8266 et v√©rifiez personnellement la validit√© de tout ce qui est √©crit ici, vous pouvez sur le site officiel du projet Arduino Mega Server dans la section de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t√©l√©chargement</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr402429/">https://habr.com/ru/post/fr402429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr402417/index.html">Le cycliste s'est gliss√© inaper√ßu</a></li>
<li><a href="../fr402419/index.html">Analyser la nouvelle Nintendo Switch</a></li>
<li><a href="../fr402421/index.html">Semaine de V√©nus dans l'h√©misph√®re Nord</a></li>
<li><a href="../fr402423/index.html">Pratique linguistique hors ligne</a></li>
<li><a href="../fr402425/index.html">Les chimistes sont les premiers √† appr√©cier les avantages des ordinateurs quantiques</a></li>
<li><a href="../fr402431/index.html">ONYX BOOX Vasco Da Gama: plus intelligent qu'un livre, plus simple qu'une tablette</a></li>
<li><a href="../fr402433/index.html">Histoire des gratte-ciel</a></li>
<li><a href="../fr402435/index.html">Digest "World Hi-Fi": audio portable, logiciel, formats et vinyle</a></li>
<li><a href="../fr402437/index.html">IPTV plus mince que RMB</a></li>
<li><a href="../fr402439/index.html">G√©olocalisation commerciale: la vie priv√©e est bon march√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>