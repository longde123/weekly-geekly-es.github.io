<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§§ üë©üèΩ‚Äçüç≥ üîñ Perl 5: Wie Makros Fehler versteckten ü§æüèæ üöΩ üö™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um die Liste der Open Source-Programmiersprachen zu erg√§nzen, die mit dem statischen Code-Analysator PVS-Studio getestet wurden, wurde Perl 5 ausgew√§h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Perl 5: Wie Makros Fehler versteckten</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/425415/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/134/949/fad/134949fad7cf6d492a3eb7324942b640.png"></div><br>  Um die Liste der Open Source-Programmiersprachen zu erg√§nzen, die mit dem statischen Code-Analysator PVS-Studio getestet wurden, wurde Perl 5 ausgew√§hlt. In diesem Artikel werden Fehler und Schwierigkeiten beim Anzeigen der Analyseergebnisse festgestellt.  Die Anzahl der Makros im Code ist so gro√ü, dass es den Anschein hat, dass der Code nicht in C geschrieben ist, sondern in einem seltsamen Dialekt.  Trotz der Schwierigkeiten beim Anzeigen des Codes konnte ich interessante Probleme sammeln, die in diesem Artikel behandelt werden. <br><br><h2>  Einf√ºhrung </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Perl</a> ist eine interpretierte dynamische Allzweck-Programmiersprache auf hoher Ebene (Perl ist eine Familie von zwei interpretierten dynamischen Allzweck-Programmiersprachen f√ºr allgemeine Zwecke).  Perl 5 wurde 1994 eingef√ºhrt.  Nach ein paar Jahrzehnten verursacht C-Code mit zahlreichen Makros bei modernen Programmierern Nervosit√§t. <br><br>  Der Quellcode f√ºr Perl 5 wurde aus dem offiziellen <a href="">Repository</a> ( <i>Blead</i> Branch) <i>entnommen</i> .  Zur √úberpr√ºfung des Projekts haben wir den statischen Code-Analysator <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PVS-Studio</a> verwendet.  Die Analyse wurde unter dem Linux-Betriebssystem durchgef√ºhrt, der Analysator ist jedoch auch f√ºr Windows und MacOS verf√ºgbar. <br><br>  Das Anzeigen der Ergebnisse der Analyse war keine leichte Aufgabe.  Tatsache ist, dass der Analysator die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorverarbeiteten .i-</a> Dateien √ºberpr√ºft, in denen alle Anweisungen des Pr√§prozessors bereits ge√∂ffnet sind, und Warnungen f√ºr Dateien mit Quellcode generiert.  Dies ist das korrekte Verhalten des Analysators. Sie m√ºssen nichts √§ndern, aber es werden viele Warnungen f√ºr Makros ausgegeben!  Und hinter Makros steckt ein unlesbarer Code. <br><a name="habracut"></a><br><h2>  Der tern√§re Operator funktioniert nicht so, wie Sie denken </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V502</a> Vielleicht arbeitet der Operator '?:' Anders als erwartet.  Der Operator '?:' Hat eine niedrigere Priorit√§t als der Operator '-'.  toke.c 9494 <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">STATIC </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">S_scan_ident</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dest, STRLEN destlen, I32 ck_uni)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((s &lt;= PL_bufend - (is_utf8) ? UTF8SKIP(s) : <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp;&amp; VALID_LEN_ONE_IDENT(s, PL_bufend, is_utf8)) { .... } .... }</code> </pre> <br>  Beginnen wir die √úberpr√ºfung mit einem sch√∂nen Fehler.  Alle paar Code√ºberpr√ºfungen m√ºssen wiederholen, dass der tern√§re Operator beim Rechnen fast die niedrigste Priorit√§t hat. <br><br>  Betrachten Sie das Fragment mit dem Fehler: <br><br><pre> <code class="cpp hljs">s &lt;= PL_bufend - (is_utf8) ? UTF8SKIP(s) : <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Die Reihenfolge der Operationen, die der Programmierer erwartet: <ol><li>  ?: </li><li>  - - </li><li>  &lt;= </li></ol><br>  Was wirklich passiert: <ol><li>  - - </li><li>  &lt;= </li><li>  ?: </li></ol><br>  Behalten Sie eine Beschriftung mit den Priorit√§ten der Operationen bei: " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Priorit√§t der Operationen in C / C ++</a> ". <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V502</a> Vielleicht arbeitet der Operator '?:' Anders als erwartet.  Der Operator '?:' Hat eine niedrigere Priorit√§t als der Operator '=='.  re_exec.c 9193 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">STATIC I32 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">S_regrepeat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ regexp *prog, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **startposp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> regnode *p, regmatch_info *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reginfo, I32 max _pDEPTH)</span></span></span><span class="hljs-function"> </span></span>{ .... assert(STR_LEN(p) == reginfo-&gt;is_utf8_pat ? UTF8SKIP(STRING(p)) : <span class="hljs-number"><span class="hljs-number">1</span></span>); .... }</code> </pre> <br>  Einfacher Code mit einem √§hnlichen Fehler.  Wenn Sie jedoch die Priorit√§ten von Operationen nicht kennen, k√∂nnen Sie einen Fehler in einem Ausdruck beliebiger Gr√∂√üe machen. <br><br>  Ein anderer Ort mit Behauptung: <br><br><ul><li>  V502 Vielleicht arbeitet der Operator '?:' Anders als erwartet.  Der Operator '?:' Hat eine niedrigere Priorit√§t als der Operator '=='.  re_exec.c 9286 </li></ul><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V502</a> Vielleicht arbeitet der Operator '?:' Anders als erwartet.  Der Operator '?:' Hat eine niedrigere Priorit√§t als der Operator '&amp;&amp;'.  pp_hot.c 3036 <br><br><pre> <code class="cpp hljs">PP(pp_match) { .... MgBYTEPOS_set(mg, TARG, truebase, RXp_OFFS(prog)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end); .... }</code> </pre> <br>  Und hier ist eine Warnung f√ºr ein Makro ... Um zu verstehen, was dort passiert, hilft auch die Implementierung des Makros nicht weiter, da einige weitere Makros verwendet werden! <br><br>  Daher h√§nge ich ein Fragment der vorverarbeiteten Datei f√ºr diese Codezeile an: <br><br><pre> <code class="cpp hljs">(((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x00000400</span></span>) &amp;&amp; (!((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x00200000</span></span>) || S_sv_only_taint_gmagic(targ)) ? (mg)-&gt;mg_len = ((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end), (mg)-&gt;mg_flags |= <span class="hljs-number"><span class="hljs-number">0x40</span></span> : ((mg)-&gt;mg_len = (((targ)-&gt;sv_flags &amp; <span class="hljs-number"><span class="hljs-number">0x20000000</span></span>) &amp;&amp; !__builtin_expect(((((PL_curcop)-&gt;cop_hints + <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x00000008</span></span>) ? (<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span> :(<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">0</span></span>),(<span class="hljs-number"><span class="hljs-number">0</span></span>))) ? (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span>)Perl_utf8_length( (U8 *)(truebase), (U8 *)(truebase)+((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end)) : (<span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span>)((prog-&gt;offs)[<span class="hljs-number"><span class="hljs-number">0</span></span>].end), (mg)-&gt;mg_flags &amp;= ~<span class="hljs-number"><span class="hljs-number">0x40</span></span>));</code> </pre> <br>  Irgendwo hier bezweifelte der Analysator die korrekte Verwendung des tern√§ren Operators (es gibt 3 davon), aber ich fand nicht die Kraft zu verstehen, was in diesem Code getan wird.  Wir haben bereits gesehen, dass die Entwickler solche Fehler machen, daher kann es auch hier sehr wahrscheinlich sein. <br><br>  Drei weitere Verwendungen dieses Makros: <br><br><ul><li>  V502 Vielleicht arbeitet der Operator '?:' Anders als erwartet.  Der Operator '?:' Hat eine niedrigere Priorit√§t als der Operator '&amp;&amp;'.  pp_ctl.c 324 </li><li>  V502 Vielleicht arbeitet der Operator '?:' Anders als erwartet.  Der Operator '?:' Hat eine niedrigere Priorit√§t als der Operator '&amp;&amp;'.  regexec.c 7335 </li><li>  V502 Vielleicht arbeitet der Operator '?:' Anders als erwartet.  Der Operator '?:' Hat eine niedrigere Priorit√§t als der Operator '&amp;&amp;'.  re_exec.c 7335 </li></ul><br>  <b>Beachten Sie die Kollegen Andrei Karpov.</b>  Ich habe 10 Minuten √ºber diesen Code meditiert und bin geneigt zu glauben, dass es keinen Fehler gibt.  Aber auf jeden Fall ist es √§u√üerst schmerzhaft, solchen Code zu lesen, und es ist besser, nicht so zu schreiben. <br><br><h2>  Fehler in den Bedingungen </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V523</a> Die Anweisung 'then' entspricht der Anweisung 'else'.  toke.c 12056 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> U8 * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">S_add_utf16_textfilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ U8 *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reversed)</span></span></span><span class="hljs-function"> </span></span>{ .... SvCUR_set(PL_linestr, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FILTER_READ(<span class="hljs-number"><span class="hljs-number">0</span></span>, PL_linestr, <span class="hljs-number"><span class="hljs-number">0</span></span>)) { SvUTF8_on(PL_linestr); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SvUTF8_on(PL_linestr); } PL_bufend = SvEND(PL_linestr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (U8*)SvPVX(PL_linestr); }</code> </pre> <br>  Ich denke, Sie k√∂nnen auf den Inhalt von Makros verzichten, um sicherzustellen, dass verd√§chtig duplizierte Codefragmente vorhanden sind. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V564</a> Das '|'  Der Operator wird auf den Wert des Bool-Typs angewendet.  Sie haben wahrscheinlich vergessen, Klammern einzuf√ºgen, oder wollten das '||'  Betreiber.  op.c 11494 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">OP * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_ck_rvconst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ OP *o)</span></span></span><span class="hljs-function"> </span></span>{ .... gv = gv_fetchsv(kidsv, o-&gt;op_type == OP_RV2CV &amp;&amp; o-&gt;op_private &amp; OPpMAY_RETURN_CONSTANT ? GV_NOEXPAND : iscv | !(kid-&gt;op_private &amp; OPpCONST_ENTERED), iscv <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? SVt_PVCV : o-&gt;op_type == OP_RV2SV ? SVt_PV : o-&gt;op_type == OP_RV2AV ? SVt_PVAV : o-&gt;op_type == OP_RV2HV ? SVt_PVHV : SVt_PVGV); .... }</span></span></code> </pre> <br>  Sehr seltsamer Code.  Der Ausdruck "iscv |  ! (kid-&gt; op_private &amp; OPpCONST_ENTERED) "wird in keiner Weise verwendet.  Hier gibt es eindeutig einen Tippfehler.  Zum Beispiel sollten Sie vielleicht hier schreiben: <br><br><pre> <code class="cpp hljs">: iscv = !(kid-&gt;op_private &amp; OPpCONST_ENTERED), iscv <span class="hljs-comment"><span class="hljs-comment">// &lt;=</span></span></code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V547 Der</a> Ausdruck 'RETVAL == 0' ist immer wahr.  Typemap.c 710 <br><br><pre> <code class="cpp hljs">XS_EUPXS(XS_XS__Typemap_T_SYSRET_pass); XS_EUPXS(XS_XS__Typemap_T_SYSRET_pass) { dVAR; dXSARGS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (items != <span class="hljs-number"><span class="hljs-number">0</span></span>) croak_xs_usage(cv, <span class="hljs-string"><span class="hljs-string">""</span></span>); { SysRet RETVAL; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 370 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Typemap.xs"</span></span></span><span class="hljs-meta"> RETVAL = 0; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> 706 </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Typemap.c"</span></span></span><span class="hljs-meta"> { SV * RETVALSV; RETVALSV = sv_newmortal(); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (RETVAL != -1) { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= if (RETVAL == 0) // &lt;= sv_setpvn(RETVALSV, "0 but true", 10); else sv_setiv(RETVALSV, (IV)RETVAL); } ST(0) = RETVALSV; } } XSRETURN(1); }</span></span></span></span></code> </pre> <br>  Die Variable <i>RETVAL wird</i> zweimal hintereinander √ºberpr√ºft.  Dar√ºber hinaus ist aus dem Code ersichtlich, dass diese Variable immer Null ist.  Vielleicht wollten sie unter einer oder beiden Bedingungen den <i>RETVALSV-</i> Zeiger √ºberpr√ºfen, aber sie machten einen Tippfehler. <br><br><h2>  Warnungen √ºber die Gr√∂√üe des Bedieners ausl√∂sen </h2><br>  Es gibt verschiedene Arten von Diagnoseregeln im Analyseger√§t, die mithilfe des Operators <i>sizeof</i> nach Fehlern suchen.  Beim Perl 5-Projekt haben zwei dieser Diagnosen insgesamt etwa tausend Warnungen generiert.  In diesem Fall ist nicht der Analysator schuld, sondern die Makros. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V568</a> Es ist seltsam, dass das Argument des Operators sizeof () der Ausdruck 'len + 1' ist.  util.c 1084 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_savepvn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pv, I32 len)</span></span></span><span class="hljs-function"> </span></span>{ .... Newx(newaddr,len+<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>); .... }</code> </pre> <br>  Der Code enth√§lt viele √§hnliche Makros.  Ich habe eines als Beispiel gew√§hlt, wir interessieren uns f√ºr das Argument "len + 1". <br><br>  Ein Makro-Pr√§prozessor wird in den folgenden Code erweitert: <br><br><pre> <code class="cpp hljs">(newaddr = ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)(__builtin_expect(((((( <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>) &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(len+<span class="hljs-number"><span class="hljs-number">1</span></span>) || <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) &gt; ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>) - <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(len+<span class="hljs-number"><span class="hljs-number">1</span></span>)))) ? (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)(len+<span class="hljs-number"><span class="hljs-number">1</span></span>) : ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)<span class="hljs-number"><span class="hljs-number">-1</span></span>)/<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)) &gt; ((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)<span class="hljs-number"><span class="hljs-number">-1</span></span>)/<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>))) ? (<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">1</span></span> : (<span class="hljs-keyword"><span class="hljs-keyword">_Bool</span></span>)<span class="hljs-number"><span class="hljs-number">0</span></span>),(<span class="hljs-number"><span class="hljs-number">0</span></span>)) &amp;&amp; (S_croak_memory_wrap(),<span class="hljs-number"><span class="hljs-number">0</span></span>)), (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)(Perl_safesysmalloc((<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)((len+<span class="hljs-number"><span class="hljs-number">1</span></span>)*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>))))));</code> </pre> <br>  F√ºr das Konstrukt <i>sizeof (len +1) wird</i> eine Analysatorwarnung ausgegeben.  Tatsache ist, dass in den Argumenten des Operators <i>sizeof</i> keine Berechnungen durchgef√ºhrt werden.  Viele Makros werden zu √§hnlichem Code erweitert.  Dies ist wahrscheinlich ein alter Legacy-Code, in dem niemand etwas anfassen m√∂chte, aber aktuelle Entwickler verwenden weiterhin alte Makros, was auf ihr unterschiedliches Verhalten hinweist. <br><br><h2>  <i>Dereferenzieren von Nullzeigern</i> </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V522 Eine</a> Dereferenzierung des Nullzeigers 'sv' kann stattfinden.  pp_ctl.c 577 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">OP * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_pp_formline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... SV *sv = ((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>); .... <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*fpc++) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: arg = *fpc++; f += arg; fieldsize = arg; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mark &lt; sp) sv = *++mark; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sv = &amp;(PL_sv_immortals[<span class="hljs-number"><span class="hljs-number">2</span></span>]); Perl_ck_warner( (<span class="hljs-number"><span class="hljs-number">28</span></span> ), <span class="hljs-string"><span class="hljs-string">"...."</span></span>); } .... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s = item = ((((sv)-&gt;sv_flags &amp; (....)) == <span class="hljs-number"><span class="hljs-number">0x00000400</span></span>) ? .... .... } .... }</code> </pre> <br>  Dieses Codefragment wird vollst√§ndig aus der vorverarbeiteten Datei √ºbernommen, da das Vorhandensein des Problems aufgrund von Makros nicht in der Quelldatei √ºberpr√ºft werden kann. <br><br>  Der <i>SV-</i> Zeiger wird bei der Deklaration auf Null initialisiert.  Der Analysator stellte fest, dass dieser Zeiger bei √úbergabe von <i>5</i> in der <i>switch-Anweisung</i> dereferenziert wird, was zuvor noch nie initialisiert wurde.  In der Verzweigung ist eine √Ñnderung des <i>sv-</i> Zeigers mit dem Wert <i>4 vorhanden</i> , aber am Ende dieses Codeblocks befindet sich die <i>break-</i> Anweisung.  H√∂chstwahrscheinlich ist an dieser Stelle zus√§tzlicher Code erforderlich. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V595</a> Der 'k'-Zeiger wurde verwendet, bevor er gegen nullptr verifiziert wurde.  √úberpr√ºfen Sie die Zeilen: 15919, 15920. op.c 15919 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_rpeep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pTHX_ OP *o)</span></span></span><span class="hljs-function"> </span></span>{ .... OP *k = o-&gt;op_next; U8 want = (k-&gt;op_flags &amp; OPf_WANT); <span class="hljs-comment"><span class="hljs-comment">// &lt;= if ( k // &lt;= &amp;&amp; k-&gt;op_type == OP_KEYS &amp;&amp; ( want == OPf_WANT_VOID || want == OPf_WANT_SCALAR) &amp;&amp; !(k-&gt;op_private &amp; OPpMAYBE_LVSUB) &amp;&amp; !(k-&gt;op_flags &amp; OPf_MOD) ) { .... }</span></span></code> </pre> <br>  In diesem Codefragment hat der Analysator einen Zeiger <i>k gefunden</i> , der eine Zeile vor seiner G√ºltigkeitspr√ºfung dereferenziert wird.  Dies kann entweder ein Fehler oder ein zus√§tzlicher Code sein. <br><br>  Diagnostics <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V595</a> findet in jedem Projekt viele Warnungen, Perl 5 ist keine Ausnahme.  Es ist unm√∂glich, all dies in den Artikel zu integrieren, daher beschr√§nken wir uns auf ein Beispiel, und die Entwickler √ºberpr√ºfen das Projekt auf Wunsch selbst. <br><br><h2>  Verschiedenes </h2><br>  V779 Nicht erreichbarer Code erkannt.  M√∂glicherweise liegt ein Fehler vor.  universal.c 457 <br><br><pre> <code class="cpp hljs">XS(XS_utf8_valid); XS(XS_utf8_valid) { dXSARGS; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (items != <span class="hljs-number"><span class="hljs-number">1</span></span>) croak_xs_usage(cv, <span class="hljs-string"><span class="hljs-string">"sv"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SV * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sv = ST(<span class="hljs-number"><span class="hljs-number">0</span></span>); STRLEN len; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> s = SvPV_const(sv,len); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SvUTF8(sv) || is_utf8_string((<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> U8*)s,len)) XSRETURN_YES; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> XSRETURN_NO; } XSRETURN_EMPTY; }</code> </pre> <br>  In der Zeile mit <i>XSRETURN_EMPTY hat der</i> Analysator einen nicht erreichbaren Code festgestellt.  Diese Funktion <i>enth√§lt</i> zwei <i>return-Anweisungen</i> und <i>croak_xs_usage</i> - ein Makro, das zu einer noreturn-Funktion erweitert wird: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Perl_croak_xs_usage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CV *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cv, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> params)</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((noreturn))</span></span></span></span>;</code> </pre> <br>  An √§hnlichen Stellen im Perl 5-Code wird das Makro <i>NOT_REACHED</i> verwendet, um einen nicht erreichbaren Zweig anzuzeigen. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">V784</a> Die Gr√∂√üe der Bitmaske ist kleiner als die Gr√∂√üe des ersten Operanden.  Dies f√ºhrt zum Verlust h√∂herer Bits.  inffast.c 296 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> ZLIB_INTERNAL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inflate_fast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(z_streamp strm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> hold; <span class="hljs-comment"><span class="hljs-comment">/* local strm-&gt;hold */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> bits; <span class="hljs-comment"><span class="hljs-comment">/* local strm-&gt;bits */</span></span> .... hold &amp;= (<span class="hljs-number"><span class="hljs-number">1U</span></span> &lt;&lt; bits) - <span class="hljs-number"><span class="hljs-number">1</span></span>; .... }</code> </pre> <br>  Der Analysator hat beim Arbeiten mit Bitmasken einen verd√§chtigen Vorgang festgestellt.  Als Bitmaske wird eine Variable mit niedrigerer Aufl√∂sung als die Variable <i>hold verwendet</i> .  Dies f√ºhrt zum Verlust hoher Bits.  Entwickler sollten diesen Code beachten. <br><br><h2>  Fazit </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a9e/e0d/a01/a9ee0da01644c5db03e6d93f79cab705.png" alt="Bild 6"></p><br><br>  Das Finden von Fehlern durch Makros war sehr schwierig.  Das Anzeigen des Berichts hat viel Zeit und M√ºhe gekostet.  Trotzdem enth√§lt der Artikel sehr interessante F√§lle, die echten Fehlern √§hneln.  Der Analysatorbericht ist ziemlich umfangreich, dort gibt es definitiv viel interessanteres.  Aber ich kann es nicht weiter betrachten :).  Ich rate dem Entwickler, das Projekt selbst zu √ºberpr√ºfen und die Fehler zu beseitigen, die er erkennen kann. <br><br>  PS Wir m√∂chten dieses interessante Projekt auf jeden Fall unterst√ºtzen und sind bereit, Entwicklern f√ºr mehrere Monate eine Lizenz zur Verf√ºgung zu stellen. <br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br><br>  Wenn Sie diesen Artikel einem englischsprachigen Publikum zug√§nglich machen m√∂chten, verwenden Sie bitte den Link zur √úbersetzung: Svyatoslav Razmyslov.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Perl 5: So verbergen Sie Fehler in Makros</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de425415/">https://habr.com/ru/post/de425415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de425405/index.html">Newtypen der Gro√ümacht</a></li>
<li><a href="../de425407/index.html">Firecore - ein lustiges Spiel auf AVR</a></li>
<li><a href="../de425409/index.html">DevBoy: einen Signalgenerator machen</a></li>
<li><a href="../de425411/index.html">Scrum ist tot</a></li>
<li><a href="../de425413/index.html">Sind Joons so gut?</a></li>
<li><a href="../de425417/index.html">Flash f√ºr alle. Alle Flash-Arrays von QSAN</a></li>
<li><a href="../de425419/index.html">Der Autor von The Witcher forderte von CD Projekt Red mindestens 16 Millionen US-Dollar</a></li>
<li><a href="../de425421/index.html">Freitag. Die Begeisterung eines Programmierers</a></li>
<li><a href="../de425423/index.html">Auf die Frage der Pandas oder den n√§chsten Schrei Jaroslawnas</a></li>
<li><a href="../de425425/index.html">√úberpr√ºfung der R-Pakete f√ºr Internet-Marketing, Teil 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>