<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üà¥ üè¨ üîµ Exclus√£o suave na API REST üåî üñäÔ∏è üßôüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para que o usu√°rio n√£o sinta dores devido a dados irremediavelmente perdidos, vale a pena pensar na exclus√£o suave. Com a exclus√£o suave, o registro n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exclus√£o suave na API REST</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440886/"><img src="https://habrastorage.org/webt/oe/bg/db/oebgdbwbph1kzflig9jyrabyozo.gif" alt="imagem"><br><br>  Para que o usu√°rio n√£o sinta dores devido a dados irremediavelmente perdidos, vale a pena pensar na exclus√£o suave.  Com a exclus√£o suave, o registro n√£o √© fisicamente exclu√≠do do banco de dados, mas apenas marcado como exclu√≠do.  Isso facilita a recupera√ß√£o de dados, redefinindo o sinalizador. <br><br>  Eu recentemente implementei a exclus√£o suave em um de nossos servi√ßos REST.  Aqueles que est√£o interessados ‚Äã‚Äãno que eu fiz, eu convido voc√™ a gato. <br><a name="habracut"></a><br><h2>  Entrada obrigat√≥ria </h2><br>  O debate sobre a possibilidade de usar remo√ß√£o leve √© ‚Äã‚Äãmuito antigo.  Basta olhar para os longos holivares <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  O mais razo√°vel √© a posi√ß√£o segundo a qual tudo depende da situa√ß√£o.  H√° casos em que a exclus√£o suave √© conveniente ou mesmo necess√°ria; h√° casos em que os argumentos dos oponentes da exclus√£o suave merecem aten√ß√£o.  A prop√≥sito, um argumento importante contra a exclus√£o suave √© a resposta que veio de 2018: se estamos falando de contas de usu√°rio, a exclus√£o suave √© contr√°ria ao <abbr title="Regulamento Geral de Prote√ß√£o de Dados - Regulamento da Uni√£o Europeia">GDPR</abbr> . <br><br>  Decidimos que, em nosso servi√ßo de armazenamento de documentos, √© necess√°ria uma exclus√£o suave. <br><br><h2>  Abordagem RESTful </h2><br>  Se queremos implementar a exclus√£o suave em um servi√ßo, precisamos entender como ele deve ficar do ponto de vista da interface.  Uma pesquisa na Internet mostrou que uma pergunta t√≠pica que as pessoas t√™m √© se deve usar DELETE {resource} como antes, ou √© melhor usar o m√©todo PATCH em vez disso com um corpo que inclua algo como <i>{status: 'delete'}</i> . <br><br>  Aqui a opini√£o do povo √© inequ√≠voca: √© necess√°rio usar DELETE como antes.  Do ponto de vista do cliente, a exclus√£o tamb√©m √© uma exclus√£o na √Åfrica.  Nada deve mudar: se um recurso for exclu√≠do, ele se torna inacess√≠vel;  se o cliente deseja excluir o recurso, ele sabe que o m√©todo HTTP DELETE √© para esse fim.  N√£o √© necess√°rio dedicar o cliente em detalhes de exatamente como o servi√ßo implementa a exclus√£o. <br><br>  Al√©m disso, estava preocupado com a quest√£o de como recuperar recursos exclu√≠dos.  Obviamente, esse problema √© resolvido pela administra√ß√£o do banco de dados.  No entanto, eu gostaria de poder fazer isso por meio da API REST.  E aqui entramos em conflito.  Acontece que o cliente ainda precisa se dedicar aos detalhes da implementa√ß√£o? <br><br>  A pesquisa n√£o retornou resultados por um longo tempo, at√© que me deparei com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.pandastrike.com/posts/20161004-soft-deletes-">um bom artigo de Dan Yoder</a> .  O artigo examina a sem√¢ntica de diferentes solicita√ß√µes HTTP e sugere que, em vez de exclus√£o f√≠sica, mova recursos remotos para o <i>arquivo morto</i> .  Al√©m disso, ser√° bom se DELETE retornar um link para o recurso arquivado.  O usu√°rio sempre pode restaurar o recurso exclu√≠do enviando uma solicita√ß√£o POST para o arquivo morto. <br><br><h2>  Desenho </h2><br>  Nosso servi√ßo REST √© criado na API da Web do ASP.NET usando o Entity Framework.  Como eu disse, fa√ßo uma exclus√£o simples para um recurso chamado documento. <br><br>  Portanto, primeiro voc√™ precisa adicionar colunas √† tabela correspondente.  Como sinalizador, eu uso um carimbo de data / hora chamado Exclu√≠do.  Se o valor n√£o for NULL, o recurso ser√° considerado exclu√≠do.  Al√©m disso, √© √∫til ter informa√ß√µes sobre quem excluiu o recurso. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> Documents <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> Deleted datetime <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, DeletedBy <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  A a√ß√£o DELETE no controlador agora definir√° simplesmente os valores desses campos em vez de excluir fisicamente o registro.  Al√©m disso, DELETE retornar√° um corpo com uma refer√™ncia padr√£o ao documento arquivado: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"links"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"archive"</span></span>: <span class="hljs-string"><span class="hljs-string">"documents/{id}/deleted"</span></span> } }</code> </pre> <br>  De fato, este √© um ponto importante: o link ajuda o cliente a entender que o documento n√£o √© exclu√≠do, mas <i>movido</i> . <br><br>  O novo controlador para documentos arquivados deve fornecer os seguintes m√©todos: <br><table><tbody><tr><td>  GET documentos / exclu√≠dos </td><td>  Obt√©m uma cole√ß√£o de todos os documentos exclu√≠dos </td></tr><tr><td>  GET documentos / {id} / exclu√≠dos </td><td>  Retorna o documento exclu√≠do </td></tr><tr><td>  Documentos do POST / {id} / exclu√≠dos </td><td>  Recupera documento exclu√≠do; <br>  n√£o requer um corpo;  retorna 201 Criado </td></tr><tr><td>  EXCLUIR documentos / {id} / exclu√≠dos </td><td>  Exclui fisicamente um documento </td></tr></tbody></table><br><h2>  Implementa√ß√£o </h2><br>  Inicialmente, planejei adicionar duas visualiza√ß√µes ao meu banco de dados: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> DeletedDocuments <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Deleted <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> AvailableDocuments <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> Documents <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Deleted <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  Pareceu-me que isso seria menos problem√°tico: em vez de definir condi√ß√µes no c√≥digo, eu apenas obtive duas propriedades DbSet diferentes no meu contexto de banco de dados.  √â verdade que voc√™ precisa ter duas entidades id√™nticas no modelo, mas essa √© a propriedade dos objetos POCO no contexto do EF - cada tabela corresponde a exatamente uma entidade. <br><br>  A prop√≥sito, as representa√ß√µes no SQL podem ser √∫teis para o Entity Framework em outros aspectos: com a ajuda deles, por exemplo, voc√™ pode consultar tabelas de outro banco de dados se n√£o quiser criar v√°rios contextos de banco de dados. <br><br>  No entanto, no meu caso, o n√∫mero com as visualiza√ß√µes n√£o passou.  Durante a autoriza√ß√£o, voc√™ precisa trabalhar com todos os documentos, porque os usu√°rios t√™m os mesmos direitos para excluir os documentos que os existentes. <br><br>  Portanto, decidi ter apenas um DbSet Documents no DbContext e no c√≥digo toda vez que descubro exatamente o que √© necess√°rio no momento: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> availableDocuments = DbContext.Documents.Where(d =&gt; d.Deleted == <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deletedDocuments = DbContext.Documents.Where(d =&gt; d.Deleted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> allDocuments = DbContext.Documents;</code> </pre> <br><h2>  Recursos Relacionados </h2><br>  Um documento √© um recurso ao qual outros recursos est√£o associados.  Por exemplo, temos um alias de documento.  Ou seja, √© poss√≠vel obter um documento n√£o apenas no caminho <i>documents / {id}</i> , mas tamb√©m no caminho <i>documents / {alias}</i> , em que o <i>alias</i> √© uma string exclusiva. <br><br>  Depois de excluir um documento, todos os aliases associados a ele devem se tornar "invis√≠veis": se anteriormente o cliente receber uma lista de todos os aliases usando documentos / aliases GET, depois de excluir o documento, seus aliases da lista desaparecer√£o. <br><br>  Mas eles permaneceram no banco de dados!  Queremos fornecer a capacidade de restaurar o documento no estado em que ele foi exclu√≠do.  Isso pode causar confus√£o para o cliente: ele est√° tentando adicionar um novo alias para outro documento, a lista retornada de <i>documentos / aliases GET</i> n√£o cont√©m essa linha e o servi√ßo se recusa a adicion√°-lo. <br><br>  Eu n√£o acho que isso seja um problema s√©rio.  No entanto, se voc√™ precisar resolv√™-lo, poder√° adicionar os <i>documentos GET</i> do terminal <i>/ exclu√≠dos / aliases</i> .  Ent√£o tudo se encaixa: o servi√ßo n√£o pode adicionar um alias, pois esse valor j√° √© usado pelo documento remoto. <br><br>  A quest√£o pode surgir: vale a pena lan√ßar um alias da lista retornada de <i>documentos / aliases</i> ?  Deixe-os ficar!  N√£o acho que essa decis√£o seja correta.  Acontece que a lista de aliases conter√° links quebrados, porque o servi√ßo retornar√° 404 N√£o encontrado se o cliente tentar obter o documento exclu√≠do por alias.  Se se trata dos recursos filhos associados ao documento, o comportamento deve ser exatamente o mesmo como se estiv√©ssemos excluindo o documento fisicamente. <br><br><h2>  Limpeza de arquivos </h2><br>  A exclus√£o suave, al√©m de poder recuperar dados com facilidade, tem v√°rias outras vantagens.  A opera√ß√£o de exclus√£o em bancos de dados relacionais √© uma opera√ß√£o cara.  E mesmo que a exclus√£o de um registro leve √† exclus√£o em cascata de registros em outras tabelas, isso estar√° repleto de conflitos.  Portanto, a remo√ß√£o macia √© mais r√°pida e confi√°vel do que a remo√ß√£o f√≠sica. <br><br>  Mas h√° uma desvantagem significativa.  A base est√° come√ßando a crescer. <br><br>  Portanto, na fase final, voc√™ deve cuidar da limpeza autom√°tica do arquivo.  Obviamente, voc√™ pode limpar a base manualmente, mas √© melhor automatizar esse processo.  Se definirmos diretamente a data de validade de um objeto remoto, por exemplo, 30 dias, o cliente poder√° exibir a p√°gina de arquivo na qual os elementos cuja vida √∫til est√° pr√≥xima do fim ser√£o destacados. <br><br>  Minhas m√£os ainda n√£o alcan√ßaram essa tarefa.  Planejamos adicionar ao nosso sistema de tarefas uma tarefa que uma vez por dia execute uma consulta SQL simples que remova todos os objetos sujos do arquivo morto.  Como par√¢metro, a tarefa deve ter uma data de validade.  Ser√° necess√°rio garantir que o valor atual desse par√¢metro seja armazenado em algum lugar do mesmo local.  Em seguida, ser√° poss√≠vel implementar um m√©todo no servi√ßo que retorne esse valor ao cliente. <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt440886/">https://habr.com/ru/post/pt440886/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt440874/index.html">Implementando o movimento livre de part√≠culas no ReactJS</a></li>
<li><a href="../pt440878/index.html">An√°lise da Web para empresas</a></li>
<li><a href="../pt440880/index.html">Os 10 principais sensores de IoT em 2019</a></li>
<li><a href="../pt440882/index.html">Fuja do Crypto Pro. Edi√ß√£o GOST 34.10-2012</a></li>
<li><a href="../pt440884/index.html">O processamento de erros irrecuper√°veis ‚Äã‚Äãno Swift</a></li>
<li><a href="../pt440888/index.html">Testes independentes do Baikal-T1 - o primeiro SoC russo de 28 nm - e do Conselho de Avalia√ß√£o BFK 3.1</a></li>
<li><a href="../pt440890/index.html">Patriotismo em jogos de computador: a opini√£o de um ex-jogador</a></li>
<li><a href="../pt440892/index.html">A inesperada efici√™ncia de sequ√™ncias quase aleat√≥rias</a></li>
<li><a href="../pt440894/index.html">Criando som para o Pathfinder: Kingmaker</a></li>
<li><a href="../pt440896/index.html">Tecnologias aditivas e digitaliza√ß√£o 3D em engenharia mec√¢nica: 7 hist√≥rias de sucesso</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>