<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëßüèæ üë®‚Äçüç≥ üöÇ Cartes de fid√©lit√©. API Google Pay pour les passes dans ASP.NET üõ¥ üëâüèæ ü§Ø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les applications de stockage de cartes bancaires sont rapidement entr√©es dans nos vies gr√¢ce √† Apple Wallet et Google Pay. Les deux plateformes, en pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cartes de fid√©lit√©. API Google Pay pour les passes dans ASP.NET</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434486/"><p>  Les applications de stockage de cartes bancaires sont rapidement entr√©es dans nos vies gr√¢ce √† Apple Wallet et Google Pay.  Les deux plateformes, en plus de la banque, vous permettent √©galement de travailler avec d'autres types de cartes - cartes de fid√©lit√©, cartes-cadeaux, billets d'√©v√©nement, cartes d'embarquement, etc. <br></p><br><p><img src="https://habrastorage.org/webt/ga/ng/rq/gangrq7tlqwob2cmgxa1dydoasu.png"><br></p><br><p>  En travaillant pour une entreprise qui dessert un r√©seau de vente au d√©tail assez important, j'ai d√ª int√©grer les cartes de fid√©lit√© de ce r√©seau dans Apple Wallet et Google Pay.  Et si vous deviez bricoler Apple Wallet simplement parce que la couche d'int√©gration est assez multifonctionnelle, alors avec Google Pay, la plupart des efforts et des cellules nerveuses ont √©t√© d√©pens√©s pour essayer de comprendre la documentation, trouver les bons outils et d√©velopper la premi√®re preuve de concept.  Bien qu'en g√©n√©ral le reste du travail soit all√© beaucoup plus vite que pour Apple Wallet, j'ai pass√© une journ√©e √† trouver comment d√©marrer le service, donc cela ne me d√©rangerait pas si quelqu'un a √©crit un article similaire avant moi. <br><a name="habracut"></a><br></p><h2>  1. Mat√©riel </h2><br>  Les cartes de fid√©lit√© sont repr√©sent√©es √† l'aide de deux entit√©s: la classe de fid√©lit√© et l'objet de fid√©lit√©. <br><br><ul><li>  <i>La classe de fid√©lit√©</i> est une sorte de mod√®le pour toutes les cartes de fid√©lit√©.  Il contient des champs communs √† toutes les cartes, tels que la couleur de la police, des liens vers les ressources des ic√¥nes, les arri√®re-plans, les champs de texte, etc., une description compl√®te peut √™tre trouv√©e ici: <br></li><li>  <i>Loyalty Object</i> - une instance de LoyaltyClass.  Il contient √©galement les donn√©es d'une carte sp√©cifique d'un client particulier - num√©ro de carte, nom, champs de texte suppl√©mentaires.  Description ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Loyaltyobject</a> <br></li></ul><br>  Pour recevoir une carte, l'utilisateur doit suivre le lien de formatage <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b></i> , o√π JWT est un jeton qui contient JSON avec des donn√©es LoyaltyClass.  Mais comme la longueur de l'URL a des limites, il est recommand√© de cr√©er d'abord une classe de fid√©lit√© si sa structure contient de nombreux caract√®res. <br><br><p>  Si vous devez mettre √† jour la carte en raison d'un changement dans le mod√®le, les styles, la n√©cessit√© d'ajouter ou de modifier des champs de texte, vous pouvez le faire en utilisant l'API.  Il suffit de remplir une demande POST avec la nouvelle version de la carte, les services Google synchronisent eux-m√™mes toutes les applications des utilisateurs qui ont cette carte. <br></p><br><h2>  2. Outils et documentation </h2><br><p>  Le probl√®me √©tait que tous les exemples dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation de l'API Google Pay pour les passes</a> √©taient exclusivement pour Java, PHP et Python, et la documentation elle-m√™me recommandait fortement "d'utiliser les biblioth√®ques clientes pour simplifier le processus" de travail avec l'API. <br></p><br><p>  En suivant ce conseil, je suis all√©e avec bonheur √† nuget, mais la biblioth√®que de Google Pay n'√©tait pas l√†.  Gloire √† Brin, la premi√®re ligne de Google pour ¬´google pay for pass dotnet¬ª a renvoy√© la page des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®ques de l'utilitaire Google Pay API for Passes</a> , qui a trouv√© ce dont j'avais besoin, bien que dans le format d'archive ZIP, dans lequel il y avait un projet .net avec une classe g√©n√©r√©e qui est un wrapper pour l'API <a href="">Google Pay</a> - Biblioth√®que <a href="">Google Pay API for Passes Client</a> . <br></p><br><p>  √Ä en juger par la pr√©sence du fichier <i>Google.Apis.Walletobjects.v1.1.9.2.00.nuspec</i> dans le projet, le d√©ploiement du package nuget faisait toujours partie des plans de l'√©quipe Google.  Apr√®s avoir ouvert ce fichier √† la recherche de documentation, je n'ai rien trouv√© de concret, et certains liens qui se trouvaient dans la section description ont √©t√© envoy√©s √† des pages inexistantes. <br><br></p><h2>  3. Obtenir un jeton d'acc√®s </h2><br><p>  Pour commencer √† travailler directement avec l'API Google Pay pour les passes, vous devez obtenir un jeton d'acc√®s, pour cela, vous avez besoin: <br><br></p><ol><li>  Avoir un compte marchand Google, que vous pouvez obtenir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> <br></li><li>  Cr√©ez un compte de service, obtenez un fichier avec ses informations d'identification - un document json avec les d√©tails du compte de service, y compris l'identifiant, l'e-mail, la cl√© priv√©e, etc.  Comme la documentation le recommande, vous devez stocker ce fichier dans un endroit s√ªr. <br></li><li>  Associer un compte marchand et un compte de service dans Google Merchant Center <br></li></ol><br>  √Ä l'aide de ce fichier, vous pouvez vous connecter √† l'aide de la biblioth√®que <i>Google.Apis.Auth.OAuth2</i> : <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">await</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOAuthToken</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> serviceAccountFile = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty;         serviceAccountFile = ConfigurationManager.AppSettings[<span class="hljs-string"><span class="hljs-string">"GooglePayServiceAccountConfigPath"</span></span>];        <span class="hljs-comment"><span class="hljs-comment">/*              Credential, GoogleCredential              Service Account,   ,      scopes API,             */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> credential = GoogleCredential.FromFile(serviceAccountFile)                            .CreateScoped(WalletobjectsService.Scope.WalletObjectIssuer);        <span class="hljs-comment"><span class="hljs-comment">/*        Access token        ,   GetAccessTokenForRequestAsync         ,               */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> credential.UnderlyingCredential.GetAccessTokenForRequestAsync();         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; }</code> </pre> <br><h2>  4. Cr√©ez une carte </h2><br><p>  Pour cr√©er une carte de fid√©lit√©, vous devez d'abord cr√©er une classe de fid√©lit√©.  La classe de fid√©lit√© peut √™tre cr√©√©e √† la fois √† l'aide de l'API et √† l'aide de l'interface Web de Google Merchant Center.  Il convient de pr√™ter attention au nom de la classe, car ce nom doit √™tre unique dans l'infrastructure Google Pay. <br><br>  Apr√®s avoir cr√©√© la classe de fid√©lit√©, vous pouvez cr√©er l'objet de fid√©lit√©.  Pour ce faire, nous aurons d√©j√† besoin de la biblioth√®que que nous avons ajout√©e au projet plus t√¥t: cr√©ez un objet de demande, sp√©cifiez le jeton OAuth, transf√©rez l'objet LoyaltyObject cr√©√© et ex√©cutez la demande: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GooglePayApiService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,    Merchant Account IssuerId = ConfigurationManager.AppSettings["GooglePayIssuerId"]; _wobService = new WalletobjectsService(); } private async Task&lt;LoyaltyObject&gt; ConvertLoyaltyObjectFromTemplate(GooglePayPassTemplate template) { string id = $"{IssuerId}.{template.SerialNumber}"; string loyaltyClassName = ConfigurationManager.AppSettings["GooglePayStoreCardClassName"];     var loyaltyClass = await GetLoyaltyClass(loyaltyClassName); var result =  new LoyaltyObject { Id = id, AccountName = template.AccountName,          Barcode = new Barcode          {          AlternateText = template.BarcodeText,               Value = template.SerialNumber,               Type = "pdf417"          },          Kind = "walletObject#loyaltyObject",          ClassId = loyaltyClass.Id,          ClassReference = loyaltyClass,          State = "active"     };     return result; } private async Task&lt;LoyaltyObject&gt; CreateLoyaltyObject(LoyaltyObject loyaltyObject) { var saveRequest = _wobService.Loyaltyobject.Insert(loyaltyObject); saveRequest.OauthToken = await GetOAuthToken(); var savedObject = await saveRequest.ExecuteAsync(); return savedObject; }</span></span></code> </pre><br>  <i>Dans</i> cet exemple, <i>GooglePayPassTemplate</i> est un DTO qui stocke un mod√®le de carte pour un utilisateur, qui est g√©n√©r√© par un service d√©velopp√© distinct. <br><br><h2>  5. Mise √† jour de la carte </h2><br><p>  Ici, le principe est le m√™me que lors de la cr√©ation: on g√©n√®re une requ√™te, on transf√®re l'objet LoyaltyObject mis √† jour, on ex√©cute: <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;LoyaltyObject&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateRequest = _wobService.Loyaltyobject.Update(loyaltyObject, loyaltyObject.Id);           updateRequest.OauthToken = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetOAuthToken(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> savedObject = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> updateRequest.ExecuteAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> savedObject; }</code> </pre> <br><p>  Apr√®s avoir termin√© la demande, la carte dans les applications des utilisateurs qui l'ont install√©e sera mise √† jour apr√®s quelques secondes, si l'appareil est sur le r√©seau et dispose d'une connexion Internet. </p><br><br><h2>  6. G√©n√©ration JWT </h2><br><p>  Pour installer la carte, vous devez rediriger l'utilisateur vers le lien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b> .  Une description de la structure du jeton peut √™tre trouv√©e sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce lien</a> . <br></p><br><p>  Le jeton est sign√© par RSA-SHA256 avec une signature qui peut √™tre g√©n√©r√©e √† l'aide du m√™me fichier avec les informations d'identification du compte de service: <br><br></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">JwtHelper</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateJwtForLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*       credential   ,         */</span></span> ServiceAccountCredential credential; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; DateTime unixEpoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 1970-01-01 00:00:00 UTC var secondsSinceEpoch = (int)Math.Round((now - unixEpoch).TotalSeconds); string serviceAccountFile = serviceAccountFile = ConfigurationManager.AppSettings["GooglePayServiceAccountConfigPath"]; using (var fs = new FileStream(serviceAccountFile, FileMode.Open, FileAccess.Read, FileShare.Read)) { credential = ServiceAccountCredential.FromServiceAccountData(fs); } /*    JwtPayload,     payload-a  JWT */ var jwtPayload = new JwtPayload { iat = secondsSinceEpoch, iss = credential.Id, payload = new JwtInternalPayload { loyaltyObjects = new[] { new LoyaltyObjectPayload { id = loyaltyObject.Id } } } }; string header = @"{""alg"":""RS256"",""typ"":""JWT""}"; string payload = JsonConverter.SerializeObject(jwtPayload); string base64Header = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(header))); string base64Payload = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(payload))); //        Signature string signature = EscapedBase64(credential.CreateSignature( Encoding.UTF8.GetBytes($"{base64Header}.{base64Payload}") )); var token = $"{base64Header}.{base64Payload}.{signature}"; return token; } private static string EscapedBase64(string base64) { return base64.Replace('+', '-') .Replace('/', '_') .Replace("=", ""); } }</span></span></code> </pre><br><h2>  Conclusion </h2><br><p>  Dans cet article, nous avons abord√© les bases de l'utilisation de l'API Google Pay pour les passes: configurer des comptes, se connecter √† l'API, cr√©er la classe de fid√©lit√© et l'objet de fid√©lit√©. <br><br>  Si UFO est en faveur, je vais vous expliquer s√©par√©ment comment travailler avec Apple Wallet (tout est plus difficile en termes de mise en ≈ìuvre), comment se faire des amis d'Apple Wallet avec Google Pay dans un seul service Web et ne pas ressentir de douleur. <br></p><br><p></p><h3>  Liens utiles </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Enregistrer un compte marchand</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation de l'API Google Pay pour les passes</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Biblioth√®ques clientes pour travailler avec Google Pay API for Passes</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr434486/">https://habr.com/ru/post/fr434486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr434474/index.html">Chat vert sur le contenu de l'espace</a></li>
<li><a href="../fr434476/index.html">ChatOps dans GitLab sera accessible √† tous</a></li>
<li><a href="../fr434478/index.html">Le code sans visage tuera la programmation, et nous n'y ferons rien.</a></li>
<li><a href="../fr434480/index.html">Nouvel an, gadgets, feu</a></li>
<li><a href="../fr434482/index.html">Une autre ann√©e de notre blog: r√©sultats de 2018</a></li>
<li><a href="../fr434490/index.html">Comment nous avons vu le haut-parleur par d√©coupe au jet d'eau</a></li>
<li><a href="../fr434494/index.html">Que lire. Liste des fictions de langue russe pour 2017 et 2018</a></li>
<li><a href="../fr434496/index.html">La validation en deux phases et l'avenir des syst√®mes distribu√©s</a></li>
<li><a href="../fr434498/index.html">MVP et Dagger 2 - Squelette d'application Android - Partie 1</a></li>
<li><a href="../fr434500/index.html">Swindler nomm√© Jeanne ou Watch Your Ears</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>