<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôçÔ∏è üèπ üö∞ Com um bom microcontrolador e o tempo voa r√°pido ou um oscilosc√≥pio de fim de semana ‚úàÔ∏è üö™ üìÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° algum tempo, o autor dessas linhas se comprometeu a desenvolver um gravador compacto de um sinal anal√≥gico unipolar dentro de 3 volts, com a maior ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Com um bom microcontrolador e o tempo voa r√°pido ou um oscilosc√≥pio de fim de semana</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468393/"><p>  H√° algum tempo, o autor dessas linhas se comprometeu a desenvolver um gravador compacto de um sinal anal√≥gico unipolar dentro de 3 volts, com a maior velocidade de leitura poss√≠vel e os menores custos e tamanhos poss√≠veis.  Na lista dos custos mais baixos poss√≠veis, tamb√©m entrei na minha dor de cabe√ßa e escolhi o conhecido STM32F303 para mim.  Lembro-me disso, o Cortex-M4 72 megahertz, de uma empresa conhecida, com conversores anal√≥gicos-digitais embutidos de 12 bits, bastante √°geis (ADC ou ADC, como desejar) e com uma interface CAN a bordo. </p><br><p>  Esses pequenos registradores exigiam v√°rias dezenas.  E a presen√ßa de um gabinete de microcontrolador com 48 pernas inspirou a esperan√ßa de que seria poss√≠vel chamar esse leitor de compacto.  A interface CAN, com a qual eu j√° tinha um bom relacionamento, me deu a oportunidade de combinar todo esse jazz de uma maneira bastante conveniente. </p><br><p>  A velocidade com que, no final, tudo funcionou, mostrou-se bastante adequada para declarar a operacionalidade da abordagem escolhida.  Foi poss√≠vel alcan√ßar uma etapa de amostragem de meio microssegundo.  Dor de cabe√ßa e montador n√£o puderam ser evitados, mas quem est√° se lembrando disso agora? </p><br><p>  No entanto, alguns sedimentos permaneceram.  Permaneceu o pensamento de que, em termos de velocidade, nem tudo estava espremido. </p><br><p>  E agora, a s√©rie STM32G4 apareceu recentemente com uma freq√º√™ncia de clock de at√© 170 megahertz, com uma op√ß√£o em um caso pequeno e com quase os mesmos ADCs velozes a bordo, no valor de cinco pe√ßas.  Era necess√°rio fazer alguma coisa. </p><a name="habracut"></a><br><p>  Ningu√©m estava de p√© sobre a alma agora e n√£o havia necessidade de se preocupar com prazos e planos. </p><br><p>  De fato, se voc√™ n√£o pensar sobre isso, poder√° aproveitar at√© o trabalho.  Mas, francamente, tive que pensar no tempo.  Pensar por muito tempo em pouco tempo (e o que, poeticamente). </p><br><p>  O pensamento sugeria que dever√≠amos come√ßar um pouco do outro lado.  Ou seja, devemos prosseguir com o menor tempo de amostragem ADC poss√≠vel, que, com base na descri√ß√£o, leva 2,5 ciclos de rel√≥gio e atinge 62,5 nanossegundos a 40 MHz (160 MHz / 4).  Ent√£o, a etapa de amostragem de 100 nanossegundos se sugere.  O n√∫mero √© redondo e, mais importante, muito pequeno e bonito, por que n√£o tentar? </p><br><p>  Al√©m disso, a placa NUCLEO-G474RE adequada para experimentos apareceu √† venda e foi comprada, √† qual era razo√°vel adicionar uma placa de ensaio adicional com dois conectores de linha dupla para soldar todos os tipos de fios e pe√ßas √† placa de ensaio e n√£o estragar a placa principal.  Aqui est√° como parece pronto. </p><br><p><img src="https://habrastorage.org/webt/kv/sx/k1/kvsxk19p26urrkufbil_6jmnm10.jpeg"></p><br><p>  L√°, abaixo, existem v√°rios fios e um resistor com um capacitor, acredite na minha palavra. </p><br><p>  Agora voc√™ precisa aplicar um sinal el√©trico adequado a todos os quatro ADCs de uma s√≥ vez e execut√°-los um ap√≥s o outro com uma etapa constante (no in√≠cio, durante a depura√ß√£o, n√£o muito curto).  Por que quatro?  De acordo com a descri√ß√£o, cada ADC gasta 15 ciclos de rel√≥gio por convers√£o, ou 0,025 * 15 = 375 nanossegundos (quase 400).  Portanto, na etapa 100, √© necess√°rio um transportador de quatro ADCs. </p><br><p>  Um circuito RC foi usado como sinal de entrada, ao qual a tens√£o era simplesmente fornecida a partir do p√© do controlador.  Eu designei esta perna para controlar o timer TIM5 no modo de pulso √∫nico. </p><br><p>  O diagrama de fia√ß√£o m√≠nimo parecia com a imagem abaixo. </p><br><p><img src="https://habrastorage.org/webt/i1/xn/_u/i1xn_uykljjux10i1f3iv9fbcum.jpeg"></p><br><p>  ADC1-ADC4 estavam envolvidos.  A profundidade de bits pode ser reduzida para um aumento na velocidade, mas 12 bits superam, porque eu n√£o queria perder a precis√£o das medi√ß√µes.  Para iniciar cada ADC na ordem e na etapa necess√°rias, tr√™s temporizadores s√£o usados ‚Äã‚Äã(TIM2, TIM3, TIM4) e outro temporizador (TIM1) serve para sincronizar os tr√™s acima.  A Figura 2 abaixo mostra os sinais em torno dos quais tudo √© constru√≠do. </p><br><p><img src="https://habrastorage.org/webt/rm/j8/xj/rmj8xjehhvbc2gk5e-xt_jy8oi4.jpeg"></p><br><p>  As setas verdes indicam a borda dos pulsos ao longo dos quais os respectivos conversores ADC1-ADC4 s√£o acionados. </p><br><p>  Para obter os 100 nanossegundos planejados, tivemos que diminuir a frequ√™ncia do rel√≥gio para 160 megahertz, para que tudo fosse completamente dividido como deveria.  No in√≠cio, o passo foi definido muito mais lentamente, em 4 microssegundos, para verificar calmamente o funcionamento dos temporizadores, usando interrup√ß√µes, portas de sa√≠da e um oscilosc√≥pio.  Em seguida, por interrup√ß√£o, foi depurado e obteve acesso direto √† mem√≥ria.  Por fim, apenas uma interrup√ß√£o √© processada - essa √© a interrup√ß√£o do final do trabalho do quarto (√∫ltimo) canal de acesso direto √† mem√≥ria.  A figura abaixo mostra as conex√µes das unidades de hardware envolvidas no processo, bem como quatro buffers de mem√≥ria de sa√≠da. </p><br><p><img src="https://habrastorage.org/webt/q-/y4/6k/q-y46k_9tzn2zrt4wnyycsssrtw.jpeg"></p><br><p>  Dos quatro buffers de mem√≥ria (na figura √† direita), as amostras s√£o coletadas programaticamente em um buffer de resultado. </p><br><p>  Nesse controlador, diferentemente do STM32F303, existe uma unidade de comuta√ß√£o de solicita√ß√£o (DMAMUX), que permite redirecionar um grande n√∫mero de solicita√ß√µes de dispositivos perif√©ricos para apenas 16 canais DMA1 e 16 canais DMA2.  No manual de refer√™ncia, as solicita√ß√µes de sa√≠da DMAMUX s√£o contadas a partir de 0 e as entradas dos canais DMA s√£o contadas a partir de 1. Eu n√£o mudei, deixei como na fonte original. </p><br><p>  Um timer TIM5 √© usado como um gerador de pulso √∫nico.  Ele fornece um conveniente modo de pulso √∫nico.  A conveni√™ncia reside na possibilidade de definir o tempo antes do in√≠cio do pulso e definir a dura√ß√£o do pr√≥prio pulso.  Esse impulso surgiu como mostrado abaixo na imagem, gentilmente fornecido por um oscilosc√≥pio alugado. </p><br><p><img src="https://habrastorage.org/webt/ru/1-/c2/ru1-c2zutulhogxtlmnh92iriu4.jpeg"></p><br><p>  O oscilograma mostra que o aumento do pulso dura 10 microssegundos, o que significa que ele deve acomodar cerca de 100 amostras. </p><br><p>  O projeto foi realizado no IAR 8.4 manualmente (ou seja, sem Cuba e o Baile), mas, espero, ser√° entendido por v√°rias cren√ßas.  Voc√™ pode v√™-lo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  Aqui est√° uma imagem do conte√∫do de um buffer ADC1 separado e do resultado coletado de quatro fontes do buffer na regi√£o do in√≠cio do pulso de entrada. </p><br><p><img src="https://habrastorage.org/webt/pz/fh/f-/pzfhf-eknlnmmpdq5gzhg9ii5lo.jpeg"></p><br><p>  Mas o conte√∫do desses buffers est√° na regi√£o do pico do pulso (onde o valor atinge 2508). </p><br><p><img src="https://habrastorage.org/webt/a6/_1/_f/a6_1_fbgckavkbfmj6xaz9pff9m.jpeg"></p><br><p>  Como voc√™ pode ver, 196-95 = 101 contagens foram gastas na se√ß√£o desde o in√≠cio do pulso at√© o pico. </p><br><p>  Portanto, a taxa de amostragem √© de 10 megahertz.  N√£o funcionou nessa velocidade imediatamente. </p><br><p>  Para conseguir isso, tive que parar o processador antes de iniciar o acesso direto √† mem√≥ria (DMA1).  √â bom que o Cortex-M4 tenha uma instru√ß√£o <strong>WFI de</strong> montagem especial (Aguarde interrup√ß√µes).  Se isso n√£o for feito, o processador atrapalhar√° os p√©s do DMA e ocupar√° o barramento com acessos √† mem√≥ria que podem esperar. </p><br><p>  Se voc√™ aumentar a contagem para 200 nanossegundos, eles parar√£o de empurrar e curar√£o pacificamente e felizes. </p><br><p>  Se envolvermos o comparador COMP4 em seu trabalho e conectarmos sua entrada positiva (porta PB0) ao sinal de entrada, use o DAC (DAC1) e conectemos sua sa√≠da (CH1) √† entrada negativa do comparador (dentro do controlador), obteremos um dispositivo de limite com um limite ajust√°vel.  As interrup√ß√µes da opera√ß√£o do comparador permitir√£o que voc√™ inicie o cron√¥metro geral do rel√≥gio TIM1 e obtenha o modo de espera, como em um oscilosc√≥pio. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468393/">https://habr.com/ru/post/pt468393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468381/index.html">De volta ao futuro? Borracha pendente Quantum</a></li>
<li><a href="../pt468383/index.html">Ruby meme generator para atrair interesse no idioma</a></li>
<li><a href="../pt468385/index.html">A √°rea de trabalho est√° morta, viva a √°rea de trabalho! Eu coleciono habrastatistiki</a></li>
<li><a href="../pt468387/index.html">O resumo de materiais interessantes para o desenvolvedor m√≥vel n¬∫ 316 (de 16 a 22 de setembro)</a></li>
<li><a href="../pt468389/index.html">Artyom Galonsky, STO Bureau do Bureau: ‚ÄúSou contra um engenheiro de DevOps‚Äù</a></li>
<li><a href="../pt468397/index.html">Not√≠cias do mundo do OpenStreetMap n¬∫ 477 (03/03/2019 - 09/09/2017)</a></li>
<li><a href="../pt468399/index.html">C / C ++. Como usar recursos de aplicativos incorporados ao trabalhar no GCC no Linux</a></li>
<li><a href="../pt468401/index.html">Maneira segura de trocar JWT no ASP.NET Core + SPA</a></li>
<li><a href="../pt468403/index.html">Controles de tempo de execu√ß√£o de aplicativos de software integrados</a></li>
<li><a href="../pt468405/index.html">Dois navegadores entram na barra de rolagem de alguma forma ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>