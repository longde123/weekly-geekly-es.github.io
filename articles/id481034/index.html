<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐗 📔 👨🏻‍🌾 Terowongan VPN langsung antara komputer melalui penyedia NAT (tanpa VPS, menggunakan server STUN dan Yandex.Disk) 👩🏽‍💻 💪🏽 🤞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kelanjutan artikel tentang bagaimana saya berhasil mengatur terowongan VPN langsung antara dua komputer yang terletak di belakang penyedia NAT. Artike...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Terowongan VPN langsung antara komputer melalui penyedia NAT (tanpa VPS, menggunakan server STUN dan Yandex.Disk)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481034/">  Kelanjutan <a href="https://habr.com/ru/post/478452/">artikel</a> tentang bagaimana saya berhasil mengatur terowongan VPN langsung antara dua komputer yang terletak di belakang penyedia NAT.  Artikel terakhir menjelaskan proses mengatur koneksi menggunakan pihak ketiga - perantara (VPS sewaan bertindak sebagai sesuatu seperti server STUN dan pemancar data node untuk koneksi).  Pada artikel ini saya akan memberitahu Anda bagaimana melakukannya tanpa VPS, tetapi perantara tetap dan mereka adalah server STUN dan Yandex. Disk ... <br><img src="https://habrastorage.org/webt/ud/sj/3t/udsj3te1itgjnnv-bsk99369pre.jpeg"><br><a name="habracut"></a><br><h3>  Pendahuluan </h3><br>  Setelah membaca komentar dari posting terakhir, saya menyadari bahwa kelemahan utama dari implementasi adalah penggunaan perantara - pihak ketiga (VPS) yang menunjukkan parameter node saat ini, di mana dan bagaimana menghubungkan.  Diberikan rekomendasi untuk menggunakan STUN ini (ada <a href="https://ru.wikipedia.org/wiki/STUN" rel="nofollow">banyak di antaranya</a> ) untuk menentukan parameter koneksi saat ini.  Pertama-tama, saya memutuskan untuk melihat isi paket menggunakan TCPDump ketika server STUN bekerja dengan klien dan menerima konten yang sama sekali tidak dapat dibaca.  Googling protokol menemukan <a href="https://tools.ietf.org/html/rfc3489" rel="nofollow">artikel yang menggambarkan protokol</a> .  Saya menyadari bahwa saya tidak dapat mengimplementasikan permintaan ke server STUN sendiri dan memasukkan gagasan itu ke "kotak jauh". <br><br><h3>  Teori </h3><br>  Baru-baru ini saya harus menginstal server STUN pada Debian dari sebuah paket <pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt install stun-server</span></span></code> </pre>  dan dalam dependensi saya melihat paket setrum-klien, tetapi entah bagaimana tidak mementingkan ini.  Tetapi kemudian, saya ingat tentang paket setrum-klien dan memutuskan untuk mencari tahu cara kerjanya, dengan googling dan Poindeksiv yang saya terima: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt install stun-client # stun stun.ekiga.net -p 21234 -v</span></span></code> </pre><br>  Sebagai tanggapan, saya menerima: <br><br><blockquote>  STUN klien versi 0.97 <br>  Membuka port 21234 dengan fd 3 <br>  Membuka port 21235 dengan fd 4 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 0 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 4 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 2 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Menerima pesan setrum: 92 byte <br>  MappedAddress = &lt;My IP&gt;: 2885 <br>  SourceAddress = 216.93.246.18//478 <br>  ChangedAddress = 216.93.246.17lla479 <br>  Atribut tidak dikenal: 32800 <br>  ServerName = Vovida.org 0,98-CPC <br>  Menerima pesan tipe 257 id = 1 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 0 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.17lla478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 4 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 2 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 0 <br><br>  Akan mengirim pesan dari len 28 ke &lt;My IP&gt;: 2885 <br>  Menerima pesan setrum: 28 byte <br>  ChangeRequest = 0 <br>  Menerima pesan tipe 1 id = 11 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 0 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.17lla478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 4 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 2 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Menerima pesan setrum: 92 byte <br>  MappedAddress = &lt;My IP&gt;: 2885 <br>  SourceAddress = 216.93.246.17lla479 <br>  ChangedAddress = 216.93.246.18 {478 <br>  Atribut tidak dikenal: 32800 <br>  ServerName = Vovida.org 0,98-CPC <br>  Menerima pesan tipe 257 id = 10 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 4 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 2 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 4 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 2 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 4 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 2 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 4 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 2 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 4 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  Pengkodean pesan setrum: <br>  Pengkodean ChangeRequest: 2 <br><br>  Akan mengirim pesan dari len 28 ke 216.93.246.18 opin478 <br>  tes I = 1 <br>  tes II = 0 <br>  Tes III = 0 <br>  tes I (2) = 1 <br>  adalah nat = 1 <br>  IP yang dipetakan sama = 1 <br>  jepit rambut = 1 <br>  port pemelihara = 0 <br>  Primer: Pemetaan Independen, Port Dependent Filter, port acak, akan menyematkan rambut <br>  Nilai kembali adalah 0x000006 </blockquote><br>  String dengan nilai <blockquote>  MappedAddress = &lt;My IP&gt;: 2885 </blockquote><br>  apa yang Anda butuhkan!  Ini menampilkan status saat ini untuk koneksi pada port UDP lokal 21234. Tetapi ini hanya setengah dari pertempuran, timbul pertanyaan tentang bagaimana mentransfer data ini ke host jarak jauh dan membuat koneksi VPN.  Menggunakan protokol surat, mungkin Telegram ?!  Ada banyak pilihan dan saya memutuskan untuk menggunakan Yandex.Disk, karena saya menemukan <a href="https://fritool.ru/curl-for-webdav/" rel="nofollow">sebuah artikel tentang bagaimana Curl bekerja melalui WebDav dengan Yandex.Disk</a> .  Setelah memikirkan implementasinya, saya sampai pada skema ini: <br><br><ol><li>  Untuk memberi tanda bahwa node siap untuk membuat koneksi dengan kehadiran file tertentu dengan cap waktu pada Yandex.disk; </li><li>  Jika node sudah siap, dapatkan parameter saat ini dari server STUN; </li><li>  Unggah parameter saat ini ke Yandex.Disk; </li><li>  Periksa ketersediaan dan baca parameter situs jauh dari file di Yandex.Disk; </li><li>  Buat koneksi ke host jarak jauh menggunakan OpenVPN. </li></ol><br><h3>  Berlatih </h3><br>  Setelah sedikit berpikir, dengan mempertimbangkan pengalaman artikel sebelumnya, saya menulis skrip cepat.  Kami akan membutuhkan: <pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># apt install openvpn stun-client curl</span></span></code> </pre> <br>  Sebenarnya skrip itu sendiri: <br><div class="spoiler">  <b class="spoiler_title">Opsi awal</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat vpn8.sh</span></span></code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash ########################    ### WARN='\033[37;1;41m' # END='\033[0m' # RED='\033[0;31m' # ${RED} # GREEN='\033[0;32m' # ${GREEN} # ################################################# #######################     ######################################################### al="echo readlink dirname grep awk md5sum shuf nc curl sleep openvpn cat stun" ch=0 for i in $al; do which $i &gt; /dev/null || echo -e "${WARN}   $i ${END}"; which $i &gt; /dev/null || ch=1; done if (( $ch &gt; 0 )); then echo -e "${WARN},      ${END}"; exit; fi ####################################################################################################################### if [[ $1 == '' ]]; then echo -e "${WARN}   (  ,      !) ${END} \t ${GREEN}           /etc/rc.local  nohup /&lt;  &gt;/vpn8.sh &gt; /var/log/vpn8.log 2&gt;/dev/hull &amp; ${END}"; exit; fi ABSOLUTE_FILENAME=`readlink -f "$0"` #     DIR=`dirname "$ABSOLUTE_FILENAME"` #      ###############################     ################################## key="$DIR/secret.key" if [ ! -f "$key" ]; then echo -e "${WARN}  VPN-  ,    : \ openvpn --genkey --secret secret.key :       \     !!!${END} # ls -l secret.key -rw------- 1 root root 637  27 11:12 secret.key # chmod 600 secret.key"; exit; fi ######################################################################################################################## ABSOLUTE_FILENAME=`readlink -f "$0"` #     DIR=`dirname "$ABSOLUTE_FILENAME"` #      name=$(uname -n | md5sum | awk '{print $1}') vpn=$(echo $1 | md5sum | awk '{print $1}') stun="stun.ekiga.net" # STUN  username="Yandex" #   . password="Password" #   . localport=`shuf -i 20000-65000 -n 1` #    echo "$(date)    ." curl -X MKCOL --user "${username}:${password}" https://webdav.yandex.ru/vpn-$vpn echo "$(date)     " for i in `curl --silent --user "$username:$password" -X PROPFIND -H "Depth: 1" https://webdav.yandex.ru/vpn-$vpn/ | sed 's/&gt;&lt;/\n/g' | grep "d:displayname" | sed 's/d:displayname//g' | sed 's/&gt;//g' | sed 's/&lt;//' | sed 's/\///g' | grep -v $(date +%Y-%m-%d-%H-%M)`; do echo "$(date) Delete: $i" curl -X DELETE --user "${username}:${password}" https://webdav.yandex.ru/vpn-$vpn/$i done until [ $c ];do until [[ $b ]]; do echo "$(date)  " date=`date +%Y-%m-%d-%H-%M` mydata=`curl --silent --user "${username}:${password}" -X PROPFIND -H "Depth: 1" https://webdav.yandex.ru/vpn-$vpn/ | sed 's/&gt;&lt;/&gt;\n&lt;/g' | grep $name | grep $date | grep "d:displayname"` if [[ -z $mydata ]]; then echo "$(date)   " echo "$date" &gt; "/tmp/$date-$name-ready.txt" curl -T "/tmp/$date-$name-ready.txt" --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/$date-$name-ready.txt else echo "$(date)     - $date" fi remote=`curl --silent --user "${username}:${password}" -X PROPFIND -H "Depth: 1" https://webdav.yandex.ru/vpn-$vpn/ | sed 's/&gt;&lt;/&gt;\n&lt;/g' | grep -v $name | grep $date | grep "d:displayname"` if [[ -z $remote ]]; then echo -e "$(date) ${RED}     ${END}" echo "$(date) " sleep 20 else echo -e "$(date) ${GREEN}    ${END}" b=1 a='' fi done until [ $a ]; do echo "$(date)      STUN : $stun" mydata=`stun $stun -p $localport -v 2&gt;&amp;1 | grep MappedAddress | sort | uniq` echo -e "$(date) ${GREEN}  : $mydata${END}" echo "$mydata" &gt; "$DIR/mydata" echo "$(date)    ." curl -T "$DIR/mydata" --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/$name.txt echo "$(date)     " filename=$(curl --silent --user "${username}:${password}" -X PROPFIND -H "Depth: 1" https://webdav.yandex.ru/vpn-$vpn/ | sed 's/&gt;&lt;/\n/g' | grep "d:displayname&gt;" | grep "txt" | grep -v "$name" | grep -v "ready" | sed 's|.*d:displayname&gt;||' | sed 's/&lt;/ /g' | awk '{print $1}') echo "$(date)     : $filename" address=$(curl --silent --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/$filename | sort | uniq | head -n1 | sed 's/:/ /g') echo "$(date)  IP-  " ip=$(echo "$address" | awk '{print $3}') port=$(echo "$address" | awk '{print $4}') if [[ -n "$ip" &amp;&amp; -n "$port" ]]; then echo -e "$(date) ${GREEN}  $ip $port ${END}" openvpn --remote $ip --rport $port --lport $localport \ --proto udp --dev tap --float --auth-nocache --verb 3 --mute 20 \ --ifconfig 10.45.54.2 255.255.255.252 \ --secret "$DIR/secret.key" \ --auth SHA256 --cipher AES-256-CBC \ --ncp-disable --ping 10 --ping-exit 30 \ --comp-lzo yes echo -e "$(date) ${WARN}  ${END}" a=1 b='' else a=1 b='' fi done done</span></span></code> </pre> <br>  Untuk menjalankan skrip yang Anda butuhkan: <br><ol><li>  Salin ke clipboard dan rekatkan ke editor, misalnya: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano vpn8.sh</span></span></code> </pre> </li><li>  tentukan nama pengguna dan kata sandi dari Yandex.Disk. </li><li>  di bidang "--ifconfig 10.45.54. (1 atau 2) 255.255.255.252" tentukan alamat IP internal antarmuka </li><li>  buat <b>secret.key dengan</b> perintah: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># openvpn --genkey --secret secret.key</span></span></code> </pre> </li><li>  membuat skrip dapat dieksekusi: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x vpn8.sh</span></span></code> </pre> </li><li>  jalankan skrip: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./vpn8.sh nZbVGBuX5dtturD</span></span></code> </pre> <br>  di mana nZbVGBuX5dtturD adalah ID koneksi yang dihasilkan <a href="https://strongpasswordgenerator.com/" rel="nofollow">di sini</a> </li></ol><br>  Pada node jarak jauh, lakukan hal yang sama kecuali untuk pembuatan secret.key dan koneksi ID, mereka harus identik. <br></div></div><br>  Versi terbaru (untuk operasi yang benar, waktu harus disinkronkan): <br><br><pre> <code class="bash hljs">cat vpn10.sh</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash stuns="stun.sipnet.ru stun.ekiga.net" #  STUN    username=" Login " #   . password=" Password " #   . intip="10.23.22.1" # IP-   WARN='\033[37;1;41m' END='\033[0m' RED='\033[0;31m' GREEN='\033[0;32m' al="ip echo readlink dirname grep awk md5sum openssl sha256sum shuf curl sleep openvpn cat stun" ch=0 for i in $al; do which $i &gt; /dev/null || echo -e "${WARN}   $i ${END}"; which $i &gt; /dev/null || ch=1; done if (( $ch &gt; 0 )); then echo -e "${WARN},      ${END}"; exit; fi if [[ $1 == '' ]]; then echo -e "${WARN}   (  ,      !) ${END} \t ${GREEN}           /etc/rc.local  nohup /&lt;  &gt;/vpn10.sh &gt; /var/log/vpn10.log 2&gt;/dev/hull &amp; ${END}" exit fi ABSOLUTE_FILENAME=`readlink -f "$0"` #     DIR=`dirname "$ABSOLUTE_FILENAME"` #      key="$DIR/secret.key" until [[ -n "$iftosrv" ]] do echo "$(date)   "; iftosrv=`ip route get 8.8.8.8 | head -n 1 | sed 's|.*dev ||' | awk '{print $1}'` sleep 5 done timedatectl name=$(uname -n | md5sum | awk '{print $1}') vpn=$(echo $1 | md5sum | awk '{print $1}') echo "$(date)    ." curl -X MKCOL --user "${username}:${password}" https://webdav.yandex.ru/vpn-$vpn echo "$(date) ID  : $vpn" until [ $c ];do echo "$(date)     " for i in `curl --silent --user "$username:$password" -X PROPFIND -H "Depth: 1" https://webdav.yandex.ru/vpn-$vpn/ | sed 's/&gt;&lt;/\n/g' | grep "d:displayname" | sed 's/d:displayname//g' | sed 's/&gt;//g' | sed 's/&lt;//' | sed 's/\///g' | grep -v $(date +%Y-%m-%d-%H-%M)` do echo -e "$(date)${RED}   : $i${END}" curl -X DELETE --user "${username}:${password}" https://webdav.yandex.ru/vpn-$vpn/$i done echo "$(date) ID  : $vpn" openvpn --genkey --secret "$key" passwd=`echo "$vpn-tt" | sha256sum | awk '{print $1}'` openssl AES-256-CBC -e -in "$key" -out "$DIR/file.enc" -k "$passwd" -base64 curl -T "$DIR/file.enc" --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/key.enc rm "$DIR"/file.enc echo -e "$(date) ${GREEN} 1 -    ${END}" go=3 localport=`shuf -i 20000-65000 -n 1` #    start='' remote='' timeout1='' nextcheck='' timestart='' until [[ $b ]] do echo "$(date)  " date=`date +%s` timeout1=60 echo "$(date)    $date" echo "$date" &gt; "/tmp/ready-$date-$name.txt" curl -T "/tmp/ready-$date-$name.txt" --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/ready-$name.txt readyfile=`curl --silent --user "${username}:${password}" -X PROPFIND -H "Depth: 1" https://webdav.yandex.ru/vpn-$vpn/ | sed 's/&gt;&lt;/&gt;\n&lt;/g' | grep -v $name | grep "ready" | grep "d:displayname" | sed 's/&lt;d:displayname&gt;//g' | sed 's/&lt;\/d:displayname&gt;//g'` if [[ -z $readyfile ]] then echo -e "$(date) ${RED}     ${END}" echo "$(date)  60 " sleep $timeout1 else remote=$(curl --silent --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/$readyfile) echo -e "$(date) ${GREEN}    ${END}" start=`curl --silent --user "${username}:${password}" -X PROPFIND -H "Depth: 1" https://webdav.yandex.ru/vpn-$vpn/ | sed 's/&gt;&lt;/&gt;\n&lt;/g' | grep "start" | grep "d:displayname" | sed 's/-/ /g' | awk '{print $2}'` if [[ -z $start ]] then let nextcheck=$timeout1-$date+$remote let timestart=$date+$timeout1-$nextcheck go=$nextcheck echo "$timestart" &gt; "/tmp/start-$date-$name.txt" curl -T "/tmp/start-$date-$name.txt" --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/start-$date-$name.txt else echo "$(date)  $go " sleep $go b=1 a='' fi fi done echo -e "$(date) ${GREEN} 2 -     ${END}" mydata='' filename='' address='' myip='' ip='' port='' ex=0 until [ $a ]; do until [[ -n "$mydata" ]]; do k=`echo "$stuns" | wc -w` x=1 z=`shuf -i 1-$k -n 1` for st in $stuns; do if [[ $x == $z ]]; then stun=$st; fi; (( x++ )); done echo "$(date)      STUN : $stun" sleep 5 &amp;&amp; for pid in $(ps xa | grep "stun "$stun" 1 -p "$localport" -v" | grep -v grep | awk '{print $1}'); do kill $pid; done &amp; mydata=`stun "$stun" 1 -p "$localport" -v 2&gt;&amp;1 | grep "MappedAddress" | sort | uniq` done echo -e "$(date) ${GREEN}  : $mydata${END}" echo "$(date)    ." echo "$mydata" &gt; "$DIR/mydata" echo "IntIP $intip" &gt;&gt; "$DIR/mydata" curl -T "$DIR/mydata" --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/$name-ipport.txt rm "$DIR/mydata" sleep 5 echo "$(date)     " filename=$(curl --silent --user "${username}:${password}" -X PROPFIND -H "Depth: 1" https://webdav.yandex.ru/vpn-$vpn/ | sed 's/&gt;&lt;/\n/g' | grep "d:displayname&gt;" | grep "ipport" | grep -v "$name" | sed 's|.*d:displayname&gt;||' | sed 's/&lt;/ /g' | awk '{print $1}') if [[ -n "$filename" ]] then echo "$(date)     : $filename" address=$(curl --silent --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/$filename | grep "MappedAddress" | head -n1 | sed 's/:/ /g') intip2=$(curl --silent --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/$filename | grep "IntIP" | head -n1 | awk '{print $2}') echo "$(date)  IP-  : $address $sesid2 $tunid2" ip=$(echo "$address" | awk '{print $3}') port=$(echo "$address" | awk '{print $4}') myip=`ip route get "$ip" | head -n 1 | sed 's|.*src ||' | awk '{print $1}'` if [[ -n "$ip" &amp;&amp; -n "$port" &amp;&amp; -n "$myip" &amp;&amp; -n "$localport" ]]; then echo -e "$(date) ${GREEN}  $ip $port ${END}" echo -e "`date` ${GREEN} $myip:$localport -&gt; $ip:$port ${END}" curl --silent --user "$username:$password" https://webdav.yandex.ru/vpn-$vpn/key.enc &gt; "$DIR/secret.enc" openssl AES-256-CBC -d -in "$DIR/secret.enc" -out "$key" -k "$passwd" -base64 chmod 600 "$key" rm "$DIR/secret.enc" openvpn --remote $ip --rport $port --lport $localport \ --proto udp --dev tun --float --auth-nocache --verb 3 --mute 20 \ --ifconfig "$intip" "$intip2" \ --secret "$key" \ --auth SHA256 --cipher AES-256-CBC \ --ncp-disable --ping 10 --ping-exit 20 \ --comp-lzo yes a=1 b='' fi else if (( $ex &gt;= 5 )) then echo "$(date) " a=1 b='' fi (( ex++ )) sleep 5 fi done done</span></span></code> </pre><br>  Untuk menjalankan skrip yang Anda butuhkan: <br><ol><li>  Salin ke clipboard dan rekatkan ke editor, misalnya: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># nano vpn10.sh</span></span></code> </pre> </li><li>  tentukan login (baris kedua) dan kata sandi dari Yandex.Disk (baris ketiga). </li><li>  tentukan alamat IP internal terowongan (baris 4). </li><li>  membuat skrip dapat dieksekusi: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x vpn10.sh</span></span></code> </pre> </li><li>  jalankan skrip: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./vpn10.sh nZbVGBuX5dtturD</span></span></code> </pre> <br>  di mana nZbVGBuX5dtturD adalah ID koneksi yang dihasilkan <a href="https://strongpasswordgenerator.com/" rel="nofollow">di sini</a> </li></ol><br>  Pada node jarak jauh, lakukan hal yang sama, tentukan alamat IP internal terowongan dan koneksi ID yang sesuai. <br><br>  Untuk memulai skrip saat startup, saya menggunakan perintah "nohup / &lt;path to script&gt; /vpn10.sh nZbVGBuX5dtturD&gt; /var/log/vpn10.log 2&gt; / dev / null &amp;" yang terdapat dalam file /etc/rc.local <br><br><h3>  Kesimpulan </h3><br>  Script berfungsi, diuji pada Ubuntu 18.04 dan Debian 9. Anda dapat menggunakan layanan lain sebagai pemancar, tetapi untuk pengalaman saya menggunakan Yandex.Disk. <br>  Dalam perjalanan percobaan, ditemukan bahwa beberapa jenis penyedia NAT tidak memungkinkan untuk koneksi.  Sebagian besar dengan operator seluler di mana torrent diblokir. <br><br>  Saya berencana untuk menyelesaikan dalam hal: <br><ul><li>  Pembuatan otomatis secret.key setiap kali Anda memulai, mengenkripsi dan menyalin ke Yandex.Disk untuk mentransfer ke host jarak jauh (Dipertimbangkan dalam versi yang diperbarui) </li><li>  Secara otomatis Menetapkan Alamat IP Antarmuka </li><li>  Enkripsi data sebelum mengunggah ke Yandex.Disk </li><li>  Optimasi kode </li></ul><br>  Semoga ada IPv6 di setiap rumah! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id481034/">https://habr.com/ru/post/id481034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id481020/index.html">Menulis simulator pengetikan sentuh menggunakan JavaScript murni: Bagian 2</a></li>
<li><a href="../id481024/index.html">Mengapa saya meninggalkan Google Maps API</a></li>
<li><a href="../id481028/index.html">Panduan untuk Mengatur Koneksi Jarak Jauh ke PLC Industri Menggunakan OpenVPN</a></li>
<li><a href="../id481030/index.html">Jenis cyberdec apa yang ingin saya lakukan untuk diri saya sendiri</a></li>
<li><a href="../id481032/index.html">Mengapa bisa diretas? Mungkin karena penyerang</a></li>
<li><a href="../id481036/index.html">30 Utilitas untuk Alat Pengembang Firefox</a></li>
<li><a href="../id481038/index.html">Pengakuan seorang pecandu desain. Bagaimana kami membuat game "IT Alchemy" dalam sebulan</a></li>
<li><a href="../id481042/index.html">Kami rasa Django menggairahkan dan menarik</a></li>
<li><a href="../id481044/index.html">Apa yang akan disajikan untuk tahun 2020: Panduan Tahun Baru Madrobots</a></li>
<li><a href="../id481048/index.html">Pengakuan sirkuit digital. Elemen-C yang digeneralisasi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>