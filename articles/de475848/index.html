<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë® üßû ‚ôëÔ∏è Wie die Yandex.Market-Suche funktioniert und was passiert, wenn einer der Server abst√ºrzt üë®üèº‚Äçüé® üë®üèæ‚Äç‚öñÔ∏è ‚öΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo, ich hei√üe Eugene. Ich arbeite in der Suchinfrastruktur von Yandex.Market. Ich m√∂chte der Habr-Community etwas √ºber die interne K√ºche des Markte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie die Yandex.Market-Suche funktioniert und was passiert, wenn einer der Server abst√ºrzt</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/475848/">  Hallo, ich hei√üe Eugene.  Ich arbeite in der Suchinfrastruktur von Yandex.Market.  Ich m√∂chte der Habr-Community etwas √ºber die interne K√ºche des Marktes erz√§hlen - aber es gibt etwas zu erz√§hlen.  Zuallererst, wie Market Search, Prozesse und Architektur funktionieren.  Wie gehen wir mit Notsituationen um: Was passiert, wenn ein Server abst√ºrzt?  Und wenn es 100 solcher Server gibt? <br><br>  Au√üerdem erfahren Sie sofort, wie wir neue Funktionen auf einer Reihe von Servern implementieren.  Und wie Sie komplexe Services direkt in der Produktion testen k√∂nnen, ohne dass dies den Benutzern unangenehm wird.  Im Allgemeinen, wie die Suche nach dem Markt funktioniert, so dass es allen gut geht. <br><br><img src="https://habrastorage.org/webt/-x/ye/eb/-xyeebvixa2pxxh3ad-peaoukyo.png"><br><a name="habracut"></a><br><h2>  Ein wenig √ºber uns: Welches Problem l√∂sen wir? </h2><br>  Wenn Sie Text eingeben, anhand von Parametern nach Produkten suchen oder Preise in verschiedenen Gesch√§ften vergleichen, gehen alle Anfragen beim Suchdienst ein.  Die Suche ist der gr√∂√üte Dienst auf dem Markt. <br><br>  Wir bearbeiten alle Suchanfragen: von market.yandex.ru, famous.ru, dem Supercheck-Service, Yandex.Advisor und mobilen Anwendungen.  Wir nehmen auch Warenangebote in die Suchergebnisse auf yandex.ru auf. <br><br><img width="500" src="https://habrastorage.org/webt/yt/_h/5d/yt_h5de7hmx0zmkv8gdk7glq-kc.png"><br><br>  Mit Suchdienst meine ich nicht nur die direkte Suche, sondern auch eine Datenbank mit allen Angeboten auf dem Markt.  Der Ma√üstab ist folgender: Pro Tag werden mehr als eine Milliarde Suchanfragen bearbeitet.  Und alles sollte schnell und ohne Unterbrechungen funktionieren und immer das gew√ºnschte Ergebnis liefern. <br><br><h2>  Was ist was: Marktarchitektur </h2><br>  Beschreiben Sie kurz die aktuelle Architektur des Marktes.  Herk√∂mmlicherweise kann es durch das folgende Schema beschrieben werden: <br><img src="https://habrastorage.org/webt/ra/yq/jv/rayqjvvmbjvxhsc8lokpysg_rvw.jpeg"><br>  Nehmen wir an, ein Partnergesch√§ft kommt zu uns.  Er sagt, ich m√∂chte ein Spielzeug verkaufen: diese b√∂se Katze mit einem Quietscher.  Und eine b√∂se Katze ohne Hocht√∂ner.  Und nur eine Katze.  Dann muss das Gesch√§ft Angebote erstellen, nach denen der Markt sucht.  Der Store bildet eine spezielle XML-Datei mit Angeboten und teilt den Pfad zu dieser XML-Datei √ºber eine Partnerschnittstelle mit.  Anschlie√üend l√§dt der Indexer diese XML-Datei regelm√§√üig herunter, √ºberpr√ºft sie auf Fehler und speichert alle Informationen in einer riesigen Datenbank. <br><br>  Es gibt viele solcher gespeicherten XML-Dateien.  Aus dieser Datenbank wird ein Suchindex erstellt.  Der Index wird im internen Format gespeichert.  Nachdem der Index erstellt wurde, l√§dt der Layout-Dienst ihn in die Suchmaschinen hoch. <br><br>  Infolgedessen wird eine b√∂se Katze mit einem Quietscher in der Datenbank angezeigt, und auf dem Server wird ein Katzenindex angezeigt. <br><br>  Ich werde im Teil √ºber die Sucharchitektur dar√ºber sprechen, wie wir nach einer Katze suchen. <br><br><h2>  Marktsucharchitektur </h2><br>  Wir leben in der Welt der Mikrodienste: Jede eingehende Anfrage an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">market.yandex.ru</a> verursacht viele Unterabfragen, und Dutzende von Diensten beteiligen sich an deren Verarbeitung.  Das Diagramm zeigt nur einige: <br><br><img src="https://habrastorage.org/webt/92/n9/iu/92n9iutvet9ls6k7djh29brfdq0.jpeg"><br>  <i>Vereinfachtes Anforderungsverarbeitungsschema</i> <br><br>  Jeder Service hat eine wunderbare Sache - einen eigenen Balancer mit einem eindeutigen Namen: <br><br><img src="https://habrastorage.org/webt/qb/_c/t4/qb_ct4mdpio2xprdlos2pi1oym8.jpeg"><br><br>  Der Balancer bietet uns gro√üe Flexibilit√§t bei der Verwaltung des Dienstes: Sie k√∂nnen beispielsweise die Server ausschalten, was h√§ufig f√ºr Updates erforderlich ist.  Der Balancer erkennt, dass der Server nicht verf√ºgbar ist, und leitet Anforderungen automatisch an andere Server oder Rechenzentren weiter.  Wenn Sie einen Server hinzuf√ºgen oder entfernen, wird die Last automatisch zwischen den Servern umverteilt. <br><br>  Der eindeutige Name des Balancers h√§ngt nicht vom Rechenzentrum ab.  Wenn Service A eine Anfrage an B sendet, leitet Balancer B die Anfrage standardm√§√üig an das aktuelle Rechenzentrum weiter.  Wenn der Dienst im aktuellen Rechenzentrum nicht verf√ºgbar ist oder nicht vorhanden ist, wird die Anforderung an andere Rechenzentren umgeleitet. <br><br>  Ein einziger FQDN f√ºr alle Rechenzentren erm√∂glicht es Service A, sich generell von Standorten zu l√∂sen.  Seine Anfrage an Service B wird immer bearbeitet.  Eine Ausnahme ist der Fall, wenn sich der Service in allen Rechenzentren befindet. <br><br>  Bei diesem Balancer ist aber nicht alles so rosig: Wir haben eine zus√§tzliche Zwischenkomponente.  Der Balancer ist m√∂glicherweise instabil und dieses Problem wird durch redundante Server behoben.  Es gibt auch eine zus√§tzliche Verz√∂gerung zwischen den Diensten A und B. In der Praxis betr√§gt sie jedoch weniger als 1 ms, und f√ºr die meisten Dienste ist dies nicht kritisch. <br><br><h3>  Gegen das Unerwartete: ausgleichende und belastbare Suchdienste </h3><br>  Stellen Sie sich einen Zusammenbruch vor: Sie m√ºssen eine Katze mit einem Quietscher finden, aber der Server st√ºrzt ab.  Oder 100 Server.  Wie komme ich raus?  Verlassen wir den Benutzer wirklich ohne Katze? <br><br>  Die Situation ist schrecklich, aber wir sind bereit daf√ºr.  Ich sage es dir in der richtigen Reihenfolge. <br><br>  Die Suchinfrastruktur befindet sich in mehreren Rechenzentren: <br><br><img src="https://habrastorage.org/webt/_i/wa/f9/_iwaf97__hrhmaspgxcl-euqqnq.jpeg"><br><br>  Beim Entwurf legen wir die M√∂glichkeit fest, ein Rechenzentrum zu deaktivieren.  Das Leben ist voller √úberraschungen - zum Beispiel kann ein Bagger ein unterirdisches Kabel durchtrennen (ja, das war so).  Die Kapazit√§ten in den verbleibenden Rechenzentren sollten ausreichen, um der Spitzenlast standzuhalten. <br><br>  Betrachten Sie ein einzelnes Rechenzentrum.  In jedem Rechenzentrum das gleiche Schema von Balancern: <br><br><img src="https://habrastorage.org/webt/x6/rp/hx/x6rphx-hrlcb1gciennukyjeudi.jpeg"><br>  Ein Balancer besteht aus mindestens drei physischen Servern.  Eine solche Redundanz dient der Zuverl√§ssigkeit.  Balancer arbeiten mit HAProx. <br><br>  Wir haben uns f√ºr HAProx aufgrund seiner hohen Leistung, des geringen Ressourcenbedarfs und der breiten Funktionalit√§t entschieden.  In jedem Server funktioniert unsere Suchsoftware. <br><br>  Die Ausfallwahrscheinlichkeit eines Servers ist gering.  Wenn Sie jedoch √ºber viele Server verf√ºgen, steigt die Wahrscheinlichkeit, dass mindestens einer ausf√§llt. <br><br>  In der Realit√§t passiert Folgendes: Server st√ºrzen ab.  Daher m√ºssen Sie den Status aller Server st√§ndig √ºberwachen.  Wenn der Server nicht mehr reagiert, wird er automatisch vom Datenverkehr getrennt.  Zu diesem Zweck verf√ºgt HAProxy √ºber eine integrierte Integrit√§tspr√ºfung.  Es wird einmal pro Sekunde an alle Server mit der HTTP-Anforderung "/ ping" gesendet. <br><br>  Eine weitere Funktion von HAProxy: Mit Agent-Check k√∂nnen Sie alle Server gleichm√§√üig laden.  Zu diesem Zweck stellt HAProxy eine Verbindung zu allen Servern her und gibt ihre Gewichtung abh√§ngig von der aktuellen Auslastung von 1 bis 100 zur√ºck. Die Gewichtung wird basierend auf der Anzahl der Anforderungen in der Verarbeitungswarteschlange und der Auslastung des Prozessors berechnet. <br><br>  Jetzt geht es darum, eine Katze zu finden.  Anfragen der Form <b>/ Suche? Text = w√ºtend + Katze</b> kommen zur <b>Suche</b> .  F√ºr eine schnelle Suche muss der gesamte Katzenindex im RAM abgelegt werden.  Selbst das Lesen von einer SSD ist nicht schnell genug. <br><br>  Es war einmal eine kleine Angebotsbasis und es gab genug RAM f√ºr einen Server.  Als die Angebotsdatenbank wuchs, passte nicht mehr alles in diesen Arbeitsspeicher, und die Daten wurden in zwei Teile geteilt: Scherbe 1 und Scherbe 2. <br><br><img src="https://habrastorage.org/webt/kz/od/j5/kzodj5ghrqccc_necth6gmylzgy.jpeg"><br>  Aber es kommt immer vor: Jede L√∂sung, auch eine gute, wirft andere Probleme auf. <br><br>  Der Balancer ging immer noch zu einem Server.  Auf der Maschine, auf der die Anfrage eingegangen ist, war jedoch nur die H√§lfte des Index vorhanden.  Der Rest war auf anderen Servern.  Daher musste der Server zu einem benachbarten Computer gehen.  Nachdem die Daten von beiden Servern empfangen wurden, wurden die Ergebnisse kombiniert und neu organisiert. <br><br>  Da der Balancer die Anforderungen gleichm√§√üig verteilt, wurden alle Server neu angeordnet und gaben nicht nur Daten weiter. <br><br>  Das Problem trat auf, wenn der benachbarte Server nicht verf√ºgbar war.  Die L√∂sung bestand darin, mehrere Server mit unterschiedlichen Priorit√§ten als "benachbarten" Server anzugeben.  Zuerst wurde die Anfrage an die Server im aktuellen Rack gesendet.  Wenn keine Antwort empfangen wurde, wurde die Anfrage an alle Server in diesem Rechenzentrum gesendet.  Und zu guter Letzt ging die Anfrage an andere Rechenzentren. <br>  Mit zunehmender Anzahl von Vorschl√§gen wurden die Daten in vier Teile geteilt.  Aber das war nicht die Grenze. <br><br>  Nun wird eine Konfiguration von acht Shards verwendet.  Um Speicherplatz zu sparen, wurde der Index au√üerdem in den Suchteil (√ºber den die Suche stattfindet) und den Snippet-Teil (der nicht an der Suche beteiligt ist) unterteilt. <br><br>  Ein Server enth√§lt nur Informationen zu einem Shard.  Um eine Suche im gesamten Index durchzuf√ºhren, m√ºssen Sie daher auf acht Servern suchen, die unterschiedliche Shards enthalten. <br><br>  Server sind in Clustern gruppiert.  Jeder Cluster enth√§lt acht Suchmaschinen und ein Snippet. <br><br><img src="https://habrastorage.org/webt/1b/om/dl/1bomdlbzui-uxhswoq1kfq9h7os.jpeg"><br>  Die Schl√ºsselwertdatenbank mit statischen Daten wird auf dem Snippet-Server ausgef√ºhrt.  Sie werden f√ºr die Ausstellung von Dokumenten ben√∂tigt, beispielsweise eine Beschreibung einer Katze mit einem Quietscher.  Die Daten werden speziell auf einem separaten Server abgelegt, um den Speicher der Suchmaschinen nicht zu belasten. <br><br>  Da Dokument-IDs nur innerhalb eines Index eindeutig sind, kann es vorkommen, dass sich keine Dokumente in den Snippets befinden.  Na ja oder so auf einer ID wird es andere Inhalte geben.  Damit die Suche funktioniert und die Suche stattfinden kann, besteht daher ein Bedarf an der Konsistenz des gesamten Clusters.  Ich werde sp√§ter dar√ºber sprechen, wie wir die Konsistenz √ºberwachen. <br><br>  Die Suche selbst ist wie folgt organisiert: Eine Suchabfrage kann an einen von acht Servern gesendet werden.  Angenommen, er ist zu Server 1 gekommen. Dieser Server verarbeitet alle Argumente und versteht, wonach und wie gesucht werden muss.  Abh√§ngig von der eingehenden Anforderung kann der Server zus√§tzliche Anforderungen an externe Dienste f√ºr die erforderlichen Informationen stellen.  Einer Anfrage k√∂nnen bis zu zehn Anfragen an externe Dienste folgen. <br><br>  Nach dem Sammeln der erforderlichen Informationen beginnt eine Suche in der Angebotsdatenbank.  Dazu werden f√ºr alle acht Server im Cluster Unterabfragen durchgef√ºhrt. <br><br>  Nach Erhalt der Antworten werden die Ergebnisse zusammengefasst.  Zum Generieren des Problems ben√∂tigen Sie m√∂glicherweise mehrere weitere Unterabfragen an den Snippet-Server. <br><br>  Suchanfragen innerhalb des Clusters lauten: <b>/ shard1? Text = angry + cat</b> .  Au√üerdem werden einmal pro Sekunde Unterabfragen der Form: <b>/ status</b> zwischen allen Servern innerhalb des Clusters durchgef√ºhrt. <br><br>  Die <b>/ status-</b> Anforderung erkennt eine Situation, in der der Server nicht verf√ºgbar ist. <br><br>  Au√üerdem wird gesteuert, dass auf allen Servern die Suchmaschinenversion und die Indexversion identisch sind, da sonst inkonsistente Daten im Cluster vorhanden sind. <br><br>  Trotz der Tatsache, dass ein Snippet-Server Anfragen von acht Suchmaschinen verarbeitet, ist sein Prozessor sehr schwach ausgelastet.  Aus diesem Grund √ºbertragen wir jetzt Snippet-Daten an einen separaten Dienst. <br><br><img src="https://habrastorage.org/webt/3u/q5/ng/3uq5ngicgxwxg60diggqot7iiky.jpeg"><br><br>  F√ºr die Daten√ºbertragung haben wir Universalschl√ºssel f√ºr Dokumente eingef√ºhrt.  Jetzt ist die Situation unm√∂glich, wenn ein Schl√ºssel Inhalt aus einem anderen Dokument zur√ºckgibt. <br><br>  Der √úbergang zu einer anderen Architektur ist jedoch noch nicht abgeschlossen.  Jetzt wollen wir den dedizierten Snippet-Server loswerden.  Und dann in der Regel weg von der Clusterstruktur.  Auf diese Weise k√∂nnen wir die Skalierung problemlos fortsetzen.  Ein zus√§tzlicher Bonus ist eine erhebliche Eisenersparnis. <br><br>  Und nun zu den Gruselgeschichten mit Happy End.  Betrachten Sie mehrere F√§lle von Nichtverf√ºgbarkeit des Servers. <br><br><h4>  Schrecklich ist passiert: Ein Server ist nicht verf√ºgbar </h4><br>  Angenommen, ein Server ist nicht verf√ºgbar.  Die anderen Server im Cluster antworten m√∂glicherweise weiterhin, die Suchergebnisse sind jedoch unvollst√§ndig. <br><br>  Durch eine Statuspr√ºfung erkennen benachbarte Server, dass einer nicht verf√ºgbar ist.  Um die Vollst√§ndigkeit zu gew√§hrleisten, antworten alle Server im Cluster auf die <b>/ ping-</b> Anforderung an den Balancer, dass sie ebenfalls nicht verf√ºgbar sind.  Es stellt sich heraus, dass alle Server im Cluster gestorben sind (was nicht der Fall ist).  Dies ist der Hauptnachteil unseres Cluster-Schemas - deshalb wollen wir davon wegkommen. <br><br><img src="https://habrastorage.org/webt/hr/ko/2o/hrko2ovb9b5q2hjb8xqgnubynec.jpeg"><br><br>  Anfragen, die mit einem Fehler endeten, fragt der Balancer erneut auf anderen Servern. <br>  Au√üerdem sendet der Balancer keinen Benutzerverkehr mehr an tote Server, √ºberpr√ºft jedoch weiterhin deren Status. <br><br>  Sobald der Server verf√ºgbar ist, reagiert er auf <b>/ ping</b> .  Sobald normale Antworten auf Pings von toten Servern eingehen, beginnen Balancer, Benutzerverkehr dorthin zu senden.  Der Cluster ist wiederhergestellt, Prost. <br><br><h4>  Schlimmer noch: Viele Server sind nicht verf√ºgbar </h4><br>  Ein erheblicher Teil der Server im Rechenzentrum ist heruntergefahren.  Was tun, wo laufen?  Der Balancer kommt wieder zur Rettung.  Jeder Balancer speichert st√§ndig die aktuelle Anzahl der Live-Server.  Er ber√ºcksichtigt immer die maximale Verkehrsmenge, die das aktuelle Rechenzentrum verarbeiten kann. <br><br>  Wenn viele Server im Rechenzentrum ausfallen, erkennt der Balancer, dass dieses Rechenzentrum nicht den gesamten Datenverkehr verarbeiten kann. <br><br>  Anschlie√üend wird der √ºbersch√ºssige Datenverkehr zuf√§llig auf andere Rechenzentren verteilt.  Alles funktioniert, jeder ist gl√ºcklich. <br><br><img src="https://habrastorage.org/webt/cp/g-/if/cpg-ifevj3dzyvmedn1v-g5lzpg.jpeg"><br><h2>  Wie wir es machen: Releases ver√∂ffentlichen </h2><br>  Jetzt erfahren Sie, wie wir die am Service vorgenommenen √Ñnderungen ver√∂ffentlichen.  Hier haben wir den Weg der Rationalisierung beschritten: Die Einf√ºhrung eines neuen Releases ist fast vollst√§ndig automatisiert. <br>  Wenn das Projekt eine bestimmte Anzahl von √Ñnderungen enth√§lt, wird automatisch eine neue Version erstellt und deren Assembly gestartet. <br><br><img src="https://habrastorage.org/webt/cy/to/0f/cyto0f3qhsuxs7bgd2momnccebe.jpeg"><br><br>  Dann wird der Service zum Testen ausgerollt, wo die Stabilit√§t √ºberpr√ºft wird. <br><br>  Gleichzeitig wird ein automatischer Leistungstest gestartet.  Er nimmt an einem besonderen Dienst teil.  Ich werde jetzt nicht √ºber ihn sprechen - seine Beschreibung verdient einen eigenen Artikel. <br><br>  Wenn die Ver√∂ffentlichung im Test erfolgreich ist, startet die Ver√∂ffentlichung der Ver√∂ffentlichung in prestable automatisch.  Prestable ist ein spezieller Cluster, in dem der normale Benutzerverkehr geleitet wird.  Wenn ein Fehler zur√ºckgegeben wird, f√ºhrt der Balancer eine erneute Anforderung in der Produktion durch. <br><br>  In prestable werden die Reaktionszeiten gemessen und mit dem vorherigen Release in der Produktion verglichen.  Wenn alles in Ordnung ist, stellt die Person eine Verbindung her: Sie √ºberpr√ºft die Grafiken und Ergebnisse der Belastungstests und beginnt mit der Einf√ºhrung in die Produktion. <br><br><h2>  Alles Gute f√ºr den Anwender: A / B-Tests </h2><br>  Es ist nicht immer offensichtlich, ob √Ñnderungen im Service echte Vorteile bringen.  Um den Nutzen von Ver√§nderungen zu messen, wurden A / B-Tests entwickelt.  Ich werde ein wenig dar√ºber sprechen, wie dies in der Yandex.Market-Suche funktioniert. <br><br>  Alles beginnt mit dem Hinzuf√ºgen eines neuen CGI-Parameters, der neue Funktionen enth√§lt.  Unser Parameter sei: <i>market_new_functionality = 1</i> .  Aktivieren Sie dann im Code diese Funktionalit√§t mit dem Flag: <br><br><pre><code class="cpp hljs">If (cgi.experiments.market_new_functionality) { <span class="hljs-comment"><span class="hljs-comment">// enable new functionality }</span></span></code> </pre> <br>  Neue Funktionen werden in der Produktion eingef√ºhrt. <br><br>  F√ºr die Automatisierung von A / B-Tests gibt es einen speziellen Dienst, der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ausf√ºhrlich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">beschrieben</a> wird.  Im Service wird ein Experiment angelegt.  Der Verkehrsanteil ist beispielsweise auf 15% festgelegt.  Das Interesse richtet sich nicht an Anfragen, sondern an Benutzer.  Die Zeit des Experiments, beispielsweise eine Woche, ist ebenfalls angegeben. <br><br>  Es k√∂nnen mehrere Versuche gleichzeitig gestartet werden.  In den Einstellungen k√∂nnen Sie festlegen, ob eine √úberschneidung mit anderen Experimenten m√∂glich ist. <br><br>  Infolgedessen f√ºgt der Dienst automatisch das Argument <i>market_new_functionality = 1</i> zu 15% der Benutzer hinzu.  Er berechnet auch automatisch die ausgew√§hlten Metriken.  Nach dem Experiment sehen sich die Analysten die Ergebnisse an und ziehen Schlussfolgerungen.  Auf der Grundlage der Ergebnisse wird die Entscheidung getroffen, die Produktion aufzunehmen oder zu verfeinern. <br><br><h2>  Die wendige Hand des Marktes: Produktionstests </h2><br>  Es kommt h√§ufig vor, dass die Funktionsweise neuer Funktionen in der Produktion √ºberpr√ºft werden muss, es gibt jedoch keine Gewissheit dar√ºber, wie sie sich unter "Kampfbedingungen" unter hoher Last verhalten werden. <br><br>  Es gibt eine L√∂sung: Flags in CGI-Parametern k√∂nnen nicht nur zum Testen von A / B, sondern auch zum Testen neuer Funktionen verwendet werden. <br><br>  Wir haben ein Tool entwickelt, mit dem Sie die Konfiguration auf Tausenden von Servern sofort √§ndern k√∂nnen, ohne den Service Risiken auszusetzen.  Es hei√üt "Stop Crane".  Die urspr√ºngliche Idee war die M√∂glichkeit, einige Funktionen ohne Layout schnell auszuschalten.  Dann wurde das Tool erweitert und komplexer. <br><br>  Das Schema des Dienstes ist unten dargestellt: <br><br><img src="https://habrastorage.org/webt/va/la/n8/valan8guj5dkld2j788pw7ytbwy.jpeg"><br><br>  Die API setzt Flag-Werte.  Der Verwaltungsdienst speichert diese Werte in einer Datenbank.  Alle Server gehen alle zehn Sekunden in die Datenbank, pumpen die Werte der Flags aus und wenden diese Werte auf jede Anforderung an. <br><br>  In Stop Crane k√∂nnen Sie zwei Arten von Werten festlegen: <br><br>  1) Bedingte Ausdr√ºcke.  Anwenden, wenn einer der Werte ausgef√ºhrt wird.  Zum Beispiel: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>:<span class="hljs-string"><span class="hljs-string">"IS_DC1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">"condition"</span></span>: <span class="hljs-string"><span class="hljs-string">"CLUSTER==2 and IS_BERU"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"4!"</span></span> }</code> </pre> <br>  Der Wert "3" wird angewendet, wenn die Anforderung am Speicherort DC1 verarbeitet wird.  Und der Wert ist "4", wenn die Anfrage auf dem zweiten Cluster f√ºr die Website famous.ru verarbeitet wird. <br><br>  2) Bedingungslose Werte.  Sie werden standardm√§√üig verwendet, wenn keine der Bedingungen erf√ºllt ist.  Zum Beispiel: <br><br>  <i>Wert, Wert!</i> <br><br>  Wenn der Wert mit einem Ausrufezeichen endet, erh√§lt er eine h√∂here Priorit√§t. <br><br>  Der Parser der CGI-Parameter analysiert die URL.  Dann werden die Werte vom Stopp-Tap √ºbernommen. <br><br>  Es gelten Werte mit folgenden Priorit√§ten: <br><br><ol><li>  H√∂here Priorit√§t ab Stopp Tippen (Ausrufezeichen). </li><li>  Der Wert aus der Abfrage. </li><li>  Der Standardwert stammt vom Stopp-Tippen. </li><li>  Der Standardwert im Code. </li></ol><br>  Es gibt viele Flags, die in bedingten Werten angegeben sind - sie reichen f√ºr alle uns bekannten Szenarien aus: <br><br><ul><li>  Rechenzentrum. </li><li>  Umwelt: Produktion, Pr√ºfung, Schatten. </li><li>  Veranstaltungsort: Markt, ber√ºhmt. </li><li>  Clusternummer. </li></ul><br>  Mit diesem Tool k√∂nnen Sie neue Funktionen auf einer Gruppe von Servern (z. B. nur in einem Rechenzentrum) aktivieren und die Funktionsweise dieser Funktionen √ºberpr√ºfen, ohne dass dies ein Risiko f√ºr den gesamten Dienst darstellt.  Selbst wenn Sie irgendwo einen schwerwiegenden Fehler gemacht haben, fiel alles und das gesamte Rechenzentrum fiel aus. Balancer leiten Anforderungen an andere Rechenzentren weiter.  Endbenutzer werden nichts bemerken. <br><br>  Wenn Sie ein Problem bemerken, k√∂nnen Sie sofort den vorherigen Wert des Flags zur√ºckgeben, und die √Ñnderungen werden r√ºckg√§ngig gemacht. <br><br>  Dieser Service hat seine Nachteile: Die Entwickler lieben ihn sehr und versuchen oft, alle √Ñnderungen in den Stop Crane zu √ºbertragen.  Wir versuchen, Missbrauch zu bek√§mpfen. <br><br>  Der Stop-Crane-Ansatz funktioniert gut, wenn Sie bereits √ºber einen stabilen Code verf√ºgen, der f√ºr die Einf√ºhrung in der Produktion bereit ist.  Gleichzeitig haben Sie immer noch Zweifel und m√∂chten den Code unter "Kampfbedingungen" √ºberpr√ºfen. <br><br>  Der Absperrhahn ist jedoch nicht zum Testen w√§hrend der Entwicklung geeignet.  F√ºr Entwickler gibt es einen separaten Cluster namens ‚ÄûSchattencluster‚Äú. <br><br><h2>  Verdeckte Pr√ºfung: Schattenhaufen </h2><br>  Anforderungen von einem der Cluster werden in den Schattencluster dupliziert.  Der Balancer ignoriert jedoch die Antworten dieses Clusters vollst√§ndig.  Das Schema seiner Arbeit ist unten dargestellt. <br><br><img src="https://habrastorage.org/webt/ie/xt/dp/iextdpgmvcam7ehqatcbwdjyjxe.jpeg"><br><br>  Wir erhalten einen Testcluster, der sich unter realen ‚ÄûKampfbedingungen‚Äú befindet.  Dort fliegt normaler Nutzerverkehr.  Die Hardware in beiden Clustern ist identisch, sodass Sie Leistung und Fehler vergleichen k√∂nnen. <br><br>  Und da der Balancer die Antworten vollst√§ndig ignoriert, werden den Endbenutzern die Antworten des Schattenclusters nicht angezeigt.  Daher ist es nicht be√§ngstigend, einen Fehler zu machen. <br><br><h2>  Schlussfolgerungen </h2><br>  Wie haben wir eine Marktsuche aufgebaut? <br><br>  Damit alles reibungslos funktioniert, teilen wir die Funktionalit√§t in separate Services.  Sie k√∂nnen also nur die Komponenten skalieren, die wir ben√∂tigen, und die Komponenten einfacher gestalten.  Es ist einfach, einem anderen Team eine separate Komponente zuzuweisen und die Verantwortung f√ºr die Arbeit daran zu teilen.  Eine signifikante Einsparung von Eisen bei diesem Ansatz ist ein offensichtliches Plus. <br><br>  Der Schattencluster hilft uns auch: Sie k√∂nnen Dienste entwickeln, sie im Prozess testen und gleichzeitig den Benutzer nicht st√∂ren. <br><br>  Na und nat√ºrlich in der Produktion einchecken.  M√ºssen Sie die Konfiguration auf tausend Servern √§ndern?  Einfach einen Stoppkran benutzen.  So k√∂nnen Sie sofort eine vorgefertigte komplexe L√∂sung bereitstellen und bei Problemen auf eine stabile Version zur√ºcksetzen. <br><br>  Ich hoffe, ich konnte zeigen, wie wir den Markt mit einer stetig wachsenden Angebotsbasis schnell und stabil machen.  Wie Sie Serverprobleme l√∂sen, eine Vielzahl von Anfragen bearbeiten, die Service-Flexibilit√§t verbessern und dies tun, ohne die Arbeitsprozesse zu unterbrechen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de475848/">https://habr.com/ru/post/de475848/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de475834/index.html">Scrum wird dir nicht helfen. Wir verstehen warum</a></li>
<li><a href="../de475836/index.html">Interview mit Arthur Khachuyan: Wie berechnet man einen Milliard√§r in sozialen Netzwerken?</a></li>
<li><a href="../de475838/index.html">Menschen ver√§ndern. Oder ... Menschen ver√§ndern. Informationen zum ‚ÄûAbheben‚Äú des Transformationsprojekts</a></li>
<li><a href="../de475840/index.html">Badoo Jira API Client: Magie in Jira in PHP</a></li>
<li><a href="../de475842/index.html">Aktions-URL & URI in SIP-Telefonen ersetzen oder √ºber Websockets verwalten?</a></li>
<li><a href="../de475850/index.html">So starten Sie eine Karriere in der IT, wenn Sie noch keine Erfahrung haben</a></li>
<li><a href="../de475854/index.html">JDBC-Pools und effizientes File-Handling: Java mitap 3. Dezember in St. Petersburg</a></li>
<li><a href="../de475856/index.html">Google App Script, Mikrotik, Telegram und VPNBook haben begonnen, ein Quartett zu spielen</a></li>
<li><a href="../de475858/index.html">Unterhaltsame Krypto-Energie: Die Hitze des Bergbaus f√ºr den Menschen und die Hitze des Menschen f√ºr den Bergbau</a></li>
<li><a href="../de475860/index.html">Apache NiFi. 28. November im Deworkacy-H√∂rsaal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>