<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôáüèº üßñüèº üêµ Skript zum Hinzuf√ºgen von Servern aus Google Cloud zur Konfiguration von ssh üçÜ ü§öüèª ‚åöÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anmerkung. Ein Artikel √ºber ein sehr einfaches Skript, das aus einer Liste von Servern eine Konfiguration f√ºr ssh Linux erstellt. Getestet auf Ubuntu ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Skript zum Hinzuf√ºgen von Servern aus Google Cloud zur Konfiguration von ssh</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484500/"><p>  Anmerkung.  Ein Artikel √ºber ein sehr einfaches Skript, das aus einer Liste von Servern eine Konfiguration f√ºr ssh Linux erstellt.  Getestet auf Ubuntu 18, verwendet Goodle Cloud SDK, Python 2.7, Bash. </p><br><p>  Nach einem starken Anstieg der Anzahl der Server, mit denen ich arbeiten muss, wurde mir klar, dass der Kennwortspeicher und die CMDB keinen solchen operativen Zugriff mehr bieten, wie damals, als ich mir alle IP-Adressen und Details auswendig erinnerte.  Vielleicht weil wir CMDB noch nicht gemeistert haben.  Trotzdem ist es irgendwie notwendig, das Problem des schnellen SSH-Zugriffs auf eine gro√üe Anzahl von Servern zu l√∂sen. </p><br><p>  Weiter - aus der Sicht des Linux-Terminals (unter Ubuntu 18 ausgef√ºhrt).  Vielleicht funktioniert es in anderen Distributionen und wahrscheinlich gibt es sogar ein Analogon unter Windows - ich habe nicht gesucht. </p><br><p>  Die Hauptanforderungen: </p><br><ul><li>  Einfach zu wiederholen.  Mehrere Administratoren <br>  und Sie m√ºssen die M√∂glichkeit haben, dasselbe f√ºr alle zu konfigurieren.  Dar√ºber hinaus erm√∂glichen wir Remote-Arbeit - zumindest hat jeder Laptop eine Situation, aber es kommt vor, dass Sie nicht an Ihrem gewohnten ‚Äûlang getunten und debuggten‚Äú Computer arbeiten. </li><li>  Server werden hinzugef√ºgt, gel√∂scht, Adressen ge√§ndert.  Dies sollte ber√ºcksichtigt werden. </li></ul><br><p> Zu diesem Zweck entschied ich mich, Alias-Hosts in den SSH-Einstellungen zu verwenden, die Liste der Server √ºber den GCP-Client von gcloud cli abzurufen und dies alles mit Python 2.7 zu automatisieren (da dies in Ubuntu standardm√§√üig der Fall war und ich mich entschied, es zu studieren, um mit Daten zu arbeiten).  Das Skript selbst mit einer Beschreibung unter dem Schnitt. </p><a name="habracut"></a><br><h1 id="postanovka-zadachi">  Erkl√§rung des Problems </h1><br><p>  Die Idee war, eine Liste der Kommunikations-Alias-Server und ihrer aktuellen Adressen so zu f√ºhren, dass nur ein Name f√ºr den Verbindungsaufbau verwendet werden kann.  Gleichzeitig wird die Liste selbst regelm√§√üig von GCP per API aktualisiert. </p><br><p>  Infolgedessen gab es mehrere Aufgaben: </p><br><ol><li>  Stellen Sie eine Verbindung zum Host her, indem Sie nur einen einpr√§gsamen Namen eingeben (normalerweise werden die Namen nach strengen Regeln gebildet, sodass es ausreicht, den Client und das System zu kennen, um den Servernamen mit ziemlicher Sicherheit zu erraten).  Namen k√∂nnen real (wenn der Server vollst√§ndig von uns erstellt wurde) oder alias in unserer Cmdb sein (wenn der Server vom Client erstellt wurde und der Name gem√§√ü den Clientregeln zugewiesen wurde).  In jedem Fall ist es einfacher, sich einen Namen als eine Adresse zu merken.  Die Adresse √§ndert sich ebenfalls. </li><li>  Eine Liste der aktuellen Hosts mit g√ºltigen Adressen abrufen.  Weil  Die Hauptplattform ist GCP, und 90% der Server sind dort. Dieses Problem wird dann durch die API und nicht durch √úberwachungstools gel√∂st. </li><li>  Suche nach Hostnamen.  Obwohl sie leichter zu merken sind, w√§chst die Anzahl und der Speicher ist nicht unbegrenzt :) Ja, und neue Administratoren sind einfacher. </li><li>  Aktualisieren Sie die Alias-Paketadresse nur, wenn sich die Adresse √§ndert.  Dies ist erforderlich, um das vollst√§ndige Umschreiben aller Bundles aufzugeben.  Dies erm√∂glicht die Speicherung von Bundles nicht nur f√ºr GCP-Server.  Bisher wurde dieses Problem nicht gel√∂st :( </li></ol><br><h1 id="opisanie-resheniya">  L√∂sungsbeschreibung </h1><br><h2 id="alias-dlya-podklyucheniya">  Alias ‚Äã‚Äãzum Verbinden </h2><br><p>  Alles hier ist ganz einfach und nicht von mir entschieden.  Das Linux-Dienstprogramm ssh unterst√ºtzt die Alias-Konfiguration in der Konfigurationsdatei. </p><br><p>  Dateispeicherort: ~ / .ssh / config </p><br><p>  Das von uns verwendete Dateiformat ist sehr banal, aber tats√§chlich sind die M√∂glichkeiten dort viel breiter: </p><br><pre><code class="plaintext hljs">HOST alias_ HostName ip__-</code> </pre> <br><p>  Weitere Informationen zu den Konfigurationsoptionen finden Sie <a href="https://linuxize.com/post/using-the-ssh-config-file/" rel="nofollow">hier</a> , <a href="https://www.cyberciti.biz/faq/create-ssh-config-file-on-linux-unix/" rel="nofollow">hier</a> oder in der <a href="https://www.ssh.com/ssh/config" rel="nofollow">offiziellen Dokumentation</a> . </p><br><h3 id="dalneyshie-shagi">  Weitere Schritte </h3><br><ol><li>  Verwenden Sie verschiedene Schl√ºssel, um eine Verbindung zu verschiedenen Hostgruppen herzustellen.  Eine kleine Paranoia in Sachen Sicherheit wird nicht schaden. </li><li>  Erstellen Sie eine Sicherungskopie dieser Datei, um sich vor versehentlichen √Ñnderungen zu sch√ºtzen und Skriptfehler zu aktualisieren. </li></ol><br><h2 id="poisk-po-imenam-hostov">  Suchen Sie nach Hostnamen </h2><br><p>  Hier liegt die Entscheidung gar nicht bei mir, sondern bei <a href="https://ben.lobaugh.net/" rel="nofollow">Ben Lobaugh</a> und ist <a href="https://ben.lobaugh.net/blog/203195/quickly-list-all-hosts-in-your-ssh-config" rel="nofollow">in seinem Artikel beschrieben</a> . <br>  Kurz gesagt, ich habe sed verwendet, das zum leichteren Starten (eine sehr lange Regel in den Parametern) mit alias abgek√ºrzt wurde: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">alias</span></span> sshhosts=<span class="hljs-string"><span class="hljs-string">"sed -rn 's/^\s*HOST\s+(.*)\s*/\1/ip' ~/.ssh/config"</span></span></code> </pre> <br><p>  Wenn Sie den Host nach dem Namensteil suchen m√ºssen, wird dieses Skript durch das Dienstprogramm grep perfekt erg√§nzt, und als Ergebnis sieht es folgenderma√üen aus: </p><br><pre> <code class="bash hljs">sshhost | grep <span class="hljs-string"><span class="hljs-string">'---'</span></span></code> </pre> <br><p>  Es gibt zum Beispiel andere M√∂glichkeiten, wie <a href="https://www.jamesridgway.co.uk/blog/list-ssh-hosts-from-your-ssh-config" rel="nofollow">hier</a> beschrieben. </p><br><h3 id="avtozapolnenie-imeni-hosta">  Hostname wird automatisch vervollst√§ndigt </h3><br><p>  <strong>Danke f√ºr die L√∂sung <a href="https://habr.com/ru/users/onix74/" class="user_link">onix74</a> !</strong> <br>  F√ºgen Sie die Zeile zu ~ / .bash_completion hinzu: </p><br><pre> <code class="bash hljs">complete -W <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(grep "^HOST " ~/.ssh/config | grep -v "\*" | sed 's/[^ ]* *\(.*\)/\1/')</span></span></span><span class="hljs-string">"</span></span> ssh</code> </pre> <br><p>  F√ºr den Befehl ssh funktioniert die automatische Vervollst√§ndigung gem√§√ü der Liste der Alias-Server.  Das hei√üt  Sie k√∂nnen ssh verwenden, um den Namen des ssh-Servers zu ersetzen.  Es funktioniert in Bash. <br></p><h3 id="dalneyshie-shagi-1">  Weitere Schritte </h3><br><p>  Ich plane, die Hosts in Gruppen zu unterteilen, damit Sie alle Server eines bestimmten Clients oder einer bestimmten Anwendung ausw√§hlen k√∂nnen.  Es scheint, dass diese Funktion f√ºr die Ausf√ºhrung von Massenskripten und Ansible-Verbindungen interessant sein wird.  sowie verschiedene Verbindungsdetails f√ºr verschiedene Gruppen zu erstellen.  Aber wie viel Sinn es wirklich macht, bleibt abzuwarten. </p><br><h2 id="poluchit-spisok-hostov-iz-gcp">  Eine Liste der Hosts erhalten Sie von GCP </h2><br><p>  In diesem Schritt ist bis auf die Parametereinstellungen alles ganz einfach (obwohl es hier um Erfahrung geht).  Ich habe mich f√ºr das GCloud SDK entschieden, um Daten abzurufen, weil  Ich benutze es zwar selten, aber ich nehme an, dass dies mir irgendwann erlauben wird, die grafische Oberfl√§che immer weniger zu nutzen und die Administrationsroutine erheblich zu vereinfachen.  Das Hauptargument ist daher, Erfahrung zu sammeln. <br>  Dies k√∂nnte wahrscheinlich auch mit curl und der GCP-REST-API geschehen, und dann w√§re die L√∂sung universeller (da die GCloud-SDKs eine separate Installation und Initialisierung erfordern, die nicht so kompliziert sind, aber dennoch erforderlich sind). </p><br><p>  Um die notwendigen Informationen zu erhalten, musste ich das json-Format verwenden.  Obwohl dies die weitere Verarbeitung der empfangenen Antwort stark vereinfacht hat, wurde ein wenig √ºber das Festlegen von Formatierungsparametern im SDK nachgedacht. <br>  Als Ergebnis erhielt ich den folgenden Befehl: </p><br><pre> <code class="bash hljs">gcloud compute instances list --filter=<span class="hljs-string"><span class="hljs-string">"status:running"</span></span> --format=<span class="hljs-string"><span class="hljs-string">"json(name, status, networkInterfaces[].accessConfigs[])"</span></span></code> </pre> <br><p>  Es werden nur derzeit aktive Server mit Informationen zu ihrem Namen und ihrer Netzwerkschnittstelle zur√ºckgegeben (es macht keinen Sinn, eine Verbindung zu den anderen Servern herzustellen).  Bisher wird f√ºr jeden Server nur eine externe Schnittstelle verwendet. </p><br><p>  Das Endergebnis kommt in json an: </p><br><pre> <code class="json hljs">[ ---...---- { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"-"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"networkInterfaces"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"accessConfigs"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"compute#accessConfig"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"External NAT"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"natIP"</span></span>: <span class="hljs-string"><span class="hljs-string">"ip-"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"networkTier"</span></span>: <span class="hljs-string"><span class="hljs-string">"PREMIUM"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ONE_TO_ONE_NAT"</span></span> } ] } ], <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUNNING"</span></span> }, ----...--- ]</code> </pre> <br><h3 id="dalneyshie-shagi-2">  Weitere Schritte </h3><br><p>  Suchen Sie ein Format, dessen Ausgabe die nachfolgende Verarbeitung minimiert oder sogar eliminiert. </p><br><h2 id="skript-sozdaniya-spiska-alias-po-dannym-iz-gcp">  Skript zum Erstellen einer Aliasliste basierend auf Daten von GCP </h2><br><p>  Das Skript wurde aus zwei Gr√ºnden in Python 2.7 geschrieben: </p><br><ol><li>  Ich beschloss, es zu studieren, um mit Daten zu arbeiten. </li><li>  Python 2.7 ist standardm√§√üig auf den meisten Linux-Systemen installiert - es wird keine Probleme geben, es an anderer Stelle zu verwenden.  Angesichts dessen, dass Sie jetzt sogar gewinnen k√∂nnen, k√∂nnen Sie ein zweites System einsetzen und Ubuntu als Terminal verwenden. </li></ol><br><p>  Der Algorithmus lautet wie folgt: </p><br><ol><li>  Die Liste der Server wird mithilfe des SDK aus der Google Cloud abgerufen, wodurch die Ausf√ºhrung des Befehls in der Konsole von Python aus initiiert wird. </li><li>  Wir analysieren den resultierenden JSON in pythonfreundliche Typen. </li><li>  Wir geben die Ausgabe in dem Format an, das f√ºr die Einstellung von ssh erforderlich ist (bei Bedarf wird die Skriptausgabe an ~ / .ssh / config oder eine Zwischendatei umgeleitet). </li></ol><br><div class="spoiler">  <b class="spoiler_title">Skript anzeigen</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python import commands import json sComputeListOutput = commands.getoutput('gcloud compute instances list --filter="status:running" --format="json(name, status, networkInterfaces[].accessConfigs[])" ') s = json.loads(sComputeListOutput) for server in s: print 'HOST ',server['name'] print ' HostName ',server['networkInterfaces'][0]['accessConfigs'][0]['natIP']</span></span></code> </pre> </div></div><br><h2 id="obnovlenie-tolko-izmenennyh-dannyh">  Aktualisieren nur ge√§nderter Daten </h2><br><p>  Diese Aufgabe ist noch in Bearbeitung.  Ich plane, die ssh / config-Datei im selben Skript zu lesen, sie mit den empfangenen Werten zu vergleichen und dann das gesamte Ergebnis zur√ºckzuschreiben.  Oder generieren Sie eine neue Datei separat und f√ºhren Sie einen Vergleich mit einer Art Diff durch. Auf diese Weise k√∂nnen Sie alle √Ñnderungen manuell best√§tigen. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de484500/">https://habr.com/ru/post/de484500/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de484486/index.html">Ein Computer, der sich weigert zu sterben</a></li>
<li><a href="../de484488/index.html">Wie verwirrend ist ein Quantensystem? Die Antwort ist m√∂glicherweise nicht berechenbar.</a></li>
<li><a href="../de484492/index.html">PHP-Klasse zum Herunterladen und Hochladen von Dateien auf den Server</a></li>
<li><a href="../de484496/index.html">Verwendung von Cura auf einem Photon 3D SLA-Drucker</a></li>
<li><a href="../de484498/index.html">KI-System warnt Fu√üg√§nger im Kopfh√∂rer vor einem herannahenden Auto</a></li>
<li><a href="../de484502/index.html">Facebook zwingt die Moderatoren, sekundengenau ihre Arbeitszeiten zu dokumentieren - sogar auf die Toilette zu gehen</a></li>
<li><a href="../de484504/index.html">Herstellung eines Luftionisators f√ºr weniger als 10 US-Dollar</a></li>
<li><a href="../de484506/index.html">Ich bin Fotograf und werde mich selbst zum Arbeitsger√§t machen</a></li>
<li><a href="../de484512/index.html">TOP 25 der gr√∂√üten ICOs: Was ist jetzt mit ihnen los?</a></li>
<li><a href="../de484514/index.html">Universelles Routing f√ºr reaktive Anwendungen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>