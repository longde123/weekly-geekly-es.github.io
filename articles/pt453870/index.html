<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï§ ü•ä ü•ù Escrevemos o proxy reverso socks5 no PowerShell. üë©üèº‚Äçüç≥ üé© ü§πüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A hist√≥ria da pesquisa e desenvolvimento em 3 partes. Parte 1 - pesquisa. 
 Existem muitas faias - ainda mais benef√≠cios. 

 Declara√ß√£o do problema 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escrevemos o proxy reverso socks5 no PowerShell.</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453870/">  A hist√≥ria da pesquisa e desenvolvimento em 3 partes.  Parte 1 - pesquisa. <br>  Existem muitas faias - ainda mais benef√≠cios. <br><br><h3>  Declara√ß√£o do problema </h3><br>  Durante a realiza√ß√£o de campanhas de protestos e RedTeam, nem sempre √© poss√≠vel usar os meios regulares dos clientes, como VPN, RDP, Citrix, etc.  como uma corre√ß√£o para entrar na rede interna.  Em algum lugar, uma VPN normal funciona de acordo com o MFA e um token de ferro √© usado como segundo fator; em algum lugar √© monitorado severamente e nossa entrada na VPN se torna imediatamente vis√≠vel, como se costuma dizer - com todas as consequ√™ncias, mas em algum lugar simplesmente n√£o existe esse meio. <br><br>  Nesses casos, constantemente √© necess√°rio fazer os chamados "t√∫neis reversos" - conex√µes da rede interna a um recurso externo ou ao servidor que controlamos.  Dentro desse t√∫nel, j√° podemos trabalhar com os recursos internos dos clientes. <br><br>  Existem v√°rias variedades desses t√∫neis reversos.  O mais famoso deles, √© claro, √© o Meterpreter.  Os t√∫neis SSH com encaminhamento de porta reversa tamb√©m est√£o em grande demanda entre as massas hackers.  Existem muitas ferramentas de encapsulamento reverso e muitas delas s√£o bem estudadas e descritas. <br><br>  Naturalmente, por sua vez, os desenvolvedores de solu√ß√µes de prote√ß√£o n√£o permanecem e detectam ativamente tais a√ß√µes. <br><br>  Por exemplo, as sess√µes de MSF s√£o detectadas com √™xito pelo IPS moderno da Cisco ou da Positive Tech, e o t√∫nel SSH reverso pode ser detectado por quase qualquer firewall mais ou menos normal. <br><br>  Portanto, para passar despercebido em uma boa campanha RedTeam, precisamos construir um t√∫nel reverso com meios n√£o padronizados e nos adaptar o mais pr√≥ximo poss√≠vel ao modo real da rede. <br><br>  Vamos tentar encontrar ou inventar algo semelhante. <br><a name="habracut"></a><br>  Antes de inventar algo, voc√™ precisa entender qual resultado queremos alcan√ßar, quais fun√ß√µes nosso desenvolvimento deve executar.  Quais ser√£o os requisitos para o t√∫nel para que possamos trabalhar no modo furtivo m√°ximo? <br><br>  √â claro que, para cada caso, esses requisitos podem diferir bastante, mas da experi√™ncia podemos distinguir os principais: <br><br><ul><li>  trabalhar no sistema operacional Windows-7-10.  Como a maioria das redes corporativas usa o Windows; </li><li>  o cliente se conecta ao servidor via SSL para evitar escutas est√∫pidas usando ips; </li><li>  ao conectar, o cliente deve suportar a opera√ß√£o atrav√©s de um servidor proxy com autoriza√ß√£o, conforme  Muitas empresas acessam a Internet atrav√©s de um proxy.  De fato, a m√°quina cliente pode nem saber nada sobre ela, e o proxy √© usado em um modo transparente.  Mas devemos colocar essa funcionalidade; </li><li>  a parte do cliente deve ser concisa e port√°til; <br>  √â claro que, para trabalhar dentro da rede do Cliente na m√°quina do cliente, voc√™ pode instalar o OpenVPN e criar um t√∫nel completo para o seu servidor (j√° que os clientes openvpn podem trabalhar com proxies).  Mas, em primeiro lugar, isso nem sempre funciona, j√° que talvez n√£o sejamos administradores locais e, em segundo lugar, far√° tanto barulho que um SIEM ou HIPS decente imediatamente nos "bater√°".  Idealmente, nosso cliente deve ser o chamado comando embutido, por exemplo, muitos shells bash s√£o implementados e executados na linha de comando, por exemplo, ao executar comandos a partir de uma macro de palavras. </li><li>  nosso t√∫nel deve ser multithread e suportar muitas conex√µes ao mesmo tempo; </li><li>  A conex√£o cliente-servidor deve ter algum tipo de autoriza√ß√£o para que o t√∫nel seja estabelecido apenas para nosso cliente, e n√£o para todos que acessam nosso servidor no endere√ßo e porta especificados.  Idealmente, para "usu√°rios de terceiros", uma p√°gina de destino com selos ou t√≥picos profissionais relacionados ao dom√≠nio de origem deve ser aberta. <br>  Por exemplo, se o Cliente for uma organiza√ß√£o m√©dica, dever√° abrir o administrador de seguran√ßa da informa√ß√£o que decidiu verificar o recurso usado pelo funcion√°rio da cl√≠nica, uma p√°gina com produtos farmac√™uticos, uma wiki com uma descri√ß√£o do diagn√≥stico ou um blog do Dr. Komarovsky, etc. </li></ul><br><h3>  An√°lise de ferramentas existentes </h3><br>  Antes de inventar sua bicicleta, voc√™ precisa analisar as bicicletas existentes e entender se realmente precisamos dela e, provavelmente, n√£o apenas pensamos na necessidade de uma bicicleta t√£o funcional. <br><br>  Pesquisando na Internet (parece que estamos bem com o google), al√©m de pesquisar no github as palavras-chave ‚Äúmeias reversas‚Äù, n√£o deu muitos resultados.  Basicamente, tudo se resume √† constru√ß√£o de t√∫neis ssh com encaminhamento de porta reversa e tudo relacionado a ele.  Al√©m dos t√∫neis SSH, v√°rias solu√ß√µes podem ser distinguidas: <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/klsecservices/rpivot</a></b> <br>  Uma implementa√ß√£o de longa data do t√∫nel reverso dos caras da Kaspersky Lab.  Pelo nome, fica claro para que serve esse script.  Implementado no Python 2.7, o t√∫nel √© executado no modo de texto n√£o criptografado (como est√° na moda dizer agora - ol√° para ILV) <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/tonyseek/rsocks</a></b> <br>  Outra implementa√ß√£o python tamb√©m est√° em texto n√£o criptografado, mas h√° mais op√ß√µes.  Ele √© escrito como um m√≥dulo e existe uma API para integrar a solu√ß√£o em seus projetos. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/llkat/rsockstun</a></b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/mis-team/rsockstun</a></b> <br>  O primeiro link √© a vers√£o inicial da implementa√ß√£o do Sox reverso no Golang (n√£o suportado pelo desenvolvedor). <br><br>  O segundo link j√° √© nossa revis√£o com fichas adicionais, tamb√©m no golang.  Em nossa vers√£o, implementamos SSL, trabalhamos atrav√©s de um proxy com autoriza√ß√£o NTLM, autoriza√ß√£o de cliente, uma p√°gina de destino com uma senha incorreta (ou melhor, um redirecionamento para uma p√°gina de destino), modo multiencadeado (ou seja, v√°rias pessoas podem trabalhar com o t√∫nel ao mesmo tempo) , um sistema de ping do cliente, esteja ativo ou n√£o. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/jun7th/tsocks</a></b> <br>  Implementa√ß√£o reversa do Sox de nossos "amigos chineses" em python.  L√°, para os pregui√ßosos e os "imortais", jaz o bin√°rio pronto (exe), montado pelos chineses e pronto para uso.  Aqui, apenas o deus chin√™s sabe que pode haver mais do que a principal funcionalidade deste bin√°rio, portanto, use-o por sua pr√≥pria conta e risco. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github.com/securesocketfunneling/ssf</a></b> <br>  Um projeto C ++ bastante interessante para implementar meias reversas e muito mais.  Al√©m do t√∫nel reverso, ele pode encaminhar portas, criar um shell de comando etc. <br><br>  <b>Msf meterpreter</b> <br>  Aqui, como se costuma dizer, sem coment√°rios.  Todos os hackers mais ou menos instru√≠dos est√£o muito familiarizados com essa coisa e compreendem com que facilidade ela pode ser detectada por equipamentos de prote√ß√£o. <br><br>  Todas as ferramentas acima funcionam em uma tecnologia semelhante: em uma m√°quina dentro da rede, √© lan√ßado um m√≥dulo bin√°rio execut√°vel pr√©-preparado, que estabelece uma conex√£o com um servidor externo.  O servidor inicia o servidor SOCKS4 / 5, que aceita conex√µes e as converte no cliente. <br><br>  A desvantagem de todas as ferramentas acima √© que o Python ou Golang √© necess√°rio na m√°quina cliente (voc√™ costumava ver o Python instalado em m√°quinas, por exemplo, diretores de empresas ou trabalhadores de escrit√≥rio?) Ou precisa arrastar um bin√°rio pr√©-montado para essa m√°quina (na verdade, python e o script em uma garrafa) e execute este bin√°rio j√° l√°.  E o download do exe com o lan√ßamento subsequente tamb√©m √© a assinatura de um antiv√≠rus ou HIPS local. <br><br>  Em geral, a conclus√£o se sugere - precisamos de uma solu√ß√£o no PowerShell.  Agora, os tomates voam at√© n√≥s - dizem powershell - est√£o surrados, est√£o sendo monitorados, bloqueados etc.  etc.  De fato - n√£o em todo lugar.  Declaramos com responsabilidade.  A prop√≥sito, existem v√°rias maneiras de ignorar os bloqueios (aqui novamente a frase da moda sobre ol√° para ILV :)), come√ßando com a renomea√ß√£o est√∫pida de powershell.exe -&gt; cmdd.exe e terminando com powerdll, etc. <br><br><h3>  Comece a inventar </h3><br>  √â claro que primeiro procuraremos no Google e ... n√£o encontraremos nada sobre esse t√≥pico (se algu√©m tiver encontrado, gere links para coment√°rios).  Existe apenas uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">implementa√ß√£o do</a> Socks5 no PowerShell, mas esse √© o Sox "direto" usual, que tem v√°rias desvantagens (falaremos sobre isso mais tarde).  √â claro que voc√™ pode transform√°-lo ao contr√°rio com um movimento do pulso, mas ser√° apenas um sox de rosca √∫nica, que n√£o √© exatamente o que precisamos para n√≥s. <br><br>  Ent√£o, n√£o encontramos nada pronto, ent√£o ainda temos que inventar nossa bicicleta.  Como base da nossa bicicleta, adotamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o desenvolvimento de</a> meias reversas no golang e implementamos o cliente no PowerShell. <br><br>  <b>RSocksTun</b> <br><br>  Ent√£o, como o rsockstun funciona? <br><br>  No cora√ß√£o do trabalho do RsocksTun (daqui em diante referido como rs) est√£o dois componentes de software - o servidor Yamux e o Socks5.  O servidor Socks5 √© um socks5 local regular, √© executado no cliente.  E a multiplexa√ß√£o de conex√µes com ele (lembra-se do multithreading?) √â fornecida usando o yamux ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais um multiplexador</a> ).  Esse esquema permite executar v√°rios servidores de meias5 do cliente e distribuir conex√µes externas a eles, encaminhando-os atrav√©s de uma √∫nica conex√£o TCP (quase como no medidor) do cliente para o servidor, realizando o modo multithread, sem o qual simplesmente n√£o podemos trabalhar totalmente no ambiente interno. rede. <br><br>  A ess√™ncia do yamux √© que ele introduz um n√≠vel de rede adicional de fluxos, realizando-o como um cabe√ßalho de 12 bytes para cada pacote.  (Aqui, intencionalmente, usamos a palavra "fluxo", n√£o um fluxo, para n√£o confundir o leitor com o thread do programa "thread" - este conceito tamb√©m usaremos neste artigo).  Dentro do cabe√ßalho do yamux cont√©m o n√∫mero do fluxo, sinalizadores para definir / finalizar o fluxo, o n√∫mero de bytes transferidos, o tamanho da janela de transfer√™ncia. <br><br><img src="https://habrastorage.org/webt/ga/go/we/gagowe129appe4mb67fwca2rumi.jpeg"><br><br>  Al√©m de instalar / concluir o fluxo, o yamux implementa um mecanismo de manuten√ß√£o de atividade que permite monitorar a integridade do canal de comunica√ß√£o instalado.  O mecanismo de mensagens de manuten√ß√£o √© configurado ao criar uma sess√£o do Yamux.  Na verdade, nas configura√ß√µes, existem apenas dois par√¢metros: ativar / desativar e a frequ√™ncia do envio de pacotes em segundos.  O servidor yamux pode enviar mensagens keepalive, para que o cliente yamux possa.  Ap√≥s o recebimento de uma mensagem keepalive, a parte remota √© obrigada a responder enviando exatamente o mesmo identificador de mensagem (na verdade, um n√∫mero) que recebeu.  Em geral, keepalive √© o mesmo ping, apenas para o yamux. <br><br>  Toda a t√©cnica de opera√ß√£o do multiplexador √© detalhada: tipos de pacotes, sinalizadores de instala√ß√£o e finaliza√ß√£o, mecanismo de transfer√™ncia de dados descrito na <a href="">especifica√ß√£o</a> yamux. <br><br><h3>  Conclus√£o para a primeira parte </h3><br>  Assim, na primeira parte do artigo, nos familiarizamos com algumas ferramentas para organizar t√∫neis reversos, analisamos suas vantagens e desvantagens, estudamos o mecanismo de opera√ß√£o do multiplexador Yamux e descrevemos os requisitos b√°sicos para o m√≥dulo PowerShell rec√©m-criado.  Na pr√≥xima parte, desenvolveremos o pr√≥prio m√≥dulo, praticamente do zero.  Para ser continuado.  N√£o mude :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453870/">https://habr.com/ru/post/pt453870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453860/index.html">AMD apresentou seus novos processadores personalizados de 7 nm Ryzen terceira gera√ß√£o</a></li>
<li><a href="../pt453862/index.html">Por que voc√™ deve usar o pathlib</a></li>
<li><a href="../pt453864/index.html">Usar um mouse e teclado em consoles √© trapa√ßa?</a></li>
<li><a href="../pt453866/index.html">Solicita√ß√£o de API com ganchos de rea√ß√£o, HOC ou prop de renderiza√ß√£o</a></li>
<li><a href="../pt453868/index.html">Mini interruptor sens√≠vel ao toque com painel de vidro no nRF52832</a></li>
<li><a href="../pt453872/index.html">Restaurando fotos usando redes neurais</a></li>
<li><a href="../pt453874/index.html">Da roleta russa ao LOTO seguro: como proteger o pessoal do data center</a></li>
<li><a href="../pt453876/index.html">Como no Yandex.Practicum, o front-end desync venceu: um n√∫mero acrob√°tico com Redux-Saga, postMessage e Jupyter</a></li>
<li><a href="../pt453882/index.html">Um √≥timo guia sobre a profiss√£o de arquiteto de solu√ß√µes (+ lista de links √∫teis)</a></li>
<li><a href="../pt453884/index.html">Substitui√ß√£o da c√¢mera HYIP ou DSLR?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>