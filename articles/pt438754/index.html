<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÄ ü§∂ ü§û Como fizemos o monitoramento de rede para 14.000 objetos üîà üïµüèΩ üîΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="T√≠nhamos 14.000 objetos, zabbix, api, python e uma relut√¢ncia em adicionar objetos manualmente. Sob o corte - sobre como os gerentes de rede implement...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como fizemos o monitoramento de rede para 14.000 objetos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/438754/">  T√≠nhamos 14.000 objetos, zabbix, api, python e uma relut√¢ncia em adicionar objetos manualmente.  Sob o corte - sobre como os gerentes de rede implementaram o monitoramento com a adi√ß√£o autom√°tica de n√≥s da rede e um pouco sobre a dor pela qual eu tive que passar. <br><br>  Este artigo se concentra mais em engenheiros de rede com pouca experi√™ncia em python.  Para ajudar na automa√ß√£o do monitoramento e na melhoria da qualidade de vida e trabalho, na aus√™ncia da necessidade de atualizar manualmente toda a frota de objetos. <br><br><img src="https://habrastorage.org/webt/mw/-u/ev/mw-uevvuik_o6poo21krw2rt0gy.jpeg"><br><a name="habracut"></a><br><h2>  Para encurtar a hist√≥ria, constru√≠mos um monitoramento </h2><br>  Oi  Meu nome √© Alexander Prokhorov e, junto com a equipe de engenheiros de rede de nosso departamento, estamos trabalhando em uma rede no # ITX5.  Nosso departamento desenvolve infraestrutura de rede, monitoramento e automa√ß√£o de rede.  Sim, e tudo relacionado √† transfer√™ncia de dados. <br><br><img src="https://habrastorage.org/webt/g1/mu/mr/g1mumrtfj5tkbmqs52gl05_d2la.png"><br><br>  Eu dividiria o sistema de monitoramento em 5 subtarefas: <br><br><ul><li>  Baixar dados mestre </li><li>  Obtendo informa√ß√µes sobre o estado dos objetos </li><li>  Disparadores e alertas </li><li>  Relat√≥rios </li><li>  Visualiza√ß√£o </li></ul><br>  Neste artigo, gostar√≠amos de compartilhar como fizemos a integra√ß√£o do monitoramento com os dados mestre em nossa empresa. <br><br>  Temos 14.000 propriedades de varejo, e a primeira tarefa que resolvemos foi a determina√ß√£o de objetos inacess√≠veis, seu n√∫mero e distribui√ß√£o geogr√°fica. <br><br>  O monitoramento foi feito no <b><font color="#cc0000">Zabbix</font></b> .  Em poucas palavras, por que - sorte e legado.  O resto: <br><br><div class="spoiler">  <b class="spoiler_title">Longa hist√≥ria.</b> <div class="spoiler_text"> Tudo come√ßou com a instala√ß√£o do monitoramento em um computador sob a mesa ... <br><br>  Quando cheguei ao trabalho da empresa em 2013, n√£o t√≠nhamos monitoramento de rede, embora a rede, na √©poca, era grande, cerca de 4000 objetos.  Aprendemos sobre quedas maci√ßas (e n√£o muito) com maior frequ√™ncia com o recebimento de aplicativos, usu√°rios ou outros departamentos, semelhantes a avalanches. <br><br><img src="https://habrastorage.org/webt/ge/6l/du/ge6lduplk0odlklh6iazcjsw6vk.jpeg"><br><br>  O primeiro foi instalado o Zabbix 1.8, como um produto que ganha impulso (moda, moderno, juventude), leve e acess√≠vel para instalar c√≥digo-fonte aberto em uma grande comunidade.  N√≥s tivemos sorte com a escolha. <br><br>  N√£o havia recursos para instala√ß√£o, ningu√©m solicitou.  N√£o estava claro se isso funcionaria; ningu√©m tinha experi√™ncia em implementa√ß√£o.  Mas precis√°vamos e o instalamos no computador "embaixo da mesa".  N√≠vel de redund√¢ncia - UPS. <br><br>  A principal quest√£o ap√≥s a instala√ß√£o √© como despejar todos os objetos (4k!) No monitoramento e, ao mesmo tempo, gerenciar aplicativos que j√° est√£o travados no Remedy.  O Zabbix j√° suportava importa√ß√£o / exporta√ß√£o de xml com dados em hosts.  O n√∫mero de objetos √© grande, n√£o havia sentido em criar um grupo separado para o objeto (e ele n√£o aparecia) e foi decidido fazer o upload do roteador de objetos como um n√≥ de rede.  Mais equipamentos de rede n√£o foram controlados (j√° gerenciados). <br><br>  A an√°lise do nosso arquivo com hosts de rede (IPAM no Excel) foi conclu√≠da e foi reformatada para xml, que o Zabbix concorda em digerir.  N√£o foi a primeira vez, mas todos os hosts foram carregados, a atualiza√ß√£o foi realizada a cada tr√™s meses, removendo os objetos fechados e adicionando novos.  Com o tempo, o Zabbix se tornou a principal e √∫nica fonte de informa√ß√µes para n√≥s e a linha direta sobre a disponibilidade de instala√ß√µes e, mais importante, sobre quedas de massa.  Isso permitiu √† linha direta aprender sobre acidentes de massa mesmo √† noite e despertar os engenheiros com liga√ß√µes (a prop√≥sito, quando ningu√©m sabia disso, era mais f√°cil viver).  Nem sempre as quedas de energia noturnas no escrit√≥rio permitiam ao no-break manter adequadamente o monitoramento de nossa rede.  Em algum momento, come√ßamos <b>a</b> fazer backups.  Porque  Como o monitoramento era inst√°vel e intermitente, as empresas decidiram organizar um grupo dedicado apenas a essa tarefa.  Logo, ela come√ßou a implementar um Zabbix centralizado, que verifica n√£o apenas a rede. <br><br>  Nosso velho Zabbix continuou a viver debaixo da mesa.  Depois de adicionar um certo n√∫mero de itens, o banco de dados come√ßou a ficar um pouco mais lento, a web, a fila e o atraso na pesquisa aumentaram; logo, tive que pegar mais dois computadores como proxy e coloc√°-los todos na cruz, para que a reserva real (e o local embaixo da mesa acabasse) .  A vida √∫til foi suportada para adicionar rapidamente algum tipo de par√¢metro personalizado ao monitoramento e observ√°-lo.  Quanto ao resto, passamos para uma centralizada. <br><br>  O monitoramento centralizado era respons√°vel por todos os equipamentos de TI - roteadores, servidores, caixas registradoras, terminais.  Depois de um tempo, ele cresceu com um grande n√∫mero de itens.  Para acessar informa√ß√µes valiosas de acessibilidade, voc√™ precisava esperar um pouco, talvez at√© tomar um caf√©.  Al√©m disso, t√≠nhamos mais e mais requisitos para monitoramento de rede mais espec√≠fico e personalizado.  Tendo naquela √©poca alguma experi√™ncia em trabalhar com o sistema, decidimos fazer a implementa√ß√£o antiga do zero, mas com raz√£o - sob o nome zabbix.noc.x5.ru Ele estava localizado no data center com a implementa√ß√£o das fun√ß√µes necess√°rias por n√≥s mesmos.  Sobre esta introdu√ß√£o e o corpo principal do artigo. <br></div></div><br>  A vers√£o do Zabbix √© 3.0 <abbr title="Suporte a longo prazo">LTS</abbr> .  Atualizado apenas nas vers√µes LTS. <br><br>  Configura√ß√£o - 4 m√°quinas virtuais: Servidor + Banco de Dados, Proxy, Proxy, Web <br><br>  Por recursos, tentamos seguir as recomenda√ß√µes no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">zabbix.com</a> para uma implementa√ß√£o grande e muito grande. <br><br>  O primeiro problema que nos confrontou foi a adi√ß√£o autom√°tica de n√≥s da rede ao monitoramento.  A descoberta regular desapareceu imediatamente.  Nossa gama de redes est√° em todos os espa√ßos abertos da super-rede 10/8.  Muitos endere√ßos precisariam ser pesquisados ‚Äã‚Äãe a descoberta autom√°tica consumiria muitos recursos do sistema, mas n√£o resolveria o problema de adicionar informa√ß√µes n√£o t√©cnicas sobre um objeto. <br><br><img src="https://habrastorage.org/webt/1r/on/nm/1ronnmq5d1dutzqrzwn-3tfypdm.png" align="right" width="240"><h2>  Como adicionar objetos </h2><br>  A solu√ß√£o foi usar scripts externos para adicionar objetos.  Os dados mestre dos objetos comerciais foram encontrados no SAP usado na empresa.  O acesso sincronizado ao <i>servi√ßo da web</i> para o upload de dados diretamente do SAP n√£o saiu, a solicita√ß√£o para todos os objetos levou um bom tempo.  Efetuou uma chamada ass√≠ncrona.  Exatamente √† meia-noite, a exporta√ß√£o completa do SAP √© adicionada ao ftp na forma de <i>XML</i> e, durante o dia, os <i>XMLs</i> com diffs das √∫ltimas vers√µes caem sobre ele. <br><br clear="right">  O Zabbix usou a <b><font color="#cc0000">API</font></b> do <b><font color="#cc0000">Zabbix</font></b> para carregar dados e interagiu com ele a partir do <i>Python</i> . <br><br>  No primeiro est√°gio, o conjunto de dados que precis√°vamos para criar o objeto foi determinado.  Utilizamos todos os sinais obtidos para a classifica√ß√£o correta de um objeto no sistema ou para maior comodidade.  Esses sinais incluem: <br><br><ul><li>  <i>Endere√ßo IP</i> - o campo mais importante para criar uma interface de monitoramento </li><li>  <i>SAP ID</i> - temos um identificador de objeto exclusivo </li><li>  <i>Status</i> - aberto / fechado </li><li>  <i>Nome</i> - o nome ou o n√∫mero do objeto, geralmente usado pelos usu√°rios ao entrar em contato </li><li>  <i>Localiza√ß√£o</i> - endere√ßo f√≠sico </li><li>  <i>Telefone</i> - telefone de contato </li><li>  <i>Grupos</i> - este grupo de grupos √© formado com base no tipo e localiza√ß√£o do objeto </li></ul><br><img src="https://habrastorage.org/webt/hr/hc/29/hrhc29q4zq8axnta-ift3gjpcwm.png"><br><br><h3>  M√≥dulo Sap-sync.py </h3><br><div class="spoiler">  <b class="spoiler_title">XML da SAP</b> <div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">werks</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WERKS</span></span></span><span class="hljs-tag">&gt;</span></span>1234<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">WERKS</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NAME1</span></span></span><span class="hljs-tag">&gt;</span></span>4321-<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NAME1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PLANT_IP</span></span></span><span class="hljs-tag">&gt;</span></span>192.168.1.50<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PLANT_IP</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">REGION</span></span></span><span class="hljs-tag">&gt;</span></span>31<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">REGION</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PSTLZ</span></span></span><span class="hljs-tag">&gt;</span></span>308580<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PSTLZ</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CITY1</span></span></span><span class="hljs-tag">&gt;</span></span>.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CITY1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CITY2</span></span></span><span class="hljs-tag">&gt;</span></span> .<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CITY2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">STREET</span></span></span><span class="hljs-tag">&gt;</span></span> .<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">STREET</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HOUSE_NUM1</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HOUSE_NUM1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TEL_NUMBER</span></span></span><span class="hljs-tag">&gt;</span></span>(999)777-77-77<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TEL_NUMBER</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BRANCH</span></span></span><span class="hljs-tag">&gt;</span></span>CH<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BRANCH</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">REGION</span></span></span><span class="hljs-tag">&gt;</span></span>CH_MSK<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">REGION</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">REGION_NAME</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">REGION_NAME</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FORMAT</span></span></span><span class="hljs-tag">&gt;</span></span>CH_MSK_D<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FORMAT</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">STATUS</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">STATUS</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">werks</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">sap-sync.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 import sys, os, getopt, ipaddress from datetime import datetime as dt from zabbix.api import ZabbixAPI import xml.etree.cElementTree as et from report import report import existhost def ping(ip): if os.system('ping -c 2 -W 1 %s &gt; /dev/null'%ip) == 0: return True else: return False def main(argv): global opath try: opts, args = getopt.getopt(argv,"hp:",["path="]) except getopt.GetoptError: print('sync-sap-chg.py -p &lt;path&gt;') sys.exit(2) for opt, arg in opts: if opt == '-h': print('sync-sap-chg.py -p &lt;path&gt;') sys.exit() elif opt in ("-p", "--path"): opath = arg def asynchronization(file, reportdata): zapi = ZabbixAPI(url='http://z.noc.x5.ru', user='user', password='pwd') #,    left_kidney = '17855' right_kidney = '17856' f_type={'S':'Super','D':'DK','H':'Giper','A':'DK'} format={'D':'13','S':'14','H':'12','A':'13'} region={'CT':'21','UR':'19','SZ':'17',~omit~} try: #  XML tree = et.ElementTree(file=file) root = tree.getroot() for werks in root.iter('werks'): #     Zabbix interfaces=[{ 'main':'1', 'type':'2', 'useip':'1', 'port':'161' }] shop={ 'inventory':{}, 'interfaces':interfaces, 'groups':[], 'templates':[{'templateid':'10194'}], 'inventory_mode':'1' } #,     XML di = { 'WERKS':'', ~omit~, 'STATUS':'Object Opened' } #    for item in werks: di[item.tag] = item.text #  SAPID   if item.tag == 'WERKS': n_proxy = ''.join(filter(lambda x: x.isdigit(), item.text)) # IP    .   /26 try: ipaddress.ip_interface('%s/%s'%(di['PLANT_IP'].strip(),26)) ip_chk = True except: ip_chk = False # ,   IP   if (di['PLANT_IP'] != '1.1.1.1') and ip_chk: #    if di['FORMAT'][-1] in ['D','A','S','H']: shop['inventory']['alias']=di['WERKS'] shop['inventory']['name']=di['NAME1'] shop['inventory']['poc_1_phone_a']=di['TEL_NUMBER'] shop['inventory']['location']=di['STREET'] #    if (di['FORMAT'][-1] in ['H']): shop['host']=f_type[di['FORMAT'][-1]]+di['WERKS'] shop['interfaces'][0]['ip']=str(ipaddress.ip_interface('%s/%s'%(di['PLANT_IP'].strip(),24)).network[1]) # ID     shop['templates'][0]['templateid']='29529' elif (di['FORMAT'][-1] in ['S']): ~omit~ #For D balance in proxies if int(n_proxy[-1]) % 2 == 0: shop['proxy_hostid'] = right_kidney else: shop['proxy_hostid'] = left_kidney # inventory   IP shop['inventory']['oob_ip']=shop['interfaces'][0]['ip'] #    format  region shop['groups']=[{'groupid':'9'}] shop['groups'].append({'groupid':format[di['FORMAT'][-1]]}) shop['groups'].append({'groupid':region[di['FORMAT'][:2]]}) #   if di['STATUS'] == ' ': shop['status']='0' else: shop['status']='1' #   T = dt.date(dt.now()).strftime("%d %B %Y") shop['inventory']['date_hw_decomm'] = T #      Zabbix hostid = existhost.exist(shop['host']) ip = shop['interfaces'][0]['ip'] #  - ! if hostid == 0 and shop['status'] == '0' and ping(ip): zapi.host.create(shop) reportdata['new'].append(di['WERKS']) #   - ! elif hostid != 0 and di['PLANT_IP'] != '1.1.1.1': #  HOSTID  shop['hostid']=hostid #     shop.pop('interfaces') zapi.host.update(shop) reportdata['update'].append(di['WERKS']) #     os.system('mv %s /mnt/ftp/old_data/'%(file)) except: reportdata['error'].append(di['WERKS']) report('   %s.   :%s'%(file, str(reportdata['error'])), 'SAP Sync Failed!') sys.exit() def checking(path): files = os.listdir(path) files.sort() reportdata ={'new':[], 'update':[], 'error':[]} for file in files: asynchronization(path+file, reportdata) if files != []: report(' %s  ! \n  %s . \n  sap:\n %s. \n  %s . \n  sap:\n %s'%(str(files), len(reportdata['new']), str(reportdata['new']), len(reportdata['update']), str(reportdata['update'])), 'SAP Sync Succeed!') if __name__ == "__main__": main(sys.argv[1:]) checking(opath)</span></span></code> </pre><br></div></div><br>  O principal objetivo deste m√≥dulo √© a an√°lise de <i>XML</i> e a tradu√ß√£o <font color="#008080"><abbr title="Nota√ß√£o de Objeto JavaScript">JSON</abbr></font> para a API do Zabbix.  √â muito conveniente, neste caso, usar dicion√°rios Python, como  n√£o √© necess√°rio format√°-los adicionalmente - usando o m√≥dulo <font color="#008080">zabbix.api</font> , <font color="#008080">voc√™</font> pode simplesmente <font color="#008080">fornecer</font> a ele um dicion√°rio com a estrutura correta.  <i>JSON</i> com a estrutura se parece com isso: <br><br><pre> <code class="json hljs">{ 'host': 'Hostname' 'groups': [...] 'interfaces': [{},{},{}] 'inventory': {} 'templates': [{},{},{}] 'inventory_mode': '<span class="hljs-number"><span class="hljs-number">1</span></span>' 'proxy_hostid': 'INT' 'status': '<span class="hljs-number"><span class="hljs-number">0</span></span>' } [] -  {} - </code> </pre><br>  Em nosso campo com o endere√ßo IP no SAP, o endere√ßo do servidor √© armazenado, n√£o o roteador, mas, usando o m√≥dulo <font color="#008080">ipaddress</font> , consideramos o primeiro endere√ßo de sub-rede, que no nosso caso √© sempre um roteador. <br><br><pre> <code class="python hljs">str(ipaddress.ip_interface(<span class="hljs-string"><span class="hljs-string">'%s/%s'</span></span>%(di[<span class="hljs-string"><span class="hljs-string">'PLANT_IP'</span></span>].strip(),<span class="hljs-number"><span class="hljs-number">24</span></span>)).network[<span class="hljs-number"><span class="hljs-number">1</span></span>])</code> </pre><br>  A data da √∫ltima atualiza√ß√£o bem-sucedida √© registrada no <i>Inventory</i> . Em situa√ß√µes controversas, ajuda a entender a relev√¢ncia das informa√ß√µes no sistema. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   T = dt.date(dt.now()).strftime("%d %B %Y") shop['inventory']['date_hw_decomm'] = T</span></span></code> </pre><br>  Ent√£o √© muito conveniente analisar as estat√≠sticas da data da atualiza√ß√£o nos dados do invent√°rio: <br><br><img src="https://habrastorage.org/webt/ja/7j/kp/ja7jkpml-hjexniqyu-_5e2vrau.png"><br><br>  O campo mais importante - <b>STATUS</b> , <i>"aberto"</i> - √© adicionado e come√ßa a ser monitorado, qualquer outro status - desativa o host.  N√£o exclu√≠mos objetos para preservar dados e estat√≠sticas hist√≥ricos. <br><br>  Ap√≥s os testes, tive que adicionar a fun√ß√£o ping para verificar se o host est√° acess√≠vel antes da adi√ß√£o inicial, porque  na pr√°tica, come√ßaram a aparecer os status <i>"abertos"</i> , que ainda n√£o est√£o totalmente abertos, mas quase. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ping</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ip)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.system(<span class="hljs-string"><span class="hljs-string">'ping -c 2 -W 1 %s &gt; /dev/null'</span></span>%ip) == <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre><br>  Anteriormente, a API do Zabbix tinha uma fun√ß√£o <b><font color="#008080">host.exist</font></b> , mas em novas vers√µes era combinada com <b><font color="#008080">host.get</font></b> .  Se o n√≥ existir, a solicita√ß√£o retornar√° <i>hostid</i> no banco de dados zabbix.  Se n√£o encontrado, retorna 0. Para verifica√ß√£o, agora eu tinha que adicionar <font color="#008080">existhost</font> , mas na verdade √© <b><font color="#008080">host.get</font></b> . <br><br><div class="spoiler">  <b class="spoiler_title">existhost.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 import sys, getopt from zabbix.api import ZabbixAPI def main(argv): global aname try: opts, args = getopt.getopt(argv,"hn:",["name="]) except getopt.GetoptError: print('existhost.py -n &lt;name&gt;') sys.exit(2) for opt, arg in opts: if opt == '-h': print('existhost.py -n &lt;name&gt;') sys.exit() elif opt in ("-n", "--name"): aname = arg def exist(name): zapi = ZabbixAPI(url='http://z.noc.x5.ru/', user='user', password='pwd') hostget = zapi.host.get(search={'name':'%s'%name}, output='hostid') if hostget == []: return 0 else: return int(hostget[0]['hostid']) if __name__ == "__main__": main(sys.argv[1:]) print(exist(aname))</span></span></code> </pre><br></div></div><br>  Finalmente, coletamos informa√ß√µes sobre o trabalho realizado, adicionamos aos logs, relat√≥rios e movemos o arquivo processado para o reposit√≥rio no OLD. <br><br><div class="spoiler">  <b class="spoiler_title">report.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 # -*- coding: utf-8 -*- import smtplib, sys from email.mime.text import MIMEText def report(message, subject): me = 'zbx-scripts@x5.ru' you = 'mail@x5.ru' smtp_server = 'smtp.ru' msg = MIMEText(message) msg['Subject'] = subject msg['From'] = me msg['To'] = you s = smtplib.SMTP(smtp_server) s.sendmail(me, [you], msg.as_string()) s.quit() if __name__ == '__main__': report(sys.argv[2], sys.argv[1])</span></span></code> </pre><br></div></div><br>  Em geral, a base de monitoramento est√° pronta, execute o script no cron para execu√ß√£o autom√°tica e esque√ßa-o. <br><br><img src="https://habrastorage.org/webt/il/hk/0r/ilhk0rph3lcm1azoquz00y_zck0.jpeg"><br><br><h2>  Como preencher invent√°rio </h2><br>  <i>N√£o somos mais n√≥s, somos networkers.</i> <br><br>  O segundo est√°gio √© preencher objetos com dados que os engenheiros precisam para trabalhar.  √â necess√°rio ver todos os dados para resolver o incidente em um sistema, para n√£o percorrer sistemas diferentes, coletando informa√ß√µes em partes de diferentes fontes.  E como os principais dados t√©cnicos est√£o no monitoramento, tamb√©m atra√≠mos o restante para o monitoramento. <br>  Para coletar e transmitir as informa√ß√µes necess√°rias, o Zabbix escreveu o <b><font color="#008080">invent√°rio.py</font></b> , que √© amplamente envolvido na coleta de dados <font color="#008080"><abbr title="Protocolo de gerenciamento de rede simples">SNMP</abbr></font> dos equipamentos e, em menor grau, na an√°lise do arquivo do Excel. <br><br>  A pergunta come√ßa - por que n√£o usar os <i>itens</i> incorporados e inserir o resultado no <i>invent√°rio</i> usando as ferramentas do pr√≥prio Zabbix?  Existem tr√™s respostas: <br><br><ol><li>  Aninhamento insuficiente de a√ß√µes, como  geralmente √© necess√°rio extrair o valor pelo SNMP e usar o resultado na pr√≥xima consulta. </li><li>  A execu√ß√£o de uma coleta de dados uma vez por dia em todos os n√≥s com um script externo n√£o carrega a atividade principal de monitoramento e n√£o h√° fila para o item'am </li><li>  Existem dados que n√£o podem ser coletados via SNMP </li></ol><br>  Os dados dos provedores, dos quais os engenheiros de primeira e segunda linhas n√£o podem prescindir, s√£o armazenados em um arquivo do Excel em uma unidade de rede compartilhada e atualizados pelos gerentes que realizam contratos de comunica√ß√£o.  A integra√ß√£o com o arquivo causou grandes d√∫vidas - a an√°lise do Excel, preenchida manualmente, que pode alterar a estrutura, o nome, o local etc., provavelmente gerar√° erros constantemente.  Mas, devido √† falta de outra fonte relevante desses dados, eu tive que us√°-los.  Para, de alguma forma, nos protegermos da constante edi√ß√£o do roteiro, concordamos com os gerentes sobre a estrutura e o preenchimento correto, explicamos como a descarga autom√°tica ser√° realizada e que √© importante observar a estrutura atual.  Na pr√°tica, √© claro, ocorreram erros, mas n√≥s os rastreamos rapidamente, amaldi√ßoamos, mas os corrigimos. <br><br><div class="spoiler">  <b class="spoiler_title">invent√°rio.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 # -*- coding: utf-8 -*- import sys, json, pysnmp, ipaddress, xlrd from datetime import datetime as dt from pysnmp.entity.rfc3413.oneliner import cmdgen def snmp(host, operation, *oid): generator = cmdgen.CommandGenerator() auth_data = cmdgen.UsmUserData('user', 'pwd', 'hash') transport = cmdgen.UdpTransportTarget((host, 161)) getAtt = getattr(generator, '%sCmd'%operation) rst = (errorIndication, errorStatus, errorIndex, varBinds) = getAtt(auth_data, transport, *oid) if not errorIndication is None or errorStatus is True: return "Error: %s %s %s %s" % rst else: if operation=='get': return varBinds elif operation=='next': result=[] for var in varBinds: result.append(var) return result def xlsdata(file, sap): rb = xlrd.open_workbook(file) sheet = rb.sheet_by_index(0) base = {} for i in range(0, sheet.nrows-1): sapnum = str(round(sheet.cell(i,4).value)) if isinstance(sheet.cell(i,4).value,float) else sheet.cell(i,4).value name = str(round(sheet.cell(i,8).value)) if isinstance(sheet.cell(i,8).value,float) else sheet.cell(i,8).value if sap.upper() == sapnum.upper(): base = { 'type' : (sheet.cell(i,2).value), 'serialno_a' : (sheet.cell(i,13).value), 'serialno_b' : (sheet.cell(i,20).value), 'tag' : ('2') if sheet.cell(i, 20).value != '' else ('1'), 'macaddress_a' : (sheet.cell(i, 15).value), 'macaddress_b' : (sheet.cell(i, 22).value) } base['date_hw_purchase'] = dt.date(dt.now()).strftime("%d %B %Y") return (base) def inventory(host, sap): BGPASBASE={} for line in open('/path/a.prokhorov/integration/BGP-AS-BASE.cfg'): if ':' in line: line = line.split(':') BGPASBASE[line[0]]='%s(%s)'%(line[1].rstrip(), line[0]) ### Get Data from Operator shop = xlsdata('/mnt/oprf/providers_base.xlsx', sap) shop['date_hw_expiry'] = 'Failed' ### Get SNMP data shop['host_router'] = 'None' shop['host_netmask'] = 'None' shop['host_networks'] = 'None' try: ### Get Networks from router networks = '' for ip,mask in snmp(host, 'next', 'iso.3.6.1.2.1.4.20.1.1', 'iso.3.6.1.2.1.4.20.1.3'): networks = networks+str(ipaddress.ip_interface(u'%s/%s'%(ip[1].prettyPrint(), mask[1].prettyPrint())))+'\n' shop['host_networks']=networks ### Get BGP information bgppeers, ispnames = '','' for peer,asbgp in snmp(host, 'next', 'iso.3.6.1.2.1.15.3.1.7', 'iso.3.6.1.2.1.15.3.1.9'): asbgp = asbgp[1].prettyPrint() bgppeers = bgppeers+peer[1].prettyPrint()+'\n' ispnames = ispnames+(BGPASBASE.get(asbgp) if BGPASBASE.get(asbgp)!=None else asbgp)+'\n' shop['host_router'] = bgppeers.strip()[:38] shop['host_netmask'] = ispnames.strip()[:38] ### Get Vendor name and Model type hardware = snmp(host, 'get', 'iso.3.6.1.2.1.47.1.1.1.1.13.1', 'iso.3.6.1.2.1.47.1.1.1.1.10.1', 'iso.3.6.1.2.1.47.1.1.1.1.12.1', 'iso.3.6.1.2.1.1.1.0', 'iso.3.6.1.2.1.47.1.1.1.1.7.1') if str(hardware[0][1]) == '0235A325': shop['model'] = hardware[4][1].prettyPrint() else: shop['model'] = hardware[0][1].prettyPrint() shop['os_short'] = hardware[1][1].prettyPrint() shop['vendor'] = hardware[2][1].prettyPrint() version = hardware[3][1].prettyPrint() os = version.split('\n')[0] shop['os_full'] = version[:250] shop['os'] = ''.join(os.split(',')[:2])[:60] ### Make indicators shop['date_hw_expiry'] = 'Success' shop['date_hw_install'] = dt.date(dt.now()).strftime("%d %B %Y") except: shop.pop('host_router') shop.pop('host_netmask') shop.pop('host_networks') return shop #return json.dumps(dict([('inventory',shop)]), sort_keys=True, indent=4) if __name__ == "__main__": print(inventory(sys.argv[1], sys.argv[2]))</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">BGP-AS-BASE.cfg</b> <div class="spoiler_text"> <code>3216:Beeline <br> 9002:Retn <br> 2854:Orange <br> ~omit~ <br> 8359:MTS <br></code> <br></div></div><br>  O <i>arquivo BGP-AS-BASE.cfg</i> representa a correspond√™ncia do n√∫mero do <i>AS</i> e do nome do provedor.  √â necess√°rio determinar o provedor com o qual o <i>BGP est√°</i> instalado (de repente, h√° um erro no arquivo com contratos).  A base externa n√£o foi utilizada, pois  Existem muitos n√∫meros <i>AS</i> privados. <br><br>  Em termos de <font color="#008080">SNMP</font> : <br><br><ul><li>  solicitamos das sub-redes do roteador pelo <font color="#008080"><abbr title="Identificador de objeto">OID</abbr></font> <i>1.3.6.1.2.1.4.20.1.1</i> e das m√°scaras de sub-rede pelo <i>OID</i> <i>1.3.6.1.2.1.4.20.1.3</i> em uma solicita√ß√£o.  N√≥s processamos, convertemos para <i>xxxx / xx</i> e escrevemos na c√©lula <i>host_networks</i> . </li><li>  Quando solicitamos dados nos endere√ßos IP dos pares <i>BGP</i> , bem como em seu <i>ASN</i> , encontramos o nome do provedor por n√∫mero no banco de dados que criamos.  N√≥s os escrevemos nos <i>campos host_router</i> e <i>host_netmask</i> .  √â importante definir imediatamente um limite de 38 caracteres, pois  esses campos n√£o suportam mais.  Nossos nomes de campo no banco de dados nem sempre coincidem com os dados que eles armazenam, porque  usou os campos existentes no banco de dados do Zabbix, para n√£o mexer na cria√ß√£o de novos campos na tabela.  Os nomes de campo corretos foram corrigidos na WEB, n√£o houve confus√£o. </li><li>  carregamos dados do fornecedor, modelo e equipamento de software.  Parsim, escreva para as vari√°veis.  O design associado √† escrita do modelo do hardware deve-se ao fato de que, para alguns modelos, a <i>Cisco tem um</i> nome escrito em um <font color="#008080">OID</font> diferente (geralmente para o chassi), ent√£o tive que fazer uma verifica√ß√£o de dados adicional. </li></ul><br>  Todo o bloco associado ao SNMP √© inclu√≠do no <i>try-except</i> , para que, se n√£o houver SNMP no equipamento, o script n√£o caia e, pelo menos, obtivemos dados do Excel pelos fornecedores.  Para entender qual parte do script foi conclu√≠da e qual n√£o √©, <i>anotamos</i> o sucesso do bloco SNMP no campo <i>date_hw_expiry</i> , al√©m da data da √∫ltima vez em que removemos todos os dados do SNMP e a data da √∫ltima vez em que encontramos os dados no arquivo do Excel. <br><img src="https://habrastorage.org/webt/cc/he/en/ccheenqcce-qkrwbxcerarkji2e.png"><br><br>  Tudo isso volta na forma de <i>JSON</i> pronto para o Zabbix. <br><br>  A atualiza√ß√£o de todos os dados do invent√°rio √© iniciada uma vez por dia, descarregando todos os hosts e iniciando o <b><i>invent√°rio.py</i></b> para cada objeto. <br><br><div class="spoiler">  <b class="spoiler_title">mp-update.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python3 # -*- coding: utf-8 -*- from multiprocessing import Pool import time from zabbix.api import ZabbixAPI from inventory import inventory from report import report def updating(shop): try: shop['inventory'] = inventory(shop['interfaces'][0]['ip'], shop['host'][-4:]) shop.pop('interfaces') shop['inventory_mode'] = '1' shop.pop('host') print (shop['hostid']) return zapi.host.update(shop) except: print("&gt;&gt;&gt;",shop['hostid']) with open ('/home/local/integration/error.txt', 'a') as err: err.write(shop['hostid']) err.write("\n") if __name__ =='__main__': t = time.time() zapi = ZabbixAPI(url='http://z.noc.x5.ru/', user='user', password='pwd') shopbase = zapi.host.get(output=['host', 'hostid'], groupids= ['12', '13', '14'], monitored="1", selectInterfaces=['ip']) pool = Pool(processes=10) p=[0 for x in range(0,len(shopbase))] for i in range(0, len(shopbase), 10): print ("Index:", i,"\n",shopbase[i],"\n") pool.map(updating,shopbase[i:i+10]) pool.close() pool.join() print(time.time()-t) report('    Zabbix.', 'Inventory updating succeed')</span></span></code> </pre><br></div></div><br>  <font color="#008080">O multiprocessamento √©</font> usado (um exemplo √© obtido das vastas extens√µes da Internet).  Para pesquisar, usamos o <i>ID SAP</i> , que temos no nome do host.  A sa√≠da resultante √© escrita <i>atualiza√ß√£o</i> 'ohm no Zabbix. <br><br><h3>  Sum√°rio </h3><br>  Para a implementa√ß√£o de toda a integra√ß√£o, atualiza√ß√£o autom√°tica e atualiza√ß√£o dos mecanismos internos, a API do Zabbix √© mais que suficiente.  As principais fun√ß√µes usadas s√£o <i>host.get</i> , <i>host.create</i> e <i>host.update</i> , que juntos permitem controlar totalmente a cria√ß√£o e atualiza√ß√£o do banco de dados de objetos de monitoramento.  Os dados de entrada dessas fun√ß√µes podem ser enviados de quaisquer sistemas e fontes dispon√≠veis. <br><br>  Os principais m√≥dulos python que nos ajudaram a lidar com esta tarefa: <i>pysnmp</i> , <i>xlrd</i> , <i>zabbix.api</i> , <i>xml</i> , <i>ipaddress</i> , <i>json</i> . <br>  <i><font color="#008080">xlrd</font></i> - analisando o excel. <br>  <i><font color="#008080">xml</font></i> - an√°lise de XML. <br>  <i><font color="#008080">pysnmp</font></i> - <i><font color="#008080">extrai</font></i> dados SNMP do equipamento. <br><br>  A intera√ß√£o SNMP √© mais f√°cil que o SSH, pelo menos porque, na pr√°tica, a pe√ßa de hardware responde mais rapidamente ao SNMP do que ao SSH, analisar as respostas SNMP √© praticamente desnecess√°rio, embora as CLIs de diferentes fornecedores geralmente sejam muito diferentes umas das outras e as conclus√µes sejam as mesmas as equipes podem diferir mesmo em modelos diferentes do mesmo fornecedor. <br><br>  Os principais <i>OIDs</i> aplicados: <br>  <i>iso.3.6.1.2.1.4.20.1.1</i> - endere√ßos de todas as interfaces do roteador <br>  <i>iso.3.6.1.2.1.4.20.1.3</i> - m√°scaras de sub-rede de todas as interfaces do roteador <br>  <i>iso.3.6.1.2.1.15.3.1.7</i> - todos os pares de BGP do roteador <br>  <i>iso.3.6.1.2.1.15.3.1.9</i> - AS de todos os pares de BGP do roteador <br>  <i>iso.3.6.1.2.1.47.1.1.1.1.13.1</i> - modelo <br>  <i>iso.3.6.1.2.1.47.1.1.1.1.10.1</i> - vers√£o curta do software <br>  <i>iso.3.6.1.2.1.47.1.1.1.1.1.12.1</i> - fornecedor <br>  <i>iso.3.6.1.2.1.1.1.0</i> - vers√£o detalhada do software <br>  <i>iso.3.6.1.2.1.47.1.1.1.1.7.1</i> - modelo, tipo de chassi <br><br>  <i>O painel</i> teve que ser adicionado um pouco para dividir os problemas nas redes de distribui√ß√£o e n√£o interferir com eles em um monte.  Adicione tamb√©m v√°rios campos, por exemplo, ip, nome e endere√ßo do provedor, para que, em caso de acidente em massa, seja suficiente copiar e colar do navegador na mensagem todos os objetos com problema, imediatamente com todos os dados necess√°rios para o provedor. <br><img src="https://habrastorage.org/webt/ea/m3/zo/eam3zojwyhottbk5offhtkltg3o.png"><br><br>  <i>O "Workview"</i> foi escrito <i>separadamente</i> , no qual podemos encontrar todas as informa√ß√µes coletadas, al√©m dos gr√°ficos coletados para esse objeto. <br><br><img src="https://habrastorage.org/webt/m1/m-/jp/m1m-jpml-eypxjlgqlsoltn7in4.png"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438754/">https://habr.com/ru/post/pt438754/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438736/index.html">DevDay for Managers: gerenciar TI</a></li>
<li><a href="../pt438740/index.html">Gerenciando segredos com o HashiCorp Vault</a></li>
<li><a href="../pt438746/index.html">No caminho para os princ√≠pios f√≠sicos da evolu√ß√£o biol√≥gica. Continua√ß√£o</a></li>
<li><a href="../pt438748/index.html">Infraestrutura como c√≥digo, ganhamos em escala (Kirill Vetchinkin, TYME)</a></li>
<li><a href="../pt438752/index.html">Contabilidade diretamente no banco: como fazer felizes os empreendedores individuais</a></li>
<li><a href="../pt438756/index.html">Sexta verifica√ß√£o de cromo, posf√°cio</a></li>
<li><a href="../pt438758/index.html">Por que o Google altera a interface de URL padr√£o no navegador</a></li>
<li><a href="../pt438762/index.html">DBX: tente se livrar da compila√ß√£o de consultas MySQL</a></li>
<li><a href="../pt438764/index.html">Sexto teste de cromo, posf√°cio</a></li>
<li><a href="../pt438766/index.html">DNA extracelular como biomarcador do envelhecimento e v√°rias patologias</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>