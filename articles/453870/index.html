<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ñ üóæ üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Escribimos Reverse socks5 proxy en powershell. Parte 1 üôÜüèº üë®üèæ‚Äçü§ù‚Äçüë®üèª üë©üèæ‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La historia de la investigaci√≥n y el desarrollo en 3 partes. Parte 1 - investigaci√≥n. 
 Hay muchas hayas, incluso m√°s beneficios. 

 Declaraci√≥n del p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escribimos Reverse socks5 proxy en powershell. Parte 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453870/">  La historia de la investigaci√≥n y el desarrollo en 3 partes.  Parte 1 - investigaci√≥n. <br>  Hay muchas hayas, incluso m√°s beneficios. <br><br><h3>  Declaraci√≥n del problema. </h3><br>  Durante la realizaci√≥n de pentests y campa√±as de RedTeam, no siempre es posible utilizar los medios habituales de los clientes, como VPN, RDP, Citrix, etc.  como una soluci√≥n para ingresar a la red interna.  En alg√∫n lugar, una VPN normal funciona de acuerdo con MFA y se usa un token de hierro como segundo factor, en alg√∫n lugar se supervisa severamente y nuestra entrada de VPN se hace visible de inmediato, como dicen, con todas las consecuencias, pero en alg√∫n lugar simplemente no hay tales medios. <br><br>  En tales casos, constantemente tenemos que hacer los llamados "t√∫neles inversos": conexiones desde la red interna a un recurso externo o al servidor que controlamos.  Dentro de dicho t√∫nel, ya podemos trabajar con los recursos internos de los clientes. <br><br>  Hay varias variedades de tales t√∫neles inversos.  El m√°s famoso de ellos, por supuesto, es Meterpreter.  Los t√∫neles SSH con reenv√≠o de puerto inverso tambi√©n tienen una gran demanda entre las masas de hackers.  Hay muchas herramientas de t√∫nel inverso y muchas de ellas est√°n bien estudiadas y descritas. <br><br>  Por supuesto, por su parte, los desarrolladores de soluciones de protecci√≥n no se quedan atr√°s y detectan activamente tales acciones. <br><br>  Por ejemplo, las sesiones de MSF son detectadas exitosamente por IPS moderno de Cisco o Positive Tech, y el t√∫nel SSH inverso puede ser detectado por casi cualquier peque√±o firewall normal. <br><br>  Por lo tanto, para pasar desapercibido en una buena campa√±a de RedTeam, necesitamos construir un t√∫nel inverso con medios no est√°ndar y adaptarnos lo m√°s posible al modo real de la red. <br><br>  Intentemos encontrar o inventar algo similar. <br><a name="habracut"></a><br>  Antes de inventar algo, debe comprender qu√© resultado queremos lograr, qu√© funciones debe realizar nuestro desarrollo.  ¬øCu√°les ser√°n los requisitos para el t√∫nel para que podamos trabajar en modo de sigilo m√°ximo? <br><br>  Est√° claro que para cada caso, tales requisitos pueden diferir enormemente, pero por experiencia podemos distinguir los principales: <br><br><ul><li>  funciona en el sistema operativo Windows-7-10.  Como la mayor√≠a de las redes corporativas usan Windows; </li><li>  el cliente se conecta al servidor a trav√©s de SSL para evitar escuchar est√∫pidamente usando ips; </li><li>  al conectarse, el cliente debe admitir la operaci√≥n a trav√©s de un servidor proxy con autorizaci√≥n, como  Muchas compa√±√≠as acceden a Internet a trav√©s de un proxy.  De hecho, es posible que la m√°quina cliente ni siquiera sepa nada al respecto, y el proxy se usa en modo transparente.  Pero debemos poner tal funcionalidad; </li><li>  la parte del cliente debe ser concisa y port√°til; <br>  Est√° claro que para trabajar dentro de la red del Cliente en la m√°quina del cliente, puede instalar OpenVPN y elevar un t√∫nel completo a su servidor (ya que los clientes openvpn pueden trabajar a trav√©s de servidores proxy).  Pero, en primer lugar, esto no siempre funciona, ya que es posible que no seamos administradores locales all√≠, y en segundo lugar, har√° tanto ruido que un SIEM o HIPS decentes inmediatamente nos ‚Äúgolpear√°n‚Äù.  Idealmente, nuestro cliente deber√≠a ser un llamado comando en l√≠nea, como muchos shells de bash, por ejemplo, y ejecutarse a trav√©s de la l√≠nea de comando, por ejemplo, al ejecutar comandos desde una macro de palabra. </li><li>  nuestro t√∫nel debe ser multiproceso y admitir muchas conexiones al mismo tiempo; </li><li>  La conexi√≥n cliente-servidor debe tener alg√∫n tipo de autorizaci√≥n para que el t√∫nel se establezca solo para nuestro cliente, y no para todos los que vienen a nuestro servidor en la direcci√≥n y puerto especificados.  Idealmente, para "usuarios de terceros", se debe abrir una p√°gina de destino con sellos o temas profesionales relacionados con el dominio de origen. <br>  Por ejemplo, si el Cliente es una organizaci√≥n m√©dica, para el administrador de seguridad de la informaci√≥n que decidi√≥ verificar el recurso que utiliz√≥ el empleado de la cl√≠nica, se abrir√° una p√°gina con productos farmac√©uticos, una wikipedia con una descripci√≥n del diagn√≥stico o un blog del Dr. Komarovsky, etc. </li></ul><br><h3>  An√°lisis de herramientas existentes. </h3><br>  Antes de inventar su bicicleta, debe analizar las bicicletas existentes y comprender si realmente la necesitamos y, probablemente, no solo pensamos en la necesidad de una bicicleta tan funcional. <br><br>  Buscar en Internet (parece que estamos de acuerdo con Google), as√≠ como buscar en el github las palabras clave "calcetines inversos", no dio muchos resultados.  B√°sicamente, todo se reduce a construir t√∫neles ssh con reenv√≠o de puerto inverso y todo lo relacionado con √©l.  Adem√°s de los t√∫neles SSH, se pueden distinguir varias soluciones: <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/klsecservices/rpivot</a></b> <br>  Una implementaci√≥n de larga data del t√∫nel inverso de los chicos de Kaspersky Lab.  Por el nombre, est√° claro para qu√© es este script.  Implementado en Python 2.7, el t√∫nel se ejecuta en modo de texto claro (como est√° de moda decir ahora, hola a ILV) <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/tonyseek/rsocks</a></b> <br>  Otra implementaci√≥n de Python tambi√©n est√° en texto claro, pero hay m√°s opciones.  Est√° escrito como un m√≥dulo y hay una API para integrar la soluci√≥n en sus proyectos. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/llkat/rsockstun</a></b> <br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/mis-team/rsockstun</a></b> <br>  El primer enlace es la versi√≥n inicial de la implementaci√≥n de Sox inverso en Golang (no compatible con el desarrollador). <br><br>  El segundo enlace ya es nuestra revisi√≥n con chips adicionales, tambi√©n en el golang.  En nuestra versi√≥n, implementamos SSL, trabajamos a trav√©s de un proxy con autorizaci√≥n NTLM, autorizaci√≥n del cliente, una p√°gina de aterrizaje con una contrase√±a incorrecta (o m√°s bien una redirecci√≥n a una p√°gina de aterrizaje), modo multiproceso (es decir, varias personas pueden trabajar con el t√∫nel al mismo tiempo) , un sistema de ping del cliente para saber si est√° vivo o no. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/jun7th/tsocks</a></b> <br>  Implementaci√≥n inversa de Sox de nuestros "amigos chinos" en python.  All√≠ para los perezosos e "inmortales" se encuentra el binar (exe) listo para usar, ensamblado por los chinos y listo para usar.  Aqu√≠, solo el dios chino sabe que puede haber m√°s que la funcionalidad principal en este binario, as√≠ que √∫selo bajo su propio riesgo y riesgo. <br><br>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/securesocketfunneling/ssf</a></b> <br>  Un proyecto bastante interesante de C ++ para implementar calcetines inversos y m√°s.  Adem√°s del t√∫nel inverso, puede hacer reenv√≠o de puertos, crear un shell de comandos, etc. <br><br>  <b>Medidor de Msf</b> <br>  Aqu√≠, como dicen, sin comentarios.  Todos los piratas inform√°ticos m√°s o menos educados est√°n muy familiarizados con esta cosa y entienden con qu√© facilidad se puede detectar con un equipo de protecci√≥n. <br><br>  Todas las herramientas anteriores funcionan en una tecnolog√≠a similar: en una m√°quina dentro de la red, se lanza un m√≥dulo binario ejecutable preparado previamente, que establece una conexi√≥n a un servidor externo.  El servidor inicia el servidor SOCKS4 / 5, que acepta conexiones y las traduce al cliente. <br><br>  La desventaja de todas las herramientas anteriores es que se requiere Python o Golang en la m√°quina del cliente (¬øvio a menudo Python instalado en las m√°quinas, por ejemplo, los directores de la empresa o los trabajadores de oficina?), O necesita arrastrar un binario premontado a esta m√°quina (en realidad, Python y el script en una botella) y ejecute este binario que ya est√° all√≠.  Y descargar exe con su posterior lanzamiento tambi√©n es la firma de un antivirus local o HIPS. <br><br>  En general, la conclusi√≥n se sugiere a s√≠ misma: necesitamos una soluci√≥n en powershell.  Ahora los tomates volar√°n hacia nosotros, dicen PowerShell, todo est√° golpeado, est√° siendo monitoreado, bloqueado, etc.  etc.  De hecho, no en todas partes.  Declaramos responsablemente.  Por cierto, hay muchas maneras de evitar los bloqueos (aqu√≠ nuevamente la frase de moda sobre hola al ILV :)), comenzando por el est√∫pido cambio de nombre de powershell.exe -&gt; cmdd.exe y terminando con powerdll, etc. <br><br><h3>  Empieza a inventar </h3><br>  Est√° claro que primero buscaremos en Google y ... no encontraremos nada sobre este tema (si alguien lo ha encontrado, agregue enlaces a los comentarios).  Solo hay una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">implementaci√≥n de</a> Socks5 en powershell, pero este es el Sox "directo" habitual, que tiene varios de sus inconvenientes (hablaremos de ellos m√°s adelante).  Por supuesto, puede convertirlo en un reverso con un movimiento de mu√±eca, pero solo ser√° un Sox de un solo hilo, que no es exactamente lo que necesitamos para nosotros. <br><br>  Entonces, no encontramos nada listo, as√≠ que todav√≠a tenemos que inventar nuestra bicicleta.  Como base de nuestra bicicleta, tomamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nuestro desarrollo de</a> calcetines inversos en el golang e implementamos el cliente para √©l en powershell. <br><br>  <b>RSocksTun</b> <br><br>  Entonces, ¬øc√≥mo funciona rsockstun? <br><br>  En el coraz√≥n del trabajo de RsocksTun (en lo sucesivo, rs) hay dos componentes de software: el servidor Yamux y el servidor Socks5.  El servidor Socks5 es un local local regular, se ejecuta en el cliente.  Y las conexiones de multiplexaci√≥n a √©l (¬ørecuerdas sobre subprocesamiento m√∫ltiple?) Se proporcionan usando yamux ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">otro multiplexor m√°s</a> ).  Este esquema le permite ejecutar varios servidores de calcetines de cliente5 y distribuir conexiones externas a ellos, reenvi√°ndolos a trav√©s de una sola conexi√≥n TCP (casi como en meterpreter) desde el cliente al servidor, realizando as√≠ el modo multihilo, sin el cual simplemente no podemos trabajar completamente en el interno red <br><br>  La esencia de yamux es que introduce un nivel de red adicional de flujos, d√°ndose cuenta como un encabezado de 12 bytes para cada paquete.  (Aqu√≠ usamos intencionalmente la palabra "transmisi√≥n", no una transmisi√≥n, para no confundir al lector con el hilo del programa "hilo" - este concepto tambi√©n lo usaremos en este art√≠culo).  Dentro del encabezado yamux contiene el n√∫mero de transmisi√≥n, las banderas para configurar / finalizar la transmisi√≥n, el n√∫mero de bytes transferidos, el tama√±o de la ventana de transferencia. <br><br><img src="https://habrastorage.org/webt/ga/go/we/gagowe129appe4mb67fwca2rumi.jpeg"><br><br>  Adem√°s de instalar / completar la transmisi√≥n, yamux implementa un mecanismo keepalive que le permite monitorear el estado del canal de comunicaci√≥n instalado.  El mecanismo de mensajes keeplive se configura al crear una sesi√≥n de Yamux.  En realidad, desde la configuraci√≥n solo hay dos par√°metros: activar / desactivar y la frecuencia de env√≠o de paquetes en segundos.  El servidor yamux puede enviar mensajes keepalive, por lo que el cliente yamux puede.  Al recibir un mensaje keepalive, la parte remota est√° obligada a responder enviando exactamente el mismo identificador de mensaje (en realidad un n√∫mero) que ha recibido.  En general, keepalive es el mismo ping, solo para yamux. <br><br>  Toda la t√©cnica de operaci√≥n del multiplexor se detalla: tipos de paquetes, indicadores de instalaci√≥n y terminaci√≥n, el mecanismo de transferencia de datos se describe en <a href="">la especificaci√≥n de</a> yamux. <br><br><h3>  Conclusi√≥n de la primera parte. </h3><br>  Entonces, en la primera parte del art√≠culo nos familiarizamos con algunas herramientas para organizar t√∫neles inversos, analizamos sus ventajas y desventajas, estudiamos el mecanismo de operaci√≥n del multiplexor Yamux y describimos los requisitos b√°sicos para el m√≥dulo PowerShell reci√©n creado.  En la siguiente parte, desarrollaremos el m√≥dulo en s√≠, pr√°cticamente desde cero.  Continuar√°  No cambies :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453870/">https://habr.com/ru/post/453870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453860/index.html">AMD present√≥ sus nuevos procesadores personalizados de 7 nm Ryzen de tercera generaci√≥n</a></li>
<li><a href="../453862/index.html">Por qu√© deber√≠as usar pathlib</a></li>
<li><a href="../453864/index.html">¬øUsar un mouse y un teclado en las consolas es hacer trampa?</a></li>
<li><a href="../453866/index.html">Solicitud API con React Hooks, HOC o Render Prop</a></li>
<li><a href="../453868/index.html">Mini interruptor t√°ctil con panel de vidrio en nRF52832</a></li>
<li><a href="../453872/index.html">Restaurar fotos usando redes neuronales</a></li>
<li><a href="../453874/index.html">De la ruleta rusa a Safe LOTO: c√≥mo proteger al personal del centro de datos</a></li>
<li><a href="../453876/index.html">Como en Yandex.Practicum, gan√≥ la desincronizaci√≥n frontal: un n√∫mero acrob√°tico con Redux-Saga, postMessage y Jupyter</a></li>
<li><a href="../453882/index.html">Una gran gu√≠a sobre la profesi√≥n de arquitecto de soluciones (+ lista de enlaces √∫tiles)</a></li>
<li><a href="../453884/index.html">¬øC√°mara HYIP o reemplazo de DSLR?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>