<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏾 😰 🤴🏾 Xiaomi Wireless-Geräte im ioBroker Smart Home 😇 👨‍🎨 🕥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Grüße an alle Liebhaber der Heimautomation. Ich habe beschlossen, die Erfahrungen mit der Verwendung von drahtlosen Xiaomi-Geräten mit ZigBee-Schnitts...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Xiaomi Wireless-Geräte im ioBroker Smart Home</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/433340/">  Grüße an alle Liebhaber der Heimautomation.  Ich habe beschlossen, die Erfahrungen mit der Verwendung von drahtlosen Xiaomi-Geräten mit ZigBee-Schnittstelle zu teilen.  Ehrlich gesagt bin ich gegen die Verwendung von drahtlosen Geräten in jeder Automatisierung, von seriösen Prozessleitsystemen für große Objekte bis hin zu kleinen Automatisierungen wie Feuermeldern oder Smart Homes, aber ... Xiaomi-Lösungen, die mit Billigkeit, Zugänglichkeit, ausgezeichnetem Design und vielen positiven Bewertungen von Benutzern bestochen wurden, entschied ich zu versuchen. <br><br>  Dieser Beitrag sollte als schrittweise Anleitung zur Integration von ZigBee-Geräten in die Smart-Home-Infrastruktur verstanden werden.  Die hier beschriebene Beschreibung ist keineswegs ein Axiom, und Sie können viele andere Möglichkeiten finden, um ZigBee-Geräte anzuschließen.  Wenn Sie dennoch die detaillierte Beschreibung überspringen, können Sie anhand der Beispiele von ZigBee und ioBroker (etwas später) einen Eindruck von der Komplexität oder Einfachheit der Kombination von Geräten verschiedener Hersteller auf einer lokalen Plattform gewinnen.  In diesem Artikel werde ich Ihnen erklären, wie Sie Geräte mit einem Smart Home verbinden, Informationen von ihnen auf einem Tablet oder einfach in einem Browser anzeigen und per Telegramm Nachrichten über die Änderung des Gerätestatus senden.  Wenn ich für Sie von Interesse bin, bitte ich um eine Katze. <br><a name="habracut"></a><br>  Laut dem Hersteller von Xiaomi sollten Benutzer eine native Anwendung mit einer Cloud-Verbindung und einem Wi-Fi-Gateway für ZigBee-Geräte verwenden.  Ein Verfahren zum Aktivieren des Entwicklermodus in einer Anwendung zum Erhalten eines Kontrolltokens ist jedoch seit langem bekannt.  Auf diese Weise können Sie innerhalb des lokalen Netzwerks mit dem Gateway kommunizieren, wodurch Sie den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mihome-</a> Treiber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ausführen können</a> , der Teil von ioBroker ist. <br><br>  ioBroker ist eine offene Plattform für IoT, einschließlich zum Aufbau von Smart-Home-Systemen.  Was ioBroker ist, finden Sie im vorherigen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel</a> . <br><br>  Jetzt „dreht“ sich mein Smart Home auf einem Cubietruck ARM-Board mit einem „Bodykit“ in Form einer 80-GB-Festplatte, wiederaufladbaren 5000-mAh-Batterien, einem 1-Draht-USB-Master und einem USB-RS485-Konverter zum Abrufen von Geräten mithilfe des Modbus-Protokolls.  Armbian OS wird mit der Übertragung der Root-Partition auf der Festplatte installiert, nur der Bootloader verbleibt auf der microSD-Speicherkarte. <br><br>  Ich begann meine Bekanntschaft mit drahtlosen Xiaomi-Geräten durch den Kauf von Temperatur- und Feuchtigkeitssensoren.  Zu dieser Zeit war die einzige Möglichkeit ihrer Integration der <b>oben</b> erwähnte <b>Mihome-</b> Treiber. <br><br><h4>  Mihome-Fahrer </h4><br>  Das Hinzufügen eines Treibers zum System ist sehr einfach. Klicken Sie in der Liste der verfügbaren Treiber auf die Schaltfläche „+“ und beobachten Sie den Installationsvorgang. <br><br><img src="https://habrastorage.org/webt/1q/uv/gs/1quvgskqfsscaszi1df_weidl_k.png"><br><br>  Ich werde die Installation und Erstkonfiguration der nativen Android-Anwendung Mi Home nicht beschreiben. Sie können sie auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github-</a> Seite des Treibers oder im Internet sehen.  Also, der Entwicklermodus wird aktiviert, das Token wird empfangen, wir konfigurieren den Mihome-Adapter, speichern und führen ihn aus, wenn er nicht gestartet wurde. <br><br><img src="https://habrastorage.org/webt/hg/gi/uz/hggiuzkuphbirpnjp1xdcwcxy2e.png"><br><br>  Das Xiaomi-Gateway und die in der Mi Home-Anwendung verbundenen Geräte sollten in der Objektstruktur angezeigt werden. <br><br><img src="https://habrastorage.org/webt/tm/wf/gs/tmwfgsbmgvfncvw-gyezzdjhamw.png"><br><br>  Als Nächstes können Sie die neu erstellten Objekte konfigurieren.  Zum Beispiel Speichern der Geschichte von Temperatur- und Feuchtigkeitssensoren.  Ich verwende einen SQL-Treiber für historische Daten, die in einer SQLite-Datenbank konfiguriert sind. <br><br><img src="https://habrastorage.org/webt/wv/op/yk/wvopykrwhlu2pcgdru82m1yv8sg.png"><br><br>  Die Speicherung des Variablenverlaufs wird im Systemobjektfenster konfiguriert: In der Objekthierarchie müssen Sie zur Variablen selbst gelangen und die Taste mit einem Schraubenschlüssel rechts drücken.  Auf der Registerkarte "Einstellungen" habe ich den Verlaufsspeicher durch Sensoren aktiviert - nur Änderungen an der Variablen. <br><br>  Andere Einstellungen: <br><br><ul><li>  Mindestintervall von 10 Sekunden - Wenn sich die Variable häufiger ändert, wird der Eintrag in der Datenbank ignoriert </li><li>  Aufzeichnen von Werten alle 300 Sekunden (5 Minuten) - Wenn sich die Variable länger als 5 Minuten nicht ändert, wird der aktuelle Wert weiterhin in die Datenbank geschrieben </li><li>  Werttyp - Nummer </li><li>  Haltbarkeit - 1 Jahr </li></ul><br><img src="https://habrastorage.org/webt/a2/6n/ed/a26nedcztddt2fo4vofcdndkadu.png"><br><br>  Das Hinzufügen neuer Geräte erfolgt über die native Anwendung.  Das heißt,  Sie müssen das neue Gerät gemäß den beigefügten Anweisungen mit dem Gateway koppeln. Danach wird es automatisch in der Liste der ioBroker-Objekte angezeigt. <br><br><h4>  ZigBee-Fahrer </h4><br>  Es war für mich unpraktisch, die native Xiaomi-Anwendung zu verwenden, zumal ich ein Gateway mit einem chinesischen Stecker kaufen musste, was in meinem Fall, abgesehen von der Kommunikation mit Geräten, für nichts nützlich war.  Ja, es kann als Nachtlicht oder in einigen Szenarien als Lichtsensor verwendet werden.  Im Internet finden Sie Anweisungen, wie Sie eine Wiedergabeliste einem Gateway „zuführen“ können, um eigene Radiosender abzuspielen, aber nichts davon ist mir aufgefallen.  Außerdem war der Gedanke, dass meine Daten irgendwo verloren gingen, verarbeitet und irgendwo gespeichert wurden, unheimlich. <br><br>  Einer der aktiven Benutzer der ioBroker-Plattform fand im Internet die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ZigBee-Shepherd-</a> Bibliothek auf node.js, in der die Verbindung von Xiaomi-Geräten erwähnt wurde.  Ein Treiber für ioBroker wurde auf dieser Basis geschrieben. Der Autor dieses Treibers war nicht nur auf Xiaomi-Geräte beschränkt. Die Liste der unterstützten Geräte wird ständig aktualisiert und ist auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github-</a> Seite des Projekts <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verfügbar</a> . <br><br>  Als Netzwerkkoordinator sollen kostengünstige, vorgefertigte Geräte auf Basis der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CC25xx-</a> Chips von TI <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verwendet</a> werden.  Sie können fertige ZigBee-Module mit USB-Anschluss und integrierter Antenne sowie teurere und seriösere Modelle kaufen: mit externer Antenne, Verstärker und Anschluss über UART. <br><br>  Um mit dem Treiber zu arbeiten, müssen Sie nur die Firmware ändern.  Somit stellt sich heraus, dass dieser Treiber kein teures Gateway benötigt, Wi-Fi-Netzwerke nicht benötigt werden.  Der "Einstiegspunkt" ist der Koordinator - ein Gerät, das auf dem SS25xx-Chip mit spezieller Firmware basiert.  Über den Koordinator erfolgt eine direkte Kommunikation zwischen ZigBee-Geräten und dem Smart Home-System sowie die Bindung neuer Geräte. <br><br>  Als Koordinator verwende ich ein fertiges Motherboard auf Basis eines CC2530-Chips mit einer externen Antenne, das ich über UART mit dem Server verbunden habe. <br><br>  Für die Gerätefirmware wurde ein spezieller SmartRF04EB-Debugger gekauft, dessen Micro-USB-Anschluss ich an den Computer angeschlossen habe, und das ZigBee-Modul, das über Kabel zum Debuggen gemäß dem Schema angeschlossen wurde: <br><table><tbody><tr><th>  SS2530 </th><th>  SmartRF04EB-Karte </th></tr><tr><td>  P22 </td><td>  DC </td></tr><tr><td>  P21 </td><td>  DD </td></tr><tr><td>  Rst </td><td>  RESET </td></tr><tr><td>  GND </td><td>  GND </td></tr><tr><td>  Vcc </td><td>  3,3V </td></tr></tbody></table><br><br><img src="https://habrastorage.org/webt/zy/g3/mf/zyg3mfircqqapiz8vz59afyrm5g.jpeg"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Laden</a> Sie auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github-</a> Seite des Projekts die Firmware (die Datei heißt CC2530ZNP-Pro-Secure_LinkKeyJoin.hex für dieses Gerät) und das Firmware-Programm (Flash-Programmierer) herunter. Anschließend werden die erforderlichen Treiber zum System hinzugefügt. <br>  Wenn Sie die Debugger-Karte an den USB-Anschluss des Computers anschließen, zeigt das Programm sofort das angeschlossene Gerät an.  Sie müssen nur den Pfad zur Firmware-Datei angeben und auf die Schaltfläche "Aktionen ausführen" klicken <br><br><img src="https://habrastorage.org/webt/7z/rd/w8/7zrdw8e3iwpyvisw6dzohkfn3zs.png"><br><br>  Die ZigBee-Modul-Ports P03 (Rx) und P02 (Tx) sind in UART4-Cubietruck-Boards (im Betriebssystem wie ttyS4) mit 3V3-Stromversorgung verbunden, GND übernahm den benachbarten Pin.  Für einen stabilen Betrieb müssen Sie die Anschlüsse P20, P4, P5 des Koordinators noch auf den Boden ziehen.  Wie ich oben geschrieben habe, verwende ich das Armbian-Betriebssystem. Der UART-Port wird sehr einfach aktiviert. Mit dem Befehl <b>armbian-config</b> im Abschnitt <b>System</b> - <b>Hardware</b> müssen Sie den gewünschten Port aktivieren und das System neu <b>starten</b> . <br><br><img src="https://habrastorage.org/webt/ic/7l/il/ic7lilxwfsext55fvjnpdyxfiuq.png"><br><br>  Der ZigBee-Treiber wird mit einem Klick über das Admin-Panel hinzugefügt. <br><br><img src="https://habrastorage.org/webt/uw/-d/zm/uw-dzmkdrsbgnunfmchqtzqq8ta.png"><br><br>  In meinem Fall ist der Koordinator mit dem Port <b>/ dev / ttyS4 verbunden</b> (wie ich oben geschrieben habe), wir geben es in den Einstellungen an. <br><br><img src="https://habrastorage.org/webt/eu/2i/bo/eu2ibog5mba2paet4ecec7jo7aw.png"><br><br>  Andere Einstellungen können standardmäßig beibehalten werden.  Nach dem ersten Start des Treibers müssen Sie Geräte koppeln (hinzufügen).  Die vollständige Anleitung zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> , das Pairing über diesen Treiber, ist etwas komplizierter als über die native Anwendung, aber ich hatte keine Probleme. <br><br>  Fügen Sie zum Beispiel die Xiaomi-Taste (Mijia-Serie) hinzu. Drücken Sie dazu die grüne Taste in den Treibereinstellungen und halten Sie gemäß den Anweisungen zuerst die Pairing-Taste auf der Rückseite mit einer Büroklammer gedrückt, bis die LED zu blinken beginnt. Klicken Sie dann etwa alle 2 Sekunden auf diese Taste. Siehe den Pairing-Fortschritt. <br><br><img src="https://habrastorage.org/webt/mm/vq/ok/mmvqokw8ors3oszymkuqv5jsswq.png"><br><br>  Meine Wohnung ist nicht groß, mit allen Geräten ist die Verbindung stabil, auch mit einem Türöffnungssensor am Treppenabsatz (Stahlbetonwand ist 100 mm und 5 m in einer geraden Linie).  Die Probleme begannen, als ich mich entschied, der Straßenluft einen Temperatur- und Feuchtigkeitssensor hinzuzufügen, den ich von der Seite der isolierten Loggia an der Außenwand des Hauses installierte.  Das Signal eines schwachen Sensors, der sich ebenfalls auf der Straße befand, erreichte den Automationsschrank nicht.  Das Problem kann einfach gelöst werden - Sie müssen dem ZigBee-Netzwerk einen Router hinzufügen und ihn näher am Sensor platzieren.  Einige drahtlose Geräte, zum Beispiel die Xiaomi-Buchse, können als Router verwendet werden, aber ich hatte keine solchen Geräte.  Ich wollte keine teure Steckdose oder ein kontrolliertes Licht kaufen, nur um Daten von einem Sensor auf der Straße weiterzuleiten.  Wie sich herausstellte, gibt es für dieselben Endgeräte, die auf dem SS25xx-Chip basieren, eine spezielle Firmware, mit der sie als Router im System verwendet werden können.  Als Ergebnis habe ich einen Router hinzugefügt, der auf dem CC2531-Chip mit einer USB-Verbindung basiert.  Ich werde nicht auf den Firmware-Prozess <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eingehen</a> , das Schema und die Firmware-Datei selbst finden Sie auf der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github-</a> Seite des Projekts. <br><br>  Da tatsächlich keine Kommunikation mit dem Modul über den USB-Anschluss stattfindet, habe ich es vorübergehend an den USB-Anschluss angeschlossen und an eine Steckdose in der Küche angeschlossen.  In naher Zukunft plane ich, es stationär in einem normalen Gebäude auf der Loggia und mit normaler Stromversorgung von einer USV zu Hause zu platzieren. <br><br><img src="https://habrastorage.org/webt/kh/an/8v/khan8vzw8f5ueqs2n-jf-9kc2e4.jpeg"><br><br>  Das Hinzufügen eines Routers zum System ist einfach: Drücken Sie die Pairing-Taste im Treiber und am eingeschalteten Router mehrmals die S2-Taste, bis die Geräte verbunden sind. <br><br><img src="https://habrastorage.org/webt/6g/x_/gf/6gx_gfpctjiecwfz8mtz3ah8bne.png"><br><br>  Fügen wir ein Beispiel für einen Temperatur- / Feuchtigkeitssensor hinzu, den ich an der Loggia außerhalb angebracht habe und der über einen Router funktionieren soll. <br><br>  Sie können das Pairing einfach über den Treiber durchführen und der Sensor sollte über den Router verbunden werden, wenn er näher ist.  Sie können jedoch zwangsweise festlegen, dass das Pairing über einen bestimmten Router erfolgt. Klicken Sie dazu in der Liste der Geräte auf dem Routersymbol auf die grüne Pairing-Schaltfläche. <br><br><img src="https://habrastorage.org/webt/bz/df/tr/bzdftrouwfsmd3qq0yyztpsfyee.png"><br><br>  Stellen Sie sicher, dass der Sensor richtig angeschlossen ist - siehe Netzwerkkarte. <br><br><img src="https://habrastorage.org/webt/g9/bj/ru/g9bjruowwwdc7tvq03p0vychauo.png"><br><br>  Die Karte zeigt die Kopplungslinien von Geräten, die die Signalqualität zwischen Netzwerksegmenten angeben.  Wie ich oben geschrieben habe, habe ich eine kleine Odnushka von 35 qm, daher ist die Karte recht bescheiden.  Mit Erlaubnis anderer Benutzer werde ich mögliche Optionen mit einer größeren Karte veröffentlichen. <br><br><img src="https://habrastorage.org/webt/9b/r9/g6/9br9g6psblxtppn56-khinqtf90.png"><br><br><img src="https://habrastorage.org/webt/jo/--/ux/jo--uxxcnxpn_qtlah5yd4awl_g.png"><br><br><img src="https://habrastorage.org/webt/p0/lg/ba/p0lgba6-rpbvnqkcttsabf6wnaa.jpeg"><br><br>  Die Funktionalität einiger Xiaomi-Geräte über diesen Adapter ist sogar etwas höher als über die native Anwendung und den Mihome-Treiber.  In Zukunft möchte ich das Netzwerk etwas erweitern und neue Geräte ausprobieren, insbesondere ein intelligentes Laufwerk für Vorhänge und einen Sensorwürfel. <br><br><h4>  Materialtreiber </h4><br>  Wir haben die Daten, die Aktuatoren gebunden, was jetzt mit ihnen zu tun?  Lassen Sie uns zunächst in einer schönen Oberfläche anzeigen.  Ich habe ein großes Projekt im VIS-Treiber, das in mehreren Versionen für unterschiedliche Berechtigungen vorhanden ist, aber es gibt genügend Material für einen separaten Artikel.  Vielleicht wird sie die nächste sein. <br><br>  Für die einfache und schnelle Anzeige von Daten und die Steuerung verschiedener Geräte verwende ich den Materialtreiber.  Installation wie gewohnt mit wenigen Klicks.  Schnittstellenkacheln zeigen Daten basierend auf Kategorieeinstellungen an, die im gleichnamigen Schnittstellenverwaltungsfenster hinzugefügt werden.  Die Liste der Kategorien ist nur durch die Vorstellungskraft begrenzt, ich verwende das "Raumfunktions" -Schema und die Gruppierung erfolgt nach diesen.  Alle Räume (Küche, Flur, Raum, Balkon usw.) und Funktionen (Beleuchtung, Sensoren, System usw.) wurden hinzugefügt. <br><br><img src="https://habrastorage.org/webt/le/nt/7p/lent7pos1th-k5mzz9yezdmug-m.png"><br><br>  Im Einstellungsfenster von Systemobjekten müssen nun die Variablen, die auf dem Bildschirm angezeigt werden, den Raum angeben, funktionieren und eine Rolle zuweisen (für eine ordnungsgemäße Anzeige).  Ein Beispiel ist der Innenraumtemperatur- und Feuchtigkeitssensor von Xiaomi, der über Bluetooth verbunden ist. <br><br><img src="https://habrastorage.org/webt/by/2u/ws/by2uwskolk1rxomzcm-mvg_rccw.png"><br><br>  Basierend auf diesen Einstellungen zeigt die Kachel Daten auf dem Bildschirm an, das Symbol wird enger und für Objekte eines bestimmten Typs steht ein Steuerelement zur Verfügung. <br><br>  <b>Beispiel 1.</b> Die Ausgabe aller Informationen in einer Kategorie - Funktion.  Beleuchtung in der gesamten Wohnung. <br><br><img src="https://habrastorage.org/webt/jp/xs/m3/jpxsm3v67xbi7otryix6xqemigu.png"><br><br>  <b>Beispiel 2.</b> Die Ausgabe aller Informationen über den Raum - Badezimmer. <br><br><img src="https://habrastorage.org/webt/5x/ce/2m/5xce2mjrmxjetxojelprdg95chg.png"><br><br>  <b>Beispiel 3. Die</b> Spannung und der Batterieentladungsgrad aller drahtlosen Xiaomi-Geräte. <br><br><img src="https://habrastorage.org/webt/40/t4/p3/40t4p3d-ggn71albkiy7aarsylo.png"><br><br>  Dieser Treiber arbeitet für mich für die lokale Steuerung des Systems von einem Mobiltelefon aus, einem stationären Tablet an der Wand.  Manchmal verbinde ich mich über VPN.  Um Zustände fernzusteuern und anzuzeigen und Benachrichtigungen zu erhalten, verwende ich den Telegrammtreiber. <br><br><h4>  Telegrammtreiber </h4><br>  Ich werde die Installation nicht beschreiben, sondern nur die Einstellungen durchgehen.  Ich verwende den Betriebsmodus durch periodisches Abrufen (standardmäßig 300 ms) und Verbindung über einen Proxyserver.  Um Token zu erhalten, müssen Sie mit dem Ersteller der Bots, BotFather, „sprechen“.  Der Vorgang ist einfach: Suchen Sie nach diesem Bot, geben Sie einen Befehl zum Erstellen eines neuen Bots ein, geben Sie seinen eindeutigen Namen und Ihren Schlüssel an, geben Sie ihn in den Treibereinstellungen an und geben Sie aus Sicherheitsgründen das Begrüßungskennwort an.  Ihr Bot wird ihn fragen, wenn er mit einem neuen Benutzer kommuniziert. <br><br><img src="https://habrastorage.org/webt/du/nw/jt/dunwjtmlt874q5t1hma81lpz0qs.png"><br><br>  Jetzt müssen Sie Kommunikationsfälle über den Bot konfigurieren.  Sie können dazu den text2command-Treiber oder JavaScript verwenden.  Historisch gesehen ist es so, dass ich JavaScript sowohl in Form von Text als auch in Form von Blockblöcken verwende.  Die Installation des JS-Treibers sollte keine Schwierigkeiten verursachen. In diesem Fall ist die Konfiguration nicht erforderlich.  Nach der Installation und dem Start müssen Sie die Menüanzeige aktivieren, um Skripte zu erstellen und zu bearbeiten. <br><br><img src="https://habrastorage.org/webt/wj/tc/pb/wjtcpbty2ro46bn6a5orrwbvpis.png"><br><br>  <b>Beispiel 1.</b> Warnungen. <br><br>  Versuchen wir zunächst, eine Benachrichtigung über die Öffnung beispielsweise der Eingangstür zu senden.  Ich habe einen drahtlosen Xiaomi-Sensor-Reed-Schalter an der Vordertür.  Ich beobachte, wie meine Frau mit dem Kleinen geht, während ich bei der Arbeit bin.  Erstellen Sie ein neues Skript in der gemeinsamen Gruppe. <br><br><img src="https://habrastorage.org/webt/cu/l6/5j/cul65jefd-k794nct-cicju7x64.png"><br><br>  Geben Sie an, was blockweise "gezeichnet" werden soll, und nennen Sie es "telegram_bot". <br><br><img src="https://habrastorage.org/webt/os/ed/kq/osedkqplopwii7ckmd3eftjliwo.png"><br><br>  In der Gruppe "Ereignisse" nehmen wir die Reaktionseinheit, um die Variable zu ändern und auf das Arbeitsfeld zu ziehen. <br><br><img src="https://habrastorage.org/webt/1h/o6/yq/1ho6yq_kluvryjb48bdo9iijn-a.png"><br><br>  Wählen Sie als Nächstes die ID des Objekts aus, das wir abonnieren, und fügen Sie die Objektprüfung durch "if" - "andernfalls if" in "true / false" ein.  Das Ergebnis sollte ungefähr so ​​aussehen. <br><br><img src="https://habrastorage.org/webt/9u/-r/0s/9u-r0sajaneojinyzpgojw2lnoa.png"><br><br>  Ok, jetzt rennen wir, wir öffnen die Tür - wir schließen die Tür und wir sehen Nachrichten im Telegramm. <br><br><img src="https://habrastorage.org/webt/ae/07/u6/ae07u62jmarzp0nw1hv2a3bhv9y.png"><br><br>  <b>Beispiel 2.</b> Lichtsteuerung über das Menü. <br>  Ein Beispiel ist komplizierter. Lassen Sie uns die Lichtsteuerung mithilfe der Menütasten im Telegramm vornehmen.  Hier muss man ein bisschen rumhängen, d.h.  Wenn Sie ein Skript erstellen, müssen Sie JS auswählen.  Die Aufgabe ist ungefähr die folgende: Schaltflächen in Form eines Menüs zu erstellen, wobei der Status der Geräte sofort im Signaturtext der Schaltfläche angezeigt wird.  Stellen Sie dennoch sicher, dass beim Drücken der Taste der Beleuchtungsstatus invertiert und der Status im Schaltflächentext sofort mit dem Erscheinen / Verschwinden der Glühbirne aktualisiert wird.  Wenn das Menü bereits ausgeführt wird und das Licht manuell mit der Taste ein- und ausgeschaltet wird, muss das Menü auch mit dem Status der Geräte aktualisiert werden. <br>  Der Code enthält Kommentare und ist relativ unkompliziert: <br><div class="oembed"><script type="text/javascript" src="https://gist.github.com/c980b9dd1c2e9d050810b11ed712b0c0.js"></script><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-31007ea0d3bd9f80540adfbc55afc7bd.css"><div id="gist93669305" class="gist">
    <div class="gist-file">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-telegram_bot" class="file">
    

  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text ">
      
<table class="highlight tab-size js-file-line-container" data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-telegram_bot-L1" class="blob-num js-line-number" data-line-number="1"></td>
        <td id="file-telegram_bot-LC1" class="blob-code blob-code-inner js-file-line">//    ID   </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L2" class="blob-num js-line-number" data-line-number="2"></td>
        <td id="file-telegram_bot-LC2" class="blob-code blob-code-inner js-file-line">const LIGHT1 = ' ',     CH_LIGHT1 = 'mqtt.0.PLC55_Lighting.lighting.MainRoom_main1';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L3" class="blob-num js-line-number" data-line-number="3"></td>
        <td id="file-telegram_bot-LC3" class="blob-code blob-code-inner js-file-line">const LIGHT2 = ' ',      CH_LIGHT2 = 'mqtt.0.PLC55_Lighting.lighting.MainRoom_main2';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L4" class="blob-num js-line-number" data-line-number="4"></td>
        <td id="file-telegram_bot-LC4" class="blob-code blob-code-inner js-file-line">const LIGHT3 = ' ',    CH_LIGHT3 = 'mqtt.0.PLC55_Lighting.lighting.MainRoom_sec';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L5" class="blob-num js-line-number" data-line-number="5"></td>
        <td id="file-telegram_bot-LC5" class="blob-code blob-code-inner js-file-line">const LIGHT4 = ' ',      CH_LIGHT4 = 'mqtt.0.PLC55_Lighting.lighting.Kitchen_main';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L6" class="blob-num js-line-number" data-line-number="6"></td>
        <td id="file-telegram_bot-LC6" class="blob-code blob-code-inner js-file-line">const LIGHT5 = ' 1',  	CH_LIGHT5 = 'mqtt.0.PLC55_Lighting.lighting.Kitchen_sec_top';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L7" class="blob-num js-line-number" data-line-number="7"></td>
        <td id="file-telegram_bot-LC7" class="blob-code blob-code-inner js-file-line">const LIGHT6 = ' 2',    CH_LIGHT6 = 'mqtt.0.PLC55_Lighting.lighting.Kitchen_sec_bottom';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L8" class="blob-num js-line-number" data-line-number="8"></td>
        <td id="file-telegram_bot-LC8" class="blob-code blob-code-inner js-file-line">const LIGHT7 = ' ',     CH_LIGHT7 = 'mqtt.0.PLC55_Lighting.lighting.BathRoom_main';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L9" class="blob-num js-line-number" data-line-number="9"></td>
        <td id="file-telegram_bot-LC9" class="blob-code blob-code-inner js-file-line">const LIGHT8 = ' ',       CH_LIGHT8 = 'mqtt.0.PLC55_Lighting.lighting.Hall_main';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L10" class="blob-num js-line-number" data-line-number="10"></td>
        <td id="file-telegram_bot-LC10" class="blob-code blob-code-inner js-file-line">const LIGHT9 = ' ',    CH_LIGHT9 = 'mqtt.0.PLC55_Lighting.lighting.Balcon_main';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L11" class="blob-num js-line-number" data-line-number="11"></td>
        <td id="file-telegram_bot-LC11" class="blob-code blob-code-inner js-file-line">
</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L12" class="blob-num js-line-number" data-line-number="12"></td>
        <td id="file-telegram_bot-LC12" class="blob-code blob-code-inner js-file-line">//    </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L13" class="blob-num js-line-number" data-line-number="13"></td>
        <td id="file-telegram_bot-LC13" class="blob-code blob-code-inner js-file-line">function sendLightMenu(message_text) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L14" class="blob-num js-line-number" data-line-number="14"></td>
        <td id="file-telegram_bot-LC14" class="blob-code blob-code-inner js-file-line">	//   </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L15" class="blob-num js-line-number" data-line-number="15"></td>
        <td id="file-telegram_bot-LC15" class="blob-code blob-code-inner js-file-line">    var l1 = getState(CH_LIGHT1).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L16" class="blob-num js-line-number" data-line-number="16"></td>
        <td id="file-telegram_bot-LC16" class="blob-code blob-code-inner js-file-line">    var l2 = getState(CH_LIGHT2).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L17" class="blob-num js-line-number" data-line-number="17"></td>
        <td id="file-telegram_bot-LC17" class="blob-code blob-code-inner js-file-line">    var l3 = getState(CH_LIGHT3).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L18" class="blob-num js-line-number" data-line-number="18"></td>
        <td id="file-telegram_bot-LC18" class="blob-code blob-code-inner js-file-line">    var l4 = getState(CH_LIGHT4).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L19" class="blob-num js-line-number" data-line-number="19"></td>
        <td id="file-telegram_bot-LC19" class="blob-code blob-code-inner js-file-line">    var l5 = getState(CH_LIGHT5).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L20" class="blob-num js-line-number" data-line-number="20"></td>
        <td id="file-telegram_bot-LC20" class="blob-code blob-code-inner js-file-line">    var l6 = getState(CH_LIGHT6).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L21" class="blob-num js-line-number" data-line-number="21"></td>
        <td id="file-telegram_bot-LC21" class="blob-code blob-code-inner js-file-line">    var l7 = getState(CH_LIGHT7).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L22" class="blob-num js-line-number" data-line-number="22"></td>
        <td id="file-telegram_bot-LC22" class="blob-code blob-code-inner js-file-line">    var l8 = getState(CH_LIGHT8).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L23" class="blob-num js-line-number" data-line-number="23"></td>
        <td id="file-telegram_bot-LC23" class="blob-code blob-code-inner js-file-line">    var l9 = getState(CH_LIGHT9).val ? '💡' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L24" class="blob-num js-line-number" data-line-number="24"></td>
        <td id="file-telegram_bot-LC24" class="blob-code blob-code-inner js-file-line">    // </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L25" class="blob-num js-line-number" data-line-number="25"></td>
        <td id="file-telegram_bot-LC25" class="blob-code blob-code-inner js-file-line">	sendTo('telegram.0', {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L26" class="blob-num js-line-number" data-line-number="26"></td>
        <td id="file-telegram_bot-LC26" class="blob-code blob-code-inner js-file-line">        text:   message_text,</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L27" class="blob-num js-line-number" data-line-number="27"></td>
        <td id="file-telegram_bot-LC27" class="blob-code blob-code-inner js-file-line">        reply_markup: {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L28" class="blob-num js-line-number" data-line-number="28"></td>
        <td id="file-telegram_bot-LC28" class="blob-code blob-code-inner js-file-line">            keyboard: [</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L29" class="blob-num js-line-number" data-line-number="29"></td>
        <td id="file-telegram_bot-LC29" class="blob-code blob-code-inner js-file-line">                [LIGHT1+l1, LIGHT2+l2, LIGHT3+l3],</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L30" class="blob-num js-line-number" data-line-number="30"></td>
        <td id="file-telegram_bot-LC30" class="blob-code blob-code-inner js-file-line">                [LIGHT4+l4, LIGHT5+l5, LIGHT6+l6],</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L31" class="blob-num js-line-number" data-line-number="31"></td>
        <td id="file-telegram_bot-LC31" class="blob-code blob-code-inner js-file-line">                [LIGHT7+l7, LIGHT8+l8, LIGHT9+l9]</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L32" class="blob-num js-line-number" data-line-number="32"></td>
        <td id="file-telegram_bot-LC32" class="blob-code blob-code-inner js-file-line">            ],</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L33" class="blob-num js-line-number" data-line-number="33"></td>
        <td id="file-telegram_bot-LC33" class="blob-code blob-code-inner js-file-line">            resize_keyboard:   true,</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L34" class="blob-num js-line-number" data-line-number="34"></td>
        <td id="file-telegram_bot-LC34" class="blob-code blob-code-inner js-file-line">            one_time_keyboard: true</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L35" class="blob-num js-line-number" data-line-number="35"></td>
        <td id="file-telegram_bot-LC35" class="blob-code blob-code-inner js-file-line">        }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L36" class="blob-num js-line-number" data-line-number="36"></td>
        <td id="file-telegram_bot-LC36" class="blob-code blob-code-inner js-file-line">    });</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L37" class="blob-num js-line-number" data-line-number="37"></td>
        <td id="file-telegram_bot-LC37" class="blob-code blob-code-inner js-file-line">}</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L38" class="blob-num js-line-number" data-line-number="38"></td>
        <td id="file-telegram_bot-LC38" class="blob-code blob-code-inner js-file-line">//  </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L39" class="blob-num js-line-number" data-line-number="39"></td>
        <td id="file-telegram_bot-LC39" class="blob-code blob-code-inner js-file-line">function changeLight(room, channel) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L40" class="blob-num js-line-number" data-line-number="40"></td>
        <td id="file-telegram_bot-LC40" class="blob-code blob-code-inner js-file-line">	//   </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L41" class="blob-num js-line-number" data-line-number="41"></td>
        <td id="file-telegram_bot-LC41" class="blob-code blob-code-inner js-file-line">    var alive = getState("mqtt.0.info.connection").val;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L42" class="blob-num js-line-number" data-line-number="42"></td>
        <td id="file-telegram_bot-LC42" class="blob-code blob-code-inner js-file-line">    if (alive.includes("PLC55_Lighting")) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L43" class="blob-num js-line-number" data-line-number="43"></td>
        <td id="file-telegram_bot-LC43" class="blob-code blob-code-inner js-file-line">        if (getState(channel).val) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L44" class="blob-num js-line-number" data-line-number="44"></td>
        <td id="file-telegram_bot-LC44" class="blob-code blob-code-inner js-file-line">            setState(channel, false, false, function () {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L45" class="blob-num js-line-number" data-line-number="45"></td>
        <td id="file-telegram_bot-LC45" class="blob-code blob-code-inner js-file-line">                sendLightMenu(room+' ');</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L46" class="blob-num js-line-number" data-line-number="46"></td>
        <td id="file-telegram_bot-LC46" class="blob-code blob-code-inner js-file-line">            });</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L47" class="blob-num js-line-number" data-line-number="47"></td>
        <td id="file-telegram_bot-LC47" class="blob-code blob-code-inner js-file-line">        } else { </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L48" class="blob-num js-line-number" data-line-number="48"></td>
        <td id="file-telegram_bot-LC48" class="blob-code blob-code-inner js-file-line">            setState(channel, true, false, function () {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L49" class="blob-num js-line-number" data-line-number="49"></td>
        <td id="file-telegram_bot-LC49" class="blob-code blob-code-inner js-file-line">                sendLightMenu(room+' ');</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L50" class="blob-num js-line-number" data-line-number="50"></td>
        <td id="file-telegram_bot-LC50" class="blob-code blob-code-inner js-file-line">            });</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L51" class="blob-num js-line-number" data-line-number="51"></td>
        <td id="file-telegram_bot-LC51" class="blob-code blob-code-inner js-file-line">        }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L52" class="blob-num js-line-number" data-line-number="52"></td>
        <td id="file-telegram_bot-LC52" class="blob-code blob-code-inner js-file-line">    } else {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L53" class="blob-num js-line-number" data-line-number="53"></td>
        <td id="file-telegram_bot-LC53" class="blob-code blob-code-inner js-file-line">        sendLightMenu('  OFFLINE');</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L54" class="blob-num js-line-number" data-line-number="54"></td>
        <td id="file-telegram_bot-LC54" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L55" class="blob-num js-line-number" data-line-number="55"></td>
        <td id="file-telegram_bot-LC55" class="blob-code blob-code-inner js-file-line">}</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L56" class="blob-num js-line-number" data-line-number="56"></td>
        <td id="file-telegram_bot-LC56" class="blob-code blob-code-inner js-file-line">//   request  ,    </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L57" class="blob-num js-line-number" data-line-number="57"></td>
        <td id="file-telegram_bot-LC57" class="blob-code blob-code-inner js-file-line">on({id: "telegram.0.communicate.request", ack: false, change: 'any'}, function (obj) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L58" class="blob-num js-line-number" data-line-number="58"></td>
        <td id="file-telegram_bot-LC58" class="blob-code blob-code-inner js-file-line">    var msg = obj.state.val;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L59" class="blob-num js-line-number" data-line-number="59"></td>
        <td id="file-telegram_bot-LC59" class="blob-code blob-code-inner js-file-line">    var command = obj.state.val.substring(obj.state.val.indexOf(']')+1);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L60" class="blob-num js-line-number" data-line-number="60"></td>
        <td id="file-telegram_bot-LC60" class="blob-code blob-code-inner js-file-line">    var user = obj.state.val.substring(obj.state.val.indexOf('[')+1,obj.state.val.indexOf(']'));</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L61" class="blob-num js-line-number" data-line-number="61"></td>
        <td id="file-telegram_bot-LC61" class="blob-code blob-code-inner js-file-line">    var chat_id = getState("telegram.0.communicate.requestChatId").val;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L62" class="blob-num js-line-number" data-line-number="62"></td>
        <td id="file-telegram_bot-LC62" class="blob-code blob-code-inner js-file-line">    var message_id = getState("telegram.0.communicate.requestMessageId").val;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L63" class="blob-num js-line-number" data-line-number="63"></td>
        <td id="file-telegram_bot-LC63" class="blob-code blob-code-inner js-file-line">    var handled = false;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L64" class="blob-num js-line-number" data-line-number="64"></td>
        <td id="file-telegram_bot-LC64" class="blob-code blob-code-inner js-file-line">    //     </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L65" class="blob-num js-line-number" data-line-number="65"></td>
        <td id="file-telegram_bot-LC65" class="blob-code blob-code-inner js-file-line">	if (command == '/start' || command == '/menu' || command == '' || command == '') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L66" class="blob-num js-line-number" data-line-number="66"></td>
        <td id="file-telegram_bot-LC66" class="blob-code blob-code-inner js-file-line">        sendLightMenu("");</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L67" class="blob-num js-line-number" data-line-number="67"></td>
        <td id="file-telegram_bot-LC67" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L68" class="blob-num js-line-number" data-line-number="68"></td>
        <td id="file-telegram_bot-LC68" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L69" class="blob-num js-line-number" data-line-number="69"></td>
        <td id="file-telegram_bot-LC69" class="blob-code blob-code-inner js-file-line">//######################## Lighting menu and commands ################</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L70" class="blob-num js-line-number" data-line-number="70"></td>
        <td id="file-telegram_bot-LC70" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT1 || command == LIGHT1+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L71" class="blob-num js-line-number" data-line-number="71"></td>
        <td id="file-telegram_bot-LC71" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT1, CH_LIGHT1);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L72" class="blob-num js-line-number" data-line-number="72"></td>
        <td id="file-telegram_bot-LC72" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L73" class="blob-num js-line-number" data-line-number="73"></td>
        <td id="file-telegram_bot-LC73" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L74" class="blob-num js-line-number" data-line-number="74"></td>
        <td id="file-telegram_bot-LC74" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT2 || command == LIGHT2+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L75" class="blob-num js-line-number" data-line-number="75"></td>
        <td id="file-telegram_bot-LC75" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT2, CH_LIGHT2);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L76" class="blob-num js-line-number" data-line-number="76"></td>
        <td id="file-telegram_bot-LC76" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L77" class="blob-num js-line-number" data-line-number="77"></td>
        <td id="file-telegram_bot-LC77" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L78" class="blob-num js-line-number" data-line-number="78"></td>
        <td id="file-telegram_bot-LC78" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT3 || command == LIGHT3+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L79" class="blob-num js-line-number" data-line-number="79"></td>
        <td id="file-telegram_bot-LC79" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT3, CH_LIGHT3);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L80" class="blob-num js-line-number" data-line-number="80"></td>
        <td id="file-telegram_bot-LC80" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L81" class="blob-num js-line-number" data-line-number="81"></td>
        <td id="file-telegram_bot-LC81" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L82" class="blob-num js-line-number" data-line-number="82"></td>
        <td id="file-telegram_bot-LC82" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT4 || command == LIGHT4+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L83" class="blob-num js-line-number" data-line-number="83"></td>
        <td id="file-telegram_bot-LC83" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT4, CH_LIHT4);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L84" class="blob-num js-line-number" data-line-number="84"></td>
        <td id="file-telegram_bot-LC84" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L85" class="blob-num js-line-number" data-line-number="85"></td>
        <td id="file-telegram_bot-LC85" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L86" class="blob-num js-line-number" data-line-number="86"></td>
        <td id="file-telegram_bot-LC86" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT5 || command == LIGHT5+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L87" class="blob-num js-line-number" data-line-number="87"></td>
        <td id="file-telegram_bot-LC87" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT5, CH_LIGHT5);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L88" class="blob-num js-line-number" data-line-number="88"></td>
        <td id="file-telegram_bot-LC88" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L89" class="blob-num js-line-number" data-line-number="89"></td>
        <td id="file-telegram_bot-LC89" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L90" class="blob-num js-line-number" data-line-number="90"></td>
        <td id="file-telegram_bot-LC90" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT6 || command == LIGHT6+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L91" class="blob-num js-line-number" data-line-number="91"></td>
        <td id="file-telegram_bot-LC91" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT6, CH_LIGHT6);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L92" class="blob-num js-line-number" data-line-number="92"></td>
        <td id="file-telegram_bot-LC92" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L93" class="blob-num js-line-number" data-line-number="93"></td>
        <td id="file-telegram_bot-LC93" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L94" class="blob-num js-line-number" data-line-number="94"></td>
        <td id="file-telegram_bot-LC94" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT7 || command == LIGHT7+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L95" class="blob-num js-line-number" data-line-number="95"></td>
        <td id="file-telegram_bot-LC95" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT7, CH_LIGHT7);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L96" class="blob-num js-line-number" data-line-number="96"></td>
        <td id="file-telegram_bot-LC96" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L97" class="blob-num js-line-number" data-line-number="97"></td>
        <td id="file-telegram_bot-LC97" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L98" class="blob-num js-line-number" data-line-number="98"></td>
        <td id="file-telegram_bot-LC98" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT8 || command == LIGHT8+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L99" class="blob-num js-line-number" data-line-number="99"></td>
        <td id="file-telegram_bot-LC99" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT8, CH_LIGHT8);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L100" class="blob-num js-line-number" data-line-number="100"></td>
        <td id="file-telegram_bot-LC100" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L101" class="blob-num js-line-number" data-line-number="101"></td>
        <td id="file-telegram_bot-LC101" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L102" class="blob-num js-line-number" data-line-number="102"></td>
        <td id="file-telegram_bot-LC102" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT9 || command == LIGHT9+'💡') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L103" class="blob-num js-line-number" data-line-number="103"></td>
        <td id="file-telegram_bot-LC103" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT9, CH_LIGHT9);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L104" class="blob-num js-line-number" data-line-number="104"></td>
        <td id="file-telegram_bot-LC104" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L105" class="blob-num js-line-number" data-line-number="105"></td>
        <td id="file-telegram_bot-LC105" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L106" class="blob-num js-line-number" data-line-number="106"></td>
        <td id="file-telegram_bot-LC106" class="blob-code blob-code-inner js-file-line">	//       ,      text2command</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L107" class="blob-num js-line-number" data-line-number="107"></td>
        <td id="file-telegram_bot-LC107" class="blob-code blob-code-inner js-file-line">    if (!handled) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L108" class="blob-num js-line-number" data-line-number="108"></td>
        <td id="file-telegram_bot-LC108" class="blob-code blob-code-inner js-file-line">        sendTo('text2command.0', {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L109" class="blob-num js-line-number" data-line-number="109"></td>
        <td id="file-telegram_bot-LC109" class="blob-code blob-code-inner js-file-line">            text: command.replace(/\//g, '#').replace(/_/g, ' '),</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L110" class="blob-num js-line-number" data-line-number="110"></td>
        <td id="file-telegram_bot-LC110" class="blob-code blob-code-inner js-file-line">            id: chat_id,</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L111" class="blob-num js-line-number" data-line-number="111"></td>
        <td id="file-telegram_bot-LC111" class="blob-code blob-code-inner js-file-line">            user: user</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L112" class="blob-num js-line-number" data-line-number="112"></td>
        <td id="file-telegram_bot-LC112" class="blob-code blob-code-inner js-file-line">        }, function (response) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L113" class="blob-num js-line-number" data-line-number="113"></td>
        <td id="file-telegram_bot-LC113" class="blob-code blob-code-inner js-file-line">            if (response &amp;&amp; response.response) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L114" class="blob-num js-line-number" data-line-number="114"></td>
        <td id="file-telegram_bot-LC114" class="blob-code blob-code-inner js-file-line">                sendTo('telegram.0', {user: user, text: response.response});</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L115" class="blob-num js-line-number" data-line-number="115"></td>
        <td id="file-telegram_bot-LC115" class="blob-code blob-code-inner js-file-line">            }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L116" class="blob-num js-line-number" data-line-number="116"></td>
        <td id="file-telegram_bot-LC116" class="blob-code blob-code-inner js-file-line">        });</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L117" class="blob-num js-line-number" data-line-number="117"></td>
        <td id="file-telegram_bot-LC117" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L118" class="blob-num js-line-number" data-line-number="118"></td>
        <td id="file-telegram_bot-LC118" class="blob-code blob-code-inner js-file-line">});</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L119" class="blob-num js-line-number" data-line-number="119"></td>
        <td id="file-telegram_bot-LC119" class="blob-code blob-code-inner js-file-line">//   ,   </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L120" class="blob-num js-line-number" data-line-number="120"></td>
        <td id="file-telegram_bot-LC120" class="blob-code blob-code-inner js-file-line">on({id: /^mqtt\.0\.PLC55_Lighting\.lighting\..*$/, ack: true, change: 'ne'}, function (obj) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L121" class="blob-num js-line-number" data-line-number="121"></td>
        <td id="file-telegram_bot-LC121" class="blob-code blob-code-inner js-file-line">    sendLightMenu(" ");</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L122" class="blob-num js-line-number" data-line-number="122"></td>
        <td id="file-telegram_bot-LC122" class="blob-code blob-code-inner js-file-line">});</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L123" class="blob-num js-line-number" data-line-number="123"></td>
        <td id="file-telegram_bot-LC123" class="blob-code blob-code-inner js-file-line">//       </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L124" class="blob-num js-line-number" data-line-number="124"></td>
        <td id="file-telegram_bot-LC124" class="blob-code blob-code-inner js-file-line">sendLightMenu("");</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="" style="float:right">view raw</a>
        <a href="">telegram_bot</a>
        hosted with ❤ by <a href="">GitHub</a>
      </div>
    </div>
</div>
</div><br><br>  Das Ergebnis sollte ungefähr so ​​aussehen: <br><br><img src="https://habrastorage.org/webt/wm/kw/dj/wmkwdjedebx86h6ujqutsik93sa.png"><br><br><h4>  Fazit </h4><br>  Der Artikel hat sich als lang herausgestellt, aber ich hoffe, er ist nützlich und erleichtert möglicherweise einigen Benutzern das Leben oder ermutigt jemanden, sein eigenes Smart Home zu erstellen. <br>  Im Moment dreht sich mein ioBroker-basiertes Smart-Home-System seit 4 Jahren und ich bin sehr zufrieden damit.  Neben ZigBee sind mehrere hausgemachte Steuerungen über MQTT und HTTP angeschlossen, um Beleuchtung, Lüftung und andere Systeme, ein Netzwerk von Temperatursensoren am 1-Draht-Bus, ein Netzteilüberwachungsgerät am RS485-Bus und das Modbus-RTU-Protokoll und vieles mehr zu steuern. <br><br>  In meinem Sparschwein mit Lösungen für ein Smart Home habe ich viele Ideen gesammelt, obwohl sie wahrscheinlich eher als Sparschwein der Probleme für ein Smart Home wahrgenommen werden sollten (diejenigen, die das Thema verstehen, was ich meine).  Hinterlassen Sie Ihre Wünsche in den Kommentaren, damit ich mich für das Thema des nächsten Artikels entscheiden kann. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de433340/">https://habr.com/ru/post/de433340/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de433330/index.html">Lösen Sie japanische Kreuzworträtsel mit SAT Solver</a></li>
<li><a href="../de433332/index.html">Python-Unterstützung in Azure-Funktionen</a></li>
<li><a href="../de433334/index.html">XAML Behaviors for WPF ist jetzt Open Source</a></li>
<li><a href="../de433336/index.html">Die Implementierung der babylonischen Bibliothek</a></li>
<li><a href="../de433338/index.html">Creality 3D-Drucker Herstellerübersicht</a></li>
<li><a href="../de433342/index.html">Ein weiterer einfacher Verilog-Prozessor</a></li>
<li><a href="../de433344/index.html">Zwei Erfolge des privaten Raums</a></li>
<li><a href="../de433346/index.html">Wechsel von Redshift zu ClickHouse</a></li>
<li><a href="../de433348/index.html">Typisiertes DSL in TypeScript von JSX</a></li>
<li><a href="../de433350/index.html">Digitale Veranstaltungen in Moskau vom 17. bis 23. Dezember</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>