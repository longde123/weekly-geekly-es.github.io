<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤳🏼 🎛️ 👩🏿‍🎨 Fichiers proxy d'AWS S3 utilisant nginx 👨‍👨‍👧‍👦 😂 👨🏻‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il semblerait que la tâche d'implémenter le frontend pour AWS sur nginx ressemble à un cas typique pour StackOverflow - après tout, il ne peut y avoir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fichiers proxy d'AWS S3 utilisant nginx</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/426739/">  Il semblerait que la tâche d'implémenter le frontend pour AWS sur nginx ressemble à un cas typique pour StackOverflow - après tout, il ne peut y avoir aucun problème avec les fichiers proxy de S3?  En fait, il s'est avéré qu'une solution toute faite n'est pas si facile à trouver, et cet article devrait corriger cette situation. <br><br><img src="https://habrastorage.org/webt/na/rw/np/narwnpom7q_0ddhmxxalre-etq0.png"><br><br><h2>  Pourquoi auriez-vous même besoin de ça? </h2><br><ol><li>  Contrôlez l'accès aux fichiers à l'aide de nginx - pertinent pour le concept d'IaC (infrastructure en tant que code).  Toutes les <b>modifications</b> liées à l'accès seront effectuées <b>uniquement dans les configurations</b> présentes dans le projet. </li><li>  Si vous donnez des fichiers via votre nginx, vous pouvez les <b>mettre</b> en <b>cache</b> et enregistrer sur les demandes à S3. </li><li>  Un tel proxy aidera à <b>ignorer le type de stockage de</b> fichiers pour différentes installations d'application (après tout, il existe d'autres solutions que S3). </li></ol><a name="habracut"></a><br><h2>  Nous formulons le cadre </h2><br><ul><li>  Le compartiment source doit être <b>privé</b> - vous ne pouvez pas autoriser des utilisateurs anonymes à télécharger des fichiers directement depuis S3.  Si dans votre cas, cette restriction ne fonctionne pas, utilisez simplement <code>proxy_pass</code> et vous ne pourrez plus lire. </li><li>  Le réglage par AWS doit être ponctuel sur une base «réglé et oublié» pour simplifier le fonctionnement. </li></ul><br><h2>  Nous recherchons une solution dans le front </h2><br>  Si votre compartiment d'origine est public, aucune difficulté ne vous menace, les demandes de proxy pour S3 et tout fonctionneront.  S'il est privé, vous devrez vous authentifier avec S3 d'une manière ou d'une autre.  Que nous offrent les collègues d'Internet: <br><br><ol><li>  Il existe des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemples d'</a> implémentation du protocole d'authentification à l'aide de nginx.  La solution est bonne, mais malheureusement, elle est conçue pour un protocole d'authentification obsolète ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Signature v2</a> ), qui ne fonctionne pas dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">certains centres de données Amazon</a> .  Si vous essayez d'utiliser cette solution, par exemple à Francfort, vous obtiendrez l'erreur <i>"Le mécanisme d'autorisation que vous avez fourni n'est pas pris en charge.</i>  <i>Veuillez utiliser AWS4-HMAC-SHA256</i> . <i>"</i>  Une version plus récente du protocole ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Signature v4</a> ) est beaucoup plus difficile à implémenter, mais il n'y a pas de solutions prêtes à l'emploi pour nginx. </li><li>  Il existe un module tiers pour nginx - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ngx_aws_auth</a> .  À en juger par la source, il prend en charge Signature v4.  Cependant, le projet semble abandonné: depuis plus d'un an, il n'y a eu aucun changement dans la base de code, et il y a aussi un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">problème de compatibilité</a> avec d'autres modules auxquels le développeur ne répond pas.  De plus, l'ajout de modules supplémentaires à nginx est souvent une étape douloureuse en soi. </li><li>  Vous pouvez utiliser un proxy s3 distinct, dont beaucoup ont été écrits.  Personnellement, j'ai aimé la solution Go - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aws-s3-proxy</a> : elle a une image prête à l'emploi et assez populaire sur DockerHub.  Mais dans ce cas, l'application va acquérir un autre composant avec ses problèmes potentiels. </li></ol><br><h2>  Appliquer la stratégie de compartiment AWS </h2><br>  AWS, en règle générale, fait peur aux nouveaux utilisateurs avec sa complexité et son volume de documentation.  Mais si vous regardez, vous comprenez qu'il est conçu de manière très logique et flexible.  Amazon a également trouvé une solution pour notre tâche - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>S3 Bucket Policy</b></a> .  Ce mécanisme vous permet de créer des règles d'autorisation flexibles pour le compartiment en fonction de différents paramètres du client ou de la demande. <br><br><img src="https://habrastorage.org/webt/6z/od/z5/6zodz56egbxlcukk3cx_wostoqg.png"><br>  <i>Interface du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">générateur de stratégie</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AWS Policy Generator</a></i> <br><br>  Voici quelques options intéressantes auxquelles vous pouvez vous lier: <br><br><ul><li>  IP ( <code>aws:SourceIp</code> ), </li><li>  En-tête de référent ( <code>aws:Referer</code> ), </li><li>  En-tête User-Agent ( <code>aws:UserAgent</code> ), </li><li>  le reste est décrit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . </li></ul><br>  La liaison IP n'est une bonne option que si l'application a un certain lieu de résidence, et à notre époque, elle est rare.  En conséquence, vous devez vous attacher à autre chose.  Comme solution, je propose de <b>générer un User-Agent ou Referer secret</b> et de ne donner des fichiers qu'aux utilisateurs qui connaissent l'en-tête secret.  Voici à quoi ressemble une politique similaire: <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"Version"</span></span>: <span class="hljs-string"><span class="hljs-string">"2012-10-17"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Id"</span></span>: <span class="hljs-string"><span class="hljs-string">"http custom auth secret"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Statement"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"Sid"</span></span>: <span class="hljs-string"><span class="hljs-string">"Allow requests with my secret."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Effect"</span></span>: <span class="hljs-string"><span class="hljs-string">"Allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Principal"</span></span>: <span class="hljs-string"><span class="hljs-string">"*"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Action"</span></span>: <span class="hljs-string"><span class="hljs-string">"s3:GetObject"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Resource"</span></span>: <span class="hljs-string"><span class="hljs-string">"arn:aws:s3:::example-bucket-for-habr/*"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Condition"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"StringLike"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"aws:UserAgent"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"xxxyyyzzz"</span></span> ] } } } ] }</code> </pre> <br>  Une petite explication: <br><br><ul><li>  <code>"Version": "2012-10-17"</code> est la cuisine AWS interne que vous n'avez pas besoin de modifier; </li><li>  <code>Principal</code> - qui est concerné par cette règle.  Vous pouvez indiquer que cela ne fonctionne que pour un compte AWS spécifique, mais dans notre cas, cela coûte <code>"*"</code> - cela signifie que la règle fonctionne pour tout le monde, y compris les utilisateurs anonymes; </li><li>  <code>Resource</code> - compartiment ARN (Amazon Resource Name) et modèle pour les fichiers à l'intérieur du compartiment.  Dans notre cas, la stratégie s'applique à tous les fichiers qui se trouvent dans le <code>example-bucket-for-habr</code> ; </li><li>  <code>Condition</code> - voici les conditions qui doivent converger pour que la politique fonctionne.  Dans notre cas, nous comparons l'en-tête prédéfini de l'agent utilisateur avec la ligne <code>xxxyyyzzz</code> . </li></ul><br>  Et voici à quoi ressemble le travail de cette règle du point de vue d'un utilisateur anonyme: <br><br><pre> <code class="bash hljs">$ curl -I https://s3.eu-central-1.amazonaws.com/example-bucket-for-habr/hello.txt HTTP/1.1 403 Forbidden $ curl -I https://s3.eu-central-1.amazonaws.com/example-bucket-for-habr/hello.txt -H <span class="hljs-string"><span class="hljs-string">'User-Agent: xxxyyyzzz'</span></span> HTTP/1.1 200 OK</code> </pre> <br>  Il reste à <b>configurer nginx</b> pour le proxy: <br><br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /s3-media/ { <span class="hljs-attribute"><span class="hljs-attribute">limit_except</span></span> GET { <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; } <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$aws_bucket</span></span> <span class="hljs-string"><span class="hljs-string">"example-bucket-for-habr"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$aws_endpoint</span></span> <span class="hljs-string"><span class="hljs-string">"s3.eu-central-1.amazonaws.com:443"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$aws_custom_secret</span></span> <span class="hljs-string"><span class="hljs-string">"xxxyyyzzz"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> User-Agent <span class="hljs-variable"><span class="hljs-variable">$aws_custom_secret</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^/s3-media/(.*)$</span></span> /<span class="hljs-variable"><span class="hljs-variable">$aws_bucket</span></span>/<span class="hljs-variable"><span class="hljs-variable">$1</span></span> <span class="hljs-literal"><span class="hljs-literal">break</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_buffering</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> https://<span class="hljs-variable"><span class="hljs-variable">$aws_endpoint</span></span>; }</code> </pre> <br><h2>  Conclusion </h2><br>  Au total, une fois que nous avons écrit une politique simple pour le bucket, nous avons eu l'opportunité de proxy en toute sécurité des fichiers en utilisant nginx.  Cependant, nous ne sommes pas liés par IP et ne dépendons pas de logiciels supplémentaires. <br><br><h2>  PS </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Awless - un puissant utilitaire CLI alternatif pour travailler avec les services AWS</a> »; </li><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rook est un entrepôt de données« libre-service »pour Kubernetes</a> »; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Théorie et pratique des sauvegardes avec Borg</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426739/">https://habr.com/ru/post/fr426739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426729/index.html">École de magie TypeScript: génériques et extension de type</a></li>
<li><a href="../fr426731/index.html">CSS: caractéristiques intéressantes de border-radius</a></li>
<li><a href="../fr426733/index.html">Le fer n'échouera pas. Comment je prépare des dizaines de serveurs par jour pour la bataille</a></li>
<li><a href="../fr426735/index.html">Bienvenue au JETHACK Hackathon</a></li>
<li><a href="../fr426737/index.html">En bref sur l'architecture des processeurs neuromorphiques: un regard intérieur</a></li>
<li><a href="../fr426741/index.html">Un mémo pour ceux qui envisagent de recruter des stagiaires pour la première fois</a></li>
<li><a href="../fr426743/index.html">Les façons d'utiliser la blockchain ont tourné ailleurs. Sony annonce un système DRM basé sur la blockchain</a></li>
<li><a href="../fr426745/index.html">PostgreSQL 11 est sorti</a></li>
<li><a href="../fr426747/index.html">En 2018, les développeurs du projet KDE ont reçu plus de 0,5 million de dollars en dons. Et pas seulement eux ...</a></li>
<li><a href="../fr426749/index.html">Déménagement à Londres avec sa femme et ses chiens. Histoire d'un développeur mobile</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>