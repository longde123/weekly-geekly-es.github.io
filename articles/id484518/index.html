<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôçüèΩ üéµ üòπ Kami mendapatkan video dari kamera melalui DVRIP menggunakan PHP üòâ üöÅ üßúüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam artikel sebelumnya, saya berjanji untuk menunjukkan skrip yang menarik video dari kamera dan, meskipun beberapa waktu telah berlalu sejak itu, j...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kami mendapatkan video dari kamera melalui DVRIP menggunakan PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484518/"> Dalam <a href="https://habr.com/ru/post/482864/">artikel sebelumnya,</a> saya berjanji untuk menunjukkan skrip yang menarik video dari kamera dan, meskipun beberapa waktu telah berlalu sejak itu, janji-janji itu harus dipenuhi.  Jadi saya melakukannya. <br><br>  Kebetulan bahwa dengan asynchrony di dunia web server semuanya terkait, tetapi tidak PHP. <br><br>  Nah, karena, Anda tahu, model yang sekarat ini, kebocoran memori, dan memang tidak ada yang keluar dari kotak di PHP kecuali <a href="https://www.php.net/manual/ru/function.stream-select.php">stream_select ()</a> dan <a href="https://www.php.net/manual/ru/function.stream-select.php">stream_set_blocking ()</a> . <br><br>  Di suatu tempat di sana, di PECL, ada semacam <a href="https://pecl.php.net/package/uv">libuv</a> , yang, pada prinsipnya, hanyalah pembungkus untuk fungsi asli dari perpustakaan asli, jadi menggunakannya seperti itu memberi Anda beberapa tantangan.  Lagi pula, siapa yang waras yang akan melakukan ini? <br><br>  Tetapi jika kita berhenti hidup di dunia PHP4 dan kembali ke realitas modern sedikit, kita akan melihat bahwa beberapa hal telah berubah dalam beberapa tahun terakhir.  Kami memiliki alat yang menarik seperti <b>ReactPHP</b> dan <b>AmPHP</b> , yang komponennya mencakup fungsionalitas Node.js dengan baik, dan keberadaan generator memungkinkan kami untuk menulis kode asinkron dengan gaya yang nyaman, seperti <i>async / menunggu</i> , menghindari semua panggilan balik tanpa akhir ini dalam panggilan balik dan rantai kilometer <i>. ). kemudian ()</i> . <i>lalu ()</i> . <br><br>  Jadi itu sebabnya sekarang, menurut saya, praktis tidak ada tugas dari dunia Node.js yang tidak bisa diselesaikan oleh PHP.  Tetapi jika masih ada beberapa, maka semuanya hanya tergantung pada kehadiran beberapa perpustakaan terpisah, dan bukan kurangnya kesempatan seperti itu. <br><blockquote>  Mungkin mengejutkan orang untuk mengetahui bahwa perpustakaan standar PHP sudah memiliki semua yang kita butuhkan untuk menulis aplikasi yang digerakkan oleh peristiwa dan non-pemblokiran.  Kami hanya mencapai batas fungsionalitas PHP asli di area ini ketika kami memintanya untuk mensurvei ribuan deskriptor file untuk aktivitas IO secara bersamaan.  Meskipun dalam kasus ini, kesalahannya bukan pada PHP tetapi sistem yang mendasari pilih () panggilan yang linier dalam penurunan kinerjanya seiring dengan meningkatnya beban. <br><br>  <i><a href="https://amphp.org/amp/event-loop/">amphp.org/amp/event-loop</a></i> </blockquote><a name="habracut"></a><br>  Tentu saja, pertanyaan menggunakan ini semua dalam produksi belum sepenuhnya ditutup, tetapi jika Anda tidak sengaja salah hal bahwa lingkungan runtime asinkron lainnya tidak akan memaafkan Anda, maka semuanya akan baik-baik saja. <br><br><h3>  DVRIP </h3><br>  Kami akan mempertimbangkan protokol, yang konon ditemukan oleh orang Cina, yang digunakan untuk berkomunikasi perangkat lunak dengan kamera pengintai. <br><br>  Semuanya bekerja di atas TCP, disebut DVRIP (kadang-kadang Sofia), dan pada saat saya membutuhkannya, saya hanya menemukan dua perpustakaan yang lebih atau kurang waras, salah satunya dijelaskan secara umum hanya menghubungkan ke kamera dan bertukar beberapa pesan, tetapi memiliki deskripsi header paket yang banyak membantu saya. <br><br>  Yang kedua ditemukan sedikit kemudian, pada saat eksaserbasi sindrom saya tidak ditemukan di sini, dan itu bekerja sedikit berbeda dari yang saya inginkan. <br><br>  Secara umum, dipersenjatai dengan sniffer dan deskripsi header paket, saya secara singkat membuat sketsa skrip tertentu yang berputar di suatu tempat di server saya di suatu tempat, dan akan disajikan dalam bukti konsep tertentu dalam artikel ini. <br><br>  Protokol itu sendiri tidak kompleks dan paketnya terlihat seperti ini: <br><br><ul><li>  header 20 byte, yang dalam PHP dapat ditunjuk sebagai <br><br><pre><code class="php hljs">unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, $buffer)</code> </pre> </li><li>  header diikuti oleh pesan len panjang dan dapat berisi json, ditambah dengan dua byte \ x0a \ x00, atau data biner. </li></ul><br>  Kami hanya akan mengirimkan json, tetapi kami akan menerima keduanya. <br><br>  Jawabannya (jika itu adalah paket dengan json) biasanya berisi bidang <b>Ret yang</b> menunjukkan keberhasilan permintaan kami.  Respons yang berisi kode <b>Ret</b> yang tidak sama dengan <b>100</b> atau <b>515</b> akan dianggap sengaja salah. <br><br>  Berbekal pengetahuan dasar ini, mari kita terhubung ke kamera dan mengerti. <br>  Kita membutuhkan dua perpustakaan - <a href="https://github.com/amphp/socket">amphp / socket</a> , yang akan <a href="https://github.com/amphp/socket">menarik</a> hampir semua yang kita butuhkan, dan <a href="https://packagist.org/packages/evenement/evenement">evenement / evenement</a> , yang tersedia dalam kemasan dan tidak memerlukan ekstensi. <br><br>  Bekerja dengan TCP di Amp terlihat seperti ini: <br><br><pre> <code class="php hljs">Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">"tcp://{$addr}:{$port}"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write(<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($chunk = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read()) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $chunk; } $socket-&gt;close(); });</code> </pre> <br>  DVRIP biasanya berjalan pada port 34567, jadi dalam kasus kami akan menjadi seperti ini: <br><br><pre> <code class="php hljs">$socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://192.168.0.200:34567'</span></span>);</code> </pre> <br>  Selanjutnya, kami masuk dengan mengirimkan hash nama pengguna dan kata sandi kami ke kamera, yang dihitung sebagai berikut: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); }</code> </pre> <br>  Jika otorisasi berhasil, kami meminta video dan, jika kamera dapat memberikannya kepada kami, maka kami mulai mentransmisikannya. <br><br>  Setiap jenis paket memiliki pesan tersendiri, sehingga kami dapat memahami permintaan apa yang kami terima jawabannya.  Secara umum, bukan pekerjaan yang berdebu. <br><br>  Untuk kenyamanan, mari kita jelaskan kelas untuk paket kami: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } }</code> </pre> <br>  dan mencoba mengirim permintaan otorisasi <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'admin'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ]));</code> </pre> <br>  Ya bagus  Kami terhubung dan mengirim pesan, tetapi kami bahkan tidak tahu apakah kamera itu benar dan bereaksi setidaknya.  Kita perlu entah bagaimana membaca jawabannya (mari kita lakukan secara serempak), pilih paket tertentu di dalamnya dan dekode mereka. <br><br>  Untuk memisahkan logika pemrosesan paket yang datang sebagai tanggapan, saya memutuskan untuk menggunakan perpustakaan <b>evenement</b> dan membuat sketsa kelas berdasarkannya yang akan membuang paket-paket yang sudah didekodekan <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br>  dan juga menambahkan beberapa metode statis ke kelas Paket kami, yang, pada kenyataannya, akan mengekstrak dan mendekode paket dari aliran data <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; }</code> </pre><br>  Sekarang, melalui penggunaan <b>Evenement</b> , kita dapat menggambarkan logika kita dalam bentuk <br><br><pre> <code class="php hljs">$reader-&gt;on($packetType, $handler);</code> </pre> <br>  Dan jadi saya mendapatkan rantai ini, di mana saya menambahkan pemrosesan Keep Alive dan SIGINT / SIGTERM lainnya: <br><br><pre> <code class="php hljs">$reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout());</code> </pre> <br>  Tak perlu dikatakan bahwa alih-alih stdout, kita dapat mengarahkan aliran video ke mana pun kita inginkan. <br><br><div class="spoiler">  <b class="spoiler_title">Naskah akhir</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> ini_set(<span class="hljs-string"><span class="hljs-string">'display_errors'</span></span>, <span class="hljs-string"><span class="hljs-string">'stderr'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Emitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Loop</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Promise</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">InputStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">IteratorStream</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Evenement</span></span>\<span class="hljs-title"><span class="hljs-title">EventEmitter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">call</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCall</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">asyncCoroutine</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStderr</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">getStdout</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">ByteStream</span></span>\<span class="hljs-title"><span class="hljs-title">pipe</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">function</span></span> <span class="hljs-title"><span class="hljs-title">Amp</span></span>\<span class="hljs-title"><span class="hljs-title">Socket</span></span>\<span class="hljs-title"><span class="hljs-title">connect</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'vendor/autoload.php'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofiaHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $password)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $md5 = md5($password, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, array_map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($i)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($md5)</span></span></span><span class="hljs-function"> </span></span>{ $c = (ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i]) + ord($md5[<span class="hljs-number"><span class="hljs-number">2</span></span> * $i + <span class="hljs-number"><span class="hljs-number">1</span></span>])) % <span class="hljs-number"><span class="hljs-number">62</span></span>; $c += $c &gt; <span class="hljs-number"><span class="hljs-number">9</span></span> ? ($c &gt; <span class="hljs-number"><span class="hljs-number">35</span></span> ? <span class="hljs-number"><span class="hljs-number">61</span></span> : <span class="hljs-number"><span class="hljs-number">55</span></span>) : <span class="hljs-number"><span class="hljs-number">48</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> chr($c); }, range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>))); } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventEmitter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> InputStream $socket; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket = $socket; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket-&gt;isClosed() &amp;&amp; $result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> Packet::read(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;socket, $buffer)) { [$packet, $chunk] = $result; $buffer = $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit(<span class="hljs-string"><span class="hljs-string">'packet'</span></span>, [$packet]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;emit($packet-&gt;getMessageType(), [$packet]); } $buffer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Packet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SUCCESS_CODES = [<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">515</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MESSAGE_CODES = [ <span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1006</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1413</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1001</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.keepAlive'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1007</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1414</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1410</span></span>, <span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1412</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InputStream $socket, string $buffer = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Promise</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $buffer)</span></span></span><span class="hljs-function"> </span></span>{ $header = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>) { $header = unpack(<span class="hljs-string"><span class="hljs-string">'Chead/Cversion/x2/IsessionId/Isequence/x2/SmsgId/Ilen'</span></span>, substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>)); $buffer = substr($buffer, <span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($header !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; strlen($buffer) &gt;= (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::fromRaw($header, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? substr($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>), substr($buffer, (int) $header[<span class="hljs-string"><span class="hljs-string">'len'</span></span>]) ]; } $buffer .= <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;read(); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!$socket-&gt;isClosed()); }); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fromRaw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $header, ?string $rawData)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function"> </span></span>{ $packet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>($header[<span class="hljs-string"><span class="hljs-string">'msgId'</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $header[<span class="hljs-string"><span class="hljs-string">'sequence'</span></span>], $header[<span class="hljs-string"><span class="hljs-string">'sessionId'</span></span>]); $packet-&gt;rawData = $rawData; $packet-&gt;data = (int) $packet-&gt;msgId === <span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>] || $rawData === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : json_decode(substr($rawData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>, JSON_THROW_ON_ERROR); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $packet; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $head = <span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $version = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sessionId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $sequence; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> int $msgId; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?string $rawData; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ?<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $msgId, ?array $data = null, int $sequence = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, int $sessionId = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId = $msgId; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence = $sequence; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId = $sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData = json_encode(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data, JSON_THROW_ON_ERROR) . <span class="hljs-string"><span class="hljs-string">"\x0a\x00"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pack(<span class="hljs-string"><span class="hljs-string">'CCx2IIx2SI'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;head, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;version, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId, strlen(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData)) . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRawData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : ?</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;rawData; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSession</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sessionId; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;sequence; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMessageType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $types = array_flip(<span class="hljs-keyword"><span class="hljs-keyword">static</span></span>::MESSAGE_CODES); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Unknown message type: '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $types[<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;msgId]; } } Loop::run(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> : \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader($socket = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> connect(<span class="hljs-string"><span class="hljs-string">'tcp://10.0.5.100:49152'</span></span>)); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>]) || !in_array($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'Ret'</span></span>], Packet::SUCCESS_CODES)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong login data'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.claim'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Claim'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.response.login'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ Loop::unreference(Loop::repeat($packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'AliveInterval'</span></span>] * <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($watcherId)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($socket-&gt;getResource() === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Loop::cancel($watcherId); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.keepAlive'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'KeepAlive'</span></span>, <span class="hljs-string"><span class="hljs-string">'SessionID'</span></span> =&gt; $packet-&gt;getData()[<span class="hljs-string"><span class="hljs-string">'SessionID'</span></span>] ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); })); }); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.response.claim'</span></span>, asyncCoroutine(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], $packet-&gt;getSequence() + <span class="hljs-number"><span class="hljs-number">1</span></span>, $packet-&gt;getSession())); })); $emitter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Emitter(); $reader-&gt;on(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($emitter)</span></span></span><span class="hljs-function"> </span></span>{ $emitter-&gt;emit($packet-&gt;getRawData()); }); $reader-&gt;once(<span class="hljs-string"><span class="hljs-string">'packet.binary'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet $packet)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket)</span></span></span><span class="hljs-function"> </span></span>{ $signalHandler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($socket, $packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.videoControl'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'Name'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span>, <span class="hljs-string"><span class="hljs-string">'OPMonitor'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Action'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Stop'</span></span>, <span class="hljs-string"><span class="hljs-string">'Parameter'</span></span> =&gt; [<span class="hljs-string"><span class="hljs-string">'Channel'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'CombinMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'NONE'</span></span>, <span class="hljs-string"><span class="hljs-string">'StreamType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'TransMode'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'TCP'</span></span>]], ], <span class="hljs-number"><span class="hljs-number">0</span></span>, $packet-&gt;getSession())); $socket-&gt;close(); }; Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>) ? SIGINT : <span class="hljs-number"><span class="hljs-number">2</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGINT'</span></span>)); Loop::unreference(Loop::onSignal(defined(<span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>) ? SIGTERM : <span class="hljs-number"><span class="hljs-number">15</span></span>, $signalHandler, <span class="hljs-string"><span class="hljs-string">'SIGTERM'</span></span>)); }); asyncCall([$reader, <span class="hljs-string"><span class="hljs-string">'start'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $socket-&gt;write((string) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Packet(Packet::MESSAGE_CODES[<span class="hljs-string"><span class="hljs-string">'packet.request.login'</span></span>], [ <span class="hljs-string"><span class="hljs-string">'EncryptType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'MD5'</span></span>, <span class="hljs-string"><span class="hljs-string">'LoginType'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'DVRIP-Web'</span></span>, <span class="hljs-string"><span class="hljs-string">'PassWord'</span></span> =&gt; sofiaHash(<span class="hljs-string"><span class="hljs-string">'123qwea'</span></span>), <span class="hljs-string"><span class="hljs-string">'UserName'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'admin'</span></span>, ])); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pipe(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IteratorStream($emitter-&gt;iterate()), getStdout()); });</code> </pre> </div></div><br>  Sekarang kita dapat mencoba merekam video dengan cara ini <br><br><pre> <code class="bash hljs">$ php recorder.php &gt; output.h264</code> </pre> <br>  Kami menambahkan pengendali SIGINT, jadi ketika Anda lelah, cukup tekan Ctrl + C dan script akan menghentikan transfer video dan menutup koneksi secara normal. <br><br>  Dan kita dapat, misalnya, mengarahkan aliran ke ffmpeg dan transcode dengan cepat. <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg -nostdin -y -hide_banner -loglevel verbose -f h264 -i pipe:0 -pix_fmt yuv420p -c copy -movflags +frag_keyframe+empty_moov+default_base_moof -reset_timestamps 1 -f mpegts output.mpegts</code> </pre> <br>  Dan Anda bisa membuat rantai bentuk panik <br><br><pre> <code class="bash hljs">$ php recorder.php | ffmpeg ... | curl -d @- ...</code> </pre> <br>  meluncurkan semua ini dengan semacam skrip yang akan dimulai kembali setiap jam, jadi kami mendapatkan potongan halus yang berlangsung 1 jam, dengan cepat, di mana pun kami butuhkan. <br><br><h3>  Mengapa </h3><br>  Saya cenderung percaya bahwa artikel ini akan menimbulkan pertanyaan "Mengapa?"  Ada solusi siap pakai untuk pendaftaran dari kamera, kamera pada umumnya dapat melakukan banyak hal sendiri, karena mereka benar keberatan dalam komentar pada artikel sebelumnya, dan secara umum itu bisa dibuat lebih mudah. <br><br>  Hanya saja saya punya waktu luang yang harus saya lakukan di suatu tempat, keinginan untuk membuat jalan sendiri dan keinginan yang tak kenal lelah untuk eksperimen. <br><br>  Dan itu berhasil. <br><br>  Tentu saja, skrip yang disajikan dalam artikel memerlukan beberapa modifikasi, dan Anda tidak boleh menggunakannya dalam bentuk ini - saya ulangi, ini adalah bukti konsep.  Dan secara umum, saya sangat memperingatkan Anda untuk menggunakan produk buatan rumah setinggi lutut untuk memastikan keamanan rumah Anda. <br>  Dalam kasus saya, keandalan tidak terlalu penting, jadi opsi ini akan berfungsi.  Seorang pengamat skrip memutar skrip ini, yang mentransfer aliran ke ffmpeg, merekam potongan per jam dan mengunggahnya ke VK, memulai kembali skrip jika terjadi pemutusan atau keadaan yang tidak terduga. <br><br>  Secara umum, semua ini bisa dihindari dengan hanya mengeluarkan video melalui RTSP melalui TCP, seperti yang saya sarankan di akhir artikel sebelumnya, tetapi ffmpeg suka menunda dengan bodoh pada saat acak dalam waktu dan mulai merespons hanya kepada SIGKILL. <br><br>  Saya mulai curiga bahwa semua ini karena arloji skrip induk dijalankan oleh mahkota dan menerima prioritas yang lebih rendah, tetapi meningkatkan prioritas hanya mengurangi frekuensi masalah. <br><br>  Dalam kasus skrip di atas, semuanya bekerja jauh lebih stabil dan belum mengajukan keluhan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id484518/">https://habr.com/ru/post/id484518/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id484502/index.html">Facebook memaksa moderator untuk mendokumentasikan jam kerja mereka hingga detik - bahkan pergi ke toilet</a></li>
<li><a href="../id484504/index.html">Membuat ionizer udara kurang dari $ 10</a></li>
<li><a href="../id484506/index.html">Saya seorang fotografer dan saya akan menjadikan diri saya alat yang berfungsi</a></li>
<li><a href="../id484512/index.html">TOP 25 ICO terbesar: ada apa dengan mereka sekarang?</a></li>
<li><a href="../id484514/index.html">Routing Universal untuk Aplikasi Bereaksi</a></li>
<li><a href="../id484520/index.html">Seperti apa bentuk arsip zip dan apa yang bisa kita lakukan dengannya. Bagian 3 - Aplikasi Praktis</a></li>
<li><a href="../id484522/index.html">Konferensi DEFCON 27. Peretasan polisi. Bagian 2</a></li>
<li><a href="../id484526/index.html">Mempersiapkan proyek SDL2 untuk dijalankan di android</a></li>
<li><a href="../id484528/index.html">Bagaimana saya memindahkan proyek hobi saya ke k8s</a></li>
<li><a href="../id484530/index.html">Mesin CNC untuk pemrosesan plasma / modifikasi bahan polimer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>