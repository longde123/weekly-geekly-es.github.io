<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ü üë®‚Äçüë®‚Äçüëß‚Äçüëß ü§üüèø Avec un bon microcontr√¥leur et le temps passe vite ou un oscilloscope de week-end üíáüèº üàÇÔ∏è üòø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, l'auteur de ces lignes a entrepris de d√©velopper un enregistreur compact d'un signal analogique unipolaire √† 3 volts avec la vit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Avec un bon microcontr√¥leur et le temps passe vite ou un oscilloscope de week-end</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468393/"><p>  Il y a quelque temps, l'auteur de ces lignes a entrepris de d√©velopper un enregistreur compact d'un signal analogique unipolaire √† 3 volts avec la vitesse de lecture la plus √©lev√©e possible et les co√ªts et les tailles les plus bas possibles.  Dans la liste des co√ªts les plus bas possibles, j'ai √©galement saisi mon mal de t√™te et choisi le bien connu STM32F303.  Je me souviens de cela, Cortex-M4 72 m√©gahertz d'une entreprise bien connue, avec des convertisseurs analogiques-num√©riques 12 bits, assez agiles (ADC ou ADC, comme vous le souhaitez) et avec une interface CAN √† bord. </p><br><p>  Ces petits registraires en ont demand√© plusieurs dizaines.  Et la pr√©sence d'un bo√Ætier de microcontr√¥leur √† 48 pieds a inspir√© l'espoir qu'il serait possible d'appeler ce lecteur compact.  L'interface CAN, avec laquelle j'avais d√©j√† de bonnes relations, m'a donn√© l'opportunit√© de combiner tout ce jazz de mani√®re assez pratique. </p><br><p>  La vitesse √† laquelle, finalement, tout a fonctionn√©, s'est av√©r√©e tout √† fait appropri√©e pour d√©clarer l'op√©rabilit√© de l'approche choisie.  Il a √©t√© possible de r√©aliser une √©tape d'√©chantillonnage d'une demi-microseconde.  Les maux de t√™te et l'assembleur ne pouvaient pas √™tre √©vit√©s, mais qui se souvient maintenant de cela? </p><br><p>  Cependant, certains s√©diments sont rest√©s.  L'id√©e est rest√©e qu'en termes de vitesse, tout n'a pas √©t√© √©limin√©. </p><br><p>  Et maintenant, la s√©rie STM32G4 est r√©cemment apparue avec une fr√©quence d'horloge allant jusqu'√† 170 m√©gahertz avec une option dans un petit bo√Ætier, et avec presque les m√™mes ADC rapides √† bord au nombre de cinq pi√®ces.  Il fallait faire quelque chose. </p><a name="habracut"></a><br><p>  Personne ne se tenait au-dessus de l'√¢me maintenant et il n'√©tait pas n√©cessaire de s'inqui√©ter des d√©lais et des plans. </p><br><p>  En effet, si vous n'y pensez pas, vous pouvez m√™me profiter du travail.  Mais, franchement, je devais penser au temps.  Penser longtemps √† peu de temps (et quoi, po√©tiquement). </p><br><p>  La pens√©e s'est sugg√©r√©e que nous devrions partir un peu de l'autre bout.  C'est-√†-dire que nous devons partir du temps d'√©chantillonnage ADC le plus court possible, qui, sur la base de la description, prend 2,5 cycles d'horloge et s'√©l√®ve √† 62,5 nanosecondes √† 40 MHz (160 MHz / 4).  Ensuite, l'√©tape d'√©chantillonnage de 100 nanosecondes se sugg√®re.  Le nombre est rond et, surtout, assez petit et beau, pourquoi ne pas l'essayer? </p><br><p>  De plus, la carte NUCLEO-G474RE adapt√©e aux exp√©riences est apparue en vente et a √©t√© achet√©e, √† laquelle il √©tait raisonnable d'ajouter une planche √† pain suppl√©mentaire avec deux connecteurs √† deux rang√©es pour souder toutes sortes de fils et de pi√®ces √† la planche √† pain et ne pas g√¢cher la principale.  Voici √† quoi cela ressemble pr√™t √† l'emploi. </p><br><p><img src="https://habrastorage.org/webt/kv/sx/k1/kvsxk19p26urrkufbil_6jmnm10.jpeg"></p><br><p>  L√†-bas, il y a plusieurs fils et une r√©sistance avec un condensateur, croyez-moi. </p><br><p>  Vous devez maintenant appliquer un signal √©lectrique appropri√© aux quatre ADC en m√™me temps, puis les ex√©cuter l'un apr√®s l'autre avec un pas constant (au d√©but, lors du d√©bogage, pas tr√®s court).  Pourquoi quatre?  Selon la description, chaque ADC passe 15 cycles d'horloge par conversion, soit 0,025 * 15 = 375 nanosecondes (pr√®s de 400).  Par cons√©quent, √† l'√©tape 100, un convoyeur de quatre ADC est requis. </p><br><p>  Un circuit RC √©tait utilis√© comme signal d'entr√©e, auquel la tension √©tait simplement fournie par le pied du contr√¥leur.  J'ai assign√© cette jambe pour contr√¥ler la minuterie TIM5 en mode impulsion unique. </p><br><p>  Le sch√©ma de c√¢blage minimum ressemblait √† l'image ci-dessous. </p><br><p><img src="https://habrastorage.org/webt/i1/xn/_u/i1xn_uykljjux10i1f3iv9fbcum.jpeg"></p><br><p>  ADC1-ADC4 √©taient impliqu√©s.  La profondeur de bits pourrait √™tre r√©duite pour une augmentation de la vitesse, mais 12 bits l'emportaient, car je ne voulais pas perdre la pr√©cision des mesures.  Pour d√©marrer chaque ADC dans l'ordre n√©cessaire et avec l'√©tape requise, trois temporisateurs sont utilis√©s (TIM2, TIM3, TIM4) et un autre temporisateur (TIM1) est utilis√© pour synchroniser les trois ci-dessus.  La figure 2 ci-dessous montre les signaux autour desquels tout est construit. </p><br><p><img src="https://habrastorage.org/webt/rm/j8/xj/rmj8xjehhvbc2gk5e-xt_jy8oi4.jpeg"></p><br><p>  Les fl√®ches vertes indiquent le bord des impulsions le long desquelles les convertisseurs ADC1-ADC4 respectifs sont d√©marr√©s. </p><br><p>  Pour obtenir les 100 nanosecondes pr√©vues, nous avons d√ª abaisser la fr√©quence d'horloge √† 160 m√©gahertz, afin que tout soit compl√®tement divis√© comme il se doit.  Au d√©but, l'√©tape a √©t√© r√©gl√©e beaucoup plus lentement, 4 microsecondes, pour v√©rifier calmement le fonctionnement des minuteries √† l'aide d'interruptions, de ports de sortie et d'un oscilloscope.  Puis, par interruption, il a √©t√© d√©bogu√© et a obtenu un acc√®s direct √† la m√©moire.  En fin de compte, une seule interruption est trait√©e - c'est l'interruption de la fin du travail √† partir du quatri√®me (dernier) canal d'acc√®s direct √† la m√©moire.  La figure ci-dessous montre les connexions des unit√©s mat√©rielles impliqu√©es dans le processus, ainsi que quatre tampons de m√©moire de sortie. </p><br><p><img src="https://habrastorage.org/webt/q-/y4/6k/q-y46k_9tzn2zrt4wnyycsssrtw.jpeg"></p><br><p>  Sur les quatre tampons de m√©moire (dans la figure de droite), les √©chantillons sont collect√©s par programme dans un seul tampon de r√©sultat. </p><br><p>  Dans ce contr√¥leur, contrairement au STM32F303, il existe une unit√© de commutation de demande (DMAMUX), qui vous permet de rediriger un grand nombre de demandes depuis des p√©riph√©riques vers seulement 16 canaux DMA1 et 16 canaux DMA2.  Dans le manuel de r√©f√©rence, les demandes de sortie DMAMUX sont compt√©es √† partir de 0, et les entr√©es des canaux des canaux DMA sont compt√©es √† partir de 1. Je ne l'ai pas chang√©, je l'ai laiss√© comme dans la source d'origine. </p><br><p>  Une minuterie TIM5 est utilis√©e comme g√©n√©rateur d'impulsions unique.  Il fournit un mode d'impulsion unique pratique.  La commodit√© r√©side dans la possibilit√© de r√©gler l'heure avant le d√©but de l'impulsion et de r√©gler la dur√©e de l'impulsion elle-m√™me.  Cette impulsion est sortie comme indiqu√© ci-dessous sur l'image, aimablement fournie par un oscilloscope lou√©. </p><br><p><img src="https://habrastorage.org/webt/ru/1-/c2/ru1-c2zutulhogxtlmnh92iriu4.jpeg"></p><br><p>  L'oscillogramme montre que la mont√©e de l'impulsion dure 10 microsecondes, ce qui signifie qu'elle devrait contenir environ 100 √©chantillons. </p><br><p>  Le projet a √©t√© fait manuellement dans IAR 8.4 (c'est-√†-dire sans Cuba et le ballon), mais, j'esp√®re, il sera compris par diverses confessions.  Vous pouvez le voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Voici une image du contenu d'un tampon ADC1 s√©par√© et le r√©sultat collect√© √† partir de quatre sources du tampon dans la r√©gion du d√©but de l'impulsion d'entr√©e. </p><br><p><img src="https://habrastorage.org/webt/pz/fh/f-/pzfhf-eknlnmmpdq5gzhg9ii5lo.jpeg"></p><br><p>  Mais le contenu de ces tampons se situe dans la r√©gion du pic d'impulsion (o√π la valeur atteint 2508). </p><br><p><img src="https://habrastorage.org/webt/a6/_1/_f/a6_1_fbgckavkbfmj6xaz9pff9m.jpeg"></p><br><p>  Comme vous pouvez le voir, 196-95 = 101 comptages ont √©t√© d√©pens√©s sur la section depuis le d√©but de l'impulsion jusqu'√† son pic. </p><br><p>  Le taux d'√©chantillonnage est donc de 10 m√©gahertz.  Cela n'a pas fonctionn√© √† cette vitesse tout de suite. </p><br><p>  Pour ce faire, j'ai d√ª arr√™ter le processeur avant de d√©marrer l'acc√®s direct √† la m√©moire (DMA1).  Il est bon que le Cortex-M4 dispose d'une instruction d'assemblage sp√©ciale <strong>WFI</strong> (Wait for interruptions).  Si cela n'est pas fait, le processeur se mettra sous les pieds du DMA et occupera le bus avec des acc√®s m√©moire qui pourraient bien attendre. </p><br><p>  Si vous augmentez l'√©tape de comptage √† 200 nanosecondes, ils cesseront de pousser et gu√©riront paisiblement et joyeusement. </p><br><p>  Si nous impliquons le comparateur COMP4 dans son travail et connectons son entr√©e positive (port PB0) au signal d'entr√©e, puis utilisons le DAC (DAC1) et connectons sa sortie (CH1) √† l'entr√©e n√©gative du comparateur (√† l'int√©rieur du contr√¥leur), nous obtenons un dispositif de seuil avec un seuil r√©glable.  Des interruptions du fonctionnement du comparateur vous permettront de d√©marrer la minuterie d'horloge g√©n√©rale TIM1 et d'obtenir un mode veille, comme dans un oscilloscope. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468393/">https://habr.com/ru/post/fr468393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468381/index.html">Retour vers le futur? Eraser Quantum en attente</a></li>
<li><a href="../fr468383/index.html">G√©n√©rateur de m√®mes Ruby pour attirer l'int√©r√™t pour la langue</a></li>
<li><a href="../fr468385/index.html">Le bureau est mort, vive le bureau! Je collectionne habrastatistiki</a></li>
<li><a href="../fr468387/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 316 (du 16 au 22 septembre)</a></li>
<li><a href="../fr468389/index.html">Artyom Galonsky, Bureau de la STO du Bureau: ¬´Je suis contre une chose telle qu'un ing√©nieur DevOps¬ª</a></li>
<li><a href="../fr468395/index.html">Surveillance de la s√©curit√© du cloud. 2e partie</a></li>
<li><a href="../fr468397/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 477 (09/03/2019 - 09.09.2019)</a></li>
<li><a href="../fr468399/index.html">C / C ++. Comment utiliser les ressources d'application int√©gr√©es lorsque vous travaillez dans GCC sous Linux</a></li>
<li><a href="../fr468401/index.html">Mani√®re s√©curis√©e d'√©changer JWT dans ASP.NET Core + SPA</a></li>
<li><a href="../fr468403/index.html">Contr√¥les d'ex√©cution des applications logicielles int√©gr√©s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>