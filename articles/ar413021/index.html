<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🌾 👨🏼‍🔬 🦈 جهاز للرؤية الليلية يعتمد على وحدة التصوير الحراري Flir Lepton 3 👩🏼‍⚖️ 🎠 🖥️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="في وقت سابق ، كتبت مقالًا حول توصيل جهاز فك التشفير للتصوير الحراري بهاتف ذكي Flir One Gen 2. حان الوقت لإزالة وحدة lepton من جهاز فك التشفير هذا وتوص...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>جهاز للرؤية الليلية يعتمد على وحدة التصوير الحراري Flir Lepton 3</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413021/" style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">في وقت سابق ،</a> كتبت مقالًا حول توصيل جهاز فك التشفير للتصوير الحراري بهاتف ذكي Flir One Gen 2. حان الوقت لإزالة وحدة lepton من جهاز فك التشفير هذا وتوصيلها مباشرة بوحدة التحكم الدقيقة عن طريق تجميع جهاز الرؤية الليلية بدقة 160 × 120 بكسل. <br><a name="habracut"></a><br>  لبناء جهاز التصوير الحراري للرؤية الليلية الخاص بك ، ستحتاج إلى: <br><br>  1) مجلس مع متحكم.  أخذت لوحة من صديق صيني مع متحكم STM32F407VGT6.  هذه وحدة تحكم جيدة: تردد 168 ميجا هرتز و 192 كيلو بايت من ذاكرة الوصول العشوائي. <br><br><img src="https://habrastorage.org/webt/8c/dc/ku/8cdckuwklqzb6uau4hu303w7ly0.jpeg"><br><br>  2) العرض.  أخذت عرضًا بدقة 320 × 240.  تأتي هذه الشاشات مع وحدات تحكم مختلفة.  حصلت عليه مع وحدة تحكم hx8347d. <br><br><img src="https://habrastorage.org/webt/6a/6m/un/6a6mundpajyfht-oxvu96zucw_g.jpeg"><br><br>  3) لوحة لتوصيل lepton 3 على SPI و I2C. <br><br><img src="https://habrastorage.org/webt/9w/l_/ba/9wl_baf3ewy_pcavn7pxgjwlfxo.jpeg"><br><br>  4) اللبتون نفسه 3. العنصر الأصعب والأغلى.  للحصول عليه ، اشتريت جهاز تصوير حراري Flir One Gen 2 معيب على موقع ئي باي وأخرجت ليبتون منه.  يبدو في التكبير مثل هذا: <br><br><img src="https://habrastorage.org/webt/vk/z0/no/vkz0nogorpl_g0n9in9e3wacyw4.jpeg"><br><br>  يمكنك استبعاد العنصر 3 من هذه القائمة ، ما لم تتمكن ، بالطبع ، من أخذ سرير لبرتون من جهاز تصوير حراري معطل ويمكنك إلغاء تثبيته (وبالمناسبة ، ستكون جهات اتصالها من الأسفل).  لسوء الحظ ، المسافة بين الأرجل في اللبتون صغيرة جدًا ، لذلك لم يتم تقديم هذا الخيار لي. <br><br>  لجمع كل هذا ، ما عليك سوى لحام كل شيء على النحو التالي: <br><br><img src="https://habrastorage.org/webt/7u/ev/sl/7uevslpasq6o-qw5hazjqqe79_4.jpeg"><br><br>  تحتاج أيضًا إلى توصيل الطاقة.  لتشغيل لوحة lepton ، أستخدم 5 فولت ، للوحة STM32 3.3 V. للحصول على 5 فولت من البطارية ، أستخدم محول TEL3-0511 (جهد الدخل من 4.5 إلى 9 فولت) ، وأخفض بالفعل 5 فولت على LP2950CZ-3.3 عادي (بالمناسبة ، يسخن حتى 70 درجة. هنا أيضًا ، تحتاج إلى استخدام محول DC / DC ، لكنني لم أشتريه بعد).  يأكل ليبتون 3 ، بالمناسبة ، حسنا.  عند تشغيله من 6 فولت ، يبلغ الاستهلاك الحالي للجهاز بأكمله حوالي 250 مللي أمبير.  عندما يريد lepton النقر فوق الغالق للمعايرة ، يرتفع التيار إلى 500 مللي أمبير. <br><br>  كل شيء معًا يبدو كالتالي: <br><br><img src="https://habrastorage.org/webt/l_/5u/6u/l_5u6uvczvxtcllw78yr8ggdgxg.jpeg"><br><br><img src="https://habrastorage.org/webt/sd/b4/ao/sdb4aok26v1_ty26lq52t5eaazq.jpeg"><br><br>  للعمل مع لبتون ، تحتاج إلى برنامج.  لقد استخدمت CubeMX و Keil 5. في هذه الحالة ، يتم تبسيط جميع روابط البرامج إلى استحالة. <br><br>  يتم التواصل مع ليبتون على SPI.  لم أستخدم I2C ، حيث لم يكن هناك حاجة خاصة لذلك.  وفقًا لـ I2C ، يمكنك التحكم في حالة lepton ، وأنماط تشغيلها ، وتمكين / تعطيل وضع المعايرة التلقائية ، وما إلى ذلك.  ولكن بالنسبة لجهاز الرؤية الليلية ، فهذا ليس ضروريًا بشكل خاص. <br><br>  لفك تشفير البيانات ، كتبت وحدة: <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">الوحدة</b> <div class="spoiler_text" style=";text-align:right;direction:rtl">  <b>leptoncontrol.h</b> <br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> LEPTON_CONTROL_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEPTON_CONTROL_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdbool.h&gt; #include &lt;stdio.h&gt; //   ( ) #define LEPTON_ORIGINAL_IMAGE_WIDTH 160 #define LEPTON_ORIGINAL_IMAGE_HEIGHT 120 //  VoSPI #define VOSPI_FRAME_HEIGHT 60 //  VoSPI #define VOSPI_FRAME_WIDTH 80 //  VoSPI   (164  RAW14  244  RGB) #define VOSPI_PACKAGE_SIZE 164 //   VoSPI   #define VOSPI_PACKAGE_LINE_SIZE 160 //  VOSPI   #define VOSPI_SEGMENT_LINE_AMOUNT 60 void LEPTONCONTROL_Init(void);// void LEPTONCONTROL_CalculateCRC(unsigned short *crc,unsigned char byte);// crc bool LEPTONCONTROL_PushVoSPI(unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line);//    VoSPI    unsigned short *LEPTONCONTROL_GetRAW14Ptr(void);//      #endif</span></span></span></span></code> </pre> <br>  <b>leptoncontrol.c</b> <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"leptoncontrol.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f4xx_hal.h"</span></span></span><span class="hljs-meta"> static unsigned short RAW14Image[LEPTON_ORIGINAL_IMAGE_HEIGHT*LEPTON_ORIGINAL_IMAGE_WIDTH];</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//  static unsigned short CRCTable[256];//   CRC16 //     #define RESYNC_TIMEOUT_MS 19 //:   #define NO_SEGMENT -1 //:   #define ERROR_PACKAGE -2 //---------------------------------------------------------------------------------------------------- // //---------------------------------------------------------------------------------------------------- void LEPTONCONTROL_Init(void) { //    CRC unsigned short code; for(long n=0;n&lt;256;n++) { code=((unsigned short)n)&lt;&lt;8; for(unsigned char m=0;m&lt;8;m++) { if(code&amp;(1&lt;&lt;15)) code=(code&lt;&lt;1)^0x1021; else code=code&lt;&lt;1; } CRCTable[n]=code; } } //---------------------------------------------------------------------------------------------------- // crc //---------------------------------------------------------------------------------------------------- void LEPTONCONTROL_CalculateCRC(unsigned short *crc,unsigned char byte) { *crc=CRCTable[(((*crc)&gt;&gt;8)^byte++)&amp;0xFF]^((*crc)&lt;&lt;8); } //---------------------------------------------------------------------------------------------------- //---------------------------------------------------------------------------------------------------- long LEPTONCONTROL_ReadSegment(unsigned short *raw14_ptr,unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line) { static long current_package=-1; static long segment=-1; long n; *first_line=false; if ((data[0]&amp;0x0F)==0x0F) return(NO_SEGMENT);//  unsigned short crc=data[2]; crc&lt;&lt;=8; crc|=data[3]; // CRC unsigned short crc16=0; LEPTONCONTROL_CalculateCRC(&amp;crc16,data[0]&amp;0x0F); LEPTONCONTROL_CalculateCRC(&amp;crc16,data[1]); LEPTONCONTROL_CalculateCRC(&amp;crc16,0); LEPTONCONTROL_CalculateCRC(&amp;crc16,0); for(n=4;n&lt;VOSPI_PACKAGE_SIZE;n++) LEPTONCONTROL_CalculateCRC(&amp;crc16,data[n]); if (crc16!=crc) return(ERROR_PACKAGE);// CRC //   unsigned short package=data[0]&amp;0x0F; package&lt;&lt;=8; package|=data[1]; if (package==0) { *first_line=true; current_package=0; } if (package==20) { unsigned char ttt=(data[0]&amp;0x70)&gt;&gt;4;//     20  segment=ttt; } if (current_package&lt;0) return(NO_SEGMENT); if (current_package!=package) { current_package=-1; return(ERROR_PACKAGE); } unsigned short *raw_ptr=raw14_ptr+current_package*VOSPI_PACKAGE_LINE_SIZE/2; for(n=0;n&lt;VOSPI_PACKAGE_LINE_SIZE/2;n++,raw_ptr++) { //    big-endian: ,  unsigned short value=data[n*sizeof(short)+4]; value&lt;&lt;=8; value|=data[n*sizeof(short)+5]; *raw_ptr=value; } current_package++; if (current_package!=VOSPI_FRAME_HEIGHT) return(NO_SEGMENT); current_package=-1; return(segment); } //---------------------------------------------------------------------------------------------------- //    VoSPI    //---------------------------------------------------------------------------------------------------- bool LEPTONCONTROL_PushVoSPI(unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line) { *first_line=false; static long waitable_segment=1; long segment=LEPTONCONTROL_ReadSegment(RAW14Image+(waitable_segment-1)*VOSPI_FRAME_WIDTH*VOSPI_SEGMENT_LINE_AMOUNT,data,first_line); if (segment==ERROR_PACKAGE) HAL_Delay(RESYNC_TIMEOUT_MS); if (segment==ERROR_PACKAGE || segment==0) waitable_segment=1; if (segment==ERROR_PACKAGE || segment==NO_SEGMENT || segment==0) return(false); if (segment!=waitable_segment) { waitable_segment=1; if (segment!=1) return(false); } waitable_segment++; if (waitable_segment!=5) return(false); waitable_segment=1; return(true); } //---------------------------------------------------------------------------------------------------- //      //---------------------------------------------------------------------------------------------------- unsigned short *LEPTONCONTROL_GetRAW14Ptr(void) { return(RAW14Image); }</span></span></span></span></code> </pre><br></div></div><br>  كل العمل مع هذه الوحدة يتكون من تقديم بسيط للبيانات التي تم الحصول عليها بواسطة SPI. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">العمل مع الوحدة</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   while(1) { HAL_SPI_Receive(&amp;hspi1,buffer,VOSPI_PACKAGE_SIZE,0x1000); bool first_line=false; unsigned char *buffer_ptr=buffer; LEPTONCONTROL_PushVoSPI(buffer_ptr,&amp;first_line); if (first_line==true) break; } //    lepton3 unsigned char *buffer_ptr=buffer; HAL_SPI_Receive(&amp;hspi1,buffer_ptr,VOSPI_PACKAGE_SIZE*SPI_READ_VOSPI_AMOUNT,0x1000); buffer_ptr=buffer; for(long n=0;n&lt;SPI_READ_VOSPI_AMOUNT;n++,buffer_ptr+=VOSPI_PACKAGE_SIZE) { bool first_line=false; bool res=LEPTONCONTROL_PushVoSPI(buffer_ptr,&amp;first_line); if (res==true) CreateImage();//     } }</span></span></code> </pre><br></div></div><br>  بعد تجميع الإطار ، يتم ببساطة تطبيع قراءات المستشعر ، وتقليصها إلى النطاق [0.255] وعرضها على الشاشة في شكل ظلال رمادية.  ومع ذلك ، لا شيء يمنع استخدام أي لوحة لتلوين الصورة. <br><br>  لعرض الصورة على الشاشة ، أستخدم وحدة FSMC المضمنة في وحدة التحكم هذه في وضع ناقل البيانات 8 بت. <br><br>  يمكن تنزيل البرنامج الكامل <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هنا</a> . <br><br>  فيديو للعمل (للأسف ، قمت بالتصوير على كاميرا قديمة بالجودة المناسبة - ليس لدي كاميرا فيديو معي الآن). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/BMG0rLr8tC8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  PS بالمناسبة ، يمكنك توصيل جهاز التصوير الحراري Flir One Gen 2 بلوحة التصحيح STM32F407Discovery مباشرة عبر USB.  ومع ذلك ، فإن الاتصال غير مستقر - غالبًا ما يتم فقدان التصوير الحراري. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/-elBzHRjZxo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  برنامج لمثل هذا الاتصال <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">هنا</a> .  ربما يفهم شخص ما هو وكيفية جعل الاتصال مستقرًا. <br><br>  كما أن وحدة lepton 3 هذه تتصل بسهولة وببساطة مع Raspberry Pi. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/IWScr3B4RJ0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  في هذه الحالة ، اضطررت إلى تعديل البرنامج من <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">المستودع</a> ، جاعلاً إصداري يعمل مع lepton 3. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar413021/">https://habr.com/ru/post/ar413021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar413011/index.html">قبو الموت</a></li>
<li><a href="../ar413013/index.html">الرغبة في الشفافية</a></li>
<li><a href="../ar413015/index.html">كيف يتم تحليلنا في دور السينما .. وليس فقط</a></li>
<li><a href="../ar413017/index.html">ملاحظة صغيرة حول حرف البدل دعونا تشفير الشهادات</a></li>
<li><a href="../ar413019/index.html">الحياة بعد عام من إدخال الروبوتات: بينما لا يُطلب المساواة</a></li>
<li><a href="../ar413023/index.html">"حسن النسيان": الدراجات الكهربائية - من النماذج الأولى إلى إمكانيات اليوم</a></li>
<li><a href="../ar413025/index.html">على الأشواك والنجوم في طريقها إلى تحسين عمليات التنمية</a></li>
<li><a href="../ar413027/index.html">HI-FI السوفييتي ومنشئوه: أقراص الفيديو بالليزر في اتحاد الجمهوريات الاشتراكية السوفياتية</a></li>
<li><a href="../ar413029/index.html">أول حل OpenShift مُدار في السحابة</a></li>
<li><a href="../ar413033/index.html">أوبري دي جراي رائد التجديد: "الأشخاص في منتصف العمر لديهم فرصة جيدة"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>