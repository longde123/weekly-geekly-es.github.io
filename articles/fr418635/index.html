<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöá üë®üèø‚ÄçüöÄ üßîüèª Cr√©ation d'une machine d'arcade d'√©mulation. Partie 1 üàØÔ∏è üë©üèª‚Äçüî¨ üâë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'√©criture d'un √©mulateur de machine d'arcade est un excellent projet √©ducatif, et dans ce tutoriel, nous examinerons tr√®s en d√©tail l'ensemble du pro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cr√©ation d'une machine d'arcade d'√©mulation. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418635/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6eb/735/b99/6eb735b9990860a94f9ef0a18ba46a82.jpg" alt="image"></div><br>  L'√©criture d'un √©mulateur de machine d'arcade est un excellent projet √©ducatif, et dans ce tutoriel, nous examinerons tr√®s en d√©tail l'ensemble du processus de d√©veloppement.  Vous voulez vraiment mettre la main sur le processeur?  La cr√©ation d'un √©mulateur est alors la meilleure fa√ßon de l'apprendre. <br><br>  Vous aurez besoin de connaissances en C, ainsi que de connaissances en assembleur.  Si vous ne connaissez pas le langage d'assemblage, l'√©criture d'un √©mulateur est la meilleure fa√ßon de l'apprendre.  Vous devrez √©galement ma√Ætriser les math√©matiques hexad√©cimales (√©galement appel√©es base 16 ou simplement ¬´hex¬ª).  Je vais parler de ce sujet. <br><br>  J'ai d√©cid√© de choisir un √©mulateur pour la machine Space Invaders, qui utilise le processeur 8080. Ce jeu et ce processeur sont tr√®s populaires, car sur Internet, vous pouvez trouver beaucoup d'informations √† leur sujet.  Vous en aurez besoin pour terminer le projet. <br><br>  Le code source complet du tutoriel est t√©l√©charg√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> .  Si vous n'avez pas ma√Ætris√© le travail avec git, alors sur la page github il y a un bouton "T√©l√©charger ZIP" qui vous permet de t√©l√©charger l'archive avec tout le code. <br><a name="habracut"></a><br><h1>  Introduction aux nombres binaires et hexad√©cimaux </h1><br>  En math√©matiques "ordinaires", le syst√®me de nombres d√©cimaux est utilis√©.  Chaque chiffre du nombre peut avoir une valeur de z√©ro √† neuf, et lorsque nous d√©passons 9, nous ajoutons un au nombre dans le chiffre suivant et recommen√ßons √† partir de z√©ro.  Tout cela est assez simple et direct, et vous n'y avez probablement jamais pens√©. <br><br>  Vous avez peut-√™tre su ou entendu que les ordinateurs fonctionnent avec des donn√©es binaires.  Les geeks informatiques appellent les math√©matiques d√©cimales base-10 et les appels binaires base-2.  En notation binaire, chaque chiffre d'un nombre ne peut avoir que deux valeurs, z√©ro ou une.  En code binaire, le nombre est le suivant: 0, 1, 10, 11, 100, 101, 110, 111, 1000. Ce ne sont pas des nombres d√©cimaux, vous ne pouvez donc pas les appeler ¬´z√©ro, un, dix, onze, cent, cent un¬ª.  Ils sont prononc√©s comme "z√©ro, un, un z√©ro, un un, un z√©ro z√©ro", etc.  Je lis rarement les nombres binaires √† haute voix, mais si n√©cessaire, vous devez indiquer clairement le syst√®me num√©rique utilis√©.  Dix, onze et cent n'ont aucune signification en notation binaire. <br><br>  En notation d√©cimale, un nombre a les chiffres suivants: unit√©s, dizaines, centaines, milliers, dizaines de milliers, etc.  Dans le syst√®me binaire, les chiffres suivants: unit√©s, deux, quatre, huit, etc.  <strong>En informatique, la valeur de chaque bit binaire est appel√©e bit.</strong>  <strong>8 bits constituent un octet.</strong> <br><br>  En termes binaires, une cha√Æne de nombres devient rapidement tr√®s longue.  Pour repr√©senter le nombre d√©cimal 20 000 en termes binaires, 16 chiffres sont requis: 0b100111000100000.  Pour r√©soudre ce probl√®me, il est pratique d'utiliser un syst√®me num√©rique hexad√©cimal, √©galement appel√© base 16 (ou hex).  En base 16, chaque chiffre contient 16 valeurs.  Pour les valeurs de z√©ro √† neuf, les m√™mes caract√®res sont utilis√©s que dans la base-10, mais pour les 6 valeurs restantes, les substitutions sont utilis√©es sous la forme des 6 premi√®res lettres de l'alphabet, de A √† F. <br><br>  Le compte dans le syst√®me hexad√©cimal est effectu√© comme suit: 0 1 2 3 4 5 6 7 8 9 ABCDEF 10 11 12, etc.  Dans l'hexad√©cimal, les dizaines, les centaines et ainsi de suite n'ont pas la m√™me signification qu'en d√©cimal, donc les gens prononcent les nombres s√©par√©ment.  Par exemple, $ A57 est prononc√© √† haute voix par "A-cinq-sept".  Pour plus de clart√©, vous pouvez √©galement ajouter un hex, par exemple, "A-cinq-sept-hex".  Dans le syst√®me num√©rique hexad√©cimal, l'√©quivalent du nombre d√©cimal 20 000 est 4E20 $ - une forme beaucoup plus compacte que 16 bits du syst√®me binaire. <br><br>  Je pense que le syst√®me hexad√©cimal a √©t√© choisi en raison d'une conversion tr√®s naturelle du binaire en hexad√©cimal et vice versa.  Chaque chiffre hexad√©cimal correspond √† 4 bits (4 bits) d'un nombre binaire similaire.  <strong>2 chiffres hexad√©cimaux constituent un octet (8 bits).</strong>  Un seul chiffre hexad√©cimal peut √™tre appel√© grignotage, et certaines personnes l'√©crivent m√™me par y comme ¬´nybble¬ª. <br><br><table><tbody><tr><th colspan="4">  Chaque chiffre hexad√©cimal est compos√© de 4 chiffres binaires </th></tr><tr><td>  Hex </td><td>  Un </td><td>  5 </td><td>  7 </td></tr><tr><td>  Binaire </td><td>  1010 </td><td>  0101 </td><td>  0111 </td></tr></tbody></table><br>  Lors de l'√©criture du code C, on pense que le nombre est d√©cimal (base-10), sauf indication contraire.  Pour indiquer au compilateur C que le nombre est binaire, nous ajoutons le nombre z√©ro et la lettre b en minuscules, comme ceci: <code>0b1101101</code> .  Le nombre hexad√©cimal peut √™tre √©crit en code C en ajoutant au d√©but de z√©ro et x en minuscule: <code>0xA57</code> .  Certaines langues d'assemblage utilisent le signe dollar $: <code>$A57</code> pour indiquer un nombre hexad√©cimal. <br><br>  Si vous y r√©fl√©chissez, la connexion entre les nombres binaires, hexad√©cimaux et d√©cimaux est assez √©vidente, mais pour le premier ing√©nieur, qui y avait pens√© avant l'invention de l'ordinateur, cela aurait d√ª devenir un moment de r√©flexion. <br><br>  Vous avez compris tout √ßa?  Super. <br><br><h1>  Une br√®ve introduction au processeur </h1><br>  <em>Si vous le savez d√©j√†, vous pouvez ignorer la section en toute s√©curit√©.</em> <br><br>  Une unit√© centrale de traitement (CPU) est une machine con√ßue pour ex√©cuter des programmes.  Les blocs fondamentaux de la CPU sont les registres et les instructions.  En tant que d√©veloppeur de logiciels, vous pouvez traiter ces registres comme des variables.  Dans notre processeur 8080, entre autres registres, il existe des registres 8 bits appel√©s A, B, C, D et E. Ces registres peuvent √™tre interpr√©t√©s comme le code C suivant: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> A, B, C, D, E;</code> </pre> <br>  Tous les processeurs ont √©galement un compteur de programmes (Program Counter, PC).  Vous pouvez le prendre comme pointeur. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pc;</code> </pre> <br>  Pour un CPU, un programme est une s√©quence de nombres hexad√©cimaux.  Chaque instruction en langage assembleur en 8080 correspond √† 1 √† 3 octets dans le programme.  Afin de savoir quelle commande correspond √† quel num√©ro, le manuel du processeur (ou toute autre information sur le processeur 8080 sur Internet) est utile. <br><br>  Les noms des commandes (instructions) sont souvent des mn√©moniques des op√©rations effectu√©es par ces commandes.  Le mn√©monique pour le chargement en 8080 est MOV (d√©placer) et ADD est utilis√© pour effectuer l'addition. <br><br><h4>  Des exemples </h4><br>  La valeur de m√©moire actuelle indiqu√©e par le compteur d'instructions est 0x79.  Ceci est conforme √† l'instruction <code>MOV A,C</code> processeur 8080. Ce code d'assemblage en code C ressemble √† <code>A=C;</code>  . <br><br>  Si, √† la place, la valeur dans le PC √©tait 0x80, alors le processeur ex√©cuterait <code>ADD B</code>  En C, cela correspond √† la cha√Æne <code>A = A + B;</code>  . <br><br>  Une liste compl√®te des instructions du processeur 8080 peut √™tre trouv√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Pour impl√©menter notre √©mulateur, nous utiliserons ces informations. <br><br><h4>  Timings </h4><br>  Dans le CPU, l'ex√©cution de chaque instruction n√©cessite un certain temps (timing), mesur√© en cycles.  Dans les processeurs modernes, ces informations peuvent √™tre difficiles √† obtenir, car les d√©lais d√©pendent de nombreux aspects diff√©rents.  Mais dans les processeurs plus anciens comme le 8080, les d√©lais sont constants et ces informations sont souvent fournies par le fabricant du processeur.  Par exemple, une instruction de transfert d'un registre vers un registre MOV prend 1 cycle. <br><br>  Les informations de synchronisation sont utiles pour √©crire du code efficace dans le processeur.  Un programmeur peut chercher √† √©viter les instructions qui prennent plusieurs cycles √† compl√©ter. <br><br>  Plus important pour nous, nous utiliserons des informations de synchronisation pour √©muler le processeur.  Pour que le jeu fonctionne de la m√™me mani√®re que sur l'original, les instructions doivent √™tre ex√©cut√©es √† la bonne vitesse.  Certains √©mulateurs y mettent beaucoup d'efforts, mais lorsque nous y arriverons, nous devrons d√©cider quelle pr√©cision nous voulons obtenir. <br><br><h1>  Op√©rations logiques </h1><br>  Avant de clore le sujet des nombres binaires et hexad√©cimaux, nous devrions parler des op√©rations logiques.  Vous √™tes probablement d√©j√† habitu√© √† utiliser la logique dans votre code, par exemple, dans des constructions comme <code>if ((conditionA) and (conditionB))</code> .  Dans les programmes qui fonctionnent directement avec du mat√©riel, vous devez souvent manipuler des bits de nombres individuels. <br><br><h3>  ET op√©ration </h3><br>  Voici tous les r√©sultats possibles de l'op√©ration ET (ET) (table de v√©rit√©) entre deux nombres √† un seul bit. <br><br><table><tbody><tr><td>  x </td><td>  y </td><td>  R√©sultat </td></tr><tr><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  0 </td><td>  1 </td><td>  0 </td></tr><tr><td>  1 </td><td>  0 </td><td>  0 </td></tr><tr><td>  1 </td><td>  1 </td><td>  1 </td></tr></tbody></table><br>  Le r√©sultat de AND n'est √©gal √† l'unit√© que lorsque les deux valeurs sont √©gales √† l'unit√©.  Lorsque nous combinons deux nombres avec l'op√©ration ET, ET pour chaque bit d'un nombre est ET avec le bit correspondant de l'autre nombre.  Le r√©sultat est stock√© dans ce bit du num√©ro de destination.  Il vaut probablement mieux regarder un exemple: <br><br><table><tbody><tr><td></td><td colspan="8">  binaire </td><td>  hex </td></tr><tr><td>  source x </td><td>  0 </td><td>  1 </td><td>  1 </td><td>  0 </td><td>  1 </td><td>  0 </td><td>  1 </td><td>  1 </td><td>  6 G $ </td></tr><tr><td>  source y </td><td>  1 </td><td>  1 </td><td>  0 </td><td>  1 </td><td>  0 </td><td>  0 </td><td>  1 </td><td>  0 </td><td>  $ D2 </td></tr><tr><td>  x ET y </td><td>  0 </td><td>  1 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  1 </td><td>  0 </td><td>  42 $ US </td></tr></tbody></table><br>  En C, l'op√©ration AND logique est une simple esperluette "&amp;". <br><br><h3>  Op√©ration OU (OU) </h3><br>  L'op√©ration OR fonctionne de mani√®re similaire.  La seule diff√©rence est que le r√©sultat sera √©gal √† un si au moins une des valeurs de x ou y est √©gale √† un. <br><br><table><tbody><tr><td>  x </td><td>  y </td><td>  R√©sultat </td></tr><tr><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  0 </td><td>  1 </td><td>  1 </td></tr><tr><td>  1 </td><td>  0 </td><td>  1 </td></tr><tr><td>  1 </td><td>  1 </td><td>  1 </td></tr></tbody></table><br><table><tbody><tr><td></td><td colspan="8">  binaire </td><td>  hex </td></tr><tr><td>  source x </td><td>  0 </td><td>  1 </td><td>  1 </td><td>  0 </td><td>  1 </td><td>  0 </td><td>  1 </td><td>  1 </td><td>  6 G $ </td></tr><tr><td>  source y </td><td>  1 </td><td>  1 </td><td>  0 </td><td>  1 </td><td>  0 </td><td>  0 </td><td>  1 </td><td>  0 </td><td>  $ D2 </td></tr><tr><td>  x OU y </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  1 </td><td>  0 </td><td>  1 </td><td>  1 </td><td>  $ Fb </td></tr></tbody></table><br>  En C, une op√©ration OU logique est indiqu√©e par une barre verticale "|". <br><br><h3>  Pourquoi est-ce important? </h3><br>  Dans de nombreux processeurs plus anciens, et en particulier dans les machines d'arcade, le jeu n√©cessite souvent de travailler avec un seul bit du nombre.  Il existe souvent un code similaire: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/*  1:     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buttons_ptr = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)<span class="hljs-number"><span class="hljs-number">0x2043</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buttons = *buttons_ptr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttons &amp; <span class="hljs-number"><span class="hljs-number">0x4</span></span>) HandleLeftButton(); <span class="hljs-comment"><span class="hljs-comment">/*  2:  LED-    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * LED_pointer = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *) <span class="hljs-number"><span class="hljs-number">0x2089</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> led = *LED_pointer; led = led | <span class="hljs-number"><span class="hljs-number">0x40</span></span>; <span class="hljs-comment"><span class="hljs-comment">//,  LED   6 *LED_pointer = led; /*  3:   LED- */ char * LED_pointer = (char *) 0x2089; char led = *LED_pointer; led = led &amp; 0xBF; //  6 *LED_pointer = led;</span></span></code> </pre> <br>  Dans l'exemple 1, l'adresse 2043 $ allou√©e en m√©moire est l'adresse des boutons du panneau de commande.  Ce code lit et r√©pond au bouton enfonc√©.  (Bien s√ªr, dans Space Invaders, ce code sera en langage assembleur!) <br><br>  Dans l'exemple 2, le jeu veut allumer un indicateur LED, qui se trouve dans le bit 6 de l'adresse de 2089 $ allou√©e en m√©moire.  Le code doit lire la valeur existante, modifier un seul bit et la r√©√©crire. <br><br>  Dans l'exemple 3, vous devez d√©sactiver l'indicateur de l'exemple 2, donc le code devrait r√©initialiser le bit 6 de l'adresse 2089 $.  Cela peut √™tre fait en effectuant l'op√©ration ET pour l'octet de commande d'indicateur avec une valeur pour laquelle seul le bit 6 est nul. Nous n'affecterons donc que 6, en laissant les bits restants inchang√©s. <br><br>  Ceci est g√©n√©ralement appel√© un ¬´masque¬ª.  En C, un masque est g√©n√©ralement √©crit √† l'aide de l'op√©rateur NOT, d√©sign√© par un tilde ("~").  Par cons√©quent, au lieu d'√©crire <code>0xBF</code> , j'√©cris simplement <code>~0x40</code> et j'obtiens le m√™me nombre, mais sans mettre beaucoup d'efforts. <br><br><h1>  Introduction au langage d'assemblage </h1><br>  Si vous lisez ce didacticiel, vous connaissez probablement la programmation informatique, par exemple en Java ou en Python.  Ces langages vous permettent de faire beaucoup de travail en seulement quelques lignes de code.  Le code est consid√©r√© comme intelligemment √©crit s'il fait autant de travail que possible sur le moins de lignes possible, peut-√™tre m√™me en utilisant les fonctionnalit√©s des biblioth√®ques int√©gr√©es.  Ces langues sont appel√©es ¬´langues de haut niveau¬ª. <br><br>  En langage d'assemblage, en revanche, il n'y a pas de fonctions de sauvetage int√©gr√©es, et de nombreuses lignes de code simples peuvent √™tre n√©cessaires pour effectuer des t√¢ches simples.  Le langage d'assemblage est consid√©r√© comme un langage de bas niveau.  Dans ce document, vous devez vous habituer √† penser dans le style de "quelle s√©quence sp√©cifique d'√©tapes doit √™tre prise pour terminer cette t√¢che?" <br><br>  La chose la plus importante que vous devez savoir sur le langage assembleur est que chaque ligne est traduite en une seule commande de processeur. <br><br>  Consid√©rez une telle construction √† partir du langage C: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = b + <span class="hljs-number"><span class="hljs-number">100</span></span>;</code> </pre> <br>  En langage assembleur, cette t√¢che devra √™tre effectu√©e dans l'ordre suivant: <br><br><ol><li>  Charger l'adresse de la variable B dans le registre 1 </li><li>  Charger le contenu de cette adresse m√©moire dans le registre 2 </li><li>  Ajouter une valeur directe 0x64 pour enregistrer 2 </li><li>  Charger l'adresse de la variable A dans le registre 1 </li><li>  √âcrire le contenu du registre 2 √† l'adresse stock√©e dans le registre 1 </li></ol><br>  Dans le code, cela ressemblera √† ceci: <br><br><pre> <code class="hljs pgsql"> lea a1, #<span class="hljs-meta"><span class="hljs-meta">$1000</span></span> ;   a lea a2, #<span class="hljs-meta"><span class="hljs-meta">$1008</span></span> ;   b <span class="hljs-keyword"><span class="hljs-keyword">move</span></span>.l d0,(a2) <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>.l d0, #<span class="hljs-meta"><span class="hljs-meta">$64</span></span> mov (a1),d0</code> </pre> <br>  Il convient de noter les √©l√©ments suivants: <br><br><ul><li>  Dans un langage de haut niveau, le compilateur d√©cide o√π placer les variables en m√©moire.  Lorsque vous √©crivez du code dans l'assembleur, vous √™tes vous-m√™me responsable de chaque adresse m√©moire que vous utiliserez. </li><li>  Dans la plupart des langages d'assemblage, les crochets signifient ¬´m√©moire √† cette adresse¬ª. </li><li>  Dans la plupart des langages d'assembleur, # d√©signe un nombre alg√©brique, √©galement appel√© valeur imm√©diate.  Par exemple, √† la ligne 1 de l'exemple ci-dessus, le code √©crit en fait la valeur # 0x1000 pour enregistrer a1.  Si le code ressemblait √† <code>move.l a1, ($1000)</code> , alors a1 recevrait le contenu de la m√©moire √† l'adresse 0x1000. </li><li>  Chaque processeur poss√®de son propre langage d'assemblage, et le portage de code d'un processeur √† un autre peut √™tre difficile. </li><li>  Ce n'est pas un vrai langage d'assemblage de processeur, je l'ai propos√© comme exemple. </li></ul><br>  Cependant, il y a une chose en commun entre les programmeurs intelligents de haut niveau et les assistants d'assemblage.  Les programmeurs assembleurs consid√®rent comme un honneur de terminer la t√¢che aussi efficacement que possible et de minimiser le nombre d'instructions utilis√©es.  Le code des machines d'arcade est g√©n√©ralement hautement optimis√© et tous les jus sont extraits de chaque octet et cycle suppl√©mentaire. <br><br><h1>  Piles </h1><br>  Parlons un peu plus du langage d'assemblage.  Dans tout programme informatique assez complexe dans les sous-programmes d'assembleur sont utilis√©s.  La plupart des processeurs ont une structure appel√©e pile. <br><br>  Imaginez une pile sous la forme d'une pile.  Si nous devons enregistrer un num√©ro, nous le mettons en haut de la pile.  Lorsque nous devons le ramener, nous le prenons du haut de la pile.  Les programmeurs assembleurs appellent popping le nombre sur la pile ¬´push¬ª, et le faire sortir est appel√© ¬´pop¬ª. <br><br>  Disons que mon programme doit appeler un sous-programme.  Je peux √©crire un code similaire: <br><br><pre> <code class="hljs css"> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">d0</span></span> ;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">d0</span></span>   0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1004</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> ;     0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1008</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">d1</span></span> ;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">d1</span></span>   0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1010</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> ;  .. 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1014</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">a0</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1018</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x101C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1020</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1024</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-id"><span class="hljs-selector-id">#0x1030</span></span> ;   0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1028</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x102C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#0x2040</span></span> ;   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2040</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1030</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1</span></span>, (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>) ;    0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1034</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> ;    0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1038</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a0</span></span>, (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>) ;    0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x103c</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span>  ..</code> </pre> <br>  Le code montr√© ci-dessus pousse les valeurs d0, d1, a0 et a1 sur la pile.  La plupart des processeurs utilisent un pointeur de pile.  Il peut s'agir d'un registre normal, par convention utilis√© comme pointeur de pile, ou d'un registre sp√©cial avec des fonctions pour certaines instructions. <br><br>  Sur les processeurs de la s√©rie 68K, le pointeur de pile n'est d√©termin√© que par convention, sinon c'est un registre r√©gulier.  Dans notre processeur 8080, le registre SP est un registre sp√©cial.  Il a des commandes PUSH et POP qui √©crivent et sautent de la pile en une seule commande. <br><br>  Dans notre projet d'√©mulateur, nous n'√©crirons pas de code √† partir de z√©ro.  Mais si vous avez besoin d'analyser des programmes en langage assembleur, il est bon d'apprendre √† reconna√Ætre de telles constructions. <br><br><h4>  Langues de haut niveau </h4><br>  Lors de l'√©criture d'un programme dans un langage de haut niveau, toutes les op√©rations de sauvegarde et de restauration des registres sont effectu√©es √† chaque appel de fonction.  Nous n'y pensons pas, car le compilateur les traite.  Les appels de fonction dans un langage de haut niveau peuvent prendre beaucoup de m√©moire et de temps processeur. <br><br>  Avez-vous d√©j√† vu un programme se bloquer lors de l'appel d'un sous-programme dans une boucle infinie?  Cela peut se produire car chaque appel de fonction a pouss√© les valeurs de registre sur la pile et √† un moment donn√©, la m√©moire a √©t√© √©puis√©e.  (Si la pile devient trop grande, cela s'appelle d√©bordement de pile ou d√©bordement de pile.) <br><br>  Vous avez peut-√™tre entendu parler des fonctions en ligne.  Ils √©vitent de sauvegarder et de restaurer les registres en incluant le code de routine dans la fonction appelante.  Le code devient plus grand, mais gr√¢ce √† cela, plusieurs commandes et op√©rations de lecture / √©criture en m√©moire sont enregistr√©es. <br><br><h4>  Conventions d'appel </h4><br>  Lorsque vous √©crivez un programme assembleur qui n'appelle que votre code, vous pouvez d√©cider vous-m√™me comment les routines communiqueront entre elles.  Par exemple, comment retourner √† la fonction appelante une fois la routine termin√©e?  Une fa√ßon consiste √† √©crire l'adresse de retour dans un registre sp√©cifique.  L'autre consiste √† placer l'adresse de retour au-dessus de la pile.  Tr√®s souvent, la d√©cision d√©pend de ce que le processeur prend en charge.  Le 8080 a une commande CALL qui pousse l'adresse de retour d'une fonction sur la pile.  Vous utiliserez peut-√™tre cette commande 8080 pour impl√©menter des appels de sous-programme. <br><br>  Une d√©cision de plus doit √™tre prise.  La conservation du registre rel√®ve-t-elle de la fonction appelante ou du sous-programme?  Dans l'exemple ci-dessus, les registres sont stock√©s par la fonction appelante.  Mais que faire si nous avons 32 registres?  Sauvegarder et restaurer 32 registres lorsqu'une routine n'en utilise qu'une petite fraction sera une perte de temps. <br><br>  Le compromis peut √™tre une approche mixte.  Supposons que nous choisissions une politique dans laquelle une routine peut utiliser les registres r10-r32 sans enregistrer leur contenu, mais ne peut pas d√©truire r1-r9.  Dans une situation similaire, la fonction appelante conna√Æt les √©l√©ments suivants: <br><br><ul><li>  Au retour d'une fonction, le contenu de r1-r9 restera inchang√© </li><li>  Je ne peux pas d√©pendre du contenu du r10-r32 </li><li>  Si j'ai besoin d'une valeur dans r10-r32 apr√®s avoir appel√© un sous-programme, alors avant de l'appeler, je dois l'enregistrer quelque part </li></ul><br>  De m√™me, chaque routine conna√Æt les √©l√©ments suivants: <br><br><ul><li>  Je peux d√©truire r10-r32 </li><li>  Si je veux utiliser r1-r9, je dois enregistrer le contenu et le restaurer avant de retourner √† la fonction qui m'a appel√© </li></ul><br><h4>  Abi </h4><br>  Sur la plupart des plates-formes modernes, ces politiques sont cr√©√©es par des ing√©nieurs et publi√©es dans des documents appel√©s ABI (Application Binary Interface).  Gr√¢ce √† ce document, les cr√©ateurs de compilateurs savent comment compiler du code pouvant appeler du code compil√© par d'autres compilateurs.  Si vous souhaitez √©crire du code assembleur qui peut fonctionner dans un tel environnement, vous devez conna√Ætre ABI et √©crire du code conform√©ment √† celui-ci. <br><br>  Conna√Ætre ABI permet √©galement de d√©boguer du code lorsque vous n'avez pas acc√®s √† la source.  L'ABI d√©finit l'emplacement des param√®tres des fonctions, donc lorsque vous envisagez un sous-programme, vous pouvez examiner ces adresses pour comprendre ce qui est transmis aux fonctions. <br><br><h4>  Retour √† l'√©mulateur </h4><br>  La plupart des codes d'assemblage √©crits √† la main, en particulier pour les processeurs et les jeux d'arcade plus anciens, ne suivent pas ABI.  Les programmes sont assembl√©s et peuvent ne pas avoir beaucoup de routines.  Chaque routine enregistre et restaure les registres uniquement en cas d'urgence. <br><br>  Si vous voulez comprendre ce que fait le programme, il serait bien de commencer par marquer les adresses cibl√©es pour les commandes CALL. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418635/">https://habr.com/ru/post/fr418635/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418625/index.html">Appel secret √† Andy Grove qui a aid√© Apple √† acheter le NeXT</a></li>
<li><a href="../fr418627/index.html">En savoir plus sur les m√©thodes de r√©solution de syst√®mes d'√©quations alg√©briques lin√©aires</a></li>
<li><a href="../fr418629/index.html">Comment v√©rifier ind√©pendamment si vous pouvez breveter votre produit et effectuer une recherche de brevets</a></li>
<li><a href="../fr418631/index.html">7 directives de code javascript</a></li>
<li><a href="../fr418633/index.html">R√©activit√© JavaScript: un exemple simple et intuitif</a></li>
<li><a href="../fr418637/index.html">Kubernetes aux masses: Slurm d√©marre le 3 ao√ªt</a></li>
<li><a href="../fr418639/index.html">Akka Streams pour les simples mortels</a></li>
<li><a href="../fr418641/index.html">Une erreur qui emp√™che un designer de grandir</a></li>
<li><a href="../fr418643/index.html">Assis vs debout: comment mieux travailler?</a></li>
<li><a href="../fr418645/index.html">Articles de la conf√©rence de printemps C ++ Russie 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>