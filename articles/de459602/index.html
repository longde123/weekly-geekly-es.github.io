<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëãüèª üì≥ ü§ï Wir binden den Lua-Interpreter in das Projekt f√ºr den Mikrocontroller (stm32) ein. üëÉüèæ üëåüèΩ üìß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In relativ gro√üen Anwendungen ist ein wesentlicher Teil des Projekts die Gesch√§ftslogik. Es ist praktisch, diesen Teil des Programms auf einem Compute...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir binden den Lua-Interpreter in das Projekt f√ºr den Mikrocontroller (stm32) ein.</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459602/"><img src="https://habrastorage.org/webt/p6/9j/kz/p69jkzome873c4rbil8fftedrxs.png"><br><br>  In relativ gro√üen Anwendungen ist ein wesentlicher Teil des Projekts die Gesch√§ftslogik.  Es ist praktisch, diesen Teil des Programms auf einem Computer zu debuggen und ihn dann in das Projekt f√ºr den Mikrocontroller einzubetten, wobei zu erwarten ist, dass dieser Teil ohne Debugging genau so ausgef√ºhrt wird, wie er beabsichtigt war (Idealfall). <br><br>  Da die meisten Programme f√ºr Mikrocontroller in C / C ++ geschrieben sind, verwenden sie f√ºr diese Zwecke normalerweise abstrakte Klassen, die Schnittstellen zu Entit√§ten auf niedriger Ebene bereitstellen (wenn ein Projekt nur mit C geschrieben wird, werden h√§ufig Funktionszeigerstrukturen verwendet).  Dieser Ansatz bietet den erforderlichen Abstraktionsgrad gegen√ºber dem Eisen, ist jedoch mit der Notwendigkeit einer st√§ndigen Neukompilierung des Projekts mit anschlie√üender Programmierung des nichtfl√ºchtigen Speichers des Mikrocontrollers mit einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gro√üen</a> bin√§ren <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Firmware-</a> Datei behaftet. <br><br>  Es gibt jedoch noch einen anderen Weg: Verwenden Sie eine Skriptsprache, mit der Sie Gesch√§ftslogik in Echtzeit auf dem Ger√§t selbst debuggen oder Arbeitsskripte direkt aus dem externen Speicher laden k√∂nnen, ohne diesen Code in die Mikrocontroller-Firmware aufzunehmen. <br><br>  Ich habe Lua als Skriptsprache gew√§hlt. <a name="habracut"></a><br><br><h2>  Warum Lua? </h2><br>  Es gibt mehrere Skriptsprachen, die Sie in ein Projekt f√ºr einen Mikrocontroller einbetten k√∂nnen.  Ein paar einfache BASIC-√§hnliche, PyMite, Pawn ... Jedes hat seine Vor- und Nachteile, von denen eine Diskussion nicht in der Liste der in diesem Artikel behandelten Themen enthalten ist. <br><br>  Kurz dar√ºber, was speziell lua gut ist - finden Sie im Artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">"Lua in 60 Minuten".</a>  Dieser Artikel hat mich sehr inspiriert und f√ºr eine detailliertere Untersuchung des Themas habe ich den offiziellen Leitfaden des Autors der Sprache Robert Jeruzalimsky " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Programming in Lua</a> " (verf√ºgbar in der offiziellen russischen √úbersetzung) gelesen. <br><br>  Ich m√∂chte auch das eLua-Projekt erw√§hnen.  In meinem Fall habe ich bereits eine vorgefertigte Low-Level-Software-Schicht f√ºr die Interaktion mit den Peripherieger√§ten des Mikrocontrollers und anderen erforderlichen Peripherieger√§ten auf der Ger√§teplatine.  Daher habe ich dieses Projekt nicht in Betracht gezogen (da bekannt ist, dass es genau die Schichten f√ºr die Verbindung des Lua-Kerns mit den Peripherieger√§ten des Mikrocontrollers bereitstellt). <br><br><h2>  √úber das Projekt, in das Lua eingebettet wird </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Traditionell</a> wird mein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sandbox-Projekt</a> als Qualit√§t des Feldes f√ºr Experimente verwendet (Link zum Commit mit der bereits integrierten Lua mit allen unten beschriebenen notwendigen Verbesserungen). <br><br>  Das Projekt basiert auf dem Mikrocontroller stm32f405rgt6 mit 1 MB nichtfl√ºchtigem Material und 192 KB RAM (die √§lteren 2 Bl√∂cke mit einer Gesamtkapazit√§t von 128 KB werden derzeit verwendet). <br><br>  Das Projekt verf√ºgt √ºber ein FreeRTOS-Echtzeitbetriebssystem zur Unterst√ºtzung der Hardware-Peripherie-Infrastruktur.  Der gesamte Speicher f√ºr Aufgaben, Semaphoren und andere FreeRTOS-Objekte wird in der Verkn√ºpfungsphase (im .bss-Bereich des RAM) statisch zugewiesen.  Alle FreeRTOS-Entit√§ten (Semaphoren, Warteschlangen, Aufgabenstapel usw.) sind Teile globaler Objekte in den privaten Bereichen ihrer Klassen.  Der FreeRTOS-Heap wird jedoch weiterhin zugewiesen, um die <i>malloc-</i> <i>freien</i> <i>Calloc-</i> Funktionen (erforderlich f√ºr Funktionen wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">printf</a> ) zu unterst√ºtzen, die f√ºr die Arbeit mit ihm neu definiert wurden.  Es gibt eine erh√∂hte API f√ºr die Arbeit mit MicroSD (FatFS) -Karten sowie f√ºr das Debuggen von UART (115200, 8N1). <br><br><h2>  √úber die Logik, Lua als Teil eines Projekts zu verwenden </h2><br>  Zum Debuggen der Gesch√§ftslogik wird angenommen, dass Befehle √ºber UART gesendet, (als separates Objekt) in fertige Zeilen gepackt (mit dem Zeichen "\ n" + 0-Terminator endend) und an die Lua-Maschine gesendet werden.  Bei erfolgloser Ausf√ºhrung erfolgt die Ausgabe √ºber printf (da es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zuvor am</a> Projekt beteiligt war).  Wenn die Logik debuggt ist, kann die endg√ºltige Gesch√§ftslogikdatei aus der Datei von der microSD-Karte heruntergeladen werden (nicht im Material dieses Artikels enthalten).  Zum Debuggen von Lua wird der Computer au√üerdem in einem separaten FreeRTOS-Thread ausgef√ºhrt (in Zukunft wird jedem debuggten Gesch√§ftslogikskript, in dem er mit seiner Umgebung ausgef√ºhrt wird, ein separater Thread zugewiesen). <br><br><h2>  Einbeziehung des Lua-Submoduls in das Projekt </h2><br>  Der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offizielle Spiegel des Projekts auf Github</a> wird als Quelle f√ºr die Lua-Bibliothek verwendet (da mein Projekt auch dort ver√∂ffentlicht ist. Sie k√∂nnen die Quellen direkt von der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offiziellen Website aus verwenden</a> ).  Da das Projekt √ºber ein etabliertes System zum Zusammenstellen von Submodulen als Teil des Projekts verf√ºgt, einzelne CMakeLists f√ºr jedes Submodul, habe ich ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">separates Submodul erstellt,</a> in das ich diesen Fork und CMakeLists aufgenommen habe, um einen einzelnen Build-Stil beizubehalten. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CMakeLists erstellt</a> die Quellen des Lua-Repositorys als statische Bibliothek mit den folgenden Submodul-Kompilierungsflags (aus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der Submodul-Konfigurationsdatei</a> im Hauptprojekt entnommen): <br><br><pre><code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(C_COMPILER_FLAGS <span class="hljs-string"><span class="hljs-string">"-std=gnu99;-fshort-enums;-fno-exceptions;-Wno-type-limits;-ffunction-sections;-fdata-sections;"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(MODULE_LUA_COMP_FLAGS <span class="hljs-string"><span class="hljs-string">"-O0;-g3;${C_COMPILER_FLAGS}"</span></span></code> </pre> <br>  Und Spezifikationsflags des verwendeten Prozessors (in den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Stamm-CMakeLists festgelegt</a> ): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(HARDWARE_FLAGS -mthumb; -mcpu=cortex-m4; -mfloat-abi=hard; -mfpu=fpv4-sp-d16;)</code> </pre> <br>  Es ist wichtig zu beachten, dass die Root-CMakeLists eine Definition angeben m√ºssen, die es erlaubt, keine doppelten Werte zu verwenden (da der Mikrocontroller keine Hardware-Unterst√ºtzung f√ºr double bietet. Nur float): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span>(-DLUA_32BITS)</code> </pre> <br>  Nun, es bleibt nur, den Linker √ºber die Notwendigkeit zu informieren, diese Bibliothek zusammenzustellen und das Ergebnis in das Layout des endg√ºltigen Projekts aufzunehmen: <br><br><div class="spoiler">  <b class="spoiler_title">CMakeLists-Plot zum Verkn√ºpfen eines Projekts mit der Lua-Bibliothek</b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_subdirectory</span></span>(<span class="hljs-variable"><span class="hljs-variable">${CMAKE_SOURCE_DIR}</span></span>/bsp/submodules/module_lua) ... <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>(<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf PUBLIC <span class="hljs-comment"><span class="hljs-comment"># -Wl,--start-group       #      . #  Lua    ,      #  . "-Wl,--start-group" ..._... MODULE_LUA ..._... "-Wl,--end-group")</span></span></code> </pre> </div></div><br><h2>  Funktionen zum Arbeiten mit Speicher definieren </h2><br>  Da sich Lua selbst nicht mit dem Speicher befasst, geht diese Verantwortung auf den Benutzer √ºber.  Bei Verwendung der geb√ºndelten <i>Lauxlib-</i> Bibliothek und der daraus <i>resultierenden</i> Funktion <i>luaL_newstate</i> ist die Funktion <i>l_alloc</i> jedoch als Speichersystem <i>gebunden</i> .  Es ist wie folgt definiert: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l_alloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ud, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> osize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nsize)</span></span></span><span class="hljs-function"> </span></span>{ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)ud; (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)osize; <span class="hljs-comment"><span class="hljs-comment">/* not used */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nsize == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(ptr, nsize); }</code> </pre> <br>  Wie am Anfang des Artikels erw√§hnt, hat das Projekt bereits <i>malloc-</i> und <i>freie</i> Funktionen √ºberschrieben, es gibt jedoch keine <i>Realloc-</i> Funktion.  Wir m√ºssen es reparieren. <br><br>  Im Standardmechanismus f√ºr die Arbeit mit dem FreeRTOS-Heap verf√ºgt die im Projekt verwendete Datei heap_4.c nicht √ºber eine Funktion zum √Ñndern der Gr√∂√üe eines zuvor zugewiesenen Speicherblocks.  In dieser Hinsicht ist es notwendig, seine Umsetzung auf der Grundlage von <i>malloc</i> und <i>frei zu machen</i> . <br><br>  Da es in Zukunft m√∂glich ist, das Speicherzuordnungsschema (unter Verwendung einer anderen Datei heap_x.c) zu √§ndern, wurde beschlossen, nicht die Innenr√§ume des aktuellen Schemas (heap_4.c) zu verwenden, sondern ein Add-In auf h√∂herer Ebene zu erstellen.  Obwohl weniger effektiv. <br><br>  Es ist wichtig zu beachten, dass die <i>Realloc-</i> Methode nicht nur den alten Block (falls vorhanden) l√∂scht und einen neuen erstellt, sondern auch Daten vom alten zum neuen Block verschiebt.  Wenn der alte Block mehr Daten als der neue hatte, wird der neue bis zum Limit mit den alten gef√ºllt und die verbleibenden Daten werden verworfen. <br><br>  Wenn diese Tatsache nicht ber√ºcksichtigt wird, kann Ihr Computer ein solches Skript dreimal ab der Zeile " <i>a = 3 \ n</i> " ausf√ºhren, wonach es in einen schweren Fehler ger√§t.  Das Problem kann gel√∂st werden, nachdem das Restbild der Register im Hard-Error-Handler untersucht wurde, anhand dessen festgestellt werden kann, dass der Absturz aufgetreten ist, nachdem versucht wurde, die Tabelle im Darm des Interpreter-Codes und seiner Bibliotheken zu erweitern.  Wenn Sie ein Skript wie " <i>print 'test'</i> " aufrufen, √§ndert sich das Verhalten abh√§ngig davon, wie die Firmware-Datei zusammengestellt wird (mit anderen Worten, das Verhalten ist undefiniert). <br><br>  Um Daten vom alten Block in den neuen zu kopieren, m√ºssen wir die Gr√∂√üe des alten Blocks ermitteln.  FreeRTOS heap_4.c (wie andere Dateien, die Heap-Behandlungsmethoden bereitstellen) bietet hierf√ºr keine API.  Deshalb musst du deine beenden.  Als Basis habe ich die <i>vPortFree-</i> Funktion genommen und ihre Funktionalit√§t in die folgende Form geschnitten: <br><br><div class="spoiler">  <b class="spoiler_title">VPortGetSizeBlock-Funktionscode</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vPortGetSizeBlock</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *puc = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)pv; BlockLink_t *pxLink; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pv != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { puc -= xHeapStructSize; pxLink = (BlockLink_t *)puc; configASSERT((pxLink-&gt;xBlockSize &amp; xBlockAllocatedBit) != <span class="hljs-number"><span class="hljs-number">0</span></span>); configASSERT(pxLink-&gt;pxNextFreeBlock == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pxLink-&gt;xBlockSize &amp; ~xBlockAllocatedBit; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> </div></div><br>  Jetzt ist es klein, schreibe <i>Realloc</i> basierend auf <i>malloc</i> , <i>free</i> und <i>vPortGetSizeBlock</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Realloc-Implementierungscode basierend auf malloc, free und vPortGetSizeBlock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> new_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* p = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> old_size = vPortGetSizeBlock(ptr); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> cpy_len = (new_size &lt; old_size)?new_size:old_size; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, ptr, cpy_len); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; }</code> </pre> </div></div><br><h2>  Unterst√ºtzung f√ºr die Arbeit mit stdout hinzuf√ºgen </h2><br>  Wie aus der offiziellen Beschreibung hervorgeht, kann der Lua-Interpreter selbst nicht mit I / O arbeiten.  Zu diesem Zweck ist eine der Standardbibliotheken angeschlossen.  F√ºr die Ausgabe wird der <i>stdout-</i> Stream verwendet.  Die Funktion <i>luaopen_io</i> aus der Standardbibliothek ist f√ºr die Verbindung zum Stream verantwortlich.  Um die Arbeit mit <i>stdout zu unterst√ºtzen</i> (im Gegensatz zu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">printf</a> ), m√ºssen Sie die Funktion <i>fwrite</i> √ºberschreiben.  Ich habe es basierend auf den im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorherigen Artikel</a> beschriebenen Funktionen neu definiert. <br><br><div class="spoiler">  <b class="spoiler_title">Fwrite-Funktion</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> fwrite(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *buf, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> count, FILE *stream) { stream = stream; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> len = size * count; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*&gt;(buf); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_write_char((s[i])) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len; }</code> </pre> </div></div><br>  Ohne ihre Definition wird die <i>Druckfunktion</i> in lua erfolgreich ausgef√ºhrt, es erfolgt jedoch keine Ausgabe.  Dar√ºber hinaus gibt es keine Fehler auf dem Lua-Stapel der Maschine (da die Funktion formal erfolgreich ausgef√ºhrt wurde). <br><br>  Zus√§tzlich zu dieser Funktion ben√∂tigen wir die Funktion <i>fflush</i> (damit der interaktive Modus funktioniert, der sp√§ter <i>erl√§utert wird</i> ).  Da diese Funktion nicht √ºberschrieben werden kann, m√ºssen Sie sie etwas anders benennen.  Die Funktion ist eine abgespeckte Version der <i>fwrite-</i> Funktion und soll das, was sich jetzt im Puffer befindet, mit der anschlie√üenden Reinigung (ohne zus√§tzliche Wagen√ºbertragung) senden. <br><br><div class="spoiler">  <b class="spoiler_title">Mc_fflush-Funktion</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mc_fflush</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len = buf_p; buf_p = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uart_1.tx(tx_buf, len, <span class="hljs-number"><span class="hljs-number">100</span></span>) != mc_interfaces::res::ok) { errno = EIO; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br><h2>  Abrufen von Zeichenfolgen von einer seriellen Schnittstelle </h2><br>  Um Strings f√ºr eine Lua-Maschine zu bekommen, habe ich beschlossen, eine einfache Uart-Terminal-Klasse zu schreiben, die: <br><br><ul><li>  empf√§ngt Daten auf einer seriellen Schnittstelle Byte f√ºr Byte (in Interrupt); </li><li>  f√ºgt das empfangene Byte der Warteschlange hinzu, von der der Stream es empf√§ngt; </li><li>  in einem Strom von Bytes, wenn dies kein Zeilenvorschub ist, der in der Form zur√ºckgesendet wird, in der er angekommen ist; </li><li>  Wenn ein Zeilenvorschub angekommen ist (' <i>\ r</i> '), werden 2 Bytes Terminal-Wagenr√ºcklauf gesendet (" <i>\ n \ r</i> "). </li><li>  Nach dem Senden der Antwort wird der Handler des angekommenen Bytes (Linienlayoutobjekt) aufgerufen. </li><li>  steuert das Dr√ºcken der L√∂schzeichentaste (um das L√∂schen von Dienstzeichen aus dem Terminalfenster zu vermeiden); </li></ul><br>  Links zu Quellen: <br><br><ul><li>  Die UART-Klassenschnittstelle ist <a href="">hier</a> ; </li><li>  Die UART-Basisklasse ist <a href="">hier</a> und <a href="">hier</a> ; </li><li>  Klasse uart_terminal <a href="">hier</a> und <a href="">hier</a> ; </li><li>  Erstellen eines Klassenobjekts als Teil des Projekts <a href="">hier</a> . </li></ul><br>  Au√üerdem stelle ich fest, dass Sie der UART-Unterbrechung im zul√§ssigen Bereich f√ºr die Arbeit mit FreeRTOS-Funktionen aus dem Interrupt eine Priorit√§t zuweisen m√ºssen, damit dieses Objekt ordnungsgem√§√ü funktioniert.  Andernfalls k√∂nnen interessante, schwer zu debuggende Fehler auftreten.  Im aktuellen Beispiel sind die folgenden Optionen f√ºr Interrupts in der Datei <a href="">FreeRTOSConfig.h festgelegt</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Einstellungen in FreeRTOSConfig.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configPRIO_BITS 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configKERNEL_INTERRUPT_PRIORITY 0XF0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   FreeRTOS API   //   0x8 - 0xF. #define configMAX_SYSCALL_INTERRUPT_PRIORITY 0x80</span></span></span></span></code> </pre> </div></div><br>  Im Projekt selbst legt ein Objekt der Klasse <i>nvic</i> die Priorit√§t des Interrupts 0x9 fest, der im g√ºltigen Bereich enthalten ist (die Klasse nvic wird <a href="">hier</a> und <a href="">hier beschrieben</a> ). <br><br><h2>  Saitenbildung f√ºr eine Lua-Maschine </h2><br>  Vom uart_terminal-Objekt empfangene Bytes werden an eine Instanz einer einfachen Klasse serial_cli √ºbertragen, die eine minimale Schnittstelle zum Bearbeiten der Zeichenfolge und zum direkten √úbertragen an den Thread bietet, in dem die Lua-Maschine ausgef√ºhrt wird (durch Aufrufen der R√ºckruffunktion).  Beim Akzeptieren des Zeichens '\ r' wird eine R√ºckruffunktion aufgerufen.  Diese Funktion sollte eine Zeile in sich selbst kopieren und die Steuerung ‚Äûfreigeben‚Äú (da der Empfang neuer Bytes w√§hrend eines Aufrufs blockiert wird. Dies ist kein Problem bei korrekt priorisierten Streams und einer ausreichend niedrigen UART-Geschwindigkeit). <br><br>  Links zu Quellen: <br><br><ul><li>  serial_cli Beschreibungsdateien <a href="">hier</a> und <a href="">hier</a> ; </li><li>  Erstellen eines Klassenobjekts als Teil des Projekts <a href="">hier</a> . </li></ul><br>  Es ist wichtig zu beachten, dass diese Klasse eine Zeichenfolge mit mehr als 255 Zeichen f√ºr ung√ºltig h√§lt und sie verwirft.  Dies ist beabsichtigt, da Sie mit dem Lua-Interpreter zeilenweise Konstrukte eingeben k√∂nnen, die auf das Ende des Blocks warten. <br><br><h2>  √úbergabe einer Zeichenfolge an den Lua-Interpreter und dessen Ausf√ºhrung </h2><br>  Der Lua-Interpreter selbst wei√ü nicht, wie er Blockcode zeilenweise akzeptiert und dann den gesamten Block selbst ausf√ºhrt.  Wenn Sie jedoch Lua auf einem Computer installieren und den Interpreter im interaktiven Modus ausf√ºhren, k√∂nnen Sie feststellen, dass die Ausf√ºhrung zeilenweise mit der entsprechenden Notation w√§hrend der Eingabe erfolgt und der Block noch nicht vollst√§ndig ist.  Da der interaktive Modus im Standardpaket enthalten ist, k√∂nnen wir dessen Code sehen.  Es befindet sich in der Datei <a href="">lua.c.</a>  Wir interessieren uns f√ºr die <i>doREPL-</i> Funktion und alles, was sie verwendet.  Um kein Fahrrad zu entwickeln und die Funktionen des interaktiven Modus im Projekt <i>abzurufen</i> , habe ich einen Port dieses Codes in einer separaten Klasse erstellt, die ich <i>lua_repl</i> mit dem Namen der urspr√ºnglichen Funktion benannt habe. <i>Diese</i> verwendet printf, um Informationen an die Konsole auszugeben, und verf√ºgt √ºber eine √∂ffentliche Methode <i>add_lua_string</i> , um eine vom Klassenobjekt empfangene Zeile hinzuzuf√ºgen serial_cli wie oben beschrieben. <br><br>  Referenzen: <br><br><ul><li>  Klassenbeschreibung lua_repl <a href="">hier</a> ; </li><li>  Code <a href="">hier</a> , <a href="">hier</a> und <a href="">hier</a> ; </li></ul><br>  Die Klasse wird nach dem Singleton-Myers-Muster erstellt, da nicht mehrere interaktive Modi innerhalb desselben Ger√§ts angegeben werden m√ºssen.  Ein Objekt der Klasse lua_repl empf√§ngt hier Daten von einem Objekt der Klasse serial_cli. <br><br>  Da das Projekt bereits √ºber ein einheitliches System zum Initialisieren und Verwalten globaler Objekte verf√ºgt, wird der Zeiger auf das Objekt der Klasse lua_repl hier an das Objekt der globalen Klasse <a href="">player :: base √ºbergeben</a> .  In der Startmethode eines Objekts der Klasse <a href="">player :: base</a> ( <a href="">hier</a> deklariert. Es wird auch von main aufgerufen) wird die <i>init-</i> Methode des Objekts der Klasse lua_repl mit der Priorit√§t der FreeRTOS 3-Task aufgerufen (im Projekt k√∂nnen Sie die Priorit√§t der Task von 1 bis 4 zuweisen. Dabei 1 Ist die niedrigste Priorit√§t und 4 ist die h√∂chste).  Nach erfolgreicher Initialisierung startet die globale Klasse den FreeRTOS-Scheduler und der interaktive Modus startet seine Arbeit. <br><br><h2>  Portierungsprobleme </h2><br>  Unten finden Sie eine Liste der Probleme, die beim Lua-Port des Computers aufgetreten sind. <br><br><h4>  Es werden 2-3 einzeilige Skripte der Variablenzuweisung ausgef√ºhrt, dann f√§llt alles in einen schweren Fehler </h4><br>  Das Problem war mit der Realloc-Methode.  Es ist nicht nur erforderlich, den Block erneut auszuw√§hlen, sondern auch den Inhalt des alten zu kopieren (wie oben beschrieben). <br><br><h4>  Beim Versuch, einen Wert zu drucken, ger√§t der Interpreter in einen schweren Fehler </h4><br>  Es war bereits schwieriger, das Problem zu erkennen, aber am Ende konnte ich herausfinden, dass snprintf zum Drucken verwendet wurde.  Da lua Werte doppelt (oder in unserem Fall float) speichert, ist printf (und seine Ableitungen) mit Gleitkommaunterst√ºtzung erforderlich (ich habe hier √ºber die Feinheiten von printf geschrieben). <br><br><h2>  Anforderungen an den nichtfl√ºchtigen (Flash-) Speicher </h2><br>  Hier sind einige Messungen, die ich durchgef√ºhrt habe, um zu beurteilen, wie viel nichtfl√ºchtiger (Flash-) Speicher zugewiesen werden muss, um die Lua-Maschine in das Projekt zu integrieren.  Die Kompilierung wurde unter Verwendung von gcc-arm-none-eabi-8-2018-q4-major durchgef√ºhrt.  Die Version von Lua 5.4 wurde verwendet.  In den Messungen bedeutet der Ausdruck ‚Äûohne Lua‚Äú, dass der Interpreter und die Interaktionsmethoden mit ihm und seinen Bibliotheken sowie ein Objekt der Klasse lua_repl nicht in das Projekt einbezogen werden.  Alle Entit√§ten auf niedriger Ebene (einschlie√ülich √úberschreibungen f√ºr die Funktionen <i>printf</i> und <i>fwrite</i> ) verbleiben im Projekt.  Die FreeRTOS-Heap-Gr√∂√üe betr√§gt 1024 * 25 Byte.  Der Rest wird von globalen Projekteinheiten besetzt. <br><br>  Die zusammenfassende Ergebnistabelle lautet wie folgt (alle Gr√∂√üen in Bytes): <br><table border="1"><tbody><tr><th>  Optionen erstellen </th><th>  Ohne Lua </th><th>  Nur Kern </th><th>  Lua mit Basisbibliothek </th><th>  Lua mit Bibliotheksbasis, Coroutine, Tabelle, String </th><th>  luaL_openlibs </th></tr><tr><td>  -O0 -g3 </td><td>  103028 </td><td>  220924 </td><td>  236124 </td><td>  262652 </td><td>  308372 </td></tr><tr><td>  -O1 -g3 </td><td>  74940 </td><td>  144732 </td><td>  156916 </td><td>  174452 </td><td>  213068 </td></tr><tr><td>  -Os -g0 </td><td>  71172 </td><td>  134228 </td><td>  145756 </td><td>  161428 </td><td>  198400 </td></tr></tbody></table><br><h2>  RAM-Anforderungen </h2><br>  Da der RAM-Verbrauch vollst√§ndig von der Aufgabe abh√§ngt, werde ich unmittelbar nach dem Einschalten des Computers mit einem anderen Satz von Bibliotheken eine √úbersichtstabelle des verbrauchten Speichers geben (diese wird vom Befehl <i>print (collectgarbage ("count") * 1024</i> ) angezeigt. <br><table border="1"><tbody><tr><td>  Zusammensetzung </td><td>  RAM verwendet </td></tr><tr><td>  Lua mit Basisbibliothek </td><td>  4809 </td></tr><tr><td>  Lua mit Bibliotheksbasis, Coroutine, Tabelle, String </td><td>  6407 </td></tr><tr><td>  luaL_openlibs </td><td>  12769 </td></tr></tbody></table><br>  Bei Verwendung aller Bibliotheken wird die Gr√∂√üe des erforderlichen RAM im Vergleich zu den vorherigen S√§tzen erheblich erh√∂ht.  Die Verwendung in einem erheblichen Teil der Anwendungen ist jedoch nicht erforderlich. <br><br>  Zus√§tzlich werden dem Taskstack, in dem die Lua-Maschine ausgef√ºhrt wird, 4 kb zugewiesen. <br><br><h2>  Weitere Verwendung </h2><br>  Um die Maschine im Projekt vollst√§ndig nutzen zu k√∂nnen, m√ºssen Sie alle Schnittstellen, die der Gesch√§ftslogikcode f√ºr die Hardware- oder Serviceobjekte des Projekts ben√∂tigt, n√§her beschreiben.  Dies ist jedoch das Thema eines separaten Artikels. <br><br><h2>  Zusammenfassung </h2><br>  In diesem Artikel wurde beschrieben, wie Sie eine Lua-Maschine mit einem Projekt f√ºr einen Mikrocontroller verbinden und einen vollwertigen interaktiven Interpreter starten, mit dem Sie direkt √ºber die Befehlszeile des Terminals mit Gesch√§ftslogik experimentieren k√∂nnen.  Zus√§tzlich wurden die Anforderungen an die Hardware des Mikrocontrollers f√ºr verschiedene Konfigurationen der Lua-Maschine ber√ºcksichtigt. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de459602/">https://habr.com/ru/post/de459602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de459590/index.html">Dezentrales Open Source-Partnerprogramm in der Waves-Blockchain</a></li>
<li><a href="../de459592/index.html">Drei Zeitmanagement-Tipps f√ºr diejenigen, die alles versucht haben.</a></li>
<li><a href="../de459594/index.html">Lesen Sie zwischen den Noten: Daten√ºbertragungssystem in der Musik</a></li>
<li><a href="../de459596/index.html">iOS Digest Nr. 9 (28. Juni - 11. Juli)</a></li>
<li><a href="../de459598/index.html">H√§ufig gestellte Fragen zu SELinux (FAQ)</a></li>
<li><a href="../de459604/index.html">Telegramm - Bot | Vollst√§ndiges Men√º</a></li>
<li><a href="../de459606/index.html">Verteilte soziale Netzwerke</a></li>
<li><a href="../de459610/index.html">Diese gef√§hrlichen Router: das umfangreichste Hacken aktueller Netzwerkger√§te und Schutzmethoden</a></li>
<li><a href="../de459612/index.html">Wie Qualcomm die Mobilfunkbranche fast 20 Jahre hintereinander betrogen hat</a></li>
<li><a href="../de459614/index.html">Roboterente r√ºhrt Reisfelder auf</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>