<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üó°Ô∏è üëäüèº ‚òÄÔ∏è Crear una API REST con Node.js y una Base de datos Oracle. Parte 2 üëµüèø üë©üèø‚Äçü§ù‚Äçüë©üèº üôÖüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parte 2: Crear una API REST: Conceptos b√°sicos de la base de datos 
 En el primer art√≠culo, cre√≥ un servidor web, aqu√≠ crear√° un m√≥dulo que es respons...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Crear una API REST con Node.js y una Base de datos Oracle. Parte 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473346/"><h4>  Parte 2: Crear una API REST: Conceptos b√°sicos de la base de datos </h4><br>  En el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">primer art√≠culo,</a> cre√≥ un servidor web, aqu√≠ crear√° un m√≥dulo que es responsable de iniciar y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cerrar el</a> grupo de conexiones de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la</a> base de datos utilizando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">node-oracledb</a> .  Y agregue una funci√≥n que simplifique la ejecuci√≥n de declaraciones simples al obtener y liberar autom√°ticamente conexiones del grupo. <br><a name="habracut"></a><br><h4>  Ejecuci√≥n de grupo de conexiones </h4><br>  Debido a que node-oracledb est√° construido sobre las bibliotecas de cliente OCI, tiene soporte incorporado para crear grupos OCI que son del lado del cliente y tienen excelentes caracter√≠sticas de rendimiento.  Para crear un grupo de conexiones, comience creando un nuevo archivo de configuraci√≥n llamado <b>database.js</b> en el directorio de <b>configuraci√≥n</b> .  Copie y pegue el siguiente c√≥digo en el archivo y guarde los cambios. <br><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">hrPool</span></span>: { <span class="hljs-attr"><span class="hljs-attr">user</span></span>: process.env.HR_USER, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: process.env.HR_PASSWORD, <span class="hljs-attr"><span class="hljs-attr">connectString</span></span>: process.env.HR_CONNECTIONSTRING, <span class="hljs-attr"><span class="hljs-attr">poolMin</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">poolMax</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">poolIncrement</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } };</code> </pre> <br>  Al igual que con el archivo <b>config / webserver.js</b> , este archivo le permite establecer algunas propiedades utilizando variables de entorno.  El uso de variables de entorno proporciona flexibilidad al implementar la aplicaci√≥n en diferentes entornos y ayuda a guardar contrase√±as y otra informaci√≥n confidencial fuera del c√≥digo fuente.  Ejecute los siguientes comandos desde el terminal para establecer las variables de entorno necesarias y aseg√∫rese de que est√©n disponibles en futuras sesiones del terminal. <br><br><pre> <code class="plaintext hljs">echo "export HR_USER=hr" &gt;&gt; ~/.bashrc echo "export HR_PASSWORD=oracle" &gt;&gt; ~/.bashrc echo "export HR_CONNECTIONSTRING=0.0.0.0/orcl" &gt;&gt; ~/.bashrc source ~/.bashrc</code> </pre> <br>  Puede notar que poolMin y poolMax eran iguales y que poolIncrement se estableci√≥ en 0. Esto crear√° un grupo de tama√±o fijo que requiere menos recursos de administraci√≥n, una buena idea para los grupos que obtienen un uso constante. <br><br>  Aunque Node.js a menudo se describe como "de un solo subproceso", tiene un grupo de subprocesos disponible para ciertas operaciones que de otro modo bloquear√≠an el subproceso principal que ejecuta c√≥digo JavaScript.  Este grupo de subprocesos es utilizado por node-oracledb para realizar todas sus operaciones asincr√≥nicas, como recibir conexiones y ejecutar c√≥digo SQL y PL / SQL.  Sin embargo, el tama√±o predeterminado del grupo de subprocesos es 4. Si desea que las 10 conexiones en el grupo funcionen simult√°neamente, debe aumentar el n√∫mero de subprocesos en consecuencia. <br><br>  La variable de entorno UV_THREADPOOL_SIZE se puede usar para ajustar el tama√±o del grupo de subprocesos.  UV_THREADPOOL_SIZE se puede configurar antes de ejecutar la aplicaci√≥n Node.js o desde dentro, pero se debe configurar antes de que se realice la primera llamada utilizando el grupo de subprocesos.  Esto se debe al hecho de que el grupo de subprocesos se crea en su primer uso y despu√©s de su creaci√≥n, su tama√±o es fijo.  Abra el archivo <b>index.js</b> en la ra√≠z de la aplicaci√≥n y agregue las siguientes l√≠neas despu√©s de la primera l√≠nea (que contiene el m√≥dulo del servidor web). <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that requires services/web-server.js is here *** const dbConfig = require('./config/database.js'); const defaultThreadPoolSize = 4; // Increase thread pool size by poolMax process.env.UV_THREADPOOL_SIZE = dbConfig.hrPool.poolMax + defaultThreadPoolSize;</span></span></code> </pre> <br>  Ahora que el grupo de subprocesos tiene el tama√±o adecuado, puede ir al m√≥dulo de base de datos.  Cree un nuevo archivo en el directorio de <b>servicios</b> denominado <b>database.js</b> .  Copie y pegue el siguiente c√≥digo y guarde los cambios. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> oracledb = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'oracledb'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dbConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../config/database.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pool = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> oracledb.createPool(dbConfig.hrPool); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.initialize = initialize;</code> </pre> <br>  Este m√≥dulo primero introduce node-oracledb y el archivo de configuraci√≥n.  Luego, se define una funci√≥n asincr√≥nica con el nombre initialize, que luego se proporciona a trav√©s del objeto module.exports.  La funci√≥n de inicializaci√≥n crea un grupo de conexiones, que se almacena en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">memoria cach√© interna de los grupos de conexiones</a> como el grupo predeterminado. <br><br>  Ahora debe conectar todo para que el grupo de conexiones se inicie antes de que se abra el servidor web.  Regrese a <b>index.js</b> y agregue la siguiente l√≠nea debajo de la l√≠nea 1. <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that requires services/web-server.js is here *** const database = require('./services/database.js');</span></span></code> </pre> <br>  Luego agregue el siguiente bloque try a la funci√≥n stratup, inmediatamente antes del bloque try existente que inicia el servidor web. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Initializing database module'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> database.initialize(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(err); process.exit(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Non-zero failure code } // *** existing try block in startup here ***</span></span></code> </pre> <br>  En este punto, puede instalar node-oracledb y probar el c√≥digo.  Ejecute los siguientes comandos en una terminal desde el directorio hr_app. <br><br><pre> <code class="javascript hljs">npm install oracledb -s node .</code> </pre> <br>  Si ve mensajes de que el m√≥dulo de base de datos y el servidor web se est√°n ejecutando, felicidades, ¬°su grupo de conexiones ahora est√° funcionando! <br><br><h4>  Cerrar el grupo de conexiones </h4><br>  Si cierra la aplicaci√≥n ahora (usando ctrl + c, como antes), el proceso Node.js se destruir√° antes de que se cierre el grupo de conexiones.  Aunque todos los procesos de bases de datos relacionados se deben limpiar autom√°ticamente, es mejor cerrar expl√≠citamente el grupo de conexiones antes de salir del proceso Node.js. <br><br>  Regrese al archivo <b>services / database.js</b> , agregue las siguientes l√≠neas de c√≥digo al final y guarde las actualizaciones. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** previous code above this line *** async function close() { await oracledb.getPool().close(); } module.exports.close = close;</span></span></code> </pre> <br>  La funci√≥n de cierre utiliza el m√©todo oracledb.getPool () para obtener el grupo predeterminado de forma s√≠ncrona, y luego llama al m√©todo de cierre en el grupo para cerrarlo. <br><br>  Para llamar a la funci√≥n de cierre en el momento adecuado, agregue las siguientes l√≠neas de c√≥digo al archivo <b>index.js</b> dentro de la funci√≥n de apagado inmediatamente despu√©s del bloque de prueba existente que detiene el servidor web. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** existing try-catch block in shutdown here *** try { console.log('Closing database module'); await database.close(); } catch (err) { console.log('Encountered error', e); err = err || e; }</span></span></code> </pre> <br>  Si inicia y cierra la aplicaci√≥n nuevamente, ver√° que el m√≥dulo de base de datos se cierra despu√©s de cerrar el servidor web, pero antes de que se complete el proceso. <br><br><h4>  Simplifique las operaciones CRUD simples </h4><br>  Ejecutar c√≥digo SQL o PL / SQL usando node-oracledb suele ser un proceso de tres pasos: obtener la conexi√≥n, ejecutar el c√≥digo y luego liberar la conexi√≥n.  Si todo lo que quiere hacer es hacer una llamada para ejecutar (no se requiere una transacci√≥n de varios pasos), entonces recibir y liberar la conexi√≥n puede parecer un c√≥digo est√°ndar.  Me gusta crear una funci√≥n que realice las tres operaciones en una sola llamada.  Regrese al archivo <b>services / database.js</b> , agregue el siguiente c√≥digo a continuaci√≥n y guarde los cambios. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** previous code above this line *** function simpleExecute(statement, binds = [], opts = {}) { return new Promise(async (resolve, reject) =&gt; { let conn; opts.outFormat = oracledb.OBJECT; opts.autoCommit = true; try { conn = await oracledb.getConnection(); const result = await conn.execute(statement, binds, opts); resolve(result); } catch (err) { reject(err); } finally { if (conn) { // conn assignment worked, need to close try { await conn.close(); } catch (err) { console.log(err); } } } }); } module.exports.simpleExecute = simpleExecute;</span></span></code> </pre> <br>  Normalmente, no utilizar√° el m√≥dulo de base de datos en el m√≥dulo del servidor web, sino que lo agregar√° ahora para verificar que funciona correctamente.  Abra el <b>archivo services / web-server.js</b> y agregue la siguiente l√≠nea debajo de las declaraciones constantes existentes en la parte superior. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// line that requires ../config/web-server.js here const database = require('./database.js');</span></span></code> </pre> <br>  Luego use el siguiente c√≥digo para reemplazar todo el controlador app.get que responde con "Hello World!"  (Las 3 l√≠neas). <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that adds morgan to app here *** app.get('/', async (req, res) =&gt; { const result = await database.simpleExecute('select user, systimestamp from dual'); const user = result.rows[0].USER; const date = result.rows[0].SYSTIMESTAMP; res.end(`DB user: ${user}\nDate: ${date}`); });</span></span></code> </pre> <br>  El nuevo controlador utiliza la funci√≥n simpleExecute del m√≥dulo de base de datos para recuperar los valores del usuario actual y la marca de sistema de la base de datos.  Los valores se utilizan en el literal de la plantilla para responder al cliente con un mensaje din√°mico. <br><br>  Inicie la aplicaci√≥n nuevamente y vaya a localhost: 3000. Deber√≠a ver algo como la siguiente imagen. <br><br><img src="https://habrastorage.org/webt/fu/89/1t/fu891trgyo2sweotztn8s0l-h-i.png" alt="imagen"><br><br>  Si ve este mensaje, entonces todo funciona como deber√≠a.  En el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">siguiente art√≠culo,</a> continuar√° creando la API agregando el enrutamiento, el controlador y la l√≥gica de la base de datos para la solicitud GET. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/473346/">https://habr.com/ru/post/473346/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../473334/index.html">Cat Ghonim: ¬øC√≥mo hacer que los gatos no se alivien en el c√©sped en casa?</a></li>
<li><a href="../473338/index.html">TDD: c√≥mo escribir las especificaciones correctamente (describe)</a></li>
<li><a href="../473340/index.html">El resumen de materiales frescos del mundo del front-end para la √∫ltima semana No. 386 (21-27 de octubre de 2019)</a></li>
<li><a href="../473342/index.html">"El largo camino te est√° esperando ..." o resolviendo el problema de pron√≥stico en C # usando Ml.NET (DataScience)</a></li>
<li><a href="../473344/index.html">Conciertos y eventos KudaGo en tu espejo</a></li>
<li><a href="../473348/index.html">La idea de inercia (SGDm), la idea de escalamiento (Adagrad) y la regularizaci√≥n en el aprendizaje autom√°tico utilizando el problema de clasificaci√≥n como ejemplo</a></li>
<li><a href="../473350/index.html">Crear una API REST con Node.js y una Base de datos Oracle. Parte 3</a></li>
<li><a href="../473352/index.html">–° colecciones actuales en 10 minutos</a></li>
<li><a href="../473354/index.html">Sobre las rarezas de la habost√°tica</a></li>
<li><a href="../473358/index.html">Instale y configure Nexus Sonatype utilizando la infraestructura como enfoque de c√≥digo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>