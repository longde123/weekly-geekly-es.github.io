<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîü ‚ôøÔ∏è üë©‚Äçüë¶‚Äçüë¶ LuaVela: impl√©mentation de Lua 5.1 bas√©e sur LuaJIT 2.0 üõåüèø üåú ‚òëÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, nous avons annonc√© une version publique et ouvert sous licence MIT le code source de LuaVela - une impl√©mentation de Lua 5.1, ba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>LuaVela: impl√©mentation de Lua 5.1 bas√©e sur LuaJIT 2.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iponweb/blog/465441/">  Il y a quelque temps, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">annonc√© une</a> version publique et ouvert sous licence MIT le code source de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LuaVela</a> - une impl√©mentation de Lua 5.1, bas√©e sur LuaJIT 2.0.  Nous avons commenc√© √† travailler dessus en 2015 et, d√©but 2017, il a √©t√© utilis√© dans plus de 95% des projets de l'entreprise.  Maintenant, je veux revenir sur le chemin parcouru.  Quelles circonstances nous ont pouss√©s √† d√©velopper notre propre impl√©mentation d'un langage de programmation?  Quels probl√®mes avons-nous rencontr√©s et comment les avons-nous r√©solus?  En quoi LuaVela est-elle diff√©rente des autres fourches LuaJIT? <br><a name="habracut"></a><br><h1>  Contexte </h1><br>  Cette section est bas√©e sur notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> sur HighLoad ++.  Nous avons commenc√© √† utiliser activement Lua pour √©crire la logique commerciale de nos produits en 2008.  Au d√©but, c'√©tait de la vanille Lua, et depuis 2009 - LuaJIT.  Le protocole RTB a √©tabli un cadre serr√© pour le traitement de la demande, de sorte que la transition vers une mise en ≈ìuvre plus rapide de la langue √©tait une solution logique et, √† un certain point, n√©cessaire. <br><br>  Au fil du temps, nous avons r√©alis√© qu'il y avait certaines limites √† l'architecture LuaJIT.  La chose la plus importante pour nous √©tait que LuaJIT 2.0 utilise strictement des pointeurs 32 bits.  Cela nous a conduit √† une situation o√π l'ex√©cution sur Linux 64 bits limitait la taille de l'espace d'adressage virtuel de la m√©moire de processus √† un gigaoctet (dans les versions ult√©rieures du noyau Linux, cette limite √©tait port√©e √† deux gigaoctets): <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* MAP_32BIT    4  x86-64: */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *ptr = mmap((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)MMAP_REGION_START, size, MMAP_PROT, MAP_32BIT | MMAP_FLAGS, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  Cette limitation est devenue un gros probl√®me - en 2015, 1 √† 2 gigaoctets de m√©moire ont cess√© d'√™tre suffisants pour que de nombreux projets chargent les donn√©es avec lesquelles la logique a fonctionn√©.  Il convient de noter que chaque instance de la machine virtuelle Lua est monothread et ne sait pas comment partager des donn√©es avec d'autres instances - cela signifie qu'en pratique, chaque machine virtuelle peut revendiquer une taille de m√©moire ne d√©passant pas 2 Go / n, o√π n est le nombre de flux de travail de notre serveur applications. <br><br>  Nous sommes pass√©s par plusieurs solutions au probl√®me: nous avons r√©duit le nombre de threads dans notre serveur d'applications, essay√© d'organiser l'acc√®s aux donn√©es via LuaJIT FFI, test√© la transition vers LuaJIT 2.1.  Malheureusement, toutes ces options √©taient soit √©conomiquement d√©savantageuses, soit mal adapt√©es √† long terme.  Il ne nous restait plus qu'√† tenter notre chance et bifurquer LuaJIT.  √Ä ce moment, nous avons pris des d√©cisions qui ont largement d√©termin√© le sort du projet. <br><br>  Tout d'abord, nous avons imm√©diatement d√©cid√© de ne pas modifier la syntaxe et la s√©mantique du langage, en nous concentrant sur la suppression des limites architecturales de LuaJIT, ce qui s'est av√©r√© √™tre un probl√®me pour l'entreprise.  Bien s√ªr, au fur et √† mesure du d√©veloppement du projet, nous avons commenc√© √† ajouter des extensions (nous en discuterons ci-dessous) - mais nous avons isol√© toutes les nouvelles API de la biblioth√®que de langues standard. <br><br>  De plus, nous avons abandonn√© la multiplateforme pour ne prendre en charge que Linux x86-64, notre seule plate-forme de production.  Malheureusement, nous n'avions pas suffisamment de ressources pour tester ad√©quatement la quantit√© gigantesque de changements que nous allions apporter √† la plateforme. <br><br><h1>  Un coup d'≈ìil sous le capot de la plateforme </h1><br>  Voyons d'o√π vient la restriction sur la taille des pointeurs.  Pour commencer, le type de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nombre</a> dans Lua 5.1 est (avec quelques mises en garde mineures) le type C double, qui √† son tour correspond au type √† double pr√©cision d√©fini par la norme IEEE 754. Dans le codage de ce type 64 bits, la plage de valeurs est mise en √©vidence pour la pr√©sentation NaN.  En particulier, comment toute valeur dans la plage [0xFFF8000000000000;  0xFFFFFFFFFFFFFFFF]. <br><br>  Ainsi, nous pouvons regrouper dans une seule valeur 64 bits soit un nombre ¬´r√©el¬ª √† double pr√©cision, soit une entit√© qui, du point de vue du type double, sera interpr√©t√©e comme NaN, et du point de vue de notre plateforme, ce sera quelque chose de plus significatif - par exemple, par le type d'objet (haut 32 bits) et un pointeur sur son contenu (bas 32 bits): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">union</span></span> TValue { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> n; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *payload; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> type; } o; };</code> </pre><br>  Cette technique est parfois appel√©e marquage NaN (ou boxe NaN), et TValue d√©crit essentiellement comment LuaJIT repr√©sente les valeurs variables dans Lua.  TValue a √©galement une troisi√®me hypostase utilis√©e pour stocker un pointeur sur une fonction et des informations pour rembobiner la pile Lua, c'est-√†-dire qu'en derni√®re analyse, la structure des donn√©es ressemble √† ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">union</span></span> TValue { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> n; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *payload; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> type; } o; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frame</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *func; <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> link; } f; };</code> </pre><br>  Le champ frame.link dans la d√©finition ci-dessus est de type uintptr_t, car dans certains cas, il stocke un pointeur et dans d'autres, il s'agit d'un entier.  Le r√©sultat est une repr√©sentation tr√®s compacte de la pile de machines virtuelles - en fait, il s'agit d'un tableau TValue, et chaque √©l√©ment du tableau est interpr√©t√© de mani√®re situationnelle soit comme un nombre, puis comme un pointeur typ√© vers un objet, ou comme des donn√©es sur le cadre de la pile Lua. <br><br>  Regardons un exemple.  Imaginez que nous avons commenc√© avec LuaJIT ce code Lua et d√©fini un point d'arr√™t √† l'int√©rieur de la fonction d'impression: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello, "</span></span> .. x) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">pi</span></span> foo(b) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> bar({}, <span class="hljs-string"><span class="hljs-string">"Lua"</span></span>)</code> </pre><br>  √Ä ce stade, la pile Lua ressemblera √† ceci: <br><br><img src="https://habrastorage.org/webt/1n/av/hn/1navhnm8vbz-inawirkvewxppme.png" alt="Pile Lua utilisant LuaJIT 2.0"><br><br>  Et tout irait bien, mais cette technique commence √† √©chouer d√®s que nous essayons de d√©marrer sur x86-64.  Si nous fonctionnons en mode de compatibilit√© pour les applications 32 bits, nous nous appuyons sur la restriction mmap d√©j√† mentionn√©e ci-dessus.  Et les pointeurs 64 bits ne fonctionneront pas du tout.  Que faire  Pour r√©soudre le probl√®me, j'ai d√ª: <br><br><ol><li>  √âtendez TValue de 64 √† 128 bits: de cette fa√ßon, nous obtenons un vide ¬´honn√™te¬ª * sur une plate-forme 64 bits. </li><li>  Corrigez le code de la machine virtuelle en cons√©quence. </li><li>  Apportez des modifications au compilateur JIT. </li></ol><br>  Le volume total des changements s'est av√©r√© tr√®s important et nous a assez √©loign√©s du LuaJIT original.  Il convient de noter que l'extension TValue n'est pas le seul moyen de r√©soudre le probl√®me.  Dans LuaJIT 2.1, nous sommes all√©s dans l'autre sens en impl√©mentant le mode LJ_GC64.  Peter Cawley, qui a √©norm√©ment contribu√© au d√©veloppement de ce mode de fonctionnement, en a pris connaissance lors d'une r√©union √† Londres.  Eh bien, dans le cas de LuaVela, la pile du m√™me exemple ressemble √† ceci: <br><br><img src="https://habrastorage.org/webt/ar/rj/yv/arrjyvsnfyixhd8haufn95nhgu8.png" alt="Pile Lua lors de l'utilisation de LuaVela"><br><br><h1>  Premiers succ√®s et stabilisation du projet </h1><br>  Apr√®s des mois de d√©veloppement actif, il est temps d'essayer LuaVela au combat.  √Ä titre exp√©rimental, nous avons choisi les projets les plus probl√©matiques en termes de consommation de m√©moire: la quantit√© de donn√©es avec laquelle ils devaient travailler, d√©passait √©videmment 1 gigaoctet, ils ont donc √©t√© contraints d'utiliser diverses solutions de contournement.  Les premiers r√©sultats sont encourageants: LuaVela est stable et pr√©sente de meilleures performances par rapport √† la configuration LuaJIT utilis√©e dans ces m√™mes projets. <br><br>  Dans le m√™me temps, la question des tests s'est pos√©e.  Heureusement, nous n'avons pas eu √† repartir de z√©ro, car d√®s le premier jour de d√©veloppement, en plus des serveurs de mise en sc√®ne, nous avions √† notre disposition: <br><br><ul><li>  Tests fonctionnels et d'int√©gration d'un serveur d'applications qui ex√©cute la logique m√©tier de tous les projets de l'entreprise. </li><li>  Tests de projets individuels. </li></ul><br>  Comme la pratique l'a montr√©, ces ressources √©taient suffisantes pour d√©boguer et amener le projet dans un √©tat stable minimum (ils ont fait un assemblage de dev - d√©ploy√© en mise en sc√®ne - cela fonctionne et ne plante pas).  En revanche, de tels tests √† travers d'autres projets √©taient totalement inadapt√©s √† long terme: un projet d'une telle complexit√© que l'impl√©mentation d'un langage de programmation ne peut pas avoir ses propres tests.  De plus, le manque de tests directement dans le projet a purement techniquement compliqu√© la recherche et la correction des erreurs. <br><br>  Dans un monde id√©al, nous voulions tester non seulement notre impl√©mentation, mais √©galement disposer d'un ensemble de tests qui nous permettrait de le valider par rapport √† la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s√©mantique du langage</a> .  Malheureusement, une certaine d√©ception nous attend √† ce sujet.  Malgr√© le fait que la communaut√© Lua cr√©e volontairement des fourches d'impl√©mentations existantes, jusqu'√† r√©cemment, un ensemble similaire de tests de validation manquait.  La situation a chang√© pour le mieux quand, fin 2018, Fran√ßois Perrad a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">annonc√©</a> le projet lua-Harness. <br><br>  Au final, nous avons r√©solu le probl√®me des tests en int√©grant les suites de tests les plus compl√®tes et repr√©sentatives de l'√©cosyst√®me Lua dans notre r√©f√©rentiel: <br><br><ul><li>  <a href="">Tests</a> √©crits par les cr√©ateurs du langage pour leur impl√©mentation de Lua 5.1. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tests</a> fournis par la communaut√© par l'auteur de LuaJIT, Mike Pall. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">harnais lua</a> </li><li>  Un sous-ensemble des tests du projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MAD en</a> cours d'√©laboration par le CERN. </li><li>  Deux ensembles de tests que nous avons cr√©√©s dans IPONWEB et qui continuent d'√™tre remplis jusqu'√† pr√©sent: l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> pour les tests fonctionnels de la plateforme, l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">autre</a> utilisant le framework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cmocka</a> pour tester l'API C et tout ce qui manque de test au niveau du code Lua. </li></ul><br>  L'introduction de chaque lot de tests nous a permis de d√©tecter et de corriger 2-3 erreurs critiques - il est donc √©vident que nos efforts ont port√© leurs fruits.  Bien que le sujet des tests de runtimes de langage et des compilateurs (√† la fois statiques et dynamiques) soit vraiment illimit√©, nous pensons avoir pos√© une base assez solide pour un d√©veloppement stable du projet.  Nous avons parl√© des probl√®mes de test de notre propre impl√©mentation de Lua (y compris des sujets tels que le travail avec des bancs de test et le d√©bogage post-mortem) √† deux reprises, √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lua √† Moscou 2017</a> et √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad ++ 2018</a> - tous ceux qui sont int√©ress√©s par les d√©tails sont invit√©s √† regarder une vid√©o de ces rapports.  Eh bien, regardez le r√©pertoire des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tests</a> dans notre r√©f√©rentiel, bien s√ªr. <br><br><h1>  De nouvelles fonctionnalit√©s </h1><br>  Ainsi, nous avions √† notre disposition une impl√©mentation stable de Lua 5.1 pour Linux x86-64, d√©velopp√©e par les forces d'une petite √©quipe, qui ¬´ma√Ætrisait¬ª progressivement l'h√©ritage LuaJIT et accumulait une expertise.  Dans de telles conditions, le d√©sir d'√©tendre la plate-forme et d'ajouter des fonctionnalit√©s qui ne sont ni dans vanilla Lua ni dans LuaJIT, mais qui nous aideraient √† r√©soudre d'autres probl√®mes urgents, est devenu tout √† fait naturel. <br><br>  Une description d√©taill√©e de toutes les extensions est fournie dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> au format RST (utilisez cmake. &amp;&amp; make docs pour construire une copie locale au format HTML).  Une description compl√®te des extensions de l'API Lua peut √™tre trouv√©e <a href="">sur ce lien</a> , et l'API C <a href="">ici</a> .  Malheureusement, dans un article de revue, il est impossible de parler de tout, alors voici une liste des fonctions les plus importantes: <br><br><ul><li>  DataState - la possibilit√© d'organiser l'acc√®s partag√© √† un objet √† partir de plusieurs instances ind√©pendantes de machines virtuelles Lua. </li><li>  La possibilit√© de d√©finir <a href="">un d√©lai d'expiration pour la coroutine</a> et d'interrompre l'ex√©cution de ceux qui s'ex√©cutent plus longtemps qu'elle. </li><li>  Un ensemble d'optimisations de compilateur JIT con√ßues pour lutter contre l'augmentation exponentielle du nombre de traces lors de la copie de donn√©es entre des objets - nous en avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parl√©</a> √† HighLoad ++ 2017, mais il y a quelques mois √† peine, nous avions de nouvelles id√©es de travail qui n'avaient pas encore √©t√© document√©es. </li><li>  Nouvelle bo√Æte √† outils: Sampling Profiler.  analyseur de sortie de d√©bogage du compilateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dumpanalyze</a> , etc. </li></ul><br>  Chacune de ces fonctionnalit√©s m√©rite un article s√©par√© - √©crivez dans les commentaires celui dont vous souhaitez en savoir plus. <br><br>  Ici, je veux parler un peu plus de la fa√ßon dont nous avons r√©duit la charge sur le ramasse-miettes.  <a href="">Le scellement</a> vous permet de rendre un objet inaccessible au ramasse-miettes.  Dans notre projet typique, la plupart des donn√©es (jusqu'√† 80%) √† l'int√©rieur de la machine virtuelle Lua sont d√©j√† des r√®gles m√©tier, qui sont une table Lua complexe.  La dur√©e de vie de cette table (minutes) est beaucoup plus longue que la dur√©e de vie des demandes trait√©es (dizaines de millisecondes) et les donn√©es qu'elle contient ne changent pas pendant le traitement des requ√™tes.  Dans une telle situation, cela n'a aucun sens de forcer le ramasse-miettes √† r√©curer autour de cette √©norme structure de donn√©es encore et encore.  Pour ce faire, nous ¬´scellons¬ª r√©cursivement l'objet et r√©organisons les donn√©es de mani√®re √† ce que le garbage collector n'atteigne jamais l'objet ¬´scell√©¬ª ou son contenu.  Dans vanilla Lua 5.4, ce probl√®me sera <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©solu en</a> prenant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en</a> charge des g√©n√©rations d'objets dans le garbage collection g√©n√©rationnel. <br><br>  Il est important de garder √† l'esprit que les objets ¬´scell√©s¬ª ne doivent pas √™tre inscriptibles.  Le non-respect de cet invariant conduit √† l'apparition de pointeurs pendants: par exemple, un objet "scell√©" fait r√©f√©rence √† un objet r√©gulier, et un ramasse-miettes, sautant un objet "scell√©" en traversant un tas, saute un objet r√©gulier - √† la diff√©rence qu'un objet "scell√©" ne peut pas √™tre lib√©r√©, et l'habituel peut.  Ayant impl√©ment√© le support de cet invariant, nous obtenons essentiellement un support d' <a href="">immunit√©</a> gratuit <a href="">pour les</a> objets, dont l'absence est souvent d√©plor√©e √† Lua.  J'insiste sur le fait que les objets immuables et ¬´scell√©s¬ª ne sont pas la m√™me chose.  La deuxi√®me propri√©t√© implique la premi√®re, mais pas l'inverse. <br><br>  Je note √©galement que dans Lua 5.1, l'immunit√© peut √™tre impl√©ment√©e √† l'aide de m√©tatables - la solution fonctionne assez bien, mais n'est pas la plus rentable en termes de performances.  De plus amples informations sur le ¬´scellement¬ª, l'immunit√© et la fa√ßon dont nous les utilisons dans la vie quotidienne se trouvent dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce</a> rapport. <br><br><h1>  Conclusions </h1><br>  Pour le moment, nous sommes satisfaits de la stabilit√© et de l'ensemble des opportunit√©s pour notre mise en ≈ìuvre.  Et bien qu'en raison des limitations initiales, notre impl√©mentation soit nettement inf√©rieure √† vanilla Lua et LuaJIT en termes de portabilit√©, elle r√©sout bon nombre de nos probl√®mes - nous esp√©rons que ces solutions sont utiles √† quelqu'un d'autre. <br><br>  De plus, m√™me si LuaVela n'est pas adapt√© √† la production, nous vous invitons √† l'utiliser comme point d'entr√©e pour comprendre le fonctionnement de LuaJIT ou de sa fourche.  En plus de r√©soudre des probl√®mes et d'√©tendre les fonctionnalit√©s, au fil des ans, nous avons remani√© une partie importante de la base de code et r√©dig√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des articles de formation</a> sur la structure interne du projet - beaucoup d'entre eux s'appliquent non seulement √† LuaVela, mais aussi √† LuaJIT. <br><br>  Merci de votre attention, nous attendons les demandes de pull! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465441/">https://habr.com/ru/post/fr465441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr465429/index.html">Pourtant, C est un langage de bas niveau</a></li>
<li><a href="../fr465431/index.html">Analyse du code source RPC du framework Apache Dubbo avec l'analyseur statique PVS-Studio</a></li>
<li><a href="../fr465433/index.html">Robots de travail - homme heureux</a></li>
<li><a href="../fr465435/index.html">Quelle distribution est pr√©f√©rable d'utiliser pour votre syst√®me embarqu√©?</a></li>
<li><a href="../fr465437/index.html">Pourquoi j'ai refus√© de travailler dans AWS</a></li>
<li><a href="../fr465445/index.html">Notes du fournisseur IoT. Impulse Exit Curse</a></li>
<li><a href="../fr465449/index.html">Comment les probl√®mes de Mail.ru et du FSB ont √©t√© forg√©s par la r√©putation de Pavel Durov et la foi en Telegram</a></li>
<li><a href="../fr465453/index.html">3 septembre - Journ√©e CTO √† Saint-P√©tersbourg</a></li>
<li><a href="../fr465455/index.html">Travailler avec les incidents, am√©liorer la r√©ponse aux incidents et la valeur de la dette technique. Mat√©riaux mitap United Backend 4: Okroshka</a></li>
<li><a href="../fr465457/index.html">√Ä propos de PBR sur les doigts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>