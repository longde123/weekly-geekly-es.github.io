<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôè üñïüèº üëßüèΩ Membangun cluster PostgreSQL ketersediaan tinggi menggunakan Patroni, etcd, HAProxy üòõ üåª üíõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kebetulan pada saat menetapkan masalah saya tidak memiliki tingkat pengalaman yang cukup untuk mengembangkan dan menjalankan solusi ini sendirian. Dan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Membangun cluster PostgreSQL ketersediaan tinggi menggunakan Patroni, etcd, HAProxy</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482314/"><p>  Kebetulan pada saat menetapkan masalah saya tidak memiliki tingkat pengalaman yang cukup untuk mengembangkan dan menjalankan solusi ini sendirian.  Dan kemudian saya mulai googling. </p><br><p>  Saya tidak tahu apa masalahnya, tetapi untuk kesekian kalinya saya dihadapkan pada kenyataan bahwa bahkan jika Anda melakukan semuanya langkah demi langkah seperti dalam tutorial, menyiapkan lingkungan yang sama seperti penulis, maka tidak ada yang berhasil.  Saya tidak tahu tentang apa ini, tetapi ketika saya menemukan ini lagi, saya memutuskan - dan saya akan menulis tutorial saya ketika semuanya berhasil.  Yang pasti akan berhasil. </p><a name="habracut"></a><br><h2 id="gaydy-v-internete">  Panduan Online </h2><br><p>  Kebetulan Internet tidak mengalami kekurangan berbagai panduan, tutorial, langkah-demi-langkah, dan sejenisnya.  Kebetulan saya ditugasi mengembangkan solusi untuk organisasi yang nyaman dan pembangunan cluster PostgreSQL yang gagal-aman, persyaratan utama di antaranya adalah streaming replikasi dari server Master ke semua replika dan input otomatis cadangan ketika server Master gagal. </p><br><p>  Pada tahap ini, tumpukan teknologi yang digunakan didefinisikan: </p><br><ul><li>  PostgreSQL sebagai DBMS </li><li>  <a href="https://github.com/zalando/patroni" rel="nofollow">Patroni</a> sebagai solusi pengelompokan </li><li>  dll sebagai penyimpanan terdistribusi untuk Patroni </li><li>  HAproxy untuk mengatur titik masuk tunggal untuk aplikasi yang menggunakan database </li></ul><br><h2 id="ustanovka">  Instalasi </h2><br><p>  Perhatian Anda - pembangunan cluster PostgreSQL ketersediaan tinggi menggunakan Patroni, dll, HAProxy. </p><br><p>  Semua operasi dilakukan pada mesin virtual dengan Debian 10 diinstal. </p><br><h3 id="etcd">  dll </h3><br><p>  Saya tidak merekomendasikan menginstal etcd pada mesin yang sama di mana patroni dan postgresql akan ditemukan, karena beban disk sangat penting untuk etcd.  Tetapi untuk tujuan pelatihan, kami akan melakukan hal itu. <br>  Instal dlld. </p><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash apt-get update apt-get install etcd</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Tambahkan konten ke file / etc / default / etcd</b> <div class="spoiler_text"><h1 id="member">  [anggota] </h1><br><p>  ETCD_NAME = datanode1 # hostname mesin Anda <br>  ETCD_DATA_DIR = "/ var / lib / etcd / default.etcd" </p><br><h1 id="all-ip-adresses-should-be-valid-lister-peer-client-etc-should-be-set-to-ip-address-of-host">  SEMUA ADRES IP AKAN HARUS BERLAKU.  DAFTAR SISWA, KLIEN, dll. HARUS DIATUR KE ALAMAT IP HOST </h1><br><p>  ETCD_LISTEN_PEER_URLS = " <a href="http://192.168.0.143:2380/" rel="nofollow">http://192.168.0.143:2380</a> " # alamat mesin Anda <br>  ETCD_LISTEN_CLIENT_URLS = " <a href="http://192.168.0.143:2379," rel="nofollow">http://192.168.0.143:379,http://127.0.0.1:379</a> " # alamat mesin Anda </p><br><h1 id="cluster">  [cluster] </h1><br><p>  ETCD_INITIAL_ADVERTISE_PEER_URLS = " <a href="http://192.168.0.143:2380/" rel="nofollow">http://192.168.0.143:2380</a> " # alamat mesin Anda <br>  ETCD_INITIAL_CLUSTER = "datanode1 = <a href="http://192.168.0.143:2380,datanode2=http://192.168.0.144:2380,datanode3=" rel="nofollow">http://192.168.0.143:2380,datanode2=http://192.168.0.144:2380,datanode3=http://192.168.0.145:2380</a> " # alamat semua mesin di cluster etcd <br>  ETCD_INITIAL_CLUSTER_STATE = "baru" <br>  ETCD_INITIAL_CLUSTER_TOKEN = "etcd-cluster-1" <br>  ETCD_ADVERTISE_CLIENT_URLS = " <a href="http://192.168.0.143:2379/" rel="nofollow">http://192.168.0.143:379</a> " # alamat mesin Anda </p></div></div><br><p>  Jalankan perintah </p><br><pre> <code class="bash hljs">systemctl restart etcd</code> </pre> <br><h3 id="postgresql-96--patroni">  PostgreSQL 9.6 + patroni </h3><br><p>  Hal pertama yang harus dilakukan adalah menginstal tiga mesin virtual untuk menginstal perangkat lunak yang diperlukan pada mereka.  Setelah menginstal mesin, jika Anda mengikuti tutorial saya, Anda dapat menjalankan skrip sederhana ini yang (hampir) melakukan segalanya untuk Anda.  Jalankan sebagai root. </p><br><p>  Harap dicatat bahwa skrip menggunakan PostgreSQL versi 9.6, ini karena persyaratan internal perusahaan kami.  Solusinya tidak diuji pada versi PostgreSQL lainnya. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash apt-get install gnupg -y echo "deb http://apt.postgresql.org/pub/repos/apt/ buster-pgdg main" &gt;&gt; /etc/apt/sources.list wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - apt-get update apt-get install postgresql-9.6 python3-pip python3-dev libpq-dev -y systemctl stop postgresql pip3 install --upgrade pip pip install psycopg2 pip install patroni[etcd] echo "\ [Unit] Description=Runners to orchestrate a high-availability PostgreSQL After=syslog.target network.target [Service] Type=simple User=postgres Group=postgres ExecStart=/usr/local/bin/patroni /etc/patroni.yml KillMode=process TimeoutSec=30 Restart=no [Install] WantedBy=multi-user.targ\ " &gt; /etc/systemd/system/patroni.service mkdir -p /data/patroni chown postgres:postgres /data/patroni chmod 700 /data/patroni touch /etc/patroni.yml</span></span></code> </pre> <br><p>  Selanjutnya, dalam file /etc/patroni.yml yang baru saja dibuat, Anda harus meletakkan konten berikut, tentu saja mengubah alamat IP di semua tempat menjadi alamat yang Anda gunakan. <br>  Perhatikan komentar di yaml ini.  Ubah alamat menjadi milik Anda di setiap mesin di cluster. </p><br><div class="spoiler">  <b class="spoiler_title">/etc/patroni.yml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">scope: pgsql #       namespace: /cluster/ #       name: postgres1 #       restapi: listen: 192.168.0.143:8008 #   ,      connect_address: 192.168.0.143:8008 #   ,      etcd: hosts: 192.168.0.143:2379,192.168.0.144:2379,192.168.0.145:2379 #     ,      etcd    # this section (bootstrap) will be written into Etcd:/&lt;namespace&gt;/&lt;scope&gt;/config after initializing new cluster # and all other cluster members will use it as a `global configuration` bootstrap: dcs: ttl: 100 loop_wait: 10 retry_timeout: 10 maximum_lag_on_failover: 1048576 postgresql: use_pg_rewind: true use_slots: true parameters: wal_level: replica hot_standby: "on" wal_keep_segments: 5120 max_wal_senders: 5 max_replication_slots: 5 checkpoint_timeout: 30 initdb: - encoding: UTF8 - data-checksums - locale: en_US.UTF8 # init pg_hba.conf     ,    pg_hba: - host replication postgres ::1/128 md5 - host replication postgres 127.0.0.1/8 md5 - host replication postgres 192.168.0.143/24 md5 - host replication postgres 192.168.0.144/24 md5 - host replication postgres 192.168.0.145/24 md5 - host all all 0.0.0.0/0 md5 users: admin: password: admin options: - createrole - createdb postgresql: listen: 192.168.0.143:5432 #   ,      connect_address: 192.168.0.143:5432 #   ,      data_dir: /data/patroni #    ,       bin_dir: /usr/lib/postgresql/9.6/bin #       postgresql pgpass: /tmp/pgpass authentication: replication: username: postgres password: postgres superuser: username: postgres password: postgres create_replica_methods: basebackup: checkpoint: 'fast' parameters: unix_socket_directories: '.' tags: nofailover: false noloadbalance: false clonefrom: false nosync: false</code> </pre> </div></div><br><p>  Script harus dijalankan pada ketiga mesin cluster, sama seperti Anda harus meletakkan konfigurasi di file /etc/patroni.yml pada semua mesin. </p><br><p>  Ketika Anda melakukan operasi ini pada semua mesin di cluster, jalankan perintah berikut di salah satu dari mereka </p><br><pre> <code class="bash hljs">systemctl start patroni systemctl start postgresql</code> </pre> <br><p>  Tunggu sekitar 30 detik, kemudian jalankan perintah ini di seluruh mesin cluster. </p><br><h3 id="haproxy">  HAproxy </h3><br><p>  Kami menggunakan HAproxy yang luar biasa untuk menyediakan satu titik masuk.  Server master akan selalu tersedia di alamat mesin tempat HAproxy digunakan. </p><br><p>  Agar tidak menjadikan mesin HAproxy titik kegagalan tunggal, jalankan di wadah Docker, nanti akan dimungkinkan untuk menjalankannya di kluster K8 dan membuat kluster failover kami bahkan lebih dapat diandalkan. </p><br><p>  Buat direktori tempat Anda dapat menyimpan dua file - Dockerfile dan haproxy.cfg.  Pergi ke sana. </p><br><div class="spoiler">  <b class="spoiler_title">Dockerfile</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">FROM ubuntu:latest RUN apt-get update \ &amp;&amp; apt-get install -y haproxy rsyslog \ &amp;&amp; rm -rf /var/lib/apt/lists/* RUN mkdir /run/haproxy COPY haproxy.cfg /etc/haproxy/haproxy.cfg CMD haproxy -f /etc/haproxy/haproxy.cfg &amp;&amp; tail -F /var/log/haproxy.log</code> </pre> </div></div><br><p>  Hati-hati, tiga baris terakhir dari file haproxy.cfg harus mencantumkan alamat mesin Anda.  HAproxy akan menghubungi Patroni, di header HTTP server master akan selalu mengembalikan 200, dan replika akan mengembalikan 503. </p><br><div class="spoiler">  <b class="spoiler_title">haproxy.cfg</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">global maxconn 100 defaults log global mode tcp retries 2 timeout client 30m timeout connect 4s timeout server 30m timeout check 5s listen stats mode http bind *:7000 stats enable stats uri / listen postgres bind *:5000 option httpchk http-check expect status 200 default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions server postgresql1 192.168.0.143:5432 maxconn 100 check port 8008 server postgresql2 192.168.0.144:5432 maxconn 100 check port 8008 server postgresql3 192.168.0.145:5432 maxconn 100 check port 8008</code> </pre></div></div><br><p>  Berada di direktori di mana kedua file kami "terletak", kami akan menjalankan perintah pengemasan kontainer secara berurutan, serta peluncurannya dengan penerusan port yang diperlukan: </p><br><pre> <code class="bash hljs">docker build -t my-haproxy . docker run -d -p5000:5000 -p7000:7000 my-haproxy</code> </pre> <br><p>  Sekarang, membuka alamat browser mesin Anda dengan HAproxy dan menentukan port 7000, Anda akan melihat statistik pada cluster Anda. </p><br><p>  Dalam keadaan UP, server yang merupakan master akan ditemukan, dan replika dalam keadaan BAWAH.  Ini normal, sebenarnya mereka berfungsi, tetapi ditampilkan dalam formulir ini karena fakta bahwa mereka mengembalikan 503 ke permintaan dari HAproxy.  Hal ini memungkinkan kita untuk selalu tahu persis dari tiga server mana yang menjadi master saat ini. </p><br><h3 id="zaklyuchenie">  Kesimpulan </h3><br><p>  Kamu luar biasa!  Hanya dalam 30 menit, Anda telah menggunakan kluster database gagal-aman dan produktif yang sangat baik dengan replikasi streaming dan penyediaan otomatis.  Jika Anda berencana untuk menggunakan solusi ini, lihat <a href="https://patroni.readthedocs.io/en/latest/" rel="nofollow">dokumentasi Patroni resmi</a> , dan terutama bagiannya mengenai utilitas patronictl, yang menyediakan akses mudah untuk mengelola kluster Anda. </p><br><p>  Selamat! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id482314/">https://habr.com/ru/post/id482314/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id482300/index.html">Menjelajahi Java 14 Records</a></li>
<li><a href="../id482302/index.html">Kabut psikologis tentang Tahun Baru</a></li>
<li><a href="../id482304/index.html">Made for China: cara membuat spanduk yang sempurna untuk konsumen Cina</a></li>
<li><a href="../id482306/index.html">Sejarah porno internet. Bagian 1</a></li>
<li><a href="../id482308/index.html">Kami membuat satu proyek plugin dengan kompilasi untuk berbagai versi Revit / AutoCAD</a></li>
<li><a href="../id482316/index.html">Kami memperumit model Sci-fi secara prosedural: apa itu Greeble dan bagaimana menggunakannya</a></li>
<li><a href="../id482318/index.html">Mengapa Rust Harus Menjadi Bahasa Pemrograman Fungsional</a></li>
<li><a href="../id482328/index.html">V&V bukan untuk balas dendam</a></li>
<li><a href="../id482330/index.html">Daftar permata dasar untuk profil aplikasi Ruby on Rails</a></li>
<li><a href="../id482332/index.html">Bagaimana seorang penggila mengangkat jaringan Wi-Fi di bawah DOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>