<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíç üò¶ ‚úãüèª Gera√ß√£o din√¢mica de DAG no fluxo de ar üïü üßñüèº üõµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Meu nome √© Anton, na Rostelecom estou desenvolvendo um data warehouse central. Nosso armazenamento consiste em m√≥dulos, cujo orquestrador...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gera√ß√£o din√¢mica de DAG no fluxo de ar</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rostelecom/blog/435746/"><p>  Ol√° pessoal!  Meu nome √© Anton, na Rostelecom estou desenvolvendo um data warehouse central.  Nosso armazenamento consiste em m√≥dulos, cujo orquestrador usa v√°rias inst√¢ncias da Informatica, algumas das quais queremos transferir para o Airflow como parte da transi√ß√£o para solu√ß√µes de c√≥digo aberto.  Como a Informatica e o Airflow s√£o ferramentas fundamentalmente diferentes, pegar e repetir uma implementa√ß√£o existente n√£o √© t√£o simples.  Quer√≠amos obter um fluxo de trabalho, por um lado, o mais pr√≥ximo poss√≠vel da implementa√ß√£o atual e, por outro lado, usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeiro princ√≠pio</a> mais interessante do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fluxo de ar</a> - o dinamismo, que oferece flexibilidade. </p><br><p>  Neste breve artigo, quero falar sobre a gera√ß√£o verdadeiramente din√¢mica de DAGs no Airflow.  Neste t√≥pico, a Internet cont√©m principalmente muitos artigos de desenvolvedores da √çndia, que s√£o materiais da forma <em>"voc√™ pode gerar dinamicamente dags no Airflow, aqui est√° um exemplo: &lt;exemplo para gerar 10 tarefas / dags do HelloWorld&gt;"</em> .  Mas est√°vamos interessados ‚Äã‚Äãna gera√ß√£o de dags, que mudar√£o com o tempo com um n√∫mero vari√°vel e nomes de tarefas. </p><br><p><img src="https://habrastorage.org/webt/zl/yr/sk/zlyrskhcw1q8wswrizaqcep2-pa.png" title="Apache Airflow"></p><a name="habracut"></a><br><p>  Atualmente, o Airflow √© implementado para iniciar um m√≥dulo que gera pacotes de dados em servidores de origem remota para posterior upload no reposit√≥rio.  Ele √© executado de acordo com um cronograma simples; n√£o √© muito interessante examin√°-lo em detalhes.  Al√©m disso, em breve ser√° introduzida uma orquestra√ß√£o atrav√©s do m√≥dulo Airflow, que fornece pacotes de dados para carregamento adicional camada por camada no preparo intermedi√°rio.  Aqui estamos aguardando uma s√©rie de ancinhos, descri√ß√µes que n√£o encontrei em lugar nenhum e quero compartilhar minha experi√™ncia. </p><br><p>  No Airflow on Habr√©, existem alguns artigos de desenvolvedores do Mail.ru nos quais coisas b√°sicas s√£o bem descritas: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Descri√ß√£o geral do Airflow</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ramifica√ß√£o, parametriza√ß√£o via jinja e comunica√ß√£o dentro do DAG atrav√©s do Xcom</a> </p><br><h2 id="nebolshoy-glossariy">  Pequeno gloss√°rio: </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DAG / DAG</a> √© um gr√°fico ac√≠clico direcionado.  Nesse caso, queremos dizer uma sequ√™ncia de a√ß√µes que dependem uma da outra e n√£o formam ciclos. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SubDAG / Sabdag</a> - o mesmo que o DAG, mas localizado dentro de outro DAG, iniciado como parte do DAG pai (ou seja, sendo tarefa) e sem um cronograma separado. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Operador / Operador</a> - uma etapa espec√≠fica do dag, executando uma a√ß√£o espec√≠fica.  Por exemplo, PythonOperator. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tarefa / Tarefa</a> - uma inst√¢ncia espec√≠fica do operador ao iniciar o DAG, √© visualizada como um pequeno quadrado na interface da web.  Por exemplo, PythonOperator, chamado <em>run_task</em> e executado no DAG <em>check_dag</em> . </p><br><h2 id="ideya-dinamicheskoy-generacii-taskov-v-dage-problemy-i-nedostatki">  A id√©ia de gera√ß√£o din√¢mica de tarefas em dag, problemas e desvantagens </h2><br><p>  Dados de entrada: </p><br><p>  H√° uma tabela no reposit√≥rio da orquestra, vamos cham√°-la de PKG_TABLE. <br>  Existe um mecanismo que adiciona entradas √† tabela PKG_TABLE que o pacote de dados est√° pronto para download. </p><br><p>  O que quer√≠amos: </p><br><p>  DAG, que ser√° gerado para pacotes prontos para download e come√ßar√° a baix√°-los (spoiler: no final, tudo acabou). </p><br><p> Usando o c√≥digo abaixo, geramos um dag que consiste na tarefa LatestOnlyOperator e sua tarefa dependente, criada quando a fun√ß√£o pkg_subdag_factory √© executada, que recebe uma lista de pacotes da tabela PKG_TABLE e gera v√°rios PythonOperators.  Se n√£o houver pacotes para baixar, um DummyOperator ser√° gerado. </p><br><p>  Eles decidiram criar a primeira vers√£o com um PythonOperator, redistribuindo-a em um fluxo de trabalho detalhado usando o Airflow. </p><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- """  DAG    """ from airflow.models import DAG from airflow.operators.python_operator import PythonOperator from airflow.operators.subdag_operator import SubDagOperator from airflow.operators.dummy_operator import DummyOperator from airflow.operators.latest_only_operator import LatestOnlyOperator from airflow.hooks.oracle_hook import OracleHook from datetime import datetime, timedelta import logging from scripts.lib import run_load, select_pkg_data def pkg_subdag_factory( oracle_hook, parent_dag_name, child_dag_name, start_date, schedule_interval, param_dict): """ ,  DAG    PythonOperator\` (1  - 1 PythonOperator)  : oracle_hook - airflow.hooks.oracle_hook.OracleHook parent_dag_name -  ""  child_dag_name -    start_date -       schedule_interval -      param_dict -     """ dag = DAG( '%s.%s' % (parent_dag_name, child_dag_name), schedule_interval=schedule_interval, start_date=start_date, catchup=False ) logging.info('selecting pkg data...') pkg_set = select_pkg_data(oracle_hook) if len(pkg_set): logging.info('pkg_set:') logging.info(pkg_set) for pkg in pkg_set: pkg_id = pkg[1] pkg_dict = {'pkg_data_' + str(pkg_id): pkg} param_dict.update(pkg_dict) task_name = 'pkg_' + str(pkg_id) PythonOperator( task_id=task_name, python_callable=run_load, op_kwargs={ 'oracle_hook': oracle_hook, 'param_dict': param_dict, 'pkg_id': pkg_id }, retries=0, dag=dag ) else: logging.info('Undelivered packages not found') DummyOperator(task_id='no_packages_dummy', retries=0, dag=dag) return dag interval = '*/10 * * * *' args = { 'owner': 'airflow', 'start_date': datetime(2018, 11, 12) } oracle_hook = OracleHook('ora_meta') main_dag_name = 'load' load_dag_name = 'load_packages' param_dict = { #       } main_dag = DAG( dag_id=main_dag_name, default_args=args, schedule_interval=interval, catchup=False ) subdag = SubDagOperator( subdag=pkg_subdag_factory( oracle_hook, main_dag_name, load_dag_name, args['start_date'], interval, param_dict ), task_id=load_dag_name, dag=main_dag ) #  ,       latest_only = LatestOnlyOperator(task_id='latest_only', dag=main_dag) subdag.set_upstream(latest_only)</span></span></code> </pre> <br><p>  As seguintes capturas de tela mostram como isso fica como resultado. <br>  Apar√™ncia do DAG: </p><br><p><img src="https://habrastorage.org/webt/_x/tl/sd/_xtlsduwcwvecmuwk2qfd2rlpyq.png" title="Apar√™ncia do DAG"></p><br><p>  Apar√™ncia do subdag na aus√™ncia de pacotes para entrega: </p><br><p><img src="https://habrastorage.org/webt/z7/vn/gy/z7vngyipby78gaksu29i0km1y04.png" title="Na aus√™ncia de pacotes para entrega"></p><br><p>  Apar√™ncia do subdag na presen√ßa de pacotes para entrega: </p><br><p><img src="https://habrastorage.org/webt/-3/ig/9f/-3ig9fawopeyqupws_ya7pp3ve0.png" title="Se houver pacotes para entrega"></p><br><h2 id="problemy-i-nyuansy">  Problemas e nuances </h2><br><ul><li>  O catchup n√£o funcionou como esper√°vamos: depois de ligar o dag desligado, ocorreram v√°rios lan√ßamentos (n√£o durante todo o per√≠odo do cronograma, mas 2-3 ao mesmo tempo).  Por isso, tive que adicionar o LatestOnlyOperator, para que todos os lan√ßamentos, exceto o √∫ltimo, fiquem ociosos. </li><li>  Se voc√™ criar um subdag, precisar√° habilit√°-lo explicitamente pela linha de comando com o comando "airflow unpause &lt;subdag_name&gt;"; caso contr√°rio, ele n√£o ser√° iniciado e voc√™ dever√° fazer isso ao criar cada novo subdag (um subdag com um novo nome), o que tornar√° muito inconveniente gerar dinamicamente .  Se voc√™ definir o par√¢metro "dags_are_paused_at_creation" = false na configura√ß√£o do fluxo de ar ($ airflow_home / airflow.cfg), n√£o ser√° necess√°rio, mas poder√° levar a conseq√º√™ncias desagrad√°veis ‚Äã‚Äãcom o lan√ßamento autom√°tico autom√°tico de um novo dag - parece-me que voc√™ precisa iniciar novos dagas manualmente. </li></ul><br><p>  Como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> diz, "Um recurso importante do Airflow √© que essas execu√ß√µes do DAG s√£o itens at√¥micos e idempotentes, &lt;...&gt;", o que significa: "Entende-se que o dag √© gerado inalterado".  Devido ao fato de termos violado esse "recurso essencial", aprendemos algumas coisas: </p><br><ul><li>  Um dag vazio (sem tarefas) inicia e n√£o pode terminar, obstruindo todos os paralelos poss√≠veis.  Isso aconteceu se n√£o houvesse pacotes de download no momento em que o dag foi lan√ßado.  Para contornar isso, um DummyOperator √© criado. </li><li>  Se durante o trabalho, o dag da tarefa for regenerado e n√£o houver mais essa tarefa no dag atualizado - ele ser√° interrompido com a interrup√ß√£o do processo em execu√ß√£o.  E isso acontece com todas as etapas do sheduler, mas n√£o mais frequentemente do que o indicado no par√¢metro min_file_process_interval na configura√ß√£o do fluxo de ar ($ airflow_home / airflow.cfg).  Para contornar isso, geramos pacotes de tarefas n√£o apenas pelo status de "pronto para download", mas tamb√©m pelo status de "carregamento em processo", para que continue a ser gerado enquanto o download estiver em andamento. </li><li>  Se a vers√£o atual do dag n√£o tiver nenhuma tarefa anterior - por exemplo, houve uma tarefa com o nome "pkg_123" que foi carregada anteriormente e n√£o √© criada na vers√£o atual do dag, voc√™ n√£o pode ver estat√≠sticas sobre essa tarefa na interface da web.  Embora todas as informa√ß√µes sejam armazenadas no banco de dados de fluxo de ar e, com base nisso, √© poss√≠vel criar um belo painel para lan√ßamentos antigos por meios externos.  Quando surgir a pergunta sobre a frequ√™ncia da atualiza√ß√£o de DAGs e a capacidade de desativ√°-lo, voc√™ pode ler sobre isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </li><li>  Devido √† gera√ß√£o din√¢mica de task_id, √© necess√°rio lan√ßar um dicion√°rio com dados para todos os pacotes atuais em cada uma dessas tarefas, bem como o ID do pacote atual, para que, quando a fun√ß√£o em si funcione, selecione os dados necess√°rios do mesmo dicion√°rio por ID do pacote.  Caso contr√°rio, todas as tarefas foram iniciadas para o mesmo pacote. </li></ul><br><h2 id="execution_date-v-logah-i-fakticheskoe-vremya-zapuska">  Execution_date nos logs e hora de in√≠cio real </h2><br><p>  Termino com outra nuance do Airflow, que a princ√≠pio confunde e n√£o √© descrita em palavras simples em outros artigos - signature_date (que √© exibida em todos os logs, na interface etc.) e na hora de in√≠cio real.  Em princ√≠pio, a descri√ß√£o est√° na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o do fluxo de ar</a> e no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FAQ</a> , mas o resultado n√£o √© √≥bvio, portanto parece-me que √© necess√°rio esclarecer. </p><br><p>  <em>Documenta√ß√£o</em> : "O Agendador inicia seu trabalho no final do per√≠odo" <br>  <em>Resultado</em> : se voc√™ criar um dag com um agendamento, por exemplo, @daily, uma execu√ß√£o com a data de execu√ß√£o "2018-01-01 00:00:00" realmente executar√° "2018-02-01 00:00:00". </p><br><h2 id="poleznye-ssylki">  Links √∫teis: </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o de recupera√ß√£o</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o LatestOnlyOperator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mais documenta√ß√£o em LatestOnlyOperator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Exemplo de uso de LatestOnlyOperator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Algumas nuances</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pergunta sobre depend√™ncias no lan√ßamento anterior</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Um pequeno exemplo sobre gera√ß√£o din√¢mica</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Uma pergunta sobre gera√ß√£o din√¢mica com uma pequena descri√ß√£o</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435746/">https://habr.com/ru/post/pt435746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435734/index.html">Como n√£o se deixar enganar fazendo f√≠sica</a></li>
<li><a href="../pt435738/index.html">T√©cnica de projeto DIY. Parte um</a></li>
<li><a href="../pt435740/index.html">As inscri√ß√µes est√£o abertas no GraphQL Meetup em S√£o Petersburgo</a></li>
<li><a href="../pt435742/index.html">Gerenciamento de recursos no Zimbra Collaboration Suite</a></li>
<li><a href="../pt435744/index.html">Resumo da Fintech: Banco da R√∫ssia poder√° bloquear sites, volumes de empr√©stimos p2p est√£o caindo, criptografia na Europa</a></li>
<li><a href="../pt435748/index.html">Lan√ßamento do Metasploit Framework 5.0</a></li>
<li><a href="../pt435750/index.html">Resumo dos eventos de TI de janeiro</a></li>
<li><a href="../pt435752/index.html">Moscow Python Conf ++ 2019 - a primeira confer√™ncia em que n√≥s mesmos preparamos alguns palestrantes</a></li>
<li><a href="../pt435756/index.html">Venda de Ano Novo</a></li>
<li><a href="../pt435760/index.html">Inside Quake: Definindo superf√≠cies vis√≠veis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>