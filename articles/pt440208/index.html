<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèø ‚ò™Ô∏è üë©üèæ‚Äçüè´ Explorando os limites de largura de banda de Kafka no Dropbox üßùüèª üëÜ üëßüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O uso generalizado das tecnologias Apache-stack √© uma tend√™ncia √≥bvia. E Kafka est√° na vanguarda da popularidade: hoje, as pessoas que conhecem esse m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Explorando os limites de largura de banda de Kafka no Dropbox</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/440208/"><img src="https://habrastorage.org/webt/7l/ga/d-/7lgad-4hzifyz50iy26wvpx-pna.png"><br><br>  O uso generalizado das tecnologias Apache-stack √© uma tend√™ncia √≥bvia.  E Kafka est√° na vanguarda da popularidade: hoje, as pessoas que conhecem esse mediador de mensagens talvez excedam o n√∫mero daqueles que est√£o acostumados a ver a palavra Franz ao lado da palavra Kafka. <br><br>  N√≥s mesmos estamos usando ativamente essa tecnologia em nossos projetos.  Mas √© sempre interessante, mas como isso funciona para os outros?  E √© duplamente interessante se este n√£o √© apenas um exemplo da pr√°tica de algu√©m, mas um teste focado na tecnologia.  Portanto, traduzimos um artigo recente que fala sobre como o Dropbox procurou empiricamente os limites de oportunidades e limites de resist√™ncia em Kafka.  E encontrou o que ele queria. <br><a name="habracut"></a><br>  <b>Explorando os limites de largura de banda de Kafka no Dropbox</b> <br>  O Apache Kafka √© uma solu√ß√£o popular para streaming distribu√≠do e processamento sequencial de grandes quantidades de dados.  √â amplamente utilizado na ind√∫stria de alta tecnologia, e o Dropbox n√£o √© exce√ß√£o.  Kafka desempenha um papel importante na estrutura de dados de muitos de nossos sistemas distribu√≠dos cr√≠ticos - an√°lise de dados, aprendizado de m√°quina, monitoramento, recupera√ß√£o e processamento de fluxo (Cape) (e estes s√£o apenas alguns). <br><br>  No Dropbox, os clusters Kafka s√£o gerenciados pela equipe Jetstream, cuja principal responsabilidade √© fornecer servi√ßos de alta qualidade relacionados ao Kafka.  Compreender o limite de largura de banda Kafka na infraestrutura do Dropbox √© fundamental para tomar as decis√µes corretas sobre como alocar recursos em diferentes casos de uso, e esse era um dos objetivos priorit√°rios da equipe.  Recentemente, criamos uma plataforma de teste automatizada para conseguir isso.  E nesta publica√ß√£o, gostar√≠amos de compartilhar nosso m√©todo e os resultados. <br><br>  <b>Plataforma de teste</b> <br><img src="https://habrastorage.org/webt/he/uq/to/heuqtorszvkeq3ocxtein41cyuy.png"><br>  A figura acima mostra os par√¢metros da nossa plataforma de teste para este estudo.  Usamos o Spark para hospedar clientes Kafka, o que nos permite produzir e consumir tr√°fego em um volume arbitr√°rio.  Criamos tr√™s clusters Kafka de tamanhos diferentes, para que o ajuste do tamanho do cluster fosse literalmente reduzido para redirecionar o tr√°fego para outro ponto.  Kafka criou um t√≥pico para a produ√ß√£o e consumo de tr√°fego de teste.  Para simplificar, distribu√≠mos o tr√°fego por todos os corretores de maneira uniforme.  Para isso, criamos um t√≥pico de teste com o n√∫mero de se√ß√µes dez vezes o n√∫mero de corretores.  Cada corretor lidera exatamente 10 se√ß√µes.  Como a grava√ß√£o em uma se√ß√£o √© seq√ºencial, poucas parti√ß√µes alocadas a um broker podem levar √† grava√ß√£o competitiva, o que limita a largura de banda.  Nossas experi√™ncias mostraram que 10 √© um bom n√∫mero para eliminar as dificuldades de gargalo associadas √† grava√ß√£o competitiva. <br><br>  Devido √† natureza distribu√≠da de nossa infraestrutura, nossos clientes est√£o localizados em v√°rias regi√µes dos Estados Unidos.  Considerando que nosso tr√°fego de teste est√° significativamente abaixo do limite dos canais de tronco do Dropbox, podemos assumir com confian√ßa que esse limite de tr√°fego inter-regional tamb√©m √© aplic√°vel ao tr√°fego local. <br><br>  <b>O que afeta a carga?</b> <br><br>  Existem muitos fatores que podem afetar a carga do cluster Kafka: o n√∫mero de produtores, o n√∫mero de grupos de consumidores, o deslocamento inicial de consumidores, o n√∫mero de mensagens por segundo, o tamanho de cada mensagem, o n√∫mero de t√≥picos e se√ß√µes envolvidos.  E estes s√£o apenas alguns deles.  O grau de liberdade na defini√ß√£o dos par√¢metros √© alto.  Portanto, precisamos encontrar os fatores dominantes para reduzir a complexidade dos testes para um n√≠vel aceit√°vel. <br><br>  Examinamos v√°rias combina√ß√µes de par√¢metros que achamos adequados.  Chegamos a uma conclus√£o surpreendente de que os fatores dominantes que devem ser levados em considera√ß√£o s√£o os principais componentes da carga: o n√∫mero de mensagens produzidas por segundo (s / s) e o n√∫mero de bytes por mensagem (b / s). <br><br>  <b>Modelo de tr√°fego</b> <br><br>  Adotamos uma abordagem formal para entender as limita√ß√µes do Kafka.  H√° um espa√ßo de tr√°fego relacionado para um cluster Kafka espec√≠fico.  Cada ponto desse espa√ßo multidimensional corresponde a um estado √∫nico de tr√°fego aplic√°vel ao Kafka e apresentado como um vetor de par√¢metros: &lt;s / s, b / s, # produtores, # grupos de consumidores, # t√≥picos, ...&gt;.  Todos os estados de tr√°fego que n√£o resultam em congestionamento KafKa formam um subespa√ßo fechado cuja superf√≠cie limitar√° o cluster Kafka. <br><br>  Para o nosso primeiro teste, escolhemos s / se eb / s como par√¢metros principais e reduzimos o espa√ßo de tr√°fego para um plano bidimensional.  Os limites do tr√°fego permitido formam √°reas de rastreamento claras.  A detec√ß√£o do limite de Kafka no nosso caso √© equivalente a determinar os valores de contorno dessa √°rea. <br><br>  <b>Automa√ß√£o de Teste</b> <br><br>  Para definir os limites com precis√£o suficiente, foi necess√°rio realizar centenas de testes com v√°rios par√¢metros - o que seria extremamente irracional para se fazer manualmente.  Portanto, desenvolvemos um algoritmo que permite executar todos os experimentos sem interven√ß√£o humana. <br><br>  <b>Taxa de congestionamento</b> <br><br>  √â muito importante encontrar um conjunto de indicadores que permita avaliar programaticamente o status do Kafka.  Examinamos uma ampla gama de indicadores poss√≠veis e resolvemos a pequena amostra a seguir: <br><br><ul><li>  um fluxo de E / S simples √© inferior a 20%: isso significa que o pool de fluxos de trabalho usado pelo Kafka para processar solicita√ß√µes de clientes est√° muito ocupado e n√£o pode lidar com as tarefas recebidas. </li><li>  mudan√ßa no conjunto de r√©plicas sincronizadas (ISR) em mais de 50%: isso significa que ao usar o tr√°fego por 50% do tempo observado, pelo menos um intermedi√°rio n√£o tem tempo para duplicar os dados recebidos de seu l√≠der. </li></ul><br>  Os mesmos indicadores s√£o usados ‚Äã‚Äãno Jetstream para monitorar o status do Kafka e servir como os primeiros sinais de alarme de sobrecarga do cluster. <br><br>  <b>Encontre bordas</b> <br><br>  Para determinar um valor de limite, fixamos b / se mudamos s / s para sobrecarregar Kafka.  √â poss√≠vel determinar o valor do limite s / s quando conhecemos o valor s / s seguro e est√° pr√≥ximo, mas j√° est√° causando sobrecarga.  Desses dois, o valor s / s seguro √© considerado o valor limite.  Como mostrado abaixo, a linha de valores de contorno √© formada de acordo com os resultados de testes semelhantes com diferentes indicadores b / s: <br><br><img src="https://habrastorage.org/webt/76/k0/u7/76k0u7ql-gxvwxsahu9qdavsj7k.png"><br><br>  Vale ressaltar que, em vez de regular diretamente s / s, experimentamos um n√∫mero diferente de fabricantes com a mesma velocidade de produ√ß√£o, indicada por np.  O fato √© que o processamento em lote de mensagens complica o controle sobre a velocidade de produ√ß√£o de um √∫nico fabricante.  Uma mudan√ßa no n√∫mero de fabricantes, por outro lado, permite alterar linearmente o tr√°fego.  De acordo com nossa pesquisa inicial, um simples aumento no n√∫mero de fabricantes n√£o criar√° uma diferen√ßa percept√≠vel na carga do Kafka. <br><br>  Para come√ßar, encontramos um valor de limite separado usando uma pesquisa bin√°ria.  A pesquisa come√ßa com um intervalo muito grande np [0, max], em que max √© o valor que necessariamente levar√° √† sobrecarga.  Em cada itera√ß√£o, um valor m√©dio √© selecionado para criar tr√°fego.  Se Kafka estiver sobrecarregado com esse valor, esse valor m√©dio se tornar√° o novo limite superior;  caso contr√°rio, ele se tornar√° um novo limite inferior.  O processo de pesquisa para quando o intervalo √© reduzido o suficiente.  Em seguida, consideramos os indicadores s / s, que est√£o relacionados ao limite inferior estabelecido dos valores dos limites. <br><br>  <b>Resultado</b> <br><br><img src="https://habrastorage.org/webt/pb/on/ni/pbonniixt0fgnygngvjnecsil8s.png"><br><br>  Como voc√™ pode ver no diagrama acima, definimos os valores de limite para Kafka de tamanhos diferentes.  Com base nos resultados, chegamos √† conclus√£o de que a taxa de transfer√™ncia m√°xima poss√≠vel da infraestrutura do Dropbox √© de 60 Mb / s por broker. <br><br>  Deve-se enfatizar que esse √© um limite conservador, pois o conte√∫do de nossas mensagens de teste foi o mais aleat√≥rio poss√≠vel, a fim de reduzir o efeito da compacta√ß√£o interna de mensagens no Kafka.  Quando o tr√°fego atinge seu limite, a unidade e a rede s√£o totalmente utilizadas.  Nos scripts de trabalho, as mensagens Kafka geralmente correspondem a um determinado padr√£o, pois geralmente s√£o formadas por algoritmos semelhantes.  Isso fornece oportunidades significativas para otimizar a compacta√ß√£o de mensagens.  Testamos um cen√°rio extremo, quando as mensagens consistem em um √∫nico caractere e registramos uma taxa de transfer√™ncia muito maior, pois o disco e a rede n√£o s√£o mais um gargalo. <br><br>  Al√©m disso, esses indicadores de taxa de transfer√™ncia est√£o corretos se houver pelo menos 5 grupos de consumidores assinando o t√≥pico testado.  Em outras palavras, a largura de banda de grava√ß√£o indicada √© alcan√ßada quando a largura de banda de leitura √© 5 vezes maior.  Quando o n√∫mero de grupos de consumidores excede 5, a largura de banda de grava√ß√£o come√ßa a diminuir √† medida que a rede se torna um gargalo.  Como a taxa de tr√°fego de leitura e grava√ß√£o √© muito menor que 5 nos casos em que os clusters de produ√ß√£o do Dropbox s√£o usados, a largura de banda obtida se estende a todos os clusters de produ√ß√£o. <br><br>  Esse resultado ajudar√° voc√™ a planejar melhor os recursos para o futuro Kafka.  Por exemplo, se queremos permitir que at√© 20% de todos os intermedi√°rios trabalhem offline, a largura de banda m√°xima segura de um intermedi√°rio deve ser 60 MB / s * 0,8 ~ = 50 Mb / s.  A partir de agora, esse n√∫mero pode ser usado para determinar o tamanho do cluster, dependendo da taxa de transfer√™ncia planejada de casos de uso futuros. <br><br>  <b>Ferramentas para trabalhos futuros</b> <br><br>  A plataforma e o testador automatizado ser√£o ferramentas valiosas para a equipe da Jetstream em seus futuros trabalhos.  Quando passamos para um novo hardware, alteramos a configura√ß√£o da rede ou atualizamos a vers√£o do Kafka, podemos simplesmente executar novamente esses testes e obter novos dados sobre os limites permitidos da nova configura√ß√£o.  Podemos aplicar a mesma metodologia para estudar outros fatores que podem afetar o desempenho de Kafka de v√°rias maneiras.  Por fim, a plataforma pode atuar como uma plataforma de teste da Jetstream para simular novas op√ß√µes de tr√°fego ou reproduzir problemas em um ambiente isolado. <br><br>  <b>Resumir</b> <br><br>  Neste artigo, introduzimos nossa abordagem sistem√°tica para entender as limita√ß√µes do Kafka.  √â importante observar que alcan√ßamos esses resultados com base na infraestrutura do Dropbox, portanto nossos n√∫meros podem n√£o ser aplic√°veis ‚Äã‚Äãa outras instala√ß√µes Kafka devido √† diferen√ßa nas condi√ß√µes de hardware, software e rede.  Esperamos que a metodologia apresentada aqui possa ajudar os leitores a entender seus pr√≥prios sistemas. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt440208/">https://habr.com/ru/post/pt440208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt440198/index.html">Novas impressoras 3D DWS para profissionais</a></li>
<li><a href="../pt440200/index.html">Vamos falar sobre log</a></li>
<li><a href="../pt440202/index.html">Controles proativos da OWASP: lista de pr√©-requisitos para desenvolvedores de software</a></li>
<li><a href="../pt440204/index.html">DIY router CNC passatempo. Humanidades para as Humanidades</a></li>
<li><a href="../pt440206/index.html">L√¢mpadas "o ano inteiro"</a></li>
<li><a href="../pt440210/index.html">Abordagem m√°quina-sinest√©sica para detectar ataques DDoS na rede. Parte 1</a></li>
<li><a href="../pt440214/index.html">Spring e JDK 8: Voc√™ ainda est√° usando @Param e nome / valor nas anota√ß√µes do Spring MVC? Ent√£o o artigo √© para voc√™</a></li>
<li><a href="../pt440216/index.html">Como eu ensinei o Zabbix a manter um olho no meu n√≥ e relatar problemas</a></li>
<li><a href="../pt440218/index.html">Ataque ao DoS que n√£o pode ser fechado: as compras t√™m sua pr√≥pria atmosfera</a></li>
<li><a href="../pt440220/index.html">A s√≠ndrome do impostor n√£o √© apenas prejudicial, mas tamb√©m ben√©fica</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>