<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Grabar sonido JS desde un micr贸fono o comentarios de voz   ｏ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Grabar sonido JS desde un micr贸fono o comentarios de voz 
 No hace mucho tiempo, al desarrollar una aplicaci贸n web corporativa, el cliente deseaba pod...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Grabar sonido JS desde un micr贸fono o comentarios de voz</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484196/"><h2>  Grabar sonido JS desde un micr贸fono o comentarios de voz </h2><br>  No hace mucho tiempo, al desarrollar una aplicaci贸n web corporativa, el cliente deseaba poder dejar comentarios de voz.  Anteriormente, no encontr茅 la creaci贸n de contenido de medios y comenc茅 a estudiar este tema con inter茅s. <br><br>  La red proporcion贸 suficiente informaci贸n de fondo sobre el tema de crear y procesar este tipo de contenido, pero no encontr茅 un ejemplo simple y completamente funcional.  Despu茅s de la implementaci贸n de la tarea por parte del cliente, decid铆 publicar el ejemplo m谩s simplificado de grabar y guardar comentarios de voz y escribir un art铆culo.  Quiz谩s este material sea 煤til para alguien y ayude en el estudio. <br><br><h3>  Declaraci贸n del problema. </h3><br>  Nos propusimos la tarea de desarrollar una mini aplicaci贸n que se ejecute en un navegador que le permita grabar un comentario de voz, enviar una grabaci贸n al servidor, el servidor guardar谩 la grabaci贸n, si tiene 茅xito, devolver谩 una respuesta con el nombre del archivo creado y mostrar谩 el objeto en la p谩gina para que se pueda escuchar la grabaci贸n. <br><a name="habracut"></a><br><h3>  Grabar sonido en el navegador </h3><br>  Se decidi贸 implementar la grabaci贸n de sonido utilizando la API web de grabaci贸n de MediaStream.  Para la grabaci贸n, utilizamos la interfaz MediaRecorder ().  Pero primero, crea una interfaz.  Tengamos index.html que contiene solo las etiquetas m谩s b谩sicas, y en el cuerpo de la etiqueta incluiremos un archivo con nuestro futuro JavaScript voice.js: <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Voice comments<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"voice.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Cree un archivo voice.js, defina una URL constante que contenga un enlace a un script que reciba sonido grabado.  A continuaci贸n, cree los botones Iniciar y Parar para iniciar y detener la grabaci贸n de sonido, as铆 como el bloque div en el que se mostrar谩n los registros guardados.  En esto nuestra interfaz est谩 lista, puede proceder directamente a la grabaci贸n de sonido. <br><br>  Como ya se mencion贸 para la grabaci贸n, utilizaremos la interfaz MediaRecorder () (para obtener m谩s informaci贸n sobre la interfaz, consulte la documentaci贸n), para su funcionamiento es necesario determinar la secuencia de medios de la que tomaremos sonido, inicial铆cela solo porque solo necesitamos una pista de audio. <br><br><pre> <code class="javascript hljs">navigator.mediaDevices.getUserMedia({ <span class="hljs-attr"><span class="hljs-attr">audio</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mediaRecorder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaRecorder(stream)});</code> </pre><br>  Ahora tenemos el mediaRecorder constante, que contiene una instancia de la interfaz, y continuaremos trabajando con ella. <br><br>  Para comenzar a grabar, debemos llamar al m茅todo MediaRecorder.start (), para detener la grabaci贸n, al m茅todo MediaRecorder.stop ().  En este caso, MediaRecorder.stop () genera un evento disponible de datos a trav茅s del cual tenemos acceso a la grabaci贸n de sonido digitalizada en forma de una matriz binaria. <br><br>  Entonces, describiremos los eventos anteriores, declararemos la matriz de voz [] y escribiremos los datos recibidos en ella: <br><br><pre> <code class="javascript hljs">navigator.mediaDevices.getUserMedia({ <span class="hljs-attr"><span class="hljs-attr">audio</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>}) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mediaRecorder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaRecorder(stream); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> voice = []; <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'#start'</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ mediaRecorder.start(); }); mediaRecorder.addEventListener(<span class="hljs-string"><span class="hljs-string">"dataavailable"</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ voice.push(event.data); }); <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'#stop'</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ mediaRecorder.stop(); }); });</code> </pre><br>  Ahora prepararemos los datos recibidos para enviar.  Para hacer esto, mediante el evento stop, cree una instancia BLOB, coloque los datos recibidos y especifique el tipo de datos MIME.  En nuestro caso, ser谩 audio / wav. <br><br><pre> <code class="javascript hljs">mediaRecorder.addEventListener(<span class="hljs-string"><span class="hljs-string">"stop"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> voiceBlob = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Blob(voice, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'audio/wav'</span></span> });</code> </pre><br>  Como resultado, tenemos una constante voiceBlob en la que se encuentra el contenido de nuestro futuro archivo wav con la grabaci贸n de un mensaje de voz. <br><br><h3>  Enviar un registro al servidor </h3><br>  Para enviar un registro al servidor, decid铆 usar el m茅todo fetch ().  Dado que este m茅todo es el m谩s moderno y proporciona una interfaz mejorada para realizar solicitudes al servidor.  Como parte de nuestra tarea, debemos iniciar una solicitud POST en el cuerpo para enviar el contenido de nuestro archivo futuro para guardar en el servidor (c贸mo funciona el m茅todo fetch () y qu茅 capacidades se pueden encontrar en la documentaci贸n en detalle).  Cree un nuevo formulario con el campo de voz y coloque el contenido de nuestro registro en 茅l. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData(); fd.append(<span class="hljs-string"><span class="hljs-string">'voice'</span></span>, voiceBlob);</code> </pre><br>  Creamos una funci贸n asincr贸nica para enviar un mensaje al servidor para recibir una respuesta y mostrar un objeto de audio para reproducir un archivo ya guardado.  Como argumento, la funci贸n tomar谩 la forma creada anteriormente. <br><br>  Iniciamos una solicitud del servidor: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> promise = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fetch(URL, { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-attr"><span class="hljs-attr">body</span></span>: form});</code> </pre><br>  Si la respuesta HTTP del servidor no contiene un c贸digo de error (el c贸digo de respuesta est谩 en el rango de 200-299), entonces nos queda por descifrar la respuesta, crear un nuevo objeto de audio en la p谩gina, determinar sus propiedades y mostrarlo.  La forma en que se forma la respuesta se discutir谩 a continuaci贸n. <br><br><h3>  Guardar un archivo en el servidor </h3><br>  Creemos un script en el servidor que recibir谩 nuestra solicitud POST con un mensaje de voz.  Dado que la grabaci贸n de sonido que enviamos es esencialmente un archivo en forma, la recibiremos en el servidor en consecuencia: <br><br><pre> <code class="php hljs">$uploadDir = <span class="hljs-string"><span class="hljs-string">'voice/'</span></span>; $typeFile = explode(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, $_FILES[<span class="hljs-string"><span class="hljs-string">'voice'</span></span>][<span class="hljs-string"><span class="hljs-string">'type'</span></span>]); $uploadFile = $uploadDir . basename(md5($_FILES[<span class="hljs-string"><span class="hljs-string">'voice'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>].time()).<span class="hljs-string"><span class="hljs-string">'.'</span></span>.$typeFile[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (move_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">'voice'</span></span>][<span class="hljs-string"><span class="hljs-string">'tmp_name'</span></span>], $uploadFile)) { $response = [<span class="hljs-string"><span class="hljs-string">'result'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'OK'</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'../'</span></span>.$uploadFile]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $response = [<span class="hljs-string"><span class="hljs-string">'result'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">''</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> json_encode($response);</code> </pre><br>  Puede encontrar muchos ejemplos similares de c贸digo PHP, procesando archivos recibidos en la red.  Primero, inicialice las variables, $ uploadDir: el directorio en el que se guardar谩 el archivo recibido, el tipo de archivo y tipo de archivo en nuestro caso ser谩 igual a wav y el nombre completo del archivo, incluido el directorio.  El nombre de archivo en este caso se forma combinando el nombre de archivo "temporal" y el valor de cadena de la hora actual cifrada usando el m茅todo md5.  Si guarda con 茅xito el archivo con un mensaje de voz en el directorio especificado, formamos una respuesta en forma de matriz que contiene el campo de resultado igual a "OK" o "ERROR" dependiendo del resultado y el campo de "datos" que, en caso de procesamiento exitoso, contiene un enlace al archivo guardado. <br><br>  Por conveniencia, transformamos la matriz en un objeto JSON y lo enviamos como respuesta. <br><br>  El c贸digo de muestra completo est谩 disponible en <a href="https://github.com/Krivodanov/Voice-comments">GitHub</a> . <br><br>  PD: el navegador le permite grabar contenido multimedia solo con una conexi贸n HTTPS segura. </div></div><p>Source: <a href="https://habr.com/ru/post/484196/">https://habr.com/ru/post/484196/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../484182/index.html">Xenobots: nanorobots vivos de c茅lulas de rana</a></li>
<li><a href="../484186/index.html">LDAP - "autenticaci贸n" es un antipatr贸n</a></li>
<li><a href="../484188/index.html">Est谩ndares de dise帽o de bases de datos</a></li>
<li><a href="../484192/index.html">Aplicaciones f谩ciles y f谩ciles de implementar en el cartucho de Tarantool (parte 2)</a></li>
<li><a href="../484194/index.html">Kubernetes traducido a ni帽os</a></li>
<li><a href="../484198/index.html">Reverso de la moneda: qui茅n gan贸 y perdi贸 con el crecimiento de las acciones de Tesla</a></li>
<li><a href="../484200/index.html">C贸mo establecer objetivos para alcanzarlos</a></li>
<li><a href="../484202/index.html">Aprendizaje autom谩tico en an谩lisis est谩tico del c贸digo fuente del programa</a></li>
<li><a href="../484204/index.html">El ransomware sin archivos FTCODE ahora roba cuentas</a></li>
<li><a href="../484206/index.html">Uso de mixins en Dart</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>