<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍👩‍👧‍👦 🔔 🤳🏼 Kubernetes: la vie d'un foyer 🧑🏿 🕦 🗜️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque perev. : Ce petit article (mais volumineux!) Écrit par Michael Hausenblas de l'équipe OpenShift de Red Hat nous a tellement plu qu'il a été a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetes: la vie d'un foyer</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/415393/">  <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: Ce petit article (mais volumineux!) Écrit par Michael Hausenblas de l'équipe OpenShift de Red Hat nous a tellement plu qu'il a été ajouté à notre base de connaissances internes Kubernetes presque immédiatement après sa découverte.</i>  <i>Et puisque les informations qui y sont présentées seront évidemment utiles à l'ensemble de la communauté informatique russophone, nous sommes heureux de publier sa traduction.</i> <br><br><img src="https://habrastorage.org/webt/os/rm/z_/osrmz_zgkbxv4y7inspp39tq9us.jpeg"><br><br>  Comme vous l'avez peut-être deviné, le titre de cette publication fait référence au dessin animé Pixar de 1998 <i>«La vie d'un insecte» (au box-office russe, il s'appelait «Les aventures de Flick» ou «La vie d'un insecte» - <b>environ trad.</b> )</i> , Et en effet: entre les anti- Kubernetes a beaucoup en commun avec les travailleurs et les foyers.  Nous examinerons attentivement le cycle de vie complet du foyer d'un point de vue pratique - en particulier, les façons dont vous pouvez influencer le comportement au démarrage et à l'arrêt, ainsi que les approches correctes pour vérifier l'état de l'application. <a name="habracut"></a><br><br>  Que vous ayez créé sous vous-même ou, mieux, via un contrôleur comme <i>Deployment</i> , <i>DaemonSet</i> ou <i>StatefulSet</i> , under peut se trouver dans l'une des phases suivantes: <br><br><ul><li>  <i>En attente</i> : le serveur API a créé une ressource de pod et l'a enregistrée dans etcd, mais elle n'était pas encore planifiée et les images de ses conteneurs n'ont pas été reçues du registre; </li><li>  <i>Running</i> (fonctionnement): under a été assigné au nœud et tous les conteneurs ont été créés par <i>kubelet</i> ; </li><li>  <i>Réussi</i> (terminé avec succès): l'opération de tous les récipients de foyer a été terminée avec succès et ils ne redémarreront pas; </li><li>  <i>Échec</i> : tous les conteneurs dans l'âtre ont cessé de fonctionner et au moins l'un des conteneurs est tombé en panne; </li><li>  <i>Inconnu</i> : API Server n'a pas pu interroger l'état du foyer, généralement en raison d'une erreur d'interaction avec <i>kubelet</i> . </li></ul><br>  Lors de l'exécution de <code>kubectl get pod</code> , notez que la colonne <code>STATUS</code> peut afficher d'autres messages (à l'exception de ces cinq) - par exemple, <code>Init:0/1</code> ou <code>CrashLoopBackOff</code> .  En effet, la phase n'est qu'une partie de l'état général du foyer.  Un bon moyen de savoir ce qui s'est exactement passé est d'exécuter <code>kubectl describe pod/$PODNAME</code> et de regarder l'entrée <code>kubectl describe pod/$PODNAME</code> <code>Events:</code> ci <code>Events:</code> dessous.  Elle affiche une liste d'actions pertinentes: que l'image du conteneur a été reçue, c'était prévu, le conteneur est dans un état « <i>malsain»</i> . <br><br>  Jetez maintenant un œil à un exemple spécifique du cycle de vie d'un foyer du début à la fin, comme le montre le diagramme suivant: <br><br><img src="https://habrastorage.org/webt/mu/rp/ms/murpmsyt_zuv4gn88nhd1j-kxdg.png"><br><br>  Que s'est-il passé ici?  Les étapes sont les suivantes: <br><br><ol><li>  Cela n'est pas illustré dans le diagramme, mais au tout début, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">infra-conteneur</a> spécial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est</a> lancé et définit les espaces de noms auxquels les conteneurs restants se joignent. </li><li>  Le premier conteneur défini par l'utilisateur qui démarre est le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conteneur init</a> ;  il peut être utilisé pour des tâches d'initialisation. </li><li>  Ensuite, le conteneur principal et le crochet <i>post-démarrage</i> sont lancés simultanément;  dans notre cas, cela se produit après 4 secondes.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Des crochets sont</a> définis pour chaque conteneur. </li><li>  Ensuite, à la 7e seconde, des tests de vivacité et de préparation entrent en jeu, à nouveau pour chaque conteneur. </li><li>  À la 11e seconde, lorsque le sous est tué, un crochet de <i>pré-arrêt</i> est déclenché et le conteneur principal est tué après une période de <i>grâce</i> .  Veuillez noter qu'en réalité, le processus d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">achèvement</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">module</a> est un peu plus compliqué. </li></ol><br>  Comment en suis-je arrivé à la séquence ci-dessus et à son timing?  Pour ce faire, nous avons utilisé le <i>déploiement</i> suivant, créé spécifiquement pour suivre l'ordre des événements (ce n'est pas très utile en soi): <br><br><pre> <code class="plaintext hljs">kind: Deployment apiVersion: apps/v1beta1 metadata: name: loap spec: replicas: 1 template: metadata: labels: app: loap spec: initContainers: - name: init image: busybox command: ['sh', '-c', 'echo $(date +%s): INIT &gt;&gt; /loap/timing'] volumeMounts: - mountPath: /loap name: timing containers: - name: main image: busybox command: ['sh', '-c', 'echo $(date +%s): START &gt;&gt; /loap/timing; sleep 10; echo $(date +%s): END &gt;&gt; /loap/timing;'] volumeMounts: - mountPath: /loap name: timing livenessProbe: exec: command: ['sh', '-c', 'echo $(date +%s): LIVENESS &gt;&gt; /loap/timing'] readinessProbe: exec: command: ['sh', '-c', 'echo $(date +%s): READINESS &gt;&gt; /loap/timing'] lifecycle: postStart: exec: command: ['sh', '-c', 'echo $(date +%s): POST-START &gt;&gt; /loap/timing'] preStop: exec: command: ['sh', '-c', 'echo $(date +%s): PRE-HOOK &gt;&gt; /loap/timing'] volumes: - name: timing hostPath: path: /tmp/loap</code> </pre> <br>  Notez que pour arrêter de force le pod lorsque le conteneur principal fonctionnait, j'ai exécuté la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl scale deployment loap --replicas=0</code> </pre> <br>  Nous avons examiné une séquence spécifique d'événements en action et nous sommes maintenant prêts à passer à des pratiques dans le domaine de la gestion du cycle de vie des foyers.  Ils sont les suivants: <br><br><ul><li>  Utilisez des conteneurs d'init pour préparer le foyer pour un fonctionnement normal.  Par exemple, pour obtenir des données externes, créer des tables dans la base de données ou attendre la disponibilité du service dont elles dépendent.  Si nécessaire, vous pouvez créer de nombreux conteneurs d'initialisation et tous doivent se terminer avec succès avant le lancement de conteneurs réguliers. </li><li>  Ajoutez toujours <code>livenessProbe</code> et <code>readinessProbe</code> .  Le premier est utilisé par <i>kubelet</i> 'ohm pour comprendre si et quand redémarrer le conteneur, et <i>déploiement</i> ' ohm pour décider si la mise à jour continue a réussi.  Le second est utilisé par le <i>service</i> pour décider de la direction du trafic vers le sous-marin.  Si ces échantillons ne sont pas définis, <i>kubelet</i> pour les deux suppose qu'ils ont été complétés avec succès.  Cela entraîne deux conséquences: a) la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">politique de redémarrage</a> ne peut pas être appliquée, b) les conteneurs dans l'âtre reçoivent instantanément du trafic du <i>service</i> auquel ils sont confrontés, et même s'ils sont toujours occupés par le processus de démarrage. </li><li>  Utilisez des crochets pour initialiser correctement le conteneur et le détruire complètement.  Par exemple, cela est utile dans le cas du fonctionnement d'une application dont vous n'avez pas accès au code source ou que vous ne pouvez pas modifier, mais qui nécessite une certaine initialisation ou préparation pour l'achèvement - par exemple, la suppression des connexions à la base de données.  Notez que lors de l'utilisation du <i>service</i> , l'arrêt du serveur API, du contrôleur de noeud final et du proxy de cube peut prendre un certain temps (par exemple, supprimer les entrées correspondantes d'iptables).  Par conséquent, la fin de votre travail sous peut affecter les demandes de candidature.  Souvent, pour résoudre ce problème, un simple crochet avec un appel de sommeil suffit. </li><li>  Pour les besoins de débogage et pour comprendre en général pourquoi elle a cessé de fonctionner, l'application peut écrire dans <code>/dev/termination-log</code> , et vous pouvez afficher les messages à l'aide de <code>kubectl describe pod …</code>  Ces paramètres par défaut sont modifiés via <code>terminationMessagePath</code> et / ou en utilisant <code>terminationMessagePolicy</code> dans la sous-spécification - voir la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">référence API</a> pour plus de détails. </li></ul><br>  Cette publication ne traite pas des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">initialiseurs</a> <i>(certains détails à leur sujet peuvent être trouvés à la fin de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce document</a> - <b>environ la traduction</b> )</i> .  Il s'agit d'un tout nouveau concept introduit dans Kubernetes 1.7.  Les initialiseurs fonctionnent à l'intérieur du plan de contrôle (serveur API) au lieu d'être dans le contexte du <i>kubelet</i> , et peuvent être utilisés pour enrichir les foyers, par exemple, avec des conteneurs side-car ou appliquer des politiques de sécurité.  De plus, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PodPresets</a> n'ont pas été pris en compte, ce qui à l'avenir peut être remplacé par un concept plus flexible d'initialiseurs. <br><br><h2>  PS du traducteur </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  «Que se passe-t-il dans Kubernetes au démarrage de l'exécution de kubectl?»: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 2</a> ; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment fonctionne le planificateur Kubernetes?"</a>  "; </li><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Guide illustré du réseautage chez Kubernetes</a> »; </li><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Notre expérience avec Kubernetes dans les petits projets</a> » <i>(reportage vidéo, qui comprend une introduction au dispositif technique de Kubernetes);</i> </li><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jouez avec Kubernetes - un service pour vous familiariser avec les K8</a> »; </li><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Infrastructure avec Kubernetes en tant que service abordable</a> .» </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415393/">https://habr.com/ru/post/fr415393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415383/index.html">Le commerçant novice a conclu un accord de 5,5 milliards d'euros en raison d'une erreur dans le système du courtier britannique</a></li>
<li><a href="../fr415385/index.html">La situation DCIM: comment la gestion de l'infrastructure des centres de données a changé ces dernières années</a></li>
<li><a href="../fr415387/index.html">Chaque développeur veut savoir comment se lancer dans le phishing.</a></li>
<li><a href="../fr415389/index.html">Aujourd'hui, le système de paiement "VKontakte"</a></li>
<li><a href="../fr415391/index.html">Début de la certification des appareils WPA3: les mots de passe faibles deviennent plus sûrs</a></li>
<li><a href="../fr415395/index.html">Téléviseurs ondulés</a></li>
<li><a href="../fr415397/index.html">PICASO 3D au Top 3D Expo 2018 - nouvelle imprimante 3D, nouveaux matériaux</a></li>
<li><a href="../fr415399/index.html">Pourquoi les prix des DVD gratuits sur Fortnite atteignent-ils 450 $</a></li>
<li><a href="../fr415401/index.html">Nous résolvons le problème d'un million d'onglets ouverts ou «aidons le matériel à survivre»</a></li>
<li><a href="../fr415403/index.html">Ports de finalisation epoll et Windows IO: la différence pratique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>