<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Ö üñêüèΩ üòΩ Como reescrevi um mecanismo de pesquisa de voos do PHP para o NodeJS üêù üñáÔ∏è ‚ôíÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Meu nome √© Andrey, sou estudante de gradua√ß√£o em uma das universidades t√©cnicas de Moscou e trabalha meio per√≠odo  muito modesto  empreendedor e de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como reescrevi um mecanismo de pesquisa de voos do PHP para o NodeJS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444400/"><p>  Oi  Meu nome √© Andrey, sou estudante de gradua√ß√£o em uma das universidades t√©cnicas de Moscou e trabalha meio per√≠odo <del>  muito modesto </del>  empreendedor e desenvolvedor iniciante.  Neste artigo, decidi compartilhar minha experi√™ncia de mudar do PHP (que eu gostei uma vez por causa de sua simplicidade, mas acabou sendo odiado por mim - explico por qu√™) no NodeJS.  Tarefas muito triviais e aparentemente elementares podem ser dadas aqui, as quais, no entanto, fiquei pessoalmente curioso para resolver durante meu conhecimento do NodeJS e os recursos do desenvolvimento do servidor em JavaScript.  Tentarei explicar e demonstrar claramente que o PHP finalmente entrou no por do sol e deu lugar ao NodeJS.  Talvez at√© seja √∫til para algu√©m aprender alguns recursos de renderiza√ß√£o de p√°ginas HTML no Node, que n√£o √© originalmente adaptado a isso a partir da palavra. </p><a name="habracut"></a><br><h2 id="vvedenie">  1. Introdu√ß√£o </h2><br><p>  Enquanto escrevia o mecanismo, usei as t√©cnicas mais simples.  Sem gerenciadores de pacotes, sem roteamento.  Somente pastas hardcore, cujo nome corresponde √† rota solicitada, e <strong>index.php</strong> em cada uma delas, configuradas pelo PHP-FPM para suportar o pool de processos.  Mais tarde, tornou-se necess√°rio usar o Composer e o Laravel, que foi a gota d'√°gua para mim.  Antes de passar √† hist√≥ria de por que decidi reescrever tudo, desde PHP at√© NodeJS, vou falar um pouco sobre o plano de fundo. </p><br><h3 id="menedzher-paketov">  Gerenciador de pacotes </h3><br><p>  No final de 2018, tive a oportunidade de trabalhar com um projeto escrito no Laravel.  Foi necess√°rio corrigir v√°rios bugs, fazer altera√ß√µes na funcionalidade existente, adicionar alguns novos bot√µes na interface.  O processo come√ßou instalando o gerenciador de pacotes e depend√™ncias.  No PHP, o Composer √© usado para isso.  Em seguida, o cliente forneceu um servidor com 1 n√∫cleo e 512 megabytes de RAM e essa foi minha primeira experi√™ncia com o Composer.  Ao instalar depend√™ncias em um servidor privado virtual com 512 megabytes de mem√≥ria, o processo travou devido √† falta de mem√≥ria. </p><br><p><img src="https://habrastorage.org/webt/pg/jm/hh/pgjmhhg0efngekrokj1yryvdzxg.png" alt="Wut?"></p><br><p> Para mim, como uma pessoa familiarizada com Linux e com experi√™ncia em trabalhar com Debian e Ubuntu, a solu√ß√£o para este problema era √≥bvia - instalar um arquivo SWAP (um arquivo de troca - para aqueles que n√£o est√£o familiarizados com a administra√ß√£o do Linux).  Um desenvolvedor inexperiente iniciante que instalou sua primeira distribui√ß√£o Laravel no Digital Ocean, por exemplo, apenas vai ao painel de controle e aumenta a tarifa at√© que a instala√ß√£o de depend√™ncias pare com um erro de segmenta√ß√£o de mem√≥ria.  E o NodeJS? <br>  E o NodeJS possui seu pr√≥prio gerenciador de pacotes - npm.  √â muito mais f√°cil de usar, mais compacto, pode funcionar mesmo em um ambiente com uma quantidade m√≠nima de RAM.  Em geral, n√£o h√° nada para culpar o Composer contra o NPM; no entanto, em caso de erros ao instalar pacotes, o Composer falhar√° como um aplicativo PHP comum e voc√™ nunca saber√° qual parte do pacote foi instalada e se foi instalada no final termina.  Em geral, para o administrador do Linux, a instala√ß√£o travada = flashbacks no Rescue Mode e <code>dpkg --configure -a</code> .  Quando essas "surpresas" me alcan√ßaram, eu n√£o gostava de PHP, mas essas eram as √∫ltimas unhas do caix√£o do meu grande amor pelo PHP. </p><br><h2 id="long-term-support-i-problema-versionirovaniya">  Problema de suporte e vers√£o de longo prazo </h2><br><p>  Lembra-se de que tipo de hype e espanto causaram o PHP7 quando os desenvolvedores o apresentaram pela primeira vez?  Aumente a produtividade em mais de 2 vezes e em alguns componentes at√© 5 vezes!  Lembra quando nasceu a s√©tima vers√£o do PHP?  E com que rapidez o WordPress ganhou!  Era dezembro de 2015.  Voc√™ sabia que o PHP 7.0 agora √© considerado uma vers√£o obsoleta do PHP e √© altamente recomend√°vel atualiz√°-lo ... N√£o, n√£o para a vers√£o 7.1, mas para a vers√£o 7.2.  Segundo os desenvolvedores, a vers√£o 7.1 j√° est√° privada de suporte ativo e recebe apenas atualiza√ß√µes de seguran√ßa.  E depois de 8 meses isso vai parar.  Parar√°, junto com o suporte ativo e a vers√£o 7.2.  Acontece que at√© o final deste ano, o PHP ter√° apenas uma vers√£o atual - 7.3. </p><br><p><img src="https://habrastorage.org/webt/zd/0p/me/zd0pmebltmchxqafrdw5yfpdfta.png" alt="Vers√µes atuais do PHP"></p><br><p>  Na verdade, isso n√£o seria muito dif√≠cil e eu n√£o atribuiria isso aos motivos de minha sa√≠da do PHP se os projetos que eu escrevi no PHP 7.0. * J√° n√£o causou um aviso de descontinua√ß√£o quando o abri.  Voltemos ao projeto em que a instala√ß√£o das depend√™ncias falhou.  Este foi um projeto escrito em 2015 no Laravel 4 com PHP 5.6.  Parecia que apenas quatro anos se passaram, mas n√£o - um monte de avisos de descontinua√ß√£o, m√≥dulos desatualizados, a incapacidade de atualizar para o Laravel 5 normalmente devido a v√°rias atualiza√ß√µes do mecanismo raiz. </p><br><p>  E isso n√£o se aplica apenas ao Laravel.  Tente escrever qualquer aplicativo PHP durante o suporte ativo das primeiras vers√µes do PHP 7.0 e esteja preparado para passar a noite procurando solu√ß√µes para problemas que surgiram em m√≥dulos PHP desatualizados.  Finalmente, um fato interessante: o suporte ao PHP 7.0 foi descontinuado antes do suporte ao PHP 5.6.  Por um segundo </p><br><p>  E o NodeJS?  Eu n√£o diria que tudo est√° muito melhor aqui e que os per√≠odos de suporte para o NodeJS s√£o fundamentalmente diferentes do PHP.  N√£o, √© a mesma coisa aqui - cada vers√£o do LTS √© suportada por 3 anos.  Mas o NodeJS possui um pouco mais dessas vers√µes mais atuais. </p><br><p><img src="https://habrastorage.org/webt/ff/xf/x_/ffxfx_rhvieo0jmad4wnabdrwuy.png" alt="Vers√µes atuais do NodeJS"></p><br><p>  Se voc√™ precisar implantar um aplicativo escrito em 2016, verifique se n√£o ter√° problemas com isso.  Ali√°s, a vers√£o 6. * n√£o ser√° mais suportada apenas em abril deste ano.  E na frente h√° 8, 10, 11 e os pr√≥ximos 12. </p><br><h2 id="o-trudnostyah-i-syurprizah-pri-perehode-na-nodejs">  Dificuldades e surpresas ao mudar para o NodeJS </h2><br><p>  Come√ßarei, talvez, com a pergunta mais interessante para mim sobre como renderizar p√°ginas HTML no NodeJS.  Mas vamos primeiro lembrar como isso √© feito no PHP: </p><br><ol><li>  Incorpore HTML diretamente no c√≥digo PHP.  O mesmo acontece com todos os novatos que ainda n√£o chegaram ao MVC.  E assim √© feito no WordPress, o que √© absolutamente horr√≠vel. </li><li>  Use o MVC, que deve simplificar a intera√ß√£o do desenvolvedor e fornecer algum tipo de divis√£o do projeto em partes, mas, na realidade, essa abordagem apenas complica tudo √†s vezes. </li><li>  Use um mecanismo de modelo.  A op√ß√£o mais conveniente, mas n√£o no PHP.  Basta olhar para a sintaxe sugerida no Twig ou Blade com chaves e porcentagens. </li></ol><br><p>  Sou um oponente ardente da combina√ß√£o ou fus√£o de v√°rias tecnologias.  O HTML deve existir separadamente, os estilos separadamente, o JavaScript separadamente (em React, isso geralmente parece monstruoso - HTML e JavaScript s√£o mistos).  √â por isso que a op√ß√£o ideal para desenvolvedores com prefer√™ncias como a minha √© um mecanismo de modelo.  N√£o precisei procurar por um aplicativo da Web no NodeJS por muito tempo e optei pelo Jade (PugJS).  Apenas aprecie a simplicidade de sua sintaxe: </p><br><pre> <code class="plaintext hljs"> div.row.links div.col-lg-3.col-md-3.col-sm-4 h4.footer-heading . div.copyright div.copy-text 2017 - #{current_year} . div.contact-link span : a(href='mailto:hello@flaut.ru') hello@flaut.ru</code> </pre> <br><p>  Tudo √© bem simples aqui: escrevi um modelo, baixei-o no aplicativo, compilei uma vez e depois o usei em qualquer lugar conveniente e a qualquer momento conveniente.  Na minha opini√£o, o desempenho do PugJS √© cerca de 2 vezes melhor que a renderiza√ß√£o, incorporando HTML no c√≥digo PHP.  Se anteriormente no PHP uma p√°gina est√°tica foi gerada pelo servidor em cerca de 200-250 milissegundos, agora √© de 90-120 milissegundos (n√£o estamos falando sobre a renderiza√ß√£o no PugJS, mas sobre o tempo gasto na solicita√ß√£o da p√°gina para a resposta do servidor ao cliente com HTML pronto )  √â assim que o carregamento e a compila√ß√£o de modelos e seus componentes no est√°gio de inicializa√ß√£o do aplicativo se parecem: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pugs = {} fs.readdirSync(__dirname + <span class="hljs-string"><span class="hljs-string">'/templates/'</span></span>).forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(file.endsWith(<span class="hljs-string"><span class="hljs-string">'.pug'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filepath = __dirname + <span class="hljs-string"><span class="hljs-string">'/templates/'</span></span> + file pugs[file.split(<span class="hljs-string"><span class="hljs-string">'.pug'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]] = pug.compile(fs.readFileSync(filepath, <span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>), { <span class="hljs-attr"><span class="hljs-attr">filename</span></span>: filepath }) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(e) } } }) <span class="hljs-comment"><span class="hljs-comment">//       return pugs.tickets({ ...config })</span></span></code> </pre> <br><p>  Parece incrivelmente simples, mas com Jade havia um pouco de complexidade no est√°gio de trabalhar com HTML j√° compilado.  O fato √© que, para implementar scripts na p√°gina, √© usada uma fun√ß√£o ass√≠ncrona, que retira todos os arquivos <code>.js</code> do diret√≥rio e adiciona a data da √∫ltima altera√ß√£o a cada um deles.  A fun√ß√£o tem o seguinte formato: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; files.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> period = files[i].lastIndexOf(<span class="hljs-string"><span class="hljs-string">'.'</span></span>) <span class="hljs-comment"><span class="hljs-comment">// get last dot in filename let filename = files[i].substring(0, period) let extension = files[i].substring(period + 1) if(extension === 'js') { let fullFilename = filename + '.' + extension if(env === 'production') { scripts.push({ path: paths.production.web + fullFilename, mtime: await getMtime(paths.production.code + fullFilename)}) } else { if(files[i].startsWith('common') || files[i].startsWith('search')) { scripts.push({ path: paths.developer.scripts.web + fullFilename, mtime: await getMtime(paths.developer.scripts.code + fullFilename)}) } else { scripts.push({ path: paths.developer.vendor.web + fullFilename, mtime: await getMtime(paths.developer.vendor.code + fullFilename)}) } } } }</span></span></code> </pre> <br><p>  Na sa√≠da, obtemos uma matriz de objetos com duas propriedades - o caminho para o arquivo e a hora em que ele foi editado pela √∫ltima vez no registro de data e hora (para atualizar o cache do cliente).  O problema √© que, mesmo na fase de coleta dos arquivos de script de um diret√≥rio, todos eles s√£o carregados na mem√≥ria estritamente em ordem alfab√©tica (pois est√£o localizados no pr√≥prio diret√≥rio e os arquivos s√£o coletados de cima para baixo - do primeiro ao √∫ltimo).  Isso levou ao fato de o arquivo <strong>app.js ter</strong> sido carregado primeiro e j√° ap√≥s o arquivo core.min.js com polyfills e vendor.min.js no final.  Esse problema foi resolvido de maneira simples - classifica√ß√£o muito banal: </p><br><pre> <code class="javascript hljs">scripts.sort(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(a.path.includes(<span class="hljs-string"><span class="hljs-string">'core.min.js'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(a.path.includes(<span class="hljs-string"><span class="hljs-string">'vendor.min.js'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> })</code> </pre> <br><p>  No PHP, tudo tinha uma apar√™ncia monstruosa na forma de caminhos para arquivos JS pr√©-gravados em uma string.  Simples, mas impratic√°vel. </p><br><h3 id="nodejs-derzhit-svoyo-prilozhenie-v-operativnoy-pamyati">  NodeJS mant√©m sua aplica√ß√£o na RAM </h3><br><p>  Esta √© uma enorme vantagem.  Tudo est√° organizado para mim, para que, no servidor, paralelamente e independentemente um do outro, existam dois sites separados - a vers√£o para o desenvolvedor e a vers√£o de produ√ß√£o.  Imagine que eu fiz algumas altera√ß√µes nos arquivos PHP no site de desenvolvimento e preciso implantar essas altera√ß√µes na produ√ß√£o.  Para fazer isso, √© necess√°rio parar o servidor ou colocar um stub "desculpe, t√©cnico. Trabalho" e, neste momento, copiar arquivos individualmente da pasta de desenvolvedor para a pasta de produ√ß√£o.  Isso causa algum tipo de tempo de inatividade e pode resultar em perda de convers√µes.  A vantagem do <strong>aplicativo</strong> na <strong>mem√≥ria</strong> do NodeJS √© para mim que todas as altera√ß√µes nos arquivos do mecanismo ser√£o feitas somente ap√≥s a reinicializa√ß√£o.  Isso √© muito conveniente, porque voc√™ pode copiar todos os arquivos necess√°rios com as altera√ß√µes e s√≥ ent√£o reiniciar o servidor.  O processo n√£o leva mais que 1-2 segundos e n√£o causa tempo de inatividade. <br>  A mesma abordagem √© usada no nginx, por exemplo.  Voc√™ primeiro edita a configura√ß√£o, verifica-a com <code>nginx -t</code> e s√≥ depois faz altera√ß√µes com o <code>service nginx reload</code> </p><br><h3 id="klasterizaciya-nodejs-prilozheniya">  Agrupando um Aplicativo NodeJS </h3><br><p>  O NodeJS possui uma ferramenta muito conveniente - o <strong>gerenciador de</strong> processos <strong>pm2</strong> .  Como geralmente executamos aplicativos no Node?  Entramos no console e escrevemos o <code>node index.js</code> .  Assim que fechamos o console, o aplicativo √© fechado.  Pelo menos √© o que acontece em um servidor com o Ubuntu.  Para evitar isso e manter o aplicativo sempre em execu√ß√£o, basta adicion√°-lo ao <strong>pm2 com o</strong> comando <code>pm2 start index.js --name production</code> simples.  Mas isso n√£o √© tudo.  A ferramenta permite monitoramento ( <code>pm2 monit</code> ) e cluster de aplicativos. </p><br><p>  Vamos lembrar como os processos s√£o organizados em PHP.  Suponha que tenhamos o nginx atendendo solicita√ß√µes http e precisamos passar a solicita√ß√£o para o PHP.  Voc√™ pode fazer isso diretamente e, a cada solicita√ß√£o, um novo processo PHP ser√° gerado e, quando conclu√≠do, ser√° eliminado.  Ou voc√™ pode usar um servidor fastcgi.  Acho que todo mundo sabe o que √© e n√£o h√° necessidade de entrar em detalhes, mas, no caso, vou esclarecer que o PHP-FPM √© mais frequentemente usado como fastcgi e sua tarefa √© gerar muitos processos PHP prontos para aceitar e processar uma nova solicita√ß√£o a qualquer momento.  Qual √© a desvantagem dessa abordagem? </p><br><p>  A primeira √© que voc√™ nunca sabe quanta mem√≥ria seu aplicativo consumir√°.  Em segundo lugar, voc√™ sempre estar√° limitado no n√∫mero m√°ximo de processos e, consequentemente, com um salto acentuado no tr√°fego, seu aplicativo PHP usar√° toda a mem√≥ria dispon√≠vel e travar√°, ou ficar√° contra o limite permitido de processos e come√ßar√° a matar os antigos.  Isso pode ser evitado definindo N√£o lembro qual par√¢metro no arquivo de configura√ß√£o do PHP-FPM √© <strong>din√¢mico</strong> e, em seguida, quantos processos ser√£o gerados conforme necess√°rio no momento.  Mas, novamente, um ataque DDoS elementar consome toda a RAM e coloca seu servidor.  Ou, por exemplo, um script de bug consumir√° toda a RAM e o servidor congelar√° por algum tempo (houve precedentes no processo de desenvolvimento). </p><br><p>  A diferen√ßa fundamental no NodeJS √© que o aplicativo n√£o pode consumir mais de 1,5 gigabytes de RAM.  N√£o h√° restri√ß√µes de processo, h√° apenas um limite de mem√≥ria.  Isso incentiva voc√™ a escrever os programas mais leves poss√≠veis.  Al√©m disso, √© muito simples calcular o n√∫mero de clusters que podemos pagar, dependendo do recurso de CPU dispon√≠vel.  √â recomend√°vel que voc√™ desligue n√£o mais que um cluster em cada n√∫cleo (exatamente como no nginx, n√£o mais que um trabalhador por n√∫cleo da CPU). </p><br><p><img src="https://habrastorage.org/webt/rk/z4/hp/rkz4hp9g8jkptpmq_tbc-_gpdpu.png" alt="Clustering no PM2"></p><br><p>  Uma vantagem dessa abordagem √© que o PM2 recarrega todos os clusters por vez.  Voltando ao par√°grafo anterior, que falou sobre o tempo de inatividade de 1-2 segundos durante a reinicializa√ß√£o.  No modo de cluster, quando voc√™ reinicia o servidor, seu aplicativo n√£o ter√° um milissegundo de tempo de inatividade. </p><br><h3 id="nodejs---eto-horoshiy-shveycarskiy-nozh">  NodeJS √© uma boa faca su√≠√ßa </h3><br><p>  Agora existe uma situa√ß√£o em que o PHP age como uma linguagem para escrever sites e o Python atua como uma ferramenta para rastrear esses sites.  NodeJS √© 2 em 1, por um lado √© um garfo, por outro √© uma colher.  Voc√™ pode escrever aplicativos e rastreadores da Web r√°pidos e poderosos no mesmo servidor dentro do mesmo aplicativo.  Parece tentador.  Mas como isso pode ser percebido, voc√™ pergunta?  O pr√≥prio Google lan√ßou a API oficial do Chromium - Puppeteer.  Voc√™ pode iniciar o Headless Chrome (um navegador sem uma interface de usu√°rio - Chrome "sem cabe√ßa") e obter o acesso mais amplo poss√≠vel √† API do navegador para rastrear p√°ginas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A maneira mais simples e acess√≠vel de trabalhar com o Puppeteer</a> . </p><br><p>  Por exemplo, no nosso grupo VKontakte, h√° uma publica√ß√£o regular de descontos e ofertas especiais para v√°rios destinos das cidades da CEI.  Geramos imagens para postagens no modo autom√°tico e, para torn√°-las bonitas, precisamos de belas imagens.  Como n√£o gosto de vincular v√°rias APIs e criar contas em dezenas de sites, escrevi um aplicativo simples que imita um usu√°rio comum com o navegador Google Chrome que percorre o site com imagens de estoque e escolhe aleatoriamente a imagem encontrada pela palavra-chave.  Eu costumava usar Python e BeautifulSoup para isso, mas agora isso n√£o √© mais necess√°rio.  E a principal caracter√≠stica e vantagem do Puppeteer √© que voc√™ pode facilmente enganar at√© sites de SPA, porque voc√™ tem √† sua disposi√ß√£o um navegador completo que entende e executa o c√≥digo JavaScript nos sites.  √â dolorosamente simples: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> browser = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> puppeteer.launch({<span class="hljs-attr"><span class="hljs-attr">headless</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">args</span></span>:[<span class="hljs-string"><span class="hljs-string">'--no-sandbox'</span></span>]}) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> page = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> browser.pages())[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.goto(<span class="hljs-string"><span class="hljs-string">`https://pixabay.com/photos/search/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${imageKeyword}</span></span></span><span class="hljs-string">/?cat=buildings&amp;orientation=horizontal`</span></span>, { <span class="hljs-attr"><span class="hljs-attr">waitUntil</span></span>: <span class="hljs-string"><span class="hljs-string">'networkidle0'</span></span> })</code> </pre> <br><p>  Assim, em tr√™s linhas de c√≥digo, lan√ßamos o navegador e abrimos a p√°gina do site com imagens.  Agora podemos selecionar um bloco aleat√≥rio com a imagem na p√°gina e adicionar uma classe a ela, na qual mais tarde poderemos virar da mesma maneira e ir para a p√°gina diretamente com a pr√≥pria imagem para carregamento adicional: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> imagesLength = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> page.evaluate(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> photos = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'.search_results &gt; .item'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(photos.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { photos[<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * photos.length)].className += <span class="hljs-string"><span class="hljs-string">' --anomaly_selected'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> photos.length })</code> </pre> <br><p>  Lembre-se de quanto c√≥digo seria necess√°rio para escrever isso no PhantomJS (que, ali√°s, fechou e entrou em estreita colabora√ß√£o com a equipe de desenvolvimento do Puppeteer).  Uma ferramenta t√£o maravilhosa pode impedir algu√©m de mudar para o NodeJS? </p><br><h3 id="v-nodejs-zalozhena-asinhronnost-na-fundamentalnom-urovne">  O NodeJS fornece assincronia fundamental </h3><br><p>  Isso pode ser considerado uma enorme vantagem do NodeJS e JavaScript, especialmente com o advento do async / wait no ES2017.  Ao contr√°rio do PHP, onde qualquer chamada √© feita de forma s√≠ncrona.  Vou dar um exemplo simples.  Anteriormente, no mecanismo de pesquisa, as p√°ginas eram geradas no servidor, mas algo precisava ser exibido na p√°gina j√° no cliente usando JavaScript, mas naquele momento o Yandex ainda n√£o era capaz de usar o JavaScript em sites e precisava implementar um mecanismo de captura instant√¢nea (captura instant√¢nea de p√°gina) especificamente para ele. usando o Prerender.  Os instant√¢neos foram armazenados em nosso servidor e emitidos para o rob√¥ mediante solicita√ß√£o.  O dilema era que essas imagens eram geradas em 3-5 segundos, o que √© completamente inaceit√°vel e pode afetar a classifica√ß√£o do site nos resultados da pesquisa.  Para resolver esse problema, um algoritmo simples foi inventado: quando o rob√¥ solicita alguma p√°gina, uma captura instant√¢nea da qual j√° possu√≠mos, fornecemos apenas a captura instant√¢nea existente, ap√≥s a qual realizamos a opera√ß√£o para criar uma nova captura instant√¢nea em segundo plano e substitu√≠-la j√° est√° dispon√≠vel.  Como foi feito no PHP: </p><br><pre> <code class="php hljs">exec(<span class="hljs-string"><span class="hljs-string">'/usr/bin/php '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">__DIR__</span></span> . <span class="hljs-string"><span class="hljs-string">'/snapshot.php -a '</span></span> . $affiliation_type . <span class="hljs-string"><span class="hljs-string">' -l '</span></span> . urlencode($full_uri) . <span class="hljs-string"><span class="hljs-string">' &gt; /dev/null 2&gt;/dev/null &amp;'</span></span>);</code> </pre> <br><p>  Nunca fa√ßa isso. <br>  No NodeJS, isso pode ser alcan√ßado chamando a fun√ß√£o ass√≠ncrona: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveSnapshot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ getSnapshot().then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function">) =&gt;</span></span> { db.saveSnapshot().then(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(status.err) <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.error(err) }) }) } <span class="hljs-comment"><span class="hljs-comment">/** *     await * ..    resolve()   */</span></span> saveSnapshot()</code> </pre> <br><p>  Em resumo, voc√™ n√£o est√° tentando ignorar o sincronismo, mas decide quando usar a execu√ß√£o de c√≥digo s√≠ncrono e quando usar ass√≠ncrono.  E √© realmente conveniente.  Especialmente quando voc√™ aprende sobre as possibilidades de <strong>Promise.all ()</strong> </p><br><p>  O pr√≥prio mecanismo de pesquisa de v√¥o √© projetado de tal maneira que envia uma solicita√ß√£o para um segundo servidor que coleta e agrega dados e, em seguida, recorre a ele para obter dados prontos para emiss√£o.  As p√°ginas de dire√ß√£o s√£o usadas para atrair tr√°fego org√¢nico. </p><br><p>  Por exemplo, para a consulta "Voos Moscou S√£o Petersburgo", uma p√°gina ser√° emitida com o endere√ßo <em>/ tickets / moscow / saint-petersburg /</em> e precisar√° de dados: </p><br><ol><li>  Pre√ßos das companhias a√©reas nessa dire√ß√£o para o m√™s atual </li><li>  Pre√ßos das companhias a√©reas nessa dire√ß√£o para o pr√≥ximo ano (pre√ßo m√©dio para cada m√™s nos pr√≥ximos 12 meses) </li><li>  Programe voos nessa dire√ß√£o </li><li>  Destinos populares da cidade de expedi√ß√£o - de Moscou (para liga√ß√£o) </li><li>  Os destinos populares da cidade de chegada s√£o de S√£o Petersburgo (para vincula√ß√£o) </li></ol><br><p>  No PHP, todos esses pedidos foram executados de forma s√≠ncrona - um ap√≥s o outro.  O tempo m√©dio de resposta da API por solicita√ß√£o √© de 150-200 milissegundos.  Multiplicamos 200 por 5 e obtemos, em m√©dia, um segundo apenas para atender solicita√ß√µes ao servidor com dados.  O NodeJS possui uma excelente fun√ß√£o <strong>chamada Promise.all</strong> , que executa todos os pedidos em paralelo, mas grava o resultado um a um.  Por exemplo, o c√≥digo de execu√ß√£o para todas as cinco solicita√ß√µes acima ficaria assim: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> [montlyPrices, yearlyPrices, flightsSchedule, originPopulars, destPopulars] = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([ getMontlyPrices(), getYearlyPrices(), getFlightSchedule(), getOriginPopulars(), getDestPopulars() ])</code> </pre> <br><p>  E obtemos todos os dados em 200 a 300 milissegundos, reduzindo o tempo de gera√ß√£o de dados da p√°gina de 1 a 1,5 segundos para ~ 500 milissegundos. </p><br><h3 id="zaklyuchenie">  Conclus√£o </h3><br><p>  A mudan√ßa do PHP para o NodeJS me ajudou a familiarizar-me com o JavaScript ass√≠ncrono, aprender a trabalhar com promessas e ass√≠ncrono / aguardar.  Depois que o mecanismo foi reescrito, a velocidade de carregamento da p√°gina foi otimizada e diferiu drasticamente dos resultados que o mecanismo mostrou em PHP.  Neste artigo, tamb√©m poder√≠amos falar sobre como os m√≥dulos simples s√£o usados ‚Äã‚Äãpara trabalhar com o cache (Redis) e o pg-promessa (PostgreSQL) no NodeJS e compar√°-los com o Memcached e o php-pgsql, mas este artigo mostrou-se bastante volumoso.  E conhecendo meu "talento" para escrever, ela tamb√©m se mostrou mal estruturada.  O objetivo deste artigo √© atrair a aten√ß√£o de desenvolvedores que ainda est√£o trabalhando com PHP e n√£o est√£o cientes das del√≠cias do NodeJS e do desenvolvimento de aplicativos baseados na Web usando um exemplo de projeto da vida real que j√° foi escrito em PHP, mas devido a prefer√™ncias seu dono foi para outra plataforma. </p><br><p>  Espero poder transmitir meus pensamentos e mais ou menos estruturados para express√°-los neste material.  Pelo menos eu tentei :) </p><br><p>  Escreva qualquer coment√°rio - amig√°vel ou com raiva.  Eu responderei a qualquer construtivo. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt444400/">https://habr.com/ru/post/pt444400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt444390/index.html">Sistema DeviceLock 8.3 DLP: um ano se passou, Billy, mas voc√™ n√£o mudou nada</a></li>
<li><a href="../pt444392/index.html">Radia√ß√£o: riscos, seguran√ßa, prote√ß√£o</a></li>
<li><a href="../pt444394/index.html">Linux Foundation lan√ßa novo projeto DevOps com Jenkins e Spinnaker</a></li>
<li><a href="../pt444396/index.html">Estande da Epson no ISE 2019 - a exposi√ß√£o j√° passou, as impress√µes permanecem</a></li>
<li><a href="../pt444398/index.html">Por que as lojas que n√£o s√£o de alimentos precisam de uma organiza√ß√£o de autoatendimento?</a></li>
<li><a href="../pt444402/index.html">React Code Split em 2019</a></li>
<li><a href="../pt444404/index.html">Por que temos medo de rob√¥s?</a></li>
<li><a href="../pt444406/index.html">It√°lia digital. O que e como funciona</a></li>
<li><a href="../pt444408/index.html">A Apple lan√ßou novos iPads ontem e tem d√∫vidas.</a></li>
<li><a href="../pt444410/index.html">Mapas de rede. Uma breve vis√£o geral do software para constru√ß√£o de mapas de rede</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>