<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😶 👩🏽‍🔬 👵🏻 Webinaire ouvert "SELECT ordre d'exécution des requêtes et plan de requête dans MS SQL Server" 💆🏿 🗜️ 🏇🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour encore! 

 Chers collègues, le dernier jour de janvier, nous lançons le cours «MS SQL Server Developer» , dans le cadre duquel nous avons eu u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Webinaire ouvert "SELECT ordre d'exécution des requêtes et plan de requête dans MS SQL Server"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/437828/">  Bonjour encore! <br><br>  Chers collègues, le dernier jour de janvier, nous lançons le cours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«MS SQL Server Developer»</a> , dans le cadre duquel nous avons eu une leçon ouverte thématique.  Nous y avons expliqué comment MS SQL Server exécute une requête SELECT, discuté dans quel ordre et ce qui est analysé, et avons également plongé un peu dans la lecture du plan de requête. <br><br>  Conférencier - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kristina Kucherova</a> , architecte de modèle de données à la Sberbank de Russie. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/H9oS-eLSX_8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br>  <b>Objectifs et itinéraire du webinaire</b> <br><br>  Les objectifs suivants ont été fixés au début du webinaire: <br><br><ol><li>  Découvrez comment le serveur exécute la demande et pourquoi cela se produit de cette manière. </li><li>  Apprendre à lire un plan de requête. </li></ol><br>  Pour les atteindre, l'enseignant a préparé un parcours simple mais efficace: <br><br><img src="https://habrastorage.org/webt/fq/kj/nr/fqkjnrypzokv5wpzw1phclft3xa.jpeg"><br><br>  <b>Pourquoi ai-je besoin d'un plan de requête?</b> <br><br>  Le plan de requête est un outil très utile que, malheureusement, de nombreux développeurs n'utilisent pas.  À première vue, il peut sembler qu'il n'est pas nécessaire de connaître la mécanique de la demande.  Cependant, si vous comprenez ce qui se passe dans SQL Server, vous pouvez écrire une requête plus efficace.  Et cela aidera beaucoup, par exemple, lors de l'optimisation. <br><br>  <b>Comment voyons-nous une requête SELECT?</b> <br><br>  Voyons à quoi ressemble la requête SELECT: <br><br><table><tbody><tr><td>  SELECT [champ1], [champ2] ... <br></td><td>  Quels domaines choisissons-nous? <br></td></tr><tr><td>  DE [table] <br></td><td>  D'où? <br></td></tr><tr><td>  O [[conditions] <br></td><td>  Où sont les conditions <br></td></tr><tr><td>  GROUPE PAR [champ1] <br></td><td>  Regrouper par champs <br></td></tr><tr><td>  AYANT [conditions] <br></td><td>  Avoir telle ou telle condition <br></td></tr><tr><td>  COMMANDER PAR [field1] <br></td><td>  Commande (trier) <br></td></tr></tbody></table><br>  <b>Comment comprendre où aller pour les données?</b> <br><br>  La première chose que le serveur essaie de comprendre quand une demande arrive est où aller pour les données.  La commande FROM répond à cette question, car c'est ici que nous aurons une liste de tables (ou le nom d'une table). <br><br>  Pour plus de clarté, imaginons que notre serveur est une sorte de majordome, que nous commandons pour venir nous chercher en vacances.  En conséquence, le majordome commence à réfléchir, mais dans quel placard sont les choses nécessaires (dans quelle table avez-vous besoin de prendre les données)?  Et pour que notre majordome puisse facilement terminer sa tâche, nous utilisons FROM. <br><br><img src="https://habrastorage.org/webt/ig/wo/uy/igwouy4la8vroshisd8pk5sqcx8.jpeg"><br><br>  <b>Comment comprendre quelles données prendre?</b> <br><br>  Disons que le majordome a trouvé le bon placard et l'a ouvert.  Mais quelles choses prendre?  Peut-être que nous allons dans une station de ski?  Ou peut-être sur une plage chaude et ensoleillée?  Pour que nos choses correspondent à la météo, la commande WHERE est utile pour nous, qui définit les conditions, c'est-à-dire nous permet de filtrer les données.  S'il fait chaud, nous prenons des ardoises, des chemises et des maillots de bain, s'il fait froid - mitaines, chaussettes tricotées, pulls)). <br><br>  L'étape suivante consiste à attacher ces données à des groupes, ce qui se produit avec GROUP BY (T-shirts séparément, chaussettes séparément).  Selon les résultats du regroupement, une condition supplémentaire peut être imposée à l'aide de HAVING (par exemple, éliminer les éléments non appariés).  En fin de compte, nous ajoutons tout en utilisant ORDER BY, obtenant la valise finie des choses à la sortie, ou plutôt, un bloc de données ordonné. <br><br><img src="https://habrastorage.org/webt/vd/lt/4b/vdlt4bg1o5ebpaxz1di_vhl__tm.jpeg"><br><br>  Soit dit en passant, il y a une nuance, mais elle consiste dans le fait qu'il y a une différence entre les conditions qui doivent être écrites dans OERE et celles dans HAVING.  Mais c'est mieux à voir dans la vidéo. <br><br>  Nous continuons.  Le chemin d'exécution de la demande est enregistré en <b>tant que plan de demande</b> dans le cache, c'est-à-dire que notre majordome écrit tout, car il est un bon majordome - et si vous voulez répéter votre commande l'année prochaine?  Et de tels plans, en principe, peuvent être nombreux. <br><br>  <b>Types de connexions dans le plan de requête</b> <br><br>  Il existe trois connexions que vous pouvez rencontrer en termes de requête: <br><br><ol><li>  Boucle imbriquée. </li><li>  Fusionner la jointure. </li><li>  Hash join. </li></ol><br>  Avant de nous attarder sur chacun d'eux plus en détail, résumons pourquoi nous devrions même lire le plan de requête.  Ceci est en fait très utile car vous apprendrez: <br><br><ul><li>  quel indice est utilisé; </li><li>  dans quel ordre adhérez-vous; </li><li>  ce qui est sélectionné dans le tampon; </li><li>  combien le serveur dépense des ressources pour l'opération; </li><li>  quelle est la différence entre un plan hypothétique et un plan réel. </li></ul><br>  <b>Boucle imbriquée</b> <br><br>  Disons que nous devons joindre les données de différentes tables.  Présentons ces tableaux comme ... une petite quantité de chocolats Skittles et l'emballage complet de M&amp;M. <br><br><img src="https://habrastorage.org/webt/4k/-s/uh/4k-suhjbpvptu8kjhe77rx8posm.jpeg"><br><br>  Lors de la connexion d'un type de boucle imbriquée, nous prenons le bonbon Skittles, puis nous obtenons le bonbon aveugle du package de M&amp;M.  Si nous ne tombons pas sur un bonbon de la même couleur (c'est notre condition), nous obtenons le suivant, c'est-à-dire qu'il y a un buste habituel.  Par conséquent, nous pouvons dire que la connexion en boucle imbriquée convient mieux à de petites quantités de données.  De toute évidence, s'il y a beaucoup de données, la suppression n'est pas la meilleure option. <br><br><img src="https://habrastorage.org/webt/fu/0d/mv/fu0dmvprjve1i1mgbn5v3nou3ow.jpeg"><br><br>  Voyons à quoi cela ressemble dans le panneau SQL: <br><br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--drop table skittles --drop table mms --    create table mms (id int identity(1,1), color varchar(25), taste varchar(15)) insert into mms (color, taste) values ('yellow', 'chocolate') insert into mms (color, taste) values ('red', 'nuts') create clustered index IX_mms_color ON mms(color); create table skittles (id int identity(1,1), color varchar(25), taste varchar(15)) create index IX_skittles_id ON skittles(id); create clustered index IX_skittles_color ON skittles(color); insert into skittles (color, taste) values ('red', 'cherry') insert into skittles (color, taste) values ('blue', 'strange') insert into skittles (color, taste) values ('yellow', 'lemon') insert into skittles (color, taste) values ('green', 'apple') insert into skittles (color, taste) values ('orange', 'orange') --    select mms.* from mms join skittles on mms.color = skittles.color select * from mms join skittles on mms.color = skittles.color</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/gx/vj/ed/gxvjedgxwzjcdv2kbzreqmmofwi.jpeg"><br><br>  <b>Fusionner la jointure</b> <br><br>  Une connexion est utilisée pour de grandes quantités de données.  Lorsque vous avez une jointure de fusion, vos deux tables ont un index par lequel elles peuvent être jointes.  Dans le cas des bonbons, c'est comme si nous les avions disposés à l'avance par couleur. <br><br>  Cela ressemble à ceci: <br><br><img src="https://habrastorage.org/webt/j2/cy/ld/j2cyldmem4_ytym2ssj3wpyco1q.jpeg"><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--2 tables 50000 rows, only clustered index by color, color is not unique select COUNT(*) from mms_big join skittles_big on mms_big.color = skittles_big.color</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/xv/vm/mf/xvvmmf1ozq_lt7f2rrcnqsvz1cs.jpeg"><br><br>  La fusion de jointure est bonne dans les cas suivants: <br><br><ul><li>  grands ensembles de données; </li><li>  les mêmes champs de connexion du même type; </li><li>  les champs de connexion ont des indices. </li></ul><br>  <b>Hash Join</b> <br><br>  La jointure par hachage est utilisée pour de grandes quantités de données non triées.  Pour rejoindre les tables dans ce cas, vous devez créer quelque chose qui imite l'index. <br><br>  Exemple de jointure par hachage: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--drop table skittles --drop table mms --    create table mms (id int identity(1,1), color varchar(25), taste varchar(15)) insert into mms (color, taste) values ('yellow', 'chocolate') insert into mms (color, taste) values ('red', 'nuts') insert into mms (color, taste) values ('blue', 'strange') insert into mms (color, taste) values ('green', 'chocolate') insert into mms (color, taste) values ('orange', 'chocolate') create table skittles (id int identity(1,1), color varchar(25), taste varchar(15)) insert into skittles (color, taste) values ('red', 'cherry') insert into skittles (color, taste) values ('blue', 'strange') insert into skittles (color, taste) values ('yellow', 'lemon') insert into skittles (color, taste) values ('green', 'apple') insert into skittles (color, taste) values ('orange', 'orange') --    select * from mms join skittles on mms.color = skittles.color</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/0g/vr/xd/0gvrxdfdoc55bwpdkv5ghkwnq-w.jpeg"><br><br>  Pour plus de clarté, nous rappelons nos bonbons: <br><br><img src="https://habrastorage.org/webt/xg/2l/cn/xg2lcndw5mzxm5msx6l_0kq_4wc.jpeg"><br><br>  L'utilisation de Hash Join implique 2 phases d'action: <br><br><ol><li>  Build - une table de hachage est construite sur la plus petite table.  Pour chaque valeur du tableau n ° 1, un hachage est considéré.  La valeur est stockée dans une table de hachage et le hachage calculé est utilisé comme clé. </li><li>  Sonde.  Pour chaque ligne du tableau n ° 2, la valeur de hachage est calculée pour les champs spécifiés dans join (operator =).  Un hachage est recherché dans la table de hachage, les valeurs des champs sont vérifiées. </li></ol><br><img src="https://habrastorage.org/webt/nr/nn/q2/nrnnq2ahbh57a28x3szylahyjue.jpeg"><br><br><img src="https://habrastorage.org/webt/fu/e3/bg/fue3bgxwsesvzgwjgzzva6isnpu.jpeg"><br><br><img src="https://habrastorage.org/webt/dd/fx/mn/ddfxmnjwgneqpqmzxeseavjpkhy.jpeg"><br><br>  Lorsque la jonction de hachage est bonne: <br><br><ul><li>  grand ensemble de données; </li><li>  pas d'indices marginaux. </li></ul><br>  Un point important: s'il n'y a pas assez de mémoire, l'enregistrement ira à tempdb - sur le disque. <br><br>  Amis, en plus de ce qui précède, la leçon ouverte comprenait également d'autres points intéressants, qui sont mieux vus en regardant la vidéo.  Nous vous suggérons de visiter la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journée portes ouvertes du cours</a> "Développeur MS SQL Server", où vous pourrez poser toutes vos questions au professeur. <br><br>  L'enseignante PS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kristina Kucherova</a> remercie Jes Schultz Borland pour sa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">présentation</a> avec PASS Summitt Execution Plans: The Secret to Query Tuning Success, qui a été utilisé pour préparer la leçon ouverte. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437828/">https://habr.com/ru/post/fr437828/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437816/index.html">MPLS est partout. Comment est l'infrastructure réseau Yandex.Cloud</a></li>
<li><a href="../fr437818/index.html">Nous enseignons à un ordinateur à distinguer les sons: se familiariser avec le concours DCASE et assembler votre classificateur audio en 30 minutes</a></li>
<li><a href="../fr437820/index.html">50 nuances de sécurité Drupal</a></li>
<li><a href="../fr437824/index.html">Extension universelle 1C pour Google Sheets et Docs - prendre et utiliser</a></li>
<li><a href="../fr437826/index.html">Comment nous avons migré la base de données de Redis et Riak KV vers PostgreSQL. Partie 1: le processus</a></li>
<li><a href="../fr437830/index.html">Programmation fiable par langage - revue noob. Partie 1</a></li>
<li><a href="../fr437832/index.html">Open source: humour de code, astuces de code, PAS de code</a></li>
<li><a href="../fr437834/index.html">Deux histoires sur la façon dont les événements de programmation ont eu lieu à Iekaterinbourg</a></li>
<li><a href="../fr437836/index.html">Under the hood Screeps - virtualisation dans le sandbox MMO pour les programmeurs</a></li>
<li><a href="../fr437838/index.html">Les technologies d'apprentissage automatique accélèrent parfois le processus d'adaptation des patients aux prothèses bioniques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>