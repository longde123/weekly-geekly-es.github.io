<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍🎨 🤦🏽 👨🏻‍⚕️ PHP, YII2 und die Bildung großer Excel-Dateien 🎷 🚵🏼 🖖🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Starten Sie 
 Ein von unserem Unternehmen unterstütztes Buchhaltungs- und Berichtssystem wuchs in Bezug auf die gespeicherte Datenmenge sehr schnell. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP, YII2 und die Bildung großer Excel-Dateien</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420393/"><h3>  Starten Sie </h3><br>  Ein von unserem Unternehmen unterstütztes Buchhaltungs- und Berichtssystem wuchs in Bezug auf die gespeicherte Datenmenge sehr schnell.  Das System ist in PHP unter Verwendung des Yii2-Frameworks geschrieben.  Anfänglich wurden Berichte über die PhpSpreadsheet-Bibliothek erstellt, die das seit langem veraltete PhpExcel ersetzte. <br><br>  Unter den verschiedenen Arten der Berichterstellung gab es eine sehr große - tatsächlich sollte der vollständige Satz aller in der Datenbank gespeicherten Daten in eine Excel-Tabelle hochgeladen werden.  In der Anfangsphase gab es keine Probleme, aber als das Volumen begann, viele hunderttausende Datensätze zu überschreiten, begann das Skript zum Entladen der Formation zum Zeitlimit zu fallen. <a name="habracut"></a>  Zunächst haben wir diese Grenze angehoben und nach Wegen gesucht, um das Problem zu lösen.  Eine vorübergehende Lösung hielt jedoch nicht lange an - das Problem mit dem Zeitlimit wurde zu einem Problem mit dem Speicherlimit.  Sie warfen den "RAM" auf den Server und entfernten das memory_limit für diese bestimmte Operation.  Sehr bald beschwerten sich Benutzer erneut über Laufzeitfehler.  Ich musste das Zeitlimit für den vollständigen Bericht aufheben.  Aber ein Dutzend Minuten mit einer Ladeanzeige auf dem Bildschirm zu sitzen und zu schauen, macht nicht viel Spaß.  Darüber hinaus wurde manchmal ein Bericht „hier und jetzt“ benötigt, und jede Minute, die für seine Entstehung aufgewendet wurde, erwies sich als kritisch.  Die Experimente mit den Umgebungseinstellungen wurden abgebrochen, am Hinterkopf zerkratzt und mit der Optimierung des Codes begonnen. <br><br><h3>  Suche nach einer Lösung </h3><br>  Als erstes wurde das Berichtsskript in den Hintergrundprozess gestellt und der Benutzer überwacht den Fortschritt über den "Fortschrittsbalken".  Die Ausführung von Hintergrundjobs wurde über den Warteschlangenmechanismus unter Verwendung von Redis als Speicher implementiert.  Die Arbeit im System wird nicht unterbrochen. Sie können andere Aufgaben ausführen und regelmäßig zur Berichtsseite zurückkehren, um festzustellen, ob die Datei bereit ist.  Sobald die Datei erstellt wurde, wird dem Benutzer ein Download-Link angeboten.  Wie oben erwähnt, war die Datei jedoch manchmal "sofort" erforderlich, und eine zunehmende Benutzerfreundlichkeit löste dieses Problem nicht.  In der Zwischenzeit wuchs die Datenmenge weiter und die Zeit, die zum Erstellen der Datei benötigt wurde, erreichte 79 Minuten!  Dies ist völlig inakzeptabel, insbesondere angesichts der Tatsache, dass die Berichterstellung eine der Grundlagen für die Funktionalität dieses Systems darstellt.  Nein, alle anderen Teile funktionierten wie am Schnürchen, aber diese Fliege in der Salbe verdarb den Gesamteindruck. <br><br><h3>  Erste Ergebnisse </h3><br>  Wir setzten uns wieder zur Code-Analyse.  Als erstes wurde die Auswahl von Daten aus der Datenbank getestet.  Die Abfragen wurden jedoch bereits maximal optimiert.  Obwohl die längste Anfrage eine schreckliche Stichprobe mit fünf oder sechs Anrufen beim monströsen FIAS war, funktionierte sie in 2-5 Sekunden.  Die Schwachstelle war nicht er, sondern die Bildung der Datei "exelnik".  Versuche haben begonnen, diesen Prozess zu optimieren.  Angefangen beim Zwischenspeichern in Redis bis hin zu Perversionen wie der Bildung separater kleiner "Excels" in parallelen Streams, gefolgt vom Einfügen in eine Datei.  Das Ergebnis war jedoch immer das gleiche: Das Problem im Laufe der Zeit wurde zu einem Problem mit dem Speicher und umgekehrt.  Es gab keinen Mittelweg, der nur von einem Extrem zum anderen floss.  Nach einer bestimmten Datenmenge begann der Ressourcenverbrauch der Bibliothek exponentiell zu wachsen und es war nicht möglich, ihn zu besiegen.  PhpSpreadsheet - nicht für große Dateien geeignet.  Infolgedessen wurde beschlossen, die Bibliothek zu ändern.  Als Option - Schreiben Sie Ihr eigenes Analogon für die Bildung von Ex-Dateien. <br><br><h3>  Analyse und Werkzeugauswahl </h3><br>  Sie beeilten sich nicht, Fahrräder zu schreiben, sondern analysierten zunächst vorhandene Lösungen.  Von den möglichen Optionen war nur die Box / der Auslauf von Interesse.  Schreiben Sie das Modul mithilfe dieser Bibliothek schnell neu.  Als Ergebnis wurde ein vollständiger Bericht in 145 Sekunden erhalten.  Ich möchte Sie daran erinnern, dass die neuesten Tests mit PhpSpreadsheet 79 Minuten und hier 2,5 Minuten dauern!  Durchgeführte Tests: Die Datenmenge wurde um das Zweifache erhöht.  Der Bericht wurde in 172 Sekunden erstellt.  Der Unterschied ist erstaunlich.  Natürlich hat die Bibliothek nicht alle Funktionen wie PhpSpreadsheet, aber in diesem Fall reicht der Mindestsatz an Werkzeugen aus, da die Geschwindigkeit entscheidend ist. <br><br><h3>  Erweiterung für Yii2 </h3><br>  Die endgültige Entscheidung wurde als Erweiterung für Yii2 festgelegt.  Vielleicht wird jemand nützlich sein.  Mit der Erweiterung können Sie jedes Dataset aus GridView hochladen, um eine hervorragende Leistung zu erzielen, während Sie das Filtern und Sortieren beibehalten.  Es verwendet yii / queue und box / spout als Abhängigkeiten.  Es ist sinnvoll, die Erweiterung zu verwenden, um wirklich große Dateien zu erstellen, also mindestens 50.000 Zeilen =) Derzeit ist das Modul, das die Grundlage für die Erweiterung geworden ist, mit einer Last von fast 600.000 Zeilen bekannt. <br><br>  Link zu github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Yii2 ExcelReport-Erweiterung</a> <br><br>  Vielen Dank für Ihre Aufmerksamkeit! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de420393/">https://habr.com/ru/post/de420393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de420383/index.html">"Yandex.Money interessiert Sie nicht für die Eingabe Ihrer Bewerbung."</a></li>
<li><a href="../de420385/index.html">Containerbasierte Integrationstests</a></li>
<li><a href="../de420387/index.html">Drei intelligente Zauberwürfel: Xiaomi, Roobo und GoCube</a></li>
<li><a href="../de420389/index.html">Implementierung des "Observer-Subscriber" -Musters mithilfe von JNI-Rückrufen in Android (NDK)</a></li>
<li><a href="../de420391/index.html">IT-Gehälter Mitte 2018</a></li>
<li><a href="../de420395/index.html">"Kostenlose" Tabletten für Gefangene - überhaupt nicht kostenlos</a></li>
<li><a href="../de420397/index.html">Wissenschaftler haben einen Weg gefunden, den Alterungsprozess von Zellen umzukehren</a></li>
<li><a href="../de420405/index.html">Untersuchung des IT-Verkaufsprozesses</a></li>
<li><a href="../de420407/index.html">C ist keine einfache Sprache</a></li>
<li><a href="../de420409/index.html">Lerne OpenGL. Lektion 5.7 - HDR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>