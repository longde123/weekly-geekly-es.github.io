<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜé üë®‚Äçüë®‚Äçüë¶ üë© ToFoIn v 1. R√©servation de passerelles et commutation entre canaux externes dans FreeBSD üßíüèΩ üèîÔ∏è üë©üèø‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Annotation 
 Dans un article pr√©c√©dent, l'organisation de la redondance des passerelles LAN a √©t√© envisag√©e. Comme solution, un script a √©t√© propos√© q...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ToFoIn v 1. R√©servation de passerelles et commutation entre canaux externes dans FreeBSD</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421857/"><h3>  Annotation </h3><br>  Dans un article pr√©c√©dent, l'organisation de la redondance des passerelles LAN a √©t√© envisag√©e.  Comme solution, un script a √©t√© propos√© qui √† l'√©poque r√©solvait le probl√®me, mais pr√©sentait un certain nombre d'inconv√©nients.  Apr√®s un certain temps, il s'est av√©r√© √©liminer ces lacunes, r√©√©crire partiellement le code et obtenir quelque chose d'acceptable √† la sortie.  Maintenant, nous pouvons dire que les scripts sont suffisamment test√©s pour √™tre appel√©s stables.  Pour simplifier la compr√©hension de l'ensemble du syst√®me, les principaux points de mise en place des services secondaires (en termes de sujet de l'article) seront partiellement reproduits ci-dessous.  La raison est simple - pendant ce temps, les r√®gles ipfw ont √©galement √©t√© retravaill√©es, dns est all√© vivre dans AD sur Samba4 avec un bind-frontend et des enregistrements mis √† jour en toute s√©curit√© depuis isc-dhcpd en utilisant kerberos, ainsi que des serveurs DNS secondaires comme bind sur les passerelles, CARP configur√© ... En g√©n√©ral, il est devenu beaucoup plus int√©ressant, mais en savoir plus sur quoi et comment cela fonctionne est ci-dessous.  Tout ce qui peut √™tre donn√© avec des r√©f√©rences √† la source sera con√ßu de mani√®re √† ne pas produire d'essence.  Ce qui a √©t√© pris ailleurs, mais qui n'est plus disponible, sera donn√© ici avec les commentaires pertinents. <br><a name="habracut"></a><br><h3>  Pr√©sentation </h3><br>  Ainsi, il existe deux mani√®res d'augmenter l'immunit√© au bruit du canal de communication avec le monde ext√©rieur de la part du consommateur: sauvegarde de la passerelle et r√©servation du point de connexion.  En d'autres termes, dans le premier cas, une deuxi√®me passerelle est mise en place, qui sera activ√©e si la premi√®re √©choue, dans le second cas, un canal Internet de secours sera organis√© en cas de probl√®me avec le principal, et plus ils traversent, mieux c'est, √©videmment.  Si <abbr title="Protocole de redondance d'adresses commun">CARP</abbr> r√©sout la premi√®re t√¢che pour FreeBSD, alors la seconde, apr√®s avoir organis√© le deuxi√®me canal externe, peut, encore une fois, √™tre r√©solue de plusieurs mani√®res.  Au minimum, vous pouvez organiser l'√©quilibrage du trafic ou la commutation entre les canaux.  En raison de la grande diff√©rence dans la bande passante des canaux externes, la premi√®re option ne me <abbr title="Basculement de Google sur Internet">convenait</abbr> pas, donc le principal coupable de la publication a √©t√© √©crit: <abbr title="Basculement de Google sur Internet">ToFoIn</abbr> - un ensemble de scripts bash qui vise √† r√©soudre les probl√®mes de diagnostic et √† passer √† un canal externe fonctionnel.  Apr√®s raffinement, il peut √™tre appliqu√© √† n passerelles et m canaux.  La situation est faible, o√π n et m sont sup√©rieurs √† 2, mais les scripts ci-dessous devraient fonctionner jusqu'√† de grandes valeurs de n et m, car  Logiquement, la limite n'est pas fix√©e.  En g√©n√©ral, je soup√ßonne qu'en utilisant ces scripts, il est possible de r√©soudre un √©ventail assez large de t√¢ches, selon l'√©tat de la connexion, limit√©, peut-√™tre, uniquement par l'imagination. <br><br><img src="https://habrastorage.org/webt/2e/yw/s8/2eyws8o9hbu3cxfpo0yja6dm_ea.png" width="500" align="left"><br>  Une telle topologie r√©seau suppose approximativement sous la forme la plus simple l'utilisation d'un ensemble de scripts ToFoIn.  Bien s√ªr, les scripts devraient fonctionner dans le cas d'un seul routeur, mais dans ce cas, vous devrez changer le module Daemon pour supprimer la d√©pendance de la s√©quence d'actions sur l'√©tat CARP, qui sera simplement absent dans le syst√®me.  La r√©servation ult√©rieure de ces n≈ìuds et d'autres ne d√©pend que du degr√© d'importance des services correspondants. <br><br><h3>  Buts et objectifs </h3><br>  L'objectif du projet, comme pr√©c√©demment, est de cr√©er un progiciel universel et facilement √©volutif ax√© sur l'identification des probl√®mes dans les connexions externes et internes et le passage automatique √† des connexions exploitables.  En termes g√©n√©raux, la logique est la suivante: <br><br><ul><li>  Il y a n ¬´routeurs¬ª avec m canaux externes sur chacun.  De plus, tous les n ¬´routeurs¬ª sont dans une hi√©rarchie stricte et sont connect√©s les uns aux autres en utilisant CARP sur toutes les interfaces n√©cessaires. </li><li>  Un agent travaille ind√©pendamment sur chaque machine, dont la t√¢che est bas√©e sur le statut CARP actuel de sa machine: <br><ul><li>  Si sauvegarde - d√©tectez et configurez la machine sur un routeur qui est actuellement le ma√Ætre; </li><li>  Si ma√Ætre - v√©rifiez l'√©tat des connexions au moment actuel et, si n√©cessaire, basculez entre les canaux externes. </li></ul></li></ul><br><h3>  Solution </h3><br>  Le r√©seau interne dispose de CARP, qui fournit des passerelles de sauvegarde et vous permet de ne pas modifier les param√®tres des autres p√©riph√©riques r√©seau sur le r√©seau interne lors du changement de canal. <br><br>  Dhcpd fonctionne en mode primaire-secondaire et, en g√©n√©ral, peu importe les autres r√¥les jou√©s par sa machine - la connexion entre dhcpd se produit sur le r√©seau interne, que les routeurs regardent toujours. <br><br>  La liaison principale est supprim√©e dans AD, qui est masqu√©e dans le r√©seau local, tandis que les serveurs de liaison secondaires travaillent sur les routeurs de la passerelle sur un pied d'√©galit√©. <br><br>  Les r√®gles ipfw diff√®rent selon le canal consid√©r√© comme le canal principal √† un moment donn√© et sont red√©marr√©es par le module Daemon lors du changement de r√¥le. <br><br>  Enfin sur les scripts eux-m√™mes.  Maintenant, les fichiers sont situ√©s dans les r√©pertoires appropri√©s, fonctionnent √† partir de leur utilisateur et ont un script de d√©marrage dans rc.d.  Les t√¢ches qui n√©cessitent un acc√®s root sont r√©solues par sudo.  Il existe un script d'installation qui prend en compte la pr√©sence √©ventuelle d'une version install√©e, ainsi qu'un fichier de param√®tres assez d√©taill√©.  Les modules sont les m√™mes avec des changements mineurs, certains n'ont presque pas chang√© de fonctionnalit√©: <br><br>  <b>Le d√©mon</b> - comme son nom l'indique - est le processus principal qui ex√©cute les modules de test et de commutation sur une minuterie, et surveille √©galement CARP. <br>  <b>Testeur</b> - teste toujours les communications externes √† l'aide de la commande ping.  (s'il est en marche, il consid√®re que la machine a CARP √† l'√©tat ma√Ætre) <br>  <b>Juge</b> - sur la base des r√©sultats du test, d√©termine quel canal externe fonctionne et si la commutation est n√©cessaire, effectue la commutation (s'il est en cours d'ex√©cution, il consid√®re que la machine a CARP √† l'√©tat ma√Ætre). <br>  <b>Scout</b> est un nouveau module.  Il d√©marre lorsque CARP est en √©tat de sauvegarde.  Il est n√©cessaire de d√©terminer lequel des routeurs restants est actuellement le principal. <br>  <b>Logger</b> - responsable de la journalisation des √©v√©nements.  Il est n√©cessaire pour que les informations sur les √©v√©nements ne soient pas dupliqu√©es et que le magazine soit plus facile √† lire. <br>  <b>Watchdog</b> - fonctionne selon le calendrier de crontab.  Il d√©termine les ¬´gels¬ª de tous les modules et (dans la mesure du possible) essaie de r√©soudre les probl√®mes qui se sont pos√©s.  C'est-√†-dire  clouer tout le monde, tout simplement. <br><br>  En plus des scripts eux-m√™mes, il convient de consid√©rer certains fichiers plus importants: <br><br>  <b>Tofoin.conf</b> - un seul fichier de param√®tres. <br>  <b>Tofoin.log</b> - un seul fichier journal des √©v√©nements. <br>  <b>Result_</b> &lt;num√©ro de canal interne&gt; est le fichier de travail, les r√©sultats des tests sont ajout√©s ici, cr√©√©s dans / tmp √† c√¥t√© de .pid et d'autres fichiers de travail. <br><br>  Je peux volontiers r√©pondre aux questions concernant le fonctionnement des modules, en expliquant les solutions dans les commentaires. <br><br><h3>  Partie technique </h3><br><h4>  √âquipement </h4><br>  Par rapport √† la p√©riode pr√©c√©dente, les passerelles sont pass√©es √† P4, ont re√ßu 1536 Mo de RAM et trois disques durs de 40 Go (miroir + disque de rechange).  Les cartes r√©seau sont toujours PCI, les PSU sont normales, naturellement en pr√©sence d'un onduleur. <br>  L'augmentation de la capacit√© est associ√©e au fer lib√©r√© et √† la mise √† jour trop fastidieuse de la source, mais surtout la premi√®re.  OS FreeBSD 11.1, FS zfs. <br><br><h4>  Param√®tres des composants du syst√®me </h4><br><div class="spoiler">  <b class="spoiler_title">Plus de d√©tails</b> <div class="spoiler_text">  Le noyau est compil√© avec de tels param√®tres suppl√©mentaires (quelque chose peut √©galement √™tre d√©fini dans le chargeur, mais c'est mieux de cette fa√ßon): <br><br><pre><code class="bash hljs">options IPFIREWALL <span class="hljs-comment"><span class="hljs-comment"># ipfw firewall options IPFIREWALL_VERBOSE options IPFIREWALL_VERBOSE_LIMIT=50 options IPFIREWALL_NAT options LIBALIAS options DUMMYNET options HZ=1000 options ROUTETABLES=4 options KSTACK_PAGES=4 options KVA_PAGES=512 device carp</span></span></code> </pre> <br>  Param√®tres /boot/loader.conf: <br><pre> <code class="bash hljs">geom_mirror_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> zfs_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> kern.geom.label.gptid.enable=<span class="hljs-string"><span class="hljs-string">"0"</span></span> vm.kmem_size=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vm.kmem_size_max=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vfs.zfs.arc_max=<span class="hljs-string"><span class="hljs-string">"512M"</span></span> vfs.zfs.vdev.cache.size=<span class="hljs-string"><span class="hljs-string">"30M"</span></span> vfs.zfs.prefetch_disable=1 kern.vty=vt</code> </pre> <br>  Param√®tres /etc/rc.conf sur la premi√®re machine (la configuration CARP est d'un int√©r√™t majeur): <br><pre> <code class="bash hljs">ifconfig_eth0=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth0=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan222"</span></span> create_args_vlan111=<span class="hljs-string"><span class="hljs-string">"vlan 111"</span></span> create_args_vlan222=<span class="hljs-string"><span class="hljs-string">"vlan 222"</span></span> ifconfig_eth1=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth1=<span class="hljs-string"><span class="hljs-string">"vlan333 vlan444 vlan555"</span></span> create_args_vlan333=<span class="hljs-string"><span class="hljs-string">"vlan 333"</span></span> create_args_vlan444=<span class="hljs-string"><span class="hljs-string">"vlan 444"</span></span> create_args_vlan555=<span class="hljs-string"><span class="hljs-string">"vlan 555"</span></span> ifconfig_eth2=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth2=<span class="hljs-string"><span class="hljs-string">"vlan666 vlan777 vlan888"</span></span> create_args_vlan666=<span class="hljs-string"><span class="hljs-string">"vlan 666"</span></span> create_args_vlan777=<span class="hljs-string"><span class="hljs-string">"vlan 777"</span></span> create_args_vlan888=<span class="hljs-string"><span class="hljs-string">"vlan 888"</span></span> ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.1/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.1/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.1/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.1/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.1/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.1/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.1/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.1/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span> zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> named_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> dhcpd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_logging=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_script=<span class="hljs-string"><span class="hljs-string">"/etc/firewall.sh"</span></span> gateway_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> tofoin_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre> <br>  <i>L√©gende:</i> <i><br></i>  <i>eth0, eth1, eth2 - adaptateurs physiques</i> <i><br></i>  <i>vlan666, vlan777, vlan888 - adaptateurs LAN virtuels,</i> <i><br></i>  <i>vlan222 et vlan555 - adaptateurs pour la communication redondante entre les cartes r√©seau externes (ils peuvent ne plus √™tre n√©cessaires, ils ont √©t√© activement utilis√©s plus t√¥t)</i> <i><br></i>  <i>vlan111 - le canal externe principal</i> <i><br></i>  <i>vlan444 - canal externe de sauvegarde</i> <i><br></i>  <i>vlan333 - t√©l√©phonie</i> <br>  Param√®tres /etc/rc.conf sur la deuxi√®me machine (la configuration CARP est d'un int√©r√™t majeur, certaines des lignes en double sont supprim√©es): <br><pre> <code class="bash hljs">ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.2/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.2/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.2/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.2/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.2/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.2/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.2/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.2/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span></code> </pre> <br>  Certaines r√®gles utiles lors de la configuration d'ipfw (nat) sont: <br>  Pour autoriser le trafic CARP: <br><pre> <code class="bash hljs">/sbin/ipfw -q add allow carp from any to any</code> </pre> <br>  Nat "Nucl√©aire": <br><pre> <code class="bash hljs">/sbin/ipfw -q nat 1 config <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ip vlan111 reset same_ports deny_in unreg_only /sbin/ipfw -q add nat 1 ip from any to any <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre> <br>  Utilisation de tables de routage sp√©cifiques avec des adaptateurs sp√©cifiques: <br><pre> <code class="bash hljs">/sbin/ipfw -q add setfib 0 all from any to any via vlan666</code> </pre> <br>  En g√©n√©ral, je pourrais √©crire un article s√©par√© sur les param√®tres ipfw que j'ai utilis√©s, mais c'est une autre fois. <br></div></div><br><h4>  Logiciels tiers </h4><br><div class="spoiler">  <b class="spoiler_title">Plus de d√©tails</b> <div class="spoiler_text">  Comme il est n√©cessaire de travailler simultan√©ment avec deux canaux externes ou plus, il est pratique d'avoir plusieurs tables de routage, une pour chaque canal.  Et ce serait bien si ces tables √©taient cr√©√©es au d√©marrage elles-m√™mes.  Le script rc.d setfib vous aidera.  La logique utilis√©e dans ToFoIn suppose que le nom de fichier (setfib1, setfib2, etc.) correspond au num√©ro de la table dans laquelle un seul script ajoute une route par d√©faut.  Par d√©faut, la table porte le num√©ro "0". <br>  Les serveurs DNS avec Bind dans le r√¥le principal fonctionnent en mode secondaire, le principal est samba4 + bind, cach√© dans le r√©seau local.  La configuration de la liaison secondaire est magnifiquement r√©v√©l√©e dans le livre "DNS and BIND" de Cricket Lee et Paul Albitz.  Je ne me souviens pas d'exigences particuli√®res qui prennent en compte l'utilisation de samba4 pour les serveurs secondaires, et je ne les mentionne pas dans le fichier de param√®tres.  Sauf si, pour diff√©rents canaux Internet, vous devrez peut-√™tre cr√©er 2 fichiers diff√©rents, qui seront ensuite copi√©s par le script ToFoIn √† l'endroit o√π bind les lira.  Cela est d√ª au fait que lors de la sp√©cification des adresses des serveurs DNS des deux fournisseurs dans le m√™me fichier, compte tenu du fait que la liaison fonctionne avec une seule table de routage, un probl√®me se pose concernant la r√©solution des adresses des serveurs en amont qui sont inaccessibles √† un certain moment. <br>  Basculement isc-dhcpd.  Dhcpd n'est pas essentiel pour ToFoIn, de plus, son absence n'affectera pas du tout les scripts, cependant, comme il me semble, il est tout √† fait logique de placer des serveurs dhcp sur des passerelles et la question de basculement se pose toujours.  Et ici, par rapport √† la derni√®re fois, c'est devenu plus int√©ressant ... En plus des r√©glages n√©cessaires au basculement, que j'ai d√©crits la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">derni√®re fois</a> (d√©but de la section "preset" dans le menu d√©roulant). <br>  Vous aurez √©galement besoin d'un script pour mettre √† jour en toute s√©curit√© les enregistrements DNS dans AD √† l'aide de samba4.  Le serveur samba4 lui-m√™me devrait juste √™tre install√©.  La configuration et le lancement ne sont pas n√©cessaires, nous ne sommes int√©ress√©s que par les outils de gestion fournis avec le kit.  Ceux qui le souhaitent peuvent trouver d'autres informations dans la section "DHCP avec mises <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√†</a> jour DNS dynamiques" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur</a> . <br>  √áa a l'air effrayant, mais √ßa marche. <br>  √Ä ce sujet, la configuration du logiciel tiers est termin√©e. <br></div></div><br><h4>  Un peu sur ToFoIn </h4><br>  Tout le texte du projet ainsi que le script d'installation sont disponibles sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">gitlab</a> . <br><br><div class="spoiler">  <b class="spoiler_title">En conclusion, un exemple de param√®tres du fichier de param√®tres ToFoIn est consid√©r√©:</b> <div class="spoiler_text">  Le nombre de routeurs utilis√©s dans le syst√®me: <br><pre> <code class="bash hljs">RNUMBER=2</code> </pre> <br>  Lorsque vous utilisez des sous-r√©seaux suppl√©mentaires, vous devez d√©finir un itin√©raire par d√©faut lorsque le routeur devient le principal.  Ici, vous pouvez sp√©cifier le num√©ro du fichier setfib correspondant qui sera red√©marr√©.  Dans cet exemple, setfib2: <br><pre> <code class="bash hljs">ADDITLAN=2</code> </pre> <br>  Nom de l'adaptateur interne: <br><pre> <code class="bash hljs">INT_IF=vlan666</code> </pre> <br>  Toutes les autres interfaces sur lesquelles les routeurs sont connect√©s via CARP.  Obligatoire pour contr√¥ler et maintenir le m√™me √©tat de toutes les interfaces: <br><pre> <code class="bash hljs">ALL_IF=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan333 vlan444 vlan666 vlan777 vlan888"</span></span></code> </pre> <br>  vhid utilis√© lors de la configuration de CARP: <br><pre> <code class="bash hljs">CARP_VHID=1</code> </pre> <br>  Les adresses IP dans le r√©seau interne des autres routeurs par ordre d'importance, si n√©cessaire, puis ASERV_IP_2, ASERV_IP_3, etc. sont simplement utilis√©es. <br><pre> <code class="bash hljs">ASERV_IP_1=192.168.0.2</code> </pre> <br>  Nombre de canaux de connexion externes: <br><pre> <code class="bash hljs">CNUMBER=2</code> </pre> <br>  Param√®tres du canal de connexion externe principal: <br>  Nom de l'adaptateur: <br><pre> <code class="bash hljs">EXT_0_IF=vlan111</code> </pre> <br>  Num√©ro de table de routage: <br><pre> <code class="bash hljs">RTABLE_0=0</code> </pre> <br>  Passerelle par d√©faut: <br><pre> <code class="bash hljs">DEFAULT_GATEWAY=2.2.2.1</code> </pre> <br>  Param√®tres du canal de connexion externe de sauvegarde: <br>  Nom de l'adaptateur: <br><pre> <code class="bash hljs">EXT_1_IF=vlan444</code> </pre> <br>  Num√©ro de table de routage: <br><pre> <code class="bash hljs">RTABLE_1=1</code> </pre> <br>  Une passerelle par d√©faut n'est pas requise, car pour toutes les tables de routage, √† l'exception de la table principale, le script rc.d setfib &lt;num√©ro de table&gt; est utilis√©, ce qui, comme la logique le suppose, doit correspondre au num√©ro de table. <br>  Param√®tres du module de testeur: <br>  Le nombre d'adresses √† v√©rifier: <br><pre> <code class="bash hljs">TNUMBER=2</code> </pre> <br>  Adresses des machines par lesquelles les requ√™tes ping sont envoy√©es.  Il est pr√©f√©rable d'utiliser le nom de domaine dans le premier cas, et seulement apr√®s cela l'adresse IP: <br><pre> <code class="bash hljs">PTARGET_0=ya.ru PTARGET_1=8.8.8.8</code> </pre> <br>  Le nombre de paquets ping envoy√©s par cible: <br><pre> <code class="bash hljs">PNUMBER=2</code> </pre> <br>  Param√®tres du module de juge <br>  Le nombre de tests r√©ussis de la cha√Æne principale avant d'y revenir.  Le temps de retour vers le canal principal apr√®s la reprise de son fonctionnement est approximativement calcul√© par la formule: (WNUMBER + 1) * SECOND JUGEPERIOD secondes. <br><pre> <code class="bash hljs">WNUMBER=3</code> </pre> <br>  Param√®tres du module d'enregistreur <br>  Ces 2 param√®tres indiquent la fr√©quence √† laquelle l'enregistreur enregistrera les √©v√©nements r√©currents.  Apr√®s l'enregistrement de l'√©v√©nement, la prochaine fois que LOGFREQ1 indique le nombre de tentatives, LOGFREQ2 correspond au nombre de tentatives.  Seuls les √©v√©nements cons√©cutifs sont pris en compte. <br><pre> <code class="bash hljs">LOGFREQ1=5 LOGFREQ2=20</code> </pre> <br>  Minuteries de d√©marrage du module en quelques secondes <br>  La p√©riode de lancement du module Tester.  Il est logique de s'appuyer sur le temps des tentatives infructueuses pour tester toutes les cibles. <br><pre> <code class="bash hljs">TESTERPERIOD=240</code> </pre> <br>  La p√©riode de lancement du module Juge.  N'installez pas moins de TESTERPERIOD. <br><pre> <code class="bash hljs">JUDGEPERIOD=300</code> </pre> <br>  La p√©riode de lancement du module Scout. <br><pre> <code class="bash hljs">SCOUTPERIOD=360</code> </pre> <br>  La p√©riode d'attente avant de v√©rifier les temporisateurs de d√©marrage des modules Testeur et Juge.  Il est logique de d√©finir une valeur inf√©rieure ou √©gale √† la valeur de TESTERPERIOD. <br><pre> <code class="bash hljs">SENSITIVITY=60</code> </pre> <br>  D√©lai apr√®s lequel un module de travail est consid√©r√© comme suspendu.  Utilis√© par le module Watchdog. <br><pre> <code class="bash hljs">TESTERLIMIT=40 JUDGELIMIT=30 LOGGERLIMIT=20 SCOUTLIMIT=120 WATCHDOGLIMIT=150</code> </pre> <br>  Chemins d'acc√®s aux fichiers et r√©pertoires <br>  Chemin vers le script ipfw. <br><pre> <code class="bash hljs">FIRESCRIPT=/etc/firewall.sh</code> </pre> <br>  Param√®tres IPFW.  Si les param√®tres ipfw ne sont pas d√©plac√©s vers un fichier s√©par√©, alors FIRESCRIPT = FIRESETDEF. <br><pre> <code class="bash hljs">FIRESETDEF=/etc/firewall/config</code> </pre> <br>  Chemin d'acc√®s aux param√®tres ipfw pour le canal externe principal: <br><pre> <code class="bash hljs">FIRESET_0=/etc/firewall/config_0</code> </pre> <br>  Le chemin d'acc√®s aux param√®tres ipfw pour le canal externe de sauvegarde, si n√©cessaire, vous pouvez continuer FIRESET_2, etc.: <br><pre> <code class="bash hljs">FIRESET_1=/etc/firewall/config_1</code> </pre> <br>  Chemins pour lier les param√®tres <br><pre> <code class="bash hljs">BINDSETDEF=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf</code> </pre> <br>  Param√®tres de liaison pour le canal externe principal: <br><pre> <code class="bash hljs">BINDSET_0=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.0</code> </pre> <br>  Liez les param√®tres du canal externe de sauvegarde, si n√©cessaire, vous pouvez continuer BINDSET_2, etc.: <br><pre> <code class="bash hljs">BINDSET_1=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.1</code> </pre> <br>  Chemins d'acc√®s √† tous les ex√©cutables ToFoIn: <br><pre> <code class="bash hljs">DAEMON=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/daemon.sh TESTER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/tester.sh JUDGE=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/judge.sh LOGGER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/logger.sh SCOUT=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/scout.sh WATCHDOG=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/watchdog.sh</code> </pre> <br>  Journal des √©v√©nements.  Ce fichier n'est PAS cr√©√© √† l'installation maintenant: <br><pre> <code class="bash hljs">LOGFILE=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/tofoin.log</code> </pre> <br>  Les fichiers et r√©pertoires temporaires sont cr√©√©s au d√©marrage des modules correspondants, certains sont supprim√©s √† l'arr√™t: <br><pre> <code class="bash hljs">DIR_TMP=/tmp/tofoin DIR_PID=/var/run/tofoin JUDGEMETER=/tmp/tofoin/judgemeter PREVSTATE=/tmp/tofoin/prevstate SCOUTGATE=/tmp/tofoin/scoutgate LOGTMP=/tmp/tofoin/logger.tmp LOGMETER=/tmp/tofoin/logmeter DAEMON_PID=/var/run/tofoin/daemon.pid TESTER_PID=/var/run/tofoin SCOUT_PID=/var/run/tofoin/scout.pid JUDGE_PID=/var/run/tofoin/judge.pid LOGGER_PID=/var/run/tofoin/logger.pid WATCHDOG_PID=/var/run/tofoin_watchdog.pid</code> </pre> <br></div></div><br><h3>  R√©sum√© </h3><br>  Il s'est av√©r√© √™tre un ensemble de scripts enti√®rement fonctionnel et fiable qui r√©pond bien √† la t√¢che de basculer vers le canal de travail dans le cas de 2 routeurs avec 2 canaux de communication externes. <br><br><h3>  Plans </h3><br>  Mes plans pour ce projet concernent, peut-√™tre, la r√©√©criture de bash en pure sh pour se d√©barrasser des logiciels inutiles sur le serveur.  D'un autre c√¥t√©, maintenant tout fonctionne √† merveille et je n'ai vraiment pas envie d'interf√©rer dans ce processus, en plus, passer √† sh est lourd de constructions de langage plus terribles n√©cessaires pour obtenir le m√™me r√©sultat. <br>  Pour le reste, probablement, il vaudrait la peine d'envisager la meilleure impl√©mentation des modules de test. <br><br><h3>  R√©f√©rences: </h3><br>  ‚Üê <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Article pr√©c√©dent</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Page du projet ToFoIn sur gitlab</a> <br><div class="spoiler">  <b class="spoiler_title">Le reste</b> <div class="spoiler_text">  DNS BIND 9: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lee K., Albitz P. - DNS et BIND (5e √©dition)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Serveur DNS BIND</a> <br>  DHCP: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DHCP de basculement</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DHCP avec mises √† jour DNS dynamiques</a> <br>  <a href="">samba-dnsupdate</a> <br>  SETFIB: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Plusieurs routes par d√©faut dans FreeBSD sans BGP ou similaire</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">setfib et basculement entre les tables de routage</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FreeBSD deux fournisseurs.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">setfib</a> <br>  IPFW + NAT: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Manuel d√©taill√© ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FreeBSD 9 + ipfw + ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Manuel d√©taill√© ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dummynet</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NAT du noyau</a> <br>  BASH: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bases de BASH.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2e partie</a> <br>  <a href="">Guide avanc√© de Bash-Scripting</a> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr421857/">https://habr.com/ru/post/fr421857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr421845/index.html">Que font r√©ellement les analystes de donn√©es? R√©sultats de 35 entretiens</a></li>
<li><a href="../fr421847/index.html">Sautez dans le cloud. Cr√©ation d'une solution IoT √©conomique sur NodeMCU + Azure IoT Hub</a></li>
<li><a href="../fr421849/index.html">Ev√©nements RH en TI en septembre 2018: My Circle Digest</a></li>
<li><a href="../fr421851/index.html">Probl√®mes de hibou et de globe: connexion de deux assemblys avec des espaces de noms et des noms de classe identiques</a></li>
<li><a href="../fr421855/index.html">Projecteurs √† domicile: les meilleurs ¬´selon la version¬ª, mise au point ultra courte, champions de la luminosit√© et de la vitesse</a></li>
<li><a href="../fr421859/index.html">Notes du fournisseur IoT. Appareils et surench√©rir</a></li>
<li><a href="../fr421863/index.html">Une nouvelle fa√ßon de cr√©er des nanotubes: d√©sormais en couleur</a></li>
<li><a href="../fr421867/index.html">Comment rendre le code lisible</a></li>
<li><a href="../fr421869/index.html">Cr√©ez une application Android pour la d√©tection de visage en temps r√©el √† l'aide du kit Firebase ML</a></li>
<li><a href="../fr421871/index.html">Comment √©chouer lamentablement de la migration Java vers Kotlin dans une application Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>