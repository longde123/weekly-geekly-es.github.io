<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçÄ üò£ üêÅ Sistema de prote√ß√£o contra vazamentos para uma m√°quina de lavar üì° üõ†Ô∏è ‚òπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Introdu√ß√£o 
 Eu acho que toda casa tem uma m√°quina de lavar. Normalmente, ele √© conectado ao abastecimento de √°gua atrav√©s de uma mangueira flex√≠ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sistema de prote√ß√£o contra vazamentos para uma m√°quina de lavar</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472296/"><img src="https://habrastorage.org/webt/7q/2r/xp/7q2rxpr6f9jntwgc-3ai-qwqglo.jpeg"><br><br><h2>  1. Introdu√ß√£o </h2><br>  Eu acho que toda casa tem uma m√°quina de lavar.  Normalmente, ele √© conectado ao abastecimento de √°gua atrav√©s de uma mangueira flex√≠vel.  Mas um grande inc√¥modo pode acontecer com uma mangueira: √†s vezes elas explodem, o que levar√° a uma inunda√ß√£o no seu apartamento e nos vizinhos.  Portanto, as m√°quinas de lavar s√£o conectadas ao abastecimento de √°gua atrav√©s de uma torneira especial, que deve ser aberta antes da lavagem e fechada depois.  N√£o conhe√ßo voc√™, mas tenho este guindaste em um local extremamente inconveniente.  Sim, e prefiro come√ßar a lavar antes de sair para o trabalho, para que a maior parte do dia a mangueira fique sob press√£o e possa estourar no momento em que n√£o estou em casa.  Seria √≥timo se o guindaste se abrir e se fechar na hora certa! <br><br>  A ideia me pareceu bastante capaz e resolvi implement√°-la: em microcontroladores e com v√°lvula motorizada. <br><a name="habracut"></a><br>  Para come√ßar, formulei os requisitos para o sistema desenvolvido: <br><br><ul><li>  monitorar o estado da m√°quina de lavar: abrir √°gua no in√≠cio da lavagem e fechar no final; </li><li>  a capacidade de controlar manualmente a v√°lvula; </li><li>  opera√ß√£o da bateria e fechamento da v√°lvula em caso de descarga da bateria; </li><li>  presen√ßa de um sensor de vazamento: feche a v√°lvula caso seja detectado vazamento. </li></ul><br>  Em seguida, ele descobriu em que partes ele ser√° composto: um monitor instalado na m√°quina de lavar e um controlador que recebe sinais do monitor e controla uma v√°lvula motorizada.  A comunica√ß√£o entre o monitor e o controlador √© via um canal de r√°dio unidirecional. <br><br>  Parece que isso √© suficiente para a tarefa t√©cnica.  Vamos come√ßar! <br><br><h2>  Sele√ß√£o MCU </h2><br>  Como todo o sistema consiste em dois dispositivos, deve haver dois microcontroladores.  Raspei as tripas e encontrei dois Atmega8: um no pacote DIP e outro no TQFP.  O do DIP - foi para o monitor e o TQFP - para o controlador.  Mais tarde, constatou-se que o firmware do controlador coberto de vegeta√ß√£o n√£o se encaixa mais no 8KB Atmega8, ent√£o tive que atualizar para o Atmega328 - um anal√≥gico completo, mas agora h√° quatro vezes mais mem√≥ria para o programa. <br>  A prop√≥sito, um dos meus motivos para realizar esses projetos √© o descarte de lixo eletr√¥nico, que acumulei ao longo de muitos anos.  √â verdade que, no final do projeto, o lixo n√£o se torna menor.  Fica ainda maior! <br><br><h2>  Parte I  Monitor </h2><br><h3>  Intera√ß√£o com uma m√°quina de lavar </h3><br>  O primeiro problema: como determinar o que a m√°quina de lavar est√° fazendo agora?  No in√≠cio do projeto, essa parte da tarefa parecia muito simples para mim.  Tudo o que precisava ser feito era determinar os momentos do in√≠cio e do fim da lavagem.  No painel frontal da m√°quina, h√° um LED que acende e apaga quando necess√°rio.  Eu esperava soldar um GPIO nele com o p√© do microcontrolador; portanto, durante a depura√ß√£o, simplesmente emulei os eventos necess√°rios no monitor com o bot√£o  Apertei o bot√£o - o LED acendeu, a lavagem come√ßou.  Deixe ir - o oposto √© verdadeiro.  No entanto, depois de analisar a m√°quina de lavar, descobriu-se que esse LED faz parte da exibi√ß√£o din√¢mica e, infelizmente, n√£o √© t√£o f√°cil determinar se est√° ligado ou desligado. <br><br>  Girando o painel de controle em minhas m√£os (alguns dias), descobri que ele foi implementado em um controlador PIC.  Al√©m disso, ele √© conectado √† placa principal com as pernas respondendo ao hardware I2C.  Sim, pensei, voc√™ pode cheirar o barramento I2C e, assim, determinar o que fazer a m√°quina de lavar agora.  Encontrei o c√≥digo sniffer I2C para o Atmega na Internet.  Claro, eu tive que tocar alguma coisa. <br><br>  Francamente: n√£o consegui entender completamente o protocolo (e n√£o tentei muito), mas acabou determinando os padr√µes de in√≠cio e fim da lavagem (al√©m de ligar e desligar a alimenta√ß√£o) com bastante precis√£o.  Demorei cerca de uma semana. <br><br>  Modelo: <b>Candy GC4 1072 D.</b>  O computador envia periodicamente uma s√©rie de sequ√™ncias de cinco bytes para a unidade de exibi√ß√£o.  As quatro primeiras sequ√™ncias est√£o no formato: <br><br> <code>12 A7 00 ‚Äì NN ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS</code> <br>  onde: 12 A7 00 - cabe√ßalho, NN - n√∫mero de sequ√™ncia, X [0..7] - 8 bytes de dados, CS - soma de verifica√ß√£o.  A quinta sequ√™ncia √© um lixo de tamanho vari√°vel, cuja ess√™ncia para mim permaneceu um mist√©rio. <br><br>  Consegui resolver os seguintes padr√µes: <br><br>  <b>Power on</b> <br><br> <code>12 A7 00 ‚Äì 01 ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS <br> 12 A7 00 ‚Äì 02 ‚Äì X0 X1 X2 X3 X4 X5 X6 X7 ‚Äì CS</code> <br>  onde X [0..7] pelo menos um n√£o √© igual a 0 <br><br>  <b>INICIAR</b> <br><br> <code>12 A7 00 ‚Äì 03 ‚Äì X0 X1 X2 X3 01 01 01 01 ‚Äì CS</code> <br>  onde X [0..3] √© qualquer n√∫mero <br><br>  <b>PARAR</b> <br><br> <code>12 A7 00 ‚Äì 03 ‚Äì X0 X1 X2 X3 00 00 00 00 ‚Äì CS</code> <br>  onde X [0..3] √© qualquer n√∫mero <br><br>  Pode-se ver que essas n√£o s√£o sequ√™ncias estritas, ou seja, modelos, ent√£o tive que mexer com o analisador. <br><br>  A l√≥gica do trabalho √© aproximadamente a seguinte: se obtivermos a sequ√™ncia POWER ON, mas n√£o houver START, come√ßaremos a transmitir pacotes com o status 0. Se a sequ√™ncia START aparecer, altere o status para 1. Em outros casos, n√£o h√° nada a enviar. <br><br>  Falaremos sobre pacotes e qual o status a seguir. <br><br>  √â engra√ßado, mas quando espiei pacotes I2C, n√£o tive a oportunidade de me conectar ao computador sniffer.  Eu usei para este Raspberry Pi powerbank'om, que tinha uma caixa de alum√≠nio.  Ent√£o, assim que esse pr√©dio entrou em contato com o corpo da lavadora, um RCD foi puxado para o escudo, a luz se apagou no apartamento e eu comecei a procurar a lanterna com o matyuki.  :) Por que esse lixo aconteceu - ainda √© um mist√©rio para mim. <br><br><h3>  Canal de r√°dio </h3><br>  Inicialmente, eu n√£o queria que os fios extras sa√≠ssem da m√°quina de lavar.  Ou seja, a conex√£o deveria ser sem fio.  A partir daqui, havia tr√™s solu√ß√µes poss√≠veis para o problema: WiFi, Bluetooth e o m√≥dulo RF para Arduino.  Eu decidi sobre este √∫ltimo selecionando o m√≥dulo FS1000A. <br><br>  √â claro que em Habr√© haver√° muitas pessoas que me censuram com essa escolha.  Eles sugerem que no Ali-Express √© poss√≠vel comprar um m√≥dulo ESP com WiFi completo por um pre√ßo baixo.  Mas pensei que isso complicaria bastante o projeto e decidi agir de maneira mais simples. <br><br>  Como voc√™ sabe, o m√≥dulo RF FS1000A n√£o pode ser conectado diretamente √† interface RS232: uma longa sequ√™ncia de zeros ou uns interrompe a sincroniza√ß√£o do receptor.  A biblioteca VirtualWire foi criada para resolver esse problema.  No entanto, essa biblioteca foi escrita para o Arduino e eu programa exclusivamente de forma nativa no Atmega em C. Felizmente, o c√≥digo para o Arduino √© muito semelhante ao C puro e, com pequenas modifica√ß√µes, a biblioteca foi portada com √™xito. <br><br>  Houve algumas dificuldades: a princ√≠pio, os pacotes n√£o queriam chegar ao receptor.  Eu culpei minhas m√£os tortas por tudo, mas, ao conectar diretamente os terminais do receptor e dos controladores de transmissor, fiquei convencido de que tudo funciona na parte do software.  O transmissor encomendado √† China mostrou-se defeituoso.  Eu tive que comprar outro kit.  Depois consertei o antigo e agora tenho dois conjuntos de transmissor-receptor.  Lembra-se do que escrevi sobre como reduzir o lixo? <br><br>  Os dados foram enviados, mas o que exatamente est√° contido nesses dados?  Aqui est√° o que o pacote transmitido √©: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> dst; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> src; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_MSG_STATUS_ALIVE _BV(0) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_MSG_STATUS_VALVE _BV(1) uint8_t status; } wmp_msg_t; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_ADDR_MONITOR 0x4d504d57 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WMP_ADDR_CONTROLLER 0x43504d57</span></span></code> </pre><br>  As duas primeiras palavras duplas s√£o os endere√ßos f√≠sicos do receptor e do transmissor.  No meu caso, eles s√£o estritamente fixos: 0x43504d57 - receptor (controlador) e 0x4d504d57 - transmissor (monitor).  De fato, os primeiros 8 bytes s√£o essa assinatura de pacote.  Informa√ß√µes significativas s√£o encontradas apenas no √∫ltimo byte - o sinalizador de bit.  O bit zero definido dessa bandeira significa que o monitor est√° ligado e funcionando - ele deve sempre ser 1. O primeiro bit √© o status da v√°lvula: 0 - a v√°lvula deve estar fechada, 1 - aberta.  S√≥ isso. <br><br>  Sup√µe-se que o monitor envie periodicamente pacotes ao controlador, confirmando sua opera√ß√£o e a capacidade de manuten√ß√£o do canal de dados.  No caso de perda do canal de comunica√ß√£o, o controlador deve fechar a v√°lvula de emerg√™ncia. <br><br>  A biblioteca VirtualWire monitora a integridade dos dados transmitidos usando o CRC32.  N√£o precisei fazer esfor√ßos adicionais nessa dire√ß√£o.  Beleza! <br><br><h3>  Constru√ß√£o civil </h3><br>  Estruturalmente, o monitor √© feito na forma de uma pequena prancha, colada na cola quente "Tio Liao ranho", dentro do painel frontal da lavadora de roupas.Por conectores, a placa √© conectada ao espa√ßo entre o computador e a placa de v√≠deo.  A pr√≥pria m√°quina n√£o sofreu nenhuma modifica√ß√£o: a qualquer momento, pode ser trazida ao seu estado original. <br><br><h2>  Parte Dois  Controlador </h2><br><h3>  Canal de r√°dio </h3><br>  Tudo √© simples aqui: o receptor do kit FS1000A e o receptor da biblioteca VirtualWire est√£o instalados.  O pacote √© analisado e seu status √© transmitido para a sa√≠da.  O receptor VirtualWire ocupa TIMER1 no microcontrolador. <br><br><h3>  Controle de v√°lvula </h3><br>  Na loja online chinesa, uma v√°lvula motorizada de 3/4 ‚Äùfoi selecionada com fonte de alimenta√ß√£o de 5 volts e com sensores terminais conectados ao cabo.  Esta v√°lvula foi instalada entre a v√°lvula de esfera e a mangueira da m√°quina de lavar.  Para controlar a v√°lvula, no mesmo local chin√™s, um driver de motor de passo de baixa pot√™ncia foi encomendado nos drivers L9110.  Conectei-o ao controlador da seguinte maneira: <br><br><img src="https://habrastorage.org/webt/0a/dr/h9/0adrh9lsveasvy1hpqc6ogngsac.png"><br><br>  Do ponto de vista do software, n√£o houve dificuldades particulares: pelas entradas VALVE_CLOSE e VALVE_OPEN, determinamos o status atual da v√°lvula.  Se esse status precisar ser alterado, ligue o motor para abrir ou fechar e aguarde at√© que um 0 l√≥gico seja estabelecido na entrada correspondente.No entanto, como abrir ou fechar leva algum tempo, eu gostaria de n√£o perder o controle sobre tudo naquele momento dispositivo  Portanto, no cron√¥metro Atmega, um agendador primitivo foi constru√≠do e o controle da v√°lvula foi transferido para uma tarefa especial.  Ao mesmo tempo, o m√≥dulo de software especial WatchDog mede o tempo que leva para a v√°lvula ser trocada e, se for muito longo, √© gerado um sinal sobre seu mau funcionamento.  Mais tarde, outras coisas interessantes foram penduradas nesse agendador, como LEDs piscando e sondando o sensor de vazamento.  Mas mais sobre isso mais tarde. <br><br>  Al√©m disso, um LED de status de tr√™s cores e uma chave seletora de controle manual de tr√™s posi√ß√µes pertencem ao circuito de controle da v√°lvula.  Na posi√ß√£o intermedi√°ria da chave seletora, o controle autom√°tico √© ativado de acordo com os sinais da m√°quina de lavar e de outros sensores.  No caso de mau funcionamento da v√°lvula, as cores vermelho e verde acendem alternadamente. <br><br><h3>  LED e indica√ß√£o sonora </h3><br>  Com os LEDs, tudo √© simples: eles se agarram diretamente √†s portas de E / S via resistores limitadores.  As correntes n√£o s√£o grandes e as portas do Atmega s√£o bastante poderosas. <br><br>  Mas o som teve que mexer.  Em primeiro lugar, n√£o encontrei um emissor piezo grande e alto.  Parece que essas pessoas existem na natureza, mas assim que participei da compra, a escolha n√£o foi nem boa.  A coisa mais legal que consegui parecer soou muito quieta.  Eu tive que navegar na Internet para obter receitas. <br><br>  Eu me acomodei em um circuito com um transistor e um autotransformador, que altera a tens√£o do som de 5V para 50V.  E ent√£o ficou relativamente alto.  N√£o em todas as frequ√™ncias, √© claro, mas mais perto da resson√¢ncia. <br><br>  Foi somente durante a gera√ß√£o do som que o brilho dos LEDs (batente com energia) diminuiu um pouco, mas o microcontrolador n√£o congelou e o programa de controle n√£o quebrou.  Eu pensei que este √© um recurso do layout de depura√ß√£o e tudo funcionar√° bem na placa final.  Eu estava enganado - n√£o melhorou.  Pior, no entanto, tamb√©m. <br><br><img src="https://habrastorage.org/webt/w8/ca/pb/w8capblzyb0abagztoygcputhsi.png"><br><br>  Outro problema foi que fiquei sem temporizadores e, em segundo plano, n√£o consegui gerar som.  Eu tive que perguntar o per√≠odo de chiado com dorme.  Assim, durante a gera√ß√£o do som, o Atmega n√£o pode fazer nada al√©m de interrup√ß√µes, tamb√©m teve que ser desativado, caso contr√°rio, o tom n√£o √© claro.  Mas isso acabou n√£o sendo muito assustador, pois a sa√≠da de som n√£o se cruzava com outras tarefas cr√≠ticas, como controlar uma v√°lvula ou receber dados via r√°dio. <br><br>  Al√©m disso, selecionei as constantes do sono para que correspondessem √†s notas e criei v√°rias combina√ß√µes mais ou menos harmoniosas: ‚Äúa v√°lvula est√° aberta‚Äù, ‚Äúa v√°lvula est√° fechada‚Äù, ‚Äúa lavagem est√° conclu√≠da‚Äù e ‚Äúvazamento‚Äù.  Mais adiante, falarei sobre o sinal de "lavagem conclu√≠da". <br><br><h3>  Detector de vazamento </h3><br>  O detector de vazamento foi originalmente planejado para ser executado no ADC interno do microcontrolador.  Experimentos demonstraram que esta √© uma solu√ß√£o perfeitamente funcional.  No entanto, eu percebi que, √†s vezes, um capacitor √© adicionado ao sensor com contatos para que ele seja conectado e se n√£o houver interrup√ß√£o no fio em algum lugar.  Voc√™ pode verificar a presen√ßa de um capacitor (e medir sua capacit√¢ncia) usando: corrente RC, comparador e rel√≥gio.  Como um comparador, √© usada uma entrada GPIO convencional (tamb√©m √© uma entrada l√≥gica e alterna de 0 a 1 a uma certa tens√£o), e h√° horas suficientes no microcontrolador. <br><br><img src="https://habrastorage.org/webt/sh/um/rn/shumrnvjljzhpc_m7fdyye9ugwi.png"><br><br>  Supunha-se que, de tempos em tempos, eu verificava a presen√ßa de um capacitor na linha e depois usava o ADC para determinar se os contatos do sensor est√£o na √°gua.  Como se viu, basta medir apenas a capacit√¢ncia do capacitor: se voc√™ o abaixar na √°gua, o tempo de carga aumentar√° e a descarga diminuir√°.  Al√©m disso, o tempo mudar√° em uma quantidade suficiente para que possa ser detectado com confian√ßa. <br><br>  Para o meu sistema, escolhi medir o tempo de carga: se o capacitor n√£o estiver conectado, ser√° zero, se estiver seco √© relativamente pequeno e se estiver na √°gua, o tempo de carga ser√° muito maior.  Os valores exatos foram determinados usando um pires com √°gua e uma s√©rie de experimentos. <br><br>  O detector de vazamento possui seu pr√≥prio LED indicador vermelho.  Se o sensor n√£o for detectado, ele acende e o comando para fechar a v√°lvula √© transmitido ao ar.  Basta restabelecer a comunica√ß√£o com o sensor, o LED apaga e a v√°lvula pode ser aberta (se apenas a m√°quina estiver no estado de lavagem, √© claro).  Outra coisa √© se o sensor detectar √°gua.  Nesse caso, o indicador come√ßa a piscar, um som intermitente desagrad√°vel √© ouvido e a v√°lvula √© fechada √† for√ßa.  Mas o mais importante, o controlador nunca sai desse estado.  Um vazamento √© considerado um acidente grave e o suprimento de √°gua n√£o ser√° retomado at√© que voc√™ reinicie o dispositivo com for√ßa. <br><br><h3>  Nutri√ß√£o </h3><br>  Comida √© a parte mais incompreens√≠vel para mim neste projeto.  Se eu sou um pouco versado em circuitos digitais, depois em anal√≥gico, para dizer o m√≠nimo - na verdade n√£o.  Mas, gra√ßas aos chineses: posso comprar m√≥dulos prontos para conversores DC-DC com controladores de carga de bateria e, com base neles, consigo pensar em algo vi√°vel. <br><br>  Desde o in√≠cio, foi planejado tornar o dispositivo com alimenta√ß√£o pr√≥pria, para que, em caso de falta de energia, verifique se a √°gua ser√° desligada.  Al√©m disso, eu tinha uma fonte de alimenta√ß√£o de 9V que precisava ser conectada em algum lugar.  No total, o resultado introdut√≥rio foi o seguinte: <br><br><ul><li>  9V vem da rede; </li><li>  3.4 ~ 3.7V vem da bateria; </li><li>  para carregar a bateria voc√™ precisa de 5V; </li><li>  5V √© necess√°rio para alimentar a l√≥gica e os circuitos de pot√™ncia; </li><li>  se a tens√£o da rede falhar, ligue a bateria; </li><li>  √© necess√°rio transmitir o sinal de carga da bateria, a tens√£o na bateria e o sinal de opera√ß√£o da rede para o controlador. </li></ul><br>  O diagrama de blocos ficou como na figura. <br><br><img src="https://habrastorage.org/webt/7g/ma/5l/7gma5lv_yub5aunjhing_cbnmjw.jpeg"><br><br>  Dois diodos Schottky s√£o usados ‚Äã‚Äãcomo elemento de comuta√ß√£o.  O controlador de carregamento possui dois LEDs: CHARGE e STANDBY.  O sinal do primeiro foi conectado √† porta GPIO do controlador para que o monitor soubesse que a bateria estava carregando.  Al√©m disso, um sinal do primeiro conversor DC-DC √© aplicado √† porta do microcontrolador para determinar se o dispositivo est√° operando com uma rede el√©trica ou bateria.  Para controlar o n√≠vel de carga, a tens√£o da bateria √© fornecida ao ADC do controlador.  Se a tens√£o estiver muito baixa, o monitor fecha a v√°lvula e entra no modo de espera: ele n√£o responde a nenhum comando at√© que a tens√£o da rede el√©trica apare√ßa. <br><br>  Infelizmente, havia alguns batentes aqui: por alguma raz√£o, o motor da v√°lvula toma parte da energia da bateria.  Aparentemente, cometi um erro com a pot√™ncia do conversor DC / DC da rede ou com a espessura das faixas de energia na placa.  Como resultado: ap√≥s abrir ou fechar a v√°lvula, a bateria come√ßa a carregar. <br><br>  Para monitorar o status da energia, h√° um LED especial de duas cores.  Se estiver verde, o dispositivo est√° operando na rede.  Se vermelho - a partir da bateria.  Se estiver verde, mas o vermelho piscar, a bateria est√° carregando. <br><br><h3>  L√≥gica de trabalho </h3><br>  Bem, temos todo o hardware e seu suporte de software, agora precisamos, de alguma forma, fazer com que tudo isso interaja.  Inicialmente, vi a implementa√ß√£o da l√≥gica do trabalho na forma de um loop grande (o que √© chamado de loop principal) com um monte de ifs dentro. <br><br>  No processo, havia a necessidade de um agendador de tarefas para a√ß√µes simples como: piscar um LED, pesquisar um sensor de vazamento, rastrear o tempo de comuta√ß√£o da v√°lvula e o controle de energia, que desliguei no TIMER0.  O planejador em si n√£o iniciou as fun√ß√µes associadas √† tarefa, mas apenas definiu o bit de sincroniza√ß√£o como um no descritor associado √† tarefa.  A tarefa ainda foi realizada no ciclo principal, conseguimos nos livrar dos intervalos de rastreamento, o que tornou muito simples. <br><br>  Do zool√≥gico ifs, que verifica o status de v√°rios subsistemas do controlador e toma uma decis√£o: era necess√°rio recusar abrir ou fechar a v√°lvula.  √â muito dif√≠cil depurar isso e √© muito f√°cil ficar confuso.  Em vez disso, gostei da id√©ia do livro antigo de D. Hazerman: "Como fazer um rob√¥ voc√™ mesmo".  O livro sugeriu que cada m√≥dulo gere seus pr√≥prios sinais de controle: avan√ßar, retroceder, rota√ß√£o etc. Em seguida, somente um que vem de um bloco com prioridade mais alta √© selecionado a partir desses sinais.  Eu fiz o mesmo. <br><br>  Priorizei os blocos da seguinte maneira: <br><br><ol><li>  Bloqueio de vazamento </li><li>  Unidade de controle da bateria </li><li>  Unidade de controle de v√°lvula manual </li><li>  Unidade de controle de v√°lvula de controle de r√°dio </li><li>  Temporizador de v√°lvula WatchDog block </li></ol><br>  Cada bloco gera tr√™s comandos: UNDEFINED, OPEN e CLOSE. <br><br>  O bloco de vazamento tem a maior prioridade, mas n√£o possui o comando ABRIR, mas seu comando FECHAR definitivamente fecha a v√°lvula, independentemente do que os outros blocos digam.  A unidade de controle manual pode interromper qualquer sinal da unidade de canal de r√°dio, o que permite controlar a v√°lvula, independentemente do que a lavadora de roupas nos indicar.  Bem e assim por diante.  Ou seja, apareceu uma estrutura hier√°rquica l√≥gica que √© f√°cil de entender e depurar. <br><br>  Agora, voltemos ao sinal: "a lavagem est√° conclu√≠da".  Infelizmente, meu modelo de m√°quina de lavar n√£o tem a oportunidade de informar sobre o final de seu trabalho com a ajuda do som: os engenheiros da Candy n√£o forneceram essa oportunidade.  Por outro lado, eu tenho um dispositivo adicional que possui um emissor piezo e a cada momento sabe o que a m√°quina de lavar est√° fazendo.  Por que n√£o faz√™-lo relatar o final da lavagem?  Bem, vamos fazer o controlador alto e desagrad√°vel (na frequ√™ncia de resson√¢ncia) chiar quando a v√°lvula fecha o sinal.  Adicione outro intervalo de guarda de cinco minutos para n√£o ouvir esse chiado sempre que ligar e desligar a m√°quina.  A v√°lvula est√° aberta por cinco minutos - a lavagem definitivamente come√ßou. <br><br><h2>  Resultados </h2><br>  O desenvolvimento levou cerca de um ano de trabalho sem pressa (muito sem pressa).  O dispositivo est√° funcionando h√° dois anos.  Em opera√ß√£o, provou ser bastante satisfat√≥rio.  Mas n√£o sem falhas.  Vamos list√°-los honestamente: <br><br><ol><li>  Eu estraguei algo com o poder: o motor da v√°lvula toma parte da energia da bateria. </li><li>  O circuito de gera√ß√£o de som consome a tens√£o de alimenta√ß√£o.  Voc√™ pode ver claramente como os LEDs mudam o brilho quando o som √© reproduzido. </li><li>  O canal de r√°dio n√£o √© muito est√°vel.  Primeiro, o sinal desaparece se uma pessoa estiver perto da m√°quina de lavar.  E segundo, √†s vezes o sinal piora por si pr√≥prio.  Nesse caso, voc√™ precisa usar a chave de altern√¢ncia manual, mas isso acontece muito raramente. </li><li>  A unidade de monitor na m√°quina de lavar pendurou algumas vezes.  O bloco do controlador n√£o travou nem uma vez. </li><li>  O som do emissor piezo foi muito abafado dentro do gabinete.  Fiz um buraco no koprus: ficou melhor, mas n√£o realmente.  Eu tive que soldar o emissor da placa e col√°-lo na caixa, diretamente em frente ao orif√≠cio. </li></ol><br>  Em geral, considero o desenvolvimento bem-sucedido e muito √∫til.  Eu ligo a m√°quina pela manh√£ e saio calmamente para o trabalho: sei que na hora certa a torneira do abastecimento de √°gua ser√° fechada. <br><br>  O arquivo com arquivos de projeto pode ser baixado <a href="">aqui</a> . <br><br><h3>  Algumas fotos. </h3><br><div class="spoiler">  <b class="spoiler_title">Vista superior com a tampa superior removida</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/pk/ac/1q/pkac1q7wwkmwbptyd814mobigx4.jpeg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Vista traseira, pelo lado dos conectores</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/-z/3g/zq/-z3gzqv3s-dwhfuvlco9jkkqbcm.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kc/cv/sx/kccvsxlyr0qtrtirqf_c5hthamq.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title">   </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bg/kh/yy/bgkhyyih1i083nb9omlxrqxo9be.jpeg"><br></div></div><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/p5/qu/2y/p5qu2ygeapyr_ivwdguhkjmkcxs.jpeg"><br></div></div><br> <i>  <br> -  ¬´¬ª</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472296/">https://habr.com/ru/post/pt472296/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472280/index.html">A tarefa de determinar a presen√ßa de uma palma em um scanner de veias</a></li>
<li><a href="../pt472288/index.html">9 extens√µes √∫teis de navegador para desenvolvedores (lista para 2020)</a></li>
<li><a href="../pt472290/index.html">Estruturas vs. Classes</a></li>
<li><a href="../pt472292/index.html">Bloqueio de conte√∫do: o cen√°rio mundial</a></li>
<li><a href="../pt472294/index.html">Crie jogos e v√≠deos no YouTube. Meu experimento de intera√ß√£o e a receita desse</a></li>
<li><a href="../pt472298/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n ¬∞ 385 (14 a 20 de outubro de 2019)</a></li>
<li><a href="../pt472300/index.html">Descida de gradiente estoc√°stico (SGD) para a fun√ß√£o de perda logar√≠tmica (LogLoss) em um problema de classifica√ß√£o bin√°ria</a></li>
<li><a href="../pt472304/index.html">NASA contrata engenheiros para desenvolver rob√¥ human√≥ide de pr√≥xima gera√ß√£o</a></li>
<li><a href="../pt472306/index.html">PHP Digest No. 166 (7 a 21 de outubro de 2019)</a></li>
<li><a href="../pt472310/index.html">Identifica√ß√£o de clientes em sites sem senhas e cookies: solicita√ß√£o de padr√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>