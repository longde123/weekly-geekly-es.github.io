<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíáüèΩ üåßÔ∏è ü¶è √Årvores de express√£o de desenvolvimento empresarial üë®üèª‚Äçüî¨ üë©‚Äçüè´ üë©üèø‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para a maioria dos desenvolvedores, o uso da √°rvore de express√£o √© limitado √†s express√µes lambda no LINQ. Frequentemente, n√£o damos import√¢ncia a como...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>√Årvores de express√£o de desenvolvimento empresarial</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/423891/">  Para a maioria dos desenvolvedores, o uso da √°rvore de express√£o √© limitado √†s express√µes lambda no LINQ.  Frequentemente, n√£o damos import√¢ncia a como a tecnologia funciona "sob o cap√¥". <br><br>  Neste artigo, mostrarei t√©cnicas avan√ßadas para trabalhar com √°rvores de express√£o: eliminando a duplica√ß√£o de c√≥digo no LINQ, gera√ß√£o de c√≥digo, metaprograma√ß√£o, transpila√ß√£o e automa√ß√£o de testes. <br><br>  Voc√™ aprender√° como usar a √°rvore de express√£o diretamente, quais armadilhas a tecnologia preparou e como contorn√°-las. <br><br><img src="https://habrastorage.org/webt/e5/qh/tt/e5qhttxqyi5a27s-4dtlt2jq1mo.png"><br><br>  Sob o recorte - transcri√ß√£o de v√≠deo e texto do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">meu relat√≥rio</a> com o DotNext 2018 Piter. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/J2XzsCoJM4o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Meu nome √© Maxim Arshinov, sou co-fundador da empresa de terceiriza√ß√£o do Hi-Tech Group.  Estamos desenvolvendo software para neg√≥cios e hoje falarei sobre como a tecnologia da √°rvore de express√£o foi usada no trabalho di√°rio e como come√ßou a nos ajudar. <br><br>  Eu nunca quis estudar especificamente a estrutura interna das √°rvores de express√£o, parecia que isso era algum tipo de tecnologia interna para o .NET Team for LINQ funcionar, e os programadores de aplicativos n√£o precisavam conhecer sua API.  Aconteceu que havia alguns problemas aplicados que precisavam ser resolvidos.  Para que eu gostasse da solu√ß√£o, tive que subir no est√¥mago. <br><br>  Toda essa hist√≥ria se estende no tempo, houve projetos diferentes, casos diferentes.  Algo saiu e eu terminei, mas me permitirei sacrificar a veracidade hist√≥rica em favor de uma apresenta√ß√£o mais art√≠stica, para que todos os exemplos estejam no mesmo modelo de assunto - uma loja on-line. <br><br><img src="https://habrastorage.org/webt/g5/yf/cr/g5yfcrf13ptoovmcheym1x15fdk.png"><br><br>  Imagine que todos n√≥s estamos escrevendo uma loja online.  Possui produtos e uma marca de sele√ß√£o "√Ä venda" no painel do administrador.  Exibiremos apenas os produtos com essa marca de sele√ß√£o marcada na parte p√∫blica. <br><br><img src="https://habrastorage.org/webt/cg/_e/jt/cg_ejtgmxn1u0hq12ezlonenue8.png"><br><br>  Tomamos algum DbContext ou NHibernate, escrevemos Where (), produzimos IsForSale. <br><br>  Est√° tudo bem, mas as regras de neg√≥cios n√£o s√£o as mesmas, de modo que as escrevemos de uma vez por todas.  Eles evoluem com o tempo.  Um gerente chega e diz que ainda devemos monitorar o saldo e exibir apenas mercadorias que possuem saldos na parte p√∫blica, sem esquecer a marca de sele√ß√£o. <br><br><img src="https://habrastorage.org/webt/8e/b1/mz/8eb1mzde7casnjrrilroqxpp8ku.png"><br><br>  N√≥s adicionamos facilmente essa propriedade.  Agora, nossas regras de neg√≥cios est√£o encapsuladas, podemos reutiliz√°-las. <br><br><img src="https://habrastorage.org/webt/6s/yj/09/6syj09lcwmeiktufuwl4a4wzvyq.png"><br><br>  Vamos tentar editar o LINQ.  Est√° tudo bem aqui? <br>  N√£o, isso n√£o funcionar√°, porque IsAvailable n√£o √© mapeado para o banco de dados, este √© o nosso c√≥digo e o provedor de consultas n√£o sabe como analis√°-lo. <br><br><img src="https://habrastorage.org/webt/qb/yt/dp/qbytdpgh5ybdiua4kjpc-rouxbs.png"><br><br>  Podemos dizer a ele que nossa propriedade tem uma hist√≥ria dessas.  Mas agora esse lambda √© duplicado na express√£o linq e na propriedade <br><br><pre><code class="cs hljs">Where(x =&gt; x.IsForSale &amp;&amp; x.InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) IsAvailable =&gt; IsForSale &amp;&amp; InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  Portanto, na pr√≥xima vez que este lambda mudar, teremos que pressionar Ctrl + Shift + F no projeto.  Naturalmente, todos n√≥s n√£o vamos encontrar - erros e tempo.  Eu quero evitar isso. <br><br><img src="https://habrastorage.org/webt/8b/8b/j8/8b8bj8voopaagucck7rcl1j9tcg.png"><br><br>  Podemos ir deste lado e colocar outro ToList () na frente de Where ().  Esta √© uma p√©ssima decis√£o, porque, se houver um milh√£o de produtos no banco de dados, todo mundo sobe para a RAM e filtra l√°. <br><br><img src="https://habrastorage.org/webt/ca/2t/2g/ca2t2gbdetsmcijcefubnokpfeu.png"><br><br>  Se voc√™ tem tr√™s produtos em uma loja, a solu√ß√£o √© boa, mas no com√©rcio eletr√¥nico geralmente h√° mais.  Isso funcionou apenas porque, apesar da semelhan√ßa entre os lambdas, eles t√™m um tipo completamente diferente.  No primeiro caso, este √© um delegado da Func e, no segundo, uma √°rvore de express√£o.  Parece o mesmo, os tipos s√£o diferentes, o bytecode √© completamente diferente. <br><br><img src="https://habrastorage.org/webt/2l/qi/ya/2lqiya8v9axdrfchqrdqtrxbe4o.png"><br><br>  Para passar da express√£o para um delegado, basta chamar o m√©todo Compile ().  Esta API fornece .NET: existe express√£o - compilada, recebida um delegado. <br><br>  Mas como voltar?  Existe alguma coisa no .NET para mudar de um delegado para √°rvores de express√£o?  Se voc√™ conhece o LISP, por exemplo, existe um mecanismo de cita√ß√£o que permite que o c√≥digo seja interpretado como uma estrutura de dados, mas no .NET n√£o √©. <br><br><h1>  Expressar ou delegar? </h1><br>  Considerando que temos dois tipos de lambdas, podemos filosofar o que √© prim√°rio: √°rvore de express√£o ou delegados. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// so slo-oooooo-ow var delegateLambda = expressionLambda.Compile();</span></span></code> </pre> <br>  √Ä primeira vista, a resposta √© √≥bvia: como existe um maravilhoso m√©todo Compile (), a √°rvore de express√£o √© prim√°ria.  E devemos receber o delegado compilando a express√£o.  Mas a compila√ß√£o √© um processo lento e, se come√ßarmos a fazer isso em qualquer lugar, obteremos uma degrada√ß√£o no desempenho.  Al√©m disso, a receberemos em locais aleat√≥rios, onde a express√£o teve que ser compilada em um delegado, haver√° uma redu√ß√£o no desempenho.  Voc√™ pode encontrar esses locais, mas eles afetar√£o o tempo de resposta do servidor e aleatoriamente. <br><br><img src="https://habrastorage.org/webt/ur/jw/y_/urjwy_veoqpl7udanxvc3-ddsl8.png"><br><br>  Portanto, eles precisam ser armazenados em cache de alguma forma.  Se voc√™ ouviu uma palestra sobre estruturas de dados simult√¢neas, conhece o ConcurrentDictionary (ou apenas conhece).  Omitirei detalhes sobre m√©todos de armazenamento em cache (com bloqueios, n√£o bloqueios).  Apenas o ConcurrentDictionary possui um m√©todo GetOrAdd () simples, e a implementa√ß√£o mais simples √© inseri-lo no ConcurrentDictionary e armazen√°-lo em cache.  A primeira vez que obtemos a compila√ß√£o, mas tudo ser√° r√°pido, porque o delegado j√° foi compilado. <br><br><img src="https://habrastorage.org/webt/h1/wp/gb/h1wpgbo_5pi3xhnfaivvvjsz4ks.png"><br><br>  Ent√£o voc√™ pode usar esse m√©todo de extens√£o, pode usar e refatorar nosso c√≥digo com IsAvailable (), descrever a express√£o, compilar as propriedades IsAvailable () e cham√°-lo em rela√ß√£o ao objeto atual. <br><br>  H√° pelo menos dois pacotes que implementam isso: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Microsoft.Linq.Translations</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Signum Framework</a> (estrutura de c√≥digo aberto criada por uma empresa comercial).  L√° e ali, h√° a mesma hist√≥ria com a compila√ß√£o de delegados.  API um pouco diferente, mas tudo como mostrei no slide anterior. <br><br>  No entanto, essa n√£o √© a √∫nica abordagem, e voc√™ pode passar de delegados para express√µes.  H√° muito tempo h√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo</a> no Habre sobre o Descompilador Delegado, em que o autor afirma que toda a compila√ß√£o √© ruim, porque h√° muito tempo. <br><br>  Em geral, os delegados estavam antes das express√µes e voc√™ pode passar a eles a partir dos delegados.  Para fazer isso, o autor usa o m√©todoBody.GetILAsByteArray ();  do Reflection, que realmente retorna todo o c√≥digo IL do m√©todo como uma matriz de bytes.  Se voc√™ o aprofundar no Reflection, poder√° obter uma representa√ß√£o de objeto desse caso, percorr√™-lo com um loop e criar uma √°rvore de express√£o.  Assim, uma transi√ß√£o reversa tamb√©m √© poss√≠vel, mas deve ser feita manualmente. <br><br><img src="https://habrastorage.org/webt/_r/pp/d5/_rppd5sfv3tmy9mfacmg6wydi3k.png"><br><br>  Para n√£o percorrer todas as propriedades, o autor sugere suspender o atributo Computado para indicar que essa propriedade precisa ser incorporada.  Antes da solicita√ß√£o, subimos para IsAvailable (), extra√≠mos seu c√≥digo IL, convertemos para a √°rvore de express√£o e substitu√≠mos a chamada IsAvailable () pelo que est√° escrito neste getter.  Acontece que um manual embutido. <br><br><img src="https://habrastorage.org/webt/nt/jx/g1/ntjxg17v2olokmu7ebckzs7v_uq.png"><br><br>  Para que isso funcione, antes de passar tudo para ToList (), chamamos o m√©todo especial Decompile ().  Ele fornece um decorador para o original consult√°vel e inlining.  Somente depois disso, passamos tudo para o provedor de consultas e tudo est√° bem conosco. <br><br><img src="https://habrastorage.org/webt/ze/cz/qw/zeczqw8mzr-k72ivpyfzqrpuhrm.png"><br><br>  O √∫nico problema com essa abordagem √© que o Delegate Decompiler 0.23.0 n√£o vai avan√ßar, n√£o h√° suporte para o Core e o pr√≥prio autor diz que esse √© um alfa profundo, existem muitos inacabados, ent√£o voc√™ n√£o pode us√°-lo na produ√ß√£o.  Embora retornaremos a este t√≥pico. <br><br><h1>  Opera√ß√µes booleanas </h1><br>  Acontece que resolvemos o problema da duplica√ß√£o de condi√ß√µes espec√≠ficas. <br><br><img src="https://habrastorage.org/webt/gc/-u/5n/gc-u5nh7vip9kn5cq1d5gn3ivxm.png"><br><br>  Mas as condi√ß√µes geralmente precisam ser combinadas usando a l√≥gica booleana.  Tivemos IsForSale (), InStock ()&gt; 0 e entre eles a condi√ß√£o "AND".  Se houver qualquer outra condi√ß√£o, ou uma condi√ß√£o "OU" for necess√°ria. <br><br><img src="https://habrastorage.org/webt/9f/xu/hy/9fxuhyfzinahcrlertade-zam2s.png"><br><br>  No caso de "And", voc√™ pode enganar e despejar todo o trabalho no provedor de consultas, ou seja, escrever muito Where () em uma linha, ele sabe como faz√™-lo. <br><br><img src="https://habrastorage.org/webt/dd/hp/c9/ddhpc9tfdvmeiadkmyfmswnr4h8.png"><br><br>  Se ‚ÄúOR‚Äù for necess√°rio, isso n√£o funcionar√°, porque WhereOr () n√£o est√° no LINQ e o operador | | n√£o est√° sobrecarregado com express√µes. <br><br><h1>  Especifica√ß√µes </h1><br>  Se voc√™ est√° familiarizado com o livro DDD de Evans ou apenas conhece algo sobre o padr√£o Especifica√ß√£o, ou seja, um padr√£o de design projetado especificamente para isso.  Existem v√°rias regras de neg√≥cios e voc√™ deseja combinar opera√ß√µes na l√≥gica booleana - implemente a especifica√ß√£o. <br><br><img src="https://habrastorage.org/webt/nj/cb/4n/njcb4n2xt0g8dk3joumhmsgmuyg.png"><br><br>  Uma especifica√ß√£o √© esse termo, um padr√£o antigo do Java.  E em Java, especialmente no antigo, n√£o havia LINQ, por isso foi implementado apenas na forma do m√©todo isSatisfiedBy (), ou seja, apenas delegados, mas n√£o houve discuss√£o sobre express√µes.  Existe uma implementa√ß√£o na Internet chamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LinqSpecs</a> , no slide voc√™ a ver√°.  Eu arquivei um pouco para mim, mas a ideia pertence √† biblioteca. <br><br>  Aqui, todos os operadores booleanos est√£o sobrecarregados, os operadores true e false s√£o sobrecarregados, para que os dois operadores ‚Äú&amp;&amp;‚Äù e ‚Äú||‚Äù trabalhem, sem eles apenas um e comercial funcionar√°. <br><br><img src="https://habrastorage.org/webt/nh/8b/16/nh8b16hfmjec4t6yotlcmu5nbzi.png"><br><br>  Em seguida, adicionamos instru√ß√µes impl√≠citas que fazem o compilador assumir que a especifica√ß√£o √© express√µes e delegados.  Em qualquer lugar em que Express√£o &lt;&gt; ou Func &lt;&gt; entrem na fun√ß√£o, voc√™ pode passar a especifica√ß√£o.  Como o operador impl√≠cito est√° sobrecarregado, o compilador analisar√° e substituir√° as propriedades Expression ou IsSatisfiedBy. <br><br><img src="https://habrastorage.org/webt/pd/-t/jk/pd-tjkx5uxieorm3go74act-2gc.png"><br><br>  IsSatisfiedBy () pode ser implementado armazenando em cache a express√£o que veio.  Em qualquer caso, verifica-se que estamos vindo de Expression, o delegado corresponde a ele, adicionamos suporte para operadores booleanos.  Agora tudo isso pode ser arranjado.  As regras de neg√≥cios podem ser colocadas em especifica√ß√µes est√°ticas, declaradas e combinadas. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Spec&lt;Product&gt; IsForSaleSpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spec&lt;Product&gt;(x =&gt; x.IsForSale); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Spec&lt;Product&gt; IsInStockSpec = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Spec&lt;Product&gt;(x =&gt; x.InStock &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><img src="https://habrastorage.org/webt/ru/ju/ya/rujuyaoj1ogssqq_resyqjmkutm.png"><br><br>  Cada regra de neg√≥cios √© gravada apenas uma vez, n√£o ser√° perdida em nenhum lugar, n√£o ser√° duplicada, poder√° ser combinada.  As pessoas que chegam ao projeto podem ver o que voc√™ tem, quais condi√ß√µes, entender o modelo de assunto. <br><br><img src="https://habrastorage.org/webt/td/5l/zi/td5lzi5sx9bcq522numfdrylehg.png"><br><br>  H√° um pequeno problema: a express√£o n√£o possui os m√©todos And (), Or () e Not ().  Estes s√£o m√©todos de extens√£o, eles devem ser implementados independentemente. <br><br><img src="https://habrastorage.org/webt/l9/go/tj/l9gotjytui3drpptkcdtbyeymcc.png"><br><br>  A primeira tentativa de implementa√ß√£o foi essa.  Sobre a √°rvore de express√µes, h√° bastante documenta√ß√£o na Internet e nem tudo √© detalhado.  Portanto, tentei apenas pegar Expression, pressione Ctrl + Space, vi OrElse (), li sobre isso.  Passou duas Express√µes para compilar e obter lambda.  Isso n√£o vai funcionar. <br><br><img src="https://habrastorage.org/webt/v4/p3/8u/v4p38uvzgxubb2y8olt38ivbipq.png"><br><br>  O fato √© que essa express√£o consiste em duas partes: par√¢metro e corpo.  O segundo tamb√©m consiste em um par√¢metro e um corpo.  Em OrElse (), voc√™ precisa passar os corpos das express√µes, ou seja, √© in√∫til comparar lambdas com "AND" e "OR", isso n√£o funcionar√°.  Corrigimos, mas n√£o funcionar√° novamente. <br><br>  Mas se da √∫ltima vez que houve uma NotSupportedException de que o lambda n√£o era suportado, agora h√° uma hist√≥ria estranha sobre o par√¢metro 1, par√¢metro 2, "algo est√° errado, n√£o vou funcionar". <br><br><h1>  C # 7.0 em poucas palavras </h1><br>  Ent√£o pensei que o m√©todo cient√≠fico do pux√£o n√£o funcionaria, preciso descobrir.  Ele come√ßou a pesquisar no Google e encontrou o site do livro de Albahari " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C # 7.0 in a Nutshell</a> ". <br><br><img src="https://habrastorage.org/webt/m6/0b/ag/m60bagpqsrrcakt5wz-p05lcfyq.png"><br><br>  Joseph Albahari, que tamb√©m √© o desenvolvedor da popular biblioteca LINQKit e LINQPad, apenas descreve esse problema.  que voc√™ n√£o pode simplesmente pegar e combinar Expression, e se voc√™ pegar a m√°gica Expression.Invoke (), ela funcionar√°. <br><br>  Pergunta: o que √© Expression.Invoke ()?  V√° para o Google novamente.  Ele cria uma InvocationExpression que aplica uma express√£o delegada ou lambda √† lista de argumentos. <br><br><img src="https://habrastorage.org/webt/br/du/mh/brdumhygufxqwgu5hfly1nlac0a.png"><br><br>  Se eu li esse c√≥digo para voc√™ agora que usamos Expression.Invoke (), passamos os par√¢metros, ent√£o a mesma coisa est√° escrita em ingl√™s.  N√£o est√° ficando mais claro.  Existe alguma Expression.Invoke () m√°gica que, por algum motivo, resolve esse problema com par√¢metros.  Devemos acreditar, n√£o √© necess√°rio entender. <br><br><img src="https://habrastorage.org/webt/ja/88/po/ja88po-nxrjqtzdya6f8xxnfwre.png"><br><br>  Ao mesmo tempo, se voc√™ tentar alimentar EFs com essa express√£o combinada, ele cair√° novamente e dir√° que Expression.Invoke () n√£o √© suportado.  A prop√≥sito, o EF Core come√ßou a apoiar, mas o EF 6 n√£o se sustenta.  Mas Albahari apenas se oferece para escrever AsExpandable (), e tudo funciona. <br><br><img src="https://habrastorage.org/webt/z5/4s/lq/z54slqaaitigetkidixpw-0a408.png"><br><br>  E voc√™ pode substituir nas subconsultas Express√£o em que precisamos de um representante.  Para combin√°-los, escrevemos Compile (), mas, ao mesmo tempo, se escrevermos AsExpandable (), como Albahari sugere, esse Compile () n√£o acontecer√° realmente, mas tudo ser√° feito de forma m√°gica corretamente. <br><br><img src="https://habrastorage.org/webt/u_/bd/wo/u_bdwop-dd-1gf_xvq3e_d9hbj8.png"><br><br>  N√£o acreditei em uma palavra e entrei na fonte.  O que √© o m√©todo AsExpandable ()?  Possui consulta e QueryOptimizer.  Vamos deixar o segundo entre colchetes, pois √© desinteressante, mas simplesmente cola Express√£o: se houver 3 + 5, ele colocar√° 8. <br><br><img src="https://habrastorage.org/webt/l6/8j/tw/l68jtwqse6njinyczxh7xs3ilmw.png"><br><br>  √â interessante que o m√©todo Expand () seja chamado posteriormente, depois o queryOptimizer e, em seguida, tudo seja passado ao provedor de consultas de alguma forma refeito ap√≥s o m√©todo Expand (). <br><br><img src="https://habrastorage.org/webt/pr/dv/oc/prdvockxs8plz7f2lyciiyu0s5y.png"><br><br>  N√≥s o abrimos, √© Visitor, por dentro vemos o Compile () n√£o original, que compila outra coisa.  N√£o direi exatamente o que, mesmo que isso tenha um certo significado, mas removemos uma compila√ß√£o e a substitu√≠mos por outra.  √ìtimo, mas cheira a marketing de n√≠vel 80 porque o impacto no desempenho n√£o est√° indo a lugar algum. <br><br><h1>  Em busca de uma alternativa </h1><br>  Eu pensei que isso n√£o iria funcionar e comecei a procurar outra solu√ß√£o.  E encontrou.  Existe um tal Pete Montgomery que tamb√©m <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escreve</a> sobre esse problema e afirma que Albahari fingiu. <br><img src="https://habrastorage.org/webt/k9/pu/hy/k9puhyrru6xqi3hyozftlav_lvk.png"><br>  Pete conversou com os desenvolvedores da EF e eles o ensinaram a combinar tudo sem Expression.Evoke ().  A ideia √© muito simples: a emboscada foi com os par√¢metros.  O fato √© que, com a combina√ß√£o Express√£o, h√° um par√¢metro da primeira express√£o e um par√¢metro da segunda.  Eles n√£o correspondem.  Os corpos foram colados, mas os par√¢metros permaneceram suspensos no ar.  Eles precisam ser enfaixados da maneira certa. <br><br>  Para fazer isso, voc√™ precisa compilar um dicion√°rio observando os par√¢metros das express√µes, se o lambda n√£o for de um par√¢metro.  N√≥s compomos um dicion√°rio e re-ligamos todos os par√¢metros do segundo aos par√¢metros do primeiro, para que os par√¢metros iniciais entrem em Express√£o, conduzam por todo o corpo que colamos. <br><img src="https://habrastorage.org/webt/yn/ct/37/ynct37iynt07424au-grgvhhz1o.png"><br>  Um m√©todo t√£o simples permite que voc√™ se livre de todas as emboscadas com Expression.Invoke ().  Al√©m disso, na implementa√ß√£o de Pete Montgomery, isso √© ainda mais interessante.  Possui um m√©todo Compose () que permite combinar qualquer express√£o. <br><br><img src="https://habrastorage.org/webt/wc/of/fv/wcoffvtu4s62gggy_qqykowjtns.png"><br><br>  Tomamos express√£o e, atrav√©s do AndAlso nos conectamos, funciona sem Expans√≠vel ().  √â essa implementa√ß√£o que √© usada em opera√ß√µes booleanas. <br><br><h1>  Especifica√ß√µes e unidades </h1><br>  Tudo estava bem at√© ficar claro que os agregados existem na natureza.  Para quem n√£o conhece, explicarei: se voc√™ tem um modelo de dom√≠nio e representa todas as entidades relacionadas entre si na forma de √°rvores, uma √°rvore pendurada separadamente √© um agregado.  O pedido e os itens do pedido ser√£o chamados de agregados, e a ess√™ncia do pedido √© a raiz da agrega√ß√£o. <br><br><img src="https://habrastorage.org/webt/zr/vr/6a/zrvr6af-865n3tluhcoivfjn68g.png"><br><br>  Se, al√©m dos produtos, ainda existem categorias com uma regra de neg√≥cios anunciada para eles na forma de uma especifica√ß√£o, existe uma certa classifica√ß√£o que deve ser superior a 50, como disseram os profissionais de marketing e queremos us√°-la dessa maneira, ent√£o isso √© bom. <br><br><img src="https://habrastorage.org/webt/tp/vh/u-/tpvhu-12wisjnbsdhnmddkqpkw4.png"><br><br>  Mas se queremos extrair os produtos de uma boa categoria, novamente √© ruim, porque nossos tipos n√£o coincidem.  Especifica√ß√£o para a categoria, mas s√£o necess√°rios produtos. <br><br><img src="https://habrastorage.org/webt/yz/cj/wp/yzcjwpjtf0jvuwff1dae8jef7ha.png"><br><br>  Novamente, precisamos resolver o problema de alguma forma.  A primeira op√ß√£o: substitua Select () por SelectMany ().  Eu n√£o gosto de duas coisas aqui.  Em primeiro lugar, n√£o sei como o suporte ao SelectMany () √© implementado em todos os provedores de consulta populares.  Em segundo lugar, se algu√©m escreve um provedor de consultas, a primeira coisa que ele far√° √© escrever a exce√ß√£o n√£o implementada e SelectMany ().  E o terceiro ponto: as pessoas pensam que SelectMany () √© uma funcionalidade ou associa√ß√£o, geralmente n√£o associada a uma consulta SELECT. <br><br><h1>  Composi√ß√£o: </h1><br>  Eu gostaria de usar Select (), n√£o SelectMany (). <br><br><img src="https://habrastorage.org/webt/-_/bv/qm/-_bvqmi8jssf1sva8boyiuh1vsg.png"><br><br>  Na mesma √©poca, li sobre teoria das categorias, sobre composi√ß√£o funcional e pensei que, se houver especifica√ß√µes do produto no bool abaixo, h√° alguma fun√ß√£o que pode ir do produto para a categoria, h√° uma especifica√ß√£o referente √† categoria, substituindo a primeira funcionar como argumento do segundo, obtemos o que precisamos, uma especifica√ß√£o referente ao produto.  Absolutamente o mesmo que a composi√ß√£o funcional funciona, mas para √°rvores de express√£o. <br><br><img src="https://habrastorage.org/webt/hg/wp/7h/hgwp7h8a0nrpv2xsfphtltel160.png"><br><br>  Ent√£o seria poss√≠vel escrever um m√©todo Where () que seja necess√°rio passar de produtos para categorias e aplicar a especifica√ß√£o a essa entidade relacionada.  Essa sintaxe para o meu gosto subjetivo parece bastante compreens√≠vel. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; Where&lt;T, TParam&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; queryable, Expression&lt;Func&lt;T, TParam&gt;&gt; prop, Expression&lt;Func&lt;TParam, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> queryable.Where(prop.Compose(<span class="hljs-keyword"><span class="hljs-keyword">where</span></span>)); }</code> </pre> <br>  Com o m√©todo Compose (), isso tamb√©m pode ser feito facilmente.  Pegamos a Express√£o de entrada dos produtos e a combinamos com as especifica√ß√µes do produto e √© isso. <br><br><img src="https://habrastorage.org/webt/5p/5k/re/5p5krejfyvexk6c-hf50hymykss.png"><br><br>  Agora voc√™ pode escrever como Where ().  Isso funcionar√° se voc√™ tiver uma m√°quina de qualquer comprimento.  Category possui uma SuperCategory e qualquer n√∫mero de propriedades adicionais que podem ser substitu√≠das. <br><br>  ‚ÄúComo temos uma ferramenta para composi√ß√£o funcional, e como podemos compil√°-la e como podemos mont√°-la dinamicamente, isso significa que h√° um cheiro de metaprograma√ß√£o!‚Äù, Pensei. <br><br><h1>  Proje√ß√µes </h1><br>  Onde podemos aplicar a metaprograma√ß√£o para que tenhamos que escrever menos c√≥digo. <br><br><img src="https://habrastorage.org/webt/z6/dw/gi/z6dwgivuday4edqii5me2z0yuw0.png"><br><br>  A primeira op√ß√£o √© proje√ß√£o.  A retirada de uma entidade inteira geralmente √© muito cara.  Na maioria das vezes, passamos para a frente, serializamos JSON.  Mas n√£o precisa de toda a ess√™ncia junto com o agregado.  Voc√™ pode fazer isso com o LINQ da maneira mais eficiente poss√≠vel, escrevendo esse Select () manualmente.  N√£o √© dif√≠cil, mas chato. <br><br><img src="https://habrastorage.org/webt/1r/co/xd/1rcoxdmbzmuplg1vyuvkz5hrrqg.png"><br><br>  Em vez disso, sugiro que todos usem ProjectToType ().  Pelo menos, existem duas bibliotecas que podem fazer isso: Automapper e Mapster.  Por alguma raz√£o, muitas pessoas sabem que o AutoMapper pode mapear na mem√≥ria, mas nem todo mundo sabe que ele possui Extens√µes Queryable, tamb√©m possui Express√£o e pode criar uma express√£o SQL.  Se voc√™ ainda escrever consultas manuais e usar o LINQ, como n√£o possui restri√ß√µes de desempenho muito s√©rias, n√£o h√° sentido em faz√™-lo com as m√£os, esse √© o trabalho da m√°quina, n√£o da pessoa. <br><br><h1>  Filtragem </h1><br>  Se podemos fazer isso com proje√ß√µes, por que n√£o fazer isso para filtrar. <br><br><img src="https://habrastorage.org/webt/wg/ei/pd/wgeipdnvwwusix--gk7_zch9nhs.png"><br><br>  Aqui est√° o c√≥digo tamb√©m.  Um filtro entra.  Muitos aplicativos de neg√≥cios s√£o assim: um filtro veio, adicione Where (), outro filtro veio, adicione Where ().  Quantos filtros existem, tantos e repita.  Nada complicado, mas muita copiar e colar. <br><br><img src="https://habrastorage.org/webt/fd/7r/wl/fd7rwlnpkuiluiadq0zppn7_t-y.png"><br><br>  Se n√≥s, como AutoMapper, fizermos, escrevermos AutoFilter, Projeto e Filtro para que ele fa√ßa tudo sozinho, seria um c√≥digo legal - sem menos. <br><br><img src="https://habrastorage.org/webt/9g/es/tg/9gestgfo-ouzbolexklhu78gv8q.png"><br><br>  Isso n√£o √© nada complicado.  Tome Expression.Property, percorra o DTO e, em ess√™ncia.  Encontramos propriedades comuns que s√£o chamadas de forma id√™ntica.  Se eles s√£o chamados da mesma forma, parece um filtro. <br><br>  Em seguida, √© necess√°rio verificar se h√° nulo, use uma constante para extrair o valor do DTO, substitu√≠-lo na express√£o e adicionar convers√£o caso voc√™ tenha Int e NullableInt ou outro Nullable para que os tipos correspondam.  E coloque, por exemplo, Equals (), um filtro que verifica a igualdade. <br><br><img src="https://habrastorage.org/webt/09/x6/me/09x6mep3p-rrvwo0vodcnke_8eo.png"><br><br>  Em seguida, colete o lambda e analise cada propriedade: se houver muitas delas, colete atrav√©s de "AND" ou "OR", dependendo de como o filtro funciona para voc√™. <br><br><img src="https://habrastorage.org/webt/ha/vw/en/havwen3xvrbraul6plgdadjjusy.png"><br><br>  O mesmo pode ser feito para a classifica√ß√£o, mas √© um pouco mais complicado, porque o m√©todo OrderBy () possui dois gen√©ricos, ent√£o voc√™ deve preench√™-los com as m√£os, use o Reflections para criar o m√©todo OrderBy () a partir de dois gen√©ricos, insira o tipo da entidade que estamos adotando, o tipo de classifica√ß√£o Propriedade.  Em geral, voc√™ tamb√©m pode fazer isso, n√£o √© dif√≠cil. <br><br>  Surge a pergunta: onde colocar Onde () - no n√≠vel da entidade, conforme as especifica√ß√µes foram anunciadas ou ap√≥s a proje√ß√£o, e onde e onde funcionar√°. <br><br><img src="https://habrastorage.org/webt/e1/4g/4g/e14g4gelsidqhaeq7avs0wgp51i.png"><br><br>  √â verdade tanto assim como porque as especifica√ß√µes s√£o, por defini√ß√£o, regras de neg√≥cios, e devemos valoriz√°-las e valoriz√°-las e n√£o cometer erros.  Esta √© uma camada unidimensional.  E os filtros s√£o mais sobre a interface do usu√°rio, o que significa que s√£o filtrados pelo DTO.  Portanto, voc√™ pode colocar dois Where ().  Existem perguntas mais prov√°veis ‚Äã‚Äãsobre o qu√£o bem o provedor de consulta lidar√° com isso muito bem, mas acredito que as solu√ß√µes ORM gravam SQL incorreto de qualquer maneira e n√£o ser√° muito pior.  Se isso √© muito importante para voc√™, essa hist√≥ria n√£o √© sobre voc√™. <br><br><img src="https://habrastorage.org/webt/46/wn/kc/46wnkcjkjayv9boma0pot5of0rs.png"><br><br>  Como se costuma dizer, √© melhor ver uma vez do que ouvir cem vezes. <br>  Agora a loja possui tr√™s produtos: Snickers, Subaru Impreza e Mars.  Loja estranha.  Vamos tentar encontrar Snickers.  Existe.  Vamos ver o que cem rublos.  Tamb√©m Snickers.  E por 500?  Aumente o zoom, n√£o h√° nada.  E para o 100500 Subaru Impreza.  √ìtimo, o mesmo vale para a classifica√ß√£o. <br><br>  Classifique alfabeticamente e por pre√ßo.  O c√≥digo l√° est√° escrito exatamente como era.  Esses filtros funcionam para qualquer classe, qualquer que seja.  Se voc√™ tentar pesquisar pelo nome, o Subaru tamb√©m existe.  E na minha apresenta√ß√£o foi Equals ().  Como assim?  O fato √© que o c√≥digo aqui e na apresenta√ß√£o √© um pouco diferente.  Comentei a linha sobre Equals () e adicionei um pouco de magia de rua especial.  Se tivermos o tipo String, n√£o precisamos de Equals (), mas chamar StartWith (), que tamb√©m recebi.  Portanto, um filtro diferente √© criado para as linhas. <br><br><img src="https://habrastorage.org/webt/t7/fa/kp/t7fakpf7peg_v2swpq2xwksiecu.png"><br><br>  Isso significa que aqui voc√™ pode pressionar Ctrl + Shift + R, selecionar o m√©todo e escrever n√£o se, mas alternar, ou voc√™ pode at√© implementar o padr√£o "Estrat√©gia" e ficar louco.  Voc√™ pode realizar qualquer desejo sobre a opera√ß√£o dos filtros.  Tudo depende dos tipos com os quais voc√™ trabalha.  Mais importante ainda, os filtros funcionar√£o da mesma maneira. <br><br>  Voc√™ pode concordar que os filtros em todos os elementos da interface do usu√°rio devem funcionar assim: as cadeias s√£o pesquisadas de uma maneira, o dinheiro √© pesquisado de outra.  Coordene tudo isso, escreva uma vez, tudo ser√° feito corretamente em diferentes interfaces e nenhum outro desenvolvedor o quebrar√°, porque esse c√≥digo n√£o est√° no n√≠vel do aplicativo, mas em algum lugar da biblioteca externa ou do kernel. <br><br><h1>  Valida√ß√£o </h1><br>  Al√©m de filtragem e proje√ß√£o, voc√™ pode fazer a valida√ß√£o.  A biblioteca JS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TComb.validation</a> teve essa ideia.  TComb √© uma abrevia√ß√£o de Type Combinators e √© baseada em um sistema de tipos e assim por diante.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> refinamentos, melhorias. </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// null and undefined validate('a', t.Nil).isValid(); // =&gt; false validate(null, t.Nil).isValid(); // =&gt; true validate(undefined, t.Nil).isValid(); // =&gt; true // strings validate(1, t.String).isValid(); // =&gt; false validate('a', t.String).isValid(); // =&gt; true // numbers validate('a', t.Number).isValid(); // =&gt; false validate(1, t.Number).isValid(); // =&gt; true</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Primeiro, as primitivas s√£o declaradas correspondentes a todos os tipos JS e um tipo nill adicional correspondente a indefinido ou zero. </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// a predicate is a function with signature: (x) -&gt; boolean var predicate = function (x) { return x &gt;= 0; }; // a positive number var Positive = t.refinement(t.Number, predicate); validate(-1, Positive).isValid(); // =&gt; false validate(1, Positive).isValid(); // =&gt; true</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o a divers√£o come√ßa. </font><font style="vertical-align: inherit;">Cada tipo pode ser aprimorado com um predicado. </font><font style="vertical-align: inherit;">Se queremos n√∫meros maiores que zero, declaramos o predicado x&gt; = 0 e fazemos a valida√ß√£o com rela√ß√£o ao tipo Positivo. </font><font style="vertical-align: inherit;">Portanto, a partir dos blocos de constru√ß√£o, voc√™ pode coletar qualquer uma de suas valida√ß√µes. </font><font style="vertical-align: inherit;">Percebemos, provavelmente, tamb√©m existem express√µes lambda. </font></font><br><br><img src="https://habrastorage.org/webt/ha/wx/lj/hawxljvmttn1bc0rhh5k4fvtywe.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A chamada √© aceita. </font><font style="vertical-align: inherit;">N√≥s pegamos o mesmo refinamento, escrevemos em C #, escrevemos o m√©todo IsValid () e compilamos e executamos Expression tamb√©m. </font><font style="vertical-align: inherit;">Agora temos a oportunidade de realizar a valida√ß√£o.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RefinementAttribute</span></span>: <span class="hljs-title"><span class="hljs-title">ValidationAttribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IValidator&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; Refinement { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RefinementAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type refinmentType</span></span></span><span class="hljs-function">)</span></span> { Refinement = (IValidator&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;) Activator.CreateInstance(refinmentType); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsValid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> =&gt; Refinement.Validate(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).IsValid(); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integramos com o sistema DataAnnotations padr√£o no ASP.NET MVC, para que tudo funcione imediatamente. Declaramos RefinementAttribute (), passamos o tipo para o construtor. O fato √© que RefinementAttribute √© gen√©rico, portanto, voc√™ deve usar um tipo como este, porque n√£o √© poss√≠vel declarar um atributo gen√©rico no .NET, infelizmente. </font></font><br><br><img src="https://habrastorage.org/webt/ml/e7/j9/mle7j92pbchiswi1ni7zfvizgou.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, marque a classe de usu√°rio com refinanciamento. AdultRefinement, essa idade √© maior que 18. </font></font><br><br><img src="https://habrastorage.org/webt/cp/2o/yt/cp2oytz1rrhql042hddkb3va8ug.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para ser completamente bom, vamos fazer a valida√ß√£o no cliente e no servidor da mesma forma. Os apoiadores do NoJS sugerem escrever apoio e front em JS. Ok, vou escrever em C #, tudo bem e transponho para JS. Javascriptists podem escrever em seu JSX, ES6 e convert√™-lo em JavaScript. Por que n√£o podemos? Escrevemos Visitor, analisamos os operadores necess√°rios e escrevemos JavaScript.</font></font><br><br><img src="https://habrastorage.org/webt/lg/qe/9y/lgqe9yl63oz8p8wmlkrmyfmkkky.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um caso de valida√ß√£o frequente separado s√£o express√µes regulares, elas tamb√©m precisam ser desmontadas. Se voc√™ possui regexp, use StringBuilder, crie regexp. Aqui eu usei dois pontos de exclama√ß√£o, j√° que JS √© uma linguagem de tipo din√¢mico, essa express√£o ser√° convertida em bool sempre, para que tudo fique bem com o tipo. Vamos ver como fica.</font></font><br><br><pre> <code class="cs hljs">{ predicate: ‚Äúx=&gt; (x &gt;= <span class="hljs-number"><span class="hljs-number">18</span></span>)‚Äù, errorMessage: ‚ÄúFor adults only¬ª }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° o nosso refino, que vem do back-end, um predicado de linha, pois em JS n√£o h√° lambdas e mensagem de erro "Somente para adultos". Vamos tentar preencher o formul√°rio. N√£o passa. Olhamos como √© feito. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© React, solicitamos do back-end do m√©todo UserRefinment () Expression e errorMessage, constru√≠mos um refinamento em rela√ß√£o ao n√∫mero, usamos eval para obter o lambda. Se eu refazer isso e remover as restri√ß√µes de tipo, substitua-o pelo n√∫mero usual, a valida√ß√£o cair√° no JS. Entre na unidade, envie. N√£o sei se √© vis√≠vel ou n√£o, false foi deduzido aqui. </font></font><br><br><img src="https://habrastorage.org/webt/km/vw/ls/kmvwlsxxw5csttfvkh_rxrpbwpe.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo est√° alerta. Quando enviamos onSubmit, alerte o que veio do back-end. E o back-end √© um c√≥digo t√£o simples. </font></font><br><br><img src="https://habrastorage.org/webt/xj/hm/mz/xjhmmznmn7xgzlcxedk_tgvdzcu.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplesmente retornamos Ok (ModelState.IsValid), a classe User que obtemos do formul√°rio em JavaScript. Aqui est√° este atributo de refinamento.</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">DemoApp.Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">User</span></span>: <span class="hljs-title"><span class="hljs-title">HasNameBase</span></span> { [Refinement(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(AdultRefinement))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Age { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ou seja, a valida√ß√£o tamb√©m funciona no back-end, declarado neste lambda. </font><font style="vertical-align: inherit;">E n√≥s o traduzimos para JavaScript. </font><font style="vertical-align: inherit;">Acontece que escrevemos express√µes lambda em C # e o c√≥digo √© executado l√° e ali. </font><font style="vertical-align: inherit;">Nossa resposta √© NoJS, tamb√©m podemos fazer isso.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Teste </font></font></h1><br><img src="https://habrastorage.org/webt/jz/fm/y0/jzfmy0ngjejazfvdrf5ld9y8cc4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geralmente, os Timlids est√£o mais preocupados com o n√∫mero de erros no c√≥digo. Quem escreve testes de unidade conhece a biblioteca Moq. </font><font style="vertical-align: inherit;">Deseja escrever mock ou declarar alguma classe - existe moq, possui sintaxe fluente. </font><font style="vertical-align: inherit;">Voc√™ pode pintar como deseja que ele se comporte e aplicar seu pedido de teste. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essas lambdas no moq tamb√©m s√£o Express√£o, n√£o delegadas. </font><font style="vertical-align: inherit;">Ele percorre as √°rvores de express√£o, aplica sua l√≥gica e depois alimenta o Castle.DynamicProxy. </font><font style="vertical-align: inherit;">E ele cria as classes necess√°rias em tempo de execu√ß√£o. </font><font style="vertical-align: inherit;">Mas n√≥s podemos fazer isso tamb√©m.</font></font><br><br><img src="https://habrastorage.org/webt/tc/xo/fk/tcxofk6igzdettbtprnfewltn_q.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um amigo meu perguntou recentemente se havia algo como o WCF em nosso Core. Eu respondi que existe uma WebAPI. Ele queria na WebAPI, como no WCF no WSDL, construir um proxy. H√° apenas arrog√¢ncia no WebAPI. Mas a arrog√¢ncia √© apenas texto, e um amigo n√£o queria assistir sempre que a API muda e o que quebra. Quando havia o WCF, ele ativou o WSDL; se a especifica√ß√£o foi alterada na API, a compila√ß√£o foi interrompida.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso faz algum sentido, pois √© relutante em pesquisar, e o compilador pode ajudar. Por analogia com moq, voc√™ pode declarar o m√©todo GetResponse &lt;&gt; () gen√©rico com seu ProductController, e o lambda que entra nesse m√©todo √© parametrizado pelo controlador. Ou seja, quando voc√™ come√ßa a escrever lambda, pressione Ctrl + Space e veja todos os m√©todos que esse controlador possui, desde que haja uma biblioteca, uma dll com c√≥digo. Existe o Intellisense, escreva tudo isso como se estivesse chamando o controlador.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, como Moq, n√£o vamos cham√°-lo, mas simplesmente construa uma √°rvore de express√£o, passe por ela, retire todas as informa√ß√µes de roteamento da configura√ß√£o da API. E, em vez de fazer algo com o controlador, que n√£o podemos executar, uma vez que devemos execut√°-lo no servidor, apenas fazemos a solicita√ß√£o POST ou GET de que precisamos e, na dire√ß√£o oposta, desserializamos a recebida, porque de Intellisense e √°rvore de express√£o que conhecemos sobre todos os tipos de retorno. Acontece que escrevemos o c√≥digo sobre os controladores, mas, na verdade, fazemos solicita√ß√µes na Web. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otimiza√ß√£o de reflex√£o </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tudo sobre a metaprograma√ß√£o tem muito em comum com a reflex√£o.</font></font><br><br><img src="https://habrastorage.org/webt/gr/bq/r_/grbqr_q2oqe0rulsblvpejylomk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sabemos que a reflex√£o √© lenta, eu gostaria de evitar isso. Aqui tamb√©m existem bons casos de trabalho com o Expression. O primeiro √© o ativador CreateInstance. Voc√™ nunca deve us√°-lo, porque existe o Expression.New (), que voc√™ pode simplesmente acessar em um lambda, compil√°-lo e obter os construtores. </font></font><br><br><img src="https://habrastorage.org/webt/8u/me/lv/8umelvrhhu0ctn0gaunjp1ldmxg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peguei esse slide emprestado de um maravilhoso palestrante e m√∫sico Vagif. Ele estava fazendo algum tipo de refer√™ncia em um blog. Aqui est√° o ativador, este √© o pico do comunismo, voc√™ v√™ o quanto ele est√° tentando fazer tudo. Constructor_Invoke, √© cerca de metade do que √© bom. E √† esquerda est√° o lambda novo e compilado. H√° um ligeiro aumento no desempenho devido ao fato de ser um delegado, n√£o um construtor, mas a escolha √© √≥bvia, √© claro que isso √© muito melhor. </font></font><br><br><img src="https://habrastorage.org/webt/yr/sv/7k/yrsv7kspmbbmnfjxc1slzkemvx4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O mesmo pode ser feito com getters ou setters.</font></font><br><br><img src="https://habrastorage.org/webt/gf/2d/4e/gf2d4ebwaltmazxfjicoupxwrbk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© feito de maneira muito simples. Se, por algum motivo, voc√™ n√£o se sentir confort√°vel com o Fast Memember, Mark Gravelli ou Fast Reflect, se n√£o quiser arrastar essa depend√™ncia, poder√° fazer o mesmo. A √∫nica dificuldade √© que voc√™ precisa monitorar todas essas compila√ß√µes, armazenar e aquecer o cache em algum lugar. Ou seja, se houver muito disso, no in√≠cio √© necess√°rio compilar uma vez. </font></font><br><br><img src="https://habrastorage.org/webt/hi/x1/e7/hix1e7peelljkkm6kewh4blyhgq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como existe um construtor, getters e setters, existe apenas comportamento, m√©todos. Mas eles tamb√©m podem ser compilados em delegados, e voc√™ ter√° apenas um grande zool√≥gico de delegados que precisar√° gerenciar. Sabendo tudo sobre o que eu falei, pode ser que algu√©m pense que, se houver muitos delegados, muitas express√µes, poder√° haver espa√ßo para o que √© chamado DSL, Little Languages ‚Äã‚Äãou um padr√£o de int√©rprete, uma m√¥nada livre.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essas s√£o as mesmas coisas quando, para alguma tarefa, criamos um conjunto de comandos e, para ele, escrevemos nosso pr√≥prio int√©rprete que executa isso. Ou seja, dentro do aplicativo, escrevemos outro compilador ou int√©rprete que sabe como usar esses comandos. Isso √© exatamente o que √© feito no DLR, na parte que funciona com as linguagens IronPython e IronRuby. A √°rvore Express√£o √© usada para executar c√≥digo din√¢mico no CLR. O mesmo pode ser feito em aplicativos de neg√≥cios, mas at√© agora n√£o percebemos essa necessidade e isso permanece fora dos colchetes.</font></font><br><br><h1>  Sum√°rio </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concluindo, quero falar sobre as conclus√µes a que chegamos ap√≥s a implementa√ß√£o e o teste. Como eu disse, isso aconteceu em diferentes projetos. Tudo o que escrevi, n√£o usamos em todos os lugares, mas em algum lugar, se necess√°rio, algumas coisas foram usadas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira vantagem √© a capacidade de automatizar a rotina. Se voc√™ tem 100 mil moldes com filtragem, pagina√ß√£o e tudo isso. Mozart brincou dizendo que, usando dados, tempo suficiente e um copo de vinho tinto, voc√™ pode escrever valsas em qualquer quantidade. Aqui, com a ajuda do Expression Trees, uma pequena metaprograma√ß√£o, voc√™ pode escrever formul√°rios em qualquer quantidade. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A quantidade de c√≥digo √© bastante reduzida, como alternativa √† gera√ß√£o de c√≥digo, se voc√™ n√£o gosta, j√° que voc√™ recebe muito c√≥digo, n√£o pode escrev√™-lo, deixa tudo em tempo de execu√ß√£o.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando esse c√≥digo para tarefas simples, reduzimos ainda mais os requisitos para os artistas, porque h√° muito pouco c√≥digo imperativo e tamb√©m n√£o h√° espa√ßo para erros. Depois de extrair uma grande quantidade de c√≥digo em componentes reutiliz√°veis, removemos essa classe de erros. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por outro lado, aumentamos muito os requisitos para as qualifica√ß√µes do designer, porque surgem d√∫vidas sobre o trabalho com Express√£o, Reflex√£o, sua otimiza√ß√£o, sobre locais onde voc√™ pode dar um tiro no p√©. Existem muitas nuances, portanto, uma pessoa n√£o familiarizada com esta API n√£o entender√° imediatamente por que o Expression simplesmente n√£o combina. O designer deve ser mais descolado.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em alguns casos, atrav√©s do Expression.Compile (), voc√™ pode detectar a degrada√ß√£o do desempenho. No exemplo de armazenamento em cache, eu tinha uma limita√ß√£o de que Express√µes s√£o est√°ticas porque Dictionary √© usado para armazenamento em cache. Se algu√©m n√£o sabe como isso √© organizado internamente, ele come√ßa a faz√™-lo sem pensar, declara as especifica√ß√µes n√£o est√°ticas por dentro, o m√©todo de cache n√£o funciona e receberemos chamadas para Compile () em locais aleat√≥rios. Exatamente o que eu queria evitar.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O menos desagrad√°vel √© que o c√≥digo deixa de se parecer com um c√≥digo C #, torna-se menos idiom√°tico, chamadas est√°ticas aparecem, m√©todos Where () adicionais estranhos, alguns operadores impl√≠citos est√£o sobrecarregados. Isso n√£o est√° na documenta√ß√£o do MSDN, nos exemplos. Se, por exemplo, uma pessoa com pouca experi√™ncia chegar at√© voc√™, que n√£o est√° acostumada a entrar no c√≥digo-fonte em caso de algo, ela provavelmente estar√° em uma pequena prostra√ß√£o pela primeira vez, porque isso n√£o se encaixa na imagem do mundo, n√£o h√° exemplos no StackOverflow, mas com isso ter√° que trabalhar de alguma forma. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, √© sobre isso que eu queria falar hoje. Muito do que eu contei, com mais detalhes, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√° escrito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em Habr√©. O c√≥digo da biblioteca √© publicado no github, mas possui uma falha fatal - a completa falta de documenta√ß√£o.</font></font><br><blockquote> 22-23     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DotNext 2018 Moscow</a> .       , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>     ( <b>  </b>   ). </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt423891/">https://habr.com/ru/post/pt423891/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt423877/index.html">29-31 de outubro: criando um cluster Kubernetes pronto para produ√ß√£o</a></li>
<li><a href="../pt423879/index.html">√â f√°cil adicionar novos recursos √† estrutura antiga? Farinha de escolha no exemplo do desenvolvimento do SObjectizer</a></li>
<li><a href="../pt423881/index.html">Quais foram os soldadores para √≥ptica (parte dois)</a></li>
<li><a href="../pt423885/index.html">Um convite para um show de luzes e um pouco de informa√ß√£o da futura plataforma Circle of Light em Moscou</a></li>
<li><a href="../pt423889/index.html">Minha decep√ß√£o com o software</a></li>
<li><a href="../pt423893/index.html">Hello World por receber dados de um dispositivo Bluetooth (BLE) via C #</a></li>
<li><a href="../pt423895/index.html">Voc√™ n√£o precisa de um advogado. Mas isso n√£o √© certo</a></li>
<li><a href="../pt423897/index.html">Dicas √∫teis para o uso do Assistente HyperLynx DDR para an√°lise QDR4</a></li>
<li><a href="../pt423901/index.html">Quando a velocidade e o dimensionamento s√£o necess√°rios: servidor de dispositivos iOS distribu√≠dos</a></li>
<li><a href="../pt423903/index.html">Imers√£o no AD: analisamos ataques avan√ßados no Microsoft Active Directory e como detect√°-los</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>