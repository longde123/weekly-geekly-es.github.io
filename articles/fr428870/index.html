<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🅿️ 🤚🏾 👨🏿‍💼 Mrr: FRP total pour React 🖨️ 🚣🏽 🥕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mrr est une bibliothèque fonctionnelle-réactive pour React (je m'excuse pour la tautologie imaginaire). 

 Le mot «réactivité» fait généralement référ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mrr: FRP total pour React</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428870/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mrr</a> est une bibliothèque fonctionnelle-réactive pour React (je m'excuse pour la tautologie imaginaire). <br><br>  Le mot «réactivité» <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fait</a> généralement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">référence à Rx.js</a> comme FRP de référence.  Cependant, une série d'articles récents sur ce sujet sur Habré ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[1]</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[2]</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">[3]</a> ) a montré la lourdeur des solutions sur Rx, qui dans des exemples simples ont perdu en clarté et en simplicité à presque toute autre approche.  Rx est grand et puissant, et est parfait pour résoudre des problèmes dans lesquels l'abstraction du flux se suggère (en pratique, c'est principalement la coordination de tâches asynchrones).  Mais écririez-vous, par exemple, une simple validation de formulaire synchrone sur Rx?  Pourrait-il vous faire gagner du temps par rapport aux approches impératives habituelles? <br><br>  mrr est une tentative de prouver que FRF peut être une solution pratique et efficace non seulement dans des problèmes spécifiques de "streaming", mais aussi dans les tâches frontales de routine les plus courantes. <br><a name="habracut"></a><br>  La programmation réactive est une abstraction très puissante, pour le moment en front-end elle est présente de deux manières: <br><br><ul><li>  Variables réactives (variables calculées): simples, fiables, intuitives, mais le potentiel du RP est loin d'être pleinement révélé </li><li>  bibliothèques pour travailler avec des flux, tels que Rx, Bacon, etc.: puissantes, mais plutôt compliquées, la portée de l'utilisation pratique est limitée à des tâches spécifiques. </li></ul><br>  Mrr combine les avantages de ces approches.  Contrairement à Rx.js, mrr dispose d'une API courte, que l'utilisateur peut développer avec ses ajouts.  Au lieu de dizaines de méthodes et d'opérateurs - quatre opérateurs de base, au lieu d'Observable (chaud et froid), Sujet, etc.  - une abstraction: flux.  De plus, mrr manque de concepts complexes qui peuvent compliquer considérablement la lisibilité du code, par exemple, les métastream. <br><br>  Cependant, mrr n'est pas un «Rx simplifié d'une manière nouvelle».  Basé sur les mêmes principes de base que Rx, mrr prétend être un créneau plus important: gérer l'état global et local (au niveau des composants) de l'application.  Bien que le concept original de programmation réactive ait été conçu pour fonctionner avec des tâches asynchrones, mrr a utilisé avec succès des approches de réactivité pour des tâches synchrones ordinaires.  C'est le principe du «FRP total». <br><br>  Souvent, lors de la création d'une application sur React, plusieurs technologies différentes sont utilisées: recomposition (ou bientôt - hooks) pour l'état du composant, Redux / mobx pour l'état global, Rx avec redux-observable (ou thunk / saga) pour la gestion des effets secondaires et la coordination asynchrone tâches dans l'éditeur.  Au lieu d'une telle «salade» d'approches et de technologies différentes au sein d'une même application, avec mrr, vous pouvez utiliser une seule technologie et un seul paradigme. <br><br>  L'interface mrr est également significativement différente de Rx et des bibliothèques similaires - elle est plus déclarative.  Grâce à l'abstraction de réactivité et à l'approche déclarative, mrr vous permet d'écrire du code expressif et concis.  Par exemple, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TodoMVC standard</a> sur mrr prend moins de 50 lignes de code (sans compter le modèle JSX). <br><br>  Mais assez de publicité.  Avez-vous réussi à combiner les avantages du RP "léger" et "lourd" dans une bouteille - vous devriez en juger, mais d'abord, veuillez lire les exemples de code. <br><br>  TodoMVC est déjà assez douloureux, et l'exemple de téléchargement de données sur les utilisateurs de Github est trop primitif pour pouvoir ressentir les fonctionnalités de la bibliothèque dessus.  Nous considérerons mrr comme un exemple d'application conditionnelle pour l'achat de billets de train.  Dans notre interface utilisateur, il y aura des champs pour choisir les stations de départ et d'arrivée, les dates.  Ensuite, après l'envoi des données, une liste des trains et des places disponibles sera retournée.  Après avoir sélectionné un train et un type de voiture spécifiques, l'utilisateur saisira les données des passagers, puis ajoutera les billets au panier.  Allons-y. <br><br>  Nous avons besoin d'un formulaire avec un choix de stations et de dates: <br><br><img src="https://habrastorage.org/webt/sm/he/aj/smheajucvbemykx4g-fvvqeygrc.gif"><br><br>  Créez des champs de saisie semi-automatique pour l'entrée des stations. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { withMrr } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mrr'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> stations = [ <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, ... ] <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Tickets = withMrr({ <span class="hljs-comment"><span class="hljs-comment">//    $init: { stationFromOptions: [], stationFromInput: '', }, //   - "" stationFromOptions: [str =&gt; stations.filter(s =&gt; s.indexOf(str)===0), 'stationFromInput'], }, (state, props, $) =&gt; { return (&lt;div&gt; &lt;h3&gt;    &lt;/h3&gt; &lt;div&gt;  : &lt;input onChange={ $('stationFromInput') } /&gt; &lt;/div&gt; &lt;ul className="stationFromOptions"&gt; { state.stationFromOptions.map(s =&gt; &lt;li&gt;{ s }&lt;/li&gt;) } &lt;/ul&gt; &lt;/div&gt;); }); export default Tickets;</span></span></code> </pre> <br>  Les composants mrr sont créés à l'aide de la fonction withMrr, qui accepte un diagramme de lien réactif (description des flux) et une fonction de rendu.  Les fonctions de rendu sont passées aux accessoires du composant, ainsi qu'à l'état, qui est maintenant complètement contrôlé par mrr.  Il contiendra l'initiale (bloc $ init) et calculé par les valeurs de formule des cellules réactives. <br><br>  Nous avons maintenant deux cellules (ou deux flux, ce qui est la même chose): <b>stationFromInput</b> , les valeurs auxquelles tombent les entrées utilisateur à l'aide de <b>$</b> helper (en passant par défaut <b>event.target.value</b> pour les éléments d'entrée de données), et une cellule qui en dérive <b>stationFromOptions</b> , contenant un tableau de stations correspondantes par nom. <br><br>  La valeur de <b>stationFromOptions est</b> automatiquement calculée chaque fois qu'une cellule parent est modifiée à l'aide d'une fonction (dans la terminologie mrr appelée « <i>formule</i> » - par analogie avec les formules Excel).  La syntaxe des expressions mrr est simple: en premier lieu est la fonction (ou opérateur) par laquelle la valeur de la cellule est calculée, puis il y a une liste de cellules dont dépend cette cellule: leurs valeurs sont transmises à la fonction.  Une telle syntaxe étrange, à première vue, présente de nombreux avantages, que nous examinerons plus loin.  Jusqu'à présent, la logique mrr rappelle ici l'approche habituelle avec les variables calculables utilisées dans Vue, Svelte et d'autres bibliothèques, à la seule différence que vous pouvez utiliser des fonctions pures. <br><br>  Nous implémentons la substitution de la station sélectionnée dans la liste du champ de saisie.  Il est également nécessaire de masquer la liste des stations après que l'utilisateur a cliqué sur l'une d'entre elles. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Tickets = withMrr({ <span class="hljs-attr"><span class="hljs-attr">$init</span></span>: { <span class="hljs-attr"><span class="hljs-attr">stationFromOptions</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">stationFromInput</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">stationFromOptions</span></span>: [<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function"> =&gt;</span></span> stations.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">s</span></span></span><span class="hljs-function"> =&gt;</span></span> str.indexOf(a) === <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-string"><span class="hljs-string">'stationFromInput'</span></span>], <span class="hljs-attr"><span class="hljs-attr">stationFrom</span></span>: [<span class="hljs-string"><span class="hljs-string">'merge'</span></span>, <span class="hljs-string"><span class="hljs-string">'stationFromInput'</span></span>, <span class="hljs-string"><span class="hljs-string">'selectStationFrom'</span></span>], <span class="hljs-attr"><span class="hljs-attr">optionsShown</span></span>: [<span class="hljs-string"><span class="hljs-string">'toggle'</span></span>, <span class="hljs-string"><span class="hljs-string">'stationFromInput'</span></span>, <span class="hljs-string"><span class="hljs-string">'selectStationFrom'</span></span>], }, (state, props, $) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">  : </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">input</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">stationFromInput</span></span></span></span><span class="xml"><span class="hljs-tag">') } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">state.stationFrom</span></span></span></span><span class="xml"><span class="hljs-tag"> }/&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { state.optionsShown &amp;&amp; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"stationFromOptions"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { state.stationFromOptions.map(s =&gt; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">selectStationFrom</span></span></span></span><span class="xml"><span class="hljs-tag">', </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag">) }&gt;</span></span></span><span class="xml">{ s }</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">) } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">); });</span></span></code> </pre><br>  Un gestionnaire d'événements créé à l'aide de l'aide $ dans la liste des stations émettra des valeurs fixes pour chaque option. <br><br>  mrr est cohérent dans son approche déclarative, étranger à toute mutation.  Après avoir sélectionné une station, nous ne pouvons pas «forcer» à changer la valeur de la cellule.  Au lieu de cela, nous créons une nouvelle cellule <b>stationFrom</b> qui, à l'aide de l'opérateur de <b>fusion de</b> fusion de flux (un équivalent approximatif sur Rx est combineLatest), collectera les valeurs de deux flux: entrée utilisateur ( <b>stationFromInput</b> ) et sélection de station ( <b>selectStationFrom</b> ). <br><br>  Nous devons afficher la liste des options une fois que l'utilisateur a entré quelque chose et se cacher après avoir sélectionné l'une des options.  La cellule <b>optionsShown</b> sera responsable de la visibilité de la liste des options, qui prendra des valeurs booléennes en fonction des changements dans les autres cellules.  Il s'agit d'un modèle très courant pour lequel il existe du sucre syntaxique - l'opérateur à <b>bascule</b> .  Il définit la valeur de la cellule sur <i>true</i> lors de tout changement du premier argument (flux) et sur <i>false</i> - le second. <br><br>  Ajoutez un bouton pour effacer le texte saisi. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Tickets = withMrr({ <span class="hljs-attr"><span class="hljs-attr">$init</span></span>: { <span class="hljs-attr"><span class="hljs-attr">stationFromOptions</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">stationFromInput</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">stationFromOptions</span></span>: [<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function"> =&gt;</span></span> stations.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">s</span></span></span><span class="hljs-function"> =&gt;</span></span> str.indexOf(a) === <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-string"><span class="hljs-string">'stationFromInput'</span></span>], <span class="hljs-attr"><span class="hljs-attr">clearVal</span></span>: [<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'clear'</span></span>], <span class="hljs-attr"><span class="hljs-attr">stationFrom</span></span>: [<span class="hljs-string"><span class="hljs-string">'merge'</span></span>, <span class="hljs-string"><span class="hljs-string">'stationFromInput'</span></span>, <span class="hljs-string"><span class="hljs-string">'selectStationFrom'</span></span>, <span class="hljs-string"><span class="hljs-string">'clearVal'</span></span>], <span class="hljs-attr"><span class="hljs-attr">optionsShown</span></span>: [<span class="hljs-string"><span class="hljs-string">'toggle'</span></span>, <span class="hljs-string"><span class="hljs-string">'stationFromInput'</span></span>, <span class="hljs-string"><span class="hljs-string">'selectStationFrom'</span></span>], }, (state, props, $) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">  : </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">input</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">stationFromInput</span></span></span></span><span class="xml"><span class="hljs-tag">') } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">state.stationFrom</span></span></span></span><span class="xml"><span class="hljs-tag"> }/&gt;</span></span></span><span class="xml"> { state.stationFrom &amp;&amp; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">clear</span></span></span></span><span class="xml"><span class="hljs-tag">') }&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { state.optionsShown &amp;&amp; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"stationFromOptions"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { state.stationFromOptions.map(s =&gt; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">selectStationFrom</span></span></span></span><span class="xml"><span class="hljs-tag">', </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag">) }&gt;</span></span></span><span class="xml">{ s }</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">) } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">); });</span></span></code> </pre><br>  Maintenant, notre cellule <b>stationFrom</b> , qui est responsable du contenu du texte dans le champ de saisie, collecte ses valeurs non pas à partir de deux, mais à partir de trois flux.  Ce code peut être simplifié.  La construction mrr de la forme [* formule *, * ... arguments de cellule *] est similaire aux expressions S en Lisp, et comme en Lisp, vous pouvez imbriquer arbitrairement de telles constructions les unes dans les autres. <br><br>  Débarrassons-nous de la cellule clearVal inutile et raccourcissons le code: <br><br><pre> <code class="javascript hljs"> stationFrom: [<span class="hljs-string"><span class="hljs-string">'merge'</span></span>, <span class="hljs-string"><span class="hljs-string">'stationFromInput'</span></span>, <span class="hljs-string"><span class="hljs-string">'selectStationFrom'</span></span>, [<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'clear'</span></span>]],</code> </pre><br>  Les programmes écrits dans un style impératif peuvent être comparés à une équipe mal organisée, où tout le monde se commande constamment quelque chose (je fais allusion aux appels de méthode et aux changements de mutation), de plus, les deux managers sont des subordonnés et vice versa.  Les programmes déclaratifs sont similaires à l'image utopique opposée: un collectif où chacun sait clairement comment il doit agir dans n'importe quelle situation.  Il n'y a pas besoin de commandes dans une telle équipe, tout le monde est à sa place et travaille en réponse à ce qui se passe. <br><br>  Au lieu de décrire toutes les conséquences possibles d'un événement (lire - pour effectuer certaines mutations), nous décrivons tous les cas dans lesquels cet événement peut se produire, c'est-à-dire  quelle valeur la cellule prendra lors de tout changement dans d'autres cellules.  Dans notre petit exemple jusqu'à présent, nous avons décrit la cellule stationFrom et trois situations qui affectent sa valeur.  Pour un programmeur habitué au code impératif, une telle approche peut sembler inhabituelle (voire une «béquille», une «perversion»).  En fait, cela vous permet d'économiser des efforts en raison de la brièveté (et de la stabilité) du code, comme nous le verrons dans la pratique. <br><br>  Et l'asynchronie?  Est-il possible de faire apparaître la liste des stations proposées avec ajax?  Pas de problème!  En substance, peu importe pour mrr que la fonction renvoie une valeur ou une promesse.  Lorsque mrr est retourné, il attend sa résolution et «pousse» les données reçues dans le flux. <br><br><pre> <code class="javascript hljs">stationFromOptions: [<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function"> =&gt;</span></span> fetch(<span class="hljs-string"><span class="hljs-string">'/get_stations?str='</span></span> + str).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function"> =&gt;</span></span> res.toJSON()), <span class="hljs-string"><span class="hljs-string">'stationFromInput'</span></span>],</code> </pre><br>  Cela signifie également que vous pouvez utiliser des fonctions asynchrones comme formules.  Des cas plus complexes (gestion des erreurs, statut de la promesse) seront examinés ultérieurement. <br><br>  La fonctionnalité de choix d'une gare de départ est prête.  Cela n'a aucun sens de reproduire le même pour la gare d'arrivée, il vaut la peine de le mettre dans un composant séparé qui peut être réutilisé.  Ce sera un composant d'entrée généralisé avec auto-complétion, nous allons donc renommer les champs et créer la fonction pour obtenir les options appropriées définies dans les accessoires. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> OptionsInput = withMrr(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function"> =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">$init</span></span>: { <span class="hljs-attr"><span class="hljs-attr">options</span></span>: [], }, <span class="hljs-attr"><span class="hljs-attr">val</span></span>: [<span class="hljs-string"><span class="hljs-string">'merge'</span></span>, <span class="hljs-string"><span class="hljs-string">'valInput'</span></span>, <span class="hljs-string"><span class="hljs-string">'selectOption'</span></span>, [<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'clear'</span></span>]], <span class="hljs-attr"><span class="hljs-attr">options</span></span>: [props.getOptions, <span class="hljs-string"><span class="hljs-string">'val'</span></span>], <span class="hljs-attr"><span class="hljs-attr">optionsShown</span></span>: [<span class="hljs-string"><span class="hljs-string">'toggle'</span></span>, <span class="hljs-string"><span class="hljs-string">'valInput'</span></span>, <span class="hljs-string"><span class="hljs-string">'selectOption'</span></span>], }), (state, props, $) =&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">input</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">valInput</span></span></span></span><span class="xml"><span class="hljs-tag">') } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">state.val</span></span></span></span><span class="xml"><span class="hljs-tag"> } /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { state.optionsShown &amp;&amp; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"options"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { state.options.map(s =&gt; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">selectOption</span></span></span></span><span class="xml"><span class="hljs-tag">', </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">s</span></span></span></span><span class="xml"><span class="hljs-tag">) }&gt;</span></span></span><span class="xml">{ s }</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">) } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> } { state.val &amp;&amp; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"clear"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">clear</span></span></span></span><span class="xml"><span class="hljs-tag">') }&gt;</span></span></span><span class="xml"> X </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">)</span></span></code> </pre><br>  Comme vous pouvez le voir, vous pouvez spécifier la structure des cellules mrr en fonction du composant props (cependant, elle ne sera exécutée qu'une seule fois - lors de l'initialisation, et ne répondra pas aux changements dans les props). <br><br><h3>  Communication entre composants </h3><br>  Connectez maintenant ce composant au composant parent et voyez comment mrr permet aux composants liés d'échanger des données. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getMatchedStations = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">str</span></span></span><span class="hljs-function"> =&gt;</span></span> fetch(<span class="hljs-string"><span class="hljs-string">'/get_stations?str='</span></span> + str).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function"> =&gt;</span></span> res.toJSON()); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Tickets = withMrr({ <span class="hljs-attr"><span class="hljs-attr">stationTo</span></span>: <span class="hljs-string"><span class="hljs-string">'selectStationFrom/val'</span></span>, <span class="hljs-attr"><span class="hljs-attr">stationFrom</span></span>: <span class="hljs-string"><span class="hljs-string">'selectStationTo/val'</span></span>, }, (state, props, $, connectAs) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (&lt;div&gt; &lt;OptionsInput { ...connectAs('selectStationFrom') } getOptions={ getMatchedStations } /&gt; - &lt;OptionsInput { ...connectAs('selectStationTo') } getOptions={ getMatchedStations } /&gt; &lt;input type="date" onChange={ $('date') } /&gt; &lt;button onClick={ $('searchTrains') }&gt;&lt;/button&gt; &lt;/div&gt;); });</code> </pre><br>  Pour associer un composant parent à un composant enfant, nous devons lui passer des paramètres à l'aide de la fonction <b>connectAs</b> (quatrième argument de la fonction de rendu).  Dans ce cas, nous indiquons le nom que nous voulons donner au composant enfant.  En attachant un composant de cette manière, par ce nom, nous pouvons accéder à ses cellules.  Dans ce cas, nous écoutons les cellules val.  L'inverse est également possible - écoutez à partir du composant enfant de la cellule parent. <br><br>  Comme vous pouvez le voir, ici mrr suit une approche déclarative: aucun rappel onChange n'est nécessaire, nous avons juste besoin de spécifier un nom pour le composant enfant dans la fonction connectAs, après quoi nous avons accès à ses cellules!  Dans ce cas, toujours en raison de la déclarativité, il n'y a aucune menace d'interférence dans le travail d'un autre composant - nous n'avons pas la possibilité de «changer» quoi que ce soit, de muter, nous ne pouvons qu'écouter les données. <br><br><h3>  Signaux et valeurs </h3><br>  L'étape suivante est la recherche de trains adaptés aux paramètres sélectionnés.  Dans l'approche impérative, nous écririons probablement un certain processeur pour soumettre le formulaire onSubmit, qui lancerait d'autres actions - une demande ajax et l'affichage des résultats.  Mais, comme vous vous en souvenez, nous ne pouvons rien "commander"!  Nous ne pouvons créer qu'un autre ensemble de cellules dérivées des cellules du formulaire.  Écrivons une autre demande. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getTrains = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to, date</span></span></span><span class="hljs-function">) =&gt;</span></span> fetch(<span class="hljs-string"><span class="hljs-string">'/get_trains?from='</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> + <span class="hljs-string"><span class="hljs-string">'&amp;to='</span></span> + to + <span class="hljs-string"><span class="hljs-string">'&amp;date='</span></span> + date).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function"> =&gt;</span></span> res.toJSON()); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Tickets = withMrr({ <span class="hljs-attr"><span class="hljs-attr">stationFrom</span></span>: <span class="hljs-string"><span class="hljs-string">'selectStationFrom/val'</span></span>, <span class="hljs-attr"><span class="hljs-attr">stationTo</span></span>: <span class="hljs-string"><span class="hljs-string">'selectStationTo/val'</span></span>, <span class="hljs-attr"><span class="hljs-attr">results</span></span>: [getTrains, <span class="hljs-string"><span class="hljs-string">'stationFrom'</span></span>, <span class="hljs-string"><span class="hljs-string">'stationTo'</span></span>, <span class="hljs-string"><span class="hljs-string">'date'</span></span>, <span class="hljs-string"><span class="hljs-string">'searchTrains'</span></span>], }, (state, props, $, connectAs) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (&lt;div&gt; &lt;OptionsInput { ...connectAs('selectStationFrom') } getOptions={ getMatchedStations } /&gt; - &lt;OptionsInput { ...connectAs('selectStationTo') } getOptions={ getMatchedStations } /&gt; &lt;input type="date" onChange={ $('date') } /&gt; &lt;button onClick={ $('searchTrains') }&gt;&lt;/button&gt; &lt;/div&gt;); });</code> </pre><br>  Cependant, un tel code ne fonctionnera pas comme prévu.  Le calcul (recalcul de la valeur de la cellule) est lancé lorsque l'un des arguments change, de sorte que la demande sera envoyée, par exemple, immédiatement après avoir sélectionné la première station, et pas seulement en cliquant sur «Rechercher».  Nous avons besoin, d'une part, que les stations et la date soient passées dans les arguments de la formule, mais d'autre part, ne répondent pas à leur changement.  Dans mrr, il existe un mécanisme élégant pour cette écoute dite passive. <br><br><pre> <code class="javascript hljs"> results: [getTrains, <span class="hljs-string"><span class="hljs-string">'-stationFrom'</span></span>, <span class="hljs-string"><span class="hljs-string">'-stationTo'</span></span>, <span class="hljs-string"><span class="hljs-string">'-date'</span></span>, <span class="hljs-string"><span class="hljs-string">'searchTrains'</span></span>],</code> </pre><br>  Ajoutez juste un moins devant le nom de la cellule, et le tour est joué!  Désormais, les <b>résultats</b> ne répondront qu'aux modifications apportées à la cellule <b>searchTrains</b> . <br><br>  Dans ce cas, la cellule <b>searchTrains</b> agit comme un «signal de cellule», et les cellules de <b>stationFrom</b> et d'autres comme des «valeurs de cellule».  Pour une cellule de signal, seul le moment où les valeurs «circulent» à travers elle est important, et quel type de données ce sera - de toute façon: cela peut être juste vrai, «1» ou autre (dans notre cas, ce seront des objets d'événement DOM )  Pour une cellule de valeur, c'est sa valeur qui est importante, mais en même temps, les moments de son changement ne sont pas significatifs.  Ces deux types de cellules ne s'excluent pas mutuellement: de nombreuses cellules sont à la fois des signaux et des valeurs.  Au niveau de la syntaxe dans mrr, ces deux types de cellules ne diffèrent en aucune façon, mais la compréhension conceptuelle d'une telle différence est très importante lors de l'écriture de code réactif. <br><br><h3>  Fractionnement des flux </h3><br>  Une demande de recherche de sièges dans le train peut prendre un certain temps, nous devons donc montrer le chargeur et également répondre en cas d'erreur.  Il y a déjà peu de promesses pour cette approche par défaut avec résolution automatique. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Tickets = withMrr({ <span class="hljs-attr"><span class="hljs-attr">$init</span></span>: { <span class="hljs-attr"><span class="hljs-attr">results</span></span>: {}, } stationFrom: <span class="hljs-string"><span class="hljs-string">'selectStationFrom/val'</span></span>, <span class="hljs-attr"><span class="hljs-attr">stationTo</span></span>: <span class="hljs-string"><span class="hljs-string">'selectStationTo/val'</span></span>, <span class="hljs-attr"><span class="hljs-attr">searchQuery</span></span>: [<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to, date</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>, to, date }), <span class="hljs-string"><span class="hljs-string">'-stationFrom'</span></span>, <span class="hljs-string"><span class="hljs-string">'-stationTo'</span></span>, <span class="hljs-string"><span class="hljs-string">'-date'</span></span>, <span class="hljs-string"><span class="hljs-string">'searchTrains'</span></span>], <span class="hljs-attr"><span class="hljs-attr">results</span></span>: [<span class="hljs-string"><span class="hljs-string">'nested'</span></span>, (cb, query) =&gt; { cb({ <span class="hljs-attr"><span class="hljs-attr">loading</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }); getTrains(query.from, query.to, query.date) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res</span></span></span><span class="hljs-function"> =&gt;</span></span> cb(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, res)) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> cb(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, err)) .finally(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> cb(<span class="hljs-string"><span class="hljs-string">'loading'</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>)) }, <span class="hljs-string"><span class="hljs-string">'searchQuery'</span></span>], <span class="hljs-attr"><span class="hljs-attr">availableTrains</span></span>: <span class="hljs-string"><span class="hljs-string">'results.data'</span></span>, }, (state, props, $, connectAs) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">&lt;div&gt; &lt;div&gt; &lt;OptionsInput { ...connectAs(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'selectStationFrom'</span></span></span></span></span><span class="hljs-function">) } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getOptions</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getMatchedStations</span></span></span><span class="hljs-function"> } /&gt; - &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OptionsInput</span></span></span><span class="hljs-function"> { ...</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectAs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'selectStationTo'</span></span></span></span></span><span class="hljs-function">) } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getOptions</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getMatchedStations</span></span></span><span class="hljs-function"> } /&gt; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">date</span></span></span><span class="hljs-function">" </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onChange</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'date'</span></span></span></span></span><span class="hljs-function">) } /&gt; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">button</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onClick</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'searchTrains'</span></span></span></span></span><span class="hljs-function">) }&gt;&lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">button</span></span></span><span class="hljs-function">&gt; &lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt; { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">results</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loading</span></span></span><span class="hljs-function"> &amp;&amp; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">className</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loading</span></span></span><span class="hljs-function">"&gt;...&lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt; } { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">results</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> &amp;&amp; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">className</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">"&gt; . ,  .   .&lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt; } { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">availableTrains</span></span></span><span class="hljs-function"> &amp;&amp; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">className</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">results</span></span></span><span class="hljs-function">"&gt; { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">availableTrains</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(train</span></span></span><span class="hljs-function">) =&gt;</span></span> &lt;div /&gt;) } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; } &lt;/</span></span>div&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>); });</code> </pre><br>  L'opérateur <b>imbriqué</b> vous permet de «décomposer» les données en sous-cellules, pour cela, le premier argument de la formule est le rappel, avec lequel vous pouvez «pousser» les données dans la sous-cellule (une ou plusieurs).  Nous avons maintenant des flux distincts qui sont responsables de l'erreur, de l'état de la promesse et des données reçues.  L'opérateur imbriqué est un outil très puissant et l'un des rares impératifs de mrr (nous précisons nous-mêmes dans quelles cellules mettre les données).  Alors que l'opérateur de fusion fusionne plusieurs threads en un seul, l'imbrication divise le thread en plusieurs sous-threads, ce qui est donc l'opposé. <br><br>  L'exemple ci-dessus est une façon standard de travailler avec des promesses, dans mrr, il est généralisé en tant qu'opérateur de promesse et vous permet de raccourcir le code: <br><br><pre> <code class="javascript hljs"> results: [<span class="hljs-string"><span class="hljs-string">'promise'</span></span>, (query) =&gt; getTrains(query.from, query.to, query.date), <span class="hljs-string"><span class="hljs-string">'searchQuery'</span></span>], <span class="hljs-comment"><span class="hljs-comment">//     availableTrains: 'results.data',</span></span></code> </pre><br>  De plus, l'opérateur de promesse s'assure que seuls les résultats de la promesse la plus récente sont utilisés. <br><br><img src="https://habrastorage.org/webt/in/ew/2d/inew2diajzwvzh6lzcie3saledw.gif"><br><br>  Composant pour afficher les sièges disponibles (pour plus de simplicité nous refuserons de différents types de voitures) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TrainSeats = withMrr({ <span class="hljs-attr"><span class="hljs-attr">selectSeats</span></span>: [<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">seatsNumber, { id }</span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(seatsNumber)).fill(<span class="hljs-literal"><span class="hljs-literal">true</span></span>).map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">trainId</span></span>: id })), <span class="hljs-string"><span class="hljs-string">'-seatsNumber'</span></span>, <span class="hljs-string"><span class="hljs-string">'-$props'</span></span>, <span class="hljs-string"><span class="hljs-string">'select'</span></span>], <span class="hljs-attr"><span class="hljs-attr">seatsNumber</span></span>: [<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'selectSeats'</span></span>], }, (state, props, $) =&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"train"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">  №{ props.num } { props.from } - { props.to }.   : { props.seats || 0 } { props.seats &amp;&amp; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">     : </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">input</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"number"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">seatsNumber</span></span></span></span><span class="xml"><span class="hljs-tag">') } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">state.seatsNumber</span></span></span></span><span class="xml"><span class="hljs-tag"> || </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">max</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">props.seats</span></span></span></span><span class="xml"><span class="hljs-tag"> } /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span></span><span class="xml"><span class="hljs-tag">') }&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">);</span></span></code> </pre><br>  Pour accéder aux accessoires dans une formule, vous pouvez vous abonner à la boîte spéciale $ props. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Tickets = withMrr({ ... selectedSeats: <span class="hljs-string"><span class="hljs-string">'*/selectSeats'</span></span>, }, (state, props, $, connectAs) =&gt; { ... &lt;div className=<span class="hljs-string"><span class="hljs-string">"results"</span></span>&gt; { state.availableTrains.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">train, i</span></span></span><span class="hljs-function">) =&gt;</span></span> &lt;TrainSeats key={i} {...train} {...connectAs(<span class="hljs-string"><span class="hljs-string">'train'</span></span> + i)}/&gt;) } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; }</span></span></code> </pre><br>  Nous utilisons à nouveau l'écoute passive pour capter le nombre de lieux sélectionnés lorsque vous cliquez sur le bouton "Sélectionner".  Nous associons chaque composant enfant au parent à l'aide de la fonction connectAs.  L'utilisateur peut sélectionner des sièges dans l'un des trains proposés, nous écoutons donc les changements dans tous les composants enfants en utilisant le masque "*". <br><br>  Mais voici le problème: l'utilisateur peut ajouter des sièges d'abord dans un train, puis dans un autre, de sorte que les nouvelles données broyeront les précédentes.  Comment «accumuler» des données de flux?  Pour ce faire, il existe un opérateur de <b>fermeture</b> qui, avec l'emboîtement et l'entonnoir, forme la base de mrr (tous les autres ne sont rien d'autre que du sucre syntaxique basé sur ces trois). <br><br><pre> <code class="javascript hljs"> selectedSeats: [<span class="hljs-string"><span class="hljs-string">'closure'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> seats = []; <span class="hljs-comment"><span class="hljs-comment">//     return selectedSeats =&gt; { seats = [...seats, selectedSeats]; return seats; } }, '*/selectSeats'],</span></span></code> </pre><br>  Lorsque vous utilisez la <b>fermeture en</b> premier (sur componentDidMount), une fermeture est créée qui renvoie la formule.  Elle a ainsi accès aux variables de fermeture.  Cela vous permet de sauvegarder les données entre les appels de manière sûre - sans glisser dans l'abîme des variables globales et de l'état mutable partagé.  Ainsi, la fermeture vous permet d'implémenter les fonctionnalités des opérateurs Rx tels que scan et autres.  Cependant, cette méthode est bonne pour les cas difficiles.  Si nous avons seulement besoin de sauvegarder la valeur d'une variable, nous pouvons simplement utiliser le lien vers la valeur précédente de la cellule en utilisant le nom spécial "^": <br><br><pre> <code class="javascript hljs"> selectedSeats: [<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">seats, prev</span></span></span><span class="hljs-function">) =&gt;</span></span> [...seats, ...prev], <span class="hljs-string"><span class="hljs-string">'*/selectSeats'</span></span>, <span class="hljs-string"><span class="hljs-string">'^'</span></span>]</code> </pre><br>  L'utilisateur doit maintenant saisir un prénom et un nom pour chaque ticket sélectionné. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SeatDetails = withMrr({}, (state, props, $) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">&lt;div&gt; { props.trainId } &lt;input name=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"name"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value={ props.name } onChange={ $(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'setDetails'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, e =&gt; [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'name'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, e.target.value, props.i]</span></span></span><span class="hljs-function">) } /&gt; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">surname</span></span></span><span class="hljs-function">" </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">props</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">surname</span></span></span><span class="hljs-function"> } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onChange</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'setDetails'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, e =&gt; [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'surname'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, e.target.value, props.i]</span></span></span><span class="hljs-function">) }/&gt; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">href</span></span></span><span class="hljs-function">="#" </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onClick</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'removeSeat'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, props.i</span></span></span><span class="hljs-function">) }&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">X</span></span></span><span class="hljs-function">&lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a</span></span></span><span class="hljs-function">&gt; &lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt;); }) </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">const</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Tickets</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">withMrr</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ $init: { results: {}, selectedSeats: [], } stationFrom: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'selectStationFrom/val'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, stationTo: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'selectStationTo/val'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, searchQuery: [(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, to, date</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>, to, date }), <span class="hljs-string"><span class="hljs-string">'-stationFrom'</span></span>, <span class="hljs-string"><span class="hljs-string">'-stationTo'</span></span>, <span class="hljs-string"><span class="hljs-string">'-date'</span></span>, <span class="hljs-string"><span class="hljs-string">'searchTrains'</span></span>], <span class="hljs-attr"><span class="hljs-attr">results</span></span>: [<span class="hljs-string"><span class="hljs-string">'promise'</span></span>, (query) =&gt; getTrains(query.from, query.to, query.date), <span class="hljs-string"><span class="hljs-string">'searchQuery'</span></span>], <span class="hljs-attr"><span class="hljs-attr">availableTrains</span></span>: <span class="hljs-string"><span class="hljs-string">'results.data'</span></span>, <span class="hljs-attr"><span class="hljs-attr">selectedSeats</span></span>: [<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">seats, prev</span></span></span><span class="hljs-function">) =&gt;</span></span> [...seats, ...prev], <span class="hljs-string"><span class="hljs-string">'*/selectSeats'</span></span>, <span class="hljs-string"><span class="hljs-string">'^'</span></span>] }, (state, props, $, connectAs) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">&lt;div&gt; &lt;div&gt; &lt;OptionsInput { ...connectAs(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'selectStationFrom'</span></span></span></span></span><span class="hljs-function">) } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getOptions</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getMatchedStations</span></span></span><span class="hljs-function"> } /&gt; - &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OptionsInput</span></span></span><span class="hljs-function"> { ...</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectAs</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'selectStationTo'</span></span></span></span></span><span class="hljs-function">) } </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getOptions</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getMatchedStations</span></span></span><span class="hljs-function"> } /&gt; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">date</span></span></span><span class="hljs-function">" </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onChange</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'date'</span></span></span></span></span><span class="hljs-function">) } /&gt; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">button</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onClick</span></span></span><span class="hljs-function">={ </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'searchTrains'</span></span></span></span></span><span class="hljs-function">) }&gt;&lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">button</span></span></span><span class="hljs-function">&gt; &lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt; { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">results</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loading</span></span></span><span class="hljs-function"> &amp;&amp; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">className</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">loading</span></span></span><span class="hljs-function">"&gt;...&lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt; } { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">results</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> &amp;&amp; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">className</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function">"&gt; . ,  .   .&lt;/</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function">&gt; } { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">availableTrains</span></span></span><span class="hljs-function"> &amp;&amp; &lt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">div</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">className</span></span></span><span class="hljs-function">="</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">results</span></span></span><span class="hljs-function">"&gt; { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">availableTrains</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(train, i</span></span></span><span class="hljs-function">) =&gt;</span></span> &lt;TrainSeats key={i} {...train} {...connectAs(<span class="hljs-string"><span class="hljs-string">'train'</span></span> + i)}/&gt;) } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; } { state.selectedSeats.map((seat, i) =&gt; &lt;SeatDetails key={i} i={i} { ...seat } {...connectAs('seat' + i)}/</span></span>&gt;) } &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; &lt;/</span></span>div&gt;); });</code> </pre><br>  La cellule <b>selectedSeats</b> contient un tableau d'emplacements sélectionnés.  Lorsque l'utilisateur saisit le nom et le prénom de chaque ticket, nous devons modifier les données dans les éléments correspondants du tableau. <br><br><pre> <code class="javascript hljs"> selectedSeats: [<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">seats, details, prev</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ??? }, '*/selectSeats', '*/setDetails', '^']</span></span></code> </pre><br>  L'approche standard ne nous convient pas: dans la formule, nous devons savoir quelle cellule a changé et réagir en conséquence.  L'une des formes de l'opérateur de fusion nous aidera. <br><br><pre> <code class="javascript hljs"> selectedSeats: [<span class="hljs-string"><span class="hljs-string">'merge'</span></span>, { <span class="hljs-string"><span class="hljs-string">'*/selectSeats'</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">seats, prev</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [...prev, ...seats]; }, <span class="hljs-string"><span class="hljs-string">'*/setDetails'</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[field, value, i], prev</span></span></span><span class="hljs-function">) =&gt;</span></span> { prev[i][field] = value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev; }, <span class="hljs-string"><span class="hljs-string">'*/removeSeat'</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, prev</span></span></span><span class="hljs-function">) =&gt;</span></span> { prev.splice(i, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev; }, }, <span class="hljs-string"><span class="hljs-string">'^'</span></span><span class="hljs-comment"><span class="hljs-comment">/*,       */</span></span>],</code> </pre><br>  C'est un peu comme les réducteurs Redux, mais avec une syntaxe plus flexible et plus puissante.  Et vous ne pouvez pas avoir peur de muter le tableau, car seule la formule d'une cellule a le contrôle, respectivement, les modifications parallèles sont exclues (mais les tableaux mutants qui sont passés en arguments ne valent certainement pas la peine). <br><br><h3>  Collections réactives </h3><br>  Le modèle lorsque la cellule stocke et modifie la matrice est très courant.  Toutes les opérations avec le tableau sont de trois types: insérer, modifier, supprimer.  Pour décrire cela, il existe un élégant opérateur <b>coll</b> .  Utilisez-le pour simplifier le calcul des <b>sièges sélectionnés</b> . <br><br>  C'était: <br><br><pre> <code class="javascript hljs"> selectedSeats: [<span class="hljs-string"><span class="hljs-string">'merge'</span></span>, { <span class="hljs-string"><span class="hljs-string">'*/selectSeats'</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">seats, prev</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [...prev, ...seats]; }, <span class="hljs-string"><span class="hljs-string">'*/setDetails'</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[field, value, i], prev</span></span></span><span class="hljs-function">) =&gt;</span></span> { prev[i][field] = value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev; }, <span class="hljs-string"><span class="hljs-string">'*/removeSeat'</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, prev</span></span></span><span class="hljs-function">) =&gt;</span></span> { prev.splice(i, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev; }, <span class="hljs-string"><span class="hljs-string">'addToCart'</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> [], }, <span class="hljs-string"><span class="hljs-string">'^'</span></span>]</code> </pre><br>  est devenu: <br><br><pre> <code class="javascript hljs"> selectedSeats: [<span class="hljs-string"><span class="hljs-string">'coll'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: <span class="hljs-string"><span class="hljs-string">'*/selectSeats'</span></span>, <span class="hljs-attr"><span class="hljs-attr">update</span></span>: <span class="hljs-string"><span class="hljs-string">'*/setDetails'</span></span>, <span class="hljs-attr"><span class="hljs-attr">delete</span></span>: [<span class="hljs-string"><span class="hljs-string">'merge'</span></span>, <span class="hljs-string"><span class="hljs-string">'*/removeSeat'</span></span>, [<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> ({}), <span class="hljs-string"><span class="hljs-string">'addToCart'</span></span>]] }]</code> </pre><br>  cependant, le format des données dans le flux setDetails doit être légèrement modifié: <br><br><pre> <code class="javascript hljs"> &lt;input name=<span class="hljs-string"><span class="hljs-string">"name"</span></span> onChange={ $(<span class="hljs-string"><span class="hljs-string">'setDetails'</span></span>, e =&gt; [{ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: e.target.value }, props.i]) } /&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">input</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"surname"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> $('</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setDetails</span></span></span></span><span class="xml"><span class="hljs-tag">', </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">e</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> [{ surname: e.target.value }, props.i]) }/&gt;</span></span></code> </pre><br>  En utilisant l'opérateur <b>coll</b> , nous décrivons trois threads qui affecteront notre tableau.  Dans ce cas, le flux de <b>création</b> doit contenir les éléments eux-mêmes, qui doivent être ajoutés au tableau (généralement des objets).  Le flux de <b>suppression</b> accepte soit les index des éléments à supprimer (à la fois dans '* / removeSeat') que les masques.  Le masque {} supprimera tous les éléments et, par exemple, le masque {nom: 'Carl'} supprimera tous les éléments portant le nom Carl.  Le flux de <b>mise à jour</b> accepte des paires de valeurs: le changement qui doit être fait avec l'élément (masque ou fonction), et l'index ou le masque des éléments qui doivent être modifiés.  Par exemple, [{patronyme: 'Johnson'}, {}] définira le nom de famille Johnson sur tous les éléments du tableau. <br><br>  L'opérateur coll utilise quelque chose comme un langage de requête interne, ce qui facilite le travail avec les collections et le rend plus déclaratif. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le code complet de</a> notre application dans JsFiddle. <br><br>  Nous nous sommes familiarisés avec presque toutes les fonctionnalités de base nécessaires de mrr.  Un sujet assez important qui est resté par-dessus bord est la gestion de patrimoine mondiale, qui pourra être discutée dans de futurs articles.  Mais maintenant, vous pouvez commencer à utiliser mrr pour gérer l'état à l'intérieur d'un composant ou d'un groupe de composants associés. <br><br><h3>  Conclusions </h3><br><h4>  Quelle est la puissance de mrr? </h4><br>  mrr vous permet d'écrire des applications dans React dans un style fonctionnel-réactif (mrr peut être déchiffré comme Make React Reactive).  mrr est très expressif - vous passez moins de temps à écrire des lignes de code. <br><br>  mrr fournit un petit ensemble d'abstractions de base, ce qui est suffisant pour tous les cas - cet article décrit presque toutes les principales caractéristiques et techniques de mrr.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe également des outils pour étendre cet ensemble de base (la possibilité de créer des opérateurs personnalisés). Vous pouvez écrire un beau code déclaratif sans lire des centaines de pages du manuel et sans même étudier les profondeurs théoriques de la programmation fonctionnelle - il est peu probable que vous ayez à utiliser, disons, des monades, car mrr lui-même est une monade géante qui sépare le calcul pur des mutations d'état.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alors que dans d'autres bibliothèques, des approches hétérogènes (impératives à l'aide de méthodes et déclaratives à l'aide de liants réactifs) coexistent souvent, dont le programmeur mélange au hasard «salade», dans mrr il y a une seule essence de base - un flux, qui contribue à l'homogénéité et à l'uniformité du code. </font><font style="vertical-align: inherit;">Confort, commodité, simplicité, gain de temps pour un programmeur sont les principaux avantages de mrr (à partir d'ici, un autre décodage de mrr en «mrrrr», c'est-à-dire ronronner un chat satisfait de la vie d'un chat).</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quels sont les inconvénients? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La programmation avec des "lignes" a ses avantages et ses inconvénients. </font><font style="vertical-align: inherit;">Vous ne pourrez pas saisir automatiquement le nom de la cellule ni rechercher l'endroit où elle est définie. </font><font style="vertical-align: inherit;">D'autre part, dans mrr, il y a toujours un et un seul endroit où le comportement de la cellule est déterminé, et il est facile de le trouver avec une simple recherche de texte, tout en recherchant l'endroit où la valeur du champ Redux du magasin est déterminée, ou encore moins le champ d'état lors de l'utilisation de l'ensemble natif. peut être plus long.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Qui pourrait être intéressé par cela? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, les adeptes de la programmation fonctionnelle sont des personnes pour qui l'avantage d'une approche déclarative est évident. </font><font style="vertical-align: inherit;">Bien sûr, les solutions casher ClojureScript existent déjà, mais elles restent un produit de niche, tandis que React gouverne la balle. </font><font style="vertical-align: inherit;">Si votre projet utilise déjà Redux, vous pouvez commencer à utiliser mrr pour gérer l'état local et éventuellement basculer sur global. </font><font style="vertical-align: inherit;">Même si vous ne comptez pas utiliser de nouvelles technologies pour le moment, vous pouvez traiter avec mrr afin de "vous étirer le cerveau" en regardant les tâches familières sous un nouveau jour, car mrr est significativement différent des bibliothèques de gestion d'état courantes.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cela peut-il déjà être utilisé? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En principe, oui :) La bibliothèque est jeune, jusqu'à présent elle a été activement utilisée sur plusieurs projets, mais l'API de la fonctionnalité de base a déjà été établie, maintenant le travail se fait principalement sur différentes lotions (sucre syntaxique), conçues pour accélérer et faciliter le développement. </font><font style="vertical-align: inherit;">Soit dit en passant, dans les principes de mrr eux-mêmes, il n'y a rien de spécifique à React, il peut être adapté pour une utilisation avec n'importe quelle bibliothèque de composants (React a été choisi en raison du manque de réactivité intégrée ou d'une bibliothèque généralement acceptée pour cela). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Merci de votre attention, je serai reconnaissant pour les commentaires et critiques constructives!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428870/">https://habr.com/ru/post/fr428870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428858/index.html">Conférence DEFCON 17. Riez de vos virus! Partie 1</a></li>
<li><a href="../fr428860/index.html">Conférence DEFCON 17. Riez de vos virus! 2e partie</a></li>
<li><a href="../fr428864/index.html">Rendons le Web encore meilleur</a></li>
<li><a href="../fr428866/index.html">7 principes de design, attitude face aux tendances du design, portfolio UX-designer, ...</a></li>
<li><a href="../fr428868/index.html">Fichiers JAR à plusieurs versions - mauvais ou bon?</a></li>
<li><a href="../fr428872/index.html">L'histoire d'un œil et de 20 opérations (non lisible) ou il voulait être pilote, mais il n'était pas autorisé à voler dans le ciel</a></li>
<li><a href="../fr428876/index.html">Il n'y a pas de retour en arrière: l'expérience personnelle du testeur</a></li>
<li><a href="../fr428878/index.html">Pig Flight, ou optimisation des interprètes Bytecode</a></li>
<li><a href="../fr428880/index.html">Nouvelles méthodes d'authentification - une menace pour la vie privée?</a></li>
<li><a href="../fr428882/index.html">Mobile Yandex. Blitz: nous analysons les tâches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>