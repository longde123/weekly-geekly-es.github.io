<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÖüèæ üîΩ üíª Smart WiFi Lichtschalter üïµüèæ ‚òÑÔ∏è üìí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag, lieber Leser. 
 
 Ein bisschen Text am Anfang. Die Idee eines ‚Äûintelligenten‚Äú Lichtschalters ist √ºberhaupt nicht neu, und dies ist wahrsche...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Smart WiFi Lichtschalter</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/393497/"><img src="https://habrastorage.org/files/8cf/a56/9c8/8cfa569c88ff458c8c84c600a6b3c67a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Guten Tag, lieber Leser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein bisschen Text am Anfang. Die Idee eines ‚Äûintelligenten‚Äú Lichtschalters ist √ºberhaupt nicht neu, und dies ist wahrscheinlich das erste, was denjenigen in den Sinn kommt, die mit der Arduino-Plattform und den IoT-Elementen vertraut wurden. Und ich bin keine Ausnahme. Nachdem ich mit Schaltungselementen, Motoren und LEDs experimentiert habe, m√∂chte ich etwas mehr anwenden, das im Alltag gefragt ist und vor allem bequem zu bedienen ist und aus Komfortgr√ºnden nicht Opfer des Experiments bleibt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Artikel werde ich Ihnen erz√§hlen, wie ich einen Schalter gemacht habe, der wie ein normaler funktioniert (dh normalerweise an einer Wand montiert ist) und gleichzeitig die Steuerung √ºber WLAN (oder √ºber das Internet, wie in diesem Fall) erm√∂glicht.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden also eine Liste erstellen, was zur Umsetzung des Plans erforderlich ist. </font><font style="vertical-align: inherit;">Ich muss sofort sagen, dass ich beabsichtigte, mich nicht stark mit Komponenten zu besch√§ftigen und Komponenten auszuw√§hlen, basierend auf dem Feedback in den Foren und dem Preis-Leistungs-Verh√§ltnis. </font><font style="vertical-align: inherit;">Daher scheinen einige Komponenten hier f√ºr erfahrene elektrische Amateure ungeeignet zu sein, aber bitte beurteilen Sie nicht streng, weil </font><font style="vertical-align: inherit;">Ich bin nur neu in der Elektromechanik und w√ºrde mich √ºber Kommentare von erfahreneren Fachleuten sehr freuen.</font></font><br>
<table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nein, nein.</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Name</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beschreibung</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preis</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HLK-PM01</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">220VAC auf 5VDC Adapter</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4,02 ‚Ç¨</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSR-40DA</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halbleiterrelais zur Stromkreisregelung</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3,35 ‚Ç¨</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AMS1117-3.3</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5V bis 3V Spannungsunterdr√ºcker</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,29 ‚Ç¨</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP8266-01</font></font></a></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikrocontroller mit WiFi</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2,35 ‚Ç¨</font></font></td>
</tr>
<tr>
<td colspan="3" align="right"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gesamt:</font></font></b></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11,01 ‚Ç¨</font></font></td>
</tr>
</tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich brauchte auch: einen Server, mit dem der Switch √ºber das Internet gesteuert wird, Arduino Uno, mit dem ich ESP programmiert habe, einen Router und Verbrauchsmaterialien wie Kabel, Terminals usw., all dies kann von Geschmack zu Geschmack variieren und hat keinen Einfluss bis zum Endergebnis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Preise stammen von Ebay, wo ich sie gekauft habe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und so sehen die Elemente aus der Tabelle aus: </font></font><br>
<br>
<img src="https://habrastorage.org/files/1ef/70b/dc9/1ef70bdc91704739b496786442c19517.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt k√∂nnen Sie ein Verbindungsdiagramm erstellen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/eb8/740/8f0/eb87408f0f4743d986dbe39f4abe02b3.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie wahrscheinlich bemerkt haben, ist das Schema sehr einfach. Alles l√§sst sich einfach, schnell und ohne L√∂ten zusammenbauen. Eine Art funktionierender Prototyp, der lange nicht gest√∂rt werden muss. Alles ist durch Dr√§hte und Klemmen verbunden. Der einzige Nachteil ist, dass das Relais nicht in die Buchse des Schalters passt. Ja, urspr√ºnglich wollte ich alles in die Wand hinter dem Schalter schieben, damit es √§sthetisch ansprechend aussieht. Zu meinem Bedauern war jedoch nicht gen√ºgend Platz in der Steckdose und das Relais passte einfach weder in die Seite noch in die Seite: </font></font><br>
<br>
<img src="https://habrastorage.org/files/ce9/090/c6f/ce9090c6ff18427486c49ce2f48570e6.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deshalb nahm ich das Relais vor√ºbergehend aus der Steckdose, bis ich einen geeigneten Schaltkasten mit einer Steckdose fand, um das B√ºgeleisen darin zu verstecken. Aber es gibt nichts Bleibenderes als nur vor√ºbergehend, nicht wahr? Daher sieht das alles jetzt so aus: </font></font><br>
<br>
<img src="https://habrastorage.org/files/69c/45e/792/69c45e79281a4ce8a02bd6cf17ece631.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isolierband sch√ºtzt vor elektrischem Schlag ... Ich hoffe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns nun √ºber den Software-Teil sprechen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor ich mit der Analyse des Codes und der Details fortfahre, werde ich ein allgemeines Diagramm der Implementierung der Lampensteuerung geben. </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/9b7/7cc/efe/9b77ccefe7c84f339fd25435ba3c74f0.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe, dass ich eines Tages alles neu schreiben werde und die Verbindung auf einem schnelleren Protokoll als HTTP basiert, aber zun√§chst einmal wird es funktionieren. </font><font style="vertical-align: inherit;">Aus der Ferne √§ndert die Gl√ºhbirne ihren Zustand in etwa 1 bis 1,5 Sekunden und sofort vom Schalter, wie es sich f√ºr einen anst√§ndigen Schalter geh√∂rt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programmierung ESP8266-01</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der einfachste Weg, dies zu tun, ist mit Arduino. Sie k√∂nnen die erforderlichen Bibliotheken f√ºr die Arduino IDE von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> herunterladen </font><font style="vertical-align: inherit;">. Es gibt alle Installations- und Konfigurationsanweisungen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als n√§chstes m√ºssen wir das ESP an den Computer anschlie√üen. Dazu ben√∂tigen wir entweder einen USB-zu-Seriell-Adapter (wie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FTDi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CH340</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FT232RL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) oder eine beliebige Arduino-Plattform (ich hatte Arduino Uno) mit RX- und TX-Ausg√§ngen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist erw√§hnenswert, dass der ESP8266-01 mit 3,3 Volt betrieben wird, was bedeutet, dass er auf keinen Fall an den Arduino angeschlossen wird, der (oft) mit 5 Volt betrieben wird, da sonst alles direkt zur H√∂lle geht. Sie k√∂nnen den Spannungsreduzierer verwenden, der in der obigen Tabelle gezeigt ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Verbindungsschema ist einfach: Wir verbinden </font></font><abbr title="Sender"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TX</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font><abbr title="Empf√§nger"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RX</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><abbr title="Boden"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ESP zu RX, TX und GND Adapter / Arduino. </font><font style="vertical-align: inherit;">Danach ist die Verbindung tats√§chlich betriebsbereit. </font><font style="vertical-align: inherit;">Der Mikrocontroller kann mit der Arduino IDE programmiert werden. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein paar Nuancen bei der Verwendung von Arduino Uno:</font></font></b> <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uno hat einen Ausgang f√ºr 3,3 V, aber es war nicht genug. </font><font style="vertical-align: inherit;">Wenn Sie ein ESP daran anschlie√üen, scheint alles zu funktionieren, die Anzeigen leuchten, aber die Kommunikation mit dem COM-Port geht verloren. </font><font style="vertical-align: inherit;">Also habe ich ein anderes 3,3-V-Netzteil f√ºr ESP verwendet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dar√ºber hinaus hatte UNO keine Probleme mit der Kommunikation mit ESP, da UNO mit 5 V und ESP mit 3 V betrieben wurde.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach mehreren Experimenten mit ESP8266-01 stellte sich heraus, dass ESPs empfindlich gegen√ºber an GPIO0 und GPIO2 angeschlossenen Spannungen sind. </font><font style="vertical-align: inherit;">Zum Zeitpunkt des Starts sollten sie auf keinen Fall geerdet sein, wenn Sie beabsichtigen, sie im normalen Modus zu starten. </font><font style="vertical-align: inherit;">Weitere Details zum Start des Mikrocontrollers </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ich wusste das nicht und musste die Schaltung leicht √§ndern, weil </font><font style="vertical-align: inherit;">In der ESP-01-Version sind nur diese 2 Pins vorhanden und beide werden in meiner Schaltung verwendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und hier ist das Programm f√ºr ESP selbst:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code anzeigen</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WiFi.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;WiFiClient.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WebServer.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266mDNS.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266HTTPClient.h&gt;</span></span></span></span>
<span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         initVariant</span></span>
  <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user_interface.h"</span></span></span></span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* ssid = <span class="hljs-string"><span class="hljs-string">"WIFISSID"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  WiFi</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* password = <span class="hljs-string"><span class="hljs-string">"***************"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  WiFi</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String self_token = <span class="hljs-string"><span class="hljs-string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String serv_token = <span class="hljs-string"><span class="hljs-string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String name = <span class="hljs-string"><span class="hljs-string">"IOT_lamp"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> String serverIP = <span class="hljs-string"><span class="hljs-string">"192.168.1.111"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  IP WEB  </span></span>
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> lamp_on =  <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> can_toggle = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> button_state;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-function">ESP8266WebServer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">80</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
HTTPClient http; <span class="hljs-comment"><span class="hljs-comment">//  </span></span><font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lamp = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    GPIO2</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> button = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ""   GPIO0</span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello! I am "</span></span> + name);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//    </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleNotFound</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"not found"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOnLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  digitalWrite(lamp, LOW);<font></font>
  lamp_on = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnOffLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  digitalWrite(lamp, HIGH);<font></font>
  lamp_on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     ./.</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span></span>{<font></font>
  http.begin(<span class="hljs-string"><span class="hljs-string">"http://"</span></span>+serverIP+<span class="hljs-string"><span class="hljs-string">"/iapi/setstate"</span></span>);<font></font>
  String post = <span class="hljs-string"><span class="hljs-string">"token="</span></span>+self_token+<span class="hljs-string"><span class="hljs-string">"&amp;state="</span></span>+(state?<span class="hljs-string"><span class="hljs-string">"on"</span></span>:<span class="hljs-string"><span class="hljs-string">"off"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//         </span></span>
  http.addHeader(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> httpCode = http.POST(post);<font></font>
  http.end();  <font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//   </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggleLamp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(lamp_on == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) {<font></font>
    turnOffLamp();<font></font>
    sendServer(<span class="hljs-literal"><span class="hljs-literal">false</span></span>);<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
    turnOnLamp();<font></font>
    sendServer(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String token = server.arg(<span class="hljs-string"><span class="hljs-string">"token"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serv_token != token) {<font></font>
    String message = <span class="hljs-string"><span class="hljs-string">"access denied"</span></span>;<font></font>
    server.send(<span class="hljs-number"><span class="hljs-number">401</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;<font></font>
  }<font></font>
  turnOnLamp();<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"success"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//     </span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleOff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{<font></font>
  String token = server.arg(<span class="hljs-string"><span class="hljs-string">"token"</span></span>);
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serv_token != token) {<font></font>
    String message = <span class="hljs-string"><span class="hljs-string">"access denied"</span></span>;<font></font>
    server.send(<span class="hljs-number"><span class="hljs-number">401</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;<font></font>
  }<font></font>
  turnOffLamp();<font></font>
  String message = <span class="hljs-string"><span class="hljs-string">"success"</span></span>;<font></font>
  server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//  MAC    IP</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initVariant</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> mac[<span class="hljs-number"><span class="hljs-number">6</span></span>] = {<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xA3</span></span>, <span class="hljs-number"><span class="hljs-number">0xA0</span></span>, <span class="hljs-number"><span class="hljs-number">0x1C</span></span>, <span class="hljs-number"><span class="hljs-number">0x8C</span></span>, <span class="hljs-number"><span class="hljs-number">0x45</span></span>};<font></font>
  wifi_set_macaddr(STATION_IF, &amp;mac[<span class="hljs-number"><span class="hljs-number">0</span></span>]);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{<font></font>
  pinMode(lamp, OUTPUT);<font></font>
  pinMode(button, INPUT_PULLUP); <span class="hljs-comment"><span class="hljs-comment">//   INPUT_PULLUP</span></span><font></font>
  turnOffLamp();<font></font>
  WiFi.hostname(name);<font></font>
  WiFi.begin(ssid, password);<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//     WiFi</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (WiFi.status() != WL_CONNECTED) {<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
  server.on(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handleRoot);<font></font>
  server.on(<span class="hljs-string"><span class="hljs-string">"/on"</span></span>,  HTTP_POST, handleOn);<font></font>
  server.on(<span class="hljs-string"><span class="hljs-string">"/off"</span></span>, HTTP_POST, handleOff);<font></font>
  server.onNotFound(handleNotFound);<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//  </span></span><font></font>
  server.begin();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{<font></font>
  server.handleClient();<font></font>
<font></font>
  <span class="hljs-comment"><span class="hljs-comment">//   </span></span><font></font>
  button_state = digitalRead(button);<font></font>
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (button_state == HIGH &amp;&amp; can_toggle) {<font></font>
    toggleLamp();<font></font>
    can_toggle = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
    delay(<span class="hljs-number"><span class="hljs-number">500</span></span>);<font></font>
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(button_state == LOW){<font></font>
    can_toggle = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ein paar Kommentare zum Code:</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist sehr wichtig, den Pin GPIO0 als pinMode (button, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">INPUT_PULLUP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">zu deklarieren </font><font style="vertical-align: inherit;">, weil </font><font style="vertical-align: inherit;">In der Schaltung verwenden wir keinen Widerstand f√ºr diese Taste. </font><font style="vertical-align: inherit;">Und ESP hat genau f√ºr diese Zwecke ein eigenes "eingen√§ht".</font></font></li>
<li>               .</li>
</ul><br>
<h2> WEB </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier k√∂nnen Sie Ihrer Fantasie freien Lauf lassen und mit allen verf√ºgbaren Mitteln einen Dienst erstellen, der vom Switch gesendete Anforderungen verarbeitet und Anforderungen zum Ein- und Ausschalten sendet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yii</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> f√ºr diesen Zweck verwendet </font><font style="vertical-align: inherit;">. Ich habe mich aus mehreren Gr√ºnden f√ºr dieses Framework entschieden. Ich ben√∂tigte eine Autorisierung (da das Portal im Internet verf√ºgbar ist) und ein Rollenmanagement (f√ºr zuk√ºnftige Experimente) und es gef√§llt mir einfach. Und jetzt sieht mein Verwaltungsportal folgenderma√üen aus: </font></font><br>
<br>
<img src="https://habrastorage.org/files/119/cb0/e72/119cb0e72f4845f8a6cac74fc856787a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Gl√ºhbirne in der Netzwerkreichweite zu steuern, w√ºrde der Server selbst auf dem ESP ausreichen. Sie m√∂chten jedoch in Zukunft wirklich Protokolle, Logik und andere Ger√§te haben. Daher ist es besser, weiterhin einen separaten Server f√ºr die Verwaltung zu verwenden.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hier dreht sich alles um das Portal. Ich denke, es macht keinen Sinn, mehr dar√ºber zu schreiben. Wenn Sie jedoch Fragen haben, werde ich diese gerne in den Kommentaren beantworten.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anstelle einer Schlussfolgerung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank, wenn Sie den Artikel bis zum Ende gelesen und vielleicht etwas N√ºtzliches darin gefunden haben. </font><font style="vertical-align: inherit;">Ich werde gerne beraten und kritisieren. </font><font style="vertical-align: inherit;">Im Allgemeinen scheint es mir immer noch, dass der Engpass in der Schaltung der 5-V-Adapter ist, und ich w√ºrde mich freuen, wenn Sie Ihre Erfahrungen bei der L√∂sung solcher Probleme teilen. </font><font style="vertical-align: inherit;">Was den ESP8266-01 betrifft, so wurden bisher keine Beschwerden von mir vorgebracht, mit Ausnahme der besonderen Verwendung der GPIO-Pins. </font><font style="vertical-align: inherit;">Es hat die zweite Woche stabil funktioniert. </font><font style="vertical-align: inherit;">Erfolg in den Projekten.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de393497/">https://habr.com/ru/post/de393497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de393485/index.html">100.000 Lumen wassergek√ºhlte DIY LED-Taschenlampe</a></li>
<li><a href="../de393487/index.html">Turbotrockner: Eine einfache M√∂glichkeit, nasse Schuhe, Socken oder Kleidung schnell zu trocknen</a></li>
<li><a href="../de393491/index.html">Die wundersch√∂nen sieben erschwinglichen Novelty-Roller</a></li>
<li><a href="../de393493/index.html">–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≠—Ä–∏–∫–∞ ‚Äî –ø–µ—Ä–≤–æ–≥–æ –≥–æ–≤–æ—Ä—è—â–µ–≥–æ —Ä–æ–±–æ—Ç–∞ –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏</a></li>
<li><a href="../de393495/index.html">Ein Mann ist im Gef√§ngnis, weil er den Inhalt der Festplatte nicht entschl√ºsseln konnte</a></li>
<li><a href="../de393505/index.html">Xiaomi mi Band2 leuchtete "versehentlich" auf der Hand des CEO auf</a></li>
<li><a href="../de393507/index.html">Projekt "Auge" Teil 21</a></li>
<li><a href="../de393509/index.html">Craig Wright versucht weiterhin, sich als der Sch√∂pfer von Bitcoin auszugeben</a></li>
<li><a href="../de393513/index.html">Die Wahrscheinlichkeit des Aussterbens der Menschheit wurde auf 0,1% pro Jahr gesch√§tzt</a></li>
<li><a href="../de393515/index.html">Die PrivatBank begann mit dem Verkauf von Solent</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>