<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍰 🛀 🤙🏼 Comment faire des e-mails et ne pas gâcher: conseils pratiques 👰🏿 👈 🧘🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le développeur, qui a rencontré pour la première fois la génération d'e-mails, n'a pratiquement aucune chance d'écrire une application qui le fera cor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment faire des e-mails et ne pas gâcher: conseils pratiques</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/419591/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/le/ph/rs/lephrsp-4zc6zhbbo-fgmhcceec.jpeg" height="500"></div><br>  Le développeur, qui a rencontré pour la première fois la génération d'e-mails, n'a pratiquement aucune chance d'écrire une application qui le fera correctement.  Environ 40% des e-mails générés par les applications d'entreprise ont une sorte de violation des normes et, par conséquent, des problèmes de livraison et d'affichage.  Il y a des raisons à cela: le courrier électronique est techniquement beaucoup plus compliqué que le Web, le courrier est réglementé par plusieurs centaines de normes et un nombre incalculable de pratiques généralement acceptées (et pas ainsi), et les clients de messagerie sont divers et imprévisibles.  Les tests peuvent améliorer considérablement la situation, mais il n'y a pratiquement aucun matériel consacré au test du courrier. <br><br>  Mail.Ru mail interagit régulièrement avec ses utilisateurs via des e-mails.  Dans notre projet, tous les composants qui sont responsables de la génération des e-mails, et même des envois uniques, subissent des tests obligatoires.  Dans cet article, nous partagerons notre expérience (et plein de bosses). <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Que sont les e-mails</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Qui est impliqué dans le processus de test et de contrôle</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Courrier et transport postal</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'interface de l'infrastructure de messagerie et les limites de l'application testée</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Définition des paramètres testés</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Structure typique d'une application génératrice</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Quoi et quand tester</a> <br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Infrastructure de livraison</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Génération d'une application</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Modèles de lettres structurelles et de mise en page</a> </li></ol></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exigences de base pour vérifier l'infrastructure</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conditions d'autorisation</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vérification de l'application génératrice</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exigences d'adresse postale</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exigences de l'en-tête de l'e-mail</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conditions requises pour la structure de la lettre</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exigences d'URI</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exigences de mise en page</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Réalisation de tests fractionnés</a> </li></ul><br><a name="habracut"></a><br><a name="1"></a><h2>  Que sont les e-mails </h2><br>  L'application peut générer différents types de lettres.  Ils peuvent être classés en plusieurs catégories.  Par la méthode de sélection des destinataires: déclencheur - sélectif - groupe.  Sur rendez-vous: transactionnel - marketing - service.  Différents types de lettres peuvent avoir des exigences différentes et appliquer différents scripts de test. <br><br>  Les e-mails de déclenchement sont générés en réponse à tout événement, par exemple, les actions de l'utilisateur ou les modifications de l'état des objets système.  Ils sont générés par l'application, et donc les plus intéressants en termes de tests.  Les e-mails de déclenchement peuvent être à la fois transactionnels et marketing. <br><br>  Des lettres personnalisées sont envoyées à une sélection dynamique d'utilisateurs correspondant à tous les critères. <br><br>  Les messages de groupe sont envoyés à un groupe connu de destinataires, par exemple, à tous les utilisateurs ou partenaires.  Les lettres sélectives et de groupe sont le plus souvent du marketing, l'envoi de ces lettres est initié manuellement ou selon un calendrier. <br><br>  Des lettres transactionnelles sont générées lorsqu'un utilisateur effectue une action.  Ces lettres comprennent, par exemple, des factures, des tickets ou des notifications d'état de livraison, des lettres avec un code de récupération d'accès, etc.  Les e-mails transactionnels sont toujours déclenchés.  Une compatibilité maximale est importante pour eux, ce qui signifie qu'ils doivent être aussi simples que possible et qu'ils doivent être testés sur un grand nombre de clients. <br><br>  Les lettres marketing encouragent l'utilisateur à entreprendre n'importe quelle action, par exemple, il peut s'agir d'une offre de remises individuelles basée sur des achats antérieurs.  Dans ces lettres, des données transactionnelles peuvent être utilisées, elles peuvent être à la fois déclenchées et massives - périodiques ou ponctuelles.  Pour ces lettres, l'efficacité est plus importante, elle est généralement déterminée par les résultats d'un test fractionné.  Certains aspects de la compatibilité peuvent être sacrifiés pour l'efficacité. <br><br>  Les lettres de marketing de groupe, par exemple, les messages sur les offres saisonnières, les promotions et les ventes, sont souvent envoyées «manuellement» et ne font pas partie de votre application, mais vous pouvez (et devez) leur appliquer des principes de test généraux. <br><br>  De plus, il peut y avoir des lettres de service générées par les employés pour les systèmes CRM, journalisation, audit ou DWH automatisés ou automatisés.  Ces lettres sont déclenchées, ce qui signifie qu'elles font également partie de l'application et doivent être testées. <br><br><a name="2"></a><h2>  Qui est impliqué dans le processus de test et de contrôle </h2><br><ol><li>  Ingénieur AQ - participe à toutes les étapes du processus. </li><li>  Ingénieur réseau - Responsable de la configuration du réseau et de l'infrastructure de messagerie.  Un ingénieur réseau doit être impliqué dans la planification des tests d'infrastructure. </li><li>  Un spécialiste de la délivrabilité est une personne qui surveille la livraison des lettres, qui participe également à la surveillance des paramètres techniques et administratifs de tous les messages envoyés et surveille l'avancement du processus d'envoi.  Il est responsable de s'assurer que les lettres envoyées atteignent le pourcentage maximum possible d'utilisateurs et ne tombent pas dans le spam, et pour cela le spécialiste doit avoir certaines connaissances et contacts.  Si des problèmes surviennent avec la remise des lettres, c'est lui qui doit comprendre la cause probable et l'éliminer: soit en éliminant les obstacles techniques;  ou changer quelque chose dans le contenu des lettres;  ou résoudre le problème avec le service d'assistance du fournisseur de messagerie, auquel les lettres ne parviennent pas.  Un tel spécialiste (le cas échéant) devrait également être impliqué dans la préparation d'une liste de contrôle et le test de l'infrastructure qui génère les applications et les lettres.  Cependant, le processus de test lui-même doit être sous le contrôle du service QA. </li><li>  Marketing par e-mail - détermine l'efficacité des campagnes marketing.  Sous son contrôle, le fractionnement des tests pour le public nécessaire aux mailings marketing a lieu.  Le marketing par e-mail contrôle également la segmentation de la base d'utilisateurs, la composition et la fréquence des e-mails envoyés et la «présentation» visuelle de l'e-mail à l'utilisateur. </li></ol><br>  Tous ces rôles ne sont pas nécessairement assumés par un employé distinct: le rôle d'un responsable marketing peut être joué par l'un des chefs de produit, et le rôle d'un spécialiste de la délivrabilité peut être joué, par exemple, par un employé de support ou un ingénieur réseau.  Et dans les startups avec un degré de probabilité élevé, tout cela devra être fait par une seule personne, et elles peuvent se révéler être un spécialiste de la qualité. <br><br><a name="3"></a><h2>  Courrier et transport postal </h2><br>  La structure du courrier est similaire à un énorme iceberg, et elle a deux niveaux.  Il existe plus d'une centaine de normes différentes régissant le courrier, mais presque toutes appartiennent à l'un de ces deux niveaux: <br><br>  <b>La partie sous-marine de l'iceberg</b> est un service réseau dont le protocole de base est le protocole d'application SMTP, défini par la RFC 5321. Il est responsable de la livraison des lettres.  Pour remettre la lettre, une enveloppe dite SMTP est formée, qui comprend les adresses de l'expéditeur et du récepteur du niveau SMTP.  D'autres services réseau tels que DNS sont également responsables de la remise de la lettre.  Le composant principal de l'infrastructure réseau est l'agent de transfert de courrier, ou l'abréviation MTA est utilisée plus souvent.  MTA est responsable de la gestion de la file d'attente de remise des messages et du processus de remise aux serveurs destinataires.  Les exemples de MTA sont Postfix, Sendmail, Exim, Microsoft SMTP service. <br><br>  Cette partie sous-marine de l'iceberg, qui comprend le MTA, les paramètres DNS et d'autres paramètres de réseau, nous l'appellerons infrastructure de messagerie ou infrastructure de livraison de messages. <br><br>  <b>La surface de l'iceberg</b> est la lettre elle-même.  La structure de base de la lettre est définie dans la RFC 5322. La lettre se compose d'en-têtes de service et d'une ou plusieurs parties avec des données.  Les données peuvent contenir du texte en texte brut et / ou HTML, des images en ligne ou des pièces jointes de presque n'importe quel type. <br><br><a name="4"></a><h2>  L'interface de l'infrastructure de messagerie et les limites de l'application testée </h2><br>  L'infrastructure de messagerie, en règle générale, possède une ou plusieurs interfaces avec lesquelles une lettre est envoyée (elle entre dans la file d'attente de remise du MTA).  Par exemple, le service de soumission SMTP, la fonction <code>mail()</code> en PHP, le transfert de données vers une application de messagerie externe ou sendmail, l'API de services internes ou externes (par exemple, GetResponse, SendPulse ou Amazon SES).  Nous considérerons ces interfaces comme faisant partie de l'infrastructure.  Très souvent, il y a une situation où l'application A prépare des données pour une lettre et une liste de destinataires, puis les transfère à l'application B via son API (pour le marketing de masse, cela peut être fait manuellement via l'interface utilisateur - UI), et déjà l'application B génère un message électronique dans Format RFC 5322 et le met en file d'attente pour la livraison MTA.  Du point de vue de l'application A (et lors de son test), l'application B fera partie de l'infrastructure de messagerie.  L'API ou l'interface utilisateur de l'application B sera l'interface de l'infrastructure de messagerie pour l'application A.  Bien que du point de vue de l'application B, la situation sera différente et l'infrastructure de messagerie pour celle-ci sera constituée d'applications ou de protocoles réseau de niveau inférieur. <br><br><a name="5"></a><h2>  Définition des paramètres testés </h2><br>  Lors du test de chaque application, il est important de mettre en évidence toutes les infrastructures de messagerie utilisées par celle-ci (il peut y en avoir plusieurs), et pour chaque infrastructure, de sélectionner les interfaces utilisées (il peut également y en avoir plusieurs pour chaque infrastructure).  Pour chaque interface, la composition et le format des données qui y sont transférées sont déterminés aussi précisément que possible, par exemple: texte de message en TEXT / HTML, texte de message en TEXT / PLAIN, sujet du message, nom du destinataire, adresse du destinataire, nom de l'expéditeur, adresse de l'expéditeur de la lettre (RFC5321.From ), l'adresse de l'expéditeur du conducteur SMTP (RFC5322.mailfrom).  Ensuite, un ensemble d'exigences est développé pour chaque paramètre (représentations, codages, valeurs limites, etc.), des méthodes de contrôle pour chacun des paramètres sont déterminées (de quelle manière le résultat réel peut-il être comparé au résultat attendu). <br><br><a name="6"></a><h2>  Structure typique d'une application génératrice </h2><br>  En règle générale, le produit que nous testons est responsable de la génération de la lettre et des données qu'elle contient.  Il s'agit généralement d'une application serveur (mais parfois cliente).  Il définit la structure de la lettre, une partie des en-têtes de service, les formats d'encapsulation des données, la présentation des chaînes et l'encodage du texte.  Un exemple simple d'une telle application est un script qui forme une lettre et appelle la fonction <code>mail()</code> . <br><br>  Les principaux éléments de l'application à maîtriser: <br><br><ul><li>  code responsable de la génération des en-têtes et / ou de la structure des lettres si la structure des lettres est générée dynamiquement et / ou un modèle de lettre statique décrivant sa structure; </li><li>  disposition de la partie HTML de la lettre (idéalement, il s'agit d'une entité distincte ou d'une partie du modèle / de la disposition de la lettre, mais qui peut être cousue dans le code d'application); </li><li>  Substitution des données d'application dans une lettre (ou dans un modèle de lettre); </li><li>  intégration de l'application avec l'infrastructure de distribution de lettres, la justesse des paramètres transférés à l'interface de l'infrastructure. </li></ul><br><a name="7"></a><h2>  Quoi et quand tester </h2><br>  Que cela nous plaise ou non, tout l'iceberg doit être testé.  Il existe plusieurs composants principaux qui nécessitent des tests: <br><br><a name="8"></a><h4>  1. Infrastructure de livraison </h4><br>  Les tests devraient mettre l'accent sur: la délivrabilité des lettres;  l'exactitude des enregistrements DNS, y compris les enregistrements PTR / FCrDNS, MX et A;  Paramètres du protocole SMTP (HELO, utilisant TLS);  autorisation de lettre (SPF / DKIM / DMARC);  Adresses d'enveloppe SMTP (si elles ne sont pas gérées par l'application);  traitement correct des paramètres d'entrée de l'interface de l'infrastructure;  suivi, comptabilité et traitement des lettres non remises. <br><br>  Il est nécessaire de tester l'infrastructure lors de la mise en œuvre initiale et chaque fois que des modifications sont apportées à l'infrastructure elle-même (la configuration du MTA, du DNS ou des modifications du réseau) ou de l'interface d'envoi de lettres;  Utilisation d'un nouveau domaine, réseau ou API  Modifiez considérablement les caractéristiques des e-mails envoyés, comme leur langue, leur taille ou leur quantité.  Selon l'expérience, l'infrastructure a tendance à changer sans déclarer la guerre, donc des tests de base devraient être effectués périodiquement, même s'il n'y a aucune information sur des changements. <br><br>  Un ingénieur réseau et un spécialiste de la délivrabilité peuvent et doivent être impliqués dans la préparation du plan et des listes de contrôle des tests d'infrastructure. <br><br><a name="9"></a><h4>  2. L'application génératrice </h4><br>  Vous devez contrôler les adresses de l'enveloppe SMTP (si elles sont contrôlées par l'application, c'est-à-dire transférées à l'interface - enveloppe-de, enveloppe-à), les valeurs des en-têtes de message de service (Date, Message-ID, Liste-Désabonnement, Soumission automatique, etc.) p.), autorisation de lettres (DKIM / DMARC), encodages MIME (base64, quoted-printable), l'exactitude générale du format de lettre, par exemple, l'absence de caractères non ASCII dans les en-têtes, la composition des données substituées, le déclenchement correct des déclencheurs, les mécanismes de désabonnement, les mécanismes de suivi collecte de lettres et de statistiques (en-têtes de postmaster, par exemple, Feedback-ID ou X-Mailru-Msgtype, ainsi que le suivi des pixels)  . <br><br>  Vous devez tester l'application au cours de son développement, lors du changement de tous ses composants associés responsables de la génération et du stockage des données, avec des modifications importantes des modèles de lettres, lors du changement de l'infrastructure utilisée ou de son interface, ainsi que dans le cadre de régressions générales. <br><br><a name="10"></a><h4>  3. Modèles de lettres structurelles et de mise en page (peuvent faire partie d'une application génératrice ou sont développés séparément) </h4><br>  La structure du message est vérifiée (Content-Type, Content-Disposition, imbrication des parties multiparties de la lettre, encodage de texte, paramètres de chaîne), la valeur de la cible et les en-têtes affichés (De, À, Répondre à, Objet), le message est affiché dans la liste des lettres et lors de la lecture dans diverses interfaces, microformats (par exemple, qu'un événement de calendrier est reconnu comme un événement de calendrier, ou un billet d'avion comme un billet d'avion), l'image de marque. <br><br>  Les modèles d'e-mail doivent être testés chaque fois que vous effectuez au moins les moindres modifications, et également séparément, par exemple, dans une situation où des lettres pénètrent dans l'application avant que la partie serveur ne soit prête. <br><br>  Il est recommandé d'utiliser un spécialiste du marketing par courrier électronique et de la délivrabilité pour rédiger une liste de contrôle pour tester un modèle de lettre. <br><br><a name="11"></a><h2>  Exigences de base pour vérifier l'infrastructure </h2><br>  L'adresse IP sélectionnée pour le serveur de messagerie doit être aussi similaire que possible à l'adresse IP du serveur de messagerie.  Il est recommandé de le vérifier à l'aide de l'utilitaire whois.  En particulier, l'adresse de l'expéditeur ne doit pas appartenir à un réseau pouvant être perçu comme dynamique;  Le réseau sélectionné doit avoir des contacts valides auxquels vous pouvez envoyer des réclamations;  le réseau doit être utilisé (avoir le statut ASSIGNÉ dans RIPE).  L'adresse IP doit avoir un enregistrement PTR correctement configuré.  Il peut être configuré indépendamment via le panneau de contrôle d'hébergement ou en utilisant le service d'assistance du fournisseur.  L'enregistrement PTR doit pointer vers le véritable nom d'hôte et en même temps être significatif, se résoudre à la même adresse IP (la soi-disant vérification FCrDNS), ne pas rappeler le nom de l'hôte dynamique et ne pas inclure un grand groupe de chiffres ou de caractères.  Un bon exemple est mailserver.example.com. <br><br>  Chaque domaine utilisé dans les adresses d'enveloppe ou les en-têtes de message doit avoir un enregistrement MX valide pointant vers un enregistrement A de l'hôte, qui, au minimum, peut traiter les messages concernant l'échec de la remise.  Pour MX, il n'est pas permis de se référer directement à une adresse IP. <br><br>  Contrôlez le passage de SPF, DKIM, DMARC.  SPF permet au propriétaire du domaine de spécifier dans l'enregistrement TXT une liste de serveurs autorisés à envoyer des e-mails avec des adresses de retour dans ce domaine.  Il est configuré pour l'adresse utilisée dans l'enveloppe de (enveloppe SMTP) dans la section de gestion de la zone DNS du domaine.  DKIM permet de vérifier la paternité d'un message ou l'appartenance de son expéditeur à un domaine spécifique à l'aide de technologies de signature numérique, qui sont ajoutées au message lui-même (dans son en-tête DKIM-Signature).  En règle générale, une signature DKIM est configurée au niveau MTA (infrastructure).  DMARC définit la politique de vérification du courrier entrant dans un domaine spécifique et les actions sur les lettres qui ne passent pas l'authentification SPF ou DKIM.  Lorsque vous essayez de violer cette politique, un rapport structuré arrive avec des informations sur une telle tentative.  DMARC, ainsi que SPF, est publié en tant qu'enregistrement TXT dans la zone de domaine. <br><br>  Vérifiez la livraison des lettres aux principaux services postaux - pour la Russie, Mail.Ru, Yandex, GMail, Microsoft (Hotmail / Outlook.com / Office365), Rambler, nic.ru.  Dans les lettres, vous devez vérifier l'exactitude de HELO;  disponibilité et passage des chèques PTR / FCrDNS, SPF, DKIM et DMARC;  la validité des en-têtes et des données qu'ils contiennent, en particulier le synchronisme des heures dans les dates et l'exactitude des fuseaux horaires. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2dc/8b4/9bc/2dc8b49bc147ae9369cbc232bd4dfdb3.png"><br><br>  La formation de certains paramètres, par exemple l'autorisation, la délivrabilité et le spam, est influencée intégralement par tous les composants, mais il existe généralement des outils opérationnels distincts pour les contrôler - rapports DMARC et FBL, API de service postmaster, outils de suivi des e-mails et statistiques de livraison.  Les tests doivent prendre en compte le niveau de mise en œuvre des outils de suivi opérationnel dans l'entreprise - par exemple, en l'absence de suivi opérationnel des rapports DMARC, vous devez tester régulièrement l'autorisation de courrier, en l'absence de suivi opérationnel de la délivrabilité - vérifier régulièrement comment et où les lettres arrivent, même s'il n'y a pas de développement lié à l'envoi de lettres pas effectué. <br><br>  Pour vérifier l'infrastructure, vous pouvez utiliser des services spécialisés, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mail-tester.com</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mxtoolbox.com</a> .  Les exigences d'infrastructure détaillées peuvent être trouvées <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans cet article</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ee/d3f/4d3/3eed3f4d3e9ad8df1edb1a90d115e318.png"><br><br><a name="12"></a><h2>  Conditions d'autorisation </h2><br>  La vérification du passage de SPF, DKIM, DMARC est généralement possible en utilisant l'en-tête Authentication-Results sur le serveur du destinataire. <br><br>  Vérifiez la validité de l'enregistrement SPF pour la syntaxe, la limite pour les requêtes DNS (par exemple, en utilisant mxtoolbox.com).  Lors de la constitution d'un SPF, toutes les sources de mailing doivent être prises en compte (n'oubliez pas les systèmes CRM, toutes les infrastructures de livraison utilisées, y compris celles à travers lesquelles des campagnes marketing ponctuelles sont menées).  Il est recommandé de définir les serveurs autorisés pour le domaine via la liste des réseaux ('ip4' / 'ip6').  SPF est vérifié pour l'adresse de l'expéditeur à partir de l'enveloppe SMTP.  Vérifiez que le domaine d'enveloppe SMTP (enveloppe-de) correspond au domaine de l'en-tête De.  Les erreurs SPF courantes sont répertoriées <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans cet article</a> . <br><br>  Vérifiez l'enregistrement DNS DKIM, la validité et la composition de la signature DKIM.  Vérifiez que vous utilisez une clé DKIM d'au moins 1024 bits.  Mode de hachage recommandé pour la signature DKIM: détendu / détendu.  Assurez-vous que tous les en-têtes importants sont signés (De, À, Objet, Date, ID de message, Version MIME, Type de contenu), que les en-têtes de suivi (Reçu, Livré à, Chemin de retour) ne sont pas signés et que DKIM est validé pour services postaux de base.  Configurez le transfert vers l'un des services de messagerie vers un autre; DKIM ne doit pas "battre" sur les lettres transférées.  Vérifiez que le domaine de signature DKIM correspond au domaine de l'expéditeur à partir de l'en-tête From. <br><br>  Vérifiez DMARC pour les services de messagerie de base.  Recherchez les rapports DMARC, identifiez et dépannez SPF et DKIM pour toutes les adresses IP de votre infrastructure. <br><br>  Vérifiez que les messages sont remis à des serveurs externes à l'aide du chiffrement (TLS).  Parfois, vous pouvez vérifier TLS par l'en-tête Received sur le serveur du destinataire: par exemple, en spécifiant le protocole ESMTPS ou la présence de paramètres du formulaire <i>(version = TLS1_2 cipher = ECDHE-RSA-AES128-GCM-SHA256 bits = 128/128);</i>  indique la présence de TLS. <br><br><a name="13"></a><h2>  Vérification de l'application génératrice </h2><br><a name="14"></a><h4>  Exigences d'adresse postale </h4><br>  <b>Adresses d'enveloppe</b> <br>  Nous commençons la vérification de l'application génératrice avec les adresses dans l'enveloppe SMTP. <br><br>  Les adresses d'enveloppe sont des adresses du niveau de l'infrastructure de messagerie.  Ils ne sont pas visibles pour l'utilisateur, mais importants pour la livraison, car dans quelle boîte aux lettres la lettre est envoyée, elle est déterminée précisément par l'adresse de l'enveloppe. <br><br>  L'adresse du destinataire dans une enveloppe (enveloppe-à, alias RCPT TO :) est l'adresse à laquelle la lettre sera effectivement livrée. <br><br><ul><li>  pour toutes les lettres à l'exception de l'inscription, l'adresse doit être légalement signée et validée pour l'envoi conformément aux exigences administratives. </li><li>  pour les newsletters, l'adresse doit être «en direct», les adresses auxquelles les lettres ne peuvent pas être livrées régulièrement doivent être marquées comme inactives, aucun courrier ne doit leur être envoyé.  Mais certaines catégories de lettres (par exemple, la récupération d'accès) peuvent également devoir être envoyées à des adresses précédemment marquées comme inactives. </li></ul><br>  Adresse de l'expéditeur dans une enveloppe SMTP (généralement appelée enveloppe-de, smtp.mailfrom ou Return-Path) - des messages seront livrés à cette adresse concernant l'impossibilité de remettre une lettre et des réponses automatiques.  Cette adresse n'est pas visible pour l'utilisateur.  Cette adresse est également utilisée pour l'autorisation SPF.  Nous vérifions que: <br><br><ul><li>  l'adresse est disponible; </li><li>  Ce n'est pas l'adresse de l'employé et il n'est pas redirigé vers lui pour exclure les réponses automatiques, les messages d'inaccessibilité, etc .; </li><li>  Il est traité par un script qui marquera les adresses des utilisateurs inaccessibles comme inactives; </li><li>  l'adresse peut être générée automatiquement, c'est-à-dire  unique à chaque lettre; </li><li>  Une lettre à cette adresse ne doit pas conduire à la génération d'une lettre de réponse, par exemple un message concernant un débordement de boîte. </li></ul><br>  <b>Adresses d'en-tête de messagerie</b> <br><br>  Ces adresses sont soit directement visibles par l'utilisateur, soit utilisées lors de la réponse à une lettre. <br><br>  Adresse de l'expéditeur (à partir de :) L'en-tête est l'adresse et le nom de l'expéditeur affichés dans la liste des lettres et lors de la lecture d'une lettre.  Nous vérifions que: <br><br><ul><li>  Il s'agit d'une adresse conviviale «lisible par l'homme» qui identifie l'entreprise. </li><li>  Il contient non seulement le courrier électronique, mais également le nom de l'expéditeur. </li><li>  n @ply est possible, mais seulement si nous voulons souligner que nous ne nous attendons pas à recevoir une réponse à la lettre et qu'elle ne sera pas lue.  Il vaut mieux reproduire cette idée dans le texte de la lettre. </li><li>  En présence de caractères non ASCII (par exemple cyrillique), le nom de l'expéditeur doit être codé conformément à MIME, le domaine en présence de caractères non ASCII doit être codé en Punycode. </li><li>  Les lettres de la même catégorie doivent avoir la même adresse; l'utilisation d'adresses générées automatiquement n'est pas autorisée.  Cela est dû au fait que From: est le plus souvent utilisé par les gens pour trier les lettres dans des dossiers à l'aide de filtres. </li><li>  L'adresse doit être différente (de préférence dans des sous-domaines différents) pour les lettres transactionnelles, marketing et urgentes (telles que les lettres du service d'assistance).  Cela est également dû au fait que l'utilisateur peut marquer les e-mails marketing comme spam ou les filtrer dans un dossier illisible. </li><li>  L'adresse de provenance et l'adresse d'enveloppe SMTP doivent être dans le même domaine ou dans des sous-domaines du même domaine d'organisation afin de passer le SPF dans le DMARC. </li><li>  L'adresse doit provenir du domaine de l'organisation.  Il est inacceptable d'utiliser des services de messagerie gratuits et d'autres domaines de messagerie publique dans De, car ces mailings ne passeront pas l'authentification SPF et DKIM dans le cadre de DMARC. </li></ul><br>  Adresse de réponse - les réponses «manuelles» seront envoyées à cette adresse lorsque l'utilisateur répond à la lettre.  Elle est facultative: si elle est absente, l'adresse de From est utilisée pour la réponse.  Vérifiez que Répondre à: <br><br><ul><li>  Il peut être généré automatiquement, c'est-à-dire  unique à la lettre (permet de savoir à quelle lettre la réponse est arrivée). </li><li>  Il ne doit pas tomber dans la boîte de l'employé pour éviter de répondre aux appels, mais devrait idéalement être «enveloppé» dans CRM. </li><li>  Il peut générer une réponse automatique CRM standard, mais il ne doit pas générer quoi que ce soit de superflu, par exemple, des messages sur un débordement de boîte.  Lors de la génération de réponses automatiques, des mesures doivent être prises pour éviter le bouclage, elles sont répertoriées dans la RFC 3834. </li><li>  Il peut provenir de n'importe quel domaine qui ne coïncide pas nécessairement avec From, mais cela effraie parfois les utilisateurs lorsqu'ils répondent. </li><li>  Peut être absent, alors l'adresse De remplit ses fonctions. </li><li>  En plus de l'adresse, le nom de l'expéditeur est indiqué. </li></ul><br>  Pour adresser: <br><br><ul><li>  Il doit contenir l'e-mail du destinataire (sinon il effraie le destinataire du message et protège l'anti-spam). </li><li>  Idéalement, il devrait contenir le nom du destinataire.  Mais si le nom est inconnu ou douteux (par exemple, l'adresse n'a pas encore été confirmée), il est préférable de ne pas l'indiquer (quelqu'un peut entrer l'adresse de quelqu'un d'autre avec un mauvais nom, et le destinataire peut être offensé par vous). </li></ul><br><a name="15"></a><h4>  Exigences de l'en-tête de l'e-mail </h4><br>  L'encodage réel du texte doit correspondre à celui indiqué dans l'en-tête.  Il est conseillé d'utiliser un seul codage dans tous les en-têtes et parties de la lettre.  Il est recommandé d'utiliser UTF-8 comme étant largement pris en charge.  L'encodage est indiqué dans les en-têtes Content-Type et dans la balise &lt;META&gt; de la partie HTML. <br><br>  Les en-têtes From:, Message-ID: et Date: doivent être formés directement dans le script pour l'envoi de la lettre (et selon les normes - avec le texte de la lettre) et toujours dans le format correct.  S'ils sont absents ou mal formés, l'un des serveurs de transit peut ajouter ces en-têtes, ce qui entraîne une violation de l'intégrité de la signature DKIM. <br><br>  Les caractères de 8 bits dans les en-têtes, y compris la ligne d'objet (Objet) et les noms des fichiers joints (Content-Type et Content-Disposition), doivent être absents;  Tous les caractères non ASCII, y compris cyrillique, doivent être codés en imprimable entre guillemets ou en base64. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/910/ab6/456/910ab6456ccd1ed4ef29f1725dab4bdd.png"><br><br><a name="16"></a><h4>  Conditions requises pour la structure de la lettre </h4><br>  Pour la partie HTML de la lettre, il est souhaitable de former une partie alternative (texte brut).  Il est également nécessaire de vérifier la conformité et la lisibilité de la partie en texte brut de la lettre (le cas échéant) et la structure générale de la lettre. <br><br>  Selon la RFC 5322, la longueur de ligne dans une lettre ne doit pas dépasser 998 caractères 8 bits.  Veuillez noter qu'en UTF-8, un personnage peut occuper plusieurs octets.  Le terminateur des lignes dans l'e-mail est une paire de CRLF (&lt;cr&gt; ascii 13, lf&gt; ascii 10), qui occupe 2 octets.  Vous devez vérifier l'exactitude du terminateur de chaîne, car les lettres sont souvent envoyées à l'aide d'un script Unix, et dans Unix, le terminateur de ligne est un caractère lf unique - il s'agit d'une erreur pour le courrier électronique.  Vous devez également vérifier si les terminateurs de chaîne rompent les caractères codés UTF-8: vous ne pouvez pas autoriser la présence d'un terminateur de chaîne entre deux octets du même caractère, par exemple cyrillique.          ,     base64. <br><br>        —      «Content-Disposition: inline»,   ,   ,  «Content-Disposition: attachment»,     . <br>  ,  ,    :  ,      multipart-   (mixed, alternative, related),  multipart/mixed       , multipart/related —    , multipart/alternative —   plain text-  HTML-.     ,       -,    : <br><br> multipart/alternative <br> — text/plain <br> — text/html <br><br>   , text/plain    text/html  multipart/related.    ,     HTML-,       -   —  plain-. <br><br>     -      : <br><br> multipart/alternative <br> — text/plain <br> — multipart/related <br> —— text/html <br> —— image/… (-) <br> —— image/… (-) <br><br> -   Content-Disposition: inline     multipart/related-. <br><br>    ,     ,   ,    : <br><br> multipart/mixed <br> — multipart/alternative <br> —— text/plain <br> —— multipart/related <br> ——— text/html <br> ——— image/png <br> ——— image/png <br>  ... <br> — application/octet-string (content-disposition: attachment) <br> — application/octet-string (content-disposition: attachment) <br>  ... <br><br> (multipart/related-  multipart/alternative-     ,     multipart/mixed-) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b63/896/ef4/b63896ef4964a08327693deae2192641.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ab/123/d6d/7ab123d6d0398601b7c62bd1ae57d59a.png"><br><br><a name="17"></a><h4>   URI </h4><br>  URI (  src, href,   ..)       ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://example.com/somepath</a> ).       (/somepath)    (//example.com/somepath),    , ..        file://. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c55/852/64f/c5585264ffa6e6f15246000cd26f9d00.png"><br><br><ul><li>    ASCII- ( , )  URI       percent encoding. </li><li> ,    (..    URL,     ),        &lt;&gt;,         .  -    ,      .  href  A        ,  -          .         «»,     . </li><li>     htt://, htts://  milto:. </li><li>           http://   htts://. </li><li>      (, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">example.com</a> :8080/somepath), ..     . </li><li>     HTML-     -    (, ,    ..)      , ..   -      ,    ;           ,        ,     ,     ( -         GET-,       POST  PUT). </li><li>      List-Unsubscribe, ,      -  , ..          . </li><li>     ,            ,    ,     (,   ).           .  ,    ,   ,    ,   ,     . </li><li>  Parce que  URI   ,       URI  data:.            URI. </li><li>     ,      . ,        ,          . </li><li>       -     . </li></ul><br><a name="18"></a><h4>     </h4><br>     ? <br><br><blockquote>            .         —   (XSS, Crossite scripting),   (interface spoofing), DOM clobbering,   /   (, IP-      )  ..,                 .  ,       .     : <br><br><ul><li>   , </li><li>   / , </li><li>    , </li><li>        (    ), </li><li>       (..      )       , </li><li>  HTML-     ( Microsoft Exchange / Outlook  RTF, -       Outlook      ), </li><li>          . </li></ul><br>      ,   -  URI cid://,     . , Mozilla Thunderbird   cid://   . </blockquote><br>      -     -       . <br><br>          . ,          URI, -    , -   ,       .        :          ,     (  ,               ). <br><br>      : <br><br><ul><li>      , ,  , ,    . </li><li>          . </li><li>   , , ,          .      (      ).      .     ,        . </li><li>       ,   . </li><li>  ,    ,  ..   -,    - ,  c,   , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">      </a> ( ,   , ,  ,  -       ). ,             ,    . </li><li>       . </li><li>    , ,  , .        (, -  ),   , ,  ,     . </li><li>               . </li><li>   : <br><ul><li>    :  « » Mail.Ru, Yandex, Gmail,   Rambler  Outlook.com; </li><li>      ; </li><li>   ,    IMAP,     ,    iPhone, Pixel (  Android), Samsung (   Android), MIUI (    Android-); </li><li>   : Chrome, Firefox, Edge, Internet Explorer, Opera  .; </li><li>   ( ),  Thunderbird, Outlook  Apple Mail,  The Bat!  Opera Mail; </li><li>     - (Exchange,  Roundcube, Communigate, Zimbra, SquirrelMail) —  B2B-; </li><li>       Retina-,        . </li></ul></li><li>          : <br><ul><li>   , SPF/DKIM/DMARC. </li><li>   :    ,  . </li><li>     : ,    ,     ,      (,       «»). </li><li>    :    ,       ..,         . </li><li>        . </li><li>     . </li><li>  . </li><li>   ,  . ,        ,    - ,       ,             . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfd/d33/a08/dfdd33a0855e3f55c1ac96534b66a716.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6a/964/e13/e6a964e1366a217ecd60bdb41f584e2f.png"></li></ul></li><li>      (  )  ,      .        ,      . </li><li>  ,     ,   , ..       ,  , , «»   . </li><li>       . ,    DKIM-   -    (  DNS   DKIM-,   ), -    (   ,    ,      From, Date  Message-ID)  -   (  ,   ,   ).   «»    ,        . </li></ul><br><a name="19"></a><h2>  - </h2><br>       ,      ,     . <br><br>   ,     ,    (   ).       .       ,     ,        . <br><br>      CTR   —         .  postmaster.mail.ru      .        (),     . CTR &lt; 10% —    ,    .    CTR &gt; 30%.        CTR          («»)   .      (   ).          ,   —   .  ,       ,  : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://help.mail.ru/developers/mailing_rules/technical</a> . <br><br>   -       .           CTR        .          (      ).             «» —    10 000 ,       . <br><br>  :      , ,      .       « »    . ,         . <br><br> <i>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">z3apa3a</a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">s4ever</a> .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">EdT</a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">4Alexander</a> .</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr419591/">https://habr.com/ru/post/fr419591/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr419581/index.html">Quels projets à but non lucratif sont intéressants pour Y Combinator</a></li>
<li><a href="../fr419583/index.html">Comment la Russie a raté l'apogée du DVD, mais rattrapé l'Occident avec l'avènement de l'Internet haut débit</a></li>
<li><a href="../fr419585/index.html">PWA est facile. Bonjour habr</a></li>
<li><a href="../fr419587/index.html">Des compétitions qui changent le monde. 1567 - 2035</a></li>
<li><a href="../fr419589/index.html">Nous utilisons AMP comme une bibliothèque polyvalente pour créer des sites dynamiques rapides</a></li>
<li><a href="../fr419593/index.html">Lunettes daltoniennes: comment ça marche et quelles sont les difficultés de sélection</a></li>
<li><a href="../fr419599/index.html">Java REST à HeadHunter School of Programmers</a></li>
<li><a href="../fr419601/index.html">Un exemple de conception d'un appareil numérique "sur les doigts"</a></li>
<li><a href="../fr419603/index.html">Contexte: les entreprises qui produisent des robots</a></li>
<li><a href="../fr419611/index.html">De l'Allemagne avec amour: le pionnier de la téléphonie IP arrive en Russie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>