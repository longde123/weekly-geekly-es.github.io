<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêØ üò≤ ‚ùî En route vers un SGBD fonctionnel et un ERP NoSQL: stockage des soldes et chiffrage üë©üèæ‚Äçü§ù‚Äçüë©üèº üé≠ üî¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 

 Nous continuons d'√©tudier l'applicabilit√© des principes de programmation fonctionnelle dans la conception d'ERP. Dans l' article pr√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>En route vers un SGBD fonctionnel et un ERP NoSQL: stockage des soldes et chiffrage</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485508/"> Bonjour, Habr! <br><br>  Nous continuons d'√©tudier l'applicabilit√© des principes de programmation fonctionnelle dans la conception d'ERP.  Dans l' <a href="https://habr.com/ru/post/482938/">article pr√©c√©dent,</a> nous avons expliqu√© pourquoi cela √©tait n√©cessaire, jet√© les bases de l'architecture et d√©montr√© la construction de convolutions simples en utilisant l'exemple d'une d√©claration inverse.  En fait, l'approche de <a href="https://habr.com/ru/post/178259/">sourcing d'√©v√©nements</a> est propos√©e, mais en raison de la s√©paration de la base de donn√©es en parties immuables et mutables, nous obtenons dans un syst√®me une combinaison des avantages d'une carte / r√©duire le stockage et d'un SGBD en m√©moire, ce qui r√©sout √† la fois le probl√®me de performances et le probl√®me d'√©volutivit√©.  Dans cet article, je vais expliquer (et montrer un prototype sur l' <a href="https://deno.land/" rel="nofollow">environnement d'ex√©cution</a> TypeScript et <a href="https://deno.land/" rel="nofollow">Deno</a> ) comment stocker des registres de soldes instantan√©s dans un tel syst√®me et calculer le co√ªt.  Pour ceux qui n'ont pas lu le 1er article - un bref r√©sum√©: <br><br>  <b>1. Journal des documents</b> .  Un ERP construit sur la base d'un SGBDR est un √©norme √©tat mutable avec un acc√®s comp√©titif, il n'est donc pas √©volutif, faiblement audible et peu fiable en fonctionnement (il permet l'incoh√©rence des donn√©es).  Dans l'ERP fonctionnel, toutes les donn√©es sont organis√©es sous la forme d'un journal chronologiquement ordonn√© de documents primaires immuables, et il n'y a rien d'autre que ces documents.  Les liens sont r√©solus des nouveaux documents aux anciens par un ID complet (et jamais l'inverse), et toutes les autres donn√©es (soldes, registres, comparaisons) sont des convolutions calcul√©es, c'est-√†-dire des r√©sultats mis en cache de fonctions pures sur le flux de documents.  Le manque d'√©tat + d'audibilit√© des fonctions nous donne une fiabilit√© accrue (la blockchain correspond parfaitement √† ce sch√©ma), et en bonus nous obtenons une simplification du sch√©ma de stockage + cache adaptatif au lieu de dur (organis√© sur la base de tableaux). <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Voici √† quoi ressemble le fragment de donn√©es dans notre ERP</b> <div class="spoiler_text"><pre><code class="json hljs">//   { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"person"</span></span>, //  ,      <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.0"</span></span>, //    <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.0^1580006048190"</span></span>, //  +    ID <span class="hljs-attr"><span class="hljs-attr">"erp_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.retail"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> } //  <span class="hljs-string"><span class="hljs-string">""</span></span> { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"purch"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"purch.XXX"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"purch.XXX^1580006158787"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2020-01-21"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"person"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.0^1580006048190"</span></span>, //    <span class="hljs-attr"><span class="hljs-attr">"stock"</span></span>: <span class="hljs-string"><span class="hljs-string">"stock.0^1580006048190"</span></span>, //    <span class="hljs-attr"><span class="hljs-attr">"lines"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"nomen"</span></span>: <span class="hljs-string"><span class="hljs-string">"nomen.0^1580006048190"</span></span>, //    <span class="hljs-attr"><span class="hljs-attr">"qty"</span></span>: <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">116.62545127448834</span></span> } ] }</code> </pre> </div></div><br>  <b>2. Immunit√© et mutabilit√©</b> .  Le journal des documents est divis√© en 2 parties in√©gales: <br><br><ul><li>  La grande partie <b>immuable</b> se trouve dans les fichiers JSON, est disponible pour la lecture s√©quentielle et peut √™tre copi√©e sur les n≈ìuds du serveur, garantissant la simultan√©it√© de la lecture.  Les convolutions calcul√©es sur la partie immuable sont mises en cache, et jusqu'au d√©calage, les points d'immunit√© sont √©galement inchang√©s (c'est-√†-dire r√©pliqu√©s). </li><li>  La plus petite partie <b>modifiable</b> correspond aux donn√©es actuelles (en termes de comptabilit√© - la p√©riode actuelle), o√π vous pouvez modifier et annuler des documents (mais pas les supprimer), ins√©rer et r√©organiser r√©troactivement des relations (par exemple, faire correspondre les re√ßus aux d√©penses, recalculer les co√ªts, etc.). .).  Les donn√©es mutables sont charg√©es dans la m√©moire dans son ensemble, ce qui permet un calcul de convolution rapide et un m√©canisme transactionnel relativement simple. </li></ul><br>  <b>3. Convolution</b> .  En raison du manque de s√©mantique JOIN, le langage SQL ne convient pas et tous les algorithmes sont √©crits dans le style fonctionnel filtrer / r√©duire, il existe √©galement des d√©clencheurs (gestionnaires d'√©v√©nements) pour certains types de documents.  Le calcul du filtre / r√©duction est appel√© convolution.  L'algorithme de convolution pour le d√©veloppeur de l'application ressemble √† un passage complet dans le journal des documents, cependant, le noyau fait une optimisation pendant l'ex√©cution - le r√©sultat interm√©diaire calcul√© √† partir de la partie immuable est pris dans le cache puis ¬´compt√©¬ª dans la partie mutable.  Ainsi, √† partir du deuxi√®me lancement, la convolution est enti√®rement calcul√©e en RAM, ce qui prend des fractions de seconde sur un million de documents (nous le montrerons avec des exemples).  La convolution est compt√©e √† chaque appel, car il est tr√®s difficile de suivre tous les changements dans les documents mutables (approche imp√©rative-r√©active), et les calculs dans la RAM sont bon march√©, et le code utilisateur avec cette approche est grandement simplifi√©.  Une convolution peut utiliser les r√©sultats d'autres convolutions, extraire des documents par ID et rechercher des documents dans le cache sup√©rieur par cl√©. <br><br>  <b>4. Versionnement et mise en cache des documents</b> .  Chaque document poss√®de une cl√© unique et un identifiant unique (cl√© + horodatage).  Les documents avec la m√™me cl√© sont organis√©s en groupe, dont le dernier enregistrement est actuel (actuel) et les autres sont historiques. <br><br>  Un cache est tout ce qui peut √™tre supprim√© et est √† nouveau restaur√© √† partir du journal des documents lorsque la base de donn√©es d√©marre.  Notre syst√®me dispose de 3 caches: <br><br><ul><li>  <b>Cache de documents</b> avec acc√®s ID.  Il s'agit g√©n√©ralement de r√©pertoires et de documents semi-permanents, tels que des journaux de taux de d√©penses.  L'attribut de mise en cache (oui / non) est li√© au type de document, le cache est initialis√© au premier d√©marrage de la base de donn√©es puis pris en charge par le noyau. </li><li>  <b>Cache sup√©rieur des documents</b> avec acc√®s par cl√©.  Stocke les derni√®res versions des entr√©es d'annuaire et des registres instantan√©s (par exemple, les soldes et les soldes).  Le signe de la n√©cessit√© d'une mise en cache sup√©rieure est li√© au type de document, le cache sup√©rieur est mis √† jour par le noyau lors de la cr√©ation / modification d'un document. </li><li>  <b>Le cache de convolution</b> calcul√© √† partir de la partie immuable de la base de donn√©es est une collection de paires cl√© / valeur.  La cl√© de convolution est une repr√©sentation sous forme de cha√Æne du code de l'algorithme + la valeur initiale s√©rialis√©e de l'accumulateur (dans laquelle les param√®tres de calcul d'entr√©e sont transmis), et le r√©sultat de la convolution est la valeur finale s√©rialis√©e de l'accumulateur (il peut s'agir d'un objet ou d'une collection complexe). </li></ul><br><h4>  Stockage des soldes </h4><br>  Nous passons au sujet r√©el de l'article - le stockage des r√©sidus.  La premi√®re chose qui me vient √† l'esprit est d'impl√©menter le reste comme une convolution, dont le param√®tre d'entr√©e sera une combinaison d'analystes (par exemple, nomenclature + entrep√¥t + lot).  Cependant, dans l'ERP, nous devons consid√©rer le prix de revient, pour lequel il est n√©cessaire de comparer les co√ªts avec les soldes (algorithmes FIFO, FIFO par lot, moyenne de l'entrep√¥t - th√©oriquement, nous pouvons faire la moyenne du co√ªt pour n'importe quelle combinaison d'analystes).  En d'autres termes, nous avons besoin du reste en tant qu'entit√© ind√©pendante, et puisque tout est un document dans notre syst√®me, le reste est √©galement un document. <br><br>  Un document de type ¬´solde¬ª est g√©n√©r√© par le d√©clencheur lors de la validation des lignes de documents d'achat / vente / mouvement, etc.  La cl√© de solde est une combinaison d'analystes, les soldes avec la m√™me cl√© forment un groupe historique, dont le dernier √©l√©ment est stock√© dans le cache sup√©rieur et disponible instantan√©ment.  Les soldes ne sont pas des √©critures et ne sont donc pas r√©sum√©s - le dernier enregistrement est pertinent et les premiers enregistrements conservent un historique. <br><br>  Le solde stocke la quantit√© dans les unit√©s de stockage et le montant dans la devise principale, et en divisant la seconde en premi√®re - nous obtenons le co√ªt instantan√© √† l'intersection de l'analyste.  Ainsi, le syst√®me stocke non seulement l'historique complet des r√©sidus, mais √©galement l'historique complet des co√ªts, ce qui est un plus pour l'audit des r√©sultats.  Le solde est l√©ger, le nombre maximal de soldes est √©gal au nombre de lignes de documents (en fait moins si les lignes sont regroup√©es par combinaison d'analystes), le nombre d'enregistrements de solde sup√©rieur ne d√©pend pas du volume de la base de donn√©es et est d√©termin√© par le nombre de combinaisons d'analystes impliqu√©s dans le contr√¥le des soldes et le calcul des co√ªts, donc la taille Notre cache sup√©rieur est toujours pr√©visible. <br><br><h4>  Consommables </h4><br>  Initialement, les soldes sont constitu√©s par des documents de r√©ception de type ¬´achat¬ª et sont ajust√©s par tous les documents de d√©penses.  Par exemple, un d√©clencheur pour un document de vente effectue les op√©rations suivantes: <br><br><ul><li>  extrait le solde actuel du cache sup√©rieur </li><li>  v√©rifie la disponibilit√© des quantit√©s </li><li>  enregistre un lien vers le solde actuel dans la ligne du document et le co√ªt instantan√© </li><li>  g√©n√®re un nouveau bilan avec un montant et un montant r√©duits </li></ul><br>  Un exemple de changement d'√©quilibre lors de la vente <br><br><pre> <code class="json hljs">//    { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0^1580006158787"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"qty"</span></span>: <span class="hljs-number"><span class="hljs-number">11209</span></span>, //  <span class="hljs-attr"><span class="hljs-attr">"val"</span></span>: <span class="hljs-number"><span class="hljs-number">1392411.5073958784</span></span> //  } //  <span class="hljs-string"><span class="hljs-string">""</span></span> { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"sale"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"sale.XXX"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"sale.XXX^1580006184280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2020-01-21"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"person"</span></span>: <span class="hljs-string"><span class="hljs-string">"person.0^1580006048190"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"stock"</span></span>: <span class="hljs-string"><span class="hljs-string">"stock.0^1580006048190"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lines"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"nomen"</span></span>: <span class="hljs-string"><span class="hljs-string">"nomen.0^1580006048190"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"qty"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-attr"><span class="hljs-attr">"price"</span></span>: <span class="hljs-number"><span class="hljs-number">295.5228788368553</span></span>, //   <span class="hljs-attr"><span class="hljs-attr">"cost"</span></span>: <span class="hljs-number"><span class="hljs-number">124.22263425781769</span></span>, //  <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0^1580006158787"</span></span> // - } ] } //    { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"bal|nomen.0|stock.0^1580006184281"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"qty"</span></span>: <span class="hljs-number"><span class="hljs-number">11189</span></span>, <span class="hljs-attr"><span class="hljs-attr">"val"</span></span>: <span class="hljs-number"><span class="hljs-number">1389927.054710722</span></span> }</code> </pre><br>  Code de classe du gestionnaire de document TypeScript <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Document, DocClass, IDBCore } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../core/DBMeta.ts'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sale</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> before_add(doc: Document, <span class="hljs-attr"><span class="hljs-attr">db</span></span>: IDBCore): [boolean, string?] { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> err = <span class="hljs-string"><span class="hljs-string">''</span></span> doc.lines.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">line</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> key = <span class="hljs-string"><span class="hljs-string">'bal'</span></span> + <span class="hljs-string"><span class="hljs-string">'|'</span></span> + db.key_from_id(line.nomen) + <span class="hljs-string"><span class="hljs-string">'|'</span></span> + db.key_from_id(doc.stock) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bal = db.get_top(key, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-comment"><span class="hljs-comment">// true -  ,    - const bal_qty = bal?.qty ?? 0 //   const bal_val = bal?.val ?? 0 //   if (bal_qty &lt; line.qty) { err += '\n"' + key + '": requested ' + line.qty + ' but balance is only ' + bal_qty } else { line.cost = bal_val / bal_qty //     line.from = bal.id } }) return err !== '' ? [false, err] : [true,] } static after_add(doc: Document, db: IDBCore): void { doc.lines.forEach(line =&gt; { const key = 'bal' + '|' + db.key_from_id(line.nomen) + '|' + db.key_from_id(doc.stock) const bal = db.get_top(key, true) const bal_qty = bal?.qty ?? 0 const bal_val = bal?.val ?? 0 db.add_mut( { type: 'bal', key: key, qty: bal_qty - line.qty, val: bal_val - line.cost * line.qty // cost   before_add() } ) }) } }</span></span></code> </pre><br>  Bien s√ªr, il serait possible de ne pas stocker le co√ªt directement dans les lignes de d√©penses, mais de le prendre par r√©f√©rence du bilan, mais le fait est que les soldes sont des documents, ils sont nombreux, il est impossible de tout mettre en cache, et obtenir un document par ID en lisant sur le disque co√ªte cher ( comment indexer des fichiers s√©quentiels pour un acc√®s rapide - je vous le dirai la prochaine fois). <br><br>  Le principal probl√®me que les commentateurs ont soulign√© est la performance du syst√®me, et nous avons tout pour le mesurer sur des quantit√©s de donn√©es relativement pertinentes. <br><br><h4>  G√©n√©ration de donn√©es source </h4><br>  Notre syst√®me comprendra <b>5 000</b> contreparties (fournisseurs et clients), <b>3 000</b> articles, <b>50</b> entrep√¥ts et <b>100 000</b> documents de chaque type - achat, transfert, vente.  Les documents sont g√©n√©r√©s de mani√®re al√©atoire, en moyenne 8,5 lignes par document.  Les lignes d'achat et de vente g√©n√®rent une transaction (et un solde), et deux lignes de mouvement, r√©sultant en <b>300</b> <b>000</b> documents primaires, g√©n√®rent environ <b>3,4 millions de</b> transactions, ce qui correspond au volume mensuel de l'ERP provincial.  Nous g√©n√©rons la partie mutable de la m√™me mani√®re, uniquement avec un volume 10 fois inf√©rieur. <br><br>  Nous g√©n√©rons les documents avec un <a href="" rel="nofollow">script</a> .  Commen√ßons par les achats, pendant le reste des documents, le d√©clencheur v√©rifiera le solde √† l'intersection de l'article et de l'entrep√¥t, et si au moins une ligne ne passe pas, le script tentera de g√©n√©rer un nouveau document.  Les soldes sont cr√©√©s automatiquement par des d√©clencheurs, le nombre maximum de combinaisons d'analystes est √©gal au nombre de nomenclatures * nombre d'entrep√¥ts, soit  <b>150k.</b> <br><br><h4>  Taille de la base de donn√©es et du cache </h4><br>  Une fois le script termin√©, nous verrons les mesures de base de donn√©es suivantes: <br><br><ul><li>  partie immuable: documents de <b>3,7kk</b> (300k primaire, les soldes restants) - fichier <b>770 Mb</b> </li><li>  partie mutable: <b>370k</b> documents (30k primaire, les soldes restants) - fichier <b>76 Mb</b> </li><li>  cache sup√©rieur des documents: <b>158k</b> documents (r√©f√©rences + tranche de soldes actuelle) - fichier <b>20 Mb</b> </li><li>  cache de documents: <b>8,8 k</b> documents (r√©pertoires uniquement) - fichier <b>&lt;1 Mo</b> </li></ul><br><h4>  Analyse comparative </h4><br>  Initialisation de la base.  En l'absence de fichiers cache, la base de donn√©es au premier d√©marrage impl√©mente une analyse compl√®te: <br><br><ul><li>  fichier de donn√©es immuable (remplissage des caches pour les types de documents mis en cache) - <b>55 sec</b> </li><li>  fichier de donn√©es mutable (chargement de donn√©es enti√®res dans la m√©moire et mise √† jour du cache sup√©rieur) - <b>6 sec</b> </li></ul><br>  Lorsque des caches existent, augmenter la base est plus rapide: <br><br><ul><li>  fichier de donn√©es mutable - <b>6 sec</b> </li><li>  fichier cache sup√©rieur - <b>1,8 sec</b> </li><li>  autres caches - moins de 1 seconde </li></ul><br>  Toute convolution d'utilisateur (par exemple, prenez le <a href="" rel="nofollow">script pour</a> construire la feuille de chiffre d'affaires) lors du premier appel lance une analyse du fichier immuable, et les donn√©es mutables sont d√©j√† analys√©es dans la RAM: <br><br><ul><li>  fichier de donn√©es immuable - <b>55 sec</b> </li><li>  tableau mutable en m√©moire - <b>0,2 sec</b> </li></ul><br>  Dans les appels suivants, lorsque les param√®tres d'entr√©e correspondent, la fonction de <i>r√©duction ()</i> renvoie le r√©sultat en <b>0,2 seconde</b> , tout en proc√©dant comme suit √† chaque fois: <br><br><ul><li>  extraire le r√©sultat du cache r√©duit par cl√© (en tenant compte des param√®tres) </li><li>  num√©risation d'un tableau mutable en m√©moire ( <b>370k</b> documents) </li><li>  ¬´Compter¬ª le r√©sultat en appliquant l'algorithme de convolution aux documents filtr√©s ( <b>20k</b> ) </li></ul><br>  Les r√©sultats sont assez attrayants pour de tels volumes de donn√©es, mon ordinateur portable √† c≈ìur unique, l'absence compl√®te de tout SGBD (nous n'oublions pas que ce n'est qu'un prototype) et un algorithme √† un passage dans le langage TypeScript (qui est toujours consid√©r√© comme un choix frivole pour les entreprises). applications dorsales). <br><br><h4>  Optimisation technique </h4><br>  Apr√®s avoir examin√© les performances du code, j'ai constat√© que plus de 80% du temps est pass√© √† lire le fichier et √† analyser Unicode, √† savoir <i>File.read ()</i> et <i>TextDecoder (). Decode ()</i> .  De plus, l' <a href="" rel="nofollow">interface de</a> fichiers de haut niveau de Deno est uniquement asynchrone et, comme je l'ai <a href="https://habr.com/ru/post/483734/">d√©couvert r√©cemment</a> , le prix de l' <i>async / wait est</i> trop √©lev√© pour ma t√¢che.  Par cons√©quent, j'ai d√ª √©crire mon propre <a href="" rel="nofollow">lecteur</a> synchrone, et sans vraiment me soucier des optimisations, pour augmenter la vitesse de lecture pure de 3 fois, ou, si vous comptez avec l'analyse JSON - de 2 fois, en m√™me temps, globalement, vous vous √™tes d√©barrass√© de l'asynchronisation.  Peut-√™tre que cette pi√®ce doit √™tre r√©√©crite √† bas niveau (ou peut-√™tre l'ensemble du projet).  L'√©criture des donn√©es sur le disque est √©galement trop lente, bien que cela soit moins critique pour le prototype. <br><br><h4>  Etapes suppl√©mentaires </h4><br>  1. D√©montrer l'impl√©mentation des algorithmes ERP suivants dans un style fonctionnel: <br><br><ul><li>  gestion des r√©serves et besoins ouverts </li><li>  planification de la cha√Æne d'approvisionnement </li><li>  calcul des co√ªts de production en tenant compte des frais g√©n√©raux </li></ul><br>  2. Passez au format de stockage binaire, cela acc√©l√©rera peut-√™tre la lecture du fichier.  Ou m√™me tout mettre √† Mongo. <br><br>  3. Transf√©rez FuncDB en mode multi-utilisateur.  Conform√©ment au principe <a href="https://ru.wikipedia.org/wiki/CQRS" rel="nofollow">CQRS</a> , la lecture est effectu√©e directement par les n≈ìuds de serveur sur lesquels les fichiers de base de donn√©es immuables sont copi√©s (ou fouill√©s sur le r√©seau), et l'enregistrement est effectu√© via un seul point REST qui g√®re les donn√©es, les caches et les transactions mutables. <br><br>  4. Acc√©l√©ration de l'obtention de tout document non mis en cache par ID en raison de l'indexation des fichiers s√©quentiels (ce qui viole bien s√ªr notre concept d'algorithmes en un seul passage, mais la pr√©sence de toute possibilit√© est toujours meilleure que son absence). <br><br><h4>  R√©sum√© </h4><br>  Jusqu'√† pr√©sent, je n'ai trouv√© aucune raison d'abandonner l'id√©e d'un SGBD / ERP fonctionnel, car malgr√© la non-universalit√© d'un tel SGBD pour une t√¢che sp√©cifique (comptabilit√© et planification), nous avons une chance d'obtenir une augmentation multiple de l'√©volutivit√©, de l'audibilit√© et de la fiabilit√© du syst√®me cible - tout cela gr√¢ce au respect du syst√®me de base principes de la PF. <br><br>  <a href="" rel="nofollow"><b>Code de projet complet</b></a> <br><br>  Si quelqu'un veut jouer seul: <br><br><ul><li>  installer <a href="https://deno.land/" rel="nofollow">deno</a> </li><li>  cloner le r√©f√©rentiel </li><li>  ex√©cuter le script de g√©n√©ration de base de donn√©es avec contr√¥le des r√©sidus (generate_sample_database_with_balanses.ts) </li><li>  ex√©cuter des scripts d'exemples 1 √† 4 situ√©s dans le dossier racine </li><li>  trouver votre propre exemple, encoder, tester et me donner des commentaires </li></ul><br>  PS <br>  La sortie de la console est con√ßue pour Linux, peut-√™tre que sous Windows, les s√©quences d'√©chappement ne fonctionneront pas correctement, mais je n'ai rien √† v√©rifier :) <br><br>  Merci de votre attention. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr485508/">https://habr.com/ru/post/fr485508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr485494/index.html">Choix du week-end: lecture l√©g√®re pour les majors STEM</a></li>
<li><a href="../fr485496/index.html">LyX: Remarques g√©n√©rales. Partie 1</a></li>
<li><a href="../fr485498/index.html">Exemple d'application r√©active √† ressort (version du 14/01/2020)</a></li>
<li><a href="../fr485502/index.html">Nouvelles du monde d'OpenStreetMap n ¬∞ 495 (01/07/2020 - 01/13/2020)</a></li>
<li><a href="../fr485504/index.html">En interdisant la reconnaissance faciale, nous manquons le point</a></li>
<li><a href="../fr485510/index.html">Comment lancer un produit seul si vous √™tes d√©veloppeur: conseils du cr√©ateur de Laravel, Taylor Otvel. Partie 3: N'abandonnez pas</a></li>
<li><a href="../fr485514/index.html">EBlink - Serveur GDB pour microcontr√¥leurs ARM Cortex-M</a></li>
<li><a href="../fr485518/index.html">Essayer de composer le non-composable: soulever tout</a></li>
<li><a href="../fr485520/index.html">QueryFilter: le concept de mod√®les de filtrage</a></li>
<li><a href="../fr485522/index.html">Hack The Box - Walkthrough AI. SQLi dans le texte API √† atteindre, le transfert SSH et RCE dans JDWP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>