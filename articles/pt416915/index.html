<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ôæ üë®üèø‚Äç‚öïÔ∏è üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Centrifugo v2 - o futuro do servidor de mensagens e da biblioteca em tempo real para Go üõçÔ∏è üåó üë®‚Äç‚ù§Ô∏è‚Äçüë®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alguns leitores podem ter ouvido falar de Centrifugo antes. Este artigo se concentrar√° no desenvolvimento da segunda vers√£o do servidor e da nova bibl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Centrifugo v2 - o futuro do servidor de mensagens e da biblioteca em tempo real para Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/416915/"><p>  Alguns leitores podem ter ouvido falar de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Centrifugo</a> antes.  Este artigo se concentrar√° no desenvolvimento da segunda vers√£o do servidor e da nova biblioteca em tempo real para o idioma Go subjacente. </p><br><p>  Meu nome √© Alexander Emelin.  No ver√£o passado, entrei para a equipe do Avito, onde agora estou ajudando a desenvolver o back-end do Avito messenger.  O novo trabalho, diretamente relacionado √† entrega r√°pida de mensagens aos usu√°rios, e os novos colegas me inspiraram a continuar trabalhando no projeto Centrifugo de c√≥digo aberto. </p><br><p><img src="https://habrastorage.org/webt/cl/mo/yt/clmoytonrzc4exvj6eeky8j-zw4.jpeg"></p><a name="habracut"></a><br><p>  Em poucas palavras - este √© um servidor que assume a tarefa de manter conex√µes constantes dos usu√°rios do seu aplicativo.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O</a> polyfill <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Websocket</a> ou SockJS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√©</a> usado como transporte, se n√£o for poss√≠vel estabelecer uma conex√£o Websocket, trabalhar atrav√©s da fonte de eventos, streaming XHR, pesquisa longa e outros transportes baseados em HTTP.  Os clientes se inscrevem nos canais nos quais o back-end por meio da API do Centrifuge publica novas mensagens √† medida que elas surgem - ap√≥s o que as mensagens s√£o entregues aos usu√°rios inscritos no canal.  Em outras palavras, √© um servidor PUB / SUB. </p><br><p><img src="https://habrastorage.org/webt/-c/ws/k-/-cwsk-n9eulxk4cd7v9berdltzy.png"></p><br><p> Atualmente, o servidor √© usado em um n√∫mero bastante grande de projetos.  Entre eles, por exemplo, est√£o alguns projetos Mail.Ru (intranet, plataformas de treinamento Technopark / Technosphere, Centro de Certifica√ß√£o, etc.), com o Centrifugo, um belo painel funciona na recep√ß√£o no escrit√≥rio do Badoo Moscow, e 350 mil usu√°rios est√£o conectados simultaneamente ao servi√ßo spot.im para a centr√≠fuga. </p><br><p>  Alguns links para artigos anteriores no servidor e seu aplicativo para aqueles que ouviram falar sobre o projeto pela primeira vez: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mergulhe no Centrifugo</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Centrifugo - 3,5 milh√µes de rpm</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Bem como um artigo em ingl√™s que conta a hist√≥ria do projeto e a motiva√ß√£o para sua apar√™ncia</a> . </li></ul><br><p>  Comecei a trabalhar na segunda vers√£o em dezembro do ano passado e continuo at√© hoje.  Vamos ver o que acontece.  Estou escrevendo este artigo n√£o apenas para popularizar o projeto, mas tamb√©m para obter um feedback um pouco mais construtivo antes do lan√ßamento do Centrifugo v2 - agora h√° espa√ßo para manobras e altera√ß√µes incompat√≠veis com vers√µes anteriores. </p><br><h1 id="real-time-biblioteka-dlya-go">  Biblioteca em tempo real para Go </h1><br><p>  Na comunidade Go, a pergunta surge de tempos em tempos - existem alternativas para o socket.io no Go?  √Äs vezes eu notei como os desenvolvedores em resposta a isso s√£o aconselhados a olhar para o Centrifugo.  No entanto, o Centrifugo √© um servidor auto-hospedado, n√£o uma biblioteca - a compara√ß√£o n√£o √© justa.  Tamb√©m me perguntaram v√°rias vezes se o c√≥digo do Centrifugo pode ser reutilizado para escrever aplicativos em tempo real no Go.  E a resposta foi: teoricamente poss√≠vel, mas n√£o pude garantir a compatibilidade com vers√µes anteriores da API de pacotes internos por meu pr√≥prio risco.  √â claro que n√£o h√° motivo para algu√©m arriscar, e bifurca√ß√£o tamb√©m √© uma op√ß√£o.  Al√©m disso, eu n√£o diria que a API para pacotes internos geralmente foi preparada para esse uso. </p><br><p>  Portanto, uma das tarefas ambiciosas que eu queria resolver no processo de trabalho na segunda vers√£o do servidor foi tentar separar o n√∫cleo do servidor em uma biblioteca separada no Go.  Acredito que isso faz sentido, considerando quantos recursos o Centrifuge possui para se adaptar √† produ√ß√£o.  Existem muitos recursos dispon√≠veis prontos para ajudar a criar aplicativos escal√°veis ‚Äã‚Äãem tempo real, eliminando a necessidade de desenvolvedores criarem suas pr√≥prias solu√ß√µes.  Escrevi sobre esses recursos anteriormente e tamb√©m descreverei alguns deles abaixo. </p><br><p>  Tentarei justificar mais uma vantagem da exist√™ncia dessa biblioteca.  A maioria dos usu√°rios do Centrifugo s√£o desenvolvedores que escrevem um back-end em linguagens / frameworks com suporte fraco √† simultaneidade (por exemplo, Django / Flask / Laravel / ...): para trabalhar com muitas conex√µes persistentes, se poss√≠vel, de maneira n√£o √≥bvia ou ineficiente.  Consequentemente, nem todos os usu√°rios podem ajudar no desenvolvimento de um servidor escrito em Go (brega por falta de conhecimento da linguagem).  Portanto, mesmo uma comunidade muito pequena de desenvolvedores Go da biblioteca poder√° ajudar a desenvolver o servidor Centrifugo usando-o. </p><br><p>  O resultado √© uma biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">centr√≠fuga</a> .  Isso ainda √© WIP, mas absolutamente todos os recursos descritos na descri√ß√£o no Github est√£o implementados e funcionando.  Como a biblioteca fornece uma API bastante rica, antes de garantir a compatibilidade com vers√µes anteriores, gostaria de ouvir v√°rios exemplos bem-sucedidos de uso em projetos reais no Go.  Ainda n√£o h√°.  Bem como malsucedido :).  N√£o h√° nenhum. </p><br><p>  Entendo que, nomeando a biblioteca da mesma maneira que o servidor, lidarei para sempre com a confus√£o.  Mas acho que essa √© a escolha certa, j√° que os clientes (como centrifugadora-js, centrifugadora-go) trabalham com a biblioteca Centrifuge e o servidor Centrifugo.  Al√©m disso, o nome j√° est√° firmemente enraizado nas mentes dos usu√°rios, e eu n√£o quero perder essas associa√ß√µes.  E, no entanto, para um pouco mais de clareza, vou esclarecer novamente: </p><br><ul><li>  Centr√≠fuga - uma biblioteca para o idioma Go, </li><li>  O Centrifugo √© uma solu√ß√£o pronta para uso, um servi√ßo separado, que na vers√£o 2 ser√° constru√≠do na biblioteca do Centrifuge. </li></ul><br><p>  Devido ao seu design, o Centrifugo (um servi√ßo independente que n√£o sabe nada sobre o seu back-end) assume que o fluxo de mensagens via transporte em tempo real passar√° do servidor para o cliente.  Como assim?  Se, por exemplo, o usu√°rio gravar uma mensagem no bate-papo, essa mensagem dever√° ser enviada primeiro ao back-end do aplicativo (por exemplo, AJAX no navegador), validado no lado do back-end, salvo no banco de dados, se necess√°rio, e enviado √† API do Centrifuge.  A biblioteca remove essa restri√ß√£o, permitindo organizar a troca bidirecional de mensagens ass√≠ncronas entre o servidor e o cliente, al√©m de chamadas RPC. </p><br><p><img src="https://habrastorage.org/webt/jf/_d/er/jf_dervpzmkl2fuprcse34ayoke.png"></p><br><p>  Vejamos um exemplo simples: implementamos um pequeno servidor no Go usando a biblioteca Centrifuge.  O servidor receber√° mensagens dos clientes do navegador via Websocket, o cliente ter√° um campo de texto no qual voc√™ pode direcionar uma mensagem, pressione Enter - e a mensagem ser√° enviada a todos os usu√°rios inscritos no canal.  Ou seja, a vers√£o mais simplificada do chat.  Pareceu-me que seria mais conveniente colocar isso na forma de uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ess√™ncia</a> . </p><br><p>  Voc√™ pode executar como de costume: </p><br><pre><code class="go hljs">git clone https:<span class="hljs-comment"><span class="hljs-comment">//gist.github.com/2f1a38ae2dcb21e2c5937328253c29bf.git cd 2f1a38ae2dcb21e2c5937328253c29bf go get -u github.com/centrifugal/centrifuge go run main.go</span></span></code> </pre> <br><p>  E ent√£o v√° para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http: // localhost: 8000</a> , abra v√°rias guias do navegador. </p><br><p>  Como voc√™ pode ver, o ponto de entrada para a l√≥gica comercial do aplicativo ocorre ao desligar as fun√ß√µes de retorno de chamada <code>On().Connect()</code> : </p><br><pre> <code class="go hljs">node.On().Connect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, client *centrifuge.Client, e centrifuge.ConnectEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centrifuge</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectReply</span></span></span></span> { client.On().Disconnect(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e centrifuge.DisconnectEvent)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">centrifuge</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DisconnectReply</span></span></span></span> { log.Printf(<span class="hljs-string"><span class="hljs-string">"client disconnected"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> centrifuge.DisconnectReply{} }) log.Printf(<span class="hljs-string"><span class="hljs-string">"client connected via %s"</span></span>, client.Transport().Name()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> centrifuge.ConnectReply{} })</code> </pre> <br><p>  A abordagem baseada em retorno de chamada me pareceu a mais conveniente para interagir com a biblioteca.  Al√©m disso, uma abordagem semelhante, apenas de tipo fraco, √© usada na implementa√ß√£o do <a href="">servidor socket-io no Go</a> .  Se, de repente, voc√™ pensar em como a API poderia ser feita de maneira mais ling√º√≠stica - ficarei feliz em ouvir. </p><br><p>  Este √© um exemplo muito simples que n√£o demonstra todos os recursos da biblioteca.  Algu√©m pode observar que, para tais fins, √© mais f√°cil usar uma biblioteca para trabalhar com o Websocket.  Por exemplo, Gorilla Websocket.  Isto √© realmente verdade.  No entanto, mesmo neste caso, voc√™ ter√° que copiar uma parte decente do c√≥digo do servidor do exemplo no reposit√≥rio Gorilla Websocket.  E se: </p><br><ul><li>  voc√™ precisa dimensionar o aplicativo para v√°rias m√°quinas, </li><li>  ou voc√™ n√£o precisa de um canal comum, mas v√°rios - e os usu√°rios podem se inscrever e cancelar dinamicamente a partir deles √† medida que voc√™ navega no aplicativo, </li><li>  ou voc√™ precisa trabalhar quando a conex√£o Websocket n√£o p√¥de ser estabelecida (n√£o h√° suporte no navegador do cliente, h√° uma extens√£o do navegador, algum tipo de proxy no caminho entre o cliente e o servidor corta a conex√£o), </li><li>  ou voc√™ precisa restaurar as mensagens perdidas pelo cliente durante pequenos intervalos na conex√£o com a Internet sem carregar o banco de dados principal, </li><li>  ou voc√™ precisa controlar a autoriza√ß√£o do usu√°rio no canal, </li><li>  ou voc√™ precisa desconectar a conex√£o permanente dos usu√°rios desativados no aplicativo, </li><li>  ou voc√™ precisa de informa√ß√µes sobre quem est√° atualmente no canal ou sobre eventos nos quais algu√©m se inscreveu / se desinscreveu no canal, </li><li>  ou voc√™ precisa de m√©tricas e monitoramento? </li></ul><br><p>  A biblioteca do Centrifuge pode ajud√°-lo com isso - na verdade, ele herdou todos os recursos b√°sicos anteriormente dispon√≠veis no Centrifugo.  Mais exemplos mostrando os pontos mencionados acima podem ser encontrados no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Github</a> . </p><br><p>  O forte legado de Centrifugo pode ser um sinal negativo, pois a biblioteca adotou toda a mec√¢nica do servidor, que √© bastante original e, talvez, possa parecer √≥bvia ou sobrecarregada com recursos desnecess√°rios para algu√©m.  Tentei organizar o c√≥digo de maneira que os recursos n√£o utilizados n√£o afetassem o desempenho geral. </p><br><p>  Existem algumas otimiza√ß√µes na biblioteca que permitem um uso mais eficiente dos recursos.  Isso combina v√°rias mensagens em um quadro Websocket para economizar nas chamadas do sistema Write ou, por exemplo, usando o Gogoprotobuf para serializar mensagens do Protobuf e outras.  Falando em Protobuf. </p><br><h1 id="binarnyy-protobuf-protokol">  Protocolo Bin√°rio Protobuf </h1><br><p>  Eu realmente queria que o Centrifugo trabalhasse com dados bin√°rios ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">e n√£o apenas comigo</a> ), ent√£o na nova vers√£o eu queria adicionar um protocolo bin√°rio al√©m do existente com base no JSON.  Agora, todo o protocolo √© descrito como um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esquema Protobuf</a> .  Isso nos permitiu torn√°-lo mais estruturado, repensar algumas decis√µes n√£o √≥bvias no protocolo da primeira vers√£o. </p><br><p>  Acho que voc√™ n√£o precisa dizer h√° muito tempo quais s√£o as vantagens do Protobuf sobre o JSON - compacidade, velocidade de serializa√ß√£o, esquema r√≠gido.  Existe uma desvantagem na forma de ilegibilidade, mas agora os usu√°rios t√™m a oportunidade de decidir o que √© mais importante para eles em uma situa√ß√£o espec√≠fica. </p><br><p>  Em geral, o tr√°fego gerado pelo protocolo Centrifugo ao usar o Protobuf em vez do JSON deve diminuir em ~ 2 vezes (excluindo os dados do aplicativo).  O consumo de CPU nos meus testes de carga sint√©tica diminuiu as mesmas ~ 2 vezes em compara√ß√£o com o JSON.  Esses n√∫meros, na verdade, falam pouco sobre o que, na pr√°tica, tudo depender√° do perfil de carga de um aplicativo espec√≠fico. </p><br><p>  Por uma quest√£o de interesse, lancei em uma m√°quina com o benchmark Debian 9.4 e 32 Intel¬Æ Xeon¬Æ Platinum 8168 CPU a 2.70GHz vCPU, o que nos permitiu comparar a largura de banda da intera√ß√£o cliente-servidor no caso de usar o protocolo JSON e o protocolo Protobuf.  Havia 1000 inscritos em 1 canal.  Nesse canal, as mensagens foram publicadas em 4 fluxos e entregues a todos os assinantes.  O tamanho de cada mensagem era 128 bytes. </p><br><p>  Resultados para JSON: </p><br><pre> <code class="go hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -s ws:<span class="hljs-comment"><span class="hljs-comment">//localhost:8000/connection/websocket -n 1000 -ns 1000 -np 4 channel Starting benchmark [msgs=1000, msgsize=128, pubs=4, subs=1000] Centrifuge Pub/Sub stats: 265,900 msgs/sec ~ 32.46 MB/sec Pub stats: 278 msgs/sec ~ 34.85 KB/sec [1] 73 msgs/sec ~ 9.22 KB/sec (250 msgs) [2] 71 msgs/sec ~ 9.00 KB/sec (250 msgs) [3] 71 msgs/sec ~ 8.90 KB/sec (250 msgs) [4] 69 msgs/sec ~ 8.71 KB/sec (250 msgs) min 69 | avg 71 | max 73 | stddev 1 msgs Sub stats: 265,635 msgs/sec ~ 32.43 MB/sec [1] 273 msgs/sec ~ 34.16 KB/sec (1000 msgs) ... [1000] 277 msgs/sec ~ 34.67 KB/sec (1000 msgs) min 265 | avg 275 | max 278 | stddev 2 msgs</span></span></code> </pre> <br><p>  Resultados para o caso Protobuf: </p><br><pre> <code class="go hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run main.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -s ws:<span class="hljs-comment"><span class="hljs-comment">//localhost:8000/connection/websocket?format=protobuf -n 100000 -ns 1000 -np 4 channel Starting benchmark [msgs=100000, msgsize=128, pubs=4, subs=1000] Centrifuge Pub/Sub stats: 681,212 msgs/sec ~ 83.16 MB/sec Pub stats: 685 msgs/sec ~ 85.69 KB/sec [1] 172 msgs/sec ~ 21.57 KB/sec (25000 msgs) [2] 171 msgs/sec ~ 21.47 KB/sec (25000 msgs) [3] 171 msgs/sec ~ 21.42 KB/sec (25000 msgs) [4] 171 msgs/sec ~ 21.42 KB/sec (25000 msgs) min 171 | avg 171 | max 172 | stddev 0 msgs Sub stats: 680,531 msgs/sec ~ 83.07 MB/sec [1] 681 msgs/sec ~ 85.14 KB/sec (100000 msgs) ... [1000] 681 msgs/sec ~ 85.13 KB/sec (100000 msgs) min 680 | avg 680 | max 685 | stddev 1 msgs</span></span></code> </pre><br><p>  Voc√™ pode perceber que a taxa de transfer√™ncia de uma instala√ß√£o desse tipo √© duas vezes maior no caso do Protobuf.  O script do cliente pode ser encontrado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> - este √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">script de refer√™ncia</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nats adaptado √†s realidades do Centrifuge</a> . </p><br><p>  Tamb√©m √© importante notar que o desempenho da serializa√ß√£o JSON no servidor pode ser "aprimorado" usando a mesma abordagem que no gogoprotobuf - buffer pool e gera√ß√£o de c√≥digo - atualmente o JSON √© serializado por um pacote da biblioteca padr√£o Go constru√≠do em refletir.  Por exemplo, no Centrifugo, a primeira vers√£o do JSON √© serializada manualmente usando uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> que fornece <a href="">um buffer pool</a> .  Algo semelhante pode ser feito no futuro como parte da segunda vers√£o. </p><br><p>  Vale ressaltar que o protobuf tamb√©m pode ser usado ao se comunicar com o servidor a partir de um navegador.  O cliente javascript usa a biblioteca protobuf.js para isso.  Como a biblioteca protobufjs √© bastante pesada e o n√∫mero de usu√°rios no formato bin√°rio ser√° pequeno, usando o webpack e seu algoritmo de agita√ß√£o de √°rvore, geramos duas vers√µes do cliente - uma com suporte apenas ao protocolo JSON e outra com suporte a JSON e protobuf.  Para outros ambientes em que o tamanho dos recursos n√£o desempenha um papel t√£o cr√≠tico, os clientes n√£o podem se preocupar com essa separa√ß√£o. </p><br><h1 id="json-web-token-jwt">  Token da Web JSON (JWT) </h1><br><p>  Um dos problemas ao usar um servidor aut√¥nomo como o Centrifugo √© que ele n√£o sabe nada sobre seus usu√°rios e seu m√©todo de autentica√ß√£o, e que tipo de mecanismo de sess√£o seu back-end usa.  E voc√™ precisa autenticar a conex√£o de alguma forma. </p><br><p>  Para fazer isso, na primeira vers√£o do Centrifuge, ao conectar, foi usada a assinatura SHA-256 HMAC, com base em uma chave secreta conhecida apenas pelo back-end e pelo Centrifugador.  Isso garantiu que o ID do usu√°rio transmitido pelo cliente realmente pertencesse a ele. </p><br><p>  Talvez a transfer√™ncia correta dos par√¢metros de conex√£o e a gera√ß√£o de um token tenham sido uma das principais dificuldades na integra√ß√£o do Centrifugo no projeto. </p><br><p>  Quando a Centr√≠fuga apareceu, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o padr√£o JWT</a> ainda n√£o era t√£o popular.  Agora, alguns anos depois, as bibliotecas para gera√ß√£o JWT est√£o dispon√≠veis para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">os idiomas mais populares</a> .  A id√©ia principal do JWT √© exatamente o que a centr√≠fuga precisa: confirma√ß√£o da autenticidade dos dados transmitidos.  Na segunda vers√£o do HMAC, uma assinatura gerada manualmente deu lugar ao uso do JWT.  Isso tornou poss√≠vel remover a necessidade de suporte para fun√ß√µes auxiliares para a gera√ß√£o correta de tokens em bibliotecas para diferentes idiomas. </p><br><p>  Por exemplo, em Python, um token para conectar-se ao Centrifugo pode ser gerado da seguinte maneira: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> jwt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time token = jwt.encode({<span class="hljs-string"><span class="hljs-string">"user"</span></span>: <span class="hljs-string"><span class="hljs-string">"42"</span></span>, <span class="hljs-string"><span class="hljs-string">"exp"</span></span>: int(time.time()) + <span class="hljs-number"><span class="hljs-number">10</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>}, <span class="hljs-string"><span class="hljs-string">"secret"</span></span>).decode() print(token)</code> </pre> <br><p>  √â importante observar que, se voc√™ usar a biblioteca Centrifuge, poder√° autenticar o usu√°rio usando o m√©todo Go nativo - dentro do middleware.  Exemplos est√£o no reposit√≥rio. </p><br><h1 id="grpc">  GRPC </h1><br><p>  Durante o desenvolvimento, tentei o fluxo bidirecional GRPC como um transporte para comunica√ß√£o entre o cliente e o servidor (al√©m dos Websocket e dos fallbacks do SockJS baseados em HTTP).  O que posso dizer?  Ele trabalhou.  No entanto, n√£o encontrei um cen√°rio √∫nico em que o streaming GRPC bidirecional fosse melhor que o Websocket.  Eu olhei principalmente para as m√©tricas do servidor: tr√°fego gerado pela interface de rede, consumo de CPU pelo servidor com um grande n√∫mero de conex√µes de entrada, consumo de mem√≥ria por conex√£o. </p><br><p>  GRPC perdido para Websocket em todos os aspectos: </p><br><ul><li>  O GRPC gera 20% mais tr√°fego em cen√°rios semelhantes, </li><li>  O GRPC consome 2-3 vezes mais CPU (dependendo da configura√ß√£o das conex√µes - todos s√£o assinados em canais diferentes ou todos s√£o assinados em um canal), </li><li>  O GRPC consome 4 vezes mais RAM por conex√£o.  Por exemplo, em conex√µes de 10k, o servidor Websocket consumia 500Mb de mem√≥ria e GRPC - 2Gb. </li></ul><br><p>  Os resultados foram bastante ... esperados.  Em geral, no GRPC, como transporte de cliente, eu n√£o via muito sentido - e exclu√≠ o c√≥digo com a consci√™ncia limpa at√©, talvez, tempos melhores. </p><br><p>  No entanto, o GRPC √© bom no que foi criado principalmente - para gerar c√≥digo que permite fazer chamadas de RPC entre servi√ßos usando um esquema predeterminado.  Portanto, al√©m da API HTTP, o Centrifuge agora tamb√©m ter√° suporte √† API baseada em GRPC, por exemplo, para publicar novas mensagens no canal e outros m√©todos dispon√≠veis da API do servidor. </p><br><h1 id="slozhnosti-s-klientami">  Dificuldades com os clientes </h1><br><p>  As altera√ß√µes feitas na segunda vers√£o, removi o suporte obrigat√≥rio de bibliotecas para a API do servidor - ficou mais f√°cil a integra√ß√£o no lado do servidor, no entanto, o protocolo do cliente no projeto foi alterado e possui um n√∫mero suficiente de recursos.  Isso dificulta bastante a implementa√ß√£o dos clientes.  Para a segunda vers√£o, agora temos um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cliente para Javascript</a> que funciona em navegadores, que deve funcionar com NodeJS e React-Native.  H√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cliente no Go</a> e constru√≠do com base e com base <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nos fich√°rios do projeto gomobile</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">para iOS e Android</a> . </p><br><p>  Para uma felicidade completa, n√£o h√° bibliotecas nativas suficientes para iOS e Android.  Para a primeira vers√£o do Centrifugo, eles foram comprados por caras da comunidade de c√≥digo aberto.  Eu quero acreditar que algo assim vai acontecer agora. </p><br><p>  Recentemente, tentei a sorte enviando um pedido de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">concess√£o do MOSS da Mozilla</a> , com a inten√ß√£o de investir no desenvolvimento de clientes, mas fui recusado.  O motivo √© a comunidade insuficientemente ativa no Github.  Infelizmente, isso √© verdade, mas como voc√™ pode ver, estou tomando algumas medidas para melhorar a situa√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/y4/3q/kc/y43qkcl_yp7fjdgalrqvuzw5hl0.jpeg"></p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>  N√£o anunciei todos os recursos que aparecer√£o no Centrifugo v2 - h√° mais informa√ß√µes na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">edi√ß√£o do Github</a> .  A libera√ß√£o do servidor ainda n√£o ocorreu, mas ocorrer√° em breve.  Ainda existem momentos inacabados, incluindo a necessidade de preencher a documenta√ß√£o.  O prot√≥tipo da documenta√ß√£o pode ser visto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Se voc√™ √© um usu√°rio do Centrifugo, agora √© a hora certa de influenciar a segunda vers√£o do servidor.  Uma √©poca em que n√£o √© t√£o assustador quebrar algo, para depois fazer melhor.  Para os interessados: o desenvolvimento est√° concentrado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no ramo c2</a> . </p><br><p>  √â dif√≠cil para mim avaliar quanta demanda a biblioteca do Centrifuge subjacente ao Centrifugo v2 estar√° em demanda.  No momento, estou satisfeito por ter conseguido traz√™-lo ao seu estado atual.  O indicador mais importante para mim agora √© a resposta para a pergunta "eu mesmo usaria essa biblioteca em meu projeto pessoal?"  Minha resposta √© sim.  No trabalho?  Sim  Portanto, acredito que outros desenvolvedores ir√£o apreci√°-lo. </p><br><p>  PS Gostaria de agradecer aos caras que ajudaram no trabalho e nos conselhos - Dmitry Korolkov, Artemy Ryabinkov, Oleg Kuzmin.  Seria apertado sem voc√™. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt416915/">https://habr.com/ru/post/pt416915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt416905/index.html">Apresenta√ß√£o do Boston Dynamics SpotMini</a></li>
<li><a href="../pt416907/index.html">Teoria da felicidade. A lei da zebra e fila alien√≠gena</a></li>
<li><a href="../pt416909/index.html">Hist√≥rico de sess√µes ativas do PostgreSQL - nova extens√£o pgsentinel</a></li>
<li><a href="../pt416911/index.html">Os chatbots deveriam ser o pr√≥ximo avan√ßo: o que deu errado?</a></li>
<li><a href="../pt416913/index.html">O que o administrador deve esquecer ao mudar para a nuvem - e o que aprender</a></li>
<li><a href="../pt416917/index.html">S√©tima tristeza</a></li>
<li><a href="../pt416919/index.html">Burger King e grava√ß√£o de tela secreta do seu telefone</a></li>
<li><a href="../pt416921/index.html">Como centenas de milhares de antenas se re√∫nem em um telesc√≥pio</a></li>
<li><a href="../pt416925/index.html">O que sabemos sobre o Ant Design</a></li>
<li><a href="../pt416927/index.html">Startups de cal√ßados - e por que o Vale do Sil√≠cio as ama tanto</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>