<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÜüèø üë©üèΩ‚Äçüåæ üç§ Validaci√≥n en aplicaciones Java üßòüèæ üëÇ üë®üèº‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este texto est√° dedicado a varios enfoques para la validaci√≥n de datos: qu√© dificultades puede encontrar un proyecto y qu√© m√©todos y tecnolog√≠as deben...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Validaci√≥n en aplicaciones Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/427543/"><p>  <em>Este texto est√° dedicado a varios enfoques para la validaci√≥n de datos: qu√© dificultades puede encontrar un proyecto y qu√© m√©todos y tecnolog√≠as deben seguirse al validar datos en aplicaciones Java.</em> </p><br><p><img src="https://habrastorage.org/webt/cj/yc/yj/cjycyj3zf_l1ai9ch_vsgzisstk.png" alt="Validaci√≥n"></p><br><p>  A menudo vi proyectos cuyos creadores no se molestaron en elegir un enfoque para la validaci√≥n de datos.  Los equipos trabajaron en el proyecto bajo una presi√≥n incre√≠ble en forma de plazos y requisitos vagos, y como resultado, simplemente no tuvieron tiempo para una validaci√≥n precisa y consistente.  Por lo tanto, su c√≥digo de validaci√≥n est√° disperso en todas partes: en fragmentos de Javascript, controladores de pantalla, en contenedores de l√≥gica de negocios, entidades de dominio, disparadores y restricciones de la base de datos.  Este c√≥digo estaba lleno de declaraciones if-else, arroj√≥ un mont√≥n de excepciones, y trat√≥ de averiguar d√≥nde se valida ese dato en particular all√≠ ... Como resultado, a medida que el proyecto se desarrolla, se vuelve dif√≠cil y costoso cumplir con los requisitos (a menudo bastante confusos), y uniformidad de los enfoques para la validaci√≥n de datos. </p><br><p>  Entonces, ¬øhay alguna forma simple y elegante de validar los datos?  ¬øHay alguna manera que nos proteja del pecado de la imposibilidad de leer, una forma que junte toda la l√≥gica de validaci√≥n y que los desarrolladores de marcos populares de Java ya nos hayan creado? </p><br><p>  S√≠, existe tal manera. </p><a name="habracut"></a><br><p>  Para nosotros, los desarrolladores de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la plataforma CUBA</a> , es muy importante que pueda utilizar las mejores pr√°cticas.  Creemos que el c√≥digo de validaci√≥n debe: </p><br><ol><li>  Sea reutilizable y siga el principio SECO; </li><li>  Sea natural y comprensible; </li><li>  Colocado donde el desarrollador espera verlo; </li><li>  Poder verificar datos de diferentes fuentes: interfaz de usuario, llamadas SOAP, REST, etc. </li><li>  Trabajar en un entorno multiproceso sin problemas; </li><li>  Llamado dentro de la aplicaci√≥n autom√°ticamente, sin la necesidad de ejecutar controles manualmente; </li><li>  Para dar al usuario mensajes claros y localizados en cuadros de di√°logo concisos; </li><li>  Sigue los est√°ndares. </li></ol><br><p>  Veamos c√≥mo se puede implementar esto usando una aplicaci√≥n de ejemplo escrita usando el marco de la Plataforma CUBA.  Sin embargo, dado que CUBA se basa en Spring y EclipseLink, la mayor√≠a de las t√©cnicas utilizadas aqu√≠ funcionar√°n en cualquier otra plataforma Java que admita las especificaciones JPA y Bean Validation. </p><br><h2 id="validaciya-s-ispolzovaniem-database-constraints">  Validaci√≥n utilizando restricciones de base de datos </h2><br><p> Quiz√°s la forma m√°s com√∫n y obvia de validar datos es usar restricciones en el nivel de la base de datos, por ejemplo, el indicador requerido (para campos cuyo valor no puede estar vac√≠o), longitud de cadena, √≠ndices √∫nicos, etc.  Este m√©todo es el m√°s adecuado para aplicaciones empresariales, ya que este tipo de software generalmente se centra estrictamente en el procesamiento de datos.  Sin embargo, incluso aqu√≠ los desarrolladores a menudo cometen errores al establecer l√≠mites por separado para cada nivel de la aplicaci√≥n.  Muy a menudo, la raz√≥n radica en la distribuci√≥n de responsabilidades entre los desarrolladores. </p><br><p>  Considere un ejemplo que la mayor√≠a de nosotros conocemos, algunos incluso por nuestra propia experiencia ... Si la especificaci√≥n dice que debe haber 10 caracteres en el campo del n√∫mero de pasaporte, es muy probable que todos lo verifiquen: el arquitecto de la base de datos en DDL, el desarrollador del backend en la Entidad correspondiente y Servicios REST, y finalmente, el desarrollador de la interfaz de usuario directamente en el lado del cliente.  Luego, este requisito cambia y el campo aumenta a 15 caracteres.  Los desarrolladores cambian los valores de restricciones en la base de datos, pero nada cambia para el usuario, porque en el lado del cliente, la restricci√≥n es la misma ... </p><br><p>  Cualquier desarrollador sabe c√≥mo evitar este problema: ¬°la validaci√≥n debe estar centralizada!  En CUBA, dicha validaci√≥n se encuentra en las anotaciones de entidad JPA.  En funci√≥n de esta metainformaci√≥n, CUBA Studio generar√° el script DDL correcto y aplicar√° los validadores apropiados del lado del cliente. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/118/a16/f17/118a16f1705740a1676eb2c0ea164ef4.png" alt="Ejemplo de restricciones"></p><br><p>  Si las anotaciones cambian, CUBA actualizar√° los scripts DDL y generar√° los scripts de migraci√≥n, por lo que la pr√≥xima vez que implemente el proyecto, entrar√°n en vigencia nuevas restricciones basadas en JPA tanto en la interfaz como en la base de datos de la aplicaci√≥n. </p><br><p> A pesar de la simplicidad y la implementaci√≥n en el nivel de la base de datos, lo que brinda una confiabilidad absoluta a este m√©todo, el alcance de las anotaciones JPA se limita a los casos m√°s simples que se pueden expresar en el est√°ndar DDL y no incluyen disparadores de bases de datos o procedimientos almacenados.  Por lo tanto, las restricciones basadas en JPA pueden hacer que un campo de entidad sea √∫nico u obligatorio o establecer una longitud m√°xima de columna.  Incluso puede establecer una restricci√≥n √∫nica en la combinaci√≥n de columnas utilizando la anotaci√≥n <code>@UniqueConstraint</code> .  Pero eso es probablemente todo. </p><br><p>  Sea como fuere, en los casos que requieren una l√≥gica de validaci√≥n m√°s compleja, como verificar un campo para un valor m√≠nimo / m√°ximo, validar con una expresi√≥n regular o realizar una verificaci√≥n personalizada espec√≠fica solo para su aplicaci√≥n, se aplica el enfoque conocido como <strong>"Validaci√≥n de Bean"</strong> . </p><br><h2 id="bean-validation">  Validaci√≥n de frijol </h2><br><p>  Todos saben que es una buena pr√°ctica seguir los est√°ndares que tienen un ciclo de vida largo, cuya efectividad ha sido probada en miles de proyectos.  Java Bean Validation es un enfoque documentado en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">JSR 380, 349 y 303</a> y sus aplicaciones: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hibernate Validator</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Apache BVal</a> . </p><br><p>  Aunque este enfoque es familiar para muchos desarrolladores, a menudo se subestima.  Esta es una manera f√°cil de integrar la validaci√≥n de datos incluso en proyectos heredados, lo que le permite crear validaciones de manera clara, simple, confiable y lo m√°s cercana posible a la l√≥gica de negocios. </p><br><p>  Usar Bean Validation le da al proyecto muchas ventajas: </p><br><ul><li>  La l√≥gica de validaci√≥n se encuentra al lado del √°rea tem√°tica: la definici√≥n de restricciones para los campos y m√©todos del contenedor ocurre de una manera natural y verdaderamente orientada a objetos. </li><li>  El est√°ndar Bean Validation nos brinda docenas de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">anotaciones</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">validaci√≥n</a> <code>@NotNull</code> para <code>@NotNull</code> , por ejemplo: <code>@NotNull</code> , <code>@Size</code> , <code>@Min</code> , <code>@Max</code> , <code>@Pattern</code> , <code>@Email</code> , <code>@Past</code> , no del todo est√°ndar <code>@URL</code> , <code>@Length</code> , el <code>@ScriptAssert</code> m√°s poderoso y muchos otros . </li><li>  El est√°ndar no nos limita a las anotaciones ya hechas y nos permite crear las nuestras.  Tambi√©n podemos crear una nueva anotaci√≥n combinando varias otras, o definirla usando una clase Java separada como validador. <br>  Por ejemplo, en el ejemplo anterior, podemos establecer la anotaci√≥n del nivel de clase <code>@ValidPassportNumber</code> para verificar que el n√∫mero de pasaporte coincida con el formato seg√∫n el valor del campo del <code>country</code> . </li><li>  Las restricciones se pueden establecer no solo en campos o clases, sino tambi√©n en m√©todos y sus par√°metros.  Este enfoque se llama <strong>"validaci√≥n por contrato"</strong> y se discutir√° un poco m√°s adelante. </li></ul><br><p>  Cuando el usuario env√≠a la informaci√≥n ingresada, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Plataforma CUBA</a> <em>(como algunos otros marcos)</em> inicia Bean Validation autom√°ticamente, por lo que muestra instant√°neamente un mensaje de error si la validaci√≥n falla, y no necesitamos ejecutar los validadores bin manualmente. </p><br><p>  Volvamos al ejemplo con el n√∫mero de pasaporte, pero esta vez lo complementaremos con varias restricciones de la entidad Persona: </p><br><ul><li>  El campo de <code>name</code> debe tener 2 o m√°s caracteres y debe ser v√°lido.  (Como puede ver, regexp no es simple, pero "Charles Ogier de Batz de Castelmore Comte d'Artagnan" pasar√° la prueba, pero "R2D2" no lo har√°); </li><li>  <code>height</code> (altura) debe estar en el siguiente intervalo: <code>0 &lt; height &lt;= 300</code> cm; </li><li>  El campo de <code>email</code> debe contener una cadena que coincida con el formato del correo electr√≥nico correcto. </li></ul><br><p>  Con todos estos controles, la clase Persona se ver√° as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">9150857881422152651L</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Pattern</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Length</span></span>(min = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"NAME"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Email</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Email address has invalid format: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"EMAIL"</span></span>, length = <span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String email; <span class="hljs-meta"><span class="hljs-meta">@DecimalMax</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height can not exceed 300 centimeters"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"300"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@DecimalMin</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height should be positive"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"0"</span></span>, inclusive = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"HEIGHT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> BigDecimal height; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"COUNTRY"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Integer country; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORT_NUMBER"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, length = <span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String passportNumber; ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  Creo que el uso de anotaciones como <code>@NotNull</code> , <code>@DecimalMin</code> , <code>@Length</code> , <code>@Pattern</code> y similares es bastante obvio y no requiere comentarios.  Echemos un vistazo m√°s de cerca a la implementaci√≥n de la anotaci√≥n <code>@ValidPassportNumber</code> . </p><br><p>  Nuestro nuevo <code>@ValidPassportNumber</code> verifica que <code>Person#passportNumber</code> coincida con el patr√≥n regexp para cada pa√≠s especificado por el campo <code>Person#country</code> . </p><br><p>  Primero, veamos la documentaci√≥n (los manuales de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CUBA</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hibernate</a> est√°n bien), de acuerdo con esto, debemos marcar nuestra clase con esta nueva anotaci√≥n y pasarle el par√°metro de <code>groups</code> , donde <code>UiCrossFieldChecks.class</code> significa que esta validaci√≥n debe ejecutarse en la cruz. validaciones: despu√©s de verificar todos los campos individuales, <code>Default.class</code> guarda la restricci√≥n en el grupo de validaci√≥n predeterminado. </p><br><p>  La descripci√≥n de la anotaci√≥n se ve as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Constraint</span></span>(validatedBy = ValidPassportNumberValidator.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> ValidPassportNumber { <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> "Passport number is not valid"</span></span>; Class&lt;?&gt;[] groups() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; Class&lt;? extends Payload&gt;[] payload() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; }</code> </pre> <br><p>  <a href="">ValidPassportNumber.java</a> </p><br><p>  Aqu√≠ <code>@Target(ElementType.TYPE)</code> dice que el prop√≥sito de esta anotaci√≥n en tiempo de ejecuci√≥n es la clase, y <code>@Constraint(validatedBy = ‚Ä¶ )</code> determina que la validaci√≥n la realiza la clase <code>ValidPassportNumberValidator</code> que implementa la interfaz <code>ConstraintValidator&lt;...&gt;</code> .  El c√≥digo de validaci√≥n en s√≠ est√° en el <code>isValid(...)</code> , que realiza la verificaci√≥n real de una manera bastante directa: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumberValidator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstraintValidator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumber</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ValidPassportNumber constraint)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, ConstraintValidatorContext context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person.country == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || person.passportNumber == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doPassportNumberFormatCheck(person.getCountry(), person.getPassportNumber()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPassportNumberFormatCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CountryCode country, String passportNumber)</span></span></span><span class="hljs-function"> </span></span>{ ... } }</code> </pre> <br><p>  <a href="">ValidPassportNumberValidator.java</a> </p><br><p>  Eso es todo  Con la Plataforma CUBA, no necesitamos escribir nada m√°s que una l√≠nea de c√≥digo que har√° que nuestra validaci√≥n personalizada funcione y le d√© mensajes de error al usuario. <br>  Nada complicado, ¬øverdad? </p><br><p>  Ahora veamos c√≥mo funciona todo.  Aqu√≠ CUBA tiene otros nishtyaki: no solo le muestra al usuario un mensaje de error, sino que tambi√©n lo resalta en los campos rojos que no pasaron la validaci√≥n del bean: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/310/83d/b2b/31083db2b14d67d88de169542b59748a.png" alt="Representaci√≥n UI"></p><br><p>  ¬øNo es esa una soluci√≥n elegante?  Obtiene una visualizaci√≥n adecuada de los errores de validaci√≥n en la interfaz de usuario al agregar solo un par de anotaciones de Java a las entidades del √°rea tem√°tica. </p><br><p>  Para resumir la secci√≥n, enumeremos brevemente las ventajas de Bean Validation para las entidades una vez m√°s: </p><br><ol><li>  Es comprensible y legible; </li><li>  Le permite definir restricciones de valor directamente en clases de entidad; </li><li>  Se puede personalizar y complementar; </li><li>  Integrado en ORM populares, y las comprobaciones se ejecutan autom√°ticamente antes de guardar los cambios en la base de datos; </li><li>  Algunos marcos tambi√©n ejecutan la validaci√≥n de beans autom√°ticamente cuando el usuario env√≠a datos a la interfaz de usuario (y si no, es f√°cil llamar a la interfaz <code>Validator</code> manualmente); </li><li>  Bean Validation es un est√°ndar reconocido y est√° lleno de documentaci√≥n en Internet. </li></ol><br><p>  Pero, ¬øqu√© sucede si necesita establecer una restricci√≥n en un m√©todo, constructor o direcci√≥n REST para validar los datos provenientes de un sistema externo?  ¬øO si necesita verificar declarativamente los valores de los par√°metros del m√©todo, sin escribir c√≥digo aburrido con muchas condiciones if-else en cada m√©todo que se est√° probando? </p><br><p>  La respuesta es simple: ¬°La validaci√≥n de frijoles tambi√©n se aplica a los m√©todos! </p><br><h2 id="validation-by-contract">  Validaci√≥n por contrato </h2><br><p>  A veces es necesario ir m√°s all√° de la validaci√≥n del estado del modelo de datos.  Muchos m√©todos pueden beneficiarse de la validaci√≥n autom√°tica de par√°metros y el valor de retorno.  Esto puede ser necesario no solo para verificar los datos que van a las direcciones REST o SOAP, sino tambi√©n en aquellos casos en los que queremos anotar las condiciones previas y posteriores de las llamadas a m√©todos para asegurarnos de que los datos ingresados ‚Äã‚Äãse verificaron antes de que se ejecutara el cuerpo del m√©todo, o que el valor de retorno est√° en el rango esperado, o por ejemplo, solo necesitamos describir declarativamente los rangos de valores de los par√°metros de entrada para mejorar la legibilidad del c√≥digo. </p><br><p>  Usando la validaci√≥n de beans, se pueden aplicar restricciones a los par√°metros de entrada y valores de retorno de m√©todos y constructores para verificar las condiciones previas y posteriores de sus llamadas en cualquier clase de Java.  Esta ruta tiene varias ventajas sobre los m√©todos tradicionales de verificar la validez de los par√°metros y los valores de retorno: </p><br><ol><li>  No es necesario realizar comprobaciones manuales en un estilo imperativo (por ejemplo, lanzando <code>IllegalArgumentException</code> y similares).  Puede definir restricciones declarativamente y hacer que el c√≥digo sea m√°s comprensible y expresivo; </li><li>  Las restricciones se pueden configurar, reutilizar y configurar: no es necesario escribir la l√≥gica de validaci√≥n para cada verificaci√≥n.  Menos c√≥digo significa menos errores. </li><li>  Si la clase, el valor de retorno del m√©todo o su par√°metro se marca con la anotaci√≥n <code>@Validated</code> , la plataforma realizar√° las comprobaciones autom√°ticamente cada vez que se llame al m√©todo. </li><li>  Si el m√≥dulo ejecutable est√° marcado con la anotaci√≥n <code>@Documented</code> , sus condiciones <code>@Documented</code> y posteriores se incluir√°n en el JavaDoc generado. </li></ol><br><p>  Usando <strong>'validaci√≥n de contrato'</strong> obtenemos un c√≥digo claro, compacto y f√°cil de mantener. </p><br><p>  Por ejemplo, veamos la interfaz del controlador REST de una aplicaci√≥n CUBA.  La interfaz <code>PersonApiService</code> permite obtener una lista de personas de la base de datos usando el m√©todo <code>getPersons()</code> y agregar una nueva persona usando la <code>addNewPerson(...)</code> . </p><br><p>  ¬°Y no olvide que la validaci√≥n del bean se hereda!  En otras palabras, si anotamos una determinada clase, campo o m√©todo, todas las clases que heredan esta clase o implementan esta interfaz estar√°n sujetas a la misma anotaci√≥n de validaci√≥n. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Validated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonApiService</span></span></span><span class="hljs-class"> </span></span>{ String NAME = <span class="hljs-string"><span class="hljs-string">"passportnumber_PersonApiService"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Valid</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredView</span></span>(<span class="hljs-string"><span class="hljs-string">"_local"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Person&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPersons</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addNewPerson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @NotNull @Length(min = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">, max = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">255</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pattern</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, regexp = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String name, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height can not exceed 300 cm"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"300"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height should be positive"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, inclusive = </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> BigDecimal height, @NotNull CountryCode country, @NotNull String passportNumber )</span></span>; }</code> </pre> <br><p>  <a href="">PersonApiService.java</a> </p><br><p>  ¬øEs este fragmento de c√≥digo lo suficientemente claro? <br>  _ (Excepto la anotaci√≥n <code>@RequiredView(‚Äú_local‚Äù)</code> , que es espec√≠fica de la Plataforma CUBA y verifica que el objeto <code>Person</code> devuelto contiene todos los campos de la tabla <code>PASSPORTNUMBER_PERSON</code> ) ._ </p><br><p>  La <code>@Valid</code> define que cada objeto de colecci√≥n devuelto por el m√©todo <code>getPersons()</code> tambi√©n debe validarse contra las restricciones de la clase <code>Person</code> . </p><br><p>  En una aplicaci√≥n CUBA, estos m√©todos est√°n disponibles en las siguientes direcciones: </p><br><ul><li>  / app / rest / v2 / services / passportnumber_PersonApiService / getPersons </li><li>  / app / rest / v2 / services / passportnumber_PersonApiService / addNewPerson </li></ul><br><p>  Abramos la aplicaci√≥n Postman y asegur√©monos de que la validaci√≥n funcione como deber√≠a: </p><br><p><img src="https://habrastorage.org/webt/qg/ra/qj/qgraqjsxfyeqqa6qcjf2pkf7tcq.png" alt="Aplicaci√≥n de cartero"></p><br><p>  Como habr√°s notado, el n√∫mero de pasaporte no est√° validado en el ejemplo anterior.  Esto se debe a que este campo requiere una verificaci√≥n cruzada de los par√°metros del m√©todo <code>addNewPerson</code> , ya que la elecci√≥n de una plantilla de expresi√≥n regular para validar <code>passportNumber</code> depende del valor del campo del <code>country</code> .  ¬°Esta validaci√≥n cruzada es un an√°logo completo de las restricciones de entidad a nivel de clase! </p><br><p>  La validaci√≥n cruzada de par√°metros es compatible con JSR 349 ‚Äã‚Äãy 380. Puede leer la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n de hibernaci√≥n</a> para aprender c√≥mo implementar su propia validaci√≥n cruzada de m√©todos de clase / interfaz. </p><br><h2 id="za-predelami-bean-validation">  Validaci√≥n de frijol exterior </h2><br><p>  No hay perfecci√≥n en el mundo, por lo que la validaci√≥n de beans tiene sus inconvenientes y limitaciones: </p><br><ol><li>  A veces solo necesitamos verificar el estado de un gr√°fico complejo de objetos antes de guardar los cambios en la base de datos.  Por ejemplo, debe asegurarse de que todos los elementos de un pedido del cliente se coloquen en un paquete.  Esta es una operaci√≥n bastante dif√≠cil, y realizarla cada vez que el usuario agrega nuevos art√≠culos al pedido no es una buena idea.  Por lo tanto, tal verificaci√≥n puede ser necesaria solo una vez: antes de guardar el objeto <code>Order</code> y sus subobjetos <code>OrderItem</code> en la base de datos. </li><li>  Algunas comprobaciones deben hacerse dentro de una transacci√≥n.  Por ejemplo, el sistema de tienda electr√≥nica debe verificar si hay suficientes copias de los productos para cumplir con el pedido antes de enviarlo a la base de datos.  Tal verificaci√≥n solo se puede realizar dentro de una transacci√≥n, porque  El sistema es multiproceso y la cantidad de productos en stock puede cambiar en cualquier momento. </li></ol><br><p>  La plataforma CUBA ofrece dos mecanismos de validaci√≥n de datos previos al compromiso llamados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escuchas de entidades</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escuchas de transacciones</a> .  Consideremos con m√°s detalle. </p><br><h3 id="entity-listemers">  Oyentes de la entidad </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los oyentes de entidad en CUBA son</a> muy similares a los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>PreInsertEvent</code> , <code>PreUpdateEvent</code> y <code>PredDeleteEvent</code></a> que JPA ofrece al desarrollador.  Ambos mecanismos le permiten verificar los objetos de entidad antes y despu√©s de que est√©n almacenados en la base de datos. </p><br><p>  En CUBA, es f√°cil crear y conectar un escucha de entidad, para esto necesita dos cosas: </p><br><ol><li>  Cree un bean administrado que implemente una de las interfaces de escucha de la entidad.  3 interfaces son importantes para la validaci√≥n: <br>  <code>BeforeDeleteEntityListener&lt;T&gt;</code> , <br>  <code>BeforeInsertEntityListener&lt;T&gt;</code> , <br> <code>BeforeUpdateEntityListener&lt;T&gt;</code> </li> <li>  Agregue la anotaci√≥n <code>@Listeners</code> al objeto de entidad que planea rastrear. </li></ol><br><p>  Y eso es todo. </p><br><p>  En comparaci√≥n con el est√°ndar JPA (JSR 338, Secci√≥n 3.5), las interfaces de escucha de la Plataforma CUBA est√°n escritas, por lo que no es necesario emitir un argumento de tipo <code>Object</code> a un tipo de entidad para comenzar a trabajar con √©l.  La plataforma CUBA agrega entidades relacionadas o personas que llaman EntityManager la capacidad de cargar y modificar otras entidades.  Todos estos cambios tambi√©n invocar√°n al oyente de la entidad correspondiente. </p><br><p>  La plataforma CUBA tambi√©n admite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"eliminaci√≥n suave"</a> , un enfoque en el que, en lugar de eliminar registros de la base de datos, solo se marcan como eliminados y quedan inaccesibles para el uso normal.  Entonces, para la eliminaci√≥n suave, la plataforma llama a los oyentes <code>BeforeDeleteEntityListener</code> / <code>AfterDeleteEntityListener</code> , mientras que las implementaciones est√°ndar llamar√≠an a los <code>PostUpdate</code> <code>PreUpdate</code> / <code>PostUpdate</code> . </p><br><p>  Veamos un ejemplo.  Aqu√≠, el bean de escucha de eventos se conecta a la clase de entidad con solo una l√≠nea de c√≥digo: la anotaci√≥n <code>@Listeners</code> , que toma el nombre de la clase de escucha: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  La implementaci√≥n del oyente en s√≠ se ve as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Checks that there are no other persons with the same * passport number and country code * Ignores spaces in the passport number for the check. * So numbers "12 45 768007" and "1245 768007" and "1245768007" * are the same for the validation purposes. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonEntityListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeDeleteEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeInsertEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeUpdateEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeDelete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException( <span class="hljs-string"><span class="hljs-string">"Passport and country code combination isn't unique"</span></span>); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeInsert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// use entity argument to validate the Person object // entityManager could be used to access database // if you need to check the data // throw ValidationException object if validation check failed if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } @Override public void onBeforeUpdate(Person person, EntityManager entityManager) { if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } ... }</span></span></code> </pre> <br><p>  <a href="">PersonEntityListener.java</a> </p><br><p>  Los oyentes de entidades son una gran opci√≥n si: </p><br><ul><li>  Es necesario verificar los datos dentro de la transacci√≥n antes de que el objeto de entidad se almacene en la base de datos; </li><li>  Es necesario verificar los datos en la base de datos durante el proceso de validaci√≥n, por ejemplo, para verificar que haya suficiente producto en stock para aceptar el pedido; </li><li>  <code>OrderItems</code> mirar no solo el objeto de la entidad, como <code>Order</code> , sino tambi√©n las entidades relacionadas, por ejemplo, <code>OrderItems</code> para la entidad <code>Order</code> ; </li><li>  Queremos rastrear las operaciones de inserci√≥n, actualizaci√≥n o eliminaci√≥n solo para ciertas clases de entidad, por ejemplo, solo para <code>OrderItem</code> <code>Order</code> y <code>OrderItem</code> , y no necesitamos verificar los cambios en otras clases de entidades durante la transacci√≥n. </li></ul><br><h3 id="transaction-listeners">  Oyentes de transacciones </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los oyentes de transacciones CUBA</a> tambi√©n act√∫an en el contexto de transacciones, pero, en comparaci√≥n con los oyentes de entidades, se les llama para cada transacci√≥n de base de datos. </p><br><p>  Esto les da superpoder: </p><br><ul><li>  nada puede escapar de su atenci√≥n. </li></ul><br><p>  Pero esto est√° determinado por sus defectos: </p><br><ul><li>  son m√°s dif√≠ciles de escribir; </li><li>  pueden reducir significativamente el rendimiento; </li><li>  Deben escribirse con mucho cuidado: un error en el escucha de transacciones puede interferir incluso con la carga inicial de la aplicaci√≥n. </li></ul><br><p>  Por lo tanto, los oyentes de transacciones son una buena soluci√≥n cuando necesita inspeccionar diferentes tipos de entidades utilizando el mismo algoritmo, por ejemplo, verificando todos los datos en busca de fraude cibern√©tico con un solo servicio que sirve a todos sus objetos comerciales. </p><br><p><img src="https://habrastorage.org/webt/km/v9/co/kmv9cougmokpc3opta_dfk4egqk.jpeg" alt="¬°No pasar√°s!"></p><br><p>  Eche un vistazo a una muestra que verifica si la entidad tiene una anotaci√≥n <code>@FraudDetectionFlag</code> y, si la hay, inicia un detector de fraude.  Repito: tenga en cuenta que este m√©todo se llama en el sistema <strong>antes de confirmar cada transacci√≥n de la base de datos</strong> , por lo que el c√≥digo debe intentar verificar la menor cantidad posible de objetos. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_ApplicationTransactionListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTransactionListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeCommitTransactionListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Logger log = LoggerFactory.getLogger(ApplicationTransactionListener.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeCommit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EntityManager entityManager, Collection&lt;Entity&gt; managedEntities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Entity entity : managedEntities) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> StandardEntity &amp;&amp; !((StandardEntity) entity).isDeleted() &amp;&amp; entity.getClass().isAnnotationPresent(FraudDetectionFlag.class) &amp;&amp; !fraudDetectorFeedAndFastCheck(entity)) { logFraudDetectionFailure(log, entity); String msg = String.format( <span class="hljs-string"><span class="hljs-string">"Fraud detection failure in '%s' with id = '%s'"</span></span>, entity.getClass().getSimpleName(), entity.getId()); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException(msg); } } } ... }</code> </pre> <br><p>  <a href="">ApplicationTransactionListener.java</a> </p><br><p>  Para convertirse en un escucha de transacciones, un bean administrado debe implementar la interfaz <code>BeforeCommitTransactionListener</code> y el m√©todo <code>beforeCommit</code> .  Los oyentes de transacciones se vinculan autom√°ticamente cuando se inicia la aplicaci√≥n.  CUBA registra todas las clases que implementan <code>BeforeCommitTransactionListener</code> o <code>BeforeCommitTransactionListener</code> como escuchas de transacciones. </p><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p>  La validaci√≥n de frijoles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">(JPA 303, 349 y 980)</a> es un enfoque que puede servir como una base confiable para el 95% de los casos de validaci√≥n de datos encontrados en un proyecto corporativo.  La principal ventaja de este enfoque es que la mayor parte de la l√≥gica de validaci√≥n se concentra directamente en las clases de modelo de dominio.  Por lo tanto, es f√°cil de encontrar, f√°cil de leer y f√°cil de mantener.  Spring, CUBA y muchas otras bibliotecas son compatibles con estos est√°ndares y realizan autom√°ticamente verificaciones de validaci√≥n cuando reciben datos en la capa de IU, llaman a m√©todos validados o guardan datos a trav√©s de ORM, por lo que la validaci√≥n de Bean a menudo parece m√°gica desde el punto de vista del desarrollador. </p><br><p>  Algunos desarrolladores de software consideran que la validaci√≥n a nivel de clases del modelo de asignatura no es natural y es demasiado complicada, dicen que la validaci√≥n de datos a nivel de interfaz de usuario es una estrategia bastante efectiva.  Sin embargo, creo que numerosos puntos de validaci√≥n en componentes y controladores de UI no son el enfoque m√°s racional.   ,  ,  ,    ,     ,       listener'        . </p><br><p>  ,  ,     : </p><br><ol><li> <strong>JPA </strong>   ,          ,        DDL. </li><li> <strong>Bean Validation</strong> ‚Äî , , ,             .      ,       . </li><li> <strong>  </strong>  bean validation,    .        , ,   REST. </li><li> <strong>Entity listeners:</strong>      ,   Bean Validation,             . ,         .  Hibernate    . </li><li> <strong>Transaction listeners</strong> ‚Äî ,   ,    .  ,      ,                    . </li></ol><br><p> <em>PS: ,              Java,      ,    ,    .</em> </p><br><hr><br><h2 id="poleznye-ssylki">  Enlaces utiles </h2><br><div class="spoiler">  <b class="spoiler_title">Texto oculto</b> <div class="spoiler_text"><h3 id="standarty-i-ih-realizacii"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Est√°ndares y su implementaci√≥n </font></font></h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 303 - Validaci√≥n de frijoles 1.0</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349 ‚Äã‚Äã- Validaci√≥n de frijoles 1.1</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349, Especificaci√≥n de validaci√≥n de frijoles</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 380, especificaci√≥n de validaci√≥n de frijol</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencia de Hibernate Validator 5.4.2 (JSR 349)</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hibernate Validator 6.10 (JSR 380) reference</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hibernate Validator main page</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hibernate validator 6.10 API docs</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HV 6.10: Declaring and validating method constraints</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HV 6.10: Cross parameter constraints</a> </li></ul><br><h3 id="biblioteki">  Bibliotecas </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CUBA bean validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Validation cookbook for CUBA applications</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">JavaFX with Bean Validation and CDI 2.0</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OVal ‚Äî non a JSR 303, 349, 380 compliant validation framework</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Spring, Java Bean Validation Basics</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Validation, Data Binding, and Type Conversion in Spring 4.1</a> </li></ul><br><h3 id="filosofiya-validacii-dannyh">    </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Form validation best practices</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">JavaFX Form Validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Blah vs Bean Validation: you missed the point like Mars Climate Orbiter</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Avoiding Many If Blocks For Validation Checking</a> </li></ul><br><h3 id="materialy-dlya-dalneyshego-chteniya">     </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Validation cookbook for CUBA applications</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427543/">https://habr.com/ru/post/es427543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427533/index.html">Relojes inteligentes que no requieren carga. ¬øHay muchos de ellos?</a></li>
<li><a href="../es427535/index.html">Lanzamos una elecci√≥n colectiva de soluciones.</a></li>
<li><a href="../es427537/index.html">C√≥mo convertirse en un gerente de producto exitoso: cursos en los que est√° capacitado en este momento</a></li>
<li><a href="../es427539/index.html">La √∫ltima vez en Europa marca la hora del invierno</a></li>
<li><a href="../es427541/index.html">Amazon insta a Bloomberg a abandonar las reclamaciones de alto perfil en un art√≠culo sobre m√≥dulos de spyware chinos en servidores</a></li>
<li><a href="../es427545/index.html">Sistemas de informaci√≥n de "aterrizaje esperado" para el registro del transporte a√©reo en Rusia</a></li>
<li><a href="../es427549/index.html">Informe del Club de Roma 2018, Cap√≠tulo 1.6: comodines tecnol√≥gicos</a></li>
<li><a href="../es427551/index.html">¬øPor qu√© no podemos abandonar el teclado QWERTY?</a></li>
<li><a href="../es427555/index.html">Animales que los humanos han aprendido a rastrear utilizando la tecnolog√≠a de reconocimiento facial</a></li>
<li><a href="../es427557/index.html">Resumen de eventos de TI en noviembre (primera parte)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>