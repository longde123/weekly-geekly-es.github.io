<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîè üëÇüèª üë©üèæ‚Äçüíº Encore une fois sur les diagrammes de Voronoi üëêüèº üöï üÜö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme √©crit dans des articles de blog r√©cents , j'ai eu du mal √† obtenir les bons d√©tails du littoral dans mon jeu Dragons Abound . Ma d√©ception est s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Encore une fois sur les diagrammes de Voronoi</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439224/">  Comme √©crit dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">articles de</a> blog <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©cents</a> , j'ai eu du mal √† obtenir les bons d√©tails du littoral dans mon jeu <b>Dragons Abound</b> .  Ma d√©ception est survenue lors de la mise en place des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√Æles-barri√®res</a> .  Pour cr√©er l'√Æle la plus √©troite possible, je leur ai fait un emplacement de large - dans la figure ci-dessous, chaque emplacement est un triangle de Delaunay: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5dc/cce/739/5dccce739bdcd3372876b7cff72b4f0e.png"></div><br>  C'√©tait plut√¥t d√©sagr√©able - √† la fois parce que l'√Æle s'est av√©r√©e tr√®s cass√©e et parce que la taille des pi√®ces √©tait trop grande.  Il semblait qu'avec une forte augmentation du nombre de triangles Delaunay (c'est-√†-dire avec une forte diminution de leur taille), ce probl√®me serait r√©solu - mais la densit√© de triangles dont j'avais besoin a entra√Æn√© un crash du navigateur. <br><a name="habracut"></a><br>  J'ai r√©solu ce probl√®me en s√©parant les contours du terrain de la repr√©sentation interne des lieux.  Cela m'a permis de dessiner des √Æles de toute taille ou forme, quelle que soit la grille de localisation sous-jacente: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b2e/8a2/351/b2e8a235144cb7c07c9d374980be1782.png"></div><br>  Le probl√®me est donc r√©solu!  Cela m'a permis de dessiner les √Æles barri√®res, et comme le littoral n'est plus oblig√© de suivre la grille de base, si n√©cessaire, un littoral plus d√©taill√© pourrait √™tre cr√©√© de la mani√®re habituelle, puis ajouter des d√©tails. <br><br>  Mais ... comment ajouter des d√©tails au littoral?  Ce n'est pas aussi facile qu'on pourrait le penser.  Comme je voulais cr√©er un littoral fractal, j'ai envisag√© d'utiliser des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fractales pour ajouter des d√©tails</a> au littoral: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5b3/f94/9fd/5b3f949fd2649767029f2768d55a8185.png"></div><br>  Apr√®s avoir exp√©riment√© les param√®tres, j'ai pu ajouter beaucoup de d√©tails et de choses int√©ressantes au littoral.  Cependant, le syst√®me n'a pas pu cr√©er quelque chose ressemblant √† une telle carte: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ed/03d/701/0ed03d701f34074236f314574162073f.png"></div><br>  Le bruit de Perlin <i>peut</i> cr√©er ce type de terrain avec une grille de base suffisamment d√©taill√©e, mais cela peut-il √™tre fait <i>sans</i> stocker les hauteurs d'√©l√©vation dans la grille de base avec la r√©solution souhait√©e (apr√®s tout, je sais que cela va casser mon code)?  Jusqu'√† ce que je comprenne comment le faire.  Le littoral est essentiellement un chemin √† travers tous les points o√π la fonction de bruit Perlin a une valeur nulle.  Bien que nous puissions apprendre directement de la fonction de bruit Perlin la valeur dans un emplacement sp√©cifique (X, Y), nous ne pouvons pas trouver (par exemple) ¬´tous les emplacements dans lesquels la fonction a une valeur nulle¬ª.  Autrement dit, il est difficile de voir comment dessiner un contour de hauteurs sans grille de base. <br><br>  Pire encore, j'ai demand√© √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Amit</a> comment proc√©der, et il ne connaissait pas non plus la r√©ponse.  C'est une chose quand je ne peux pas dire cela, mais quand m√™me une personne aussi intelligente ne peut pas donner de r√©ponse, je commence √† penser que cela ne peut pas √™tre fait.  C'est triste.  Je peux donner au littoral toute forme dont j'ai besoin, mais je ne peux pas obtenir les formes dont j'ai besoin sans une grille de base tr√®s d√©taill√©e. <br><br>  Alors, comment puis-je obtenir une grille haute r√©solution sans casser le code? <br><br>  L'une des solutions qui m'est venue √† l'esprit me rappelle ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">qu'a fait Azgaar</a> dans son g√©n√©rateur de cartes: les cellules Voronoi de taille variable.  L'id√©e principale est d'augmenter la densit√© (et de diminuer la taille) du maillage de base le long des c√¥tes et de maintenir une densit√© plus faible dans les oc√©ans et d'autres zones qui ne n√©cessitent pas de d√©tails.  Avec cette option, je disposerai de nombreuses cellules maill√©es uniquement dans les zones o√π vous avez besoin de d√©tails.  Ce changement sera assez difficile √† impl√©menter dans <b>Dragons Abound</b> , mais je veux y r√©fl√©chir.  D'un autre c√¥t√©, Azgaar lui-m√™me <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">n'√©tait pas tr√®s satisfait de cette approche</a> , il faut donc √©galement en tenir compte. <br><br>  En parall√®le, je voulais √©tudier les causes d'un plantage du navigateur lors du traitement d'un tas de triangles.  Les outils de d√©veloppement de Chrome m'ont fourni des informations d√©taill√©es sur les performances.  Je ne suis en aucun cas un expert dans l'utilisation de ces outils, mais de nombreuses fonctions sont assez simples √† comprendre.  Si vous souhaitez conna√Ætre la quantit√© totale de m√©moire utilis√©e dans le programme, l'onglet M√©moire contient des informations sur la capacit√© actuellement utilis√©e: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ccd/da9/c31/ccdda9c31c29814b1ffa88b0ae5eefce.png"></div><br>  Dans ce cas, j'ai ouvert la page Web Azgaar, et elle occupe un modeste 20 Mo de m√©moire.  Vous pouvez utiliser cet outil pour conna√Ætre la quantit√© de m√©moire <b>occup√©e par Dragons Abound</b> et pour d√©terminer le moment o√π l'onglet se bloque. <br><br>  Le param√®tre de base qui contr√¥le la r√©solution du maillage sous-jacent dans <b>Dragons Abound est</b> habilement nomm√© ¬´npts¬ª (nombre de points).  Pour chaque zone d'unit√© de la carte (les cartes des r√©gions que j'utilise habituellement comme exemples ont une zone de 1 unit√©) <b>Dragons Abound</b> cr√©e un nombre donn√© d'emplacements de la grille de base.  J'utilise g√©n√©ralement 16K (16384) pour npts, ce qui signifie que chaque emplacement de grille correspond √† environ 70 pixels carr√©s de l'√©cran √† une √©chelle de zoom standard. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/73d/0a7/6ca/73d0a76ca2e25bf5c5724ef2c446b25c.png"></div><br>  Bien s√ªr, la quantit√© exacte de m√©moire utilis√©e d√©pend de la carte, mais pour la carte illustr√©e ci-dessus avec 16 000 points, vous avez besoin d'environ 92 Mo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/f8f/8c2/82ef8f8c28678bfb47a7a642761fe11e.png"></div><br>  C'est moins que ce √† quoi je m'attendais et, pour √™tre honn√™te, un chiffre assez modeste. <br><br>  Si vous doublez le nombre de points dans la grille de base, la capacit√© de m√©moire augmentera √† 138 Mo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/40d/beb/ad7/40dbebad7c52e1e833fef7372ac7d1d9.png"></div><br>  La taille de la m√©moire occup√©e n'a pas doubl√©, car une partie de cette m√©moire est occup√©e par des ressources et d'autres structures de donn√©es dont la taille n'a pas chang√©.  16 000 points suppl√©mentaires "p√®sent" environ 50 Mo de m√©moire, c'est-√†-dire que chaque point occupe par cons√©quent environ 3 Ko de m√©moire.  C'est plus que ce √† quoi je m'attendais, mais en g√©n√©ral le volume est encore assez modeste.  Sur un ordinateur avec 64 Go de m√©moire, 150 Mo sont √† peine perceptibles. <br><br>  Apr√®s avoir fait quelques doubles suppl√©mentaires, j'ai trouv√© que l'onglet avec <b>Dragons Abound</b> se bloque g√©n√©ralement √† environ 128K points.  Si nous l'attrapons avant qu'il ne vole et v√©rifions la m√©moire, nous verrons ce qui suit: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/718/c57/d27/718c57d27a1bce96fa73943e53196b9a.png"></div><br>  J'ai suppos√© que l'onglet se bloque en raison de la m√©moire occup√©e, mais g√©n√©ralement le probl√®me n'est pas dans la m√©moire.  Pourquoi l'onglet se bloque-t-il?  Le seul indice est que l'onglet ne plante pas avant la fin de la carte, et c'est probablement une indication qu'un crash se produit pendant le rendu. <br><br>  Il est logique de supposer que le SVG que je cr√©e surcharge le rendu du navigateur en raison de sa taille ou de sa complexit√©.  Pour commencer, je peux savoir combien d'√©l√©ments SVG je cr√©e.  En D3, je peux obtenir le nombre total d'√©l√©ments SVG cr√©√©s en utilisant <code>svg.selectAll('*').size()</code> . <br><br>  Courir √† partir de 16 000 points et v√©rifier le nombre d'√©l√©ments SVG m'a montr√© ce qui suit: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/14a/d15/77d/14ad1577d0e1f61b29e76bc36f57961f.png"></div><br>  32K points ont 65457 √©l√©ments et 128K points ont 258823. Chaque point ajout√© √† la grille de base ajoute deux √©l√©ments √† la carte.  Je pense avoir trouv√© une source de malheur. <br><br>  Chaque point de la grille de base ajoute des √©l√©ments SVG en raison de la fa√ßon dont <b>Dragons Abound rend la</b> terre (et l'eau).  Le terrain est rendu en rendant chaque emplacement de base sous la forme d'un polygone rempli, puis en les floutant tous.  Cela permet √† <b>Dragons Abound</b> de donner au terrain un beau motif ou d'utiliser la hauteur du terrain pour rendre le terrain avec un ombrage 3D, comme indiqu√© ici: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/294/b56/8c4/294b568c4939a297253b4fe4172eac0b.png"></div><br>  Vous pouvez d√©sactiver la visualisation de la terre et de l'oc√©an pour v√©rifier le nombre d'√©l√©ments SVG cr√©√©s.  √Ä 256 000 points: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ad7/e09/1e6/ad7e091e6c4c6de42207734830d508af.png"></div><br>  Wow, le nombre d'√©l√©ments SVG a consid√©rablement diminu√©.  Comme je l'esp√©rais, la carte est maintenant rendue sans planter!  Autrement dit, si vous √©vitez d'utiliser une grille pour rendre la terre et l'eau, vous pouvez cr√©er une grille beaucoup plus dense qu'auparavant. <br><br>  Maintenant que j'ai un r√©seau Voronoi beaucoup plus dense, je veux v√©rifier s'il me permet de g√©n√©rer les √©l√©ments de relief dont j'ai besoin, comme les √Æles c√¥ti√®res.  Le maillage dense de Voronoi cr√©e d'autres probl√®mes (en particulier avec les rivi√®res), donc je d√©sactiverai tout sauf les c√¥tes pour acc√©l√©rer les tests et me concentrer sur eux.  Voici le rendu original de certains littoraux √† 256K pixels et avec du bruit standard: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7c4/bad/0a0/7c4bad0a043f626a83d3edb071e5c77f.png"></div><br>  Il s'av√®re que la carte est bien rendue et cr√©e d√©j√† un littoral beaucoup plus beau. <br><br>  M√™me sans r√©glage minutieux, le r√©sultat est bien meilleur.  Le bruit cr√©e les types de c√¥tes fractales et d'√Æles c√¥ti√®res que j'ai indiqu√©es sur la carte ci-dessus. <br><br>  Voici les √Æles avec une augmentation de 300%: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b70/32e/471/b7032e471d8ac9c0029781799a43af56.png"></div><br>  Avec cette augmentation, vous pouvez remarquer des artefacts de triangles dans la grille de base, mais m√™me ainsi, les √Æles peuvent cr√©er des formes int√©ressantes.  Vous pouvez utiliser l'anti-aliasing (comme je le fais sur la version actuelle des cartes) pour se d√©barrasser de certains des artefacts les plus visibles des triangles.  Au grossissement standard, cela fournit un littoral moins accident√©, mais √©limine √©galement certains petits d√©tails: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6f/783/120/c6f78312049d55db06e1776250ce520a.png"></div><br>  Vous devez probablement vous connecter pour trouver un terrain d'entente. <br><br>  La plupart des g√©n√©rateurs de sushis proc√©duraux utilisent le bruit Perlin pour cr√©er une carte de hauteur.  Nous devons trouver les param√®tres de bruit appropri√©s, s√©lectionner une graine, puis utiliser la valeur de bruit √† chaque emplacement (x, y) pour d√©finir la masse du terrain.  Un aspect pratique de la cr√©ation d'un terrain est que si vous avez besoin de plus de d√©tails sur le littoral, vous pouvez simplement ajuster les param√®tres de bruit. <br><br>  Cependant, <b>Dragons Abound</b> ne cr√©e pas de terrain de cette fa√ßon.  (Ou du moins, cela cr√©e plus que cela.) <b>Dragons Abound</b> utilise de nombreuses m√©thodes diff√©rentes pour cr√©er des sushis.  Bien qu'ils utilisent tous le bruit √† un degr√© ou √† un autre, tr√®s peu cr√©ent des terrains directement √† partir du bruit.  Par exemple, le jeu a une proc√©dure pour cr√©er une √Æle qui cr√©e un masque pour l'√Æle (g√©n√©ralement une ellipse), utilise du bruit pour donner √† l'ellipse une forme plus naturelle, puis applique un bruit diff√©rent pour remplir approximativement le masque.  Chaque carte particuli√®re est g√©n√©ralement cr√©√©e par une combinaison de plusieurs proc√©dures diff√©rentes.  Par cons√©quent, l'ajout de d√©tails en ajustant les param√®tres de bruit pour <b>Dragons Abound n'est</b> pas tr√®s appropri√©. <br><br>  Pour mes besoins, il vaut mieux aborder le probl√®me sous un angle l√©g√®rement diff√©rent.  Si j'ai une carte d'√©l√©vation sp√©cifique qui d√©finit les masses terrestres, comment puis-je ajouter des d√©tails aux bords de ces masses terrestres?  Cela peut nous conduire √† l'id√©e que nous devons reconna√Ætre les bords des masses terrestres et masquer le reste de la carte, etc.  Mais, d'un autre c√¥t√©, je ne suis pas du tout contre l'ajout de d√©tails suppl√©mentaires au reste de la carte.  Si la terre est un peu plus accident√©e ou que le fond de l'oc√©an est un peu plus accident√©, c'est normal. <br><br>  Que signifie l'ajout de d√©tails au littoral?  Un littoral est simplement une ligne de contour dans laquelle une carte de hauteur a une valeur nulle.  (La valeur est arbitraire, mais un tel principe est utilis√© dans tous les g√©n√©rateurs de terres proc√©durales.) Pour rendre cette ligne plus d√©taill√©e, vous devez l√©g√®rement d√©placer l√©g√®rement la terre √† c√¥t√© de cette ligne de contour, de sorte que les c√¥tes simples deviennent plus complexes, des parties de la terre d√©passent dans l'oc√©an et deviennent √Æles, etc.  Mais cela ne devrait pas arriver tout √† fait par accident, je veux que les changements semblent naturels.  Nous r√©sumons tout cela, et il semble que vous devez ajouter une petite quantit√© de bruit √† toute la carte.  Et en fait, c'est exactement ce que j'ai fait dans l'exemple original ci-dessus. <br><br>  Bien s√ªr, cela doit √™tre fait avec soin afin de ne pas effacer les masses terrestres cr√©√©es et de cr√©er d'autres probl√®mes.  Essentiellement, je dois configurer trois param√®tres. <br><br>  Le premier est l'√©chelle du bruit.  Une √©chelle est simplement un intervalle de valeurs pour ce bruit.  Dans notre cas, je souhaite abaisser certaines zones vers le bas et augmenter certaines, de sorte que la plage de valeurs doit √™tre de n√©gative √† positive.  Cependant, je ne veux pas ajouter de nouvelles montagnes ou cr√©er un oc√©an loin du littoral existant, je ferai donc de la valeur maximale (absolue) du bruit une petite fraction de la hauteur standard du terrain. <br><br>  Le deuxi√®me param√®tre est la fr√©quence principale du bruit.  La fr√©quence d√©termine la vitesse √† laquelle le bruit change √† l'int√©rieur de l'emplacement.  Le bruit √† basse fr√©quence change tr√®s lentement, donc une zone positive avec du bruit √† basse fr√©quence peut (par exemple) couvrir toute la carte.  Le bruit √† haute fr√©quence change rapidement, donc une r√©gion positive avec du bruit √† haute fr√©quence peut (par exemple) avoir la taille d'une petite √Æle.  Dans notre cas, la fr√©quence de bruit principale d√©termine les plus grands √©l√©ments de relief que nous verrons dans le bruit.  Autrement dit, si je veux que le bruit ajoute (disons) de petites √Æles (mais rien de plus grand qu'eux) √† la carte, alors je dois s√©lectionner la fr√©quence principale de la taille d'une petite √Æle. <br><br>  Vous pourriez penser que c'est facile √† faire (il suffit de mesurer une petite √Æle et d'affecter cette taille √† la fr√©quence principale).  Cependant, la fr√©quence est mesur√©e dans les coordonn√©es de la fonction de bruit, pas dans les coordonn√©es de la carte!  Une fonction de bruit typique peut avoir un intervalle de 0 √† 255 dans chaque coordonn√©e, et une carte peut avoir un intervalle de -1 √† 1 dans chaque coordonn√©e. Pire encore, les coordonn√©es de bruit sont r√©duites, et de nombreux utilisateurs qui utilisent le bruit ne s'en rendent m√™me pas compte.  La traduction d'une unit√© √† l'autre et la d√©termination des fr√©quences appropri√©es sont source de confusion, il est donc g√©n√©ralement plus facile de simplement exp√©rimenter avec des intervalles de fr√©quence et de choisir celui qui cr√©e les √©l√©ments de carte de la bonne taille. <br><br>  Le troisi√®me param√®tre est le nombre d'octaves de bruit.  Les octaves sont des couches suppl√©mentaires de bruit.  Chaque couche double g√©n√©ralement la fr√©quence et r√©duit de moiti√© l'√©chelle de bruit.  Autrement dit, chaque nouveau calque ajoute des √©l√©ments en relief deux fois moins que le calque pr√©c√©dent, mais √©galement deux fois plus faibles.  Autrement dit, vous devez s√©lectionner le nombre d'octaves qui donnent les plus petits √©l√©ments dont nous avons besoin, et pour cela, vous devrez peut-√™tre ajuster l'√©chelle de bruit, car il est toujours suffisamment fort dans l'octave la plus √©lev√©e pour appara√Ætre sur la carte.  Comme je le fais intentionnellement pour rendre les c√¥tes tr√®s complexes, j'utiliserai pas mal d'octaves de bruit. <br><br>  Commen√ßons par la configuration.  Pour commencer, je vais g√©n√©rer un exemple de carte sans bruit suppl√©mentaire: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cf2/e89/ce9/cf2e89ce9f62d676f9659141be032e15.png"></div><br>  De toute √©vidence, c'est un littoral ennuyeux, avec des lignes douces et seulement quelques grandes √Æles.  Voici le m√™me littoral avec l'√©chantillon de bruit d'origine: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/035/e88/a62/035e88a62f7f2a79fd41e573016bb3aa.png"></div><br>  Le bruit a consid√©rablement chang√© la forme de la carte, transformant de grands fragments de terre en oc√©an, et vice versa.  De nombreuses √Æles sont √©galement apparues, y compris loin dans la mer.  Tout cela indique que l'√©chelle de bruit est trop grande.  Les plus grands √©l√©ments de relief individuels ajout√©s par le bruit devraient √™tre la taille des petites √Æles de la carte d'origine.  Il s'agit probablement de la nouvelle taille maximale des √©l√©ments, ce qui prouve que la fr√©quence principale du bruit est approximativement choisie correctement.  Enfin, de nombreux petits d√©tails sont apparus, jusqu'aux limites de la taille d'affichage, ce qui montre qu'il y a suffisamment d'octaves.  (Cependant, le nombre d'octaves peut √™tre plus que n√©cessaire. Cela n'affecte pas l'apparence de la carte, mais est inefficace.) Il semble que, fondamentalement, vous devez ajuster l'√©chelle de bruit. <br><br>  L'ajustement du bruit est une op√©ration assez compliqu√©e car je veux que ce bruit affecte principalement la terre et l'eau √† environ une ligne de contour avec une hauteur = 0. C'est-√†-dire que j'ai besoin d'une √©chelle relativement petite, mais il n'est pas clair comment choisir le bon nombre, car dans diff√©rentes cartes, la distribution des hauteurs varie.  La solution est de trouver la bonne √©chelle √† la vol√©e.  Vous pouvez prendre toutes les valeurs absolues des hauteurs sur la carte, les trier et trouver le point de coupure qui s√©lectionne (disons) 10% des emplacements autour de z√©ro.  Tous ces emplacements tombent dans l'intervalle (par exemple) [-0,05, 0,05], puis je peux utiliser la valeur 0,05 pour d√©terminer l'√©chelle du bruit ajout√©. <br><br>  (J'√©cris des ¬´d√©finitions¬ª parce que pour diverses raisons, vous ne pouvez pas simplement utiliser 0,05. Vous devez d'abord transformer la terre en eau et vice versa. L'ajout (disons) de 0,002 √† -0,05 n'apportera aucune modification visible √† la carte. Autrement dit, l'intervalle devrait √™tre bien sup√©rieur √† 0,05. si je veux convertir une proportion significative d'emplacements d'une hauteur de -0,05 de l'eau √† la terre. Deuxi√®mement, les fonctions de bruit ne sont pas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©parties uniform√©ment</a> , donc avec une √©chelle de 0,05, la fonction de bruit ne retournera jamais r√©ellement la valeur 0,05! En pratique, la difficult√© est que l'√©chelle doit √™tre beaucoup plus grande  que les plus grandes valeurs que nous voulons voir assez souvent.) <br><br>  Apr√®s avoir exp√©riment√©, j'ai trouv√© une valeur qui ajoute de la complexit√© aux c√¥tes, sans les modifier de mani√®re significative, et cr√©e √©galement un petit nombre d'√Æles: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3f9/2e5/19c/3f92e519c2370c7bbaa3338ef65a0944.png"></div><br>  Comme toujours, ces param√®tres dans le jeu peuvent prendre un intervalle de valeurs, donc je peux obtenir un large √©ventail de cartes: des cartes avec des c√¥tes assez lisses aux cartes avec des banques cass√©es et complexes.  En laissant le programme s√©lectionner les valeurs, j'ai obtenu le r√©sultat suivant: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43f/275/649/43f2756497cf54b7f95aa6a8f9cd5618.png"></div><br>  Les c√¥tes sont plus douces, mais il y a encore la plus grande partie de la complexit√© suppl√©mentaire de l'√©chelle moyenne et un nombre suffisant de nouvelles √Æles. <br><br>  Lors de la mise en ≈ìuvre des c√¥tes fractales, j'ai r√©alis√© la capacit√© de contr√¥ler le niveau de fractalisation √† l'aide de la fonction de bruit, de sorte que certaines zones auront des c√¥tes lisses, tandis que d'autres auront des c√¥tes complexes.  Je pensais que cela augmenterait consid√©rablement l'int√©r√™t de la carte et qu'elle serait moins ¬´g√©n√©r√©e¬ª, alors j'ajouterai cette fonctionnalit√© ici.  L'id√©e est assez simple - avant d'ajouter du bruit de c√¥te √† la carte, je le multiplie par la sortie de la deuxi√®me fonction de bruit, qui va de z√©ro √† 1. Lorsque cette fonction est petite, de petits d√©tails seront ajout√©s aux c√¥tes.  Lorsqu'il est proche de 1, des d√©tails suppl√©mentaires seront ajout√©s en totalit√©.  En s√©lectionnant l'√©chelle de la deuxi√®me fonction de bruit, qui varie lentement tout au long de la carte, j'obtiendrai certaines zones avec des c√¥tes complexes, d'autres avec des lignes simples et des transitions logiques entre elles: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/095/4a0/350/0954a03506ed074216606083654ceb08.png"></div><br>  Ici, j'ai rendu les param√®tres c√¥tiers grands, de sorte que la diff√©rence soit plus visible.  Nous voyons des c√¥tes sauvages et accident√©es au nord-est et des plages plus lisses √† l'ouest. <br><br>  Nous avons donc consid√©rablement am√©lior√© la g√©n√©ration du littoral, mais je ne parviens toujours pas √† g√©n√©rer une carte avec autant de triangles de Delaunay.  Je n'affiche que les cartes de contour car de nombreux autres √©l√©ments de carte sont cass√©s.  Il doit √™tre corrig√©. <br><br>  Le reste du programme ne fonctionne pas bien avec autant de triangles Delaunay (avec des param√®tres actuels de 256K).  Le principal probl√®me est que <b>Dragons Abound dessine la</b> terre et l'eau en dessinant tous les triangles individuels, et tant d'√©l√©ments SVG provoquent le crash du navigateur.  J'ai donc d√ª d√©sactiver compl√®tement le rendu des sushis.  Il existe probablement un moyen de contourner ce probl√®me, mais le fait d'avoir autant de triangles cr√©e d'autres probl√®mes.  Par exemple, certaines parties du programme doivent traiter l'int√©gralit√© de la carte.  Chacun d'entre eux devient seize fois plus lent √† 256 000 emplacements qu'√† 16 000 emplacements.  Dans le code, il existe √©galement des parties (par exemple, un nouveau mod√®le de pr√©cipitation) qui se brisent lorsque vous travaillez avec autant de triangles.  Et de la cr√©ation d'une grille de localisation aussi d√©taill√©e, nous ne gagnons rien - apr√®s avoir g√©n√©r√© le littoral, rien ne s'am√©liore de la complexit√© suppl√©mentaire.  Par cons√©quent, bien que je puisse revoir le programme et corriger les zones o√π un grand nombre d'emplacements ralentit ou casse trop le code, il semble plus facile de r√©duire la r√©solution de la grille de la carte apr√®s la cr√©ation des c√¥tes. <br><br>  Comme indiqu√© ci-dessus, Azgaar a d√©j√† effectu√© des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">travaux</a> pour modifier la r√©solution de la grille de Voronoi sous-jacente √† la carte.  Il a r√©alis√© la possibilit√© de changer la r√©solution de la grille √† la vol√©e dans le processus de g√©n√©ration, c'est-√†-dire qu'il pourrait (par exemple) augmenter la densit√© des emplacements le long de la c√¥te.  Cependant, un changement local de densit√© a ses inconv√©nients - en particulier, il cr√©e d'√©tranges triangles le long de la fronti√®re.  Azgaar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sugg√©r√©</a> plus tard que le syst√®me √©tait trop complexe et ne valait pas la peine.  Azgaar sait g√©n√©ralement de quoi il parle, donc je vais croire sur parole et je n'essaierai pas de reconditionner le maillage fini. <br><br>  Au lieu de cela, j'ai cr√©√© une deuxi√®me grille avec la r√©solution souhait√©e (inf√©rieure), puis copi√© la carte d'√©l√©vation dans cette nouvelle grille.  (N'oubliez pas que <b>Dragons Abound</b> stocke d√©sormais les c√¥tes s√©par√©ment de la grille, donc apr√®s leur cr√©ation, elles ne d√©pendent plus de l'ajustement exact de la grille. Pour ce faire, c'est un peu compliqu√©. √âtant donn√© que la grille d'origine a une r√©solution beaucoup plus √©lev√©e que la nouvelle, de nombreux emplacements dans l'original la grille sera superpos√©e √† un emplacement dans la nouvelle grille. Chacun de ces emplacements source a une hauteur diff√©rente sur la carte de hauteur, comment puis-je les copier? Utiliser la moyenne? Ou la hauteur maximale (minimale)? <br><br>  Pour commencer, je s√©lectionne simplement un emplacement al√©atoire pour voir si la nouvelle grille fonctionne avec le reste du programme: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3d2/6c4/0d3/3d26c40d3b59d96dd54c98a550352dde.png"></div><br>  Tout s'est √©tonnamment bien pass√©.  Un bug mineur se produit lorsque les nouveaux emplacements ne sont pas correctement marqu√©s comme terre, c√¥te ou eau, mais apr√®s avoir r√©solu ce probl√®me, la g√©n√©ration de la carte a bien fonctionn√©.  Vous devez nettoyer les d√©fauts mineurs (par exemple, le tag Palmanor qui est sorti sur l'eau), mais dans l'ensemble, il semble bon.  M√™me les petites √Æles se sont av√©r√©es magnifiques. <br><br>  Au final, j'ai d√©cid√© qu'avec une diminution de la r√©solution de la grille de Voronoi, chaque emplacement serait la moyenne des emplacements de base.  Cela semble √™tre une sage d√©cision, et si n√©cessaire, elle peut toujours √™tre modifi√©e.  Cette image montre comment, en cons√©quence, les c√¥tes ont √©t√© s√©par√©es du maillage fini: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c40/859/805/c40859805e84a195276b4cbaeaaa0796.png"></div><br>  Pour r√©sumer: dans <b>Dragons Abound</b> , une grille de triangles Delone √† tr√®s haute r√©solution est utilis√©e lors de la g√©n√©ration de la carte de hauteur.  Apr√®s son ach√®vement, <b>Dragons Abound</b> d√©finit les c√¥tes en suivant les transitions des valeurs n√©gatives aux valeurs positives dans la carte des hauteurs.  Ensuite, le jeu copie la grille haute r√©solution dans une grille de r√©solution beaucoup plus basse, en faisant la moyenne des emplacements qui tombent dans un emplacement de la nouvelle grille.  Ensuite, la grille haute r√©solution est supprim√©e et le reste de la g√©n√©ration proc√©durale et de la visualisation se poursuit sur la grille basse r√©solution.  Une question int√©ressante est de savoir si l'utilisation du maillage de Delaunay a une quelconque valeur √† ce stade;  il pourrait √™tre utile de copier sur une grille d'hexagones ou quelque chose de similaire. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439224/">https://habr.com/ru/post/fr439224/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439210/index.html">Java apr√®s une √©ruption volcanique</a></li>
<li><a href="../fr439216/index.html">pudge 500 ligne de base de donn√©es int√©grable sur Golang</a></li>
<li><a href="../fr439218/index.html">VK bot sur son genou, ou comment faire plaisir aux gens le 14 f√©vrier</a></li>
<li><a href="../fr439220/index.html">Grande ville pour les appareils mobiles sur Unity. Exp√©rience en d√©veloppement et optimisation</a></li>
<li><a href="../fr439222/index.html">Qu'est-ce que la gestion des API?</a></li>
<li><a href="../fr439226/index.html">Scala + MXNet = Microservice avec neurone en prod</a></li>
<li><a href="../fr439232/index.html">JAMstack: Comment cr√©er votre propre blog en utilisant Gatsby + Contentful + Netlify</a></li>
<li><a href="../fr439234/index.html">La vie du d√©veloppeur Open Source dans les GIF</a></li>
<li><a href="../fr439236/index.html">xenvman: environnements de test de microservices flexibles (et plus)</a></li>
<li><a href="../fr439238/index.html">Play Store accepte d√©sormais les applications Web progressives (PWA)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>