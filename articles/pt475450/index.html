<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèΩ ‚ôêÔ∏è üë©üèΩ‚Äçü§ù‚Äçüë®üèæ Bot de telegrama para uma sele√ß√£o personalizada de artigos de Habr üåø üë≤üèª üë®üèæ‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Para perguntas no estilo de "por qu√™?" H√° um artigo antigo - Natural Geektimes - tornando o espa√ßo mais limpo . 


 Muitos artigos, por raz√µes subjeti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot de telegrama para uma sele√ß√£o personalizada de artigos de Habr</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475450/"><p>  Para perguntas no estilo de "por qu√™?"  H√° um artigo antigo - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Natural Geektimes - tornando o espa√ßo mais limpo</a> . </p><br><p>  Muitos artigos, por raz√µes subjetivas, alguns n√£o gostam e outros, pelo contr√°rio, √© uma pena perder.  Quero otimizar esse processo e economizar tempo. </p><br><p>  O artigo acima prop√¥s uma abordagem com scripts no navegador, mas eu realmente n√£o gostei (apesar de ter usado antes) pelos seguintes motivos: </p><br><ul><li>  Para diferentes navegadores no seu computador / telefone, voc√™ deve configur√°-lo novamente, se poss√≠vel. </li><li>  A filtragem r√≠gida dos autores nem sempre √© conveniente. </li><li>  O problema com autores cujos artigos n√£o querem ser perdidos, mesmo que sejam publicados uma vez por ano, n√£o est√° resolvido. </li></ul><br><p>  A filtragem por classifica√ß√£o de artigo incorporada no site nem sempre √© conveniente, pois artigos altamente especializados, por todo o seu valor, podem receber uma classifica√ß√£o bastante modesta. </p><br><p>  Inicialmente, eu queria gerar feed RSS (ou mesmo alguns), deixando apenas o interessante por l√°.  Mas, no final, descobriu-se que ler rss n√£o era muito conveniente: em qualquer caso, para comentar / votar em um artigo / adicion√°-lo aos favoritos, voc√™ deve acessar o navegador.  Portanto, escrevi um bot para um telegrama que lan√ßa artigos interessantes para mim no PM.  O pr√≥prio Telegram faz com que sejam belas visualiza√ß√µes, o que, em combina√ß√£o com informa√ß√µes sobre o autor / classifica√ß√£o / visualiza√ß√µes, parece bastante informativo. </p><br><p><img src="https://habrastorage.org/webt/uk/e7/hr/uke7hrnmcthxqqzubouampuvlrw.png"></p><br><p>  Sob o corte, detalhes como recursos de trabalho, processo de escrita e solu√ß√µes t√©cnicas. </p><a name="habracut"></a><br><h2 id="kratko-o-bote">  Brevemente sobre o bot </h2><br><p>  Reposit√≥rio: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/Kright/habrahabr_reader</a> </p><br><p>  Bot de telegrama: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://t.me/HabraFilterBot</a> </p><br><p>  O usu√°rio define uma classifica√ß√£o adicional para tags e autores.  Depois disso, um filtro √© aplicado aos artigos - a classifica√ß√£o do artigo em Habr√©, a classifica√ß√£o do usu√°rio do autor e a m√©dia das classifica√ß√µes do usu√°rio por tags s√£o adicionadas.  Se a quantidade for maior que o valor limite definido pelo usu√°rio, o artigo passar√° pelo filtro. </p><br><p>  Um objetivo secund√°rio de escrever um bot era obter divers√£o e experi√™ncia.  Al√©m disso, lembrei-me regularmente de que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√£o era o Google</a> e, portanto, muitas coisas foram feitas da maneira mais simples e primitiva poss√≠vel.  No entanto, isso n√£o impediu que o processo de grava√ß√£o do bot se esticasse por tr√™s meses. </p><br><h2 id="za-oknom-bylo-leto">  Fora da janela era ver√£o </h2><br><p>  Julho terminou e eu decidi escrever um bot.  E n√£o sozinho, mas com um amigo que dominava a scala e queria escrever algo nela.  O come√ßo parecia promissor - o c√≥digo ser√° visto como "equipe", a tarefa parecia f√°cil e eu pensei que em algumas semanas ou um m√™s o bot estar√° pronto. </p><br><p>  Apesar de eu mesmo ter escrito c√≥digo sobre a rocha nos √∫ltimos anos, geralmente ningu√©m v√™ ou olha para esse c√≥digo: projetos de animais de estima√ß√£o, verifica√ß√£o de algumas id√©ias, pr√©-processamento de dados, dom√≠nio de alguns conceitos do FP.  Eu estava realmente interessado em como o c√≥digo da equipe se parece, porque o c√≥digo no rock pode ser escrito de maneiras muito diferentes. </p><br><p>  O que poderia ter acontecido?  No entanto, n√£o vamos apressar as coisas. <br>  Tudo o que acontece pode ser rastreado pelo hist√≥rico de confirma√ß√µes. </p><br><p>  Um amigo criou o reposit√≥rio em 27 de julho, mas n√£o fez mais nada, ent√£o comecei a escrever c√≥digo. </p><br><h3 id="30-iyulya">  30 de julho </h3><br><p>  Resumidamente: escrevi analisando feeds RSS de Habr. </p><br><ul><li> <code>com.github.pureconfig</code> para ler arquivos de configura√ß√£o typesafe diretamente nas classes de caso (acabou sendo muito conveniente) </li><li>  <code>scala-xml</code> para ler xml: como eu originalmente queria escrever minha implementa√ß√£o para fita rss e fita rss no formato xml, usei esta biblioteca para analisar.  Na verdade, a an√°lise de rss tamb√©m apareceu. </li><li>  <code>scalatest</code> para testes.  Mesmo para pequenos projetos, escrever testes economiza tempo - por exemplo, ao depurar a an√°lise de xml, √© muito mais f√°cil fazer o download para um arquivo, gravar testes e corrigir erros.  Quando um bug apareceu mais tarde com a an√°lise de algum html estranho com caracteres utf-8 inv√°lidos, tornou-se novamente mais conveniente coloc√°-lo em um arquivo e adicionar um teste. </li><li>  atores de Akka.  Objetivamente, eles n√£o eram necess√°rios, mas o projeto foi escrito por divers√£o, eu queria experiment√°-los.  Como resultado, estou pronto para dizer que gostei.  Pode-se olhar para a id√©ia de POO do outro lado - existem atores que trocam mensagens.  O que √© mais interessante - √© poss√≠vel (e necess√°rio) escrever c√≥digo de forma que a mensagem n√£o chegue ou n√£o possa ser processada (de modo geral, quando a conta est√° sendo executada em um √∫nico computador, as mensagens n√£o devem ser perdidas).  No come√ßo, eu estava desesperado e havia um lixo no c√≥digo com atores se inscrevendo, mas no final consegui criar uma arquitetura bastante simples e elegante.  O c√≥digo dentro de cada ator pode ser considerado de thread √∫nico; quando o ator trava, o Akka o reinicia - um sistema bastante tolerante a falhas √© obtido. </li></ul><br><h3 id="9-avgusta">  9 de agosto </h3><br><p>  Eu adicionei o projeto <code>scala-scrapper</code> para analisar p√°ginas html do Habr (para obter informa√ß√µes como classifica√ß√£o de artigos, n√∫mero de favoritos etc.). </p><br><p>  E Gatos.  Aqueles que est√£o na rocha. </p><br><p><img src="https://habrastorage.org/webt/52/t8/4v/52t84v4u6vw7z6prsq8iqpmn0d8.png"></p><br><p>  Depois, li um livro sobre bancos de dados distribu√≠dos, gostei da ideia de CRDT (tipo de dados replicado sem conflitos, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">habr</a> ), ent√£o filmei a classe de tipo do semigrupo comutativo para informa√ß√µes sobre o artigo sobre Habr√©. </p><br><p>  De fato, a ideia √© muito simples - temos contadores que mudam monotonamente.  O n√∫mero de promotores est√° crescendo suavemente, o n√∫mero de vantagens tamb√©m (no entanto, assim como o n√∫mero de desvantagens).  Se eu tiver duas vers√µes de informa√ß√µes sobre um artigo, voc√™ poder√° "mescl√°-las em uma" - considere o estado do contador que √© mais relevante. </p><br><p>  Um semigrupo significa que dois objetos com informa√ß√µes sobre um artigo podem ser mesclados em um.  Comutativo significa que voc√™ pode mesclar A + B e B + A, o resultado n√£o depende da ordem e, como resultado, a vers√£o mais recente permanece.  A prop√≥sito, a associatividade tamb√©m est√° aqui. </p><br><p>  Por exemplo, por design, o rss ap√≥s a an√°lise forneceu informa√ß√µes ligeiramente atenuadas sobre o artigo - sem m√©tricas, como o n√∫mero de visualiza√ß√µes.  Um ator especial pegou informa√ß√µes sobre os artigos e correu para as p√°ginas html para atualiz√°-las e mesclar com a vers√£o antiga. </p><br><p>  De um modo geral, como o akka, n√£o havia necessidade disso, era poss√≠vel armazenar updateDate para o artigo e adotar um mais novo sem fus√µes, mas fui conduzido por uma estrada de aventura. </p><br><h2 id="12-avgusta">  12 de agosto </h2><br><p>  Comecei a me sentir mais livre e, por interesse, tornei cada conversa um ator separado.  Teoricamente, um ator por si s√≥ pesa cerca de 300 bytes e pode ser criado pelo menos por milh√µes, portanto, essa √© uma abordagem completamente normal.  Parece-me uma solu√ß√£o bastante interessante: </p><br><p>  Um ator foi a ponte entre o servidor de telegrama e o sistema de mensagens em Akka.  Ele simplesmente recebeu mensagens e as enviou para o ator de bate-papo desejado.  O bate-papo do ator em resposta poderia enviar algo de volta - e foi enviado de volta aos telegramas.  O que foi muito conveniente - esse ator acabou sendo o mais simples poss√≠vel e continha apenas a l√≥gica da resposta √†s mensagens.  A prop√≥sito, informa√ß√µes sobre novos artigos chegavam a todos os bate-papos, mas, novamente, n√£o vejo nenhum problema nisso. </p><br><p>  Em geral, o bot j√° estava trabalhando, respondendo √†s mensagens, mantendo uma lista de artigos enviados ao usu√°rio, e eu j√° pensei que o bot estava quase pronto.  Eu terminei lentamente pequenos chips, como normalizar os nomes dos autores e tags (substituindo "sd f" por "s_d_f"). </p><br><p>  Havia apenas um <em>pequeno, mas</em> - o estado n√£o persistiu em lugar algum. </p><br><h2 id="vsyo-poshlo-ne-tak">  Tudo deu errado </h2><br><p>  Voc√™ deve ter notado que eu escrevi o bot principalmente sozinho.  Portanto, o segundo participante ingressou no desenvolvimento e as seguintes altera√ß√µes apareceram no c√≥digo: </p><br><ul><li>  Para armazenar o estado apareceu mongoDB.  Ao mesmo tempo, os logs quebraram no projeto, porque por alguma raz√£o os monga come√ßaram a envi√°-los por spam e algumas pessoas simplesmente os desativaram globalmente. </li><li>  A ponte ator no telegrama foi transformada al√©m do reconhecimento e come√ßou a analisar as pr√≥prias mensagens. </li><li>  Os atores das conversas estavam b√™bados sem piedade, em vez deles parecia um ator que escondia em si todas as informa√ß√µes sobre todas as conversas ao mesmo tempo.  Para cada espirro, esse ator entrava em mongu.  Bem, sim, √© dif√≠cil envi√°-lo a todos os atores do bate-papo ao atualizar informa√ß√µes sobre um artigo (somos como o Google, milh√µes de usu√°rios aguardam um milh√£o de artigos em um bate-papo para todos), mas √© normal entrar em um monga toda vez que voc√™ atualiza um bate-papo.  Como entendi muito mais tarde, a l√≥gica de trabalho dos chats tamb√©m foi completamente cortada e algo inoperante apareceu. </li><li>  N√£o h√° nenhum rastro das classes. </li><li>  Uma l√≥gica doentia apareceu nos atores com suas assinaturas, levando a uma condi√ß√£o de ra√ßa. </li><li>  Estruturas de dados com campos do tipo <code>Option[Int]</code> transformados em Int com valores padr√£o m√°gicos do tipo -1.  Mais tarde, percebi que o mongoDB armazena json e n√£o h√° nada de errado em armazenar <code>Option</code> ali, ou pelo menos analisar -1 como None, mas naquela √©poca eu n√£o sabia disso e acreditava na palavra "√© necess√°rio".  Esse c√≥digo n√£o foi escrito por mim e eu n√£o me preocupei em alter√°-lo por enquanto. </li><li>  Descobri que meu endere√ßo IP p√∫blico tem a propriedade de mudar e toda vez que eu precisava adicion√°-lo ao mongue da lista de permiss√µes.  Comecei o bot localmente, o monga estava em algum lugar nos servidores monga como empresa. </li><li>  De repente, a normaliza√ß√£o de tags e formata√ß√£o de mensagens para um telegrama desapareceu.  (Hmm, por que faria isso?) </li><li>  Gostei que o estado do bot esteja armazenado em um banco de dados externo e, ap√≥s a reinicializa√ß√£o, continue funcionando como se nada tivesse acontecido.  No entanto, esta foi a √∫nica vantagem. </li></ul><br><p>  A segunda pessoa n√£o estava com pressa e todas essas mudan√ßas apareceram em uma grande pilha j√° no in√≠cio de setembro.  N√£o apreciei imediatamente a escala do dano resultante e comecei a entender o banco de dados, porque  nunca tinha lidado com eles antes.  S√≥ ent√£o eu percebi quanto c√≥digo de trabalho foi cortado e quantos bugs foram adicionados em troca. </p><br><h2 id="sentyabr">  Setembro </h2><br><p>  No come√ßo, pensei que seria √∫til dominar Mongu e fazer tudo bem.  Ent√£o comecei lentamente a entender que organizar a comunica√ß√£o com o banco de dados tamb√©m √© uma arte na qual voc√™ pode fazer corridas e apenas erros.  Por exemplo, se duas mensagens do tipo <code>/subscribe</code> chegarem do usu√°rio e, em resposta a cada uma, criaremos uma entrada no prato, porque no momento do processamento dessas mensagens, o usu√°rio n√£o est√° assinado.  Eu suspeitava que a comunica√ß√£o com o monga na forma existente n√£o fosse escrita da melhor maneira.  Por exemplo, as configura√ß√µes do usu√°rio foram criadas no momento em que ele se inscreveu.  Se ele tentasse alter√°-los antes do fato da assinatura ... o bot n√£o respondeu, porque o c√≥digo no ator subiu ao banco de dados para as configura√ß√µes, n√£o p√¥de encontrar e travou.  Para a pergunta - por que n√£o criar as configura√ß√µes conforme necess√°rio, descobri que n√£o h√° nada para alter√°-las se o usu√°rio n√£o tiver se inscrito ... O sistema de filtragem de mensagens foi de alguma forma tornado √≥bvio e, mesmo depois de uma an√°lise minuciosa do c√≥digo, eu n√£o conseguia entender se ele foi originalmente concebido ou h√° um erro. </p><br><p>  N√£o havia uma lista de artigos enviados para o bate-papo, mas foi sugerido que eu mesmo os escrevesse.  Isso me surpreendeu - em geral, n√£o me opunha a arrastar todo tipo de pe√ßas para o projeto, mas seria l√≥gico extrair essas coisas e parafus√°-las.  Mas n√£o, o segundo participante parece ter esquecido tudo, mas disse que a lista dentro do bate-papo √© supostamente uma p√©ssima decis√£o, e voc√™ precisa criar um prato com eventos como "o artigo x foi enviado ao usu√°rio x".  Em seguida, se o usu√°rio solicitasse o envio de novos artigos, era necess√°rio enviar uma solicita√ß√£o ao banco de dados, qual dos eventos selecionaria eventos relacionados ao usu√°rio, ainda obteria uma lista de novos artigos, os filtraria, enviaria ao usu√°rio e lan√ßaria eventos sobre ele no banco de dados. </p><br><p>  O segundo participante sofreu em algum lugar na dire√ß√£o das abstra√ß√µes, quando o bot n√£o apenas receber√° artigos de Habr e enviar√° n√£o apenas para telegramas. </p><br><p>  De alguma forma, implementei os eventos na forma de um tablet separado na segunda quinzena de setembro.  N√£o √© o ideal, mas o bot pelo menos funcionou e come√ßou a me enviar artigos novamente, e eu lentamente descobri o que estava acontecendo no c√≥digo. </p><br><p>  Agora voc√™ pode voltar primeiro e lembrar que o reposit√≥rio n√£o foi originalmente criado por mim.  O que poderia ter acontecido?  Minha solicita√ß√£o de pool foi rejeitada.  Descobri que eu tinha um c√≥digo de acesso, que n√£o sabia trabalhar em equipe e tinha que editar bugs na curva de implementa√ß√£o atual e n√£o modific√°-lo para um estado utiliz√°vel. </p><br><p>  Fiquei chateado, olhei para o hist√≥rico de confirma√ß√µes, a quantidade de c√≥digo escrito.  Eu olhei para os momentos que foram originalmente bem escritos e depois quebrados ... </p><br><h2 id="frk-it">  F * rk it </h2><br><p>  Lembrei-me do artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Voc√™ n√£o √© o Google</a> . </p><br><p>  Eu pensei que ningu√©m realmente precisa de uma id√©ia sem implementa√ß√£o.  Eu pensei que eu quero ter um bot de trabalho que funcione em uma √∫nica c√≥pia em um √∫nico computador como um simples programa java.  Eu sei que meu bot funcionar√° por meses sem reiniciar, pois no passado eu escrevi esses bots.  Se ele cair repentinamente e n√£o enviar o pr√≥ximo artigo ao usu√°rio, o c√©u n√£o cair√° sobre a terra e nada de catastr√≥fico acontecer√°. </p><br><p>  Por que preciso de uma janela de encaixe, mongoDB e outro culto √† carga de software "s√©rio", se o c√≥digo n√£o funciona estupidamente ou funciona de maneira torta? </p><br><p>  Bifurquei o projeto e fiz tudo como queria. </p><br><p><img src="https://habrastorage.org/webt/ns/gh/ze/nsghzekle4yfth_aqyivbx17wxy.jpeg"></p><br><p>  Na mesma √©poca, mudei de emprego e faltava muito tempo livre.  De manh√£, acordei exatamente no trem, voltei tarde da noite e n√£o queria mais fazer nada.  N√£o fiz nada por um tempo, superei o desejo de terminar o bot e comecei a reescrever lentamente o c√≥digo enquanto dirigia para o trabalho pela manh√£.  N√£o posso dizer que foi produtivo: sentar em um trem tr√™mulo com um laptop no colo e espiar o excesso de pilhas do telefone n√£o √© muito conveniente.  No entanto, o tempo para escrever o c√≥digo passou despercebido e o projeto come√ßou a se mover lentamente para um estado de funcionamento. </p><br><p>  Em algum lugar no fundo, havia um worm de d√∫vida que o mongoDB queria usar, mas eu pensei que havia desvantagens vis√≠veis al√©m das vantagens do armazenamento em estado ‚Äúconfi√°vel‚Äù: </p><br><ul><li>  O banco de dados se torna outro ponto de falha. </li><li>  O c√≥digo est√° ficando mais dif√≠cil, e vou escrever por mais tempo. </li><li>  O c√≥digo se torna lento e ineficiente; em vez de alterar o objeto na mem√≥ria, as altera√ß√µes s√£o enviadas ao banco de dados e recuadas, se necess√°rio. </li><li>  Existem restri√ß√µes sobre o tipo de armazenamento de eventos em uma placa separada, os quais est√£o associados aos recursos do banco de dados. </li><li>  Na vers√£o de teste do monga, existem algumas restri√ß√µes e, se voc√™ as encontrar, precisar√° iniciar e configurar o mongu para alguma coisa. </li></ul><br><p>  Eu bebi Mongu, agora o estado do bot √© simplesmente armazenado na mem√≥ria do programa e, de tempos em tempos, √© salvo em um arquivo na forma de json.  Talvez nos coment√°rios eles escrevam que eu estou errado, porque √© aqui que voc√™ deve us√°-lo etc.  Mas este √© o meu projeto, a abordagem com o arquivo √© o mais simples poss√≠vel e funciona de maneira transparente. </p><br><p>  Joguei valores m√°gicos como -1 e retornei a <code>Option</code> normal, adicionei o armazenamento de uma placa de hash com os artigos enviados de volta ao objeto com informa√ß√µes de bate-papo.  Adicionada remo√ß√£o de informa√ß√µes sobre artigos com mais de cinco dias, para n√£o armazenar tudo em sequ√™ncia.  Ele trouxe o log em condi√ß√£o de trabalho - os logs em quantidades razo√°veis ‚Äã‚Äãs√£o gravados no arquivo e no console.  Foram adicionados v√°rios comandos de administra√ß√£o, como salvar estado ou obter estat√≠sticas como o n√∫mero de usu√°rios e artigos. </p><br><p>  Corrigi um monte de pequenas coisas: por exemplo, os artigos agora indicam o n√∫mero de visualiza√ß√µes, curtidas, desgostos e coment√°rios no momento em que o filtro do usu√°rio foi passado.  Em geral, √© incr√≠vel quantas pequenas coisas precisavam ser consertadas.  Eu mantive uma lista, anotei todas as ‚Äúrugosidade‚Äù l√° e as corrigi o mais longe poss√≠vel. </p><br><p>  Por exemplo, adicionei a capacidade de definir todas as configura√ß√µes diretamente em uma mensagem: </p><br><pre> <code class="plaintext hljs">/subscribe /rating +20 /author a -30 /author s -20 /author p +9000 /tag scala 20 /tag akka 50</code> </pre> <br><p>  E o comando <code>/settings</code> exibe neste formul√°rio, voc√™ pode pegar um texto e enviar todas as configura√ß√µes para um amigo. <br>  Parece um pouco, mas existem dezenas de nuances semelhantes. </p><br><p>  Filtragem de artigos implementada na forma de um modelo linear simples - o usu√°rio pode definir uma classifica√ß√£o adicional para autores e tags, al√©m de um valor limite.  Se a soma da classifica√ß√£o do autor, a classifica√ß√£o m√©dia das tags e a classifica√ß√£o real do artigo for maior que o valor limite, o artigo ser√° mostrado ao usu√°rio.  Voc√™ pode solicitar ao bot artigos com o comando / new ou assinar o bot e ele lan√ßar√° artigos no PM a qualquer hora do dia. </p><br><p>  De um modo geral, tive uma ideia para cada artigo desenhar mais sinais (hubs, n√∫mero de coment√°rios, marcadores, din√¢mica das altera√ß√µes de classifica√ß√£o, quantidade de texto, figuras e c√≥digo no artigo, palavras-chave) e o usu√°rio para mostrar o voto ok / n√£o ok em cada artigo e para cada usu√°rio treinar o modelo, mas fiquei com pregui√ßa. </p><br><p>  Al√©m disso, a l√≥gica do trabalho n√£o ser√° t√£o √≥bvia.  Agora eu posso colocar manualmente uma classifica√ß√£o de +9000 para o PatientZero e, com uma classifica√ß√£o de limiar de +20, eu garantirei o recebimento de todos os seus artigos (a menos que, √© claro, eu coloquei -100500 para todas as tags). </p><br><p>  A arquitetura resultante era bastante simples: </p><br><ol><li>  Um ator que armazena o estado de todos os chats e artigos.  Carrega seu estado de um arquivo em disco e, de tempos em tempos, salva-o novamente, cada vez em um novo arquivo. </li><li>  Um ator que ocasionalmente acessa o feed rss aprende sobre novos artigos, analisa os links, analisa e envia esses artigos para o primeiro ator.  Al√©m disso, ele √†s vezes solicita ao primeiro ator uma lista de artigos, seleciona aqueles que n√£o t√™m mais de tr√™s dias, mas n√£o s√£o atualizados h√° muito tempo, e os atualiza. </li><li>  Um ator que se comunica com um telegrama.  Ainda levei a an√°lise de mensagens completamente aqui.  De uma maneira boa, quero dividi-lo em dois - para que um analise as mensagens recebidas e o segundo lide com problemas de transporte, como encaminhar mensagens n√£o enviadas.  Agora n√£o h√° reenvio, e a mensagem que n√£o foi alcan√ßada devido a um erro ser√° simplesmente perdida (exceto que ser√° marcada nos logs), mas at√© agora isso n√£o causa problemas.  Talvez surjam problemas se um monte de pessoas se inscrever no bot e eu atingir o limite para o envio de mensagens). </li></ol><br><p>  O que eu gostei - gra√ßas a akka, a queda dos atores 2 e 3 em geral n√£o afeta o desempenho do bot.  Talvez alguns artigos n√£o sejam atualizados a tempo ou algumas mensagens n√£o cheguem ao telegrama, mas Akka reinicia o ator e tudo continua a funcionar mais.  Eu salvo as informa√ß√µes que o artigo √© mostrado ao usu√°rio somente quando o ator do telegrama responde que ele entregou a mensagem com sucesso.  A pior coisa que me amea√ßa √© enviar uma mensagem v√°rias vezes (se for entregue, mas a confirma√ß√£o for perdida de alguma maneira desconhecida).  Em princ√≠pio, se o primeiro ator n√£o mantivesse o estado em si mesmo, mas se comunicasse com algum tipo de banco de dados, ele tamb√©m poderia cair em sil√™ncio e voltar √† vida.  Eu tamb√©m poderia tentar a persist√™ncia do akka para restaurar o estado dos atores, mas a implementa√ß√£o atual me conv√©m com sua simplicidade.  N√£o que meu c√≥digo trava com frequ√™ncia - pelo contr√°rio, dediquei muito esfor√ßo para tornar isso imposs√≠vel.  Mas a merda acontece, e a capacidade de dividir o programa em partes isoladas - atores parecia realmente conveniente e pr√°tico para mim. </p><br><p>  Adicionado circle-ci para saber imediatamente quando o c√≥digo for quebrado.  Pelo menos que o c√≥digo parou de compilar.  Inicialmente, eu queria adicionar travis, mas mostrava apenas meus projetos sem os bifurcados.  Em geral, essas duas coisas podem ser usadas livremente em reposit√≥rios abertos. </p><br><h2 id="itogi">  Sum√°rio </h2><br><p>  J√° √© novembro.  O bot est√° escrito, usei-o nas √∫ltimas duas semanas e gostei.  Se voc√™ tem id√©ias para melhorias - escreva.  N√£o vejo o objetivo de gerar receita: deixe funcionar e envie artigos interessantes. </p><br><p>  Link para o bot: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://t.me/HabraFilterBot</a> <br>  Github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/Kright/habrahabr_reader</a> </p><br><p>  Pequenas conclus√µes: </p><br><ul><li>  Mesmo um projeto pequeno pode levar muito tempo. </li><li>  Voc√™ n√£o √© o Google.  N√£o faz sentido atirar em um pardal com um canh√£o.  Uma solu√ß√£o simples tamb√©m pode funcionar. </li><li>  Projetos de animais de estima√ß√£o s√£o muito adequados para experimentar novas tecnologias. </li><li>  Os bots de telegrama s√£o escritos de maneira bastante simples.  Se n√£o fosse por ‚Äútrabalho em equipe‚Äù e experimentos com tecnologias, o bot teria sido escrito em uma semana ou duas. </li><li>  O modelo do ator √© uma coisa interessante que combina bem com a resili√™ncia de v√°rios threads e c√≥digos. </li><li>  Parece-me que sinto por que a comunidade de c√≥digo aberto adora garfos. </li><li>  Os bancos de dados s√£o bons, pois o estado do aplicativo n√£o depende mais das falhas / reinicializa√ß√µes do aplicativo, mas o trabalho com o banco de dados complica o c√≥digo e imp√µe restri√ß√µes √† estrutura dos dados. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt475450/">https://habr.com/ru/post/pt475450/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt475438/index.html">Yekaterinburg, 19 de novembro - Meetup do Atlassian User Group</a></li>
<li><a href="../pt475440/index.html">Interfaces para monitorar o desempenho de bancos de dados populares no Foglight for Databases</a></li>
<li><a href="../pt475442/index.html">Visita √† sede do Google - Termos e condi√ß√µes</a></li>
<li><a href="../pt475444/index.html">Reatores industriais de ur√¢nio-grafite para produ√ß√£o de plut√¥nio</a></li>
<li><a href="../pt475448/index.html">Existem mais linhas de c√≥digo em um carro moderno do que ...</a></li>
<li><a href="../pt475452/index.html">Sele√ß√£o: 5 livros de marketing para ler para um fundador de startup</a></li>
<li><a href="../pt475458/index.html">Controle remoto com gatilho externo para c√¢meras SONY HDR no ESP8266</a></li>
<li><a href="../pt475462/index.html">Como localizar um jogo para celular no mercado asi√°tico</a></li>
<li><a href="../pt475464/index.html">A maneira do arquiteto: certifica√ß√£o e imers√£o em produtos</a></li>
<li><a href="../pt475466/index.html">Intel Xeon E-2200. N√∫cleos de servidor, or√ßamento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>