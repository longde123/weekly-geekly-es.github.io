<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë® ‚òÇÔ∏è üê∂ Aventures dans un flux s√©par√©. Rapport Yandex üíÖüèΩ üçÄ üéÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comment travailler avec des images sur le client, tout en conservant une interface utilisateur fluide? Le d√©veloppeur de l'interface Pavel Smirnov en ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aventures dans un flux s√©par√©. Rapport Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/453626/"> Comment travailler avec des images sur le client, tout en conservant une interface utilisateur fluide?  Le d√©veloppeur de l'interface Pavel Smirnov en a parl√© sur la base de l'exp√©rience de d√©veloppement de la recherche de photographies sur le march√©.  √Ä partir du rapport, vous pouvez apprendre √† utiliser correctement Web Workers et OffscreenCanvas. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/t_/ku/-u/t_ku-uoatzm936x50sn7rzjab5w.jpeg"></a> <br><br>  - Pendant cette demi-heure, nous parlerons d'aventures.  Je raconterai mon aventure et j'esp√®re vraiment que mon rapport vous inspirera et que vous prendrez et ferez de m√™me √† la maison. <br><br><a name="habracut"></a>  Au d√©but, je voulais parler de certaines technologies nouvelles ou pas tr√®s nouvelles que nos navigateurs nous donnent et qui nous permettent de faire des choses sympas.  Mais il me semble que ce ne serait pas tr√®s amusant, car tout le monde peut aller sur MDN et lire quelque chose.  Par cons√©quent, je vais raconter l'histoire d'une fonctionnalit√© que j'ai r√©alis√©e avec l'√©quipe Market. <br><br>  Pr√©sentons-moi encore une fois.  Je m'appelle Pasha, je suis d√©veloppeur d'interfaces au sein de l'√©quipe Market. <br><br><img src="https://habrastorage.org/webt/bc/vy/s_/bcvys_xxtyt4hekvl26k-9zdlga.jpeg"><br><br>  Je m'occupe principalement des interfaces mobiles - recherche de carte, carte d'offre.  Je r√©√©cris √©galement le code de l'ancienne pile vers la nouvelle, puis de la nouvelle vers une pile encore plus r√©cente.  Et j'essaye de rendre mes interfaces bonnes.  Ici, il vaut la peine de dire ce qu'est une bonne interface. <br><br>  Les bonnes interfaces ont des caract√©ristiques diff√©rentes.  Premi√®rement, c'est pratique; deuxi√®mement, c'est beau; troisi√®mement, c'est abordable.  Mais l'une des caract√©ristiques dont je veux parler aujourd'hui est la vitesse.  Et la vitesse se manifeste souvent dans la finesse de son travail.  M√™me de petites frises peuvent changer consid√©rablement l'exp√©rience utilisateur de nos interfaces. <br><br><img src="https://habrastorage.org/webt/p-/ww/kw/p-wwkw03iuh5yrgyfc-fjvubma8.jpeg"><br><br>  Passons au plan de ma conversation d'aujourd'hui.  Nous allons d'abord parler de la t√¢che que j'ai accomplie: trouver une image sur le march√©.  Ensuite, je vais vous dire quels probl√®mes j'ai d√ª r√©soudre pour impl√©menter cette fonctionnalit√©.  Ici, nous rappelons un peu comment fonctionne votre script dans le navigateur et regardons les technologies qui m'ont aid√©.  Petit spoiler: ce sont Web Workers et OffscreenCanvas. <br><br>  Revenons √† la t√¢che.  Il y a quelques mois, Luba, notre chef de produit, m'a approch√©.  Lyuba s'occupe des probl√®mes de choix d'un produit sur le march√©.  Nous avons maintenant plusieurs options pour trouver des marchandises.  L'un d'eux consiste √† saisir quelque chose dans la barre de recherche. <br><br><img src="https://habrastorage.org/webt/ul/m6/tn/ulm6tnl0vt8kdewxzrr1ofgfch0.jpeg"><br><br>  Par exemple, ¬´achetez un iPhone X rouge √† Samara¬ª.  Et nous trouverons quelque chose.  Ou nous pouvons utiliser l'arborescence du catalogue.  Dans ce catalogue, nous avons des cat√©gories et sous-cat√©gories. <br><br>  Mais que se passe-t-il si je veux trouver quelque chose sur le march√©, sans savoir comment √ßa s'appelle, mais soit j'ai une photo de cette chose, soit je la vois √† la f√™te de quelqu'un? <br><br><img src="https://habrastorage.org/webt/hz/0t/ne/hz0tnecdwmrqd4slxosbd4ghtgs.jpeg"><br><br>  Je vais raconter un cas r√©el.  Je suis all√© une fois avec mes amis dans un caf√©.  Nous avons command√© de la limonade l√†-bas, vous savez, dans une telle cruche, et cette cruche avait une chose tellement √©trange.  J'ai m√™me gard√© une photo.  Il √©tait destin√© √† ce que lorsque vous versez de la limonade dans un verre, la glace n'y p√©n√®tre pas.  Nous pensions que c'√©tait une bonne chose, mais nous avions des opinions diff√©rentes sur le nom de cette chose et, en g√©n√©ral, √† quoi elle √©tait destin√©e.  Par cons√©quent, nous l'avons trouv√© sur Yandex.Pictures. <br><br>  Mais j'ai pens√© - ce serait cool si je pouvais non seulement rechercher cette chose, mais aussi l'acheter imm√©diatement ou au moins trouver le prix, lire les avis, les sp√©cifications, etc. √Ä ce stade, nos r√™ves ont co√Øncid√© avec Any, et nous avons d√©cid√© faire une telle fonctionnalit√© sur le march√©. <br><br>  √Ä quoi ressemble cette fonctionnalit√©?  Il permet √† l'utilisateur de t√©l√©charger une photo ou une image, vous pouvez m√™me imm√©diatement prendre une photo et l'envoyer au march√©.  Nous analysons cette photo en utilisant les technologies de recherche Yandex, trouvons un produit dessus et montrons √† l'utilisateur les r√©sultats avec ces produits.  Cela semble simple, mais si c'√©tait aussi simple, je ne ferais pas mon rapport.  Pour vous assurer de ce type de fonctionnalit√©, permettez-moi de le montrer. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Regardez la premi√®re d√©mo</a></i> <br><br>  Je vais montrer sur la production.  Commen√ßons par t√©l√©charger la chose que nous recherchions et voyons ce qui se passe. <br><br>  Nous avons trouv√© des marchandises et plus pr√©cis√©ment cette chose.  Cette chose s'appelle une passoire.  Pour trouver autre chose, hier j'ai pris une photo d'un coll√®gue sur une table sur une table, cherchons-la.  Voici un tel livre, peut-√™tre que quelqu'un l'a lu.  Cela s'appelle "Perfect Code".  Il le trouve √©galement d'une mani√®re ou d'une autre, et pour une raison quelconque, avec une limite de 18+.  C'est probablement un peu √©trange. <br><br>  Revenons √† notre rapport.  Quels probl√®mes ai-je rencontr√©s?  Le premier probl√®me est que l'utilisateur commence √† t√©l√©charger quoi que ce soit, y compris des images √©normes.  Par exemple, mon t√©l√©phone prend des photos de trois √† quatre m√©gaoctets, ce qui est beaucoup.  L'envoi de telles photos au backend est inefficace.  Cela prend beaucoup de temps, cela prend beaucoup de temps pour les analyser, vous devez donc faire quelque chose.  Mais ici, tout est simple - nous recadrerons, compresserons, redimensionnerons cette photo sur le client. <br><br><img src="https://habrastorage.org/webt/gs/qm/fo/gsqmfoelkfhdlcmhijbrpl1u3b8.jpeg"><br><br>  Comment allons-nous proc√©der?  Nous avons un dossier.  Et nous lirons en quelque sorte ce fichier.  Nous lirons √† l'aide de l'API FileReader.  Je vais vous dire bri√®vement ce que c'est. <br><br><img src="https://habrastorage.org/webt/ii/c0/ip/iic0ipw8vjdg5mpre0x6yw3ye_q.jpeg"><br><br>  Il s'agit d'une telle API de navigateur qui nous permet de lire le fichier t√©l√©charg√© et de faire quelque chose avec.  Vous pouvez lire de diff√©rentes mani√®res, nous allons l'examiner maintenant.  Voici ses fonctionnalit√©s, et nous avons une sorte d'objet qui nous est retourn√© apr√®s avoir √©t√© entr√© par l'√©v√©nement change.  Essayons de le lire. <br><br><img src="https://habrastorage.org/webt/dd/t6/ya/ddt6yaay0twlpecj1rkwxhzob1w.jpeg"><br><br>  Le code ressemblera √† ceci.  Il n'y a encore rien de compliqu√© ici.  Nous avons un objet Reader cr√©√© √† partir du constructeur FileReader, sur lequel nous suspendons le d√©veloppeur de l'√©v√©nement de chargement.  Ensuite, nous lirons ce fichier en tant que DataURL.  DataURL - une cha√Æne qui repr√©sente le contenu du fichier encod√© via Base64.  Comme nous lisons, nous devons le couper en quelque sorte.  Tout d'abord, chargeons le tout dans une image.  Nous avons un √©l√©ment tag ou img, et nous le chargeons ici. <br><br><img src="https://habrastorage.org/webt/38/fo/oe/38fooeukiuqzgzmprkjqvpelgfw.jpeg"><br><br>  Le code ressemblera √† ceci.  Nous cr√©ons un √©l√©ment img, par l'√©v√©nement load Reader nous chargeons notre ligne dans l'attribut src et nous ferons tout plus loin lorsque notre ligne aura fini de se charger dans img. <br><br>  Nous ferons ce que nous voulions - recadrer l'image.  Nous allons le compresser, et ici une chose telle que Canvas nous aidera, un outil tr√®s puissant.  Cela vous permet de faire beaucoup.  Mais ici, nous dessinons simplement notre image sur cette toile, et si les tailles d'image d√©passent le maximum autoris√©, nous les adapterons un peu.  De plus, nous pouvons prendre cette image avec Canvas du taux de compression souhait√©. <br><br><img src="https://habrastorage.org/webt/if/zs/ny/ifzsnym6-fi7xyx8evc-_dvv4ni.jpeg"><br><br>  Quelque chose comme √ßa.  Autre petit avertissement: le code ici est grandement simplifi√©, je ne pr√©cise pas tout.  Nous avons la gestion des erreurs et d'autres choses, mais pour que tout tienne sur la diapositive et soit clair dans le rapport, j'ai omis certains d√©tails. <br><br>  Nous avons des tailles d'image, nous les regardons simplement.  Certaines constantes nous sont autoris√©es.  Si les tailles des images d√©passent nos constantes, nous les coupons juste en dessous et d√©finissons notre toile √† ces m√™mes tailles. <br><br>  Ensuite, nous allons dessiner notre image sur cette toile. <br><br><img src="https://habrastorage.org/webt/3n/c1/gr/3nc1gr71oyygkviglnhv9hwfzeg.jpeg"><br><br>  Prenez le contexte 2D, nous avons besoin d'une image 2D et essayez de dessiner en utilisant la m√©thode drawImage.  DrawImage est une m√©thode int√©ressante qui accepte, si je ne me trompe, neuf param√®tres.  Mais ils ne sont pas tous obligatoires, nous n'en utiliserons que cinq.  Nous prenons Image et ces deux z√©ros, c'est un d√©calage ou une indentation de l'image.  Nous avons besoin du point en haut √† gauche.  Dessinez avec les dimensions dont nous avons besoin. <br><br>  De plus, √† partir de ce canevas, nous prendrons notre cha√Æne Base64 encod√©e DataURL exactement de la m√™me mani√®re et la transformerons en blob - un objet sp√©cial qui est pratique pour nous √† envoyer au serveur.  Il semble que ce soit tout.  Tout fonctionne.  L'image est rogn√©e, l'image est envoy√©e, l'image est reconnue. <br><br>  Mais alors j'ai commenc√© √† remarquer quelque chose.  Lorsque j'ai test√© cette solution, lorsque j'ai t√©l√©charg√© une image, en particulier sur des appareils faibles, mon interface s'est un peu ralentie.  Soit le bouton n'a pas √©t√© enfonc√©, alors l'√©l√©ment n'a pas d√©fil√© ainsi.  Avez-vous eu l'impression que votre code fonctionne dans 99% des cas et fonctionne bien, mais parfois il ne fonctionne tout simplement pas?  Et vous pouvez le donner pour les tests, et probablement personne ne le remarquera.  Et les utilisateurs ne le remarqueront probablement pas, en particulier sur les appareils faibles. <br><br>  Cela ne m'est jamais arriv√© et j'ai d√©cid√© de le r√©parer.  Cela s'est av√©r√© √™tre un probl√®me.  Si l'image est grande, alors pendant les manipulations avec recadrage, compression, cela nous a pris du temps, et en ce petit, petit temps, notre interface ne r√©pondait pas. <br><br>  Au d√©but, j'ai compris pourquoi cela se produisait.  Ici, il vaut la peine de se rappeler comment JavaScript fonctionne dans le navigateur.  Je n'entrerai pas dans les d√©tails, c'est un sujet pour un gros rapport.  N'oubliez pas certains points. <br><br><img src="https://habrastorage.org/webt/rx/bq/-n/rxbq-nzhacdcemzt89xme0h331w.jpeg"><br><br>  Nous avons JavaScript en cours d'ex√©cution dans un seul thread, appelons-le principal.  Et nous avons une telle chose dans le navigateur comme une boucle d'√©v√©nements.  Ici, nous disons imm√©diatement qu'il s'agit d'un mod√®le.  Dans certains navigateurs, la boucle d'√©v√©nements est organis√©e diff√©remment, mais comme son nom l'indique, il s'agit g√©n√©ralement d'une boucle.  Il traite certaines t√¢ches dans la file d'attente dans l'ordre. <br><br>  Un moment d√©sagr√©able: tant qu'il n'aura pas ex√©cut√© une t√¢che, il ne passera pas √† la suivante.  Je vais montrer la d√©mo que j'ai vue, elle la montre.  C'est un classique. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Regardez la deuxi√®me d√©mo</a></i> <br><br>  J'ai une image GIF et une animation CSS r√©alis√©es de diff√©rentes mani√®res: l'une en utilisant translatex, l'autre en position: relative √† gauche, la troisi√®me en JavaScript, √† savoir requestAnimationFrame.  C'est l√† que le h√©risson tourne.  Que vais-je faire? <br><br>  Je vais bloquer le thread principal pendant cinq secondes.  Vous savez, les durs √† cuire calculent g√©n√©ralement le ni√®me nombre de Fibonacci, mais j'ai √©crit une boucle sans fin avec une pause en cinq secondes. <br><br>  Que va-t-il se passer?  Vous avez imm√©diatement remarqu√© que le h√©risson a cess√© de tourner et que le chat inf√©rieur, anim√© par translatex, a √©galement arr√™t√© de rouler.  Mais voyons la m√™me d√©mo dans un autre navigateur, par exemple Safari.  Le chat GIF a cess√© de courir. <br><br>  Pourquoi est-ce que je montre tout √ßa?  Premi√®rement, les navigateurs sont diff√©rents, vous devez en tenir compte.  Deuxi√®mement, lorsque notre flux est bloqu√© par quelque chose, certaines choses cesseront de fonctionner.  Par exemple - animation JavaScript.  Ou bien montrons que le texte ne se distinguera plus pour nous, les boutons ne seront plus press√©s. <br><br>  Ceci est un exemple tr√®s abstrait.  Ne bloquons pas le flux pendant cinq secondes, mais prenons notre t√¢che, t√©l√©chargeons une photo, recadrez-la, pressez-la et dessinez-la ici.  Nous ne l'enverrons nulle part, ce ne sera pas tr√®s r√©v√©lateur. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Regardez la troisi√®me d√©mo</a></i> <br><br>  J'ai un MacBook puissant ici, et pour que tout soit plus convaincant, nous allons ralentir le processeur de six fois.  Cela vous permet de faire des DevTools.  T√©l√©chargez notre photo.  Le code parfait nous aidera √† nouveau.  Comme nous le voyons, la m√™me chose se produit que lors du blocage du thread principal. <br><br>  Revenons ensuite √† notre t√¢che et r√©fl√©chissons √† la mani√®re dont nous allons y faire face. <br><br><img src="https://habrastorage.org/webt/us/bk/y1/usbky1tcsqcmijlpm7yvhzqejxu.jpeg"><br><br>  Soit dit en passant, si vous regardez le profileur, nous le verrons.  Dans le cadre rouge est notre microt√¢che, qui bloque le fil principal.  On voit qu'il le bloque pendant pr√®s de cinq secondes.  C'est sur un ordinateur assez puissant, et sur des appareils plus faibles, ce sera encore plus visible. <br><br>  Passons √† la solution.  Je dirai tout de suite ce que j'ai utilis√© et ce que j'ai fait, puis nous analyserons toutes ces choses.  Tout d'abord, j'ai utilis√© Web Workers.  Ils nous permettent de mettre certaines t√¢ches dans un thread s√©par√©.  Et deuxi√®mement, dans le contexte des Web Workers, le DOM n'est pas disponible pour nous.  Pour faire face √† cette situation, nous utiliserons d'autres outils.  L'image ne sera pas disponible pour nous, le canevas classique est disponible, et donc nous utilisons le canevas et quelques autres astuces. <br><br><img src="https://habrastorage.org/webt/fy/vw/f1/fyvwf1psmu5-m4szo28ffv7qykm.jpeg"><br><br>  Rappelons-nous rapidement ce que sont les travailleurs, √† quoi ils servent.  Ils vous permettent d'ex√©cuter JavaScript dans un thread s√©par√©, pas principalement.  Et le flux Workers n'interf√®re pas avec le flux de rendu de l'interface principale.  Par cons√©quent, nous pouvons effectuer des t√¢ches de calcul complexes sans ralentir notre interface. <br><br>  Nous avons un outil qui vous permet de transf√©rer quelque chose aux travailleurs et de retourner quelque chose des travailleurs.  Voyons un exemple. <br><br><img src="https://habrastorage.org/webt/tl/3n/gt/tl3ngt03saazi4u4c-jrw2qpsjs.jpeg"><br><br>  Nous cr√©ons donc notre Worker en utilisant le constructeur.  L√†, vous devez transf√©rer le chemin d'acc√®s au fichier.  On peut m√™me passer blob.  Et nous avons un gestionnaire d'√©v√©nements Message.  Dans ce cas, il affichera simplement quelque chose √† l'√©cran.  Ensuite, nous pouvons envoyer des donn√©es √† notre travailleur. <br><br><img src="https://habrastorage.org/webt/dz/d4/zq/dzd4zq9kr9xsjub1pznwor1m0cy.jpeg"><br><br>  Quel est le support?  Tout va bien ici.  Les travailleurs sont un outil bien connu, pas nouveau, mais beaucoup de mes amis pensent qu'ils ne sont pas toujours soutenus.  Ce n'est pas le cas. <br><br><img src="https://habrastorage.org/webt/qq/0p/iq/qq0piq8knelh8flsttmdu3nvmxc.jpeg"><br><br>  Regardons maintenant OffscreenCanvas.  Comme nous l'avons d√©j√† vu, Canvas est un outil tr√®s puissant, mais, malheureusement, il n'est pas disponible pour nous dans le contexte des Web Workers, nous allons donc utiliser une alternative.  C'est une chose assez nouvelle appel√©e OffscreenCanvas.  Il vous permet de faire √† peu pr√®s les m√™mes choses que Canvas, seulement d√©j√† hors de l'√©cran, c'est-√†-dire dans le contexte de Web Workers.  Bien s√ªr, nous pouvons le faire √©galement dans le contexte de la fen√™tre, mais maintenant nous ne le ferons pas. <br><br><img src="https://habrastorage.org/webt/g4/26/zz/g426zzs7plg7015gze3pivfyedc.jpeg"><br><br>  Qu'y a-t-il avec le support?  Comme vous pouvez le voir, il y a beaucoup de rouge.  OffscreenCanvas n'est normalement pris en charge que dans Chrome.  Il existe √©galement une option avec Firefox, mais jusqu'√† pr√©sent, il existe un indicateur, et Canvas ne fonctionne qu'avec le contexte WebGL.  Ici, vous pouvez demander - pourquoi est-ce que je parle d'une chose aussi cool que OffscreenCanvas, qui ne fonctionne nulle part? <br><br><img src="https://habrastorage.org/webt/ut/pg/po/utpgpozecg0ufn847t-jpfuleqe.jpeg"><br><br>  Une petite digression.  Nous avons certains niveaux de prise en charge des navigateurs sur le march√©.  Et nous avons deux quantit√©s.  Une valeur caract√©rise le navigateur, que nous ne prenons pas en charge du tout.  Cela repr√©sente environ la moiti√© du pourcentage de popularit√© du navigateur. <br><br>  Et il y a une deuxi√®me quantit√©.  Il comprend les navigateurs que nous prenons en charge, mais uniquement les fonctionnalit√©s essentielles.  Ici, sans Workers, toutes les fonctionnalit√©s de recherche fonctionnent, mais avec de petites frises.  Je pense que √ßa va, et notre √©quipe pense que √ßa va.  Voyons comment nous allons mettre cela en ≈ìuvre. <br><br><img src="https://habrastorage.org/webt/eo/p7/0l/eop70llp8tzton82fokyhi9c17e.jpeg"><br><br>  Voici un sch√©ma de ce que nous allons faire.  Nous avons m√™me des fichiers que nous lirons via FileReader.  Mais dans le flux principal, nous l'enverrons √† Web Workers, o√π il sera coup√©, compress√© et nous sera renvoy√©, et nous l'enverrons d√©j√† au serveur. <br><br><img src="https://habrastorage.org/webt/uq/zx/x_/uqzxx_ifbctkux0m1o1ogw5pauu.jpeg"><br><br>  Voyons le code de notre Worker.  Tout d'abord, nous cr√©ons une instance OffscreenCanvas avec la largeur et la hauteur dont nous avons besoin. <br><br>  De plus, comme je l'ai dit, l'√©l√©ment Image n'est pas disponible pour nous dans le contexte des travailleurs, nous utilisons donc ici la m√©thode createImageBitmap, qui fera de nous la structure de donn√©es qui caract√©rise notre image. <br><br>  De l'int√©ressant: nous voyons ici soi.  Ceux qui ne connaissent pas les Web Workers, cette chose indique le contexte d'ex√©cution.  Cela n'a pas d'importance pour nous ici, fen√™tre ou ceci, nous utilisons soi-m√™me.  Cette m√©thode est asynchrone, j'ai utilis√© l'attente ici pour la compacit√© et la commodit√©, pourquoi pas? <br><br>  Ensuite, nous obtenons la m√™me image et faisons la m√™me chose qu'auparavant.  Dessinez sur la toile et revenez. <br><br>  Du simple.  Nous avions l'habitude de prendre DataURL et de tout convertir en blob.  Mais ici, la m√©thode convertToBlob est imm√©diatement disponible pour nous.  Pourquoi ne l'ai-je pas utilis√© auparavant?  Parce que le soutien √©tait pire.  Mais depuis que nous sommes all√©s jusqu'ici et que nous utilisons OffscreenCanvas, qu'est-ce qui nous emp√™che d'utiliser convertToBlob? <br><br><img src="https://habrastorage.org/webt/a2/c-/bs/a2c-bssaaa8knh26p10fdta__zc.jpeg"><br><br>  Nous retournerons ce blob essentiellement un flux, d'o√π nous l'enverrons au serveur.  Ou, comme dans les d√©mos, dessinez-le. <br><br>  Nous cr√©ons donc un Worker dans le thread principal, en √©coutons certains messages et nous dessinons ou envoyons au serveur.  Il n'y a rien d'important ici.  Le travailleur acceptera nos fichiers. <br><br>  Revenons √† notre d√©mo. <br><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Regardez la quatri√®me d√©mo</a></i> <br><br>  Tout de m√™me d√©mo, tout de m√™me trois chats et un h√©risson.  Je r√©activerai la limitation, ralentissant le processeur six fois.  Je vais t√©l√©charger la m√™me photo.  Comme on le voit, au moment o√π l'image a √©t√© dessin√©e, les animations ne se sont pas arr√™t√©es, le h√©risson a continu√© √† tourner, l'interface est rest√©e et nous avons r√©alis√© ce que nous voulions. <br><br>  Mais cette d√©cision peut-elle √™tre am√©lior√©e? <br><br><img src="https://habrastorage.org/webt/sc/jo/x0/scjox0apap-ojlx03_gfvauava8.jpeg"><br><br>  Ici, au fait, le profileur.  Ici, nous ne voyons pas les √©normes microt√¢ches pendant les cinq secondes que nous avons vues auparavant. <br><br>  Une am√©lioration est possible.  Utilisation d'objets transf√©rables.  Ici, il vaut la peine d'y retourner.  Lorsque nous avons transmis notre DataURL ou blob via le m√©canisme postMessage, nous avons copi√© ces donn√©es.  Ce n'est probablement pas tr√®s efficace.  Ce serait cool de l'√©viter.  Par cons√©quent, nous avons un m√©canisme qui vous permet de transf√©rer des donn√©es vers Web Workers comme dans un package. <br><br>  Pourquoi dis-je ¬´j'aime¬ª?  Lorsque nous transf√©rons ces donn√©es aux travailleurs, nous perdons le contr√¥le sur eux dans le flux principal - nous ne pouvons en aucun cas interagir avec eux.  Il y a une deuxi√®me limitation ici.  Nous ne pouvons pas transf√©rer tous les types de donn√©es vers Web Workers.  Nous ne pouvons pas faire cela avec une cha√Æne, nous le ferons diff√©remment. <br><br><img src="https://habrastorage.org/webt/7s/ai/ml/7saimltvcz1_i2iwgxbfeoyqaxq.jpeg"><br><br>  Regardons le code.  Premi√®rement, nous transmettons les donn√©es un peu diff√©remment.  Voici notre postMessage.  Vous voyez, il existe un tel tableau avec loadEvent.target.result.  Une telle interface nous permet de transf√©rer nos donn√©es en tant qu'objets transf√©rables, en perdant le contr√¥le sur eux. <br><br>  Soit dit en passant, quiconque √©crit en Rust entendra probablement quelque chose de familier.  Et nous lirons notre fichier non pas comme une cha√Æne, mais comme un ArrayBuffer.  Il s'agit d'un flux de donn√©es binaires lidar auquel il n'y a pas d'acc√®s direct.  Par cons√©quent, nous devrons faire autre chose avec eux. <br><br><img src="https://habrastorage.org/webt/5j/o6/t8/5jo6t8mnnnnlquvzvnsnluqs__4.jpeg"><br><br>  Retour √† nos ImageWorkers.  Ici, c'est devenu beaucoup plus int√©ressant.  Tout d'abord, nous prenons notre tampon et faisons une chose aussi terrible que Uint8ClampedArray.  Il s'agit d'un tableau typ√©.  Comme son nom l'indique, les donn√©es qu'il contient sont les num√©ros de signe, c'est-√†-dire des nombres de z√©ro √† 255 qui repr√©senteront le pixel de notre image. <br><br>  Le troisi√®me argument, nous passons une chose aussi √©trange, comme la largeur, multipli√©e par la hauteur, multipli√©e par quatre.  Pourquoi exactement quatre?  Exactement, RGBA.  Il existe trois valeurs par couleur et une par canal alpha. <br><br>  Ensuite, nous cr√©erons ImageData √† partir de ce tableau, un type de donn√©es sp√©cial qui peut √™tre facilement dessin√© sur le canevas.  Rien d'int√©ressant ici.  Nous prenons simplement un tableau et le transmettons au constructeur.  De plus, de la m√™me mani√®re, nous dessinons notre image sur la toile, mais en utilisant une m√©thode diff√©rente, sous ImageData.  De plus, tout est le m√™me qu'avant. <br><br>  Passons aux conclusions.  Aujourd'hui, je vous ai parl√© d'une t√¢che que je n'avais pas effectu√©e il y a si peu de temps.  Qu'y ai-je remarqu√©? <br><br><img src="https://habrastorage.org/webt/0l/ay/mp/0laympqckrdgl8mbdfc7zozrgfa.jpeg"><br><br>  La fluidit√© de l'interface est tr√®s importante.  Lorsque l'utilisateur accuse un peu de retard, se fige un peu, le bouton n'est pas enfonc√©, cela peut entra√Æner une grave d√©t√©rioration de l'UX.  Les navigateurs fonctionnent diff√©remment.  Nous avons examin√© un exemple sph√©rique avec Safari et Yandex.Browser.  Nous voyons que si vous avez v√©rifi√© la fluidit√© de votre interface dans un navigateur, vous devriez regarder les autres. <br><br>  Vous devez faire quelque chose avec les scripts de blocage s'ils continuent pendant longtemps.  Dans mon cas, je l'ai mis sur Web Workers.  Mais il existe probablement d'autres approches, vous pouvez en quelque sorte les diviser en plus petites, vous devez r√©fl√©chir ici.            ,  Web Workers,        . <br><br>   ?        .  C'est tr√®s important.     .    ,      200     ,       . <br><br>     Web Workers  .   ,   ,         . <br><br>    : <br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">How Browsers Work: Behind the scenes of modern web browsers</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> WebGL/Three.js   OffscreenCanvas  -</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OffscreenCanvas ‚Äî Speed up Your Canvas Operations with a Web Worker</a> </li></ul><br>  . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453626/">https://habr.com/ru/post/fr453626/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453612/index.html">Football dans les nuages ‚Äã‚Äã- la mode ou une n√©cessit√©?</a></li>
<li><a href="../fr453614/index.html">D√©p√¥t npm local (hors ligne)</a></li>
<li><a href="../fr453616/index.html">Quel est le probl√®me avec la loi f√©d√©rale sur les signatures √©lectroniques (63-FZ) et comment y rem√©dier</a></li>
<li><a href="../fr453618/index.html">Comment nous travaillons avec les id√©es et comment LANBIX est n√©</a></li>
<li><a href="../fr453622/index.html">Programmeur de puces G-Shield: √©criture de certificats num√©riques sur des puces au stade de la production</a></li>
<li><a href="../fr453628/index.html">Que paierez-vous dans 20 ans?</a></li>
<li><a href="../fr453634/index.html">√âcole d'analyse syst√®me d'Alfa Bank</a></li>
<li><a href="../fr453642/index.html">Analyseur intelligent pour un nombre √©crit en mots</a></li>
<li><a href="../fr453644/index.html">Interview - 10 questions sur Swift. 3e partie</a></li>
<li><a href="../fr453646/index.html">Normalisation des donn√©es dans une base de donn√©es distribu√©e, des microservices et un ERP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>