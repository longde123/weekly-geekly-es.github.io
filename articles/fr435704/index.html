<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèª üíÇ üë∑üèº Solutions architecturales pour un jeu mobile. Partie 2: commande et leurs files d'attente üçî üë®üèΩ‚Äçü§ù‚Äçüë®üèº üë©üèΩ‚Äçü§ù‚Äçüë®üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans la premi√®re partie de l'article, nous avons examin√© comment le mod√®le doit √™tre organis√© de mani√®re √† √™tre facile √† utiliser, mais le d√©bogage et...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Solutions architecturales pour un jeu mobile. Partie 2: commande et leurs files d'attente</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435704/"><img src="https://habrastorage.org/webt/1n/ji/xq/1njixqpyay22mmuyckufhgouye8.jpeg"><br><br>  Dans la premi√®re partie de l'article, nous avons examin√© comment le mod√®le doit √™tre organis√© de mani√®re √† √™tre facile √† utiliser, mais le d√©bogage et le vissage des interfaces sont simples.  Dans cette partie, nous consid√©rerons le retour des commandes de changements dans le mod√®le, dans toute sa beaut√© et sa diversit√©.  Comme pr√©c√©demment, la priorit√© pour nous sera la commodit√© du d√©bogage, en minimisant les gestes qu'un programmeur doit faire pour cr√©er une nouvelle fonctionnalit√©, ainsi que la lisibilit√© du code pour une personne. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Solutions architecturales pour un jeu mobile.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1: Mod√®le</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Solutions architecturales pour un jeu mobile.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 3: Vue sur la pouss√©e du jet</a> <br><a name="habracut"></a><br><h2>  Pourquoi commander </h2><br>  Le mod√®le de commande sonne fort, mais en fait c'est juste un objet dans lequel tout ce qui est n√©cessaire pour l'op√©ration demand√©e y est ajout√© et stock√©.  Nous choisissons cette approche, au moins parce que nos √©quipes seront envoy√©es sur le r√©seau, et m√™me nous obtiendrons quelques copies de l'√©tat du jeu pour un usage officiel.  Ainsi, lorsque l'utilisateur clique sur le bouton, une instance de la classe de commandes est cr√©√©e et envoy√©e au destinataire.  La signification de la lettre C dans l'abr√©viation MVC est quelque peu diff√©rente. <br><br><h2>  Pr√©diction des r√©sultats et v√©rification des commandes sur le r√©seau </h2><br>  Dans ce cas, le code sp√©cifique est moins important que l'id√©e.  Et voici l'id√©e: <br><br>  Un jeu qui se respecte ne peut pas attendre une r√©ponse du serveur avant de r√©agir au bouton.  Bien s√ªr, Internet s'am√©liore et vous pouvez avoir un tas de serveurs partout dans le monde, et je connais m√™me quelques jeux r√©ussis en attente d'une r√©ponse du serveur, l'un d'eux est m√™me Summoning Wars, mais vous n'avez toujours pas besoin de le faire.  Parce que pour l'internet mobile, des retards de 5 √† 15 secondes sont plus susceptibles d'√™tre la norme qu'une exception, √† Moscou au moins, le jeu devrait √™tre vraiment g√©nial pour que les joueurs n'y fassent pas attention. <br><br>  En cons√©quence, nous avons un √©tat de jeu qui repr√©sente toutes les informations n√©cessaires √† l'interface, et les commandes lui sont appliqu√©es imm√©diatement, et seulement apr√®s cela, elles sont envoy√©es au serveur.  Habituellement, les programmeurs java assidus sont assis sur le serveur, dupliquant toutes les nouvelles fonctionnalit√©s une √† une dans une autre langue.  Sur notre projet ¬´cerfs¬ª, leur nombre a atteint 3 personnes, et les erreurs commises lors du portage ont √©t√© une source constante de joie insaisissable.  Au lieu de cela, nous pouvons le faire diff√©remment.  Nous ex√©cutons sur le serveur .Net et ex√©cutons c√¥t√© serveur le m√™me code de commande que sur le client. <br><br>  Le mod√®le d√©crit dans le dernier article nous offre une nouvelle opportunit√© int√©ressante pour l'auto-test.  Apr√®s avoir ex√©cut√© la commande sur le client, nous calculerons le hachage de la modification survenue dans l'arborescence GameState et l'appliquerons √† l'√©quipe.  Si le serveur ex√©cute le m√™me code de commande et que le hachage des modifications ne correspond pas, alors quelque chose s'est mal pass√©. <br><br>  Premiers avantages: <br><br><ul><li>  Cette solution acc√©l√®re consid√©rablement le d√©veloppement et minimise le nombre de programmeurs de serveurs. </li><li>  Si le programmeur a fait des erreurs conduisant √† un comportement non d√©terministe, par exemple, il a obtenu la premi√®re valeur du dictionnaire, ou a utilis√© DateTime.now, et a g√©n√©ralement utilis√© certaines valeurs non √©crites explicitement dans les champs de commande, puis quand heh d√©marre sur le serveur, elles ne correspondront pas, et nous le d√©couvrirons. </li><li>  Le d√©veloppement client peut pour l'instant se faire sans serveur du tout.  Vous pouvez m√™me passer en alpha convivial sans avoir de serveur.  C'est utile non seulement pour les d√©veloppeurs ind√©pendants qui manquent leur jeu de r√™ve la nuit.  Quand j'√©tais √† Piksonik, il y a eu un cas o√π le programmeur du serveur a perdu tous les polym√®res, et notre jeu a √©t√© contraint de subir une mod√©ration, ayant au lieu du serveur un mannequin d√©fendant stupidement tout l'√©tat du jeu de temps en temps. </li></ul><br>  Un inconv√©nient qui, pour une raison quelconque, est syst√©matiquement sous-estim√©: <br><br><ul><li>  Si le programmeur client a fait quelque chose de mal et qu'il est invisible pendant le test, par exemple, la probabilit√© de marchandises dans les bo√Ætes myst√©rieuses, alors personne ne peut √©crire la m√™me chose une deuxi√®me fois et trouver une erreur.  Le code autoportable n√©cessite une attitude beaucoup plus responsable envers les tests. </li></ul><br><h2>  Informations de d√©bogage d√©taill√©es </h2><br>  L'une de nos priorit√©s d√©clar√©es est la commodit√© du d√©bogage.  Si lors de l'ex√©cution de l'√©quipe, nous avons attrap√© l'ex√©cution - tout est clair, nous r√©trogradons l'√©tat du jeu, envoyons l'√©tat complet aux journaux et s√©rialisons la commande qui l'a d√©pos√©, tout est pratique et beau.  La situation est plus compliqu√©e si nous avons une d√©synchronisation avec le serveur.  Parce que le client a d√©j√† ex√©cut√© plusieurs autres commandes depuis lors, et il s'av√®re non seulement de savoir dans quel √©tat √©tait le mod√®le avant d'ex√©cuter la commande qui a conduit √† la catastrophe, mais je le veux vraiment.  Cloner un gamestate devant chaque √©quipe est trop compliqu√© et trop cher.  Pour r√©soudre le probl√®me, nous compliquons le sch√©ma cousu sous le capot du moteur. <br><br>  Chez le client, nous n'aurons pas un √âtat gamest, mais deux.  Le premier sert d'interface principale pour le rendu, les commandes lui sont appliqu√©es imm√©diatement.  Apr√®s cela, les commandes appliqu√©es sont mises en file d'attente pour √™tre envoy√©es au serveur.  Le serveur effectue la m√™me action de son c√¥t√© et confirme que tout va bien et est correct.  Apr√®s avoir re√ßu la confirmation, le client prend la m√™me commande et l'applique au deuxi√®me gamestate, l'amenant √† l'√©tat qui a d√©j√† √©t√© confirm√© par le serveur comme correct.  Dans le m√™me temps, nous avons √©galement la possibilit√© de comparer le hachage des modifications apport√©es pour √™tre s√ªr, et nous pouvons √©galement comparer le hachage complet de l'arborescence enti√®re sur le client, que nous pouvons calculer apr√®s l'ex√©cution de la commande, il p√®se un peu et est consid√©r√© comme assez rapide.  Si le serveur ne dit pas que tout va bien, il demande au client des d√©tails sur ce qui s'est pass√©, et le client peut lui envoyer un deuxi√®me √©tat de jeu s√©rialis√© exactement tel qu'il √©tait avant que la commande ne soit ex√©cut√©e avec succ√®s sur le client. <br>  La solution semble tr√®s attrayante, mais elle pose deux probl√®mes qui doivent √™tre r√©solus au niveau du code: <br><br><ul><li>  Parmi les param√®tres de commande, il peut y avoir non seulement des types simples, mais aussi des liens vers des mod√®les.  Dans un autre √âtat de jeu, au m√™me endroit exact se trouvent d'autres objets du mod√®le.  Nous r√©solvons ce probl√®me de la mani√®re suivante: Avant l'ex√©cution de la commande sur le client, nous s√©rialisons toutes ses donn√©es.  Parmi eux, il peut y avoir des liens vers des mod√®les, que nous √©crirons sous forme de chemin vers le mod√®le depuis la racine de l'√©tat du jeu.  Nous le faisons avant l'√©quipe, car apr√®s son ex√©cution, les chemins peuvent changer.  Ensuite, nous envoyons ce chemin au serveur, et le gamestate du serveur pourra obtenir un lien vers son mod√®le en cours de route.  De m√™me, lorsqu'une √©quipe est appliqu√©e au deuxi√®me √©tat de jeu, le mod√®le peut √™tre obtenu √† partir du deuxi√®me √©tat de jeu. </li><li>  En plus des types et mod√®les √©l√©mentaires, une √©quipe peut avoir des liens vers des collections.  Dictionnaire &lt;cl√©, mod√®le&gt;, Dictionnaire &lt;mod√®le, cl√©&gt;, Liste &lt;Mod√®le&gt;, Liste &lt;Valeur&gt;.  Pour chacun d'eux, ils doivent √©crire des s√©rialiseurs.  Certes, vous ne pouvez pas vous pr√©cipiter l√†-dedans, dans un vrai projet, de tels domaines surviennent √©tonnamment rarement. </li><li>  L'envoi de commandes au serveur une √† la fois n'est pas une bonne id√©e, car l'utilisateur peut les produire plus rapidement qu'Internet ne peut les faire glisser d'avant en arri√®re, sur un Internet m√©diocre, le pool de commandes non √©labor√© par le serveur augmentera.  Au lieu d'envoyer des commandes une par une, nous les enverrons par lots de plusieurs pi√®ces.  Dans ce cas, apr√®s avoir re√ßu une r√©ponse du serveur que quelque chose s'est mal pass√©, vous devrez d'abord appliquer au deuxi√®me √©tat toutes les commandes pr√©c√©dentes du m√™me package qui ont √©t√© confirm√©es par le serveur, puis seulement effacer et envoyer le deuxi√®me √©tat de contr√¥le au serveur. </li></ul><br><h2>  Commodit√© et facilit√© d'√©criture des commandes </h2><br>  Le code d'ex√©cution des commandes est le deuxi√®me plus grand et le premier code le plus responsable du jeu.  Plus ce sera simple et clair, et moins le programmeur aura besoin de faire plus avec ses mains pour l'√©crire, plus le code sera √©crit rapidement, moins il y aura d'erreurs et, de mani√®re tr√®s inattendue, plus le programmeur sera heureux.  Je place le code d'ex√©cution directement dans la commande elle-m√™me, en plus des pi√®ces et fonctions g√©n√©rales qui se trouvent dans des classes de r√®gles statiques distinctes, le plus souvent sous la forme d'extensions aux classes de mod√®le avec lesquelles elles fonctionnent.  Je vais vous montrer quelques exemples de commandes de mon projet pour animaux de compagnie, l'une tr√®s simple et l'autre un peu plus compliqu√©e: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> HexKingdoms { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FCSetSideCostCommand</span></span></span><span class="hljs-class"> :</span></span> HexKingdomsCommand { <span class="hljs-comment"><span class="hljs-comment">//              protected override bool DetaliedLog { get { return true; } } public FCMatchModel match; public int newCost; protected override void HexApply(HexKingdomsRoot root) { match.sideCost = newCost; match.CalculateAssignments(); match.CalculateNextUnassignedPlayer(); } } }</span></span></code> </pre> <br>  Et voici le journal que cette commande laisse apr√®s elle-m√™me, si ce journal n'est pas d√©sactiv√© pour cela. <br><br><pre> <code class="json hljs">[FCSetSideCostCommand id=<span class="hljs-number"><span class="hljs-number">1</span></span> match=FCMatchModel[<span class="hljs-number"><span class="hljs-number">0</span></span>] newCost=<span class="hljs-number"><span class="hljs-number">260</span></span>] Execute:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0027546</span></span> Apply:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0008689</span></span> { <span class="hljs-attr"><span class="hljs-attr">"LOCAL_PERSISTENTS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"0"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"SIDE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"1"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"POSSIBLE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"POSSIBLE_COST"</span></span>:<span class="hljs-number"><span class="hljs-number">260</span></span>}}}}</code> </pre> <br>  La premi√®re fois indiqu√©e dans le journal est le temps pendant lequel toutes les modifications n√©cessaires ont √©t√© apport√©es au mod√®le, et la seconde est le temps pendant lequel toutes les modifications ont √©t√© effectu√©es par les contr√¥leurs d'interface.  Cela devrait √™tre indiqu√© dans le journal afin de ne pas faire accidentellement quelque chose de terriblement lent, ou de remarquer √† temps si les op√©rations commencent √† prendre trop de temps simplement en raison de la taille du mod√®le lui-m√™me. <br><br>  Mis √† part les appels √† des objets persistants sur Id-shniks, qui r√©duisent consid√©rablement la lisibilit√© du journal, ce qui aurait d'ailleurs pu √™tre √©vit√© ici, le code de commande lui-m√™me et le journal qu'il a fait avec l'√©tat du jeu sont incroyablement clairs.  Veuillez noter que dans le texte de la commande, le programmeur ne fait aucun mouvement suppl√©mentaire.  Tout ce dont vous avez besoin est fait par le moteur sous le capot. <br><br>  Voyons maintenant un exemple d'une plus grande √©quipe <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> HexKingdoms { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FCSetUnitForPlayerCommand</span></span></span><span class="hljs-class"> :</span></span> HexKingdomsCommand { <span class="hljs-comment"><span class="hljs-comment">//            protected override bool DetaliedLog { get { return true; } } public FCSelectArmyScreenModel screen; public string unit; public int count; protected override void HexApply(HexKingdomsRoot root) { if (count == 0 &amp;&amp; screen.player.units.ContainsKey(unit)) { screen.player.units.Remove(unit); screen.selectedUnits.Remove(unit); } else if (count != 0) { if (screen.player.units.ContainsKey(unit)) { screen.player.units[unit] = count; screen.selectedUnits[unit].count = count; } else { screen.player.units.Add(unit, count); screen.selectedUnits[unit] = new ReferenceUnitModel() { type = unit, count = count }; } } screen.SetSelectedReferenceUnits(); screen.player.CalculateUnitsCost(); var side = screen.match.sides[screen.side]; screen.match.CalculatePlayerAssignmentsAcceptablity(side); screen.match.CalculateNextUnassignedPlayer(screen.player); } } }</span></span></code> </pre> <br>  Et voici le journal laiss√© par l'√©quipe: <br><br><pre> <code class="json hljs">[FCSetUnitForPlayerCommand id=<span class="hljs-number"><span class="hljs-number">3</span></span> screen=/UI_SCREENS[main] unit=militia count=<span class="hljs-number"><span class="hljs-number">1</span></span>] Execute:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0065625</span></span> Apply:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.0004573</span></span> { <span class="hljs-attr"><span class="hljs-attr">"LOCAL_PERSISTENTS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"UNITS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@set"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"militia"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>}}, <span class="hljs-attr"><span class="hljs-attr">"ASSIGNED"</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>}}}, <span class="hljs-attr"><span class="hljs-attr">"UI_SCREENS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@changed"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"SELECTED_UNITS"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"@set"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"militia"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"@new"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"TYPE"</span></span>:<span class="hljs-string"><span class="hljs-string">"militia"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"REMARK"</span></span>:<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"COUNT"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"SELECTED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"DISABLED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"HIGHLIGHT_GREEN"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"HIGHLIGHT_RED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"BUTTON_ENABLED"</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>}}}}}}}</code> </pre> <br>  Comme on dit, c'est beaucoup plus clair.  Prenez le temps d'√©quiper l'√©quipe d'un journal pratique, compact et informatif.  C'est la cl√© de votre bonheur.  Le mod√®le doit fonctionner tr√®s rapidement, nous y avons donc utilis√© une vari√©t√© d'astuces avec des m√©thodes de stockage et d'acc√®s aux champs.  Les commandes sont ex√©cut√©es dans le pire des cas une fois par trame, en fait, plusieurs fois moins souvent, nous allons donc effectuer la s√©rialisation et la d√©s√©rialisation des champs de commande sans aucune fantaisie, juste par r√©flexion.  Nous ne trions les champs que par nom afin que l'ordre soit fixe, eh bien, nous compilerons la liste des champs une fois pendant la dur√©e de vie de la commande, et nous lirons en utilisant des m√©thodes natives C #. <br><br><h2>  Mod√®le d'information pour l'interface. </h2><br>  Prenons la prochaine √©tape pour compliquer notre moteur, une √©tape qui semble effrayante, mais qui simplifie consid√©rablement l'√©criture et le d√©bogage des interfaces.  Tr√®s souvent, en particulier dans le mod√®le MVP associ√©, le mod√®le ne contient que la logique m√©tier contr√¥l√©e par le serveur et les informations sur l'√©tat de l'interface sont stock√©es dans le pr√©sentateur.  Par exemple, vous souhaitez commander cinq billets.  Vous avez d√©j√† s√©lectionn√© leur num√©ro, mais vous n'avez pas encore cliqu√© sur le bouton "commander".  Les informations sur le nombre exact de billets que vous avez choisis dans le formulaire peuvent √™tre stock√©es quelque part dans les coins secrets de la classe, qui sert de joint entre le mod√®le et son affichage.  Ou, par exemple, le joueur passe d'un √©cran √† un autre, mais rien ne change dans le mod√®le, et o√π il se trouvait lorsque la trag√©die s'est produite, le programmeur de d√©bogage ne sait que par les mots d'un testeur extr√™mement disciplin√©.  L'approche est simple, compr√©hensible, presque toujours utilis√©e et un peu malveillante, √† mon avis.  Parce que si quelque chose a mal tourn√©, l'√©tat de ce pr√©sentateur, qui a conduit √† une erreur, est absolument impossible √† d√©couvrir.  Surtout si l'erreur s'est produite sur le serveur de combat lors de l'op√©ration pour 1000 $, et non sur le testeur dans un environnement contr√¥l√© et reproductible. <br><br>  Au lieu de cette approche habituelle, nous interdisons √† quiconque, √† l'exception du mod√®le, de contenir des informations sur l'√©tat de l'interface.  Cela a, comme d'habitude, des avantages et des inconv√©nients qui doivent √™tre combattus. <br><br><ul><li>  <b>(+1)</b> L'avantage le plus important, √©conomiser des mois de travail de programmation - en cas de probl√®me, le programmeur charge simplement l'√©tat du jeu avant l'accident et re√ßoit exactement le m√™me √©tat non seulement du mod√®le commercial, mais de l'interface enti√®re jusqu'au dernier bouton de l'√©cran. </li><li>  <b>(+2)</b> Si une √©quipe a chang√© quelque chose dans l'interface, le programmeur peut facilement aller dans le journal et voir exactement ce qui a chang√© sous une forme json pratique, comme dans la section pr√©c√©dente. </li><li>  <b>(-1)</b> Beaucoup d'informations redondantes apparaissent dans le mod√®le qui ne sont pas n√©cessaires pour comprendre la logique m√©tier du jeu et ne sont pas n√©cessaires deux fois par le serveur. </li></ul><br>  Pour r√©soudre ce probl√®me, nous marquerons certains champs comme notServerVerified, cela ressemble √† ceci, par exemple, comme ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EDictionary&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt; uiScreens { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UI_SCREENS.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PDictionaryModel&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt; UI_SCREENS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDictionaryModel&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>, UIStateModel&gt;() { notServerVerified = <span class="hljs-literal"><span class="hljs-literal">true</span></span> };</code> </pre> <br>  Cette partie du mod√®le et tout ce qui se trouve en dessous concernera exclusivement le client. <br><br>  Si vous vous souvenez encore, les indicateurs de ce que vous devez exporter et de ce qui ne ressemble pas √† ceci: <br><br><pre> <code class="cpp hljs">[Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ExportMode { all = <span class="hljs-number"><span class="hljs-number">0x0</span></span>, changes = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, serverVerified = <span class="hljs-number"><span class="hljs-number">0x2</span></span> }</code> </pre> <br>  Par cons√©quent, lors de l'exportation ou du calcul d'un hachage, vous pouvez sp√©cifier s'il faut exporter la totalit√© de l'arborescence ou uniquement la partie de celle-ci qui est v√©rifi√©e par le serveur. <br><br>  La premi√®re complication √©vidente qui en r√©sulte est la n√©cessit√© de cr√©er des commandes distinctes qui doivent √™tre v√©rifi√©es par le serveur et celles qui ne sont pas n√©cessaires, mais il y a aussi celles qui doivent √™tre v√©rifi√©es pas enti√®rement.  Afin de ne pas charger le programmeur avec des op√©rations inutiles pour configurer la commande, nous essaierons √† nouveau de faire tout ce qui est n√©cessaire avec le capot moteur. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/** &lt;summary&gt;    ,      &lt;/summary&gt; */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-comment"><span class="hljs-comment">/** &lt;summary&gt;         &lt;/summary&gt; */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyClientSide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br>  Le programmeur qui cr√©e la commande peut remplacer l'une ou les deux de ces fonctions.  Bien s√ªr, tout cela est merveilleux, mais comment puis-je m'assurer que le programmeur n'a rien g√¢ch√© et s'il a g√¢ch√© quelque chose - comment peut-il l'aider rapidement et facilement √† le r√©parer?  Il y a deux fa√ßons.  J'ai appliqu√© le premier, mais vous aimerez peut-√™tre davantage le second. <br><br><h3>  Premi√®re voie </h3><br>  Nous utilisons les fonctionnalit√©s int√©ressantes de notre mod√®le: <br><br><ol><li>  Le moteur appelle la premi√®re fonction, apr√®s quoi il re√ßoit un hachage de changements dans la partie v√©rifi√©e par le serveur de l'√©tat du jeu.  S'il n'y a pas de changement, nous traitons exclusivement avec l'√©quipe client. </li><li>  Nous obtenons le hachage du mod√®le des changements dans le mod√®le entier, pas seulement celui v√©rifi√© par le serveur.  S'il diff√®re du hachage pr√©c√©dent, le programmeur a foir√© et chang√© quelque chose dans la partie du mod√®le qui n'a pas √©t√© v√©rifi√©e par le serveur.  Nous parcourons l'arbre d'√©tat et vidons le programmeur en tant qu'ex√©cution d'une liste compl√®te des champs notServerVerified = true et de ceux situ√©s en dessous de l'arbre qu'il a chang√©. </li><li>  Nous appelons la deuxi√®me fonction.  Nous obtenons du mod√®le un hachage des changements survenus dans la partie v√©rifi√©e.  S'il ne co√Øncide pas avec le hachage apr√®s le premier appel, alors dans la deuxi√®me fonction, le programmeur a fait n'importe quoi.  Si nous voulons obtenir un journal tr√®s informatif dans ce cas, nous restaurons le mod√®le entier √† son √©tat d'origine, le s√©rialisons dans un fichier, puis le programmeur sera utile pour le d√©bogage, puis le clonera en entier (deux lignes - s√©rialisation-d√©s√©rialisation), et maintenant nous appliquons d'abord le premier , nous validons les modifications afin que le mod√®le ne change pas, apr√®s quoi nous appliquons la deuxi√®me fonction.  Et puis nous exportons toutes les modifications dans la partie v√©rifi√©e par le serveur sous la forme de JSON et l'incluons dans l'ex√©cution abusive, afin que le programmeur honteux puisse imm√©diatement voir ce qu'il a chang√© et o√π il a chang√©, ce qui ne devrait pas √™tre chang√©. </li></ol><br>  Cela a l'air bien s√ªr effrayant, mais en fait c'est 7 lignes, parce que les fonctions qui font tout cela (sauf traverser l'arbre depuis le deuxi√®me paragraphe), nous sommes pr√™ts.  Et comme il s'agit de r√©ception, nous pouvons nous permettre d'agir de mani√®re non optimale. <br><br><h3>  Deuxi√®me voie </h3><br>  Un peu plus brutal, maintenant dans ModelRoot, nous avons un champ de verrouillage, mais nous pouvons le diviser en deux, l'un ne verrouillera que les champs v√©rifi√©s sur le serveur, l'autre uniquement les champs v√©rifi√©s.  Dans ce cas, le programmeur qui a fait quelque chose de mal recevra imm√©diatement une explication √† ce sujet avec un lien avec l'endroit o√π il l'a fait.  Le seul inconv√©nient de cette approche est que si dans notre arbre une propri√©t√© de mod√®le est marqu√©e comme non v√©rifiable, alors tout ce qui se trouve dans l'arbre en dessous concernant le calcul des hachages et le contr√¥le des modifications ne sera pas inspect√©, m√™me si chaque champ n'a pas √©t√© marqu√©.  Un verrou, bien s√ªr, ne regardera pas dans la hi√©rarchie, ce qui signifie que tous les champs de la partie non contr√¥l√©e de l'arbre devront √™tre marqu√©s, et il ne fonctionnera pas √† certains endroits pour utiliser les m√™mes classes dans l'interface utilisateur et la partie habituelle de l'arbre.  En option, une telle construction est possible (je l'√©crirai simplifi√©e): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameState</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RootModelData data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RootModelLocal local; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RootModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> locked { get; } }</code> </pre> <br>  Il s'av√®re ensuite que chaque sous-arbre a son propre verrou.  GameState h√©rite des mod√®les, car il est plus facile que de proposer une impl√©mentation distincte de toutes les m√™mes fonctionnalit√©s pour lui. <br><br><h3>  Am√©liorations n√©cessaires </h3><br>  Bien entendu, le responsable du traitement des √©quipes devra ajouter de nouvelles fonctionnalit√©s.  L'essence des modifications sera que toutes les commandes ne seront pas envoy√©es au serveur, mais uniquement celles qui cr√©ent les modifications v√©rifi√©es.  Le serveur de son c√¥t√© ne soul√®vera pas l'arborescence d'√©tat du jeu entier, mais uniquement la partie v√©rifi√©e, et en cons√©quence le hachage ne co√Øncidera que pour la partie v√©rifi√©e.  Lorsqu'une commande est ex√©cut√©e sur le serveur, seule la premi√®re des deux fonctions de la commande sera lanc√©e, et lors de la r√©solution des r√©f√©rences aux mod√®les dans le gamestate, si le chemin m√®ne √† une partie non v√©rifiable de l'arborescence, null sera plac√© dans la variable de commande au lieu du mod√®le.  Toutes les √©quipes non envoyeuses se conformeront honn√™tement aux √©quipes habituelles, mais seront consid√©r√©es comme d√©j√† confirm√©es.  D√®s qu'ils atteignent la ligne et qu'il n'y en a pas non confirm√©s devant eux, ils seront imm√©diatement appliqu√©s au deuxi√®me √©tat. <br><br>  Il n'y a rien de fondamentalement compliqu√© dans la mise en ≈ìuvre.  C'est juste que la propri√©t√© de chaque champ du mod√®le a une autre condition, une travers√©e d'arbre. <br><br>  Un autre raffinement n√©cessaire - vous aurez besoin de Factory for ParsistentModel distinct dans les parties v√©rifi√©es et non v√©rifi√©es de l'arborescence et NextFreeId sera diff√©rent pour elles. <br><br><h2>  Commandes lanc√©es par le serveur </h2><br>  Il y a un probl√®me si le serveur veut envoyer sa commande au client, car l'√©tat du client par rapport au serveur peut d√©j√† avancer de quelques pas.  L'id√©e principale est que si le serveur devait envoyer sa commande, il envoie la notification du serveur au client avec la r√©ponse suivante et l'√©crit dans le champ des notifications envoy√©es √† ce client.  Le client re√ßoit une notification, forme une commande sur sa base et la place √† la fin de sa file d'attente, apr√®s celles qui se sont termin√©es sur le client mais qui n'ont pas encore atteint le serveur.  Apr√®s un certain temps, la commande est envoy√©e au serveur dans le cadre du processus normal de travail avec le mod√®le.  Ayant re√ßu cette commande pour traitement, le serveur jette la notification hors de la file d'attente sortante.  Si le client n'a pas r√©pondu √† la notification dans le d√©lai d√©fini avec le package suivant, une commande de red√©marrage lui est envoy√©e.  Si le client qui a re√ßu la notification est tomb√©, se connecte plus tard ou, pour une raison quelconque, charge le jeu, le serveur transformera toutes les notifications en commandes avant de lui donner l'√©tat, les ex√©cutera de son c√¥t√©, et ce n'est qu'apr√®s cela que le client rejoignant son nouvel √©tat.  Veuillez noter qu'un joueur peut avoir un √©tat conflictuel avec des ressources n√©gatives lorsque le joueur a r√©ussi √† d√©penser l'argent exactement au moment o√π le serveur les lui a pris.  La co√Øncidence est peu probable, mais avec une grande DAU, elle est presque in√©vitable.  Par cons√©quent, l'interface et les r√®gles du jeu ne devraient pas tomber √† mort dans une telle situation. <br><br><h2>  Commandes √† ex√©cuter dont vous avez besoin de conna√Ætre la r√©ponse du serveur </h2><br>  Une erreur typique est de penser qu'un nombre al√©atoire ne peut √™tre obtenu qu'√† partir du serveur.  Rien ne vous emp√™che d'avoir le m√™me g√©n√©rateur de nombres pseudo-al√©atoires fonctionnant simultan√©ment √† partir du client et du serveur, √† partir d'un sid commun.  De plus, la graine actuelle peut √™tre stock√©e directement dans le gamestate.  Certains peuvent trouver difficile de synchroniser la r√©ponse de ce g√©n√©rateur.  En fait, pour cela, il suffit d'avoir un num√©ro de plus dans le m√™me article - exactement combien de num√©ros ont √©t√© re√ßus du g√©n√©rateur √† ce moment.  Si votre g√©n√©rateur pour une raison quelconque ne converge pas, alors vous avez quelque part une erreur et le code ne fonctionne pas de mani√®re d√©terministe.  Et ce fait ne doit pas √™tre cach√© sous le tapis, mais tri√© et rechercher une erreur.  Pour la grande majorit√© des cas, y compris m√™me les bo√Ætes myst√©rieuses, cette approche est suffisante. <br><br>  Cependant, il y a des moments o√π cette option ne convient pas.  Par exemple, vous jouez un prix tr√®s cher et ne voulez pas que le camarade rus√© d√©compile le jeu, et √©crivez un bot qui vous indique √† l'avance ce qui tombera de la bo√Æte de diamants si vous l'ouvrez maintenant, et si vous faites tourner le tambour dans un autre endroit avant cela.  Vous pouvez stocker des graines pour chaque variable al√©atoire s√©par√©ment, cela prot√©gera contre le piratage frontal, mais cela n'aidera en rien d'un bot qui vous indique combien de bo√Ætes le produit dont vous avez besoin se trouve actuellement.  Eh bien, le cas le plus √©vident est que vous ne voudrez peut-√™tre pas briller dans la configuration client avec des informations sur la probabilit√© d'un √©v√©nement rare.  Bref, il est parfois n√©cessaire d'attendre une r√©ponse du serveur. <br>  De telles situations ne devraient pas √™tre r√©solues gr√¢ce aux capacit√©s suppl√©mentaires du moteur, mais en divisant l'√©quipe en deux - le premier pr√©pare la situation et met l'interface en attente de notifications, le second en fait, avec la r√©ponse dont vous avez besoin.  M√™me si vous bloquez √©troitement l'interface entre eux sur le client, une autre commande peut passer √† travers - par exemple, une unit√© d'√©nergie sera restaur√©e √† temps. <br><br>  Il est important de comprendre que de telles situations ne sont pas la r√®gle, mais l'exception.  En fait, la plupart des jeux n'ont besoin que d'une seule √©quipe en attente d'une r√©ponse - GetInitialGameState.  Un autre pack de ces commandes est l'interaction entre les joueurs dans un m√©ta-jeu, GetLeaderboard, par exemple.  Les deux cents autres pi√®ces sont d√©terministes. <br><br><h2>  Stockage des donn√©es du serveur et sujet boueux de l'optimisation du serveur </h2><br>  J'avoue tout de suite que je suis un client, et parfois j'ai entendu de telles id√©es et algorithmes de la part de serveurs familiers qu'ils ne se seraient m√™me pas gliss√©s dans ma t√™te.  En communiquant avec mes coll√®gues, j'ai en quelque sorte d√©velopp√© une image du fonctionnement de mon architecture c√¥t√© serveur dans le cas id√©al.  Cependant: il existe des contre-indications, il est n√©cessaire de consulter un serveur sp√©cialis√©. <br><br>  Tout d'abord sur le stockage des donn√©es.  C'est votre c√¥t√© serveur qui peut avoir des restrictions suppl√©mentaires.  Par exemple, vous pouvez √™tre interdit d'utiliser des champs statiques.  De plus, le code des commandes et des mod√®les est autoportable, mais le code de propri√©t√© sur le client et sur le serveur n'a pas du tout √† co√Øncider.  Tout peut y √™tre cach√©, jusqu'√† l'initialisation paresseuse des valeurs de champ du memcache, par exemple.  Les champs de propri√©t√© peuvent √©galement recevoir des param√®tres suppl√©mentaires utilis√©s par le serveur, mais n'affectent pas le travail du client. <br><br>  La premi√®re diff√©rence cardinale du serveur: o√π les champs sont s√©rialis√©s et d√©s√©rialis√©s.  Une solution raisonnable est que la plupart de l'arbre d'√©tat est s√©rialis√© en un immense champ binaire ou json.  Dans le m√™me temps, certains champs sont extraits des tables.  Cela est n√©cessaire car les valeurs de certains champs seront constamment n√©cessaires au fonctionnement des services d'interaction entre les joueurs.  Par exemple, l'ic√¥ne et le niveau sont constamment secou√©s par une vari√©t√© de personnes.  Il vaut mieux les conserver dans une base de donn√©es r√©guli√®re.  Et l'√©tat complet ou partiel, mais d√©taill√© d'une personne aura tr√®s rarement besoin de quelqu'un d'autre que lui, quand quelqu'un d√©cide de se pencher sur son territoire. <br><br>  De plus, tirer des champs de la base un √† la fois n'est pas pratique, et il peut s'av√©rer que tout tra√Æne pendant longtemps.  Une solution tr√®s non standard, disponible uniquement pour notre architecture, peut consister dans le fait que le client, lors de l'ex√©cution d'une commande, collecte des informations sur tous les champs stock√©s s√©par√©ment dans des tables dont les getters ont r√©ussi √† toucher, et ajoute ces informations √† la commande pour que le serveur puisse lever ce groupe de champs une demande √† la base de donn√©es.  Bien s√ªr, avec des restrictions raisonnables, afin de ne pas mendier pour DDOS caus√© par des programmeurs aux mains courb√©es qui ont touch√© √† tout de mani√®re inattentive. <br><br>  Avec un tel stockage s√©par√©, on devrait consid√©rer les m√©canismes de transactionnalit√© lorsqu'un joueur rampe dans les donn√©es d'un autre, par exemple, lui vole de l'argent.  Mais dans le cas g√©n√©ral, nous le faisons par notification.  Autrement dit, le voleur re√ßoit son argent imm√©diatement, et la personne vol√©e re√ßoit une notification avec des instructions pour radier de l'argent quand il s'agit de cela. <br><br><h2>  Comment les √©quipes sont r√©parties entre les serveurs </h2><br>  Maintenant, le deuxi√®me moment important pour le serveur.  Il existe deux approches.  Au d√©but, pour le traitement de toute demande (ou d'un paquet de demandes), l'√©tat entier est √©lev√© de la base de donn√©es ou du cache vers la m√©moire, trait√©, puis renvoy√© √† la base de donn√©es.  Les op√©rations sont √©labor√©es de mani√®re atomique sur un tas de serveurs d'ex√©cution diff√©rents, et ils n'ont qu'une base commune, et m√™me pas toujours.  En tant que client, √©lever l'√©tat entier √† chaque √©quipe est choquant, mais j'ai vu comment cela fonctionne, et cela fonctionne de mani√®re tr√®s fiable et √©volutive.  La deuxi√®me option est que l'√©tat monte une fois en m√©moire et y habite jusqu'√† ce que le client ne tombe qu'occasionnellement en ajoutant son √©tat actuel √† la base de donn√©es.            .    -           .        ,       .     ,     ,   .          10 .       ,     ,       ‚Äî          .         ,                .     ‚Äî    . <br><br><h2>    </h2><br>   ,        :       ,      .      .              .   ,          .     ,          .            ‚Äî          ‚Äî            . <br><br>         ,   ,       -                     .     ,    .          ,     VR   CS,  -           . ,  ,         ,          30%. <br><br>   ,      ‚Äî    ,     .          ,      .     ,  , ,     ,    ,       . <br><br> , , -      ,     :       .     ,       .      ,   35                 .     ,       ,    . ,   ,                 ,    ‚Äî         . <br>     :       ‚Äî 30 .          ?  ‚Ññ1:   .  ‚Ññ2:       ,        3000      . <br><br>  ,                   ‚Äî  .  Quelque chose comme √ßa: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> interface Command { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot root, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time)</span></span></span></span>; }</code> </pre> <br>    , ,     Unity     ‚Äî .    UnixTime   ,         ,         PTime,   PValue&lt;long&gt;  ,     JSON         :   - .    .   . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quatri√®me situation: Dans l'√©tat de jeu, il y a des situations o√π une √©quipe doit √™tre initi√©e sans la participation d'un joueur, √† temps, par exemple, la r√©cup√©ration d'√©nergie. Une situation tr√®s courante, en fait. Je veux avoir un champ, c'est un exercice pratique. Par exemple PTimeOut, dans lequel il sera possible d'enregistrer un point dans le temps apr√®s lequel une commande doit √™tre cr√©√©e et ex√©cut√©e. Dans le code, cela peut ressembler √† ceci:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PTimeOut RESTORE_ENERGY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PTimeOut() {command = (model, property) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestoreEnergyCommand() { model = model}} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> restoreEnergy { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RESTORE_ENERGY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { RESTORE_ENERGY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); }} }</code> </pre> <br>                ,      .     ,       ,       .            ,       ,      ,      ,      .          ,         ,              . <br><br>     -   ,        .   ,      ,       ,     ,      ,    .            ,               currentTime,   : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCurrentTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time)</span></span></span></span>; } vs <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RootModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> event Action&lt;<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>&gt; setCurrentTime; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est bien, mais le probl√®me est que les mod√®les qui sont supprim√©s de l'arborescence des mod√®les pour toujours et contiennent un tel champ resteront abonn√©s √† cet √©v√©nement et devront le r√©soudre correctement. </font><font style="vertical-align: inherit;">Avant d'envoyer une commande, v√©rifiez si elles sont toujours dans l'arborescence et ont un lien faible avec cet √©v√©nement ou inversion de contr√¥le, de sorte qu'elles ne restent pas inaccessibles au GC.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Annexe 1, un cas typique tir√© de la vie r√©elle </font></font></h3><br>      .             ,    - .       ,    ,           .        ,      ,   ,  ,      callback,       . , .      ,           ,               ,  ,    ¬´  ¬ª , ,    .    ,   ,             . <br><br>  ,    .       ,        inventory,      .     ,   ,      -,  ,     .          ,       ¬´ ¬ª      ,      ,      ,    .     ¬´    ¬ª.         ,        .        ,       ,                 .      : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OpenMisterBox</span></span></span><span class="hljs-class"> :</span></span> Command { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BoxItemModel item; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> slot; <span class="hljs-comment"><span class="hljs-comment">//        ,  . public override void Apply(GameState state) { state.inventory[item.revardKey] += item.revardCount; } //       . public override void Apply(GameState state) { var cause = state.NewPersistent&lt;WaitForCommand&gt;(); cause.key = item.key; cause.value = item.value; state.ui.delayedInventoryVisualization.Add(cause); state.ui.mysteryBoxScreen.animations.Add(new Animation() {cause = item, slot = slot})); } } public class MysteryBoxView : View { /* ... */ public override void ConnectModel(MysteryBoxScreenModel model, List&lt;Control&gt; c) { model.Get(c, MysteryBoxScreenModel.ANIMATIONS) .Control(c, onAdd = item =&gt; animationFactory(item, OnComleteOrAbort =&gt; { AsincQueue(new RemoveAnimation() {cause = item.cause, animation = item}) }), onRemove = item =&gt; {} ) } } public class InventoryView : View&lt;InventoryItem&gt; { public Text text; public override void ConnectModel(InventoryItem model, List&lt;Control&gt; c) { model.GameState.ui.Get(c, UIModel.DELAYED_INVENTORY_VISUALIZATION). .Where(c, item =&gt; item.key == model.key) .Expression(c, onChange = (IList&lt;InventoryItem&gt; list) =&gt; { int sum = 0; for (int i = 0; i &lt; list.Count; i++) sum += list[i].value; return sum; }, onAdd = null, onRemove = null ) //      .Join (c, model.GameState.Get(GameState.INVENTORY).ItemByKey(model.key)) .Expression(c, (delay, count) =&gt; count - delay) .SetText(c, text); //     ,      ,   ,  ,   ,       ,     : model.inventory.CreateVisibleInventoryItemCount(c, model.key).SetText(c, text); } } public class RemoveDelayedInventoryVisualization : Command { public DelayCauseModel cause; public override void Apply(GameState state) { state.ui.delayedInventoryVisualization.Remove(cause); } } public class RemoveAnimation : RemoveDelayedInventoryVisualization { public Animation animation public override void Apply(GameState state) { base.Apply(state); state.ui.mysteryBoxScreen.animations.Remove(animation); } }</span></span></code> </pre> <br>  Qu'avons-nous finalement?   View,       ,         ,           .  .          GameState        ,    ,      .    ,       ,    ,    . <br><br><h2>  Total </h2><br>  -   ,      ,                  ,     , ,   ,      .              .    , ,                        .              ,         ,       . <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et maintenant je vous demande de r√©pondre √† des questions tr√®s importantes pour moi. </font><font style="vertical-align: inherit;">Si vous avez des id√©es sur la fa√ßon de faire ce que j'ai mal fait, ou si vous voulez simplement commenter mes r√©ponses, je vous attends dans les commentaires. </font><font style="vertical-align: inherit;">Une proposition de coop√©ration et des instructions sur de nombreuses erreurs de syntaxe, veuillez en PM.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435704/">https://habr.com/ru/post/fr435704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435694/index.html">Comment et pourquoi nous avons optimis√© l'algorithme de nettoyage des caches SLAB dans le noyau Linux</a></li>
<li><a href="../fr435696/index.html">Antiquit√©s: publicit√© informatique 1997</a></li>
<li><a href="../fr435698/index.html">√âcrire votre propre bon gestionnaire de m√©moire</a></li>
<li><a href="../fr435700/index.html">Questions d'entretiens chez 8 Worst Vue.js</a></li>
<li><a href="../fr435702/index.html">Les trolls brevet√©s commencent et gagnent: comment je suis rest√© sans jeu</a></li>
<li><a href="../fr435706/index.html">Nous utilisons rcm pour d√©ployer la configuration dans n'importe quel dossier</a></li>
<li><a href="../fr435708/index.html">Fayal: un lieu de rencontre dans l'Atlantique</a></li>
<li><a href="../fr435712/index.html">Procter & Gamble lance une imprimante pour la peau anti-√¢ge</a></li>
<li><a href="../fr435714/index.html">Les d√©veloppeurs ukrainiens ont eu acc√®s aux fichiers de toutes les cam√©ras Ring du monde</a></li>
<li><a href="../fr435718/index.html">Nous pompons Angular NGSW en utilisant une logique personnalis√©e dans Service Worker</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>