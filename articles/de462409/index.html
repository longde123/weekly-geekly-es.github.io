<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ú üé¥ üôåüèø Assembler-Codegenerator-Bibliothek f√ºr AVR-Mikrocontroller. Teil 1 ü•Ä üë©üèº‚Äçüç≥ ‚õπüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Teil 2. Erste Schritte ‚Üí 
 Assembler Code Generator Library f√ºr AVR-Mikrocontroller 
 Teil 1. Erste Bekanntschaft 


 Guten Tag, liebe Chabrowiten. Ic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Assembler-Codegenerator-Bibliothek f√ºr AVR-Mikrocontroller. Teil 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462409/"><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2. Erste Schritte ‚Üí</a> </p><br><h1>  Assembler Code Generator Library f√ºr AVR-Mikrocontroller </h1><br><h2>  Teil 1. Erste Bekanntschaft </h2><br><p>  Guten Tag, liebe Chabrowiten.  Ich m√∂chte Sie auf das n√§chste (von den vielen verf√ºgbaren) Projekt zur Programmierung beliebter Mikrocontroller der AVR-Serie aufmerksam machen. </p><br><p>  Es w√§re m√∂glich, viel Text auszugeben, um zu erkl√§ren, warum dies notwendig ist. Schauen Sie sich stattdessen nur Beispiele an, wie es sich von anderen L√∂sungen unterscheidet.  Alle Erkl√§rungen und Vergleiche mit vorhandenen Programmiersystemen werden bei Bedarf analysiert.  Die Bibliothek wird gerade fertiggestellt, sodass die Implementierung einiger Funktionen m√∂glicherweise nicht optimal erscheint.  Au√üerdem sollen einige der Aufgaben, die dem Programmierer in dieser Version zugewiesen sind, weiter optimiert oder automatisiert werden. </p><a name="habracut"></a><br><p>  Also fangen wir an.  Ich m√∂chte sofort klarstellen, dass das pr√§sentierte Material keinesfalls als vollst√§ndige Beschreibung betrachtet werden sollte, sondern nur als Demonstration einiger Merkmale der entwickelten Bibliothek, um zu verstehen, wie interessant dieser Ansatz f√ºr die Leser sein kann. </p><br><p>  Wir werden nicht von der vorherrschenden Praxis abweichen und mit einem klassischen Beispiel beginnen, einer Art "Hallo Welt" f√ºr Mikrocontroller.  Wir blinken n√§mlich die LED, die an einen der Prozessorzweige angeschlossen ist.  √ñffnen wir VisualStudio von Microsoft aus (jede Version reicht aus) und erstellen eine Konsolenanwendung f√ºr C #.  F√ºr diejenigen, die sich nicht auskennen, ist die f√ºr die Arbeit ausreichende Community Edition absolut kostenlos. </p><br><p>  Eigentlich ist der Text selbst wie folgt: </p><br><div class="spoiler">  <b class="spoiler_title">Quellcode Beispiel 1</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> NanoRTOSLib; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); m.PortB[<span class="hljs-number"><span class="hljs-number">0</span></span>].Mode = ePinMode.OUT; m.PortB.Activate(); m.LOOP(m.TempL, (r, l) =&gt; m.GO(l), (r) =&gt; { m.PortB[<span class="hljs-number"><span class="hljs-number">0</span></span>].Toggle();}); Console.WriteLine(AVRASM.Text(m)); } } }</code> </pre> </div></div><br><p>  Damit alles funktioniert und Sie genau die Bibliothek ben√∂tigen, die ich vertrete. <br>  Nach dem Kompilieren und Ausf√ºhren des Programms sehen wir in der Konsolenausgabe das folgende Ergebnis dieses Programms. </p><br><div class="spoiler">  <b class="spoiler_title">Kompilierungsergebnis von Beispiel 1</b> <div class="spoiler_text"><pre> <code class="dos hljs">#include ‚Äúcommon.inc‚Äù RESET: ldi r16, high(RAMEND) out SPH,r16 ldi r16, low(RAMEND) out SPL,r16 outi DDRB,<span class="hljs-number"><span class="hljs-number">0</span></span>x1 L0000: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> TempL,PORTB ldi TempH,<span class="hljs-number"><span class="hljs-number">1</span></span> eor TempL,TempH out PORTB,TempL xjmp L0000 .DSEG</code> </pre> </div></div><br><p>  Wenn Sie das Ergebnis in eine Umgebung kopieren, die mit dem AVR-Assembler arbeiten und die <i>Common.inc-Makrobibliothek</i> verbinden kann (die <i>Makrobibliothek</i> ist auch eines der Bestandteile des vorgestellten Programmiersystems und arbeitet mit <i>NanoRTOSLib zusammen</i> ), kann dieses Programm auf einem Emulator oder einem realen Chip kompiliert und √ºberpr√ºft werden Stellen Sie sicher, dass alles funktioniert. </p><br><p>  Betrachten Sie den Quellcode des Programms genauer.  Zun√§chst ordnen wir der Variablen m den verwendeten Kristalltyp zu.  Stellen Sie als n√§chstes den digitalen Ausgangsmodus f√ºr das Nullbit von Port B des Kristalls ein und aktivieren Sie den Port.  Die n√§chste Zeile sieht etwas seltsam aus, aber ihre Bedeutung ist recht einfach.  Darin sagen wir, dass wir eine Endlosschleife organisieren wollen, in deren K√∂rper wir den Wert des Nullbits von Port B in das Gegenteil √§ndern.  Die letzte Zeile des Programms visualisiert tats√§chlich das Ergebnis von allem, was zuvor in Form von Assembler-Code geschrieben wurde.  Alles ist sehr einfach und kompakt.  Und das Ergebnis unterscheidet sich praktisch nicht von dem, was man in Assembler schreiben k√∂nnte.  Der Ausgabecode kann nur zwei Fragen enthalten: die erste - warum den Stack initialisieren, wenn wir ihn immer noch nicht verwenden, und welche <i>Art von xjmp</i> ?  Die Antwort auf die erste Frage und gleichzeitig eine Erkl√§rung, warum Assembler anstelle eines vorgefertigten HEX ausgegeben wird, lautet wie folgt: Das Ergebnis in Form eines Assemblers erm√∂glicht es Ihnen, das Programm weiter zu analysieren und zu optimieren, sodass der Programmierer Codefragmente ausw√§hlen und √§ndern kann, die ihm nicht gefallen.  Und die Initialisierung des Stapels wurde zumindest aus den Gr√ºnden belassen, dass Sie ohne Verwendung des Stapels nicht viele Programme erstellen k√∂nnen.  Wenn es Ihnen jedoch nicht gef√§llt, k√∂nnen Sie es gerne aufr√§umen.  Die Ausgabe an den Assembler ist f√ºr diesen Zweck vorgesehen.  <i>Xjmp</i> ist ein Beispiel f√ºr die Verwendung von Makros, um die Lesbarkeit des Ausgabe-Assemblers zu <i>verbessern</i> .  Insbesondere ist <i>xjmp</i> ein Ersatz f√ºr <i>jmp</i> und <i>rjmp</i> mit der richtigen Substitution in Abh√§ngigkeit von der L√§nge des √úbergangs. </p><br><p>  Wenn Sie das Programm mit einem Chip f√ºllen, sehen wir nat√ºrlich kein Blinken der Diode, obwohl sich der Pin-Zustand √§ndert.  Es passiert einfach zu schnell, um es durch die Augen zu sehen.  Daher betrachten wir das folgende Programm, in dem wir weiterhin mit einer Diode blinken, aber damit es sichtbar ist.  Zum Beispiel ist eine Verz√∂gerung von 0,5 Sekunden durchaus geeignet: nicht zu schnell und nicht zu langsam.  Es w√§re m√∂glich, viele verschachtelte Schleifen mit NOPs zu erstellen, um eine Verz√∂gerung zu bilden. Wir werden diesen Schritt jedoch √ºberspringen, da der Beschreibung der Funktionen der Bibliothek nichts hinzugef√ºgt wird, und sofort die Gelegenheit nutzen, die verf√ºgbare Hardware zu verwenden.  Wir √§ndern unsere Anwendung wie folgt. </p><br><div class="spoiler">  <b class="spoiler_title">Quellcode Beispiel 2</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); m.PortB[<span class="hljs-number"><span class="hljs-number">0</span></span>].Mode = ePinMode.OUT; m.PortB.Activate(); m.WDT.Clock = eWDTClock.WDT500ms; m.WDT.OnTimeout = () =&gt; m.PortB[<span class="hljs-number"><span class="hljs-number">0</span></span>].Toggle(); m.WDT.Activate(); m.EnableInterrupt(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loop = AVRASM.newLabel(); m.GO(loop); Console.WriteLine(AVRASM.Text(m)); } } }</code> </pre> </div></div><br><p>  Offensichtlich √§hnelt das Programm dem vorherigen, daher werden wir nur ber√ºcksichtigen, was sich ge√§ndert hat.  In diesem Beispiel haben wir zun√§chst WDT (Watchdog Timer) verwendet.  F√ºr Arbeiten mit gro√üen Verz√∂gerungen, die keine extreme Genauigkeit erfordern, ist dies die beste Option.  Um dies zu verwenden, m√ºssen Sie lediglich die erforderliche Frequenz festlegen, indem Sie den Teiler √ºber die Eigenschaft WDT.Clock festlegen und die Aktionen festlegen, die zum Zeitpunkt des Ausl√∂sens des Ereignisses ausgef√ºhrt werden m√ºssen, indem Sie den Code √ºber die Eigenschaft WDT.OnTimeout definieren.  Da wir Interrupts ben√∂tigen, um zu funktionieren, m√ºssen sie mit dem Befehl EnableInterrupt aktiviert werden.  Der Hauptzyklus kann jedoch durch einen Dummy ersetzt werden.  Darin haben wir noch nichts vor.  Daher deklarieren und setzen wir ein Label und machen einen bedingungslosen √úbergang, um einen leeren Zyklus zu organisieren.  Wenn Sie LOOP mehr m√∂gen - bitte.  Das Ergebnis wird sich nicht √§ndern. <br>  Schauen wir uns im Finale den resultierenden Code an. </p><br><div class="spoiler">  <b class="spoiler_title">Kompilierungsergebnis von Beispiel 2</b> <div class="spoiler_text"><pre> <code class="dos hljs">#include ‚Äúcommon.inc‚Äù jmp RESET reti ; IRQ0 Handler nop reti ;IRQ1 Handler nop reti ;PC_INT0 Handler nop reti ;PC_INT1 Handler nop reti ;PC_INT2 Handler nop jmp WDT ;Watchdog Timer Handler RESET: ldi r16, high(RAMEND) out SPH,r16 ldi r16, low(RAMEND) out SPL,r16 outi DDRB,<span class="hljs-number"><span class="hljs-number">0</span></span>x1 ldi TempL, (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;WDCE) | (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;WDE) sts WDTCSR,TempL ldi TempL, <span class="hljs-number"><span class="hljs-number">0</span></span>x42 sts WDTCSR,TempL sei L0000: xjmp L0000 WDT: push r17 push r16 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r16,SREG push r16 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> TempL,PORTB ldi TempH,<span class="hljs-number"><span class="hljs-number">1</span></span> eor TempL,TempH out PORTB,TempL pop r16 out SREG,r16 pop r16 pop r17 reti .DSEG</code> </pre> </div></div><br><p>  Diejenigen, die mit diesem Prozessor vertraut sind, werden zweifellos eine Frage haben, wohin mehrere weitere Interruptvektoren gegangen sind.  Hier haben wir die folgende Logik verwendet - wenn der Code nicht verwendet wird - wird der Code nicht ben√∂tigt.  Daher endet die Interrupt-Tabelle mit dem zuletzt verwendeten Vektor. <br>  Trotz der Tatsache, dass das Programm die Aufgabe perfekt bew√§ltigt, mag es den w√§hlerischsten m√∂glicherweise nicht, dass die Anzahl der m√∂glichen Verz√∂gerungen begrenzt ist und der Schritt zu grob ist.  Daher werden wir einen anderen Weg in Betracht ziehen und gleichzeitig sehen, wie die Arbeit mit Timern in der Bibliothek organisiert ist.  In dem Mega328-Kristall, der als Probe genommen wird, gibt es bis zu 3 davon.  2 8-Bit und ein 16-Bit.  Die Architekten haben sich sehr bem√ºht, so viele Funktionen wie m√∂glich in diese Timer zu investieren, daher ist ihre Einstellung ziemlich umfangreich. </p><br><p>  Zun√§chst berechnen wir, welcher Z√§hler f√ºr unsere Verz√∂gerung von 0,5 Sekunden verwendet werden soll.  Wenn wir die Kristalltaktfrequenz von 16 MHz nehmen, ist es selbst mit dem maximalen Peripherieteiler unm√∂glich, innerhalb des 8-Bit-Z√§hlers zu bleiben.  Daher werden wir den einzigen uns zur Verf√ºgung stehenden 16-Bit-Timer1-Z√§hler nicht komplizieren und verwenden. </p><br><p>  Infolgedessen nimmt das Programm die folgende Form an: </p><br><div class="spoiler">  <b class="spoiler_title">Quellcode Beispiel 3</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> NanoRTOSLib; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> {<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); m.FCLK = <span class="hljs-number"><span class="hljs-number">16000000</span></span>; m.CKDIV8 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bit1 = m.PortB[<span class="hljs-number"><span class="hljs-number">0</span></span>]; bit1.Mode = ePinMode.OUT; m.PortB.Activate(); m.Timer1.Mode = eWaveFormMode.CTC_OCRA; m.Timer1.Clock = eTimerClockSource.CLK256; m.Timer1.OCRA = (<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>)((<span class="hljs-number"><span class="hljs-number">0.5</span></span> * m.FCLK) / <span class="hljs-number"><span class="hljs-number">256</span></span>); m.Timer1.OnCompareA = () =&gt; bit1.Toggle(); m.Timer1.Activate(); m.EnableInterrupt(); m.LOOP(m.TempH, (r, l) =&gt; m.GO(l), (r) =&gt; { }); Console.WriteLine(AVRASM.Text(m)); } } }</code> </pre> </div></div><br><p>  Da wir den Hauptgenerator als Taktquelle f√ºr unseren Timer verwenden, m√ºssen Sie f√ºr die korrekte Berechnung der Verz√∂gerung die Prozessortaktfrequenz, die Teilereinstellung und die periphere Taktsicherung angeben.  Der Haupttext des Programms ist das Einstellen des Timers auf den gew√ºnschten Modus.  Hier wird absichtlich ein Deliberator von 256 und nicht ein Maximum f√ºr die Taktung gew√§hlt, denn wenn Sie einen Teiler von 1024 f√ºr die erforderliche Taktfrequenz von 500 ms ausw√§hlen, die wir erhalten m√∂chten, wird eine Bruchzahl erhalten. </p><br><p>  Der resultierende Assembler-Code unseres Programms sieht folgenderma√üen aus: </p><br><div class="spoiler">  <b class="spoiler_title">Kompilierungsergebnis von Beispiel 3</b> <div class="spoiler_text"><pre> <code class="dos hljs">#include ‚Äúcommon.inc‚Äù jmp RESET reti ; IRQ0 Handler nop reti ;IRQ1 Handler nop reti ;PC_INT0 Handler nop reti ;PC_INT1 Handler nop reti ;PC_INT2 Handler nop reti ;Watchdog Timer Handler nop reti ;Timer2 Compare A Handler nop reti ;Timer2 Compare B Handler nop reti ;Timer2 Overflow Handler nop reti ;Timer1 Capture Handler nop jmp TIM1_COMPA ;Timer1 Compare A Handler RESET: ldi r16, high(RAMEND) out SPH,r16 ldi r16, low(RAMEND) out SPL,r16 outi DDRB,<span class="hljs-number"><span class="hljs-number">0</span></span>x1 outiw OCR1A,<span class="hljs-number"><span class="hljs-number">0</span></span>x7A12 outi TCCR1A,<span class="hljs-number"><span class="hljs-number">0</span></span> outi TCCR1B,<span class="hljs-number"><span class="hljs-number">0</span></span>xC outi TCCR1C,<span class="hljs-number"><span class="hljs-number">0</span></span>x0 outi TIMSK1,<span class="hljs-number"><span class="hljs-number">0</span></span>x2 outi DDRB,<span class="hljs-number"><span class="hljs-number">0</span></span>x1 sei L0000: xjmp L0000 TIM1_COMPA: push r17 push r16 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r16,SREG push r16 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> TempL,PORTB ldi TempH,<span class="hljs-number"><span class="hljs-number">1</span></span> eor TempL,TempH out PORTB,TempL pop r16 out SREG,r16 pop r16 pop r17 reti .DSEG</code> </pre> </div></div><br><p>  Es scheint schon nichts mehr zu kommentieren zu geben.  Wir initialisieren die Ger√§te, konfigurieren Interrupts und genie√üen das Programm. </p><br><p>  Das Durcharbeiten von Interrupts ist der einfachste Weg, um Programme f√ºr die Arbeit in Echtzeit zu erstellen.  Leider ist es nicht immer m√∂glich, zwischen parallelen Aufgaben zu wechseln, die nur Interrupt-Handler verwenden, um diese Aufgaben auszuf√ºhren.  Die Einschr√§nkung ist das Verbot der Behandlung verschachtelter Interrupts, was dazu f√ºhrt, dass der Prozessor bis zum Beenden des Prozessors nicht auf alle anderen Interrupts reagiert, was zu einem Verlust von Ereignissen f√ºhren kann, wenn der Prozessor zu lange l√§uft. </p><br><p>  Eine L√∂sung besteht darin, den Ereignisregistrierungscode und dessen Verarbeitung zu trennen.  Der parallele Multithread-Verarbeitungskern aus der Bibliothek ist so organisiert, dass der Interrupt-Handler beim Eintreten eines Ereignisses nur das angegebene Ereignis registriert und bei Bedarf die minimal erforderlichen Datenerfassungsvorg√§nge ausf√ºhrt und die gesamte Verarbeitung im Hauptstrom ausgef√ºhrt wird.  Der Kernel pr√ºft nacheinander, ob unverarbeitete Flags vorhanden sind, und f√§hrt, falls gefunden, mit der entsprechenden Aufgabe fort. </p><br><p>  Die Verwendung dieses Ansatzes vereinfacht den Entwurf von Systemen mit mehreren asynchronen Aufgaben, sodass Sie jede f√ºr sich betrachten k√∂nnen, ohne sich auf die Probleme beim Wechseln von Ressourcen zwischen Aufgaben konzentrieren zu m√ºssen.  Betrachten Sie als Beispiel die Implementierung von zwei unabh√§ngigen Aufgaben, von denen jede ihre Ausgabe mit einer bestimmten Verz√∂gerung umschaltet. </p><br><div class="spoiler">  <b class="spoiler_title">Quellcode Beispiel 4</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> NanoRTOSLib; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); m.FCLK = <span class="hljs-number"><span class="hljs-number">16000000</span></span>; m.CKDIV8 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; m.PortB.Direction(<span class="hljs-number"><span class="hljs-number">0x07</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bit1 = m.PortB[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bit2 = m.PortB[<span class="hljs-number"><span class="hljs-number">2</span></span>]; m.PortB.Activate(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Parallel(m, <span class="hljs-number"><span class="hljs-number">4</span></span>); tasks.Heap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StaticHeap(tasks, <span class="hljs-number"><span class="hljs-number">64</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t1 = tasks.CreateTask((tsk) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loop = AVRASM.NewLabel(); bit1.Toggle(); tsk.Delay(<span class="hljs-number"><span class="hljs-number">32</span></span>); tsk.TaskContinue(loop); },<span class="hljs-string"><span class="hljs-string">"Task1"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t2 = tasks.CreateTask((tsk) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loop = AVRASM.NewLabel(); bit2.Toggle(); tsk.Delay(<span class="hljs-number"><span class="hljs-number">48</span></span>); tsk.TaskContinue(loop); }, <span class="hljs-string"><span class="hljs-string">"Task2"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ca = tasks.ContinuousActivate(tasks.AlwaysOn, t1); tasks.ActivateNext(ca, tasks.AlwaysOn, t2); ca.Dispose(); m.EnableInterrupt(); tasks.Loop(); Console.WriteLine(AVRASM.Text(m)); } } }</code> </pre> </div></div><br><p>  In dieser Aufgabe konfigurieren wir den Null- und den ersten Ausgang von Port B so, dass der Wert ausgegeben und von 0 auf 1 und umgekehrt ge√§ndert wird, mit einer Periode von 32 ms f√ºr Null und 48 ms f√ºr den ersten Ausgang.  F√ºr die Verwaltung jedes Ports ist eine separate Aufgabe verantwortlich.  Das erste, was zu beachten ist, ist die Definition einer Instanz von Parallel.  Diese Klasse ist der Kern des Aufgabenmanagements.  In seinem Konstruktor bestimmen wir die maximal zul√§ssige Anzahl gleichzeitig laufender Threads.  Das Folgende ist eine Speicherzuordnung zum Speichern von Datenstr√∂men.  Die im Beispiel verwendete StaticHeap-Klasse weist jedem Stream eine feste Anzahl von Bytes zu.  Um unser Problem zu l√∂sen, ist dies akzeptabel, und die Verwendung einer festen Speicherzuordnung im Vergleich zu dynamisch vereinfacht die Algorithmen und macht den Code kompakter und schneller.  Im weiteren Verlauf des Codes beschreiben wir eine Reihe von Aufgaben, die unter der Kontrolle des Kernels ausgef√ºhrt werden sollen.  Sie sollten auf die asynchrone Funktion Verz√∂gerung achten, mit der wir eine Verz√∂gerung bilden.  Seine Besonderheit ist, dass beim Aufrufen dieser Funktion die erforderliche Verz√∂gerung in den Stream-Einstellungen festgelegt wird und die Steuerung auf den Kernel √ºbertragen wird.  Nach Ablauf des festgelegten Intervalls gibt der Kernel die Kontrolle √ºber den Befehl nach dem Befehl Delay an die Task zur√ºck.  Ein weiteres Merkmal der Aufgabe ist das Programmieren des Verhaltens des Aufgabenflusses nach Abschluss im letzten Aufgabenbefehl.  In unserem Fall sind beide Tasks so konfiguriert, dass sie in einer Endlosschleife ausgef√ºhrt werden, wobei die Steuerung am Ende jedes Zyklus zum Kernel zur√ºckkehrt.  Wenn erforderlich, kann durch Ausf√ºhren einer Aufgabe der Thread freigegeben oder zur Ausf√ºhrung einer anderen Aufgabe weitergeleitet werden. </p><br><p>  Der Grund f√ºr das Aufrufen der Aufgabe besteht darin, das dem Aufgabenablauf zugewiesene Signal zu aktivieren.  Das Signal kann sowohl programmgesteuert als auch Hardware durch Interrupts von Peripherieger√§ten aktiviert werden.  Ein Taskaufruf setzt das Signal zur√ºck.  Eine Ausnahme bildet das vordefinierte AlwaysOn-Signal, das sich immer im aktiven Zustand befindet.  Auf diese Weise k√∂nnen Aufgaben erstellt werden, die in jedem Abfragezyklus gesteuert werden.  Die LOOP-Funktion ist erforderlich, um die Hauptausf√ºhrungsschleife aufzurufen.  Leider wird die Gr√∂√üe des Ausgabecodes bei Verwendung von Parallel bereits erheblich gr√∂√üer als in den vorherigen Beispielen (ca. 600 Befehle) und kann im Artikel nicht vollst√§ndig zitiert werden. </p><br><p>  Und f√ºr s√º√üe - so etwas wie ein Live-Projekt, n√§mlich ein digitales Thermometer.  Alles ist wie immer einfach.  Ein digitaler Sensor mit einer SPI-Schnittstelle, einer 4-stelligen 7-Segment-Anzeige und mehreren Verarbeitungsthreads, um die Dinge k√ºhl zu halten.  In einem fahren wir einen Zyklus f√ºr die dynamische Anzeige, in einem anderen Ereignisse, die einen Temperaturlesezyklus ausl√∂sen, im dritten lesen wir die vom Sensor empfangenen Werte und konvertieren sie von einem Bin√§rcode in BCD und dann in einen Segmentcode f√ºr einen dynamischen Anzeigepuffer. </p><br><p>  Das Programm selbst ist wie folgt. </p><br><div class="spoiler">  <b class="spoiler_title">Quellcode Beispiel 5</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> NanoRTOSLib; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ConsoleApp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mega328(); m.FCLK = <span class="hljs-number"><span class="hljs-number">16000000</span></span>; m.CKDIV8 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> led7s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Led_7(); led7s.SegPort = m.PortC; led7s.Activate(); m.PortD.Direction(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); m.PortD.Activate(); m.PortB[<span class="hljs-number"><span class="hljs-number">0</span></span>].Mode = ePinMode.OUT; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tc77 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TC77(); tc77.CS = m.PortB[<span class="hljs-number"><span class="hljs-number">0</span></span>]; tc77.Port = m.SPI; m.Timer0.Clock = eTimerClockSource.CLK64; m.Timer0.Mode = eWaveFormMode.Normal; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reader = m.DREG(<span class="hljs-string"><span class="hljs-string">"Temperature"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bcdRes = m.DREG(<span class="hljs-string"><span class="hljs-string">"digits"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = m.BYTE(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bcd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BCD(reader, bcdRes); m.subroutines.Add(bcd); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> os = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Parallel(m, <span class="hljs-number"><span class="hljs-number">4</span></span>); os.Heap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StaticHeap(os, <span class="hljs-number"><span class="hljs-number">64</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmrSig = os.AddSignal(m.Timer0.OVF_Handler); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spiSig = os.AddSignal(m.SPI.Handler, () =&gt; { m.SPI.Read(m.TempL); m.TempL.MStore(tmp); }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> actuator = os.CreateTask((tsk) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loop = AVRASM.NewLabel(); tc77.ReadTemperatureAsync(); tsk.Delay(<span class="hljs-number"><span class="hljs-number">16</span></span>); tsk.TaskContinue(loop); }, <span class="hljs-string"><span class="hljs-string">"actuator"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> treader = os.CreateTask((tsk) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loop = AVRASM.NewLabel(); tc77.ReadTemperatureCallback(os, reader, tmp); reader &gt;&gt;= <span class="hljs-number"><span class="hljs-number">7</span></span>; m.CALL(bcd); tsk.TaskContinue(loop); }, <span class="hljs-string"><span class="hljs-string">"reader"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> display = os.CreateTask((tsk) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loop = AVRASM.NewLabel(); m.PortD.Write(<span class="hljs-number"><span class="hljs-number">0xFE</span></span>); m.TempQL.Load(bcdRes.Low); m.TempQL &amp;= <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; led7s.Show(m.TempQL); os.AWAIT(); m.PortD.Write(<span class="hljs-number"><span class="hljs-number">0xFD</span></span>); m.TempQL.Load(bcdRes.Low); m.TempQL &gt;&gt;= <span class="hljs-number"><span class="hljs-number">4</span></span>; led7s.Show(m.TempQL); os.AWAIT(); m.PortD.Write(<span class="hljs-number"><span class="hljs-number">0xFB</span></span>); m.TempQL.Load(bcdRes.High); m.TempQL &amp;= <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; led7s.Show(m.TempQL); os.AWAIT(); m.PortD.Write(<span class="hljs-number"><span class="hljs-number">0xF7</span></span>); m.TempQL.Load(bcdRes.High); m.TempQL &gt;&gt;= <span class="hljs-number"><span class="hljs-number">4</span></span>; led7s.Show(m.TempQL); os.AWAIT(); tsk.TaskContinue(loop); }, <span class="hljs-string"><span class="hljs-string">"display"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ct = os.ContinuousActivate(os.AlwaysOn, actuator); os.ActivateNext(ct, spiSig, treader); os.ActivateNext(ct, tmrSig, display); tc77.Activate(); m.Timer0.Activate(); m.EnableInterrupt(); os.Loop(); Console.WriteLine(AVRASM.Text(m)); } } }</code> </pre> </div></div><br><p>  Es ist klar, dass dies kein Arbeitsentwurf ist, sondern nur eine technologische Demo, die die F√§higkeiten der NanoRTOS-Bibliothek demonstrieren soll.  In jedem Fall sind weniger als 100 Quellzeilen und weniger als 1 KB Ausgabecode ein gutes Ergebnis f√ºr eine funktionsf√§hige Anwendung. </p><br><p>  In den folgenden Artikeln m√∂chte ich im Falle eines Interesses an diesem Projekt n√§her auf die Prinzipien und Merkmale der Programmierung mit dieser Bibliothek eingehen. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de462409/">https://habr.com/ru/post/de462409/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de462397/index.html">Wie man eine Katze mit TLA + f√§ngt</a></li>
<li><a href="../de462399/index.html">Die statische Analyse verbessert die Codebasis komplexer C ++ - Projekte</a></li>
<li><a href="../de462401/index.html">Entwickler Tods√ºnden</a></li>
<li><a href="../de462403/index.html">Auswahl der Monitorgr√∂√üe: Winkelgr√∂√üentheorie, Begr√ºndung und Vergleich</a></li>
<li><a href="../de462407/index.html">Food Design Digest Juli 2019</a></li>
<li><a href="../de462411/index.html">L√∂se Sudoku mit Algorithmus X.</a></li>
<li><a href="../de462415/index.html">Bereitstellen von Symfony + React-Anwendungen auf AWS √ºber CI</a></li>
<li><a href="../de462417/index.html">Apples Petition</a></li>
<li><a href="../de462421/index.html">Apollo Guidance Computer - Architektur und Systemsoftware. Teil 2</a></li>
<li><a href="../de462423/index.html">Projektmanagement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>