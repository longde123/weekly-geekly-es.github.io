<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïµüèæ üìÄ üëêüèª D√©veloppement en monorepositaire. Rapport Yandex üöø üÜé üåó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je m'appelle Azat Razetdinov, je suis chez Yandex depuis 12 ans, je g√®re le service de d√©veloppement d'interfaces chez Y. Real Estate. Aujourd'hui, je...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©veloppement en monorepositaire. Rapport Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/469021/">  Je m'appelle Azat Razetdinov, je suis chez Yandex depuis 12 ans, je g√®re le service de d√©veloppement d'interfaces chez Y. Real Estate.  Aujourd'hui, je voudrais parler d'un monorepositaire.  Si vous n'avez qu'un seul r√©f√©rentiel au travail - f√©licitations, vous vivez d√©j√† dans un seul r√©f√©rentiel.  Maintenant pourquoi les autres en ont besoin. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/v_/vr/gi/v_vrgiiye4emmloccesmmogxlim.jpeg"></a> <br><br><blockquote>  Selon Marina Pereskokova, chef du service de d√©veloppement d'API Yandex.Mart, mon grand-p√®re a plant√© un monorepa, et un monorepa est devenu grand, gros. </blockquote><br><a name="habracut"></a>  - Chez Yandex, nous avons essay√© diff√©rentes fa√ßons de travailler avec plusieurs services et nous avons remarqu√© - d√®s que vous avez plus d'un service, des parties communes commencent in√©vitablement √† appara√Ætre: mod√®les, utilitaires, outils, morceaux de code, mod√®les, composants.  La question est: o√π mettre tout √ßa?  Bien s√ªr, vous pouvez copier-coller, nous pouvons le faire, mais je le veux magnifiquement. <br><br>  Nous avons m√™me essay√© une entit√© comme SVN externals pour ceux qui s'en souviennent.  Nous avons essay√© les sous-modules git.  Nous avons essay√© les packages npm lorsqu'ils sont apparus.  Mais tout cela √©tait en quelque sorte long, ou quelque chose.  Vous prenez en charge n'importe quel package, recherchez une erreur, apportez des corrections.  Ensuite, vous devez publier une nouvelle version, passer par les services, mettre √† niveau vers cette version, v√©rifier que tout fonctionne, ex√©cuter les tests, rechercher l'erreur, revenir au r√©f√©rentiel de la biblioth√®que, corriger l'erreur, publier la nouvelle version, parcourir les services, mettre √† jour et ainsi de suite cercle.  Cela s'est juste transform√© en douleur. <br><br><img src="https://habrastorage.org/webt/rq/ie/uo/rqieuoverzzoq6wrhpujf4qz8vw.jpeg"><br><br>  Ensuite, nous avons r√©fl√©chi √† l'opportunit√© de nous r√©unir dans un seul r√©f√©rentiel.  Prenez tous nos services et biblioth√®ques, transf√©rez et d√©veloppez dans un seul r√©f√©rentiel.  Il y avait beaucoup d'avantages.  Je ne dis pas que cette approche est id√©ale, mais du point de vue de l'entreprise et m√™me du d√©partement de plusieurs groupes, des avantages significatifs apparaissent. <br><br>  Pour moi personnellement, la chose la plus importante est l'atomicit√© des commits, qu'en tant que d√©veloppeur, je peux r√©parer la biblioth√®que, contourner tous les services, apporter des modifications, ex√©cuter des tests, v√©rifier que tout fonctionne, la pousser dans le ma√Ætre, et tout cela avec une seule modification.  Pas besoin de reconstruire, publier, mettre √† jour quoi que ce soit. <br><br>  Mais si tout va si bien, pourquoi tout le monde n'est-il pas encore pass√© au mono-r√©f√©rentiel?  Bien s√ªr, il y a aussi des inconv√©nients. <br><br><img src="https://habrastorage.org/webt/bb/1u/pv/bb1upvyscjzd_csjkvxce0yh9a0.jpeg"><br><br>  Selon Marina Pereskokova, chef du service de d√©veloppement d'API Yandex.Map, mon grand-p√®re a plant√© un monorepa, et un monorepa est devenu grand, gros.  C'est un fait, pas une blague.  Si vous collectez de nombreux services dans un seul r√©f√©rentiel, il se d√©veloppe in√©vitablement.  Et si nous parlons de git, qui extrait tous les fichiers ainsi que leur historique complet pour toute l'existence de votre code, c'est un espace disque assez grand. <br><br>  Le deuxi√®me probl√®me est l'injection dans le ma√Ætre.  Vous avez pr√©par√© une demande de pool, effectu√© un examen, vous √™tes pr√™t √† la fusionner.  Et il s'av√®re que quelqu'un a r√©ussi √† vous devancer et que vous devez r√©soudre les conflits.  Vous avez r√©solu les conflits, encore une fois pr√™t √† affluer, et encore une fois, vous n'avez pas eu le temps.  Ce probl√®me est en train d'√™tre r√©solu, il existe des syst√®mes de file d'attente de fusion, lorsqu'un robot sp√©cial automatise ce travail, demande des pools de voies, tente de r√©soudre les conflits, s'il le peut.  S'il ne le peut pas, il appelle l'auteur.  Cependant, un tel probl√®me existe.  Il existe des solutions qui le nivellent, mais vous devez en tenir compte. <br><br>  Ce sont des points techniques, mais aussi organisationnels.  Supposons que vous ayez plusieurs √©quipes qui fournissent plusieurs services diff√©rents.  Lorsqu'ils migrent vers un seul r√©f√©rentiel, leur responsabilit√© commence √† s'√©roder.  Parce qu'ils ont fait une sortie, d√©ploy√© en production - quelque chose s'est cass√©.  Nous commen√ßons le d√©briefing.  Il s'av√®re que c'est un d√©veloppeur d'une autre √©quipe qui a commis quelque chose dans le code g√©n√©ral, nous l'avons retir√©, non publi√©, ne l'avons pas vu, tout s'est cass√©.  Et il n'est pas clair qui est responsable.  Il est important de comprendre et d'utiliser toutes les m√©thodes possibles: tests unitaires, tests d'int√©gration, linter - tout ce qui est possible pour r√©duire ce probl√®me de l'influence d'un code sur tous les autres services. <br><br>  Fait int√©ressant, qui d'autre que Yandex et d'autres joueurs utilise le mono-r√©f√©rentiel?  Beaucoup de gens.  Ce sont React, Jest, Babel, Ember, Meteor, Angular.  Les gens comprennent - il est plus facile, moins cher, plus rapide de d√©velopper et de publier des packages npm √† partir d'un r√©f√©rentiel unique que de plusieurs petits r√©f√©rentiels.  La chose la plus int√©ressante est qu'avec ce processus, des outils pour travailler avec un monorepositaire ont commenc√© √† se d√©velopper.  Juste √† propos d'eux et je veux parler. <br><br>  Tout commence par la cr√©ation d'un monorepositaire.  L'outil frontal le plus c√©l√®bre au monde est appel√© lerna. <br><br><img src="https://habrastorage.org/webt/2a/n9/my/2an9myv3k_dokzcizjfhshporh0.jpeg"><br><br>  Ouvrez simplement votre d√©p√¥t, ex√©cutez npx lerna init, il vous posera des questions suggestives et ajoutera quelques entit√©s √† votre copie de travail.  La premi√®re entit√© est la configuration lerna.json, qui indique au moins deux champs: la version de bout en bout de tous vos packages et l'emplacement de vos packages dans le syst√®me de fichiers.  Par d√©faut, tous les packages sont ajout√©s au dossier packages, mais vous pouvez le configurer √† votre guise, vous pouvez m√™me les ajouter √† la racine, lerna peut √©galement le r√©cup√©rer. <br><br>  La prochaine √©tape est de savoir comment ajouter vos r√©f√©rentiels au r√©f√©rentiel mono, comment les transf√©rer? <br><br>  Que voulons-nous r√©aliser?  Tr√®s probablement, vous avez d√©j√† une sorte de r√©f√©rentiel, dans ce cas A et B. <br><br><img src="https://habrastorage.org/webt/gd/yl/d0/gdyld0xwsgytno9mhaz7g-t-ikc.jpeg"><br><br>  Il s'agit de deux services, chacun dans son propre r√©f√©rentiel, et nous souhaitons les transf√©rer vers le nouveau mono-r√©f√©rentiel dans le dossier packages, de pr√©f√©rence avec un historique des validations, afin que vous puissiez rendre git blame, git log, etc. <br><br><img src="https://habrastorage.org/webt/rd/td/z1/rdtdz1-3hqxrjvgsgf4tb4wq5fy.jpeg"><br><br>  Il existe un outil d'importation lerna pour cela.  Vous sp√©cifiez simplement l'emplacement de votre r√©f√©rentiel et lerna le transf√®re √† votre monorepo.  Dans le m√™me temps, elle prend d'abord une liste de toutes les validations, modifie chaque validation, change le chemin d'acc√®s aux fichiers de la racine en packages / nom_package, et les applique les unes apr√®s les autres, les impose dans votre mono-r√©f√©rentiel.  En fait, chaque commit se pr√©pare, en changeant les chemins d'acc√®s aux fichiers.  Essentiellement, lerna fait de la magie pour vous.  Si vous lisez le code source, les commandes git sont simplement ex√©cut√©es dans une certaine s√©quence. <br><br>  C‚Äôest la premi√®re fa√ßon.  Cela a un inconv√©nient: si vous travaillez dans une entreprise o√π il y a des processus de production, o√π les gens √©crivent d√©j√† une sorte de code et que vous allez les traduire en un monorep, vous ne le ferez probablement pas en une journ√©e.  Vous devrez comprendre, configurer, v√©rifier que tout d√©marre, tester.  Mais les gens n'ont pas de travail, ils continuent de faire quelque chose. <br><br><img src="https://habrastorage.org/webt/u5/w4/je/u5w4jenpjqspns44ok1grkidxug.jpeg"><br><br>  Pour une transition plus fluide vers le mono-rap, il existe un outil tel que git subtree.  C'est une chose plus sophistiqu√©e, mais en m√™me temps native de git, qui vous permet non seulement d'importer des r√©f√©rentiels individuels dans un r√©f√©rentiel mono par une sorte de pr√©fixe, mais aussi d'√©changer des modifications dans les deux sens.  Autrement dit, l'√©quipe qui fournit le service peut √™tre facilement d√©velopp√©e davantage dans son propre r√©f√©rentiel s√©par√©, tandis que vous pouvez extraire leurs modifications via git subtree pull, apporter vos propres modifications et les repousser via git subtree push.  Et vivez comme √ßa dans la p√©riode de transition aussi longtemps que vous le souhaitez. <br><br>  Et lorsque vous avez tout configur√©, v√©rifi√© que tous les tests sont en cours d'ex√©cution, que le d√©ploiement fonctionne, que l'ensemble du CI / CD est configur√©, vous pouvez dire qu'il est temps de passer √† autre chose.  Pour la p√©riode de transition, une excellente solution, je recommande. <br><br>  Eh bien, nous avons d√©plac√© nos r√©f√©rentiels dans un mono-r√©f√©rentiel, mais o√π est la magie quelque part?  Mais nous voulons mettre en √©vidence les parties communes et les utiliser d'une mani√®re ou d'une autre.  Et pour cela, il existe un m√©canisme de ¬´liaison de d√©pendance¬ª.  Qu'est-ce que la d√©pendance de liaison?  Il existe un outil d'amor√ßage lerna, une commande similaire √† npm install, qui ex√©cute simplement npm install dans tous vos packages. <br><br><img src="https://habrastorage.org/webt/kh/tg/cw/khtgcwjnzf2kjxoy61wgmkevopo.jpeg"><br><br>  Mais ce n‚Äôest pas tout.  De plus, elle recherche des d√©pendances internes.  Vous pouvez en utiliser un autre dans un package √† l'int√©rieur de votre r√©f√©rentiel.  Par exemple, si vous avez le package A, qui d√©pend de Jest dans ce cas, il y a le package B, qui d√©pend de Jest et le package A. Si le package A est un outil commun, un composant commun, alors le package B est un service qui l'a utilise. <br><br>  Lerna d√©finit ces d√©pendances internes et remplace physiquement cette d√©pendance par un lien symbolique sur le syst√®me de fichiers. <br><br><img src="https://habrastorage.org/webt/or/lk/am/orlkampii1gcc_kxupnpc5k-hxy.jpeg"><br><br><img src="https://habrastorage.org/webt/ia/dp/oo/iadpoole-lvonlr_o30aqvbc8no.jpeg"><br><br>  Apr√®s avoir ex√©cut√© lerna bootstrap, juste √† l'int√©rieur du dossier node_modules, au lieu du dossier physique A, un lien symbolique appara√Æt qui m√®ne au dossier avec le package A. Ceci est tr√®s pratique car vous pouvez modifier le code dans le package A et v√©rifier imm√©diatement le r√©sultat dans le package B , ex√©cutez les tests, l'int√©gration, les unit√©s, tout ce que vous voulez.  Le d√©veloppement est grandement simplifi√©, vous n'avez plus besoin de r√©assembler le package A, de publier, de connecter le package B. Il vient d'√™tre corrig√© ici, v√©rifi√© l√†. <br><br>  Veuillez noter que si vous regardez les dossiers node_modules, et l√† et il y a de la plaisanterie, nous avons dupliqu√© le module install√©.  En g√©n√©ral, il faut un certain temps lorsque vous d√©marrez lerna bootstrap, attendez que tout s'arr√™te, car il y a beaucoup de travaux r√©p√©t√©s, des d√©pendances en double sont obtenues dans chaque package. <br><br>  Pour acc√©l√©rer l'installation des d√©pendances, le m√©canisme d'augmentation des d√©pendances est utilis√©.  L'id√©e est tr√®s simple: vous pouvez apporter les d√©pendances g√©n√©rales √† la racine node_modules. <br><br><img src="https://habrastorage.org/webt/so/lj/kr/soljkrixddhlkrth4w95b1bk5ek.jpeg"><br><br>  Si vous sp√©cifiez l'option --hoist (il s'agit d'une mise √† niveau √† partir de l'anglais), presque toutes les d√©pendances seront simplement d√©plac√©es vers les root node_modules.  Et cela fonctionne presque toujours.  Noda est tellement arrang√©e que si elle n'a pas trouv√© les d√©pendances √† son niveau, elle commence √† chercher un niveau plus haut, sinon l√†, un autre niveau plus haut et ainsi de suite.  Presque rien ne change.  Mais en fait, nous avons pris et d√©dupliqu√© nos d√©pendances, transf√©r√© les d√©pendances √† la racine. <br><br>  En m√™me temps, lerna est assez intelligente.  S'il y a un conflit, par exemple, si le package A utilise Jest version 1 et le package B utilise la version 2, alors l'un d'eux appara√Ætra et le second restera √† son niveau.  C'est √† peu pr√®s ce que fait npm dans le dossier node_modules normal, il essaie √©galement de d√©dupliquer les d√©pendances et de les porter au maximum √† la racine. <br><br>  Malheureusement, cette magie ne fonctionne pas toujours, surtout avec les outils, avec Babel, avec Jest.  Il arrive souvent qu'il d√©marre, car Jest a son propre syst√®me de r√©solution de modules, Noda commence √† tra√Æner, lance une erreur.  Surtout dans de tels cas o√π l'outil ne g√®re pas les d√©pendances qui sont all√©es √† la racine, il existe l'option nohoist, qui vous permet de souligner que ces packages ne sont pas transf√©r√©s √† la racine, laissez-les en place. <br><br><img src="https://habrastorage.org/webt/2z/sx/9z/2zsx9zvtkofxy_2uk4au8x1uxbu.jpeg"><br><br>  Si vous sp√©cifiez --nohoist = jest, toutes les d√©pendances √† l'exception de jest iront √† la racine et jest restera au niveau du paquet.  Pas √©tonnant que j'aie donn√© un tel exemple - c'est une plaisanterie qui a des probl√®mes avec ce comportement, et nohoist aide √† cela. <br><br>  Un autre avantage de la r√©cup√©ration des d√©pendances: <br><br><img src="https://habrastorage.org/webt/yp/1n/ur/yp1nurrr-zokokzjy7rgzvmozzi.jpeg"><br><br>  Si auparavant vous aviez package-lock.json s√©par√© pour chaque service, pour chaque package, alors quand vous √™tes hoyed, tout monte, et le seul package-lock.json reste.  Ceci est pratique du point de vue du d√©versement dans le ma√Ætre, de la r√©solution des conflits.  Une fois que tout le monde a √©t√© tu√©, et c'est tout. <br><br>  Mais comment lerna y parvient-elle?  Elle est assez agressive avec npm.  Lorsque vous sp√©cifiez hoist, il prend votre package.json √† la racine, le sauvegarde, en substitue un autre, agr√®ge toutes vos d√©pendances, ex√©cute npm install, presque tout est plac√© √† la racine.  Ensuite, ce package.json temporaire supprime, restaure le v√¥tre.  Si apr√®s cela, vous ex√©cutez une commande avec npm, par exemple, npm remove, npm ne comprendra pas ce qui s'est pass√©, pourquoi toutes les d√©pendances sont soudainement apparues √† la racine.  Lerna viole le niveau d'abstraction, elle rampe dans l'outil, qui est en dessous de son niveau. <br><br>  Les gars de Yarn ont √©t√© les premiers √† remarquer ce probl√®me et ont dit: qu'est-ce que nous tourmentons, laissez-nous tout faire pour vous nativement, afin que tout hors de la bo√Æte fonctionne. <br><br><img src="https://habrastorage.org/webt/4l/0q/yb/4l0qybezxp0nwi_fulfgleb11oe.jpeg"><br><br>  Yarn peut d√©j√† faire la m√™me chose hors de la bo√Æte: d√©pendances de liens, s'il voit que le package B d√©pend du package A, il fera un lien symbolique pour vous, gratuitement.  Il sait comment augmenter les d√©pendances, le fait par d√©faut, tout s'additionne √† la racine.  Comme lerna, il peut laisser le seul yarn.lock √† la racine du r√©f√©rentiel.  Tout le monde yarn.lock dont vous n'avez plus besoin. <br><br><img src="https://habrastorage.org/webt/wj/bu/e7/wjbue7nf67iucirzohdpfxk75xe.jpeg"><br><br>  Il est configur√© de mani√®re similaire.  Malheureusement, yarn suppose que tous les param√®tres sont ajout√©s √† package.json, je sais qu'il y a des gens qui essaient de supprimer tous les param√®tres des outils √† partir de l√†, ne laissant qu'un minimum.  Malheureusement, yarn n'a pas encore appris √† le sp√©cifier dans un autre fichier, uniquement package.json.  Il y a deux nouvelles options, une nouvelle et une obligatoire.  Comme il est suppos√© que le r√©f√©rentiel racine ne sera jamais publi√©, yarn requiert private = true pour y √™tre sp√©cifi√©. <br><br>  Mais les param√®tres des espaces de travail sont stock√©s dans la m√™me cl√©.  Le param√®tre est tr√®s similaire aux param√®tres de lerna, il y a un champ packages o√π vous sp√©cifiez l'emplacement de vos packages, et il y a une option nohoist, tr√®s similaire √† l'option nohoist dans lerna.  Sp√©cifiez simplement ces param√®tres et obtenez la m√™me structure que dans lerna.  Toutes les d√©pendances courantes sont all√©es √† la racine et celles sp√©cifi√©es dans la cl√© nohoist sont rest√©es √† leur niveau. <br><br><img src="https://habrastorage.org/webt/6w/rj/8c/6wrj8cm-b68sgcbsm0gstgmwzm8.jpeg"><br><br>  La meilleure partie est que lerna peut travailler avec du fil et ramasser ses param√®tres.  Il suffit de sp√©cifier deux champs dans lerna.json, lerna comprendra imm√©diatement que vous utilisez du fil, allez dans package.json, obtenez tous les param√®tres √† partir de l√† et travaillez avec eux.  Ces deux outils se connaissent d√©j√† et fonctionnent ensemble. <br><br><img src="https://habrastorage.org/webt/q5/hs/em/q5hsemi5za3meeg_s7zjj0sak4g.jpeg"><br><br>  Et pourquoi le support n'a-t-il pas encore √©t√© fait √† npm si tant de grandes entreprises utilisent un mono-r√©f√©rentiel? <br><br><img src="https://habrastorage.org/webt/h1/al/n6/h1aln6qeuati1bbhmojwgtao1xo.jpeg"><br><h5>  <sup><sub><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien depuis la diapositive</a></sub></sup> </h5><br>  Ils disent que tout sera, mais dans la septi√®me version.  Support de base dans le septi√®me, √©tendu - dans le huiti√®me.  Ce post a √©t√© publi√© il y a un mois, mais en m√™me temps, la date n'est pas encore connue pour la sortie du septi√®me npm.  Nous attendons qu'il rattrape enfin le fil. <br><br>  Lorsque vous avez plusieurs services dans un mono-r√©f√©rentiel, la question se pose in√©vitablement de les g√©rer pour ne pas aller dans chaque dossier, ne pas ex√©cuter de commandes?  Il y a des op√©rations massives pour cela. <br><br><img src="https://habrastorage.org/webt/8f/9z/lk/8f9zlkf-hdow1itwrmkiczqm5pk.jpeg"><br><br><img src="https://habrastorage.org/webt/ux/z_/ed/uxz_edv1rkl4bjlydo8q8pndty8.jpeg"><br><br>  Yarn poss√®de une commande d'espace de travail Yarn, suivie du nom du package et du nom de la commande.  √âtant donn√© que le fil de la bo√Æte, contrairement √† npm, peut faire les trois choses: ex√©cuter ses propres commandes, ajouter une d√©pendance √† Jest, ex√©cuter des scripts √† partir de package.json, comme test, et peut √©galement ex√©cuter des fichiers ex√©cutables √† partir du dossier node_modules / .bin.  Il vous enseignera √† l'aide d'heuristiques il comprendra ce que vous voulez.  Il est tr√®s pratique d'utiliser l'espace de travail de fil pour les op√©rations ponctuelles sur un seul paquet. <br><br>  Il existe une commande similaire qui vous permet d'ex√©cuter une commande sur tous les packages dont vous disposez. <br><br><img src="https://habrastorage.org/webt/-e/yn/vd/-eynvdikhrjyxn0we1fkw0loqcw.jpeg"><br><br>  Indiquez uniquement vos commandes avec tous les arguments. <br><br><img src="https://habrastorage.org/webt/qk/_t/lx/qk_tlxutn7it2owurvm5ne444o8.jpeg"><br><br>  De la part des pros, il est tr√®s pratique de diriger diff√©rentes √©quipes.  Parmi les inconv√©nients, par exemple, il est impossible d'ex√©cuter des commandes shell.  Supposons que je veuille supprimer tous les dossiers des modules de n≈ìuds, je ne peux pas ex√©cuter les espaces de travail de fil run rm. <br>  Il n'est pas possible de sp√©cifier une liste de packages, par exemple, je souhaite supprimer la d√©pendance dans seulement deux packages, un seul √† la fois ou s√©par√©ment. <br><br>  Eh bien, il se bloque √† la toute premi√®re erreur.  Si je veux supprimer la d√©pendance de tous les packages - et en fait, seulement deux d'entre eux l'ont, mais je ne veux pas penser o√π elle se trouve, mais je veux juste la supprimer - alors le fil ne le permettra pas, il plantera √† la toute premi√®re situation o√π ce package n'est pas dans les d√©pendances.  Ce n'est pas tr√®s pratique, parfois vous voulez ignorer les erreurs, parcourir tous les packages. <br><br><img src="https://habrastorage.org/webt/gv/bj/ax/gvbjax1gepdak6jwcxpf7q9u8ea.jpeg"><br><br>  Lerna a une bo√Æte √† outils beaucoup plus int√©ressante, il y a deux commandes run et exec distinctes.  Run peut ex√©cuter des scripts √† partir de package.json, et contrairement √† yarn, il peut tout filtrer par packages, vous pouvez sp√©cifier --scope, vous pouvez utiliser des ast√©risques, des globes, tout est assez universel.  Vous pouvez ex√©cuter ces op√©rations en parall√®le, vous pouvez ignorer les erreurs via le commutateur --no-bail. <br><br><img src="https://habrastorage.org/webt/j9/f_/km/j9f_kmpn1tkhfr88nsjykrunm5g.jpeg"><br><br>  Exec est tr√®s similaire.  Contrairement √† Yarn, il vous permet non seulement d'ex√©cuter des fichiers ex√©cutables √† partir de node_modules.bin, mais √©galement d'ex√©cuter des commandes shell arbitraires.  Par exemple, vous pouvez supprimer node_modules ou ex√©cuter une marque, comme vous le souhaitez.  Et la m√™me option est prise en charge. <br><br><img src="https://habrastorage.org/webt/t4/f4/tv/t4f4tv2z0646cgezhzwamag6qgm.jpeg"><br><br>  Des outils tr√®s pratiques, quelques avantages.  C'est le cas lorsque la lerne d√©chire le fil, est au bon niveau d'abstraction.  C'est exactement ce dont lerna a besoin: simplifier le travail avec plusieurs packages en monorepe. <br><br>  Avec les monoreps, il y a encore un inconv√©nient.  Lorsque vous avez un CI / CD, vous ne pouvez pas l‚Äôoptimiser.  Plus vous avez de services, plus cela prend de temps.  Supposons que vous commenciez √† tester tous les services pour chaque demande de pool, et plus il y en a, plus le travail prend de temps.  Des op√©rations s√©lectives peuvent √™tre utilis√©es pour optimiser ce processus.  Je nommerai trois fa√ßons diff√©rentes.  Les deux premiers d'entre eux peuvent √™tre utilis√©s non seulement en monorep, mais aussi dans vos projets, si pour une raison quelconque vous n'utilisez pas ces m√©thodes. <br><br>  La premi√®re est lint-stages, qui vous permet d'ex√©cuter linter, des tests, tout ce que vous voulez, uniquement sur les fichiers qui ont √©t√© modifi√©s ou seront valid√©s dans ce commit.  Ex√©cutez l'int√©gralit√© de la charpie non pas sur l'ensemble de votre projet, mais uniquement sur les fichiers qui ont √©t√© modifi√©s. <br><br><img src="https://habrastorage.org/webt/7v/qj/4z/7vqj4zxxvjc3fyt_bs5nfbk85nc.jpeg"><br><br><img src="https://habrastorage.org/webt/dx/if/eu/dxifeu43kvhxy7kthspwefr2o8m.jpeg"><br><br>  La configuration est tr√®s simple.  Mettez des crochets pelucheux, pr√©-valid√©s et dites que lorsque vous modifiez un fichier js, vous devez ex√©cuter eslint.  Ainsi, la v√©rification de pr√©-validation est consid√©rablement acc√©l√©r√©e.  Surtout si vous avez de nombreux services, un tr√®s grand r√©f√©rentiel mono.  L'ex√©cution d'eslint sur tous les fichiers est alors trop co√ªteuse et vous pouvez optimiser les crochets de pr√©-engagement sur lint de cette mani√®re. <br><br><img src="https://habrastorage.org/webt/x9/n7/dg/x9n7dgdih-y-zepifpkfd9czys8.jpeg"><br><br>  Si vous √©crivez des tests sur Jest, il dispose √©galement d'outils pour ex√©cuter des tests de mani√®re s√©lective. <br><br><img src="https://habrastorage.org/webt/gd/fp/op/gdfpopeopfjlht4excpli5ec0d8.jpeg"><br><br>  Cette option vous permet de lui donner une liste de fichiers source et de trouver tous les tests qui d'une mani√®re ou d'une autre affectent ces fichiers.  Que peut-on utiliser en conjonction avec des peluches?  Attention, ici je ne pr√©cise pas tous les fichiers js, mais seulement la source.  Nous excluons les fichiers js eux-m√™mes avec des tests √† l'int√©rieur, nous ne regardons que la source.  Nous commen√ßons findRelatedTests et acc√©l√©rons consid√©rablement le fonctionnement de l'unit√© pour pr√©commettre ou pr√©-pousser, comme vous le souhaitez. <br><br>  Et la troisi√®me m√©thode est associ√©e aux monorepositoires.  Il s'agit de lerna, qui peut d√©terminer quels packages ont chang√© par rapport √† la validation de base.  Il ne s'agit probablement pas de crochets, mais de votre CI / CD: Travis ou d'un autre service que vous utilisez. <br><br><img src="https://habrastorage.org/webt/bn/is/ij/bnisijuykjzbkbi6-mhd19lwvmq.jpeg"><br><br><img src="https://habrastorage.org/webt/ul/d4/u2/uld4u2saou9lwemuj2ky4usffyu.jpeg"><br><br>  Les commandes run et exec ont l'option since, qui vous permet d'ex√©cuter n'importe quelle commande uniquement dans les packages qui ont chang√© depuis une sorte de commit.  Dans les cas simples, vous pouvez sp√©cifier un assistant si vous y versez tout.  Si vous voulez plus de pr√©cision, il est pr√©f√©rable de sp√©cifier la validation de base de votre demande de pool via votre outil CI / CD, alors ce sera un test plus honn√™te. <br><br>  Puisque lerna conna√Æt toutes les d√©pendances √† l'int√©rieur des packages, il peut √©galement d√©tecter les d√©pendances indirectes.  Si vous changez la biblioth√®que A, qui est utilis√©e dans la biblioth√®que B, qui est utilis√©e dans le service C, lerna le comprendra. ,      .    ,   C   ‚Äî ,      .  lerna      . <br><br>   ,    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">c lerna</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  yarn workspaces   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>      . <br><br>  ,   .  ,   .    .  ?    ,        ,       ,   .  ,         ,     .    ,   -      . ,      Babel.     ,   ,     .                  .     ,           . <br><br>     :  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">mishanga</a>    .        ,    ,     .   , . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469021/">https://habr.com/ru/post/fr469021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469007/index.html">RubyRussia 2019. Nikita Shilnikov sur les effets alg√©briques</a></li>
<li><a href="../fr469009/index.html">Le fret culte dans le d√©veloppement de logiciels</a></li>
<li><a href="../fr469011/index.html">11 mythes sur l'USB Type-C</a></li>
<li><a href="../fr469015/index.html">Slurm: Moscou intensif par Kubernetes et autres annonces</a></li>
<li><a href="../fr469019/index.html">SPA Meetup 5: Int√©gration Jest avec QA, UIKit puissant, biblioth√®ques de composants, DI pour la mise √† l'√©chelle, commandes de plate-forme</a></li>
<li><a href="../fr469023/index.html">Comment trouver un emploi avec d√©localisation en Europe: un guide pratique pour les professionnels de l'informatique</a></li>
<li><a href="../fr469025/index.html">Refroidissez le vin rapidement! Invention russe</a></li>
<li><a href="../fr469027/index.html">Ivanovo! Mitap: Comment construire une carri√®re dans le num√©rique?</a></li>
<li><a href="../fr469031/index.html">12 nouvelles intelligence artificielle Azure Media Services</a></li>
<li><a href="../fr469033/index.html">Lancement de la plateforme Elbrus pour les r√©seaux neuronaux PuzzleLib</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>