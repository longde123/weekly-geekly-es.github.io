<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™‹ ğŸ¥Š ğŸ™‚ How Go rettete unseren schwarzen Freitag ğŸˆ¶ ğŸ§”ğŸ¾ ğŸ™†ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zuvor haben wir darÃ¼ber gesprochen, wie wir mit zunehmender Auslastung die Verwendung von Python im Backend kritischer Produktionsdienste schrittweise...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>How Go rettete unseren schwarzen Freitag</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/434208/">  Zuvor haben wir darÃ¼ber gesprochen, wie wir mit zunehmender Auslastung die Verwendung von Python im Backend kritischer Produktionsdienste schrittweise aufgegeben und durch Go ersetzt haben.  Und heute mÃ¶chte ich, Denis Girko, Teamleiter des Madmin-Entwicklungsteams, Details mitteilen: Wie und warum dies am Beispiel einer der wichtigsten Dienstleistungen fÃ¼r unser Unternehmen geschehen ist - Berechnung des Preises unter BerÃ¼cksichtigung von Rabatten auf Gutscheine. <br><br><img src="https://habrastorage.org/webt/8q/bo/y4/8qboy4stjrxnm432zasibweeyqe.jpeg"><br><a name="habracut"></a><br>  Die Mechanik der Arbeit mit Gutscheinen wird wahrscheinlich von jedem vertreten, der mindestens einmal in Online-Shops eingekauft hat.  Auf einer speziellen Seite oder direkt im Warenkorb geben Sie die Gutscheinnummer ein und die Preise werden entsprechend dem versprochenen Rabatt neu berechnet.  Die Berechnung hÃ¤ngt davon ab, welche Art von Rabatt der Gutschein bietet - in Prozent, in Form eines festen Betrags oder unter Verwendung einer anderen Mathematik (zum Beispiel berÃ¼cksichtigen wir zusÃ¤tzlich Punkte des Treueprogramms, VerkaufsfÃ¶rderungsaktionen, Warentypen usw.).  NatÃ¼rlich wird die Bestellung bereits mit neuen Preisen ausgestellt. <br><br>  Die Wirtschaft ist von all diesen Mechanismen der Arbeit mit Preisen begeistert, aber wir mÃ¶chten den Service aus einem etwas anderen Blickwinkel betrachten. <br><br><h2>  Wie funktioniert es? </h2><br>  FÃ¼r die Preisgestaltung unter BerÃ¼cksichtigung all dieser Schwierigkeiten im Backend haben wir jetzt einen separaten Service.  Er war jedoch nicht immer unabhÃ¤ngig.  Der Dienst erschien ein oder zwei Jahre nach dem Start des Online-Shops und war bis 2016 Teil eines groÃŸen Python-Monolithen, der eine Vielzahl von Komponenten fÃ¼r MarketingaktivitÃ¤ten (Madmin) enthielt.  SpÃ¤ter stach er als unabhÃ¤ngiger â€Blockâ€œ hervor, als er sich der Microservice-Architektur zuwandte. <br><br>  Wie bei Monolithen Ã¼blich, wurde Madmin modifiziert und korrespondierte teilweise mit einer groÃŸen Anzahl von Entwicklern.  Dort wurden Bibliotheken von Drittanbietern integriert, was die Entwicklung vereinfachte, sich jedoch hÃ¤ufig nicht optimal auf die Leistung auswirkte.  Zu diesem Zeitpunkt war uns der Widerstand gegen schwere Lasten wÃ¤hrend des Verkaufs jedoch nicht wirklich wichtig, da der Service die Aufgabe hervorragend erledigte.  Aber 2016 hat alles verÃ¤ndert. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e40/3a3/3e1/e403a33e16fea41905491776c8b0c26e.jpg"><br><br>  In den USA ist "Black Friday" seit den 60er Jahren des letzten Jahrhunderts bekannt.  In Russland begann die EinfÃ¼hrung in den 2010er Jahren, wÃ¤hrend die Aktion von Grund auf neu erstellt werden musste - der Markt war nicht ganz bereit dafÃ¼r.  Die BemÃ¼hungen der Organisatoren waren jedoch nicht umsonst, und mit jedem Jahr nahm der Nutzerverkehr auf unserer Website wÃ¤hrend der Verkaufstage zu.  Daher war unsere Kollision mit der Last, die fÃ¼r diese Version des Preisberechnungsdienstes zu hoch war, nur eine Frage der Zeit. <br><br><h2>  Schwarzer Freitag 2016. Und wir haben sie verschlafen </h2><br>  Da die Verkaufsidee ihr volles Potenzial entfaltet hat, unterscheidet sich â€Black Fridayâ€œ von jedem anderen Tag des Jahres darin, dass um Mitternacht ein ungefÃ¤hr wÃ¶chentliches Website-Publikum in den Laden kommt.  Dies ist eine schwierige Zeit fÃ¼r alle Dienste.  Selbst bei denen, die das ganze Jahr Ã¼ber reibungslos funktionieren, treten manchmal Probleme auf. <br><br>  Jetzt bereiten wir uns auf jeden neuen â€Black Fridayâ€œ vor und ahmen die erwartete Belastung nach, aber 2016 haben wir uns immer noch anders verhalten.  Beim Testen von Madmin vor einem wichtigen Tag haben wir die LastbestÃ¤ndigkeit anhand von Benutzerverhaltensszenarien an normalen Tagen getestet.  Wie sich herausstellte, spiegelt dieser Test nicht die tatsÃ¤chliche Situation wider, da am "Black Friday" viele Leute mit dem gleichen Gutschein kommen.  Infolgedessen blockierte der Preisberechnungsdienst unter BerÃ¼cksichtigung dieses Preisnachlasses, der eine dreifache Belastung (im Vergleich zu normalen Tagen) nicht bewÃ¤ltigen konnte, die MÃ¶glichkeit, Kunden wÃ¤hrend des heiÃŸesten HÃ¶hepunkts des Verkaufs zwei Stunden lang zu bedienen. <br><br>  Der Dienst "ging" eine Stunde vor Mitternacht.  Alles begann mit einer Unterbrechung der Verbindung zur Datenbank (zu diesem Zeitpunkt MySQL), wonach nicht alle laufenden Kopien des Preisberechnungsdienstes wieder eine Verbindung herstellen konnten.  Und diejenigen, die noch verbunden waren, hielten der Last nicht stand und reagierten nicht mehr, da sie an den BasisschlÃ¶ssern steckten. <br><br>  ZufÃ¤llig blieb der Junior dann im Dienst, der zum Zeitpunkt des Dienstausfalls auf dem Weg vom BÃ¼ro nach Hause war.  Er konnte sich erst mit dem Problem verbinden, als er am Ort ankam und die "schwere Artillerie" - den Notdienstoffizier - anrief.  Zusammen normalisierten sie die Situation jedoch erst nach zwei Stunden. <br><br>  Zu Beginn des Verfahrens wurden Einzelheiten darÃ¼ber bekannt, wie suboptimal der Dienst war.  Zum Beispiel stellte sich heraus, dass zur Berechnung eines Coupons 28 Abfragen an die Datenbank gestellt wurden (es ist nicht Ã¼berraschend, dass alles mit 100% CPU-Auslastung funktionierte).  Die oben genannten Benutzer mit demselben Black Friday-Gutschein haben die Situation nicht vereinfacht, zumal wir fÃ¼r alle Gutscheine einen AnwendungszÃ¤hler hatten. Bei jeder Verwendung wurde die Belastung erhÃ¶ht, indem auf diesen ZÃ¤hler verwiesen wurde. <br><br>  2016 gab uns viele DenkanstÃ¶ÃŸe - hauptsÃ¤chlich darÃ¼ber, wie wir unsere Arbeit mit Gutscheinen und Tests so anpassen kÃ¶nnen, dass diese Situation nicht erneut auftritt.  Und in Zahlen wird dieser Freitag am besten durch dieses Bild beschrieben: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/75e/310/1fc/75e3101fca74fc4e8b220673619eaada.jpg"><br>  <i>Die Ergebnisse des Black Friday 2016</i> <br><br><h2>  Schwarzer Freitag 2017. Wir haben uns ernsthaft vorbereitet, aber ... </h2><br>  Nachdem wir eine gute Lektion erhalten hatten, bereiteten wir uns im Voraus auf den nÃ¤chsten â€Schwarzen Freitagâ€œ vor, nachdem wir den Service ernsthaft umgebaut und optimiert hatten.  Zum Beispiel haben wir schlieÃŸlich zwei Arten von Coupons erstellt: limit und unbegrenzt. Um Sperren beim gleichzeitigen Zugriff auf die Datenbank zu vermeiden, haben wir den Eintrag in die Datenbank aus dem Skript entfernt, um den beliebten Coupon anzuwenden.  Parallel dazu haben wir 1â€“2 Monate vor â€Black Fridayâ€œ im Dienst von MySQL auf PostgreSQL umgestellt, wodurch zusammen mit der Codeoptimierung die Anzahl der Aufrufe der Datenbank von 28 auf 4â€“5 reduziert wurde. Diese Verbesserungen ermÃ¶glichten es, den Testdienst auf SLA-Anforderungen auszudehnen - Antwort in 3 Sekunden 95 Perzentil bei 600 U / min. <br><br>  Da wir keine Ahnung hatten, wie sehr unsere Verbesserungen die Arbeit der alten Version des Service in der Produktion beschleunigten, wurden zu diesem Zeitpunkt zwei Versionen des Python-Codes gleichzeitig fÃ¼r den Black Friday vorbereitet - eine hochoptimierte vorhandene Version und vÃ¶llig neuer Code, der von Grund auf neu geschrieben wurde.  In der Produktion wurde der zweite ausgerollt, der vor diesem Tag und dieser Nacht getestet wurde.  Wie sich jedoch "im Kampf" herausstellte, etwas unterbewertet. <br><br>  Am Tag des "Notfalls" mit dem Eintreffen des Hauptkundenstroms begann die Belastung des Dienstes exponentiell zu wachsen.  Einige Anfragen wurden bis zu zwei Minuten bearbeitet.  Aufgrund der langen Bearbeitung einiger Anfragen stieg die Belastung fÃ¼r andere Arbeitnehmer. <br><br>  Unsere Hauptaufgabe war es, solch wertvollen Verkehr fÃ¼r Unternehmen bereitzustellen.  Es wurde jedoch klar, dass "GieÃŸen mit Eisen" das Problem nicht lÃ¶st und die Anzahl der beschÃ¤ftigten Arbeiter ab jeder Minute 100% erreichen wird.  Da wir nicht genau wussten, womit wir konfrontiert waren, beschlossen wir, Harakiri in uWSGI zu aktivieren und einfach lange Anfragen (die lÃ¤nger als 6 Sekunden verarbeitet werden) festzunageln, um Ressourcen fÃ¼r normale freizugeben.  Und es half wirklich, Widerstand zu leisten - die Arbeiter wurden nur ein paar Minuten vor ihrer vÃ¶lligen ErschÃ¶pfung freigelassen. <br><br>  Wenig spÃ¤ter haben wir die Situation herausgefunden ... Es stellte sich heraus, dass es sich um Anfragen mit sehr groÃŸen KÃ¶rben - von 40 bis 100 Waren - und mit einem bestimmten Gutschein handelte, der EinschrÃ¤nkungen im Sortiment hatte.  Diese Situation wurde durch den neuen Code schlecht herausgearbeitet.  Es zeigte eine falsche Arbeit mit dem Array, die sich in eine unendliche Rekursion verwandelte.  Es ist merkwÃ¼rdig, dass wir dann einen Koffer mit groÃŸen KÃ¶rben getestet haben, aber nicht in Kombination mit einem kniffligen Gutschein.  Als LÃ¶sung haben wir einfach auf eine andere Version des Codes umgestellt.  Dies geschah zwar drei Stunden vor dem Ende des Schwarzen Freitags.  Von diesem Moment an wurden alle KÃ¶rbe korrekt verarbeitet.  Und obwohl wir zu diesem Zeitpunkt den Verkaufsplan abgeschlossen haben, haben wir wundersame globale Probleme aufgrund der fÃ¼nfmaligen Belastung am Ã¼blichen Tag vermieden. <br><br><h2>  Schwarzer Freitag 2018 </h2><br>  Bis 2018 haben wir fÃ¼r hoch ausgelastete Dienste, die die Site bedienen, schrittweise mit der Implementierung von Go begonnen.  In Anbetracht der Geschichte frÃ¼herer Schwarzer Freitage war der Rabattberechnungsdienst einer der ersten Kandidaten fÃ¼r die Verarbeitung. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f2/257/86a/2f225786a88b927c087c904c36702203.jpg"><br><br>  NatÃ¼rlich kÃ¶nnten wir die Version von Python speichern, die bereits "im Kampf getestet" wurde, und vor dem neuen "Black Friday" kÃ¶nnten wir schwere Bibliotheken ausschalten und nicht optimalen Code wegwerfen.  Zu diesem Zeitpunkt hatte Golang jedoch bereits Wurzeln geschlagen und sah vielversprechender aus. <br><br>  Wir haben diesen Sommer auf einen neuen Service umgestellt, sodass wir ihn vor dem nÃ¤chsten Verkauf gut testen konnten, auch bei zunehmendem Lastprofil. <br><br>  Beim Testen stellte sich heraus, dass die SchwÃ¤che in Bezug auf hohe Lasten unsere Basis bleibt.  Zu lange Transaktionen fÃ¼hrten dazu, dass wir den gesamten Verbindungspool ausgewÃ¤hlt haben und Anforderungen in die Warteschlange gestellt wurden.  Daher mussten wir die Logik der Anwendung ein wenig Ã¼berarbeiten, die Nutzung der Datenbank auf ein Minimum reduzieren (nur dann darauf verweisen, wenn nichts dagegen zu tun ist) und Verzeichnisse aus der Datenbank und Daten zu Coupons zwischenspeichern, die am Black Friday beliebt sind. <br><br>  In diesem Jahr haben wir zwar einen groÃŸen Fehler bei den Lastprognosen gemacht: Wir haben uns auf ein 6-8-faches Wachstum der Spitzen vorbereitet und nur fÃ¼r ein solches Anforderungsvolumen gute Arbeit geleistet (zusÃ¤tzliche Caches hinzugefÃ¼gt, experimentelle Funktionen im Voraus deaktiviert, einige Dinge vereinfacht, zusÃ¤tzliche Kubernetes-Knoten bereitgestellt und sogar Datenbankserver fÃ¼r Replikate, die am Ende nicht benÃ¶tigt wurden).  TatsÃ¤chlich war der Anstieg des Benutzerinteresses geringer, sodass alles wie gewohnt verlief.  Die Antwortzeit des Dienstes Ã¼berschritt 50 ms bei 95 Perzentilen nicht. <br><br>  FÃ¼r uns ist eines der wichtigsten Merkmale, wie die Anwendung skaliert wird, wenn nicht genÃ¼gend Ressourcen fÃ¼r eine Kopie vorhanden sind.  Go nutzt Hardwareressourcen effizienter, sodass Sie bei gleicher Auslastung weniger Kopien ausfÃ¼hren mÃ¼ssen (was letztendlich mehr Anforderungen auf denselben Hardwareressourcen bedient).  In diesem Jahr, zum HÃ¶hepunkt des Verkaufs, arbeiteten 16 Instanzen der Anwendung, die durchschnittlich 300 Anfragen pro Sekunde mit Spitzenwerten von bis zu 400 Anfragen pro Sekunde verarbeiteten, was ungefÃ¤hr dem Zweifachen der Ã¼blichen Auslastung entspricht.  Beachten Sie, dass fÃ¼r einen Python-Dienst im letzten Jahr 102 Instanzen erforderlich waren. <br><br>  Es scheint, dass der Service on Go vom ersten Ansatz an alle unsere BedÃ¼rfnisse erfÃ¼llt hat.  Aber Golang ist keine "One-Stop-LÃ¶sung fÃ¼r alle Probleme".  Auf einige Funktionen konnte es nicht verzichten.  Zum Beispiel mussten wir die Anzahl der Threads begrenzen, die der Dienst auf dem Kubernetes-Multiprozessorknoten starten kann, damit beim Skalieren "benachbarte" Anwendungen in der Produktion nicht beeintrÃ¤chtigt werden (standardmÃ¤ÃŸig hat Go keine Begrenzung fÃ¼r die Anzahl der Prozessoren).  Dazu setzen wir GOMAXPROCS in allen Anwendungen auf Go.  Wir werden gerne kommentieren, wie nÃ¼tzlich dies war - in unserem Team war dies nur eine der Hypothesen zum Umgang mit der Verschlechterung von "Nachbarn". <br><br>  Ein weiteres â€Setupâ€œ ist die Anzahl der Verbindungen, die als Keep-Alive gehalten werden.  Normale http- und DB-Clients in Go halten standardmÃ¤ÃŸig nur zwei Verbindungen. Wenn also viele Anforderungen gleichzeitig vorliegen und Sie den Datenverkehr beim Einrichten der TCP-Verbindung sparen mÃ¼ssen, ist es sinnvoll, diesen Wert durch Festlegen von MaxIdleConnsPerHost bzw. SetMaxIdleConns zu erhÃ¶hen. <br><br>  Trotz dieser manuellen â€Wendungenâ€œ bot uns Golang eine groÃŸe Leistungsspanne fÃ¼r zukÃ¼nftige VerkÃ¤ufe. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de434208/">https://habr.com/ru/post/de434208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de434196/index.html">3CX v16 Alpha 2 und PlÃ¤ne fÃ¼r das neue Jahr</a></li>
<li><a href="../de434198/index.html">Auswahl eines Webserver-Betriebsmodus basierend auf persÃ¶nlichen Erfahrungen</a></li>
<li><a href="../de434200/index.html">Ist Rust so schrecklich wie es gemalt ist</a></li>
<li><a href="../de434202/index.html">4 Geheimnisse, wie Sie Ihren Job in der Datenwissenschaft nicht verlieren kÃ¶nnen</a></li>
<li><a href="../de434206/index.html">Jet Distributor ok.ru/music</a></li>
<li><a href="../de434210/index.html">Analyse des Android-Quizwettbewerbs vom HeadHunter-Stand auf der Mobius 2018 in Moskau</a></li>
<li><a href="../de434212/index.html">Tesla Tower. Was passiert in und in der NÃ¤he eines Wolkenkratzers, wenn ein Blitz einschlÃ¤gt?</a></li>
<li><a href="../de434214/index.html">Java Dynamic Proxy: Was ist das und wie wird es verwendet?</a></li>
<li><a href="../de434216/index.html">Brute-Force-Angriffe mit Kali Linux</a></li>
<li><a href="../de434218/index.html">Einfacher Java Clicker Bot am Beispiel des Spiels World of Warcraft 3.3.5a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>