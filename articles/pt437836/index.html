<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí∂ üì§ üçô Sob o cap√¥ Screeps - virtualiza√ß√£o na caixa de areia MMO para programadores üìè ü§∂üèø üëàüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, falarei sobre uma tecnologia pouco conhecida que encontrou um aplicativo-chave em nosso jogo online para programadores. Para n√£o puxar a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sob o cap√¥ Screeps - virtualiza√ß√£o na caixa de areia MMO para programadores</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437836/"><p> Neste artigo, falarei sobre uma tecnologia pouco conhecida que encontrou um aplicativo-chave em nosso jogo online para programadores.  Para n√£o puxar a borracha por um longo tempo, h√° um spoiler imediatamente: parece que ningu√©m fez tal xamanismo no c√≥digo nativo do Node.js. ao qual chegamos ap√≥s v√°rios anos de desenvolvimento.  O mecanismo de m√°quina virtual isolada (c√≥digo aberto), executado sob o cap√¥ do projeto, foi escrito especificamente para suas necessidades e atualmente √© usado na produ√ß√£o por n√≥s e por outra startup.  E os recursos de isolamento que ele fornece s√£o √∫nicos e merecem ser informados sobre eles. </p><br><p>  Mas vamos falar sobre tudo em ordem. </p><br><h2>  Antecedentes </h2><br><p>  Voc√™ gosta de programar?  N√£o √© a rotina da empresa que muitos de n√≥s somos obrigados a fazer 40 horas por semana, lutando com a procrastina√ß√£o, derramando litros de caf√© e queimando profissionalmente;  e <i>programa√ß√£o</i> √© um processo m√°gico incompar√°vel de transformar pensamentos em um programa de trabalho, aproveitando o fato de que o c√≥digo que voc√™ acabou de escrever est√° incorporado na tela e come√ßa a viver a vida que o criador pede.  Nesses momentos, quero escrever a palavra "Criador" com uma letra mai√∫scula - um sentimento que surge no processo √†s vezes √© quase uma rever√™ncia. </p><br><p><img src="https://habrastorage.org/webt/mm/2a/5h/mm2a5hmu2k6s26hviyoykwd6tv8.jpeg"></p><br><p>  √â uma pena que muito poucos projetos reais relacionados aos ganhos di√°rios possam oferecer a seus desenvolvedores tais sentimentos.  Na maioria das vezes, para n√£o perder a paix√£o pela programa√ß√£o, os entusiastas precisam come√ßar um caso paralelo: um hobby de programa√ß√£o, um projeto para animais de estima√ß√£o, um c√≥digo aberto na moda, apenas um script em python para automatizar sua casa inteligente ... ou o comportamento de um personagem em algum popular online jogo. </p><a name="habracut"></a><br><p>  Sim, s√£o os jogos online que geralmente fornecem uma fonte inesgot√°vel de inspira√ß√£o para os programadores.  At√© os primeiros jogos desse g√™nero (Ultima Online, Everquest, sem mencionar todos os tipos de MUDs) atra√≠ram muitos artes√£os que n√£o se interessam tanto em desempenhar o papel e apreciar a fantasia do mundo, mas na aplica√ß√£o de seus talentos para automatizar tudo e tudo em espa√ßo de jogo virtual.  E at√© hoje, isso continua sendo uma disciplina especial da Olimp√≠ada de Jogos MMO on-line: refinar sua mente ao escrever seu bot para que ele passe despercebido pela administra√ß√£o e obtenha o lucro m√°ximo em compara√ß√£o com outros jogadores.  Ou outros bots - como, por exemplo, no EVE Online, onde a negocia√ß√£o em mercados densamente povoados √© um pouco menos do que totalmente controlada por scripts de negocia√ß√£o, assim como em bolsas reais. </p><br><p>  A ideia de um jogo online, <em>inicialmente e completamente orientada para programadores,</em> pairava no ar.  Tal jogo em que escrever um bot n√£o √© um ato pun√≠vel, mas a ess√™ncia da jogabilidade.  Onde a tarefa seria n√£o executar as mesmas a√ß√µes "Matar monstros X e encontrar itens Y" de tempos em tempos, mas escrever um script que possa executar corretamente essas a√ß√µes em seu nome.  E como implica um jogo online no g√™nero MMO, a rivalidade ocorre com os scripts de outros jogadores em tempo real em um √∫nico mundo de jogo comum. </p><br><p>  Ent√£o, em 2014, o jogo Screeps (das palavras "Scripts" e "creeps") apareceu - uma caixa de areia MMO estrat√©gica em tempo real com um √∫nico <em>mundo persistente</em> grande no qual os jogadores n√£o influenciam o que est√° acontecendo, exceto escrevendo scripts de IA para suas unidades de jogo .  Toda a mec√¢nica de um jogo estrat√©gico comum - extra√ß√£o de recursos, constru√ß√£o de unidades, constru√ß√£o de uma base, tomada de territ√≥rios, fabrica√ß√£o e comercializa√ß√£o - o pr√≥prio jogador precisa ser programado atrav√©s da API JavaScript fornecida pelo mundo do jogo.  A diferen√ßa das diferentes competi√ß√µes na cria√ß√£o de IA √© que o mundo do jogo, como deveria estar no mundo dos jogos on-line, constantemente trabalha e vive sua vida em tempo real 24/7 nos √∫ltimos 4 anos, lan√ßando a IA de cada jogador a cada ciclo de jogo. </p><br><p>  Portanto, basta o jogo em si - isso deve ser suficiente para entender melhor a ess√™ncia dos problemas t√©cnicos que encontramos durante o desenvolvimento.  Voc√™ pode obter mais visualiza√ß√µes deste v√≠deo, mas isso √© opcional: </p><br><div class="spoiler">  <b class="spoiler_title">Trailer de v√≠deo</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZboTgOajnGg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2>  Quest√µes t√©cnicas </h2><br><p>  A ess√™ncia da mec√¢nica do mundo do jogo √© a seguinte: o mundo inteiro √© dividido em <strong>salas</strong> , que s√£o interconectadas por sa√≠das em quatro pontos cardeais.  Uma sala √© uma unidade at√¥mica do processo de processamento do estado do mundo do jogo.  A sala pode ter certos objetos (por exemplo, unidades) que t√™m seu pr√≥prio estado e, em cada etapa do jogo, eles recebem comandos dos jogadores.  O manipulador de servidor ocupa uma sala de cada vez, executa esses comandos, alterando o estado dos objetos e confirma o novo estado da sala no banco de dados.  Esse sistema √© dimensionado bem horizontalmente: voc√™ pode adicionar mais manipuladores ao cluster e, como as salas s√£o arquitetonicamente isoladas uma da outra, √© poss√≠vel processar tantas salas em paralelo quanto os manipuladores em execu√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/mp/d0/ed/mpd0ed40jp8efrihjrxkfft49fc.png"></p><br><p>  No momento, temos <strong>42.060 quartos</strong> no jogo.  Um cluster de servidores de 36 m√°quinas f√≠sicas de quatro n√∫cleos cont√©m 144 processadores.  Usamos o Redis para criar filas, todo o back-end √© escrito em Node.js. </p><br><p>  Essa foi uma etapa do jogo.  Mas de onde v√™m as equipes de jogadores?  A especificidade do jogo √© que n√£o h√° interface onde voc√™ possa clicar em uma unidade e pedir para ele ir a um determinado ponto ou construir uma estrutura espec√≠fica.  O m√°ximo que pode ser feito na interface √© colocar uma bandeira intang√≠vel no lugar certo na sala.  Para que a unidade chegue a este local e tome as medidas necess√°rias, √© necess√°rio que o seu script fa√ßa algo como o seguinte para v√°rios ticks do jogo: </p><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.loop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> creep = Game.creeps[<span class="hljs-string"><span class="hljs-string">'Creep1'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> flag = Game.flags[<span class="hljs-string"><span class="hljs-string">'Flag1'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!creep.pos.isEqualTo(flag.pos)) { creep.moveTo(flag.pos); } }</code> </pre> <br><p>  Acontece que, em cada etapa do jogo, voc√™ precisa <code>loop</code> fun√ß√£o de <code>loop</code> do jogador, execut√°-la em um ambiente JavaScript completo desse jogador em particular (no qual o objeto <code>Game</code> formado para ele existe), obter um conjunto de pedidos para as unidades e envi√°-las para a pr√≥xima fase de processamento.  Tudo parece ser bem simples. </p><br><p><img src="https://habrastorage.org/webt/po/om/vh/poomvhcw4nhpjcsgk2df0a5hg_e.png"></p><br><p>  Os problemas come√ßam quando se trata das nuances da implementa√ß√£o.  No momento, temos <strong>1600 jogadores ativos</strong> no mundo.  Os scripts de players individuais j√° n√£o podem ser chamados de "scripts" - alguns deles cont√™m at√© <strong>25k linhas de c√≥digo</strong> , s√£o compilados a partir de TypeScript ou mesmo a partir de C / C ++ / Rust via WebAssembly (sim, apoiamos wasm!), E implementamos o conceito de sistemas operacionais em miniatura reais, em que os jogadores desenvolveram seu pr√≥prio conjunto de tarefas - processos e gerenciamento de jogos por meio do n√∫cleo, que executa tantas tarefas quantas forem necess√°rias para executar um determinado tato de um jogo, as executa e as coloca de volta nas filas at√© a pr√≥xima medida.  Como a CPU e a mem√≥ria do player s√£o limitadas a cada ciclo de clock, este modelo funciona bem.  Embora n√£o seja obrigat√≥rio - para iniciar o jogo, √© suficiente para um iniciante pegar um script de 15 linhas, que tamb√©m j√° est√° escrito como parte do tutorial. </p><br><p>  Mas agora vamos lembrar que o script do player deve funcionar em uma m√°quina JavaScript real.  E que o jogo funcione em tempo real - ou seja, a m√°quina JavaScript de cada jogador deve existir constantemente, trabalhando em um determinado ritmo, para n√£o desacelerar o jogo como um todo.  O est√°gio de execu√ß√£o de scripts de jogos e forma√ß√£o de ordens para unidades funciona aproximadamente no mesmo princ√≠pio das salas de processamento - o script de cada jogador √© uma tarefa que um manipulador do pool assume, muitos manipuladores paralelos trabalham no cluster.  Mas, diferentemente do est√°gio das salas de processamento, j√° existem muitas dificuldades. </p><br><p>  Em primeiro lugar, n√£o √© poss√≠vel distribuir tarefas pelos manipuladores aleatoriamente em cada ciclo do rel√≥gio, como √© poss√≠vel fazer no caso de salas.  A m√°quina JavaScript do jogador deve funcionar sem interrup√ß√£o, cada medida subseq√ºente √© apenas uma nova chamada de fun√ß√£o de <code>loop</code> , mas o contexto global deve continuar o mesmo.  Grosso modo, o jogo permite que voc√™ fa√ßa algo assim: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> song = [<span class="hljs-string"><span class="hljs-string">'EX-'</span></span>, <span class="hljs-string"><span class="hljs-string">'TER-'</span></span>, <span class="hljs-string"><span class="hljs-string">'MI-'</span></span>, <span class="hljs-string"><span class="hljs-string">'NATE!'</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.loop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ Game.creeps[<span class="hljs-string"><span class="hljs-string">'DalekSinger'</span></span>].say(song[counter]); counter++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(counter == song.length) { counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> <br><p><img src="https://habrastorage.org/webt/sz/sk/je/szskjecusiurkgvg1apq3sxzjdw.gif"></p><br><p>  Tal flu√™ncia vai cantar em uma linha da m√∫sica a cada jogo.  O n√∫mero da linha do <code>counter</code> m√∫sicas √© armazenado em um contexto global que √© armazenado entre as medidas.  Se cada vez que o script deste player for executado em um novo processo de tratamento, o contexto ser√° perdido.  Isso significa que todos os jogadores devem ser alocados para manipuladores espec√≠ficos e devem ser alterados o menos poss√≠vel.  Mas e o balanceamento de carga?  Um jogador pode gastar 500ms de execu√ß√£o nesse n√≥, e o outro jogador pode gastar 10ms, e √© muito dif√≠cil prever isso com anteced√™ncia.  Se 20 jogadores 500ms cada ca√≠rem em um n√≥, a opera√ß√£o desse n√≥ levar√° 10 segundos, durante os quais todos os outros aguardar√£o sua conclus√£o e ficar√£o inativos.  E para reequilibrar esses jogadores e jog√°-los para outros n√≥s, voc√™ precisa perder o contexto deles. </p><br><p>  Em segundo lugar, o ambiente do jogador deve estar bem isolado de outros jogadores e do ambiente do servidor.  E isso diz respeito n√£o apenas √† seguran√ßa, mas tamb√©m ao conforto dos pr√≥prios usu√°rios.  Se um jogador vizinho rodando no mesmo n√≥ no cluster que eu, horrivelmente, gera muito lixo e geralmente se comporta de maneira inadequada, n√£o devo sentir isso.  Como o recurso da CPU no jogo √© o tempo de execu√ß√£o do script (√© calculado do in√≠cio ao fim do m√©todo de <code>loop</code> ), o desperd√≠cio de recursos em tarefas externas durante a execu√ß√£o do meu script pode ser muito sens√≠vel, porque √© gasto com o or√ßamento de recursos da CPU. </p><br><p>  Ao tentar lidar com esses problemas, criamos v√°rias solu√ß√µes. </p><br><h2 id="pervaya-versiya">  Primeira vers√£o </h2><br><p>  A primeira vers√£o do mecanismo de jogo foi baseada em duas coisas b√°sicas: </p><br><ul><li>  m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>vm</code></a> em tempo integral na entrega do Node.js, </li><li>  bifurca√ß√£o dos processos de tempo de execu√ß√£o. </li></ul><br><p>  Parecia assim.  Em cada m√°quina do cluster, havia 4 processos (de acordo com o n√∫mero de n√∫cleos) de manipuladores de scripts de jogos.  Quando uma nova tarefa era recebida da fila de scripts de jogos, o manipulador solicitava os dados necess√°rios do banco de dados e transferia-os para o processo filho, que era mantido em um estado de execu√ß√£o constante, reiniciado em caso de falha e reutilizado por diferentes jogadores.  O processo filho, sendo isolado do pai (que continha a l√≥gica de neg√≥cios do cluster), s√≥ podia fazer uma coisa: criar um objeto <code>Game</code> partir dos dados recebidos e iniciar a m√°quina virtual do jogador.  Para come√ßar, usamos o m√≥dulo <code>vm</code> no Node.js. </p><br><p>  Por que essa decis√£o foi imperfeita?  A rigor, os dois problemas acima n√£o foram resolvidos aqui. </p><br><p>  <code>vm</code> funciona no mesmo modo de thread √∫nico que o Node.js.  Portanto, para ter quatro processadores paralelos em cada n√∫cleo em uma m√°quina de 4 n√∫cleos, voc√™ precisa ter 4 processos.  Mover um jogador "vivendo" em um processo para outro processo leva a uma recria√ß√£o completa do contexto global, mesmo que isso aconte√ßa na mesma m√°quina. </p><br><p><img src="https://habrastorage.org/webt/mu/pk/xl/mupkxlqzbbgh4zjnnymqjdjapm0.png"></p><br><p>  Al√©m disso, o <code>vm</code> n√£o cria realmente uma m√°quina virtual totalmente isolada.  O que ele faz √© apenas criar um <em>contexto</em> ou escopo isolado, mas executar o c√≥digo na mesma inst√¢ncia da m√°quina virtual JavaScript, de onde <code>vm.runInContext</code> chamada <code>vm.runInContext</code> .  E isso significa - no mesmo caso em que outros jogadores s√£o lan√ßados.  Embora os players sejam separados por contextos globais isolados, mas, fazendo parte da mesma m√°quina virtual, eles t√™m uma mem√≥ria de pilha comum, um coletor de lixo comum e geram lixo juntos.  Se o jogador "A" gerou muito lixo durante a execu√ß√£o do script do jogo, o trabalho conclu√≠do e o controle foram passados ‚Äã‚Äãpara o jogador "B", nesse momento <em>todo o</em> lixo do processo pode ser coletado e o jogador "B" pagar√° o tempo da CPU para coletar o lixo de outra pessoa.  Sem mencionar o fato de que todos os contextos funcionam no mesmo loop de eventos e, teoricamente, √© poss√≠vel executar a promessa de outra pessoa a qualquer momento, embora tenhamos tentado evitar isso.  Al√©m disso, o <code>vm</code> n√£o permite controlar a quantidade de mem√≥ria heap que √© alocada para a execu√ß√£o do script, toda a mem√≥ria do processo est√° dispon√≠vel. </p><br><h2 id="isolated-vm">  vm isolado </h2><br><p>  Mora uma pessoa t√£o maravilhosa chamada Marcel Laverde.  Para alguns, ele se tornou not√°vel por escrever uma biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fibras de n√≥</a> , para outros, por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">invadir o Facebook e foi contratado para trabalhar l√°</a> .  E para n√≥s ele √© maravilhoso porque participou generosamente de nossa primeira campanha de crowdfunding e at√© hoje √© um grande f√£ de Screeps. </p><br><p>  Nosso projeto est√° em c√≥digo aberto h√° v√°rios anos - o servidor do jogo √© publicado no GitHub.  Embora o cliente oficial seja vendido por uma taxa via Steam, h√° vers√µes alternativas e o pr√≥prio servidor est√° dispon√≠vel para estudo e modifica√ß√£o em qualquer escala, o que √© altamente recomend√°vel. </p><br><p>  E quando Marcel nos escreve: "Pessoal, tenho uma boa experi√™ncia no desenvolvimento nativo de C / C ++ para o Node.js, e gosto do seu jogo, mas n√£o gosto de como ele funciona em tudo - vamos escrever um novo. tecnologia de lan√ßamento de m√°quina virtual para Node.js especificamente para Screeps? ‚Äù </p><br><p>  Como Marcel n√£o pediu dinheiro, n√£o poder√≠amos recusar.  Ap√≥s v√°rios meses de nossa coopera√ß√£o, a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><strong>isolated-vm</strong></a> nasceu.  E isso mudou absolutamente tudo. </p><br><p>  <code>isolated-vm</code> difere de <code>vm</code> por isolar n√£o o <em>contexto</em> , mas <em>isolar</em> em termos de <abbr title="Mecanismo JavaScript usado no Node.js">V8</abbr> .  Sem entrar em detalhes, isso significa que √© criada uma inst√¢ncia separada completa da m√°quina JavaScript, que possui n√£o apenas seu pr√≥prio contexto global, mas tamb√©m sua pr√≥pria mem√≥ria heap, coletor de lixo e funciona como parte de um loop de eventos separado.  Das desvantagens: para cada m√°quina em execu√ß√£o, √© necess√°ria uma pequena sobrecarga de RAM (cerca de 20 MB) e tamb√©m √© imposs√≠vel transferir objetos ou chamar fun√ß√µes diretamente para a m√°quina, toda a troca deve ser serializada.  Isso acaba com os contras, o resto - √© apenas uma panac√©ia! </p><br><p><img src="https://habrastorage.org/webt/gh/cz/5v/ghcz5vxih2oaferse6kgv-zruvq.png"></p><br><p>  Agora √© realmente poss√≠vel executar o script de cada jogador em seu pr√≥prio espa√ßo completamente isolado.  O jogador tem seus pr√≥prios 500 MB de quadril; se terminar, significa que √© o seu pr√≥prio quadril que terminou, e n√£o o quadril de todo o processo.  Se voc√™ gerou lixo - ent√£o esse √© seu pr√≥prio lixo, voc√™ precisa colet√°-lo.  As promessas de oscila√ß√£o ser√£o executadas somente quando o seu isolamento durar na pr√≥xima vez e n√£o antes.  Bem e seguran√ßa - sob nenhuma circunst√¢ncia √© poss√≠vel acessar em algum lugar fora do isolado, apenas se voc√™ encontrar alguma vulnerabilidade no n√≠vel V8. </p><br><p>  Mas e o balanceamento?  Outra vantagem do isolated-vm √© que ele inicia as m√°quinas do mesmo processo, mas em threads separados (a experi√™ncia de Marcel com fibras de n√≥ foi √∫til aqui).  Se tivermos uma m√°quina com 4 n√∫cleos, podemos criar um pool de 4 threads e iniciar 4 m√°quinas paralelas ao mesmo tempo.  Ao mesmo tempo, estando no mesmo processo, o que significa ter uma mem√≥ria comum, podemos transferir qualquer jogador de um segmento para outro dentro desse pool.  Embora cada player permane√ßa vinculado a um processo espec√≠fico em uma m√°quina espec√≠fica (para n√£o perder o contexto global), o equil√≠brio entre quatro threads √© suficiente para resolver os problemas de distribui√ß√£o de players "pesados" e "leves" entre os n√≥s, para que todos os processadores terminem. trabalhar ao mesmo tempo e no hor√°rio. </p><br><p>  Ap√≥s executar esta fun√ß√£o no modo experimental, recebemos uma enorme quantidade de feedback positivo de jogadores cujos scripts come√ßaram a funcionar muito melhor, mais est√°vel e mais previs√≠vel.  E agora esse √© o nosso mecanismo padr√£o, embora os jogadores ainda possam escolher o tempo de execu√ß√£o herdado apenas para compatibilidade com os scripts antigos (alguns jogadores conscientemente se concentraram nas especificidades do ambiente compartilhado no jogo). </p><br><p>  Obviamente, ainda h√° espa√ßo para otimiza√ß√£o adicional, e tamb√©m existem outras √°reas interessantes do projeto nas quais resolvemos v√°rios problemas t√©cnicos.  Mas mais sobre isso em outra hora. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt437836/">https://habr.com/ru/post/pt437836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt437826/index.html">Como migramos o banco de dados do Redis e do Riak KV para o PostgreSQL. Parte 1: o processo</a></li>
<li><a href="../pt437828/index.html">Abra o webinar "SELECT ordem de execu√ß√£o da consulta e plano de consulta no MS SQL Server"</a></li>
<li><a href="../pt437830/index.html">Programa√ß√£o confi√°vel por idioma - revis√£o noob. Parte 1</a></li>
<li><a href="../pt437832/index.html">C√≥digo aberto: humor de c√≥digo, truques de c√≥digo, c√≥digo N√ÉO</a></li>
<li><a href="../pt437834/index.html">Duas hist√≥rias sobre como os eventos de programa√ß√£o ocorreram em Ecaterimburgo</a></li>
<li><a href="../pt437838/index.html">As tecnologias de aprendizado de m√°quina aceleram o processo de adapta√ß√£o dos pacientes √†s pr√≥teses bi√¥nicas</a></li>
<li><a href="../pt437842/index.html">A hist√≥ria secreta de Donkey Kong: das m√°quinas de arcade ao NES</a></li>
<li><a href="../pt437844/index.html">O conflito permanente de digita√ß√£o est√°tica versus din√¢mica - o TypeScript n√£o ajuda</a></li>
<li><a href="../pt437846/index.html">bobaoskit - acess√≥rios, dnssd e WebSocket</a></li>
<li><a href="../pt437848/index.html">Tornamos o processo de desenvolvimento de software pesado para microcontroladores mais conveniente (n√£o)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>