<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍀 👨🏽‍🔬 🌊 Ikhtisar IPSec di Mikrotik 🎈 👨🏼‍🎨 💲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IPSec (IP Security) - satu set protokol dan algoritma untuk mengenkripsi data dalam jaringan IPv4 dan IPv6. Kedengarannya tidak rumit, tetapi IPSec ti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ikhtisar IPSec di Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438176/"><p>  IPSec (IP Security) - satu set protokol dan algoritma untuk mengenkripsi data dalam jaringan IPv4 dan IPv6.  Kedengarannya tidak rumit, tetapi IPSec tidak menetapkan aturan yang jelas untuk mengenkripsi lalu lintas; sebaliknya, pengembang mengimplementasikan seperangkat alat (protokol dan algoritme), yang dengannya administrator membuat saluran aman untuk data. </p><br><p>  Saya ingin menyentuh IPSec di RouterOS sedikit lebih dalam daripada HOWTO sederhana, dengan teori dan contoh minimal tentang cara mengkonfigurasi dan men-debug IPSec.  Ini bukan panduan, dan tanpa latihan di bangku tes, tidak disarankan untuk memulai pengaturan terowongan dan server VPN nyata. </p><a name="habracut"></a><br><h3 id="preimuschestva-i-nedostatki-ipsec">  Keuntungan dan kerugian IPSec </h3><br><p>  Kekuatan: </p><br><ul><li>  Bekerja pada level jaringan model OSI </li><li>  Itu dapat mengenkripsi paket sumber sepenuhnya atau dari lapisan transport dan lebih tinggi </li><li>  Ada mekanisme untuk mengatasi NAT </li><li>  Berbagai macam enkripsi dan algoritma hashing traffic dapat dipilih </li><li>  IPSec - Satu Set Standar Terbuka, Dapat Diperpanjang </li><li>  Dalam kasus Mikrotik, itu tidak memerlukan pembelian biaya tambahan atau lisensi </li></ul><br><p>  Kelemahan: </p><br><ul><li>  Kesulitan </li><li>  Berbagai terminologi dan alat konfigurasi untuk vendor yang berbeda </li><li>  Menggunakan algoritma enkripsi yang kuat membutuhkan daya komputasi yang baik. </li><li>  Mudah mendeteksi DPI </li></ul><br><h3 id="protokoly-v-sostave-ipsec">  Protokol dalam IPSec </h3><br><p><img src="https://habrastorage.org/webt/nd/k6/0m/ndk60mwkllka7jpnl2flzdqt8ce.png"></p><br><p>  Secara global, semua protokol yang akan Anda tangani selama konfigurasi dapat dibagi menjadi dua kelompok: protokol pertukaran kunci dan protokol perlindungan data. </p><br><p>  <strong>Protokol Pertukaran Kunci (IKE)</strong> <br>  Tugas utama adalah untuk mengotentikasi peserta dalam koneksi dan menyetujui parameter enkripsi dan kunci untuk melindungi informasi yang dikirimkan. </p><br><ul><li>  IKE (Internet Key Exchange) - didefinisikan pada tahun 1998.  Banyak fitur (misalnya, bridging NAT) ditambahkan kemudian sebagai add-on dan mungkin tidak diimplementasikan dengan berbagai vendor.  Dasar negosiasi utama adalah ISAKMP. </li><li>  IKEv2 (Internet Key Exchange versi 2) - revisi terbaru dari 2014.  Ini adalah pengembangan protokol IKE, di mana beberapa masalah diselesaikan, mekanisme perjanjian utama disederhanakan, dan ekstensi (NAT-T, Keepalives, Mode Config) menjadi bagian dari protokol. </li></ul><br><p>  Dalam praktiknya, sebagian besar koneksi IPSec diimplementasikan menggunakan IKE karena peralatan yang ketinggalan zaman atau keengganan administrator untuk mengubah sesuatu. </p><br><p>  <strong>Protokol Perlindungan Data (ESP, AH)</strong> <br>  Tugas utama adalah melindungi data pengguna. </p><br><ul><li>  ESP (Encapsulating Payload Security) - mengenkripsi dan mengautentikasi sebagian data yang dikirimkan </li><li>  AH (Authentication Header) - mengotentikasi seluruh paket (kecuali untuk bidang yang bisa berubah-ubah), tidak mengenkripsi data, tetapi memungkinkan Anda untuk memastikan bahwa paket itu tidak berubah selama transmisi melalui jaringan </li></ul><br><h3 id="poryadok-ustanovki-ipsec-soedineniya">  Prosedur Instalasi Koneksi IPSec </h3><br><p><img src="https://habrastorage.org/webt/lu/rv/ps/lurvpsvrdub2tcgkmpx8ut5ep58.png"></p><br><p>  Peserta koneksi IPSec biasanya disebut rekan, yang menunjukkan kesetaraan mereka dalam koneksi yang ditetapkan.  Konfigurasi yang dekat dengan client-server dimungkinkan, tetapi ketika membangun terowongan IPSec permanen, salah satu rekan dapat menjadi inisialisasi. </p><br><ol><li>  Salah satu rekan memulai koneksi IPSec </li><li>  Ada pertukaran informasi kunci, otentikasi rekan, koordinasi parameter koneksi </li><li>  Berdasarkan informasi kunci yang diterima, terowongan terenkripsi tambahan dibentuk </li><li>  Menggunakan terowongan terenkripsi, rekan-rekan menentukan parameter enkripsi data dan bertukar informasi untuk menghasilkan kunci </li><li>  Hasil dari fase sebelumnya adalah seperangkat aturan dan kunci untuk perlindungan data (SA) </li><li>  Secara berkala mengintip pembaruan kunci enkripsi </li></ol><br><p>  Salah satu konsep kunci dalam IPSec adalah SA (Security Association) - satu set algoritma enkripsi untuk mengenkripsi dan mem-hashing informasi, serta kunci enkripsi, yang disetujui oleh rekan-rekan. </p><br><p>  Terkadang Anda dapat menemukan divisi ke: </p><br><ul><li>  ISAKMP SA - parameter dan kunci yang terkait dengan terowongan bantu </li><li>  Data SA (atau hanya SA) - parameter dan kunci yang terkait dengan enkripsi lalu lintas </li></ul><br><h3 id="poryadok-raboty-protokolov-soglasovaniya-klyuchey">  Protokol perjanjian utama </h3><br><p>  Protokol IKE dapat bekerja dalam dua mode: utama (utama) dan agresif (agresif), protokol IKEv2 berisi satu mode. </p><br><h4 id="ike-main">  IKE Main </h4><br><p><img src="https://habrastorage.org/webt/zw/jb/yv/zwjbyvrpmup5t7nfgaol329rudi.png"></p><br><p>  Fase pertama terdiri dari enam paket: <br>  1-2: Penyelarasan pengaturan enkripsi terowongan sekunder dan berbagai opsi IPSec <br>  3-4: Berbagi informasi untuk menghasilkan kunci rahasia <br>  5-6: Otentikasi Sebaya Menggunakan Saluran Terenkripsi Tambahan </p><br><p>  Fase kedua terdiri dari tiga paket: <br>  1-3: Menggunakan saluran tambahan terenkripsi.  Koordinasi parameter perlindungan lalu lintas, pertukaran informasi untuk menghasilkan kunci rahasia </p><br><h3 id="ike-aggressive">  IKE Agresif </h3><br><p><img src="https://habrastorage.org/webt/xu/wz/qu/xuwzqu4qle5lxlcvb-hnvuhqehg.png"></p><br><p>  Fase pertama terdiri dari tiga paket: <br>  1: Mengajukan penawaran untuk menginstal saluran terenkripsi tambahan dan informasi untuk menghasilkan kunci pribadi <br>  2: Menanggapi penawaran, informasi untuk menghasilkan kunci rahasia, data untuk otentikasi <br>  3: Data otentikasi </p><br><p>  Fase kedua terdiri dari tiga paket: <br>  1-3: Menggunakan saluran tambahan terenkripsi.  Koordinasi parameter perlindungan lalu lintas, pertukaran informasi untuk menghasilkan kunci rahasia </p><br><p>  Dalam mode agresif, inisiator hanya mengirim satu set parameter dalam kalimat.  Pertukaran informasi untuk otentikasi rekan terjadi sebelum pemasangan terowongan bantu yang aman.  Mode agresif lebih cepat konsisten, tetapi kurang aman. </p><br><h3 id="ikev2">  IKEv2 </h3><br><p><img src="https://habrastorage.org/webt/ev/mq/ni/evmqnimq5_sdeybuz63x3ddssbu.png"></p><br><p>  Di IKEv2, fase-fase tersebut dinamai: IKE_SA_INIT dan IKE_AUTH.  <em>Tetapi jika saya berbicara tentang Phase1 dan Phase2 nanti dalam teks, ini juga berlaku untuk fase IKEv2.</em> </p><br><p>  Setiap fase IKEv2 terdiri dari dua paket: <br>  IKE_SA_INIT: Koordinasi parameter enkripsi terowongan bantu, pertukaran informasi untuk menghasilkan kunci pribadi </p><br><p>  IKE_AUTH: menggunakan saluran tambahan terenkripsi.  Otentikasi teman sebaya, koordinasi parameter perlindungan lalu lintas, pertukaran informasi untuk menghasilkan kunci rahasia </p><br><h3 id="security-assotiations-database-sad">  Basis Data Perundingan Keamanan (SAD) </h3><br><p>  Hasil dari IKE (dan IKEv2) adalah Security Assotiations (SA), yang menentukan pengaturan perlindungan lalu lintas dan kunci enkripsi.  Setiap SA adalah searah dan koneksi IPSec berisi sepasang SA.  Semua SA disimpan dalam database SAD dan dapat diakses oleh administrator untuk melihat dan mengatur ulang. </p><br><h3 id="inkapsulyaciya-dannyh">  Enkapsulasi data </h3><br><p><img src="https://habrastorage.org/webt/3z/3k/aa/3z3kaaj2rwmnx59apvueigp3lno.png"></p><br><p>  IPSec menyediakan dua opsi untuk merangkum data: </p><br><ul><li>  Mode transportasi - hanya muatan paket yang dilindungi, meninggalkan header asli.  Untuk membangun terowongan, mode transportasi biasanya digunakan bersama dengan ipip atau gre, yang payload-nya sudah berisi seluruh paket sumber. </li><li>  Mode terowongan - mengenkapsulasi sepenuhnya paket asli dalam paket baru (mirip dengan gre atau ipip).  Tetapi untuk tunnel ipsec, antarmuka eksplisit tidak dibuat dalam sistem, ini bisa menjadi masalah jika routing statis dinamis atau kompleks digunakan. </li></ul><br><h3 id="security-policy-database-spd">  Database Kebijakan Keamanan (SPD) </h3><br><p>  Database aturan yang menentukan lalu lintas apa yang harus dienkripsi, protokol perlindungan data, tipe enkapsulasi, dan sejumlah parameter lainnya. <br>  Posisi pemeriksaan SPD dapat ditampilkan pada diagram Alur Paket. </p><br><p><img src="https://habrastorage.org/webt/nh/jo/rm/nhjorm-je866yymx0_cxwdnyop8.png"></p><br><h3 id="preodolenie-nat">  NAT menjembatani </h3><br><p>  IPSec menggunakan protokol lapisan jaringan untuk mentransfer data yang tidak dapat ditangani NAT.  Untuk mengatasi masalah tersebut, protokol NAT-T digunakan (ekstensi dalam IKE dan bagian dari IKEv2).  Inti dari NAT-T adalah dalam enkapsulasi tambahan paket IPSec dalam paket UDP yang diproses oleh NAT. </p><br><h3 id="ipsec-v-mikrotik">  IPSec di Mikrotik </h3><br><p>  IPSec tersedia secara gratis di perangkat apa pun yang menjalankan RouterOS dengan paket Keamanan terinstal. </p><br><h3 id="apparatnoe-shifrovanie">  Enkripsi perangkat keras </h3><br><p>  Untuk melepas CPU, akselerasi perangkat keras enkripsi ditambahkan ke beberapa model router MikroTik, daftar lengkap dapat ditemukan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di wiki</a> . <br>  Opsi anggaran terbanyak: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">RB750Gr3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">RB3011</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">HAP AC ^ 2</a> . </p><br><p>  Saya sendiri saya memeriksa kecepatan IPSec antara dua RB1100AHx2 dan antara dua RB750Gr3. </p><br><p>  Untuk mencapai hasil maksimum pada RB1100AHx2 Anda harus: </p><br><ul><li>  Gunakan port 11 yang terhubung langsung ke CPU dan konfigurasikan satu inti CPU untuk menangani 11 lalu lintas port </li><li>  Gunakan antrian perangkat keras saja pada antarmuka, nonaktifkan RPS </li><li>  Aktifkan FastPath Layer3 (sekitar 800mb / detik), atau mengecualikan lalu lintas IPSec dari conntrack (sekitar 700mb / detik) <br>  Tanpa manipulasi yang dijelaskan pada port paling lambat (eter13), dimungkinkan untuk mendapatkan ~ 170Mb / detik, pada ~ ~ 400Mb / detik yang biasa. </li></ul><br><p>  Pada RB750Gr3 tanpa optimisasi sekitar 200Mb / detik. </p><br><p>  Router single-core Qualcomm menunjukkan hasil 10-40mb / detik tergantung pada model, optimisasi, dan beban kerja dari proses lain. </p><br><p>  Saya sarankan Anda membiasakan diri dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">presentasi</a> dari karyawan mikrotik, mereka menyentuh topik pengaturan mengoptimalkan untuk mengurangi beban pada CPU dan meningkatkan kecepatan, yang saya tidak tambahkan ke teks. </p><br><h3 id="razlichiya-642x-i-643x">  Perbedaan 6.42.X dan 6.43.X </h3><br><p>  Tergantung pada versi RouterOS yang Anda gunakan, menu konfigurasi IPSec akan bervariasi. </p><br><p><img src="https://habrastorage.org/webt/6q/pz/5c/6qpz5cgthate04bihl8gq2zr9t8.png"></p><br><p><img src="https://habrastorage.org/webt/ng/ug/hi/ngughirhx6nwd1v8mjaa9omfb7g.png"></p><br><p><img src="https://habrastorage.org/webt/kv/ow/3-/kvow3-bmivzfr_tf6bqnywr5wu8.png"></p><br><p>  Sudah ada perubahan baru dalam versi pengujian, jadi baca Catatan Rilis sebelum memutakhirkan. </p><br><p><img src="https://habrastorage.org/webt/ri/rd/gu/rirdgucrebbf1ucxjqbj65gzf-s.png"></p><br><h3 id="konfiguraciya-ipsec">  Konfigurasi IPsec </h3><br><p><img src="https://habrastorage.org/webt/r6/lf/j5/r6lfj5hlclkbx9qmph0owsqf_ak.png"><br>  Menu [IP] -&gt; [IPSec] tidak seseram yang terlihat pada pandangan pertama.  Diagram menunjukkan bahwa item konfigurasi utama adalah: Peer dan Profil. <br>  Tab Remote Peers dan Installed SAs bersifat informatif. </p><br><h4 id="peers-i-peers-profiles">  Profil Sebaya dan Sebaya </h4><br><p>  Konfigurasi peer IPSec untuk membuat koneksi IKE dan membuat terowongan aman tambahan. </p><br><p><img src="https://habrastorage.org/webt/e2/kj/e1/e2kje1zwzhubqsyriypavj3bmfm.png" alt="gambar"></p><br><p>  <strong>Konfigurasikan IPSec Remote Peers</strong> </p><br><p><img src="https://habrastorage.org/webt/pq/9d/cv/pq9dcvyqrf64pdklohgf1eapoze.png"></p><br><div class="spoiler">  <b class="spoiler_title">Catatan</b> <div class="spoiler_text"><ul><li>  Dimulai dengan 6.43, RouterOS bersumpah saat menggunakan PSK tanpa otentikasi tambahan.  Jika Anda tidak ingin mengkonfigurasi kunci, sertifikat, atau xAuth tambahan, Anda dapat beralih ke IKEv2 atau mengabaikan peringatan. </li><li>  Sebagai rekan, Anda dapat menentukan IP atau subnet tertentu (relevan untuk VPN Client-Server) </li><li>  Jika ada aturan yang bertentangan, aturan dengan subnet yang lebih akurat akan digunakan untuk terhubung ke peer (mirip dengan rute) </li><li>  Otentikasi kunci XAuth dan rsa tidak berfungsi di IKEv2 </li><li>  Untuk IKEv2, Mikrotik membuat implementasi xAuth tidak kompatibel dengan platform lain </li><li>  Mode pasif biasanya digunakan untuk membuat konfigurasi VPN Client-Server (konfigurasi L2TP / IPsec atau IKEv2), tetapi dapat berguna saat menghubungkan sejumlah besar terowongan Site-to-Site ke satu titik, untuk mengurangi lalu lintas palsu. </li><li>  Jika Anda berencana untuk menggunakan xAuth, maka "server" harus pasif.  Pengguna untuk server dibuat di [IPSec] -&gt; [Pengguna] </li><li>  Saat menggunakan kebijakan Hasilkan, pilih mode port-ketat </li></ul></div></div><br><p>  <strong>Menyiapkan profil (Proposal) untuk harmonisasi Fase 1</strong> </p><br><p><img src="https://habrastorage.org/webt/w8/s9/vj/w8s9vjxiguir63a_hfpci1ih1bi.png" alt="gambar"></p><br><p><img src="https://habrastorage.org/webt/_v/x3/ff/_vx3ff1ogwsxjggebdjqazfqhve.png"></p><br><div class="spoiler">  <b class="spoiler_title">Catatan</b> <div class="spoiler_text"><ul><li>  Opsi tambahan untuk IKE menjadi bagian dari IKEv2, pengaturan diabaikan </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Korelasi grup DH dengan jumlah mereka</a> (nomor grup digunakan oleh vendor lain) </li><li>  Saat mengirim Proposal, sistem mengurutkan algoritme pasangan + grup dh dari lebih persisten ke kurang persisten <br><img src="https://habrastorage.org/webt/7i/h8/fj/7ih8fjegurxodmq-daxuwxfhpii.png"></li></ul></div></div><br><h4 id="policies-i-policy-proposals">  Kebijakan dan Proposal Kebijakan </h4><br><p>  Politisi memeriksa paket yang lewat untuk kepatuhan dengan kondisi dan menerapkan tindakan yang ditentukan.  Jika Anda kembali ke aliran Paket, maka blok dengan Kebijakan IPSec adalah rekonsiliasi dengan kebijakan.  Tindakan menentukan: protokol keamanan IPSec (ESP atau AH), proposal untuk negosiasi SA, mode enkapsulasi. <br><img src="https://habrastorage.org/webt/tp/bk/1n/tpbk1nrkowlvaqdnrfvgpvbaxg0.png" alt="gambar"></p><br><p>  Paket melewati kebijakan satu per satu hingga cocok dengan kondisi salah satunya. </p><br><p>  <strong>Pengaturan Kebijakan</strong> <br><img src="https://habrastorage.org/webt/yw/cp/nj/ywcpnjdyjonrxpnfel79irfov4g.png"></p><br><div class="spoiler">  <b class="spoiler_title">Anotasi</b> <div class="spoiler_text"><ul><li>  Biasanya tidak diperlukan Src spesifik.  dan Dst.  Port, tetapi secara umum, kemampuan untuk mengenkripsi lalu lintas aplikasi individual menarik </li><li>  Tidak semua protokol ip disajikan dalam daftar Protokol (misalnya, tidak ada gre), Anda dapat menentukan jumlah protokol yang diperlukan secara manual. </li><li>  Template bukan politisi!  Mereka digunakan jika menghasilkan-kebijakan diatur dalam konfigurasi rekan. </li><li>  Apa yang harus dilakukan jika SA spesifik untuk suatu kebijakan tidak ditemukan.  Sebelumnya, ada masalah dengan L2TP / IPSec ketika beberapa klien tidak dapat terhubung karena NAT yang sama (ketika menggunakan IKE), bug ini diselesaikan (dengan asumsi bahwa klien ini bukan windows) jika Anda mengatur level = unik.  Kalau tidak, beralihlah ke IKEv2 </li><li>  Saat mengatur kebijakan, gunakan [Safe mode], satu gerakan canggung dan Anda berisiko kehilangan akses ke router menggunakan Level3 </li></ul></div></div><br><p>  <strong>Menyiapkan Proposal untuk persetujuan SA</strong> <br><img src="https://habrastorage.org/webt/mh/yf/cd/mhyfcd2-2nsxbouuxhgbecj3kyu.png"></p><br><p><img src="https://habrastorage.org/webt/0n/xk/tw/0nxktwxmxyu2quyanfw-rco-yqa.png"></p><br><h4 id="groups">  Grup </h4><br><p>  Digunakan untuk mengaitkan templat kebijakan dan rekan kerja. </p><br><p><img src="https://habrastorage.org/webt/do/r7/gc/dor7gc6s4zuwlo2mmz5irrc3alm.png" alt="gambar"></p><br><p>  Di salah satu versi RouterOS yang lebih lama, ada bug dengan grup default yang tidak berfungsi. </p><br><h4 id="mode-config">  Konfigurasi mode </h4><br><p>  Mengirim dan menerima parameter IP tanpa menggunakan protokol tambahan.  Memungkinkan Anda membuat IPSec yang hanya terdiri dari Klien-ke-Server VPN. </p><br><p><img src="https://habrastorage.org/webt/sr/s2/dl/srs2dl4tcpixxiwi2mrletlguva.png"></p><br><p><img src="https://habrastorage.org/webt/os/r2/gg/osr2ggrnm_0-vqtoukxb5hnzfjs.png"></p><br><h4 id="keys-i-users">  Kunci dan Pengguna </h4><br><p>  Digunakan untuk otentikasi rekan canggih. <br>  <strong>Kunci</strong> <br>  Kunci RSA: pembangkitan, impor, ekspor.  Tidak didukung di IKEv2. </p><br><p><img src="https://habrastorage.org/webt/ec/7z/j4/ec7zj4doiqkdgwe4soh7lrk21f8.png"></p><br><p>  <strong>Pengguna</strong> <br>  Basis data pengguna XAuth untuk "server".  Klien menentukan pengaturan xAuth dalam konfigurasi rekan.  Dimungkinkan untuk meneruskan otentikasi xAuth ke server RADIUS. </p><br><p><img src="https://habrastorage.org/webt/pi/wl/vq/piwlvq80v1cnndmhyjg91jzrqle.png"></p><br><h4 id="remote-peers">  Rekan jarak jauh </h4><br><p>  Daftar semua rekan yang memasang dan memasang terowongan bantu (Fase 1).  Anda dapat menghapus rekan-rekan untuk memperbarui kunci terowongan bantu. </p><br><p><img src="https://habrastorage.org/webt/j2/-g/ct/j2-gct_8wrf7bl2zgtzqsswwbgk.png" alt="gambar"></p><br><p><img src="https://habrastorage.org/webt/2k/37/3m/2k373mg8qxox4y-ruph-jza_d0m.png" alt="gambar"></p><br><h4 id="installed-sas">  SA Terpasang </h4><br><p>  Database SAD atau daftar semua SA yang dinegosiasikan.  Anda dapat melihat algoritma dan kunci perlindungan data yang digunakan. </p><br><p><img src="https://habrastorage.org/webt/jw/jb/su/jwjbsuorsms85vw656xfgvcneuc.png" alt="gambar"></p><br><p><img src="https://habrastorage.org/webt/wd/8x/gr/wd8xgrc-h0ngxcfq77qun4ymuhk.png" alt="gambar"></p><br><p>  Bendera Hardware AEAD menunjukkan penggunaan enkripsi perangkat keras. </p><br><p><img src="https://habrastorage.org/webt/jz/5-/yv/jz5-yv-xaw_a8gx5zrxz1hlesye.png" alt="gambar"></p><br><p>  Administrator dapat mengatur ulang SA, tetapi hanya semua dari jenis yang sama (esp atau ah) pada saat yang sama. </p><br><h4 id="ipsec-i-firewall">  IPSec dan Firewall </h4><br><p>  Di Firewall, Anda dapat memeriksa apakah lalu lintas masuk atau keluar kebijakan IPSec atau tidak.  Aplikasi yang jelas adalah L2TP / IPSec, Anda dapat melarang pemasangan koneksi L2TP jika lalu lintas belum dienkripsi sebelumnya. </p><br><p><img src="https://habrastorage.org/webt/xt/06/sw/xt06swif3vlsv_vjcyywb1lepf0.png"></p><br><p>  <strong>Protokol dan port yang digunakan dalam IPSec</strong> </p><br><ul><li>  IKE - UDP: 500 </li><li>  IKEv2 - UDP: 4500 </li><li>  NAT-T - UDP: 4500 </li><li>  ESP - ipsec-esp (50) </li><li>  AH - ipsec-ah (51) </li></ul><br><h3 id="ipsec-i-endpoinds">  IPSec dan Endpoinds </h3><br><p>  Dan sekarang tentang sakitnya ... <br>  Mikrotik wiki memiliki tabel dengan hashing dan algoritma enkripsi untuk: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Windows</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">iOS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">OS-X</a> . </p><br><p>  Saya tidak menemukan informasi tentang klien vpn android bawaan, tetapi secara umum ini berfungsi dengan proposal dari windows.  Tidak ada dukungan IKEv2 di Android, Anda harus menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">StrongSwan</a> . </p><br><h3 id="primery-konfiguracii">  Contoh konfigurasi </h3><br><p>  Skema dan konfigurasi dasar untuk contoh dengan terowongan Site-to-Site: </p><br><p><img src="https://habrastorage.org/webt/bn/a7/xu/bna7xud0pazv4ipia2k0083wqom.png"></p><br><pre><code class="plaintext hljs">#Mikrotik1 /ip address add address=10.10.10.10/24 interface=ether1 network=10.10.10.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.10.10.1 dst-address=0.0.0.0/0 #Mikrotik2 /ip address add address=10.20.20.20/24 interface=ether1 network=10.20.20.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.20.20.1 dst-address=0.0.0.0/0</code> </pre> <br><h4 id="ipsec-v-tunnelnom-rezhime">  IPSec dalam mode terowongan </h4><br><p><img src="https://habrastorage.org/webt/wy/cg/ad/wycgadjksxuyftckhoctoxciub4.png"></p><br><p>  Konfigurasi langkah demi langkah: </p><br><ol><li>  Buat Proposal untuk IKE Phase1 </li><li>  Buat pesta.  Kami menunjukkan alamat, proposal, mode pertukaran, kunci PSK.  Saya memilih IKEv2, Anda dapat menggunakan utama / agresif seperti yang diinginkan </li><li>  Buat Proposal untuk SA </li><li>  Tentukan subnet di mana kita membuat terowongan </li><li>  Tentukan alamat SA, mode terowongan, dan proposal untuk enkripsi lalu lintas </li><li>  Mengedit Aturan NAT </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/c2/tg/at/c2tgatfqb3bgw5qer0u6lvi_jt0.png"></a> </p><br><p>  Opsi konsol: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=192.168.200.0/24 proposal=ipsec-tunnel-sa sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10 src-address=192.168.100.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/je/5y/gq/je5ygqbnhfjklyqxu8pg1kf2saq.png"></a> </p><br><p>  Opsi konsol: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=192.168.100.0/24 proposal=tets-ipsec-sa sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20 src-address=192.168.200.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Dan di sini NAT?</b> <div class="spoiler_text"><p>  Untuk bekerja dalam mode tunnel, Anda memerlukan rute palsu ke subnet jarak jauh, atau rute default, jika paket tidak akan melangkah lebih jauh dari keputusan Routing.  Biasanya tidak ada masalah dengan opsi pertama, tetapi dengan rute default dan Source NAT (yang pertama dan kedua hadir di sebagian besar router rumah dan kantor) akan ada masalah. </p><br><p>  Ingat Aliran Paket.  Paket melewati Sumber NAT lebih awal dari kebijakan IPSec, aturan dengan penyamaran tidak tahu apa-apa bahwa lalu lintas dimaksudkan untuk dikirim ke terowongan "sesaat" dan akan menyiarkan tajuk paket untuk dikirim ke IPSec ketika paket dengan tajuk yang diubah diperiksa di alamat sumber Kebijakan di header tidak akan sesuai dengan aturan dan paket akan terbang ke rute default, yang, setelah melihat alamat tujuan dari jaringan pribadi, kemungkinan besar akan menjatuhkannya. </p><br><p>  Ada beberapa solusi untuk masalah ini: </p><br><ul><li>  Menggunakan rute palsu </li><li>  Menggunakan aturan terima opsional sebelum SourceNAT </li><li>  Subjek src-nat hanya untuk paket-paket yang tidak ada kebijakan IPSec (dalam contoh) </li><li>  Kecualikan lalu lintas dari pelacakan koneksi menggunakan RAW </li></ul></div></div><br><p>  <strong>Verifikasi koneksi yang dibangun</strong> <br><img src="https://habrastorage.org/webt/no/xd/cn/noxdcnqrsbftj6mfsxlmpruizmq.png" alt="gambar"></p><br><ol><li>  Kami melihat tetangga di Remote Peers </li><li>  Kami melihat SA yang diinstal (penghitung lalu lintas tidak akan berubah sampai Anda memulainya) </li><li>  Dalam politik, status mapan dan bendera (A) ctive </li></ol><br><h4 id="ipipipsec">  IPIP / IPSec </h4><br><p><img src="https://habrastorage.org/webt/2b/hy/1d/2bhy1d1tnwd57iyppymvb8dbkww.png"></p><br><p>  Terowongan IPIP Preset: </p><br><pre> <code class="plaintext hljs">#Mikrotik1 #  ipip /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.20.20.20 # ip   ipip  /ip address add address=10.30.30.1/30 interface=ipip-vpn #     /ip route add distance=1 dst-address=192.168.200.0/24 gateway=10.30.30.2 #Mikrotik2 # ,      /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.10.10.10 /ip address add address=10.30.30.2/30 interface=ipip-vpn /ip route add distance=1 dst-address=192.168.100.0/24 gateway=10.30.30.1</code> </pre> <br><p>  Konfigurasi Langkah-demi-Langkah IPSec: </p><br><ol><li>  Buat Proposal untuk IKE Phase1 </li><li>  Buat pesta.  Tunjukkan alamat, proposal, mode pertukaran, kunci PSK </li><li>  Buat Proposal untuk SA </li><li>  Tentukan subnet di mana kita membuat terowongan </li><li>  Kami menentukan alamat SA, jenis lalu lintas yang akan kami enkripsi dan proposal </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/5e/mf/_w/5emf_wcxb3ulnjv3fykuino9stg.png"></a> </p><br><p>  Opsi konsol: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=10.20.20.20/32 proposal=ipsec-tunnel-sa protocol=ipencap src-address=10.10.10.10/32 sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/9o/dk/oy/9odkoy8krqem4mck9rkfibhm220.png"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=10.10.10.10/32 proposal=tets-ipsec-sa protocol=ipencap src-address=10.20.20.20/32 sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20</code> </pre> </div></div><br><p>  Untuk lalai, perbedaan nyata dalam konfigurasi terowongan dan mode transportasi dalam Kebijakan IPSec: <br><img src="https://habrastorage.org/webt/5v/ka/fg/5vkafg3ca8vilvv0s-lv1tdbxhw.png" alt="gambar"></p><br><p>  Pemeriksaan koneksi mirip dengan mode terowongan. </p><br><h4 id="l2tpipsec">  L2TP / IPSec </h4><br><p>  Contoh-contoh sebelumnya sangat cocok untuk membuat VPN permanen antara dua rekan, dengan alamat IP eksternal statis. </p><br><p>  Jika alamat salah satu rekan adalah dinamis (dan biasanya terletak di belakang NAT), Anda harus menggunakan VPN Client-to-Server lain. <br><img src="https://habrastorage.org/webt/ms/l5/3a/msl53ahdcdv8fl2vd-62m1exdmk.png" alt="gambar"></p><br><p>  Pra-konfigurasi L2TP: </p><br><pre> <code class="plaintext hljs">#     /ip pool add name=pool-l2tp ranges=192.168.77.10-192.168.77.20 #    /ppp profile add change-tcp-mss=yes local-address=192.168.77.1 name=l2tp-ipsec only-one=yes remote-address=pool-l2tp use-compression=no use-encryption=no use-mpls=no use-upnp=no #   /ppp secret add name=user1 password=test1 profile=l2tp-ipsec service=l2tp add name=user2 password=test2 profile=l2tp-ipsec service=l2tp add name=user3 password=test3 profile=l2tp-ipsec service=l2tp #  L2TP (  ipsec) /interface l2tp-server server set authentication=chap,mschap2 default-profile=l2tp-ipsec enabled=yes</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Mengapa saya mengabaikan penyetelan otomatis IPsec</b> <div class="spoiler_text"><p>  Dalam konfigurasi ipip, gre, eoip, l2tp ada konfigurasi otomatis koneksi ipsec, sebenarnya sistem menciptakan aturan dinamis untuk Peer dan Kebijakan untuk Anda, tetapi pertama-tama kami tidak mencari cara yang mudah, dan kedua, ketika memutakhirkan dari 6.42 ke 6.43, terowongan yang dibuat secara otomatis bangkrut dan bukan fakta bahwa ini tidak akan terjadi lagi. </p></div></div><br><p>  Konfigurasi Langkah-demi-Langkah IPSec: </p><br><ol><li>  Buat grup baru (Anda dapat menggunakan default) </li><li>  Buat Proposal untuk IKE Phase1 </li><li>  Kami membuat pesta, atau lebih tepatnya sebuah subnet.  Bersumpah pada kunci PSK, tetapi jika kita berurusan dengan windows sebagai klien, maka kita punya pilihan: Sertifikat atau PSK. </li><li>  Tetapkan pasif = ya dan kirim-init-kontak = tidak, di generate-policy = port-ketat (terima port dari klien) </li><li>  Buat Proposal untuk SA </li><li>  Buat templat untuk menghasilkan kebijakan </li><li>  Tentukan proposal untuk SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Konfigurasi mikrotik</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/ua/a8/ph/uaa8phm-3iy-qvrxuc6m4kbirr8.png" alt="gambar"></a> <br>  <em>Dalam tangkapan layar, kesalahannya adalah menentukan dst.</em>  <em>port dan src.</em>  <em>port tidak diperlukan</em> </p><br><p>  Opsi konsol: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec policy group add name=l2tp-ipsec #2 /ip ipsec peer profile add dh-group=modp1024 enc-algorithm=aes-256 hash-algorithm=sha256 name=l2tp-ipsec-ike #3-4 /ip ipsec peer add address=0.0.0.0/0 generate-policy=port-strict passive=yes policy-template-group=l2tp-ipsec profile=l2tp-ipsec-ike secret=secret-ipsec-pass send-initial-contact=no #5 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=l2tp-ipsec-sa pfs-group=none #6-7 /ip ipsec policy add dst-address=0.0.0.0/0 group=l2tp-ipsec proposal=l2tp-ipsec-sa protocol=udp src-address=0.0.0.0/0 template=yes</code> </pre> </div></div><br><p>  <strong>Konfigurasi firewall untuk membuat koneksi L2TP hanya setelah IPSec</strong> </p><br><pre> <code class="plaintext hljs">/ip firewall filter # IKE, NAT-T  ipsec-esp add chain=input protocol=17 dst-port=500,4500 action=accept add chain=input protocol=50 action=accept # L2TP,     ipsec    add chain=input protocol=17 dst-port=1701 ipsec-policy=in,ipsec action=accept add chain=input protocol=17 dst-port=1701 action-drop</code> </pre> <br><h4 id="ikev2-vpn">  IKEv2 VPN </h4><br><p>  Opsi L2TP populer, tetapi berkat konfigurasi mode, Anda dapat mengonfigurasi server VPN hanya menggunakan IPSec.  Ini adalah jenis VPN yang menjanjikan, tetapi sejauh ini jarang digunakan, jadi selain mengkonfigurasi sisi server, saya akan memberikan contoh pengaturan klien StrongSwan di android. </p><br><p><img src="https://habrastorage.org/webt/el/un/fu/elunfukm2k6qajijslvcfd-zvuy.png" alt="gambar"></p><br><p>  Tentu saja, tidak semuanya cerah.  Sebagian besar sistem operasi "pengguna" (khususnya Windows dan Android) setuju untuk bekerja dengan VPN semacam itu hanya jika mereka disahkan oleh sertifikat atau EAP. </p><br><p>  <em>Sertifikat adalah titik kelemahan saya, jika ada yang tahu cara membuat sertifikat yang ditandatangani sendiri dengan benar yang diimpor oleh Windows dan akan digunakan dalam koneksi, tulis di komentar.</em> </p><br><p>  Pembuatan sertifikat awal: </p><br><pre> <code class="plaintext hljs">#Root CA   /certificate add name=ca common-name="IKEv2 CA" days-valid=6928 /certificate sign ca ca-crl-host=&lt;IP &gt; #   vpn /certificate add common-name=&lt;IP &gt; subject-alt-name=IP:&lt;IP &gt; key-usage=tls-server name=vpn days-valid=6928 #   /certificate sign vpn ca=ca #   #       ,       #     Revoke   /certificate add common-name=client key-usage=tls-client name=client days-valid=6928 #   /certificate sign client ca=ca</code> </pre> <br><p>  Konfigurasi Selangkah demi Selangkah oleh IKEv2 VPN: </p><br><ol><li>  Kami membuat kumpulan alamat untuk distribusi ke pelanggan </li><li>  Buat profil konfigurasi mode untuk mendistribusikan parameter IP ke klien </li><li>  Buat grup untuk menautkan template Sebaya dan kebijakan </li><li>  Buat Proposal untuk IKE Phase1 </li><li>  Buat profil untuk menghubungkan teman-teman.  Otentikasi Sertifikat, Protokol IKEv2, Mode Pasif </li><li>  Tentukan profil konfigurasi mode, grup 3 langkah dan aktifkan pembuatan kebijakan </li><li>  Buat Proposal untuk SA </li><li>  Buat templat untuk menghasilkan kebijakan </li><li>  Tentukan Proposal untuk SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Konfigurasikan Mikrotik</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/1r/8w/vj/1r8wvjsgjjwhijje2dhwb90qv78.png" alt="gambar"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip pool add name=pool-ike ranges=192.168.77.10-192.168.77.20 #2 /ip ipsec mode-config add address-pool=pool-ike address-prefix-length=32 name=ikev2-vpn static-dns=77.88.8.8 system-dns=no #3 /ip ipsec policy group add name=ikev2-vpn #4 /ip ipsec peer profile add enc-algorithm=aes-256,aes-128 hash-algorithm=sha256 name=ikev2-vpn #5-6 /ip ipsec peer add address=0.0.0.0/0 auth-method=rsa-signature certificate=vpn exchange-mode=ike2 generate-policy=port-strict mode-config=ikev2-vpn passive=yes policy-template-group=ikev2-vpn profile=ikev2-vpn send-initial-contact=no #7 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=ikev2-vpn #8-9 /ip ipsec policy add dst-address=0.0.0.0/0 group=ikev2-vpn proposal=ikev2-vpn src-address= 0.0.0.0/0 template=yes</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Konfigurasi StrongSwan di android.</b> <div class="spoiler_text"><p>  <em>Pertama, Anda perlu mentransfer sertifikat klien dan ca ke telepon.</em> <br>  <a href="">https://habrastorage.org/webt/tp/pk/ad/tppkadaifd1k7xi6hf3jxgg7vcs.png</a> </p><br><p>  <em>Untuk mata besar: Salib dekat wi-fi berdiri karena</em>  <em>sebagian besar aplikasi sistem diblokir oleh AFWall +.</em> </p></div></div><br><p>  Jika koneksi berhasil, Anda akan melihat: kebijakan dinamis, menulis ke Peer jarak jauh, dan sepasang SA. </p><br><p><img src="https://habrastorage.org/webt/89/ov/4w/89ov4wsqvw7r-dvsoz2crontmlk.png" alt="gambar"></p><br><p><img src="https://habrastorage.org/webt/cc/b2/ic/ccb2icr_nqz32btmghwptrz7svc.png" alt="gambar"></p><br><p><img src="https://habrastorage.org/webt/sl/cn/gz/slcngz0e3objej8x3fw4-m3wypc.png" alt="gambar"></p><br><p>  <em>Lisensi demo routerOS x86 tidak memiliki batasan pada jumlah terowongan IPSec, termasuk IKEv2 VPN.</em>  <em>Anda dapat menggunakan demo RouterOS x86 (jangan bingung dengan RouterOS CHR gratis, semuanya menyedihkan) di VPS dan dapatkan server VPN pribadi dengan upaya administrasi minimal, tanpa membeli lisensi untuk RouterOS atau RouterOS CHR.</em> </p><br><h3 id="para-slov-pro-analiz-logov-ipsec">  Beberapa kata tentang analisis log IPSec </h3><br><p>  Log in Mikrotik adalah cerita yang terpisah, kadang-kadang mereka cukup rinci untuk menganalisis masalah, tetapi kurangnya fitur dangkal: bersih, salin, temukan kekuatan Anda untuk menginstal server syslog terpisah. </p><br><p>  Sedangkan untuk IPSec, berikut adalah opsi analisis log cepat (kami hanya meninggalkan yang diperlukan di tab terpisah): </p><br><p><img src="https://habrastorage.org/webt/05/rz/_g/05rz_grffjd7zz1r-a8zhsi87cy.png" alt="gambar"></p><br><pre> <code class="plaintext hljs">/system logging action add memory-lines=100000 name=ipsec target=memory /system logging add action=ipsec topics=ipsec,error add action=ipsec topics=ipsec,debug,!packet add action=ipsec topics=ipsec,info</code> </pre> <br><p>  Dan beberapa contoh masalah konfigurasi IPSec yang khas: </p><br><div class="spoiler">  <b class="spoiler_title">Proposal Masalah Konsistensi pada Phase1</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bp/jm/y1/bpjmy12i4eieobnfhrnj3hlvpcq.png" alt="gambar"></p><br><ol><li>  Baca pesan kesalahan.  Masalahnya adalah ketika merekonsiliasi Proposal di tahap pertama. </li><li>  Kami melihat di atas, router itu sendiri menyarankan agar ia mengirim pesta, dan apa yang dikonfigurasi secara lokal </li></ol></div></div><br><div class="spoiler">  <b class="spoiler_title">Masalah masalah rekonsiliasi IKE_SA_INIT</b> <div class="spoiler_text"><p>  Dalam log Anda akan melihat sesuatu seperti berikut ini: </p><br><p><img src="https://habrastorage.org/webt/8i/d9/gh/8id9ghqgdgxsjjsfhn3zcn5_vtq.png"></p><br><p>  Menganalisis lalu lintas </p><br><p>  Dalam permintaan, Anda dapat melihat proposal dari jamuan makan: </p><br><p><img src="https://habrastorage.org/webt/pw/u2/ib/pwu2ibw3dyxswemrr74wcbphcoy.png"></p><br><p>  Dalam jawaban kita melihat bahwa tidak ada proposal yang cocok ditemukan: </p><br><p><img src="https://habrastorage.org/webt/q2/lb/qk/q2lbqkcr8qvtd1hgia4fj0hrb44.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Proposal masalah rekonsiliasi untuk SA</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/2y/yg/7m/2yyg7ma7ko4lce5vsyef4nmojdi.png"><br>  Router meminta tentang kesalahan proposal pada fase2 dan menunjukkan apa yang dikonfigurasikan secara lokal dan apa yang jauh. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Proposal Masalah rekonsiliasi IKE_AUTH</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bn/pk/vn/bnpkvnfazxyqmpbvdg78e26mfgy.png"><br>  Kami melihat bahwa ada koneksi dan otentikasi rekan, tetapi lebih lanjut kesalahan proposal.  Anda tidak akan melihat detail apa pun dalam debug, di wireshark (lalu lintas IKE_AUTH dienkripsi). </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Kesalahan Otentikasi PSK</b> <div class="spoiler_text"><p>  Untuk IKE: </p><br><p><img src="https://habrastorage.org/webt/cp/wm/b5/cpwmb55qp8qyjmba_xijboxmiwa.png"></p><br><p>  Untuk IKEv2: <br><img src="https://habrastorage.org/webt/ks/fn/k0/ksfnk0qdgmgizzusfsyrlwxvcfs.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Mode IKE salah</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/md/fb/ll/mdfbllmvedawn5ptdd-yvjcsrpw.png" alt="gambar"><br>  Kita melihat bahwa Phase1 rusak dalam batas waktu, meskipun paket berada di antara rekan-rekan.  Tetapi ukuran paket yang masuk jauh lebih besar, jika kita menganalisis melalui wireshark, kita akan melihat bahwa rekan jauh menggunakan mode agresif. </p><br><p><img src="https://habrastorage.org/webt/3g/ke/ii/3gkeiidaj8m-fs0ky7ucxqjxx6k.png"><br>  Kami melihat bahwa paket dikirim dari kami ke UDP: 500, dan mereka datang ke UDP: 4500 dan agak besar.  Di sini peer jarak jauh memiliki mode IKEv2. </p></div></div><br><p>  Terakhir, baca bagian <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pemecahan masalah dari wiki</a> .  Dan semua materi tentang IPSec diinginkan untuk berkenalan, saya hanya menjelaskan seperangkat alat dan pengaturan dasar. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id438176/">https://habr.com/ru/post/id438176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id438166/index.html">Interaksi antara situs di browser dan program yang berjalan secara lokal</a></li>
<li><a href="../id438168/index.html">Bagaimana memecahkan kamera yang mahal sehingga istrimu tidak membunuhmu</a></li>
<li><a href="../id438170/index.html">Hadiah dinamai menurut Ilya Segalovich. Kisah tentang Ilmu Komputer dan Peluncuran Publikasi</a></li>
<li><a href="../id438172/index.html">Apple tidak dapat memindahkan produksi perangkatnya ke AS</a></li>
<li><a href="../id438174/index.html">Kuning - Vakum - Cloud</a></li>
<li><a href="../id438178/index.html">Membuat aplikasi ARCore pertama Anda</a></li>
<li><a href="../id438180/index.html">Daftarkan transaksi real estat secara online</a></li>
<li><a href="../id438182/index.html">Studi ini menemukan manfaat pembajakan moderat bagi produsen dan distributor konten</a></li>
<li><a href="../id438188/index.html">Bill Gates dan reaktor natrium cepat</a></li>
<li><a href="../id438196/index.html">Jika proyeknya adalah "Teater", gunakan aktor ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>