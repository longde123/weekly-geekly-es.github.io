<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüî¨ üåî ‚ô®Ô∏è Apresentando o CLI Builder üêä üò§ ‚õÖÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, examinaremos a nova API da CLI angular, que permitir√° estender os recursos existentes da CLI e adicionar novos. Discutiremos como trabal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apresentando o CLI Builder</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450746/"><img src="https://habrastorage.org/webt/sm/xo/kb/smxokbjs_uhwjcb1rjv7cwt5k3m.png" alt="Apresentando o CLI Builder"><br><br>  Neste artigo, examinaremos a nova API da CLI angular, que permitir√° estender os recursos existentes da CLI e adicionar novos.  Discutiremos como trabalhar com essa API e quais pontos de sua extens√£o existem, o que permite adicionar novas funcionalidades √† CLI. <br><a name="habracut"></a><br><h2>  A hist√≥ria </h2><br>  H√° cerca de um ano, introduzimos o arquivo da √°rea de trabalho ( <i>angular.json</i> ) na CLI angular e repensamos muitos dos princ√≠pios b√°sicos para implementar seus comandos.  Chegamos ao fato de termos colocado as equipes nas ‚Äúcaixas‚Äù: <br><br><ol><li> <b>Comandos esquem√°ticos - "Comandos esquem√°ticos"</b> .  At√© agora, voc√™ provavelmente j√° ouviu falar sobre o Schematics, a biblioteca usada pela CLI para gerar e modificar seu c√≥digo.  Ele apareceu na vers√£o 5 e atualmente √© usado na maioria dos comandos relacionados ao seu c√≥digo, como <i>novo</i> , <i>gerar</i> , <i>adicionar</i> e <i>atualizar</i> . </li><li>  <b>Comandos diversos - "Outras equipes"</b> .  Estes s√£o comandos que n√£o est√£o diretamente relacionados ao seu projeto: <i>ajuda</i> , <i>vers√£o</i> , <i>configura√ß√£o</i> , <i>doc</i> .  Recentemente, a <i>an√°lise</i> tamb√©m apareceu, bem como nossos ovos de P√°scoa (Shhh! Nem uma palavra para ningu√©m!). </li><li>  <b>Comandos de tarefas - "Comandos de tarefas"</b> .  Essa categoria, em geral, "inicia processos executados no c√≥digo de outras pessoas".  - Por exemplo, <i>build</i> √© uma projeto, <i>lint</i> est√° depurando e <i>test</i> est√° testando. </li></ol><br>  Come√ßamos a projetar o <i>angular.json</i> h√° muito tempo.  Inicialmente, foi concebido como um substituto para a configura√ß√£o do Webpack.  Al√©m disso, deveria permitir que os desenvolvedores escolhessem independentemente a implementa√ß√£o da montagem do projeto.  Como resultado, obtivemos um sistema b√°sico de inicia√ß√£o de tarefas, que permaneceu simples e conveniente para nossos experimentos.  Chamamos essa API de "arquiteto". <br><br>  Apesar do fato de o Architect n√£o ser oficialmente suportado, ele era popular entre os desenvolvedores que desejavam personalizar a montagem de projetos, bem como entre as bibliotecas de terceiros que precisavam controlar seu fluxo de trabalho.  O Nx o usou para executar comandos do Bazel, a Ionic para executar testes de unidade no Jest, e os usu√°rios podem estender suas configura√ß√µes de Webpack usando ferramentas como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ngx-build-plus</a> .  E isso foi apenas o come√ßo. <br><br>  <b>Uma vers√£o oficialmente suportada, est√°vel e aprimorada dessa API √© usada na CLI Angular vers√£o 8.</b> <br><br><h2>  Conceito </h2><br>  A API do arquiteto oferece ferramentas para agendar e coordenar tarefas que a CLI Angular usa para implementar seus comandos.  Ele usa fun√ß√µes chamadas <br>  ‚ÄúConstrutores‚Äù - ‚Äúcolecionadores‚Äù que podem atuar como tarefas ou planejadores de outros colecionadores.  Al√©m disso, ele usa angular.json como um conjunto de instru√ß√µes para os pr√≥prios coletores. <br><br>  Este √© um sistema muito geral projetado para ser flex√≠vel e extens√≠vel.  Ele cont√©m uma API para relat√≥rios, registros e testes.  Se necess√°rio, o sistema pode ser expandido para novas tarefas. <br><br><h2>  Pickers </h2><br>  Montadores s√£o fun√ß√µes que implementam l√≥gica e comportamento para uma tarefa que pode substituir o comando da CLI.  - Por exemplo, inicie o linter. <br><br>  A fun√ß√£o do coletor usa dois argumentos: o valor de entrada (ou op√ß√µes) e o contexto que fornece o relacionamento entre a CLI e o pr√≥prio coletor.  A divis√£o de responsabilidade aqui √© a mesma que em Esquema - o usu√°rio da CLI define as op√ß√µes, a API √© respons√°vel pelo contexto e voc√™ (o desenvolvedor) define o comportamento necess√°rio.  O comportamento pode ser implementado de forma s√≠ncrona, ass√≠ncrona ou simplesmente exibir um determinado n√∫mero de valores.  A sa√≠da deve ser do tipo <i>BuilderOutput</i> , que cont√©m o <i>sucesso do</i> campo l√≥gico e o <i>erro</i> opcional do campo, que cont√©m a mensagem de erro. <br><br><h2>  Arquivo e tarefas da √°rea de trabalho </h2><br>  A API do Architect conta com <i>angular.json</i> , um arquivo da √°rea de trabalho para armazenar tarefas e suas configura√ß√µes. <br><br>  <i>angular.json</i> divide o espa√ßo de trabalho em projetos e eles, por sua vez, em tarefas.  Por exemplo, seu aplicativo criado com o comando <i>ng new</i> √© um desses projetos.  Uma das tarefas deste projeto ser√° a tarefa de <i>constru√ß√£o</i> , que pode ser iniciada usando o <i>comando ng build</i> .  Por padr√£o, esta tarefa possui tr√™s chaves: <br><br><ol><li>  <b>construtor</b> - o nome do coletor a ser usado para concluir a tarefa, no formato <i>PACKAGE_NAME: ASSEMBLY_NAME</i> . </li><li>  <b>op√ß√µes</b> - configura√ß√µes usadas ao iniciar uma tarefa por padr√£o. </li><li>  <b>configura√ß√µes</b> - configura√ß√µes que ser√£o aplicadas ao iniciar uma tarefa com a configura√ß√£o especificada. </li></ol><br>  As configura√ß√µes s√£o aplicadas da seguinte maneira: quando a tarefa √© iniciada, as configura√ß√µes s√£o obtidas do bloco de op√ß√µes e, se uma configura√ß√£o foi especificada, suas configura√ß√µes s√£o gravadas sobre as existentes.  Depois disso, se configura√ß√µes adicionais forem passadas para <i>scheduleTarget ()</i> - o bloco de <i>substitui√ß√µes</i> , elas ser√£o gravadas por √∫ltimo.  Ao usar a CLI Angular, os argumentos da linha de comando s√£o transmitidos para <i>substitui√ß√µes</i> .  Depois que todas as configura√ß√µes s√£o transferidas para o coletor, ele as verifica de acordo com seu esquema e, somente se as configura√ß√µes corresponderem a ele, o contexto ser√° criado e o coletor come√ßar√° a funcionar. <br><br>  Mais informa√ß√µes sobre o espa√ßo de trabalho <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h2>  Crie seu pr√≥prio colecionador </h2><br>  Como exemplo, vamos criar um coletor que executar√° um comando na linha de comando.  Para criar um coletor, use a f√°brica <i>createBuilder</i> e retorne o objeto <i>BuilderOutput</i> : <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { BuilderOutput, createBuilder } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular-devkit/architect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> createBuilder(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options, context</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;BuilderOutput&gt;(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { resolve({ <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); }); });</code> </pre> <br>  Agora, vamos adicionar um pouco de l√≥gica ao nosso coletor: queremos controlar o coletor atrav√©s das configura√ß√µes, criar novos processos, aguardar a conclus√£o do processo e, se o processo for conclu√≠do com √™xito (ou seja, c√≥digo de retorno 0), sinalize isso ao arquiteto: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { BuilderOutput, createBuilder } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular-devkit/architect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> childProcess <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'child_process'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> createBuilder(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options, context</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> child = childProcess.spawn(options.command, options.args); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;BuilderOutput&gt;(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { child.on(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, code =&gt; { resolve({ <span class="hljs-attr"><span class="hljs-attr">success</span></span>: code === <span class="hljs-number"><span class="hljs-number">0</span></span> }); }); }); });</code> </pre><br><h2>  Processamento de sa√≠da </h2><br>  Agora, o m√©todo de <i>gera√ß√£o</i> passa todos os dados para a sa√≠da padr√£o do processo.  Podemos querer transferi-los para o <i>logger</i> - logger.  Nesse caso, primeiro, a depura√ß√£o durante o teste ser√° facilitada e, segundo, o pr√≥prio Architect pode executar nosso coletor em um processo separado ou desativar a sa√≠da padr√£o de processos (por exemplo, no aplicativo Electron). <br><br>  Para fazer isso, podemos usar o <i>Logger</i> , dispon√≠vel no objeto de <i>contexto</i> , o que nos permitir√° redirecionar a sa√≠da do processo: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { BuilderOutput, createBuilder } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular-devkit/architect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> childProcess <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'child_process'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> createBuilder(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options, context</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> child = childProcess.spawn(options.command, options.args, { <span class="hljs-attr"><span class="hljs-attr">stdio</span></span>: <span class="hljs-string"><span class="hljs-string">'pipe'</span></span> }); child.stdout.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, (data) =&gt; { context.logger.info(data.toString()); }); child.stderr.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, (data) =&gt; { context.logger.error(data.toString()); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;BuilderOutput&gt;(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { child.on(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, code =&gt; { resolve({ <span class="hljs-attr"><span class="hljs-attr">success</span></span>: code === <span class="hljs-number"><span class="hljs-number">0</span></span> }); }); }); });</code> </pre><br><h2>  Relat√≥rios de desempenho e status </h2><br>  A parte final da API relacionada √† implementa√ß√£o de seu pr√≥prio coletor √© o progresso e os relat√≥rios de status atuais. <br><br>  No nosso caso, o comando √© conclu√≠do ou executado, portanto, n√£o faz sentido adicionar um relat√≥rio de progresso.  No entanto, podemos comunicar nosso status ao coletor pai, para que ele entenda o que est√° acontecendo. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { BuilderOutput, createBuilder } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular-devkit/architect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> childProcess <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'child_process'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> createBuilder(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options, context</span></span></span><span class="hljs-function">) =&gt;</span></span> { context.reportStatus(<span class="hljs-string"><span class="hljs-string">`Executing "</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${options.command}</span></span></span><span class="hljs-string">"...`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> child = childProcess.spawn(options.command, options.args, { <span class="hljs-attr"><span class="hljs-attr">stdio</span></span>: <span class="hljs-string"><span class="hljs-string">'pipe'</span></span> }); child.stdout.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, (data) =&gt; { context.logger.info(data.toString()); }); child.stderr.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, (data) =&gt; { context.logger.error(data.toString()); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>&lt;BuilderOutput&gt;(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { context.reportStatus(<span class="hljs-string"><span class="hljs-string">`Done.`</span></span>); child.on(<span class="hljs-string"><span class="hljs-string">'close'</span></span>, code =&gt; { resolve({ <span class="hljs-attr"><span class="hljs-attr">success</span></span>: code === <span class="hljs-number"><span class="hljs-number">0</span></span> }); }); }); });</code> </pre><br>  Para passar um relat√≥rio de <i>progresso</i> , use o m√©todo <i>reportProgress</i> com valores de resumo atuais e (opcionalmente) como argumentos.  <i>total</i> pode ser qualquer n√∫mero.  Por exemplo, se voc√™ souber quantos arquivos precisa processar, poder√° transferir o n√∫mero deles para o <i>total</i> , e para o <i>atual,</i> poder√° transferir o n√∫mero de arquivos j√° processados.  √â assim que <a href="">o coletor tslint</a> relata seu progresso. <br><br><h2>  Valida√ß√£o de entrada </h2><br>  O objeto de <i>op√ß√µes</i> passado para o coletor √© verificado usando o esquema JSON.  Isso √© semelhante ao esquema, se voc√™ souber o que √©. <br><br>  Em nosso exemplo de coletor, esperamos que nossos par√¢metros sejam um objeto que receba duas chaves: <i>command</i> - command (string) e <i>args</i> - argumentos (array de strings).  Nosso esquema de verifica√ß√£o ficar√° assim: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"$schema"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://json-schema.org/schema"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"object"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"command"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"args"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"items"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"string"</span></span> } } }</code> </pre><br>  Os esquemas s√£o ferramentas realmente poderosas que podem realizar um grande n√∫mero de verifica√ß√µes.  Para obter mais informa√ß√µes sobre esquemas JSON, consulte o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site oficial do esquema JSON</a> . <br><br><h2>  Crie um pacote de compila√ß√£o </h2><br>  H√° um arquivo-chave que precisamos criar para nosso pr√≥prio coletor, a fim de torn√°-lo compat√≠vel com a CLI Angular - <i>builders.json</i> , respons√°vel pela rela√ß√£o entre nossa implementa√ß√£o do coletor, seu nome e o esquema de verifica√ß√£o.  O arquivo em si √© assim: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"builders"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"command"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"implementation"</span></span>: <span class="hljs-string"><span class="hljs-string">"./command"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"schema"</span></span>: <span class="hljs-string"><span class="hljs-string">"./command/schema.json"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Runs any command line in the operating system."</span></span> } } }</code> </pre><br>  Em seguida, no arquivo <i>package.json</i> , adicionamos a chave <i>builders</i> , apontando para o arquivo <i>builders.json</i> : <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"@example/command-runner"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"Builder for Architect"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"builders"</span></span>: <span class="hljs-string"><span class="hljs-string">"builders.json"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"devDependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"@angular-devkit/architect"</span></span>: <span class="hljs-string"><span class="hljs-string">"^1.0.0"</span></span> } }</code> </pre><br>  Isso informar√° ao Architect onde procurar o arquivo de defini√ß√£o do coletor. <br><br>  Portanto, o nome do nosso coletor √© <i>"@ example / command-runner: command"</i> .  A primeira parte do nome, antes dos dois pontos (:), √© o nome do pacote, definido usando <i>package.json</i> .  A segunda parte √© o nome do coletor, definido usando o arquivo <i>builders.json</i> . <br><br><h2>  Testando seus pr√≥prios construtores </h2><br>  A maneira recomendada de testar montadores √© atrav√©s do teste de integra√ß√£o.  Isso ocorre porque a cria√ß√£o de um <i>contexto</i> n√£o <i>√©</i> f√°cil, portanto, voc√™ deve usar o agendador do Architect. <br><br>  Para simplificar os padr√µes, pensamos em uma maneira simples de criar uma inst√¢ncia do Architect: primeiro, voc√™ cria um <i>JsonSchemaRegistry</i> (para testar o esquema), depois <i>TestingArchitectHost</i> e, finalmente, uma inst√¢ncia do <i>Architect</i> .  Agora voc√™ pode compilar o <i>arquivo de</i> configura√ß√£o <i>builders.json</i> . <br><br>  Aqui est√° um exemplo de execu√ß√£o do coletor, que executa o <i>comando ls</i> e verifica se o comando foi conclu√≠do com √™xito.  Observe que usaremos a sa√≠da padr√£o dos processos no <i>logger</i> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Architect, ArchitectHost } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular-devkit/architect'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { TestingArchitectHost } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular-devkit/architect/testing'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { logging, schema } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@angular-devkit/core'</span></span>; describe(<span class="hljs-string"><span class="hljs-string">'Command Runner Builder'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> architect: Architect; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> architectHost: ArchitectHost; beforeEach(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> registry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> schema.CoreSchemaRegistry(); registry.addPostTransform(schema.transforms.addUndefinedDefaults); <span class="hljs-comment"><span class="hljs-comment">//  TestingArchitectHost ‚Äì    . //     ,   . architectHost = new TestingArchitectHost(__dirname, __dirname); architect = new Architect(architectHost, registry); //      NPM-, //    package.json  . await architectHost.addBuilderFromPackage('..'); }); //      Windows it('can run ls', async () =&gt; { //  ,     . const logger = new logging.Logger(''); const logs = []; logger.subscribe(ev =&gt; logs.push(ev.message)); // "run"    ,       . const run = await architect.scheduleBuilder('@example/command-runner:command', { command: 'ls', args: [__dirname], }, { logger }); // "result" ‚Äì    . //    "BuilderOutput". const output = await run.result; //  . Architect     //   ,    ,    . await run.stop(); //   . expect(output.success).toBe(true); // ,     . // `ls $__dirname`. expect(logs).toContain('index_spec.ts'); }); });</span></span></code> </pre><br>  Para executar o exemplo acima, voc√™ precisa do pacote <i>ts-node</i> .  Se voc√™ pretende usar o N√≥, renomeie <i>index_spec.ts</i> para <i>index_spec.js</i> . <br><br><h2>  Usando o coletor em um projeto </h2><br>  Vamos criar um angular.json simples que demonstre tudo o que aprendemos sobre montadores.  Supondo que empacotamos nosso coletor em <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">example</a> / command-runner</i> e, em seguida, criamos um novo aplicativo usando o <i>ng builder-test</i> , o arquivo <i>angular.json</i> pode ter a seguinte apar√™ncia (parte do conte√∫do foi removida por quest√µes de brevidade): <br><br><pre> <code class="json hljs">{ // ...   . <span class="hljs-attr"><span class="hljs-attr">"projects"</span></span>: { // ... <span class="hljs-attr"><span class="hljs-attr">"builder-test"</span></span>: { // ... <span class="hljs-attr"><span class="hljs-attr">"architect"</span></span>: { // ... <span class="hljs-attr"><span class="hljs-attr">"build"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"builder"</span></span>: <span class="hljs-string"><span class="hljs-string">"@angular-devkit/build-angular:browser"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"options"</span></span>: { // ...   <span class="hljs-attr"><span class="hljs-attr">"outputPath"</span></span>: <span class="hljs-string"><span class="hljs-string">"dist/builder-test"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/index.html"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/main.ts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"polyfills"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/polyfills.ts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tsConfig"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/tsconfig.app.json"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"configurations"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"production"</span></span>: { // ...   <span class="hljs-attr"><span class="hljs-attr">"optimization"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"aot"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"buildOptimizer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } } }</code> </pre><br>  Se decidimos adicionar uma nova tarefa para aplicar (por exemplo) o comando <i>touch</i> ao arquivo (atualiza a data de modifica√ß√£o do arquivo) usando nosso coletor, executar√≠amos o <i>npm install <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">example</a> / command-runner</i> e, em seguida, <i>far√≠amos</i> altera√ß√µes em <i>angular.json</i> : <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"projects"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"builder-test"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"architect"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"touch"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"builder"</span></span>: <span class="hljs-string"><span class="hljs-string">"@example/command-runner:command"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"options"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"command"</span></span>: <span class="hljs-string"><span class="hljs-string">"touch"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"args"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"src/main.ts"</span></span> ] } }, <span class="hljs-attr"><span class="hljs-attr">"build"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"builder"</span></span>: <span class="hljs-string"><span class="hljs-string">"@angular-devkit/build-angular:browser"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"options"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"outputPath"</span></span>: <span class="hljs-string"><span class="hljs-string">"dist/builder-test"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/index.html"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/main.ts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"polyfills"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/polyfills.ts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tsConfig"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/tsconfig.app.json"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"configurations"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"production"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"fileReplacements"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"replace"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/environments/environment.ts"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"with"</span></span>: <span class="hljs-string"><span class="hljs-string">"src/environments/environment.prod.ts"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"optimization"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"aot"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"buildOptimizer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } } } } } }</code> </pre><br>  A CLI Angular possui um comando de <i>execu√ß√£o</i> , que √© o principal comando para executar coletores.  Como primeiro argumento, ele usa uma sequ√™ncia do formato <i>PROJECT: TASK [: CONFIGURATION]</i> .  Para executar nossa tarefa, podemos usar o comando <i>ng run builder-test: touch</i> . <br><br>  Agora, podemos querer redefinir alguns argumentos.  Infelizmente, n√£o podemos redefinir matrizes a partir da linha de comando at√© o momento, no entanto, podemos alterar o pr√≥prio comando para demonstra√ß√£o: <i>ng execute o builder-test: touch --command = ls</i> .  - Isso produzir√° o <i>arquivo src / main.ts.</i> <br><br><h2>  Modo de exibi√ß√£o </h2><br>  Por padr√£o, sup√µe-se que os coletores ser√£o chamados uma vez e encerrados; no entanto, eles podem retornar <i>Observable</i> para implementar seu pr√≥prio modo de observa√ß√£o (como o coletor <i>Webpack</i> ).  O Architect <i>assinar√°</i> o <i>Observable</i> at√© que ele termine ou pare e possa assinar o coletor novamente se o coletor for chamado com os mesmos par√¢metros (embora n√£o seja garantido). <br><br><ol><li>  O coletor deve retornar um objeto <i>BuilderOutput</i> ap√≥s cada execu√ß√£o.  Ap√≥s a conclus√£o, ele pode entrar no modo de observa√ß√£o causado por um evento externo e, se reiniciar, precisar√° chamar a fun√ß√£o <i>context.reportRunning ()</i> para notificar o Architect de que o coletor est√° trabalhando novamente.  Isso proteger√° o coletor de impedi-lo pelo arquiteto em uma nova chamada. </li><li>  O pr√≥prio arquiteto cancela a assinatura de <i>Observable</i> quando o coletor para (usando run.stop (), por exemplo), usando a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">l√≥gica Teardown</a> - o algoritmo de destrui√ß√£o.  Isso permitir√° que voc√™ pare e limpe a montagem se esse processo j√° estiver em execu√ß√£o. </li></ol><br>  Resumindo o acima, se o seu coletor assistir a eventos externos, ele funcionar√° em tr√™s est√°gios: <br><br><ol><li>  <b>Cumprimento.</b>  Por exemplo, compila√ß√£o do Webpack.  Esta etapa termina quando o Webpack termina a constru√ß√£o e seu coletor envia o <i>BuilderOutput</i> ao <i>Observable</i> . </li><li>  <b>Observa√ß√£o.</b>  - Entre dois lan√ßamentos, eventos externos s√£o monitorados.  Por exemplo, o Webpack monitora o sistema de arquivos para quaisquer altera√ß√µes.  Esta etapa termina quando o Webpack retoma a constru√ß√£o e <i>context.reportRunning () √©</i> chamado.  Ap√≥s esta etapa, a etapa 1 come√ßa novamente. </li><li>  <b>Conclus√£o.</b>  - A tarefa est√° totalmente conclu√≠da (por exemplo, era esperado que o Webpack iniciasse um certo n√∫mero de vezes) ou o in√≠cio do coletor foi interrompido (usando <i>run.stop ()</i> ).  Nesse caso, o algoritmo de destrui√ß√£o <i>observ√°vel</i> √© executado e limpo. </li></ol><br><h2>  Conclus√£o </h2><br>  Aqui est√° um resumo do que aprendemos nesta publica√ß√£o: <br><br><ol><li>  Fornecemos uma nova API que permitir√° que os desenvolvedores alterem o comportamento dos comandos da CLI angular e adicionem novos usando assemblers que implementam a l√≥gica necess√°ria. </li><li>  Os coletores podem ser s√≠ncronos, ass√≠ncronos e responsivos a eventos externos.  Eles podem ser chamados v√°rias vezes, assim como por outros colecionadores. </li><li>  Os par√¢metros que o coletor recebe quando a tarefa √© iniciada s√£o lidos primeiro a partir do arquivo <i>angular.json</i> e, em seguida, s√£o substitu√≠dos pelos par√¢metros da configura√ß√£o, se houver, e substitu√≠dos pelos sinalizadores da linha de comando, se eles foram adicionados. </li><li>  A maneira recomendada de testar coletores √© atrav√©s de testes de integra√ß√£o, no entanto, voc√™ pode executar testes de unidade separadamente da l√≥gica do coletor. </li><li>  Se o coletor retornar um Observable, ele dever√° ser limpo depois de passar pelo algoritmo de destrui√ß√£o. </li></ol><br>  Num futuro pr√≥ximo, a frequ√™ncia de uso dessas APIs aumentar√°.  Por exemplo, a implementa√ß√£o do Bazel est√° fortemente associada a eles. <br><br>  J√° vimos como a comunidade cria novos coletores de CLI para uso, por exemplo, <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">brincadeiras</a></i> e <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ciprestes</a></i> para teste. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450746/">https://habr.com/ru/post/pt450746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450734/index.html">Fuzzing √© um passo importante no desenvolvimento seguro</a></li>
<li><a href="../pt450736/index.html">"Isolar a Internet √© muito mais f√°cil e mais barato do que fornecer bloqueio externo".</a></li>
<li><a href="../pt450738/index.html">Rob√¥s no data center: como a intelig√™ncia artificial pode ser √∫til?</a></li>
<li><a href="../pt450740/index.html">Base de l√¢mpada inteligente REDMOND - adicione √† casa inteligente</a></li>
<li><a href="../pt450744/index.html">Infraestrutura de bicicleta em Minsk para um expat em TI</a></li>
<li><a href="../pt450748/index.html">Certifica√ß√£o ISTQB. Parte 1: ser ou n√£o ser?</a></li>
<li><a href="../pt450752/index.html">‚ÄúEu tenho apenas um m√©todo de ensino: apenas trabalhe‚Äù - entrevista com Ryan Dahl (Node.js, Deno)</a></li>
<li><a href="../pt450754/index.html">Corridas de cadeiras de rodas: piloto russo vence campeonato CYBATHLON em T√≥quio</a></li>
<li><a href="../pt450756/index.html">Sobre incapacitantes militares</a></li>
<li><a href="../pt450758/index.html">gem factory_trace ajuda a limpar suas f√°bricas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>