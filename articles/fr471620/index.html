<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧜 📦 🚱 Stratégies de déploiement dans Kubernetes: roulement, recréation, bleu / vert, canari, sombre (test A / B) 🍖 🤽🏽 ◀️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque perev.: Ce document de revue de Weaveworks présente les stratégies de déploiement d'applications les plus populaires et parle de la possibili...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stratégies de déploiement dans Kubernetes: roulement, recréation, bleu / vert, canari, sombre (test A / B)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/471620/">  <i><b>Remarque</b></i>  <i><b>perev.:</b> Ce document de revue de Weaveworks présente les stratégies de déploiement d'applications les plus populaires et parle de la possibilité de mettre en œuvre les plus avancées d'entre elles à l'aide de l'opérateur Kubernetes Flagger.</i>  <i>Il est écrit dans un langage simple et contient des diagrammes visuels qui permettent aux ingénieurs, même novices, de comprendre le problème.</i> <br><br><img src="https://habrastorage.org/webt/fh/bq/eq/fhbqeq1e_cjmxhj_-d15uvfna-a.png"><br>  <i>Le diagramme est tiré d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un autre examen</a> des stratégies de déploiement effectuées chez Container Solutions.</i> <br><br>  Aujourd'hui, l'un des plus gros problèmes de développement d'applications natives cloud est le déploiement de déploiement.  Avec l'approche microservice, les développeurs travaillent déjà avec des applications entièrement modulaires et les conçoivent, permettant à différentes équipes d'écrire du code et d'apporter des modifications à l'application en même temps. <br><br>  Les déploiements plus courts et plus fréquents présentent les avantages suivants: <br><br><ul><li>  Le temps de mise sur le marché est réduit. </li><li>  Les nouvelles fonctionnalités atteignent les utilisateurs plus rapidement. </li><li>  Les commentaires des utilisateurs parviennent plus rapidement à l'équipe de développement.  Cela signifie que l'équipe peut compléter les fonctions et résoudre les problèmes plus rapidement. </li><li>  Le moral des développeurs augmente: il est plus intéressant de travailler avec un grand nombre de fonctions en développement. </li></ul><a name="habracut"></a><br>  Mais avec l'augmentation des fréquences de publication, les chances de nuire à la fiabilité des applications ou à l'expérience utilisateur augmentent également.  C'est pourquoi il est important pour les équipes opérationnelles et DevOps de créer des processus et de gérer les stratégies de déploiement de manière à minimiser les risques pour le produit et les utilisateurs.  (En savoir plus sur l'automatisation du pipeline CI / CD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .) <br><br>  Dans cet article, nous discuterons de diverses stratégies de déploiement chez Kubernetes, y compris des déploiements roulants et des méthodes plus avancées telles que les déploiements canaries et leurs variantes. <br><br><h2>  Stratégies de déploiement </h2><br>  Il existe plusieurs types de stratégies de déploiement que vous pouvez utiliser en fonction de votre objectif.  Par exemple, vous devrez peut-être apporter des modifications à un certain environnement pour des tests supplémentaires, ou à un sous-ensemble d'utilisateurs / clients, ou vous devrez peut-être effectuer des tests limités sur les utilisateurs avant de rendre certaines fonctions <i>accessibles au public</i> . <br><br><h3>  Rolling (déploiement progressif et «glissant») </h3><br>  Il s'agit d'une stratégie de déploiement standard dans Kubernetes.  Il remplace progressivement, un par un, les pods avec l'ancienne version de l'application par des pods avec la nouvelle version - sans temps d'arrêt du cluster. <br><br><img src="https://habrastorage.org/webt/zk/gb/4n/zkgb4n3ppub2pjxw5qobxhi3y6e.png"><br><br>  Kubernetes attend que les nouveaux pods soient prêts pour le travail (en les vérifiant avec des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tests de préparation</a> ) avant de commencer à réduire les anciens.  Si un problème se produit, une telle mise à jour continue peut être interrompue sans arrêter l'intégralité du cluster.  Dans le fichier YAML de type de déploiement, la nouvelle image remplace l'ancienne image: <br><br><pre><code class="plaintext hljs">apiVersion: apps/v1beta1 kind: Deployment metadata: name: awesomeapp spec: replicas: 3 template: metadata: labels: app: awesomeapp spec: containers: - name: awesomeapp image: imagerepo-user/awesomeapp:new ports: - containerPort: 8080</code> </pre> <br>  Les paramètres d'une mise à jour continue peuvent être spécifiés dans le fichier manifeste: <br><br><pre> <code class="plaintext hljs">spec: replicas: 3 strategy: type: RollingUpdate rollingUpdate: maxSurge: 25% maxUnavailable: 25% template: ...</code> </pre><br><h3>  Recréer (recréation) </h3><br>  Dans ce type de déploiement le plus simple, les anciens pods sont tués en même temps et remplacés par de nouveaux: <br><br><img src="https://habrastorage.org/webt/s8/cc/f4/s8ccf4olujogufddg0vav3jhens.png"><br><br>  Le manifeste correspondant ressemble à ceci: <br><br><pre> <code class="plaintext hljs">spec: replicas: 3 strategy: type: Recreate template: ...</code> </pre> <br><h3>  Bleu / vert (déploiement bleu-vert) </h3><br>  La stratégie de déploiement bleu-vert (parfois aussi appelée rouge / noir, c'est-à-dire rouge-noir) implique le déploiement simultané de l'ancienne (verte) et de la nouvelle (bleue) versions de l'application.  Après avoir placé les deux versions, les utilisateurs ordinaires ont accès à la version verte, tandis que la version bleue est disponible pour l'équipe QA pour automatiser les tests via un service distinct ou une redirection de port directe: <br><br><img src="https://habrastorage.org/webt/th/zp/ee/thzpeewsyc4kfooyoffzlq7wsbg.png"><br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1beta1 kind: Deployment metadata: name: awesomeapp-02 spec: template: metadata: labels: app: awesomeapp version: "02"</code> </pre> <br>  Une fois la version bleue (nouvelle) testée et sa version approuvée, le service y bascule et le vert (ancien) est minimisé: <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: Service metadata: name: awesomeapp spec: selector: app: awesomeapp version: "02" ...</code> </pre> <br><h3>  Canaries (déploiement canari) </h3><br>  Les rouleaux canaris ressemblent à du bleu-vert, mais sont mieux gérés et utilisent une approche <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">progressive</a> par étapes.  Ce type comprend plusieurs stratégies différentes, y compris les lancements «cachés» et les tests A / B. <br><br>  Cette stratégie est utilisée lorsqu'il est nécessaire de faire l'expérience de nouvelles fonctionnalités, en règle générale, dans le backend de l'application.  L'essence de l'approche est de créer deux serveurs presque identiques: l'un dessert presque tous les utilisateurs et l'autre, avec de nouvelles fonctionnalités, ne dessert qu'un petit sous-ensemble d'utilisateurs, après quoi leurs résultats sont comparés.  Si tout se passe bien, la nouvelle version se déploie progressivement sur l'ensemble de l'infrastructure. <br><br>  Bien que cette stratégie ne puisse être mise en œuvre qu'en utilisant les outils Kubernetes, en remplaçant les anciens pods par de nouveaux, il est beaucoup plus pratique et plus facile d'utiliser un maillage de service comme Istio. <br><br>  Par exemple, vous pouvez avoir deux manifestes différents dans Git: le régulier avec la balise 0.1.0 et le canari avec la balise 0.2.0.  En modifiant les poids dans le manifeste de la passerelle virtuelle Istio, vous pouvez contrôler la répartition du trafic entre ces deux déploiements: <br><br><img src="https://habrastorage.org/webt/gi/sc/0j/gisc0jek9mx_ayulquedmg_fapi.png"><br><br>  Pour une procédure pas à pas sur l'implémentation de déploiements canaries avec Istio, consultez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitOps Workflows with Istio</a> .  <i>( <b>Remarque</b> : nous avons également traduit ici du matériel sur les rouleaux de canaris à Istio.)</i> <br><br><h4>  Déploiements des Canaries avec Weaveworks Flagger </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Weaveworks Flagger</a> permet de gérer facilement et efficacement les déploiements des canaris. <br><br>  Flagger automatise le travail avec eux.  Il utilise Istio ou AWS App Mesh pour acheminer et commuter le trafic, ainsi que les métriques Prometheus pour analyser les résultats.  De plus, l'analyse des déploiements canaris peut être complétée par des webhooks pour les tests d'acceptation, les tests de stress et tout autre type de contrôles. <br><br>  Sur la base du déploiement de Kubernetes et, si nécessaire, de la mise à l'échelle horizontale des pods (HPA), Flagger crée des ensembles d'objets (déploiements Kubernetes, services ClusterIP et services virtuels Istio ou App Mesh) pour l'analyse et la mise en œuvre des déploiements canaries: <br><br><img src="https://habrastorage.org/webt/-u/vo/wj/-uvowj-rfdu9kwnslkjfmxj1_p4.png"><br><br>  Implémentant une <i>boucle de contrôle</i> , Flagger bascule progressivement le trafic vers le serveur canari, tout en mesurant simultanément les indicateurs de performance clés, tels que le pourcentage de requêtes HTTP réussies, la durée moyenne des requêtes et la santé des pods.  Sur la base de l'analyse des KPI (indicateurs clés de performance), la partie canari croît ou s'effondre, et les résultats de l'analyse sont publiés dans Slack.  Une description et une démonstration de ce processus peuvent être trouvées dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">livraison progressive pour le maillage d'application</a> . <br><br><img src="https://habrastorage.org/webt/gt/vc/o2/gtvco2gxt0zgw2iqy00bs892phe.png"><br><br><h3>  Déploiement sombre (caché) ou A / B </h3><br>  Le déploiement secret est une autre variante de la stratégie canarienne (Flagger peut également fonctionner avec, d'ailleurs).  La différence entre les déploiements secrets et canaris est que les déploiements secrets traitent avec le frontend et non le backend, comme ceux des canaris. <br><br>  Un autre nom pour ces déploiements est A / B testing.  Au lieu d'ouvrir l'accès à la nouvelle fonction à tous les utilisateurs, elle n'est proposée qu'à une partie limitée.  Généralement, ces utilisateurs ne savent pas qu'ils sont des testeurs pionniers (d'où le terme «déploiement secret»). <br><br>  À l'aide des <i>bascules de</i> fonction et d'autres outils, vous pouvez surveiller la façon dont les utilisateurs interagissent avec la nouvelle fonction, si elle les captive ou s'ils trouvent la nouvelle interface utilisateur déroutante et d'autres types de mesures. <br><br><img src="https://habrastorage.org/webt/hs/gw/jo/hsgwjoo8bij97zvuhrv9evmix-s.png"><br><br><h4>  Flagger et déploiements A / B </h4><br>  En plus du routage pondéré, Flagger peut également diriger le trafic vers le serveur canary, en fonction des paramètres HTTP.  Pour les tests A / B, vous pouvez utiliser des en-têtes HTTP ou des cookies pour rediriger un segment spécifique d'utilisateurs.  Ceci est particulièrement efficace pour les applications frontales qui nécessitent une <i>affinité de session</i> pour le serveur.  Pour plus d'informations, consultez la documentation de Flagger. <br><br>  <i>L'auteur remercie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Stefan Prodan</a> , ingénieur Weaveworks (et créateur de Flagger), pour tous ces déploiements impressionnants.</i> <br><br><h2>  PS du traducteur </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Présentation et comparaison des contrôleurs Ingress pour Kubernetes</a> "; </li><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Werf est notre outil CI / CD à Kubernetes (revue et rapport vidéo)</a> »; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Assemblage et déploiement du même type de microservices avec werf et GitLab CI</a> "; </li><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Qu'est-ce que GitOps?</a>  ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471620/">https://habr.com/ru/post/fr471620/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471604/index.html">N'oubliez pas Open Graph</a></li>
<li><a href="../fr471608/index.html">Système d'évitement des collisions: Partie 1. Législation en tant que savoirs traditionnels pour le développeur</a></li>
<li><a href="../fr471610/index.html">Serveur REST sur Prolog, à quoi ça ressemble?</a></li>
<li><a href="../fr471614/index.html">Version Rustup 1.20.0: prise en charge des profils, améliorations des commandes de mise à jour et de documentation</a></li>
<li><a href="../fr471618/index.html">C / C ++ de Python (boost)</a></li>
<li><a href="../fr471622/index.html">Xamarin.Forms - Un exemple simple d'émulation de carte basée sur l'hôte</a></li>
<li><a href="../fr471624/index.html">Donner une présentation avec une conception UI / UX parfaite</a></li>
<li><a href="../fr471626/index.html">L'IA pour les gens: des mots simples sur la technologie</a></li>
<li><a href="../fr471628/index.html">J'ai remanié à lui seul 15 000 lignes héritées. Ce fut les deux pires semaines de ma vie</a></li>
<li><a href="../fr471630/index.html">Plaisir interdit: dans quels pays PornHub est-il bloqué et pourquoi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>