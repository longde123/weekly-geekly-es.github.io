<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🎨 👩🏽 🌘 Tentukan pemblokiran PKH pada router OpenWrt dengan WireGuard dan DNSCrypt 🐤 🌖 📁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apa perbedaan dari bahan serupa? 


- Implementasi OpenWrt murni 
- Menggunakan WireGuard 
- Konfigurasi router diatur menggunakan konfigurasi OpenWrt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tentukan pemblokiran PKH pada router OpenWrt dengan WireGuard dan DNSCrypt</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440030/"><h2 id="chem-otlichaetsya-ot-podobnyh-materialov">  Apa perbedaan dari bahan serupa? </h2><br><ul><li>  Implementasi OpenWrt murni </li><li>  Menggunakan WireGuard </li><li>  Konfigurasi router diatur menggunakan konfigurasi OpenWrt, dan tidak banyak dalam satu skrip </li><li>  Ada beberapa situasi ketika me-restart jaringan dan me-reboot </li><li>  Mengkonsumsi sedikit sumber daya router: subnet yang dikunci terkandung dalam iptables, dan tidak dalam tabel routing.  Apa yang memungkinkan Anda untuk menggunakan bisnis ini bahkan di perangkat yang lemah </li><li>  Konfigurasi otomatis menggunakan Ansible (tidak diperlukan python di router) </li></ul><a name="habracut"></a><br><h2 id="videoversiya">  Versi video </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/GMvEF0PXN-w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="pochemu-openwrt-i-wireguard">  Mengapa OpenWrt dan WireGuard? </h2><br><p>  OpenWrt diinstal pada banyak model router soho, dikonfigurasi dan diperluas sesuai keinginan hati Anda.  Sekarang banyak firmware router add-on di atas OpenWrt. </p><br><p>  Wireguard digunakan karena pengaturannya yang cepat dan mudah, dan juga karena kecepatan transmisi yang tinggi melalui terowongan. </p><br><h2 id="nemnogo-o-wireguard">  Sedikit tentang WireGuard </h2><br><p>  Dalam kasus kami, server adalah VPS di luar ILV, klien adalah router OpenWrt di rumah.  Ketika Anda ingin pergi ke <del>  pornolab </del>  telegram, router Anda akan mengarahkan lalu lintas melalui server dengan WireGuard. <br>  WireGuard memunculkan koneksi situs ke situs, mis.  baik server dan klien memiliki server dan sisi klien dari konfigurasi.  Jika tidak jelas, akan menjadi jelas ketika Anda melihat konfigurasi. </p><br><p>  Server dan klien memiliki kunci privat dan publik mereka sendiri. </p><br><h2 id="nastroyka-wireguard-na-servere">  Mengkonfigurasi WireGuard di server </h2><br><p>  Saya melakukan semuanya di Ubuntu 18.04, tetapi dalam dokumentasi resmi ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" title="petunjuk pemasangan">instruksi instalasi</a> untuk semua OS yang dikenal dan tidak terlalu. </p><br><h3 id="ustanovka">  Instalasi </h3><br><pre><code class="bash hljs">sudo add-apt-repository ppa:wireguard/wireguard</code> </pre> <br><blockquote>  Jika terjadi kesalahan <br><pre> <code class="bash hljs">sudo: add-apt-repository: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> not found</code> </pre> <br><br>  Instal perangkat lunak-properties-common - paket menyediakan kemampuan untuk menambah dan menghapus PPA <br><pre> <code class="bash hljs">sudo apt install software-properties-common</code> </pre> <br></blockquote><br><pre> <code class="bash hljs">sudo apt update sudo apt install wireguard-dkms wireguard-tools</code> </pre> <br><p>  Kami membuat kunci untuk server.  Kami akan menyimpan kunci di direktori WireGuard untuk kenyamanan. </p><br><pre> <code class="plaintext hljs">cd /etc/wireguard/ wg genkey | tee privatekey-server | wg pubkey &gt; publickey-server</code> </pre> <br><p>  Dengan demikian, akan ada kunci pribadi dalam file server privatekey, dan kunci publik di file server publickey. <br>  Kami juga segera menghasilkan kunci untuk klien: </p><br><pre> <code class="plaintext hljs">wg genkey | tee privatekey-client | wg pubkey &gt; publickey-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/k4/xo/m5/k4xom503xmvyxdhjsvelqhaslxo.png"></p><br><h3 id="konfiguraciya">  Konfigurasi </h3><br><p>  Konfigurasi disimpan di /etc/wireguard/wg0.conf.  Sisi server terlihat seperti ini: </p><br><pre> <code class="bash hljs">[Interface] Address = 192.168.100.1 PrivateKey = privatekey-server ListenPort = 51820 PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o ens3 -j MASQUERADE PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o ens3 -j MASQUERADE</code> </pre> <br><p>  <strong>Alamat</strong> - alamat untuk antarmuka wg (alamat di dalam terowongan) <br>  <strong>PrivateKey</strong> - Kunci pribadi (privatekey-server) <br>  <strong>ListenPort</strong> - Port tempat layanan menunggu untuk terhubung </p><br><p>  Ya, kami memang menyamar, karena kami akan menggunakan server ini untuk mengakses Internet <br>  Harap perhatikan bahwa nama antarmuka dalam kasing Anda mungkin berbeda: </p><br><p>  Bagian klien </p><br><pre> <code class="bash hljs">[Peer] PublicKey = publickey-client AllowedIPs = 192.168.100.3/24</code> </pre> <br><p>  <strong>PublicKey</strong> - kunci publik dari router kami (publickey-client) <br>  <strong>IP</strong> yang <strong>diizinkan</strong> adalah subnet yang akan tersedia melalui terowongan ini.  Server hanya perlu akses ke alamat klien. </p><br><p>  Kedua bagian disimpan dalam satu konfigurasi. </p><br><p>  Nyalakan autostart saat reboot: </p><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> wg-quick@wg0</code> </pre> <br><p>  Kami menjadikan server sebagai router: </p><br><pre> <code class="bash hljs">sysctl -w net.ipv4.ip_forward=1</code> </pre> <br><p>  Konfigurasikan firewall.  Misalkan kita hanya memiliki WireGuard dan ssh di server kami: </p><br><pre> <code class="bash hljs">sudo iptables -A INPUT -i lo -j ACCEPT sudo iptables -A INPUT -p udp -m udp --dport 51820 -j ACCEPT sudo iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT sudo iptables -A INPUT -p icmp -j ACCEPT sudo iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT sudo iptables -A INPUT -j DROP</code> </pre> <br><p>  Simpan konfigurasi iptables: </p><br><pre> <code class="bash hljs">sudo apt-get install iptables-persistent sudo netfilter-persistent save</code> </pre> <br><p>  Kami meningkatkan antarmuka wg untuk pertama kalinya secara manual: </p><br><pre> <code class="bash hljs">wg-quick up wg0</code> </pre> <br><p><img src="https://habrastorage.org/webt/1_/me/ai/1_meai1la87gto2qfa7vwmcfmju.png"></p><br><p>  Server WireGuard sudah siap. </p><br><p>  <strong>UPD 06/27/19</strong> Jika penyedia Anda masih menggunakan PPoE, maka Anda perlu menambahkan aturan.  Terima kasih <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">denix123</a> </p><br><pre> <code class="plaintext hljs">iptables -t mangle -I POSTROUTING -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu</code> </pre> <br><h2 id="nastroyka-routera">  Pengaturan router </h2><br><p>  Saya menggunakan OpenWrt versi 18.06.1 pada Xiaomi mi 3G dan Asus RT-N16. </p><br><h3 id="logika-raboty-routera">  Logika dari router </h3><br><p>  Kami memuat daftar, menempatkannya di iptables, iptables menandai semua alamat dari daftar ini dengan penanda 0x1.  Selanjutnya, semua paket yang ditandai dengan 0x1 pergi ke tabel routing terpisah, semua paket yang masuk ke tabel routing ini pergi melalui antarmuka wg. </p><br><p><img src="https://habrastorage.org/webt/vy/rc/ji/vyrcjihaaozo-vzf1nkm9nlxpl0.gif"></p><br><h3 id="ustanovka-paketov">  Instalasi Paket </h3><br><p>  Adapun ruang yang ditempati pada flash, semuanya akan membutuhkan sekitar 0,9MB.  Jika Anda memiliki tempat yang sangat buruk, ganti curl dengan wget dan Anda mungkin tidak perlu menginstal dnscrypt-proxy. </p><br><p>  Kami menaruh paket.  Di OpenWrt, ini mudah dilakukan melalui manajer paket opkg: </p><br><pre> <code class="bash hljs">opkg update opkg install ipset wireguard curl</code> </pre> <br><h3 id="zagruzka-spiskov">  Daftar unduhan </h3><br><p>  Segala sesuatu yang dapat dilakukan melalui fitur standar OpenWrt dilakukan melalui mereka.  Segala sesuatu yang lain (kecuali hotplug) saya masukkan ke dalam skrip kecil: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh START=99 dir=/tmp/lst mkdir -p $dir echo "Run download lists" curl -z $dir/subnet.lst https://antifilter.download/list/subnet.lst --output $dir/subnet.lst curl -z $dir/ipsum.lst https://antifilter.download/list/ipsum.lst --output $dir/ipsum.lst echo "Firewall restart" /etc/init.d/firewall restart</span></span></code> </pre> <br><p>  Daftar subnet dan alamat terlarang diperoleh melalui file.  Bagi mereka, kita membuat direktori di / tmp.  Di / tmp - karena RAM, fitur OpenWrt seperti itu cukup nyaman.  Tidak ada gunanya menulis sesuatu di ROM router lagi. </p><br><p>  Kami memompa daftar dengan antifilter.download curl, z flag berarti bahwa curl akan mengunduh file hanya jika file jarak jauh berbeda dari file lokal atau jika tidak ada, seperti halnya saat memuat router. </p><br><p>  <em>subnet.lst</em> - daftar subnet yang diblokir, tidak sering berubah. <br>  <em>ipsum.lst</em> adalah daftar alamat yang diblokir, yang dirangkum oleh mask.  Alih-alih 150 ribu catatan, kami mendapatkan 15 ribu - dengan mudah. </p><br><p>  Setelah kita memiliki file, kita me-restart firewall, ini diperlukan agar ipset berfungsi dan menambahkan daftar ke iptables, kita akan mengkonfigurasi ipset di /etc/config / firewall. </p><br><p>  Script ini kita tambahkan di /etc/init.d/ akan disebut hirkn.  Jadikan itu dapat dieksekusi </p><br><pre> <code class="bash hljs">chmod +x /etc/init.d/hirkn</code> </pre> <br><p>  Sekarang kami tidak hanya memiliki skrip, tetapi seluruh layanan.  Agar dapat mulai saat boot, kami membuat symlink di /etc/rc.d.  Kami membutuhkannya untuk memulai setelah semua layanan lain, jadi kami membuat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" title="awalan S99">awalan S99</a> </p><br><pre> <code class="bash hljs">ln -s /etc/init.d/hirkn /etc/rc.d/S99hirkn</code> </pre> <br><p>  Daftar perlu diperbarui dari waktu ke waktu, kami menambahkan catatan di cron: </p><br><pre> <code class="bash hljs">crontab -e</code> </pre> <br><pre> <code class="bash hljs">0 4 * * * /etc/init.d/hirkn</code> </pre> <br><p>  Tampaknya cukup memadai untuk memperbaruinya sekali sehari.  Perlu diingat bahwa ketika menambahkan daftar ke ipset, jaringan jatuh, dalam kasus saya ini 2 detik. <br>  <strong>UPD</strong> : Jika Anda tidak ingin istirahat, maka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">sigo73</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">Grayver</a> menyarankan dalam komentar bagaimana melakukan ini. </p><br><p>  Aktifkan juga mahkota, secara default dinonaktifkan: </p><br><pre> <code class="bash hljs">/etc/init.d/cron <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> /etc/init.d/cron start</code> </pre> <br><h3 id="konfiguraciya-tablicy-marshrutizacii">  Konfigurasi tabel perutean </h3><br><p>  Buat tabel routing untuk lalu lintas melalui terowongan dengan hanya menambahkan baris: </p><br><pre> <code class="bash hljs">99 vpn</code> </pre> <br><p>  ke file / etc / iproute2 / rt_tables. </p><br><p>  Anda dapat membuat rute default untuk tabel "vpn" melalui antarmuka wg dengan perintah: </p><br><pre> <code class="bash hljs">ip route add table vpn default dev wg0</code> </pre> <br><p>  Tetapi ketika Anda me-restart jaringan, rute menghilang, jadi kami membuat file 30-rknroute di direktori /etc/hotplug.d/iface/ dengan konten sederhana: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ip route add table vpn default dev wg0</span></span></code> </pre> <br><p>  Ini berarti bahwa ketika Anda menghidupkan / mematikan antarmuka, rute kami akan ditambahkan.  Dan karenanya, rute ini akan selalu terdaftar. </p><br><h3 id="konfiguraciya-seti">  Konfigurasi jaringan </h3><br><p>  Kita perlu mengkonfigurasi WireGuard dan aturan untuk paket berlabel 0x1. </p><br><p>  Konfigurasi WireGuard terletak di / etc / config / network </p><br><p>  Bagian "server": </p><br><pre> <code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'wg0'</span></span> option private_key <span class="hljs-string"><span class="hljs-string">'privatekey-client'</span></span> list addresses <span class="hljs-string"><span class="hljs-string">'192.168.100.3/24'</span></span> option listen_port <span class="hljs-string"><span class="hljs-string">'51820'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'wireguard'</span></span></code> </pre> <br><p>  <strong>private_key</strong> adalah privatekey-client yang kami hasilkan saat mengonfigurasi server <br>  <strong>daftar alamat</strong> - alamat antarmuka wg <br>  <strong>listen_port</strong> - port tempat WireGuard menerima koneksi.  Tetapi koneksi akan terjadi melalui port di server, jadi di sini kita tidak akan membuka port di firewall untuk itu <br>  <strong>proto</strong> - tentukan protokolnya sehingga openwrt akan mengerti bahwa ini adalah konfigurasi WireGuard </p><br><p>  Bagian "Klien": </p><br><pre> <code class="bash hljs">config wireguard_wg0 option public_key <span class="hljs-string"><span class="hljs-string">'publickey-server'</span></span> option allowed_ips <span class="hljs-string"><span class="hljs-string">'0.0.0.0/0'</span></span> option route_allowed_ips <span class="hljs-string"><span class="hljs-string">'0'</span></span> option endpoint_host <span class="hljs-string"><span class="hljs-string">'wg-server-ip'</span></span> option persistent_keepalive <span class="hljs-string"><span class="hljs-string">'25'</span></span> option endpoint_port <span class="hljs-string"><span class="hljs-string">'51820'</span></span></code> </pre> <br><p>  <strong>public_key</strong> - kunci publickey-server <br>  <strong>allow_ips</strong> - subnet di mana lalu lintas dapat melewati terowongan, dalam kasus kami tidak ada batasan yang diperlukan, oleh karena itu 0.0.0.0/0 <br>  <strong>route_allowed_ips</strong> - flag yang membuat rute melalui antarmuka wg untuk jaringan yang terdaftar dari parameter allow_ips.  Dalam kasus kami, ini tidak perlu, iptables berfungsi <br>  <strong>endpoint_host</strong> - ip / url dari server wg kami <br>  <strong>persistent_keepalive</strong> - interval waktu setelah paket dikirim untuk mendukung koneksi <br>  <strong>endpoint_port</strong> - port wireguard di server </p><br><p>  Kami juga akan menambahkan aturan ke konfigurasi jaringan yang akan mengirim semua lalu lintas bertanda 0x1 ke tabel routing "vpn": </p><br><pre> <code class="bash hljs">config rule option priority <span class="hljs-string"><span class="hljs-string">'100'</span></span> option lookup <span class="hljs-string"><span class="hljs-string">'vpn'</span></span> option mark <span class="hljs-string"><span class="hljs-string">'0x1'</span></span></code> </pre> <br><h3 id="konfiguraciya-firewall">  Konfigurasi firewall </h3><br><p><del>  Kami menambahkan dua aturan untuk menandai paket, mereka tidak cocok dengan sintaks UCI openwrt, jadi kami menambahkannya "sebagaimana adanya" ke /etc/firewall.user. </del><br>  <strong>UPD</strong> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">Grayver</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" title="disarankan">menyarankan</a> agar mereka cocok.  Kami mengaturnya setelah mengatur ipset </p><br><p>  Konfigurasi firewall ada di / etc / config / firewall </p><br><p>  Tambahkan zona untuk penyadapan.  Di openwrt, zona adalah rantai khusus di iptables.  Dengan demikian, zona dengan satu / beberapa antarmuka dibuat dan aturan sudah digantung padanya.  Zona untuk wg terlihat seperti ini: </p><br><pre> <code class="bash hljs">config zone option name <span class="hljs-string"><span class="hljs-string">'wg'</span></span> option family <span class="hljs-string"><span class="hljs-string">'ipv4'</span></span> option masq <span class="hljs-string"><span class="hljs-string">'1'</span></span> option output <span class="hljs-string"><span class="hljs-string">'ACCEPT'</span></span> option forward <span class="hljs-string"><span class="hljs-string">'REJECT'</span></span> option input <span class="hljs-string"><span class="hljs-string">'REJECT'</span></span> option mtu_fix <span class="hljs-string"><span class="hljs-string">'1'</span></span> option network <span class="hljs-string"><span class="hljs-string">'wg0'</span></span></code> </pre> <br><p>  Kami hanya mengizinkan lalu lintas untuk keluar dari antarmuka dan mengaktifkan penyamaran. </p><br><p>  Sekarang Anda perlu mengaktifkan penerusan dari zona lan ke zona wg: </p><br><pre> <code class="bash hljs">config forwarding option src <span class="hljs-string"><span class="hljs-string">'lan'</span></span> option dest <span class="hljs-string"><span class="hljs-string">'wg'</span></span></code> </pre> <br><p>  Nah, hal terakhir adalah membuat daftar di iptables menggunakan ipset: </p><br><pre> <code class="bash hljs">config ipset option name <span class="hljs-string"><span class="hljs-string">'vpn_subnets'</span></span> option storage <span class="hljs-string"><span class="hljs-string">'hash'</span></span> option loadfile <span class="hljs-string"><span class="hljs-string">'/tmp/lst/subnet.lst'</span></span> option match <span class="hljs-string"><span class="hljs-string">'dst_net'</span></span> config ipset option name <span class="hljs-string"><span class="hljs-string">'vpn_ipsum'</span></span> option storage <span class="hljs-string"><span class="hljs-string">'hash'</span></span> option loadfile <span class="hljs-string"><span class="hljs-string">'/tmp/lst/ipsum.lst'</span></span> option match <span class="hljs-string"><span class="hljs-string">'dst_net'</span></span></code> </pre> <br><p>  <strong>loadfile</strong> - file dari mana kita mengambil daftar <br>  <strong>nama</strong> - nama untuk daftar kami <br>  <strong>penyimpanan</strong> , <strong>cocok</strong> - di sini kami menentukan cara menyimpan dan jenis data apa.  Kami akan menyimpan jenis "subnet" </p><br><p>  <strong>UPD</strong> : Jika Anda ingin menggunakan daftar masing-masing alamat IP, maka Anda perlu menambah ukuran daftar ipset.  Dalam config ipset add </p><br><pre> <code class="plaintext hljs"> option hashsize '1000000' option maxelem '1000000'</code> </pre> <br><p>  Kalau tidak, Anda akan mendapatkan kesalahan </p><br><pre> <code class="plaintext hljs">ipset v6.38: Hash is full, cannot add more elements</code> </pre> <br><p>  <strong>UPD</strong> : Tambahkan dua aturan untuk paket pelabelan </p><br><pre> <code class="plaintext hljs">config rule option name 'mark_subnet' option src 'lan' option proto 'all' option ipset 'vpn_subnets' option set_mark '0x1' option target 'MARK' config rule option name 'mark_ipsum' option src 'lan' option proto 'all' option ipset 'vpn_ipsum' option set_mark '0x1' option target 'MARK'</code> </pre> <br><p>  Aturan-aturan ini menyiratkan bahwa semua paket pergi ke subnet dari vpn_subnets dan daftar vpn_ipsum harus ditandai dengan 0x1. </p><br><p>  Setelah itu, kami me-restart jaringan: </p><br><pre> <code class="bash hljs">/etc/init.d/network restart</code> </pre> <br><p><img src="https://habrastorage.org/webt/e6/pm/m6/e6pmm6etqcw0dbz-c3ddqmzqemo.png"></p><br><p>  dan jalankan skrip: </p><br><pre> <code class="bash hljs">/etc/init.d/hirkn</code> </pre> <br><p><img src="https://habrastorage.org/webt/e4/q-/6r/e4q-6rktvq2y8znvhmtpxfdsnwi.gif"></p><br><p>  Setelah mengerjakan skrip, semuanya akan bekerja untuk Anda.  Periksa rute pada klien router: </p><br><pre> <code class="bash hljs">mtr/traceroute telegram.org/linkedin.com</code> </pre> <br><p><img src="https://habrastorage.org/webt/wp/6e/jp/wp6ejpwtfwu9xkk-iizc8qj_aeu.gif"></p><br><h2 id="bonusom-nastroim-dnscrypt">  Bonus mengkonfigurasi DNSCrypt </h2><br><p>  Mengapa  Penyedia Anda dapat dengan hati-hati mengganti alamat ip dari sumber daya yang diblokir, sehingga mengarahkan Anda ke ip Anda dengan sebuah rintisan, yah, bypass IP kami tidak akan membantu dalam kasus ini.  Untuk substitusi, tidak selalu perlu menggunakan server dns penyedia, permintaan Anda dapat dicegat dan balasan akan diganti.  Omong-omong, bukan hanya penyedia yang bisa melakukan ini. </p><br><pre> <code class="bash hljs">opkg install dnscrpt-proxy</code> </pre> <br><p>  Konfigurasikan konfigurasi / etc / config / dnscrypt-proxy seperti ini: </p><br><pre> <code class="bash hljs">config dnscrypt-proxy ns1 option address <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span> option port <span class="hljs-string"><span class="hljs-string">'5353'</span></span> option resolver <span class="hljs-string"><span class="hljs-string">'cpunks-ru'</span></span></code> </pre> <br><p>  Jadi kami memiliki layanan dnscrypt pada port 5353 yang tersedia di localhost. </p><br><p>  <strong>Resolver</strong> adalah server yang mendukung enkripsi dns.  Pada router, file /usr/share/dnscrypt-proxy/dnscrypt-resolvers.csv berisi daftar server yang tersedia pada saat rilis versi dnscrypt yang diinstal.  Dan di sini adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://dnscrypt.info/public-servers/</a> secara umum semua server dnscrypt yang tersedia.  Anda dapat memilih resolver lain dan / atau menambah server untuk toleransi kesalahan.  Perlu diingat bahwa agar DNSCrypt dapat bekerja dengan resolver yang dipilih, itu harus ditentukan dalam dnscrypt-resolvers.csv. </p><br><p>  Kami mengkonfigurasi dnsmasq agar berfungsi dengan dnscrypt.  Di / etc / config / dhcp, beri komentar di baris: </p><br><pre> <code class="bash hljs">option resolvfile <span class="hljs-string"><span class="hljs-string">'/tmp/resolv.conf.auto'</span></span></code> </pre> <br><p>  sehingga penyedia server dns tidak terlibat. </p><br><p>  Dan tambahkan: </p><br><pre> <code class="bash hljs"> list server <span class="hljs-string"><span class="hljs-string">'/pool.ntp.org/208.67.222.222'</span></span> list server <span class="hljs-string"><span class="hljs-string">'127.0.0.1#5353'</span></span></code> </pre> <br><p>  <strong>Entri daftar server 'domain / ip_dns'</strong> menunjukkan server dns mana yang digunakan untuk menyelesaikan domain yang ditentukan.  Dengan demikian, kami tidak menggunakan dnscrypt untuk sinkronisasi ntp - penting bagi layanan dnscrypt untuk memiliki waktu saat ini. </p><br><p><del>  Ketika router memuat, skrip hirkn berjalan lebih cepat daripada dnscrypt dimulai, sehingga domain antifilter.download tidak menyelesaikan dan daftar tidak diunduh.  Anda dapat membuat penundaan atau hal lain untuk muncul, tetapi sejauh ini saya tidak melihat alasan. </del><br>  <strong>UPD</strong> : perlu menambahkan baris </p><br><pre> <code class="plaintext hljs">START=99</code> </pre> <br><p>  ke skrip hirkn </p><br><p>  Akibatnya, kami mendapatkan sisipan seperti itu di konfigurasi: </p><br><pre> <code class="bash hljs"> <span class="hljs-comment"><span class="hljs-comment">#option resolvfile '/tmp/resolv.conf.auto' list server '/pool.ntp.org/208.67.222.222' list server '127.0.0.1#5353'</span></span></code> </pre> <br><p>  <strong>UPD</strong> : Pada beberapa perangkat, DNSCrypt tetap dimulai setelah skrip.  Cara termudah untuk memperbaikinya adalah dengan menambahkan baris ke / etc / config / dhcp </p><br><pre> <code class="plaintext hljs"> list server '/antifilter.download/208.67.222.222'</code> </pre> <br><p>  Nonaktifkan penggunaan DNS penyedia untuk antarmuka yang lemah <br>  Di / etc / config / network tambahkan baris </p><br><pre> <code class="plaintext hljs">option peerdns '0'</code> </pre> <br><p>  ke antarmuka yang lemah. <br>  Kami mendapatkan konfigurasi ini </p><br><pre> <code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'wan'</span></span> option ifname <span class="hljs-string"><span class="hljs-string">'eth0.2'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'dhcp'</span></span> option peerdns <span class="hljs-string"><span class="hljs-string">'0'</span></span></code> </pre> <br><p>  Mulai ulang jaringan </p><br><pre> <code class="plaintext hljs">/etc/init.d/network restart</code> </pre> <br><p>  Tambahkan ke startup dan mulai dnscrypt: </p><br><pre> <code class="bash hljs">/etc/init.d/dnscrypt-proxy <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> /etc/init.d/dnscrypt-proxy start</code> </pre> <br><p>  Mulai ulang dnsmasq: </p><br><pre> <code class="bash hljs">/etc/init.d/dnsmasq restart</code> </pre> <br><p><img src="https://habrastorage.org/webt/i2/b5/90/i2b590nxr6-lqnk1h2-tq-i6t-4.gif"><br>  <em>Ilustrasi pekerjaan tanpa DNSCrypt dan dengan DNSCrypt</em> </p><br><h2 id="avtomaticheski-razvertyvaem-s-pomoschyu-ansible">  Diterapkan secara otomatis dengan Ansible </h2><br><p>  Playbook dan templat ada di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" title="github">github</a> .  Ini menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">modul</a> , tidak perlu python di router dan ada dukungan untuk uci.  Saya mencoba memastikan bahwa konfigurasi OpenWrt Anda tetap tidak tersentuh, tetapi berhati-hatilah. </p><br><p>  Instal modul gekmihesg / ansible-openwrt: </p><br><pre> <code class="bash hljs">ansible-galaxy install gekmihesg.openwrt</code> </pre> <br><p>  Salin playbook dan tempeyta: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/ansible git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/itdoginfo/ansible-openwrt-hirkn mv ansible-openwrt-hirkn/* . rm -rf ansible-openwrt-hirkn</code> </pre> <br><p>  Tambahkan router Anda ke host: </p><br><pre> <code class="bash hljs">[openwrt] 192.168.1.1</code> </pre> <br><p>  Ganti variabel Anda di hirkn.yml: </p><br><pre> <code class="bash hljs"> vars: ansible_template_dir: /etc/ansible/templates/ wg_server_address: wg_server_ip/url wg_private_key: privatekey-client wg_public_key: publickey-server wg_listen_port: 51820 wg_client_port: 51820 wg_client_address: 192.168.100.3/24</code> </pre> <br><p>  Pastikan untuk mengatur: </p><br><p>  <strong>wg_server_address</strong> - server wireguard ip / url <br>  <strong>wg_private_key</strong> , <strong>wg_public_key</strong> - kunci pribadi dari klien dan server publik <br>  Sisanya tidak dapat diubah atau diubah, tergantung pada bagaimana server WireGuard dikonfigurasi </p><br><p>  Luncurkan buku pedoman </p><br><pre> <code class="bash hljs">ansible-playbook playbooks/hirkn.yml</code> </pre> <br><p>  Setelah menyelesaikan buku pedoman, router akan segera mulai memotong kunci melalui server wireguard Anda. </p><br><h2 id="pochemu-ne-bgp">  Kenapa tidak BGP? </h2><br><p>  Di bawah openwrt ada dua utilitas yang mengimplementasikan BGP - quagga dan burung.  Quagg saya tidak bisa mengumpulkan data dari antifilter.  Bird berteman dengan layanan dari setengah tendangan, tapi sayangnya saya tidak mengerti bagaimana cara memaksa antarmuka default untuk ditambahkan ke subnet yang diterima.  (Saya akan senang mengetahui bagaimana ini dapat diterapkan). </p><br><p>  Dalam komentar pada artikel seperti itu, saya melihat bahwa router orang “bijaksana” untuk sementara waktu, ketika mereka memasukkan daftar ke tabel routing.  Dengan implementasi melalui ipset, Xiaomi mi 3G saya berpikir selama 2 detik (Asus rt-n16 selama 5 detik), ketika Anda memberinya daftar 15 ribu subnet.  Dengan pekerjaan lebih lanjut, saya tidak melihat beban pada prosesor. </p><br><p>  <em>Semua materi bukan ajakan untuk bertindak dan disajikan untuk pengenalan fungsi dari OS Linux.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id440030/">https://habr.com/ru/post/id440030/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id440018/index.html">Paparan lokal yang dinamis</a></li>
<li><a href="../id440020/index.html">Regresi atau regresi dalam pengujian</a></li>
<li><a href="../id440022/index.html">Ferrari kecil: Fintech-startup Rally Rd akan memungkinkan Anda untuk membeli "saham" mobil langka</a></li>
<li><a href="../id440024/index.html">Redirect printf () dari STM32 ke Qt Creator Console</a></li>
<li><a href="../id440026/index.html">Kaggle: tidak bisa berjalan - mari kita lari</a></li>
<li><a href="../id440032/index.html">Kecerdasan Buatan Cakrawala Nihil Fajar</a></li>
<li><a href="../id440034/index.html">Arsitektur CIUMAN. Dari microservice ke monolith</a></li>
<li><a href="../id440036/index.html">Sentuhan mengetik</a></li>
<li><a href="../id440040/index.html">Dalam pengembangan - masing-masing untuk dirinya sendiri. Tapi terkadang itu mengarah ke jalan buntu.</a></li>
<li><a href="../id440044/index.html">Riwayat Lengkap Qualcomm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>