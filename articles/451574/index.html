<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎈 ⛔️ 🧑🏿 Desarrollar una utilidad en GraalVM 🍚 🦆 🦁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Declaración del problema. 


 Periódicamente, tengo la tarea de compartir archivos en una red local, por ejemplo, con un colega del proyecto. 


 Pued...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desarrollar una utilidad en GraalVM</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451574/"><h2 id="postanovka-zadachi">  Declaración del problema. </h2><br><p> Periódicamente, tengo la tarea de compartir archivos en una red local, por ejemplo, con un colega del proyecto. </p><br><p>  Puede haber muchas soluciones para esto: Samba / FTP / scp.  Simplemente puede cargar el archivo en un lugar público como Google Drive, adjuntarlo a una tarea en Jira o incluso enviarlo por correo electrónico. </p><br><p>  Pero todo esto, en un grado u otro, es inflexible, en algún lugar requiere un ajuste preliminar y tiene sus propias limitaciones (por ejemplo, el tamaño máximo de inversión). </p><br><p>  Y quieres algo más ligero y flexible. </p><br><p>  Siempre me sorprendió gratamente la oportunidad en Linux, utilizando los medios disponibles, de construir rápidamente una solución práctica. </p><br><p>  Digamos, a menudo resolví la tarea mencionada usando el sistema python con la siguiente línea simple </p><br><pre><code class="bash hljs">$ python3 -mhttp.server Serving HTTP on 0.0.0.0 port 8000 ...</code> </pre> <br><p>  Este comando inicia el servidor web en la carpeta actual y le permite obtener una lista de archivos y descargarlos a través de la interfaz web.  Más de estas cosas se pueden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tirar aquí</a> . </p><a name="habracut"></a><br><p>  Hay varios inconvenientes.  Ahora, para transferir el enlace de descarga a un colega, debe conocer su dirección IP en la red. </p><br><p>  Es conveniente usar el comando </p><br><pre> <code class="bash hljs">$ ifconfig -a</code> </pre> <br><p>  Y luego, de la lista resultante de interfaces de red, seleccione la apropiada y redacte manualmente un enlace del formulario <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http: // IP: 8000</a> , que puede enviar. </p><br><p>  Segundo inconveniente: este servidor tiene un solo subproceso.  Esto significa que mientras uno de sus colegas descarga el archivo, el segundo ni siquiera podrá descargar la lista de archivos. </p><br><p>  En tercer lugar, es inflexible.  Si necesita transferir solo un archivo, se abrirá la carpeta completa, es decir  Tendrá que realizar tales gestos (y luego limpiar la basura): </p><br><pre> <code class="bash hljs">$ mkdir tmp1 $ cp file.zip tmp1 $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> tmp1 $ python3 -mhttp.server</code> </pre> <br><p>  El cuarto inconveniente: no hay <em>una</em> manera <em>fácil</em> de descargar todo el contenido de una carpeta. </p><br><p>  Para transferir el contenido de una carpeta, generalmente usan una técnica llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tar pipe</a> . </p><br><p>  Hacen algo como esto: </p><br><pre> <code class="bash hljs">$ ssh user@host <span class="hljs-string"><span class="hljs-string">'cd /path/to/source &amp;&amp; tar cf - .'</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/destination &amp;&amp; tar xvf -</code> </pre> <br><p>  Si de repente no está claro, explicaré cómo funciona.  La primera parte del comando <code>tar cf - .</code>  crea un archivo de los contenidos de la carpeta actual y escribe en la salida estándar.  Además, esta salida se transmite a través de una tubería a través de un canal ssh seguro a la entrada de un <code>tar xvf -</code> similar <code>tar xvf -</code> que realiza el procedimiento contrario, es decir,  lee entradas estándar y descomprime en la carpeta actual.  De hecho, el archivo se transfiere, ¡pero sin crear un archivo intermedio! </p><br><p>  El inconveniente de este enfoque también es obvio.  Necesitamos acceso ssh de una máquina a otra, y esto casi nunca se hace en el caso general. </p><br><p>  ¿Es posible lograr todo lo anterior, pero sin estos problemas descritos? </p><br><p>  Entonces, es hora de formalizar lo que construiremos: </p><br><ol><li>  Programa fácil de instalar (binario estático) </li><li>  Lo que le permitirá transferir tanto un archivo como una carpeta con todo el contenido </li><li>  Con compresión opcional </li><li>  Lo que permite que el host descargue los archivos utilizando solo herramientas estándar * nix (wget / curl / tar) </li><li>  El programa inmediatamente después del lanzamiento emitirá los comandos exactos para descargar </li></ol><br><h2 id="reshenie">  Solución </h2><br><p>  En la conferencia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">JEEConf</a> , a la que asistí no hace mucho, el tema de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Graal</a> se planteó repetidamente.  El tema está lejos de ser nuevo, pero para mí fue un detonante para finalmente sentir esta bestia con mi propia mano. </p><br><p>  Para aquellos que aún no están en el tema (¿existe realmente tal cosa? OO) permítanme recordarles que GraalVM es una JVM tan bombeada de Oracle con características adicionales, las más notables de las cuales son: </p><br><ol><li>  Polyglot JVM: la capacidad de ejecutar sin problemas Java, Javascript, Python, Ruby, R, etc.  codigo </li><li>  Soporte para compilación AOT: compilación de Java directamente en el binario nativo </li><li>  Una característica menos notable, pero muy interesante: el compilador C2 se reescribió de C ++ a Java para facilitar su desarrollo posterior.  Esto ya ha producido resultados notables.  Este compilador hace muchas más optimizaciones en la etapa de convertir el bytecode de Java a código nativo.  Por ejemplo, puede eliminar de manera más efectiva las asignaciones.  Twitter pudo reducir el consumo de CPU en un 11% con solo activar esta configuración, que en su escala dio un notable ahorro de recursos (y dinero). </li></ol><br><p>  Puede actualizar la idea de Graal, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en este artículo de habr</a> . </p><br><p>  Escribiremos en Java, por lo que para nosotros la característica más relevante será la compilación AOT. </p><br><p>  En realidad, el resultado del desarrollo se presenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en este repositorio de Github</a> . </p><br><p>  Ejemplo de uso para transferir un solo archivo: </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/report.pdf'</span></span> To download the file please use one of the commands below: curl http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> curl http://192.168.0.179:17777/dl?z --compressed &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span> wget -O- http://192.168.0.179:17777/dl?z | gunzip &gt; <span class="hljs-string"><span class="hljs-string">'report.pdf'</span></span></code> </pre> <br><p>  Un ejemplo de uso al transferir el contenido de una carpeta (¡todos los archivos, incluidos los archivos adjuntos!): </p><br><pre> <code class="bash hljs">$ serv <span class="hljs-string"><span class="hljs-string">'/path/to/folder'</span></span> To download the files please use one of the commands below. NB! All files will be placed into current folder! curl http://192.168.0.179:17777/dl | tar -xvf - wget -O- http://192.168.0.179:17777/dl | tar -xvf - curl http://192.168.0.179:17777/dl?z | tar -xzvf - wget -O- http://192.168.0.179:17777/dl?z | tar -xzvf -</code> </pre> <br><p>  Si, tan simple! </p><br><p>  Tenga en cuenta que el programa mismo determina la dirección IP correcta en la que los archivos estarán disponibles para descargar. </p><br><h2 id="nablyudeniya--razmyshleniya">  Observaciones / Pensamientos </h2><br><p>  Está claro que uno de los objetivos al crear el programa era su compacidad.  Y aquí está el resultado que se logró: </p><br><pre> <code class="bash hljs">$ du -hs `<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> serv` 2.4M /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/serv</code> </pre> <br><p>  Increíblemente, ¡toda la JVM, junto con el código de la aplicación, cabe en unos miserables pocos megabytes!  Por supuesto, todo está algo mal, pero más sobre eso más adelante. </p><br><p>  De hecho, el compilador Graal produce un binario que es un poco más grande que 7 megabytes de tamaño.  Decidí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comprimirlo</a> aún <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">más con el UPX</a> . </p><br><p>  Esto resultó ser una buena idea, ya que el tiempo de lanzamiento aumentó mientras era muy insignificante: </p><br><p>  Opción sin comprimir: </p><br><pre> <code class="bash hljs">$ time ./build/com.cmlteam.serv.serv -v 0.1 real 0m0.001s user 0m0.001s sys 0m0.000s</code> </pre> <br><p>  Comprimido </p><br><pre> <code class="bash hljs">$ time ./build/serv -v 0.1 real 0m0.021s user 0m0.021s sys 0m0.000s</code> </pre> <br><p>  A modo de comparación, el tiempo de lanzamiento en la "forma tradicional": </p><br><pre> <code class="bash hljs">$ time java -cp <span class="hljs-string"><span class="hljs-string">"/home/xonix/proj/serv/target/classes:/home/xonix/.m2/repository/commons-cli/commons-cli/1.4/commons-cli-1.4.jar:/home/xonix/.m2/repository/org/apache/commons/commons-compress/1.18/commons-compress-1.18.jar"</span></span> com.cmlteam.serv.Serv -v 0.1 real 0m0.040s user 0m0.030s sys 0m0.019s</code> </pre> <br><p>  Como puede ver, el doble de lento que la versión UPX. </p><br><p>  En general, un tiempo de inicio corto es uno de los puntos fuertes de GraalVM.  Esto, así como el bajo consumo de memoria, genera un entusiasmo significativo en torno al uso de esta tecnología para microservicios y sin servidor. </p><br><p>  Traté de hacer que la lógica del programa sea lo más mínima posible y usar un mínimo de bibliotecas.  En principio, este enfoque generalmente está justificado y, en este caso, me preocupaba que agregar dependencias de expertos de terceros “ponderara” significativamente el archivo de programa resultante. </p><br><p>  Por ejemplo, por eso no utilicé una dependencia de terceros para un servidor web Java (y hay muchos para todos los gustos y colores), pero utilicé la implementación JDK de un servidor web de <code>com.sun.net.httpserver.*</code> Paquete.  En realidad, el uso del paquete <code>com.sun.*</code> Se considera de <code>com.sun.*</code> , pero en este caso lo considero permisible, ya que estoy compilando en código nativo y, por lo tanto, no hay ninguna cuestión de compatibilidad entre la JVM. </p><br><p>  Sin embargo, mis miedos eran completamente en vano.  En el programa, utilicé dos dependencias por conveniencia </p><br><ol><li>  <code>commons-cli</code> : para analizar argumentos de línea de comandos </li><li>  <code>commons-compress</code> - para generar una carpeta tarball y compresión gzip opcional </li></ol><br><p>  Al mismo tiempo, el tamaño del archivo aumentó muy ligeramente.  Me aventuraré a sugerir que el compilador de Graal es muy inteligente para no poner todos los nicks de complementos en el archivo ejecutable, sino solo el código de ellos que realmente usa el código de la aplicación. </p><br><p>  La compilación en código Graal nativo se realiza mediante la utilidad de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">imagen nativa</a> .  Vale la pena mencionar que este proceso requiere muchos recursos.  Digamos, en mi configuración no tan lenta con una CPU Intel 7700K a bordo, este proceso lleva 19 segundos.  Por lo tanto, recomiendo que al desarrollar, ejecute el programa como de costumbre (a través de Java), y recopile el binario en la etapa final. </p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  El experimento, me parece, fue muy exitoso.  Al desarrollar usando el kit de herramientas Graal, no encontré ningún problema insuperable o incluso significativo.  Todo funcionó de manera predecible y estable.  Aunque, casi con certeza, todo no será tan fácil si intenta construir algo más complejo de esta manera, por ejemplo, una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aplicación en Spring Boot</a> .  Sin embargo, ya se han presentado varias plataformas en las que se declara el soporte nativo para Graal.  Entre ellos están <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Micronaut</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Microprofile</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Quarkus</a> . </p><br><p>  En cuanto al desarrollo posterior del proyecto, una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lista de mejoras</a> planificadas para la versión 0.2 ya está lista.  Además, por el momento, el ensamblaje del binario final se implementa solo para Linux x64.  Espero que esta omisión se solucione en el futuro, especialmente porque el compilador de <code>native-image</code> de Graal es compatible con MacOS y Windows.  Desafortunadamente, aún no admite la compilación cruzada, lo que podría facilitar las cosas. </p><br><p>  Espero que la utilidad presentada sea útil al menos para alguien de la comunidad habr acreditada.  Estaré doblemente contento si hay quienes desean contribuir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">al proyecto</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/451574/">https://habr.com/ru/post/451574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451560/index.html">Estimado cliente, es por eso que este cambio tomó tanto tiempo.</a></li>
<li><a href="../451562/index.html">¿Cómo escapar de una secta?</a></li>
<li><a href="../451566/index.html">Operation TaskMasters: cómo expusimos a las organizaciones de ataque del grupo cibernético en Rusia y la CEI</a></li>
<li><a href="../451570/index.html">Mudarse a Francia por trabajo: salarios, visas y currículums</a></li>
<li><a href="../451572/index.html">Tendencias de tecnología de desarrollo web 2019</a></li>
<li><a href="../451576/index.html">El libro "Nuestro código. Artesanía, profesión, arte "</a></li>
<li><a href="../451580/index.html">MODX Digest # 5 (22 de abril - 13 de mayo de 2019)</a></li>
<li><a href="../451582/index.html">Content Marketing en inglés: 5 cifras importantes para ayudar a las startups</a></li>
<li><a href="../451586/index.html">Bienvenido a la Difusión UPD de BD & DWH Raiffeisen MeetUp</a></li>
<li><a href="../451588/index.html">Nota de prueba de integración con Jenkins en Kubernetes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>