<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💣 🦔 🚘 调整PostgreSQL设置以优化性能 👨🏼‍🚀 🥉 ✋🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="默认情况下，未为工作负载配置PostgreSQL。 设置默认值可确保PostgreSQL在所有资源最少的地方都能正常运行。 所有数据库设置都有默认设置。 数据库管理员或开发人员的主要职责是配置PostgreSQL以适合其系统负载。 在此博客中，我们将概述有关根据工作负载调整PostgreSQL数据库...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>调整PostgreSQL设置以优化性能</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458952/"><img width="40%" align="left" src="https://habrastorage.org/webt/l-/ic/pg/l-icpgtelc8i-e2bloa97rcz9pu.jpeg"> 默认情况下，未为工作负载配置PostgreSQL。 设置默认值可确保PostgreSQL在所有资源最少的地方都能正常运行。 所有数据库设置都有默认设置。 数据库管理员或开发人员的主要职责是配置PostgreSQL以适合其系统负载。 在此博客中，我们将概述有关根据工作负载调整PostgreSQL数据库设置以提高数据库性能的基本建议。 <br><br> 请记住，虽然优化PostgreSQL服务器配置可以提高性能，但数据库设计人员在编写查询时也应小心。 如果查询执行可以使用索引的全表扫描，或者执行繁重的联接或昂贵的聚合操作，则即使数据库设置配置正确，系统仍可能无法正常工作。 在编写数据库查询时，重要的是要注意性能。 <br><br> 但是，数据库参数也非常重要，因此让我们看一下最有可能提高性能的八个参数。 <br><a name="habracut"></a><br><h2> 自定义PostgreSQL选项 </h2><br>  PostgreSQL使用自己的缓冲区，也使用缓冲的内核IO。 这意味着数据两次存储在内存中，首先在PostgreSQL缓冲区中，然后在内核缓冲区中。 与其他数据库不同，PostgreSQL不提供直接I / O。 这称为双缓冲。  PostgreSQL缓冲区称为<b>shared_buffer</b> ，它是大多数操作系统中最有效的自定义参数。 此参数设置PostgreSQL将用于缓存的已分配内存量。 <br><br>  shared_buffer的默认值设置得很低，您不会从中获得很多好处。 这是因为某些机器和操作系统不支持更高的值。 但是在大多数现代机器中，您需要增加此值以获得最佳性能。 <br><br> 推荐值是计算机总RAM的25％。 您应该尝试一些较低和较高的值，因为在某些情况下，设置超过25％可以获得良好的性能。 但是实际配置取决于您的机器和工作数据集。 如果您的工作数据集可以轻松放入RAM中，则可以增加shared_buffer的值，使其包含整个数据库，并且整个工作数据集都可以位于缓存中。 但是，您显然不想为PostgreSQL保留所有RAM。 <br><br> 值得注意的是，在生产环境中，尽管应始终执行测试以达到正确的平衡，但是良好的性能确实对shared_buffer至关重要。 <br><br>  <sup>检查shared_buffer的值</sup> <br><pre><code class="sql hljs">testdb=<span class="hljs-comment"><span class="hljs-comment"># SHOW shared_buffers; shared_buffers ---------------- 128MB (1 row)</span></span></code> </pre> <br>  <sub><b>注意</b> ：请小心，因为某些内核<b>不支持更大的值</b> ，尤其是在Windows上。</sub> <br><br><h3>  wal_buffers </h3><br>  PostgreSQL首先将WAL（预记录日志）中的条目写入缓冲区，然后将这些缓冲区刷新到磁盘。  <b>wal_buffers</b>定义的默认缓冲区大小为16 MB。 但是，如果您有许多并发连接，则更高的值可以提高性能。 <br><br><h3>  Effective_cache_size </h3><br>  <b>Effective_cache_size</b>提供了可用于磁盘缓存的内存的估计值。 这仅是一个准则，并非分配的内存或缓存的确切数量。 它不分配实际的内存，但告诉优化器内核中可用的缓存量。 如果此参数设置得太低，则查询计划程序可能会决定不使用某些索引，即使它们很有用。 因此，设置一个大的值总是有意义的。 <br><br><h3>  work_mem </h3><br> 此设置用于复杂的排序。 如果需要进行复杂的排序，请增加<b>work_mem</b>的值以获得良好的结果。 在内存中排序比在磁盘上排序数据快得多。 将其设置为很高的值可能会导致环境出现存储瓶颈，因为此选项与用户排序操作有关。 因此，如果有许多用户尝试执行排序操作，那么系统将突出显示： <br><br><pre> <code class="sql hljs">work_mem * total sort operations</code> </pre> <br> 适用于所有用户。 全局设置此参数会导致很高的内存使用率。 因此，强烈建议您在会话级别进行更改。 <br><br>  <sup>work_mem = 2MB</sup> <br><pre> <code class="sql hljs">testdb=<span class="hljs-comment"><span class="hljs-comment"># SET work_mem TO "2MB"; testdb=# EXPLAIN SELECT * FROM bar ORDER BY bar.b; QUERY PLAN ----------------------------------------------------------------------------------- Gather Merge (cost=509181.84..1706542.14 rows=10000116 width=24) Workers Planned: 4 -&gt; Sort (cost=508181.79..514431.86 rows=2500029 width=24) Sort Key: b -&gt; Parallel Seq Scan on bar (cost=0.00..88695.29 rows=2500029 width=24) (5 rows)</span></span></code> </pre> <br> 在514431.86评估初始请求排序节点。 成本是任意计算的单位。 对于以上请求，我们只有work_mem 2 MB。 为了进行测试，让我们将该值增加到256 MB，看看它是否影响成本。 <br><br>  <sup>work_mem = 256MB</sup> <br><pre> <code class="sql hljs">testdb=<span class="hljs-comment"><span class="hljs-comment"># SET work_mem TO "256MB"; testdb=# EXPLAIN SELECT * FROM bar ORDER BY bar.b; QUERY PLAN ----------------------------------------------------------------------------------- Gather Merge (cost=355367.34..1552727.64 rows=10000116 width=24) Workers Planned: 4 -&gt; Sort (cost=354367.29..360617.36 rows=2500029 width=24) Sort Key: b -&gt; Parallel Seq Scan on bar (cost=0.00..88695.29 rows=2500029 width=24)</span></span></code> </pre> <br> 请求成本从514431.86降低到360617.36，即降低了30％。 <br><br><h3>  maintenance_work_mem </h3><br>  <b>maintenance_work_mem</b>是用于维护任务的内存参数。 默认值为64 MB。 设置较大的值有助于完成诸如VACUUM，RESTORE，CREATE INDEX，ADID FOREIGN KEY和ALTER TABLE等任务。 <br><br>  <sup>maintenance_work_mem = 10MB</sup> <br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># CHECKPOINT; postgres=# SET maintenance_work_mem to '10MB'; postgres=# CREATE INDEX foo_idx ON foo (c); CREATE INDEX Time: 170091.371 ms (02:50.091)</span></span></code> </pre> <br><br>  <sup>maintenance_work_mem = 256MB</sup> <br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># CHECKPOINT; postgres=# set maintenance_work_mem to '256MB'; postgres=# CREATE INDEX foo_idx ON foo (c); CREATE INDEX Time: 111274.903 ms (01:51.275)</span></span></code> </pre> <br> 如果将maintenance_work_mem参数设置为仅10 MB，则索引创建时间为170091.371 ms，但是当将maintenance_work_mem参数增加至256 MB时，索引创建时间将减少为111274.903 ms。 <br><br><h3> 同步提交 </h3><br> 用于确保事务提交在向客户端返回成功完成状态之前等待WAL写入磁盘。 这是性能和可靠性之间的折衷。 如果您的应用程序的设计方式使性能比可靠性更为重要，请禁用<b>sync_commit</b> 。 在这种情况下，事务将很快提交，因为它不会等待WAL文件被重置，但是会损害可靠性。 如果服务器发生故障，即使客户端收到指示事务提交成功完成的消息，数据也可能会丢失。 <br><br><h3>  checkpoint_timeout，checkpoint_completion_target </h3><br>  PostgreSQL将更改写入WAL。 检查点进程将数据刷新到文件。 发生断点（CHECKPOINT）时执行此操作。 这是一项昂贵的操作，并且可能导致大量的IO操作。 这整个过程涉及昂贵的磁盘读/写操作。 用户始终可以在必要时启动检查点任务（CHECKPOINT），或使用<b>checkpoint_timeout</b>和<b>checkpoint_completion_target</b>参数自动启动该任务。 <br><br>  checkpoint_timeout参数用于设置WAL断点之间的时间。 将其设置得太低会减少故障后的恢复时间，因为有更多的数据正在写入磁盘，但也会降低性能，因为每个检查点最终都会消耗宝贵的系统资源。 <br><br>  checkpoint_completion_target是完成检查点的检查点之间的时间分数。 高频检查点会影响性能。 为了顺利完成检查点作业， <b>checkpoint_timeout</b>必须为低。 否则，操作系统将累积所有脏页，直到观察到该比率为止，然后产生较大的重置。 <br><br><h2> 结论 </h2><br> 您可以调整更多选项来获得更好的性能，但是它们的影响要小于此处突出显示的选项。 最后，我们必须始终记住，并非所有参数都与所有类型的应用程序相关。 设置选项时，某些应用程序可以更好地工作，而有些则不能。  PostgreSQL数据库设置必须根据应用程序及其运行所在的操作系统的特定需求进行调整。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN458952/">https://habr.com/ru/post/zh-CN458952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN458938/index.html">捆绑了C ++ 20，启动了C ++ 23。 科隆会议的结果</a></li>
<li><a href="../zh-CN458940/index.html">我们如何实施敏捷测试</a></li>
<li><a href="../zh-CN458944/index.html">雇用员工始于……尊重。 我们将采访工程师</a></li>
<li><a href="../zh-CN458948/index.html">《哈伯周刊》第8期/ Yandex Sorcerers，一本关于波斯王子的书，针对黑客的YouTube，五角大楼的“心脏”激光</a></li>
<li><a href="../zh-CN458950/index.html">使用示例在JavaScript中解析异步/等待</a></li>
<li><a href="../zh-CN458954/index.html">哪些类型的检测在视频监视中很有用。 机制与功能</a></li>
<li><a href="../zh-CN458956/index.html">机器学习与 分析方法</a></li>
<li><a href="../zh-CN458960/index.html">企业追求</a></li>
<li><a href="../zh-CN458962/index.html">将图像转换为声音-您会听到什么？</a></li>
<li><a href="../zh-CN458964/index.html">TestMace。 快速上手</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>