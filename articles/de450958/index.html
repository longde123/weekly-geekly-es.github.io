<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëºüèª ‚õé üíï AnyStub, Java-Verbindungsstubbibliothek üë©üèº‚Äçü§ù‚Äçüë®üèª üìÉ üñïüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im Gegensatz zu vielen Plattformen leidet Java unter einem Mangel an Verbindungsstubbibliotheken. Wenn Sie schon lange auf dieser Welt sind, sollten S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>AnyStub, Java-Verbindungsstubbibliothek</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450958/"><p> Im Gegensatz zu vielen Plattformen leidet Java unter einem Mangel an Verbindungsstubbibliotheken.  Wenn Sie schon lange auf dieser Welt sind, sollten Sie wahrscheinlich mit WireMock, Betamax oder sogar Spock vertraut sein.  Viele Entwickler in den Tests verwenden Mockito, um das Verhalten von Objekten zu beschreiben. DataJpaTest mit einer lokalen h2-Datenbank, Gurkentests.  Heute werden Sie eine leichte Alternative kennenlernen, die Ihnen hilft, mit verschiedenen Problemen umzugehen, die bei der Verwendung dieser Ans√§tze auftreten k√∂nnen.  Insbesondere versucht anyStub, die folgenden Probleme zu l√∂sen: </p><br><ul><li>  Vereinfachen Sie die Konfiguration der Testumgebung </li><li>  Automatisieren Sie die Datenerfassung f√ºr Tests </li><li>  Bleiben Sie beim Testen Ihrer Anwendung und vermeiden Sie das Testen auf etwas anderes </li></ul><a name="habracut"></a><br><h2 id="chto-takoe-anystub-i-kak-eto-rabotaet">  Was ist anyStub und wie funktioniert es? </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">AnyStub schlie√üt</a> Funktionsaufrufe ab und versucht, √ºbereinstimmende Anrufe zu finden, die bereits aufgezeichnet wurden.  Damit k√∂nnen zwei Dinge passieren: </p><br><ul><li>  Wenn ein √ºbereinstimmender Aufruf vorliegt, stellt anyStub das mit diesem Aufruf verkn√ºpfte aufgezeichnete Ergebnis wieder her und gibt es zur√ºck </li><li>  Wenn kein √ºbereinstimmender Anruf vorliegt und der Zugriff auf das externe System zul√§ssig ist, f√ºhrt anyStub diesen Anruf durch, zeichnet dieses Ergebnis auf und gibt es zur√ºck </li></ul><br><p>  AnyStub bietet standardm√§√üig Wrapper f√ºr den http-Client von Apache HttpClient zum Erstellen von Stubs f√ºr http-Anforderungen und mehrere Schnittstellen von javax.sql. * F√ºr DB-Verbindungen.  Sie erhalten auch eine API zum Erstellen von Stubs f√ºr andere Verbindungen. </p><br><p>  AnyStub ist eine einfache Klassenbibliothek und erfordert keine spezielle Konfiguration Ihrer Umgebung.  Diese Bibliothek ist f√ºr die Arbeit mit Spring-Boot-Anwendungen vorgesehen. Wenn Sie diesem Pfad folgen, erzielen Sie den gr√∂√ütm√∂glichen Nutzen.  Sie k√∂nnen es au√üerhalb von Spring in einfachen Java-Anwendungen verwenden, aber auf jeden Fall m√ºssen Sie zus√§tzliche Arbeit leisten.  Die folgende Beschreibung konzentriert sich auf das Testen von Spring-Boot-Anwendungen. </p><br><p>  Schauen wir uns die Integrationstests an.  Dies ist die aufregendste und umfassendste M√∂glichkeit, Ihr System zu testen.  Tats√§chlich erledigen Spring-Boot und JUnit fast alles f√ºr Sie, wenn Sie magische Anmerkungen schreiben: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span></code> </pre> <br><p>  Derzeit werden Integrationstests untersch√§tzt und in begrenztem Umfang verwendet, und einige Entwickler vermeiden sie.  Dies ist haupts√§chlich auf die zeitaufw√§ndige Vorbereitung und Wartung von Tests oder die Notwendigkeit einer speziellen Konfiguration der Umgebung auf Build-Servern zur√ºckzuf√ºhren. </p><br><p>  Mit anyStub m√ºssen Sie den Federkontex nicht l√§hmen.  Stattdessen ist es einfach und unkompliziert, den Kontext nahe an der Produktionskonfiguration zu halten. </p><br><p>  In diesem Beispiel wird anhand des Handbuchs von Pivotal gezeigt, wie Sie anyStub mit einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Consuming a RESTful-Webdienst</a> verbinden. </p><br><p>  Verbinden einer Bibliothek √ºber pom.xml </p><br><pre> <code class="java hljs"> &lt;dependency&gt; &lt;groupId&gt;org.anystub&lt;/groupId&gt; &lt;artifactId&gt;anystub&lt;/artifactId&gt; &lt;version&gt;<span class="hljs-number"><span class="hljs-number">0.2</span></span>.27&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt;</code> </pre> <br><p>  Der n√§chste Schritt besteht darin, den Federkontext zu √§ndern. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.http.StubHttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.http.client.HttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.http.impl.client.HttpClientBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.web.client.RestTemplateBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.web.client.RestTemplateCustomizer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.client.HttpComponentsClientHttpRequestFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.client.RestTemplate; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RestTemplateBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">builder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RestTemplateCustomizer restTemplateCustomizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestTemplateCustomizer() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">customize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span></span>{ HttpClient real = HttpClientBuilder.create().build(); StubHttpClient stubHttpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StubHttpClient(real); HttpComponentsClientHttpRequestFactory requestFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpComponentsClientHttpRequestFactory(); requestFactory.setHttpClient(stubHttpClient); restTemplate.setRequestFactory(requestFactory); } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestTemplateBuilder(restTemplateCustomizer); } }</code> </pre> <br><p>  Diese √Ñnderung √§ndert nicht die Komponentenbeziehungen in der Anwendung, sondern ersetzt nur die Implementierung einer einzelnen Schnittstelle.  Dies f√ºhrt uns zum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Barbara-Lisk-Substitutionsprinzip</a> .  Wenn das Design Ihrer Anwendung nicht dagegen verst√∂√üt, wird durch diese Ersetzung die Funktionalit√§t nicht verletzt. </p><br><p>  Alles ist fertig.  Dieses Projekt enth√§lt bereits einen Test. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RestTemplate restTemplate; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contextLoads</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertThat(restTemplate).isNotNull(); } }</code> </pre> <br><p>  Dieser Test ist leer, f√ºhrt jedoch bereits den Anwendungskontext aus.  <strong>Der Spa√ü beginnt hier</strong> .  Wie oben erw√§hnt, stimmt der Anwendungskontext im Test mit dem Arbeitskontext √ºberein, in dem der CommandLineRunner erstellt wird, in dem die http-Anforderung an das externe System ausgef√ºhrt wird. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = LoggerFactory.getLogger(Application.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String args[])</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(Application.class); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RestTemplate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplateBuilder builder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.build(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CommandLineRunner </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> args -&gt; { Quote quote = restTemplate.getForObject( <span class="hljs-string"><span class="hljs-string">"https://gturnquist-quoters.cfapps.io/api/random"</span></span>, Quote.class); log.info(quote.toString()); }; } }</code> </pre> <br><p>  Dies reicht aus, um die Funktionsweise der Bibliothek zu demonstrieren.  Nach dem ersten Start der Tests finden Sie die neue <code>complete/src/test/resources/anystub/stub.yml</code> . </p><br><pre> <code class="plaintext hljs">request0: exception: [] keys: [GET, HTTP/1.1, 'https://gturnquist-quoters.cfapps.io/api/random'] values: [HTTP/1.1, '200', OK, 'Content-Type: application/json;charset=UTF-8', 'Date: Thu, 25 Apr 2019 23:04:49 GMT', 'X-Vcap-Request-Id: 5ffce9f3-d972-4e95-6b5c-f88f9b0ae29b', 'Content-Length: 177', 'Connection: keep-alive', '{"type":"success","value":{"id":3,"quote":"Spring has come quite a ways in addressing developer enjoyment and ease of use since the last time I built an application using it."}}']</code> </pre> <br><p>  Was ist passiert?  spring-boot hat RestTemplateBuilder aus der Testkonfiguration in die Anwendung integriert.  Dies f√ºhrte dazu, dass die Anwendung die Stub-Implementierung des http-Clients durcharbeitete.  StubHttpClient hat die Anforderung abgefangen, die Stub-Datei nicht gefunden, die Anforderung ausgef√ºhrt, das Ergebnis in einer Datei gespeichert und das aus der Datei wiederhergestellte Ergebnis zur√ºckgegeben. </p><br><p>  Von nun an k√∂nnen Sie diesen Test ohne Internetverbindung ausf√ºhren, und diese Anforderung ist erfolgreich.  <code>restTemplate.getForObject()</code> gibt das gleiche Ergebnis zur√ºck.  Auf diese Tatsache k√∂nnen Sie sich bei Ihren zuk√ºnftigen Tests verlassen. </p><br><p>  Sie finden alle beschriebenen √Ñnderungen auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> . </p><br><p>  Tats√§chlich haben wir noch keinen einzigen Test erstellt.  Bevor wir Tests schreiben, schauen wir uns an, wie es mit Datenbanken funktioniert. </p><br><p>  In diesem Beispiel f√ºgen wir einen Integrationstest zum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Zugriff auf relationale Daten mit JDBC mit Spring</a> aus dem Pivotal-Lernprogramm hinzu. </p><br><p>  Die Testkonfiguration f√ºr diesen Fall sieht folgenderma√üen aus: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.jdbc.StubDataSource; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.h2.jdbcx.JdbcDataSource; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.sql.DataSource; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DataSource </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ JdbcDataSource ds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JdbcDataSource(); ds.setURL(<span class="hljs-string"><span class="hljs-string">"jdbc:h2:./test"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StubDataSource(ds); } }</code> </pre> <br><p>  Hier wird eine regul√§re Datenquelle f√ºr eine externe Datenbank erstellt und mit einer Stub-Implementierung - der StubDataSource-Klasse - umschlossen.  Spring-Boot bettet es in den Kontext ein.  Wir m√ºssen auch mindestens einen Test erstellen, um den Federkontext im Test auszuf√ºhren. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.AnyStubId; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.runner.RunWith; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.context.SpringBootTest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.test.context.junit4.SpringRunner; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.Assert.*; <span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Dies ist wieder ein leerer Test - seine einzige Aufgabe besteht darin, den Anwendungskontext auszuf√ºhren.  Hier sehen wir eine sehr wichtige Anmerkung <code>@AnystubId</code> , die jedoch noch nicht beteiligt ist. </p><br><p>  Nach dem ersten Durchlauf finden Sie eine neue <code>src/test/resources/anystub/stub.yml</code> , die alle Datenbankaufrufe enth√§lt.  Sie werden √ºberrascht sein, wie der Fr√ºhling hinter den Kulissen mit Datenbanken funktioniert.  Beachten Sie, dass neue Testl√§ufe nicht zu einem echten Zugriff auf die Datenbank f√ºhren.  Wenn Sie test.mv.db l√∂schen, wird es nach wiederholten Testl√§ufen nicht angezeigt.  Alle √Ñnderungen k√∂nnen auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> angezeigt werden. </p><br><p>  Zusammenfassend.  mit anyStub: </p><br><ul><li>  Sie m√ºssen keine spezielle Testumgebung einrichten </li><li>  Das Testen wird mit realen Daten durchgef√ºhrt </li><li>  Der erste Testlauf best√§tigt Ihre Annahmen und speichert die Testdaten. Die folgenden Tests √ºberpr√ºfen, ob das System nicht beeintr√§chtigt wurde </li></ul><br><p>  Sie haben wahrscheinlich Fragen: Wie werden F√§lle abgedeckt, in denen die Datenbank noch nicht vorhanden ist, was mit negativen Tests und der Ausnahmebehandlung zu tun ist.  Wir werden darauf zur√ºckkommen, aber zuerst werden wir uns mit dem Schreiben einfacher Tests befassen. </p><br><p>  Wir experimentieren jetzt mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Konsumieren eines RESTful-Webdienstes</a> .  Dieses Projekt enth√§lt keine Komponenten, die getestet werden k√∂nnen.  Im Folgenden werden zwei Klassen erstellt, die zwei Ebenen eines Architekturdesigns darstellen sollen. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.client.RestTemplate; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RestTemplate restTemplate; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataProvider</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.restTemplate = restTemplate; } <span class="hljs-function"><span class="hljs-function">Quote </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> restTemplate.getForObject( <span class="hljs-string"><span class="hljs-string">"https://gturnquist-quoters.cfapps.io/api/random"</span></span>, Quote.class); } }</code> </pre> <br><p>  DataProvider bietet Zugriff auf Daten in <del>  fl√ºchtig </del>  externes System. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DataProvider dataProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataProcessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataProvider dataProvider)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataProvider = dataProvider; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataProvider.provideData().getValue().getQuote().length(); } }</code> </pre> <br><p>  DataProcessor verarbeitet Daten von einem externen System. </p><br><p>  Wir beabsichtigen, den <code>DataProcessor</code> zu testen.  Es ist notwendig, die Richtigkeit des Verarbeitungsalgorithmus zu testen und das System vor einer Verschlechterung durch zuk√ºnftige √Ñnderungen zu sch√ºtzen. </p><br><p>  Um diese Ziele zu erreichen, k√∂nnen Sie ein DataProvider-Scheinobjekt mit einem Datensatz erstellen und in Tests an den DataProcessor-Konstruktor √ºbergeben.  Eine andere M√∂glichkeit k√∂nnte darin bestehen, den DataProcessor zu zerlegen, um die Verarbeitung der Quote-Klasse hervorzuheben.  Dann ist eine solche Klasse einfach mit Komponententests zu testen (dies ist sicherlich die empfohlene Methode in angesehenen B√ºchern √ºber sauberen Code).  Versuchen wir, Code√§nderungen und die Erfindung von Testdaten zu vermeiden und schreiben Sie einfach einen Test. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProcessorTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DataProcessor dataProcessor; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span>(filename = <span class="hljs-string"><span class="hljs-string">"stub"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">131</span></span>, dataProcessor.processData()); } }</code> </pre> <br><p>  Zeit, √ºber die Annotation @AnystubId zu sprechen.  Diese Anmerkung hilft beim Verwalten und Steuern von Stub-Dateien in Tests.  Es kann mit einer Testklasse oder ihrer Methode verwendet werden.  Diese Anmerkung erstellt eine individuelle Stub-Datei f√ºr den entsprechenden Bereich.  Wenn ein Bereich gleichzeitig von Annotationen auf Klassen- und Methodenebene abgedeckt wird, hat die Annotation der Methode Vorrang.  Diese Anmerkung enth√§lt den Parameter Dateiname, der den Namen der Stub-Datei definiert.  Die Erweiterung ".yml" wird automatisch hinzugef√ºgt, wenn sie weggelassen wird.  Wenn Sie diesen Test ausf√ºhren, finden Sie <strong>keine</strong> neue Datei.  Die <code>src/test/resources/anystub/stub.yml</code> wurde bereits fr√ºher erstellt und wird von diesem Test wiederverwendet.  Wir haben die Nummer 131 von diesem Stub erhalten, indem wir das Ergebnis der Abfrage analysiert haben. </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">131</span></span>, dataProcessor.processData()); Base base = getStub(); assertEquals(<span class="hljs-number"><span class="hljs-number">1</span></span>, base.times(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>)); assertTrue(base.history().findFirst().get().matchEx_to(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-string"><span class="hljs-string">".*gturnquist-quoters.cfapps.io.*"</span></span>)); }</code> </pre> <br><p>  In diesem Test wird die Annotation @AnyStubId ohne den Parameter Dateiname angezeigt.  In diesem Fall wird die <code>src/test/resources/anystubprocessDataTest2.yml</code> .  Der Dateiname wird aus dem Namen der Funktion (Klasse) + ".yml" erstellt.  Sobald anyStub eine neue Datei f√ºr diesen Test erstellt, m√ºssen Sie einen echten Systemaufruf durchf√ºhren.  Und es ist unser Gl√ºck, dass das neue Zitat die gleiche L√§nge hat.  Die letzten beiden √úberpr√ºfungen zeigen, wie das Verhalten der Anwendung getestet wird.  Es steht Ihnen zur Verf√ºgung: Abfragen nach Parametern oder Teilen von Parametern ausw√§hlen und die Anzahl der Abfragen z√§hlen.  In der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> finden Sie verschiedene Variationen der Zeiten <em>und √úbereinstimmungsfunktionen</em> . </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span>(requestMode = RequestMode.rmTrack) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">168</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); Base base = getStub(); assertEquals(<span class="hljs-number"><span class="hljs-number">4</span></span>, base.times(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>)); }</code> </pre> <br><p>  In diesem Test wird @AnyStubId mit dem neuen Parameter requestMode angezeigt.  Sie k√∂nnen damit Berechtigungen f√ºr Stub-Dateien verwalten.  Es gibt zwei Aspekte, die gesteuert werden m√ºssen: Dateisuche und Berechtigung zum Aufrufen eines externen Systems. </p><br><p>  <code>RequestMode.rmTrack</code> legt die folgenden Regeln fest: Wenn die Datei gerade erstellt wurde, werden alle Anforderungen an das externe System gesendet und mit den Antworten in die Datei geschrieben, unabh√§ngig davon, ob die Datei eine identische Anforderung enth√§lt (Duplikate in der Datei sind zul√§ssig).  Wenn vor dem Ausf√ºhren der Tests die Stub-Datei vorhanden ist, sind Anforderungen an das externe System verboten.  Anrufe werden in genau derselben Reihenfolge erwartet.  Wenn die n√§chste Anforderung nicht mit der Anforderung in der Datei √ºbereinstimmt, wird eine Ausnahme ausgel√∂st. </p><br><p>  <code>RequestMode.rmNew</code> dieser Modus ist standardm√§√üig aktiviert.  Jede Anforderung wird in der Stub-Datei durchsucht.  Wird eine √ºbereinstimmende Anforderung gefunden - das entsprechende Ergebnis wird aus der Datei wiederhergestellt, wird die Anforderung an das externe System verschoben.  Wird die Anforderung nicht gefunden, wird das externe System angefordert und das Ergebnis in einer Datei gespeichert.  Doppelte Anforderungen in der Datei - treten nicht auf. </p><br><p>  <code>RequestMode.rmNone</code> Jede Anfrage wird in einer Stub-Datei nachgeschlagen.  Wenn eine √ºbereinstimmende Abfrage gefunden wird, wird das Ergebnis aus der Datei wiederhergestellt.  Wenn der Test eine Anforderung generiert, die nicht in der Datei enthalten ist, wird eine Ausnahme ausgel√∂st. </p><br><p>  <code>RequestMode.rmAll</code> vor der ersten Anforderung wird die Stub-Datei gel√∂scht.  Alle Anforderungen werden in die Datei geschrieben (Duplikate in der Datei sind zul√§ssig).  Sie k√∂nnen diesen Modus verwenden, wenn Sie die Verbindungsarbeit beobachten m√∂chten. </p><br><p>  <code>RequestMode.rmPassThrough</code> alle Anforderungen werden direkt an das externe System gesendet, wobei der Implementierungsstub umgangen wird. </p><br><p>  Diese √Ñnderungen sind auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> verf√ºgbar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">.</a> </p><br><h1 id="chto-eschyo">  Was sonst? </h1><br><p>  Wir haben gesehen, wie anyStub Antworten speichert.  Wenn beim Zugriff auf ein externes System eine Ausnahme ausgel√∂st wird, speichert anyStub diese und spielt sie bei nachfolgenden Anforderungen ab. </p><br><p>  Oft werden Ausnahmen von Klassen der obersten Ebene ausgel√∂st, w√§hrend Verbindungsklassen eine g√ºltige Antwort erhalten (wahrscheinlich mit einem Fehlercode).  In diesem Fall ist anyStub daf√ºr verantwortlich, die Antwort mit dem Fehlercode zu reproduzieren, und die √ºbergeordneten Klassen l√∂sen auch Ausnahmen f√ºr Ihre Tests aus. </p><br><p>  F√ºgen Sie dem Repository Stub-Dateien hinzu. </p><br><p>  Haben Sie keine Angst, Stub-Dateien zu l√∂schen und zu √ºberschreiben. </p><br><p>  Verwalten Sie Stub-Dateien mit Bedacht.  Sie k√∂nnen eine Datei in mehreren Tests wiederverwenden oder f√ºr jeden Test eine eigene Datei bereitstellen.  Nutzen Sie diese Gelegenheit f√ºr Ihre Bed√ºrfnisse.  Normalerweise ist es jedoch eine schlechte Idee, eine einzelne Datei mit unterschiedlichen Zugriffsmodi zu verwenden. </p><br><p>  Dies sind alle Hauptfunktionen von anyStub. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de450958/">https://habr.com/ru/post/de450958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de450948/index.html">MU-MIMO: einer der Implementierungsalgorithmen</a></li>
<li><a href="../de450950/index.html">Dart Streams Grundlagen</a></li>
<li><a href="../de450952/index.html">Mittlerer Index und Antibank</a></li>
<li><a href="../de450954/index.html">Wie wir gelernt haben, Java in Docker auszunutzen</a></li>
<li><a href="../de450956/index.html">Vergleich der industriellen COB: ISIM vs. Kics</a></li>
<li><a href="../de450962/index.html">Insulinpumpen, manipulationssichere Mikrochips und softwaredefiniertes Radio</a></li>
<li><a href="../de450964/index.html">Neue x86 SIMD-Bibliothek - Immintrin-Debug</a></li>
<li><a href="../de450966/index.html">Video von einem alten Computer aufnehmen - Methoden von LGR</a></li>
<li><a href="../de450970/index.html">Wie man die Apple-Preise in den USA und in Russland wirklich vergleicht. Pers√∂nliche Erfahrung</a></li>
<li><a href="../de450972/index.html">Wie organisiere ich ein Fotostudio? Fall von Bolshakova Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>