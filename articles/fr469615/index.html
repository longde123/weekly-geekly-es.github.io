<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõí üë©üèª‚Äç‚öñÔ∏è üö¥ Temps de haute pr√©cision: comment travailler avec des fractions de seconde en MySQL et PHP üöÑ ü§∑üèª üë©üèª‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une fois que je me suis surpris √† penser que lorsque je travaillais avec le temps dans des bases de donn√©es, j'utilisais presque toujours du temps pr√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Temps de haute pr√©cision: comment travailler avec des fractions de seconde en MySQL et PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/469615/"><p><img src="https://habrastorage.org/webt/uu/43/0k/uu430kx8xpmnjcelv7obc41muik.jpeg"></p><br><p>  Une fois que je me suis surpris √† penser que lorsque je travaillais avec le temps dans des bases de donn√©es, j'utilisais presque toujours du temps pr√©cis √† la seconde simplement parce que j'√©tais habitu√© et que c'√©tait l'option d√©crite dans la documentation et un grand nombre d'exemples.  Cependant, cette pr√©cision est d√©sormais loin d'√™tre suffisante pour toutes les t√¢ches.  Les syst√®mes modernes sont complexes - ils peuvent √™tre constitu√©s de nombreuses parties, avoir des millions d'utilisateurs interagissant avec eux - et dans de nombreux cas, il est plus pratique d'utiliser une plus grande pr√©cision, dont le support existe depuis longtemps. </p><br><p>  Dans cet article, je parlerai des moyens d'utiliser le temps avec des parties fractionnaires d'une seconde dans MySQL et PHP.  Il a √©t√© con√ßu comme un tutoriel, donc le mat√©riel est con√ßu pour un large √©ventail de lecteurs et, √† certains endroits, r√©p√®te la documentation.  La valeur principale devrait √™tre que j'ai rassembl√© dans un seul texte tout ce que vous devez savoir pour travailler avec ce temps dans MySQL, PHP et le framework Yii, et j'ai √©galement ajout√© des descriptions des probl√®mes non √©vidents que vous pourriez rencontrer. </p><br><p>  J'utiliserai le terme ¬´temps de haute pr√©cision¬ª.  Dans la documentation MySQL, vous verrez le terme ¬´secondes fractionnelles¬ª, mais sa traduction litt√©rale semble √©trange, mais je n'ai pas trouv√© une autre traduction √©tablie. </p><a name="habracut"></a><br><h2 id="kogda-stoit-ispolzovat-vremya-vysokoy-tochnosti">  Quand utiliser le temps de haute pr√©cision? </h2><br><p>  Pour commencer, je vais montrer une capture d'√©cran de la bo√Æte de r√©ception de ma bo√Æte de r√©ception, qui illustre bien l'id√©e: </p><br><p><img src="https://habrastorage.org/webt/bc/tg/gx/bctggxr0qbeetqe9hmmb4zjmbom.png" alt="Deux lettres d'un exp√©diteur"></p><br><p>  Les lettres sont la r√©action d'une m√™me personne √† un √©v√©nement.  Un homme a accidentellement appuy√© sur le mauvais bouton, s'en est vite rendu compte et s'est corrig√©.  En cons√©quence, nous avons re√ßu deux lettres envoy√©es √† peu pr√®s en m√™me temps, qui sont importantes pour trier correctement.  Si l'heure d'envoi est la m√™me, il est possible que les lettres soient affich√©es dans le mauvais ordre et que le destinataire soit g√™n√©, car alors il recevra le mauvais r√©sultat pour lequel il comptera. </p><br><p>  Je suis tomb√© sur les situations suivantes dans lesquelles un temps de grande pr√©cision serait pertinent: </p><br><ol><li>  Vous souhaitez mesurer le temps entre certaines op√©rations.  Ici, tout est tr√®s simple: plus la pr√©cision des horodatages aux limites de l'intervalle est √©lev√©e, plus la pr√©cision du r√©sultat est √©lev√©e.  Si vous utilisez des secondes enti√®res, vous pouvez faire une erreur pendant 1 seconde (si vous tombez sur les fronti√®res des secondes).  Si vous utilisez six d√©cimales, l'erreur sera inf√©rieure de six ordres de grandeur. </li><li>  Vous avez une collection o√π il est probable qu'il y ait plusieurs objets avec le m√™me temps de cr√©ation.  Un exemple est un chat familier √† tout le monde, o√π la liste des contacts est tri√©e par heure du dernier message.  S'il appara√Æt une navigation page par page, il existe m√™me un risque de perte de contacts aux bordures de page.  Ce probl√®me peut √™tre r√©solu sans temps de haute pr√©cision gr√¢ce au tri et √† la pagination par une paire de champs (temps + identifiant unique d'un objet), mais cette solution a ses inconv√©nients (au moins la complication des requ√™tes SQL, mais pas seulement).  Augmenter la pr√©cision du temps contribuera √† r√©duire la probabilit√© de probl√®mes et √† √©viter de compliquer le syst√®me. </li><li> Vous devez conserver un historique des modifications de certains objets.  Ceci est particuli√®rement important dans le monde des services, o√π les modifications peuvent se produire en parall√®le et √† des endroits compl√®tement diff√©rents.  √Ä titre d'exemple, je peux travailler avec des photos de nos utilisateurs, o√π de nombreuses op√©rations diff√©rentes peuvent √™tre effectu√©es en parall√®le (l'utilisateur peut rendre la photo priv√©e ou la supprimer, elle peut √™tre mod√©r√©e dans l'un des nombreux syst√®mes, recadr√©e pour √™tre utilis√©e comme photo dans le chat, etc.). ) </li></ol><br><p>  Il faut garder √† l'esprit que l'on ne peut pas croire les valeurs obtenues √† 100% et la pr√©cision r√©elle des valeurs obtenues peut √™tre inf√©rieure √† six d√©cimales.  Cela est d√ª au fait que nous pouvons obtenir une valeur d'heure inexacte (en particulier lorsque vous travaillez dans un syst√®me distribu√© compos√© de nombreux serveurs), l'heure peut changer de mani√®re inattendue (par exemple, lors de la synchronisation via NTP ou lors du changement d'horloge), etc. Je ne m'attarderai pas sur tous ces probl√®mes, mais je donnerai quelques articles o√π vous pourrez en savoir plus √† leur sujet: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Id√©es fausses des programmeurs sur le temps¬ª</a> (l'article lui-m√™me est tr√®s minimaliste, mais en plus des r√©sum√©s du texte, des explications peuvent √™tre trouv√©es dans les commentaires); </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"La lourde charge de temps</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"</a> </li></ul><br><h2 id="rabota-so-vremenem-vysokoy-tochnosti-v-mysql">  Travailler avec un temps de haute pr√©cision dans MySQL </h2><br><p> MySQL prend en charge trois types de colonnes dans lesquelles l'heure peut √™tre stock√©e: <code>TIME</code> , <code>DATETIME</code> et <code>TIMESTAMP</code> .  Initialement, ils ne pouvaient stocker que des valeurs qui √©taient des multiples d'une seconde (par exemple, 2019-08-14 19:20:21).  Dans la version 5.6.4, sortie en d√©cembre 2011, il est devenu possible de travailler avec la fraction de seconde.  Pour ce faire, lors de la cr√©ation de la colonne, vous devez sp√©cifier le nombre de d√©cimales, qui doivent √™tre stock√©es dans la partie fractionnaire de l'horodatage.  Le nombre maximal de caract√®res pris en charge est de six, ce qui vous permet de stocker un temps pr√©cis √† la microseconde pr√®s.  Si vous essayez d'utiliser plus de caract√®res, vous obtenez une erreur. </p><br><p>  Un exemple: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`ChatContactsList`</span></span> ( <span class="hljs-string"><span class="hljs-string">`chat_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-string"><span class="hljs-string">`title`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`last_message_send_time`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span>; Query OK, 0 rows affected (0.02 sec) Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`ChatContactsList`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MODIFY</span></span> last_message_send_time <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ERROR 1426 (42000): Too-big precision 9 specified for 'last_message_send_time'. Maximum is 6. Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`ChatContactsList`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MODIFY</span></span> last_message_send_time <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; Query OK, 0 rows affected (0.09 sec) Records: 0 Duplicates: 0 Warnings: 0 Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> ChatContactsList (title, last_message_send_time) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'Chat #1'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>()); Query OK, 1 row affected (0.03 sec) Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList; +<span class="hljs-comment"><span class="hljs-comment">---------+---------+-------------------------+ | chat_id | title | last_message_send_time | +---------+---------+-------------------------+ | 1 | Chat #1 | 2019-09-22 22:23:15.000 | +---------+---------+-------------------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  Dans cet exemple, l'horodatage de l'enregistrement ins√©r√© a une fraction nulle.  Cela s'est produit car la valeur d'entr√©e a √©t√© indiqu√©e √† la seconde pr√®s.  Pour r√©soudre le probl√®me, la pr√©cision de la valeur d'entr√©e doit √™tre identique √† celle de la base de donn√©es.  Le conseil semble √©vident, mais il est pertinent, car un probl√®me similaire peut appara√Ætre dans les applications r√©elles: nous √©tions confront√©s √† une situation o√π la valeur d'entr√©e avait trois d√©cimales et six √©taient stock√©es dans la base de donn√©es. </p><br><p>  Le moyen le plus simple d'√©viter ce probl√®me est d'utiliser les valeurs d'entr√©e avec une pr√©cision maximale (jusqu'√† quelques microsecondes).  Dans ce cas, lors de l'√©criture des donn√©es dans la table, l'heure sera arrondie √† la pr√©cision requise.  Il s'agit d'une situation tout √† fait normale qui ne provoquera aucun avertissement: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> last_message_send_time=<span class="hljs-string"><span class="hljs-string">"2019-09-22 22:23:15.2345"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> chat_id=<span class="hljs-number"><span class="hljs-number">1</span></span>; Query OK, 1 row affected (0.00 sec) Rows matched: 1 Changed: 1 Warnings: 0 Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList; +<span class="hljs-comment"><span class="hljs-comment">---------+---------+-------------------------+ | chat_id | title | last_message_send_time | +---------+---------+-------------------------+ | 1 | Chat #1 | 2019-09-22 22:23:15.235 | +---------+---------+-------------------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  Lorsque vous utilisez l'initialisation automatique et la mise √† jour automatique des colonnes TIMESTAMP √† l'aide d'une structure de la forme <code>DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</code> il est important que les valeurs aient la m√™me pr√©cision que la colonne elle-m√™me: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>; ERROR 1067 (42000): Invalid default value for 'updated' Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>); ERROR 1067 (42000): Invalid default value for 'updated' Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CURRENT_TIMESTAMP</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>); Query OK, 0 rows affected (0.07 sec) Records: 0 Duplicates: 0 Warnings: 0 Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> last_message_send_time=<span class="hljs-string"><span class="hljs-string">'2019-09-22 22:22:22'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> chat_id=<span class="hljs-number"><span class="hljs-number">1</span></span>; Query OK, 0 rows affected (0.00 sec) Rows matched: 1 Changed: 0 Warnings: 0 Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList; +<span class="hljs-comment"><span class="hljs-comment">---------+---------+-------------------------+-------------------------+ | chat_id | title | last_message_send_time | updated | +---------+---------+-------------------------+-------------------------+ | 1 | Chat #1 | 2019-09-22 22:22:22.000 | 2019-09-22 22:26:39.968 | +---------+---------+-------------------------+-------------------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  Les fonctions MySQL pour travailler dans le temps permettent de travailler avec la partie fractionnaire des unit√©s de mesure.  Je ne les √©num√©rerai pas tous (je sugg√®re de regarder dans la documentation), mais je donnerai quelques exemples: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) + <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-number"><span class="hljs-number">7.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>; +<span class="hljs-comment"><span class="hljs-comment">------------------------+--------------------------+------------------------------+ | NOW(2) | NOW(4) | NOW(4) + INTERVAL 7.5 SECOND | +------------------------+--------------------------+------------------------------+ | 2019-09-22 21:12:23.31 | 2019-09-22 21:12:23.3194 | 2019-09-22 21:12:30.8194 | +------------------------+--------------------------+------------------------------+ 1 row in set (0.00 sec) Test&gt; SELECT SUBTIME(CURRENT_TIME(6), CURRENT_TIME(3)), CURRENT_TIME(6), CURRENT_TIME(3); +-------------------------------------------+-----------------+-----------------+ | SUBTIME(CURRENT_TIME(6), CURRENT_TIME(3)) | CURRENT_TIME(6) | CURRENT_TIME(3) | +-------------------------------------------+-----------------+-----------------+ | 00:00:00.000712 | 21:12:50.793712 | 21:12:50.793 | +-------------------------------------------+-----------------+-----------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  Le principal probl√®me associ√© √† l'utilisation de la partie fractionnaire des secondes dans les requ√™tes SQL est l'incoh√©rence de la pr√©cision dans les comparaisons ( <code>&gt;</code> , <code>&lt;</code> , <code>BETWEEN</code> ).  Vous pouvez le rencontrer si les donn√©es de la base de donn√©es ont une pr√©cision et dans les requ√™tes - une autre.  Voici un petit exemple illustrant ce probl√®me: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">#         Test&gt; INSERT INTO ChatContactsList (title, last_message_send_time) VALUES ('Chat #2', '2019-09-22 21:16:39.123456'); Query OK, 0 row affected (0.00 sec) Test&gt; SELECT chat_id, title, last_message_send_time FROM ChatContactsList WHERE title='Chat #2'; +---------+---------+-------------------------+ | chat_id | title | last_message_send_time | +---------+---------+-------------------------+ | 2 | Chat #2 | 2019-09-22 21:16:39.123 | &lt;-     - ,    +---------+---------+-------------------------+ 1 row in set (0.00 sec) Test&gt; SELECT title, last_message_send_time FROM ChatContactsList WHERE last_message_send_time &gt;= '2019-09-22 21:16:39.123456'; &lt;-    ,    INSERT- +---------+-------------------------+ | title | last_message_send_time | +---------+-------------------------+ | Chat #1 | 2019-09-22 22:22:22.000 | +---------+-------------------------+ 1 row in set (0.00 sec) &lt;- Chat #2   - ,     ,    </span></span></code> </pre> <br><p>  Dans cet exemple, la pr√©cision des valeurs de la requ√™te est sup√©rieure √† la pr√©cision des valeurs de la base de donn√©es et le probl√®me se produit ¬´√† la fronti√®re par le haut¬ª.  Dans la situation oppos√©e (si la valeur d'entr√©e a une pr√©cision inf√©rieure √† la valeur dans la base de donn√©es), il n'y aura pas de probl√®me - MySQL apportera la valeur √† la pr√©cision souhait√©e dans INSERT et SELECT: </p><br><pre> <code class="sql hljs">Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> ChatContactsList (title, last_message_send_time) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'Chat #3'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-09-03 21:20:19.1'</span></span>); Query OK, 1 row affected (0.00 sec) Test&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> title, last_message_send_time <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> last_message_send_time &lt;= <span class="hljs-string"><span class="hljs-string">'2019-09-03 21:20:19.1'</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------+-------------------------+ | title | last_message_send_time | +---------+-------------------------+ | Chat #3 | 2019-09-03 21:20:19.100 | +---------+-------------------------+ 1 row in set (0.00 sec)</span></span></code> </pre> <br><p>  La coh√©rence de l'exactitude des valeurs doit toujours √™tre gard√©e √† l'esprit lorsque vous travaillez avec un temps de haute pr√©cision.  Si ces probl√®mes de limites sont critiques pour vous, vous devez vous assurer que le code et la base de donn√©es fonctionnent avec le m√™me nombre de d√©cimales. </p><br><div class="spoiler">  <b class="spoiler_title">R√©flexions sur le choix de la pr√©cision dans les colonnes avec des parties fractionnaires de secondes</b> <div class="spoiler_text"><p>  La quantit√© d'espace occup√©e par la partie fractionnaire d'une unit√© de temps d√©pend du nombre de caract√®res dans la colonne.  Il semble naturel de choisir des significations famili√®res: trois ou six d√©cimales.  Mais dans le cas de trois personnages, ce n'est pas si simple.  En fait, MySQL utilise un octet pour stocker deux d√©cimales: </p><br><blockquote><div class="scrollable-table"><table><thead><tr><th>  Pr√©cision fractionnelle en secondes </th><th>  Exigences de stockage </th></tr></thead><tbody><tr><td>  0 </td><td>  0 octets </td></tr><tr><td>  1, 2 </td><td>  1 octet </td></tr><tr><td>  3, 4 </td><td>  2 octets </td></tr><tr><td>  5, 6 </td><td>  3 octets </td></tr></tbody></table></div><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exigences de stockage de type de date et d'heure</a> </blockquote><p>  Il s'av√®re que si vous s√©lectionnez trois d√©cimales, vous n'utilisez pas pleinement l'espace occup√© et pour la m√™me surcharge, vous pouvez prendre quatre caract√®res.  En g√©n√©ral, je vous recommande de toujours utiliser un nombre pair de caract√®res et, si n√©cessaire, de ¬´rogner¬ª ceux qui ne sont pas n√©cessaires lors de la sortie.  L'option id√©ale est de ne pas √™tre gourmand et de prendre six d√©cimales.  Dans le pire des cas (avec le type DATETIME), cette colonne occupera 8 octets, c'est-√†-dire la m√™me chose que l'entier dans la colonne BIGINT. </p></div></div><br><p>  Voir aussi: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Secondes fractionnaires dans les valeurs temporelles¬ª</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Initialisation et mise √† jour automatiques pour TIMESTAMP et DATETIME¬ª</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Fonctions de date et d'heure¬ª</a> . </li></ul><br><h2 id="rabota-so-vremenem-vysokoy-tochnosti-v-php">  Travailler avec un temps de haute pr√©cision en PHP </h2><br><p>  Il ne suffit pas d'avoir du temps de haute pr√©cision dans la base de donn√©es - vous devez pouvoir travailler avec lui dans le code de vos programmes.  Dans cette section, je parlerai de trois points principaux: </p><br><ol><li>  R√©ception et formatage de l'heure: je vais expliquer comment obtenir l'horodatage avant de le mettre dans la base de donn√©es, de le r√©cup√©rer √† partir de l√† et de faire une sorte de manipulation. </li><li>  Travailler avec le temps dans PDO: je vais vous montrer un exemple de la fa√ßon dont PHP prend en charge le formatage du temps dans une biblioth√®que de base de donn√©es. </li><li>  Travailler avec le temps dans les frameworks: je vais parler de l'utilisation du temps dans les migrations pour changer la structure de la base de donn√©es. </li></ol><br><h3 id="poluchenie-i-formatirovanie-vremeni">  Obtention et formatage de l'heure </h3><br><p>  Lorsque vous travaillez avec le temps, vous devez pouvoir effectuer plusieurs op√©rations de base: </p><br><ul><li>  obtenir l'heure actuelle; </li><li>  obtenir un instant dans le temps d'une cha√Æne format√©e; </li><li>  ajouter une p√©riode √† un point dans le temps (ou soustraire une p√©riode); </li><li>  obtenir une cha√Æne format√©e pour un point dans le temps. </li></ul><br><p>  Dans cette partie, je vais vous dire quelles sont les possibilit√©s pour effectuer ces op√©rations en PHP. </p><br><p>  La premi√®re consiste √† travailler avec <strong>un horodatage sous forme de nombre</strong> .  Dans ce cas, dans le code PHP, nous travaillons avec des variables num√©riques, que nous op√©rons √† travers des fonctions telles que l' <code>time</code> , la <code>date</code> , <code>strtotime</code> .  Cette m√©thode ne peut pas √™tre utilis√©e pour travailler avec un temps de haute pr√©cision, car dans toutes ces fonctions, les horodatages sont un entier (ce qui signifie que la partie fractionnelle en eux sera perdue). </p><br><p>  Voici les signatures des principales fonctions de la documentation officielle: </p><br><blockquote> <code>time ( void ) : int</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.php.net/manual/ru/function.time.php</a> <br><br> <code>strtotime ( string $time [, int $now = time() ] ) : int</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://php.net/manual/ru/function.strtotime.php</a> <br><br> <code>date ( string $format [, int $timestamp = time() ] ) : string</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://php.net/manual/ru/function.date.php</a> <br><br> <code>strftime ( string $format [, int $timestamp = time() ] ) : string</code> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.php.net/manual/ru/function.strftime.php</a> </blockquote><br><div class="spoiler">  <b class="spoiler_title">Un point int√©ressant sur la fonction date</b> <div class="spoiler_text"><p>  Bien qu'il soit impossible de passer la fraction de seconde √† l'entr√©e de ces fonctions, dans la ligne du mod√®le de formatage pass√© √† l'entr√©e de la fonction <code>date</code> , vous pouvez d√©finir des caract√®res pour afficher les millisecondes et microsecondes.  Lors du formatage, les z√©ros seront toujours renvoy√©s √† leur place. </p><br><div class="scrollable-table"><table><thead><tr><th>  Caract√®re au format cha√Æne </th><th>  La description </th><th>  Exemple de valeur de retour </th></tr></thead><tbody><tr><td>  u </td><td>  Microsecondes (ajout√©es en PHP 5.2.2).  Notez que date () renverra toujours 000000, comme  il prend un param√®tre entier, alors que DateTime :: format () prend en charge les microsecondes si DateTime est cr√©√© avec eux. </td><td>  Par exemple: 654321 </td></tr><tr><td>  v </td><td>  Millisecondes (ajout√© en PHP 7.0.0).  La remarque est la m√™me que pour u. </td><td>  Par exemple: 654 </td></tr></tbody></table></div><br><p>  Un exemple: </p><br><pre> <code class="php hljs">$now = time(); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> date(<span class="hljs-string"><span class="hljs-string">'Ymd H:i:s.u'</span></span>, $now); <span class="hljs-comment"><span class="hljs-comment">// 2019-09-11 21:27:18.000000 print date('Ymd H:i:s.v', $now); // 2019-09-11 21:27:18.000</span></span></code> </pre> </div></div><br><p>  Cette m√©thode inclut <code>microtime</code> <code>hrtime</code> <code>microtime</code> et <code>hrtime</code> , qui vous permettent d'obtenir un <code>hrtime</code> avec une partie fractionnaire pour l'instant en cours.  Le probl√®me est qu'il n'existe aucun moyen pr√™t √† l'emploi pour formater une telle √©tiquette et l'obtenir √† partir d'une cha√Æne d'un format sp√©cifique.  Cela peut √™tre r√©solu en impl√©mentant ind√©pendamment ces fonctions, mais je n'envisagerai pas une telle option. </p><br><blockquote>  Si vous devez travailler uniquement avec des minuteries, la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HRTime</a> est une bonne option, que je ne consid√©rerai pas plus en d√©tail en raison des limites de son utilisation.  Je peux seulement dire qu'il vous permet de travailler avec du temps √† la nanoseconde et garantit la monotonie des minuteries, ce qui √©limine certains des probl√®mes qui peuvent √™tre rencontr√©s lorsque vous travaillez avec d'autres biblioth√®ques. </blockquote><p>  Pour travailler pleinement avec des parties fractionnaires d'une seconde, vous devez utiliser le module <strong>DateTime</strong> .  Sous certaines r√©serves, il vous permet d'effectuer toutes les op√©rations list√©es ci-dessus: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//    : $time = new \DateTimeImmutable(); //      : $time = new \DateTimeImmutable('2019-09-12 21:32:43.908502'); $time = \DateTimeImmutable::createFromFormat('Ymd H:i:s.u', '2019-09-12 21:32:43.9085'); // / : $period = \DateInterval::createFromDateString('5 seconds'); $timeBefore = $time-&gt;add($period); $timeAfter = $time-&gt;sub($period); //      : print $time-&gt;format('Ymd H:i:s.v'); // '2019-09-12 21:32:43.908' print $time-&gt;format("Ymd H:i:su"); // '2019-09-12 21:32:43.908502'</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Le point non √©vident lors de l'utilisation de `DateTimeImmutable :: createFromFormat`</b> <div class="spoiler_text"><p>  La lettre <code>u</code> dans la cha√Æne de format signifie microsecondes, mais elle fonctionne √©galement correctement dans le cas de parties fractionnaires de moindre pr√©cision.  De plus, c'est le seul moyen de sp√©cifier des parties fractionnaires d'une seconde dans une cha√Æne de format.  Un exemple: </p><br><pre> <code class="php hljs">$time = \DateTimeImmutable::createFromFormat(<span class="hljs-string"><span class="hljs-string">'Ymd H:i:s.u'</span></span>, <span class="hljs-string"><span class="hljs-string">'2019-09-12 21:32:43.9085'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// =&gt;   DateTimeImmutable    2019-09-12 21:32:43.908500 $time = \DateTimeImmutable::createFromFormat('Ymd H:i:s.u', '2019-09-12 21:32:43.90'); // =&gt;   DateTimeImmutable    2019-09-12 21:32:43.900000 $time = \DateTimeImmutable::createFromFormat('Ymd H:i:s.u', '2019-09-12 21:32:43'); // =&gt;  false</span></span></code> </pre> </div></div><br><p>  Le principal probl√®me de ce module est l'inconv√©nient de travailler avec des intervalles contenant des fractions de seconde (voire l'impossibilit√© d'un tel travail).  La <code>\DateInterval</code> bien qu'elle contienne la partie fractionnaire d'une seconde pr√©cise aux m√™mes six d√©cimales, vous ne pouvez initialiser cette partie fractionnaire que par <code>DateTime::diff</code> .  Le constructeur de la classe DateInterval et la m√©thode d'usine <code>\DateInterval::createFromDateString</code> ne peuvent fonctionner qu'avec des secondes enti√®res et ne permettent pas de sp√©cifier la partie fractionnaire: </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     -   $buggyPeriod1 = new \DateInterval('PT7.500S'); //       ,    $buggyPeriod2 = \DateInterval::createFromDateString('2 minutes 7.5 seconds'); print $buggyPeriod2-&gt;format('%R%H:%I:%S.%F') . PHP_EOL; //  "+00:02:00.000000"</span></span></code> </pre> <br><p>  Un autre probl√®me peut survenir lors du calcul de la diff√©rence entre deux points dans le temps √† l'aide de la m√©thode <code>\DateTimeImmutable::diff</code> .  En PHP avant la version 7.2.12, il y avait un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bug √†</a> cause duquel les parties fractionnaires d'une seconde existaient s√©par√©ment des autres chiffres et pouvaient recevoir leur propre signe: </p><br><pre> <code class="php hljs">$timeBefore = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTimeImmutable(<span class="hljs-string"><span class="hljs-string">'2019-09-12 21:20:19.987654'</span></span>); $timeAfter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTimeImmutable(<span class="hljs-string"><span class="hljs-string">'2019-09-14 12:13:14.123456'</span></span>); $diff = $timeBefore-&gt;diff($timeAfter); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> $diff-&gt;format(<span class="hljs-string"><span class="hljs-string">'%R%a days %H:%I:%S.%F'</span></span>) . PHP_EOL; <span class="hljs-comment"><span class="hljs-comment">//  PHP  7.2.12+   "+1 days 14:52:54.135802" //       "+1 days 14:52:55.-864198"</span></span></code> </pre> <br><p>  En g√©n√©ral, je vous conseille d'√™tre prudent lorsque vous travaillez avec des intervalles et de couvrir soigneusement ce code avec des tests. </p><br><p>  Voir aussi: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Date et heure"</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Fonction Hrtime."</a> </li></ul><br><h3 id="rabota-so-vremenem-vysokoy-tochnosti-v-pdo">  Travailler avec un temps de haute pr√©cision dans PDO </h3><br><p>  PDO et mysqli sont les deux principales interfaces pour interroger les bases de donn√©es MySQL √† partir du code PHP.  Dans le contexte d'une conversation sur le temps, ils sont similaires les uns aux autres, donc je ne parlerai que de l'un d'eux - AOP. </p><br><p>  Lorsque vous travaillez avec des bases de donn√©es dans PDO, l'heure appara√Æt √† deux endroits: </p><br><ul><li>  en tant que param√®tre pass√© aux requ√™tes ex√©cut√©es; </li><li>  comme une valeur qui vient en r√©ponse aux requ√™tes SELECT. </li></ul><br><p>  Il est recommand√© de passer des espaces r√©serv√©s lors du passage de param√®tres √† la demande.  Les espaces r√©serv√©s peuvent transf√©rer des valeurs √† partir d'un tr√®s petit ensemble de types: valeurs bool√©ennes, cha√Ænes et entiers.  Il n'y a pas de type appropri√© pour la date et l'heure, vous devez donc convertir manuellement la valeur d'un objet de la classe DateTime / DateTimeImmutable en une cha√Æne. </p><br><pre> <code class="php hljs">$now = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTimeImmutable(); $db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \PDO(<span class="hljs-string"><span class="hljs-string">'mysql:...'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>, [\PDO::ATTR_ERRMODE =&gt; \PDO::ERRMODE_EXCEPTION]); $stmt = $db-&gt;prepare(<span class="hljs-string"><span class="hljs-string">'INSERT INTO Test.ChatContactsList (title, last_message_send_time) VALUES (:title, :date)'</span></span>); $result = $stmt-&gt;execute([<span class="hljs-string"><span class="hljs-string">':title'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Test #1"</span></span>, <span class="hljs-string"><span class="hljs-string">':date'</span></span> =&gt; $now-&gt;format(<span class="hljs-string"><span class="hljs-string">'Ymd H:i:s.u'</span></span>)]);</code> </pre> <br><p>  L'utilisation d'un tel code n'est pas tr√®s pratique, car √† chaque fois vous devez formater la valeur transmise.  Par cons√©quent, dans la base de code Badoo, nous avons impl√©ment√© la prise en charge des espaces r√©serv√©s typ√©s dans notre wrapper pour travailler avec la base de donn√©es.  Dans le cas des dates, cela est tr√®s pratique, car il vous permet de transf√©rer une valeur dans diff√©rents formats (un objet qui impl√©mente DateTimeInterface, une cha√Æne format√©e ou un nombre avec un horodatage), et toutes les transformations et v√©rifications n√©cessaires de l'exactitude des valeurs transf√©r√©es sont d√©j√† effectu√©es √† l'int√©rieur.  En prime, lors du transfert d'une valeur incorrecte, nous apprenons l'erreur imm√©diatement, et non apr√®s avoir re√ßu une erreur de MySQL lors de l'ex√©cution de la requ√™te. </p><br><p>  La r√©cup√©ration de donn√©es √† partir des r√©sultats de requ√™te semble assez simple.  Lors de l'ex√©cution de cette op√©ration, PDO renvoie les donn√©es sous forme de cha√Ænes, et dans le code, nous devons continuer √† traiter les r√©sultats si nous voulons travailler avec des objets temporels (et ici, nous avons besoin de la fonctionnalit√© pour obtenir l'heure de la cha√Æne format√©e, dont j'ai parl√© dans la section pr√©c√©dente). </p><br><pre> <code class="php hljs">$stmt = $db-&gt;prepare(<span class="hljs-string"><span class="hljs-string">'SELECT * FROM Test.ChatContactsList ORDER BY last_message_send_time DESC, chat_id DESC LIMIT 5'</span></span>); $stmt-&gt;execute(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)) { $row[<span class="hljs-string"><span class="hljs-string">'last_message_send_time'</span></span>] = is_null($row[<span class="hljs-string"><span class="hljs-string">'last_message_send_time'</span></span>]) ? <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \DateTimeImmutable($row[<span class="hljs-string"><span class="hljs-string">'last_message_send_time'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">//  -  }</span></span></code> </pre> <br><blockquote>  Remarque <br><br>  Le fait que PDO renvoie des donn√©es sous forme de cha√Ænes n'est pas enti√®rement vrai.  Lors de la r√©ception de valeurs, il est possible de d√©finir le type de valeur pour la colonne √† l'aide de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>PDOStatement::bindColumn</code></a> .  Je n'en ai pas parl√© car il y a le m√™me ensemble limit√© de types qui n'aide pas avec les dates. </blockquote><p>  Malheureusement, il y a un probl√®me √† prendre en compte.  En PHP avant la version 7.3, il y a un bogue √† cause duquel PDO, lorsque l'attribut <code>PDO::ATTR_EMULATE_PREPARES</code> est <code>PDO::ATTR_EMULATE_PREPARES</code> "coupe" la partie fractionnaire d'une seconde lorsqu'il est re√ßu de la base de donn√©es.  Des d√©tails et un exemple peuvent √™tre trouv√©s dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">description</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bogue sur php.net</a> .  En PHP 7.3, cette erreur a √©t√© corrig√©e et a averti que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce changement rompt la compatibilit√© descendante</a> . </p><br><p>  Si vous utilisez PHP version 7.2 ou ant√©rieure et n'√™tes pas en mesure de le mettre √† jour ou d'activer <code>PDO::ATTR_EMULATE_PREPARES</code> , vous pouvez contourner ce bogue en corrigeant les requ√™tes SQL qui renvoient l'heure avec une partie fractionnaire afin que cette colonne ait un type de cha√Æne.  Cela peut √™tre fait, par exemple, comme ceci: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(last_message_send_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> last_message_send_time_fixed <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ChatContactsList <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> last_message_send_time <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><p>  Ce probl√®me peut √©galement √™tre rencontr√© lorsque vous travaillez avec le module <code>mysqli</code> : si vous utilisez des requ√™tes pr√©par√©es via un appel √† la m√©thode <code>mysqli::prepare</code> , puis en PHP avant la version 7.3, la partie fractionnaire d'une seconde ne sera pas retourn√©e.  Comme avec PDO, vous pouvez r√©soudre ce probl√®me en mettant √† jour PHP ou en contournant la conversion temporelle en type de cha√Æne. </p><br><p>  Voir aussi: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Requ√™tes pr√©par√©es et proc√©dures stock√©es dans PDO"</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Requ√™tes pr√©par√©es dans mysqli"</a> ; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation sur la m√©thode mysqli_stmt :: bind_param</a> (ici les types d'espaces r√©serv√©s support√©s dans mysqli sont d√©crits); </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pool de requ√™tes √† PHP, dans lequel ils ont fix√© la "troncature" de la partie fractionnaire de secondes</a> . </li></ul><br><h3 id="rabota-so-vremenem-vysokoy-tochnosti-v-yii-2">  Travailler avec un temps de haute pr√©cision dans Yii 2 </h3><br><p>  La plupart des frameworks modernes fournissent une fonctionnalit√© de migration qui vous permet de stocker l'historique des modifications de sch√©ma de base de donn√©es dans le code et de le modifier de mani√®re incr√©mentielle.  Si vous utilisez des migrations et souhaitez utiliser du temps de haute pr√©cision, votre framework doit le prendre en charge.  Heureusement, cela fonctionne d√®s le d√©part dans tous les principaux cadres. </p><br><p>  Dans cette section, je montrerai comment ce support est impl√©ment√© dans Yii (dans les exemples j'ai utilis√© la version 2.0.26).  √Ä propos de Laravel, Symfony et d'autres, je n'√©crirai pas afin de ne pas rendre l'article sans fin, mais je serai heureux si vous ajoutez des d√©tails dans les commentaires ou les nouveaux articles sur ce sujet. </p><br><p>  Dans la migration, nous √©crivons du code qui d√©crit les modifications apport√©es au sch√©ma de donn√©es.  Lors de la cr√©ation d'une nouvelle table, nous d√©crivons toutes ses colonnes √† l'aide de m√©thodes sp√©ciales de la classe \ yii \ db \ Migration (elles sont d√©clar√©es dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">barre SchemaBuilderTrait</a> ).  Les m√©thodes <code>time</code> , <code>timestamp</code> et <code>datetime</code> qui peuvent prendre une valeur d'entr√©e de pr√©cision sont responsables de la description des colonnes contenant la date et l'heure. </p><br><p>  Exemple de migration dans laquelle une nouvelle table est cr√©√©e avec une colonne de temps de haute pr√©cision: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">db</span></span>\<span class="hljs-title"><span class="hljs-title">Migration</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m190914_141123_create_news_table</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createTable(<span class="hljs-string"><span class="hljs-string">'news'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;primaryKey(), <span class="hljs-string"><span class="hljs-string">'title'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;string()-&gt;notNull(), <span class="hljs-string"><span class="hljs-string">'content'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;text(), <span class="hljs-string"><span class="hljs-string">'published'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timestamp(<span class="hljs-number"><span class="hljs-number">6</span></span>), <span class="hljs-comment"><span class="hljs-comment">//     ]); } public function down() { $this-&gt;dropTable('news'); } }</span></span></code> </pre> <br><p>  Et voici un exemple de migration dans lequel la pr√©cision d'une colonne existante change: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m190916_045702_change_news_time_precision</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;alterColumn( <span class="hljs-string"><span class="hljs-string">'news'</span></span>, <span class="hljs-string"><span class="hljs-string">'published'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timestamp(<span class="hljs-number"><span class="hljs-number">6</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;alterColumn( <span class="hljs-string"><span class="hljs-string">'news'</span></span>, <span class="hljs-string"><span class="hljs-string">'published'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;timestamp(<span class="hljs-number"><span class="hljs-number">3</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }</code> </pre> <br><p>       ActiveRecord     -  :          ,         DateTime-.  ,     ‚Äî    ¬´¬ª      <code>PDO::ATTR_EMULATE_PREPARES</code> .   Yii    ,        .   ,       ,        PDO. </p><br><p> . : </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    Yii 2</a> ; </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  SchemaBuilderTrait</a> . </li></ul><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p> ,   ,     ‚Äî  ,     .                 ,    ,    . ,    ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469615/">https://habr.com/ru/post/fr469615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469599/index.html">D√©briefing du d√©veloppement du moteur 2D sur WinForms</a></li>
<li><a href="../fr469605/index.html">L'avenir du Li-Fi: polaritons, excitons, photons et certains disulfures de tungst√®ne</a></li>
<li><a href="../fr469607/index.html">Conscience humaine. Impossible de transf√©rer la copie?</a></li>
<li><a href="../fr469609/index.html">Veuillez √™tre en ligne</a></li>
<li><a href="../fr469613/index.html">√Ä propos du syst√®me national de gestion des donn√©es</a></li>
<li><a href="../fr469617/index.html">D√©truisez le monopole am√©ricain sur l'EDA. Innopolis fait le premier pas</a></li>
<li><a href="../fr469619/index.html">Recherche: si l'acheteur comprend qu'il parle avec le chat bot, l'achat n'aura pas lieu du tout</a></li>
<li><a href="../fr469623/index.html">GitLab 12.3 avec pare-feu d'application Web et analyse des performances</a></li>
<li><a href="../fr469625/index.html">Comment nous avons collect√© des donn√©es sur les campagnes publicitaires des plateformes en ligne (le chemin √©pineux vers le produit)</a></li>
<li><a href="../fr469629/index.html">L'atome pacifique n'est pas dans tous les foyers: des options inattendues pour les sources d'√©nergie des radionucl√©ides</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>