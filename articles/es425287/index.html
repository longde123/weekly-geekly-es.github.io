<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåö üë©‚ÄçüöÄ ü§¥üèº Casas FIAS en PostgreSQL üí© üßîüèø ‚öΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El art√≠culo anterior que describe las direcciones y funciones de FIAS para trabajar con ellas en el entorno PostgreSQL despert√≥ inter√©s entre una pequ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Casas FIAS en PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425287/">  El art√≠culo anterior que describe las direcciones y funciones de FIAS para trabajar con ellas en el entorno PostgreSQL despert√≥ inter√©s entre una peque√±a parte de los lectores. <br><br>  Por lo tanto, tiene sentido describir funciones similares en PL / pgSQL para trabajar con una lista de casas FIAS cargadas en una base de datos que ejecuta PostgreSQL. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/94a/cb7/fbc/94acb7fbc32a4cf18fd15e854b62360c.png"></div><br>  La primera mitad del art√≠culo proporciona comentarios sobre la implementaci√≥n de funciones.  En el segundo, los c√≥digos fuente de funciones, as√≠ como los scripts para crear una tabla con registros internos de FIAS, as√≠ como cargar datos en esta tabla desde un archivo en formato CSV.  Para aquellos lectores que solo est√°n interesados ‚Äã‚Äãen los textos de origen, sugerimos proceder inmediatamente al Ap√©ndice. <br><a name="habracut"></a><br>  Este art√≠culo est√° estrechamente relacionado con los materiales de la serie de art√≠culos "Direcciones FIAS en el entorno PostgreSQL" ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comienzo</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">continuaci√≥n 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">continuaci√≥n 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">finalizaci√≥n</a> ). <br><a name="tfHousesAOT_def"></a><h3>  √Årbol geneal√≥gico en casa </h3><br><p>  Comencemos con un ejemplo. <br></p><p>  Llamar a la funci√≥n f <b>stf_Houses_AddressObjectTree</b> ('42301ab8-9ead-4f8e-8281-e64f2769a254') dar√° como resultado la siguiente lista de entradas. </p><br>  <b>Tabla 1. El resultado de la funci√≥n.</b> <br><br><img src="https://habrastorage.org/webt/3n/2w/ir/3n2wirseekn4w0oz6kcnzhazl4o.png"><br><br><p>  En una inspecci√≥n m√°s cercana, puede observar que el identificador del elemento ( <b>HOUSEGUID</b> ) ‚Äúd.  1, edif.  2, p. 26 ‚Äù, se recibieron seis registros como resultado: </p><br><ul><li>  tres registros de padres con elementos formadores de direcciones: sobre la regi√≥n, ciudad y calle; </li><li>  tres registros con las caracter√≠sticas del n√∫mero de casa: n√∫mero de casa, n√∫mero de edificio y n√∫mero de edificio. </li></ul><br><p>  La funci√≥n tiene otro par√°metro opcional: la fecha de vencimiento del registro ( <b>EndDate</b> ), con la que puede ver el pedigr√≠ no solo del registro actual de la casa, sino tambi√©n de registros ya obsoletos. <br><br>  El texto completo de la funci√≥n se proporciona en el Ap√©ndice en la secci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Creaci√≥n de la funci√≥n fstf_Houses_AddressObjectTree</a> . </p><br><h4>  Desde el principio </h4><br><p>  Si sabe c√≥mo est√° organizada la mesa de la casa FIAS, entonces esta secci√≥n puede omitirse. <br>  Las casas FIAS ( <b>CASAS</b> ) son una lista secundaria para la lista de elementos generadores de direcciones de FIAS ( <b>ADDROBJ</b> ).  Cada entrada de la lista de la casa se refiere a un elemento generador de direcciones FIAS por el valor del campo <b>AOGUID</b> .  Para determinar en qu√© calle y en qu√© localidad se encuentra la casa, debe encontrar el registro correspondiente con el mismo identificador de lista <b>ADDROBJ por el</b> valor <b>AOGUID</b> del registro <b>HOUSES</b> . </p><br><p>  A pesar de la simplicidad externa del mecanismo de interacci√≥n entre la lista de casas y la lista de elementos formadores de direcciones en su interacci√≥n, las caracter√≠sticas complican la implementaci√≥n de funciones en las <b>CASAS</b> . </p><br><p>  En primer lugar, cada registro de la lista de casas por el identificador <b>AOGUID se</b> refiere a un grupo de elementos formadores de direcciones, uno de los cuales es relevante. </p><br><p>  En segundo lugar, hay varias entradas en la lista FIAS con el mismo conjunto de caracter√≠sticas de n√∫mero de casa: n√∫mero de casa, n√∫mero de edificio, n√∫mero de edificio. </p><br><p>  En tercer lugar, el registro de la casa no siempre se hereda del registro de la calle del pueblo. </p><br>  Pero, primero lo primero. <br><p>  Para una mayor consideraci√≥n del almacenamiento de informaci√≥n sobre casas en FIAS, es suficiente limitarnos a 4 tablas (archivos DBF): </p><br><img src="https://habrastorage.org/webt/ba/zn/e3/bazne3xtr_fqhud7hgzdxzjgl-8.png"><br><br><ul><li>  <b>ADDROBJ</b> - lista de elementos formadores de direcciones; </li><li>  <b>CASAS</b> - lista de casas; </li><li>  <b>STRSTAT</b> - un directorio de caracter√≠sticas estructurales; </li><li>  <b>ESTSTAT</b> - un directorio de signos de propiedad. </li></ul><br><p>  ADDROBJ se discuti√≥ en detalle en una publicaci√≥n anterior, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Direcciones de FIAS en PostgreSQL",</a> por lo que sus caracter√≠sticas se discutir√°n aqu√≠ exactamente tanto como sea necesario para describir las caracter√≠sticas de las casas. </p><br>  <b>Tabla 2. Historia de la casa ‚ÄúTerritorio de Krasnoyarsk, distrito de Taimyr Dolgan-Nenetsky, Dudinka, ul.</b>  <b>Dudinskaya, 1</b> <b><br></b> <br><br><img src="https://habrastorage.org/webt/5b/vu/8k/5bvu8k8v5lriarnghwlo7n5lmk8.png"><br><br><p>  Como se puede ver en la tabla, en contraste con los objetos que forman direcciones, los registros de la historia de la casa no tienen signos especiales de relevancia.  El registro con la fecha de finalizaci√≥n m√°s antigua del per√≠odo, que es mayor que la actual, es relevante.  Hasta ahora, los registros actuales de la casa est√°n marcados con la fecha 06.06.2079.  Todos los dem√°s registros sobre la casa se consideran hist√≥ricos, y las fechas de inicio y finalizaci√≥n caracterizan el per√≠odo de relevancia de cada registro. </p><br><p>  La lista de casas FIAS no contiene punteros a los registros anteriores y siguientes sobre la casa.  Por lo tanto, el orden de los registros desde la profundidad real de la historia de la casa est√° determinado por la fecha de finalizaci√≥n decreciente y m√°s all√° de la fecha de inicio del per√≠odo, respectivamente <b>EndDate</b> y <b>StartDate</b> . </p><br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.HOUSEGUID=<span class="hljs-string"><span class="hljs-string">'2fd64ecd-4b4b-4fc8-bd15-4a4a2f310b21'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>,h.STARTDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre> <br><p>  Lector atento mirando la Fig.  1, probablemente me hice la pregunta: ¬øpor qu√© se mencionan los libros de referencia de signos de estructura y propiedad?  FIAS utiliza m√°s de 10 de este tipo de directorios, entonces, ¬øpor qu√© se destacan estos dos? </p><br><p>  La respuesta sorprender√° a muchos: desde el punto de vista de la "l√≥gica FIAS", la direcci√≥n de la casa no est√° completamente identificada por la direcci√≥n, la casa, el edificio y los n√∫meros de edificio.  El t√©rmino "l√≥gica FIAS" se utiliz√≥ en la respuesta de un empleado del Servicio de Impuestos Federales a mi pregunta de por qu√© en la lista de casas en el Territorio de Krasnoyarsk hay m√°s de 250 direcciones de casas emparejadas.  La misma respuesta dice que la unicidad del registro es proporcionada por los valores AOGUID, HOUSENUM, BUILDNUM, STRUCNUM, STRSTATUS, ESTSTATUS. </p><br><br><img src="https://habrastorage.org/webt/xi/13/1l/xi131l6giem5x7mcbj4f-vpxfli.png"><br><br><p>  En otras palabras, para encontrar un objeto no es suficiente conocer la localidad, calle, n√∫mero de casa.  Tambi√©n debes saber: </p><br><ul><li>  "Posesi√≥n" es o "propiedad de la vivienda"; </li><li>  el estado de este objeto est√° definido o no definido; </li><li>  etc. </li></ul><br><img src="https://habrastorage.org/webt/np/9i/6n/np9i6n0cehorqtwgf6fzwyqm4mu.png"><br><br><p>  As√≠ es como se ve una muestra de la lista general de casas FIAS con direcciones duplicadas. <br>  El hecho de que diferentes objetos tengan la misma direcci√≥n no es sorprendente.  El edificio y la tierra debajo de √©l;  casa, garaje, casa de ba√±os para un propietario.  Todos tienen la misma direcci√≥n.  Pero FIAS es un registro de direcci√≥n, es decir  lista de direcciones.  Por lo tanto, es natural esperar que las direcciones sean √∫nicas en √©l, y no edificios, estructuras, estructuras. </p><br><p>  Es decir  La lista de casas FIAS de la lista de direcciones de casas comenz√≥ a desarrollarse hacia la lista de edificios de tierra.  Y los usuarios de FIAS deben considerar esto. </p><br><p>  Todos pueden verificar la presencia de casas con direcciones duplicadas ejecutando una instrucci√≥n SELECT similar a la siguiente.  Al mismo tiempo, la funci√≥n fsfn_Houses_TreeActualName no se puede usar, porque  se usa solo para reducir el n√∫mero de columnas en el resultado.  No es necesario utilizar los directorios fias_StructureStatus (an√°logo de STRSTAT) y fias_EstateStatus (an√°logo a ESTSTAT), como  El efecto marcado tambi√©n se puede rastrear en los c√≥digos de signos de estructura y posesi√≥n. </p><br><img src="https://habrastorage.org/webt/ch/d_/gr/chd_grqqzvzh7u_z058i-qxjkmk.png"><br><br><div class="spoiler">  <b class="spoiler_title">c√≥digo fuente del operador</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fsfn_Houses_TreeActualName(h.AOGUID,h.HOUSEGUID),h.HOUSEGUID,str.StructureStatusName,est.EstateStatusName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> AOGUID,HOUSENUM,BUILDNUM,STRUCNUM,COUNT(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> EndDate =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> AOGUID,HOUSENUM,BUILDNUM,STRUCNUM <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> COUNT(*)&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>) hg <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=hg.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.HOUSENUM=hg.HOUSENUM <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> COALESCE(h.BUILDNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>)=COALESCE(hg.BUILDNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> COALESCE(h.STRUCNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>)=COALESCE(hg.STRUCNUM,<span class="hljs-string"><span class="hljs-string">''</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">LEFT OUTER JOIN</span></span> fias_StructureStatus str <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.STRSTATUS=str.StructureStatusID <span class="hljs-keyword"><span class="hljs-keyword">LEFT OUTER JOIN</span></span> fias_EstateStatus est <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.ESTSTATUS=est.EstateStatusID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.EndDate =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.AOGUID,h.HOUSENUM,h.BUILDNUM,h.STRUCNUM,h.STRSTATUS,h.ESTSTATUS;</code> </pre><br></div></div><br><p>  Y finalmente, otra caracter√≠stica de la lista de inicio de FIAS.  Cada registro interno de esta lista contiene un enlace a un elemento formador de direcciones, cuya lista es una jerarqu√≠a de dichos elementos.  En cada nivel de la jerarqu√≠a hay elementos formadores de direcciones que pertenecen a diferentes tipos.  Entonces, el elemento ra√≠z es la regi√≥n (territorio de Krasnoyarsk en nuestro caso), en el siguiente nivel se encuentra un okrug aut√≥nomo, regi√≥n o ciudad de subordinaci√≥n regional.  Y as√≠ sucesivamente.  (Para m√°s detalles, vea "Direcciones FIAS en PostgreSQL"). </p><br><p>  Formalmente, un registro interno le permite hacer referencia a un elemento de la jerarqu√≠a en cualquier nivel.  Afortunadamente, no hab√≠a casas que se refirieran a un distrito o regi√≥n entre los datos del Territorio de Krasnoyarsk.  Sin embargo, no todas las casas se refieren a la calle del pueblo: </p><br><ul><li>  El 98% de los hogares FIAS est√°n vinculados a calles en √°reas pobladas; </li><li>  1.2% de casas - con calles en asociaciones de jardiner√≠a; </li><li>  0.3% de las casas son con asentamientos; </li><li>  0.5% de casas con otros elementos direccionables. </li></ul><br><img src="https://habrastorage.org/webt/mh/xq/3u/mhxq3ukmrzmjlboytqt2q4fsxno.png"><br>  <b>Fig.</b>  <b>2)</b> <br><br><h4>  Propagaci√≥n de domicilios por propietarios (FIAS vs mapa) </h4><br><p>  Aqu√≠ se describe un problema que conduce a una interpretaci√≥n ambigua del √°rbol geneal√≥gico.  (Igor Leonidovich Timoshchenkov, especialista en SIG, Aigeo LLC, Krasnoyarsk, me llam√≥ la atenci√≥n sobre este problema). </p><br><p>  Lo anterior muestra c√≥mo varios registros contienen la misma direcci√≥n en casa.  Lo que puede explicarse por el deseo de la inspecci√≥n fiscal de mantener no solo un registro de una casa privada, sino tambi√©n de los edificios circundantes: un garaje, un granero, etc.  Pero hay ejemplos inversos cuando varios edificios (fias_Houses) corresponden a un edificio (casa) con diferentes n√∫meros para esta casa. </p><br><br><img src="https://habrastorage.org/webt/5-/u6/cs/5-u6csqwbyl14t6fwhnix-r3nue.png"><br><br><p>  Echa un vistazo a esta foto.  A la izquierda hay una captura de pantalla con un mapa del pueblo donde se encuentran las casas para dos propietarios.  Estas son casas comunes de un piso con dos entradas.  Una familia vive a la derecha y otra a la izquierda.  Todav√≠a se pueden imaginar como casas de dos apartamentos. </p><br><p>  Ahora mira la mesa de la derecha.  En √©l, casi todas las casas con dos propietarios corresponden a 3 entradas.  Es decir  La tabla de casas FIAS muestra tanto la direcci√≥n de la casa individual ("d. 1") como las direcciones de las partes de la casa ("d. 1/1", "d. 1/2") pertenecientes a un propietario. </p><br><h4>  Como funciona </h4><br><p>  La funci√≥n <b>fstf_Houses_AddressObjectTree</b> tiene dos versiones: con cuatro o con dos par√°metros.  En la versi√≥n de la funci√≥n con dos par√°metros, se transmiten el identificador de la casa ( <b>HouseGUID</b> ) y la fecha de vencimiento del registro <b>(EndDate</b> ).  Una versi√≥n con cuatro par√°metros requiere adem√°s un identificador para el elemento generador de direcci√≥n ( <b>AOGUID</b> ) y el estado actual ( <b>CurrStatus</b> ). </p><br><img src="https://habrastorage.org/webt/f9/9k/mv/f99kmvqqmijnjjs14z0vmakvrmq.png"><br><br><div class="spoiler">  <b class="spoiler_title">c√≥digo fuente del operador</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_AOGUID,v_CurrStatus h.AOGUID,<span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt; <span class="hljs-keyword"><span class="hljs-keyword">ALL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> iao.currstatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MAX(iao.currstatus) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fias_AddressObjects ao <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=ao.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.HOUSEGUID=a_HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.ENDDATE= COALESCE(a_ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre><br></div></div><br><p>  Una funci√≥n con menos par√°metros calcula los valores de los par√°metros faltantes y llama a una funci√≥n con una gran cantidad de par√°metros.  Para hacer esto, el identificador del elemento que forma la direcci√≥n simplemente se recupera del campo correspondiente de la tabla de la casa (f <b>ias_Houses</b> ).  Y el valor del estado actual ( <b>CurrStatus</b> ) se calcula de acuerdo con las siguientes reglas: </p><br><ul><li>  si ninguno de los registros hist√≥ricos del elemento formador de direcciones contiene 0 en el campo CurrStatus, entonces a la variable v_CurrStatus se le asigna el valor de campo m√°ximo para este elemento formador de direcciones; </li><li>  de lo contrario, a esta variable se le asigna el valor 0. </li></ul><br><p>  Una funci√≥n con una gran cantidad de par√°metros primero llama a la funci√≥n <b>fstf_AddressObjects_AddressObjectTree</b> , que devuelve los elementos que forman la direcci√≥n principal para la casa.  Puede leer m√°s sobre la funci√≥n fstf_AddressObjects_AddressObjectTree en la secci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pedigree</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">elemento de formaci√≥n de direcciones del documento Direcciones FIAS en PostgreSQL</a> </p>  . <br><p>  Luego, las entradas sobre los elementos formadores de direcciones se complementan con entradas sobre los n√∫meros de la casa, el edificio, la estructura (ver Tabla 1), que se crean para cada campo no vac√≠o sobre el n√∫mero de la casa, el edificio y la estructura. </p><br><p>  Para que todos los registros de salida tengan la misma estructura y no sin cierta cuota de rapidez, los valores del nivel de c√≥digo de campos ( <b>AOLevel</b> ), el estado actual ( <b>CurrStatus</b> ) y el estado de relevancia ( <b>ActStatus</b> ) se crean artificialmente en el cuerpo de la funci√≥n. </p><br><p>  El c√≥digo para el nivel de la casa (edificio, estructura) siempre se establece en 8, consulte el libro de referencia "Niveles de objetos direccionables" de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la informaci√≥n de FIAS en el documento Composici√≥n de informaci√≥n</a> ). </p><br><p>  El estado de relevancia se establece en <b>1</b> si la fecha de vencimiento del registro ( <b>EndDate</b> ) es <b>06.06.2079</b> y 0 en caso contrario. </p><br><p>  <b>Los valores del</b> campo <b>CurrStatus</b> son m√°s complicados.  Usando sus valores, se resuelven dos tareas simult√°neamente: se establece el identificador de cada versi√≥n del registro sobre el elemento que forma la direcci√≥n y se asigna el signo de la relevancia del registro.  Por lo tanto, el √∫ltimo registro actual sobre un elemento contiene un valor de <b>0</b> en este campo, y todos los registros hist√≥ricos est√°n numerados en el orden de aparici√≥n: "1" es el registro m√°s antiguo, seguido en el tiempo: "2", etc.  El orden de asignaci√≥n de valores al campo CurrStatus se describe con m√°s detalle en la publicaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Direcciones FIAS en PostgreSQL</a> . </p><br><img src="https://habrastorage.org/webt/8t/13/og/8t13ogvul4asrek6okocveb8frq.png"><br><br><div class="spoiler">  <b class="spoiler_title">Encabezado de spoiler</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> h.AOGUID, h.HOUSEGUID, h.HOUSENUM, h.BUILDNUM, h.STRUCNUM, h.ENDDATE, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> COALESCE(h.ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> RANK() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.AOGUID, h.HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HouseCurrStatus, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> COALESCE (h.ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) =TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> HouseActStatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_Houses h <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fias_AddressObjects ao <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> h.AOGUID=ao.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> h.AOGUID=a_AOGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.HOUSEGUID=a_HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> h.ENDDATE= COALESCE(a_ENDDATE, TO_TIMESTAMP(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>,<span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> h.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>;</code> </pre><br></div></div><br><h3>  Direcci√≥n completa de la casa </h3><br><p>  La idea principal de la funci√≥n <b>fsfn_Houses_TreeActualName</b> es devolver el n√∫mero de casa conectado en una l√≠nea junto con los nombres de todos sus antepasados: elementos formadores de direcciones. </p><br><p>  Por ejemplo, deje que la funci√≥n del √°rbol geneal√≥gico (fstf_Houses_AddressObjectTree) devuelva la siguiente lista de valores. </p><br>  <b>Tabla 4. El resultado de la funci√≥n fstf_Houses_AddressObjectTree ('0c0d670f-097c-4e1d-bcac-9e9b22fb1b99')</b> <br><br><img src="https://habrastorage.org/webt/5s/iu/ks/5siuksa7hfbicjmqsdt-fiqu1z0.png"><br><br><p>  Entonces <b>fsfn_Houses_TreeActualName</b> ('0c0d670f-097c-4e1d-bcac-9e9b22fb1b99') deber√≠a devolver: ‚Äú <b>Sr. Krasnoyarsk, 34A St. Lazo, bld.</b>  <b>6, p. 17</b> ". </p><br><p>  La funci√≥n <b>fsfn_Houses_TreeActualName</b> se puede simplificar como una funci√≥n agregada <b>STRING_AGG</b> sobre el resultado de una funci√≥n que devuelve un √°rbol geneal√≥gico en el hogar. </p><br><p>  La funci√≥n en cuesti√≥n tiene otro par√°metro opcional: una matriz de m√°scaras ( <b>a_MaskArray</b> ), con la que puede incluir en el resultado no todos los nombres de elementos, sino solo aquellos que son necesarios. </p><br>  <b>Tabla 5. Lista de m√°scaras de funciones.</b> <br><br><img src="https://habrastorage.org/webt/6e/dl/q5/6edlq5zop1sqnwemc1s2zmbmgme.png"><br><br><div class="spoiler">  <b class="spoiler_title">versi√≥n de texto de la tabla</b> <div class="spoiler_text"><table><tbody><tr><th>  Valor </th><th>  Nota </th></tr><tr><td>  {HS} </td><td>  M√°scara - n√∫mero de casa </td></tr><tr><td>  {POR} </td><td>  M√°scara - n√∫mero de caso </td></tr><tr><td>  {BG} </td><td>  M√°scara: n√∫mero de edificio </td></tr><tr><td>  {ST} </td><td>  M√°scara - calle </td></tr><tr><td>  {ZC} </td><td>  M√°scara - C√≥digo postal </td></tr><tr><td>  {DT} </td><td>  M√°scara - √°rea urbana </td></tr><tr><td>  {LP} </td><td>  M√°scara - ciudad subordinada </td></tr><tr><td>  {LM} </td><td>  M√°scara: el asentamiento principal </td></tr><tr><td>  {TP} </td><td>  M√°scara: regi√≥n del sujeto de la federaci√≥n </td></tr><tr><td>  {TM} </td><td>  M√°scara: sujeto de la federaci√≥n (regi√≥n) </td></tr><tr><td>  {CY} </td><td>  M√°scara - Pa√≠s </td></tr></tbody></table><br></div></div><br>  Consulte tambi√©n la secci√≥n " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Nombre completo del elemento formador de direcciones" de la publicaci√≥n "Direcciones FIAS en PostgreSQL</a> ". <br>  El texto de la funci√≥n se proporciona en la secci√≥n Aplicaci√≥n " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Creaci√≥n de la funci√≥n fsfn_Houses_TreeActualName</a> ". <br><br><h3>  FIAS Home Search </h3><br><p>  La funci√≥n <b>fstf_Houses_SearchByName est√°</b> dise√±ada para buscar las direcciones de las casas FIAS por sus n√∫meros y los nombres de los elementos formadores de direcciones.  Adem√°s, la b√∫squeda puede llevarse a cabo no solo por el nombre y el tipo del elemento actual, sino tambi√©n por los nombres y tipos de uno o dos de sus antepasados ‚Äã‚Äãm√°s cercanos. </p><br><p>  Veamos algunos ejemplos.  Y para empezar, encontraremos todas las casas con el n√∫mero "220". </p><br>  <b>Tabla 6. Resultado de la funci√≥n fstf_Houses_SearchByName ('220')</b> <br><br><img src="https://habrastorage.org/webt/lk/82/od/lk82odn1sragk7w8oudjxihuqye.png"><br><br><p>  A diferencia de la funci√≥n de b√∫squeda de elementos formadores de direcciones ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fstf_AddressObjects_SearchByName</a> ), el resultado de esta funci√≥n no contiene el efecto de "nadar" a trav√©s de los niveles de elementos formadores de direcciones.  El primer par√°metro de la funci√≥n siempre contiene el patr√≥n de b√∫squeda para el n√∫mero de casa, el segundo, el n√∫mero de edificio, el tercer n√∫mero de edificio. </p><br><p>  Ahora cambia la solicitud.  Encontramos todas las casas de elementos formadores de direcciones, cuyo n√∫mero contiene el n√∫mero "1", y la palabra "Krasnoyarsk" aparece en los nombres. </p><br>  <b>Tabla 7. El resultado de la funci√≥n fstf_Houses_SearchByName ('1', NULL, NULL, 'Krasnoyarsk')</b> <br><br><img src="https://habrastorage.org/webt/bi/jm/as/bijmasrtluarib2trzq_f4m-jf8.png"><br><br><p>  El prop√≥sito de los par√°metros restantes coincide exactamente con el prop√≥sito de los par√°metros de la funci√≥n de b√∫squeda de los elementos generadores de direcciones (fstf_AddressObjects_SearchByName). <br>  El texto de la funci√≥n se proporciona en la secci√≥n Aplicaci√≥n " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Creaci√≥n de la funci√≥n fstf_Houses_SearchByName</a> " </p>  . <br><h4>  Como funciona </h4><br><p>  La implementaci√≥n de <b>fstf_Houses_SearchByName es</b> similar en muchos aspectos a la implementaci√≥n de la funci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">b√∫squeda de elementos generadores de direcciones (fstf_AddressObjects_SearchByName)</a> .  La principal diferencia es que la b√∫squeda se realiza en dos tablas relacionadas, <b>fias_Houses</b> y <b>fias_AddressObjects</b> . </p><br><p>  La funci√≥n tiene 9 argumentos.  Los tres primeros son los n√∫meros de casa ( <b>a_HouseNum</b> ), el edificio <b>(a_BuildNum</b> ) y el edificio ( <b>a_StrucNum</b> ).  Los 6 restantes ( <b>a_FormalName</b> , <b>a_ShortName</b> , <b>a_ParentFormalName</b> , <b>a_ParentShortName</b> , <b>a_GrandParentFormalName</b> , <b>a_GrandParentShortName</b> ) coinciden completamente con los par√°metros de la funci√≥n. <br><br>  Si establece solo el valor del par√°metro "n√∫mero de casa", la funci√≥n devolver√° todas las direcciones en el n√∫mero de casa que la secuencia especificada encuentra con un s√≠mbolo.  Si pasa NULL o una cadena vac√≠a ("") como n√∫mero de casa, se devolver√°n las direcciones de todas las casas cuyos elementos de direcci√≥n se especifiquen mediante un conjunto de otros par√°metros. <br><br><img src="https://habrastorage.org/webt/bo/sh/ht/boshhtjrbef92owia3wp2j2_6sm.png"><br><br></p><h3>  Ep√≠logo </h3><br><p>  Esta secci√≥n contiene recomendaciones sobre c√≥mo cargar la lista de casas FIAS en la tabla <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">fias_Houses</a></b> . </p><br><p>  La carga de datos en una tabla de casas se realiza de la misma manera que la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">carga de datos en una tabla de elementos formadores de direcciones</a> .  Solo el archivo fuente ser√° <b>HOUSE99.DBF</b> , no <b>ADDROB99.DBF</b> .  Aqu√≠ <b>99</b> es el n√∫mero de la regi√≥n (Rep√∫blica, regi√≥n, territorio).  Por ejemplo, para el territorio de Krasnoyarsk, el archivo fuente es el archivo <b>HOUSE24.DBF</b> . </p><br><p>  Primero, el siguiente archivo con la actualizaci√≥n se descarga desde la p√°gina <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Actualizaciones de</a> FIAS.  El archivo <b>HOUSE99.DBF</b> se extrae de √©l <b>.</b> </p><p>  . <br></p><p>  Luego, el archivo <b>HOUSE99.DBF se</b> convierte al formato <b>CSV</b> y ya convertido, se carga mediante la instrucci√≥n COPY en la tabla temporal <b>fias_Houses_Temp</b> . </p><br><p>  Y finalmente, los datos temporales se utilizan para actualizar la tabla principal, es decir.  inexistente en fias_Houses se agregan, y los existentes se reemplazan. <br>  En la secci√≥n " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Descarga de actualizaciones de FIAS House en la tabla fias_Houses</a> " se ofrece un ejemplo de un script para actualizar una tabla de casas. </p><br><h3>  App </h3><br><a name="tfHousesAOT"></a><h3>  Crear la funci√≥n fstf_Houses_AddressObjectTree </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los comentarios sobre el c√≥digo fuente de la funci√≥n se pueden encontrar aqu√≠</a> . <br><br><div class="spoiler">  <b class="spoiler_title">c√≥digo de funci√≥n</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fstf_Houses_AddressObjectTree(a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,a_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>); <span class="hljs-comment"><span class="hljs-comment">/******************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   (  )   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/******************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fstf_Houses_AddressObjectTree( a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),<span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*    4: */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 0 - , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 1-50 - , ..  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 51 -  */</span></span> a_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'2079-06-06'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rtf_GUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), rtf_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>, rtf_AOLevel <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ShortTypeName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_AddressObjectName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_HouseAOLevel <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">8</span></span>; c_HouseShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_BuildShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StructShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StatusActual <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_StatusNotActual <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> c_MAXENDDATE <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>:=to_timestamp(<span class="hljs-string"><span class="hljs-string">'2079-06-06 00:00:00'</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD'</span></span>); v_HouseActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HouseCurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_Return_Error <span class="hljs-type"><span class="hljs-type">Integer</span></span> :=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************ --************************************************************ BEGIN RETURN QUERY SELECT * FROM fstf_AddressObjects_AddressObjectTree (a_AOGUID,a_CurrStatus); IF a_ENDDATE IS NULL THEN SELECT INTO v_ENDDATE MAX(ENDDATE) FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID; ELSE v_ENDDATE:=a_ENDDATE; END IF; SELECT INTO v_HOUSENUM,v_BUILDNUM,v_STRUCNUM, v_ENDDATE,v_HouseCurrStatus h.HOUSENUM,h.BUILDNUM,h.STRUCNUM, h.ENDDATE,ah.HouseCurrStatus FROM fias_Houses h INNER JOIN (SELECT AOGUID,HOUSEGUID,ENDDATE, RANK() OVER (PARTITION BY AOGUID, HOUSEGUID ORDER BY ENDDATE ASC) AS HouseCurrStatus FROM fias_Houses insh WHERE insh.AOGUID=a_AOGUID AND insh.HOUSEGUID=a_HOUSEGUID) as ah ON h.AOGUID=ah.AOGUID AND h.HOUSEGUID=ah.HOUSEGUID AND h.ENDDATE=ah.ENDDATE WHERE h.ENDDATE=v_ENDDATE; v_HouseActStatus:=CASE WHEN COALESCE(v_ENDDATE,c_MAXENDDATE)= c_MAXENDDATE THEN c_StatusActual ELSE c_StatusNotActual END; v_HouseCurrStatus:=CASE WHEN COALESCE(v_ENDDATE,c_MAXENDDATE)= c_MAXENDDATE THEN 0 ELSE v_HouseCurrStatus END; IF v_HOUSENUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_HouseShortTypeName,v_HOUSENUM; END IF; IF v_BUILDNUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_BuildShortTypeName,v_BUILDNUM; END IF; IF v_STRUCNUM IS NOT NULL THEN RETURN QUERY SELECT a_HOUSEGUID,v_HouseCurrStatus,v_HouseActStatus, c_HouseAOLevel,c_StructShortTypeName,v_STRUCNUM; END IF; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_AddressObjectTree(a_AOGUID VARCHAR(36), a_HOUSEGUID VARCHAR(36),a_CurrStatus INTEGER,a_ENDDATE TIMESTAMP) IS '  (  )       '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS fstf_Houses_AddressObjectTree(a_HOUSEGUID VARCHAR(36),a_ENDDATE TIMESTAMP); /******************************************************************/ /*   (  )   */ /*      */ /******************************************************************/ CREATE OR REPLACE FUNCTION fstf_Houses_AddressObjectTree( a_HOUSEGUID VARCHAR(36),/*     */ a_ENDDATE TIMESTAMP default '2079-06-06'/*     */ ) RETURNS TABLE (rtf_GUID VARCHAR(36), rtf_CurrStatus INTEGER,rtf_ActStatus INTEGER, rtf_AOLevel INTEGER,rtf_ShortTypeName VARCHAR(10),rtf_AddressObjectName VARCHAR(100)) AS $BODY$ DECLARE c_MaxEndDate CONSTANT TIMESTAMP:=TO_TIMESTAMP('2079-06-06','YYYY-MM-DD'); c_ActualStatusCode CONSTANT INTEGER :=1; /*      */ c_NotActualStatusCode CONSTANT INTEGER :=0; /*     */ v_AOGUID VARCHAR(36); /*   */ /*   */ v_CurrStatus INTEGER; /*    4: */ /* 0 - , */ /* 1-50 - , */ /* ..   , */ /*     */ /*     , */ /* 51 - */ v_Return_Error Integer :=0; /*   */ --******************************************************************* --******************************************************************* BEGIN SELECT INTO v_AOGUID,v_CurrStatus h.AOGUID, CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE ao.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE ao.aoguid = iao.aoguid) ELSE 0 END FROM fias_Houses h INNER JOIN fias_AddressObjects ao ON h.AOGUID=ao.AOGUID WHERE h.HOUSEGUID=a_HOUSEGUID AND h.ENDDATE=COALESCE(a_ENDDATE,c_MaxEndDate) ORDER BY h.ENDDATE DESC; RETURN QUERY SELECT * FROM fstf_Houses_AddressObjectTree( v_AOGUID,a_HOUSEGUID, v_CurrStatus,a_ENDDATE); END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_AddressObjectTree(a_HOUSEGUID VARCHAR(36),a_ENDDATE TIMESTAMP) IS '  (  )       '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM fstf_Houses_AddressObjectTree('8b40b028-68eb-4315-a256-ea300c604688','42301ab8-9ead-4f8e-8281-e64f2769a254') ORDER BY rtf_AOLevel; SELECT * FROM fstf_Houses_AddressObjectTree('42301ab8-9ead-4f8e-8281-e64f2769a254') ORDER BY rtf_AOLevel;</span></span></code> </pre><br></div></div><br><a name="fnHousesTAN"></a><br><h3>  Crear la funci√≥n fsfn_Houses_TreeActualName </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los comentarios sobre el c√≥digo fuente de la funci√≥n se pueden encontrar aqu√≠</a> . <br><div class="spoiler">  <b class="spoiler_title">c√≥digo de funci√≥n</b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fsfn_Houses_TreeActualName(a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),a_MaskArray <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">10</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fsfn_Houses_TreeActualName( a_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> a_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_MaskArray <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">10</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'{TP,LM,LP,ST,HS,BY,BG}'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  ,   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_HouseMaskArray <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">3</span></span>]:=<span class="hljs-string"><span class="hljs-string">'{HS,BY,BG}'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> c_HouseNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{HS}'</span></span>; c_BodyNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{BY}'</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_BuildingNoMask <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] :=<span class="hljs-string"><span class="hljs-string">'{BG}'</span></span>;<span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> c_HouseShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_BuildShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; c_StructShortTypeName <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>):=<span class="hljs-string"><span class="hljs-string">'.'</span></span>; v_ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TreeAddressObjectName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_Return_Error <span class="hljs-type"><span class="hljs-type">Integer</span></span> :=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--******************************************************* --******************************************************* BEGIN v_TreeAddressObjectName:=fsfn_AddressObjects_TreeActualName (a_AOGUID,a_MaskArray); SELECT INTO v_ENDDATE MAX(ENDDATE) FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID; SELECT INTO v_HOUSENUM,v_BUILDNUM,v_STRUCNUM HOUSENUM, BUILDNUM,STRUCNUM FROM fias_Houses WHERE AOGUID=a_AOGUID AND HOUSEGUID=a_HOUSEGUID AND ENDDATE=v_ENDDATE; IF c_HouseNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_HOUSENUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' ||c_HouseShortTypeName||' '||v_HOUSENUM END; END IF; IF c_BodyNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_BUILDNUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' || c_BuildShortTypeName||' '||v_BUILDNUM END; END IF; IF c_BuildingNoMask &lt;@ a_MaskArray AND COALESCE(TRIM(v_STRUCNUM),'')&lt;&gt;'' THEN v_TreeAddressObjectName:=v_TreeAddressObjectName|| CASE WHEN v_TreeAddressObjectName='' THEN '' ELSE ', ' || c_StructShortTypeName||' '||v_STRUCNUM END; END IF; RETURN v_TreeAddressObjectName; END; $BODY$ LANGUAGE plpgsql ; COMMENT ON FUNCTION fsfn_Houses_TreeActualName(a_AOGUID VARCHAR(36),a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) IS '         '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS fsfn_Houses_TreeActualName(a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) CASCADE; /*****************************************************************/ /*           */ /*****************************************************************/ CREATE OR REPLACE FUNCTION fsfn_Houses_TreeActualName( a_HOUSEGUID VARCHAR(36), /*     */ a_MaskArray VARCHAR(2)[10] default '{TP,LM,LP,ST,HS,BY,BG}' /*  ,   */ /*    */ ) RETURNS VARCHAR(1000) AS $BODY$ DECLARE c_MaxEndDate CONSTANT TIMESTAMP:=TO_TIMESTAMP('2079-06-06','YYYY-MM-DD'); v_AOGUID VARCHAR(36); /*    */ v_TreeAddressObjectName VARCHAR(1000); /*     */ v_Return_Error Integer :=0; /*   */ --********************************************************** --********************************************************** BEGIN SELECT INTO v_AOGUID h.AOGUID FROM fias_Houses h INNER JOIN fias_AddressObjects ao ON h.AOGUID=ao.AOGUID WHERE h.HOUSEGUID=a_HOUSEGUID AND h.ENDDATE=c_MaxEndDate ORDER BY h.ENDDATE DESC; v_TreeAddressObjectName:=fsfn_Houses_TreeActualName (v_AOGUID,a_HOUSEGUID,a_MaskArray); RETURN v_TreeAddressObjectName; END; $BODY$ LANGUAGE plpgsql ; COMMENT ON FUNCTION fsfn_Houses_TreeActualName(a_HOUSEGUID VARCHAR(36),a_MaskArray VARCHAR(2)[10]) IS '         '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT fsfn_Houses_TreeActualName('8b40b028-68eb-4315-a256-ea300c604688','42301ab8-9ead-4f8e-8281-e64f2769a254'); SELECT fsfn_Houses_TreeActualName('42301ab8-9ead-4f8e-8281-e64f2769a254');</span></span></code> </pre><br></div></div><br><a name="tfHousesSBN"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crear la funci√≥n fstf_Houses_SearchByName </font></font></h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los comentarios sobre el c√≥digo fuente de la funci√≥n se pueden encontrar aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo de funci√≥n</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fstf_Houses_SearchByName(a_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),a_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),a_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),a_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),a_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), a_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),a_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>)); <span class="hljs-comment"><span class="hljs-comment">/*****************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*****************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fstf_Houses_SearchByName( a_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rtf_AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),rtf_HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>),rtf_AOLevel <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_HousesFullName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>),rtf_HouseNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_BuildNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_StrucNum <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>),rtf_EndDate <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span>,rtf_ShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_FormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>), rtf_CurrStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>,rtf_ActStatus <span class="hljs-type"><span class="hljs-type">INTEGER</span></span>, rtf_ParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_ParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>),rtf_GrandParentShortName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>),rtf_GrandParentFormalName <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $BODY$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_WildChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-string"><span class="hljs-string">'%'</span></span>; c_BlankChar <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)=<span class="hljs-string"><span class="hljs-string">' '</span></span>; v_HouseNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_BuildNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_StrucNumTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_ShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_ParentFormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_ParentShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_GrandParentFormalNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">150</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_GrandParentShortNameTemplate <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--*************************************************************** --*************************************************************** BEGIN v_ShortNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_ShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_FormalNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_FormalName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_HouseNumTemplate:= CASE WHEN TRIM(COALESCE(a_HouseNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_HouseNum),c_BlankChar,c_WildChar)) END ||CASE WHEN TRIM(COALESCE(a_BuildNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_BuildNum),c_BlankChar,c_WildChar)) END || CASE WHEN TRIM(COALESCE(a_StrucNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_StrucNum),c_BlankChar,c_WildChar)) END; v_HouseNumTemplate:=v_HouseNumTemplate||c_WildChar; v_HouseNumTemplate:=CASE WHEN TRIM(COALESCE(a_HouseNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_HouseNum),c_BlankChar,c_WildChar)) END ||c_WildChar; v_BuildNumTemplate:=CASE WHEN TRIM(COALESCE(a_BuildNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_BuildNum),c_BlankChar,c_WildChar)) END ||c_WildChar; v_StrucNumTemplate:=CASE WHEN TRIM(COALESCE(a_StrucNum,''))='' THEN '' ELSE LOWER(c_WildChar ||REPLACE(TRIM(a_StrucNum),c_BlankChar,c_WildChar)) END||c_WildChar; IF a_FormalName IS NOT NULL AND a_ParentFormalName IS NULL AND a_ParentShortName IS NULL AND a_GrandParentFormalName IS NULL AND a_GrandParentShortName IS NULL THEN IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus, NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects cfa INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'),h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'),h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum,h.EndDate, cfa.ShortName,cfa.FORMALNAME,cfa.currstatus,cfa.Actstatus, NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects cfa INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY cfa.AOLevel,cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'),h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'),h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; END IF; ELSIF a_FormalName IS NOT NULL AND a_ParentFormalName IS NOT NULL AND a_GrandParentFormalName IS NULL AND a_GrandParentShortName IS NULL THEN v_ParentShortNameTemplate:=UPPER(COALESCE(c_WildChar ||REPLACE(TRIM(a_ParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)); v_ParentFormalNameTemplate:=UPPER(c_WildChar ||REPLACE(TRIM(a_ParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar); v_FormalNameTemplate:=COALESCE(v_FormalNameTemplate,c_WildChar); IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum,h.EndDate, cfa.ShortName,cfa.FORMALNAME,cfa.currstatus, cfa.Actstatus,pfa.ShortName,pfa.FORMALNAME, NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects pfa INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY pfa.ShortName,pfa.FORMALNAME,cfa.AOLevel, cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum,TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum,TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'), h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,NULL::VARCHAR,NULL::VARCHAR FROM fias_AddressObjects pfa INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY pfa.ShortName,pfa.FORMALNAME,cfa.AOLevel, cfa.ShortName,cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; END IF; ELSE v_GrandParentShortNameTemplate:=COALESCE(UPPER( COALESCE(c_WildChar ||REPLACE(TRIM(a_GrandParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)),c_WildChar); v_GrandParentFormalNameTemplate:=COALESCE(UPPER( c_WildChar ||REPLACE(TRIM(a_GrandParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar),c_WildChar); v_ParentShortNameTemplate:=COALESCE(UPPER( COALESCE(c_WildChar ||REPLACE(TRIM(a_ParentShortName),c_BlankChar,c_WildChar) ||c_WildChar,c_WildChar)),c_WildChar); v_ParentFormalNameTemplate:=COALESCE(UPPER( c_WildChar||REPLACE(TRIM(a_ParentFormalName),c_BlankChar,c_WildChar) ||c_WildChar),c_WildChar); v_FormalNameTemplate:=COALESCE(v_FormalNameTemplate,c_WildChar); IF a_HouseNum IS NOT NULL OR a_BuildNum IS NOT NULL OR a_StrucNum IS NOT NULL THEN RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,gpfa.ShortName,gpfa.FORMALNAME FROM fias_AddressObjects gpfa INNER JOIN fias_AddressObjects pfa ON gpfa.AOGUID=pfa.ParentGUID INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND gpfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE gpfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(gpfa.FORMALNAME) LIKE v_GrandParentFormalNameTemplate AND UPPER(gpfa.ShortName) LIKE v_GrandParentShortNameTemplate AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate AND TRIM(LOWER(COALESCE(h.HouseNum,''))) LIKE v_HouseNumTemplate AND TRIM(LOWER(COALESCE(h.BuildNum,''))) LIKE v_BuildNumTemplate AND TRIM(LOWER(COALESCE(h.StrucNum,''))) LIKE v_StrucNumTemplate ORDER BY gpfa.ShortName,gpfa.FORMALNAME,pfa.ShortName, pfa.FORMALNAME,cfa.AOLevel,cfa.ShortName, cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'),h.StrucNum; ELSE RETURN QUERY SELECT cfa.AOGUID,h.HouseGUID,cfa.AOLevel, fsfn_Houses_TreeActualName(h.AOGUID,h.HouseGUID), h.HouseNum,h.BuildNum,h.StrucNum, h.EndDate,cfa.ShortName,cfa.FORMALNAME, cfa.currstatus,cfa.Actstatus,pfa.ShortName, pfa.FORMALNAME,gpfa.ShortName,gpfa.FORMALNAME FROM fias_AddressObjects gpfa INNER JOIN fias_AddressObjects pfa ON gpfa.AOGUID=pfa.ParentGUID INNER JOIN fias_AddressObjects cfa ON pfa.AOGUID=cfa.ParentGUID INNER JOIN fias_Houses h ON cfa.aoguid = h.aoguid WHERE cfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) ELSE 0 END AND pfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE pfa.aoguid = iao.aoguid) ELSE 0 END AND gpfa.currstatus= CASE WHEN 0 &lt; ALL(SELECT iao.currstatus FROM fias_AddressObjects iao WHERE cfa.aoguid = iao.aoguid) THEN (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE gpfa.aoguid = iao.aoguid) ELSE 0 END AND h.EndDate=(SELECT MAX(ih.EndDate) FROM fias_Houses ih WHERE cfa.aoguid = ih.aoguid AND h.HouseGUID = ih.HouseGUID) AND UPPER(gpfa.FORMALNAME) LIKE v_GrandParentFormalNameTemplate AND UPPER(gpfa.ShortName) LIKE v_GrandParentShortNameTemplate AND UPPER(pfa.FORMALNAME) LIKE v_ParentFormalNameTemplate AND UPPER(pfa.ShortName) LIKE v_ParentShortNameTemplate AND UPPER(cfa.FORMALNAME) LIKE v_FormalNameTemplate AND UPPER(cfa.ShortName) LIKE v_ShortNameTemplate ORDER BY gpfa.ShortName,gpfa.FORMALNAME,pfa.ShortName, pfa.FORMALNAME,cfa.AOLevel,cfa.ShortName, cfa.FORMALNAME, TO_NUMBER(SUBSTRING(h.HouseNum,E'\\d+'),'9999'), h.HouseNum, TO_NUMBER(SUBSTRING(h.BuildNum,E'\\d+'),'9999'), h.BuildNum, TO_NUMBER(SUBSTRING(h.StrucNum,E'\\d+'),'9999'), h.StrucNum; END IF; END IF; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_Houses_SearchByName(a_HouseNum VARCHAR(20),a_BuildNum VARCHAR(10),a_StrucNum VARCHAR(10),a_FormalName VARCHAR(150),a_ShortName VARCHAR(20),a_ParentFormalName VARCHAR(150),a_ParentShortName VARCHAR(20), a_GrandParentFormalName VARCHAR(150),a_GrandParentShortName VARCHAR(20)) IS '            '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; --SELECT * FROM fstf_Houses_SearchByName('220'); --SELECT * FROM fstf_Houses_SearchByName(NULL,NULL,'220'); SELECT * FROM fstf_Houses_SearchByName('1',NULL,NULL,''); SELECT * FROM fstf_Houses_SearchByName(NULL,NULL,NULL,'','','',NULL,'');</span></span></code> </pre><br></div></div><br><a name="HousesCreate"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crear una tabla de la casa FIAS fias_Houses </font></font></h3><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo de script</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_Houses; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_EstateStatus; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_StructureStatus; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_Houses( HOUSEID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, AOGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, HOUSEGUID <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, HOUSENUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, BUILDNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STRUCNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, POSTALCODE <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, OKATO <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, OKTMO <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, IFNSFL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, TERRIFNSFL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, IFNSUL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, TERRIFNSUL <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, ESTSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STATSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STRSTATUS <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, STARTDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, ENDDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, UPDATEDATE <span class="hljs-type"><span class="hljs-type">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, NORMDOC <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, COUNTER <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, CADNUM <span class="hljs-type"><span class="hljs-type">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, DIVTYPE <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_Houses <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> ( HOUSEID )) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE1fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(AOGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE2fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSEGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE3fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(AOGUID,HOUSEGUID); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE4fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSENUM,BUILDNUM,STRUCNUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE5fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(HOUSENUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE6fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(BUILDNUM); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> XIE7fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fias_Houses(STRUCNUM); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_Houses <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'HOUSE         ,     .'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSEID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'   '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.AOGUID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'      (, ,    ..)'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSEGUID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'   '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.HOUSENUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.BUILDNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STRUCNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.POSTALCODE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.IFNSFL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.TERRIFNSFL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.IFNSUL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.TERRIFNSUL <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.OKATO <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.OKTMO <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.ESTSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STRSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STATSTATUS <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.STARTDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.ENDDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.UPDATEDATE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  () '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.NORMDOC <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.COUNTER <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'     4'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.CADNUM <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_Houses.DIVTYPE <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' : 0 ‚Äì   1 ‚Äì  2 ‚Äì '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_EstateStatus( EstateStatusID <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, EstateStatusName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, EstateStatusShortName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_EstateStatus <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (EstateStatusID)) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_EstateStatus <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' ()  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' .  :0 ‚Äì  ,1 ‚Äì ,2 ‚Äì ,3 ‚Äì '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_EstateStatus.EstateStatusShortName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fias_StructureStatus( StructureStatusID <span class="hljs-type"><span class="hljs-type">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, StructureStatusName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, StructureStatusShortName <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> XPKfias_StructureStatus <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (StructureStatusID)) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">OIDS</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> fias_StructureStatus <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' ()  '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusID <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' .  :0 ‚Äì  ,1 ‚Äì ,2 ‚Äì ,3 ‚Äì '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> fias_StructureStatus.StructureStatusShortName <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-comment"><span class="hljs-comment">--ROLLBACk TRANSACTION; COMMIT TRANSACTION;</span></span></code> </pre><br></div></div><br><a name="HousesFilling"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Descargue las actualizaciones de FIAS Home en la tabla fias_Houses </font></font></h3><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo fuente del script</font></font></b> <div class="spoiler_text"><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> $$<span class="pgsql"><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">BEGIN</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_Houses_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_DeletedHouses_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_EstateStatus_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">CREATE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> fias_StructureStatus_temp </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">AS</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">LIMIT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql">; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_EstateStatus  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  " "   */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_EstateStatus_temp(EstateStatusID,EstateStatusNAME,EstateStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\ESTSTAT_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* " "     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_EstateStatus s </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> EstateStatusNAME=t.EstateStatusNAME, EstateStatusShortName=t.EstateStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus ds </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_EstateStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> ds.EstateStatusID=t.EstateStatusID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> ds.EstateStatusID=s.EstateStatusID; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_EstateStatus(EstateStatusID,EstateStatusNAME,EstateStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> EstateStatusID,EstateStatusNAME,EstateStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_EstateStatus os </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.EstateStatusID=os.EstateStatusID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/******************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_StructureStatus  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  " "  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/******************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_StructureStatus_temp(StructureStatusID,StructureStatusNAME,StructureStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\STRSTAT_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     " "  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*   */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*****************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_StructureStatus s </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> StructureStatusNAME=t.StructureStatusNAME, StructureStatusShortName=t.StructureStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus ds </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_StructureStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> ds.StructureStatusID=t.StructureStatusID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> ds.StructureStatusID=s.StructureStatusID; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_StructureStatus(StructureStatusID,StructureStatusNAME,StructureStatusShortName) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> StructureStatusID,StructureStatusNAME,StructureStatusShortName </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus_temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_StructureStatus os </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.StructureStatusID=os.StructureStatusID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_Houses_temp     */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/**********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">COPY</span></span></span><span class="pgsql"> fias_Houses_temp(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'W:\Projects\Enisey GIS\DB\SourceData\HOUSE24_20180827.csv'</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WITH</span></span></span><span class="pgsql"> (</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FORMAT</span></span></span><span class="pgsql"> csv,</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELIMITER</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">';'</span></span></span><span class="pgsql">, </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ENCODING</span></span></span><span class="pgsql"> </span><span class="hljs-string"><span class="pgsql"><span class="hljs-string">'UTF8'</span></span></span><span class="pgsql">); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*     fias_DeletedHouses_temp , */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*        */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  DHOUSE24      . */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*         */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* COPY fias_DeletedHouses_temp(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) FROM 'W:\Projects\Enisey GIS\DB\SourceData\DHOUSE24_20180827.csv' WITH (FORMAT csv,DELIMITER ';', ENCODING 'UTF8'); */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*        */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/***********************************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">UPDATE</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SET</span></span></span><span class="pgsql"> AOGUID=t.AOGUID, BUILDNUM=t.BUILDNUM, ENDDATE=t.ENDDATE, ESTSTATUS=t.ESTSTATUS, HOUSEGUID=t.HOUSEGUID, HOUSENUM=t.HOUSENUM, STATSTATUS=t.STATSTATUS, IFNSFL=t.IFNSFL, IFNSUL=t.IFNSUL, OKATO=t.OKATO, OKTMO=t.OKTMO, POSTALCODE=t.POSTALCODE, STARTDATE=t.STARTDATE, STRUCNUM=t.STRUCNUM, STRSTATUS=t.STRSTATUS, TERRIFNSFL=t.TERRIFNSFL, TERRIFNSUL=t.TERRIFNSUL, UPDATEDATE=t.UPDATEDATE, NORMDOC=t.NORMDOC, COUNTER=t.COUNTER, CADNUM=t.CADNUM, DIVTYPE=t.DIVTYPE </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses dh </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INNER</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">JOIN</span></span></span><span class="pgsql"> fias_Houses_Temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">ON</span></span></span><span class="pgsql"> t.HOUSEID=dh.HOUSEID </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> h.HOUSEID=dh.HOUSEID; </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/* fias_DeletedHouses_temp */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DELETE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql">(</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> </span><span class="hljs-number"><span class="pgsql"><span class="hljs-number">1</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_DeletedHouses_temp delh </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> delh.HOUSEID=h.HOUSEID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*       */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*  fias_Houses,  */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    fias_Houses_Temp */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/****************************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INSERT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">INTO</span></span></span><span class="pgsql"> fias_Houses(AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE) </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> AOGUID,BUILDNUM,ENDDATE,ESTSTATUS,HOUSEGUID,HOUSEID,HOUSENUM,STATSTATUS,IFNSFL,IFNSUL,OKATO,OKTMO,POSTALCODE,STARTDATE,STRUCNUM,STRSTATUS,TERRIFNSFL,TERRIFNSUL,UPDATEDATE,NORMDOC,COUNTER,CADNUM,DIVTYPE </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses_Temp t </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">NOT</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql">(</span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">SELECT</span></span></span><span class="pgsql"> * </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">FROM</span></span></span><span class="pgsql"> fias_Houses h </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">WHERE</span></span></span><span class="pgsql"> t.HOUSEID=h.HOUSEID); </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/*    */</span></span></span><span class="pgsql"> </span><span class="hljs-comment"><span class="pgsql"><span class="hljs-comment">/************************************/</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_DeletedHouses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_Houses_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_EstateStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">DROP</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">TABLE</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">IF</span></span></span><span class="pgsql"> </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">EXISTS</span></span></span><span class="pgsql"> fias_StructureStatus_temp; </span><span class="hljs-keyword"><span class="pgsql"><span class="hljs-keyword">END</span></span></span><span class="pgsql">; $$</span><span class="undefined"></span></span><span class="hljs-keyword"><span class="pgsql"><span class="undefined"></span></span><span class="hljs-keyword">LANGUAGE</span></span> plpgsql; <span class="hljs-comment"><span class="hljs-comment">--ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT (SELECT COUNT(*) FROM fias_Houses) AS HouseCount, (SELECT COUNT(*) FROM fias_EstateStatus) AS EStatusCount, (SELECT COUNT(*) FROM fias_StructureStatus) AS SStatusCount;</span></span></code> </pre><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es425287/">https://habr.com/ru/post/es425287/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es425275/index.html">12 consejos para escalar Node.js</a></li>
<li><a href="../es425279/index.html">C√≥mo entrevistar a Google: qu√© ser, qu√© no pasar</a></li>
<li><a href="../es425281/index.html">Pautas para llevar "a la condici√≥n" un clon del popular mini-enrutador chino Hame A15, tambi√©n conocido como "sin marca A5-V11"</a></li>
<li><a href="../es425283/index.html">Localizaci√≥n infinita, o c√≥mo traducimos un mapa en tiempo real</a></li>
<li><a href="../es425285/index.html">Si no contratas a Jones, entonces no mereces a los se√±ores</a></li>
<li><a href="../es425289/index.html">Enfoque corporativo</a></li>
<li><a href="../es425291/index.html">Los resultados de la pasant√≠a de verano 2018: barrieron quinientos pita shawarma. Y sobrevivi√≥</a></li>
<li><a href="../es425293/index.html">La entrevista ideal (probablemente) de un desarrollador m√≥vil de gama media</a></li>
<li><a href="../es425295/index.html">KotlinConf 2018 Live - estamos en el aire</a></li>
<li><a href="../es425297/index.html">Tres auriculares para deportes o c√≥mo me encant√≥ la conducci√≥n √≥sea</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>