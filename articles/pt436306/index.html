<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÜüèº üòü „äôÔ∏è Machine Learning para Vertica ‚õèÔ∏è üå∑ üíã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anota√ß√£o 
 Neste artigo, quero compartilhar minha pr√≥pria experi√™ncia com o aprendizado de m√°quina em um data warehouse da Vertica. 

 Francamente, eu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Machine Learning para Vertica</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436306/"><h2>  Anota√ß√£o </h2><br>  Neste artigo, quero compartilhar minha pr√≥pria experi√™ncia com o aprendizado de m√°quina em um data warehouse da Vertica. <br><br>  Francamente, eu n√£o sou um analista especialista que ser√° capaz de descrever em detalhes toda a variedade de m√©todos de pesquisa e algoritmos de previs√£o de dados.  Ainda assim, sendo um especialista em Vertica e tendo uma experi√™ncia b√°sica com ML, tentarei falar sobre maneiras de trabalhar com a an√°lise preditiva no Vertica usando a funcionalidade interna do servidor e a linguagem R. <br><br><h2>  Biblioteca de aprendizado de m√°quina Vertica </h2><br>  A partir da vers√£o 7, o Vertica foi expandido com a biblioteca Machine Learning, com a qual voc√™ pode: <br><br><ul><li>  Prepare exemplos de dados para aprendizado de m√°quina </li><li> treinar modelos de aprendizado de m√°quina com dados preparados; </li><li>  realizar an√°lises preditivas de dados de armazenamento em modelos de aprendizado de m√°quina salvos. </li></ul><br>  A biblioteca vem imediatamente completa com a instala√ß√£o do Vertica para todas as vers√µes, incluindo a Comunidade gratuita.  O trabalho com ele √© estruturado na forma de uma chamada para fun√ß√µes do SQL, descritas em detalhes na documenta√ß√£o com exemplos de uso em dados de demonstra√ß√£o preparados. <br><a name="habracut"></a><br><h2>  Um exemplo de trabalho com ML no Vertica </h2><br>  Como um exemplo simples de como o ML funciona, usei os dados de demonstra√ß√£o mtcars que fazem parte do exemplo de dados do ML para a Vertica.  Esses dados incluem duas tabelas: <br><br><ul><li>  mtcars_train - dados preparados para o treinamento de modelos de aprendizado de m√°quina </li><li>  mtcars - dados para an√°lise </li></ul><br>  Vejamos os dados para treinamento: <br><br><pre><code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars_train;</code> </pre> <br><img src="https://habrastorage.org/webt/mu/4_/o0/mu4_o0ovpeupz4c3qkf1uvnegya.jpeg"><br><br>  No conjunto de dados dos modelos de carros, suas caracter√≠sticas s√£o descritas.  Vamos tentar treinar o aprendizado de m√°quina para que, de acordo com as caracter√≠sticas dos carros, seja poss√≠vel prever qual tipo de caixa de velocidades est√° envolvida no carro - uma caixa manual ou uma caixa de velocidades autom√°tica.  Para fazer isso, precisamos construir um modelo de regress√£o log√≠stica com os dados preparados, encontrando a depend√™ncia do tipo de caixa do campo "am" e os campos de peso do ve√≠culo "wt", o n√∫mero de cilindros "cyl" e o n√∫mero de velocidades na caixa "gear": <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> LOGISTIC_REG(<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>, <span class="hljs-string"><span class="hljs-string">'mtcars_train'</span></span>, <span class="hljs-string"><span class="hljs-string">'am'</span></span>, <span class="hljs-string"><span class="hljs-string">'cyl, wt, gear'</span></span>); Finished in 19 iterations</code> </pre> <br>  A fun√ß√£o chamada analisou a rela√ß√£o entre am e os campos cyl, wt, gear, revelou a f√≥rmula da depend√™ncia e escreveu o resultado da simula√ß√£o da depend√™ncia no banco de dados Vertica no modelo "logistic_reg_mtcars".  Usando este modelo salvo, agora voc√™ pode analisar dados sobre carros e prever a disponibilidade de caixas de velocidades autom√°ticas. <br><br>  Informa√ß√µes sobre o modelo podem ser visualizadas: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> GET_MODEL_SUMMARY(<span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> model_name=<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>);</code> </pre> <br><img src="https://habrastorage.org/webt/hd/aj/gp/hdajgpkb3a4jvlq2-czafzt9mv0.jpeg"><br><br>  Agora usamos o modelo nos dados para carros, salvando o resultado em uma nova tabela: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> mtcars_predict_results <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> car_model, am, PREDICT_LOGISTIC_REG(cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> model_name=<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">prediction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars );</code> </pre> <br>  E comparando os valores reais de am com os obtidos na previs√£o de previs√£o: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars_predict_results;</code> </pre> <br><img src="https://habrastorage.org/webt/48/rt/zh/48rtzhy3c4ahjfqrupulpfy_mqy.jpeg"><br><br>  Nesse caso, a previs√£o para 100% coincidiu com o tipo real de caixa nos modelos apresentados.  No caso de preparar novos dados para treinamento, voc√™ precisar√° excluir e salvar novamente o modelo. <br><br><h2>  Funcionalidade de ML no Vertica </h2><br>  A biblioteca Vertica ML suporta os seguintes tipos de an√°lise preditiva: <br><br><ul><li>  <b>Previs√£o:</b> <br><ul><li>  Regress√£o linear </li><li>  Floresta aleat√≥ria para regress√£o </li><li>  SVM (Support Vector Machine) para regress√£o </li></ul></li><li>  <b>Classifica√ß√£o:</b> <br><ul><li>  Regress√£o log√≠stica </li><li>  Bayes ing√™nuos </li><li>  Floresta aleat√≥ria para classifica√ß√£o </li><li>  SVM (Support Vector Machine) para classifica√ß√£o </li></ul></li><li>  <b>Agrupamento:</b> <br><ul><li>  k-significa </li></ul></li></ul><br>  Para preparar os dados para o treinamento, a seguinte funcionalidade √© apresentada: <br><br><ul><li>  Balanceamento de dados </li><li>  Limpeza de emiss√µes </li><li>  Codificando valores de coluna categ√≥ricos (textuais) </li><li>  Substituindo dados ausentes </li><li>  Normaliza√ß√£o de dados </li><li>  An√°lise de componentes principais </li><li>  Amostragem de dados </li><li>  Decomposi√ß√£o de valor singular </li></ul><br>  Considerando a funcionalidade de ML no Vertica, podemos dizer que a biblioteca interna nos permite resolver uma gama bastante ampla de problemas, mas n√£o possui o backlog para estudar os padr√µes e depend√™ncias nos dados.  Existem fun√ß√µes para preparar dados para aprendizado de m√°quina, mas sem visualizar a distribui√ß√£o de dados na forma de gr√°ficos, apenas os gurus da an√°lise com conhecimento especializado dos dados analisados ‚Äã‚Äãpodem "preparar" esses dados e treinar modelos de aprendizado. <br><br><h2>  R Studio com Vertica </h2><br>  Para uma an√°lise preditiva de dados mais completa e interativa, a linguagem R √© ideal, que possui um ambiente visual para trabalhar com dados do R Studio.  As vantagens tang√≠veis do uso de R com o Vertica ser√£o: <br><br><ul><li>  interatividade do ambiente com a capacidade de salvar o estado para an√°lises posteriores ap√≥s a pr√≥xima execu√ß√£o; </li><li>  visualiza√ß√£o visual de dados sob a forma de tabelas e gr√°ficos; </li><li>  Poder da linguagem R para trabalhar com conjuntos de dados; </li><li>  uma variedade de algoritmos de an√°lise preditiva semelhantes aos apresentados no Vertica ML. </li></ul><br>  As desvantagens de trabalhar com R com big data s√£o os requisitos de RAM, a velocidade de trabalho com grandes matrizes de dados e a necessidade de importar e exportar dados da Vertica.  Essas defici√™ncias s√£o cobertas pela capacidade de incorporar fun√ß√µes R escritas para execu√ß√£o direta em um cluster no Vertica, que ser√° descrito abaixo. <br><br><h2>  Uma pequena introdu√ß√£o ao R </h2><br>  Vamos reproduzir a previs√£o de caixas autom√°ticas nos dados da Vertica usando R. Para n√£o assustar os programadores que n√£o est√£o familiarizados com esse idioma, realizarei um curso breve de um jovem lutador R. <br><br>  Portanto, a linguagem R √© a mesma linguagem processual que possui objetos, classes e fun√ß√µes. <br>  Um objeto pode ser um conjunto de dados (vetor, lista, conjunto de dados ...), valor (texto, n√∫mero, data, hora ...) ou uma fun√ß√£o.  Para valores, os tipos num√©rico, sequ√™ncia, booleano e data e hora s√£o suportados.  Para conjuntos de dados, a numera√ß√£o da matriz come√ßa em 1, n√£o em 0. <br><br>  Classicamente, em vez de "=" em R, o operador de atribui√ß√£o "&lt;-" √© usado.  Embora n√£o seja proibido usar a atribui√ß√£o para o outro lado "-&gt;" e at√© o habitual "=".  O operador "=" √© usado ao chamar fun√ß√µes para especificar par√¢metros nomeados. <br><br>  Em vez de "."  "$" √© usado para acessar os campos dos conjuntos de dados.  Um ponto n√£o √© uma palavra-chave e √© usado nos nomes de objetos para aumentar sua legibilidade.  Assim, "my.data $ field" ser√° descriptografado como uma matriz de registros do campo "field" do conjunto de dados "my.data". <br><br>  Voc√™ pode usar aspas simples ou duplas para enquadrar textos. <br><br>  <b>Mais importante:</b> R √© voltado para trabalhar com conjuntos de dados.  Mesmo que o c√≥digo diga "a &lt;-1", verifique se R dentro de si acredita que "a" √© uma matriz de 1 elemento.  O design do idioma permite trabalhar com conjuntos de dados como com vari√°veis ‚Äã‚Äãcomuns: adicionar e subtrair, conectar e desconectar, filtrar por medi√ß√µes.  A maneira mais f√°cil de criar uma matriz listando seus elementos √© chamar a fun√ß√£o "c (elementos da matriz separados por v√≠rgulas)".  O nome "c" parece ser uma abrevia√ß√£o curta de Collection, mas n√£o vou dizer com certeza. <br><br><h2>  Carregando dados de um DBMS no R </h2><br>  Para usar RDBMS atrav√©s do ODBC para R, voc√™ deve instalar o pacote RODBC.  Ele pode ser instalado no R Studio na guia packages ou usando o comando R: <br><br><pre> <code class="plaintext hljs">install.packages('RODBC') library('RODBC')</code> </pre> <br><br>  Agora podemos trabalhar com a Vertica.  Criamos um alias ODBC para o servidor e obtemos os dados de teste e o conjunto completo de dados para o carro: <br><br><pre> <code class="plaintext hljs">#    Vertica con &lt;- odbcConnect(dsn='VerticaDSN') #    mtcars_train mtcars.train &lt;- sqlQuery(con, "SELECT * FROM public.mtcars_train") #    mtcars&lt;/b&gt; mtcars.data &lt;- sqlQuery(con, "SELECT * FROM public.mtcars") #   odbcClose(con)</code> </pre> <br>  Ao carregar dados das fontes R para campos de tipos de texto e data e hora, sua perten√ßa a fatores √© automaticamente estabelecida.  O campo "am" √© do tipo num√©rico e R √© percebido como um indicador num√©rico e n√£o como um fator que n√£o permitir√° uma regress√£o log√≠stica.  Portanto, convertemos esse campo em um fator num√©rico: <br><br><pre> <code class="plaintext hljs">mtcars.data$am = factor(mtcars.data$am) mtcars.train$am = factor(mtcars.train$am)</code> </pre> <br>  No R Studio, √© conveniente assistir dados interativamente, criar gr√°ficos de an√°lise preditiva e escrever c√≥digo em R com dicas: <br><br> <a href=""><img src="https://habrastorage.org/webt/r2/ft/b8/r2ftb85rnjcmpiblxomwdiicr7k.jpeg"></a> <br><br><h2>  Construindo um modelo em R </h2><br>  Construiremos um modelo de regress√£o log√≠stica sobre o conjunto de dados preparado para as mesmas dimens√µes do Vertica: <br><br><pre> <code class="plaintext hljs">mtcars.model &lt;- glm(formula = am ~ cyl + wt + gear, family = binomial(), data = mtcars.train)</code> </pre> <br>  <b>Explica√ß√£o:</b> na linguagem R, a f√≥rmula de an√°lise preditiva √© indicada como: <br><br><pre> <code class="plaintext hljs">&lt;  &gt;~&lt;   &gt;</code> </pre> <br><h2>  An√°lise de dados do modelo em R </h2><br>  Inicializamos o conjunto de dados resultante, retirando do mtcars todos os registros para os campos obrigat√≥rios: <br><br><pre> <code class="plaintext hljs">mtcars.result &lt;- data.frame(car_model = mtcars.data$car_model, am = mtcars.data$am, predict = 0)</code> </pre> <br>  Agora, com base no modelo constru√≠do, voc√™ pode executar a an√°lise dos pr√≥prios dados: <br><br><pre> <code class="plaintext hljs">mtcars.result$predict &lt;- predict.glm(mtcars.model, newdata = subset(mtcars.data, select = c('cyl', 'wt', 'gear')), type = 'response' )</code> </pre> <br>  O resultado da an√°lise √© retornado ao campo de previs√£o como uma porcentagem da probabilidade da previs√£o.  Simplifique por analogia com a Vertica os valores 0 ou 1, considerando a previs√£o positiva com uma probabilidade superior a 50%: <br><br><pre> <code class="plaintext hljs">mtcars.result$predict &lt;- ifelse(mtcars.result$predict &gt; 0.5, 1, 0)</code> </pre> <br>  Calculamos o n√∫mero total de registros para os quais o campo de previs√£o previsto n√£o corresponde ao valor real em am: <br><br><pre> <code class="plaintext hljs">nrow(mtcars[mtcars.result$am != mtcars.result$predict, ])</code> </pre> <br>  R retornou zero.  Assim, a previs√£o convergiu em todos os modelos de carros, como no ML da Vertica. <br><br>  <b>Observa√ß√£o: os</b> registros dos mtcars foram retornados pelo filtro (o primeiro par√¢metro entre colchetes) com todas as colunas (o segundo par√¢metro foi omitido ap√≥s a v√≠rgula entre colchetes). <br><br><h2>  Salvando e carregando dados localmente no R </h2><br>  Ao sair do R, o est√∫dio oferece salvar o estado de todos os objetos para continuar trabalhando ap√≥s uma reinicializa√ß√£o.  Se, por algum motivo, voc√™ precisar salvar e restaurar o estado de objetos individuais, essas fun√ß√µes especiais s√£o fornecidas em R: <br><br><pre> <code class="plaintext hljs">#      save(mtcars.model, file = 'mtcars.model') #      load('mtcars.model')</code> </pre> <br><h2>  Salvando dados do R no Vertica </h2><br>  Se o R Studio foi usado para preparar dados para o treinamento dos modelos ML Vertica, ou se foram analisados ‚Äã‚Äãdiretamente nele, que ser√£o usados ‚Äã‚Äãno banco de dados Vertica, os conjuntos de dados R poder√£o ser gravados na tabela Vertica. <br><br>  Como a biblioteca ODBC para R foi projetada para RDBMSs OLTP, ela n√£o pode gerar corretamente consultas de cria√ß√£o de tabela para o Vertica.  Portanto, para registrar dados com √™xito, voc√™ precisar√° criar manualmente a tabela necess√°ria no Vertica usando SQL, cujo conjunto de campos e tipos coincide com o conjunto de dados grav√°veis ‚Äã‚ÄãR. <br><br>  Al√©m disso, o pr√≥prio processo de grava√ß√£o parece simples (n√£o esque√ßa de abrir e fechar a conex√£o contra): <br><br><pre> <code class="plaintext hljs">sqlSave(con, mtcars.result, tablename = 'public.mtcars_result', append = TRUE, rownames = FALSE, colnames = FALSE)</code> </pre> <br><h2>  Usando o Vertica com R </h2><br>  O trabalho interativo com dados no R Studio √© adequado para o modo de pesquisa e prepara√ß√£o de dados.  Mas √© completamente inadequado para a an√°lise de fluxos de dados e grandes matrizes no modo autom√°tico.  Uma das op√ß√µes para o esquema de an√°lise preditiva h√≠brida R com a Vertica √© a prepara√ß√£o de dados para aprender sobre R e identificar depend√™ncias para a constru√ß√£o de modelos.  Em seguida, usando as fun√ß√µes de ML incorporadas ao Vertica, os modelos de previs√£o para dados preparados em R s√£o treinados levando em considera√ß√£o as depend√™ncias identificadas das vari√°veis. <br><br>  Existe uma op√ß√£o mais flex√≠vel quando todo o poder da linguagem R √© usado diretamente no Vertica.  Para isso, a Vertica desenvolveu a distribui√ß√£o R na forma de uma biblioteca de plug-ins que permite usar fun√ß√µes de transforma√ß√£o escritas diretamente na linguagem R. em consultas SQL. A documenta√ß√£o descreve em detalhes a instala√ß√£o do suporte R para Vertica e os pacotes R adicionais necess√°rios para a opera√ß√£o, se houver. <br><br><h2>  Salvando o Modelo R no Vertica </h2><br>  Para usar o modelo de an√°lise preparado anteriormente pelo R Studio nas fun√ß√µes R em execu√ß√£o no Vertica, √© necess√°rio salv√°-lo nos servidores Vertica.  Salvar localmente em cada servidor do cluster com um arquivo n√£o √© conveniente nem confi√°vel, novos servidores podem ser adicionados ao cluster e, ao alterar o modelo, ser√° necess√°rio lembrar de reescrever todos os arquivos novamente. <br><br>  A maneira mais conveniente √© serializar o modelo R em texto e salvar a fun√ß√£o Vertica como UDF, que retornar√° esse texto como uma constante (n√£o esque√ßa de abrir e fechar a conex√£o): <br><br><pre> <code class="plaintext hljs">#     mtcars.model.text &lt;- rawToChar( serialize(mtcars.model, connection = NULL, ascii = TRUE)) #       Vertica # (     ) mtcars.func &lt;- paste0( "CREATE OR REPLACE FUNCTION public.MtCarsAnalizeModel() RETURN varchar(65000) AS BEGIN RETURN '", gsub("'", "''", mtcars.model.text), "'; END; GRANT EXECUTE ON FUNCTION public.MtCarsAnalizeModel() TO public;" ) #    Vertica sqlQuery(con, mtcars.func)</code> </pre> <br>  O m√©todo proposto permite contornar a restri√ß√£o do Vertica nos par√¢metros transmitidos na fun√ß√£o de transforma√ß√£o, onde apenas a transfer√™ncia de constantes ou express√µes das constantes √© necess√°ria.  O Vertica UDF SQL compila n√£o como fun√ß√µes, mas como express√µes calculadas, ou seja, ao passar um par√¢metro, em vez de chamar a fun√ß√£o, seu texto (nesse caso, uma constante) ser√° transferido, que foi salvo no c√≥digo acima. <br><br>  Se voc√™ alterar o modelo, ser√° necess√°rio recriar sua fun√ß√£o no Vertica.  Faz sentido agrupar esse c√≥digo em uma fun√ß√£o universal que gera uma fun√ß√£o no Vertica com o nome especificado do modelo passado. <br><br><h2>  Fun√ß√µes R para Vertica </h2><br>  Para conectar fun√ß√µes R ao Vertica, voc√™ precisa gravar fun√ß√µes de an√°lise e registro de dados no Vertica. <br><br>  A fun√ß√£o de trabalhar com dados do pr√≥prio Vertica deve ter dois par√¢metros: o conjunto de dados resultante (como data.frame) e os par√¢metros de trabalho (como lista): <br><br><pre> <code class="plaintext hljs">MtCarsAnalize &lt;- function(data, parameters) { if ( is.null(parameters[['model']]) ) { stop("NULL value for model! Model cannot be NULL.") } else { model &lt;- unserialize(charToRaw(parameters[['model']])) } names(data) &lt;- c('car_model', 'cyl', 'wt', 'gear') result &lt;- data.frame(car_model = data$car_model, predict = 0) result$predict &lt;- predict.glm(model, newdata = subset(data, select = c('cyl', 'wt', 'gear')), type = 'response' ) result$predict &lt;- ifelse(result$predict &gt; 0.5, TRUE, FALSE) return(result) }</code> </pre> <br>  No corpo da fun√ß√£o, √© verificado que o par√¢metro do modelo √© passado, cujo texto √© traduzido para a forma bin√°ria e desserializado para o objeto do modelo de an√°lise.  Como a Vertica transfere seus pr√≥prios nomes de campo para o conjunto de dados da fun√ß√£o, nomes de campo expl√≠citos s√£o definidos para o conjunto de dados.  Com base nos dados obtidos, um conjunto de resultados √© constru√≠do com o nome do modelo da m√°quina e previs√£o zero.  Em seguida, uma previs√£o √© constru√≠da usando apenas os campos necess√°rios para a an√°lise do conjunto de dados obtido.  O campo de previs√£o do conjunto de resultados √© definido como valores booleanos (para uma altera√ß√£o em vez de valores num√©ricos) e o resultado √© retornado da fun√ß√£o. <br><br>  Agora resta descrever o registro dessa fun√ß√£o no Vertica: <br><br><pre> <code class="plaintext hljs">MtCarsAnalizeFactory &lt;- function() { list(name = MtCarsAnalize, udxtype = c("transform"), intype = c("varchar", "int", "float", "int"), outtype = c("varchar", "boolean"), outnames = c("car_model", "predict"), parametertypecallback=MtCarsAnalizeParameters) } MtCarsAnalizeParameters &lt;- function() { parameters &lt;- list(datatype = c("varchar"), length = 65000, scale = c("NA"), name = c("model")) return(parameters) }</code> </pre> <br>  A fun√ß√£o MtCarsAnalizeFactory descreve o nome da fun√ß√£o usada para a opera√ß√£o, o campo para o conjunto de dados de entrada e sa√≠da e a segunda fun√ß√£o descreve o par√¢metro passado "modelo".  Tipos de campo s√£o tipos de dados Vertica.  Ao transferir e retornar dados, o Vertica converte automaticamente os valores nos tipos de dados necess√°rios para o idioma R. Voc√™ pode ver a tabela de compatibilidade de tipos na documenta√ß√£o do Vertica. <br><br>  Voc√™ pode testar a opera√ß√£o da fun√ß√£o gravada do Vertica nos dados carregados no R studio: <br><br><pre> <code class="plaintext hljs">test.data = subset(mtcars.data, select = c('car_model', 'cyl', 'wt', 'gear')) test.params = list(model = mtcars.model.text) test.result = MtCarsAnalize(test.data, test.params)</code> </pre> <br><h2>  Conecte a biblioteca de recursos ao Vertica </h2><br>  Salvamos todas as fun√ß√µes acima em um arquivo "mtcars_func.r" e carregamos esse arquivo em um dos servidores do cluster Vertica em "/ home / dbadmin". <br><br>  <b>Um ponto importante:</b> no R Studio, voc√™ precisa definir a op√ß√£o de salvar a tradu√ß√£o de linhas em arquivos no modo Posix (LF).  Isso pode ser feito nas op√ß√µes globais, se√ß√£o C√≥digo, guia Salvar.  Se voc√™ estiver trabalhando no Windows, por padr√£o, o arquivo ser√° salvo com um retorno de carro e n√£o poder√° ser carregado no Vertica. <br><br>  N√≥s nos conectamos ao servidor do cluster Vertica, no qual salvamos o arquivo e carregamos a biblioteca: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIBRARY</span></span> MtCarsLibs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'/home/dbadmin/mtcars_func.r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'R'</span></span>;</code> </pre> <br>  Agora, nesta biblioteca, voc√™ pode registrar a fun√ß√£o R: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> TRANSFORM <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.MtCarsAnalize <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'R'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-string"><span class="hljs-string">'MtCarsAnalizeFactory'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIBRARY</span></span> MtCarsLibs; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> TRANSFORM <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.MtCarsAnalize(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>;</code> </pre> <br><h2>  Chamar fun√ß√µes R no Vertica </h2><br>  Chamamos a fun√ß√£o R, passando o texto do modelo, que foi salvo anteriormente como uma fun√ß√£o UDF: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MtCarsAnalize(car_model, cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">model</span></span> = public.MtCarsAnalizeModel()) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars;</code> </pre> <br><img src="https://habrastorage.org/webt/8a/om/ve/8aomvezlxe_-0n4gnyonxkr25om.jpeg"><br><br>  Pode-se verificar que, assim como nos casos anteriores, a previs√£o √© 100% consistente com o estado real das coisas: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.*, p.predict, p.predict = c.am::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars c <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MtCarsAnalize(car_model, cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">model</span></span> = public.MtCarsAnalizeModel()) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars ) p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.car_model = p.car_model</code> </pre> <br>  <b>Observe:</b> as fun√ß√µes de transforma√ß√£o no Vertica retornam seu pr√≥prio conjunto de dados dos campos e registros definidos nas fun√ß√µes; no entanto, elas podem ser usadas em consultas se agrupadas em uma subconsulta. <br><br>  Quando as fun√ß√µes R s√£o conectadas, a Vertica copia o c√≥digo-fonte para sua instala√ß√£o, que √© compilado no c√≥digo da m√°quina.  O arquivo R de origem carregado no servidor ap√≥s a conex√£o com a biblioteca n√£o √© necess√°rio para trabalho adicional.  A velocidade das fun√ß√µes que levam em considera√ß√£o a compila√ß√£o bin√°ria √© alta o suficiente para trabalhar com grandes matrizes de dados; no entanto, vale lembrar que todas as opera√ß√µes R s√£o executadas na mem√≥ria e existe o risco de troca, se houver falta de mem√≥ria do SO para atender √†s necessidades da Vertica e R trabalhando juntas. . <br><br>  Se a fun√ß√£o for chamada na parti√ß√£o dos dados especificados em PARTITION BY for OVER, o Vertica paraleliza a execu√ß√£o de cada parti√ß√£o nos servidores de cluster.  Portanto, se um fabricante ainda estivesse presente no conjunto de dados, al√©m do modelo da m√°quina, voc√™ poderia especific√°-lo em PARTITION BY e paralelizar a an√°lise para cada fabricante. <br><br><h2>  Outras oportunidades de aprendizado de m√°quina da Vertica </h2><br>  Al√©m do R, a Vertica pode desenvolver suas pr√≥prias fun√ß√µes de transforma√ß√£o em C, Java e Python.  Cada idioma possui suas pr√≥prias nuances e recursos para escrever e se conectar ao Vertica.  Juntamente com seu pr√≥prio ML, tudo isso confere √† Vertica uma boa reserva para an√°lise preditiva de dados. <br><br><h2>  Obrigado e links </h2><br>  Quero sinceramente agradecer ao meu amigo e colega Vlad Malofeev, da Perm, que me apresentou a R e me ajudou a descobrir isso em um de nossos projetos conjuntos. <br><br>  Inicialmente, em um projeto em que uma previs√£o foi feita em condi√ß√µes dif√≠ceis para o futuro usando dados do ano passado, os desenvolvedores tentaram usar SQL e Java.  Isso causou grandes dificuldades, levando em considera√ß√£o a qualidade dessas fontes e atrasou bastante o desenvolvimento do projeto.  Vlad veio ao projeto com R, conectamos R √† Vertica, ele dirigiu os dados para o est√∫dio e tudo girou e virou lindamente imediatamente.  Literalmente em semanas, tudo o que durou meses foi varrido, salvando o projeto de c√≥digos complexos. <br><br>  Os dados de exemplo com carros podem ser baixados do reposit√≥rio GIT: <br><br><pre> <code class="plaintext hljs">git clone https://github.com/vertica/Machine-Learning-Examples</code> </pre> <br>  e fa√ßa o upload para o Vertica: <br><br><pre> <code class="plaintext hljs">/opt/vertica/bin/vsql -d &lt;name of your database&gt; -f load_ml_data.sql</code> </pre> <br>  Se voc√™ deseja aprofundar-se no ML e aprender a trabalhar com R, recomendo um livro em russo <b>"R em a√ß√£o".</b>  <b>An√°lise e visualiza√ß√£o de dados na linguagem R. ‚Äù</b>  Ele foi escrito em uma linguagem humana simples e acess√≠vel e √© adequado para iniciantes que ainda n√£o encontraram o aprendizado de m√°quina. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> voc√™ pode ver informa√ß√µes sobre como conectar a biblioteca R ao Vertica. <br><br>  Para quem j√° come√ßou a aprender e usar o ML em Python, vale a pena prestar aten√ß√£o no IDE Rodeo, este √© um an√°logo do R Studio, porque sem a an√°lise interativa da qualidade √© imposs√≠vel.  Penso que tudo o que √© descrito neste artigo no R de maneira semelhante pode ser desenvolvido em Python, incluindo salvar o modelo em fun√ß√µes UDF e desenvolver fun√ß√µes de an√°lise para o Vertica.  Se voc√™ marcar, n√£o se esque√ßa de cancelar a inscri√ß√£o sobre os resultados nos coment√°rios, serei grato pelas informa√ß√µes. <br><br>  Obrigado pelo seu tempo e espero poder demonstrar a simplicidade e os incr√≠veis recursos da simbiose de R e Vertica. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt436306/">https://habr.com/ru/post/pt436306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt436296/index.html">expl√≠cito em detalhes</a></li>
<li><a href="../pt436298/index.html">Ideias da mesa: vinil virtual</a></li>
<li><a href="../pt436300/index.html">9 principais pr√°ticas de seguran√ßa no Kubernetes</a></li>
<li><a href="../pt436302/index.html">Experi√™ncia de substitui√ß√£o de importa√ß√£o real usando o sistema de armazenamento russo AERODISK</a></li>
<li><a href="../pt436304/index.html">Zimbra Collaboration Suite e a luta contra o phishing</a></li>
<li><a href="../pt436308/index.html">Rostelecom pode se tornar um monopolista no mercado de data centers</a></li>
<li><a href="../pt436310/index.html">Como as m√©tricas de Ivan, o DevOps fez. Objeto de influ√™ncia</a></li>
<li><a href="../pt436312/index.html">S√≠ntese de fala em rede neural usando a arquitetura Tacotron 2, ou "Fa√ßa o alinhamento ou tente morrer"</a></li>
<li><a href="../pt436314/index.html">Hotel-rob√¥ japon√™s "disparou" metade de seus rob√¥s devido aos problemas que eles criam</a></li>
<li><a href="../pt436316/index.html">Como os cart√µes inteligentes ajudam a impulsionar projetos de TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>