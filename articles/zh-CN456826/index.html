<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤Ÿ ğŸ’ˆ ğŸ§“ğŸ¿ ä½¿ç”¨AWXï¼ŒAnsibleï¼Œhaproxyå’ŒCROC Cloudè¿›è¡ŒDIYè‡ªåŠ¨ç¼©æ”¾ ğŸ‘‡ğŸ¼ ğŸ‘› â¬‡ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸ä¹…å‰ï¼Œæˆ‘ä»¬ä¸ºæ­¤è¿›è¡Œäº†æ— ä»£ç†ç›‘è§†å’Œè­¦æŠ¥ã€‚ è¿™ä¸å…·æœ‰å…¼å®¹APIçš„AWSä¸­çš„CloudWatchç±»ä¼¼ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬æ­£åœ¨ç ”ç©¶å¹³è¡¡å™¨å’Œè‡ªåŠ¨ç¼©æ”¾ã€‚ ä½†æ˜¯ï¼Œå°½ç®¡æˆ‘ä»¬ä¸æä¾›æ­¤ç±»æœåŠ¡ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡ä½¿ç”¨æˆ‘ä»¬çš„ç›‘è§†å’Œæ ‡ç­¾ï¼ˆAWSèµ„æºæ ‡ç­¾APIï¼‰ä½œä¸ºç®€å•çš„æœåŠ¡å‘ç°ä½œä¸ºæ•°æ®æºï¼Œè®©å®¢æˆ·è‡ªå·±å®Œæˆè¿™é¡¹æœåŠ¡ã€‚ æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­å±•ç¤º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨AWXï¼ŒAnsibleï¼Œhaproxyå’ŒCROC Cloudè¿›è¡ŒDIYè‡ªåŠ¨ç¼©æ”¾</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/456826/"><p><img src="https://habrastorage.org/webt/6f/nt/tj/6fnttjgdk8vat9bbsahsnck_rfa.jpeg" alt="å›¾ç‰‡"></p><br><p> ä¸ä¹…å‰ï¼Œæˆ‘ä»¬ä¸ºæ­¤è¿›è¡Œäº†æ— ä»£ç†ç›‘è§†å’Œè­¦æŠ¥ã€‚ è¿™ä¸å…·æœ‰å…¼å®¹APIçš„AWSä¸­çš„CloudWatchç±»ä¼¼ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬æ­£åœ¨ç ”ç©¶å¹³è¡¡å™¨å’Œè‡ªåŠ¨ç¼©æ”¾ã€‚ ä½†æ˜¯ï¼Œå°½ç®¡æˆ‘ä»¬ä¸æä¾›æ­¤ç±»æœåŠ¡ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡ä½¿ç”¨æˆ‘ä»¬çš„ç›‘è§†å’Œæ ‡ç­¾ï¼ˆAWSèµ„æºæ ‡ç­¾APIï¼‰ä½œä¸ºç®€å•çš„æœåŠ¡å‘ç°ä½œä¸ºæ•°æ®æºï¼Œè®©å®¢æˆ·è‡ªå·±å®Œæˆè¿™é¡¹æœåŠ¡ã€‚ æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­å±•ç¤ºå¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œã€‚ </p><a name="habracut"></a><br><p> ç®€å•WebæœåŠ¡çš„æœ€å°åŸºç¡€ç»“æ„çš„ç¤ºä¾‹ï¼šDNS-&gt; 2ä¸ªå‡è¡¡å™¨-&gt; 2ä¸ªåç«¯ã€‚ å¯ä»¥å°†è¿™ç§åŸºç¡€ç»“æ„è§†ä¸ºå®¹é”™æ“ä½œå’Œç»´æŠ¤çš„æœ€ä½è¦æ±‚ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬ä¸ä¼šå†â€œå‹ç¼©â€è¯¥åŸºç¡€æ¶æ„ï¼Œä¾‹å¦‚åªå‰©ä¸‹ä¸€ä¸ªåç«¯ã€‚ ä½†æ˜¯æˆ‘æƒ³å¢åŠ åç«¯æœåŠ¡å™¨çš„æ•°é‡å¹¶å‡å°‘åˆ°ä¸¤ä¸ªã€‚ è¿™å°†æ˜¯æˆ‘ä»¬çš„ä»»åŠ¡ã€‚ æ‰€æœ‰ç¤ºä¾‹éƒ½å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">èµ„æºåº“ä¸­æ‰¾åˆ°</a> ã€‚ </p><br><h3 id="bazovaya-infrastruktura"> åŸºæœ¬åŸºç¡€è®¾æ–½ </h3><br><p> æˆ‘ä»¬ä¸ä¼šè¯¦ç»†ä»‹ç»ä¸Šè¿°åŸºç¡€ç»“æ„çš„é…ç½®ï¼Œåªä¼šæ˜¾ç¤ºå¦‚ä½•åˆ›å»ºå®ƒã€‚ æˆ‘ä»¬æ›´å–œæ¬¢ä½¿ç”¨Terraforméƒ¨ç½²åŸºç¡€æ¶æ„ã€‚ å®ƒæœ‰åŠ©äºå¿«é€Ÿåˆ›å»ºæ‰€éœ€çš„ä¸€åˆ‡ï¼ˆVPCï¼Œå­ç½‘ï¼Œå®‰å…¨ç»„ï¼ŒVMï¼‰ï¼Œå¹¶ä¸€æ¬¡åˆä¸€æ¬¡åœ°é‡å¤æ­¤è¿‡ç¨‹ã€‚ </p><br><p> ç”¨äºæé«˜åŸºæœ¬åŸºç¡€ç»“æ„çš„è„šæœ¬ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ä¸»æ–‡ä»¶</b> <div class="spoiler_text"><pre><code class="bash hljs">variable <span class="hljs-string"><span class="hljs-string">"ec2_url"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"access_key"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"secret_key"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"region"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"vpc_cidr_block"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"instance_type"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"big_instance_type"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"az"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"ami"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"client_ip"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"material"</span></span> {} provider <span class="hljs-string"><span class="hljs-string">"aws"</span></span> { endpoints { ec2 = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.ec2_url}</span></span></span><span class="hljs-string">"</span></span> } skip_credentials_validation = <span class="hljs-literal"><span class="hljs-literal">true</span></span> skip_requesting_account_id = <span class="hljs-literal"><span class="hljs-literal">true</span></span> skip_region_validation = <span class="hljs-literal"><span class="hljs-literal">true</span></span> access_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.access_key}</span></span></span><span class="hljs-string">"</span></span> secret_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.secret_key}</span></span></span><span class="hljs-string">"</span></span> region = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.region}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_vpc"</span></span> <span class="hljs-string"><span class="hljs-string">"vpc"</span></span> { cidr_block = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.vpc_cidr_block}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_subnet"</span></span> <span class="hljs-string"><span class="hljs-string">"subnet"</span></span> { availability_zone = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.az}</span></span></span><span class="hljs-string">"</span></span> vpc_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_vpc.vpc.id}</span></span></span><span class="hljs-string">"</span></span> cidr_block = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_security_group"</span></span> <span class="hljs-string"><span class="hljs-string">"sg"</span></span> { name = <span class="hljs-string"><span class="hljs-string">"auto-scaling"</span></span> vpc_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_vpc.vpc.id}</span></span></span><span class="hljs-string">"</span></span> ingress { from_port = 22 to_port = 22 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"0.0.0.0/0"</span></span>] } ingress { from_port = 80 to_port = 80 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span>] } ingress { from_port = 8080 to_port = 8080 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span>] } egress { from_port = 0 to_port = 0 protocol = <span class="hljs-string"><span class="hljs-string">"-1"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"0.0.0.0/0"</span></span>] } } resource <span class="hljs-string"><span class="hljs-string">"aws_key_pair"</span></span> <span class="hljs-string"><span class="hljs-string">"key"</span></span> { key_name = <span class="hljs-string"><span class="hljs-string">"auto-scaling-new"</span></span> public_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.material}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_instance"</span></span> <span class="hljs-string"><span class="hljs-string">"compute"</span></span> { count = 5 ami = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.ami}</span></span></span><span class="hljs-string">"</span></span> instance_type = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${count.index == 0 ? var.big_instance_type : var.instance_type}</span></span></span><span class="hljs-string">"</span></span> key_name = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_key_pair.key.key_name}</span></span></span><span class="hljs-string">"</span></span> subnet_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_subnet.subnet.id}</span></span></span><span class="hljs-string">"</span></span> availability_zone = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.az}</span></span></span><span class="hljs-string">"</span></span> security_groups = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_security_group.sg.id}</span></span></span><span class="hljs-string">"</span></span>] } resource <span class="hljs-string"><span class="hljs-string">"aws_eip"</span></span> <span class="hljs-string"><span class="hljs-string">"pub_ip"</span></span> { instance = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_instance.compute.0.id}</span></span></span><span class="hljs-string">"</span></span> vpc = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } output <span class="hljs-string"><span class="hljs-string">"awx"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_eip.pub_ip.public_ip}</span></span></span><span class="hljs-string">"</span></span> } output <span class="hljs-string"><span class="hljs-string">"haproxy_id"</span></span> { value = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${slice(aws_instance.compute.*.id, 1, 3)}</span></span></span><span class="hljs-string">"</span></span>] } output <span class="hljs-string"><span class="hljs-string">"awx_id"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_instance.compute.0.id}</span></span></span><span class="hljs-string">"</span></span> } output <span class="hljs-string"><span class="hljs-string">"backend_id"</span></span> { value = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${slice(aws_instance.compute.*.id, 3, 5)}</span></span></span><span class="hljs-string">"</span></span>] }</code> </pre> </div></div><br><p> ç°ä»£äº‘çš„æ™®é€šç”¨æˆ·ä¼¼ä¹åº”è¯¥ç†è§£æ­¤é…ç½®ä¸­æè¿°çš„æ‰€æœ‰å®ä½“ã€‚ ç‰¹å®šäºæˆ‘ä»¬çš„äº‘å’Œç‰¹å®šä»»åŠ¡çš„å˜é‡å°†ç§»è‡³å•ç‹¬çš„æ–‡ä»¶-terraform.tfvarsï¼š </p><br><div class="spoiler">  <b class="spoiler_title">terraform.tfvars</b> <div class="spoiler_text"><pre> <code class="bash hljs">ec2_url = <span class="hljs-string"><span class="hljs-string">"https://api.cloud.croc.ru"</span></span> access_key = <span class="hljs-string"><span class="hljs-string">"project:user@customer"</span></span> secret_key = <span class="hljs-string"><span class="hljs-string">"secret-key"</span></span> region = <span class="hljs-string"><span class="hljs-string">"croc"</span></span> az = <span class="hljs-string"><span class="hljs-string">"ru-msk-vol51"</span></span> instance_type = <span class="hljs-string"><span class="hljs-string">"m1.2small"</span></span> big_instance_type = <span class="hljs-string"><span class="hljs-string">"m1.large"</span></span> vpc_cidr_block = <span class="hljs-string"><span class="hljs-string">"10.10.0.0/16"</span></span> ami = <span class="hljs-string"><span class="hljs-string">"cmi-3F5B011E"</span></span></code> </pre> </div></div><br><p> å¯åŠ¨Terraformï¼š </p><br><div class="spoiler">  <b class="spoiler_title">terraformé€‚ç”¨</b> <div class="spoiler_text"><pre> <code class="bash hljs">yes yes | terraform apply -var client_ip=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(curl -s ipinfo.io/ip)</span></span></span><span class="hljs-string">/32"</span></span> -var material=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat &lt;ssh_publick_key_path&gt;)</span></span></span><span class="hljs-string">"</span></span></code> </pre> </div></div><br><h3 id="nastroyka-monitoringa"> ç›‘æ§è®¾ç½® </h3><br><p> ä¸Šé¢å¯åŠ¨çš„VMç”±æˆ‘ä»¬çš„äº‘è‡ªåŠ¨ç›‘è§†ã€‚ æ­¤ç›‘è§†æ•°æ®å°†æˆä¸ºå°†æ¥è‡ªåŠ¨ç¼©æ”¾çš„ä¿¡æ¯æºã€‚ ä¾é æŸäº›æŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥å¢åŠ æˆ–å‡å°‘åŠŸç‡ã€‚ </p><br><p> åœ¨æˆ‘ä»¬çš„äº‘ä¸­è¿›è¡Œç›‘è§†å¯ä»¥ä½¿æ‚¨æ ¹æ®ä¸åŒæ¡ä»¶é’ˆå¯¹ä¸åŒæŒ‡æ ‡é…ç½®è­¦æŠ¥ã€‚ éå¸¸æ–¹ä¾¿ã€‚ æˆ‘ä»¬ä¸éœ€è¦ä»»ä½•æ—¶é—´é—´éš”åˆ†ææŒ‡æ ‡å¹¶åšå‡ºå†³å®š-è¿™å°†é€šè¿‡äº‘ç›‘æ§æ¥å®Œæˆã€‚ åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è­¦æŠ¥ä½œä¸ºCPUæŒ‡æ ‡ï¼Œä½†åœ¨æˆ‘ä»¬çš„ç›‘æ§ä¸­ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹ä»¥ä¸‹æŒ‡æ ‡é…ç½®è­¦æŠ¥ï¼šç½‘ç»œåˆ©ç”¨ç‡ï¼ˆé€Ÿåº¦/ ppsï¼‰ï¼Œç£ç›˜åˆ©ç”¨ç‡ï¼ˆé€Ÿåº¦/ iopsï¼‰ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">cloudwatch put-metric-alarm</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CLOUDWATCH_URL=https://monitoring.cloud.croc.ru <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> instance_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$CLOUDWATCH_URL</span></span> \ cloudwatch put-metric-alarm \ --alarm-name <span class="hljs-string"><span class="hljs-string">"scaling-low_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --dimensions Name=InstanceId,Value=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --namespace <span class="hljs-string"><span class="hljs-string">"AWS/EC2"</span></span> --metric-name CPUUtilization --statistic Average \ --period 60 --evaluation-periods 3 --threshold 15 --comparison-operator LessThanOrEqualToThreshold; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> instance_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$CLOUDWATCH_URL</span></span> \ cloudwatch put-metric-alarm\ --alarm-name <span class="hljs-string"><span class="hljs-string">"scaling-high_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --dimensions Name=InstanceId,Value=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --namespace <span class="hljs-string"><span class="hljs-string">"AWS/EC2"</span></span> --metric-name CPUUtilization --statistic Average\ --period 60 --evaluation-periods 3 --threshold 80 --comparison-operator GreaterThanOrEqualToThreshold; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p> ä¸€äº›å¯èƒ½éš¾ä»¥ç†è§£çš„å‚æ•°çš„æè¿°ï¼š </p><br><p>  --profile-aws-cliè®¾ç½®é…ç½®æ–‡ä»¶ï¼Œåœ¨ã€œ/ .aws / configä¸­æè¿°ã€‚ é€šå¸¸ï¼Œåœ¨ä¸åŒçš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸åŒçš„è®¿é—®å¯†é’¥ã€‚ </p><br><p>  --dimensions-åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œè¯¥å‚æ•°ç¡®å®šå°†é’ˆå¯¹å“ªä¸ªèµ„æºåˆ›å»ºè­¦æŠ¥ï¼Œè¯¥å®ä¾‹çš„æ ‡è¯†ç¬¦æ¥è‡ªå˜é‡$ instance_idã€‚ </p><br><p>  --namespace-ä»ä¸­é€‰æ‹©ç›‘è§†æŒ‡æ ‡çš„åç§°ç©ºé—´ã€‚ </p><br><p>  --metric-name-ç›‘è§†æŒ‡æ ‡çš„åç§°ã€‚ </p><br><p>  --statistic-æŒ‡æ ‡å€¼èšåˆæ–¹æ³•çš„åç§°ã€‚ </p><br><p>  --period-ç›‘è§†å€¼æ”¶é›†äº‹ä»¶ä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚ </p><br><p>  --evaluation-periods-è§¦å‘è­¦æŠ¥æ‰€éœ€çš„æ—¶é—´é—´éš”æ•°ã€‚ </p><br><p>  --threshold-ç”¨äºè¯„ä¼°è­¦æŠ¥çŠ¶æ€çš„åº¦é‡æ ‡å‡†é˜ˆå€¼ã€‚ </p><br><p>  --comparison-operator-ä¸€ç§ç”¨äºè¯„ä¼°ç›¸å¯¹äºé˜ˆå€¼çš„æŒ‡æ ‡å€¼çš„æ–¹æ³•ã€‚ </p></div></div><br><p> åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸ºæ¯ä¸ªåç«¯å®ä¾‹åˆ›å»ºäº†ä¸¤ä¸ªè­¦æŠ¥ã€‚ å½“CPUè´Ÿè½½å°äº15ï¼…çš„æ—¶é—´æŒç»­3åˆ†é’Ÿæ—¶ï¼ŒScaling-low- &lt;instance-id&gt;å°†è¿›å…¥â€œè­¦æŠ¥â€çŠ¶æ€ã€‚ å½“CPUè´Ÿè½½è¶…è¿‡80ï¼…3åˆ†é’Ÿåï¼ŒScaling-high- &lt;instance-id&gt;å°†è¿›å…¥æŠ¥è­¦çŠ¶æ€ã€‚ </p><br><h3 id="nastroyka-tegov"> æ ‡ç­¾å®šåˆ¶ </h3><br><p> è®¾ç½®ç›‘è§†åï¼Œæˆ‘ä»¬é¢ä¸´ä»¥ä¸‹ä»»åŠ¡-å®ä¾‹åŠå…¶åç§°çš„å‘ç°ï¼ˆæœåŠ¡å‘ç°ï¼‰ã€‚ æˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼äº†è§£æˆ‘ä»¬ç°åœ¨å·²ç»å¯åŠ¨äº†å¤šå°‘ä¸ªåç«¯å®ä¾‹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“å®ƒä»¬çš„åç§°ã€‚ ä¾‹å¦‚ï¼Œåœ¨äº‘ä¹‹å¤–çš„ä¸–ç•Œä¸­ï¼Œé¢†äº‹å’Œé¢†äº‹æ¨¡æ¿å°†éå¸¸é€‚åˆç”Ÿæˆå¹³è¡¡å™¨é…ç½®ã€‚ ä½†æ˜¯æˆ‘ä»¬çš„äº‘ä¸­æœ‰æ ‡ç­¾ã€‚ æ ‡ç­¾å°†å¸®åŠ©æˆ‘ä»¬å¯¹èµ„æºè¿›è¡Œåˆ†ç±»ã€‚ é€šè¿‡è¯·æ±‚æœ‰å…³ç‰¹å®šæ ‡è®°ï¼ˆæè¿°æ ‡è®°ï¼‰çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£æ± ä¸­å½“å‰æœ‰å¤šå°‘ä¸ªå®ä¾‹ä»¥åŠå®ƒä»¬å…·æœ‰ä»€ä¹ˆIDã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå”¯ä¸€çš„å®ä¾‹IDç”¨ä½œä¸»æœºåã€‚ ç”±äºVPCå†…éƒ¨æœ‰å†…éƒ¨DNSï¼Œè¿™äº›ID /ä¸»æœºåè§£æä¸ºå†…éƒ¨IPå®ä¾‹ã€‚ </p><br><p> æˆ‘ä»¬ä¸ºåç«¯å®ä¾‹å’Œå¹³è¡¡å™¨è®¾ç½®æ ‡ç­¾ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ec2åˆ›å»ºæ ‡ç­¾</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> EC2_URL=<span class="hljs-string"><span class="hljs-string">"https://api.cloud.croc.ru"</span></span> aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"&lt;awx_instance_id&gt;"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=awx <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=backend ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;haproxy_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=haproxy; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>;</code> </pre> <br><p> å…¶ä¸­ï¼š </p><br><p>  --resources-å°†è®¾ç½®æ ‡ç­¾çš„èµ„æºæ ‡è¯†ç¬¦çš„åˆ—è¡¨ã€‚ </p><br><p>  --tagsæ˜¯é”®å€¼å¯¹çš„åˆ—è¡¨ã€‚ </p></div></div><br><p>  CROC Cloud <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£ä¸­</a>æä¾›äº†ä¸€ä¸ªç¤ºä¾‹æè¿°æ ‡ç­¾ã€‚ </p><br><h3 id="nastroyka-avtoskeylinga"> è‡ªåŠ¨ç¼©æ”¾è®¾ç½® </h3><br><p> ç°åœ¨äº‘æ­£åœ¨ç›‘è§†ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“å¦‚ä½•ä½¿ç”¨æ ‡ç­¾ï¼Œæˆ‘ä»¬åªèƒ½è½®è¯¢å·²é…ç½®è­¦æŠ¥çš„çŠ¶æ€ä»¥è¿›è¡Œè§¦å‘ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå®ä½“ï¼Œè¯¥å®ä½“å°†å‚ä¸å®šæœŸç›‘è§†ï¼Œç›‘è§†å’Œå¯åŠ¨åˆ›å»º/åˆ é™¤å®ä¾‹çš„ä»»åŠ¡ã€‚ åœ¨è¿™é‡Œå¯ä»¥åº”ç”¨å„ç§è‡ªåŠ¨åŒ–å·¥å…·ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨AWXã€‚  AWXæ˜¯å•†ä¸š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Ansible Tower</a>çš„å¼€æºç‰ˆæœ¬ï¼Œè¯¥äº§å“ç”¨äºé›†ä¸­ç®¡ç†AnsibleåŸºç¡€æ¶æ„ã€‚ ä¸»è¦ä»»åŠ¡æ˜¯å®šæœŸå¯åŠ¨æˆ‘ä»¬çš„ansibleå‰§æœ¬ã€‚ </p><br><p>  AWXéƒ¨ç½²çš„ç¤ºä¾‹å¯åœ¨å®˜æ–¹å­˜å‚¨åº“çš„<a href="">Wiki</a>é¡µé¢ä¸Šæ‰¾åˆ°ã€‚  Ansible Toweræ–‡æ¡£ä¸­ä¹Ÿæè¿°äº†AWXé…ç½®ã€‚ ä¸ºäº†ä½¿AWXå¼€å§‹è¿è¡Œè‡ªå®šä¹‰å‰§æœ¬ï¼Œæ‚¨å¿…é¡»é€šè¿‡åˆ›å»ºä»¥ä¸‹å®ä½“å¯¹å…¶è¿›è¡Œé…ç½®ï¼š </p><br><ul><li> ä¸‰ç§ç±»å‹çš„å‡­è¯ï¼š <br>  <em>-AWSå‡­è¯-æˆæƒä¸CROCäº‘ç›¸å…³çš„æ“ä½œã€‚</em> <em><br></em>  -æœºå™¨å‡­æ®-ç”¨äºè®¿é—®æ–°åˆ›å»ºå®ä¾‹çš„sshå¯†é’¥ã€‚ <br>  -SCMå‡­è¯-ç”¨äºç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­çš„æˆæƒã€‚ </li><li>  Projectæ˜¯ä¸€ä¸ªå®ä½“ï¼Œå®ƒå°†ä»å‰§æœ¬ä¸­æ¨é€gitå­˜å‚¨åº“ã€‚ </li><li> è„šæœ¬-åŠ¨æ€æ¸…å•è„šæœ¬ã€‚ </li><li> åº“å­˜æ˜¯ä¸€ä¸ªå®ä½“ï¼Œå®ƒå°†åœ¨å¯åŠ¨å‰§æœ¬ä¹‹å‰è°ƒç”¨åŠ¨æ€åº“å­˜è„šæœ¬ã€‚ </li><li> æ¨¡æ¿-ç‰¹å®šå‰§æœ¬è°ƒç”¨çš„é…ç½®ï¼Œç”±Projectçš„ä¸€ç»„å‡­æ®ï¼Œæ¸…å•å’Œå‰§æœ¬ç»„æˆã€‚ </li><li> å·¥ä½œæµç¨‹-å¯¹å‰§æœ¬çš„ä¸€ç³»åˆ—è°ƒç”¨ã€‚ </li></ul><br><p> è‡ªåŠ¨ç¼©æ”¾è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š </p><br><ul><li>  scale_up-è‡³å°‘è§¦å‘ä¸€ä¸ªé«˜è­¦æŠ¥æ—¶åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼› </li><li>  scale_down-å¦‚æœä½è­¦æŠ¥å¯¹å…¶èµ·ä½œç”¨ï¼Œåˆ™ç»ˆæ­¢è¯¥å®ä¾‹ã€‚ </li></ul><br><p> ä½œä¸ºscale_upéƒ¨åˆ†çš„ä¸€éƒ¨åˆ†ï¼Œæ‚¨å°†éœ€è¦ï¼š </p><br><ul><li> å‘äº‘ç›‘è§†æœåŠ¡è¯¢é—®â€œè­¦æŠ¥â€çŠ¶æ€ä¸‹æ˜¯å¦å­˜åœ¨é«˜è­¦æŠ¥ï¼› </li><li> å¦‚æœæ‰€æœ‰é«˜è­¦æŠ¥éƒ½å¤„äºâ€œ OKâ€çŠ¶æ€ï¼Œåˆ™æå‰åœæ­¢scale_upï¼› </li><li> åˆ›å»ºå…·æœ‰å¿…è¦å±æ€§ï¼ˆæ ‡ç­¾ï¼Œå­ç½‘ï¼Œsecurity_groupç­‰ï¼‰çš„æ–°å®ä¾‹ï¼› </li><li> ä¸ºæ­£åœ¨è¿è¡Œçš„å®ä¾‹åˆ›å»ºé«˜ä½è­¦æŠ¥ï¼› </li><li> åœ¨æ–°å®ä¾‹ä¸­é…ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒåªæ˜¯å¸¦æœ‰æµ‹è¯•é¡µçš„nginxï¼‰ï¼› </li><li> æ›´æ–°haproxyé…ç½®ï¼Œé‡æ–°åŠ è½½ï¼Œä»¥ä½¿è¯·æ±‚å¼€å§‹è¿›å…¥æ–°å®ä¾‹ã€‚ </li></ul><br><div class="spoiler">  <b class="spoiler_title">create-instance.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">--- - name: get alarm statuses describe_alarms: region: "croc" alarm_name_prefix: "scaling-high" alarm_state: "alarm" register: describe_alarms_query - name: stop if no alarms fired fail: msg: zero high alarms in alarm state when: describe_alarms_query.meta | length == 0 - name: create instance ec2: region: "croc" wait: yes state: present count: 1 key_name: "{{ hostvars[groups['tag_role_backend'][0]].ec2_key_name }}" instance_type: "{{ hostvars[groups['tag_role_backend'][0]].ec2_instance_type }}" image: "{{ hostvars[groups['tag_role_backend'][0]].ec2_image_id }}" group_id: "{{ hostvars[groups['tag_role_backend'][0]].ec2_security_group_ids }}" vpc_subnet_id: "{{ hostvars[groups['tag_role_backend'][0]].ec2_subnet_id }}" user_data: | #!/bin/sh sudo yum install epel-release -y sudo yum install nginx -y cat &lt;&lt;EOF &gt; /etc/nginx/conf.d/dummy.conf server { listen 8080; location / { return 200 '{"message": "$HOSTNAME is up"}'; } } EOF sudo systemctl restart nginx loop: "{{ hostvars[groups['tag_role_backend'][0]] }}" register: new - name: create tag entry ec2_tag: ec2_url: "https://api.cloud.croc.ru" region: croc state: present resource: "{{ item.id }}" tags: role: backend loop: "{{ new.instances }}" - name: create low alarms ec2_metric_alarm: state: present region: croc name: "scaling-low_{ item.id }}" metric: "CPUUtilization" namespace: "AWS/EC2" statistic: Average comparison: "&lt;=" threshold: 15 period: 300 evaluation_periods: 3 unit: "Percent" dimensions: {'InstanceId':"{{ item.id }}"} loop: "{{ new.instances }}" - name: create high alarms ec2_metric_alarm: state: present region: croc name: "scaling-high_{{ item.id }}" metric: "CPUUtilization" namespace: "AWS/EC2" statistic: Average comparison: "&gt;=" threshold: 80.0 period: 300 evaluation_periods: 3 unit: "Percent" dimensions: {'InstanceId':"{{ item.id }}"} loop: "{{ new.instances }}"</code> </pre> </div></div><br><p> åœ¨create-instance.yamlä¸­ï¼Œå‘ç”Ÿçš„äº‹æƒ…æ˜¯ï¼šä½¿ç”¨æ­£ç¡®çš„å‚æ•°åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œå¯¹è¯¥å®ä¾‹è¿›è¡Œæ ‡è®°å¹¶åˆ›å»ºå¿…è¦çš„è­¦æŠ¥ã€‚  Nginxå®‰è£…å’Œé…ç½®è„šæœ¬ä¹Ÿé€šè¿‡ç”¨æˆ·æ•°æ®ä¼ é€’ã€‚ ç”¨æˆ·æ•°æ®ç”±cloud-initæœåŠ¡å¤„ç†ï¼Œè¯¥æœåŠ¡å¯åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­çµæ´»é…ç½®å®ä¾‹ï¼Œè€Œæ— éœ€å€ŸåŠ©å…¶ä»–è‡ªåŠ¨åŒ–å·¥å…·ã€‚ </p><br><p> åœ¨update-lb.yamlä¸­ï¼Œåœ¨haproxyå®ä¾‹å’Œé‡æ–°åŠ è½½haproxyæœåŠ¡ä¸Šé‡æ–°åˆ›å»º/etc/haproxy/haproxy.cfgæ–‡ä»¶ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">update-lb.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- name: update haproxy configs template: src: haproxy.cfg.j2 dest: /etc/haproxy/haproxy.cfg - name: add new backend host to haproxy systemd: name: haproxy state: restarted</code> </pre> </div></div><br><p> å…¶ä¸­haproxy.cfg.j2æ˜¯haproxyæœåŠ¡é…ç½®æ–‡ä»¶æ¨¡æ¿ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">haproxy.cfg.j2</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># {{ ansible_managed }} global log /dev/log local0 log /dev/log local1 notice chroot /var/lib/haproxy stats timeout 30s user haproxy group haproxy daemon defaults log global mode http option httplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 frontend loadbalancing bind *:80 mode http default_backend backendnodes backend backendnodes balance roundrobin option httpchk HEAD / {% for host in groups['tag_role_backend'] %} server {{hostvars[host]['ec2_id']}} {{hostvars[host]['ec2_private_ip_address']}}:8080 check {% endfor %}</code> </pre> </div></div><br><p> ç”±äºé€‰é¡¹httpchké€‰é¡¹æ˜¯åœ¨haproxyåç«¯éƒ¨åˆ†ä¸­å®šä¹‰çš„ï¼Œå› æ­¤haproxyæœåŠ¡å°†è‡ªåŠ¨è½®è¯¢åç«¯å®ä¾‹çš„çŠ¶æ€ï¼Œå¹¶ä¸”ä»…å¹³è¡¡è¿‡å»è¿è¡ŒçŠ¶å†µæ£€æŸ¥ä¹‹é—´çš„æµé‡ã€‚ </p><br><p> åœ¨scale_downéƒ¨åˆ†ä¸­ï¼Œæ‚¨éœ€è¦ï¼š </p><br><ul><li> æ£€æŸ¥çŠ¶æ€ä½æŠ¥è­¦ï¼› </li><li> å¦‚æœåœ¨â€œè­¦æŠ¥â€çŠ¶æ€ä¸‹æ²¡æœ‰ä½è­¦æŠ¥ï¼Œåˆ™è¿‡æ—©ç»ˆæ­¢æ’­æ”¾ï¼› </li><li> ç»ˆæ­¢æ‰€æœ‰å±äºä½è­¦æŠ¥çº§åˆ«çš„å®ä¾‹ï¼› </li><li> ç¦æ­¢ç»ˆæ­¢æœ€åä¸€å¯¹å®ä¾‹ï¼Œå³ä½¿å®ƒä»¬çš„è­¦æŠ¥å¤„äºâ€œè­¦æŠ¥â€çŠ¶æ€ï¼› </li><li> åˆ é™¤æˆ‘ä»¬ä»è´Ÿè½½å‡è¡¡å™¨é…ç½®ä¸­åˆ é™¤çš„å®ä¾‹ã€‚ </li></ul><br><div class="spoiler">  <b class="spoiler_title">destroy-instance.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- name: look for alarm status describe_alarms: region: "croc" alarm_name_prefix: "scaling-low" alarm_state: "alarm" register: describe_alarms_query - name: count alarmed instances set_fact: alarmed_count: "{{ describe_alarms_query.meta | length }}" alarmed_ids: "{{ describe_alarms_query.meta }}" - name: stop if no alarms fail: msg: no alarms fired when: alarmed_count | int == 0 - name: count all described instances set_fact: all_count: "{{ groups['tag_role_backend'] | length }}" - name: fail if last two instance remaining fail: msg: cant destroy last two instances when: all_count | int == 2 - name: destroy tags for marked instances ec2_tag: ec2_url: "https://api.cloud.croc.ru" region: croc resource: "{{ alarmed_ids[0].split('_')[1] }}" state: absent tags: role: backend - name: destroy instances ec2: region: croc state: absent instance_ids: "{{ alarmed_ids[0].split('_')[1] }}" - name: destroy low alarms ec2_metric_alarm: state: absent region: croc name: "scaling-low_{{ alarmed_ids[0].split('_')[1] }}" - name: destroy high alarms ec2_metric_alarm: state: absent region: croc name: "scaling-high_{{ alarmed_ids[0].split('_')[1] }}"</code> </pre> </div></div><br><p> åœ¨destroy-instance.yamlä¸­ï¼Œåˆ é™¤è­¦æŠ¥ï¼Œç»ˆæ­¢å®ä¾‹åŠå…¶æ ‡ç­¾ï¼Œå¹¶æ£€æŸ¥ç¦æ­¢ç»ˆæ­¢æœ€è¿‘å®ä¾‹çš„æ¡ä»¶ã€‚ </p><br><p> ç”±äºåˆ é™¤å®ä¾‹åï¼Œä¸ä¹‹å…³è”çš„æ ‡ç­¾å°†è¢«æ¨è¿Ÿåˆ é™¤å¹¶ä¸”å¯ä»¥å†ä½¿ç”¨ä¸€åˆ†é’Ÿï¼Œå› æ­¤æˆ‘ä»¬åœ¨åˆ é™¤å®ä¾‹åæ˜¾å¼åˆ é™¤æ ‡ç­¾ã€‚ <br>  AWX </p><br><h3 id="nastroyka-zadach-shablonov"> è®¾ç½®ä»»åŠ¡ï¼Œæ¨¡æ¿ </h3><br><p> ä»¥ä¸‹ä»»åŠ¡é›†å°†åœ¨AWXä¸­åˆ›å»ºå¿…è¦çš„å®ä½“ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">awx-configure.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">--- - name: Create tower organization tower_organization: name: "scaling-org" description: "scaling-org organization" state: present - name: Add tower cloud credential tower_credential: name: cloud description: croc cloud api creds organization: scaling-org kind: aws state: present username: "{{ croc_user }}" password: "{{ croc_password }}" - name: Add tower github credential tower_credential: name: ghe organization: scaling-org kind: scm state: present username: "{{ ghe_user }}" password: "{{ ghe_password }}" - name: Add tower ssh credential tower_credential: name: ssh description: ssh creds organization: scaling-org kind: ssh state: present username: "ec2-user" ssh_key_data: "{{ lookup('file', 'private.key') }}" - name: Add tower project tower_project: name: "auto-scaling" scm_type: git scm_credential: ghe scm_url: &lt;repo-name&gt; organization: "scaling-org" scm_branch: master state: present - name: create inventory tower_inventory: name: dynamic-inventory organization: "scaling-org" state: present - name: copy inventory script to awx copy: src: "{{ role_path }}/files/ec2.py" dest: /root/ec2.py - name: create inventory source shell: | export SCRIPT=$(tower-cli inventory_script create -n "ec2-script" --organization "scaling-org" --script @/root/ec2.py | grep ec2 | awk '{print $1}') tower-cli inventory_source create --update-on-launch True --credential cloud --source custom --inventory dynamic-inventory -n "ec2-source" --source-script $SCRIPT --source-vars '{"EC2_URL":"api.cloud.croc.ru","AWS_REGION": "croc"}' --overwrite True - name: Create create-instance template tower_job_template: name: "create-instance" job_type: "run" inventory: "dynamic-inventory" credential: "cloud" project: "auto-scaling" playbook: "create-instance.yaml" state: "present" register: create_instance - name: Create update-lb template tower_job_template: name: "update-lb" job_type: "run" inventory: "dynamic-inventory" credential: "ssh" project: "auto-scaling" playbook: "update-lb.yaml" credential: "ssh" state: "present" register: update_lb - name: Create destroy-instance template tower_job_template: name: "destroy-instance" job_type: "run" inventory: "dynamic-inventory" project: "auto-scaling" credential: "cloud" playbook: "destroy-instance.yaml" credential: "ssh" state: "present" register: destroy_instance - name: create workflow tower_workflow_template: name: auto_scaling organization: scaling-org schema: "{{ lookup('template', 'schema.j2')}}" - name: set scheduling shell: | tower-cli schedule create -n "3min" --workflow "auto_scaling" --rrule "DTSTART:$(date +%Y%m%dT%H%M%SZ) RRULE:FREQ=MINUTELY;INTERVAL=3"</code> </pre> </div></div><br><p> ä¸Šä¸€ç‰‡æ®µå°†ä¸ºæ¯ä¸ªä½¿ç”¨çš„ansibleå‰§æœ¬åˆ›å»ºä¸€ä¸ªæ¨¡æ¿ã€‚ æ¯ä¸ªæ¨¡æ¿éƒ½ä½¿ç”¨ä¸€ç»„å·²å®šä¹‰çš„å‡­æ®å’Œæ¸…å•æ¥é…ç½®ä¸€ä¸ªå‰§æœ¬çš„å¯åŠ¨ã€‚ </p><br><p> è¦æ„å»ºç”¨äºè°ƒç”¨å‰§æœ¬çš„ç®¡é“ï¼Œå°†å…è®¸å·¥ä½œæµç¨‹æ¨¡æ¿ã€‚ è®¾ç½®è‡ªåŠ¨ç¼©æ”¾çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">schema.j2</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- failure_nodes: - id: 101 job_template: {{ destroy_instance.id }} success_nodes: - id: 102 job_template: {{ update_lb.id }} id: 103 job_template: {{ create_instance.id }} success_nodes: - id: 104 job_template: {{ update_lb.id }}</code> </pre> </div></div><br><p> ä¸Šä¸€ä¸ªæ¨¡æ¿æ˜¾ç¤ºäº†å·¥ä½œæµç¨‹å›¾ï¼Œå³ æ¨¡æ¿æ‰§è¡Œçš„é¡ºåºã€‚ åœ¨æ­¤å·¥ä½œæµç¨‹ä¸­ï¼Œä»…åœ¨æˆåŠŸå®Œæˆä¸Šä¸€ä¸ªæ­¥éª¤ä¹‹åï¼Œæ‰æ‰§è¡Œæ¯ä¸ªä¸‹ä¸€ä¸ªæ­¥éª¤ï¼ˆsuccess_nodesï¼‰ã€‚ å›¾ä¸­æ˜¾ç¤ºäº†å·¥ä½œæµç¨‹çš„å›¾å½¢è¡¨ç¤ºï¼š <br><img src="https://habrastorage.org/webt/po/l-/vb/pol-vbfpulv4hoimk99mvbtig-u.png" alt="å·¥ä½œæµç¨‹"></p><br><p> ç»“æœï¼Œåˆ›å»ºäº†ä¸€ä¸ªé€šç”¨çš„å·¥ä½œæµï¼Œè¯¥å·¥ä½œæµæ‰§è¡Œcreate-instaceå‰§æœ¬ï¼Œå¹¶æ ¹æ®æ‰§è¡ŒçŠ¶æ€ï¼Œé”€æ¯å®ä¾‹å’Œ/æˆ–update-lbå‰§æœ¬ã€‚ é›†æˆçš„å·¥ä½œæµç¨‹ä¾¿äºæŒ‰ç»™å®šçš„æ—¶é—´è¡¨è¿è¡Œã€‚ è‡ªåŠ¨ç¼©æ”¾è¿‡ç¨‹å°†æ¯ä¸‰åˆ†é’Ÿå¯åŠ¨ä¸€æ¬¡ï¼Œæ ¹æ®è­¦æŠ¥çŠ¶æ€å¯åŠ¨å’Œç»ˆæ­¢å®ä¾‹ã€‚ </p><br><h3 id="testirovanie-raboty"> å·¥ä½œæµ‹è¯• </h3><br><p> ç°åœ¨æ£€æŸ¥é…ç½®çš„ç³»ç»Ÿçš„æ“ä½œã€‚ é¦–å…ˆï¼Œå®‰è£…ç”¨äºhttpåŸºå‡†æµ‹è¯•çš„wrkå®ç”¨ç¨‹åºã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">wrkå®‰è£…</b> <div class="spoiler_text"><pre> <code class="bash hljs">ssh -A ec2-user@&lt;aws_instance_ip&gt; sudo su - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt yum groupinstall <span class="hljs-string"><span class="hljs-string">'Development Tools'</span></span> yum install -y openssl-devel git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/wg/wrk.git wrk <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> wrk make install wrk /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> </div></div><br><p> æˆ‘ä»¬å°†ä½¿ç”¨äº‘ç›‘è§†æ¥ç›‘è§†è´Ÿè½½æœŸé—´å®ä¾‹èµ„æºçš„ä½¿ç”¨ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ç›‘æ§</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">function CPUUtilizationMonitoring() { local AWS_CLI_PROFILE="&lt;aws_cli_profile&gt;" local CLOUDWATCH_URL="https://monitoring.cloud.croc.ru" local API_URL="https://api.cloud.croc.ru" local STATS="" local ALARM_STATUS="" local IDS=$(aws --profile $AWS_CLI_PROFILE --endpoint-url $API_URL ec2 describe-instances --filter Name=tag:role,Values=backend | grep -i instanceid | grep -oE 'i-[a-zA-Z0-9]*' | tr '\n' ' ') for instance_id in $IDS; do STATS="$STATS$(aws --profile $AWS_CLI_PROFILE --endpoint-url $CLOUDWATCH_URL cloudwatch get-metric-statistics --dimensions Name=InstanceId,Value=$instance_id --namespace "AWS/EC2" --metric CPUUtilization --end-time $(date --iso-8601=minutes) --start-time $(date -d "$(date --iso-8601=minutes) - 1 min" --iso-8601=minutes) --period 60 --statistics Average | grep -i average)"; ALARMS_STATUS="$ALARMS_STATUS$(aws --profile $AWS_CLI_PROFILE --endpoint-url $CLOUDWATCH_URL cloudwatch describe-alarms --alarm-names scaling-high-$instance_id | grep -i statevalue)" done echo $STATS | column -s ',' -o '|' -N $(echo $IDS | tr ' ' ',') -t echo $ALARMS_STATUS | column -s ',' -o '|' -N $(echo $IDS | tr ' ' ',') -t } export -f CPUUtilizationMonitoring watch -n 60 bash -c CPUUtilizationMonitoring</code> </pre> </div></div><br><p> å‰ä¸€ä¸ªè„šæœ¬æ¯60ç§’ä¸€æ¬¡è·å–æœ‰å…³æœ€åä¸€åˆ†é’Ÿçš„CPUUtilizationæŒ‡æ ‡å¹³å‡å€¼çš„ä¿¡æ¯ï¼Œå¹¶è½®è¯¢åç«¯å®ä¾‹çš„è­¦æŠ¥çŠ¶æ€ã€‚ </p><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥è¿è¡Œwrkå¹¶æŸ¥çœ‹è´Ÿè½½ä¸‹çš„åç«¯å®ä¾‹çš„èµ„æºåˆ©ç”¨ç‡ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">è¿è¡Œ</b> <div class="spoiler_text"><pre> <code class="bash hljs">ssh -A ec2-user@&lt;awx_instance_ip&gt; wrk -t12 -c100 -d500s http://&lt;haproxy_instance_id&gt; <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> </div></div><br><p> æœ€åä¸€æ¡å‘½ä»¤å°†ä½¿ç”¨12ä¸ªçº¿ç¨‹å¹¶æ‰“å¼€100ä¸ªhttpè¿æ¥æ¥å¯åŠ¨åŸºå‡†æµ‹è¯•500ç§’ã€‚ </p><br><p> éšç€æ—¶é—´çš„æµé€ï¼Œç›‘è§†è„šæœ¬åº”æ˜¾ç¤ºåœ¨åŸºå‡†æµ‹è¯•æœŸé—´ï¼ŒCPUUtilizationæŒ‡æ ‡çš„ç»Ÿè®¡ä¿¡æ¯å€¼ä¼šå¢åŠ ï¼Œç›´åˆ°è¾¾åˆ°300ï¼…ã€‚ åŸºå‡†æµ‹è¯•å¼€å§‹å180ç§’ï¼ŒStateValueæ ‡å¿—åº”åˆ‡æ¢åˆ°â€œè­¦æŠ¥â€çŠ¶æ€ã€‚ æ¯ä¸¤åˆ†é’Ÿä¸€æ¬¡ï¼Œè‡ªåŠ¨ç¼©æ”¾å·¥ä½œæµç¨‹å¼€å§‹ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç¦æ­¢å¹¶è¡Œæ‰§è¡ŒåŒä¸€å·¥ä½œæµç¨‹ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸¤åˆ†é’Ÿï¼Œå°†æ‰§è¡Œå·¥ä½œæµç¨‹çš„ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”ä»…åœ¨å‰ä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰å¯åŠ¨ã€‚ å› æ­¤ï¼Œå½“wrkè¿è¡Œæ—¶ï¼Œèµ„æºå°†ä¸æ–­å¢åŠ ï¼Œç›´åˆ°æ‰€æœ‰åç«¯å®ä¾‹çš„é«˜è­¦æŠ¥è¿›å…¥OKçŠ¶æ€ä¸ºæ­¢ã€‚ å®Œæˆåï¼Œwrk scale_downå·¥ä½œæµç¨‹å°†ç»ˆæ­¢é™¤ä¸¤ä¸ªåç«¯å®ä¾‹ä¹‹å¤–çš„æ‰€æœ‰å®ä¾‹ã€‚ </p><br><p> ç›‘è§†è„šæœ¬çš„ç¤ºä¾‹è¾“å‡ºï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ç›‘æµ‹ç»“æœ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># start test i-43477460 |i-AC5D9EE0 "Average": 0.0 | "Average": 0.0 i-43477460 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok" # start http load i-43477460 |i-AC5D9EE0 "Average": 267.0 | "Average": 111.0 i-43477460 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok" # alarm state i-43477460 |i-AC5D9EE0 "Average": 267.0 | "Average": 282.0 i-43477460 |i-AC5D9EE0 "StateValue": "alarm"| "StateValue": "alarm" # two new instances created i-1E399860 |i-F307FB00 |i-43477460 |i-AC5D9EE0 "Average": 185.0 | "Average": 215.0 | "Average": 245.0 | i-1E399860 |i-F307FB00 |i-43477460 |i-AC5D9EE0 "StateValue": "insufficient_data"| "StateValue": "insufficient_data"| "StateValue": "alarm"| "StateValue": "alarm" # only two instances left after load has been stopped i-935BAB40 |i-AC5D9EE0 "Average": 0.0 | "Average": 0.0 i-935BAB40 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok"</code> </pre> </div></div><br><p> åŒæ ·åœ¨CROC Cloudä¸­ï¼Œæ‚¨å¯ä»¥åœ¨ç›¸åº”é€‰é¡¹å¡çš„å®ä¾‹é¡µé¢ä¸ŠæŸ¥çœ‹ç›‘è§†å¸–å­ä¸­ä½¿ç”¨çš„å›¾å½¢ã€‚ </p><br><p> æŸ¥çœ‹è­¦æŠ¥å¯åœ¨â€œè­¦æŠ¥â€é€‰é¡¹å¡çš„â€œç›‘è§†â€é¡µé¢ä¸Šæ‰¾åˆ°ã€‚ </p><br><h3 id="zaklyuchenie"> ç»“è®º </h3><br><p> è‡ªåŠ¨ç¼©æ”¾æ˜¯ä¸€ç§éå¸¸æµè¡Œçš„æ–¹æ¡ˆï¼Œä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œå®ƒå°šæœªå‡ºç°åœ¨æˆ‘ä»¬çš„äº‘ä¸­ï¼ˆä½†ä»…åœ¨ç°åœ¨ï¼‰ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬æœ‰è®¸å¤šå¼ºå¤§çš„APIå¯ä»¥ä½¿ç”¨æµè¡Œçš„ï¼Œå‡ ä¹æ ‡å‡†çš„å·¥å…·ï¼ˆä¾‹å¦‚Terraformï¼Œansibleï¼Œaws-cliç­‰ï¼‰æ¥æ‰§è¡Œç±»ä¼¼æ“ä½œä»¥åŠè®¸å¤šå…¶ä»–æ“ä½œã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN456826/">https://habr.com/ru/post/zh-CN456826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN456812/index.html">ITMOå¤§å­¦æœ‰ä»€ä¹ˆ-ITèŠ‚ï¼Œé»‘å®¢é©¬æ‹‰æ¾ï¼Œä¼šè®®å’Œå…¬å¼€ç ”è®¨ä¼š</a></li>
<li><a href="../zh-CN456814/index.html">åœ¨10åˆ†é’Ÿå†…å­¦ä¹ Pythonä¸­çš„å‡½æ•°å¼ç¼–ç¨‹</a></li>
<li><a href="../zh-CN456818/index.html">ä¸€å®¶æ— æ³•æ¥è¿‘çš„å…¬å¸çš„ç³»ç»Ÿç®¡ç†å‘˜ã€‚ éš¾ä»¥æ‰¿å—çš„è´Ÿæ‹…ï¼Ÿ</a></li>
<li><a href="../zh-CN456820/index.html">é»åœŸâ†’ç –â†’ç«ç‚‰</a></li>
<li><a href="../zh-CN456824/index.html">ä»€ä¹ˆæ˜¯æ¦‚ç‡ä»¥åŠå¦‚ä½•è®¡ç®—</a></li>
<li><a href="../zh-CN456828/index.html">å°åˆ·ç”µè·¯æ¿çš„è°ƒæ•´è¿‡å­”</a></li>
<li><a href="../zh-CN456830/index.html">Vivaldi 2.6-å¤æ—¥å¨±ä¹</a></li>
<li><a href="../zh-CN456836/index.html">é€‰æ‹©ï¼šæ‚¨å¯èƒ½ä¸çŸ¥é“çš„5ç§æ˜¾è€Œæ˜“è§çš„ç«äº‰åˆ†æå·¥å…·</a></li>
<li><a href="../zh-CN456838/index.html">ICEè¯„åˆ†ä»‹ç»äº§å“åŠŸèƒ½ä¼˜å…ˆçº§</a></li>
<li><a href="../zh-CN456840/index.html">SDL 2è¯¾ï¼šç¬¬6è¯¾-åŸè¯­</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>