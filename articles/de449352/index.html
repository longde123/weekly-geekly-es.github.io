<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÄ ü¶ä üïµÔ∏è Wie wir die √úberwachung auf Prometheus, Clickhouse und ELK aufgebaut haben üéôÔ∏è üñêüèø üì∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich hei√üe Anton Baderin. Ich arbeite am Center for High Technologies und bin in der Systemadministration t√§tig. Vor einem Monat endete unsere Unterneh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie wir die √úberwachung auf Prometheus, Clickhouse und ELK aufgebaut haben</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449352/"><p>  Ich hei√üe Anton Baderin.  Ich arbeite am Center for High Technologies und bin in der Systemadministration t√§tig.  Vor einem Monat endete unsere Unternehmenskonferenz, auf der wir unsere Erfahrungen mit der IT-Community unserer Stadt teilten.  Ich habe √ºber die √úberwachung von Webanwendungen gesprochen.  Das Material war f√ºr Junior oder Middle Level gedacht, die diesen Prozess nicht von Grund auf neu aufgebaut haben. </p><br><p><img src="https://habrastorage.org/webt/uj/x8/ej/ujx8ej4lg5vvhtvxczpnxnq4xkm.jpeg" alt="Bild"></p><br><p> Der Eckpfeiler eines √úberwachungssystems ist die L√∂sung von Gesch√§ftsproblemen.  Die √úberwachung zum Zwecke der √úberwachung ist f√ºr niemanden von Interesse.  Was will das Gesch√§ft?  Damit alles schnell und fehlerfrei funktioniert.  Unternehmen wollen Proaktivit√§t, damit wir Probleme im Service selbst identifizieren und so schnell wie m√∂glich beseitigen k√∂nnen.  Dies sind in der Tat die Aufgaben, die ich im letzten Jahr im Projekt eines unserer Kunden gel√∂st habe. </p><a name="habracut"></a><br><h2 id="o-proekte">  √úber das Projekt </h2><br><p>  Das Projekt ist eines der gr√∂√üten Treueprogramme des Landes.  Wir helfen Einzelh√§ndlern, ihre Verkaufsfrequenz durch verschiedene Marketinginstrumente wie Bonuskarten zu erh√∂hen.  Insgesamt umfasst das Projekt 14 Anwendungen, die auf zehn Servern ausgef√ºhrt werden. </p><br><p>  Bei der Durchf√ºhrung von Interviews habe ich wiederholt festgestellt, dass Administratoren Webanwendungen bei weitem nicht immer ordnungsgem√§√ü √ºberwachen: Bisher haben viele die Betriebssystemmetriken eingestellt und gelegentlich Dienste √ºberwacht. </p><br><p>  In meinem Fall war Icinga zuvor die Basis des Kunden√ºberwachungssystems.  Sie hat die oben genannten Probleme nicht gel√∂st.  Oft hat uns der Kunde selbst √ºber Probleme informiert, und zumindest hatten wir einfach nicht gen√ºgend Daten, um dem Grund auf den Grund zu gehen. </p><br><p>  Dar√ºber hinaus bestand ein klares Verst√§ndnis f√ºr die Sinnlosigkeit seiner Weiterentwicklung.  Ich denke, diejenigen, die mit Icinga vertraut sind, werden mich verstehen.  Daher haben wir uns entschlossen, das √úberwachungssystem f√ºr Webanwendungen im Projekt komplett neu zu gestalten. </p><br><h2 id="prometheus">  Prometheus </h2><br><p>  Wir haben Prometheus anhand von drei Schl√ºsselindikatoren ausgew√§hlt: </p><br><ol><li>  Eine gro√üe Anzahl verf√ºgbarer Metriken.  In unserem Fall gibt es 60.000 von ihnen.  Nat√ºrlich ist es erw√§hnenswert, dass die √ºberwiegende Mehrheit von ihnen nicht verwendet wird (wahrscheinlich etwa 95%).  Andererseits sind sie alle relativ billig.  F√ºr uns ist dies ein weiteres Extrem im Vergleich zum zuvor verwendeten Icinga.  Das Hinzuf√ºgen von Metriken war ein besonderes Problem: Die verf√ºgbaren waren teuer (sehen Sie sich nur den Quellcode eines Plugins an).  Jedes Plug-In war ein Bash- oder Python-Skript, dessen Start im Hinblick auf die verbrauchten Ressourcen nicht billig ist. </li><li>  Dieses System verbraucht relativ wenig Ressourcen.  Alle unsere Metriken haben 600 MB RAM, 15% eines Kerns und ein paar Dutzend IOPS.  Nat√ºrlich m√ºssen Sie Exporteure von Metriken ausf√ºhren, aber sie sind alle in Go geschrieben und unterscheiden sich auch nicht in der V√∂llerei.  Ich denke nicht, dass dies in der modernen Realit√§t ein Problem ist. </li><li>  Es erm√∂glicht den Wechsel zu Kubernetes.  Angesichts der Pl√§ne des Kunden liegt die Wahl auf der Hand. </li></ol><br><h2 id="elk">  ELK </h2><br><p>  Bisher haben wir keine Protokolle gesammelt oder verarbeitet.  Die M√§ngel sind allen klar.  Wir haben uns f√ºr ELK entschieden, da wir bereits Erfahrung mit diesem System hatten.  Wir speichern dort nur Anwendungsprotokolle.  Die Hauptauswahlkriterien waren die Volltextsuche und ihre Geschwindigkeit. </p><br><h2 id="slickhouse">  Clickhouse </h2><br><p>  Die Wahl fiel zun√§chst auf InfluxDB.  Wir haben die Notwendigkeit erkannt, Nginx-Protokolle und Statistiken aus pg_stat_statements zu sammeln und Prometheus-Verlaufsdaten zu speichern.  Influx gefiel uns nicht, da es regelm√§√üig viel Speicher verbrauchte und abst√ºrzte.  Au√üerdem wollte ich Anforderungen nach remote_addr gruppieren und in diesem DBMS nur nach Tags gruppieren.  Tags der Stra√üe (Speicher), deren Anzahl bedingt begrenzt ist. </p><br><p>  Wir haben die Suche erneut gestartet.  Wir brauchten eine analytische Basis mit minimalem Ressourcenverbrauch, vorzugsweise mit Datenkomprimierung auf der Festplatte. </p><br><p>  Clickhouse erf√ºllt all diese Kriterien und wir haben die Wahl nie bereut.  Wir schreiben keine ausstehenden Datenmengen hinein (die Anzahl der Einf√ºgungen betr√§gt nur etwa f√ºnftausend pro Minute). </p><br><h2 id="newrelic">  NewRelic </h2><br><p>  NewRelic ist seit jeher bei uns, seit es die Wahl des Kunden war.  Wir verwenden es als APM. </p><br><h2 id="zabbix">  Zabbix </h2><br><p>  Wir verwenden Zabbix ausschlie√ülich zur √úberwachung der Black Box verschiedener APIs. </p><br><h2 id="opredelenie-podhoda-k-monitoringu">  Definieren eines √úberwachungsansatzes </h2><br><p>  Wir wollten die Aufgabe zerlegen und damit den √úberwachungsansatz systematisieren. </p><br><p>  Dazu habe ich unser System in folgende Ebenen unterteilt: </p><br><ul><li>  Hardware und VMS; </li><li>  operationssystem; </li><li>  Systemdienste, Software-Stack; </li><li>  Anwendung </li><li>  Gesch√§ftslogik. </li></ul><br><p>  Was macht diesen Ansatz bequem: </p><br><ul><li>  Wir wissen, wer f√ºr die Arbeit der einzelnen Ebenen verantwortlich ist, und k√∂nnen auf dieser Grundlage Warnungen senden. </li><li>  Wir k√∂nnen die Struktur verwenden, um Warnungen zu unterdr√ºcken. Es w√§re seltsam, eine Warnung √ºber die Unzug√§nglichkeit der Datenbank zu senden, wenn auf die virtuelle Maschine im Allgemeinen nicht zugegriffen werden kann. </li></ul><br><p>  Da es unsere Aufgabe ist, Unregelm√§√üigkeiten im System zu erkennen, m√ºssen wir auf jeder Ebene einen bestimmten Satz von Metriken ausw√§hlen, die beim Schreiben der Regeln der Warnung ber√ºcksichtigt werden sollten.  Als n√§chstes werden wir die Ebenen "VMS", "Betriebssystem" und "Systemdienste, Software-Stack" durchgehen. </p><br><h2 id="virtualnye-mashiny">  Virtuelle Maschinen </h2><br><p>  Hosting gibt uns einen Prozessor, eine Festplatte, einen Speicher und ein Netzwerk.  Und mit den ersten beiden hatten wir Probleme.  Also Metriken: </p><br><p>  CPU-gestohlene Zeit - Wenn Sie eine virtuelle Maschine bei Amazon kaufen (z. B. t2.micro), sollten Sie verstehen, dass Ihnen nicht ein ganzer Prozessorkern zugewiesen wird, sondern nur ein Teil ihrer Zeit.  Und wenn Sie es ersch√∂pfen, wird Ihnen der Prozessor weggenommen. </p><br><p>  Mit dieser Metrik k√∂nnen Sie solche Momente verfolgen und Entscheidungen treffen.  Ist es beispielsweise erforderlich, einen Tarif fetter zu nehmen oder die Verarbeitung von Hintergrundaufgaben und -anforderungen in der API auf verschiedene Server zu verteilen. </p><br><p>  IowaPS + CPU iowait Zeit - aus irgendeinem Grund s√ºndigen viele Cloud-Hosting-Unternehmen, indem sie IOPS nicht bereitstellen.  Dar√ºber hinaus ist ein Zeitplan mit niedrigem IOPS kein Argument f√ºr sie.  Daher lohnt es sich, iowait CPU zu sammeln.  Mit diesem Grafikpaar - mit niedrigen IOPS und hohen E / A-Erwartungen - k√∂nnen Sie bereits mit dem Hosting sprechen und das Problem l√∂sen. </p><br><h2 id="operacionnaya-sistema">  Operationssystem </h2><br><p>  Betriebssystemmetriken: </p><br><ul><li>  Menge des verf√ºgbaren Speichers in%; </li><li>  Aktivit√§t mit Swap: vmstat swapin, swapout; </li><li>  Die Anzahl der verf√ºgbaren Inodes und des freien Speicherplatzes im Dateisystem in% </li><li>  durchschnittliche Belastung; </li><li>  Anzahl der Verbindungen in zwei Zust√§nden; </li><li>  Conntrack Tischf√ºlle; </li><li>  Die Netzwerkleistung kann mit dem Dienstprogramm ss, iproute2-Paket, √ºberwacht werden. Ruft den RTT-Verbindungsindikator von seiner Ausgabe ab und gruppiert ihn nach Zielport. </li></ul><br><p>  Auch auf der Ebene des Betriebssystems haben wir eine Entit√§t wie Prozesse.  Es ist wichtig, im System eine Reihe von Prozessen hervorzuheben, die bei seiner Arbeit eine wichtige Rolle spielen.  Wenn Sie beispielsweise mehrere pgpool haben, m√ºssen Sie Informationen f√ºr jeden von ihnen sammeln. </p><br><p>  Der Satz von Metriken lautet wie folgt: </p><br><ul><li>  CPU </li><li>  das Ged√§chtnis ist haupts√§chlich resident; </li><li>  IO - vorzugsweise in IOPS; </li><li>  FileFd - √∂ffnen und begrenzen; </li><li>  Signifikante Seitenfehler - damit Sie verstehen, welcher Prozess ausgetauscht wird. </li></ul><br><p>  Die gesamte √úberwachung wird in Docker bereitgestellt. Wir verwenden advisor, um Metrikdaten zu erfassen.  Auf anderen Maschinen verwenden wir Process-Exporter. </p><br><h2 id="sistemnye-servisy-stek-po">  Systemdienste, Software-Stack </h2><br><p>  Jede Anwendung hat ihre eigenen Besonderheiten, und es ist schwierig, bestimmte Metriken zu unterscheiden. </p><br><p>  Universelles Set sind: </p><br><ul><li>  Anforderungsrate; </li><li>  Anzahl der Fehler; </li><li>  Latenz </li><li>  S√§ttigung. </li></ul><br><p>  Die auff√§lligsten Beispiele f√ºr die √úberwachung auf dieser Ebene sind Nginx und PostgreSQL. </p><br><p>  Der am meisten ausgelastete Dienst in unserem System ist die Datenbank.  Fr√ºher hatten wir oft Probleme, herauszufinden, was die Datenbank tut. </p><br><p>  Wir haben eine hohe Belastung der Festplatten gesehen, aber die Slogans zeigten nicht wirklich etwas.  Wir haben dieses Problem mit pg_stat_statements gel√∂st, einer Ansicht, die Statistiken zu Anforderungen sammelt. </p><br><p>  Dies ist alles, was der Administrator ben√∂tigt. </p><br><p>  Wir zeichnen die Aktivit√§t von Lese- und Schreibanforderungen auf: </p><br><img src="https://habrastorage.org/webt/6r/fm/rp/6rfmrp9k711d0azcv7thr3bfapu.jpeg"><br><img src="https://habrastorage.org/webt/j7/dn/ki/j7dnki6of_-n3l33xe5mz9xapkk.jpeg"><br><p>  Alles ist einfach und klar, jede Anfrage hat ihre eigene Farbe. </p><br><p>  Ein ebenso auff√§lliges Beispiel sind Nginx-Protokolle.  Es √ºberrascht nicht, dass nur wenige sie analysieren oder in der Liste der erforderlichen erw√§hnen.  Das Standardformat ist nicht sehr informativ und muss erweitert werden. </p><br><p>  Pers√∂nlich habe ich request_time, upstream_response_time, body_bytes_sent, request_length, request_id hinzugef√ºgt. Wir zeichnen die Antwortzeit und die Anzahl der Fehler auf: </p><br><img src="https://habrastorage.org/webt/3l/wp/cw/3lwpcwwdctrsk7mgnexjmxstsxq.jpeg"><br><img src="https://habrastorage.org/webt/zk/w9/ak/zkw9akpuwajs85xktgcm6wtar1m.jpeg"><br><p>  Wir zeichnen die Antwortzeit und die Anzahl der Fehler auf.  Erinnerst du dich?  Habe ich √ºber Gesch√§ftsziele gesprochen?  Zu schnell und fehlerfrei?  Wir haben diese Probleme bereits mit zwei Diagrammen abgeschlossen.  Und auf ihnen k√∂nnen Sie bereits die Dienstadministratoren anrufen. </p><br><p>  Ein weiteres Problem blieb jedoch bestehen - um die rasche Beseitigung der Ursachen des Vorfalls zu gew√§hrleisten. </p><br><h2 id="ustranenie-incidentov">  Incident Management </h2><br><p>  Der gesamte Prozess von der Identifizierung bis zur L√∂sung eines Problems kann in mehrere Schritte unterteilt werden: </p><br><ul><li>  Problemidentifikation; </li><li>  Benachrichtigung des diensthabenden Administrators; </li><li>  Reaktion auf den Vorfall; </li><li>  Beseitigung der Ursachen. </li></ul><br><p>  Es ist wichtig, dass wir dies so schnell wie m√∂glich tun.  Und wenn wir in der Phase der Identifizierung eines Problems und des Versendens einer Benachrichtigung nicht viel Zeit gewinnen k√∂nnen - sie werden in jedem Fall zwei Minuten lang bleiben, dann sind die n√§chsten nur ein unber√ºhrtes Feld f√ºr Verbesserungen. </p><br><p>  Stellen wir uns vor, das Telefon klingelte im Dienst.  Was wird er tun?  Suchen Sie nach Antworten auf Fragen - was ist kaputt, wo ist es kaputt, wie soll man reagieren?  So beantworten wir diese Fragen: </p><br><img src="https://habrastorage.org/webt/p_/kj/wj/p_kjwjrqkewlj50zmcy1hz9cuju.jpeg"><br><p>  Wir f√ºgen einfach alle diese Informationen in den Benachrichtigungstext ein und geben ihm einen Link zu einer Wiki-Seite, auf der beschrieben wird, wie auf dieses Problem reagiert, wie es gel√∂st und eskaliert wird. </p><br><p>  Ich habe noch nichts √ºber die Anwendungsschicht und die Gesch√§ftslogik gesagt.  Leider wurde die Erfassung von Metriken in unseren Anwendungen noch nicht implementiert.  Die einzige Quelle f√ºr zumindest einige Informationen aus diesen Ebenen sind die Protokolle. </p><br><p>  Ein paar Punkte. </p><br><p>  Schreiben Sie zun√§chst strukturierte Protokolle.  Es ist nicht erforderlich, den Kontext in den Nachrichtentext aufzunehmen.  Dies macht es schwierig, sie zu gruppieren und zu analysieren.  Logstash braucht lange, um all dies zu normalisieren. </p><br><p>  Zweitens verwenden Sie die Schweregrade korrekt.  Jede Sprache hat ihren eigenen Standard.  Pers√∂nlich unterscheide ich vier Ebenen: </p><br><ol><li>  kein Fehler; </li><li>  clientseitiger Fehler; </li><li>  Ein Fehler ist auf unserer Seite, wir verlieren kein Geld, wir tragen kein Risiko. </li><li>  Der Fehler ist auf unserer Seite, wir verlieren Geld. </li></ol><br><p>  Ich fasse zusammen.  Es muss versucht werden, die √úberwachung genau aus der Gesch√§ftslogik heraus aufzubauen.  Versuchen Sie, die Anwendung selbst zu √ºberwachen und mit Metriken wie der Anzahl der Verk√§ufe, der Anzahl neuer Benutzerregistrierungen, der Anzahl der derzeit aktiven Benutzer usw. zu arbeiten. </p><br><p>  Wenn Ihr gesamtes Unternehmen eine einzelne Schaltfl√§che in Ihrem Browser ist, m√ºssen Sie √ºberwachen, ob sie gedr√ºckt wird und ordnungsgem√§√ü funktioniert.  Alles andere ist nicht wichtig. </p><br><p>  Wenn Sie dies nicht haben, k√∂nnen Sie versuchen, es in den Anwendungsprotokollen, Nginx-Protokollen usw. nachzuholen, wie wir es getan haben.  Sie sollten so nah wie m√∂glich an der Anwendung sein. </p><br><p>  Betriebssystemmetriken sind nat√ºrlich wichtig, aber f√ºr das Gesch√§ft nicht interessant, wir werden nicht daf√ºr bezahlt. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de449352/">https://habr.com/ru/post/de449352/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de449342/index.html">Zuf√§lliges Orakel basierend auf der digitalen Blockchain-Signatur</a></li>
<li><a href="../de449344/index.html">Kodim - Pizza</a></li>
<li><a href="../de449346/index.html">MODX Digest # 4 (8. - 22. April 2019)</a></li>
<li><a href="../de449348/index.html">Buildroot - Teil 2. Erstellen der Konfiguration Ihres Boards; Anwendung von externen Baum-, Rootfs-Overlay- und Post-Build-Skripten</a></li>
<li><a href="../de449350/index.html">Keybase und echte TOFU</a></li>
<li><a href="../de449356/index.html">Gesch√§ftsprozesse. BPMN-Modellextraktion aus dem Dokument. Teil 1</a></li>
<li><a href="../de449358/index.html">Neue Grenzen in der Physik</a></li>
<li><a href="../de449360/index.html">Microsoft hat die virtuelle Realit√§t f√ºr sehbehinderte Menschen angepasst</a></li>
<li><a href="../de449362/index.html">UPS im Gesundheitswesen: Delta Electronics Health Experience</a></li>
<li><a href="../de449364/index.html">Hintergrund: Was ist Continuous Delivery?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>