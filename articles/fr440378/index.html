<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚öóÔ∏è üßîüèΩ ü¶ç Retour aux microservices avec Istio. 2e partie ü•™ ü§¥üèø üôÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Remarque perev. : La premi√®re partie de cette s√©rie a √©t√© consacr√©e √† la pr√©sentation d'Istio et √† sa d√©monstration en action. Nous allons maintenant ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Retour aux microservices avec Istio. 2e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/440378/"><img src="https://habrastorage.org/webt/bj/j4/oy/bjj4oyjxqshrbjf5eks9sgsvbeg.png"><br><br>  <i><b>Remarque</b></i>  <i><b>perev.</b></i>  <i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La premi√®re partie de</a> cette s√©rie a √©t√© consacr√©e √† la pr√©sentation d'Istio et √† sa d√©monstration en action.</i>  <i>Nous allons maintenant parler d'aspects plus complexes de la configuration et de l'utilisation de ce maillage de service, et en particulier du routage finement r√©gl√© et de la gestion du trafic r√©seau.</i> <i><br><br></i>  <i>Nous vous rappelons √©galement que l'article utilise des configurations (manifestes pour Kubernetes et Istio) du r√©f√©rentiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">istio-mastery</a> .</i> <i><a name="habracut"></a></i> <br><br><h2>  Gestion du trafic </h2><br>  Avec Istio, de nouvelles fonctionnalit√©s apparaissent dans le cluster pour fournir: <br><br><ul><li>  <b>Routage dynamique des requ√™tes</b> : d√©ploiements canaries, tests A / B; </li><li>  <b>√âquilibrage de charge</b> : simple et coh√©rent, bas√© sur des hachages; </li><li>  <b>R√©cup√©ration en cas de chute</b> : temporisations, tentatives, disjoncteurs; </li><li>  <b>Saisie des d√©fauts</b> : retards, interruption des requ√™tes, etc. </li></ul><br>  Dans la suite de l'article, ces fonctionnalit√©s seront pr√©sent√©es comme un exemple de l'application s√©lectionn√©e et de nouveaux concepts seront introduits en cours de route.  Le premier de ces concepts sera <code>DestinationRules</code> <i>(c'est-√†-dire les r√®gles concernant le destinataire du trafic / des demandes - environ Transl.)</i> , Avec lesquelles nous activons les tests A / B. <br><br><h2>  Test A / B: DestinationRules en pratique </h2><br>  Le test A / B est utilis√© dans les cas o√π il existe deux versions de l'application (g√©n√©ralement elles diff√®rent visuellement) et nous ne sommes pas s√ªrs √† 100% de celle qui am√©liorera l'interaction utilisateur.  Par cons√©quent, nous lan√ßons simultan√©ment les deux versions et collectons des mesures. <br><br>  Pour d√©ployer la deuxi√®me version du frontend n√©cessaire pour d√©montrer les tests A / B, ex√©cutez la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube/ab-testing/sa-frontend-green-deployment.yaml deployment.extensions/sa-frontend-green created</code> </pre> <br>  Le manifeste de d√©ploiement pour la "version verte" diff√®re √† deux endroits: <br><br><ol><li>  L'image est bas√©e sur une autre balise - <code>istio-green</code> , </li><li>  Les pods ont une <code>version: green</code> √©tiquette <code>version: green</code> . </li></ol><br>  √âtant donn√© que les deux d√©ploiements ont l'√©tiquette <code>app: sa-frontend</code> , les demandes achemin√©es par le service virtuel <code>sa-external-services</code> vers le service <code>sa-frontend</code> seront redirig√©es vers toutes ses instances et la charge sera distribu√©e √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'</a> aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'algorithme round-robin</a> , ce qui conduira √† la situation suivante: <br><br><img src="https://habrastorage.org/webt/p-/bi/mj/p-bimjrw8ywosk5q020d3loefsy.png"><br>  <i>Fichiers demand√©s introuvables</i> <br><br>  Ces fichiers sont introuvables car ils sont appel√©s diff√©remment dans les diff√©rentes versions de l'application.  Assurons-nous de ceci: <br><br><pre> <code class="bash hljs">$ curl --silent http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/ | tr <span class="hljs-string"><span class="hljs-string">'"'</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> | grep main /static/css/main.c7071b22.css /static/js/main.059f8e9c.js $ curl --silent http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/ | tr <span class="hljs-string"><span class="hljs-string">'"'</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> | grep main /static/css/main.f87cd8c9.css /static/js/main.f7659dbb.js</code> </pre> <br>  Cela signifie que <code>index.html</code> , demandant une version des fichiers statiques, peut √™tre envoy√© par l'√©quilibreur de charge aux pods qui ont une version diff√©rente, o√π, pour des raisons √©videntes, ces fichiers n'existent pas.  Par cons√©quent, pour que l'application fonctionne, nous devons mettre une restriction: " <b>la m√™me version de l'application qui a donn√© index.html doit √©galement servir les requ√™tes suivantes</b> ." <br><br>  Nous atteindrons l'objectif avec un √©quilibrage de charge <i>coh√©rent bas√© sur le hachage (Equilibrage de</i> charge <i>coh√©rent)</i> .  Dans ce cas, les <b>demandes d'un client sont envoy√©es √† la m√™me instance d'arri√®re-plan</b> , pour laquelle une propri√©t√© pr√©d√©finie est utilis√©e - par exemple, un en-t√™te HTTP.  Impl√©ment√© √† l'aide de DestinationRules. <br><br><h2>  DestinationRules </h2><br>  Une fois que <b>VirtualService a</b> envoy√© une demande au service souhait√©, √† l'aide de DestinationRules, nous pouvons d√©terminer les strat√©gies qui seront appliqu√©es au trafic destin√© aux instances de ce service: <br><br><img src="https://habrastorage.org/webt/sd/be/iy/sdbeiy6vndddkdjifebk9a7-q2m.png"><br>  <i>Istio Resource Traffic Management</i> <br><br>  <b>Remarque</b> : L'effet des ressources Istio sur le trafic r√©seau est pr√©sent√© ici de mani√®re simplifi√©e.  Pour √™tre pr√©cis, la d√©cision sur l'instance √† laquelle envoyer la demande est prise par Envoy dans la passerelle d'entr√©e configur√©e dans CRD. <br><br>  √Ä l'aide des r√®gles de destination, nous pouvons configurer l'√©quilibrage de charge de sorte que des hachages coh√©rents soient utilis√©s et que les r√©ponses de la m√™me instance de service soient garanties au m√™me utilisateur.  La configuration suivante permet cela ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">destinationrule-sa-frontend.yaml</a> ) pour y parvenir: <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: sa-frontend spec: host: sa-frontend trafficPolicy: loadBalancer: consistentHash: httpHeaderName: version # 1</code> </pre> <br>  1 - le hachage sera g√©n√©r√© en fonction du contenu de l'en-t√™te de la <code>version</code> HTTP. <br><br>  Appliquez la configuration avec la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/ab-testing/destinationrule-sa-frontend.yaml destinationrule.networking.istio.io/sa-frontend created</code> </pre> <br>  Ex√©cutez maintenant la commande ci-dessous et assurez-vous d'obtenir les fichiers dont vous avez besoin lorsque vous sp√©cifiez l'en-t√™te de <code>version</code> : <br><br><pre> <code class="bash hljs">$ curl --silent -H <span class="hljs-string"><span class="hljs-string">"version: yogo"</span></span> http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/ | tr <span class="hljs-string"><span class="hljs-string">'"'</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> | grep main</code> </pre> <br>  <b>Remarque</b> : Pour ajouter diff√©rentes valeurs dans le titre et tester les r√©sultats directement dans le navigateur, vous pouvez utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette extension</a> pour Chrome <i>(ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">celle-ci</a> pour Firefox - environ Transl.)</i> . <br><br>  En g√©n√©ral, DestinationRules a plus d'options dans le domaine de l'√©quilibrage de charge - consultez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle pour</a> plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de</a> d√©tails. <br><br>  Avant d'√©tudier VirtualService, nous supprimerons la ¬´version verte¬ª de l'application et la r√®gle correspondante dans le sens du trafic en ex√©cutant les commandes suivantes: <br><br><pre> <code class="bash hljs">$ kubectl delete -f resource-manifests/kube/ab-testing/sa-frontend-green-deployment.yaml deployment.extensions ‚Äúsa-frontend-green‚Äù deleted $ kubectl delete -f resource-manifests/istio/ab-testing/destinationrule-sa-frontend.yaml destinationrule.networking.istio.io ‚Äúsa-frontend‚Äù deleted</code> </pre> <br><h2>  Mise en miroir: les services virtuels en pratique </h2><br>  L'observation <i>("blindage")</i> ou la mise en miroir <i>("mirroring")</i> est utilis√©e dans les cas o√π nous voulons tester une modification de la production sans affecter les utilisateurs finaux: pour cela, nous dupliquons ("miroir") les demandes pour la deuxi√®me instance, o√π les modifications n√©cessaires sont apport√©es, et regardez les cons√©quences.  <i>Autrement dit, c'est lorsque votre (a) coll√®gue s√©lectionne le probl√®me le plus critique et fait une demande de retrait sous la forme d'un √©norme tas de salet√© que personne ne peut r√©ellement lui faire une revue.</i> <br><br>  Pour tester ce sc√©nario en action, cr√©ez une deuxi√®me instance de SA-Logic avec des bugs ( <code>buggy</code> ) en ex√©cutant la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/kube/shadowing/sa-logic-service-buggy.yaml deployment.extensions/sa-logic-buggy created</code> </pre> <br>  Et maintenant, nous ex√©cutons la commande pour nous assurer que toutes les instances avec <code>app=sa-logic</code> ont <code>app=sa-logic</code> des √©tiquettes avec les versions correspondantes: <br><br><pre> <code class="bash hljs">$ kubectl get pods -l app=sa-logic --show-labels NAME READY LABELS sa-logic-568498cb4d-2sjwj 2/2 app=sa-logic,version=v1 sa-logic-568498cb4d-p4f8c 2/2 app=sa-logic,version=v1 sa-logic-buggy-76dff55847-2fl66 2/2 app=sa-logic,version=v2 sa-logic-buggy-76dff55847-kx8zz 2/2 app=sa-logic,version=v2</code> </pre> <br>  Le service <code>sa-logic</code> cible les pods avec l'√©tiquette <code>app=sa-logic</code> , donc toutes les demandes seront r√©parties entre toutes les instances: <br><br><img src="https://habrastorage.org/webt/6d/po/v8/6dpov8tnmom1j_sr7tcedj7bufo.png"><br><br>  ... mais nous voulons que les demandes soient dirig√©es vers les instances avec la version v1 et mises en miroir vers les instances avec la version v2: <br><br><img src="https://habrastorage.org/webt/7u/n6/aj/7un6aj7gerw57imbzmwgkwgjajw.png"><br><br>  Nous y parviendrons gr√¢ce au VirtualService en combinaison avec le DestinationRule, o√π les r√®gles d√©termineront les sous-ensembles et les routes du VirtualService vers un sous-ensemble particulier. <br><br><h2>  D√©finition de sous-ensembles dans les r√®gles de destination </h2><br>  <i>Les sous-ensembles sont</i> d√©finis par la configuration suivante ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sa-logic-subsets-destinationrule.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: sa-logic spec: host: sa-logic # 1 subsets: - name: v1 # 2 labels: version: v1 # 3 - name: v2 labels: version: v2</code> </pre> <br><ol><li>  L' <code>host</code> d√©termine que cette r√®gle s'applique uniquement aux cas o√π la route va vers le service <code>sa-logic</code> ; </li><li>  Les noms des sous-ensembles sont utilis√©s lors du routage vers des instances du sous-ensemble; </li><li>  Une √©tiquette d√©finit les paires cl√©-valeur auxquelles les instances doivent correspondre pour faire partie d'un sous-ensemble. </li></ol><br>  Appliquez la configuration avec la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/shadowing/sa-logic-subsets-destinationrule.yaml destinationrule.networking.istio.io/sa-logic created</code> </pre> <br>  Maintenant que les sous-ensembles sont d√©finis, vous pouvez continuer et configurer VirtualService pour appliquer les r√®gles aux requ√™tes √† sa-logic afin qu'elles: <br><br><ol><li>  Rout√© vers un sous-ensemble de <code>v1</code> , </li><li>  Refl√©t√© sur un sous-ensemble de <code>v2</code> . </li></ol><br>  Le manifeste suivant vous permet de r√©aliser votre plan ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sa-logic-subsets-shadowing-vs. Yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: sa-logic spec: hosts: - sa-logic http: - route: - destination: host: sa-logic subset: v1 mirror: host: sa-logic subset: v2</code> </pre> <br>  Aucune explication n'est requise ici, alors jetez un ≈ìil √† l'action: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/shadowing/sa-logic-subsets-shadowing-vs.yaml virtualservice.networking.istio.io/sa-logic created</code> </pre> <br>  Ajoutez la charge en appelant cette commande: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> curl -v http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span>; \ sleep .8; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br>  Regardons les r√©sultats dans Grafana, o√π nous pouvons voir que la version <code>buggy</code> bloque pour environ 60% des demandes, mais aucun de ces plantages n'affecte les utilisateurs finaux car ils ont un service qui fonctionne. <br><br><img src="https://habrastorage.org/webt/x3/g6/so/x3g6so65q5jmyjj48-_kjf254de.png"><br>  <i>Succ√®s des r√©ponses des diff√©rentes versions du service sa-logic</i> <br><br>  Ici, nous avons d'abord vu comment VirtualService est appliqu√© aux Envoy√©s de nos services: lorsque l'application <code>sa-web-app</code> fait une demande √† <code>sa-logic</code> , elle passe par le sidecar Envoy, qui - via VirtualService - est configur√© pour acheminer la demande vers le sous-ensemble v1 et miroir une requ√™te √† un sous-ensemble de v2 du <code>sa-logic</code> . <br><br>  Je sais: vous avez d√©j√† eu le temps de penser que les services virtuels sont simples.  Dans la section suivante, nous √©largissons cette vue par le fait qu'elles sont √©galement vraiment magnifiques. <br><br><h2>  Rouleaux de canaris </h2><br>  Canary Deployment est le processus de d√©ploiement d'une nouvelle version d'une application pour un petit nombre d'utilisateurs.  Il est utilis√© pour s'assurer qu'il n'y a pas de probl√®me dans la version et seulement apr√®s cela, √©tant d√©j√† confiant dans sa qualit√© (de sortie) suffisante, pour se propager √† <i>un</i> public plus large. <br><br>  Pour d√©montrer les d√©ploiements des canaris, nous continuerons de travailler avec un sous-ensemble de <code>buggy</code> en <code>sa-logic</code> . <br><br>  Ne perdons pas de temps dessus et envoyons imm√©diatement 20% des utilisateurs √† la version avec des bugs (cela repr√©sentera notre d√©ploiement canari), et les 80% restants au service normal.  Pour ce faire, appliquez le VirtualService suivant ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sa-logic-subsets-canary-vsyaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: sa-logic spec: hosts: - sa-logic http: - route: - destination: host: sa-logic subset: v1 weight: 80 # 1 - destination: host: sa-logic subset: v2 weight: 20 # 1</code> </pre> <br>  1 est le poids, qui d√©termine le pourcentage de demandes qui seront envoy√©es au destinataire ou √† un sous-ensemble du destinataire. <br><br>  Mettez √† jour la configuration pr√©c√©dente de VirtualService pour <code>sa-logic</code> commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/canary/sa-logic-subsets-canary-vs.yaml virtualservice.networking.istio.io/sa-logic configured</code> </pre> <br>  ... et voyez imm√©diatement qu'une partie des demandes se bloque: <br><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ curl -i http://<span class="hljs-variable"><span class="hljs-variable">$EXTERNAL_IP</span></span>/sentiment \ -H <span class="hljs-string"><span class="hljs-string">"Content-type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"sentence": "I love yogobella"}'</span></span> \ --silent -w <span class="hljs-string"><span class="hljs-string">"Time: %{time_total}s \t Status: %{http_code}\n"</span></span> \ -o /dev/null; sleep .1; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> Time: 0.153075s Status: 200 Time: 0.137581s Status: 200 Time: 0.139345s Status: 200 Time: 30.291806s Status: 500</code> </pre> <br>  Les VirtualServices activent les d√©ploiements canaries: dans ce cas, nous avons r√©duit les cons√©quences potentielles des probl√®mes √† 20% de la base d'utilisateurs.  Super!  Maintenant, dans chaque cas, lorsque nous ne sommes pas s√ªrs de notre code (en d'autres termes, toujours ...), nous pouvons utiliser la mise en miroir et les d√©ploiements canaries. <br><br><h2>  D√©lais et tentatives </h2><br>  Mais les bogues ne sont pas toujours dans le code.  Dans la liste des " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">8 erreurs de calcul distribu√©</a> " appara√Æt en premier lieu l'opinion erron√©e selon laquelle "le r√©seau est fiable".  En r√©alit√©, le r√©seau n'est <b>pas</b> fiable, et pour cette raison, nous avons besoin de d√©lais d'attente et de nouvelles <i>tentatives</i> . <br><br>  Pour la d√©monstration, nous continuerons √† utiliser la m√™me version de <code>sa-logic</code> ( <code>buggy</code> ), et nous simulerons la non-fiabilit√© du r√©seau avec des pannes al√©atoires. <br><br>  Laissez notre service avec des bogues avoir 1/3 de chance pour une r√©ponse trop longue, 1/3 pour une ex√©cution avec une erreur de serveur interne et 1/3 pour un retour de page r√©ussi. <br><br>  Afin d'att√©nuer les cons√©quences de tels probl√®mes et d'am√©liorer la vie des utilisateurs, nous pouvons: <br><br><ol><li>  ajouter un d√©lai d'attente si le service r√©pond pendant plus de 8 secondes, </li><li>  r√©essayez si la demande √©choue. </li></ol><br>  Pour l'impl√©mentation, nous utiliserons la d√©finition de ressource suivante ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sa-logic-retries-timeouts-vs.yaml</a> ): <br><br><pre> <code class="plaintext hljs">apiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: sa-logic spec: hosts: - sa-logic http: - route: - destination: host: sa-logic subset: v1 weight: 50 - destination: host: sa-logic subset: v2 weight: 50 timeout: 8s # 1 retries: attempts: 3 # 2 perTryTimeout: 3s # 3</code> </pre> <br><ol><li>  Le d√©lai d'expiration de la demande est d√©fini sur 8 secondes; </li><li>  Des tentatives de demande r√©p√©t√©es sont effectu√©es 3 fois; </li><li>  Et chaque tentative est consid√©r√©e comme infructueuse si le temps de r√©ponse d√©passe 3 secondes. </li></ol><br>  Nous avons donc atteint l'optimisation, car l'utilisateur n'a pas √† attendre plus de 8 secondes et nous ferons trois nouvelles tentatives pour obtenir une r√©ponse en cas d'√©checs, augmentant ainsi les chances de r√©ussite. <br><br>  Appliquez la configuration mise √† jour avec la commande suivante: <br><br><pre> <code class="bash hljs">$ kubectl apply -f resource-manifests/istio/retries/sa-logic-retries-timeouts-vs.yaml virtualservice.networking.istio.io/sa-logic configured</code> </pre> <br>  Et v√©rifiez dans les graphiques de Grafana que le nombre de r√©ponses r√©ussies est termin√©: <br><br><img src="https://habrastorage.org/webt/ee/l_/qs/eel_qsg8z2vwzjwi35xmqg6eiko.png"><br>  <i>Am√©liorations des statistiques des r√©ponses r√©ussies apr√®s l'ajout de d√©lais d'attente et de nouvelles tentatives</i> <br><br>  Avant de passer √† la section suivante <i>(ou plut√¥t √† la partie suivante de l'article, car il n'y aura plus d'exp√©riences dans cette pratique - environ la traduction)</i> , supprimez <code>sa-logic-buggy</code> et VirtualService en ex√©cutant les commandes suivantes: <br><br><pre> <code class="bash hljs">$ kubectl delete deployment sa-logic-buggy deployment.extensions ‚Äúsa-logic-buggy‚Äù deleted $ kubectl delete virtualservice sa-logic virtualservice.networking.istio.io ‚Äúsa-logic‚Äù deleted</code> </pre> <br><h2>  Mod√®les de disjoncteurs et de cloisons </h2><br>  Nous parlons de deux mod√®les importants dans l'architecture de microservices qui vous permettent de r√©aliser <i>des</i> services d' <i>auto-gu√©rison</i> . <br><br>  <b>Le</b> <i>disjoncteur (¬´disjoncteur¬ª) est</i> utilis√© pour emp√™cher les demandes de parvenir √† une instance d'un service consid√©r√© comme malsain et le restaurer pendant que les demandes des clients sont redirig√©es vers des instances saines de ce service (ce qui augmente le pourcentage de r√©ponses r√©ussies).  <i>(Remarque: une description plus d√©taill√©e du mod√®le peut √™tre trouv√©e, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .)</i> <br><br>  <b>La cloison</b> <i>("partition")</i> isole les pannes de service de la d√©faite de l'ensemble du syst√®me.  Par exemple, le service B est rompu et un autre service (le client du service B) fait une demande au service B, √† la suite de quoi il utilisera son pool de threads et ne pourra pas r√©pondre √† d'autres demandes (m√™me si elles ne sont pas li√©es au service B).  <i>(Remarque: une description plus d√©taill√©e du mod√®le peut √™tre trouv√©e, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .)</i> <br><br>  Je vais omettre les d√©tails sur la mise en ≈ìuvre de ces mod√®les, car ils sont faciles √† trouver dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> , et je veux vraiment montrer l'authentification et l'autorisation, qui seront discut√©es dans la prochaine partie de l'article. <br><br><h2>  PS du traducteur </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  ¬´Retour aux microservices avec Istio¬ª: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 1 (familiarit√© avec les principales fonctionnalit√©s)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 3 (authentification et autorisation)</a> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Conduit - un maillage de service l√©ger pour Kubernetes</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Qu'est-ce qu'un maillage de service et pourquoi en ai-je besoin [pour une application cloud avec microservices]?</a>  ". </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440378/">https://habr.com/ru/post/fr440378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440364/index.html">Vous savez kilo, m√©ga et concert. Et ronne et cuecca?</a></li>
<li><a href="../fr440366/index.html">Cycle de vie d'un article sur Habr√©: on √©crit un habraparser</a></li>
<li><a href="../fr440370/index.html">Conditions d'utilisation: 99% des utilisateurs ne les comprennent tout simplement pas</a></li>
<li><a href="../fr440372/index.html">Mon compilateur Pascal et l'art contemporain polonais</a></li>
<li><a href="../fr440374/index.html">Les fonctions Yandex envoient du courrier</a></li>
<li><a href="../fr440382/index.html">200 est-il bon ou mauvais?</a></li>
<li><a href="../fr440386/index.html">Lib√©rer la gestion des erreurs en √©liminant les erreurs</a></li>
<li><a href="../fr440388/index.html">Intervalles: la prochaine √©volution C ++</a></li>
<li><a href="../fr440390/index.html">Le monde diversifi√© des syst√®mes embarqu√©s et la place d'Embox dans celui-ci</a></li>
<li><a href="../fr440392/index.html">WebRTC sur votre site - pas de bugs et pas de budget</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>