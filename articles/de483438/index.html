<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ô®Ô∏è üë®‚Äçüî¨ ‚è∫Ô∏è Spielen Sie "osu!", Vergessen Sie Fehler nicht üîÇ üö§ üëÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir begr√º√üen alle Liebhaber von exotischen und nicht sehr fehlerhaften Codes. Heute ist PVS-Studio auf dem Pr√ºfstand ein recht seltener Gast - ein Spi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Spielen Sie "osu!", Vergessen Sie Fehler nicht</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/483438/"><p><img src="https://habrastorage.org/getpro/habr/post_images/3ac/9da/a12/3ac9daa12b519fc14e45f7f65abdd204.png" alt="Bild 1" align="left"></p>  Wir begr√º√üen alle Liebhaber von exotischen und nicht sehr fehlerhaften Codes.  Heute ist PVS-Studio auf dem Pr√ºfstand ein recht seltener Gast - ein Spiel in C #.  Und zwar osu!  Wie immer: Fehler suchen, √ºberlegen, spielen. <br><a name="habracut"></a><br><h2>  Das Spiel </h2><br>  Osu!  - Ein Open-Source-Musik-Rhythmus-Spiel.  Gemessen an den Informationen auf <a href="https://osu.ppy.sh/home">der Website des Spiels ist</a> es sehr beliebt, da mehr als 15 Millionen registrierte Spieler beansprucht werden.  Das Projekt zeichnet sich durch kostenloses Gameplay, farbenfrohes Design mit der M√∂glichkeit zum Anpassen von Karten, erweiterte Funktionen zum Zusammenstellen einer Online-Bewertung von Spielern, die Anwesenheit von Multiplayern und eine gro√üe Anzahl von Musikkompositionen aus.  Ich werde das Spiel nicht im Detail beschreiben, Interessenten finden leicht alle Informationen im Netzwerk.  Zum Beispiel <a href="https://en.wikipedia.org/wiki/Osu!">hier</a> . <br><br>  Ich interessiere mich mehr f√ºr den Quellcode des Projekts, der von <a href="https://github.com/ppy/osu">GitHub</a> heruntergeladen werden kann.  Eine signifikante Anzahl von Commits (mehr als 24.000) im Projektarchiv erregt sofort Aufmerksamkeit, was auf die aktive Entwicklung des Projekts hinweist, die bis heute andauert (das Spiel wurde 2007 ver√∂ffentlicht, aber die Arbeit wurde wahrscheinlich fr√ºher begonnen).  Gleichzeitig gibt es nicht viel Quellcode - 1813 .cs-Dateien, die 135.000 Codezeilen enthalten, ausgenommen leere.  Dieser Code enth√§lt Tests, die ich normalerweise bei Schecks nicht ber√ºcksichtige.  Der Testcode ist in 306 .cs-Dateien und dementsprechend in 25.000 Codezeilen ohne leere Codezeilen enthalten.  Dies ist ein kleines Projekt: Zum Vergleich enth√§lt der C # -Kern des PVS-Studio-Analysators ungef√§hr 300.000 Codezeilen. <br><br>  Insgesamt habe ich, um das Spiel auf Fehler zu √ºberpr√ºfen, Nicht-Test-Projekte verwendet, die 1507 Quellcodedateien und 110.000 Zeilen enthielten.  Das Ergebnis hat mich jedoch teilweise gefreut, da es einige interessante Fehler gab, von denen ich Ihnen gerne erz√§hle. <br><br><h2>  Fehler </h2><br>  <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> Es gibt identische Unterausdr√ºcke 'result == HitResult.Perfect' links und rechts vom '||'  Betreiber.  DrawableHoldNote.cs 266 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckForResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ApplyResult(r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (holdNote.hasBroken &amp;&amp; (result == HitResult.Perfect || result == HitResult.Perfect)) result = HitResult.Good; .... }); }</code> </pre> <br>  Ein gutes Beispiel f√ºr eine kopier- und einf√ºgeorientierte Programmierung.  Ein Comic-Begriff, den mein Kollege Valery Komarov k√ºrzlich in seinem Artikel " <a href="https://www.viva64.com/ru/b/0699/">Top 10 Errors in Java Projects for 2019</a> " verwendet (vorgestellt) hat. <br><br>  Es folgen also zwei identische Pr√ºfungen nacheinander.  Eine der Pr√ºfungen sollte h√∂chstwahrscheinlich eine andere <i>HitResult-</i> Aufz√§hlungskonstante enthalten: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HitResult { None, Miss, Meh, Ok, Good, Great, Perfect, }</code> </pre> <br>  Welche bestimmte Konstante musste verwendet werden, oder ist die zweite √úberpr√ºfung √ºberhaupt nicht erforderlich?  Fragen, die nur der Entwickler beantworten kann.  In jedem Fall ist ein Fehler aufgetreten, der die Logik des Programms verf√§lscht. <br><br>  <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> Es gibt identische Unterausdr√ºcke 'family! = GetFamilyString (TournamentTypeface.Aquatico)' links und rechts vom Operator '&amp;&amp;'.  TournamentFont.cs 64 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeightString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> family, FontWeight weight</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weight == FontWeight.Regular &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico) &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico)) weightString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; .... }</code> </pre> <br>  Und wieder Kopieren-Einf√ºgen.  Ich habe den Code formatiert, sodass der Fehler leicht erkennbar ist.  In der Originalfassung wurde die gesamte Bedingung in einer Zeile geschrieben.  Es ist auch schwer zu sagen, wie Code repariert werden kann.  Die <i>TournamentTypeface-</i> Enumeration enth√§lt eine einzige Konstante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TournamentTypeface { Aquatico }</code> </pre> <br>  Die Bedingung hat die <i>Familienvariable</i> m√∂glicherweise zweimal versehentlich verwendet, dies ist jedoch nicht korrekt. <br><br>  <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> [CWE-393] Es ist seltsam, dass diese Methode immer denselben Wert von 'false' zur√ºckgibt.  KeyCounterAction.cs 19 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forwards</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!EqualityComparer&lt;T&gt;.Default.Equals(action, Action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsLit = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forwards) Increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  Die Methode gibt immer <i>false zur√ºck</i> .  F√ºr solche Fehler √ºberpr√ºfe ich normalerweise den aufrufenden Code, da sie den R√ºckgabewert oft nirgendwo verwenden, dann gibt es keinen Fehler (mit Ausnahme des h√§sslichen Programmierstils).  In diesem Fall bin ich auf folgenden Code gesto√üen: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action</span></span></span><span class="hljs-function">)</span></span> =&gt; Target.Children .OfType&lt;KeyCounterAction&lt;T&gt;&gt;() .Any(c =&gt; c.OnPressed(action, Clock.Rate &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  Wie Sie sehen, wird das von der <i>OnPressed-</i> Methode zur√ºckgegebene Ergebnis verwendet.  Und da es immer <i>falsch ist</i> , ist das Ergebnis des Aufrufs von <i>OnPressed</i> auch immer <i>falsch</i> .  Ich denke, Sie sollten diesen Code noch einmal √ºberpr√ºfen, da eine hohe Fehlerwahrscheinlichkeit besteht. <br><br>  Ein weiterer √§hnlicher Fehler: <br><br><ul><li>  V3009 [CWE-393] Es ist seltsam, dass diese Methode immer denselben Wert von 'false' zur√ºckgibt.  KeyCounterAction.cs 30 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3042/">V3042</a> [CWE-476] M√∂gliche NullReferenceException.  Das '?.'  und '.'  Operatoren werden f√ºr den Zugriff auf Mitglieder des 'val.NewValue'-Objekts TournamentTeam.cs 41 verwendet <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TournamentTeam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Acronym.ValueChanged += val =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) FlagName.Value = val.NewValue.Length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? val.NewValue?.Substring(0, 2).ToUpper() : string.Empty; }; .... }</span></span></code> </pre> <br>  Unter der Bedingung <i>?:</i> Operator ist die Variable <i>val.NewValue</i> nicht sicher.  Der Analysator hat diese Schlussfolgerung gezogen, da in der then-Verzweigung eine sichere Option verwendet wird, um √ºber den Operator <i>val.NewValue? .Substring (....)</i> auf die Variable zuzugreifen. <br><br>  Ein weiterer √§hnlicher Fehler: <br><br><ul><li>  V3042 [CWE-476] M√∂gliche NullReferenceException.  Das '?.'  und '.'  Operatoren werden f√ºr den Zugriff auf Mitglieder des 'val.NewValue'-Objekts TournamentTeam.cs 48 verwendet </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3042/">V3042</a> [CWE-476] M√∂gliche NullReferenceException.  Das '?.'  und '.'  Operatoren werden f√ºr den Zugriff auf Mitglieder des 'api'-Objekts SetupScreen.cs 77 verwendet <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionableInfo { Label = <span class="hljs-string"><span class="hljs-string">"Current User"</span></span>, ButtonText = <span class="hljs-string"><span class="hljs-string">"Change Login"</span></span>, Action = () =&gt; { api.Logout(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }, Value = api?.LocalUser.Value.Username, .... }, .... } private class ActionableInfo : LabelledDrawable&lt;Drawable&gt; { .... public Action Action; .... }</span></span></code> </pre> <br>  Dieser Code ist weniger klar, aber ich denke, der Fehler ist immer noch da.  Erstellen Sie ein Objekt vom Typ <i>ActionableInfo</i> .  Das Feld " <i>Aktion"</i> wird mit einem Lambda initialisiert, in dessen K√∂rper es nicht sicher ist, mit einer potenziell Null-Referenz- <i>API zu arbeiten</i> .  Der Analysator betrachtete dieses Muster als Fehler, da die Variable <i>api</i> bei der Initialisierung des Parameters <i>Value</i> sicher funktioniert.  Ich habe den Fehler als mehrdeutig bezeichnet, weil der Lambda-Code eine verz√∂gerte Ausf√ºhrung voraussetzt und der Entwickler dann m√∂glicherweise einen Wert ungleich Null f√ºr die <i>API-</i> Verkn√ºpfung garantiert.  Dies ist jedoch nur eine Annahme, da der Lambda-K√∂rper keine Anzeichen f√ºr ein sicheres Arbeiten mit dem Link enth√§lt (z. B. Vorabkontrollen). <br><br>  <a href="https://www.viva64.com/ru/w/v3066/">V3066</a> [CWE-683] M√∂gliche falsche Reihenfolge der an die Methode 'Atan2' √ºbergebenen Argumente: 'diff.X' und 'diff.Y'.  SliderBall.cs 182 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> completionProgress</span></span></span><span class="hljs-function">)</span></span> { .... Rotation = <span class="hljs-number"><span class="hljs-number">-90</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(-Math.Atan2(diff.X, diff.Y) * <span class="hljs-number"><span class="hljs-number">180</span></span> / Math.PI); .... }</code> </pre> <br>  Der Analysator vermutete, dass der Entwickler bei der Arbeit mit der <i>Atan2-</i> Methode der <i>Math-</i> Klasse die Reihenfolge der Argumente vertauscht hatte.  <i>Atan2 Ad</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Parameters: // y: // The y coordinate of a point. // // x: // The x coordinate of a point. public static double Atan2(double y, double x);</span></span></code> </pre> <br>  Wie Sie sehen, wurden die Werte in umgekehrter Reihenfolge √ºbertragen.  Ich kann nicht beurteilen, ob dies ein Fehler ist, da die <i>UpdateProgress-</i> Methode viele nichttriviale Berechnungen enth√§lt.  Ich stelle nur die Tatsache eines m√∂glichen Problems im Code fest. <br><br>  <a href="https://www.viva64.com/ru/w/v3080/">V3080</a> [CWE-476] M√∂gliche Null-Dereferenzierung.  Betrachten Sie 'Beatmap'.  WorkingBeatmap.cs 57 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Track </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObject = Beatmap.HitObjects.LastOrDefault(); .... }</code> </pre> <br>  Der Analysator wies auf die Gefahr des Zugriffs √ºber den <i>Beatmap-</i> Null-Link hin.  Hier ist was es ist: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IBeatmap Beatmap { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LoadBeatmapAsync().Result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TaskCanceledException) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre> <br>  Nun, der Analysator ist richtig. <br><br>  Weitere Informationen dazu, wie PVS-Studio solche Fehler findet, sowie zu Neuerungen in C # 8.0 in Bezug auf √§hnliche Themen (Arbeiten mit potenziell null Referenzen) finden Sie im Artikel " <a href="https://www.viva64.com/ru/b/0631/">Nullf√§hige Referenztypen in C # 8.0 und statische Analyse</a> ". <br><br>  <a href="https://www.viva64.com/ru/w/v3083/">V3083</a> [CWE-367] Unsicherer Aufruf des Ereignisses 'ObjectConverted', NullReferenceException ist m√∂glich.  √úberlegen Sie, ob Sie einer lokalen Variablen ein Ereignis zuweisen m√∂chten, bevor Sie sie aufrufen.  BeatmapConverter.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ObjectConverted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { converted = converted.ToList(); ObjectConverted.Invoke(obj, converted); } .... }</code> </pre> <br>  Unkritischer und weit verbreiteter Fehler.  Zwischen dem √úberpr√ºfen des Ereignisses auf <i>Null</i> und dem Aufrufen des Ereignisses k√∂nnen sie das Abonnement k√ºndigen, was zum Absturz des Programms f√ºhrt. <br>  Eine der L√∂sungen: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... converted = converted.ToList(); ObjectConverted?.Invoke(obj, converted); .... }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v3095/">V3095</a> [CWE-476] Das Objekt 'columns' wurde verwendet, bevor es gegen null verifiziert wurde.  Zeilen √ºberpr√ºfen: 141, 142. SquareGraph.cs 141 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redrawProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ColumnCount; i++) columns[i].State = i &lt;= progress ? ColumnState.Lit : ColumnState.Dimmed; columns?.ForceRedraw(); }</code> </pre> <br>  Es ist nicht sicher, die <i>Spaltensammlung</i> in einer Schleife zu umgehen.  Gleichzeitig ging der Entwickler davon aus, dass der Spaltenlink m√∂glicherweise null ist, da sp√§ter im Code ein Operator f√ºr den bedingten Zugriff verwendet wird, um auf die Auflistung zuzugreifen. <br><br>  <a href="https://www.viva64.com/ru/w/v3119/">V3119 Das</a> Aufrufen des √ºberschriebenen Ereignisses 'OnNewResult' kann zu unvorhersehbarem Verhalten f√ºhren.  Erw√§gen Sie, Ereignis-Accessoren explizit zu implementieren, oder verwenden Sie das Schl√ºsselwort 'sealed'.  DrawableRuleset.cs 256 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHitObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TObject hitObject</span></span></span><span class="hljs-function">)</span></span> { .... drawableObject.OnNewResult += (_, r) =&gt; OnNewResult?.Invoke(r); .... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;JudgementResult&gt; OnNewResult;</code> </pre> <br>  Der Analysator warnt vor den Gefahren eines √ºberschriebenen oder virtuellen Ereignisses.  Was genau ist die Gefahr - ich empfehle in der <a href="https://www.viva64.com/ru/w/v3119/">Beschreibung</a> f√ºr die Diagnose zu lesen.  Au√üerdem habe ich einmal einen Artikel zu diesem Thema geschrieben: " <a href="https://www.viva64.com/ru/b/0453/">Virtuelle Ereignisse in C #: Es ist ein Fehler aufgetreten</a> ." <br><br>  Ein weiteres √§hnliches unsicheres Konstrukt im Code: <br><br><ul><li>  V3119 Das Aufrufen eines √ºberschriebenen Ereignisses kann zu unvorhersehbarem Verhalten f√ºhren.  Erw√§gen Sie, Ereignis-Accessoren explizit zu implementieren, oder verwenden Sie das Schl√ºsselwort 'sealed'.  DrawableRuleset.cs 257 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3123/">V3123</a> [CWE-783] Vielleicht das '??'  Der Bediener arbeitet anders als erwartet.  Seine Priorit√§t ist niedriger als die Priorit√§t anderer Operatoren im linken Teil.  OsuScreenStack.cs 45 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * ((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; }</code> </pre> <br>  Zum besseren Verst√§ndnis des Problems werde ich ein synthetisches Beispiel geben, wie der Code jetzt funktioniert: <br><br><pre> <code class="cs hljs">x = (c * a) ?? b;</code> </pre> <br>  Der Fehler ist darauf zur√ºckzuf√ºhren, dass der Operator * eine h√∂here Priorit√§t als der Operator ?? hat.  Korrigierte Version des Codes (Klammern hinzugef√ºgt): <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * (((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); }</code> </pre> <br>  Ein weiterer √§hnlicher Fehler im Code: <br><br>  <a href="https://www.viva64.com/ru/w/v3123/">V3123</a> [CWE-783] Vielleicht das '??'  Der Bediener arbeitet anders als erwartet.  Seine Priorit√§t ist niedriger als die Priorit√§t anderer Operatoren im linken Teil.  FramedReplayInputHandler.cs 103 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime - NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  Hier wurde wie im vorherigen Codefragment die Priorit√§t der Operatoren nicht ber√ºcksichtigt.  Der an die <i>Math.Abs-</i> Methode √ºbergebene Ausdruck wird nun wie folgt ausgewertet: <br><br><pre> <code class="cs hljs">(a ‚Äì b) ?? <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Korrigierter Code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime ‚Äì (NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v3142/">V3142</a> [CWE-561] Nicht erreichbarer Code erkannt.  M√∂glicherweise liegt ein Fehler vor.  DrawableHoldNote.cs 214 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPressed(action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result.Type == HitResult.Miss) <span class="hljs-comment"><span class="hljs-comment">// &lt;= holdNote.hasBroken = true; .... }</span></span></code> </pre> <br>  Der Analysator gibt an, dass der <i>OnPressed-Handlercode</i> , der mit der zweiten <i>if-Anweisung</i> beginnt, nicht erreichbar ist.  Dies folgt aus der Annahme, dass die erste Bedingung immer wahr ist, d. <i>H.</i> Die <i>base.OnPressed-</i> Methode <i>gibt</i> immer <i>false zur√ºck</i> .  Schauen <i>Sie</i> sich die <i>base.OnPressed-</i> Methode an: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action != Action.Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  Wir fahren mit der <i>UpdateResult-</i> Methode fort: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userTriggered</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Time.Elapsed &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Judged) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Judged; }</code> </pre> <br>  Beachten Sie, dass die Implementierung der <i>Judged-</i> Eigenschaft hier nicht wichtig ist, da die Logik der <i>UpdateResult-</i> Methode impliziert, dass die letzte <i>return-Anweisung der folgenden</i> entspricht: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Daher gibt die <i>UpdateResult-</i> Methode immer <i>false zur√ºck</i> , was zu einem Fehler mit nicht erreichbarem Code im Code √ºber dem Stapel f√ºhrt. <br><br>  <a href="https://www.viva64.com/ru/w/v3146/">V3146</a> [CWE-476] M√∂gliche Null-Dereferenzierung von 'Regelsatz'.  Der 'FirstOrDefault' kann einen Standard-Nullwert zur√ºckgeben.  APILegacyScoreInfo.cs 24 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ScoreInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateScoreInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RulesetStore rulesets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ruleset = rulesets.GetRuleset(OnlineRulesetID); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mods = Mods != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? ruleset.CreateInstance() <span class="hljs-comment"><span class="hljs-comment">// &lt;= .GetAllMods().Where(....) .ToArray() : Array.Empty&lt;Mod&gt;(); .... }</span></span></code> </pre> <br>  Der Analyzer betrachtet den Aufruf von <i>ruleset.CreateInstance ()</i> als unsicher.  Die <i>Regelmengenvariable</i> erh√§lt zuvor den Wert als Ergebnis des Aufrufs von <i>GetRuleset</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RulesetInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRuleset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> =&gt; AvailableRulesets.FirstOrDefault(....);</code> </pre> <br>  Wie Sie sehen, ist die Warnung des Analysators berechtigt, da die Aufrufkette <i>FirstOrDefault</i> enth√§lt, die <i>null zur√ºckgeben kann</i> . <br><br><h2>  Fazit </h2><br>  Generell ist das Spielprojekt "osu!" Mit einer geringen Anzahl von Fehlern zufrieden.  Trotzdem empfehle ich Entwicklern, auf die erkannten Probleme zu achten.  Und lassen Sie das Spiel weiterhin seinen Fans gefallen. <br><br>  Und f√ºr diejenigen, die tiefer in den Code eintauchen m√∂chten, m√∂chte ich Sie daran erinnern, dass der PVS-Studio Analyzer, der einfach von der offiziellen Website <a href="https://www.viva64.com/ru/pvs-studio-download/">heruntergeladen</a> werden kann, eine gute Hilfe sein wird.  Ich stelle auch fest, dass einmalige Projektpr√ºfungen, wie die oben beschriebenen, nichts mit der Verwendung eines statischen Analysators in der Praxis zu tun haben.  Die maximale Effizienz bei der Fehlerbek√§mpfung kann nur durch den regelm√§√üigen Einsatz des Tools sowohl auf dem Build-Server als auch direkt auf dem Computer des Entwicklers erreicht werden (inkrementelle Analyse).  Das maximale Ziel besteht darin, zu verhindern, dass Fehler in das Versionskontrollsystem gelangen, und Fehler zu beheben, die bereits beim Schreiben des Codes aufgetreten sind. <br><br>  Viel Gl√ºck und Erfolg! <br><br><h2>  Referenzen </h2><br>  Dies ist die erste Ver√∂ffentlichung im Jahr 2020.  Bei dieser Gelegenheit werde ich Links zu Artikeln zur √úberpr√ºfung von C # -Projekten im letzten Jahr bereitstellen: <br><br><ul><li>  <a href="https://www.viva64.com/ru/b/0605/">Suchen Sie nach Fehlern im Amazon Web Services SDK f√ºr .NET-Quellcode</a> </li><li>  <a href="https://www.viva64.com/ru/b/0622/">√úberpr√ºfung des Quellcodes von Roslyn</a> </li><li>  <a href="https://www.viva64.com/ru/b/0631/">Nullf√§hige Referenztypen in C # 8.0 und statische Analyse</a> </li><li>  <a href="https://www.viva64.com/ru/b/0653/">WinForms: Fehler, Holmes</a> </li><li>  <a href="https://www.viva64.com/ru/b/0654/">Die Geschichte, wie PVS-Studio einen Fehler in der in ... PVS-Studio verwendeten Bibliothek gefunden hat</a> </li><li>  <a href="https://www.viva64.com/ru/b/0656/">√úberpr√ºfung des Quellcodes von .NET Core-Bibliotheken durch den statischen Analysator PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0664/">Roslyn-Analysatoren √ºberpr√ºfen</a> </li><li>  <a href="https://www.viva64.com/ru/b/0677/">Unter Telerik UI for UWP k√∂nnen Sie sich mit PVS-Studio vertraut machen</a> </li><li>  <a href="https://www.viva64.com/ru/b/0678/">Azure PowerShell: ‚Äûgr√∂√ütenteils harmlos‚Äú</a> </li><li>  <a href="https://www.viva64.com/ru/b/0681/">Wir suchen und analysieren Fehler im Orchard CMS-Code</a> </li><li>  <a href="https://www.viva64.com/ru/b/0683/">√úberpr√ºfen des OpenCvSharp-Wrappers √ºber OpenCV mit PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0692/">Azure SDK f√ºr .NET: Die Geschichte einer schwierigen Fehlersuche</a> </li><li>  <a href="https://www.viva64.com/ru/b/0694/">SARIF SDK und seine Fehler</a> </li><li>  <a href="https://www.viva64.com/ru/b/0698/">Top 10 Bugs in C # -Projekten f√ºr 2019</a> </li></ul><br><p> <a href="https://habr.com/en/company/pvs-studio/blog/483436/"><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Wenn Sie diesen Artikel mit einem englischsprachigen Publikum teilen m√∂chten, verwenden Sie bitte den Link zur √úbersetzung: Sergey Khrenov.  <a href="https://habr.com/en/company/pvs-studio/blog/483436/">Spielen Sie "osu!", Aber achten Sie auf Bugs</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de483438/">https://habr.com/ru/post/de483438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de483418/index.html">Ticketsysteme: Wie haben Sie drei kostenlose OTRS erhalten?</a></li>
<li><a href="../de483424/index.html">DBA: √úbertragung von SEQUENCE-Werten zwischen PostgreSQL-Datenbanken</a></li>
<li><a href="../de483426/index.html">Freitag Tab Umfrage</a></li>
<li><a href="../de483428/index.html">Wie wird die elektronische Dokumentenverwaltung nach Inkrafttreten von Gesetzes√§nderungen zur elektronischen Signatur aussehen?</a></li>
<li><a href="../de483436/index.html">Spielen Sie "osu!", Aber achten Sie auf Bugs</a></li>
<li><a href="../de483440/index.html">Neueste D-Compiler</a></li>
<li><a href="../de483444/index.html">DORA-Bericht 2019: So verbessern Sie die DevOps-Leistung</a></li>
<li><a href="../de483446/index.html">Wissenschaftler haben einen neuen Weg gefunden, um den Eisengehalt im Trinkwasser zu senken</a></li>
<li><a href="../de483448/index.html">Disney - die gr√∂√üte Zwei-Wege in der Geschichte der Menschheit</a></li>
<li><a href="../de483454/index.html">Wechseln von Mercurial zu GIT in Atlassian Bitbucket mit Speichern von Dateien in kyrillischer Sprache</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>