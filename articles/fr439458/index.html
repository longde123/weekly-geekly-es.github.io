<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒ­ ğŸ‘©ğŸ¿â€ğŸ­ ğŸ‘¨ğŸ¿â€âš•ï¸ Comment nous avons traduit le site Web de la RÃ©publique en Kubernetes ğŸ‘¨â€ğŸ¤ ğŸ“š ğŸ‘´ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Des documents scandaleux, importants et simplement trÃ¨s cool ne sont pas publiÃ©s dans les mÃ©dias tous les jours, et aucun Ã©diteur ne s'engage Ã  prÃ©dir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons traduit le site Web de la RÃ©publique en Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/439458/"><img src="https://habrastorage.org/webt/w6/od/az/w6odaz9seym3nomzxkvoekqzbms.png"><br><br>  Des documents scandaleux, importants et simplement trÃ¨s cool ne sont pas publiÃ©s dans les mÃ©dias tous les jours, et aucun Ã©diteur ne s'engage Ã  prÃ©dire le succÃ¨s d'un article avec une prÃ©cision de 100%.  Le maximum que l'Ã©quipe a est au niveau instinctif pour dire du matÃ©riel Â«fortÂ» ou Â«ordinaireÂ».  Câ€™est tout.  Commence alors la magie imprÃ©visible des mÃ©dias, grÃ¢ce Ã  laquelle l'article peut atteindre le sommet des rÃ©sultats de recherche avec des dizaines de liens provenant d'autres publications ou le matÃ©riel sombrera dans l'oubli.  Et juste dans le cas de la publication d'articles sympas, les sites mÃ©diatiques tombent pÃ©riodiquement sous un afflux monstrueux d'utilisateurs, que nous appelons modestement Â«l'habraeffetÂ». <br><br>  Cet Ã©tÃ©, le site Internet de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RÃ©publique a</a> Ã©tÃ© victime du professionnalisme de ses propres auteurs: des articles sur le thÃ¨me de la rÃ©forme des retraites, de l'Ã©ducation scolaire et d'une bonne nutrition ont rÃ©uni au total plusieurs millions de lecteurs.  La publication de chacun des documents mentionnÃ©s a conduit Ã  des charges si Ã©levÃ©es que jusqu'Ã  la chute du site Internet de la RÃ©publique, il restait absolument Â«un peu d'espaceÂ».  L'administration s'est rendu compte qu'il fallait changer quelque chose: il fallait changer la structure du projet de telle sorte qu'il puisse rÃ©agir vigoureusement aux changements des conditions de travail (principalement la charge externe), tout en restant pleinement fonctionnel et accessible aux lecteurs mÃªme en cas de sauts trÃ¨s brusques de frÃ©quentation.  Et un grand bonus serait l'intervention manuelle minimale de l'Ã©quipe technique de la RÃ©publique Ã  ces moments. <br><br>  Sur la base des rÃ©sultats d'une discussion conjointe avec des experts de la RÃ©publique sur les diffÃ©rentes options de mise en Å“uvre de la liste de souhaits exprimÃ©e, nous avons dÃ©cidÃ© de transfÃ©rer le site Web de la publication Ã  Kubernetes *.  Ã€ propos de ce que tout cela nous a coÃ»tÃ© Ã  tous, et ce sera l'histoire d'aujourd'hui. <br><br>  <i>* Pendant le dÃ©mÃ©nagement, pas un seul spÃ©cialiste technique rÃ©publicain n'a Ã©tÃ© blessÃ©</i> <br><a name="habracut"></a><br><h3>  Ã€ quoi il ressemblait en termes gÃ©nÃ©raux </h3><br>  Tout a commencÃ©, bien sÃ»r, par des nÃ©gociations sur la maniÃ¨re dont tout se passera Â«maintenantÂ» et Â«plus tardÂ».  Malheureusement, le paradigme moderne du marchÃ© informatique implique que dÃ¨s qu'une entreprise se retire pour une sorte de solution d'infrastructure, elle la transforme en liste de prix de service clÃ© en main.  Il semblerait que le travail soit Â«clÃ© en mainÂ» - quoi de plus agrÃ©able et de plus agrÃ©able qu'un directeur conditionnel ou un propriÃ©taire d'entreprise?  J'ai payÃ© et ma tÃªte ne me fait pas de mal: planification, dÃ©veloppement, assistance - tout est lÃ , du cÃ´tÃ© de l'entrepreneur, l'entreprise ne peut que gagner de l'argent pour payer un service aussi agrÃ©able. <br><br>  Cependant, le transfert complet de l'infrastructure informatique n'est pas toujours appropriÃ© pour le client Ã  long terme.  Il est plus correct Ã  tous points de vue de travailler en une seule grande Ã©quipe, de sorte qu'aprÃ¨s la fin du projet, le client comprenne comment vivre avec la nouvelle infrastructure et que les collÃ¨gues de l'atelier ne se posent pas la question "oh, qu'est-ce que c'Ã©tait jusqu'ici?"  aprÃ¨s signature du certificat d'achÃ¨vement et dÃ©monstration des rÃ©sultats.  Les gars de la RÃ©publique Ã©taient du mÃªme avis.  En consÃ©quence, pendant deux mois, nous avons atterri un atterrissage de quatre personnes au client, qui a non seulement rÃ©alisÃ© notre idÃ©e, mais aussi des spÃ©cialistes techniquement formÃ©s du cÃ´tÃ© de la RÃ©publique pour poursuivre le travail et l'existence dans les rÃ©alitÃ©s de Kubernetes. <br><br>  Et toutes les parties en ont profitÃ©: nous avons rapidement terminÃ© le travail, gardÃ© nos spÃ©cialistes prÃªts pour de nouvelles rÃ©alisations et obtenu que Republic en tant que client bÃ©nÃ©ficie d'un soutien consultatif avec nos propres ingÃ©nieurs.  La publication, en revanche, a reÃ§u une nouvelle infrastructure adaptÃ©e aux Â«habraeffectsÂ», son propre personnel de spÃ©cialistes techniques retenu et la possibilitÃ© de demander de l'aide si nÃ©cessaire. <br><br><h3>  Nous prÃ©parons une tÃªte de pont </h3><br>  "DÃ©truire - pas construire."  Ce dicton s'applique Ã  tout.  Bien sÃ»r, la solution la plus simple semble Ãªtre la prise en otage de l'infrastructure du client mentionnÃ©e prÃ©cÃ©demment et l'enchaÃ®nement, le client Ã  lui-mÃªme, ou l'overclocking du personnel existant et la nÃ©cessitÃ© d'engager un gourou des nouvelles technologies.  Nous sommes allÃ©s le troisiÃ¨me, pas le moyen le plus populaire aujourd'hui, et avons commencÃ© par la formation des ingÃ©nieurs de la RÃ©publique. <br><br>  Vers le dÃ©but, nous avons vu une telle solution pour assurer le fonctionnement du site: <br><img src="https://habrastorage.org/webt/lh/tu/dx/lhtudxfxmjai0dymprwmpctjmr8.png"><br><br>  Autrement dit, Republic n'avait que deux serveurs de fer - le principal et la sauvegarde, la sauvegarde.  La chose la plus importante pour nous a Ã©tÃ© de rÃ©aliser un changement de paradigme dans la pensÃ©e des spÃ©cialistes techniques du client, car auparavant, ils traitaient d'un groupe trÃ¨s simple de NGINX, PHP-fpm et PostgreSQL.  Ils Ã©taient dÃ©sormais confrontÃ©s Ã  l'architecture de conteneur Ã©volutive de Kubernetes.  Donc, tout d'abord, nous avons basculÃ© le dÃ©veloppement de Republic local vers l'environnement docker-compose.  Et ce n'Ã©tait que la premiÃ¨re Ã©tape. <br><br>  Avant notre arrivÃ©e, les dÃ©veloppeurs de Republic ont conservÃ© leur environnement de travail local dans des machines virtuelles configurÃ©es via Vagrant, ou ont travaillÃ© directement avec le serveur de dÃ©veloppement via sftp.  Sur la base de l'image de base gÃ©nÃ©rale d'une machine virtuelle, chaque dÃ©veloppeur a Â«prÃ©configurÃ©Â» sa machine Â«pour lui-mÃªmeÂ», ce qui a donnÃ© lieu Ã  un ensemble de configurations diffÃ©rentes.  Ã€ la suite de cette approche, l'inclusion de nouvelles personnes dans l'Ã©quipe a augmentÃ© de faÃ§on exponentielle le temps d'entrÃ©e dans le projet. <br><br>  Dans les nouvelles rÃ©alitÃ©s, nous avons offert Ã  l'Ã©quipe une structure plus transparente de l'environnement de travail.  Il a dÃ©crit de maniÃ¨re dÃ©clarative quels logiciels et quelles versions sont nÃ©cessaires pour le projet, l'ordre des connexions et les interactions entre les services (applications).  Cette description a Ã©tÃ© tÃ©lÃ©chargÃ©e dans un rÃ©fÃ©rentiel git sÃ©parÃ© afin qu'elle puisse Ãªtre gÃ©rÃ©e de maniÃ¨re pratique et centralisÃ©e. <br><br>  Toutes les applications nÃ©cessaires ont commencÃ© Ã  s'exÃ©cuter dans des conteneurs Docker sÃ©parÃ©s - et c'est un site php rÃ©gulier avec nginx, beaucoup de statiques, des services pour travailler avec des images (redimensionnement, optimisation, etc.), et ... un service sÃ©parÃ© pour les sockets web Ã©crit en D Tous les fichiers de configuration (nginx-conf, php-conf ...) font Ã©galement partie de la base de code du projet. <br><br>  En consÃ©quence, l'environnement local a Ã©tÃ© complÃ¨tement "recrÃ©Ã©", complÃ¨tement identique Ã  l'infrastructure actuelle du serveur.  Ainsi, le temps nÃ©cessaire pour maintenir le mÃªme environnement Ã  la fois sur les machines locales des dÃ©veloppeurs et sur le prod a Ã©tÃ© rÃ©duit.  Ce qui, Ã  son tour, a grandement contribuÃ© Ã  Ã©viter des problÃ¨mes complÃ¨tement inutiles causÃ©s par les configurations locales auto-Ã©crites de chaque dÃ©veloppeur. <br><br>  En consÃ©quence, les services suivants ont Ã©tÃ© gÃ©nÃ©rÃ©s dans l'environnement docker-compose: <br><br><ul><li>  Web pour l'application php-fpm; </li><li>  nginx; </li><li>  impproxy et cairosvg (services pour travailler avec des images); </li><li>  postgres </li><li>  redis; </li><li>  recherche Ã©lastique; </li><li>  trompette (le mÃªme service pour les sockets web sur D). </li></ul><br>  Du point de vue des dÃ©veloppeurs, le travail avec la base de code est restÃ© inchangÃ© - il a Ã©tÃ© montÃ© dans les services nÃ©cessaires Ã  partir d'un rÃ©pertoire sÃ©parÃ© (le rÃ©fÃ©rentiel de base avec le code du site) dans les services nÃ©cessaires: le rÃ©pertoire public dans le service nginx, tout le code d'application php dans le service php-fpm.  Ã€ partir du rÃ©pertoire sÃ©parÃ© (qui contient toutes les configurations d'environnement de composition), les fichiers de configuration correspondants sont montÃ©s dans les services nginx et php-fpm.  Les rÃ©pertoires avec postgres de donnÃ©es, elasticsearch et redis sont Ã©galement montÃ©s sur la machine locale du dÃ©veloppeur, de sorte que si tous les conteneurs doivent Ãªtre reconstruits / supprimÃ©s, les donnÃ©es de ces services ne seront pas perdues. <br><br>  Pour travailler avec les journaux d'application - Ã©galement dans l'environnement Docker-compose - les services de la pile ELK ont Ã©tÃ© augmentÃ©s.  Auparavant, une partie des journaux des applications Ã©tait Ã©crite dans le fichier standard / var / log / ..., les journaux des applications php et les exÃ©cutions Ã©taient Ã©crits dans Sentry, et cette option de stockage de journaux "dÃ©centralisÃ©" Ã©tait extrÃªmement difficile Ã  utiliser.  DÃ©sormais, les applications et les services ont Ã©tÃ© configurÃ©s et affinÃ©s pour interagir avec la pile ELK.  L'utilisation des journaux est devenue beaucoup plus facile; les dÃ©veloppeurs disposent dÃ©sormais d'une interface pratique pour rechercher et filtrer les journaux.  Ã€ l'avenir (dÃ©jÃ  dans le cube) - vous pouvez regarder les journaux d'une version spÃ©cifique de l'application (par exemple, un kronzhoba lancÃ© avant-hier). <br><br>  De plus, l'Ã©quipe de la RÃ©publique a commencÃ© une courte pÃ©riode d'adaptation.  L'Ã©quipe devait comprendre et apprendre Ã  travailler dans le nouveau paradigme de dÃ©veloppement, dans lequel les Ã©lÃ©ments suivants devraient Ãªtre pris en compte: <br><br><ol><li>  Les applications deviennent sans Ã©tat, et elles peuvent perdre des donnÃ©es Ã  tout moment, donc travailler avec des bases de donnÃ©es, des sessions, des fichiers statiques doit Ãªtre construit diffÃ©remment.  Les sessions PHP doivent Ãªtre stockÃ©es de maniÃ¨re centralisÃ©e et partagÃ©es entre toutes les instances d'application.  Il peut s'agir de fichiers, mais le plus souvent, redis est utilisÃ© Ã  ces fins en raison de sa plus grande facilitÃ© de gestion.  Les conteneurs pour les bases de donnÃ©es doivent Â«monterÂ» un datadir ou la base de donnÃ©es doit Ãªtre exÃ©cutÃ©e en dehors de l'infrastructure de conteneur. </li><li>  Un stockage de fichiers d'environ 50 Ã  60 Go d'images ne doit pas se trouver Â«dans l'application WebÂ».  Ã€ ces fins, il est nÃ©cessaire d'utiliser du stockage externe, des systÃ¨mes cdn, etc. </li><li>  Toutes les applications (bases de donnÃ©es, serveurs d'applications ...) sont dÃ©sormais des Â«servicesÂ» distincts, et l'interaction entre elles doit Ãªtre configurÃ©e par rapport au nouvel espace de noms. </li></ol><br>  Une fois que l'Ã©quipe de dÃ©veloppement de Republic s'est habituÃ©e aux innovations, nous avons commencÃ© Ã  transfÃ©rer l'infrastructure de vente de la publication Ã  Kubernetes. <br><br><h3>  Et voici Kubernetes </h3><br>  Sur la base de l'environnement conÃ§u pour le dÃ©veloppement local de docker-compose, nous avons commencÃ© Ã  traduire le projet en un "cube".  Tous les services sur lesquels le projet est construit localement, nous avons "emballÃ© dans des conteneurs": nous avons organisÃ© une procÃ©dure linÃ©aire et comprÃ©hensible pour la construction d'applications, le stockage de configurations, la compilation de statiques.  Du point de vue du dÃ©veloppement, ils ont supprimÃ© les paramÃ¨tres de configuration dont nous avions besoin dans les variables d'environnement, ont commencÃ© Ã  stocker les sessions non pas dans des fichiers, mais dans des radis.  Nous avons augmentÃ© l'environnement de test, oÃ¹ nous avons dÃ©ployÃ© une version fonctionnelle du site. <br><br>  Comme il s'agit d'un ancien projet monolithique, il est Ã©vident qu'il y avait une relation difficile entre les versions frontend et backend, respectivement, et ces deux composants ont Ã©tÃ© dÃ©ployÃ©s en mÃªme temps.  Par consÃ©quent, nous avons dÃ©cidÃ© de construire les pods de l'application Web de maniÃ¨re Ã  ce que deux conteneurs tournent dans un pod: php-fpm et nginx. <br><br>  Nous avons Ã©galement construit une mise Ã  l'Ã©chelle automatique afin que les applications Web soient mises Ã  l'Ã©chelle jusqu'Ã  un maximum de 12 au pic de trafic, dÃ©finissez certains tests de vivacitÃ© / de prÃ©paration, car l'application nÃ©cessite au moins 2 minutes pour s'exÃ©cuter (car vous devez rÃ©chauffer le cache, gÃ©nÃ©rer des configurations ...) <br><br>  ImmÃ©diatement, bien sÃ»r, il y avait toutes sortes de bancs et de nuances.  Par exemple: la statique compilÃ©e Ã©tait nÃ©cessaire Ã  la fois pour le serveur Web qui la distribuait et pour le serveur d'applications sur fpm, qui quelque part Ã  la volÃ©e gÃ©nÃ©rait une sorte d'images, quelque part svg donnait directement au code.  Nous avons rÃ©alisÃ© que pour ne pas se lever deux fois, nous devons crÃ©er un conteneur de construction intermÃ©diaire et conteneuriser l'assemblage final en plusieurs Ã©tapes.  Pour ce faire, nous avons crÃ©Ã© plusieurs conteneurs intermÃ©diaires, dans chacun desquels les dÃ©pendances sont extraites sÃ©parÃ©ment, puis les statiques (css et js) sont collectÃ©es sÃ©parÃ©ment, puis dans deux conteneurs - en nginx et en fpm - elles sont copiÃ©es Ã  partir du conteneur de build intermÃ©diaire. <br><br><h3>  Nous commenÃ§ons </h3><br>  Pour travailler avec des fichiers lors de la premiÃ¨re itÃ©ration, nous avons crÃ©Ã© un rÃ©pertoire commun synchronisÃ© avec toutes les machines en fonctionnement.  Par le mot Â«synchronisÃ©Â», je veux dire ici exactement ce que vous pouvez penser avec horreur en premier lieu - rsync dans un cercle.  De toute Ã©vidence, une mauvaise dÃ©cision.  En consÃ©quence, nous avons obtenu tout l'espace disque sur GlusterFS, configurÃ© le travail avec les images afin qu'elles soient toujours accessibles Ã  partir de n'importe quelle machine et que rien ne ralentisse.  Pour l'interaction de nos applications avec les systÃ¨mes de stockage (postgres, elasticsearch, redis), les services externalName ont Ã©tÃ© crÃ©Ã©s dans k8s, de sorte que, par exemple, en cas de passage urgent Ã  la base de donnÃ©es de sauvegarde, mettez Ã  jour les paramÃ¨tres de connexion en un seul endroit. <br><br>  Tout le travail avec les crones a Ã©tÃ© transfÃ©rÃ© aux nouvelles entitÃ©s k8s - cronjob, qui peuvent fonctionner selon un calendrier spÃ©cifique. <br><br>  En consÃ©quence, nous avons obtenu cette architecture: <br><br> <a href=""><img src="https://habrastorage.org/webt/q4/-1/f9/q4-1f9u514-psd-2yfkn5pg74j0.jpeg"></a> <br>  <i>Cliquable</i> <br><br><h3>  Oh difficile </h3><br>  Ce fut le lancement de la premiÃ¨re version, car parallÃ¨lement Ã  la restructuration complÃ¨te de l'infrastructure, le site Ã©tait toujours en cours de refonte.  Une partie du site a Ã©tÃ© construite avec certains paramÃ¨tres - pour la statique et tout le reste, et une partie - avec d'autres.  LÃ , il fallait ... pour le moins ... pervertir avec tous ces conteneurs Ã  plusieurs Ã©tages, copier les donnÃ©es d'eux dans un ordre diffÃ©rent, etc. <br><br>  Nous avons Ã©galement dÃ» danser avec des tambourins autour du systÃ¨me CI \ CD afin d'enseigner tout cela Ã  dÃ©ployer et Ã  contrÃ´ler Ã  partir de diffÃ©rents rÃ©fÃ©rentiels et d'environnements diffÃ©rents.  AprÃ¨s tout, un contrÃ´le constant des versions des applications est nÃ©cessaire afin que vous puissiez comprendre quand un service ou un autre service a Ã©tÃ© dÃ©ployÃ© et avec quelle version de l'application une ou une autre erreur a commencÃ©.  Pour ce faire, nous avons mis en place le systÃ¨me de journalisation correct (ainsi que la culture de journalisation elle-mÃªme) et implÃ©mentÃ© ELK.  Les collÃ¨gues ont appris Ã  dÃ©finir certains sÃ©lecteurs, Ã  voir quel cron gÃ©nÃ¨re quelles erreurs, comment il est gÃ©nÃ©ralement exÃ©cutÃ©, car dans le Â«cubeÂ» aprÃ¨s l'exÃ©cution du conteneur de cron, vous n'y entrerez plus. <br><br>  Mais la chose la plus difficile pour nous a Ã©tÃ© de retravailler et de rÃ©viser l'intÃ©gralitÃ© de la base de code. <br><br>  Je vous rappelle que Republic est un projet qui a maintenant 10 ans.  Cela a commencÃ© avec une Ã©quipe, une autre se dÃ©veloppe maintenant, et il est vraiment difficile de pelleter tous les codes source pour d'Ã©ventuels bugs et erreurs.  Bien sÃ»r, en ce moment, notre groupe d'atterrissage de quatre personnes a connectÃ© les ressources du reste de l'Ã©quipe: nous avons cliquÃ© et testÃ© l'ensemble du site avec des tests, mÃªme dans les sections que les gens vivants n'avaient pas visitÃ©s depuis 2016. <br><br><h3>  Aucun Ã©chec partout </h3><br>  Lundi, tÃ´t le matin, lorsque les gens sont allÃ©s au mailing de masse avec un rÃ©sumÃ©, nous avons tous eu un pieu.  Le coupable a Ã©tÃ© trouvÃ© assez rapidement: cronjob a commencÃ© et a commencÃ© frÃ©nÃ©tiquement Ã  envoyer des lettres Ã  tous ceux qui voulaient obtenir une sÃ©lection de nouvelles au cours de la semaine derniÃ¨re, dÃ©vorant les ressources de l'ensemble du cluster en cours de route.  Nous ne pouvions pas accepter un tel comportement, nous avons donc rapidement mis des limites strictes sur toutes les ressources: la quantitÃ© de processeur et de mÃ©moire qu'un conteneur peut consommer, etc. <br><br><h3>  Comment l'Ã©quipe de dÃ©veloppeurs de la RÃ©publique a-t-elle fait face </h3><br>  Nos activitÃ©s ont apportÃ© beaucoup de changements et nous l'avons compris.  En fait, nous avons non seulement redessinÃ© l'infrastructure de la publication, au lieu du bundle habituel Â«serveur de sauvegarde principalÂ», implÃ©mentÃ© une solution de conteneur, qui, si nÃ©cessaire, connectait des ressources supplÃ©mentaires, mais a Ã©galement complÃ¨tement changÃ© l'approche de dÃ©veloppement. <br><br>  AprÃ¨s un certain temps, les gars ont commencÃ© Ã  comprendre que cela ne fonctionnait pas directement avec du code, mais avec une application abstraite.  Compte tenu des processus CI \ CD (construits sur Jenkins), ils ont commencÃ© Ã  Ã©crire des tests, ils ont obtenu des environnements de dÃ©veloppement de stade Ã  part entiÃ¨re oÃ¹ ils peuvent tester de nouvelles versions de leur application en temps rÃ©el, voir oÃ¹ tout tombe et apprendre Ã  vivre nouveau monde idÃ©al. <br><br><h3>  Qu'a obtenu le client </h3><br>  Tout d'abord, Republic a enfin obtenu un processus de dÃ©ploiement contrÃ´lÃ©!  Auparavant, dans la RÃ©publique, il y avait un responsable qui est allÃ© sur le serveur, a tout dÃ©marrÃ© manuellement, puis collectÃ© des statistiques, vÃ©rifiÃ© avec ses mains que rien n'Ã©tait tombÃ© ... Maintenant, le processus de dÃ©ploiement est construit de sorte que les dÃ©veloppeurs soient engagÃ©s dans le dÃ©veloppement et ne perdent pas de temps sur autre chose .  Et la personne responsable a maintenant une tÃ¢che - surveiller comment la libÃ©ration s'est dÃ©roulÃ©e en gÃ©nÃ©ral. <br><br>  AprÃ¨s un push vers la branche maÃ®tre, soit automatiquement, soit par un dÃ©ploiement par Â«bouton-poussoirÂ» (pÃ©riodiquement, en raison de certaines exigences mÃ©tier, le dÃ©ploiement automatique est dÃ©sactivÃ©), Jenkins entre dans la mÃªlÃ©e: l'assemblage du projet commence.  Tout d'abord, tous les conteneurs docker sont assemblÃ©s: des dÃ©pendances (compositeur, fil, npm) sont installÃ©es dans les conteneurs prÃ©paratoires, ce qui vous permet d'accÃ©lÃ©rer le processus de construction si la liste des bibliothÃ¨ques requises n'a pas changÃ© pendant le dÃ©ploiement;  puis des conteneurs pour php-fpm, nginx, d'autres services sont collectÃ©s, dans lesquels, par analogie avec l'environnement docker-compose, seules les parties nÃ©cessaires de la base de code sont copiÃ©es.  AprÃ¨s cela, les tests sont lancÃ©s et, en cas de rÃ©ussite des tests, il y a une poussÃ©e d'images vers le magasin privÃ© et, en fait, le dÃ©ploiement des dÃ©ploiements dans le cuber. <br><br>  GrÃ¢ce au transfert de Republic vers k8s, nous avons obtenu une architecture utilisant un cluster de trois machines rÃ©elles sur lesquelles jusqu'Ã  douze copies de l'application web peuvent Â«tournerÂ» en mÃªme temps.  Dans le mÃªme temps, le systÃ¨me lui-mÃªme, en fonction des charges actuelles, dÃ©cide du nombre de copies dont il a besoin actuellement.  Nous avons pris Republic de la loterie Â«fonctionne - ne fonctionne pasÂ» avec des serveurs statiques primaires et de secours et avons construit un systÃ¨me flexible pour eux, prÃªt pour une augmentation semblable Ã  une avalanche de la charge sur le site. <br><br>  Ã€ ce moment, la question peut se poser "les gars, vous avez changÃ© deux morceaux de fer pour les mÃªmes morceaux de fer, mais avec la virtualisation, quel est le gain, Ãªtes-vous bien lÃ ?"  Et, bien sÃ»r, ce sera logique.  Mais seulement en partie.  En consÃ©quence, nous n'avons pas obtenu uniquement des piÃ¨ces de matÃ©riel avec virtualisation.  Nous avons eu un environnement de travail stable, le mÃªme dans la nourriture et la vierge.  Un environnement gÃ©rÃ© de maniÃ¨re centralisÃ©e pour tous les participants au projet.  Nous avons obtenu un mÃ©canisme pour assembler l'ensemble du projet et dÃ©ployer les versions, encore une fois, le mÃªme pour tout le monde.  Nous avons obtenu un systÃ¨me d'orchestration de projet pratique.  DÃ¨s que l'Ã©quipe de la RÃ©publique constate qu'ils cessent gÃ©nÃ©ralement d'avoir suffisamment de ressources actuelles et les risques de charges ultra-Ã©levÃ©es (ou quand c'est dÃ©jÃ  arrivÃ© et que tout est rÃ©glÃ©), ils prennent juste un autre serveur, en 10 minutes dÃ©ploient le rÃ´le d'un nÅ“ud de cluster dessus, et op-op tout est beau et bon Ã  nouveau.  La structure prÃ©cÃ©dente du projet ne suggÃ©rait pas du tout une telle approche; il n'y avait ni solution lente ni rapide Ã  de tels problÃ¨mes. <br><br>  DeuxiÃ¨mement, un dÃ©ploiement transparent est apparu: le visiteur pourra soit accÃ©der Ã  l'ancienne version de l'application, soit Ã  une nouvelle.  Et pas comme avant, quand le contenu pourrait Ãªtre nouveau, mais les styles sont anciens. <br>  En consÃ©quence, l'entreprise est satisfaite: toutes sortes de nouvelles choses peuvent dÃ©sormais Ãªtre rÃ©alisÃ©es plus rapidement et plus souvent. <br>  Au total, de Â«mais essayonsÂ» Ã  Â«terminÃ©Â», le travail sur le projet a durÃ© 2 mois.  L'Ã©quipe de notre part est un atterrissage hÃ©roÃ¯que de quatre personnes + soutien Ã  la "base" lors de la vÃ©rification du code et des tests. <br><br><h3>  Ce que les utilisateurs ont </h3><br>  Et les visiteurs, en principe, n'ont pas vu les changements.  Le processus de dÃ©ploiement de la stratÃ©gie de RollingUpdate est construit Â«de maniÃ¨re transparenteÂ».  Le dÃ©ploiement d'une nouvelle version du site ne nuit en rien aux utilisateurs, la nouvelle version du site, jusqu'Ã  ce que les tests rÃ©ussissent et les tests de vivacitÃ© / prÃ©paration, ne sera pas disponible.  Ils voient simplement que le site fonctionne et qu'il ne tombera pas aprÃ¨s avoir publiÃ© des articles sympas.  C'est en gÃ©nÃ©ral ce dont tout projet a besoin. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439458/">https://habr.com/ru/post/fr439458/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439446/index.html">Ce que vous devez savoir sur JavaScript Engine Switcher 3.0</a></li>
<li><a href="../fr439448/index.html">Ã€ quelles questions sur la virtualisation attendez-vous une rÃ©ponse d'un diplÃ´mÃ©?</a></li>
<li><a href="../fr439450/index.html">RS-485 sur microcontrÃ´leurs domestiques de la sociÃ©tÃ© Milander</a></li>
<li><a href="../fr439454/index.html">Program as Art - Un nouveau paradigme de gestion de logiciels</a></li>
<li><a href="../fr439456/index.html">Podcasts hipster # 2</a></li>
<li><a href="../fr439460/index.html">Comment les spÃ©cialistes du marketing de Maksidoma perdent des millions en affichant un marketing de croissance: audit indÃ©pendant de l'utilisabilitÃ©</a></li>
<li><a href="../fr439462/index.html">Civilisation printaniÃ¨re, 5/5</a></li>
<li><a href="../fr439464/index.html">VXinspect: contrÃ´le qualitÃ© des piÃ¨ces en 10 minutes</a></li>
<li><a href="../fr439466/index.html">La sonde en orbite lunaire de la NASA a pris les premiÃ¨res photos de la station chinoise Chang'e-4 - deux pixels de lumiÃ¨re</a></li>
<li><a href="../fr439468/index.html">OÃ¹ mÃ¨ne la recherche du SCADA parfait</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>