<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçü§ù‚Äçüë®üèº ‚õ∫Ô∏è üõ≥Ô∏è Testando o c√≥digo do SQL Server com tSQLt üíø üôçüèø üêõ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="FYI: este artigo √© uma vers√£o expandida da minha palestra no SQA Days # 25. 

 Com base na minha experi√™ncia com colegas, posso afirmar: o teste de c√≥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testando o c√≥digo do SQL Server com tSQLt</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/465567/">  <i>FYI: este artigo √© uma vers√£o expandida da minha <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">palestra</a> no SQA Days # 25.</i> <br><br>  Com base na minha experi√™ncia com colegas, posso afirmar: o teste de c√≥digo de banco de dados n√£o √© uma pr√°tica amplamente difundida.  Isso pode ser potencialmente perigoso.  A l√≥gica do DB √© escrita por seres humanos, assim como todos os outros c√≥digos "usuais".  Portanto, pode haver falhas que podem causar consequ√™ncias negativas para um produto, empresa ou usu√°rio.  Se esses procedimentos s√£o armazenados, ajudando o back-end ou modificando os dados de ETL em um armaz√©m - sempre h√° um risco e o teste ajuda a diminu√≠-lo.  Quero lhe dizer o que √© o tSQLt e como isso nos ajuda a testar o c√≥digo do banco de dados. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/-h/nx/2e-hnxb3bddbq3ck_8vi4jwah8i.jpeg"></div><a name="habracut"></a><br><h1>  O contexto </h1><br>  H√° um grande armaz√©m usando o SQL Server e contendo diferentes dados de ensaios cl√≠nicos.  √â preenchido a partir de uma variedade de fontes (principalmente bancos de dados orientados a documentos).  Muitos ETLs transformam dados no armaz√©m em v√°rias ocasi√µes.  Esses dados podem ser carregados em bancos de dados menores para uso por aplicativos da Web orientados para pequenas tarefas espec√≠ficas.  Alguns dos clientes do cliente pediram para implementar APIs para suas necessidades.  Essas APIs geralmente usam procedimentos armazenados e consultas diferentes. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/iw/vu/rz/iwvurz8sbflhuz3mkj39ipf9rag.png"></div><br>  Em geral, h√° uma quantidade muito grande de c√≥digo no lado do DBMS. <br><br><h1>  Por que precisamos disso? </h1><br>  Como voc√™ pode ver na introdu√ß√£o, o c√≥digo do DB faz parte do c√≥digo do aplicativo e tamb√©m pode conter bugs. <br><br>  Acho que muitos de n√≥s estamos familiarizados com a Curva de Boehm: os bugs s√£o sempre mais caros para serem corrigidos posteriormente no processo.  Um erro que foi cometido em um est√°gio de desenvolvimento anterior e localizado em um posterior pode custar mais.  Isso ocorre devido √† necessidade de passar por v√°rias etapas intermedi√°rias (codifica√ß√£o, teste de unidade, teste de integra√ß√£o, teste de sistema etc.) duas vezes: para depura√ß√£o e retorno do c√≥digo ao est√°gio em que foi encontrado.  Esse efeito tamb√©m √© v√°lido para a caixa do armaz√©m.  Se houver um erro em um procedimento ETL e os dados forem modificados v√°rias vezes, devemos: <br><br><ol><li>  passar por todas as etapas de transforma√ß√£o de dados de volta √† origem do problema </li><li>  conserte o problema </li><li>  obter os dados adequados novamente (edi√ß√µes manuais adicionais podem ser necess√°rias) </li><li>  verifique se n√£o h√° outros dados quebrados causados ‚Äã‚Äãpelo bug. </li></ol><br>  N√£o esque√ßa que n√£o vendemos brinquedos macios.  Um erro em uma √°rea como os ensaios cl√≠nicos pode prejudicar n√£o apenas os neg√≥cios, mas tamb√©m a sa√∫de humana. <br><br><h1>  Como testar? </h1><br>  Como estamos falando de teste de c√≥digo, queremos dizer teste de unidade e integra√ß√£o.  Essas coisas s√£o muito repetitivas e implicam regress√£o persistente.  A rigor, esse teste nunca √© feito manualmente (bem, exceto em alguns casos singulares provavelmente). <br><br>  Bom b√¥nus: os testes podem ser materiais de apoio para a documenta√ß√£o do c√≥digo.  Por exemplo, os requisitos podem ser assim (clic√°veis): <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/fh/af/xb/fhafxb5yph-tgvy2zhka9jfcvmk.png"></a> </div><br>  Arquivo XLS, 2 colunas com requisitos + informa√ß√µes adicionais fragmentadas em outras colunas + marca√ß√£o confusa.  Pode ser dif√≠cil restaurar os desejos iniciais, se necess√°rio.  Os testes podem ajudar a registrar nuances de implementa√ß√£o.  Obviamente, eles n√£o devem ser considerados como substitutos da documenta√ß√£o. <br><br>  Infelizmente, a complexidade do teste aumenta com o crescimento da complexidade do c√≥digo; portanto, esse efeito pode ser suavizado. <br><br>  Os testes podem ser uma camada de seguran√ßa adicional contra fus√µes espont√¢neas.  Os testes autom√°ticos de CI ajudam nesse problema por causa de seu formalismo. <br><br>  Portanto, se decidimos usar a automa√ß√£o, precisamos escolher uma ferramenta para isso. <br><br><h1>  O que usar para testar? </h1><br>  No caso de teste de c√≥digo de banco de dados, vejo duas abordagens: alimentado por SQL (quando uma ferramenta est√° funcionando diretamente no DBMS) e n√£o alimentado por SQL.  Aqui est√£o as principais diferen√ßas que encontrei: <br><div class="scrollable-table"><table><tbody><tr><th>  Alimentado por SQL <br></th><th>  N√£o alimentado por sql <br></th></tr><tr><td>  Requer instala√ß√£o de objetos de banco de dados <br></td><td>  Requer instala√ß√£o de ferramentas externas (em rela√ß√£o ao DB) <br></td></tr><tr><td>  Os testes s√£o independentes das tecnologias usadas fora do DB <br></td><td>  Os testes podem depender de tecnologias usadas fora do DB <br></td></tr><tr><td>  A estrutura √© sempre dedicada a apenas um DBMS <br></td><td>  O Framework geralmente suporta v√°rios DBMSs <br></td></tr><tr><td>  O conhecimento do DBMS √© o √∫nico requisito para escrever testes;  √© poss√≠vel usar testadores manuais ou DBA <br></td><td>  √â necess√°rio conhecimento adicional de linguagens ou tecnologias de programa√ß√£o para escrever testes;  a ajuda de um desenvolvedor √© frequentemente necess√°ria <br></td></tr><tr><td>  A execu√ß√£o no n√≠vel do DBMS permite o uso avan√ßado de falsifica√ß√µes e asser√ß√µes. <br></td><td>  A execu√ß√£o fora de um DBMS pode limitar os recursos da ferramenta <br></td></tr></tbody></table></div>  No caso do SQL Server, temos v√°rias op√ß√µes: <br><div class="scrollable-table"><table><tbody><tr><th colspan="6" align="center">  Informa√ß√£o geral </th></tr><tr><th>  Nome </th><th>  Abordagem </th><th>  Arquitetura </th><th>  Idioma / Plataforma </th><th>  Linguagem de testes </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tSQLt</a> </td><td>  Alimentado por SQL </td><td>  xUnit </td><td>  T-SQL + CLR </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TSQLUnit</a> </td><td>  Alimentado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utTSQL</a> </td><td>  Alimentado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tst</a> </td><td>  Alimentado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dbfit</a> </td><td>  N√£o alimentado por sql </td><td>  Fitnessess </td><td>  C # / java </td><td>  Marca√ß√£o Wiki </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slacker</a> </td><td>  N√£o alimentado por sql </td><td>  RSpec (orientado a BDD) </td><td>  Ruby </td><td>  Ruby </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUnit</a> , etc. </td><td>  N√£o alimentado por sql </td><td>  xUnit </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="4" align="center">  Datas </th></tr><tr><th>  Nome </th><th>  Primeira apari√ß√£o </th><th>  Confirma√ß√£o mais recente </th><th>  Vers√£o mais recente </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tSQLt</a> </td><td>  27/07/2007 </td><td>  07/07/2019 </td><td>  31/01/2016 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TSQLUnit</a> </td><td>  16-12-2006 (0,9) <br>  21/07/2007 (0,91 rc1) </td><td>  26/04/2018 (GitHub) </td><td>  04/09/2011 (SourceForge) </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utTSQL</a> </td><td>  12/03/2003 </td><td>  12/03/2003 </td><td>  12/03/2003 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tst</a> </td><td>  02-03-2009 (v1.0) </td><td>  N / a </td><td>  30-03-2012 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dbfit</a> </td><td>  12-01-2009 </td><td>  10-09-2018 </td><td>  15/08/2015 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slacker</a> </td><td>  23/06/2011 </td><td>  12-12-2018 </td><td>  12-12-2018 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUnit</a> , etc. </td><td>  N / a </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="7" align="center">  Funcionalidades </th></tr><tr><th>  Nome </th><th>  CLR n√£o √© necess√°rio </th><th>  Sa√≠da XML </th><th>  Testes em transa√ß√µes separadas </th><th>  Fakes </th><th>  Manipuladores de erro </th><th>  Asser√ß√µes </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tSQLt</a> </td><td>  - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  Excelente </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TSQLUnit</a> </td><td>  + </td><td>  - </td><td>  + </td><td>  - </td><td>  - </td><td>  Falhando </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utTSQL</a> </td><td>  + </td><td>  - </td><td>  - </td><td>  - </td><td>  - </td><td>  Abaixo da m√©dia </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tst</a> </td><td>  + </td><td>  + </td><td>  + (opcional) </td><td>  - </td><td>  + </td><td>  Excelente </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dbfit</a> </td><td>  + </td><td>  - </td><td>  + (opcional) </td><td>  - </td><td>  + </td><td>  Muito bom;  matizado </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slacker</a> </td><td>  + </td><td>  - </td><td>  + (opcional) </td><td>  - </td><td>  - </td><td>  Muito bom;  matizado </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUnit</a> , etc. </td><td>  + </td><td>  + </td><td>  N / a </td><td>  N / a </td><td>  N / a </td><td>  Excelente;  matizado </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="3" align="center">  Outros </th></tr><tr><th>  Nome </th><th>  Documenta√ß√£o </th><th>  Comunidade </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tSQLt</a> </td><td>  Excelente;  matizado </td><td>  Excelente </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TSQLUnit</a> </td><td>  Abaixo da m√©dia </td><td>  Abaixo da m√©dia </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utTSQL</a> </td><td>  Excelente </td><td>  Abaixo da m√©dia </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tst</a> </td><td>  Excelente </td><td>  Abaixo da m√©dia </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dbfit</a> </td><td>  Excelente </td><td>  M√©dia </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slacker</a> </td><td>  Excelente </td><td>  M√©dia </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUnit</a> , etc. </td><td>  Excelente </td><td>  Excelente </td></tr></tbody></table></div>  A escala "Excelente - Falha" √© subjetiva, desculpe, √© dif√≠cil encontrar uma maneira de contornar. <br><br>  "Primeira apari√ß√£o" - a data mais antiga da apar√™ncia da estrutura que eu pude encontrar - a primeira vers√£o ou confirma√ß√£o. <br><br>  Como voc√™ pode ver, as alternativas baseadas em SQL foram abandonadas h√° muito tempo e o tSQLt √© o √∫nico produto atualmente suportado.  Al√©m disso, o tSQLt vence funcionalmente.  A √∫nica coisa √© que o TST possui um conjunto de afirma√ß√µes um pouco mais rico que o tSQLt;  no entanto, duvido que isso possa superar todos os contras. <br><br>  A documenta√ß√£o do tSQLt possui algumas nuances, que ser√£o descritas mais adiante. <br><br>  No mundo que n√£o usa SQL, as coisas n√£o s√£o t√£o claras.  Alternativas est√£o se desenvolvendo, embora n√£o sejam superativas.  DbFit √© uma ferramenta bastante interessante baseada na estrutura FitNesse.  Isso implica usar a marca√ß√£o wiki para escrever testes.  O Slacker tamb√©m √© interessante: a abordagem BDD √© sugerida para teste de c√≥digo do banco de dados. <br><br>  Devo dizer sobre asser√ß√µes em solu√ß√µes que n√£o usam SQL.  √Ä primeira vista, a quantidade de afirma√ß√µes √© menor e podemos pensar que essas ferramentas s√£o piores.  Mas devemos ter em mente que eles s√£o fundamentalmente diferentes do tSQLt, portanto, esse olhar superficial √© incorreto. <br><br>  A √∫ltima linha - "NUnit, etc."  - √© mais como um lembrete.  Muitas estruturas usuais de teste de unidade podem ser aplicadas ao c√≥digo do banco de dados com a ajuda de bibliotecas adicionais.  Existem muitas N / D nesta linha porque, na verdade, essa linha inclui v√°rias ferramentas.  Essa √© a fonte de "nuances" na coluna "asser√ß√µes" - ferramentas diferentes podem fornecer conjuntos diferentes e n√£o h√° garantia de que todas as asser√ß√µes possam ser aplicadas ao DB. <br><br>  Como outra m√©trica interessante, podemos considerar as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tend√™ncias do Google</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ud/2u/km/ud2ukmcoyjvstvhcu2taegpib34.png"></div><br>  Nuances: <br><br><ol><li>  Decidi n√£o incluir o Slacker porque esse nome pode significar coisas diferentes (e consultas como "estrutura do Slacker" s√£o pouco vistas no gr√°fico). </li><li>  Por curiosidade (e porque um slot permaneceu vazio), adicionei a tend√™ncia do TST.  Mas dificilmente nos mostra a imagem real, porque √© uma abrevia√ß√£o que pode significar coisas diferentes tamb√©m. </li><li>  N√£o inclu√≠ o NUnit e seus an√°logos.  Essas ferramentas s√£o estruturas para teste de c√≥digo "usual", portanto, suas tend√™ncias n√£o s√£o descritivas para o nosso contexto. </li></ol><br>  Como voc√™ pode ver, o tSQLt √© a ferramenta mais pesquis√°vel da lista.  Outra ferramenta (menos) popular √© o DbFit.  Outras ferramentas t√™m popularidade limitada. <br><br>  De um modo geral, podemos ver que o tSQLt brilha em segundo plano. <br><br><h1>  O que √© tSQLt? </h1><br>  √â f√°cil adivinhar que o tSQLt √© uma estrutura de teste de unidade acionada por SQL.  O site oficial √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://tsqlt.org</a> . <br><br>  √â prometido que o tSQLt suporta o SQL Server a partir do 2005 SP2.  N√£o verifiquei essas revis√µes antecipadas, mas n√£o vejo problemas com 2012 em nosso servidor dev e 2017 em minha m√°quina local. <br><br>  C√≥digo aberto, licen√ßa Apache 2.0, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dispon√≠vel no GitHub</a> .  Como de costume, podemos dividir, contribuir, usar gratuitamente em projetos comerciais e, o mais importante, n√£o precisamos ter medo de spywares no CLR. <br><br><h1>  Mec√¢nica </h1><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/1v/kx/wi/1vkxwixwjyna756vsce7uhwqzw0.png"></div><br>  Casos de teste s√£o procedimentos armazenados.  Eles podem ser combinados em classes de teste (su√≠te de testes na terminologia xUnit). <br><br>  As classes de teste nada mais s√£o do que esquemas de banco de dados.  O tSQLt exige registr√°-los com o procedimento NewTestClass, que adiciona classes de teste a uma tabela especial. <br><br>  √â poss√≠vel determinar um procedimento de configura√ß√£o.  Esse procedimento ser√° executado antes de cada caso de teste separado. <br><br>  O procedimento de desmontagem ap√≥s a execu√ß√£o do caso de teste n√£o √© necess√°rio.  Cada caso de teste com seu SetUp √© executado em uma transa√ß√£o separada que √© revertida ap√≥s a coleta de resultados.  √â muito conveniente, mas tem algumas consequ√™ncias negativas - descreverei-as um pouco mais tarde. <br><br>  A estrutura permite executar casos de teste um de cada vez, todas as classes de teste de uma s√≥ vez ou at√© todas as classes de teste registradas com um √∫nico comando. <br><br><h1>  Recursos e exemplos </h1><br>  N√£o querendo repetir o guia oficial, mostrarei os recursos do tSQLt em exemplos. <br><br>  <i>Isen√ß√£o de responsabilidade:</i> <br><br><ul><li>  <i>exemplos s√£o simplificados</i> </li><li>  <i>o c√≥digo original n√£o √© completamente meu - s√£o cria√ß√µes bastante coletivas</i> </li><li>  <i>o exemplo 2 √© ficcionalizado por mim para demonstrar os recursos mais completamente.</i> </li></ul><br><h3>  Exemplo # 1: CsvSql </h3><br>  O seguinte foi implementado mediante solicita√ß√£o de um dos clientes do cliente.  Existem consultas SQL armazenadas nos campos Nvarchar (MAX).  A interface do usu√°rio m√≠nima √© criada para visualiz√°-los.  Os conjuntos de resultados gerados por essas consultas s√£o usados ‚Äã‚Äãno back-end para composi√ß√£o posterior como arquivos CSV.  Os arquivos CSV podem ser solicitados por uma chamada de API. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/5q/mu/oy/5qmuoyyjjvlphk79jt-xtawwjn8.png"></div><br>  Os conjuntos de resultados s√£o grandes e cont√™m um grande n√∫mero de colunas.  Um exemplo hipot√©tico desse conjunto de resultados: <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/dg/50/bb/dg50bbx25qaw6ycwpfqcsfj5kyk.png"></div><br>  Este conjunto de resultados representa dados de ensaios cl√≠nicos.  Vamos dar uma olhada no c√°lculo [ClinicsNum].  Temos 2 tabelas: [Trial] e [Clinic]. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/qo/mu/n-/qomun-gdbdl05teniypbtzi8jio.png"></div><br>  Existe um FK: [Clinic]. [TrialID] -&gt; [Trial]. [TrialID].  Obviamente, √© suficiente usar COUNT (*) para derivar v√°rias cl√≠nicas: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*), ...  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Trial  <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Clinic    <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Trial.ID = Clinic.TrialID  <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Trial.Name = @trialName  <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ...</code> </pre> <br>  Como podemos testar essa consulta?  Primeiro, vamos usar o stub FakeTable, que facilitar√° muito nosso trabalho adicional. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.FakeTable 'dbo.Trial'; EXEC tSQLt.FakeTable 'dbo.Clinic';</code> </pre> <br>  O FakeTable cria uma coisa simples - renomeia tabelas antigas e cria novas com o mesmo nome.  Os mesmos nomes, as mesmas colunas, mas sem restri√ß√µes e gatilhos. <br><br>  Precisamos disso porque: <br><br><ol><li>  O banco de dados de teste pode conter alguns dados que podem impedir uma execu√ß√£o adequada do teste.  O FakeTable nos permite n√£o depender deles. </li><li>  Normalmente, precisamos preencher apenas algumas colunas para fins de teste.  A tabela pode conter muitos deles, geralmente contendo restri√ß√µes e gatilhos.  Facilitamos a inser√ß√£o de dados posteriormente - inseriremos apenas as informa√ß√µes necess√°rias para o teste, mantendo o teste o mais minimalista poss√≠vel. </li><li>  N√£o haver√° execu√ß√µes indesejadas, portanto, n√£o precisamos nos preocupar com p√≥s-efeitos. </li></ol><br>  Em seguida, inserimos os dados de teste necess√°rios: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Trial ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-string"><span class="hljs-string">'Valerian'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Clinic ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [TrialID], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic1'</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic2'</span></span>);</code> </pre> <br>  N√≥s derivamos a consulta do banco de dados, criamos a tabela [Actual] e a preenchemos com o resultado <br>  definido a partir da consulta. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sqlStatement <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> actual ([TrialID], ...); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> actual EXEC sp_executesql @sqlStatement, ...</code> </pre> <br>  Agora, preenchemos [Esperado] - nossos valores esperados: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> expected (   ClinicsNum <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> expected <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Quero chamar sua aten√ß√£o para o fato de termos apenas uma coluna na tabela [Esperado], embora tenhamos o conjunto completo na coluna [Real]. <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/qd/gx/ga/qdgxgaqr4cjp2eayoz0eycjs8cg.png"></div><br>  Isso se deve a um recurso √∫til do procedimento AssertEqualsTable que usaremos para verifica√ß√£o de valores. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEqualsTable   'expected',   'actual',   'incorrect number of clinics';</code> </pre> <br>  Ele compara apenas as colunas que s√£o apresentadas nas duas tabelas.  √â muito conveniente no nosso caso, porque a consulta em teste retorna muitas colunas, cada uma conectada com uma l√≥gica bastante complicada.  N√£o queremos aumentar os casos de teste, portanto esse recurso realmente ajuda.  Obviamente, esse recurso √© uma faca de dois gumes.  Se [Real] for preenchido via SELECT TOP 0 e, a certa altura, aparecer uma coluna inesperada, esse caso de teste n√£o ser√° detectado.  Voc√™ deve escrever verifica√ß√µes adicionais para cobrir isso. <br><br><h3>  Procedimentos duplos AssertEqualsTable </h3><br>  Vale ressaltar que o tSQLt cont√©m 2 procedimentos como AssertEqualsTable.  Eles s√£o AssertEqualsTableSchema e AssertResultSetsHaveSameMetaData.  O primeiro faz o mesmo que AssertEqualsTable, mas nos metadados das tabelas.  O segundo faz o mesmo, mas nos metadados dos conjuntos de resultados. <br><br><h3>  Exemplo # 2: Restri√ß√µes </h3><br>  O exemplo anterior nos mostrou como podemos remover restri√ß√µes.  Mas e se precisarmos verificar?  Tecnicamente, as restri√ß√µes tamb√©m fazem parte da l√≥gica e podem ser consideradas como candidatas a cobertura por testes. <br><br>  Considere a situa√ß√£o do exemplo anterior.  2 tabelas - [Trial] e [Clinic];  [TrialID] FK: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-8/zu/v3/-8zuv3clqoo3ygm9wko5hpibc90.png"></div><br>  Vamos tentar escrever um caso de teste para verific√°-lo.  Primeiro, como no caso anterior, falsificamos as tabelas: <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable '[dbo].[Trial]' EXEC tSQLt.FakeTable '[dbo].[Clinic]'</code> </pre> <br>  O objetivo √© o mesmo - livrar-se de limites desnecess√°rios.  Queremos verifica√ß√µes isoladas sem esfor√ßo indevido. <br><br>  Em seguida, retornamos a restri√ß√£o que queremos testar usando ApplyConstraint: <br><br><pre> <code class="sql hljs">EXEC tSQLt.ApplyConstraint   '[dbo].[Clinic]',   'Trial_FK';</code> </pre> <br>  Agora temos uma configura√ß√£o para a verifica√ß√£o.  A verifica√ß√£o em si √© que tentar inserir dados causar√° uma exce√ß√£o.  Para a aprova√ß√£o do caso de teste, precisamos capturar essa exce√ß√£o.  Manipulador de exce√ß√£o ExpectException pode ajudar. <br><br><pre> <code class="sql hljs">EXEC tSQLt.ExpectException   @ExpectedMessage = 'The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted...<span class="hljs-string"><span class="hljs-string">',   @ExpectedSeverity = 16,   @ExpectedState = 0;</span></span></code> </pre> <br>  Podemos tentar inserir n√£o inser√≠veis ap√≥s a configura√ß√£o do manipulador. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [dbo].[Clinic] ([TrialID])   <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  A exce√ß√£o foi capturada.  Teste aprovado. <br><br><h3>  Procedimentos g√™meos ApplyConstraint </h3><br>  A maneira de testar os gatilhos propostos pelos autores do tSQLt √© semelhante a testar restri√ß√µes.  Podemos usar o procedimento ApplyTrigger para retornar o gatilho √† tabela.  Depois disso, tudo corre como no exemplo acima - inicie o gatilho, verifique o resultado. <br><br><h3>  ExpectNoException - o ant√¥nimo de ExpectException </h3><br>  Existe um procedimento ExpectNoException para os casos em que a exce√ß√£o n√£o deve ocorrer.  Funciona da mesma maneira que ExpectException, exceto que o teste falha em caso de exce√ß√£o. <br><br><h3>  Exemplo # 3: Sem√°foro </h3><br>  Existem alguns procedimentos armazenados e servi√ßos do Windows.  O in√≠cio de sua execu√ß√£o pode ser causado por diferentes eventos externos.  No entanto, a ordem de sua execu√ß√£o √© fixa.  Portanto, √© necess√°rio implementar o controle de acesso no lado do banco de dados - ou seja, um sem√°foro.  No nosso caso, o sem√°foro √© um grupo de procedimentos armazenados trabalhando juntos. <br><br>  Vejamos um procedimento dentro do sem√°foro.  Temos 2 tabelas - [Process] e [ProcStatus]: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-m/hz/8-/-mhz8-fm_n1w7njpryiv8z3epiw.png"></div><br>  A tabela [Process] cont√©m uma lista de processos permitidos para execu√ß√£o.  [ProcStatus], obviamente, cont√©m a lista de status do processo da tabela anterior. <br><br>  Ent√£o, o que nosso procedimento faz?  Primeiro, ele faz as seguintes verifica√ß√µes: <br><br><ol><li>  Passamos um nome de processo como um dos par√¢metros de entrada do procedimento.  Este nome √© pesquisado no campo [Nome] da tabela [Processo]. </li><li>  Se o nome do processo foi encontrado, ele verifica o sinalizador [IsRunable] da tabela [Process]. </li><li>  Se o sinalizador estiver LIGADO, consideramos que o processo pode ser executado.  A √∫ltima verifica√ß√£o ocorre na tabela [ProcStatus].  Precisamos garantir que o processo n√£o esteja sendo executado no momento, o que significa a aus√™ncia de registros sobre o processo com o status "InProg" na tabela [ProcStatus]. </li></ol><br>  Se tudo estiver OK e todas as verifica√ß√µes forem aprovadas, adicionamos um novo registro sobre nosso processo na tabela [ProcStatus] com o status "InProg".  O ID desse novo registro √© retornado com o par√¢metro de sa√≠da ProcStatusId. <br><br>  Se algo der errado, esperamos o seguinte: <br><br><ol><li>  Um email para um administrador do sistema √© enviado. </li><li>  ProcStatusId = -1 √© retornado. </li><li>  Nenhum novo registro [ProcStatus] adicionado. </li></ol><br>  Vamos criar um caso de teste para verificar o caso de aus√™ncia de processo na tabela [Process]. <br><br>  N√≥s usamos o FakeTable novamente.  N√£o √© t√£o cr√≠tico aqui, mas pode ser conveniente porque: <br><br><ol><li>  √â garantido que n√£o haver√° dados que possam interromper a execu√ß√£o do caso de teste. </li><li>  A verifica√ß√£o adicional da aus√™ncia de novos registros [ProcStatus] ser√° simplificada. </li></ol><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Process'; EXEC tSQLt.FakeTable 'dbo.ProcStatus';</code> </pre> <br>  Existe um procedimento [SendEmail] cujo nome fala por si.  Precisamos atender sua chamada.  O tSQLt sugere o uso do SpyProcedure para isso. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.SpyProcedure 'dbo.SendEmail'</code> </pre> <br>  O SpyProcedure faz o seguinte: <br><br><ol><li>  Cria uma tabela com um nome parecido com [dbo]. [ProcedureName_SpyProcedureLog] </li><li>  Assim como o FakeTable, substitui o procedimento original por um gerado automaticamente, com o mesmo nome, mas com l√≥gica de log interno.  Voc√™ tamb√©m pode adicionar sua pr√≥pria l√≥gica ao procedimento gerado, se necess√°rio. </li></ol><br>  N√£o √© dif√≠cil adivinhar que os logs s√£o gravados na tabela [dbo]. [SendEmail_SpyProcedureLog].  Esta tabela cont√©m uma coluna [_ID_] que √© para os n√∫meros de sequ√™ncia das chamadas.  As colunas subsequentes s√£o nomeadas ap√≥s os par√¢metros passados ‚Äã‚Äãpara o procedimento e usados ‚Äã‚Äãpara colet√°-los, para que os valores dos par√¢metros tamb√©m possam ser verificados. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/ko/gh/4h/kogh4hgcdsxagldk2bmdcfrptzi.png"></div><br>  A √∫ltima coisa que precisamos fazer antes da chamada do sem√°foro √© criar uma vari√°vel para armazenar o valor [ProcStatusId] (para ser mais exato, -1, pois o registro n√£o ser√° adicionado). <br><br><pre> <code class="plaintext hljs">DECLARE @ProcStatusId BIGINT;</code> </pre> <br>  Chamamos o sem√°foro: <br><br><pre> <code class="plaintext hljs">EXEC dbo.[Semaphore_JobStarter]   'SomeProcess',   @ProcStatusId OUTPUT; -- here we get -1</code> </pre> <br>  Agora, temos todos os dados necess√°rios para as verifica√ß√µes.  Vamos come√ßar verificando <br>  que a mensagem foi enviada. <br><br><pre> <code class="plaintext hljs">IF NOT EXISTS (   SELECT *   FROM dbo.SendEmail_SpyProcedureLog) EXEC tSQLt.Fail 'SendEmail has not been run.';</code> </pre> <br>  Nesse caso, n√£o verificamos os par√¢metros passados ‚Äã‚Äãe testamos apenas o fato de enviar.  Quero chamar sua aten√ß√£o para o procedimento Fail.  Ele nos permite "oficialmente" falhar em um caso de teste.  Se voc√™ precisar criar uma constru√ß√£o sofisticada, o Fail pode ajudar. <br><br>  Agora, verificamos a aus√™ncia de registros na tabela [ProcStatus] com o procedimento AssertEmptyTable. <br><br><pre> <code class="plaintext hljs">EXEC tSQLt.AssertEmptyTable 'dbo.ProcStatus';</code> </pre> <br>  Foi aqui que o FakeTable que usamos no come√ßo nos ajudou.  Com isso, podemos esperar uma tabela vazia e testar usando uma √∫nica linha de c√≥digo.  A maneira correta de verificar isso sem falsifica√ß√£o de tabela seria comparar o n√∫mero de linhas antes e depois da execu√ß√£o do procedimento, e isso exigiria mais a√ß√µes. <br><br>  Podemos facilmente verificar a igualdade ProcStatusId = -1 com AssertEquals. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEquals   -1,       @ProcStatusId,       'Wrong ProcStatusId.';</code> </pre> <br>  AssertEquals √© minimalista.  Apenas compara 2 valores, nada de extraordin√°rio. <br><br><h3>  Procedimentos g√™meos AssertEquals </h3><br>  Temos os seguintes procedimentos para compara√ß√£o de valores: <br><br><ul><li>  AssertEquals </li><li>  AssertNotEquals </li><li>  AssertEqualsString </li><li>  Assertike </li></ul><br>  Os nomes s√£o auto-explicativos, eu acho.  O √∫nico procedimento que quero enfatizar √© AssertEqualsString.  √â o procedimento dedicado √† verifica√ß√£o de valores de string.  Por que precisamos de mais um procedimento, considerando determinados AssertEquals universais?  O problema √© que AssertEquals / AssertNotEquals / AssertLike funcionam com o tipo SQL_VARIANT.  O NVARCHAR (MAX) n√£o est√° inclu√≠do no SQL_VARIANT, portanto, os desenvolvedores do tSQLt precisaram fazer um procedimento adicional. <br><br><h3>  Fun√ß√£o falsa </h3><br>  Com um simples toque, podemos chamar o FakeFunction de um procedimento semelhante ao SpyProcedure.  Esse falso permite substituir qualquer fun√ß√£o por uma mais simples.  Como as fun√ß√µes do SQL Server funcionam como um tubo de pasta de dente (o resultado √© retornado pelo √∫nico "orif√≠cio"), √© tecnicamente imposs√≠vel implementar uma funcionalidade de log.  A substitui√ß√£o da l√≥gica interna √© a √∫nica maneira dispon√≠vel. <br><br><h1>  Armadilhas </h1><br>  Quero falar sobre algumas armadilhas que voc√™ pode enfrentar durante o uso do tSQLt.  Nesse caso, "armadilhas" significam alguns problemas causados ‚Äã‚Äãpor restri√ß√µes do SQL Server e / ou imposs√≠veis de serem resolvidos pelos desenvolvedores da estrutura. <br><br><h3>  Revers√£o de transa√ß√µes e condena√ß√£o </h3><br>  O primeiro e principal problema enfrentado por nossa equipe √© a revers√£o e condena√ß√£o das transa√ß√µes.  O SQL Server n√£o pode reverter a transa√ß√£o aninhada separadamente.  Ele sempre reverte todas as transa√ß√µes at√© o limite.  Considerando que o tSQLt agrupa cada teste em uma transa√ß√£o separada, pode se tornar um problema, pois a revers√£o dentro de um procedimento armazenado pode interromper uma execu√ß√£o de teste com um erro de execu√ß√£o n√£o descritivo. <br><br>  Como solu√ß√£o alternativa, usamos pontos de salvamento.  A ideia √© simples.  No in√≠cio, verificamos se estamos dentro de uma transa√ß√£o ou n√£o.  Se sim, supomos que √© uma transa√ß√£o tSQLt e colocamos um ponto de salvamento, portanto, reverteremos para ela, se necess√°rio.  Se n√£o, iniciamos uma nova transa√ß√£o.  De fato, n√£o permitimos aninhamento. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/bu/ih/vl/buihvlf1ffnwuzbotecbqtev09o.png"></div><br>  O problema √© complicado por causa da transa√ß√£o - pode acontecer se uma exce√ß√£o for lan√ßada.  Uma transa√ß√£o condenada n√£o pode ser confirmada nem revertida para um ponto de salvamento, portanto, devemos revert√™-la para a transa√ß√£o mais externa novamente. <br><br>  Considerando os pontos descritos acima, devemos usar a seguinte estrutura: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY BEGIN CATCH   DECLARE @isCommitable BIT =       CASE WHEN XACT_STATE() = 1           THEN 'true'           ELSE 'false'   END;   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       ROLLBACK TRANSACTION SavepointName;   ELSE       ROLLBACK;   THROW; END CATCH;</span></span></code> </pre> <br>  Vamos revisar o c√≥digo pe√ßa por pe√ßa.  Primeiro, precisamos determinar se estamos dentro de uma transa√ß√£o ou n√£o. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Ap√≥s derivar o sinalizador @isNestedTransaction, podemos iniciar o bloco TRY e definir um ponto de salvamento ou iniciar uma transa√ß√£o, dependendo da situa√ß√£o. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful</span></span></code> </pre> <br>  Depois de fazer algo √∫til, confirmamos os resultados se for um procedimento "real". <br><br><pre> <code class="sql hljs">       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY</span></span></code> </pre> <br>  Obviamente, se for um caso de teste, n√£o precisamos confirmar nada.  O tSQLt reverter√° as altera√ß√µes automaticamente no final. <br><br>  Se algo der errado e entrarmos no bloco CATCH, precisamos determinar se a transa√ß√£o √© compromet√≠vel ou n√£o. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH   <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isCommitable <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =       <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> XACT_STATE() = <span class="hljs-number"><span class="hljs-number">1</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Podemos reverter para o ponto de salvamento apenas se: <br><br><ol><li>  A transa√ß√£o √© confirmada </li><li>  √â uma execu√ß√£o de teste, portanto, existe um ponto de salvamento. </li></ol><br>  Em todos os outros casos, devemos reverter toda a transa√ß√£o. <br><br><pre> <code class="sql hljs">   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;   ELSE       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;   THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH;</code> </pre> <br>  Sim, infelizmente, se atingirmos o estado de transa√ß√£o inconfund√≠vel durante uma execu√ß√£o de teste, ainda ocorreremos o erro de execu√ß√£o. <br><br><h3>  Faketable e a quest√£o da chave estrangeira </h3><br>  Vamos revisar as tabelas familiares [Trial] e [Clinic] <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/fy/k7/nm/fyk7nmhfha_fnezignyxclpflay.png"></div><br>  Lembramos sobre o [TrialID] FK.  Que problema isso pode causar?  Nos exemplos acima, aplicamos o FakeTable nas duas tabelas.  Se o usarmos em apenas um deles, alcan√ßaremos a seguinte configura√ß√£o: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/og/to/3-/ogto3-drjheieblpi1_gsyup4hs.png"></div><br>  Portanto, uma tentativa de inserir um registro em [Clinic] pode falhar, mesmo se tivermos preparado dados na vers√£o falsa de [Trial]. <br><br><pre> <code class="sql hljs">[dbo].[Test_FK_Problem] failed: (Error) The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">"Trial_Fk"</span></span>. The conflict occurred <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-string"><span class="hljs-string">"HabrDemo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"dbo.tSQLt_tempobject_ba8f36353f7a44f6a9176a7d1db02493"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'TrialID'</span></span>.[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]{Test_FK_Problem,<span class="hljs-number"><span class="hljs-number">14</span></span>}</code> </pre> <br>  Conclus√£o: fingir tudo ou nada.  Em caso de nenhum, obviamente, voc√™ deve preparar um banco de dados com todos os dados de teste necess√°rios. <br><br><h3>  SpyProcedure nos procedimentos do sistema </h3><br>  Infelizmente, n√£o podemos espionar os procedimentos do sistema: <br><br><pre> <code class="sql hljs">[HabrDemo].[test_test] failed: (Error) Cannot <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SpyProcedure <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> sys.sp_help because the <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>] {tSQLt.Private_ValidateProcedureCanBeUsedWithSpyProcedure,<span class="hljs-number"><span class="hljs-number">7</span></span>}</code> </pre> <br>  No exemplo do sem√°foro, rastreamos as chamadas do procedimento [SendEmail], criado por nossos desenvolvedores.  Nesse caso, n√£o foi exigido apenas pelo teste.  Foi necess√°rio criar um procedimento separado, pois √© necess√°rio preparar alguns dados antes do envio.  Mas voc√™ deve estar mentalmente preparado para escrever um procedimento entre camadas para atingir os objetivos do teste. <br><br><h1>  Pr√≥s </h1><br><h3>  Instala√ß√£o r√°pida </h3><br>  A instala√ß√£o do tSQLt consiste em 2 etapas e leva cerca de 2 minutos.  Voc√™ precisa ativar o CLR se n√£o estiver ativo no momento e executar um √∫nico script SQL.  Isso √© tudo: agora voc√™ pode adicionar sua primeira classe de teste e escrever casos de teste. <br><br><h3>  Aprendizado r√°pido </h3><br>  O tSQLt √© f√°cil de aprender.  Demorou um pouco mais de um dia √∫til para mim.  Perguntei aos colegas e parece que tamb√©m leva cerca de 1 dia √∫til para os outros.  Duvido que possa demorar muito mais tempo. <br><br><h3>  Integra√ß√£o r√°pida de IC </h3><br>  Demorou cerca de 2 horas para configurar a integra√ß√£o do IC em nosso projeto.  O tempo pode variar, √© claro, mas n√£o √© um problema em geral, e pode ser feito rapidamente. <br><br><h3>  Um amplo conjunto de instrumentos </h3><br>  √â subjetivo, mas, na minha opini√£o, a funcionalidade tSQLt √© rica e a maior parte das necessidades pode ser coberta por ela.  Se n√£o for suficiente, voc√™ sempre pode usar o procedimento Fail para casos raros e sofisticados. <br><br><h3>  Documenta√ß√£o conveniente </h3><br>  Guias oficiais s√£o convenientes e consistentes.  Voc√™ pode entender facilmente o uso do tSQLt em um curto per√≠odo, mesmo que seja sua primeira ferramenta de teste de unidade. <br><br><h3>  Sa√≠da clara </h3><br>  A sa√≠da do teste pode ser realizada em um formato de texto ilustrativo: <br><br><pre> <code class="plaintext hljs">[tSQLtDemo].[test_error_messages] failed: (Failure) Expected an error to be raised. [tSQLtDemo].[test_tables_comparison] failed: (Failure) useful and descriptive error message Unexpected/missing resultset rows! |_m_|Column1|Column2| +---+-------+-------+ |&lt; |2 |Value2 | |= |1 |Value1 | |= |3 |Value3 | |&gt; |2 |Value3 | +----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result | +--+------------------------------------+-------+-------+ |1 |[tSQLtDemo].[test_constraint] | 83|Success| |2 |[tSQLtDemo].[test_trial_view] | 83|Success| |3 |[tSQLtDemo].[test_error_messages] | 127|Failure| |4 |[tSQLtDemo].[test_tables_comparison]| 147|Failure| ----------------------------------------------------------------------------- Msg 50000, Level 16, State 10, Line 1 Test Case Summary: 4 test case(s) executed, 2 succeeded, 2 failed, 0 errored. -----------------------------------------------------------------------------</code> </pre><br>  Tamb√©m pode ser derivado do banco de dados (clic√°vel) ... <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/-f/83/la/-f83lajcz1mfcnkhtttz45b0x3g.png"></a> </div><br>  ... ou at√© como XML. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">errors</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">failures</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timestamp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2019-06-22T16:46:06"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.433"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BLAHBLAHBLAH\SQL2017"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_constraint"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.097"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_error_messages"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.153"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">failure</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Expected an error to be raised."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt.Fail"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_trial_view"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.156"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-out</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-err</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  O √∫ltimo formato permite a integra√ß√£o do IC sem problemas.  Especificamente, usamos o tSQLt junto com o Atlassian Bamboo. <br><br><h3>  Suporte do redgate </h3><br>  Como um dos profissionais, posso citar o suporte de um dos maiores fornecedores de ferramentas de DBA - RedGate.  O plug-in do SQL Server Management Studio chamado SQL Test funciona com o tSQLt desde o in√≠cio.  Al√©m disso, o RedGate ajuda o principal desenvolvedor do tSQLt com o ambiente de desenvolvimento, de acordo com suas palavras nos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grupos do Google</a> . <br><br><h1>  Contras </h1><br><h3>  Nenhuma tabela tempor√°ria falsificada </h3><br>  O tSQLt n√£o permite falsificar tabelas tempor√°rias.  Pensamentos, em caso de necessidade, voc√™ pode usar um complemento n√£o oficial.  Infelizmente, este complemento funciona apenas com o SQL Server 2016 ou superior. <br><br><h3>  Trabalhar com bancos de dados externos </h3><br>  O tSQLt foi projetado para funcionar com o c√≥digo no mesmo banco de dados no qual a estrutura est√° instalada.  Portanto, pode ser imposs√≠vel us√°-lo com um banco de dados externo.  Pelo menos, falsifica√ß√µes n√£o funcionam. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>]   EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'[AdventureWorks2017].[Person].[Password]'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/au/ny/gaaunygdr124sssxhonbb2s0b_0.png"></div><br>  Parece que as afirma√ß√µes funcionam, mas sua trabalhabilidade n√£o √© garantida, √© claro. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db_assertions] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#Actual   FROM [AdventureWorks2017].[Person].[Password]   SELECT *   INTO #Expected   FROM (          SELECT 'bE3XiWw=' AS [PasswordSalt]   ) expectedresult;   EXEC tSQLt.AssertEqualsTable '#Expected', '#Actual', 'The salt is not salty'; END</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cg/dk/ow/cgdkowych69imevqmbirkkgsniq.png"></div><br><h3>  Erros de documenta√ß√£o </h3><br>  Apesar de eu ter mencionado acima que os guias s√£o convenientes e consistentes, a documenta√ß√£o tem alguns problemas.  Ele cont√©m pe√ßas desatualizadas. <br><br>  Exemplo 1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúGuia de in√≠cio r√°pido‚Äù</a> sugere o download da estrutura do SourceForge. <br>  Eles se mudaram do SourceForge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">at√© 2015</a> . <br><br>  Exemplo 2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O guia ApplyConstraint</a> utiliza design volumoso com o procedimento Fail dentro de um exemplo de captura de exce√ß√£o.  Isso pode ser substitu√≠do por um c√≥digo simples e claro usando ExpectException. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> ConstraintTests.[<span class="hljs-keyword"><span class="hljs-keyword">test</span></span> ReferencingTable_ReferencedTable_FK prevents <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> orphaned <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'dbo.ReferencedTable'</span></span>; EXEC tSQLt.FakeTable 'dbo.ReferencingTable'; EXEC tSQLt.ApplyConstraint 'dbo.ReferencingTable','ReferencingTable_ReferencedTable_FK'; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* [NB] Why don't we use ExceptException below? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.ReferencingTable ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, ReferencedTableId ) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span> ) ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = ERROR_MESSAGE(); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%ReferencingTable_ReferencedTable_FK%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'Expected error message containing ''ReferencingTable_ReferencedTable_FK'' but got: '''</span></span>,@ErrorMessage,<span class="hljs-string"><span class="hljs-string">'''!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  E isso √© esperado, por causa de ... <br><br><h3>  Abandono parcial </h3><br>  Houve uma pausa prolongada no desenvolvimento do in√≠cio de 2016 at√© junho de 2019. Sim, infelizmente, essa ferramenta foi parcialmente abandonada.  O desenvolvimento come√ßou lentamente em 2019, de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">acordo com o GitHub</a> .  Embora os Grupos oficiais do Google <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tenham um t√≥pico em</a> que Sebastian, o principal desenvolvedor do tSQLt, foi questionado sobre o futuro do projeto.  A √∫ltima pergunta foi feita em 2 de mar√ßo de 2019, sem resposta. <br><br><h3>  Problema no SQL Server 2017 </h3><br>  A instala√ß√£o do tSQLt pode exigir algumas a√ß√µes adicionais se voc√™ estiver usando o SQL Server 2017. A Microsoft implementou a primeira altera√ß√£o de seguran√ßa desde 2012 nesta vers√£o.  O sinalizador no n√≠vel do servidor "CLR strict security" foi adicionado.  Este sinalizador n√£o permite a cria√ß√£o de assemblies n√£o assinados '(mesmo o SAFE).  A descri√ß√£o detalhada merece um artigo separado (e, felizmente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">j√° temos</a> um artigo bom; consulte tamb√©m os artigos a seguir na sequ√™ncia. Apenas esteja mentalmente preparado para isso. <br><br>  Obviamente, eu poderia atribuir esse problema √†s "armadilhas", mas esse problema pode ser resolvido pelos desenvolvedores do tSQLt.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O problema do GitHub j√° foi levantado</a> .  Ainda assim, n√£o foi resolvido desde outubro de 2017. <br><br><h1>  Alternativas (¬±) para outros SGBD </h1><br>  O tSQLt n√£o √© √∫nico.  Embora voc√™ n√£o possa us√°-lo em outros DBMS por causa das nuances de CLR e T-SQL, ainda assim poder√° encontrar algo semelhante.  Vale ressaltar que essas alternativas n√£o s√£o muito pr√≥ximas ao tSQLt, por isso quero dizer abordagem baseada em SQL. <br><br>  Por exemplo, usu√°rios do PostgreSQL podem experimentar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pgTAP</a> .  √â uma ferramenta bem desenvolvida e em desenvolvimento ativo que usa PL / pgSQL nativo para testes e formato de sa√≠da TAP.  A ferramenta similar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MyTap</a> pode ajud√°-lo com testes no MySQL.  Essa estrutura √© um pouco menos funcional que o pgTAP, mas ainda pode ser √∫til.  E tamb√©m est√° em desenvolvimento ativo.  Se voc√™ √© um usu√°rio feliz do Oracle, tem a oportunidade de usar a ferramenta muito poderosa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utPLSQL</a> .  Ele est√° se desenvolvendo muito ativamente e fornece um grande n√∫mero de recursos. <br><br><h1>  Conclus√£o </h1><br>  Eu queria transmitir 2 id√©ias: <br><br>  O primeiro: a utilidade do teste de c√≥digo do banco de dados.  N√£o √© importante se voc√™ estiver usando o SQL Server, Oracle, MySQL ou outra coisa.  Se seu banco de dados contiver l√≥gica n√£o testada, voc√™ estar√° assumindo riscos.  Como todos os outros bugs em todos os outros c√≥digos, os bugs do c√≥digo do DB podem danificar o produto e a empresa que o fornece. <br><br>  O segundo: a escolha da ferramenta.  Para quem trabalha com o SQL Server, o tSQLt, mesmo que n√£o seja um vencedor de 100%, certamente merece aten√ß√£o.  Apesar do desenvolvimento lento e de alguns problemas, ainda √© uma estrutura pr√°tica que pode facilitar muito o seu trabalho. <br><br><div class="spoiler">  <b class="spoiler_title">Fontes que me ajudaram (lista n√£o exaustiva)</b> <div class="spoiler_text">  DbFit - Teste automatizado de banco de dados de c√≥digo aberto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.methodsandtools.com/tools/dbfit.php</a> <br><br>  Documenta√ß√£o do DbFit: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://dbfit.github.io/dbfit/docs/</a> <br><br>  Wiki do Slacker: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/vassilvk/slacker/wiki</a> <br><br>  Documenta√ß√£o TST: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://archive.codeplex.com/projects/TST/4e04e281-9f35-4891-809a-15f09d304f4e</a> <br><br>  Asser√ß√µes do NUnit: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/nunit/docs/wiki/Assertions</a> <br><br>  c√≥digo utTSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://sourceforge.net/p/uttsql/code/HEAD/tree/</a> <br><br>  Junit Class Assert: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://junit.org/junit4/javadoc/latest/org/junit/Assert.html</a> <br><br>  pgTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://pgtap.org/</a> <br><br>  utPLSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://utplsql.org/</a> <br><br>  MyTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/hepabolu/mytap</a> <br><br>  Grupos tSQLt do Google: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://groups.google.com/forum/#!forum/tsqlt</a> <br><br>  Site oficial do tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://tsqlt.org/</a> <br><br>  tSQLt GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/tSQLt-org/tSQLt</a> <br><br>  Tend√™ncias do Google: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://bit.ly/2x7BQL6</a> <br><br>  Como ROLLBACK uma transa√ß√£o ao testar usando tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://stackoverflow.com/questions/8973138/how-to-rollback-a-transaction-when-testing-using-tsqlt</a> <br><br>  Quais s√£o os pr√≥s e os contras do teste manual de unidade em rela√ß√£o ao teste automatizado de unidade?: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Https://stackoverflow.com/questions/2948337/what-are-the-pros-and-cons-of-manual-unit-unit-testing-against -a-unidade-automatizada-tes # 2948354</a> <br><br>  Os bons, os maus e os ugle¬Øe¬Ø: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://sqlquantumleap.com/2017/08/07/sqlclr-vs-sql-server-2017-part-1-clr-strict-security/</a> <br><br>  Rex Black, Erik Van Veenendal, Dorothy Graham, Funda√ß√µes de teste de software, Terceira edi√ß√£o, 2012 Cengage Learning EMEA <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt465567/">https://habr.com/ru/post/pt465567/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt465551/index.html">Resumo dos eventos de TI de setembro (parte um)</a></li>
<li><a href="../pt465553/index.html">Linguagem de programa√ß√£o √ú. Introdu√ß√£o, motiva√ß√£o para criar, objetivos</a></li>
<li><a href="../pt465555/index.html">12 Soft Skills que tornam os gerentes de projeto de TI impar√°veis</a></li>
<li><a href="../pt465557/index.html">Prazos de Desenvolvimento de Produto</a></li>
<li><a href="../pt465561/index.html">O que aprendi com um programador l√≠der</a></li>
<li><a href="../pt465569/index.html">Mapa de desenvolvimento para desenvolvedores m√≥veis</a></li>
<li><a href="../pt465571/index.html">Como vender cigarros masculinos para mulheres e fazer selvagens se protegerem: redatores que poderiam</a></li>
<li><a href="../pt465573/index.html">Todo o poder do IntelliJ IDEA no exemplo de um idioma (nas imagens)</a></li>
<li><a href="../pt465575/index.html">Opera√ß√µes de compara√ß√£o em C ++ 20</a></li>
<li><a href="../pt465577/index.html">Novos tipos de micromarca√ß√£o para trechos interativos avan√ßados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>