<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßñüèΩ üë©üèø‚Äçü§ù‚Äçüë©üèæ üöÖ R√©daction sur Flare-On 2019 ü§±üèº üë®üèº‚Äçüîß üì°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="-0x01 - Intro 


 Cet article est consacr√© √† l'analyse de toutes les t√¢ches de Flare-On 2019 - le concours annuel de r√©tro-ing√©nierie de FireEye. Dans...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©daction sur Flare-On 2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/469393/"><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/bz/4g/sb/bz4gsbxbvka4sjtartbqmxccw6q.png"></div><br><a name="intro"></a><br><h2 id="-0x01---intro">  -0x01 - Intro </h2><br><p>  Cet article est consacr√© √† l'analyse de toutes les t√¢ches de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Flare-On 2019</a> - le concours annuel de r√©tro-ing√©nierie de FireEye.  Dans ces comp√©titions, je participe pour la deuxi√®me fois.  L'ann√©e pr√©c√©dente, j'ai r√©ussi √† atteindre la 11e place en termes de temps de r√©alisation, apr√®s avoir r√©solu tous les probl√®mes en 13 jours environ.  Cette ann√©e, l'ensemble des t√¢ches a √©t√© plus facile, et je me suis retrouv√© en 54 heures, prenant en m√™me temps 3 place en terme de livraison. </p><br><p> Dans cet article, j'ai essay√© de d√©crire ces moments qui ont suscit√© mon plus grand int√©r√™t, par cons√©quent, l'analyse ne d√©crira pas la routine de travail dans l'IDA, la compr√©hension des algorithmes de chaque fonction et d'autres points peu int√©ressants.  J'esp√®re qu'apr√®s avoir lu ceci, vous trouverez quelque chose de nouveau et d'utile pour vous.  Vous pouvez trouver l'analyse des probl√®mes des auteurs, ainsi que des statistiques et des prix pour les gagnants <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Si vous √™tes int√©ress√©, alors bienvenue au chat! </p><a name="habracut"></a><br><h2 id="0x00---soderzhanie">  0x00 - Contenu </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x01 - Memecat Battlestation [√âdition de d√©monstration Shareware]</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x02 - Overlong</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x03 - Flarebear</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x04 - Dnschess</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x05 - d√©mo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x06 - bmphide</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x07 - wopr</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x08 - serpent</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x09 - recharg√©</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x0A - Mugatu</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x0B - vv_max</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x0C - aide</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">0x0D - R√©sum√©</a> </li></ol><br><a name="task01"></a><br><h2 id="0x01---memecat-battlestation-shareware-demo-edition">  0x01 - Memecat Battlestation [√âdition de d√©monstration Shareware] </h2><br><blockquote>  Bienvenue au sixi√®me d√©fi Flare-On! <br><br>  Ceci est un jeu simple.  Effectuer une ing√©nierie inverse pour d√©terminer les "codes d'armes" que vous devez entrer pour vaincre chacun des deux ennemis et l'√©cran de victoire r√©v√©lera le drapeau.  Entrez le drapeau ici sur ce site pour marquer et passer au niveau suivant. <br><br>  * Ce d√©fi est √©crit en .NET.  Si vous n'avez pas encore d'outil de r√©tro-ing√©nierie .NET pr√©f√©r√©, je recommande dnSpy <br><br>  ** Si vous avez d√©j√† r√©solu la version compl√®te de ce jeu sur notre stand √† BlackHat ou la version ult√©rieure sur Twitter, f√©licitations, entrez le drapeau de l'√©cran de victoire maintenant pour contourner ce niveau. </blockquote><p>  Cette t√¢che a √©t√© d√©finie √† l'avance dans le cadre de Black Hat USA 2019, √† peu pr√®s au moment o√π je l'ai d√©cid√©. <del>  Je ne me souviens pas comment il l'a r√©solu </del>  La t√¢che est assez simple, nous n'envisagerons donc pas sa solution. </p><br><a name="task02"></a><br><h2 id="0x02---overlong">  0x02 - Overlong </h2><br><blockquote>  Le secret de ce prochain d√©fi est intelligemment cach√©.  Cependant, avec la bonne approche, trouver la solution ne prendra pas trop de temps. </blockquote><p>  √âtant donn√© le fichier x86 .exe.  Lorsque vous essayez de d√©marrer, un message s'affiche avec le contenu suivant: </p><br><p><img src="https://habrastorage.org/webt/gb/0q/ee/gb0qeertq_z-3wk0jyry5tuyjts.png"></p><br><p>  Lors de l'analyse de l'application, vous pouvez constater que le message est stock√© dans un certain codage avec une longueur de caract√®re variable (de 1 √† 4 octets).  Lorsque la fonction de d√©codage est appel√©e, elle re√ßoit la longueur du r√©sultat attendu, qui est plus courte que le message lui-m√™me, c'est pourquoi l'indicateur n'est pas visible.  Vous pouvez corriger la valeur de longueur pass√©e √† la fonction en mode d√©bogage et obtenir le message complet avec l'indicateur: </p><br><p><img src="https://habrastorage.org/webt/5q/lp/be/5qlpbeezlg3hmwbr8-bqnmd-50o.png"></p><br><p>  Vous pouvez √©galement r√©√©crire l'algorithme de d√©codage en Python et obtenir un indicateur: </p><br><pre><code class="python hljs">msg = [ ... ] <span class="hljs-comment"><span class="hljs-comment">#      output = [] i = 0 while i &lt; len(msg): if (msg[i] &gt;&gt; 3) == 0x1e: out_char = ( ((msg[i + 3] &amp; 0x3F) &lt;&lt; 0 ) | ((msg[i + 2] &amp; 0x3F) &lt;&lt; 6 ) | ((msg[i + 1] &amp; 0x3F) &lt;&lt; 12) | ((msg[i + 0] &amp; 7) &lt;&lt; 18) ) output.append(out_char) i += 4 elif (msg[i] &gt;&gt; 4) == 0x0e: out_char = ( ((msg[i + 2] &amp; 0x3F) &lt;&lt; 0 ) | ((msg[i + 1] &amp; 0x3F) &lt;&lt; 6 ) | ((msg[i + 0] &amp; 0xF) &lt;&lt; 12) ) output.append(out_char) i += 3 elif (msg[i] &gt;&gt; 5) == 6: out_char = ( ((msg[i + 1] &amp; 0x3F) &lt;&lt; 0 ) | ((msg[i + 0] &amp; 0xF) &lt;&lt; 6 ) ) output.append(out_char) i += 2 else: output.append(msg[i]) i += 1 print(bytes([i for i in output])) # b'I never broke the encoding: I_a_M_t_h_e_e_n_C_o_D_i_n_g@flare-on.com'</span></span></code> </pre> <br><a name="task03"></a><br><h2 id="0x03---flarebear">  0x03 - Flarebear </h2><br><blockquote>  Chez Flare, nous avons cr√©√© notre propre animal de compagnie Tamagotchi, le flarebear.  Il est tr√®s pointilleux.  Gardez-le vivant et heureux et il vous donnera le drapeau. </blockquote><p>  Dans cette t√¢che, un fichier <code>apk</code> pour <code>Android</code> .  Envisagez une m√©thode de solution sans lancer l'application elle-m√™me. </p><br><p>  La premi√®re √©tape consiste √† obtenir le code source de l'application.  Pour ce faire, √† l'aide de l'utilitaire <code>dex2jar</code> convertissez <code>apk</code> en <code>jar</code> puis r√©cup√©rez le code source <code>Java</code> √† l'aide du d√©compilateur, que je pr√©f√®re utiliser <code>cfr</code> . </p><br><pre> <code class="plaintext hljs">~/retools/d2j/d2j-dex2jar.sh flarebear.apk java -jar ~/retools/cfr/cfr-0.146.jar --outputdir src flarebear-dex2jar.jar</code> </pre> <br><p>  En analysant le code source de l'application, vous pouvez trouver une m√©thode <code>.danceWithFlag()</code> int√©ressante, qui se trouve dans le fichier <code>FlareBearActivity.java</code> .  Dans <code>.danceWithFlag()</code> , les ressources <code>raw</code> de l'application sont d√©chiffr√©es √† l'aide de la <code>.decrypt(String, byte[])</code> , dont le premier argument est la cha√Æne obtenue √† l'aide de la m√©thode <code>.getPassword()</code> .  Le drapeau est s√ªrement dans les ressources crypt√©es, alors essayons de les d√©crypter.  Pour ce faire, j'ai d√©cid√© de r√©√©crire un peu le code d√©compil√©, en supprimant <code>Android</code> d√©pendances <code>Android</code> et en ne laissant que les m√©thodes n√©cessaires au d√©chiffrement, afin que le code r√©sultant puisse √™tre compil√©.  De plus, au cours de l'analyse, il a √©t√© constat√© que la m√©thode <code>.getPassword()</code> d√©pend de trois valeurs d'√©tat entier.  Chaque valeur se situe dans un petit intervalle de <code>0</code> √† <code>N</code> , vous pouvez donc parcourir toutes les valeurs possibles √† la recherche du mot de passe souhait√©. </p><br><p>  Le r√©sultat est le code suivant: </p><br><div class="spoiler">  <b class="spoiler_title">Main.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.InputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.charset.Charset; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.Key; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.spec.AlgorithmParameterSpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.spec.KeySpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.Cipher; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.SecretKey; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.SecretKeyFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.IvParameterSpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.PBEKeySpec; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.spec.SecretKeySpec; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String args [])</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Main a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Main(); InputStream inputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(<span class="hljs-string"><span class="hljs-string">"ecstatic"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> fileSize = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"ecstatic"</span></span>).length(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] file1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) fileSize]; inputStream.read(file1); inputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(<span class="hljs-string"><span class="hljs-string">"ecstatic2"</span></span>); fileSize = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"ecstatic2"</span></span>).length(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] file2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) fileSize]; inputStream.read(file2); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; <span class="hljs-number"><span class="hljs-number">7</span></span>; j++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k = <span class="hljs-number"><span class="hljs-number">1</span></span>; k &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>; k++) { String pass = a.getPassword(i, j, k); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] out1 = a.decrypt(pass, file1); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] out2 = a.decrypt(pass, file2); OutputStream outputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(<span class="hljs-string"><span class="hljs-string">"out1"</span></span>); outputStream.write(out1); outputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(<span class="hljs-string"><span class="hljs-string">"out2"</span></span>); outputStream.write(out2); System.out.println(<span class="hljs-string"><span class="hljs-string">"yep!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (javax.crypto.BadPaddingException ex) { } } } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decrypt(Object object, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arrby) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> Exception { Object object2 = Charset.forName(<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>); object2 = <span class="hljs-string"><span class="hljs-string">"pawsitive_vibes!"</span></span>.getBytes((Charset)object2); object2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IvParameterSpec((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[])object2); object = ((String)object).toCharArray(); Object object3 = Charset.forName(<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>); object3 = <span class="hljs-string"><span class="hljs-string">"NaClNaClNaCl"</span></span>.getBytes((Charset)object3); object = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PBEKeySpec((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[])object, (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[])object3, <span class="hljs-number"><span class="hljs-number">1234</span></span>, <span class="hljs-number"><span class="hljs-number">256</span></span>); object = SecretKeyFactory.getInstance(<span class="hljs-string"><span class="hljs-string">"PBKDF2WithHmacSHA1"</span></span>).generateSecret((KeySpec)object); object3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecretKeySpec(((SecretKey)object).getEncoded(), <span class="hljs-string"><span class="hljs-string">"AES"</span></span>); object = Cipher.getInstance(<span class="hljs-string"><span class="hljs-string">"AES/CBC/PKCS5Padding"</span></span>); ((Cipher)object).init(<span class="hljs-number"><span class="hljs-number">2</span></span>, (Key)object3, (AlgorithmParameterSpec)object2); object = ((Cipher)object).doFinal(arrby); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> [])object; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPassword</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n3)</span></span></span><span class="hljs-function"> </span></span>{ String string2 = <span class="hljs-string"><span class="hljs-string">"*"</span></span>; String string3 = <span class="hljs-string"><span class="hljs-string">"*"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (n % <span class="hljs-number"><span class="hljs-number">9</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"*"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"#"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"+"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"$"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"-"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: { string2 = <span class="hljs-string"><span class="hljs-string">"_"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (n3 % <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"@"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"&amp;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"#"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"+"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"_"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: { string3 = <span class="hljs-string"><span class="hljs-string">"$"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: } String string4 = String.join(<span class="hljs-string"><span class="hljs-string">""</span></span>, Collections.nCopies(n / n3, <span class="hljs-string"><span class="hljs-string">"flare"</span></span>)); String string5 = String.join(<span class="hljs-string"><span class="hljs-string">""</span></span>, Collections.nCopies(n2 * <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rotN(<span class="hljs-string"><span class="hljs-string">"bear"</span></span>, n * n2))); String string6 = String.join(<span class="hljs-string"><span class="hljs-string">""</span></span>, Collections.nCopies(n3, <span class="hljs-string"><span class="hljs-string">"yeah"</span></span>)); StringBuilder stringBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); stringBuilder.append(string4); stringBuilder.append(string2); stringBuilder.append(string5); stringBuilder.append(string3); stringBuilder.append(string6); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stringBuilder.toString(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rotN</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String charSequence, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ Collection&lt;String&gt; collection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(charSequence.length()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; charSequence.length(); ++i) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c2 = c = charSequence.charAt(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Character.isLowerCase(c)) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c3; c2 = c3 = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)(c + n); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c3 &gt; <span class="hljs-string"><span class="hljs-string">'z'</span></span>) { c2 = c3 = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)(c3 - n * <span class="hljs-number"><span class="hljs-number">2</span></span>); } } collection.add(Character.valueOf(c2).toString()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> collection.stream().collect(Collectors.joining()); <span class="hljs-comment"><span class="hljs-comment">// return ArraysKt.joinToString$default(CollectionsKt.toCharArray((List)collection), (CharSequence)FLARE_BEAR_NAME, null, null, 0, null, null, 62, null); } }</span></span></code> </pre> </div></div><br><p>  Nous allons extraire les ressources chiffr√©es, compiler et ex√©cuter le fichier r√©sultant: </p><br><pre> <code class="plaintext hljs">$ ~/retools/apktool/apktool d flarebear.apk $ cp flarebear/res/raw/* . $ javac Main.java $ java Main</code> </pre> <br><p>  Heureusement, une seule de toutes les options de mot de passe que vous s√©lectionnez est appropri√©e.  En cons√©quence, nous obtenons deux images avec un drapeau: </p><br><pre> <code class="plaintext hljs">~/flareon2019/3 - Flarebear$ file out* out1: PNG image data, 2100 x 2310, 8-bit/color RGB, non-interlaced out2: PNG image data, 2100 x 2310, 8-bit/color RGB, non-interlaced</code> </pre> <br><img width="400" src="https://habrastorage.org/webt/eo/sp/wv/eospwvjutdz_76f4qrwzqqzstie.png"><br><img width="400" src="https://habrastorage.org/webt/mr/cf/wk/mrcfwklfuon1ebo1ctqafdzicti.png"><br><a name="task04"></a><br><h2 id="0x04---dnschess">  0x04 - Dnschess </h2><br><blockquote>  Un trafic r√©seau suspect nous a conduits √† ce programme d'√©checs non autoris√© ex√©cut√© sur un bureau Ubuntu.  Cela semble √™tre le travail des pirates informatiques du cyberespace.  Vous devrez prendre les bonnes mesures pour r√©soudre celui-ci.  Bonne chance! </blockquote><p>  Cette t√¢che contient un vidage du trafic, un fichier ex√©cutable <code>ELF</code> <code>ChessUI</code> et une biblioth√®que <code>ChessAI.so</code> .  En ex√©cutant le fichier ex√©cutable, vous pouvez voir l'√©chiquier. </p><br><img width="500" src="https://habrastorage.org/webt/5t/7m/gn/5t7mgn6jyrc2zndnuwliuiuzovc.png"><br><p>  Commen√ßons l'analyse par un vidage du trafic. </p><br><p><img src="https://habrastorage.org/webt/br/00/-5/br00-59yyrbti3rrdxgvizcfkdk.png"></p><br><p>  Tout le trafic consiste en des requ√™tes vers un serveur <code>DNS</code> type <code>A</code>  Les requ√™tes elles-m√™mes consistent en les noms des pi√®ces, la description du coup dans le jeu d'√©checs et la partie constante de <code>.game-of-thrones.flare-on.com</code> , par exemple <code>rook-c3-c6.game-of-thrones.flare-on.com</code> .  Par la partie constante, vous pouvez facilement trouver le bon endroit dans la biblioth√®que <code>ChessAI.so</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> __int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNextMove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> idx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *chess_name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pos_from, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pos_to, \__int64 a5)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">hostent</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v9</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">// [rsp+20h] [rbp-60h] char *ip_addr; // [rsp+28h] [rbp-58h] char dns_name; // [rsp+30h] [rbp-50h] unsigned __int64 v12; // [rsp+78h] [rbp-8h] v12 = __readfsqword(0x28u); strcpy(&amp;dns_name, chess_name); pos_to_str(&amp;dns_name, pos_from); pos_to_str(&amp;dns_name, pos_to); strcat(&amp;dns_name, ".game-of-thrones.flare-on.com"); v9 = gethostbyname(&amp;dns_name); if ( !v9 ) return 2LL; ip_addr = *v9-&gt;h_addr_list; if ( *ip_addr != 127 || ip_addr[3] &amp; 1 || idx != (ip_addr[2] &amp; 0xF) ) return 2LL; sleep(1u); flag[2 * idx] = ip_addr[1] ^ key[2 * idx]; flag[2 * idx + 1] = ip_addr[1] ^ key[2 * idx + 1]; *(_DWORD *)a5 = (unsigned __int8)ip_addr[2] &gt;&gt; 4; *(_DWORD *)(a5 + 4) = (unsigned __int8)ip_addr[3] &gt;&gt; 1; strcpy((char *)(a5 + 8), off_4120[idx]); return (unsigned __int8)ip_addr[3] &gt;&gt; 7; }</span></span></code> </pre> <br><p>  Le code montre que, sur la base des adresses <code>ip</code> re√ßues, une certaine cha√Æne d'octets est d√©chiffr√©e, qui est stock√©e dans une autre zone de m√©moire, que j'ai appel√©e <code>flag</code> . </p><br><p>  Pour r√©soudre la t√¢che, la premi√®re chose √† faire est d'obtenir toutes les adresses <code>ip</code> du vidage de trafic.  Vous pouvez le faire avec la commande suivante: </p><br><pre> <code class="plaintext hljs">tshark -r capture.pcap | grep -P -o '127.(\d+).(\d+).(\d+)' | grep -v '127.0.0.1'</code> </pre> <br><p>  <code>ips</code> enregistr√© toutes les adresses <code>ip</code> dans le fichier <code>ips</code> , <code>ips</code> pouvez utiliser le code <code>Python</code> suivant pour obtenir l'indicateur: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'ips'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: ips = f.read().split() flag = bytearray(<span class="hljs-number"><span class="hljs-number">64</span></span>) key = <span class="hljs-string"><span class="hljs-string">b'yZ\xb8\xbc\xec\xd3\xdf\xdd\x99\xa5\xb6\xac\x156\x85\x8d\t\x08wRMqT}\xa7\xa7\x08\x16\xfd\xd7'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ip <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ips: a, b, c, d = map(int, ip.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> d &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> idx = c &amp; <span class="hljs-number"><span class="hljs-number">0xf</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> idx &gt; <span class="hljs-number"><span class="hljs-number">14</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> flag[<span class="hljs-number"><span class="hljs-number">2</span></span>*idx] = b ^ key[<span class="hljs-number"><span class="hljs-number">2</span></span>*idx] flag[<span class="hljs-number"><span class="hljs-number">2</span></span>*idx + <span class="hljs-number"><span class="hljs-number">1</span></span>] = b ^ key[<span class="hljs-number"><span class="hljs-number">2</span></span>*idx + <span class="hljs-number"><span class="hljs-number">1</span></span>] print(flag.decode() + <span class="hljs-string"><span class="hljs-string">'@flare-on.com'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># LooksLikeYouLockedUpTheLookupZ@flare-on.com</span></span></code> </pre> <br><a name="task05"></a><br><h2 id="0x05---demo">  0x05 - d√©mo </h2><br><blockquote>  Un membre de l'√©quipe de Flare a essay√© de nous impressionner par ses comp√©tences en mati√®re de d√©mosc√®ne.  Cela semble vide.  Voyez si vous pouvez le d√©couvrir ou peut-√™tre que nous devrons les renvoyer.  Pas de pression. </blockquote><p>  √âtant donn√© le fichier ex√©cutable <code>4k.exe</code> , qui utilise <code>DirectX</code> .  Une fois lanc√©, le logo <code>FlareOn</code> rotatif s'affiche dans la fen√™tre principale. </p><br><p><img src="https://habrastorage.org/webt/db/cw/ll/dbcwllgkqhasqqyvcmjv0iugwoc.png"></p><br><p>  L'analyse statique du programme r√©v√®le une seule fonction, qui est le point d'entr√©e.  Dans le contenu, la fonction ressemble √† l'impl√©mentation du d√©cryptage de code.  Nous ne perdrons pas de temps √† analyser l'algorithme de cette fonction, il suffit de mettre un point d'arr√™t sur l'instruction <code>ret</code> et de voir o√π le contr√¥le est transf√©r√©.  Apr√®s retour, nous nous retrouvons √† l'adresse <code>0x00420000</code> , le code auquel est d√©mont√© comme quelque chose de suffisant: </p><br><p><img src="https://habrastorage.org/webt/ba/ns/cb/banscbeyqmgqabaf6nbg5khebgk.png"></p><br><p>  Il a ensuite √©t√© d√©cid√© de transf√©rer ce code du mode d√©bogage vers la base de donn√©es <code>IDA</code> √† l'aide de l' <code>API</code> et de poursuivre l'analyse statique. </p><br><p>  Le nouveau code au d√©but importe les fonctions n√©cessaires √† partir de diverses biblioth√®ques.  Le tableau de ces fonctions peut √©galement √™tre restaur√© en dynamique.  Le r√©sultat est l'ensemble de fonctions suivant: </p><br><p><img src="https://habrastorage.org/webt/hj/em/xv/hjemxvwadjd5f6z-paauo9vh4by.png"></p><br><p>  Le "vrai" point d'entr√©e du programme sera: </p><br><p><img src="https://habrastorage.org/webt/5l/gl/-4/5lgl-4g3pzgrxf0gigfh5m99uqe.png"></p><br><p>  Notez la cr√©ation de <code>DeviceInterface</code> type <code>IDirect3DDevice9 **</code> .  A l'avenir, cette interface est activement utilis√©e, et pour simplifier l'inverse, il est n√©cessaire de d√©finir un tableau de ses m√©thodes.  Il a √©t√© possible de trouver la d√©finition de l'interface assez rapidement, par exemple <a href="">ici</a> .  J'ai analys√© ce tableau et l'ai converti en une structure pour l' <code>IDA</code> .  L'application du type r√©sultant √† <code>DeviceInterface</code> peut consid√©rablement simplifier l'analyse du code.  Les captures d'√©cran suivantes montrent le r√©sultat du d√©compilateur pour la fonction principale du cycle de rendu de sc√®ne avant et apr√®s l'application du type. </p><br><p><img src="https://habrastorage.org/webt/gh/yc/35/ghyc35pxpo9mhyi8dx-louqlcsy.png"></p><br><p><img src="https://habrastorage.org/webt/wg/sk/ql/wgskqlsgkdxsul3hqll8m-ohv8c.png"></p><br><p>  Apr√®s une analyse plus approfondie, il a √©t√© constat√© que deux maillages polygonaux (maillage, maillage polygonal) sont cr√©√©s dans le programme, bien que lorsque le programme est en cours d'ex√©cution, nous ne voyons qu'un seul objet.  De plus, lors de la construction de grilles, leurs sommets sont chiffr√©s √† l'aide de <code>XOR</code> , ce qui soul√®ve √©galement des soup√ßons.  D√©cryptons et visualisons les sommets.  La deuxi√®me grille est la plus int√©ressante, car  il a beaucoup plus de sommets.  <code>matplotlib</code> tous les sommets, j'ai trouv√© que la coordonn√©e <code>Z</code> de chacun d'eux est 0, donc pour la visualisation, il a √©t√© d√©cid√© de dessiner des graphiques bidimensionnels en utilisant <code>matplotlib</code> .  Le code et le r√©sultat suivants avec un indicateur se sont av√©r√©s: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'vertexes'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: data = f.read() n = len(data) // <span class="hljs-number"><span class="hljs-number">4</span></span> data = list(struct.unpack(<span class="hljs-string"><span class="hljs-string">'{}I'</span></span>.format(n), data)) key = [<span class="hljs-number"><span class="hljs-number">0xCB343C8</span></span>, <span class="hljs-number"><span class="hljs-number">0x867B81F0</span></span>, <span class="hljs-number"><span class="hljs-number">0x84AF72C3</span></span>] data = [data[i] ^ key[i % <span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(data))] data = struct.pack(<span class="hljs-string"><span class="hljs-string">'{}I'</span></span>.format(n), *data) data = list(struct.unpack(<span class="hljs-string"><span class="hljs-string">'{}f'</span></span>.format(n), data)) x = data[<span class="hljs-number"><span class="hljs-number">0</span></span>::<span class="hljs-number"><span class="hljs-number">3</span></span>] y = data[<span class="hljs-number"><span class="hljs-number">1</span></span>::<span class="hljs-number"><span class="hljs-number">3</span></span>] z = data[<span class="hljs-number"><span class="hljs-number">2</span></span>::<span class="hljs-number"><span class="hljs-number">3</span></span>] print(z) plt.plot(x, y) plt.show()</code> </pre> <br><p><img src="https://habrastorage.org/webt/ke/5w/z5/ke5wz52y1nkpe3jpgxsrl9vcg4c.png"></p><br><a name="task06"></a><br><h2 id="0x06---bmphide">  0x06 - bmphide </h2><br><blockquote>  Tyler Dean a parcouru le mont.  Elbert (la plus haute montagne du Colorado) √† 2h du matin pour capturer cette photo au moment id√©al.  Ne sautez jamais le jour de la jambe.  Nous avons trouv√© cette photo et cet ex√©cutable sur une cl√© USB qu'il a laiss√©e au d√©but du sentier.  Peut-on lui faire confiance? </blockquote><p>  Dans la t√¢che, le fichier ex√©cutable <code>bmphide.exe</code> et l'image <code>image.bmp</code> sont <code>image.bmp</code> .  On peut supposer que certains messages sont cach√©s dans l'image √† l'aide de m√©thodes de st√©ganographie. </p><br><p>  Le binaire est √©crit en <code>C#</code> , j'ai donc utilis√© l'utilitaire <code>dnSpy</code> pour l'analyse.  Vous pouvez imm√©diatement remarquer que la plupart des noms des m√©thodes sont obscurcis.  Si vous regardez la m√©thode <code>Program.Main</code> , vous pouvez comprendre la logique du programme et faire des hypoth√®ses sur le but de certains d'entre eux: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// BMPHIDE.Program // Token: 0x06000018 RID: 24 RVA: 0x00002C18 File Offset: 0x00002C18 private static void Main(string[] args) { Program.Init(); Program.yy += 18; string filename = args[2]; string fullPath = Path.GetFullPath(args[0]); string fullPath2 = Path.GetFullPath(args[1]); byte[] data = File.ReadAllBytes(fullPath2); Bitmap bitmap = new Bitmap(fullPath); byte[] data2 = Program.h(data); Program.i(bitmap, data2); bitmap.Save(filename); }</span></span></code> </pre><br><ul><li>  L'application est initialis√©e √† l'aide de la m√©thode <code>Program.Init()</code> </li><li>  Lire le fichier de donn√©es et le fichier image </li><li>  En utilisant la m√©thode <code>byte [] Program.h(byte [])</code> , certaines conversions de donn√©es sont effectu√©es </li><li>  En utilisant la m√©thode <code>Program.i(Bitmap, byte[])</code> , les donn√©es converties sont ins√©r√©es dans l'image </li><li>  L'image r√©sultante est enregistr√©e avec un nouveau nom. </li></ul><br><p>  Lorsque l'application est initialis√©e, diff√©rentes m√©thodes de classe <code>A</code> appel√©es.  Une analyse superficielle de la classe a montr√© la similitude de certaines de ses m√©thodes avec les m√©thodes de l'obfuscateur <code>ConfuserEx</code> (fichier <code>AntiTamper.JIT.cs</code> ).  L'application est vraiment prot√©g√©e contre le d√©bogage.  Dans le m√™me temps, il n'a pas √©t√© possible de retirer les m√©canismes de protection √† l'aide de l'utilitaire <code>de4dot</code> et de ses fourches, il a donc √©t√© d√©cid√© de poursuivre l'analyse. </p><br><p>  Consid√©rez la m√©thode <code>Program.i</code> , qui est utilis√©e pour ins√©rer des donn√©es dans une image. </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num = Program.j(<span class="hljs-number"><span class="hljs-number">103</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = Program.j(<span class="hljs-number"><span class="hljs-number">103</span></span>); i &lt; bm.Width; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = Program.j(<span class="hljs-number"><span class="hljs-number">103</span></span>); j &lt; bm.Height; j++) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag = num &gt; data.Length - Program.j(<span class="hljs-number"><span class="hljs-number">231</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Color pixel = bm.GetPixel(i, j); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> red = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.R &amp; Program.j(<span class="hljs-number"><span class="hljs-number">27</span></span>)) | ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)data[num] &amp; Program.j(<span class="hljs-number"><span class="hljs-number">228</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> green = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.G &amp; Program.j(<span class="hljs-number"><span class="hljs-number">27</span></span>)) | (data[num] &gt;&gt; Program.j(<span class="hljs-number"><span class="hljs-number">230</span></span>) &amp; Program.j(<span class="hljs-number"><span class="hljs-number">228</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> blue = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.B &amp; Program.j(<span class="hljs-number"><span class="hljs-number">25</span></span>)) | (data[num] &gt;&gt; Program.j(<span class="hljs-number"><span class="hljs-number">100</span></span>) &amp; Program.j(<span class="hljs-number"><span class="hljs-number">230</span></span>)); Color color = Color.FromArgb(Program.j(<span class="hljs-number"><span class="hljs-number">103</span></span>), red, green, blue); bm.SetPixel(i, j, color); num += Program.j(<span class="hljs-number"><span class="hljs-number">231</span></span>); } } }</code> </pre> <br><p>  Cependant, tr√®s similaire au <code>LSB</code> classique, dans les endroits o√π des constantes sont attendues, la m√©thode <code>int Program.j(byte)</code> est utilis√©e.  Le r√©sultat de son travail d√©pend des diff√©rentes valeurs globales obtenues, y compris lors de l'initialisation dans la m√©thode <code>Program.Init()</code> .  Il a √©t√© d√©cid√© de ne pas inverser son travail, mais d'obtenir toutes les valeurs possibles lors de l'ex√©cution.  <code>dnSpy</code> permet de modifier le code d'application d√©compil√© et d'enregistrer les modules modifi√©s.  Nous en profitons et <code>Program.Main</code> m√©thode <code>Program.Main</code> comme suit: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Program.Init(); Program.yy += <span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">256</span></span>; i++) { Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"j({0}) = {1}"</span></span>, i, Program.j((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)i))); } }</code> </pre> <br><p>  Au d√©marrage, nous obtenons les valeurs suivantes: </p><br><pre> <code class="plaintext hljs">E:\&gt;bmphide_j.exe j(0) = 206 j(1) = 204 j(2) = 202 j(3) = 200 j(4) = 198 j(5) = 196 j(6) = 194 j(7) = 192 j(8) = 222 j(9) = 220 j(10) = 218 j(11) = 216 j(12) = 214 j(13) = 212 j(14) = 210 j(15) = 208 j(16) = 238 j(17) = 236 j(18) = 234 j(19) = 232 j(20) = 230 ...</code> </pre> <br><p>  Remplacez les appels √† <code>Program.j</code> dans la m√©thode <code>Program.j</code> par les constantes r√©sultantes: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bitmap bm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bm.Width; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; bm.Height; j++) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag = num &gt; data.Length - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Color pixel = bm.GetPixel(i, j); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> red = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.R &amp; <span class="hljs-number"><span class="hljs-number">0xf8</span></span>) | ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)data[num] &amp; <span class="hljs-number"><span class="hljs-number">0x7</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> green = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.G &amp; <span class="hljs-number"><span class="hljs-number">0xf8</span></span>) | (data[num] &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x7</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> blue = ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)pixel.B &amp; <span class="hljs-number"><span class="hljs-number">0xfc</span></span>) | (data[num] &gt;&gt; <span class="hljs-number"><span class="hljs-number">6</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x3</span></span>); Color color = Color.FromArgb(<span class="hljs-number"><span class="hljs-number">0</span></span>, red, green, blue); bm.SetPixel(i, j, color); num += <span class="hljs-number"><span class="hljs-number">1</span></span>; } } }</code> </pre> <br><p>  Maintenant, il devient clair comment ins√©rer chaque octet du message dans l'image: </p><br><ul><li>  les bits 0 √† 2 sont plac√©s dans les 3 LSB du canal rouge du point </li><li>  les bits 3 √† 5 sont plac√©s dans les 3 LSB du canal vert du point </li><li>  les bits 6 √† 7 sont plac√©s dans les 2 LSB du canal bleu du point </li></ul><br><p>  Ensuite, j'ai essay√© de r√©p√©ter l'algorithme de la m√©thode de conversion des donn√©es, mais le r√©sultat du calcul ne correspondait pas √† la sortie du programme.  Il s'est av√©r√© que la classe <code>A</code> √©galement des fonctionnalit√©s pour remplacer les m√©thodes (dans <code>A.VerifySignature(MethodInfo m1, MethodInfo m2)</code> ) et modifier le code d'octet <code>IL</code> des m√©thodes (dans <code>A.IncrementMaxStack</code> ). </p><br><p>  Pour s√©lectionner les m√©thodes qui doivent √™tre remplac√©es dans <code>Program</code> , dans <code>Program.Init</code> , l' <code>IL</code> bytecode <code>IL</code> m√©thodes est hach√© et compar√© aux valeurs pr√©-calcul√©es.  Au total, deux m√©thodes sont remplac√©es.  Pour savoir lesquels, ex√©cutez l'application sous le d√©bogueur en d√©finissant des points d'arr√™t sur les appels <code>A.VerifySignature</code> et vous devez ignorer l'appel <code>A.CalculateStack()</code> dans <code>Program.Init</code> , car  Il emp√™che le d√©bogage. </p><br><p><img src="https://habrastorage.org/webt/v7/2o/l4/v72ol4f8pcefzyg7lnmkywe4tyw.png"></p><br><p>  Par cons√©quent, vous pouvez voir que la m√©thode <code>Program.a</code> est remplac√©e par <code>Program.b</code> et <code>Program.c</code> est remplac√©e par <code>Program.d</code> . </p><br><p>  Vous devez maintenant g√©rer la modification du bytecode: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsafe</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">uint</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IncrementMaxStack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr self, A.ICorJitInfo* comp, A.CORINFO_METHOD_INFO* info, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">** nativeEntry, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params">* nativeSizeOfCode</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag = info != <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag) { MethodBase methodBase = Ac(info-&gt;ftn); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag2 = methodBase != <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag2) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag3 = methodBase.MetadataToken == <span class="hljs-number"><span class="hljs-number">100663317</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag3) { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> flNewProtect; A.VirtualProtect((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), info-&gt;ILCodeSize, <span class="hljs-number"><span class="hljs-number">4u</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> flNewProtect); Marshal.WriteByte((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); Marshal.WriteByte((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), <span class="hljs-number"><span class="hljs-number">62</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); A.VirtualProtect((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), info-&gt;ILCodeSize, flNewProtect, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> flNewProtect); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag4 = methodBase.MetadataToken == <span class="hljs-number"><span class="hljs-number">100663316</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag4) { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> flNewProtect2; A.VirtualProtect((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), info-&gt;ILCodeSize, <span class="hljs-number"><span class="hljs-number">4u</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> flNewProtect2); Marshal.WriteInt32((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">309030853</span></span>); Marshal.WriteInt32((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-number"><span class="hljs-number">209897853</span></span>); A.VirtualProtect((IntPtr)((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)info-&gt;ILCode), info-&gt;ILCodeSize, flNewProtect2, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> flNewProtect2); } } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> A.originalDelegate(self, comp, info, flags, nativeEntry, nativeSizeOfCode); }</code> </pre> <br><p>  Il est clair que les m√©thodes avec des valeurs <code>MetadataToken</code> sp√©cifiques, √† savoir <code>0x6000015</code> et <code>0x6000014</code> , seront modifi√©es.  Ces jetons correspondent aux m√©thodes <code>Program.h</code> et <code>Program.g</code> .  <code>dnSpy</code> dispose d'un √©diteur <code>hex</code> int√©gr√© dans lequel, lors du survol, les donn√©es de la m√©thode sont mises en √©vidence: leur titre (surlign√© en violet) et leur code d'octet (surlign√© en rouge), comme indiqu√© dans la capture d'√©cran.  Vous pouvez acc√©der √† la m√©thode souhait√©e dans l'√©diteur <code>hex</code> en cliquant sur l'adresse correspondante dans le commentaire avant la m√©thode d√©compil√©e (par exemple, <code>File Offset: 0x00002924</code> ). </p><br><p><img src="https://habrastorage.org/webt/xt/i6/e6/xti6e6knsrkyrapcutnkypgfeau.png"></p><br><p>  Essayons d'appliquer toutes les modifications d√©crites: nous cr√©erons une copie du fichier, dans n'importe quel √©diteur hexad√©cimal, nous changerons les valeurs aux d√©calages n√©cessaires, que nous avons appris de <code>dnSpy</code> et nous remplacerons les m√©thodes a <code>a -&gt; b</code> et <code>c -&gt; d</code> dans <code>Program.h</code> .  Nous <code>Program.Init</code> √©galement de <code>Program.Init</code> tous les appels au module <code>A</code>  Si tout est fait correctement, lorsque nous essayons d'ins√©rer un message dans l'image √† l'aide de l'application modifi√©e, nous obtenons le m√™me r√©sultat que lorsque l'application d'origine fonctionnait.  Les captures d'√©cran ci-dessous montrent le code d√©compil√© des m√©thodes des applications originales et modifi√©es. </p><br><p><img src="https://habrastorage.org/webt/lq/wo/em/lqwoemy3gsysvsptxholl6ioyey.png"></p><br><p><img src="https://habrastorage.org/webt/le/tw/j6/letwj6p_uzdmlglrgsky2gifwuy.png"></p><br><p>  Il reste √† cr√©er un algorithme de transformation inverse.  C'est assez simple, donc je ne donnerai que le script <code>Python</code> r√©sultant: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-comment"><span class="hljs-comment"># Rotate left: 0b1001 --&gt; 0b0011 rol = lambda val, r_bits, max_bits: \ (val &lt;&lt; r_bits%max_bits) &amp; (2**max_bits-1) | \ ((val &amp; (2**max_bits-1)) &gt;&gt; (max_bits-(r_bits%max_bits))) # Rotate right: 0b1001 --&gt; 0b1100 ror = lambda val, r_bits, max_bits: \ ((val &amp; (2**max_bits-1)) &gt;&gt; r_bits%max_bits) | \ (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (2**max_bits-1)) rol8 = lambda a, b: rol(a, b, 8) ror8 = lambda a, b: ror(a, b, 8) def extract(fname): img = Image.open(fname) w, h = img.size result = bytearray() for i in range(w): for j in range(h): r, g, b = img.getpixel((i, j)) # print('{:02x} {:02x} {:02x}'.format(r, g, b)) byte = (r &amp; 0b111) | ((g &amp; 0b111) &lt;&lt; 3) | ((b &amp; 0b11) &lt;&lt; 6) result.append(byte) return result enc = extract('image.bmp') n = len(enc) dec = bytearray() def g(idx): b = ((idx + 1) * 309030853) &amp; 0xff k = ((idx + 2) * 209897853) &amp; 0xff return b ^ k j = 0 for i in range(n): x = enc[i] x = rol8(x, 3) x ^= g(2*i + 1) x = ror8(x, 7) x ^= g(2*i + 0) dec.append(x) with open('output', 'wb') as f: f.write(dec)</span></span></code> </pre> <br><p>  En ex√©cutant ce script, nous obtenons une autre image <code>bmp</code> sans indicateur.  En r√©p√©tant la proc√©dure dessus, nous obtenons l'image finale avec le drapeau. </p><br><p><img src="https://habrastorage.org/webt/jj/ba/yq/jjbayqp9cpownsuf1wlrwar-rem.png"></p><br><a name="task07"></a><br><h2 id="0x07---wopr">  0x07 - wopr </h2><br><blockquote>  Nous avons utilis√© nos propres comp√©tences en piratage informatique pour "trouver" cette IA sur un supercalculateur militaire.  Il ressemble fortement au film classique WarGames de 1983.  Peut-√™tre que la vie imite l'art?  Si vous pouvez trouver les codes de lancement pour nous, nous vous laisserons passer au prochain d√©fi.  Nous nous engageons √† ne pas d√©clencher une guerre thermonucl√©aire. </blockquote><p>  En t√¢che, l'application console <code>worp.exe</code> .  Apparemment, pour le r√©soudre, vous devez r√©cup√©rer du code. </p><br><p><img src="https://habrastorage.org/webt/ji/1p/2w/ji1p2w_9cpkv8vsaxbezvicozjc.png"></p><br><p>  L'analyse du point d'entr√©e montre qu'il s'agit d'une archive auto-extractible.  Au d√©marrage, la variable d'environnement <code>_MEIPASS2</code> .  Si cette variable n'existe pas, un r√©pertoire temporaire est cr√©√© dans lequel le contenu de l'archive est d√©compress√©, et l'application red√©marre avec la variable d'environnement donn√©e <code>_MEIPASS2</code> .  Contenu de l'archive: </p><br><pre> <code class="plaintext hljs">. ‚îú‚îÄ‚îÄ api-ms-win-core-console-l1-1-0.dll ‚îú‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ api-ms-win-crt-utility-l1-1-0.dll ‚îú‚îÄ‚îÄ base_library.zip ‚îú‚îÄ‚îÄ _bz2.pyd ‚îú‚îÄ‚îÄ _ctypes.pyd ‚îú‚îÄ‚îÄ _hashlib.pyd ‚îú‚îÄ‚îÄ libcrypto-1_1.dll ‚îú‚îÄ‚îÄ libssl-1_1.dll ‚îú‚îÄ‚îÄ _lzma.pyd ‚îú‚îÄ‚îÄ pyexpat.pyd ‚îú‚îÄ‚îÄ python37.dll ‚îú‚îÄ‚îÄ select.pyd ‚îú‚îÄ‚îÄ _socket.pyd ‚îú‚îÄ‚îÄ _ssl.pyd ‚îú‚îÄ‚îÄ this ‚îÇ  ‚îú‚îÄ‚îÄ __init__.py ‚îÇ  ‚îî‚îÄ‚îÄ key ‚îú‚îÄ‚îÄ ucrtbase.dll ‚îú‚îÄ‚îÄ unicodedata.pyd ‚îú‚îÄ‚îÄ VCRUNTIME140.dll ‚îî‚îÄ‚îÄ wopr.exe.manifest 1 directory, 56 files</code> </pre> <br><p>  A en juger par le contenu, nous avons affaire √† une application <code>Python</code> conditionn√©e en <code>exe</code> .  √Ä l'appui de cela, dans le binaire principal, vous pouvez trouver l'importation dynamique des fonctions correspondantes de la biblioth√®que <code>Python</code> : <code>PyMarshal_ReadObjectFromString</code> , <code>PyEval_EvalCode</code> et autres.  Pour une analyse plus approfondie, vous devez extraire le bytecode <code>Python</code> .  Pour ce faire, enregistrez le contenu de l'archive √† partir du r√©pertoire temporaire et <code>_MEIPASS2</code> chemin d'acc√®s dans la variable d'environnement <code>_MEIPASS2</code> .  Ex√©cutez le binaire principal en mode d√©bogage en d√©finissant un point d'arr√™t sur la fonction <code>PyMarshal_ReadObjectFromString</code> .  Cette fonction prend comme arguments un pointeur vers un tampon avec un code <code>Python</code> s√©rialis√© et sa longueur.  Nous vidons le contenu du tampon de longueur connue pour chacun des appels.  Je n'ai re√ßu que 2 appels, alors que dans le second, l'objet s√©rialis√© est beaucoup plus gros, et nous allons l'analyser. </p><br><p>  Une mani√®re assez simple d'analyser les donn√©es obtenues consiste √† les convertir au format de fichiers <code>.pyc</code> (bytecode <code>Python</code> compil√©) et √† les d√©compiler en utilisant <code>uncompyle6</code> .  Pour ce faire, il suffit d'ajouter un en-t√™te de 16 octets aux donn√©es re√ßues.  En cons√©quence, j'ai obtenu le fichier suivant: </p><br><pre> <code class="plaintext hljs">00000000: 42 0d 0d 0a 00 00 00 00 de cd 57 5d 00 00 00 00 B.........W].... 00000010: e3 00 00 00 00 00 00 00 00 00 00 00 00 09 00 00 ................ 00000020: 00 40 00 00 00 73 3c 01 00 00 64 00 5a 00 64 01 .@...s&lt;...dZd 00000030: 64 02 6c 01 5a 01 64 01 64 02 6c 02 5a 02 64 01 dlZddlZd</code> </pre> <br><p>  Ensuite, nous d√©compilons le fichier r√©sultant en utilisant <code>uncompyle6</code> : </p><br><pre> <code class="plaintext hljs">uncompyle6 task.pyc &gt; task.py</code> </pre> <br><p>  Si nous essayons d'ex√©cuter le fichier d√©compil√©, nous obtiendrons une exception dans la ligne <code>BOUNCE = pkgutil.get_data('this', 'key')</code> .  Ceci est facilement r√©solu en affectant simplement le contenu du fichier <code>key</code> de l'archive √† la variable <code>BOUNCE</code> .  En relan√ßant le script, nous ne verrons que l'inscription <code>LOADING...</code>  Apparemment, certaines techniques sont utilis√©es dans la t√¢che qui emp√™chent la d√©compilation.  Nous proc√©dons √† l'analyse du code <code>Python</code> r√©sultant.  √Ä la toute fin, nous voyons le cycle suivant: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">256</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(lzma.decompress(fire(eye(__doc__.encode()), bytes([i]) + BOUNCE))) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><p>  Vous pouvez comprendre que la fonction d' <code>print</code> est en fait remplac√©e par <code>exec</code> , et son argument d√©pend uniquement de <code>__doc__.encode()</code> - le texte au d√©but du fichier.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au d√©but de l'ex√©cution du code, enregistrez la fonction </font></font><code>print</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sous un nom diff√©rent et remplacez-la </font></font><code>print</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans le bloc </font></font><code>try-except</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Lorsque nous ex√©cutons le script r√©sultant, rien ne nous sera de nouveau affich√©. </font><font style="vertical-align: inherit;">La d√©compilation </font></font><code>__doc__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font><font style="vertical-align: inherit;">peut-√™tre </font><font style="vertical-align: inherit;">√©t√© enregistr√©e incorrectement. </font><font style="vertical-align: inherit;">Essayons d'extraire la valeur </font></font><code>__doc__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">directement du code s√©rialis√© comme suit:</font></font></p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> marshal <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'pycode1'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> inp: data = inp.read() code = marshal.loads(data) doc = code.co_consts[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'doc.txt'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> outp: outp.write(doc)</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez √† nouveau le script en rempla√ßant le contenu </font></font><code>__doc__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Par cons√©quent, √† une certaine valeur </font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, le code s'affiche avec succ√®s √† l'√©cran. </font><font style="vertical-align: inherit;">Nous l'enregistrons dans un nouveau fichier et l'analysons. </font><font style="vertical-align: inherit;">Dans la fonction, </font></font><code>wrong</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous pouvez trouver la ligne suivante:</font></font></p><br><pre> <code class="python hljs">trust = windll.kernel32.GetModuleHandleW(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)</code> </pre> <br><p>          ,         .      <code>0x100000</code>            <code>wrong</code> ,        .          ,     . </p><br><p>         .    <code>z3</code> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> z3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> stage2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wrong xor = [<span class="hljs-number"><span class="hljs-number">212</span></span>, <span class="hljs-number"><span class="hljs-number">162</span></span>, <span class="hljs-number"><span class="hljs-number">242</span></span>, <span class="hljs-number"><span class="hljs-number">218</span></span>, <span class="hljs-number"><span class="hljs-number">101</span></span>, <span class="hljs-number"><span class="hljs-number">109</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">125</span></span>, <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-number"><span class="hljs-number">249</span></span>, <span class="hljs-number"><span class="hljs-number">83</span></span>, <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-number"><span class="hljs-number">187</span></span>, <span class="hljs-number"><span class="hljs-number">131</span></span>, <span class="hljs-number"><span class="hljs-number">206</span></span>] h = list(wrong()) h = [h[i] ^ xor[i] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>)] b = <span class="hljs-number"><span class="hljs-number">16</span></span> * [<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>] x = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>): x.append(BitVec(<span class="hljs-string"><span class="hljs-string">'x'</span></span> + str(i), <span class="hljs-number"><span class="hljs-number">32</span></span>)) b[<span class="hljs-number"><span class="hljs-number">0</span></span>] = x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] b[<span class="hljs-number"><span class="hljs-number">1</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] b[<span class="hljs-number"><span class="hljs-number">2</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">3</span></span>] = x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">4</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">5</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">6</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">7</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] b[<span class="hljs-number"><span class="hljs-number">8</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] b[<span class="hljs-number"><span class="hljs-number">9</span></span>] = x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">10</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">8</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">11</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] b[<span class="hljs-number"><span class="hljs-number">12</span></span>] = x[<span class="hljs-number"><span class="hljs-number">0</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">13</span></span>] = x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">4</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">6</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">12</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] b[<span class="hljs-number"><span class="hljs-number">14</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">2</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">7</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">14</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] b[<span class="hljs-number"><span class="hljs-number">15</span></span>] = x[<span class="hljs-number"><span class="hljs-number">1</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">3</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">5</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">9</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">10</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">11</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">13</span></span>] ^ x[<span class="hljs-number"><span class="hljs-number">15</span></span>] solver = Solver() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>): solver.add(x[i] &lt; <span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">16</span></span>): solver.add(b[i] == h[i]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> solver.check() == sat: m = solver.model() print(bytes([m[i].as_long() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> x])) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print(<span class="hljs-string"><span class="hljs-string">'unsat'</span></span>)</code> </pre> <br><p>   ,    : <code>5C0G7TY2LWI2YXMB</code> </p><br><p><img src="https://habrastorage.org/webt/yp/ox/jh/ypoxjh3rafci2a5-ukpy2uvbgu0.png"></p><br><a name="task08"></a><br><h2 id="0x08---snake"> 0x08 ‚Äî snake </h2><br><blockquote> The Flare team is attempting to pivot to full-time twitch streaming video games instead of reverse engineering computer software all day. We wrote our own classic NES game to stream content that nobody else has seen and watch those subscribers flow in. It turned out to be too hard for us to beat so we gave up. See if you can beat it and capture the internet points that we failed to collect. </blockquote><p>    <code>NES</code> - .       <code>FCEUX</code> , ..      .  ,   . </p><br><p><img src="https://habrastorage.org/webt/tk/fx/sq/tkfxsqug4puqwqs893v5zceereg.png"></p><br><p>  ,  ,     <code>0x25</code>    .    ,   .     <code>NES</code> -  <code>IDA</code> .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inesldr</a> .     <code>0x25</code> .   <code>C82A</code>    ,           .      <code>0x33</code> . </p><br><p><img src="https://habrastorage.org/webt/uo/2b/h8/uo2bh8iawskqdff-153-964ljwq.png"></p><br><p> ,     ‚Äî   <code>0x32</code>   <code>0x25</code>       .     ,    .  , <code>FCEUX</code>    .          . </p><br><p><img src="https://habrastorage.org/webt/jn/nu/jh/jnnujhs5-fugmpqugrp1z9m7p0o.png"></p><br><a name="task09"></a><br><h2 id="0x09---reloadered"> 0x09 ‚Äî reloadered </h2><br><blockquote> This is a simple challenge, enter the password, receive the key. I hear that it caused problems when trying to analyze it with ghidra. Remember that valid flare-on flags will always end with @flare-on.com </blockquote><p>      <code>reloaderd.exe</code> ,     .    ,     ,     .     ,       ,         <code>XOR</code>    ,     <code>@FLAG.com</code> ,     . </p><br><p><img src="https://habrastorage.org/webt/ki/ug/mv/kiugmvs_ouxbeziqmqnzjhxgqmu.png"></p><br><p>         ,   <code>NOP</code> .          ,     ,   .          .   ,     .    ,      ,       .   ,      ,     <code>NOP</code> ,      . </p><br><p>        ,      ,      <code>XOR</code>  ,  .      <code>@flare-on.com</code> ,    .            : </p><br><pre> <code class="python hljs">flag = bytearray(<span class="hljs-string"><span class="hljs-string">b'D)6\n)\x0f\x05\x1be&amp;\x10\x04+h0/\x003/\x05\x1a\x1f\x0f8\x02\x18B\x023\x1a(\x04*G?\x04&amp;dfM\x107&gt;(&gt;w\x1c?~64*\x00'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0x539</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0x34</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i % <span class="hljs-number"><span class="hljs-number">3</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (i % <span class="hljs-number"><span class="hljs-number">7</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>: flag[j] ^= (i &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) end = <span class="hljs-string"><span class="hljs-string">b'@flare-on.com'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bytes([i^j <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zip(a, b)]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len(flag)): print(i, xor(end, flag[i:])) print(xor(flag, <span class="hljs-string"><span class="hljs-string">b'3HeadedMonkey'</span></span>*<span class="hljs-number"><span class="hljs-number">4</span></span>))</code> </pre> <br><p><img src="https://habrastorage.org/webt/th/qz/9b/thqz9bwdjdkt-a7smd_tb8uncxs.png"></p><br><a name="task10"></a><br><h2 id="0x0a---mugatu"> 0x0A ‚Äî Mugatu </h2><br><blockquote>  Bonjour <br><br> I'm working an incident response case for Derek Zoolander. He clicked a link and was infected with MugatuWare! As a result, his new headshot compilation GIF was encrypted. <br><br> To secure an upcoming runway show, Derek needs this GIF decrypted; however, he refuses to pay the ransom. <br><br> We received an additional encrypted GIF from an anonymous informant. The informant told us the GIF should help in our decryption efforts, but we were unable to figure it out. <br><br> We're reaching out to you, our best malware analyst, in hopes that you can reverse engineer this malware and decrypt Derek's GIF. <br><br> I've included a directory full of files containing: <br><ul><li> MugatuWare malware </li><li> Ransom note (GIFtToDerek.txt) </li><li> Encrypted headshot GIF (best.gif.Mugatu) </li><li> Encrypted informant GIF (the_key_to_success_0000.gif.Mugatu) </li></ul><br><br>  Merci, <br> Roy </blockquote><p>     : </p><br><ul><li> best.gif.Mugatu </li><li> GIFtToDerek.txt </li><li> Mugatuware.exe </li><li> the_key_to_success_0000.gif.Mugatu </li></ul><br><p>   ,    ,   <code>GIF</code> -. ,      <code>.Mugatu</code> .      <code>Mugatuware.exe</code> . ,     ‚Äî           .    ,      ,   . </p><br><p><img src="https://habrastorage.org/webt/no/au/se/noauseew8d2jezeoaqj9kd-pp9e.png"></p><br><p>        <code>IDA</code> ,     : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_segment <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_name <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_bytes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_typeinf idata = ida_segment.get_segm_by_name(<span class="hljs-string"><span class="hljs-string">'.idata'</span></span>) type_map = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> addr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(idata.start_ea, idata.end_ea, <span class="hljs-number"><span class="hljs-number">4</span></span>): name = ida_name.get_name(addr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name: tp = ida_typeinf.idc_get_type(addr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tp: type_map[name] = tp <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> addr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(idata.start_ea, idata.end_ea, <span class="hljs-number"><span class="hljs-number">4</span></span>): imp = ida_bytes.get_dword(addr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> imp != <span class="hljs-number"><span class="hljs-number">0</span></span>: imp_name = ida_name.get_name(imp) name_part = imp_name.split(<span class="hljs-string"><span class="hljs-string">'_'</span></span>)[<span class="hljs-number"><span class="hljs-number">-1</span></span>] ida_name.set_name(addr, name_part + <span class="hljs-string"><span class="hljs-string">'_imp'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name_part <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> type_map: tp = type_map[name_part] ida_typeinf.apply_decl(addr, tp.replace(<span class="hljs-string"><span class="hljs-string">'('</span></span>, <span class="hljs-string"><span class="hljs-string">'func('</span></span>) + <span class="hljs-string"><span class="hljs-string">';'</span></span>)</code> </pre> <br><p>        : </p><br><p><img src="https://habrastorage.org/webt/f-/cl/ad/f-cladmcmadtfx1v9bdhjhobt28.png"></p><br><p>   ,        ,     <code>in-memory</code>  <code>PE</code> -.           ,        <code>CrazyPills!!!</code>  .     ,      .       <code>Sleep</code> ,      <code>http</code> -.    ,     ,      ,        .   ,          ,    ,     .    . </p><br><p><img src="https://habrastorage.org/webt/np/pq/5q/nppq5qbcpyirk9xgamtl0wh89h0.png"></p><br><p>  -         : </p><br><ul><li>         ; </li><li>   ; </li><li>           <code>Mailslots</code> ; </li><li>        <code>really, really, really, ridiculously good looking gifs</code> ; </li><li>         <code>.gif</code> .      <code>.Mugatu</code> .      <code>GIFtToDerek.txt</code>   . </li></ul><br><p>  ,   ‚Äî 8 .          <code>XOR</code>     <code>CrazyPills!!!</code> ,        .  ,        : </p><br><p><img src="https://habrastorage.org/webt/bm/em/6u/bmem6uqdty4xdugfaxuz0j9efuw.png"></p><br><p>     <code>XTEA</code> ,    ‚Äî     <code>BYTE</code> ,    <code>DWORD</code> .           .         <code>Python</code> : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b, key)</span></span></span><span class="hljs-function">:</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">32</span></span>): t = (i + key[i &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> a = (a + (t ^ (b + ((b &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ^ (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>))))) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> i = (<span class="hljs-number"><span class="hljs-number">0x100000000</span></span> + i - <span class="hljs-number"><span class="hljs-number">0x61C88647</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> t = (i + key[(i &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> b = (b + (t ^ (a + ((a &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ^ (a &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>))))) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a, b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b, key)</span></span></span><span class="hljs-function">:</span></span> i = <span class="hljs-number"><span class="hljs-number">0xc6ef3720</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">32</span></span>): t = (i + key[(i &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> b = (<span class="hljs-number"><span class="hljs-number">0x100000000</span></span> + b - (t ^ (a + ((a &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ^ (a &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>))))) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> i = (i + <span class="hljs-number"><span class="hljs-number">0x61C88647</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> t = (i + key[i &amp; <span class="hljs-number"><span class="hljs-number">3</span></span>]) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> a = (<span class="hljs-number"><span class="hljs-number">0x100000000</span></span> + a - (t ^ (b + ((b &gt;&gt; <span class="hljs-number"><span class="hljs-number">5</span></span>) ^ (b &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>))))) &amp; <span class="hljs-number"><span class="hljs-number">0xffffffff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a, b</code> </pre><br><p>  ,  <code>the_key_to_success_0000.gif.Mugatu</code>     .        ,     .     : </p><br><p><img src="https://habrastorage.org/webt/lm/bb/jl/lmbbjl90qtlexwxwtywt6wbh09i.gif"></p><br><p>  ,        ,        .        <code>C</code> .     <code>GIF</code> -. </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; void decrypt(unsigned int * inp, unsigned int * outp, unsigned char * key) { unsigned int i = 0xc6ef3720; unsigned int a = inp[0]; unsigned int b = inp[1]; unsigned int t; for(int j = 0; j &lt; 32; j++) { t = i + key[(i &gt;&gt; 11) &amp; 3]; b -= t ^ (a + ((a &gt;&gt; 5) ^ (a &lt;&lt; 4))); i += 0x61C88647; t = i + key[i &amp; 3]; a -= t ^ (b + ((b &gt;&gt; 5) ^ (b &lt;&lt; 4))); } outp[0] = a; outp[1] = b; } int main() { int fd = open("best.gif.Mugatu", 0); unsigned int inp[2]; unsigned int outp[2]; unsigned int key = 0; read(fd, inp, 8); close(fd); for(unsigned long long key = 0; key &lt; 0x100000000; key++) { if((key &amp; 0xffffff) == 0) { printf("%lf\n", ((double)key) / ((double)0x100000000) * 100.0); } decrypt(inp, outp, &amp;key); if( ((char *)outp)[0] == 'G' &amp;&amp; ((char *)outp)[1] == 'I' &amp;&amp; ((char *)outp)[2] == 'F' &amp;&amp; ((char *)outp)[5] == 'a') { printf("%#llx\n", key); } } }</span></span></span></span></code> </pre> <br><p>        <code>0xb1357331</code>      : </p><br><p><img src="https://habrastorage.org/webt/cw/s5/fz/cws5fzu68wbv5mf-myteh-o8uqk.gif"></p><br><a name="task11"></a><br><h2 id="0x0b---vv_max"> 0x0B ‚Äî vv_max </h2><br><blockquote> Hey, at least its not subleq. </blockquote><p>     <code>vv_max.exe</code> ,      .          256-     .       <code>AVX2</code> ,   <code>vpermd</code> , <code>vpslld</code>  .    -    : </p><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">0000 clear_regs 0001 r0 = 393130324552414c46 0023 r1 = 3030303030303030303030303030303030303030303030303030303030303030 0045 r3 = 1a1b1b1b1a13111111111111111111151a1b1b1b1a1311111111111111111115 0067 r4 = 1010101010101010080408040201101010101010101010100804080402011010 0089 r5 = b9b9bfbf041310000000000000000000b9b9bfbf04131000 00ab r6 = 2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f 00cd r10 = 140014001400140014001400140014001400140014001400140014001400140 00ef r11 = 1100000011000000110000001100000011000000110000001100000011000 0111 r12 = ffffffff0c0d0e08090a040506000102ffffffff0c0d0e08090a040506000102 0133 r13 = ffffffffffffffff000000060000000500000004000000020000000100000000 0155 r16 = ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff 0177 r17 = 6a09e667bb67ae853c6ef372a54ff53a510e527f9b05688c1f83d9ab5be0cd19 0199 r18 = 428a2f9871374491b5c0fbcfe9b5dba53956c25b59f111f1923f82a4ab1c5ed5 01bb r19 = 300000002000000010000000000000007000000060000000500000004 01dd r20 = 0 01ff r21 = 100000001000000010000000100000001000000010000000100000001 0221 r22 = 200000002000000020000000200000002000000020000000200000002 0243 r23 = 300000003000000030000000300000003000000030000000300000003 0265 r24 = 400000004000000040000000400000004000000040000000400000004 0287 r25 = 500000005000000050000000500000005000000050000000500000005 02a9 r26 = 600000006000000060000000600000006000000060000000600000006 02cb r27 = 700000007000000070000000700000007000000070000000700000007 02ed r20 = vpermd(r0, r20) 02f1 r21 = vpermd(r0, r21) 02f5 r22 = vpermd(r0, r22) 02f9 r23 = vpermd(r0, r23) 02fd r24 = vpermd(r0, r24) 0301 r25 = vpermd(r0, r25) 0305 r26 = vpermd(r0, r26) 0309 r27 = vpermd(r0, r27) 030d r7 = vpsrld(r1, 4) 0311 r28 = r20 ^ r21 0315 r28 = r28 ^ r22 0319 r28 = r28 ^ r23 031d r28 = r28 ^ r24 0321 r28 = r28 ^ r25 0325 r28 = r28 ^ r26 0329 r28 = r28 ^ r27 032d r7 = r7 &amp; r6 0331 r29 = vpslld(r17, 7) 0335 r30 = vpsrld(r17, 25) 0339 r15 = r29 | r30 033d r8 = vpcmpeqb(r1, r6) 0341 r29 = vpslld(r17, 21) 0345 r30 = vpsrld(r17, 11) 0349 r29 = r29 | r30 034d r15 = r15 ^ r29 0351 r8 = vpcmpeqb(r1, r6) 0355 r29 = vpslld(r17, 26) 0359 r30 = vpsrld(r17, 6) 035d r29 = r29 | r30 0361 r15 = r15 ^ r29 0365 r29 = r20 ^ r16 0369 r30 = r20 &amp; r18 036d r29 = r29 ^ r30 0371 r15 = add_d(r29, r15) 0375 r20 = add_d(r15, r0) 0379 r7 = add_b(r8, r7) 037d r29 = r20 ^ r28 0381 r17 = vpermd(r29, r19) 0385 r7 = vpshufb(r5, r7) 0389 r29 = vpslld(r17, 7) 038d r30 = vpsrld(r17, 25) 0391 r15 = r29 | r30 0395 r29 = vpslld(r17, 21) 0399 r30 = vpsrld(r17, 11) 039d r29 = r29 | r30 03a1 r15 = r15 ^ r29 03a5 r29 = vpslld(r17, 26) 03a9 r30 = vpsrld(r17, 6) 03ad r29 = r29 | r30 03b1 r15 = r15 ^ r29 03b5 r2 = add_b(r1, r7) 03b9 r29 = r21 ^ r16 03bd r30 = r21 &amp; r18 03c1 r29 = r29 ^ r30 03c5 r15 = add_d(r29, r15) 03c9 r21 = add_d(r15, r0) 03cd r29 = r21 ^ r28 03d1 r17 = vpermd(r29, r19) 03d5 r20 = r20 ^ r21 03d9 r29 = vpslld(r17, 7) 03dd r30 = vpsrld(r17, 25) 03e1 r15 = r29 | r30 03e5 r29 = vpslld(r17, 21) 03e9 r30 = vpsrld(r17, 11) 03ed r29 = r29 | r30 03f1 r15 = r15 ^ r29 03f5 r29 = vpslld(r17, 26) 03f9 r30 = vpsrld(r17, 6) 03fd r29 = r29 | r30 0401 r15 = r15 ^ r29 0405 r7 = vpmaddubsw(r2, r10) 0409 r29 = r22 ^ r16 040d r30 = r22 &amp; r18 0411 r29 = r29 ^ r30 0415 r15 = add_d(r29, r15) 0419 r22 = add_d(r15, r0) 041d r29 = r22 ^ r28 0421 r17 = vpermd(r29, r19) 0425 r20 = r20 ^ r22 0429 r29 = vpslld(r17, 7) 042d r30 = vpsrld(r17, 25) 0431 r15 = r29 | r30 0435 r29 = vpslld(r17, 21) 0439 r30 = vpsrld(r17, 11) 043d r29 = r29 | r30 0441 r15 = r15 ^ r29 0445 r29 = vpslld(r17, 26) 0449 r30 = vpsrld(r17, 6) 044d r29 = r29 | r30 0451 r15 = r15 ^ r29 0455 r2 = vpmaddwd(r7, r11) 0459 r29 = r23 ^ r16 045d r30 = r23 &amp; r18 0461 r29 = r29 ^ r30 0465 r15 = add_d(r29, r15) 0469 r23 = add_d(r15, r0) 046d r29 = r23 ^ r28 0471 r17 = vpermd(r29, r19) 0475 r20 = r20 ^ r23 0479 r29 = vpslld(r17, 7) 047d r30 = vpsrld(r17, 25) 0481 r15 = r29 | r30 0485 r29 = vpslld(r17, 21) 0489 r30 = vpsrld(r17, 11) 048d r29 = r29 | r30 0491 r15 = r15 ^ r29 0495 r29 = vpslld(r17, 26) 0499 r30 = vpsrld(r17, 6) 049d r29 = r29 | r30 04a1 r15 = r15 ^ r29 04a5 r29 = r24 ^ r16 04a9 r30 = r24 &amp; r18 04ad r29 = r29 ^ r30 04b1 r15 = add_d(r29, r15) 04b5 r24 = add_d(r15, r0) 04b9 r29 = r24 ^ r28 04bd r17 = vpermd(r29, r19) 04c1 r20 = r20 ^ r24 04c5 r29 = vpslld(r17, 7) 04c9 r30 = vpsrld(r17, 25) 04cd r15 = r29 | r30 04d1 r29 = vpslld(r17, 21) 04d5 r30 = vpsrld(r17, 11) 04d9 r29 = r29 | r30 04dd r15 = r15 ^ r29 04e1 r29 = vpslld(r17, 26) 04e5 r30 = vpsrld(r17, 6) 04e9 r29 = r29 | r30 04ed r15 = r15 ^ r29 04f1 r29 = r25 ^ r16 04f5 r30 = r25 &amp; r18 04f9 r29 = r29 ^ r30 04fd r15 = add_d(r29, r15) 0501 r25 = add_d(r15, r0) 0505 r29 = r25 ^ r28 0509 r17 = vpermd(r29, r19) 050d r20 = r20 ^ r25 0511 r2 = vpshufb(r2, r12) 0515 r29 = vpslld(r17, 7) 0519 r30 = vpsrld(r17, 25) 051d r15 = r29 | r30 0521 r29 = vpslld(r17, 21) 0525 r30 = vpsrld(r17, 11) 0529 r29 = r29 | r30 052d r15 = r15 ^ r29 0531 r29 = vpslld(r17, 26) 0535 r30 = vpsrld(r17, 6) 0539 r29 = r29 | r30 053d r15 = r15 ^ r29 0541 r29 = r26 ^ r16 0545 r30 = r26 &amp; r18 0549 r29 = r29 ^ r30 054d r15 = add_d(r29, r15) 0551 r26 = add_d(r15, r0) 0555 r29 = r26 ^ r28 0559 r17 = vpermd(r29, r19) 055d r20 = r20 ^ r26 0561 r29 = vpslld(r17, 7) 0565 r30 = vpsrld(r17, 25) 0569 r15 = r29 | r30 056d r29 = vpslld(r17, 21) 0571 r30 = vpsrld(r17, 11) 0575 r29 = r29 | r30 0579 r15 = r15 ^ r29 057d r29 = vpslld(r17, 26) 0581 r30 = vpsrld(r17, 6) 0585 r29 = r29 | r30 0589 r15 = r15 ^ r29 058d r2 = vpermd(r2, r13) 0591 r29 = r27 ^ r16 0595 r30 = r27 &amp; r18 0599 r29 = r29 ^ r30 059d r15 = add_d(r29, r15) 05a1 r27 = add_d(r15, r0) 05a5 r29 = r27 ^ r28 05a9 r17 = vpermd(r29, r19) 05ad r20 = r20 ^ r27 05b1 r19 = ffffffffffffffffffffffffffffffffffffffffffffffff 05d3 r20 = r20 &amp; r19 05d7 r31 = 2176620c3a5c0f290b583618734f07102e332623780e59150c05172d4b1b1e22</code> </pre> </div></div><br><p>             <code>FLARE2019</code> .        ,     ,    .  ,      <code>FLARE2019</code> .    <code>r2</code>  <code>r20</code> .     ,   <code>r20</code>      .     <code>r2</code>  ‚Äî      6  <code>r2</code> .           ,   6       .     <code>Frida</code> : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># vvmax.py from __future__ import print_function import frida import string import hexdump def check(val): global gdata with open('vvmax.js', 'r') as f: script_src = f.read() pid = frida.spawn(['vv_max.exe', 'FLARE2019', val.ljust(32, 'a')]) session = frida.attach(pid) script = session.create_script(script_src) def handler(message, data): handler.data = data script.on('message', handler) script.load() frida.resume(pid) while not hasattr(handler, 'data'): pass session.detach() return handler.data alph = string.printable def to_bits(x): return ''.join(bin(ord(i))[2:].zfill(8) for i in x) target = to_bits('pp\xb2\xac\x01\xd2^a\n\xa7*\xa8\x08\x1c\x86\x1a\xe8E\xc8)\xb2\xf3\xa1\x1e\x00\x00\x00\x00\x00\x00\x00\x00') password = '' while len(password) != 32: for c in alph: data = to_bits(check(password + c)) i = 6*len(password + c) if data[:i] == target[:i]: password += c i += 1 break print() print('-----&gt;', `password`) print()</span></span></code> </pre> <br><pre> <code class="plaintext hljs">// vvmax.js var modules = Process.enumerateModules(); var base = modules[0].base; Interceptor.attach(base.add(0x1665), function() { var p = this.context.rdx.add(0x840); var res = p.readByteArray(32); send(null, res); });</code> </pre> <br><p>        : </p><br><p><img src="https://habrastorage.org/webt/wo/d7/xp/wod7xpefz_k328dmgnuvnmy7ifi.png"></p><br><a name="task12"></a><br><h2 id="0x0c---help"> 0x0C ‚Äî help </h2><br><blockquote> You're my only hope FLARE-On player! One of our developers was hacked and we're not sure what they took. We managed to set up a packet capture on the network once we found out but they were definitely already on the system. I think whatever they installed must be buggy ‚Äî it looks like they crashed our developer box. We saved off the dump file but I can't make heads or tails of it ‚Äî PLEASE HELP!!!!!! </blockquote><p>       .      <code>RAM</code> -    .       <code>4444</code> , <code>6666</code> , <code>7777</code>  <code>8888</code> .   ,   , ,    <code>RAM</code> -.      <code>volatility</code> .           <code>volatility</code>   <code>Win10x64_15063</code> ,    ,     <code>Win7SP1x64</code> ,        . </p><br><p>      <code>volatility</code>       : </p><br><pre> <code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp modules Volatility Foundation Volatility Framework 2.6 Offset(V) Name Base Size File ------------------ -------------------- ------------------ ------------------ ---- 0xfffffa800183e890 ntoskrnl.exe 0xfffff80002a49000 0x5e7000 \SystemRoot\system32\ntoskrnl.exe ... 0xfffffa800428ff30 man.sys 0xfffff880033bc000 0xf000 \??\C:\Users\FLARE ON 2019\Desktop\man.sys</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp moddump --base 0xfffff880033bc000 -D drivers Volatility Foundation Volatility Framework 2.6 Module Base Module Name Result ------------------ -------------------- ------ 0xfffff880033bc000 man.sys Error: e_magic 0000 is not a valid DOS signature.</code> </pre> <br><p> ,   .       <code>volshell</code>    . </p><br><pre> <code class="plaintext hljs">$ volatility --profile Win7SP1x64 -f help.dmp volshell In [1]: db(0xfffff880033bc000) 0xfffff880033bc000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc010 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc030 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc040 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc050 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc060 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 0xfffff880033bc070 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ In [2]: db(0xfffff880033bc000 + 0x1100) 0xfffff880033bd100 01 48 8b 4c 24 20 48 8b 44 24 28 48 89 41 08 48 .HL$.HD$(HAH 0xfffff880033bd110 83 c4 18 c3 cc cc cc cc cc cc cc cc cc cc cc cc ................ 0xfffff880033bd120 48 89 4c 24 08 48 83 ec 38 48 8b 44 24 40 0f be HL$.H..8H.D$@.. 0xfffff880033bd130 48 43 48 8b 44 24 40 0f be 40 42 83 c0 01 3b c8 HCH.D$@..@B...;. 0xfffff880033bd140 7e 27 45 33 c9 41 b8 15 5b 00 00 48 8d 15 de 44 ~'E3.A..[..H...D 0xfffff880033bd150 00 00 48 8d 0d 07 45 00 00 ff 15 71 4f 00 00 c7 ..H...E....qO... 0xfffff880033bd160 44 24 20 00 00 00 00 eb 08 c7 44 24 20 01 00 00 D$........D$.... 0xfffff880033bd170 00 48 8b 44 24 40 48 8b 80 b8 00 00 00 48 83 c4 .HD$@H......H.. In [4]: man = addrspace().read(0xfffff880033bc000, 0xf000) In [5]: with open('man_writeup.sys', 'wb') as f: ...: f.write(man) ...:</code> </pre> <br><p> ,    ,   <code>moddump</code>  .   .      .  -    ,   ,      . </p><br><p>           <code>RC4</code>   .          ,        . </p><br><p>             <code>user-space</code> .      <code>DLL</code> -   .          <code>DLL</code> - ( <code>m.dll</code> ),    .         ,                 .          : </p><br><ul><li>      ( <code>+0x8</code> ) </li><li>   <code>_EPROCESS</code>   ( <code>+0x68</code> ) </li><li>     ( <code>+0x48</code> ) </li><li>   ( <code>+0x58</code> ) </li></ul><br><p>  <code>DLL</code> -           <code>RC4</code> ,       <code>0x2c</code> -   ,    <code>0x48</code> . </p><br><p>      <code>volatility</code>      <code>volshell</code> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Crypto.Cipher <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ARC4 head = <span class="hljs-number"><span class="hljs-number">0xfffff880033c8158</span></span> krnl = addrspace() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">u64</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> struct.unpack(<span class="hljs-string"><span class="hljs-string">'Q'</span></span>, x)[<span class="hljs-number"><span class="hljs-number">0</span></span>] fd = u64(krnl.read(head, <span class="hljs-number"><span class="hljs-number">8</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: proc_addr = u64(krnl.read(fd + <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) base = u64(krnl.read(fd + <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) key = krnl.read(fd + <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">0x2c</span></span>) sz = u64(krnl.read(fd + <span class="hljs-number"><span class="hljs-number">0x58</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>)) fd = u64(krnl.read(fd, <span class="hljs-number"><span class="hljs-number">8</span></span>)) p = obj.Object(<span class="hljs-string"><span class="hljs-string">'_EPROCESS'</span></span>, proc_addr, krnl) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> p.ImageFileName.v(), hex(proc_addr), hex(base), hex(sz) proc_space = p.get_process_address_space() dump = proc_space.read(base, sz) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> dump[:<span class="hljs-number"><span class="hljs-number">0x100</span></span>] == <span class="hljs-string"><span class="hljs-string">'\x00'</span></span> * <span class="hljs-number"><span class="hljs-number">0x100</span></span>: dump = ARC4.new(key).decrypt(dump) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'proc_{:016x}'</span></span>.format(base), <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(dump) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fd == head: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br><p>   ,  ,            <code>RC4</code> .         <code>IDA</code> ,   ,         : </p><br><div class="spoiler"> <b class="spoiler_title">  IDA</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __future__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_function <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> idaapi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_func, decompile, get_name_ea, auto_wait, BADADDR <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> idaapi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cot_call, cot_obj, init_hexrays_plugin, qexit <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_typeinf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ida_lines <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rc4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key, data)</span></span></span><span class="hljs-function">:</span></span> S = list(range(<span class="hljs-number"><span class="hljs-number">256</span></span>)) j = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> list(range(<span class="hljs-number"><span class="hljs-number">256</span></span>)): j = (j + S[i] + ord(key[i % len(key)])) % <span class="hljs-number"><span class="hljs-number">256</span></span> S[i], S[j] = S[j], S[i] j = <span class="hljs-number"><span class="hljs-number">0</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span> out = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> char <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data: j = (j + <span class="hljs-number"><span class="hljs-number">1</span></span>) % <span class="hljs-number"><span class="hljs-number">256</span></span> y = (y + S[j]) % <span class="hljs-number"><span class="hljs-number">256</span></span> S[j], S[y] = S[y], S[j] out.append(chr(ord(char) ^ S[(S[j] + S[y]) % <span class="hljs-number"><span class="hljs-number">256</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>.join(out) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt_stack_str_args</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ea)</span></span></span><span class="hljs-function">:</span></span> func = get_func(ea) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> func <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: c_func = decompile(func) c_func.pseudocode <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ex: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> citem <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> c_func.treeitems: citem = citem.to_specific_type <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> citem.is_expr() <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>\ citem.op == cot_call <span class="hljs-keyword"><span class="hljs-keyword">and</span></span>\ citem.ea == ea: args = [] key = citem.a[<span class="hljs-number"><span class="hljs-number">0</span></span>] key_len = citem.a[<span class="hljs-number"><span class="hljs-number">1</span></span>] s = citem.a[<span class="hljs-number"><span class="hljs-number">2</span></span>] s_len = citem.a[<span class="hljs-number"><span class="hljs-number">3</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_var_idx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> obj.opname != <span class="hljs-string"><span class="hljs-string">'var'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> obj.opname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'ref'</span></span>, <span class="hljs-string"><span class="hljs-string">'cast'</span></span>): obj = obj.x <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception(<span class="hljs-string"><span class="hljs-string">'can\'t find type'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj.v.idx <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> key_len.opname != <span class="hljs-string"><span class="hljs-string">'num'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> s_len.opname != <span class="hljs-string"><span class="hljs-string">'num'</span></span>: print(<span class="hljs-string"><span class="hljs-string">'[!] can\'t get length: 0x{:08x}'</span></span>.format(ea)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: key_len_val = key_len.n._value s_len_val = s_len.n._value print(<span class="hljs-string"><span class="hljs-string">'0x{:08x}'</span></span>.format(ea), <span class="hljs-string"><span class="hljs-string">'key_len ='</span></span>, key_len_val, <span class="hljs-string"><span class="hljs-string">', s_len ='</span></span>, s_len_val) hx_view = idaapi.open_pseudocode(ea, <span class="hljs-number"><span class="hljs-number">-1</span></span>) key_var_stkoff = hx_view.cfunc.get_lvars()[get_var_idx(key)].location.stkoff() s_var_stkoff = hx_view.cfunc.get_lvars()[get_var_idx(s)].location.stkoff() key_var = [v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.get_lvars() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v.location.stkoff() == key_var_stkoff][<span class="hljs-number"><span class="hljs-number">0</span></span>] tif = ida_typeinf.tinfo_t() ida_typeinf.parse_decl(tif, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-string"><span class="hljs-string">'unsigned __int8 [{}];'</span></span>.format(key_len_val), <span class="hljs-number"><span class="hljs-number">0</span></span>) hx_view.set_lvar_type(key_var, tif) s_var = [v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.get_lvars() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v.location.stkoff() == s_var_stkoff][<span class="hljs-number"><span class="hljs-number">0</span></span>] tif = ida_typeinf.tinfo_t() ida_typeinf.parse_decl(tif, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-string"><span class="hljs-string">'unsigned __int8 [{}];'</span></span>.format(s_len_val + <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>) hx_view.set_lvar_type(s_var, tif) key_var = [v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.get_lvars() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v.location.stkoff() == key_var_stkoff][<span class="hljs-number"><span class="hljs-number">0</span></span>] s_var = [v <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.get_lvars() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> v.location.stkoff() == s_var_stkoff][<span class="hljs-number"><span class="hljs-number">0</span></span>] key_regex = re.compile(<span class="hljs-string"><span class="hljs-string">'{}\[(.+)\] = (.+);'</span></span>.format(key_var.name)) s_regex = re.compile(<span class="hljs-string"><span class="hljs-string">'{}\[(.+)\] = (.+);'</span></span>.format(s_var.name)) key = bytearray(key_len_val) s = bytearray(s_len_val + <span class="hljs-number"><span class="hljs-number">1</span></span>) src = <span class="hljs-string"><span class="hljs-string">'\n'</span></span>.join([ida_lines.tag_remove(i.line) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hx_view.cfunc.pseudocode]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> s_regex.findall(src): s[int(i)] = (<span class="hljs-number"><span class="hljs-number">0x100</span></span> + int(j)) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, j <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> key_regex.findall(src): key[int(i)] = (<span class="hljs-number"><span class="hljs-number">0x100</span></span> + int(j)) &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span> key = <span class="hljs-string"><span class="hljs-string">''</span></span>.join(chr(i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> key) s = <span class="hljs-string"><span class="hljs-string">''</span></span>.join(chr(i) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> s) result = rc4(key, s[:<span class="hljs-number"><span class="hljs-number">-1</span></span>]) <span class="hljs-comment"><span class="hljs-comment"># unicode to ascii if set(ord(i) for i in result[1::2]) == {0}: result = 'wide_' + ''.join(result[0::2]) hx_view.rename_lvar(s_var, 's_' + result, True) except Exception as ex: print('[!] error: {}'.format(ex)) print('#### decryption helper script ####') xref_to = get_name_ea(BADADDR, 'decrypt_stack_str') xref_from = get_first_cref_to(xref_to) while xref_from != BADADDR: print('### 0x{:08x}'.format(xref_from)) decrypt_stack_str_args(xref_from) xref_from = get_next_cref_to(xref_to, xref_from)</span></span></code> </pre> </div></div><br><p>    : </p><br><p><img src="https://habrastorage.org/webt/v9/xx/cg/v9xxcgdktosjrdfyg8ohucbha6g.png"></p><br><p>      .       : </p><br><ul><li> <code>m.dll</code> ‚Äî ,    .   <code>4444</code>   .   ‚Äî           ; </li><li> <code>n.dll</code> ‚Äî         <code>192.168.1.243</code> ; </li><li> <code>c.dll</code> ‚Äî          <code>RC4</code> .       ; </li><li> <code>k.dll</code> ‚Äî            (keylogger); </li><li> <code>s.dll</code> ‚Äî       ; </li><li> <code>f.dll</code> ‚Äî       . </li></ul><br><p>      ,       <code>XOR</code>    8.      <code>4444</code>       , ..       .       :    ,       ‚Äî      . ,   -   . </p><br><p>    ( <code>4444</code> )     . ,     -   .       ,      .            : </p><br><ul><li> keys.kdb </li><li> C:\ </li><li> C:\keypass\keys.kdb </li></ul><br><p> ,        <code>f.dll</code> :       <code>keys.kdb</code> ,      . </p><br><p>     <code>6666</code>     .      <code>LZNT1</code>     <code>RC4</code>  <code>XOR</code> .   ,  <code>XOR</code> -  , ..       .   <code>RC4</code>    ,     <code>RAM</code> -: <code>FLARE ON 2019</code> .  ,   <code>GetUserNameA</code> ,        ,            -   ,      <code>RC4</code> .      <code>LZNT1</code>     : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ctypes <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * nt = windll.ntdll <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> fname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'input'</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(fname, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: buf = f.read() dec_data = create_string_buffer(<span class="hljs-number"><span class="hljs-number">0x10000</span></span>) final_size = c_ulong(<span class="hljs-number"><span class="hljs-number">0</span></span>) status = nt.RtlDecompressBuffer( <span class="hljs-number"><span class="hljs-number">0x102</span></span>, <span class="hljs-comment"><span class="hljs-comment"># COMPRESSION_FORMAT_LZNT1 dec_data, # UncompressedBuffer 0x10000, # UncompressedBufferSize c_char_p(buf), # CompressedBuffer 0xFFFFFF, # CompressedBufferSize byref(final_size) # FinalUncompressedSize ) with open(fname + '.uncompressed', 'wb') as f: f.write(dec_data.raw[:final_size.value])</span></span></code> </pre> <br><p>         <code>6666</code> .    : </p><br><pre> <code class="plaintext hljs">00000000: CC 69 94 FA 6A 37 18 29 CB 8D 87 EF 11 63 8E 73 .i..j7.).....cs 00000010: FE AB 43 3B B3 94 28 4B 4D 19 00 00 00 4F DB C7 ..C;..(KM....O.. 00000020: F3 1E E4 13 15 34 8F 51 A9 2B C2 D7 C1 96 78 F7 .....4.Q.+....x. 00000030: 91 98</code> </pre> <br><p>     ,  : </p><br><pre> <code class="plaintext hljs">00000000: 19 00 00 00 4F DB C7 F3 1E E4 13 15 34 8F 51 A9 ....O.......4.Q. 00000010: 2B C2 D7 C1 96 78 F7 91 98 +....x...</code> </pre> <br><p>  4   ‚Äî    ,     25.   : </p><br><pre> <code class="plaintext hljs">00000000: 12 B0 00 43 3A 5C 6B 65 79 70 61 04 73 73 01 70 ...C:\keypa.ss.p 00000010: 73 2E 6B 64 62 s.kdb</code> </pre> <br><p>        <code>C:\keypass\keys.kdb</code> .   ,      ,     .      <code>6666</code>     ‚Äî      <code>KeePass</code> . </p><br><p>     <code>7777</code>        <code>BMP</code> .       <code>XOR</code> ,   ,     , ..          .       ,   ,    <code>KeePass</code> . </p><br><p><img src="https://habrastorage.org/webt/3h/wg/ud/3hwgud3zz5s77zqiv2siwqjexve.png"></p><br><p><img src="https://habrastorage.org/webt/su/u2/dl/suu2dlwj1a8sqd5nq0vt2oqqkg8.png"></p><br><p>     <code>8888</code>     <code>k.dll</code> ‚Äî      . </p><br><pre> <code class="plaintext hljs">C:\Windows\system32\cmd.exe nslookup googlecom ping 1722173110 nslookup soeblogcom nslookup fiosquatumgatefiosrouterhome C:\Windows\system32\cmd.exe Start Start menu Start menu chrome www.flare-on.com - Google Chrome tis encrypting something twice better than once Is encrypting something twice better than once? - Google Search - Google Chrome Start Start menu Start menu keeKeePass &lt;DYN_TITLE&gt; th1sisth33nd111 KeePass keys.kdb - KeePass Is encrypting something twice better than once? - Google Search - Google Chrome Start Start menu Start menu KeePass &lt;DYN_TITLE&gt; th1sisth33nd111 Open Database - keys.kdb KeePass Start Start menu Start menu KeePass Start menu Start menu Start menu KeePass &lt;DYN_TITLE&gt; th1sisth33nd111</code> </pre> <br><p>       <code>th1sisth33nd111</code>     ,    .    ,     .   ,  keylogger          . ,   ,    <code>ping</code>    .      <code>hashcat</code>      <code>KeePass</code>   ,    .              : </p><br><pre> <code class="plaintext hljs">$ strings help.dmp | grep -i '3nd!' !s_iS_th3_3Nd!!!</code> </pre> <br><p>  <code>Th</code>        . </p><br><p><img src="https://habrastorage.org/webt/xb/9g/yb/xb9gyb5mnp6evacpllttaz1czco.png"></p><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>     .      ,   -. </p><br><a name="outro"></a><br><h2 id="0x0d---itog"> 0x0D ‚Äî  </h2><br><p> ,  .   ,       ,        .      ,        <code>volatility</code> ,      .            (  UTC+3:00): </p><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/am/yq/ul/amyquljwc2ieb2qzb4ct9nemtnm.png"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469393/">https://habr.com/ru/post/fr469393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469381/index.html">Agones, cr√©ez un serveur de jeu multi-utilisateurs. Architecture et installation</a></li>
<li><a href="../fr469383/index.html">Solution hyperconverg√©e AERODISK vAIR. Base - Syst√®me de fichiers ARDFS</a></li>
<li><a href="../fr469387/index.html">L'histoire d'un "d√©veloppeur" ou comment un nouveau venu pour √©crire une application pour iOS</a></li>
<li><a href="../fr469389/index.html">Param√©trage par un r√©seau neuronal d'un mod√®le physique pour r√©soudre un probl√®me d'optimisation topologique</a></li>
<li><a href="../fr469391/index.html">Interfaces audio: le son comme source d'information sur la route, au bureau et dans le ciel</a></li>
<li><a href="../fr469395/index.html">O√π et comment utiliser les multicolonnes (colonnes CSS)</a></li>
<li><a href="../fr469399/index.html">Wi-Fi au mus√©e-domaine Arkhangelskoye</a></li>
<li><a href="../fr469401/index.html">Mise √† jour du service WebMeeting 3CX, Elastix Online Converter et nouveaux didacticiels vid√©o</a></li>
<li><a href="../fr469403/index.html">Nous interviewons un candidat pour le poste de d√©veloppeur de logiciels senior</a></li>
<li><a href="../fr469405/index.html">Le Deep Learning est d√©sormais en Java</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>