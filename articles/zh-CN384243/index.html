<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💍 👩🏿‍🏭 🤛 通过RF24Network通过Modbus的OpenHAB无线家用空调控制器 👨🏾‍🤝‍👨🏽 🈺 🚙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在我写了第一篇关于用控制器控制空调的文章之后，仅仅两年多了。在这段时间里，远程控制空调的想法并没有让我离开，而是多次重生。主要条件是空调没有电线。
 
 即，控制器的控制必须是无线的。
 
 背景
 第一个原型是Arduino UNO。她接受了UART上的团队，并且知道如何打开和关闭空调。因为连接到...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>通过RF24Network通过Modbus的OpenHAB无线家用空调控制器</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384243/"><img align="left" src="https://habrastorage.org/files/1d4/8ed/b4b/1d48edb4b2b24079a0e2a7e7d5d7e584.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在</font><font style="vertical-align: inherit;">我写了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">篇关于用控制器控制空调的文章</font><font style="vertical-align: inherit;">之后</font><font style="vertical-align: inherit;">，仅仅两年多了。</font><font style="vertical-align: inherit;">在这段时间里，远程控制空调的想法并没有让我离开，而是多次重生。</font><font style="vertical-align: inherit;">主要条件是空调没有电线。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
即，控制器的控制必须是无线的。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">背景</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一个原型是Arduino UNO。她接受了UART上的团队，并且知道如何打开和关闭空调。因为连接到工作计算机的arduinka几乎没有实际意义，负责人一直在寻找将后者连接到家庭服务器的机会。从服务器到所有难题的罪魁祸首都没有直接可见性。最大的是在所有同一台工作计算机上都带有LAN的插槽-因为它几乎与空调相对。以太网屏蔽不可用。但是请记住，在zashashnik中的某个地方有一个d-link DSL-2500U dsl调制解调器，该调制解调器已经使用很长时间了，板上只有一个端口。赋予铁杆第二次生命的愿望导致了谷歌搜索，这反过来又奇迹般地导致了一篇文章，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将ADSL调制解调器变成Arduino / CraftDuino的以太网屏蔽</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
向前跳过了创建自定义固件的有趣过程，我仍然设法使调制解调器侦听所需的端口并通过它“转发” UART。</font><font style="vertical-align: inherit;">因此，在家庭服务器上，我可以发送命令打开/关闭端口到本地调制解调器地址，该地址将转到与其连接的arduino。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是这篇文章不是关于这个的。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最终的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方案使用Modbus协议和</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">RF24Network</font></a><font style="vertical-align: inherit;">无线网络</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">一切都在OpenHAB中控制。</font></font><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在过去的两年中，我设法从中国订购了许多nishtyak，其中大多数都在等待中。</font><font style="vertical-align: inherit;">该清单包括NRF24L01 +模块，由少数人购买以进行试验。</font><font style="vertical-align: inherit;">如果有一天我没有偶然发现一系列文章，他将在壁橱里闲散的走得更远：</font></font><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何交朋友OpenHAB和Arduino</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino和Modbus</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino和OpenHAB</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从  </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">博里奇</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">谢谢你！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多亏了他们，我才熟悉Modbus协议。</font><font style="vertical-align: inherit;">但最重要的是，我为自己找到了OpenHAB-我已经寻找了很长时间。</font><font style="vertical-align: inherit;">这促使我开始实施长期的想法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在浏览了文章中的示例之后，我决定尝试使用以太网屏蔽与上述调制解调器分离控制器和服务器。</font><font style="vertical-align: inherit;">该解决方案使我们能够完成摆在您面前的任务-防护罩和控制器位于台式机上，而无需使用工作计算机，同时，防护罩始终连接到本地网络，并且可以从家庭服务器进行访问。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但是这个决定注定要失败。</font></font></b><div class="spoiler_text">     ModbusRtu over TCP   .    modpoll,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Arduino &amp; Modbus</a>  .     —          192.168.1.110   3000  !<br>
<br>
    OpenHAB. ,  , Modbus Binding   «RTU over TCP».        —     ModbusRtu   c      TCP.            OpenHAB-(ethernet)--(UART)-.<br>
<br>
 ,   ?      Item  .      1 Item     .      —      . ,   ,    TCP    Modbus Binding. ..              .<br>
<br>
   Modbus Binding     Item'   host-port-slaveID     .<br>
<br>
        ,     .                .       ,    .<br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理念</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，我终于确定自己需要制造一个可以通过空中操作的控制器。</font><font style="vertical-align: inherit;">NRF24L01 +模块不应消失！。的确，这至少需要两个控制器-一个起直接作用，第二个起路由器的作用。</font><font style="vertical-align: inherit;">第二个应该连接到服务器，并通过它与其他服务器进行无线通信。</font><font style="vertical-align: inherit;">连接到它时，我们指定该包要使用的下级的ID。</font><font style="vertical-align: inherit;">事实证明，一个串行端口上有许多从设备。</font><font style="vertical-align: inherit;">是的-这是基于Modbus的无线网络。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
顺便说一句，Modbus允许一个主机建立一个网络-许多下属。</font><font style="vertical-align: inherit;">以及</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RF24Network</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">-使一切变得无线，甚至在网络节点之间自动路由。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino的库开发</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了实现这样的解决方案，需要花很多时间来修改</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Master-Slave-for-Arduino</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">，以便能够从中继承并重载一些方法。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我的实现</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">也已更新（已添加library.properties，库文件分为标头和正文）以适用于最新的Arduino IDE 1.6.5。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Arduino</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-over-RF24Network-for-Arduino</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">允许您实现两种可能的行为-代理和从属。</font><font style="vertical-align: inherit;">示例ModbusRF24Proxy实际上是“路由器”的实现，除了设置必要的引脚外，不需要进行任何修改。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus示例RF24Proxy</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24Network.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtu.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtuRF24.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> stlPin  13  <span class="hljs-comment">//     (   Arduino)</span></span><font></font>
<font></font>
<span class="hljs-comment">// nRF24L01(+) radio attached using Getting Started board </span>
<span class="hljs-function">RF24 <span class="hljs-title">radio</span><span class="hljs-params">(<span class="hljs-number">9</span>, <span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Network uses that radio</span>
<span class="hljs-function">RF24Network <span class="hljs-title">network</span><span class="hljs-params">(radio)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Address of our node</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-comment">//  ,   TX</span>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">proxy</span><span class="hljs-params">(network, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;
<span class="hljs-keyword">int8_t</span> state = <span class="hljs-number">0</span>;
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> tempus;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">//    </span><font></font>
    io_setup();<font></font>
    <span class="hljs-comment">//    </span><font></font>
<font></font>
    proxy.begin(<span class="hljs-number">57600</span>);<font></font>
<font></font>
    SPI.begin();<font></font>
    radio.begin();<font></font>
    network.begin(<span class="hljs-comment">/*channel*/</span> <span class="hljs-number">90</span>, <span class="hljs-comment">/*node address*/</span> this_node);<font></font>
<font></font>
    <span class="hljs-comment">//    100 </span>
    tempus = millis() + <span class="hljs-number">100</span>;<font></font>
    digitalWrite(stlPin, HIGH);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_setup</span><span class="hljs-params">()</span> </span>{<font></font>
    digitalWrite(stlPin, HIGH);<font></font>
    pinMode(stlPin, OUTPUT);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">// Pump the network regularly</span><font></font>
    network.update();<font></font>
<font></font>
    <span class="hljs-comment">//  </span><font></font>
    state = proxy.proxy();<font></font>
<font></font>
    <span class="hljs-comment">//      -    50  </span>
    <span class="hljs-keyword">if</span> (state &gt; <span class="hljs-number">4</span>) {<font></font>
        tempus = millis() + <span class="hljs-number">50</span>;<font></font>
        digitalWrite(stlPin, HIGH);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (millis() &gt; tempus) digitalWrite(stlPin, LOW);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
路由器或代理使用特殊的构造函数格式：</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  ,   TX</span>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">proxy</span><span class="hljs-params">(network, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
和功能 </font></font><br>
<pre><code class="cpp hljs">proxy.proxy();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理串行端口上的传入数据包，将其发送到RF24Network，从网络接收响应，然后将结果发送回串行端口。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在此实现中，代理的RF24Network地址为零：</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Address of our node</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = <span class="hljs-number">0</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -即 </font><font style="vertical-align: inherit;">这是网络的根设备。</font><font style="vertical-align: inherit;">如有必要，可以更改代理控制器拓扑中的位置。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus示例RF24从站</font></font></b><div class="spoiler_text">    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Arduino &amp; Modbus</a>:<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24Network.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtu.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtuRF24.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ID   1      <span class="hljs-comment">//  </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> btnPin  2   <span class="hljs-comment">//  ,   </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ledPin  7  <span class="hljs-comment">//   </span></span><font></font>
<font></font>
<span class="hljs-comment">// nRF24L01(+) radio attached using Getting Started board </span>
<span class="hljs-function">RF24 <span class="hljs-title">radio</span><span class="hljs-params">(<span class="hljs-number">9</span>, <span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Network uses that radio</span>
<span class="hljs-function">RF24Network <span class="hljs-title">network</span><span class="hljs-params">(radio)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Address of our node</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = ID;<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">slave</span><span class="hljs-params">(network, ID)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">//   modbus</span>
<span class="hljs-keyword">uint16_t</span> au16data[<span class="hljs-number">11</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_setup</span><span class="hljs-params">()</span> </span>{<font></font>
    digitalWrite(ledPin, LOW);<font></font>
    pinMode(ledPin, OUTPUT);<font></font>
    pinMode(btnPin, INPUT);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_poll</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// Coil[1]  Discrete[0]</span>
    au16data[<span class="hljs-number">0</span>] = au16data[<span class="hljs-number">1</span>];
    <span class="hljs-comment">//   1.3   </span>
    digitalWrite(ledPin, bitRead(au16data[<span class="hljs-number">1</span>], <span class="hljs-number">3</span>));
    <span class="hljs-comment">//     0.3</span>
    bitWrite(au16data[<span class="hljs-number">0</span>], <span class="hljs-number">3</span>, digitalRead(btnPin));
    <span class="hljs-comment">// Holding[5,6,7]  Input[2,3,4]</span>
    au16data[<span class="hljs-number">2</span>] = au16data[<span class="hljs-number">5</span>];<font></font>
    au16data[<span class="hljs-number">3</span>] = au16data[<span class="hljs-number">6</span>];<font></font>
    au16data[<span class="hljs-number">4</span>] = au16data[<span class="hljs-number">7</span>];
    <span class="hljs-comment">//    </span>
    au16data[<span class="hljs-number">8</span>] = slave.getInCnt();<font></font>
    au16data[<span class="hljs-number">9</span>] = slave.getOutCnt();<font></font>
    au16data[<span class="hljs-number">10</span>] = slave.getErrCnt();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">//    </span><font></font>
    io_setup();<font></font>
<font></font>
    Serial.begin(<span class="hljs-number">57600</span>);<font></font>
    Serial.println(<span class="hljs-string">"RF24Network/examples/modbus_slave/"</span>);<font></font>
<font></font>
    SPI.begin();<font></font>
    radio.begin();<font></font>
    network.begin(<span class="hljs-comment">/*channel*/</span> <span class="hljs-number">90</span>, <span class="hljs-comment">/*node address*/</span> this_node);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">// Pump the network regularly</span><font></font>
    network.update();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (network.available()) {<font></font>
        slave.poll(au16data, <span class="hljs-number">11</span>);<font></font>
    }<font></font>
    <span class="hljs-comment">//    Modbus    </span><font></font>
    io_poll();<font></font>
}<font></font>
</code></pre><br>
<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这种情况下，构造函数已经不同：</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  </span>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">slave</span><span class="hljs-params">(network, ID)</span></span>;
</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus寄存器结构</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在第一次成功地尝试控制空调的能力之后，我的食欲却增加了。</font><font style="vertical-align: inherit;">现在这还不够，并且由于我的移动应用程序中具有OpenHAB功能，因此它至少应具有本机控制面板的所有功能。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这意味着这里至少是功能列表：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当前状态指示</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">打开和关闭空调，各种模式（O </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，电离，静音模式）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当前模式的选择（自动，加热，冷却，排水，风扇）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示每种模式的温度和风扇速度。</font><font style="vertical-align: inherit;">对于风扇模式，只有速度；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">垂直窗帘设置（自动，0°，15°，30°，45°，60°）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">水平窗帘设置（自动，“ | |”，“ / /”，“ / |”，“ | \”，“ \ \”）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时间设置（小时，分钟）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在计时器设置上；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关机定时器设置；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">准时设置（小时，分钟）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关机时间设置（小时，分钟）；</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在开发过程中，寄存器的结构对我来说已经改变了很多次。</font><font style="vertical-align: inherit;">当前版本在扰流板下方。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus寄存器</font></font></b><div class="spoiler_text"><table>
<tbody><tr>
<th>Type</th>
<th>Byte</th>
<th>Bit</th>
<th>Name</th>
<th></th>
</tr>
<tr>
<td>Bit RO</td>
<td>0</td>
<td>0</td>
<td>CFG_OXYGEN</td>
<td>1 —   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>1</td>
<td>CFG_ION</td>
<td>1 —   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>2</td>
<td>CFG_QUIET</td>
<td>1 —   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>3</td>
<td>CFG_TIMER</td>
<td>1 —  /   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>4</td>
<td>CFG_DELAY</td>
<td>1 —   /</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>5</td>
<td>CFG_SWING</td>
<td>1 —   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>6</td>
<td>CFG_SWINGH</td>
<td>1 —    </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>7</td>
<td>CFG_SWINGV</td>
<td>1 —    </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>8</td>
<td>CFG_CLOCK</td>
<td>1 —  </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>9</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>10</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>11</td>
<td>CFG_AUTO</td>
<td>1 —   AUTO</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>12</td>
<td>CFG_COOL</td>
<td>1 —   COOL</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>13</td>
<td>CFG_HEAT</td>
<td>1 —   HEAT</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>14</td>
<td>CFG_DRY</td>
<td>1 —   DRY</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>15</td>
<td>CFG_FAN</td>
<td>1 —   FAN</td>
</tr>
<tr>
<td>Integer RO</td>
<td>1</td>
<td></td>
<td>CFG_TEMP</td>
<td>.  . : Min + Max*256</td>
</tr>
<tr>
<td>Integer RO</td>
<td>2</td>
<td></td>
<td>CFG_FAN_SPEED</td>
<td>  FAN</td>
</tr>
<tr>
<td>Bit RO</td>
<td>3</td>
<td>0</td>
<td>STATE_POWER</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>1</td>
<td>STATE_OXYGEN</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>2</td>
<td>STATE_ION</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>3</td>
<td>STATE_QUIET</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>4</td>
<td>STATE_TIMER</td>
<td>:0 — , 1 — </td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>8</td>
<td>CONTROL_POWER</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>9</td>
<td>CONTROL_OXYGEN</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>10</td>
<td>CONTROL_ION</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>11</td>
<td>CONTROL_QUIET</td>
<td></td>
</tr>
<tr>
<td>Integer RO</td>
<td>4</td>
<td></td>
<td>RTC_HR_MI</td>
<td>0x1308</td>
</tr>
<tr>
<td>Integer RW</td>
<td>5</td>
<td></td>
<td>RTCW_HR_MI</td>
<td>0x1308</td>
</tr>
<tr>
<td>Integer RO</td>
<td>6</td>
<td></td>
<td>TEMPERATURE1</td>
<td> . INT16,   </td>
</tr>
<tr>
<td>Integer RO</td>
<td>7</td>
<td></td>
<td>TEMPERATURE2</td>
<td> . INT16,   </td>
</tr>
<tr>
<td>Bit RW</td>
<td>8</td>
<td>0</td>
<td>MODE_AUTO</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>MODE_COOL</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>MODE_HEAT</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>MODE_DRY</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>MODE_FAN</td>
<td></td>
</tr>
<tr>
<td>Integer RW</td>
<td>9</td>
<td></td>
<td>TEMP_AUTO</td>
<td> AUTO</td>
</tr>
<tr>
<td>Integer RW</td>
<td>10</td>
<td></td>
<td>TEMP_COOL</td>
<td> COOL</td>
</tr>
<tr>
<td>Integer RW</td>
<td>11</td>
<td></td>
<td>TEMP_HEAT</td>
<td> HEAT</td>
</tr>
<tr>
<td>Integer RW</td>
<td>12</td>
<td></td>
<td>TEMP_DRY</td>
<td> DRY</td>
</tr>
<tr>
<td>Integer RW</td>
<td>13</td>
<td></td>
<td>FAN_AUTO</td>
<td> AUTO. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>14</td>
<td></td>
<td>FAN_COOL</td>
<td> COOL. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>15</td>
<td></td>
<td>FAN_HEAT</td>
<td> HEAT. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>16</td>
<td></td>
<td>FAN_DRY</td>
<td> DRY. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>17</td>
<td></td>
<td>FAN_SPEED</td>
<td> FAN. 0: Auto</td>
</tr>
<tr>
<td>Bit RW</td>
<td>18</td>
<td>0</td>
<td>SWING_AUTO</td>
<td> </td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>SWINGV_0</td>
<td>   0°</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>SWINGV_15</td>
<td>   15°</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>SWINGV_30</td>
<td>   30°</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>SWINGV_45</td>
<td>   45°</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>5</td>
<td>SWINGV_60</td>
<td>   60°</td>
</tr>
<tr>
<td>Bit RW</td>
<td>19</td>
<td>0</td>
<td>SWINGH_AUTO</td>
<td> </td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>SWINGH_VV</td>
<td>  | &nbsp;|</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>SWINGH_LL</td>
<td>  / &nbsp;/</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>SWINGH_LV</td>
<td>  / &nbsp;|</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>SWINGH_VR</td>
<td>  | &nbsp;\</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>5</td>
<td>SWINGH_RR</td>
<td>  \ &nbsp;\</td>
</tr>
<tr>
<td>Bit RW</td>
<td>20</td>
<td>0</td>
<td>TIMER_ON</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>TIMER_OFF</td>
<td></td>
</tr>
<tr>
<td>Integer RW</td>
<td>21</td>
<td></td>
<td>TIME_ON_HOUR</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>22</td>
<td></td>
<td>TIME_ON_MINUTE</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>23</td>
<td></td>
<td>TIME_OFF_HOUR</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>24</td>
<td></td>
<td>TIME_OFF_MINUTE</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>25</td>
<td></td>
<td>DS18B20_ENV</td>
<td>. </td>
</tr>
<tr>
<td>Integer RW</td>
<td>26</td>
<td></td>
<td>DS18B20_NOZ</td>
<td>. </td>
</tr>
</tbody></table><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
寄存器的组织方式是，当控制器启动时，整个数据阵列从EEPROM初始化。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前三个寄存器（CFG_ *）包含功能的配置，它们永不更改，并由EEPROM固件初始化。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
寄存器3-7始终显示控制器的当前状态。寄存器3的高位用于改变状态。他们的更改启动了空调的开/关和特殊模式。执行该命令后，该寄存器的低位复制到高位。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
寄存器4包含当前控制器时间，可从RTC读取。该值以BCD格式保存，因此当该寄存器以十六进制表示时，将按原样读取时间-12:34为0x1234。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
寄存器5用于更改RTC时间。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
寄存器6-7包含DS18B20传感器的温度。</font><font style="vertical-align: inherit;">该值包含一个有符号整数，等于T * 100，即 </font><font style="vertical-align: inherit;">25.67°C = 2567。</font><font style="vertical-align: inherit;">最多提供2个传感器，但是通过扩展寄存器表以存储传感器的地址及其温度可以轻松更改数量。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
传感器地址的最后2个字节存储在寄存器25-26中。</font><font style="vertical-align: inherit;">更换传感器时，请重置相应的地址寄存器。</font><font style="vertical-align: inherit;">当检测到新传感器时，将检查其地址是否在寄存器25-26中。</font><font style="vertical-align: inherit;">如果地址在表中，则传感器的温度值输入到相应的寄存器6-7中。</font><font style="vertical-align: inherit;">如果该地址不在表中，并且该表具有零个单元格，则将当前传感器地址写入空闲单元格中。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用户修改后的寄存器8-26将保存在EEPROM中。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">腺体</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
硬件包括以下组件：</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Pro迷你版。 </font></font><div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><img src="https://habrastorage.org/files/e8a/460/33b/e8a46033b9cf45609d87e9a08f9f4ba9.png" alt="Arduino Pro Mini NEW"></div></div></li>
<li>NRF24L01+ —   2.4</li>
<li>LM1117-3.3 —  3.3  NRF24L01+</li>
<li>DS1302 — RTC</li>
<li> 32768  RTC</li>
<li>DS18B20 —  . 2</li>
<li> — , , </li>
</ol><br>
<br>
<img src="https://habrastorage.org/files/b4f/6f2/357/b4f6f2357e044c78a3472d4d6b25ad07.jpg"><br>
<img src="https://habrastorage.org/files/025/6de/902/0256de902fed444682fc2e16f3e9be88.jpg"><br>
<img src="https://habrastorage.org/files/e45/604/4aa/e456044aabe0499c9b8016d908411434.jpg"><br>
<img src="https://habrastorage.org/files/3f2/818/d9a/3f2818d9af814ffba67ed9e271c1450d.jpg"><br>
<img src="https://habrastorage.org/files/f76/385/124/f76385124e4e4c2ca573b268365f5e40.jpg"><br>
<img src="https://habrastorage.org/files/be6/ded/b3c/be6dedb3c93a40fe9841a17dead1b723.jpg"><br>
<img src="https://habrastorage.org/files/80a/50c/1b7/80a50c1b7e154c87ae07296e704d6674.jpg"><br>
<img src="https://habrastorage.org/files/a5b/f61/96e/a5bf6196ee764f90bf535df517477363.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过将光耦合器连接到相应的LED来实现空调的反馈。因此，确保了与空调的电路的电流隔离。通过使用电阻器实验性地选择了光耦合器输入的电流，以使光耦合器的输出打开，并且空调上的主LED的亮度不会降低。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在空调的红外接收器旁边安装了一个红外LED。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该控制器由来自中国奇迹的mini-USB充电供电。从充电盒中移除了中国市电电压触点，并移除了电线。充电本身落在空调机外壳的肠道内，并与输入端220并联。控制器使用常规USB AB电缆连接至充电。</font></font><br>
<br>
 «»    Arduino Mega2560  NRF24L01+   LM1117-3.3.    3.3     (    470*16)   .      2560  3.3       ,    .           . <br>
 2560       USB     10 .<br>
<br>
<h4>OpenHAB</h4><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Arduino &amp; OpenHAB</a>    Modbus Binding,     ,     ,     .      .<br>
<br>
<div class="spoiler"><b class="spoiler_title">  Modbus Binding</b><div class="spoiler_text">#<br>
modbus:serial.ac_hall_state.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_state.id=1<br>
modbus:serial.ac_hall_state.start=48<br>
modbus:serial.ac_hall_state.length=5<br>
modbus:serial.ac_hall_state.type=discrete<br>
<br>
#<br>
modbus:serial.ac_hall_power.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_power.id=1<br>
modbus:serial.ac_hall_power.start=56<br>
modbus:serial.ac_hall_power.length=4<br>
modbus:serial.ac_hall_power.type=coil<br>
<br>
#<br>
modbus:serial.ac_hall_rtc.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_rtc.id=1<br>
modbus:serial.ac_hall_rtc.start=4<br>
modbus:serial.ac_hall_rtc.length=1<br>
modbus:serial.ac_hall_rtc.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_temperature.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_temperature.id=1<br>
modbus:serial.ac_hall_temperature.start=6<br>
modbus:serial.ac_hall_temperature.length=2<br>
modbus:serial.ac_hall_temperature.type=holding<br>
modbus:serial.ac_hall_temperature.valuetype=int16<br>
<br>
#<br>
modbus:serial.ac_hall_mode.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_mode.id=1<br>
modbus:serial.ac_hall_mode.start=8<br>
modbus:serial.ac_hall_mode.length=1<br>
modbus:serial.ac_hall_mode.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_temp.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_temp.id=1<br>
modbus:serial.ac_hall_temp.start=9<br>
modbus:serial.ac_hall_temp.length=4<br>
modbus:serial.ac_hall_temp.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_fan.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_fan.id=1<br>
modbus:serial.ac_hall_fan.start=13<br>
modbus:serial.ac_hall_fan.length=5<br>
modbus:serial.ac_hall_fan.type=holding<br>
<br>
#<br>
modbus:serial.ac_hall_swing.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_swing.id=1<br>
modbus:serial.ac_hall_swing.start=18<br>
modbus:serial.ac_hall_swing.length=2<br>
modbus:serial.ac_hall_swing.type=holding<br>
<br>
#<br>
modbus:serial.ac_hall_timer.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_timer.id=1<br>
modbus:serial.ac_hall_timer.start=320<br>
modbus:serial.ac_hall_timer.length=2<br>
modbus:serial.ac_hall_timer.type=coil<br>
<br>
# <br>
modbus:serial.ac_hall_timer_time.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_timer_time.id=1<br>
modbus:serial.ac_hall_timer_time.start=21<br>
modbus:serial.ac_hall_timer_time.length=4<br>
modbus:serial.ac_hall_timer_time.type=holding<br>
<br>
#  DS18B20<br>
modbus:serial.ac_hall_ds18b20.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_ds18b20.id=1<br>
modbus:serial.ac_hall_ds18b20.start=25<br>
modbus:serial.ac_hall_ds18b20.length=2<br>
modbus:serial.ac_hall_ds18b20.type=holding<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"> items</b><div class="spoiler_text"><pre>Contact AC_HALL_STATE_POWER             "AC_HALL_STATE_POWER [MAP(air_cond.map):%s]"    (){modbus="ac_hall_state:0"}<font></font>
Contact AC_HALL_STATE_OXYGEN            "AC_HALL_STATE_OXYGEN [MAP(air_cond.map):%s]"   (){modbus="ac_hall_state:1"}<font></font>
Contact AC_HALL_STATE_ION               "AC_HALL_STATE_ION [MAP(air_cond.map):%s]"      (){modbus="ac_hall_state:2"}<font></font>
Contact AC_HALL_STATE_QUIET             "AC_HALL_STATE_QUIET [MAP(air_cond.map):%s]"    (){modbus="ac_hall_state:3"}<font></font>
Contact AC_HALL_STATE_TIMER             "[MAP(air_cond.map):%s]"                  (){modbus="ac_hall_state:4"}<font></font>
<font></font>
Switch  AC_HALL_CONTROL_POWER           ""                   &lt;climate&gt;       (){modbus="ac_hall_power:0"}<font></font>
Switch  AC_HALL_CONTROL_OXYGEN          " O2"                                  (){modbus="ac_hall_power:1"}<font></font>
Switch  AC_HALL_CONTROL_ION             ""                                     (){modbus="ac_hall_power:2"}<font></font>
Switch  AC_HALL_CONTROL_QUIET           " "                                   (){modbus="ac_hall_power:3"}<font></font>
<font></font>
Number  AC_HALL_RTC                     "RTC[%x]"                                       (){modbus="ac_hall_rtc:0"}<font></font>
String  AC_HALL_RTC_S                   " [%s]"         &lt;clock&gt;         ()<font></font>
<font></font>
Group   gAC_HALL_TEMPERATURE            "Living Room temp"<font></font>
<font></font>
Number  AC_HALL_TEMPERATURE_ENV         "[%d]"                                   (){modbus="ac_hall_temperature:0"}<font></font>
Number  AC_HALL_TEMPERATURE_NOZ         "[%d]"                                     (){modbus="ac_hall_temperature:1"}<font></font>
Number  AC_HALL_TEMPERATURE_ENVF        " [%.2f °C]"     &lt;temperature&gt;           (gAC_HALL_TEMPERATURE)<font></font>
Number  AC_HALL_TEMPERATURE_NOZF        " [%.2f °C]"       &lt;temperature&gt;           (gAC_HALL_TEMPERATURE)<font></font>
<font></font>
Number  AC_HALL_DS18B20_ENV             "ENV[%x]"                                       (){modbus="ac_hall_ds18b20:0"}<font></font>
Number  AC_HALL_DS18B20_NOZ             "NOZZLES[%x]"                                   (){modbus="ac_hall_ds18b20:1"}<font></font>
<font></font>
Number  AC_HALL_MODE                    ""                                              (){modbus="ac_hall_mode:0"}<font></font>
<font></font>
Number  AC_HALL_TEMP_AUTO               "[%d °C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:0"}<font></font>
Number  AC_HALL_TEMP_COOL               "[%d °C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:1"}<font></font>
Number  AC_HALL_TEMP_HEAT               "[%d °C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:2"}<font></font>
Number  AC_HALL_TEMP_DRY                "[%d °C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:3"}<font></font>
<font></font>
Number  AC_HALL_FAN_AUTO                "[%d]"                                  (){modbus="ac_hall_fan:0"}<font></font>
Number  AC_HALL_FAN_COOL                "[%d]"                                  (){modbus="ac_hall_fan:1"}<font></font>
Number  AC_HALL_FAN_HEAT                "[%d]"                                  (){modbus="ac_hall_fan:2"}<font></font>
Number  AC_HALL_FAN_DRY                 "[%d]"                                  (){modbus="ac_hall_fan:3"}<font></font>
Number  AC_HALL_FAN_SPEED               "[%d]"                                  (){modbus="ac_hall_fan:4"}<font></font>
<font></font>
Number  AC_HALL_SWINGV                  ""                                              (){modbus="ac_hall_swing:0"}<font></font>
Number  AC_HALL_SWINGH                  ""                                              (){modbus="ac_hall_swing:1"}<font></font>
<font></font>
Switch  AC_HALL_TIMER_ON                " "              &lt;clock&gt;         (){modbus="ac_hall_timer:0"}<font></font>
Switch  AC_HALL_TIMER_OFF               " "             &lt;clock&gt;         (){modbus="ac_hall_timer:1"}<font></font>
<font></font>
Number  AC_HALL_TIME_ON_HR              "[%02d]"                                     (){modbus="ac_hall_timer_time:0"}<font></font>
Number  AC_HALL_TIME_ON_MI              "[%02d]"                                  (){modbus="ac_hall_timer_time:1"}<font></font>
Number  AC_HALL_TIME_OFF_HR             "[%02d]"                                     (){modbus="ac_hall_timer_time:2"}<font></font>
Number  AC_HALL_TIME_OFF_MI             "[%02d]"                                  (){modbus="ac_hall_timer_time:3"}<font></font>
</pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
规则用于将整数温度转换为实际温度，以及将控制器时间格式化为HH：MM格式。</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">规则设定</font></font></b><div class="spoiler_text"><pre>import org.openhab.core.library.types.*<font></font>
import org.openhab.core.persistence.*<font></font>
import org.openhab.model.script.actions.*<font></font>
import java.io.File<font></font>
<font></font>
rule "Update AC_HALL ENV temp"<font></font>
        when<font></font>
                Item AC_HALL_TEMPERATURE_ENV received update<font></font>
        then<font></font>
                var Number T = AC_HALL_TEMPERATURE_ENV.state as DecimalType<font></font>
                var Number H = T/100<font></font>
                postUpdate(AC_HALL_TEMPERATURE_ENVF, H)<font></font>
end<font></font>
rule "Update AC_HALL NOZZLES temp"<font></font>
        when<font></font>
                Item AC_HALL_TEMPERATURE_NOZ received update<font></font>
        then<font></font>
                var Number T = AC_HALL_TEMPERATURE_NOZ.state as DecimalType<font></font>
                var Number H = T/100<font></font>
                postUpdate(AC_HALL_TEMPERATURE_NOZF, H)<font></font>
end<font></font>
rule "Update AC_HALL_RTC clock"<font></font>
        when<font></font>
                Item AC_HALL_RTC received update<font></font>
        then<font></font>
                var Number T = AC_HALL_RTC.state as DecimalType<font></font>
                var H = T.intValue / 256<font></font>
                var M = T.intValue % 256<font></font>
                var S = String::format("%02x:%02x",H,M)<font></font>
                postUpdate(AC_HALL_RTC_S, S)<font></font>
end<font></font>
</pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">站点地图设置</font></font></b><div class="spoiler_text"><pre>sitemap demo label="Demo House"{<font></font>
        Frame label="HOME"{<font></font>
                Text label=" " icon="ac_cond"{<font></font>
                        Frame label="" {<font></font>
                                Switch item= AC_HALL_CONTROL_POWER labelcolor=[AC_HALL_STATE_POWER==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_OXYGEN labelcolor=[AC_HALL_STATE_OXYGEN==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_ION labelcolor=[AC_HALL_STATE_ION==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_QUIET labelcolor=[AC_HALL_STATE_QUIET==OPEN="blue"]<font></font>
                                Text item=AC_HALL_STATE_TIMER labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"] icon="clock-on"<font></font>
                                Text item=AC_HALL_RTC_S<font></font>
                                Text item=AC_HALL_TEMPERATURE_ENVF<font></font>
                                Text item=AC_HALL_TEMPERATURE_NOZF<font></font>
                        }<font></font>
<font></font>
                        Frame label=""{<font></font>
                                Selection item=AC_HALL_MODE label="" mappings=[1=AUTO, 2=COOL, 4=HEAT, 8=DRY, 16=FAN]<font></font>
                                Text item=AC_HALL_TEMP_AUTO visibility=[AC_HALL_MODE==1]<font></font>
                                Text item=AC_HALL_TEMP_COOL visibility=[AC_HALL_MODE==2]<font></font>
                                Text item=AC_HALL_TEMP_HEAT visibility=[AC_HALL_MODE==4]<font></font>
                                Text item=AC_HALL_TEMP_DRY visibility=[AC_HALL_MODE==8]<font></font>
<font></font>
                                Text item=AC_HALL_FAN_AUTO visibility=[AC_HALL_MODE==1]<font></font>
                                Text item=AC_HALL_FAN_COOL visibility=[AC_HALL_MODE==2]<font></font>
                                Text item=AC_HALL_FAN_HEAT visibility=[AC_HALL_MODE==4]<font></font>
                                Text item=AC_HALL_FAN_DRY visibility=[AC_HALL_MODE==8]<font></font>
                                Text item=AC_HALL_FAN_SPEED visibility=[AC_HALL_MODE==16]<font></font>
<font></font>
                                Selection item=AC_HALL_SWINGV label="" mappings=[1=AUTO, 2="0°", 4="15°", 8="30°", 16="45°", 32="60°"]<font></font>
                                Selection item=AC_HALL_SWINGH label="" mappings=[1=AUTO, 4="/   /", 8="/   |", 2="|   |", 16="|   \\", 32="\\   \\"]<font></font>
<font></font>
                                Text label="" icon="settings"{<font></font>
                                        Frame label="AUTO"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_AUTO minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_AUTO mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="COOL"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_COOL minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_COOL mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="HEAT"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_HEAT minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_HEAT mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="DRY"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_DRY minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_DRY mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="FAN"{<font></font>
                                                Switch item=AC_HALL_FAN_SPEED mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label=""{<font></font>
                                                Text item=AC_HALL_DS18B20_ENV<font></font>
                                                Text item=AC_HALL_DS18B20_NOZ<font></font>
                                        }<font></font>
                                }<font></font>
                        }<font></font>
                        Frame label="" {<font></font>
                                Switch item= AC_HALL_TIMER_ON labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"]<font></font>
                                Setpoint item=AC_HALL_TIME_ON_HR minValue=0 maxValue=23 step=1<font></font>
                                Setpoint item=AC_HALL_TIME_ON_MI minValue=0 maxValue=50 step=5<font></font>
<font></font>
                                Switch item= AC_HALL_TIMER_OFF labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"]<font></font>
                                Setpoint item=AC_HALL_TIME_OFF_HR minValue=0 maxValue=23 step=1<font></font>
                                Setpoint item=AC_HALL_TIME_OFF_MI minValue=0 maxValue=50 step=5<font></font>
                        }<font></font>
                }<font></font>
                Text item=AC_HALL_RTC_S<font></font>
                Text item=AC_HALL_TEMPERATURE_ENVF{<font></font>
                        Frame label=" "{<font></font>
                                Chart item=gAC_HALL_TEMPERATURE period=h refresh=60000<font></font>
                        }<font></font>
                        Frame label=" 4 " {<font></font>
                                Chart item=gAC_HALL_TEMPERATURE period=4h refresh=600000<font></font>
                        }<font></font>
                }<font></font>
        }<font></font>
}<font></font>
</pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果通过浏览器看起来像这样：</font></font><br>
<img align="left" src="https://habrastorage.org/files/5c0/129/0f3/5c01290f365b47399e9b16123c21f6fa.png"><img align="left" src="https://habrastorage.org/files/634/45b/94b/63445b94b4ab47349482b85667313e10.png"><img align="left" src="https://habrastorage.org/files/09c/8cb/8ff/09c8cb8ffb8240349ce57e8c7ccc6629.png"><br clear="all">
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为大象，我对结果感到满意。现在，无论有移动互联网还是WiFI，都可以使用空调控制。使用智能手机上的VPN客户端，我可以通过浏览器和移动应用程序访问我的家庭服务器上的OpenHAB。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
无线解决方案使将控制器与空调紧密集成成为可能。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
反馈的存在使您确信所发送的命令已被空调接收，并且温度传感器清楚地表明了这一点-几秒钟后，您可以观察到空调出口处的温度读数变化。好吧，几分钟后-和环境温度。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在接近给定条件时观察空调的轮廓很有趣。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
毫无疑问，这将不是我计划使用的唯一无线控制器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有计划使用空调本身的IR接收器读取本地遥控器的命令以更新控制器中的设置。</font><font style="vertical-align: inherit;">此外，IR接收器本身已经通过光耦合器连接到控制器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后阅读特别的谢谢！</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino库ModbusRtu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Master-Slave-for-Arduino</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino库ModbusRtuRF24 </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">-</font></a><font style="vertical-align: inherit;"> RF24上的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Arduino网络</font></font></a></li>
</ol></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN384243/">https://habr.com/ru/post/zh-CN384243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN384229/index.html">阅读后适用。为游戏开发者准备的25本书</a></li>
<li><a href="../zh-CN384231/index.html">如果没人需要天然铀，那么如何进行浓缩呢？</a></li>
<li><a href="../zh-CN384235/index.html">无人机将在2020年打开俄罗斯的天空</a></li>
<li><a href="../zh-CN384239/index.html">回顾《星球大战》的机器人Sphero BB-8</a></li>
<li><a href="../zh-CN384241/index.html">Emercoin：加密货币和数字密钥合而为一</a></li>
<li><a href="../zh-CN384247/index.html">意见：Twitter共享测试软件</a></li>
<li><a href="../zh-CN384249/index.html">一系列有用的设备：5个在办公室有用的小工具</a></li>
<li><a href="../zh-CN384251/index.html">机器人和人。从内容到形式</a></li>
<li><a href="../zh-CN384253/index.html">长颈鹿神经网络学会了在72小时内以国际FIDE大师的水平下棋</a></li>
<li><a href="../zh-CN384257/index.html">餐馆如何创建网站：4种设计解决方案</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>