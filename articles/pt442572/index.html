<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìª üåñ üòá Usando a ferramenta de configura√ß√£o do Datapath ü§≤üèæ üçù üêü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Temos que dar o pen√∫ltimo passo no desenvolvimento pr√°tico do trabalho com o UDB. Hoje n√£o desenvolveremos o uso do UDB Editor automatizado, mas no mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando a ferramenta de configura√ß√£o do Datapath</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442572/"><img src="https://habrastorage.org/webt/fu/yo/23/fuyo230rbfhla_li8ryzzngttlw.jpeg"><br><br>  Temos que dar o pen√∫ltimo passo no desenvolvimento pr√°tico do trabalho com o UDB.  Hoje n√£o desenvolveremos o uso do UDB Editor automatizado, mas no modo semi-manual, usando a ferramenta de configura√ß√£o do Datapath.  Uma ajuda muito boa para dominar essa ferramenta √© AN82156 - PSoC 3, PSoC 4 e PSoC 5LP - Design de componentes do PSoC Creator com Datapaths UDB.  Na verdade, eu mesmo estudei. <br><a name="habracut"></a><br>  Talvez, ao ler nossas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tradu√ß√µes de documenta√ß√£o no UDB</a> , algu√©m tenha tentado reproduzir o conhecimento de l√° em pr√°tica e tenha notado que nem toda a funcionalidade descrita nas publica√ß√µes est√° dispon√≠vel no Editor do UDB.  Isso se deve ao fato de que os desenvolvedores n√£o come√ßaram a colocar alguns mecanismos particularmente pesados ‚Äã‚Äãno UDB Editor.  Os autores do AN82156 argumentam que, atrav√©s do UDB Editor, voc√™ n√£o pode fazer o seguinte: <br><br><ul><li>  organizar entrada e sa√≠da de dados paralelos; </li><li>  organizar gerenciamento FIFO din√¢mico; </li><li>  implementar o inverso do sinal do rel√≥gio FIFO; </li><li>  implementar a fun√ß√£o CRC; </li><li>  implementar a fun√ß√£o PRS; </li><li>  implementar a escolha da transfer√™ncia de entrada; </li><li>  implementar migra√ß√£o din√¢mica de entrada. </li></ul><br>  De minha parte, acrescentarei que n√£o encontrei como implementar a permuta√ß√£o de petiscos no Editor UDB. <br><br>  Se essas fun√ß√µes forem necess√°rias no projeto, voc√™ precisar√° criar seu pr√≥prio c√≥digo Verilog.  Eu usei especificamente a palavra "criar" em vez de "escrever".  Conhecer esta linguagem de programa√ß√£o √© suficiente no n√≠vel de leitura.  Quero dizer, voc√™ precisa entender qual design √© necess√°rio para o que.  E poder escrever do zero √© sempre √∫til, mas essa habilidade n√£o √© necess√°ria para o que √© apresentado neste artigo. <br><br>  Como um problema solucion√°vel, escolhi um estojo semi-sint√©tico.  Em geral, decidi enviar alguns dados para a porta paralela e, em particular, pelo que est√° √† m√£o, o LCD de texto tem uma porta paralela.  Tirei-o da impressora 3D MZ3D h√° tr√™s anos quando transplantei o √∫ltimo para o STM32.  Portanto, o caso √© semi-sint√©tico: hoje, esses indicadores geralmente t√™m uma entrada I2C e n√£o precisam se conectar atrav√©s de uma pilha de fios na vida real.  No entanto, os LCDs modernos tamb√©m t√™m portas paralelas, para que todos possam us√°-los para repetir o experimento. <br><br>  Considere o esquema de troca de exibi√ß√£o retirado de reprap.org (isso n√£o foi f√°cil, meu provedor bloqueia este site, al√©m de v√°rios outros t√©cnicos, motivando-o com o fato de que ele vive no mesmo IP de algu√©m bloqueado). <br><br><img src="https://habrastorage.org/webt/0x/th/ry/0xthryzxadx_9guzmhdyhrxnzty.png"><br><br>  √ìtimo layout!  Em primeiro lugar, n√£o preciso pensar em ler: os dados no LCD s√≥ podem ser gravados (a linha R / W √© aterrada e n√£o est√° dispon√≠vel no conector).  Em segundo lugar, os dados v√™m em um formato de 4 bits, o que significa que n√£o apenas podemos calcular a sa√≠da paralela, mas tamb√©m verificar a opera√ß√£o da fun√ß√£o de permuta√ß√£o de mordidelas. <br><br><h2>  Cria√ß√£o de projeto </h2><br>  Ent√£o, inicie o PSoC Creator e selecione <b>Arquivo-&gt; Novo-&gt; Projeto</b> : <br><br><img src="https://habrastorage.org/webt/pv/ma/tv/pvmatvfviveyo4fa822osy45p2c.png"><br><br>  Em seguida, escolho minha t√°bua de p√£o: <br><br><img src="https://habrastorage.org/webt/dv/st/hi/dvsthib82j6ynrdxc0sk-5j20nk.png"><br><br>  A seguir est√° o diagrama vazio: <br><br><img src="https://habrastorage.org/webt/oi/fx/vv/oifxvvsf0qye7j-mdyoxmbfux4q.png"><br><br>  Vou chamar o projeto <b>LCDTest2</b> : <br><br><img src="https://habrastorage.org/webt/qs/3f/rl/qs3frlgxrnzqzqrzzfryptvjfqq.png"><br><br>  Agora, como antes, v√° para a guia <b>Componentes</b> : <br><br><img src="https://habrastorage.org/webt/wq/nb/bo/wqnbboubijieyovk7akrat6piik.png"><br><br>  E, ap√≥s selecionar o projeto, pressione o bot√£o direito do mouse e selecione <b>Adicionar item do componente</b> . <br><br><img src="https://habrastorage.org/webt/hi/fu/hv/hifuhvearnltnfz2dvmhwtzgw4o.png"><br><br>  E aqui voc√™ tem que escolher o <b>Assistente de s√≠mbolo</b> .  D√™ um nome ... Bem, digamos <b>LCD4bit</b> . <br><br><img src="https://habrastorage.org/webt/59/f0/g3/59f0g3lya8ado4kcxgj6lcsxggk.png"><br><br>  Atribu√≠ as seguintes portas ao s√≠mbolo: <br><br><img src="https://habrastorage.org/webt/6a/jr/uo/6ajruo1io2jusjunhameiumtb20.png"><br><br>  <b>clk</b> √© a entrada do rel√≥gio.  Portas com um prefixo de LCD s√£o portas LCD padr√£o.  <b>Com fome</b> - sa√≠das informando √† unidade DMA que existe espa√ßo livre no FIFO, a id√©ia foi discutida em um artigo sobre como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">controlar LEDs RGB</a> .  Clique em OK para obter o personagem. <br><br><img src="https://habrastorage.org/webt/ze/fq/5z/zefq5z65eq0i4mq21y2d3jip7t4.png"><br><br>  Agora, com base neste s√≠mbolo, um modelo Verilog deve ser gerado.  Clique com o bot√£o direito do mouse nas proximidades do s√≠mbolo e selecione <b>Gerar Verilog</b> no menu de contexto. <br><br><img src="https://habrastorage.org/webt/h9/k7/oo/h9k7oogp_wqsdfugdg-8bdr_hru.png"><br><br>  Temos o modelo mostrado na figura abaixo (no formato de texto ainda n√£o faz sentido): <br><br><img src="https://habrastorage.org/webt/ax/t9/k-/axt9k-s-zfi2kfd7qdz9pe-zlqq.png"><br><br>  Criamos um m√≥dulo e algumas se√ß√µes.  Mas eles n√£o criaram o Datapath ainda.  Para adicion√°-lo, v√° para a √°rvore do projeto, selecione o arquivo <b>LCD4bit.v</b> , pressione o bot√£o direito do mouse e selecione a <b>Ferramenta de Configura√ß√£o</b> do <b>Datapath</b> no menu de contexto que aparece: <br><br><img src="https://habrastorage.org/webt/z2/1g/5w/z21g5wom4_-yq_nmcjlhvb3irg0.png"><br><br>  Uma janela se abre diante de n√≥s, que por enquanto mostrarei apenas parcialmente: <br><br><img src="https://habrastorage.org/webt/m0/fz/9i/m0fz9idl6xt5rimcittxpme2iea.png"><br><br>  Por favor, ame e favor, editor do Datapath.  Ele cont√©m todos os bits que foram descritos na tradu√ß√£o da documenta√ß√£o propriet√°ria.  Mas h√° tantas dessas partes que, nos primeiros dias, eu olhei para ele, mas tinha medo de fazer qualquer coisa.  Olha, olha e sai.  E s√≥ depois de algum tempo, se acostumando, ele come√ßou a tentar fazer alguma coisa.  Na verdade, foi por isso que trouxe apenas parte da janela.  Por que assustar todo mundo antes do tempo?  Enquanto isso, precisamos apenas criar um Datapath, portanto, selecionamos o item de menu <b>Editar-&gt; Novo Datapath</b> : <br><br><img src="https://habrastorage.org/webt/-n/dx/vj/-ndxvjk_wrpdjucuq0_c3jcqfai.png"><br><br>  Qual op√ß√£o escolher na caixa de di√°logo exibida? <br><br><img src="https://habrastorage.org/webt/wf/ma/kf/wfmakfepho5l4h4nxffpua7wgok.png"><br><br>  A quest√£o √© um pouco mais s√©ria do que parece.  Deixe-me destacar o pr√≥ximo par√°grafo para que ningu√©m seja pego (eu fui pego, e depois vi perguntas na rede daquelas que recebi e ningu√©m realmente as respondeu, e a resposta est√° em <b>AN82156</b> , voc√™ s√≥ precisa l√™-lo na diagonal, como diz l√° frase curta e discreta). <br><blockquote>  Se voc√™ planeja trabalhar com dados paralelos, deve escolher definitivamente a op√ß√£o CY_PSOC3_DP.  Nenhuma outra op√ß√£o conter√° portas para conectar dados paralelos. </blockquote>  Ent√£o  Deixe a inst√¢ncia ser chamada LCD_DP: <br><br><img src="https://habrastorage.org/webt/tf/a3/hs/tfa3hsi-mu2ljvyeukwmprwlm_4.png"><br><br>  Clique em OK e feche a <b>ferramenta de configura√ß√£o</b> do <b>Datapath por enquanto</b> , concordando em salvar o resultado.  Voltaremos aqui mais tarde. <br><br>  Nosso c√≥digo Verilog foi expandido.  Agora tem Datapath.  Seu come√ßo √© completamente ileg√≠vel.  N√£o √© assustador, √© configurado pela <b>ferramenta de</b> configura√ß√£o do <b>Datapath</b> . <br><br><img src="https://habrastorage.org/webt/tz/d9/ur/tzd9urfa66hsfic2w9gsn6tkysu.png"><br><br>  E governaremos o final da descri√ß√£o do Datapath.  Nosso site fica assim <div class="spoiler">  <b class="spoiler_title">(a partir deste ponto, faz sentido trazer tudo em forma de texto).</b> <div class="spoiler_text"><pre><code class="plaintext hljs">)) LCD_DP( /* input */ .reset(1'b0), /* input */ .clk(1'b0), /* input [02:00] */ .cs_addr(3'b0), /* input */ .route_si(1'b0), /* input */ .route_ci(1'b0), /* input */ .f0_load(1'b0), /* input */ .f1_load(1'b0), /* input */ .d0_load(1'b0), /* input */ .d1_load(1'b0), /* output */ .ce0(), /* output */ .cl0(), /* output */ .z0(), /* output */ .ff0(), /* output */ .ce1(), /* output */ .cl1(), /* output */ .z1(), /* output */ .ff1(), /* output */ .ov_msb(), /* output */ .co_msb(), /* output */ .cmsb(), /* output */ .so(), /* output */ .f0_bus_stat(), /* output */ .f0_blk_stat(), /* output */ .f1_bus_stat(), /* output */ .f1_blk_stat(), /* input */ .ci(1'b0), // Carry in from previous stage /* output */ .co(), // Carry out to next stage /* input */ .sir(1'b0), // Shift in from right side /* output */ .sor(), // Shift out to right side /* input */ .sil(1'b0), // Shift in from left side /* output */ .sol(), // Shift out to left side /* input */ .msbi(1'b0), // MSB chain in /* output */ .msbo(), // MSB chain out /* input [01:00] */ .cei(2'b0), // Compare equal in from prev stage /* output [01:00] */ .ceo(), // Compare equal out to next stage /* input [01:00] */ .cli(2'b0), // Compare less than in from prv stage /* output [01:00] */ .clo(), // Compare less than out to next stage /* input [01:00] */ .zi(2'b0), // Zero detect in from previous stage /* output [01:00] */ .zo(), // Zero detect out to next stage /* input [01:00] */ .fi(2'b0), // 0xFF detect in from previous stage /* output [01:00] */ .fo(), // 0xFF detect out to next stage /* input [01:00] */ .capi(2'b0), // Software capture from previous stage /* output [01:00] */ .capo(), // Software capture to next stage /* input */ .cfbi(1'b0), // CRC Feedback in from previous stage /* output */ .cfbo(), // CRC Feedback out to next stage /* input [07:00] */ .pi(8'b0), // Parallel data port /* output [07:00] */ .po() // Parallel data port );</code> </pre> <br></div></div><br>  Assustador  Agora vamos descobrir o que √© isso - deixar√° de ser assustador.  De fato, existem tr√™s grupos distintos neste texto.  Vamos relembrar a tradu√ß√£o da documenta√ß√£o.  Como era o caminho de dados na foto?  Anotarei imediatamente na figura os lugares aos quais os grupos ‚Äú1‚Äù, ‚Äú2‚Äù e ‚Äú3‚Äù pertencem. <br><br><img src="https://habrastorage.org/webt/ji/xe/5x/jixe5x_fxqpx6kgybrjmakagpw4.png"><br><br>  Na verdade, o primeiro grupo de portas no c√≥digo verilog s√£o as entradas.  Compare os nomes na sa√≠da do multiplexador de entrada (‚Äú1‚Äù na figura) e os nomes dos sinais no c√≥digo. <br><br>  Agora todas as entradas s√£o zero.  Teremos que conectar a entrada do rel√≥gio e podemos encaminhar at√© seis linhas de entrada, como foi feito no UDB Editor.  Essas entradas s√£o: <br><br><pre> <code class="plaintext hljs"> /* input */ .reset(1'b0), /* input */ .clk(1'b0), /* input [02:00] */ .cs_addr(3'b0), /* input */ .route_si(1'b0), /* input */ .route_ci(1'b0), /* input */ .f0_load(1'b0), /* input */ .f1_load(1'b0), /* input */ .d0_load(1'b0), /* input */ .d1_load(1'b0),</code> </pre><br>  O segundo grupo s√£o as sa√≠das.  Os nomes no c√≥digo tamb√©m coincidem com os nomes das entradas do multiplexador de sa√≠da "2": <br><br><pre> <code class="plaintext hljs"> /* output */ .ce0(), /* output */ .cl0(), /* output */ .z0(), /* output */ .ff0(), /* output */ .ce1(), /* output */ .cl1(), /* output */ .z1(), /* output */ .ff1(), /* output */ .ov_msb(), /* output */ .co_msb(), /* output */ .cmsb(), /* output */ .so(), /* output */ .f0_bus_stat(), /* output */ .f0_blk_stat(), /* output */ .f1_bus_stat(), /* output */ .f1_blk_stat(),</code> </pre><br>  Somente uma esp√©cie de Datapath especificada possui o terceiro grupo (as outras n√£o, portanto, n√£o h√° dados paralelos).  Esses s√£o sinais internos do Datapath atrav√©s dos quais voc√™ pode encadear independentemente ou executar outras a√ß√µes √∫teis.  Os nomes no c√≥digo tamb√©m coincidem com os nomes dos sinais internos espalhados na figura.  N√≥s, atrav√©s de um deles (o √∫ltimo da lista, o nome dele √© <b>po</b> ), enviaremos dados paralelos diretamente para as pernas do chip. <br><br><pre> <code class="plaintext hljs"> /* input */ .ci(1'b0), // Carry in from previous stage /* output */ .co(), // Carry out to next stage /* input */ .sir(1'b0), // Shift in from right side /* output */ .sor(), // Shift out to right side /* input */ .sil(1'b0), // Shift in from left side /* output */ .sol(), // Shift out to left side /* input */ .msbi(1'b0), // MSB chain in /* output */ .msbo(), // MSB chain out /* input [01:00] */ .cei(2'b0), // Compare equal in from prev stage /* output [01:00] */ .ceo(), // Compare equal out to next stage /* input [01:00] */ .cli(2'b0), // Compare less than in from prv stage /* output [01:00] */ .clo(), // Compare less than out to next stage /* input [01:00] */ .zi(2'b0), // Zero detect in from previous stage /* output [01:00] */ .zo(), // Zero detect out to next stage /* input [01:00] */ .fi(2'b0), // 0xFF detect in from previous stage /* output [01:00] */ .fo(), // 0xFF detect out to next stage /* input [01:00] */ .capi(2'b0), // Software capture from previous stage /* output [01:00] */ .capo(), // Software capture to next stage /* input */ .cfbi(1'b0), // CRC Feedback in from previous stage /* output */ .cfbo(), // CRC Feedback out to next stage /* input [07:00] */ .pi(8'b0), // Parallel data port /* output [07:00] */ .po() // Parallel data port );</code> </pre><br>  Ent√£o  Enquanto trabalhamos, teremos que conectar algumas dessas entradas e sa√≠das √†s nossas pr√≥prias entidades e o restante - apenas deixe-as na forma em que as criamos. <br><br><h2>  Usando o UDB Editor como refer√™ncia </h2><br>  E agora temos um espa√ßo em branco, sabemos onde e o que temos que escrever.  Resta entender o que exatamente entraremos l√°.  Aconteceu que eu uso a linguagem Verilog nem todos os dias, ent√£o, em termos gerais, lembro de tudo, e escrever do zero para mim √© sempre uma situa√ß√£o estressante.  Quando o projeto j√° est√° em andamento, tudo √© lembrado, mas se ap√≥s alguns meses de inatividade eu come√ßar algo do zero, √© claro, n√£o lembro mais os detalhes da sintaxe desse idioma em particular.  Portanto, sugiro pedir ao ambiente de desenvolvimento que nos ajude. <br><br>  O UDB Editor para auto-monitoramento cria c√≥digo Verilog.  Aproveitamos o fato de que os componentes que n√£o est√£o envolvidos no circuito principal n√£o s√£o compilados, para que possamos criar um componente auxiliar no UDB Editor e ele n√£o entrar√° no c√≥digo de sa√≠da.  N√≥s desenharemos um aut√¥mato l√°, faremos um ajuste aproximado das entradas e sa√≠das do Datapath e apenas transferiremos o texto gerado automaticamente para o nosso m√≥dulo verilog e modificaremos tudo de forma criativa.  Isso √© muito mais simples do que lembrar os detalhes da sintaxe da Verilog e escrever tudo do zero (embora quem use Verilog constantemente, √© claro, ser√° mais f√°cil escrever do zero: a conclus√£o criativa, como veremos em breve, √© simples, mas exige hora). <br><br>  Ent√£o, come√ßamos a fazer um componente auxiliar.  Com o movimento usual da m√£o, adicionamos um novo elemento ao projeto: <br><br><img src="https://habrastorage.org/webt/to/d2/fg/tod2fgx1opcdho2edizges-vr3q.png"><br><br>  Este ser√° um documento UDB, vamos cham√°-lo de <b>UDBhelper</b> : <br><br><img src="https://habrastorage.org/webt/j3/wt/iu/j3wtiuj2htdr-ct4f7m_3z497oi.png"><br><br>  √â hora de pensar na m√°quina, que colocaremos na folha criada.  Para fazer isso, precisamos considerar qual diagrama de tempo devemos formar com ele: <br><br><img src="https://habrastorage.org/webt/rh/zj/da/rhzjdasl8ioia8n8okjuuaieft4.png"><br><br><img src="https://habrastorage.org/webt/dy/3a/0z/dy3a0zmkacoa4tvgaugebovdhqy.png"><br><br>  Ent√£o  Primeiro, voc√™ precisa definir o sinal RS (j√° que o R / W √© soldado a zero no hardware).  Em seguida, aguarde tAS, aumente o sinal E e defina os dados (a configura√ß√£o de dados em rela√ß√£o √† margem positiva E n√£o √© limitada).  Os dados devem estar no barramento n√£o menos que tDSW, ap√≥s o qual o sinal E. deve ser descartado, devendo permanecer no barramento por pelo menos tDHW e RS por pelo menos tAH. <br><br>  RS √© o comando ou sinalizador de dados.  Se RS for zero, um comando ser√° gravado; se for um, os dados ser√£o gravados. <br><br>  Sugiro o envio de comandos atrav√©s do <b>FIFO0</b> e dados atrav√©s do <b>FIFO1</b> .  Na estrutura da tarefa atual, isso n√£o contradiz nada.  Ent√£o a m√°quina de estados finitos proposta por mim ter√° a seguinte forma: <br><br><img src="https://habrastorage.org/webt/jn/6y/6j/jn6y6jnzllwbwgmslak7nif1xmu.png"><br><br>  No estado <b>ocioso</b> , a m√°quina ainda n√£o possui dados FIFO.  Se os dados aparecerem em <b>FIFO0</b> , eles v√£o para <b>LoadF0</b> , onde no futuro receber√£o dados de <b>FIFO0</b> a A0. <br><br>  Enquanto os comandos est√£o sendo transmitidos, os dados n√£o devem ser enviados.  Portanto, a condi√ß√£o para receber dados ter√° prioridade mais baixa do que a condi√ß√£o para receber comandos. <br><br><img src="https://habrastorage.org/webt/og/gn/fl/oggnfl3tcjcxa8pzu64qcj3yzpa.png"><br><br>  Os dados s√£o recebidos em A1 no estado <b>LoadF1</b> (do <b>FIFO1,</b> eles s√≥ podem ir para o registro A1 e n√£o podem ir para o registro A0) e depois s√£o copiados de A1 para A0 no estado <b>A1toA0</b> . <br><br>  Qualquer que seja o caminho para o ponto de converg√™ncia das setas, temos dados em A0.  Eles j√° s√£o enviados para a porta paralela.  <b>Empurramos</b> E (no estado <b>E_UP1</b> ), <b>soltamos</b> E (no estado <b>E_DOWN1</b> ).  A seguir, teremos um estado para trocar petiscos ( <b>SWAP</b> ), ap√≥s o qual E aumentar√° novamente ( <b>E_UP2</b> ).  Sobre isso, esgotei oito estados que podem ser codificados em tr√™s bits.  E lembramos que a RAM de configura√ß√£o din√¢mica do Datapath possui apenas tr√™s entradas de endere√ßo.  Alguns truques podem ser aplicados, mas o artigo j√° √© grande.  Portanto, apenas na segunda vez, soltaremos E no estado <b>ocioso</b> .  Ent√£o oito estados s√£o suficientes para n√≥s. <br><br>  Tamb√©m colocamos o Datapath na planilha e atribu√≠mos suas entradas e sa√≠das de uma maneira que √© familiar nos artigos anteriores.  Aqui est√£o as entradas: <br><br><img src="https://habrastorage.org/webt/ct/fn/0j/ctfn0jvexwfycfrdovbnatwv7ze.png"><br><br>  Aqui est√£o as sa√≠das: <br><br><img src="https://habrastorage.org/webt/ct/mj/gd/ctmjgdzfvx-mz8qnzwbp6undlau.png"><br><br>  Nada de novo, tudo j√° foi descrito em artigos anteriores do ciclo.  Ent√£o, temos um espa√ßo em branco, com base no qual podemos fazer algo por conta pr√≥pria.  √â verdade que, para garantir que tudo esteja funcionando, precisamos levar nosso sistema ao n√≠vel superior do projeto, caso contr√°rio, nenhum erro ser√° encontrado.  E nas experi√™ncias iniciais sem erros n√£o vai funcionar.  Portanto, faremos mais uma a√ß√£o auxiliar. <br><br>  A descri√ß√£o de como o circuito √© feito vai al√©m da descri√ß√£o do trabalho com o UDB.  Vou apenas mostrar qual circuito eu tenho.  Existe apenas uma unidade DMA: ao enviar comandos para o LCD, √© necess√°rio suportar grandes pausas, por isso ainda √© mais f√°cil fazer isso programaticamente.  Para outras aplica√ß√µes, voc√™ pode simplesmente colocar o segundo bloco DMA por analogia, usando o sinal <b>hungry0</b> . <br><br><img src="https://habrastorage.org/webt/mz/zd/g8/mzzdg80tinx_ffjjigxypmehj0w.png"><br><br>  Para atender com precis√£o o per√≠odo de tempo, escolhi uma frequ√™ncia de rel√≥gio igual a um megahertz.  Seria poss√≠vel ter uma frequ√™ncia e mais alta, mas os dados s√£o transmitidos por cabos longos em condi√ß√µes de alta interfer√™ncia, portanto, √© melhor reservar um tempo para definir os dados antes e depois do port√£o com uma margem.  Se algu√©m repetir meus experimentos na mesma placa de ensaio - n√£o use a porta P3.2: um capacitor √© soldado a essa perna na placa.  Eu matei por meia hora, at√© descobrir por que n√£o formava um impulso E, que primeiro liguei l√°.  Joguei para a P3.1 - tudo funcionou imediatamente.  Meu barramento de dados vai para P3.7-P3.4, RS para P3.3, ent√£o E originalmente foi para P3.2 ... <br><br>  Bem aqui.  Agora, se voc√™ tentar compilar o projeto, obteremos erros completamente previs√≠veis <br><br><img src="https://habrastorage.org/webt/az/tm/fb/aztmfbvzsl52ghanjovqpva5_7o.png"><br><br>  Ent√£o o sistema est√° tentando coletar alguma coisa.  Mas ela ainda n√£o tem nada a cobrar.  Prosseguimos para copiar o c√≥digo.  Para fazer isso, no Editor do UDB, alterne para a guia Verilog (essa guia est√° localizada sob a janela com a folha do Editor do UDB): <br><br><img src="https://habrastorage.org/webt/kg/tk/fy/kgtkfyn1tssdt4-cjydawzl7vnw.png"><br><br>  O que √© familiar l√°?  No final do texto est√° o corpo do aut√¥mato.  Vamos come√ßar a migra√ß√£o a partir dele. <br><br><div class="spoiler">  <b class="spoiler_title">Coloque-o tamb√©m em Datapath:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/* ==================== State Machine: SM ==================== */ always @ (posedge clock) begin : Idle_state_logic case(SM) Idle : begin if (( !F0empty ) == 1'b1) begin SM &lt;= LoadF0 ; end else if (( !F1empty ) == 1'b1) begin SM &lt;= LoadF1 ; end end LoadF0 : begin if (( 1'b1 ) == 1'b1) begin SM &lt;= E_Up1 ; end end E_Up1 : begin if (( 1'b1 ) == 1'b1) begin SM &lt;= E_Down1 ; end end E_Down1 : begin if (( 1'b1 ) == 1'b1) begin SM &lt;= SWAP ; end end SWAP : begin if (( 1'b1 ) == 1'b1) begin SM &lt;= E_UP2 ; end end E_UP2 : begin if (( 1'b1 ) == 1'b1) begin SM &lt;= Idle ; end end LoadF1 : begin if (( 1'b1 ) == 1'b1) begin SM &lt;= A1toA0 ; end end A1toA0 : begin if (( 1'b1 ) == 1'b1) begin SM &lt;= E_Up1 ; end end default : begin SM &lt;= Idle; end endcase end</code> </pre><br></div></div><br>  Existem declara√ß√µes no topo desse c√≥digo (nomes para estados, cadeias para Datapath, um registro que codifica o estado de um aut√¥mato).  N√≥s os transferimos para o apropriado <div class="spoiler">  <b class="spoiler_title">se√ß√£o do nosso c√≥digo:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/* ==================== Wire and Register Declarations ==================== */ localparam [2:0] Idle = 3'b000; localparam [2:0] LoadF0 = 3'b001; localparam [2:0] LoadF1 = 3'b010; localparam [2:0] E_Up1 = 3'b100; localparam [2:0] A1toA0 = 3'b011; localparam [2:0] E_Down1 = 3'b101; localparam [2:0] SWAP = 3'b110; localparam [2:0] E_UP2 = 3'b111; wire hungry0; wire F0empty; wire hungry1; wire F1empty; wire Datapath_1_d0_load; wire Datapath_1_d1_load; wire Datapath_1_f0_load; wire Datapath_1_f1_load; wire Datapath_1_route_si; wire Datapath_1_route_ci; wire [2:0] Datapath_1_select; reg [2:0] SM;</code> </pre><br></div></div><br>  Bem, e <br><br><div class="spoiler">  <b class="spoiler_title">o local de liga√ß√£o do sinal √© transfer√≠vel:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">/* ==================== Assignment of Combinatorial Variables ==================== */ assign Datapath_1_d0_load = (1'b0); assign Datapath_1_d1_load = (1'b0); assign Datapath_1_f0_load = (1'b0); assign Datapath_1_f1_load = (1'b0); assign Datapath_1_route_si = (1'b0); assign Datapath_1_route_ci = (1'b0); assign Datapath_1_select[0] = (SM[0]); assign Datapath_1_select[1] = (SM[1]); assign Datapath_1_select[2] = (SM[2]);</code> </pre><br></div></div><br>  √â hora de conectar o Datapath.  O c√≥digo portado do UDB Editor √© bom para edi√ß√£o de m√°quina, mas n√£o muito bom para edi√ß√£o manual.  L√°, s√£o criadas cadeias que se conectam √†s entradas do Datapath em uma extremidade e √†s constantes na outra.  Mas no c√≥digo criado pela <b>Ferramenta de Configura√ß√£o</b> do <b>Datapath</b> (que faz tudo para o trabalho manual), todas as entradas j√° est√£o diretamente conectadas a zero constantes.  Portanto, conectarei apenas as linhas que n√£o s√£o constantes, mas cortarei tudo do encaminhamento de constantes do texto transferido.  A conex√£o ficou assim (a cor destaca os lugares que editei em rela√ß√£o aos criados automaticamente na Ferramenta de configura√ß√£o do Datapath): <br><br><img src="https://habrastorage.org/webt/-3/gk/fd/-3gkfd3bhnnc7wygbr6wpqoscyo.png"><br><br><div class="spoiler">  <b class="spoiler_title">Mesmo texto:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">)) LCD_DP( /* input */ .reset(1'b0), /* input */ .clk(clk), /* input [02:00] */ .cs_addr(SM), /* input */ .route_si(1'b0), /* input */ .route_ci(1'b0), /* input */ .f0_load(1'b0), /* input */ .f1_load(1'b0), /* input */ .d0_load(1'b0), /* input */ .d1_load(1'b0), /* output */ .ce0(), /* output */ .cl0(), /* output */ .z0(), /* output */ .ff0(), /* output */ .ce1(), /* output */ .cl1(), /* output */ .z1(), /* output */ .ff1(), /* output */ .ov_msb(), /* output */ .co_msb(), /* output */ .cmsb(), /* output */ .so(), /* output */ .f0_bus_stat(hungry0), /* output */ .f0_blk_stat(F0empty), /* output */ .f1_bus_stat(hungry1), /* output */ .f1_blk_stat(F1empty),</code> </pre><br></div></div><br>  Dados paralelos s√£o um pouco mais complicados.  O Datapath possui uma porta de oito bits e apenas quatro delas precisam ser trazidas para fora.  Portanto, iniciamos o circuito auxiliar e conectamos apenas metade dele √† sa√≠da: <br><br><pre> <code class="plaintext hljs">wire [7:0] tempBus; assign LCD_D = tempBus[7:4];</code> </pre><br>  E conecte-o assim: <br><br><img src="https://habrastorage.org/webt/km/aq/_a/kmaq_abi2kkprp406kne413j5u0.png"><br><br><div class="spoiler">  <b class="spoiler_title">Mesmo texto:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> /* input [07:00] */ .pi(8'b0), // Parallel data port /* output [07:00] */ .po( tempBus) // Parallel data port );</code> </pre><br></div></div><br>  Tentamos montar (Shift + F6 ou atrav√©s do item de menu <b>Build-&gt; Generate Application</b> ).  Temos o erro: <br><br><img src="https://habrastorage.org/webt/kw/ox/as/kwoxasreij4-snkxyvc63iqozxq.png"><br><br>  Temos portas com <b>fome0</b> e com <b>fome1</b> (apareceram ao criar o componente), bem como cadeias com o mesmo nome (apareceram ao arrastar da amostra).  Apenas remova essas correntes (deixando as portas).  E em algum lugar o sinal do <b>rel√≥gio</b> vazou, e n√≥s temos esse circuito chamado <b>clk</b> . <br><br>  Ap√≥s remover todos os circuitos desnecess√°rios (aqueles que inicialmente lan√ßavam zero constantes nas entradas do <b>Datapath</b> , al√©m de <b>hungry0</b> e <b>hungry1</b> ), obtemos o seguinte c√≥digo para o in√≠cio do nosso arquivo: <br><br><pre> <code class="plaintext hljs">// Your code goes here /* ==================== Wire and Register Declarations ==================== */ localparam [2:0] Idle = 3'b000; localparam [2:0] LoadF0 = 3'b001; localparam [2:0] LoadF1 = 3'b010; localparam [2:0] E_Up1 = 3'b100; localparam [2:0] A1toA0 = 3'b011; localparam [2:0] E_Down1 = 3'b101; localparam [2:0] SWAP = 3'b110; localparam [2:0] E_UP2 = 3'b111; wire F0empty; wire F1empty; reg [2:0] SM; /* ==================== Assignment of Combinatorial Variables ==================== */ wire [7:0] tempBus; assign LCD_D = tempBus[7:4];</code> </pre><br>  E ao substituir o <b>rel√≥gio</b> por <b>clk</b> no corpo da m√°quina, ao mesmo tempo, jogarei fora todas as linhas que s√£o boas para a gera√ß√£o autom√°tica, mas com a edi√ß√£o manual, apenas crio confus√£o (todas as compara√ß√µes que d√£o um resultado incondicional <b>TRUE</b> e assim por diante).  Em particular, no exemplo abaixo, voc√™ pode atravessar cerca de metade das linhas (e algumas <b>inicias / finais</b> s√£o opcionais, √†s vezes ser√£o necess√°rias, porque adicionaremos a√ß√µes, as destaquei): <br><br><img src="https://habrastorage.org/webt/9s/e9/t1/9se9t15zkc1hux1qrpga3jbh7cm.png"><br><br>  Ap√≥s pentear de acordo com o princ√≠pio acima (e substituir o <b>rel√≥gio</b> por <b>clk</b> ), esse corpo permanece <br><br><div class="spoiler">  <b class="spoiler_title">(ficou mais curto, o que significa que √© mais f√°cil de ler):</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">always @ (posedge clk) begin : Idle_state_logic case(SM) Idle : begin if (( !F0empty ) == 1'b1) begin SM &lt;= LoadF0 ; end else if (( !F1empty ) == 1'b1) begin SM &lt;= LoadF1 ; end end LoadF0 : begin SM &lt;= E_Up1 ; end E_Up1 : begin SM &lt;= E_Down1 ; end E_Down1 : begin SM &lt;= SWAP ; end SWAP : begin SM &lt;= E_UP2 ; end E_UP2 : begin SM &lt;= Idle ; end LoadF1 : begin SM &lt;= A1toA0 ; end A1toA0 : begin SM &lt;= E_Up1 ; end default : begin SM &lt;= Idle; end endcase end</code> </pre><br></div></div><br>  Agora, durante a compila√ß√£o, somos informados de que os <b>circuitos LCD_E</b> e <b>LCD_RS</b> n√£o <b>est√£o</b> conectados. <br><br>  Na verdade, isso √© verdade: <br><br><img src="https://habrastorage.org/webt/cz/da/h7/czdah7nfkzmou2mr8-omzs_-hby.png"><br><br>  Chegou a hora de adicionar a√ß√£o √† m√°quina de estado.  Substituiremos as declara√ß√µes das portas correspondentes √†s cadeias n√£o conectadas por <b>reg</b> , pois as escreveremos no corpo da m√°quina (esta √© a sintaxe da linguagem Verilog, se escrevermos, os dados dever√£o clicar, para isso precisamos de um gatilho, e isso √© dado pela palavra-chave <b>reg</b> ): <br><br><img src="https://habrastorage.org/webt/l5/vq/uj/l5vqujn7yirpf4dkorxzevy9ij4.png"><br><div class="spoiler">  <b class="spoiler_title">Mesmo texto:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">module LCD4bit ( output hungry0, output hungry1, output [3:0] LCD_D, output reg LCD_E, output reg LCD_RS, input clk );</code> </pre><br></div></div><br>  E encha a m√°quina com a√ß√µes.  Eu j√° disse a l√≥gica acima quando estava considerando o gr√°fico de transi√ß√£o do aut√¥mato, ent√£o mostrarei apenas o resultado: <br><br><img src="https://habrastorage.org/webt/ij/t1/5i/ijt15itzdfznooyvlgz0sjlk5t4.png"><br><div class="spoiler">  <b class="spoiler_title">Mesmo texto:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">always @ (posedge clk) begin : Idle_state_logic case(SM) Idle : begin LCD_E &lt;= 0; if (( !F0empty ) == 1'b1) begin SM &lt;= LoadF0 ; LCD_RS &lt;= 0; end else if (( !F1empty ) == 1'b1) begin SM &lt;= LoadF1 ; LCD_RS &lt;= 1; end end LoadF0 : begin SM &lt;= E_Up1 ; end E_Up1 : begin SM &lt;= E_Down1 ; LCD_E &lt;= 1'b1; end E_Down1 : begin SM &lt;= SWAP ; LCD_E &lt;= 1'b0; end SWAP : begin SM &lt;= E_UP2 ; end E_UP2 : begin SM &lt;= Idle ; LCD_E &lt;= 1; end LoadF1 : begin SM &lt;= A1toA0 ; end A1toA0 : begin SM &lt;= E_Up1 ; end default : begin SM &lt;= Idle; end endcase end</code> </pre><br></div></div><br>  A partir deste momento, o projeto come√ßa a se montar.  Mas ele n√£o vai funcionar ainda.  At√© agora, eu disse: "Nesse estado, carregaremos o registro do FIFO", "Nesse caso, A1 ser√° copiado para A0", "Nibbles ser√£o reorganizados".  Em geral, falei muito, mas at√© agora n√£o houve a√ß√µes.  Chegou a hora de cumpri-los.  Observamos como os estados foram codificados: <br><br><pre> <code class="plaintext hljs">localparam [2:0] Idle = 3'b000; localparam [2:0] LoadF0 = 3'b001; localparam [2:0] LoadF1 = 3'b010; localparam [2:0] E_Up1 = 3'b100; localparam [2:0] A1toA0 = 3'b011; localparam [2:0] E_Down1 = 3'b101; localparam [2:0] SWAP = 3'b110; localparam [2:0] E_UP2 = 3'b111;</code> </pre><br>  <b>Reabra a ferramenta de configura√ß√£o do Datapath</b> : <br><br><img src="https://habrastorage.org/webt/eh/oh/sz/ehohszogw7vzyiup9cjumf4b3ii.png"><br><br>  E comece a <b>editar as</b> linhas <b>CFGRAM</b> .  Ao editar, lembre-se do esquema do Datapath, a saber: <br><br><img src="https://habrastorage.org/webt/cz/xr/vu/czxrvuaul7vkqilrqinrgzpu1fy.png"><br><br>  Os quadros vermelhos na figura abaixo (e as setas na figura acima) destacaram as √°reas corrigidas (e o caminho dos dados) para o estado <b>LoadF0</b> (c√≥digo 001, ou seja, <b>Reg1</b> ).  Tamb√©m inseri coment√°rios manualmente.  O conte√∫do de F0 deve entrar em A0. <br><br><img src="https://habrastorage.org/webt/4z/zv/kh/4zzvkhchg55gnp-39oag_d-bkt8.png"><br><br>  Com quadros e setas verdes, marquei as configura√ß√µes e o caminho para o estado LoadF1 (c√≥digo 010 - <b>Reg2</b> ). <br><br>  Com quadros e setas azuis, marquei as configura√ß√µes e o caminho para o estado A1toA0 (c√≥digo 011 - <b>Reg3</b> ). <br><br>  Os quadros e setas roxos marcamos as configura√ß√µes e o caminho para o estado do SWAP (c√≥digo 110 - <b>Reg6</b> ). <br><br>  Finalmente, as setas laranja mostram o caminho de dados paralelo.  E nenhuma a√ß√£o √© tomada por eles.  Eles sempre saem do <b>SRCA</b> .  Quase sempre temos A0 selecionado como <b>SRCA</b> : os dados saem de A0.  Portanto, para redirecionar os dados de entrada, ter√≠amos que executar v√°rias a√ß√µes auxiliares, mas n√£o aceitamos dados; portanto, aqui n√£o precisamos dessas a√ß√µes e todos encontrar√£o sua lista no <b>AN82156</b> .  Tamb√©m n√£o precisamos editar nenhuma configura√ß√£o est√°tica do Datapath; portanto, feche a <b>Datapath Config Tool</b> . <br><br>  S√≥ isso.  Hardware concebido conclu√≠do.  Come√ßando a desenvolver c√≥digo C.  Para fazer isso, v√° para a guia <b>Origem</b> e edite o arquivo <b>main.c.</b> <br><br><img src="https://habrastorage.org/webt/fp/ia/7s/fpia7s4zyzaxy8mzmqxktib-obw.png"><br><br>  A inicializa√ß√£o regular do LCD e a sa√≠da de caracteres "ABC" s√£o assim (lembro que os comandos v√£o para <b>FIFO0</b> , a documenta√ß√£o precisa inserir pausas entre as equipes e os dados v√£o para <b>FIFO1</b> , n√£o encontrei nada sobre as pausas entre os dados): <br><br><pre> <code class="plaintext hljs"> volatile uint8_t* pFIFO0 = (uint8_t*) LCD4bit_1_LCD_DP__F0_REG; volatile uint8_t* pFIFO1 = (uint8_t*) LCD4bit_1_LCD_DP__F1_REG; pFIFO0[0] = 0x33; CyDelay (5); pFIFO0[0] = 0x33; CyDelay (100); pFIFO0[0] = 0x33; CyDelay (5); pFIFO0[0] = 0x20; CyDelay (5); pFIFO0[0] = 0x0C; //   CyDelay (50); pFIFO0[0] = 0x01; //   CyDelay (50); pFIFO1[0] = 'A'; pFIFO1[0] = 'B'; pFIFO1[0] = 'C';</code> </pre><br>  O que √©  Por que h√° apenas o primeiro caractere na tela? <br><br><img src="https://habrastorage.org/webt/3g/tq/sr/3gtqsrr050bqbhaqi2ke9g1pg0w.png"><br><br>  E se voc√™ adicionar atrasos entre a sa√≠da de dados - est√° tudo bem: <br><br><img src="https://habrastorage.org/webt/3b/he/2a/3bhe2a1_ioou2gktkqfzydumrne.png"><br><br>  O oscilosc√≥pio n√£o possui canais suficientes para esse trabalho.  Verificamos o trabalho em um analisador l√≥gico.  O processo de grava√ß√£o de dados √© o seguinte. <br><br><img src="https://habrastorage.org/webt/yr/y_/_j/yry__jhgasihbzmmrrr2cnsylaq.png"><br><br>  Todos os dados est√£o no lugar (tr√™s pares de pacotes).  O tempo para instala√ß√£o e captura de dados √© alocado em volume suficiente.  Em geral, do ponto de vista dos diagramas de tempo - tudo √© feito corretamente.  O problema cient√≠fico √© resolvido, os diagramas de tempo desejados s√£o formados.  Aqui est√° a engenharia - n√£o.  A raz√£o para isso √© a lentid√£o do processador instalado no LCD.  Entre bytes, adicione atrasos. <br><br>  Iremos formar atrasos usando um contador de sete bits e, ao mesmo tempo, treinaremos para adicion√°-lo a esse sistema.  Vamos permanecer no estado de Espera n√£o menos do que em um determinado per√≠odo de tempo, e um contador de sete bits medir√° esse tempo para n√≥s.  E, novamente, n√£o escreveremos, mas criaremos c√≥digo.  Portanto, novamente vamos ao componente auxiliar do UDB Editor e adicionamos um contador √† planilha, definindo seus par√¢metros da seguinte maneira: <br><br><img src="https://habrastorage.org/webt/gq/8c/qw/gq8cqwl0liu7mv9gpgm8-wngom0.png"><br><br>  Este contador sempre funcionar√° ( <b>Ativar est√° definido</b> como 1).  Mas ele ser√° carregado quando a m√°quina estiver no estado <b>E_UP2</b> (ap√≥s o qual ca√≠mos imediatamente no estado <b>ocioso</b> ).  A linha <b>Count7_1_tc ser√°</b> aumentada para 1 quando o contador contar para zero, o que <b>criaremos</b> uma condi√ß√£o adicional para sair do estado de <b>espera</b> .  A figura tamb√©m cont√©m o valor do per√≠odo, mas n√£o o encontraremos no c√≥digo Verilog.  Ter√° que ser inserido no c√≥digo C.  Mas primeiro, transferimos o c√≥digo Verilog gerado automaticamente, alternando para a guia Verilog.  Primeiro de tudo, o contador deve estar conectado (vemos esse c√≥digo no in√≠cio do arquivo e o movemos tamb√©m para o in√≠cio): <br><br><pre> <code class="plaintext hljs">`define CY_BLK_DIR "$CYPRESS_DIR\..\psoc\content\CyComponentLibrary\CyComponentLibrary.cylib\Count7_v1_0" `include "$CYPRESS_DIR\..\psoc\content\CyComponentLibrary\CyComponentLibrary.cylib\Count7_v1_0\Count7_v1_0.v"</code> </pre><br>  Como o refinamento criativo de linhas e constantes √© realizado j√° foi descrito, ent√£o mostrarei o resultado.  Aqui est√£o as cadeias e atribui√ß√µes adicionadas como resultado (o resto define as constantes, ent√£o eu as joguei fora): <br><br><pre> <code class="plaintext hljs">wire Count7_1_load; wire Count7_1_tc; assign Count7_1_load = (SM==E_UP2);</code> </pre><br>  E aqui est√° o pr√≥prio contador, colocado no final do arquivo.  Todas as constantes s√£o atribu√≠das √†s portas diretamente nesta declara√ß√£o: <br><br><pre> <code class="plaintext hljs"> Count7_v1_0 Count7_1 ( .en(1'b1), .load(Count7_1_load), .clock(clk), .reset(1'b0), .cnt(), .tc(Count7_1_tc)); defparam Count7_1.EnableSignal = 1; defparam Count7_1.LoadSignal = 1;</code> </pre><br>  Para permitir que esse contador funcione, adicionamos automaticamente uma condi√ß√£o adicional para sair do estado de <b>espera</b> : <br><br><img src="https://habrastorage.org/webt/pc/it/pd/pcitpdmqenlvq8pblarf3uh5h84.png"><br><div class="spoiler">  <b class="spoiler_title">Mesmo texto:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> case(SM) Idle : begin LCD_E &lt;= 0; if (( !F0empty ) == 1'b1) begin SM &lt;= LoadF0 ; LCD_RS &lt;= 0; end else if (( !F1empty &amp;Count7_1_tc ) == 1'b1) begin SM &lt;= LoadF1 ; LCD_RS &lt;= 1; end end</code> </pre><br></div></div><br>  A API para o contador adicionado dessa maneira n√£o √© criada; portanto, adicionamos duas linhas m√°gicas √† fun√ß√£o <b>principal</b> , que formei na imagem e semelhan√ßa do que vi na API de projetos anteriores (a primeira linha define o valor carregado da conta, a mesma carga, a segunda inicia o contador): <br><br><pre> <code class="plaintext hljs"> *((uint8_t*)LCD4bit_1_Count7_1_Counter7__PERIOD_REG) = 0x20; *((uint8_t*)LCD4bit_1_Count7_1_Counter7__CONTROL_AUX_CTL_REG) |= 0x20; // Start</code> </pre><br>  O analisador mostra que, no caso modificado, o atraso √© √≥bvio: <br><br><img src="https://habrastorage.org/webt/ui/ey/ax/uieyax5yt3f0kpkhyyoikiishmq.png"><br><br>  O LCD tamb√©m possui todos os tr√™s caracteres. <br><br>  Mas a produ√ß√£o de caracteres program√°ticos na vida real √© inaceit√°vel.  Apenas adicion√°-los ao FIFO transbordar√°.  Aguarde o FIFO esvaziar - isso significa criar grandes atrasos para o n√∫cleo do processador.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O processador opera a uma frequ√™ncia de 72 MHz e os dados s√£o emitidos por 7-8 ciclos de clock a uma frequ√™ncia de 1 MHz. </font><font style="vertical-align: inherit;">Portanto, na vida real, o texto deve ser exibido usando o DMA. </font><font style="vertical-align: inherit;">√â aqui que o princ√≠pio "Iniciar e esquecer" √© √∫til. </font><font style="vertical-align: inherit;">Todos os atrasos no diagrama de temporiza√ß√£o ser√£o gerados pelo UDB, e o controlador DMA determinar√° a disponibilidade do FIFO para receber dados para n√≥s. </font><font style="vertical-align: inherit;">O n√∫cleo do processador precisa apenas formar uma linha na mem√≥ria e configurar o DMA, ap√≥s o que ele pode executar outras tarefas sem se preocupar com a sa√≠da do LCD.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicione o seguinte c√≥digo:</font></font></b> <div class="spoiler_text"><pre> <code class="plaintext hljs"> static const char line[] = "This is a line"; /* Defines for DMA_D */ #define DMA_D_BYTES_PER_BURST 1 #define DMA_D_REQUEST_PER_BURST 1 /* Variable declarations for DMA_D */ /* Move these variable declarations to the top of the function */ uint8 DMA_D_Chan; uint8 DMA_D_TD[1]; /* DMA Configuration for DMA_D */ DMA_D_Chan = DMA_D_DmaInitialize(DMA_D_BYTES_PER_BURST, DMA_D_REQUEST_PER_BURST, HI16(line), HI16(LCD4bit_1_LCD_DP__F1_REG)); DMA_D_TD[0] = CyDmaTdAllocate(); CyDmaTdSetConfiguration(DMA_D_TD[0], sizeof(line)-1, CY_DMA_DISABLE_TD, CY_DMA_TD_INC_SRC_ADR); CyDmaTdSetAddress(DMA_D_TD[0], LO16((uint32)line), LO16((uint32)LCD4bit_1_LCD_DP__F1_REG)); CyDmaChSetInitialTd(DMA_D_Chan, DMA_D_TD[0]); CyDmaChEnable(DMA_D_Chan, 1);</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Na tela, temos: </font></font><br><br><img src="https://habrastorage.org/webt/i7/ny/vi/i7nyvipk7tg8w_jdflryw2s39uk.png"><br><br><h2>  Conclus√£o </h2><br>  ,     ,        UDB     ‚Äî Datapath Config Tool.  ,    UDB Editor,        UDB,     ,   UDB Editor.             ,    ,    ,     UDB Editor. <br><br>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt442572/">https://habr.com/ru/post/pt442572/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt442560/index.html">Mash: multithreading, coroutines, ass√≠ncrono e espera</a></li>
<li><a href="../pt442562/index.html">Como resfriar equipamentos em um data center - tr√™s novas tecnologias</a></li>
<li><a href="../pt442566/index.html">Igual √† lua: engenharia reversa de um m√≥dulo h√≠brido de amp op</a></li>
<li><a href="../pt442568/index.html">Semana 10 de seguran√ßa: Vulnerabilidades de driver NVIDIA</a></li>
<li><a href="../pt442570/index.html">Regras Sigma. Artesanato ou novo padr√£o para SOC</a></li>
<li><a href="../pt442574/index.html">A base para uma teoria generalizada das redes neurais √© criada</a></li>
<li><a href="../pt442576/index.html">Overclockers de longa dura√ß√£o: como o resfriamento l√≠quido come√ßou a dominar nos data centers</a></li>
<li><a href="../pt442578/index.html">Lan√ßamento do Linux 5.0</a></li>
<li><a href="../pt442580/index.html">Engenharia reversa de formato bin√°rio usando arquivos .SNG da Korg como exemplo</a></li>
<li><a href="../pt442582/index.html">Como tentamos ass√©dio moral</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>