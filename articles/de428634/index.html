<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçã üëÜ üíáüèº Portierung von Quake3 üìô üë©üèø‚Äç‚úàÔ∏è üèçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unter dem Embox- Betriebssystem (dessen Entwickler ich bin) wurde OpenGL vor einiger Zeit unterst√ºtzt, es gab jedoch keine sinnvolle Leistungspr√ºfung,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Portierung von Quake3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/embox/blog/428634/"><img src="https://habrastorage.org/webt/or/0q/lb/or0qlb1hvs2q5j4-xfsfv5uofys.png" align="right" width="320"><br><p>  Unter dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Embox-</a> Betriebssystem (dessen Entwickler ich bin) wurde OpenGL vor einiger Zeit unterst√ºtzt, es gab jedoch keine sinnvolle Leistungspr√ºfung, sondern nur das Rendern von Szenen mit mehreren grafischen Grundelementen. </p><br><p>  Ich habe mich nie besonders f√ºr Gamedev interessiert, obwohl ich nat√ºrlich Spiele mag, und mich entschieden - dies ist eine gute M√∂glichkeit, Spa√ü zu haben, aber gleichzeitig OpenGL zu √ºberpr√ºfen und zu sehen, wie die Spiele mit dem Betriebssystem interagieren. </p><br><p>  In diesem Artikel werde ich dar√ºber sprechen, wie Quake3 auf Embox erstellt und ausgef√ºhrt wird. </p><a name="habracut"></a><br><p>  Genauer gesagt werden wir nicht <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Quake3</a> selbst ausf√ºhren, sondern <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ioquake3</a> basierend darauf, das auch Open Source Code enth√§lt.  Der Einfachheit halber nennen wir ioquake3 nur Beben :) </p><br><p>  Ich werde sofort reservieren, dass der Artikel den Quake-Quellcode und seine Architektur nicht analysiert (Sie k√∂nnen hier dar√ºber lesen, es gibt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√úbersetzungen zum Habr√©</a> ), und dieser Artikel wird sich darauf konzentrieren, wie sichergestellt werden kann, dass das Spiel auf dem neuen Betriebssystem gestartet wird. </p><br><p>  Die im Artikel vorgestellten Codefragmente werden zum besseren Verst√§ndnis vereinfacht: Fehlerpr√ºfungen werden weggelassen, Pseudocode wird verwendet und so weiter.  Originalquellen finden Sie in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unserem Repository</a> . </p><br><h2 id="zavisimosti">  Abh√§ngigkeiten </h2><br><p>  Seltsamerweise werden nicht viele Bibliotheken ben√∂tigt, um Quake3 zu erstellen.  Wir werden brauchen: </p><br><ul><li> POSIX + LibC - <code>malloc()</code> / <code>memcpy()</code> / <code>printf()</code> und so weiter </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">libcurl</a> - Vernetzung </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mesa3D</a> - OpenGL-Unterst√ºtzung </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SDL</a> - Unterst√ºtzung f√ºr Eingangs- und Audioger√§te </li></ul><br><p>  Mit dem ersten Absatz ist also alles klar - ohne diese Funktionen ist es schwierig, in C zu entwickeln, und die Verwendung dieser Aufrufe wird durchaus erwartet.  Daher ist die Unterst√ºtzung f√ºr diese Schnittstellen in fast allen Betriebssystemen irgendwie verf√ºgbar, und in diesem Fall war es praktisch nicht erforderlich, Funktionen hinzuzuf√ºgen.  Ich musste mich um den Rest k√ºmmern. </p><br><h3 id="libcurl">  libcurl </h3><br><p>  Es war das einfachste.  Libc reicht aus, um libcurl zu erstellen (einige Funktionen sind nat√ºrlich nicht verf√ºgbar, werden aber nicht ben√∂tigt).  Das Konfigurieren und Erstellen dieser Bibliothek ist statisch sehr einfach. </p><br><p>  Normalerweise werden sowohl Anwendungen als auch Bibliotheken dynamisch verkn√ºpft, aber weil  In Embox ist der Hauptmodus das Verkn√ºpfen in einem Bild. Wir verkn√ºpfen alles statisch. </p><br><p>  Abh√§ngig vom verwendeten Build-System variieren die spezifischen Schritte, aber die Bedeutung ist ungef√§hr so: </p><br><pre> <code class="hljs powershell">wget https://curl.haxx.se/download/curl<span class="hljs-literal"><span class="hljs-literal">-7</span></span>.<span class="hljs-number"><span class="hljs-number">61.1</span></span>.tar.gz tar <span class="hljs-literal"><span class="hljs-literal">-xf</span></span> curl<span class="hljs-literal"><span class="hljs-literal">-7</span></span>.<span class="hljs-number"><span class="hljs-number">61.1</span></span>.tar.gz cd curl<span class="hljs-literal"><span class="hljs-literal">-7</span></span>.<span class="hljs-number"><span class="hljs-number">61.1</span></span> ./configure -<span class="hljs-literal"><span class="hljs-literal">-enable</span></span><span class="hljs-literal"><span class="hljs-literal">-static</span></span> -<span class="hljs-literal"><span class="hljs-literal">-host</span></span>=i386<span class="hljs-literal"><span class="hljs-literal">-unknown</span></span><span class="hljs-literal"><span class="hljs-literal">-none</span></span> <span class="hljs-literal"><span class="hljs-literal">-disable</span></span><span class="hljs-literal"><span class="hljs-literal">-shared</span></span> make ls ./lib/.libs/libcurl.a <span class="hljs-comment"><span class="hljs-comment">#      </span></span></code> </pre> <br><h3 id="mesaopengl">  Mesa / OpenGL </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Mesa</a> ist ein Open-Source-Framework f√ºr die Arbeit mit Grafiken. Es unterst√ºtzt eine Reihe von Schnittstellen (OpenCL, Vulkan und andere). In diesem Fall sind wir jedoch an OpenGL interessiert.  Das Portieren eines so gro√üen Frameworks ist das Thema eines separaten Artikels.  Ich werde mich nur auf das beschr√§nken, was Embox Mesa3D bereits hat :) Nat√ºrlich ist hier jede OpenGL-Implementierung geeignet. </p><br><h3 id="sdl">  Sdl </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">SDL</a> ist ein plattform√ºbergreifendes Framework f√ºr die Arbeit mit Eingabeger√§ten, Audio und Grafik. </p><br><p>  Im Moment werden wir alles au√üer Grafiken h√§mmern und zum Zeichnen von Frames Stub-Funktionen schreiben, um zu sehen, wann sie aufgerufen werden. </p><br><p>  Die Backends f√ºr die Arbeit mit Grafiken sind in <code>SDL2-2.0.8/src/video/SDL_video.c</code> . </p><br><p>  Es sieht ungef√§hr so ‚Äã‚Äãaus: </p><br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-comment">/* Available video drivers */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> VideoBootStrap *bootstrap[] = { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SDL_VIDEO_DRIVER_COCOA &amp;COCOA_bootstrap, #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SDL_VIDEO_DRIVER_X11 &amp;X11_bootstrap, #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> ... }</span></span></code> </pre> <br><p>  <code>VideoBootStrap</code> einfach Ihren <code>VideoBootStrap</code> hinzu, um die "normale" Unterst√ºtzung f√ºr die neue Plattform nicht zu <code>VideoBootStrap</code> </p><br><p>  Der Einfachheit halber k√∂nnen Sie etwas als Grundlage nehmen, zum Beispiel <code>src/video/qnx/video.c</code> oder <code>src/video/raspberry/SDL_rpivideo.c</code> , aber zuerst machen wir die Implementierung fast leer: </p><br><pre> <code class="hljs cpp"><span class="hljs-comment"><span class="hljs-comment">/* SDL_sysvideo.h */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VideoBootStrap</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *name; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *desc;``` <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (*available) (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>); SDL_VideoDevice *(*create) (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> devindex); } VideoBootStrap; <span class="hljs-comment"><span class="hljs-comment">/* embox_video.c */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SDL_VideoDevice *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createDevice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> devindex)</span></span></span><span class="hljs-function"> </span></span>{ SDL_VideoDevice *device; device = (SDL_VideoDevice *)SDL_calloc(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(SDL_VideoDevice)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (device == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> device; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">available</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } VideoBootStrap EMBOX_bootstrap = { <span class="hljs-string"><span class="hljs-string">"embox"</span></span>, <span class="hljs-string"><span class="hljs-string">"EMBOX Screen"</span></span>, available, createDevice };</code> </pre><br><p>  F√ºgen Sie Ihre <code>VideoBootStrap</code> zum Array hinzu: </p><br><pre> <code class="hljs cs"><span class="hljs-comment"><span class="hljs-comment">/* Available video drivers */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> VideoBootStrap *bootstrap[] = { &amp;EMBOX_bootstrap, <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SDL_VIDEO_DRIVER_COCOA &amp;COCOA_bootstrap, #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> SDL_VIDEO_DRIVER_X11 &amp;X11_bootstrap, #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> ... }</span></span></code> </pre> <br><p>  Grunds√§tzlich k√∂nnen Sie zu diesem Zeitpunkt bereits SDL kompilieren.  Wie bei libcurl h√§ngen die Kompilierungsdetails vom jeweiligen Build-System ab, aber irgendwie m√ºssen Sie Folgendes tun: </p><br><pre> <code class="hljs powershell">./configure -<span class="hljs-literal"><span class="hljs-literal">-host</span></span>=i386<span class="hljs-literal"><span class="hljs-literal">-unknown</span></span><span class="hljs-literal"><span class="hljs-literal">-none</span></span> \ -<span class="hljs-literal"><span class="hljs-literal">-enable</span></span><span class="hljs-literal"><span class="hljs-literal">-static</span></span> \ -<span class="hljs-literal"><span class="hljs-literal">-enable</span></span><span class="hljs-literal"><span class="hljs-literal">-audio</span></span>=no \ -<span class="hljs-literal"><span class="hljs-literal">-enable</span></span><span class="hljs-literal"><span class="hljs-literal">-video</span></span><span class="hljs-literal"><span class="hljs-literal">-directfb</span></span>=no \ -<span class="hljs-literal"><span class="hljs-literal">-enable</span></span><span class="hljs-literal"><span class="hljs-literal">-directfb</span></span><span class="hljs-literal"><span class="hljs-literal">-shared</span></span>=no \ -<span class="hljs-literal"><span class="hljs-literal">-enable</span></span><span class="hljs-literal"><span class="hljs-literal">-video</span></span><span class="hljs-literal"><span class="hljs-literal">-vulkan</span></span>=no \ -<span class="hljs-literal"><span class="hljs-literal">-enable</span></span><span class="hljs-literal"><span class="hljs-literal">-video</span></span><span class="hljs-literal"><span class="hljs-literal">-dummy</span></span>=no \ -<span class="hljs-literal"><span class="hljs-literal">-with</span></span><span class="hljs-literal"><span class="hljs-literal">-x</span></span>=no make ls build/.libs/libSDL2.a <span class="hljs-comment"><span class="hljs-comment">#     </span></span></code> </pre> <br><h2 id="sobiraem-sam-quake">  Wir sammeln Quake selbst </h2><br><p>  Quake3 beinhaltet die Verwendung dynamischer Bibliotheken, aber wir werden es wie alles andere statisch verkn√ºpfen. </p><br><p>  Legen Sie dazu einige Variablen im Makefile fest </p><br><pre> <code class="hljs objectivec">CROSS_COMPILING=<span class="hljs-number"><span class="hljs-number">1</span></span> USE_OPENAL=<span class="hljs-number"><span class="hljs-number">0</span></span> USE_OPENAL_DLOPEN=<span class="hljs-number"><span class="hljs-number">0</span></span> USE_RENDERER_DLOPEN=<span class="hljs-number"><span class="hljs-number">0</span></span> SHLIBLDFLAGS=-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span></code> </pre> <br><h2 id="pervyy-zapusk">  Erster Start </h2><br><p>  Der Einfachheit halber werden wir auf qemu / x86 laufen.  Dazu m√ºssen Sie es installieren (hier und unten gibt es Befehle f√ºr Debian, da andere Distributionspakete m√∂glicherweise anders aufgerufen werden). </p><br><pre> <code class="hljs sql">sudo apt <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> qemu-<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>-i386</code> </pre> <br><p>  Und der Start selbst: </p><br><pre> <code class="hljs powershell">qemu<span class="hljs-literal"><span class="hljs-literal">-system</span></span><span class="hljs-literal"><span class="hljs-literal">-i386</span></span> <span class="hljs-literal"><span class="hljs-literal">-kernel</span></span> build/base/bin/embox <span class="hljs-literal"><span class="hljs-literal">-m</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-literal"><span class="hljs-literal">-vga</span></span> std <span class="hljs-literal"><span class="hljs-literal">-serial</span></span> stdio</code> </pre> <br><p>  Beim Starten von Quake wird jedoch sofort eine Fehlermeldung angezeigt </p><br><pre> <code class="hljs go">&gt; quake3 EXCEPTION [<span class="hljs-number"><span class="hljs-number">0x6</span></span>]: error = <span class="hljs-number"><span class="hljs-number">00000000</span></span> EAX=<span class="hljs-number"><span class="hljs-number">00000001</span></span> EBX=<span class="hljs-number"><span class="hljs-number">00d</span></span>56370 ECX=<span class="hljs-number"><span class="hljs-number">80200001</span></span> EDX=<span class="hljs-number"><span class="hljs-number">0781</span></span>abfd GS=<span class="hljs-number"><span class="hljs-number">00000010</span></span> FS=<span class="hljs-number"><span class="hljs-number">00000010</span></span> ES=<span class="hljs-number"><span class="hljs-number">00000010</span></span> DS=<span class="hljs-number"><span class="hljs-number">00000010</span></span> EDI=<span class="hljs-number"><span class="hljs-number">007</span></span>b5740 ESI=<span class="hljs-number"><span class="hljs-number">007</span></span>b5740 EBP=<span class="hljs-number"><span class="hljs-number">338968</span></span>ec EIP=<span class="hljs-number"><span class="hljs-number">0081d</span></span>370 CS=<span class="hljs-number"><span class="hljs-number">00000008</span></span> EFLAGS=<span class="hljs-number"><span class="hljs-number">00210202</span></span> ESP=<span class="hljs-number"><span class="hljs-number">37895d</span></span>6d SS=<span class="hljs-number"><span class="hljs-number">53535353</span></span></code> </pre><br><p>  Der Fehler wird nicht vom Spiel, sondern vom Betriebssystem angezeigt. <del>  Debag zeigte, dass dieser Fehler durch unvollst√§ndige SIMD-Unterst√ºtzung f√ºr x86 in QEMU verursacht wurde: Ein Teil der Anweisungen wird nicht unterst√ºtzt und l√∂st eine unbekannte Befehlsausnahme (ung√ºltiger Opcode) aus. </del>  <em>upd: Wie von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">WGH</a> in den Kommentaren vorgeschlagen, bestand das eigentliche Problem darin, dass ich vergessen habe, die SSE-Unterst√ºtzung in cr0 / cr4 explizit zu aktivieren, sodass mit QEMU alles in Ordnung ist.</em> </p><br><p>  Dies geschieht nicht in Quake selbst, sondern in OpenLibM (dies ist die Bibliothek, mit der wir mathematische Funktionen implementieren - <code>sin()</code> , <code>expf()</code> und dergleichen).  Patchen Sie OpenLibm so, dass <code>__test_sse()</code> SSE nicht wirklich √ºberpr√ºft, sondern einfach glaubt, dass es keine Unterst√ºtzung gibt. </p><br><p>  Die obigen Schritte reichen aus, um ausgef√ºhrt zu werden. Die folgende Ausgabe ist in der Konsole sichtbar: </p><br><pre> <code class="hljs coffeescript">&gt; quake3 ioq3 <span class="hljs-number"><span class="hljs-number">1.36</span></span> linux-x86_64 Nov <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2018</span></span> SSE instruction set <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> available ----- FS_Startup ----- We are looking <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the current search path: <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>.q3a/baseq3 ./baseq3 ---------------------- <span class="hljs-number"><span class="hljs-number">0</span></span> files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pk3 files <span class="hljs-string"><span class="hljs-string">"pak0.pk3"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> missing. Please copy it <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> your legitimate Q3 CDROM. Point Release files are missing. Please re-install the <span class="hljs-number"><span class="hljs-number">1.32</span></span> point release. Also check that your ioq3 executable <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the correct place <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> that every file <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-string"><span class="hljs-string">"baseq3 "</span></span> directory <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> present <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> readable ERROR: couldn<span class="hljs-string"><span class="hljs-string">'t open crashlog.txt</span></span></code> </pre> <br><p>  Quake3 ist bereits nicht schlecht, versucht zu starten und zeigt sogar eine Fehlermeldung an!  Wie Sie sehen k√∂nnen, fehlen ihm die Dateien im <code>baseq3</code> Verzeichnis.  Es enth√§lt Sounds, Texturen und all das.  Beachten Sie, dass <code>pak0.pk3</code> von einer lizenzierten CD-ROM <code>pak0.pk3</code> sollte (ja, Open Source bedeutet keine freie Nutzung). </p><br><h3 id="podgotovka-diska">  Datentr√§gervorbereitung </h3><br><pre> <code class="hljs pgsql">sudo apt install qemu-utils #  qcow2- qemu-img <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> -f qcow2 quake.img <span class="hljs-number"><span class="hljs-number">1</span></span>G #   nbd sudo modprobe nbd max_part=<span class="hljs-number"><span class="hljs-number">63</span></span> #  qcow2-      sudo qemu-nbd -c /dev/nbd0 quake.img sudo mkfs.ext4 /dev/nbd0 sudo mount /dev/nbd0 /mnt cp -r <span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/q3/baseq3 /mnt sync sudo umount /mnt sudo qemu-nbd -d /dev/nbd0</code> </pre> <br><p>  Jetzt k√∂nnen Sie das Blockger√§t an qemu √ºbertragen </p><br><pre> <code class="hljs powershell">qemu<span class="hljs-literal"><span class="hljs-literal">-system</span></span><span class="hljs-literal"><span class="hljs-literal">-i386</span></span> <span class="hljs-literal"><span class="hljs-literal">-kernel</span></span> build/base/bin/embox <span class="hljs-literal"><span class="hljs-literal">-m</span></span> <span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-literal"><span class="hljs-literal">-vga</span></span> std <span class="hljs-literal"><span class="hljs-literal">-serial</span></span> stdio <span class="hljs-literal"><span class="hljs-literal">-hda</span></span> quake.img</code> </pre> <br><p>  Wenn das System gestartet wird, mounten Sie die Festplatte auf <code>/mnt</code> und f√ºhren Sie quake3 in diesem Verzeichnis aus. Diesmal st√ºrzt es sp√§ter ab </p><br><pre> <code class="hljs dos">&gt; mount -t ext4 /dev/hda1 /mnt &gt; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /mnt &gt; quake3 ioq3 <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">36</span></span> linux-x86_64 Nov <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2018</span></span> SSE instruction <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> available ----- FS_Startup ----- We are looking <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the current search <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>: //.q3a/baseq3 ./baseq3 ./baseq3/pak8.pk3 (<span class="hljs-number"><span class="hljs-number">9</span></span> files) ./baseq3/pak7.pk3 (<span class="hljs-number"><span class="hljs-number">4</span></span> files) ./baseq3/pak6.pk3 (<span class="hljs-number"><span class="hljs-number">64</span></span> files) ./baseq3/pak5.pk3 (<span class="hljs-number"><span class="hljs-number">7</span></span> files) ./baseq3/pak4.pk3 (<span class="hljs-number"><span class="hljs-number">272</span></span> files) ./baseq3/pak3.pk3 (<span class="hljs-number"><span class="hljs-number">4</span></span> files) ./baseq3/pak2.pk3 (<span class="hljs-number"><span class="hljs-number">148</span></span> files) ./baseq3/pak1.pk3 (<span class="hljs-number"><span class="hljs-number">26</span></span> files) ./baseq3/pak0.pk3 (<span class="hljs-number"><span class="hljs-number">3539</span></span> files) ---------------------- <span class="hljs-number"><span class="hljs-number">4073</span></span> files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pk3 files execing default.cfg couldn't exec q3config.cfg couldn't exec autoexec.cfg Hunk_Clear: reset the hunk ok Com_RandomBytes: using weak randomization ----- Client Initialization ----- Couldn't read q3history. ----- Initializing Renderer ---- ------------------------------- QKEY building random string Com_RandomBytes: using weak randomization QKEY generated ----- Client Initialization Complete ----- ----- R_Init ----- tty]EXCEPTION [<span class="hljs-number"><span class="hljs-number">0</span></span>xe]: error = <span class="hljs-number"><span class="hljs-number">00000000</span></span> EAX=<span class="hljs-number"><span class="hljs-number">00000000</span></span> EBX=<span class="hljs-number"><span class="hljs-number">00</span></span>d2a2d4 ECX=<span class="hljs-number"><span class="hljs-number">00000000</span></span> EDX=<span class="hljs-number"><span class="hljs-number">111011</span></span>e0 GS=<span class="hljs-number"><span class="hljs-number">00000010</span></span> <span class="hljs-built_in"><span class="hljs-built_in">FS</span></span>=<span class="hljs-number"><span class="hljs-number">00000010</span></span> ES=<span class="hljs-number"><span class="hljs-number">00000010</span></span> DS=<span class="hljs-number"><span class="hljs-number">00000010</span></span> EDI=<span class="hljs-number"><span class="hljs-number">0366</span></span>d158 ESI=<span class="hljs-number"><span class="hljs-number">111011</span></span>e0 EBP=<span class="hljs-number"><span class="hljs-number">37869918</span></span> EIP=<span class="hljs-number"><span class="hljs-number">00000000</span></span> CS=<span class="hljs-number"><span class="hljs-number">00000008</span></span> EFLAGS=<span class="hljs-number"><span class="hljs-number">00010212</span></span> ESP=<span class="hljs-number"><span class="hljs-number">006</span></span>ef6ca SS=<span class="hljs-number"><span class="hljs-number">111011</span></span>e0 EXCEPTION [<span class="hljs-number"><span class="hljs-number">0</span></span>xe]: error = <span class="hljs-number"><span class="hljs-number">00000000</span></span></code> </pre> <br><p><del>  Dieser Fehler tritt erneut bei SIMD in Qemu auf. </del>  <em>upd: Wie von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">WGH</a> in den Kommentaren vorgeschlagen, bestand das eigentliche Problem darin, dass ich vergessen habe, die SSE-Unterst√ºtzung in cr0 / cr4 explizit zu aktivieren, sodass mit QEMU alles in Ordnung ist.</em>  Dieses Mal werden die Anweisungen in der virtuellen Quake3 x86-Maschine verwendet.  Das Problem wurde gel√∂st, indem die Implementierung f√ºr x86 durch eine interpretierte VM ersetzt wurde (mehr √ºber die virtuelle Maschine Quake3 und im Prinzip √ºber Architekturfunktionen k√∂nnen Sie alles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">im selben Artikel</a> lesen).  Danach werden unsere Funktionen f√ºr SDL aufgerufen, aber nat√ºrlich passiert nichts, weil  Diese Funktionen tun noch nichts. </p><br><h2 id="dobavlyaem-podderzhku-grafiki">  Grafikunterst√ºtzung hinzuf√ºgen </h2><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SDL_VideoDevice *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createDevice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> devindex)</span></span></span><span class="hljs-function"> </span></span>{ ... device-&gt;GL_GetProcAddress = glGetProcAddress; device-&gt;GL_CreateContext = glCreateContext; ... } <span class="hljs-comment"><span class="hljs-comment">/*   OpenGL- */</span></span> <span class="hljs-function"><span class="hljs-function">SDL_GLContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">glCreateContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_THIS, SDL_Window *window)</span></span></span><span class="hljs-function"> </span></span>{ OSMesaContext ctx; <span class="hljs-comment"><span class="hljs-comment">/*   -  --    .. */</span></span> sdl_init_buffers(); <span class="hljs-comment"><span class="hljs-comment">/*    Mesa */</span></span> ctx = OSMesaCreateContextExt(OSMESA_BGRA, <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); OSMesaMakeCurrent(ctx, fb_base, GL_UNSIGNED_BYTE, fb_width, fb_height); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ctx; }</code> </pre> <br><p>  Der zweite Handler wird ben√∂tigt, um der SDL mitzuteilen, welche Funktionen bei der Arbeit mit OpenGL aufgerufen werden sollen. </p><br><p>  Dazu starten wir ein Array und pr√ºfen von Anfang bis Anfang, welche Aufrufe fehlen. </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *proc; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *fn; } embox_sdl_tbl[] = { { <span class="hljs-string"><span class="hljs-string">"glClear"</span></span>, glClear }, { <span class="hljs-string"><span class="hljs-string">"glClearColor"</span></span>, glClearColor }, { <span class="hljs-string"><span class="hljs-string">"glColor4f"</span></span>, glColor4f }, { <span class="hljs-string"><span class="hljs-string">"glColor4ubv"</span></span>, glColor4ubv }, { <span class="hljs-number"><span class="hljs-number">0</span></span> }, }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">glGetProcAddress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_THIS, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *proc)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; embox_sdl_tbl[i].proc != <span class="hljs-number"><span class="hljs-number">0</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(embox_sdl_tbl[i].proc, proc)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> embox_sdl_tbl[i].fn; } } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"embox/sdl: Failed to find %s\n"</span></span>, proc); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  Bei einigen Neustarts wird die Liste vollst√§ndig genug, um einen Begr√º√üungsbildschirm und ein Men√º zu zeichnen.  Zum Gl√ºck hat Mesa alle notwendigen Funktionen.  Das einzige ist, dass es aus irgendeinem Grund keine <code>glGetString()</code> -Funktion gibt, <code>glGetString()</code> musste <code>glGetString()</code> verwendet <code>_mesa_GetString()</code> . </p><br><p>  Wenn die Anwendung gestartet wird, wird ein Begr√º√üungsbildschirm angezeigt. Prost! </p><br><img src="https://habrastorage.org/webt/_o/te/pv/_otepvhrhcyqp1aotjvgcylm4fs.png"><br><br><h2 id="dobavlyaem-ustroystva-vvoda">  Eingabeger√§te hinzuf√ºgen </h2><br><p>  F√ºgen Sie der SDL Tastatur- und Mausunterst√ºtzung hinzu. </p><br><p>  Um mit Ereignissen arbeiten zu k√∂nnen, m√ºssen Sie einen Handler hinzuf√ºgen </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SDL_VideoDevice *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createDevice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> devindex)</span></span></span><span class="hljs-function"> </span></span>{ ... device-&gt;PumpEvents = pumpEvents; ... }</code> </pre> <br><p>  Beginnen wir mit der Tastatur.  Wir legen eine Funktion auf, um das Dr√ºcken / Loslassen einer Taste zu unterbrechen.  Diese Funktion sollte sich an das Ereignis erinnern (im einfachsten Fall schreiben wir einfach in eine lokale Variable, Warteschlangen k√∂nnen bei Bedarf verwendet werden). Der Einfachheit halber speichern wir nur das letzte Ereignis. </p><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> input_event last_event; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sdl_indev_eventhnd</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">struct</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input_dev *indev</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*    ,   last_event */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> == input_dev_event(indev, &amp;last_event)) { } }</code> </pre><br><p>  Dann <code>pumpEvents()</code> in <code>pumpEvents()</code> das Ereignis und √ºbergeben es an die SDL: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pumpEvents</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_THIS</span></span></span><span class="hljs-function">)</span></span> { SDL_Scancode scancode; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> pressed; scancode = scancode_from_event(&amp;last_event); pressed = is_press(last_event); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pressed) { SDL_SendKeyboardKey(SDL_PRESSED, scancode); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SDL_SendKeyboardKey(SDL_RELEASED, scancode); } }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Weitere Informationen zu Schl√ºsselcodes und SDL_Scancode</b> <div class="spoiler_text"><p>  SDL verwendet eine eigene Aufz√§hlung f√ºr Schl√ºsselcodes, daher m√ºssen Sie den Betriebssystemschl√ºsselcode in SDL-Code konvertieren. </p><br><p>  Eine Liste dieser Codes ist in der Datei <code>SDL_scancode.h</code> definiert </p><br><p>  Sie k√∂nnen den ASCII-Code beispielsweise folgenderma√üen konvertieren (nicht alle ASCII-Zeichen sind hier, aber diese reichen v√∂llig aus): </p><br><pre> <code class="hljs powershell"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> int key_to_sdl[] = { [<span class="hljs-string"><span class="hljs-string">' '</span></span>] = SDL_SCANCODE_SPACE, [<span class="hljs-string"><span class="hljs-string">'\r'</span></span>] = SDL_SCANCODE_RETURN, [<span class="hljs-number"><span class="hljs-number">27</span></span>] = SDL_SCANCODE_ESCAPE, [<span class="hljs-string"><span class="hljs-string">'0'</span></span>] = SDL_SCANCODE_0, [<span class="hljs-string"><span class="hljs-string">'1'</span></span>] = SDL_SCANCODE_1, ... [<span class="hljs-string"><span class="hljs-string">'8'</span></span>] = SDL_SCANCODE_8, [<span class="hljs-string"><span class="hljs-string">'9'</span></span>] = SDL_SCANCODE_9, [<span class="hljs-string"><span class="hljs-string">'a'</span></span>] = SDL_SCANCODE_A, [<span class="hljs-string"><span class="hljs-string">'b'</span></span>] = SDL_SCANCODE_B, [<span class="hljs-string"><span class="hljs-string">'c'</span></span>] = SDL_SCANCODE_C, ... [<span class="hljs-string"><span class="hljs-string">'x'</span></span>] = SDL_SCANCODE_X, [<span class="hljs-string"><span class="hljs-string">'y'</span></span>] = SDL_SCANCODE_Y, [<span class="hljs-string"><span class="hljs-string">'z'</span></span>] = SDL_SCANCODE_Z, };</code> </pre></div></div><br><p>  Das ist alles mit der Tastatur, der Rest wird von SDL und Quake selbst erledigt.  √úbrigens stellte sich hier heraus, dass Quake irgendwo bei der Verarbeitung von Tastenanschl√§gen Anweisungen verwendet, die von QEMU nicht unterst√ºtzt werden. Sie m√ºssen von der virtuellen x86-Maschine zur interpretierten virtuellen Maschine wechseln. Dazu f√ºgen wir dem Makefile <code>BASE_CFLAGS += -DNO_VM_COMPILED</code> . </p><br><p>  Danach k√∂nnen Sie die Bildschirmschoner feierlich ‚Äû√ºberspringen‚Äú und sogar das Spiel starten (Fehler hacken :)).  Es war angenehm √ºberrascht, dass alles so gerendert wird, wie es sollte, wenn auch mit sehr niedrigen fps. </p><br><p><img src="https://habrastorage.org/webt/fk/rx/cj/fkrxcjn_k-kheteoo4ak1tdwb2q.png"></p><br><p>  Jetzt k√∂nnen Sie die Mausunterst√ºtzung starten.  F√ºr Maus-Interrupts ben√∂tigen Sie einen weiteren Handler, und die Ereignisbehandlung muss etwas kompliziert sein.  Wir beschr√§nken uns nur auf die linke Maustaste.  Es ist klar, dass Sie auf die gleiche Weise den richtigen Schl√ºssel, das richtige Rad usw. hinzuf√ºgen k√∂nnen. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pumpEvents</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_THIS</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (from_keyboard(&amp;last_event)) { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_left_click(&amp;last_event)) { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> SDL_SendMouseButton(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, SDL_PRESSED, SDL_BUTTON_LEFT); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_left_release(&amp;last_event)) { <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> SDL_SendMouseButton(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, SDL_RELEASED, SDL_BUTTON_LEFT); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> SDL_SendMouseMotion(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, mouse_diff_x(), <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> mouse_diff_y()); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> } } }</code> </pre> <br><p>  Danach wird es m√∂glich, die Kamera zu steuern und zu schie√üen, Prost!  Tats√§chlich reicht das schon zum Spielen :) </p><br><p><img src="https://habrastorage.org/webt/q5/pz/lb/q5pzlbtkbrinpcmgdggt4e5vfma.png"></p><br><h2 id="optimizaciya">  Optimierung </h2><br><p>  Es ist nat√ºrlich cool, dass es Kontrolle und irgendeine Art von Grafik gibt, aber eine solche FPS ist absolut wertlos.  H√∂chstwahrscheinlich wird die meiste Zeit f√ºr die Arbeit an OpenGL aufgewendet (bei dem es sich um Software handelt und au√üerdem wird SIMD nicht verwendet), und die Implementierung der Hardwareunterst√ºtzung ist zu langwierig und kompliziert. </p><br><p>  Versuchen wir, das Spiel mit etwas Blut zu beschleunigen. </p><br><h3 id="optimizaciya-kompilyatora-i-snizhenie-razresheniya">  Compileroptimierung und niedrigere Aufl√∂sung </h3><br><p>  Wir bauen das Spiel, alle Bibliotheken und das Betriebssystem selbst mit <code>-O3</code> (wenn pl√∂tzlich jemand an dieser Stelle liest, aber nicht wei√ü, was dieses Flag ist - mehr √ºber GCC-Optimierungsflags finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ). </p><br><p>  Zus√§tzlich verwenden wir die Mindestaufl√∂sung von 320 x 240, um die Arbeit des Prozessors zu erleichtern. </p><br><h3 id="kvm">  Kvm </h3><br><p>  Mit KVM (Kernel-based Virtual Machine) k√∂nnen Sie die Hardwarevirtualisierung (Intel VT und AMD-V) verwenden, um die Leistung zu verbessern.  Qemu unterst√ºtzt diesen Mechanismus. Um ihn zu verwenden, m√ºssen Sie Folgendes tun. </p><br><p>  Zun√§chst m√ºssen Sie die Virtualisierungsunterst√ºtzung im BIOS aktivieren.  Ich habe ein Gigabyte B450M DS3H-Motherboard und AMD-V wird √ºber MIT -&gt; Erweiterte Frequenzeinstellungen -&gt; Erweiterte CPU-Kerneinstellungen -&gt; SVM-Modus -&gt; Aktiviert (Gigabyte, was ist los mit Ihnen?) Eingeschaltet. </p><br><p>  Dann setzen wir das notwendige Paket und f√ºgen das entsprechende Modul hinzu </p><br><pre> <code class="hljs powershell">sudo apt install qemu<span class="hljs-literal"><span class="hljs-literal">-kvm</span></span> sudo modprobe kvm<span class="hljs-literal"><span class="hljs-literal">-amd</span></span> <span class="hljs-comment"><span class="hljs-comment">#  kvm-intel</span></span></code> </pre> <br><p>  Das war's, jetzt k√∂nnen Sie qemu das <code>-enable-kvm</code> (oder <code>-no-kvm</code> , um keine Hardwarebeschleunigung zu verwenden). </p><br><h2 id="itog">  Zusammenfassung </h2><br><iframe width="560" height="315" src="https://www.youtube.com/embed/t6k_FSF-py0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Das Spiel wurde gestartet, die Grafiken werden nach Bedarf angezeigt, die Steuerung funktioniert.  Leider werden die Grafiken in einem Stream auf der CPU gezeichnet, auch ohne SIMD, da die Steuerung aufgrund der niedrigen fps (2-3 Bilder pro Sekunde) sehr unpraktisch ist. </p><br><p>  Der Portierungsprozess war interessant.  Vielleicht wird es in Zukunft m√∂glich sein, Quake auf einer Plattform mit Hardware-Grafikbeschleunigung zu starten, aber jetzt werde ich mich auf das konzentrieren, was ist. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de428634/">https://habr.com/ru/post/de428634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de428624/index.html">Jeffrey Richter, Pavel Yosifovich, Greg Young und alles in allem. Hardcore und Architektur bei DotNext 2018 Moskau</a></li>
<li><a href="../de428626/index.html">Wie man die Erweiterung in PHP7 schwieriger macht als "Hallo Welt" und nicht rot√§ugig wird. Teil 1</a></li>
<li><a href="../de428628/index.html">Arbeiten Sie mit abstrakten JavaScript-Syntaxb√§umen</a></li>
<li><a href="../de428630/index.html">Nein, Bitcoin wird unser Klima bis 2033 nicht zerst√∂ren.</a></li>
<li><a href="../de428632/index.html">Umgang mit Abfangj√§gern in Reaktion</a></li>
<li><a href="../de428636/index.html">Roskomnadzor wird eine Geldstrafe von Google zur√ºckfordern</a></li>
<li><a href="../de428638/index.html">Herzflammenmotor: QardioCore Heart Monitor Review</a></li>
<li><a href="../de428640/index.html">Mit dem Mobilteil in der Tasche: Snom DECT-Ger√§te f√ºr schnurlose Telefonnetzwerke</a></li>
<li><a href="../de428644/index.html">Low-Level-Brainfuck</a></li>
<li><a href="../de428646/index.html">Die iPhone-Modelle des letzten Jahres verlangsamen sich ebenfalls aufgrund des Batterieverschlei√ües</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>