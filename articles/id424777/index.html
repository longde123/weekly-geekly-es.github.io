<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👇🏽 💳 🎍 Menggunakan Konsul untuk Skala Layanan Stateful 👊🏽 🍣 🔋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada 22 September, kami mengadakan mitap non-standar pertama kami untuk pengembang sistem yang sarat muatan. Itu sangat keren, banyak umpan balik posi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Menggunakan Konsul untuk Skala Layanan Stateful</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/424777/">  <i>Pada 22 September, kami mengadakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mitap non-standar</a> pertama kami untuk pengembang sistem yang sarat muatan.</i>  <i>Itu sangat keren, banyak umpan balik positif pada laporan dan karena itu memutuskan tidak hanya untuk mengunggahnya, tetapi juga untuk mendekripsi Habr.</i>  <i>Hari ini kami menerbitkan pidato oleh Ivan Bubnov, DevOps dari BIT.GAMES.</i>  <i>Dia berbicara tentang implementasi layanan penemuan Konsul dalam proyek beban tinggi yang sudah berjalan untuk kemungkinan penskalaan cepat dan kegagalan layanan negara.</i>  <i>Dan juga tentang mengatur namespace yang fleksibel untuk aplikasi backend dan jebakan.</i>  <i>Sekarang sepatah kata untuk Ivan.</i> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/X4VYCrOCD3A" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Saya mengelola infrastruktur produksi di studio BIT.GAMES dan menceritakan kisah pengenalan konsul dari Hashicorp dalam proyek kami "Guild of Heroes" - RPG fantasi dengan pvp asinkron untuk perangkat seluler.  Tersedia di Google Play, App Store, Samsung, Amazon.  DAU sekitar 100.000, online dari 10 hingga 13 ribu.  Kami membuat game di Unity, jadi kami menulis klien di C # dan menggunakan bahasa skrip BHL kami sendiri untuk logika game.  Kami menulis bagian server di Golang (beralih dari PHP).  Berikutnya adalah arsitektur skematik proyek kami. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/dd/-v/gu/dd-vgufl1o4g4sjqu8luww4f56k.png"><br>  <i>Bahkan, ada lebih banyak layanan, hanya ada dasar-dasar logika permainan.</i> <br><br>  Jadi apa yang kita miliki.  Dari layanan tanpa kewarganegaraan, ini adalah: <br><br><ul><li>  nginx, yang kami gunakan sebagai Frontend dan Load Balancers dan mendistribusikan klien ke backend kami berdasarkan koefisien berat; </li><li>  gamed - backends, aplikasi yang dikompilasi dari Go.  Ini adalah poros utama dari arsitektur kami, mereka melakukan bagian terbesar dari pekerjaan dan berkomunikasi dengan semua layanan backend lainnya. </li></ul><br>  Dari layanan Stateful, yang utama kami miliki adalah: <br><br><ul><li>  Redis, yang kami gunakan untuk menyimpan informasi terbaru (kami juga menggunakannya untuk mengatur obrolan dalam game dan menyimpan notifikasi untuk pemain kami); </li><li>  Percona Server untuk Mysql adalah tempat penyimpanan informasi yang persisten (mungkin yang terbesar dan paling lambat dalam arsitektur apa pun).  Kami menggunakan garpu MySQL dan di sini kami akan membicarakannya lebih detail hari ini. </li></ul><br>  Selama proses desain, kami (seperti orang lain) berharap bahwa proyek ini akan berhasil dan menyediakan mekanisme sharding.  Ini terdiri dari dua entitas database MAINDB dan pecahan itu sendiri. <br><br><img src="https://habrastorage.org/webt/y2/sj/h-/y2sjh-qfoxlosksflpkvxuq3cxk.png"><br><br>  MAINDB adalah sejenis daftar isi - ini menyimpan informasi tentang data pecahan tertentu tentang kemajuan pemain yang disimpan.  Dengan demikian, rangkaian pengambilan informasi lengkap terlihat seperti ini: klien mengakses frontend, yang pada gilirannya mendistribusikannya kembali ke salah satu backend, backend menuju MAINDB, melokalisasi pecahan pemain, dan kemudian memilih data langsung dari beling itu sendiri. <br><br>  Tetapi ketika kami merancang, kami bukan proyek besar, jadi kami memutuskan untuk membuat pecahan pecahan hanya secara nominal.  Mereka semua berada di server fisik yang sama dan kemungkinan besar partisi database dalam server yang sama. <br><br>  Untuk cadangan, kami menggunakan replikasi slave master klasik.  Itu bukan solusi yang sangat baik (saya akan mengatakan mengapa sedikit kemudian), tetapi kelemahan utama dari arsitektur itu adalah bahwa semua backend kita tahu tentang layanan backend lain secara eksklusif oleh alamat IP.  Dan jika terjadi kecelakaan konyol lain di pusat data dari jenis " <i>maaf, teknisi kami menekan kabel pada server Anda sementara melayani yang lain dan kami membutuhkan waktu yang sangat lama untuk mencari tahu mengapa server Anda tidak terhubung</i> " diperlukan gerakan besar dari kami.  Pertama, ini adalah pembangunan kembali dan pra-instalasi backend dari server cadangan IP untuk tempat yang gagal.  Kedua, setelah kejadian itu, perlu untuk mengembalikan tuan kita dari cadangan dari cadangan, karena ia dalam keadaan tidak konsisten dan membawanya ke keadaan terkoordinasi menggunakan replikasi yang sama.  Kemudian kami kembali memasang backend dan mengisi ulang.  Semua ini, tentu saja, menyebabkan downtime. <br><br>  Ada saatnya ketika direktur teknis kami (yang sangat saya ucapkan terima kasih) berkata: "Teman-teman, hentikan penderitaan, kita perlu mengubah sesuatu, mari mencari jalan keluar."  Pertama-tama, kami ingin mencapai proses penskalaan dan migrasi yang sederhana, mudah dipahami, dan paling penting - dikelola dari satu tempat ke tempat lain jika diperlukan.  Selain itu, kami ingin mencapai ketersediaan tinggi dengan mengotomatiskan failover. <br><br><img src="https://habrastorage.org/webt/lb/96/ys/lb96yszgjsbjtriury8zxqr0loa.png"><br><br>  Sumbu sentral dari penelitian kami telah menjadi Konsul dari Hashicorp.  Pertama, kami dinasihati, dan kedua, kami sangat tertarik dengan kesederhanaan, keramahan, dan tumpukan teknologi yang luar biasa dalam satu kotak: layanan penemuan dengan pemeriksaan kesehatan, penyimpanan bernilai-kunci dan hal terpenting yang ingin kami gunakan adalah DNS yang memutuskan kepada kami alamat dari domain service.consul. <br><br>  Consul juga menyediakan UI Web dan REST API yang hebat untuk mengelola semua ini. <br><br>  Adapun ketersediaan tinggi, kami memilih dua utilitas untuk failover otomatis: <br><br><ul><li>  MHA untuk MySQL </li><li>  Redis-sentinel </li></ul><br><img src="https://habrastorage.org/webt/bc/e5/dg/bce5dg_dxoi0irv9gic5e4d1jki.png"><br><br>  Dalam kasus MHA untuk MySQL, kami menuangkan agen ke dalam node dengan basis data, dan mereka memantau keadaan mereka.  Ada batas waktu tertentu dengan kegagalan master, setelah itu berhenti budak dibuat untuk menjaga konsistensi dan master cadangan kami dari master yang muncul dalam keadaan tidak konsisten tidak mengambil data.  Dan kami menambahkan web hook ke agen-agen ini, yang terdaftar di sana IP baru cadangan master di Consul sendiri, setelah itu masuk ke penerbitan DNS. <br><br>  Dengan Redis-sentinel, semuanya bahkan lebih sederhana.  Karena dia sendiri melakukan bagian terbesar dari pekerjaan, semua yang tersisa untuk kita lakukan adalah untuk memperhitungkan dalam pemeriksaan kesehatan bahwa Redis-sentinel harus dilakukan secara eksklusif pada node master. <br><br>  Awalnya semuanya bekerja dengan sempurna, seperti jam.  Kami tidak punya masalah di bangku tes.  Tapi itu layak pindah ke lingkungan alami transfer data dari pusat data yang dimuat, mengingat beberapa OOM-kill (ini kehabisan memori, di mana proses tersebut dibunuh oleh inti sistem) dan mengembalikan layanan atau hal-hal yang lebih canggih yang mempengaruhi ketersediaan layanan - bagaimana kita segera mendapatkan risiko serius positif palsu atau tidak ada respons yang terjamin sama sekali (jika Anda mencoba untuk memutar beberapa cek dalam upaya untuk melarikan diri dari positif palsu). <br><br><img src="https://habrastorage.org/webt/a9/8t/7i/a98t7i3cvbb18duz7mkcr8f4vqg.png"><br><br>  Pertama-tama, semuanya tergantung pada kesulitan menulis pemeriksaan kesehatan yang benar.  Tampaknya tugasnya cukup sepele - periksa apakah layanan ini berjalan di server dan port pingani Anda.  Tetapi, seperti yang diperlihatkan oleh praktik selanjutnya, menulis cek kesehatan ketika mengimplementasikan Konsul adalah proses yang sangat rumit dan memakan waktu.  Karena begitu banyak faktor yang mempengaruhi ketersediaan layanan Anda di pusat data tidak dapat diramalkan - mereka terdeteksi hanya setelah waktu tertentu. <br><br>  Selain itu, pusat data bukanlah struktur statis tempat Anda dibanjiri dan berfungsi sebagaimana mestinya.  Tetapi kami, sayangnya (atau untungnya), baru mengetahui hal ini nanti, tetapi untuk saat ini kami terinspirasi dan penuh keyakinan bahwa kami akan mengimplementasikan segala sesuatu pada produksi. <br><br><img src="https://habrastorage.org/webt/c3/kt/uz/c3ktuzba_fzzjqodfbfsdv6sj6k.png"><br><br>  Mengenai penskalaan, saya akan katakan secara singkat: kami mencoba menemukan sepeda yang sudah jadi, tetapi semuanya dirancang untuk arsitektur tertentu.  Dan, seperti dalam kasus Jetpants, kami tidak dapat memenuhi persyaratan yang dikenakannya pada arsitektur penyimpanan informasi yang persisten. <br><br>  Karena itu, kami memikirkan tentang skrip kami sendiri yang mengikat dan menunda pertanyaan ini.  Kami memutuskan untuk bertindak secara konsisten dan mulai dengan penerapan Konsul. <br><br><img src="https://habrastorage.org/webt/99/em/bk/99embkj_f7vdi-kta4rdme6ga6k.png"><br><br>  Konsul adalah desentralisasi, cluster terdistribusi yang beroperasi berdasarkan protokol gosip dan algoritma konsensus Raft. <br><br>  Kami memiliki equorum independen dari lima server (lima untuk menghindari situasi otak terpisah).  Untuk setiap node, kami menumpahkan agen Konsul dalam mode agen dan menumpahkan semua pemeriksaan kesehatan (mis. Tidak ada sehingga kami mengunggah satu pemeriksaan kesehatan ke server tertentu dan lainnya ke server tertentu).  Healthcheck ditulis sehingga mereka hanya lulus jika ada layanan. <br><br>  Kami juga menggunakan utilitas lain sehingga kami tidak perlu mempelajari backend kami untuk menyelesaikan alamat dari domain tertentu pada port non-standar.  Kami menggunakan Dnsmasq - ini menyediakan kemampuan untuk sepenuhnya menyelesaikan alamat pada node cluster yang kami butuhkan (yang di dunia nyata, jadi, tidak ada, tetapi ada secara eksklusif di dalam cluster).  Kami menyiapkan skrip otomatis untuk mengisi Ansible, mengunggah semuanya ke produksi, menyetel namespace, memastikan semuanya selesai.  Dan, sambil menggerakkan jari mereka, mengisi ulang backend kami, yang diakses bukan oleh alamat IP, tetapi dengan nama-nama ini dari server.consul domain. <br><br>  Semuanya dimulai pertama kali, sukacita kami tidak mengenal batas.  Tetapi masih terlalu dini untuk bersukacita, karena dalam satu jam kami memperhatikan bahwa pada semua simpul di mana backend kami berada, indikator rata-rata beban meningkat dari 0,7 menjadi 1,0, yang merupakan indikator yang agak gemuk. <br><br><img src="https://habrastorage.org/webt/em/ua/v_/emuav_oozpbvjdoa7yg1ldfeag0.png"><br><br>  Saya naik ke server untuk melihat apa yang terjadi dan menjadi jelas bahwa CPU memakan Konsul.  Di sini kita mulai mencari tahu, mulai perdukunan dengan strace (sebuah utilitas untuk sistem unix yang memungkinkan Anda untuk melacak syscall mana proses sedang berjalan), membuang statistik Dnsmasq untuk memahami apa yang terjadi pada node ini, dan ternyata kami melewatkan poin yang sangat penting.  Saat merencanakan integrasi, kami melewatkan cache data DNS dan ternyata backend kami menarik Dnsmasq untuk setiap gerakannya, dan itu, pada gilirannya, beralih ke Konsul dan semua ini menghasilkan 940 kueri DNS per detik yang sakit-sakitan. <br><br>  Jalan keluarnya tampak jelas - putar saja ttl dan semuanya akan menjadi lebih baik.  Tetapi di sini tidak mungkin menjadi fanatik, karena kami ingin menerapkan struktur ini untuk mendapatkan namespace dinamis yang mudah dikendalikan dan cepat berubah (oleh karena itu, kami tidak dapat menetapkan, misalnya, 20 menit).  Kami memutar ttl ke nilai optimal maksimum bagi kami, kami berhasil mengurangi tingkat permintaan per detik menjadi 540, tetapi ini tidak mempengaruhi indikator konsumsi CPU. <br><br>  Kemudian kami memutuskan untuk keluar dengan cara yang rumit, menggunakan file host kustom. <br><br><img src="https://habrastorage.org/webt/0p/li/01/0pli01ivofxzndxm9pa9xrtvu6m.png"><br><br>  Sangat baik bahwa kami memiliki segalanya untuk ini: sistem template yang sangat baik dari Consul, yang, berdasarkan keadaan cluster dan skrip template, menghasilkan file dalam bentuk apa pun, konfigurasi apa pun yang Anda inginkan.  Selain itu, Dnsmasq memiliki parameter konfigurasi addn-hosts yang memungkinkan Anda untuk menggunakan file host non-sistem sebagai file host tambahan yang sama. <br><br>  Apa yang kami lakukan, sekali lagi menyiapkan skrip dalam Ansible, mengunggahnya ke produksi dan mulai terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/p6/qe/3i/p6qe3iaqlloehk1ld7ptisb_0dg.png"><br><br>  Ada elemen tambahan dan file statis pada disk, yang cukup cepat dibuat ulang.  Sekarang rantai tampak cukup sederhana: gamed beralih ke Dnsmasq, dan pada gilirannya (alih-alih menarik agen Consula, yang akan bertanya pada server di mana kita memiliki simpul ini atau itu) hanya melihat file.  Ini memecahkan masalah dengan konsumsi CPU oleh Konsul. <br><br>  Sekarang semuanya mulai terlihat seperti yang kami rencanakan - benar-benar transparan untuk produksi kami, praktis tanpa memakan sumber daya. <br><br>  Kami cukup tersiksa pada hari itu dan dengan cemas kami pulang.  Mereka tidak takut sia-sia, karena pada malam hari peringatan dari pemantauan membangunkan saya dan memberi tahu saya bahwa kami memiliki kesalahan yang berskala besar (walaupun jangka pendek). <br><br><img src="https://habrastorage.org/webt/yg/yj/z_/ygyjz_upz8khxqgriqbsye0_xma.png"><br><br>  Berhubungan dengan log di pagi hari, saya melihat bahwa semua kesalahan adalah dari jenis host yang tidak diketahui sama.  Tidak jelas mengapa Dnsmasq tidak dapat menggunakan satu atau layanan lain dari file - sepertinya tidak ada sama sekali.  Untuk mencoba memahami apa yang sedang terjadi, saya menambahkan metrik khusus untuk membuat ulang file - sekarang saya tahu persis waktu kapan akan dibuat ulang.  Selain itu, template Konsul itu sendiri memiliki opsi cadangan yang sangat baik, yaitu  Anda dapat melihat status file regenerasi sebelumnya. <br><br>  Pada siang hari, insiden itu berulang beberapa kali dan menjadi jelas bahwa pada suatu titik waktu (walaupun sifatnya sporadis, tidak sistematis), file host tanpa layanan spesifik apa pun akan dibuat ulang.  Ternyata di pusat data tertentu (saya tidak akan melakukan anti-periklanan) ada jaringan yang agak tidak stabil - karena jaringan yang terputus-putus, kami benar-benar tidak dapat diprediksi berhenti melewati pemeriksaan kesehatan, atau bahkan simpul jatuh dari gugus.  Itu terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/3v/_q/ve/3v_qvengzywl6bqdchzxs2fshl4.png"><br><br>  Node keluar dari cluster, agen Konsul segera diberitahu tentang hal ini, dan template Konsul segera membuat ulang file host tanpa layanan yang kami butuhkan.  Ini umumnya tidak dapat diterima, karena masalahnya konyol: jika layanan tidak tersedia selama beberapa detik, siapkan waktu tunggu dan ulang (mereka tidak terhubung satu kali, tetapi yang kedua kali ternyata).  Tapi kami memprovokasi struktur baru di penjual ketika layanan menghilang begitu saja dari pandangan dan tidak ada cara untuk terhubung dengannya. <br><br>  Kami mulai berpikir tentang apa yang harus dilakukan dan memutar parameter batas waktu dalam Konsul, setelah itu diidentifikasi setelah berapa banyak node jatuh.  Kami berhasil memecahkan masalah ini dengan indikator yang cukup kecil, node berhenti rontok, tetapi ini tidak membantu dengan pemeriksaan kesehatan. <br><br>  Kami mulai berpikir untuk memilih parameter yang berbeda untuk pemeriksaan kesehatan, mencoba untuk entah bagaimana memahami kapan dan bagaimana ini terjadi.  Tetapi karena kenyataan bahwa semuanya terjadi secara sporadis dan tidak terduga, kami tidak dapat melakukannya. <br><br>  Kemudian kami pergi ke template Konsul dan memutuskan untuk membuat batas waktu untuk itu, setelah itu bereaksi terhadap perubahan status gugus.  Sekali lagi, tidak mungkin menjadi fanatik, karena kita bisa sampai pada situasi di mana hasilnya tidak akan lebih baik daripada DNS klasik, ketika kita membidik yang sama sekali berbeda. <br><br>  Dan sekali lagi direktur teknis kami datang ke penyelamatan dan berkata: "Guys, mari kita coba untuk melepaskan semua interaktivitas ini, kita semua dalam produksi dan tidak ada waktu untuk penelitian, kita perlu menyelesaikan masalah ini.  Mari manfaatkan hal-hal sederhana dan mudah dimengerti. ”  Jadi kami sampai pada konsep menggunakan penyimpanan kunci-nilai sebagai sumber untuk menghasilkan file host. <br><br><img src="https://habrastorage.org/webt/ar/qm/kx/arqmkxvbfzahdo6qrlom1htydq4.png"><br><br>  Seperti apa tampilannya: kami menolak semua pemeriksaan kesehatan dinamis, menulis ulang skrip templat kami sehingga menghasilkan file berdasarkan data yang direkam dalam penyimpanan nilai kunci.  Di penyimpanan nilai-kunci, kami menggambarkan seluruh infrastruktur kami dalam bentuk nama kunci (ini adalah nama layanan yang kami butuhkan) dan nilai kunci (ini adalah nama dari simpul dalam gugus).  Yaitu  jika node ada di cluster, maka kita dengan mudah mendapatkan alamat IP-nya dan menuliskannya ke file hosts. <br><br>  Kami menguji semuanya, mengisinya dalam produksi, dan itu menjadi peluru perak dalam situasi tertentu.  Sekali lagi, kami cukup tersiksa sepanjang hari pulang, tetapi kembali sudah beristirahat, didorong, karena masalah ini tidak terulang dan tidak terulang selama setahun terakhir.  Dari mana saya pribadi menyimpulkan bahwa ini adalah keputusan yang tepat (khusus untuk kami). <br><br>  Jadi  Kami akhirnya mendapatkan apa yang kami inginkan dan mengatur namespace dinamis untuk backend kami.  Lebih lanjut kami berupaya memastikan ketersediaan tinggi. <br><br><img src="https://habrastorage.org/webt/m9/k0/nu/m9k0nueo_w_79ywwhcco0tgnq5u.png"><br><br>  Tetapi kenyataannya adalah bahwa cukup takut pada integrasi Konsul dan karena masalah yang kami temui, kami berpikir dan memutuskan bahwa menerapkan auto-failover bukanlah solusi yang baik, karena sekali lagi kita mengambil risiko kesalahan positif atau kegagalan.  Proses ini buram dan tidak terkendali. <br><br>  Oleh karena itu, kami menempuh jalan yang lebih sederhana (atau kompleks): kami memutuskan untuk meninggalkan kegagalan dengan hati nurani administrator yang bertugas, tetapi memberinya alat tambahan lain.  Kami telah mengganti replikasi master slave dengan replikasi master master dalam mode Baca saja.  Ini menghilangkan sejumlah besar sakit kepala dalam proses failover'ov - ketika Anda mendapatkan panduan, yang perlu Anda lakukan adalah mengubah nilai dalam penyimpanan k / v menggunakan UI Web atau perintah dalam API dan sebelum itu, mode Baca saja master cadangan. <br><br>  Setelah insiden selesai, master kontak dan secara otomatis datang ke keadaan terkoordinasi tanpa tindakan yang tidak perlu.  Kami berhenti pada opsi ini dan menggunakannya seperti sebelumnya - bagi kami itu senyaman mungkin, dan yang paling penting sesederhana mungkin, sejernih dan terkontrol. <br><br><img src="https://habrastorage.org/webt/mr/fn/tc/mrfntctgtpanvrkqhlqmbm9liue.png"><br>  <i>Antarmuka Web Konsul</i> <br><br>  Di sebelah kanan adalah penyimpanan k / v dan layanan kami terlihat, yang kami gunakan dalam gamed;  nilai adalah nama simpul. <br><br>  Sedangkan untuk penskalaan, kami mulai menerapkannya ketika pecahan sudah penuh di satu server, basis bertambah, menjadi lambat, jumlah pemain meningkat, kami bertukar dan kami memiliki tugas mendistribusikan semua pecahan ke server kami yang berbeda. <br><br><img src="https://habrastorage.org/webt/0b/yc/zg/0byczgl-2ugpi8z_dgwzytcmrw4.png"><br><br>  Bagaimana kelihatannya: menggunakan utilitas XtraBackup, kami memulihkan cadangan kami pada sepasang server baru, setelah itu master baru digantung dengan seorang budak pada yang lama.  Itu datang ke keadaan yang konsisten, kami mengubah nilai kunci dalam k / v-storage dari nama node master lama ke nama node master baru.  Kemudian (ketika kami percaya bahwa semuanya berjalan dengan benar dan semua bermain dengan pilihan mereka, pembaruan, sisipan pergi ke master baru), kami hanya harus membunuh replikasi dan membuat drop database yang didambakan pada produksi, karena kita semua suka melakukan dengan database yang tidak perlu. <br><br><img src="https://habrastorage.org/webt/1x/6k/pw/1x6kpwybgw6-wsgscd6r1kylk-u.png"><br><br>  Jadi pecahan kami hancur.      40        ,      backend'         (  ,      —      ). <br><br><img src="https://habrastorage.org/webt/gm/du/bj/gmdubjovhtlet9n2-bljkeqz7oq.png"><br><br>    failover',     —  20  40      .         . <br><br>       —  ,    ,            -   ,     . <br><br> -,     ,          ,   ,   -  ,     ,       ,     . <br><br>  - ,            ,   ;          —    , ,    ,   . <br><br><h3>    </h3><br> <b>   k/v   —      ?</b> <br><br> K/v-     Consul-   -  ,     http- RESTful API  Web UI. <br><br>     ,   -             ,     ,   . <br><br> <b>       ,     Redis?</b> <br><br>        ,    - . <br><br> -,          backend. -,      backend',       —    .  Yaitu       ,     MAINDB        ,   .        .                  -  ,       . <br><br>      - ,       inmemory key-value    -. <br><br> <b>   ?</b> <br><br>    MySQL — Percona server. <br><br> <b>            ?      Maria,     MHA for MySQL,    Galera.</b> <br><br>      Galera.    -   « »       Galera       ,     .       ,       . <br><br>    ,     —         ,         ,     -  ,    ,         ,   . <br><br><h3>    Pixonic DevGAMM Talks </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">CICD:        </a> ( ,   Pixonic); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">     -  Quake Champions</a> ( , backend- Saber Interactive); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> -  - Tacticool</a> ( , Lead Software Engineer  PanzerDog); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> ECS, C# Job System  SRP    </a> ( , Field Engineer  Unity); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> KISS  </a> ( , Lead Game Programmer  1C Game Studios); </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">      </a> ( , Deputy Technical Officer  Pixonic). </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Cucumber  :  BDD-    </a> ( , Technical Product Manager  ALICE Platform). </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id424777/">https://habr.com/ru/post/id424777/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id424763/index.html">Editor teks bukan matematika tertinggi Anda, di sini Anda perlu berpikir</a></li>
<li><a href="../id424765/index.html">Manajemen negara dalam aplikasi Flutter</a></li>
<li><a href="../id424767/index.html">Kami membuat kue dari Habr. Lagi</a></li>
<li><a href="../id424771/index.html">Pengalaman pribadi: dari ide dan lembar kosong hingga versi konsep situs</a></li>
<li><a href="../id424773/index.html">Pemodelan biofarma dan numerik: Pengalaman dan praktik Amgen</a></li>
<li><a href="../id424779/index.html">SPA multi-halaman dalam Python</a></li>
<li><a href="../id424781/index.html">Mengajar dan menguji jaringan saraf pada PyTorch menggunakan Ignite</a></li>
<li><a href="../id424787/index.html">Wawancara dengan Aaron Patterson, Pembicara Konferensi RubyRusia 2018</a></li>
<li><a href="../id424789/index.html">Bagaimana cara menyebarkan aplikasi Ruby on Rails dengan HAProxy Ingress, unicorn / puma, dan soket web</a></li>
<li><a href="../id424791/index.html">Memperluas kemampuan jaringan dari relay yang dapat diprogram menggunakan WI-FI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>