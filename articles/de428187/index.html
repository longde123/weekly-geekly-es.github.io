<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•í üëßüèº ‚òÄÔ∏è So schreiben Sie eine Erweiterung f√ºr die GNOME-Shell: Nicht st√∂ren üë©üèø‚Äçüîß üï° üèéÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alles begann mit der Umstellung auf eine neue Version einer Linux-Distribution und dort auf die ber√ºchtigte GNOME-Shell (kurz GH) in Javascript. Nun, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So schreiben Sie eine Erweiterung f√ºr die GNOME-Shell: Nicht st√∂ren</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428187/"><p>  Alles begann mit der Umstellung auf eine neue Version einer Linux-Distribution und dort auf die <em>ber√ºchtigte</em> GNOME-Shell (kurz GH) in Javascript.  Nun, ok, auf JS so auf JS funktioniert es - und okay. </p><br><p> Gleichzeitig hat das Tempo meiner Arbeit lange Zeit verlangt, einen normalen Mailer zu finden, anstatt die Tonnen von Megabyte auf der Registerkarte <code>outlook.office.com</code> im Browser zu bremsen und zu verschlingen.  Und jetzt stellte ich fest, dass es in unserer Zeit mehrere fast ausgezeichnete Kandidaten gibt, ein Problem - der Mailer begann mich mit Benachrichtigungen √ºber neue Briefe zu bekommen - und Ton und Popup-Inschriften. </p><br><p>  Was zu tun ist?  Die Entscheidung, die Do Not Disturb-Erweiterung zu schreiben, kam nicht sofort, ich wollte wirklich kein Fahrrad schreiben und / oder mich in der Entwicklung / im Code / in Tonnen von Fehlern festsetzen, aber ich entschied mich und m√∂chte jetzt meine Erfahrungen mit Habr teilen.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">1</a></sup> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/737/175/2b5/7371752b5fb33b8858bff75857fbfa83.jpg"></p><a name="habracut"></a><br><h2 id="tehnicheskie-trebovaniya">  Technische Anforderungen </h2><br><p>  Ich m√∂chte haben <del>  eine gro√üe </del>  Schaltfl√§che zum Deaktivieren von Benachrichtigungen und Sounds f√ºr die Zeit Ihrer Wahl: 20 Minuten, 40 Minuten, 1 Stunde, 2 Stunden, 4, 8 und 24 Stunden.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">2</a></sup> Ja, Timing wie in Slack. </p><br><p>  Auf den Erweiterungen von extensions.gnome.org gab es eine Erweiterung "Do Not Disturb Button", die als Modell f√ºr das Schreiben der Erweiterung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Do Not Disturb Time diente</a> . </p><br><h2 id="konechnyy-rezultat-do-not-disturb-timehttpsextensionsgnomeorgextension1484do-not-disturb-time">  Endergebnis: Zeit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">nicht st√∂ren</a> </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/104/41d/479/10441d479062c7540a2743c6fb0b852d.png" alt="Zeit nicht st√∂ren"></p><br><p>  Installieren Sie von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">extensions.gnome.org</a> . <br>  Quellen auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> : Sterne setzen, Gabel, Verbesserungen anbieten. </p><br><h3 id="kak-ustanovit-rasshirenie-gh-instrukciya">  So installieren Sie die GH-Erweiterung: Anleitung </h3><br><ol><li>  Installieren Sie das <em>chrome-gnome-shell-</em> Paket, einen Browser-Connector, am Beispiel von Ubuntu: <br> <code>sudo apt install chrome-gnome-shell</code> </li> <li>  Installieren Sie √ºber den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> die Browser-Erweiterung: <br><ul><li>  Folgen Sie dem Link <em>Klicken Sie hier, um die Browser-Erweiterung zu installieren</em> </li><li>  In Ubuntu 18.04 funktionierte es f√ºr mich im Chrome / Chromium-Browser, in Fedora 28/29 - sowohl in Firefox als auch in Chromium </li></ul></li><li>  Wir suchen nach der gew√ºnschten Erweiterung in der Liste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://extensions.gnome.org</a> : Aktivieren, Deaktivieren, √Ñndern der Erweiterungseinstellungen. </li><li>  GEWINN! </li></ol><br><h2 id="nachalo">  Starten Sie </h2><br><p>  Erstellen Sie eine Erweiterung von Grund auf neu: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> gnome<span class="hljs-literal"><span class="hljs-literal">-shell</span></span><span class="hljs-literal"><span class="hljs-literal">-extension</span></span><span class="hljs-literal"><span class="hljs-literal">-tool</span></span> -<span class="hljs-literal"><span class="hljs-literal">-create</span></span><span class="hljs-literal"><span class="hljs-literal">-extension</span></span> Name: <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> Not Disturb Time Description: Disables notifications and sound <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a period Uuid: dnd@catbo.net Created extension <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'~/.local/share/gnome-shell/extensions/dnd@catbo.net'</span></span> <span class="hljs-comment"><span class="hljs-comment">#  gnome-shell Alt+F2, r, Enter #    https://extensions.gnome.org/local/      #   Gnome Shell - , gnome-shell   systemd,   journalctl -f /usr/bin/gnome-shell #    ,       gnome-shell journalctl -f /usr/bin/gnome-shell | grep -E 'dnd|$'</span></span></code> </pre> <br><p>  Die Datei <code>extension.js</code> im entsprechenden Verzeichnis ist der Einstiegspunkt in unsere Anwendung. In einer minimalen Version sieht sie folgenderma√üen aus: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{} <span class="hljs-comment"><span class="hljs-comment">//   ;    function disable() {} // --||-- ;     enable()</span></span></code> </pre> <br><h3 id="pervyy-kod">  Erster Code </h3><br><p>  Zuerst m√∂chten wir dem <code>Status Menu</code> oben rechts eine Schaltfl√§che hinzuf√ºgen, wie im obigen Screenshot. </p><br><p>  Wo soll ich anfangen?  Oh, fangen wir mit der Dokumentation an.  Wir haben alle offizielle Unterlagen.  Aber nein, die offizielle Dokumentation ist sehr klein und fragmentiert, aber dank <code>julio641742</code> und seiner inoffiziellen Dokumentation erhalten wir, was wir brauchen: </p><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">// 1 -    (1 - , 0 - , 0.5 -  ) // true,     let dndButton = new PanelMenu.Button(1, "DoNotDisturb", false); // `right` -      (left/center/right) Main.panel.addToStatusArea("DoNotDisturbRole", dndButton, 0, "right"); let box = new St.BoxLayout(); dndButton.actor.add_child(box); let icon = new St.Icon({ style_class: "system-status-icon" }); icon.set_gicon(Gio.icon_new_for_string("/tmp/bell_normal.svg")); box.add(icon);</span></span></code> </pre> <br><p>  Dieser Code erstellt das Schl√ºsselobjekt <code>dndButton</code> der <code>dndButton</code> Klasse - dies ist eine Schaltfl√§che, die speziell f√ºr das Statusmen√ºfenster entwickelt wurde.  Und wir f√ºgen es mit der Funktion Main.panel.addToStatusArea () in dieses Panel ein.  <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">3</a></sup> </p><br><p>  F√ºgen Sie Men√ºelemente mit daran befestigten Handlern ein. Beispiel: </p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> menuItem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PopupMenu.PopupMenuItem(<span class="hljs-string"><span class="hljs-string">"hello, world!"</span></span>); menuItem.connect(<span class="hljs-string"><span class="hljs-string">"activate"</span></span>, (menuItem, event) =&gt; { log(<span class="hljs-string"><span class="hljs-string">"hello, world!"</span></span>); }); dndButton.menu.addMenuItem(menuItem);</code> </pre> <br><p>  Vielen Dank, julio641742, f√ºr die Dokumentation!  Link: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/julio641742/gnome-shell-extension-reference</a> </p><br><p>  Der endg√ºltige Arbeitscode ist <a href="">hier</a> . </p><br><h2 id="osobennosti-raboty-gnome-shell-i-javascript">  GNOME Shell- und Javascript-Funktionen </h2><br><p>  Drau√üen ist Ende 2018 und Node.js / V8 ist das Hauptwerkzeug zum Ausf√ºhren von Javascript-Code.  Die gesamte moderne Webentwicklung beruht auf einem "Knoten". </p><br><p>  Die GNOME-Shell und die gesamte umgebende Infrastruktur verwenden jedoch eine andere Javascript-Engine, Mozillas SpiderMonkey, und dies bringt viele wichtige Leistungsunterschiede mit sich. </p><br><h3 id="import-moduley">  Module importieren </h3><br><p>  Im Gegensatz zu Node.js gibt es hier kein require () und auch keinen ausgefallenen ES6-Import.  Stattdessen gibt es ein spezielles Importobjekt, dessen Zugriff auf das Laden des Moduls f√ºhrt: </p><br><pre> <code class="hljs julia"> //<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PanelMenu = require(<span class="hljs-string"><span class="hljs-string">"ui/panelMenu"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PanelMenu = imports.ui.panelMenu;</code> </pre> <br><p>  In diesem Fall haben wir das Modul js / ui / panelMenu.js aus der GNOME Shell-Paketbibliothek heruntergeladen, die die Funktionalit√§t einer Schaltfl√§che mit einem Popup-Men√º implementiert. </p><br><p>  Ja, alle Schaltfl√§chen im Bedienfeld eines modernen Linux-Desktops, der GNOME verwendet, basieren auf panelMenu.js.  Einschlie√ülich: die gleiche rechte Taste mit Batterieanzeigen, Wi-Fi, Lautst√§rke;  Eingabesprachenschalter en-ru. </p><br><p>  Als n√§chstes gibt es ein spezielles Attribut <code>imports.searchPath</code> - dies ist eine Liste von Pfaden (Zeilen), in denen unsere JS-Module durchsucht werden.  Zum Beispiel haben wir eine Timer-Funktion einem separaten timeUtils.js-Modul zugewiesen und sie in der N√§he des Eingabepunkts unserer Erweiterung extension.js platziert.  Importieren Sie timeUtils.js wie folgt: </p><br><pre> <code class="hljs pgsql">//     , -  ~/.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/gnome-shell/extensions/&lt;your-<span class="hljs-keyword"><span class="hljs-keyword">extension</span></span>&gt;/ const Me = imports.misc.extensionUtils.getCurrentExtension(); //       imports.searchPath.unshift(Me.path); //   const timeUtils = imports.timeUtils;</code> </pre> <br><h3 id="logirovanie-otladka-javascript">  Protokollieren, Debuggen von Javascript </h3><br><p>  Nun, da wir Node.js nicht haben, haben wir unsere eigene Protokollierung.  Anstelle von console.log () stehen im Code mehrere Protokollierungsfunktionen zur Verf√ºgung, siehe gjs /../ global.cpp, static_funcs: </p><br><ul><li>  "log" = g_message ("JS LOG:" + message) - Anmeldung in stderr, Beispiel: </li></ul><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat helloWorld.js log(<span class="hljs-string"><span class="hljs-string">"hello, world"</span></span>); <span class="hljs-variable"><span class="hljs-variable">$</span></span> gjs helloWorld.js Gjs<span class="hljs-literal"><span class="hljs-literal">-Message</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">21.048</span></span>: JS LOG: hello, world</code> </pre> <br><ul><li>  "logError" - protokolliert den Ausnahmestapel: <br><ul><li>  Das erste erforderliche Argument ist eine Ausnahme, dann wird das gew√ºnschte durch ein Komma getrennt </li><li>  Beispiel: Wenn Sie den Stapel an der richtigen Stelle drucken m√ºssen: </li></ul></li></ul><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'bum!'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { logError(e, <span class="hljs-string"><span class="hljs-string">"what a fuck"</span></span>); }</code> </pre> <br><p>  und dies wird in stderr in stil zeichnen: </p><br><pre> <code class="hljs powershell">(gjs:<span class="hljs-number"><span class="hljs-number">28674</span></span>): Gjs<span class="hljs-literal"><span class="hljs-literal">-WARNING</span></span> **: <span class="hljs-number"><span class="hljs-number">13</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">46.951</span></span>: JS ERROR: what a fuck: Error: bum! ggg<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">5</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> ddd<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">12</span></span>:<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span>./gtk.js:<span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><ul><li>  "print" = g_print ("% s \ n", txt);  - im Gegensatz zu log () nur Text + "\ n" in stdout, ohne Pr√§fixe und Farbgebung </li><li>  "printerr" = g_printerr ("% s \ n", txt) - der Unterschied zum Druck ist der in stderr </li></ul><br><p>  Aber es gibt keinen sofort einsatzbereiten Debugger f√ºr SpiderMonkey (es war nicht umsonst, dass ich vor allem die verf√ºgbaren Tools f√ºr die Protokollierung sorgf√§ltig geschrieben habe, verwenden Sie ihn!).  Falls gew√ºnscht, k√∂nnen Sie JSRDbg ausprobieren: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eins</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zwei</a> . </p><br><h2 id="a-est-li-zhizn-dlya-js-koda-vne-gnome-shell">  Gibt es Leben f√ºr JS-Code au√üerhalb von GNOME Shell? </h2><br><p>  Es gibt.  Voll funktionsf√§hige Anwendungen, einschlie√ülich einer grafischen Benutzeroberfl√§che (GUI), k√∂nnen in Javascript geschrieben werden!  Sie m√ºssen sie mit gjs binar, dem JS-GTK-Code-Launcher, ausf√ºhren. Ein Beispiel f√ºr das Erstellen eines GUI-Fensters: </p><br><pre> <code class="hljs vala">$ which gjs /usr/bin/gjs $ dpkg --search /usr/bin/gjs gjs: /usr/bin/gjs $ cat gtk.js <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span> = imports.gi.<span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.init(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); let win = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.Window(); win.connect(<span class="hljs-string"><span class="hljs-string">"delete-event"</span></span>, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.main_quit(); }); win.show_all(); <span class="hljs-built_in"><span class="hljs-built_in">Gtk</span></span>.main(); $ gjs gtk.js</code> </pre> <br><p>  Oben habe ich erw√§hnt, dass Code in Module aufgeteilt und aus Javascript geladen wird.  Die Frage stellt sich, aber wie kann im Modul selbst festgestellt werden, ob es als "Hauptmodul" gestartet oder von einem anderen Modul geladen wird? </p><br><p>  Python hat ein authentisches Konstrukt: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: main()</code> </pre> <br><p>  In Node.js - √§hnlich: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.main === <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>) { main(); }</code> </pre> <br><p>  Ich habe keine offizielle Antwort auf diese Frage f√ºr Gjs / GH gefunden, aber ich habe mir eine solche Technik ausgedacht, die ich schnell mit dem Leser teilen m√∂chte (warum hat jemand ‚Äûdosyudova‚Äú gelesen? Respekt!). </p><br><p>  Der knifflige Trick basiert also auf der Analyse des aktuellen Aufrufstapels. Wenn er aus zwei oder mehr Zeilen besteht, befinden wir uns nicht im main () -Modul: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>().stack.split(<span class="hljs-regexp"><span class="hljs-regexp">/\r\n|\r|\n/g</span></span>).filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">line</span></span></span><span class="hljs-function"> =&gt;</span></span> line.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) .length == <span class="hljs-number"><span class="hljs-number">1</span></span> ) { main(); }</code> </pre> <br><h2 id="uborka-za-soboy">  Housekeeping </h2><br><p>  Jede GNOME-Shell-Erweiterung hat Zugriff auf alle Objekte in der gesamten GNOME-Shell.  Um beispielsweise die Anzahl der noch ungelesenen Benachrichtigungen anzuzeigen, gelangen wir zu dem Container mit ihnen im <code>Notification Area</code> in der Mitte oben, Nummer 4 im Bild (klicken Sie auf die Inschrift mit der aktuellen Uhrzeit, sie kann im realen Leben angeklickt werden, nicht hier): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/91e/eec/acc/91eeecaccdc67202335ce4d51d8d90d3.png" alt="Zeit nicht st√∂ren"></p><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> unseenlist = Main.panel.statusArea.dateMenu._messageList._notificationSection._list;</code> </pre> <br><p>  Sie k√∂nnen herausfinden, wie viele ungelesene Benachrichtigungen Ereignisse zum Hinzuf√ºgen und L√∂schen von Benachrichtigungen abonnieren: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> number = unseenlist.get_n_children(); unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-added"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"added!"</span></span>); }); unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-removed"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"removed!"</span></span>); });</code> </pre> <br><p>  Dies ist in Ordnung, aber der Benutzer kann manchmal entscheiden, dass er die X-Erweiterung nicht mehr ben√∂tigt, und auf die Schaltfl√§che klicken, um die Erweiterung zu deaktivieren.  F√ºr eine Erweiterung entspricht dies dem Aufrufen der Funktion disable (), und es sollten alle Anstrengungen unternommen werden, damit die deaktivierte Erweiterung das funktionierende GH nicht besch√§digt: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dndButton.destroy(); }</code> </pre> <br><p>  In diesem Fall m√ºssen Sie zus√§tzlich zum L√∂schen der Schaltfl√§che selbst die Ereignisse "Schauspieler hinzugef√ºgt" / "Schauspieler entfernt" abbestellen, zum Beispiel: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> signal = unseenlist.connect(<span class="hljs-string"><span class="hljs-string">"actor-added"</span></span>, () =&gt; { log(<span class="hljs-string"><span class="hljs-string">"added!"</span></span>); }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dndButton.destroy(); unseenlist.disconnect(signal); }</code> </pre> <br><p>  Wenn dies nicht getan wird, wird der Code der Handler beim entsprechenden Ereignis weiterhin aufgerufen. Versuchen Sie, den Status der Men√ºschaltfl√§che zu aktualisieren, die noch nicht vorhanden ist, und ... Die GNOME-Shell schl√§gt fehl.  Nun ja, wir werden es tun, Benutzer werden schw√∂ren, die Steine ‚Äã‚Äãwerden zu den GNOME Shell-Entwicklern und GNOME im Allgemeinen fliegen.  Das wirkliche Bild, Th. </p><br><p>  GNOME Shell / Gjs ist also eine Symbiose aus zwei Systemen, Glib / GTK und Javascript, und sie verfolgen einen unterschiedlichen Ansatz beim Ressourcenmanagement.  Glib / GTK erfordert die explizite Freigabe seiner Ressourcen (Schaltfl√§chen, Timer usw.).  Wenn das Objekt von der Javascript-Engine erstellt wurde, verhalten wir uns wie gewohnt (geben Sie nichts frei). </p><br><p>  Sobald unsere Erweiterung fertig ist und nicht "flie√üt", k√∂nnen Sie sie daher sicher auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://extensions.gnome.org ver√∂ffentlichen</a> . </p><br><h2 id="rezhim-gnomesessionpresencestatusbusy-i-dbus">  GnomeSession.PresenceStatus.BUSY- und DBus-Modus. </h2><br><p>  Wenn Sie nicht vergessen haben, f√ºhren wir die Erweiterung "Nicht st√∂ren" durch, mit der die Anzeige von Benachrichtigungen f√ºr den Benutzer deaktiviert wird. </p><br><p>  GNOME hat bereits eine Flagge, die f√ºr diesen Zustand verantwortlich ist.  Nach der Benutzeranmeldung wird der Gnome-Sitzungsprozess erstellt, in dem sich dieses Flag befindet: Dies ist das Attribut GsmPresencePrivate.status. Weitere Informationen finden Sie in den Quellen f√ºr gnome-session, gnome-session / gsm-Pr√§senz.c.  Wir erhalten Zugriff auf dieses Flag √ºber die DBus-Schnittstelle (solche Interprozesskommunikation). </p><br><p>  Nicht nur wir, sondern auch GH selbst ben√∂tigt Informationen zu dieser Flagge, um keine Benachrichtigungen anzuzeigen.  Dies ist in der GH-Quelle leicht zu finden: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._presence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GnomeSession.Presence(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">proxy, error</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onStatusChanged(proxy.status); }); ... this._presence.connectSignal(<span class="hljs-string"><span class="hljs-string">'StatusChanged'</span></span>, (proxy, senderName, [status]) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._onStatusChanged(status); });</code> </pre> <br><p>  In diesem Fall ist die Methode _onStatusChanged ein Handler, der auf eine Status√§nderung reagiert.  Wir kopieren diesen Code an uns selbst, passen ihn an - wir haben <sup><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">4</a></sup> Benachrichtigungen herausgefunden, es war ein Ton zu h√∂ren. </p><br><h2 id="vyklyuchenievklyuchenie-zvuka">  Stumm / Aufheben der Stummschaltung </h2><br><p>  Die meisten modernen Linux-Desktops werden von PulseAudio gesteuert. <del>  ber√ºchtigte Arbeit </del>  Programmautorschaft des ber√ºchtigten Lennart Poettering.  Bis jetzt bin ich noch nicht dazu gekommen, PulseAudio-Code zu schreiben, und ich war froh, die Gelegenheit zu haben, PulseAudio auf einer bestimmten Ebene zu verstehen. </p><br><p>  Als Ergebnis stellte sich heraus, dass f√ºr die Stummschaltung / Stummschaltung ein <code>pactl</code> Dienstprogramm <code>pactl</code> , oder vielmehr drei darauf basierende Befehle: </p><br><ul><li>  "pactl info": Finden Sie die <code>default sink</code> - welche Tonausgabe, wenn es mehrere gibt, der Standardton ist </li><li>  "pactl list sinks": Ermitteln Sie den Mute / Unute-Status des entsprechenden Ger√§ts </li><li>  "pactl set-sink-mute% (defaultSink) s% (isMute) s": f√ºr Mute / Unmute selbst </li></ul><br><p>  Unsere Aufgabe ist es also, Befehle / Prozesse auszuf√ºhren, deren Ausgabe stdout zu lesen und regelm√§√üig nach den gew√ºnschten Werten zu suchen.  Kurz gesagt, eine Standardaufgabe. </p><br><p>  Bei GNOME ist die glib-Kernbibliothek f√ºr die Erstellung von Prozessen verantwortlich, und es gibt eine hervorragende <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation</a> dazu.  Und nat√ºrlich ist sie in C. Und wir haben JS.  Es ist bekannt, dass das Gjs-Paket eine intelligente, "intuitive" Ebene zwischen der C-API und Javascript bildet.  Aber Sie verstehen immer noch, dass Sie Beispiele brauchen und Sie k√∂nnen nicht ohne googeln auskommen. </p><br><p>  Als Ergebnis erhalten wir dank des hervorragenden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kerns Arbeitscode</a> : </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> resList = GLib.spawn_command_line_sync(cmd); <span class="hljs-comment"><span class="hljs-comment">// res = true/false, /   // status = int,    // out/err = ,  stdout/stderr  let [res, out, err, status] = resList; if (res != true || status != 0) { print("not ok!"); } else { // do something useful }</span></span></code> </pre> <br><h2 id="sohranenie-nastroek-v-reestre">  Einstellungen speichern <del>  in der Registrierung </del></h2><br><p>  Nat√ºrlich gibt es unter Linux keine Registrierung.  Hier bist du nicht Windows.  Es gibt eine bessere, GSettings (dies ist die API), hinter der mehrere Implementierungsoptionen verborgen sind. Standardm√§√üig verwendet GNOME Dconf.  So sieht das GUI-Framework aus: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0fe/03c/eca/0fe03ceca6c7fc9338377fc5d0909024.png" alt="dconf-editor"></p><br><p>  - Was ist besser als das Speichern von Einstellungen in Nur-Text-Dateien?  - Fragen Sie die alten und b√§rtigen Linux-Benutzer.  Das Hauptmerkmal von GSettings ist, dass Sie √Ñnderungen an Einstellungen einfach abonnieren k√∂nnen, zum Beispiel: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Gio = imports.gi.Gio; settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Gio.Settings({ <span class="hljs-attr"><span class="hljs-attr">settings_schema</span></span>: schemaObj }); settings.connect(<span class="hljs-string"><span class="hljs-string">"changed::mute-audio"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log(<span class="hljs-string"><span class="hljs-string">"I see, you changed it!"</span></span>); });</code> </pre> <br><p>  Die einzige Einstellung in unserer Option "Nicht st√∂ren" ist die Option "Audio stumm schalten", mit der der Benutzer den Ton f√ºr eine "ruhige Stunde" oder nicht auf Wunsch des Benutzers ausschalten kann. </p><br><h2 id="i-nemnogo-klassiki-gui-na-gtk">  Und ein bisschen klassische GTK-GUI </h2><br><p>  Um dem Benutzer die Einstellungen unserer Erweiterung auf sch√∂ne Weise anzuzeigen (und nicht mit schmutzigen Pfoten in die Registrierung zu gelangen), bietet GH uns an, einen GUI-Code zu schreiben und ihn in die Funktion buildPrefsWidget () der Datei prefs.js einzuf√ºgen.  In diesem Fall sehen wir gegen√ºber unserer Erweiterung in der Liste der "Installierten Erweiterungen" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> eine zus√§tzliche Schaltfl√§che "Diese Erweiterung konfigurieren", indem Sie darauf klicken, welche unserer Sch√∂nheit angezeigt wird. </p><br><p>  Lassen Sie uns eine separate Registerkarte "Info" erstellen, da bekannt ist, dass das Programm ohne Ebout leider nicht vollst√§ndig ist. </p><br><p>  Um eine klassische grafische Oberfl√§che zu erstellen, verf√ºgt GTK im Allgemeinen √ºber eine ganze Reihe von Bausteinen und <code></code> , deren Quantit√§t und Qualit√§t Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> √ºberpr√ºfen k√∂nnen. </p><br><p>  Wir werden nur einige davon verwenden: </p><br><ul><li>  Gtk.Notebook ist eine Registerkarte, wie in einem Browser </li><li>  Gtk.VBox ist ein Container zum vertikalen Strukturieren einer Liste von Widgets </li><li>  Gtk.Label ist ein Grundelement, eine Inschrift, mit der HTML formatiert werden kann </li></ul><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildPrefsWidget</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    Gtk.Notebook    GUI let notebook = new Gtk.Notebook(); ... //  About,    VBox c   10 , //   margin/padding   let aboutBox = new Gtk.VBox({ border_width: 10 }); //     About notebook.append_page( aboutBox, new Gtk.Label({label: "About"}), ); //        , //      ,    (expand) aboutBox.pack_start( new Gtk.Label({ label: "&lt;b&gt;Do Not Disturb Time&lt;/b&gt;", use_markup: true, }), true, // expand true, // fill 0, ); ... notebook.show_all(); return notebook; }</span></span></code> </pre> <br><p>  Letzter Screenshot: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f87/554/787/f8755478763d159cbb9dfc1518881e60.png"></p><br><h2 id="dopolnitelno">  Optional </h2><br><div class="spoiler">  <b class="spoiler_title">1. Betriebsarten: Unterst√ºtzung und Betrieb</b> <div class="spoiler_text"><p>  Die Arbeit des Programmierers umfasst in meinem Fall zwei Modi: <br>  1) im Support-Modus, wenn Sie schnell auf Ereignisse reagieren m√ºssen - Mail, Slack, Skype und mehr <br>  2) im Betriebsmodus, wenn es wichtig ist, Benachrichtigungen f√ºr mindestens 20 Minuten zu k√ºrzen, andernfalls geht der Fokus verloren und die endg√ºltige Arbeitsproduktivit√§t ist vernachl√§ssigbar.  Hierf√ºr ist der Modus ‚ÄûNicht st√∂ren‚Äú hilfreich. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">2. So schalten Sie den Ton aus</b> <div class="spoiler_text"><p>  Es scheint, dass eine vollst√§ndige Stummschaltung, Stummschaltung, zu viel ist.  In der Tat m√∂chten Sie im Idealfall, dass Slack / Skype im Modus ‚ÄûNicht st√∂ren‚Äú geh√∂rt wird, der Rest der Sounds (echte Benachrichtigungen) jedoch nicht.  Aber daf√ºr m√ºssen sie irgendwie unterschieden werden.  Sie k√∂nnen nat√ºrlich eine Sound-API speziell f√ºr Benachrichtigungen erstellen (und diese ist bereits vorhanden), nur gibt es immer ein Programm / einen Programmierer, der / der diese Funktionalit√§t nicht verwendet.  Ein Beispiel ist der Mailspring-Mailer: Er spielt einfach Sounds √ºber das <code>audio</code> Tag ab und kann beispielsweise in keiner Weise von der Sprache in einem Slack-Anruf unterschieden werden. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">3. PanelMenu.Button</b> <div class="spoiler_text"><p>  PanelMenu.Button - Dies ist die eigentliche Schaltfl√§che im Panel + Popup-Men√º. Sie k√∂nnen es selbst herausfinden und von Grund auf neu erstellen. Beide werden von den <em>Jungs an der Wunde</em> gesch√§tzt!  Ich habe ein schnelles Ergebnis angestrebt und deshalb den Code aus inoffiziellen Unterlagen kopiert. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">4. SetStatusRemote ()</b> <div class="spoiler_text"><p>  Initiieren Sie tats√§chlich einen Moduswechsel mit SetStatusRemote (). </p></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de428187/">https://habr.com/ru/post/de428187/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de428175/index.html">Schlaue Pr√§fixbaum-C-Implementierung</a></li>
<li><a href="../de428177/index.html">Was ist also falsch an der Arbeitssuche / den Arbeitnehmern in der IT?</a></li>
<li><a href="../de428179/index.html">Bei einer japanischen Auktion wurde ein Prototyp eines Wii-Controllers f√ºr den GameCube entwickelt</a></li>
<li><a href="../de428181/index.html">Moralische Maschine: gnadenlos oder bedeutungslos?</a></li>
<li><a href="../de428183/index.html">Implementierung des Levenberg-Marquardt-Algorithmus zur Optimierung neuronaler Netze auf TensorFlow</a></li>
<li><a href="../de428189/index.html">Wer ist ein Paladin?</a></li>
<li><a href="../de428191/index.html">Was sollen wir f√ºr einen Hackathon arrangieren oder wie haben wir einen internen Hackathon durchgef√ºhrt?</a></li>
<li><a href="../de428193/index.html">√úber Touren gehen</a></li>
<li><a href="../de428197/index.html">Effektive pers√∂nliche Finanzierung. Stufe 1</a></li>
<li><a href="../de428201/index.html">Maulwurfsl√∂cher in JavaScript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>