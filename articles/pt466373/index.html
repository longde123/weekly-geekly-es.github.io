<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÖ üë©‚Äçüîß üç∏ Desenvolvimento de bot Python TamTam ‚è∞ üßî ‚õ∑Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Deixe-me apresentar: meu nome √© Sergey Agaltsov e sou um "programador na vida". Isso significa que eu sou gerente de TI h√° muito tempo, e ne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desenvolvimento de bot Python TamTam</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/466373/"><p><img src="https://habrastorage.org/webt/hv/5y/zn/hv5yzn1xbdnmstacgsl-4bqqcfc.jpeg"></p><br><p>  Ol√° Habr!  Deixe-me apresentar: meu nome √© Sergey Agaltsov e sou um "programador na vida".  Isso significa que eu sou gerente de TI h√° muito tempo, e nem um programador de profiss√£o, mas uso a programa√ß√£o constantemente, tanto na minha atividade principal quanto como hobby.  Como um dos meus ex-chefes costumava dizer - "Seryoga! Voc√™ entrou novamente na programa√ß√£o!"  √â verdade que n√£o posso dizer que ele ou qualquer outra pessoa tenha ficado muito insatisfeito com isso. </p><br><p>  Ap√≥s o surgimento da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API Bot</a> no messenger TamTam, eu, como programador verdadeiro e, portanto, pregui√ßoso, criei duas bibliotecas Python para trabalhar com ela: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API do cliente aberto</a> (doravante - OAC) - gerou inicialmente usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OpenAPI Generator</a> baseado no esquema da API e adaptou-o levando em considera√ß√£o os recursos do gerador; </li><li>  o shell para esse cliente √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TamTamBot</a> (daqui em diante - TTB), que simplifica o trabalho com o OAC. </li></ul><br><p>  Portanto, havia um certo TamTam Python SDK. </p><br><p>  Fiz isso antes de tudo "por mim mesmo, pela alma", mas tamb√©m sugeri que a comunidade TamTam, se desejado, a usasse.  Mas, como voc√™ sabe, nem uma √∫nica boa a√ß√£o fica impune - as pessoas pediram para escrever um artigo de treinamento.  E aqui estou eu com este artigo.  Nele, mostrarei como desenvolver um bot simples usando essas bibliotecas. </p><a name="habracut"></a><br><h1 id="zadacha">  Desafio </h1><br><p>  Desenvolva um bot projetado para simplificar as a√ß√µes dos desenvolvedores de bot.  O bot deve funcionar no modo de pesquisa permanente do estado bot-api (pesquisa longa).  Neste artigo, o bot ser√° treinado para mostrar o interior da mensagem enviada a ele e tamb√©m configurado para corresponder √† funcionalidade desenvolvida. </p><br><p>  Entende-se que o leitor instalou o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Python 3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">git</a> , conectado ao ambiente de desenvolvimento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PyCharm</a> (o ambiente de desenvolvimento pode ser diferente, mas a hist√≥ria ser√° baseada no PyCharm).  √â desej√°vel entender o b√°sico do POO. </p><br><h1 id="poluchenie-tokena-bota">  Obtendo um token de bot </h1><br><p>  O token √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">obtido</a> atrav√©s de uma chamada para o bot especializado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@PrimeBot</a> </p><br><p>  Encontramos este bot no TamTam, digite o comando / create e responda √†s perguntas: </p><br><ul><li> Digite o nome abreviado exclusivo do bot em letras latinas - este √© o nome de usu√°rio do bot pelo qual ele estar√° dispon√≠vel via @ ou por um link no formato <code>https://tt.me/username</code> .  N√£o h√° restri√ß√µes especiais para o nome de usu√°rio.  Em particular, a palavra bot √© opcional. </li><li>  Digite um nome - este √© o nome de exibi√ß√£o do bot.  Aqui voc√™ j√° pode usar o alfabeto cir√≠lico. </li></ul><br><p>  Se tudo for digitado corretamente, o bot criado ser√° adicionado aos contatos e, em troca, receberemos um token - uma sequ√™ncia de caracteres no formato: HDyDvomx6TfsXkgwfFCUY410fv-vbf4XVjr8JVSUu4c. </p><br><h1 id="pervichnaya-nastroyka">  Configura√ß√£o inicial </h1><br><div class="spoiler">  <b class="spoiler_title">Mostrar</b> <div class="spoiler_text"><p>  Crie um diret√≥rio: </p><br><pre> <code class="plaintext hljs">mkdir ttBotDevHelper</code> </pre> <br><p>  V√° para ele: </p><br><pre> <code class="plaintext hljs">cd ttBotDevHelper/</code> </pre> <br><p>  Inicializamos o reposit√≥rio git: </p><br><pre> <code class="plaintext hljs">git init</code> </pre> <br><p>  Fa√ßa o download das bibliotecas necess√°rias, adicionando-as como sub-m√≥dulos do git: </p><br><pre> <code class="plaintext hljs">git submodule add https://github.com/asvbkr/openapi_client.git openapi_client git submodule add https://github.com/asvbkr/TamTamBot.git TamTamBot</code> </pre> <br><p>  Abrimos o diret√≥rio criado no PyCharm (por exemplo, no explorer, no menu de contexto "Abrir pasta como projeto PyCharm") e criamos um arquivo que nosso bot conter√° - Arquivo / Novo / Arquivo Python.  Na caixa de di√°logo exibida, digite o nome - ttBotDevHelper e responda positivamente √† quest√£o de adicionar ao git. </p><br><p>  Agora precisamos criar um ambiente virtual para o nosso projeto. </p><br><p>  Para criar um ambiente virtual, selecione Arquivo / Configura√ß√µes e selecione a subchave Int√©rprete do projeto na guia Projeto.  Em seguida, √† direita, clique no √≠cone de roda dentada e selecione Adicionar: </p><br><p><img src="https://habrastorage.org/webt/dg/js/qv/dgjsqvo0ygtsp12lehregxcm8po.png" alt="imagem"></p><br><p>  O PyCharm oferecer√° sua pr√≥pria op√ß√£o de acomoda√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/lp/gg/og/lpggogip_ekpmuoiegolvfxyk2s.png" alt="imagem"></p><br><p>  Faz sentido concordar com ele. </p><br><p>  Ap√≥s criar o ambiente virtual, a tela anterior ser√° aberta, mas j√° conter√° informa√ß√µes sobre o ambiente criado.  Nesta tela, voc√™ precisa instalar os pacotes necess√°rios clicando no √≠cone "+" √† direita e digitando os nomes dos pacotes: </p><br><ul><li>  pedidos </li><li>  seis </li></ul><br><p>  Em seguida, adicionamos o arquivo .gitignore ao projeto, excluindo arquivos que n√£o s√£o necess√°rios no git, com o seguinte conte√∫do: </p><br><pre> <code class="plaintext hljs">venv/ .idea/ # Byte-compiled / optimized / DLL files __pycache__/ *.py[cod] *$py.class *.log *.log.* .env ttb.sqlite3</code> </pre> <br><p>  Adicione <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma vari√°vel de ambiente</a> chamada <code>TT_BOT_API_TOKEN</code> , na qual indicamos o valor do token do nosso bot recebido de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://tt.me/primebot</a> e reinicie o PyCharm. </p><br><p>  <strong>(!)</strong> Em vez de adicionar uma vari√°vel de ambiente diretamente ao ambiente do SO, o PyCharm utiliza de maneira ideal um arquivo .env especial.  Sua configura√ß√£o ser√° discutida abaixo. </p><br><p>  Parab√©ns, agora voc√™ pode prosseguir para a parte mais interessante - escrevendo seu bot. </p></div></div><br><h1 id="zapusk-prosteyshego-bota">  Lan√ßamento simples de bot </h1><br><p>  Abra o arquivo ttBotDevHelper.py e escreva as primeiras linhas: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: UTF-8 -*- from TamTamBot.TamTamBot import TamTamBot class BotDevHelper(TamTamBot): pass</span></span></code> </pre> <br><p>  Aqui criamos nossa classe de bot com base na classe TamTamBot. </p><br><p>  PyCharm sugere que a classe BotDevHelper cont√©m m√©todos abstratos que precisam ser implementados.  Pressione Alt-Enter no nome da classe, selecione "Implementar m√©todos abstratos", selecione todos os m√©todos (2 deles) propostos pelo PyCharm e clique em OK.  Como resultado, dois m√©todos de propriedade vazios ser√£o adicionados: token e descri√ß√£o.  Modificamos o c√≥digo resultante da seguinte maneira: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: UTF-8 -*- import os from TamTamBot.TamTamBot import TamTamBot from TamTamBot.utils.lng import set_use_django class BotDevHelper(TamTamBot): @property def token(self): return os.environ.get('TT_BOT_API_TOKEN') @property def description(self): return '       .\n\n' \ 'This bot is an helper in the development and management of bots.' if __name__ == '__main__': set_use_django(False) BotDevHelper().polling()</span></span></code> </pre> <br><p>  A propriedade <code>token</code> retorna o token do nosso bot, cujo valor √© obtido da vari√°vel de ambiente <code>TT_BOT_API_TOKEN</code> .  A propriedade <code>description</code> retorna uma descri√ß√£o estendida do nosso bot, que ser√° exibida aos usu√°rios. </p><br><p>  O c√≥digo no final do arquivo √© necess√°rio para executar nosso bot no modo de pesquisa de status. </p><br><p>  Observo que a classe base <code>TamTamBot</code> envolve o uso do servidor web django para trabalhar no modo gancho da web.  Mas agora a tarefa √© mais simples e n√£o precisamos de django, que √© o que estamos relatando na linha <code>set_use_django(False)</code> .  Aqui, o m√©todo <code>polling()</code> √© chamado para o objeto de nossa classe, o que garante a opera√ß√£o no modo necess√°rio. </p><br><p>  O m√≠nimo necess√°rio √© feito.  Este c√≥digo j√° est√° funcionando.  Execute-o para executar.  Para fazer isso, pressione a combina√ß√£o de teclas Ctrl-Shift-F10. </p><br><p>  Se voc√™ n√£o adicionou uma vari√°vel de ambiente anteriormente, diretamente ao sistema operacional, ocorrer√° um erro com a mensagem "No access_token" na inicializa√ß√£o.  Para corrigi-lo, configure o PyCharm para usar o arquivo .env. </p><br><div class="spoiler">  <b class="spoiler_title">Mostre como</b> <div class="spoiler_text"><p>  Crie um arquivo de texto .env.  Seu conte√∫do em nosso caso deve ser o seguinte: </p><br><pre> <code class="plaintext hljs">TT_BOT_API_TOKEN=__</code> </pre> <br><p>  Agora voc√™ precisa conect√°-lo √† configura√ß√£o de inicializa√ß√£o no PyCharm: </p><br><p>  Selecionamos a configura√ß√£o Executar / Editar e, na guia EnvFile, conectamos nosso arquivo .env: </p><br><p><img src="https://habrastorage.org/webt/2s/6s/ci/2s6scissf6roedcy6r26rjoi6ve.png" alt="imagem"></p><br><p>  Depois clique em Aplicar. </p></div></div><br><p>  Depois de iniciar o bot, voc√™ pode ir ao TamTam, abrir um di√°logo com o bot e clicar no bot√£o "Iniciar".  O bot reportar√° informa√ß√µes sobre suas superpot√™ncias ocultas.  Isso significa que o bot est√° funcionando.  Enquanto o bot est√° trabalhando no modo de demonstra√ß√£o, no qual 4 comandos est√£o dispon√≠veis.  Basta v√™-los. </p><br><p>  Apesar da opini√£o pronunciada do bot sobre sua frieza, ele timidamente sugere que at√© agora ele n√£o pode fazer nada.  Ensinar a ele tudo o necess√°rio para a conquista do mundo √© nossa tarefa. </p><br><h1 id="priyom-soobscheniya-istochnika-i-otpravka-otvetnogo-soobscheniya-s-vnutrennim-predstavleniem-soobscheniya-istochnika">  Recebendo uma mensagem de origem e enviando uma mensagem de resposta com uma representa√ß√£o interna da mensagem de origem </h1><br><p>  Bloquearemos o m√©todo <code>receive_text()</code> , cujo controle √© transferido ao enviar texto para o chat com o bot: </p><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive_text</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, update)</span></span></span><span class="hljs-function">:</span></span> res = self.msg.send_message(NewMessageBody(<span class="hljs-string"><span class="hljs-string">f' : </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{update.message}</span></span></span><span class="hljs-string">'</span></span>, link=update.link), user_id=update.user_id) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bool(res)</code> </pre> <br><p>  O objeto de <code>update</code> da classe <code>UpdateCmn</code> , que √© passado para esse m√©todo, cont√©m v√°rias informa√ß√µes √∫teis e, em particular, tudo o que precisamos agora: </p><br><ul><li>  <code>update.message</code> - um objeto que cont√©m a pr√≥pria mensagem; </li><li>  <code>update.link</code> - link de resposta pronto para esta mensagem; </li><li>  <code>update.user_id</code> - identificador do usu√°rio que enviou a mensagem. </li></ul><br><p>  Para enviar uma mensagem do bot, usamos a vari√°vel <code>self.msg</code> , que cont√©m o objeto <code>MessagesApi</code> que implementa a funcionalidade descrita na se√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mensagens</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descri√ß√£o</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API</a> .  Este objeto cont√©m o m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>send_message()</code></a> que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>send_message()</code></a> , que fornece o envio de mensagens.  No m√≠nimo, esse m√©todo deve receber um objeto da classe <code>NewMessageBody</code> e o destino - o ID do usu√°rio, no nosso caso. </p><br><p>  Por sua vez, um objeto da classe <code>NewMessageBody</code> nesse caso √© criado transmitindo uma representa√ß√£o textual do objeto da mensagem de origem e um link de resposta para a mensagem de origem. </p><br><p>  Reiniciamos nosso bot e verificamos em um di√°logo com o bot que o bot gera uma resposta a qualquer uma de nossas mensagens contendo a representa√ß√£o interna do objeto de mensagem de origem. </p><br><p>  O c√≥digo fonte desse estado est√° <a href="">aqui</a> . </p><br><h1 id="dobavlenie-novoy-komandy-bota-s-parametrom---pokaz-vnutrennego-predstavleniya-soobscheniya-po-ego-identifikatoru">  Adicionando um novo comando bot com um par√¢metro - mostrando a representa√ß√£o interna da mensagem por seu identificador </h1><br><p>  Ao desenvolver bots, muitas vezes √© necess√°rio examinar a representa√ß√£o interna de uma mensagem usando um ou mais identificadores de mensagens conhecidos (id da mensagem).  Adicione essa funcionalidade ao nosso bot.  Para fazer isso, primeiro, retiramos em um m√©todo separado a funcionalidade de gerar informa√ß√µes sobre a representa√ß√£o interna de mensagens: </p><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view_messages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, update, list_mid, link=None)</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> msgs = self.msg.get_messages(message_ids=list_mid) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msgs: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> msg <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> msgs.messages: r = self.msg.send_message(NewMessageBody(<span class="hljs-string"><span class="hljs-string">f' </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{msg.body.mid}</span></span></span><span class="hljs-string">:\n`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{msg}</span></span></span><span class="hljs-string">`'</span></span>[:NewMessageBody.MAX_BODY_LENGTH], link=link), user_id=update.user_id) res = res <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res</code> </pre> <br><p>  Neste m√©todo, passamos uma lista de meados. </p><br><p>  Para obter objetos de mensagem, usamos o m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>self.msg.get_messages</code></a> , que retorna uma lista de objetos na propriedade messages. </p><br><p>  Al√©m disso, uma representa√ß√£o textual de cada uma das mensagens recebidas √© enviada ao nosso di√°logo em mensagens separadas.  Para evitar erros, o texto da mensagem gerada √© truncado pela constante do tamanho m√°ximo da mensagem - <code>NewMessageBody.MAX_BODY_LENGTH</code> . </p><br><p>  Em seguida, adicione um m√©todo que processa o comando.  <strong>Vamos</strong> cham√°-lo de <strong>vmp</strong> .  Voc√™ pode passar a lista intermedi√°ria para o comando com um espa√ßo. </p><br><p>  O TTB foi projetado para que o manipulador de comandos seja criado como um m√©todo com o nome <code>cmd_handler_%s</code> , em que% s √© o nome do comando.  I.e.  para o comando vmp, o m√©todo ser√° chamado <code>cmd_handler_vmp</code> .  Um objeto da classe <code>UpdateCmn</code> √© passado para o manipulador de comandos.  Al√©m disso, para um comando, ele pode conter a propriedade <code>cmd_args</code> , que cont√©m um dicion√°rio de linhas e palavras que foram inseridas com o comando </p><br><p>  O c√≥digo ficar√° assim: </p><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cmd_handler_vmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, update)</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> update.this_cmd_response: <span class="hljs-comment"><span class="hljs-comment">#    ,       if update.cmd_args: #        list_id = [] parts = update.cmd_args.get('c_parts') or [] if parts: for line in parts: for part in line: list_id.append(str(part)) if list_id: res = self.view_messages(update, list_id, update.link) return bool(res)</span></span></code> </pre> <br><p>  N√≥s reiniciamos o bot.  Agora, se voc√™ digitar um comando no di√°logo do bot como: <code>/vmp mid1 mid2</code> (voc√™ pode fazer as verifica√ß√µes anteriores no meio), em troca, receberemos duas mensagens com uma representa√ß√£o interna dos objetos de mensagem de origem, para cada um dos meios transmitidos. </p><br><p>  O c√≥digo fonte desse estado est√° <a href="">aqui</a> . </p><br><h1 id="modifikaciya-komandy-bota-dlya-raboty-s-tekstovym-otvetom">  Modifica√ß√£o de um comando bot para trabalhar com uma resposta de texto </h1><br><p>  Voc√™ tamb√©m pode tentar encaminhar a mensagem de outro canal / chat.  Mas, neste caso, apenas o conte√∫do da mensagem de origem em di√°logo com o bot ser√° mostrado.  Em particular, ao enviar uma mensagem, as informa√ß√µes do bot√£o n√£o s√£o salvas. </p><br><p>  Mas e se quisermos ver informa√ß√µes sobre a mensagem original?  Nesse caso, voc√™ precisa tirar o meio da mensagem encaminhada. </p><br><p>  Para implementar esse modo, modificamos o comando <strong>vmp</strong> para que, quando chamado sem par√¢metros, espere que a mensagem seja encaminhada e, depois disso, pegue o meio da mensagem enviada e exiba informa√ß√µes sobre ela. </p><br><p>  <strong>(!)</strong> Para o funcionamento correto dessa funcionalidade, o bot deve ter permiss√£o de leitura do canal / fonte de bate-papo. </p><br><p>  N√≥s modificamos o c√≥digo de comando da seguinte maneira: </p><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cmd_handler_vmp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, update)</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> update.this_cmd_response: <span class="hljs-comment"><span class="hljs-comment">#    ,       if update.cmd_args: #        list_id = [] parts = update.cmd_args.get('c_parts') or [] if parts: for line in parts: for part in line: list_id.append(str(part)) if list_id: res = self.view_messages(update, list_id, update.link) else: #      self.msg.send_message(NewMessageBody(f' **  /    :'), user_id=update.user_id) update.required_cmd_response = True #       else: #    message = update.message link = message.link #       link #  -   . if link and link.type == MessageLinkType.FORWARD: res = self.view_messages(update, [link.message.mid], update.link) else: #         ,    . self.msg.send_message(NewMessageBody(f'.  **   /. , .'), user_id=update.user_id) return False return bool(res)</span></span></code> </pre> <br><p>  E desde  com essa abordagem, o risco aumenta devido √† falta de acesso √†s mensagens; em seguida, no m√©todo <code>view_messages()</code> , adicionamos uma verifica√ß√£o da conformidade com o n√∫mero de mensagens solicitadas / recebidas: </p><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view_messages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, update, list_mid, link=None)</span></span></span><span class="hljs-function">:</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> msgs = self.msg.get_messages(message_ids=list_mid) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> msgs: <span class="hljs-comment"><span class="hljs-comment">#    mid     if len(msgs.messages) &lt; len(list_mid): self.msg.send_message(NewMessageBody( f'     .    @{self.username}  /  .', link=update.link ), user_id=update.user_id) return False else: for msg in msgs.messages: r = self.msg.send_message(NewMessageBody(f' {msg.body.mid}:\n`{msg}`'[:NewMessageBody.MAX_BODY_LENGTH], link=link), user_id=update.user_id) res = res or r return res</span></span></code> </pre> <br><p>  Reiniciamos o bot, fornecemos o comando / vmp e, ap√≥s o prompt sobre a necessidade de encaminhamento ser exibido, encaminhamos a mensagem do canal / chat.  Se o bot tiver o direito de ler mensagens neste canal / chat, uma representa√ß√£o textual do objeto de mensagem encaminhada ser√° exibida.  Se n√£o houver acesso, o bot relatar√° um poss√≠vel problema e aguardar√° o encaminhamento da fonte correta. </p><br><h1 id="nastroyka-svoystv-bota">  Definindo propriedades do bot </h1><br><p>  Agora resta trazer brilho.  Vamos fechar a propriedade <code>about</code> , que retorna o texto que o bot exibe quando come√ßa a funcionar, bem como o comando / start. </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta"> @property def about(self): return '       .'</span></span></code> </pre> <br><p>  Bloquearemos o m√©todo <code>get_commands()</code> , que retorna a lista de comandos do nosso bot, que aparece na caixa de di√°logo com o bot. </p><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_commands</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># type: () -&gt; [BotCommand] commands = [ BotCommand('start', ' '), BotCommand('menu', ' '), BotCommand('vmp', '  '), ] return commands</span></span></code> </pre> <br><p>  Vamos desativar a propriedade main_menu_buttons, que retorna a lista de bot√µes no menu principal, chamada pelo comando / menu. </p><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main_menu_buttons</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># type: () -&gt; [] buttons = [ #       -  [CallbackButtonCmd(' ', 'start')], #        - .    -  [CallbackButtonCmd('  ', 'vmp', intent=Intent.POSITIVE)], ] return buttons</span></span></code> </pre> <br><p>  Reiniciamos o bot, verifique se est√° tudo em ordem.  Parab√©ns, seu primeiro bot foi criado e, apesar de algum brinquedo, ele tem exigido bastante funcionalidade. </p><br><p>  O c√≥digo fonte desse estado est√° <a href="">aqui</a> . </p><br><p>  O bot @devhelpbot em funcionamento pode ser visto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  Por enquanto √© tudo.  Se o t√≥pico for de interesse, nos artigos a seguir eu posso considerar o desenvolvimento adicional do bot.  Por exemplo, adicionando bot√µes personalizados (em particular Sim / N√£o) e processando-os, enviando v√°rios tipos de conte√∫do (arquivos, fotos, etc.), trabalhando no modo webhook, etc. </p><br><p>  A prop√≥sito, voc√™ pode rapidamente fazer perguntas em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bate-papo especial</a> .  Sugest√µes / id√©ias diretas l√°. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt466373/">https://habr.com/ru/post/pt466373/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt466361/index.html">Como o certificado Cossacks GICSP recebeu</a></li>
<li><a href="../pt466363/index.html">Slurm DevOps. Primeiro dia Git, CI / CD, IaC e o dinossauro verde</a></li>
<li><a href="../pt466365/index.html">Desenvolvendo um sistema operacional monol√≠tico semelhante a Unix - Introdu√ß√£o (1)</a></li>
<li><a href="../pt466367/index.html">N√≠vel da API do Android, compatibilidade com vers√µes anteriores e posteriores</a></li>
<li><a href="../pt466371/index.html">As tr√™s principais obje√ß√µes de vendas que voc√™ pode enfrentar ao trabalhar com tecnologias de tend√™ncias</a></li>
<li><a href="../pt466375/index.html">Museum DataArt. KUVT2 - estudar e brincar</a></li>
<li><a href="../pt466379/index.html">Execute o software "desktop" no microcontrolador</a></li>
<li><a href="../pt466381/index.html">Como as l√¢mpadas LED da Era mudaram em 2019</a></li>
<li><a href="../pt466383/index.html">Oceano de criptomoedas: an√°lise dos 50 principais projetos com o CoinMarketCap</a></li>
<li><a href="../pt466385/index.html">Entendendo os Corretores de Mensagens. Aprendendo a mec√¢nica das mensagens atrav√©s do ActiveMQ e Kafka. Cap√≠tulo 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>