<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëãüèæ üßùüèø üë®üèø‚Äçü§ù‚Äçüë®üèΩ Workflow Core - un moteur de processus m√©tier pour .Net Core üçß ‚úçÔ∏è üïò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! 


 Nous avons d√©cid√© de soutenir le th√®me de la migration du projet √† l'aide de Windows Workflow Foundation vers .Net Core , qui a √©t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Workflow Core - un moteur de processus m√©tier pour .Net Core</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avanpost/blog/475902/"><p><img src="https://habrastorage.org/webt/hp/ll/of/hpllof4hjsvcpfxbkl_q-epwfew.jpeg" alt="image"></p><br><p>  Bonjour √† tous! </p><br><p>  Nous avons d√©cid√© de soutenir le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">th√®me de la migration du projet √† l'aide de Windows Workflow Foundation vers .Net Core</a> , qui a √©t√© lanc√© par des coll√®gues de DIRECTUM, car nous avons rencontr√© un probl√®me similaire il y a quelques ann√©es et avons suivi notre propre chemin. </p><a name="habracut"></a><br><h2>  Commen√ßons par l'histoire </h2><br><p>  Notre produit phare, Avanpost IDM, est un syst√®me de gestion du cycle de vie des comptes et de l'acc√®s des employ√©s.  Il sait g√©rer l'acc√®s √† la fois automatiquement en fonction du mod√®le de r√¥le et en fonction des demandes.  √Ä l'aube de la formation du produit, nous avions un syst√®me de libre-service assez simple avec un flux de travail √©tape par √©tape simple, pour lequel le moteur n'√©tait pas requis en principe. </p><br><p><img src="https://habrastorage.org/webt/hl/uo/c1/hluoc1imf_ejbdyzynpumdefmaa.png" alt="image"></p><br><p>  Cependant, face √† de gros clients, nous avons r√©alis√© qu'un outil beaucoup plus flexible √©tait n√©cessaire, car leurs exigences pour les processus de coordination des droits d'acc√®s recherchaient les r√®gles d'un bon workflow feuillu.  Apr√®s avoir analys√© les exigences, nous avons d√©cid√© de d√©velopper notre propre √©diteur de processus au format BPMN, adapt√© √† nos besoins.  Nous parlerons du d√©veloppement de l'√©diteur √† l'aide de React.js + SVG un peu plus tard, et aujourd'hui nous discuterons du sujet principal - le <strong>moteur de workflow</strong> ou le moteur de processus m√©tier. </p><br><h2>  Pr√©requis </h2><br><p>  Au d√©but du d√©veloppement du syst√®me, nous avions les exigences suivantes pour le moteur: </p><br><ul><li>  Prise en charge des diagrammes de processus, un format compr√©hensible, la possibilit√© de diffuser de notre format au format moteur </li><li>  Stockage de l'√©tat du processus </li><li>  Prise en charge de la gestion des versions de processus </li><li>  Prise en charge de l'ex√©cution parall√®le (branches) du processus </li><li>  Une licence appropri√©e pour utiliser la solution dans un produit commercial r√©pliqu√© </li><li>  Prise en charge de la mise √† l'√©chelle horizontale </li></ul><br><p>  Apr√®s avoir analys√© le march√© (pour 2014), nous avons opt√© pour une solution pratiquement non alternative pour .Net: Windows Workflow Foundation. </p><br><h2>  Windows Workflow Foundation (WWF) </h2><br><p>  Le WWF est la technologie de Microsoft pour d√©finir, ex√©cuter et g√©rer les workflows. </p><br><p>  La base de sa logique est un ensemble de conteneurs pour les actions (activit√©s) et la possibilit√© de construire des processus s√©quentiels √† partir de ces conteneurs.  Le conteneur peut √™tre ordinaire - une certaine √©tape du processus o√π l'activit√© est effectu√©e.  Il peut s'agir d'un gestionnaire - contenant la logique de branchement. </p><br><p>  Vous pouvez dessiner un processus directement dans Visual Studio.  Le diagramme de processus m√©tier compil√© est stock√© dans Haml, ce qui est tr√®s pratique - le format est d√©crit, il est possible de faire un concepteur de processus auto-√©crit.  C'est d'une part.  D'un autre c√¥t√©, Xaml n'est pas le format le plus pratique pour stocker une description - le sch√©ma compil√© pour un processus plus ou moins r√©el s'av√®re √©norme, notamment en raison de la redondance.  C'est tr√®s difficile √† comprendre, mais vous devrez le comprendre. </p><br><p>  Mais si t√¥t ou tard on peut comprendre zen avec des sch√©mas et apprendre √† les lire, alors le manque de transparence du moteur lui-m√™me ajoute d√©j√† aux tracas lors du fonctionnement du syst√®me par les utilisateurs.  Lorsque l'erreur vient des entrailles de Wf, il n'est pas toujours possible de d√©couvrir √† 100% quelle √©tait exactement la raison de l'√©chec.  La source ferm√©e et la monstruosit√© relative n'aide pas le cas.  Souvent, les corrections de bugs √©taient dues √† des sympt√¥mes. </p><br><p> En toute honn√™tet√©, il convient de pr√©ciser ici que les probl√®mes d√©crits ci-dessus, pour la plupart, nous tourmentent en raison de la forte personnalisation de Wf.  L'un des lecteurs dira avec certitude que nous avons nous-m√™mes cr√©√© un tas de probl√®mes, puis les avons r√©solus h√©ro√Øquement.  Il √©tait n√©cessaire de fabriquer un moteur self-made d√®s le d√©but.  En g√©n√©ral, ils auront raison. </p><br><p>  En fin de compte, la solution a fonctionn√© de mani√®re suffisamment stable et est entr√©e en production avec succ√®s.  Mais la transition de nos produits vers .Net Core nous a oblig√©s √† abandonner le WWF et √† chercher un autre moteur de processus m√©tier, car  Depuis mai 2019, Windows Workflow Foundation n'a pas √©t√© migr√© vers .Net Core.  Comme nous recherchions un nouveau moteur - le sujet d'un article s√©par√©, mais finalement nous nous sommes install√©s sur Workflow Core. </p><br><h2>  Noyau de workflow </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Workflow Core</a> est un moteur de processus m√©tier gratuit.  Il est d√©velopp√© sous licence MIT, c'est-√†-dire qu'il peut √™tre utilis√© en toute s√©curit√© dans le d√©veloppement commercial. </p><br><p>  Il est activement effectu√© par une seule personne, plusieurs autres font p√©riodiquement une demande de pull.  Il existe des ports pour d'autres langages (Java, Python et plusieurs autres). </p><br><p>  Le moteur est positionn√© comme l√©ger.  En fait, il ne s'agit que d'un h√¥te pour l'ex√©cution s√©quentielle d'actions regroup√©es par n'importe quelle r√®gle m√©tier. </p><br><p>  Le projet a une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation wiki</a> .  Malheureusement, il ne d√©crit pas toutes les fonctionnalit√©s du moteur.  Cependant, il sera impudent d'exiger une documentation compl√®te - le projet opensource est soutenu par un passionn√©.  Par cons√©quent, le Wiki sera tout √† fait suffisant pour commencer. </p><br><p>  D√®s la sortie de la bo√Æte, il est possible de stocker l'√©tat du processus dans un stockage externe (stockage persistant).  Les fournisseurs sont standard pour: </p><br><ul><li>  Mongodb </li><li>  SQL Server </li><li>  PostgreSQL </li><li>  Sqlite </li><li>  Amazon DynamoDB </li></ul><br><p>  √âcrivez votre fournisseur n'est pas un probl√®me.  Nous prenons les sources de toute norme et faisons comme exemple. </p><br><p>  La mise √† l'√©chelle horizontale est prise en charge, c'est-√†-dire que vous pouvez ex√©cuter le moteur sur plusieurs n≈ìuds √† la fois, tout en ayant un point de stockage des √©tats de processus (un stockage de persistance).  Dans ce cas, le placement de la file d'attente de t√¢ches interne du moteur doit √™tre dans le stockage g√©n√©ral (rabbitMQ, en option).  Pour exclure l'ex√©cution d'une t√¢che par plusieurs n≈ìuds, un gestionnaire de verrouillage est fourni en m√™me temps.  Par analogie avec les fournisseurs de stockage externes, il existe des impl√©mentations standard: </p><br><ul><li>  Baux de stockage Azure </li><li>  Redis </li><li>  AWS DynamoDB </li><li>  SQLServer (dans la source il y en a, mais rien n'est dit dans la documentation) </li></ul><br><p>  Il est plus facile d'apprendre √† conna√Ætre quelque chose de nouveau avec un exemple.  Alors faisons-le.  Je d√©crirai la construction d'un processus simple d√®s le d√©but, avec une explication.  Un exemple peut sembler incroyablement simple.  Je suis d'accord - c'est simple.  Le plus pour commencer. </p><br><p>  Allons-y. </p><br><h4>  √âtape </h4><br><p>  Une √©tape est une √©tape du processus au cours de laquelle des actions sont effectu√©es.  L'ensemble du processus est construit √† partir d'une s√©quence d'√©tapes.  Une √©tape peut effectuer de nombreuses actions, peut √™tre r√©p√©t√©e, par exemple, pour un √©v√©nement ext√©rieur.  Il y a un ensemble d'√©tapes qui sont dot√©es de la logique ¬´pr√™te √† l'emploi¬ª: </p><br><ul><li>  Attendre </li><li>  Si </li><li>  Alors que </li><li>  Foreach </li><li>  Retard </li><li>  Parall√®le </li><li>  Horaire </li><li>  R√©cidive </li></ul><br><p>  Bien s√ªr, sur certaines primitives int√©gr√©es, vous ne pouvez pas supporter le processus.  Nous avons besoin d'√©tapes qui compl√®tent les t√¢ches commerciales.  Par cons√©quent, pour l'instant, mettez-les de c√¥t√© et prenez des mesures avec notre propre logique.  Pour ce faire, vous devez h√©riter de l'abstraction <strong>StepBody</strong> . </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StepBody</span></span> : <span class="hljs-title"><span class="hljs-title">IStepBody</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStepExecutionContext context</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><p>  La m√©thode <strong>Run</strong> est ex√©cut√©e lorsque le processus entre dans une √©tape.  Il faut y mettre la logique n√©cessaire. </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StepBody</span></span> : <span class="hljs-title"><span class="hljs-title">IStepBody</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStepExecutionContext context</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br><p>  Les √©tapes prennent en charge l'injection de d√©pendance.  Pour ce faire, enregistrez-les simplement dans le m√™me conteneur que les d√©pendances n√©cessaires. </p><br><p>  De toute √©vidence, le processus a besoin de son propre contexte - un endroit o√π des r√©sultats interm√©diaires d'ex√©cution peuvent √™tre ajout√©s.  Wf core a son propre contexte pour l'ex√©cution d'un processus qui stocke des informations sur son √©tat actuel.  Vous pouvez y acc√©der en utilisant la variable de <strong>contexte</strong> de la m√©thode <strong>Run</strong> ().  En plus de la fonction int√©gr√©e, nous pouvons utiliser notre contexte. </p><br><p>  Nous analyserons les fa√ßons de d√©crire et d'enregistrer le processus plus en d√©tail ci-dessous, pour l'instant, nous d√©finissons simplement une certaine classe - le contexte. </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProcessContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Number1 {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Number2 {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> StepResult {<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>;} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Number1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; Number2 = <span class="hljs-number"><span class="hljs-number">2</span></span>; } }</code> </pre> <br><p>  Dans les variables <strong>Nombre,</strong> nous √©crivons des nombres;  dans la variable <strong>StepResult</strong> - le r√©sultat de l'√©tape. </p><br><p>  Nous avons d√©cid√© du contexte.  Vous pouvez √©crire votre propre √©tape: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomStep</span></span> : <span class="hljs-title"><span class="hljs-title">StepBody</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Ilogger _log; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Input1 { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Input2 { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Action { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Result { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomStep</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Ilogger log</span></span></span><span class="hljs-function">)</span></span> { _log = log; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStepExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { Result = ‚Äùnone‚Äù; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Action ==‚Äùsum‚Äù) { Result = Number1 + Number2; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Action ==‚Äùdif‚Äù){ Result = Number1 - Number2; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ExecutionResult.Next(); } }</code> </pre> <br><p>  La logique est extr√™mement simple: deux chiffres et le nom de l'op√©ration viennent √† l'entr√©e.  Le r√©sultat de l'op√©ration est √©crit dans la variable de sortie <strong>R√©sultat</strong> .  Si l'op√©ration n'est pas d√©finie, le r√©sultat sera <em>nul</em> . </p><br><p>  Nous avons d√©cid√© du contexte, il y a une √©tape avec la logique dont nous avons aussi besoin.  Maintenant, nous devons enregistrer notre processus dans le moteur. </p><br><h4>  Description du processus.  Inscription dans le moteur. </h4><br><p>  Il existe deux fa√ßons de d√©crire un processus.  Le premier est la description dans le code - le code dur. </p><br><p>  Le processus est d√©crit via l' <strong>interface fluide</strong> .  Il est n√©cessaire d'h√©riter de l' <strong>interface IWorkflow &lt;T&gt;</strong> g√©n√©ralis√©e, o√π T est la classe de contexte du mod√®le.  Dans notre cas, il s'agit d'un <strong>ProcessContext</strong> . </p><br><p>  Cela ressemble √† ceci: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleWorkflow</span></span> : <span class="hljs-title"><span class="hljs-title">IWorkflow</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ProcessContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Build</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IWorkflowBuilder&lt;ProcessContext&gt; builder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    } public string Id =&gt; "SomeWorkflow"; public int Version =&gt; 1; }</span></span></code> </pre> <br><p>  La description elle-m√™me se trouvera dans la m√©thode <strong>Build</strong> .  Les champs <strong>Id</strong> et <strong>Version</strong> sont √©galement obligatoires.  Wf core prend en charge la gestion des versions de processus - vous pouvez enregistrer n versions de processus avec le m√™me identifiant.  Ceci est pratique lorsque vous devez mettre √† jour un processus existant et en m√™me temps donner "en direct" aux t√¢ches existantes. </p><br><p>  Nous d√©crivons un processus simple: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleWorkflow</span></span> : <span class="hljs-title"><span class="hljs-title">IWorkflow</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ProcessContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Build</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IWorkflowBuilder&lt;ProcessContext&gt; builder</span></span></span><span class="hljs-function">)</span></span> { builder.StartWith&lt;CustomStep&gt;() .Input(step =&gt; step.Input1, data =&gt; data.Number1) .Input(step =&gt; step.Input2, data =&gt; data.Number2) .Input(step =&gt; step.Action, data =&gt; ‚Äúsum‚Äù) .Output(data =&gt; data.StepResult, step =&gt; step.Result) .EndWorkflow(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id =&gt; <span class="hljs-string"><span class="hljs-string">"SomeWorkflow"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Version =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>  S'il est traduit en langage ¬´humain¬ª, cela se traduira par quelque chose comme ceci: le processus commence par l'√©tape <strong>CustomStep</strong> .  La valeur du champ d'√©tape <strong>Input1</strong> est tir√©e du champ de contexte <strong>Number1</strong> , La valeur du champ d'√©tape <strong>Input2</strong> est tir√©e du champ de contexte <strong>Number2</strong> , le champ d' <strong>action</strong> est cod√© en dur √† la valeur <strong>¬´somme¬ª</strong> .  La sortie du champ <strong>R√©sultat est</strong> √©crite dans le <strong>champ</strong> contextuel <strong>StepResult</strong> .  Terminez le processus. </p><br><p>  D'accord, le code s'est av√©r√© tr√®s lisible, il est tout √† fait possible de le comprendre, m√™me sans connaissances particuli√®res en C #. </p><br><p>  Ajoutez une √©tape suppl√©mentaire √† notre processus, qui affichera le r√©sultat de l'√©tape pr√©c√©dente dans le journal: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomStep</span></span> : <span class="hljs-title"><span class="hljs-title">StepBody</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Ilogger _log; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TextToOutput { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomStep</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Ilogger log</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    _log = log; } public override ExecutionResult Run(IStepExecutionContext context) { _log.Debug(TextToOutput); return ExecutionResult.Next(); } }</span></span></code> </pre> <br><p>  Et mettez √† jour le processus: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SimpleWorkflow</span></span> : <span class="hljs-title"><span class="hljs-title">IWorkflow</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ProcessContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Build</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IWorkflowBuilder&lt;ProcessContext&gt; builder</span></span></span><span class="hljs-function">)</span></span> { builder.StartWith&lt;CustomStep&gt;() .Input(step =&gt; step.Input1, data =&gt; data.Number1) .Input(step =&gt; step.Input2, data =&gt; data.Number2) .Input(step =&gt; step.Action, data =&gt; ‚Äúsum‚Äù) .Output(data =&gt; data.StepResult, step =&gt; step.Result) .Then&lt;OutputStep&gt;.Input(step =&gt; step.TextToOutput, data =&gt; data.StepResult) .EndWorkflow(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Id =&gt; <span class="hljs-string"><span class="hljs-string">"SomeWorkflow"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Version =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p>  Maintenant, apr√®s l'√©tape avec l'op√©ration d'addition, l'√©tape de sortie du r√©sultat dans le journal suit.  √Ä l'entr√©e, nous passons la variable <strong>R√©sultat</strong> et contexte dans laquelle le r√©sultat de l'ex√©cution a √©t√© √©crit √† la derni√®re √©tape.  Je prendrai la libert√© d'affirmer qu'une telle description √† travers un code (hardcode) dans des syst√®mes r√©els serait de peu d'utilit√©.  Sauf pour certains processus bureautiques.  Il est beaucoup plus int√©ressant de pouvoir stocker le circuit s√©par√©ment.  Au minimum, nous n'avons pas √† remonter le projet chaque fois que nous devons changer quelque chose dans le processus ou en ajouter un nouveau.  Wf core fournit cette fonctionnalit√© en stockant le sch√©ma json.  Nous continuons d'√©largir notre exemple. </p><br><h4>  Description du processus Json </h4><br><p>  <i>De plus, je ne fournirai pas de description via le code.</i>  <i>Ce n'est pas particuli√®rement int√©ressant et ne fera que gonfler l'article.</i> </p><br><p>  Le noyau Wf prend en charge la description de sch√©ma dans json.  √Ä mon avis, json est plus visuel que xaml (un bon sujet pour holivar dans les commentaires :)).  La structure du fichier est assez simple: </p><br><pre> <code class="plaintext hljs">{ "Id": "SomeWorkflow", "Version": 1, "DataType": "App.ProcessContext, App", "Steps": [ { /*step1*/ }, { /*step2*/ } ] }</code> </pre> <br><p>  Le champ <strong>DataType</strong> indique le nom complet de la classe de contexte et le nom de l'assembly dans lequel il est d√©crit.  <strong>Steps</strong> stocke une collection de toutes les √©tapes du processus.  Remplissez l'√©l√©ment <strong>Steps</strong> : </p><br><pre> <code class="plaintext hljs">{ "Id": "SomeWorkflow", "Version": 1, "DataType": "App.ProcessContext, App", "Steps": [ { "Id": "Eval", "StepType": "App.CustomStep, App", "NextStepId": "Output", "Inputs": { "Input1": "data.Number1", "Input2": "data.Number2" }, "Outputs": { "StepResult": "step.Result" } }, { "Id": "Output", "StepType": "App.OutputStep, App", "Inputs": { "TextToOutput": "data.StepResult" } } ] }</code> </pre> <br><p>  Examinons de plus pr√®s la structure de la description de l'√©tape via json. </p><br><p>  Les champs <strong>Id</strong> et <strong>NextStepId</strong> stockent l'identifiant de cette √©tape et un indicateur de l'√©tape qui peut √™tre la suivante.  De plus, l'ordre des √©l√©ments de la collection est sans importance. </p><br><p>  <strong>StepType est</strong> similaire au champ <strong>DataType</strong> , il contient le nom de classe complet de l'√©tape (un type qui h√©rite de <strong>StepBody</strong> et impl√©mente la logique d'√©tape) et le nom de l'assembly.  <strong>Les</strong> objets <strong>Entr√©es</strong> et <strong>Sorties</strong> sont plus int√©ressants.  Ils sont d√©finis sous forme de cartographie. </p><br><p>  Dans le cas des <strong>entr√©es, le</strong> nom de l'√©l√©ment json est le nom du champ de classe de notre √©tape;  la valeur de l'√©l√©ment est le nom du champ dans la classe, le contexte du processus. </p><br><p>  Pour les <strong>sorties, au</strong> contraire, le nom de l'√©l√©ment json est le nom du champ dans la classe, le contexte du processus;  La valeur de l'√©l√©ment est le nom du champ de classe de notre √©tape. </p><br><p>  Pourquoi les champs de contexte sont-ils sp√©cifi√©s via les <em>donn√©es. {Field_name}</em> , et dans le cas de <strong>Output</strong> , <em>√©tape. {Field_name}</em> ?  √âtant donn√© que wf core, la valeur de l'√©l√©ment est ex√©cut√©e en tant qu'expression C # (la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que d'expressions dynamiques est</a> utilis√©e).  C'est une chose plut√¥t utile, avec son aide, vous pouvez mettre une logique m√©tier directement dans le sch√©ma, si, bien s√ªr, l'architecte approuve une telle honte :). </p><br><p>  Nous diversifions le sch√©ma avec des primitives standard.  Ajouter une √©tape <strong>If</strong> conditionnelle et traiter un √©v√©nement externe. </p><br><h5>  Si </h5><br><p>  <strong>Si</strong> primitif.  Ici commencent les difficult√©s.  Si vous avez l'habitude de bpmn et de dessiner des processus dans cette notation, vous trouverez une configuration facile.  Selon la documentation, l'√©tape est d√©crite comme suit: </p><br><pre> <code class="plaintext hljs">{ "Id": "IfStep", "StepType": "WorkflowCore.Primitives.If, WorkflowCore", "NextStepId": "nextStep", "Inputs": { "Condition": "&lt;&lt;expression to evaluate&gt;&gt;" }, "Do": [ [ { /*do1*/ }, { /*do2*/ } ] ] }</code> </pre> <br><p>  Il n'y a aucun sentiment que quelque chose ne va pas ici?  J'en ai un.  L'entr√©e d'√©tape est d√©finie sur <em>Condition</em> - expression.  Ensuite, nous d√©finissons la liste des √©tapes √† l'int√©rieur du tableau <strong>Do</strong> (actions).  Alors, o√π est la <strong>fausse</strong> branche?  Pourquoi n'y a-t-il pas de tableau Do pour False?  En fait, il y en a.  Il est entendu que la branche <strong>False</strong> est simplement un passage plus loin dans le processus, c'est-√†-dire en suivant le pointeur dans <strong>NextStepId</strong> .  Au d√©but, j'√©tais constamment confus √† cause de cela.  D'accord, tri√©.  Mais non.  Si les actions de processus dans le cas de <em>True</em> doivent √™tre plac√©es dans <strong>Do</strong> , c'est ce que sera le "beau" json.  Et s'il y en a, <strong>si</strong> enferm√©s dans une douzaine?  Tout ira de c√¥t√©.  Ils disent √©galement que le sch√©ma sur xaml est difficile √† lire.  Il y a un petit hack.  Prenez simplement le moniteur plus large.  Il a √©t√© mentionn√© un peu plus haut que l'ordre des √©tapes de la collection n'a pas d'importance, la transition suit les signes.  Il peut √™tre utilis√©.  Ajoutez une √©tape suppl√©mentaire: </p><br><pre> <code class="plaintext hljs">{ "Id": "Jump", "StepType": "App.JumpStep, App", "NextStepId": "" }</code> </pre> <br><p>  Devinez √† quoi je m√®ne?  Certes, nous introduisons une √©tape de service qui, en transit, am√®ne le processus √† une √©tape dans <strong>NextStepId</strong> . </p><br><p>  Mettez √† jour notre sch√©ma: </p><br><pre> <code class="plaintext hljs">{ "Id": "SomeWorkflow", "Version": 1, "DataType": "App.ProcessContext, App", "Steps": [ { "Id": "Eval", "StepType": "App.CustomStep, App", "NextStepId": "MyIfStep", "Inputs": { "Input1": "data.Number1", "Input2": "data.Number2" }, "Outputs": { "StepResult": "step.Result" } }, { "Id": "MyIfStep", "StepType": "WorkflowCore.Primitives.If, WorkflowCore", "NextStepId": "OutputEmptyResult", "Inputs": { "Condition": "!String.IsNullOrEmpty(data.StepResult)" }, "Do": [ [ { "Id": "Jump", "StepType": "App.JumpStep, App", "NextStepId": "Output" } ] ] }, { "Id": "Output", "StepType": "App.OutputStep, App", "Inputs": { "TextToOutput": "data.StepResult" } }, { "Id": "OutputEmptyResult", "StepType": "App.OutputStep, App", "Inputs": { "TextToOutput": "\"Empty result\"" } } ] }</code> </pre> <br><p>  L'√©tape <strong>If</strong> v√©rifie si le r√©sultat de l'√©tape <strong>Eval</strong> est vide.  S'il n'est pas vide, alors nous affichons le r√©sultat, s'il est vide, alors le message " <em>R√©sultat vide</em> ".  L'√©tape <strong>Jump</strong> am√®ne le processus √† l'√©tape <strong>Output</strong> , qui se trouve en dehors de la collection <strong>Do.</strong>  Ainsi, nous avons maintenu la ¬´verticalit√©¬ª du sch√©ma.  De cette fa√ßon, on peut aussi sauter n pas en arri√®re, c'est-√†-dire  organiser un cycle.  Il existe des primitives int√©gr√©es pour les boucles dans le noyau wf, mais elles ne sont pas toujours pratiques.  Dans bpmn, par exemple, les boucles sont organis√©es via <strong>If</strong> . </p><br><p>  Utilisez cette approche ou la norme, c'est √† vous de d√©cider.  Pour nous, une telle organisation √©tait des √©tapes plus pratiques. </p><br><h5>  Attendre </h5><br><p>  La primitive <strong>WaitFor</strong> permet au monde ext√©rieur d'influencer le processus lorsqu'il est d√©j√† en cours d'ex√©cution.  Par exemple, si au stade du processus, l'approbation du cours par un utilisateur est requise.  Le processus restera dans l'√©tape <strong>WaitFor</strong> jusqu'√† ce qu'il re√ßoive un √©v√©nement auquel il est abonn√©. </p><br><p>  Structure primitive: </p><br><pre> <code class="plaintext hljs">{ "Id": "Wait", "StepType": "WorkflowCore.Primitives.WaitFor, WorkflowCore", "NextStepId": "NextStep", "CancelCondition": "If(cancel==true)", "Inputs": { "EventName": "\"UserAction\"", "EventKey": "\"DoSum\"", "EffectiveDate": "DateTime.Now" } }</code> </pre> <br><p>  Je vais expliquer un peu les param√®tres. </p><br><p>  <strong>CancelCondition</strong> - une condition pour interrompre une attente.  Offre la possibilit√© d'interrompre l'attente d'un √©v√©nement et de poursuivre le processus.  Par exemple, si un processus attend n √©v√©nements diff√©rents en m√™me temps (le noyau wf prend en charge l'ex√©cution parall√®le des √©tapes), il n'est pas n√©cessaire d'attendre que tous <strong>arrivent</strong> , dans ce cas <strong>CancelCondition</strong> nous aidera.  Nous ajoutons un indicateur logique aux variables de contexte et √† la r√©ception de l'√©v√©nement, nous d√©finissons l'indicateur sur <em>true</em> - toutes les √©tapes <strong>WaitFor</strong> sont termin√©es. </p><br><p>  <strong>EventName</strong> et <strong>EventKey</strong> - nom et cl√© de l'√©v√©nement.  Des champs sont n√©cessaires pour distinguer les √©v√©nements, c'est-√†-dire dans un syst√®me r√©el avec un grand nombre de processus fonctionnant simultan√©ment.  afin que le moteur comprenne quel √©v√©nement est destin√© √† quel processus et √† quelle √©tape. </p><br><p>  <strong>EffectiveDate</strong> - un champ facultatif qui ajoute un horodatage d'√©v√©nement.  Cela peut √™tre utile si vous devez publier un √©v√©nement ¬´dans le futur¬ª.  Pour qu'il soit publi√© imm√©diatement, vous pouvez laisser le param√®tre vide ou r√©gler l'heure actuelle. </p><br><p>  Dans tous les cas, il n'est pas pratique de prendre une √©tape distincte pour traiter les r√©actions de l'ext√©rieur, mais m√™me g√©n√©ralement, cela sera redondant.  Une √©tape suppl√©mentaire peut √™tre √©vit√©e en ajoutant √† l'√©tape habituelle l'attente d'un √©v√©nement externe et la logique de son traitement.  Nous <strong>compl√©tons l'</strong> √©tape <strong>CustomStep en</strong> vous abonnant √† un √©v√©nement externe: </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomStep</span></span> : <span class="hljs-title"><span class="hljs-title">StepBody</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Ilogger _log; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TextToOutput { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomStep</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Ilogger log</span></span></span><span class="hljs-function">)</span></span> { _log = log; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> ExecutionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStepExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//-  return ExecutionResult.WaitForEvent("eventName", "eventKey", DateTime.Now); } }</span></span></code> </pre> <br><p>  Nous avons utilis√© la m√©thode d'extension <strong>WaitForEvent ()</strong> standard.  Il accepte les param√®tres <strong>EventName</strong> , <strong>EventKey</strong> et <strong>EffectiveDate</strong> mentionn√©s pr√©c√©demment.  Apr√®s avoir termin√© la logique d'une telle √©tape, le processus attendra l'√©v√©nement d√©crit et appellera √† nouveau la m√©thode <strong>Run ()</strong> au moment o√π l'√©v√©nement est publi√© dans le bus moteur.  Cependant, dans la forme actuelle, nous ne pouvons pas distinguer les moments de l'entr√©e initiale dans l'√©tape et l'entr√©e apr√®s l'√©v√©nement.  Mais je voudrais en quelque sorte s√©parer la logique avant-apr√®s au niveau de l'√©tape.  Et le drapeau <strong>EventPublished</strong> nous y aidera.  Il est situ√© dans le contexte g√©n√©ral du processus, vous pouvez l'obtenir comme ceci: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ifEvent=context.ExecutionPointer.EventPublished;</code> </pre> <br><p>  Sur la base de cet indicateur, vous pouvez diviser la logique en toute s√©curit√© avant et apr√®s un √©v√©nement externe. </p><br><p>  Une pr√©cision importante - selon l'id√©e du cr√©ateur du moteur, une √©tape ne peut √™tre sign√©e que sur un √©v√©nement et y r√©agir une fois.  Pour certaines t√¢ches, c'est une limitation tr√®s d√©sagr√©able.  Il nous a m√™me fallu ¬´finir¬ª le moteur pour sortir de cette nuance.  Nous ignorerons leur description dans cet article, sinon l'article ne se terminera jamais :).  Des pratiques d'utilisation plus complexes et des exemples d'am√©liorations seront trait√©s dans les articles suivants. </p><br><h4>  Processus d'enregistrement dans le moteur.  Publication de l'√©v√©nement sur le bus. </h4><br><p>  Ainsi, avec la mise en ≈ìuvre de la logique des √©tapes et des descriptions du processus compris.  Ce qui reste est la chose la plus importante, sans laquelle le processus ne fonctionnera pas - la description doit √™tre enregistr√©e. </p><br><p>  Nous utiliserons la m√©thode d'extension <strong>AddWorkflow ()</strong> standard, qui placera ses d√©pendances dans notre conteneur IoC. </p><br><p>  Cela ressemble √† ceci: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IServiceCollection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddWorkflow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IServiceCollection services, Action&lt;WorkflowOptions&gt; setupAction = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><p>  <strong>IServiceCollection</strong> - interface - un contrat pour une collection de descriptions de services.  Il vit √† l'int√©rieur de DI de Microsoft (plus d'informations √† ce sujet peuvent √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lues ici</a> ) </p><br><p>  <strong>WorkflowOptions</strong> - param√®tres de base du moteur.  Il n'est pas n√©cessaire de les d√©finir vous-m√™me; les valeurs standard sont tout √† fait acceptables pour la premi√®re connaissance.  Nous allons plus loin. </p><br><p>  Si le processus a √©t√© d√©crit dans le code, l'enregistrement se d√©roule comme suit: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = _serviceProvider.GetService&lt;IWorkflowHost&gt;(); host.RegisterWorkflow&lt;SomeWorkflow, ProcessContext&gt;();</code> </pre> <br><p>  Si le processus est d√©crit via json, il doit √™tre enregistr√© comme suit (bien s√ªr, la description json doit √™tre pr√©charg√©e √† partir de l'emplacement de stockage): </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> host = _serviceProvider.GetService&lt;IWorkflowHost&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> definitionLoader = _serviceProvider.GetService&lt;IDefinitionLoader&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> definition = loader.LoadDefinition({*json  *});</code> </pre> <br><p>  De plus, pour les deux options, le code sera le m√™me: </p><br><pre> <code class="cs hljs">host.Start(); <span class="hljs-comment"><span class="hljs-comment">//      host.StartWorkflow(definitionId, version, context); //      /// host.Stop(); / /    </span></span></code> </pre> <br><p>  Le param√®tre <strong>definitionId</strong> est l'identifiant du processus.  Ce qui est √©crit dans le champ Id du processus.  Dans ce cas, id = <strong>SomeWorkflow</strong> . </p><br><p>  Le param√®tre <strong>version</strong> sp√©cifie la version du processus √† ex√©cuter.  Le moteur offre la possibilit√© d'enregistrer imm√©diatement n versions de processus avec un identifiant.  C'est pratique lorsque vous devez apporter des modifications √† la description du processus sans interrompre les t√¢ches en cours d'ex√©cution - de nouvelles seront cr√©√©es en fonction de la nouvelle version, les anciennes vivront tranquillement sur l'ancienne. </p><br><p>  Le param√®tre <strong>context</strong> est une instance du contexte de processus. </p><br><p>  Les <strong>m√©thodes host.Start ()</strong> et <strong>host.Stop ()</strong> d√©marrent et arr√™tent l'h√©bergement de processus.  Si, dans l'application, le lancement des processus est une t√¢che appliqu√©e et est effectu√©e p√©riodiquement, l'h√©bergement doit √™tre arr√™t√©.  Si l'application se concentre principalement sur la mise en ≈ìuvre de divers processus, l'h√©bergement ne peut pas √™tre arr√™t√©. </p><br><p>  Il existe une m√©thode pour envoyer des messages du monde ext√©rieur au bus moteur, qui les r√©partira ensuite entre les abonn√©s: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PublishEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> eventName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> eventKey, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> eventData, DateTime effectiveDate = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br><p>  La description de ses param√®tres √©tait plus √©lev√©e dans l'article ( <em>voir la partie primitive WaitFor</em> ). </p><br><h2>  Conclusion </h2><br><p>  Nous avons d√©finitivement pris des risques lorsque nous avons opt√© pour le projet Workflow Core - opensource, qui est activement d√©velopp√© par une seule personne, et m√™me avec une documentation tr√®s pauvre.  Et vous ne trouverez probablement pas de r√©elles pratiques d'utilisation de wf core dans les syst√®mes de production (sauf le n√¥tre).  Bien s√ªr, apr√®s avoir s√©lectionn√© une couche d'abstractions distincte, nous nous sommes assur√©s contre le cas d'√©chec et la n√©cessit√© de retourner rapidement au WWF, par exemple, ou une solution auto-√©crite, mais tout s'est plut√¥t bien pass√© et l'√©chec n'est pas venu. </p><br><p>  Le passage au moteur open source Workflow Core a r√©solu un certain nombre de probl√®mes qui nous emp√™chaient de vivre paisiblement sur WWF.  Le plus important d'entre eux est, bien s√ªr, le support .Net Core et son absence, m√™me dans les plans, WWF. </p><br><p>  Voici l'open source.  Travailler avec le WWF et obtenir diverses erreurs de ses entrailles, la capacit√© de lire au moins la source serait tr√®s utile.  Sans parler de changer quelque chose en eux.  Ici avec Workflow Core une libert√© totale (y compris les licences - MIT).  Si une erreur appara√Æt soudainement dans les entrailles du moteur, t√©l√©chargez simplement les sources depuis github et recherchez calmement la cause de son apparition.  Oui, la simple possibilit√© de d√©marrer le moteur en mode d√©bogage avec des points d'arr√™t facilite d√©j√† consid√©rablement le processus. </p><br><p>  Bien s√ªr, en r√©solvant certains probl√®mes, Workflow Core en a apport√© de nouveaux.  Nous avons d√ª apporter une quantit√© importante de modifications au c≈ìur du moteur.  Mais.  Les travaux de ¬´finition¬ª pour eux-m√™mes co√ªtent moins de temps que de d√©velopper votre propre moteur √† partir de z√©ro.  La solution finale √©tait tout √† fait acceptable en termes de vitesse et de stabilit√©, elle nous a permis d'oublier les probl√®mes avec le moteur et de nous concentrer sur le d√©veloppement de la valeur commerciale du produit. </p><br><p>  <em>PS Si le sujet s'av√®re int√©ressant, alors il y aura plus d'articles sur wf core, avec une analyse plus approfondie du moteur et des solutions aux probl√®mes commerciaux complexes.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr475902/">https://habr.com/ru/post/fr475902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr475888/index.html">Avantages de la reconnaissance faciale du cloud</a></li>
<li><a href="../fr475892/index.html">Comment nous avons am√©lior√© l'ordre du d√©jeuner au bureau (sans acc√®s au serveur)</a></li>
<li><a href="../fr475894/index.html">Trois protocoles de passage</a></li>
<li><a href="../fr475896/index.html">R√©acteur N complet C d'E / S</a></li>
<li><a href="../fr475900/index.html">Les 6 cours Azure les plus r√©cents</a></li>
<li><a href="../fr475904/index.html">5 notes pour le nouveau manager</a></li>
<li><a href="../fr475908/index.html">Les 10 cours Microsoft les plus populaires en russe</a></li>
<li><a href="../fr475912/index.html">Comment √©valuer et comparer les p√©riph√©riques de chiffrement pour les r√©seaux Ethernet</a></li>
<li><a href="../fr475916/index.html">Ajoutez des yeux au robot</a></li>
<li><a href="../fr475920/index.html">Pas au moment de l'ex√©cution, mais au moment de la conception</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>