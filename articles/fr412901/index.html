<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÅ ü•ß ü§õüèæ Surveillance et Kubernetes (revue et rapport vid√©o) üßóüèæ üå®Ô∏è üåö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le 28 mai, lors de la conf√©rence RootConf 2018, qui a eu lieu dans le cadre du festival RIT ++ 2018, dans la section ¬´Logging and Monitoring¬ª, un rapp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Surveillance et Kubernetes (revue et rapport vid√©o)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/412901/">  Le 28 mai, lors de la conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RootConf</a> 2018, qui a eu lieu dans le cadre du festival RIT ++ 2018, dans la section ¬´Logging and Monitoring¬ª, un rapport ¬´Monitoring and Kubernetes¬ª a √©t√© remis.  Il raconte l'exp√©rience de la surveillance de la configuration avec Prometheus, qui a √©t√© obtenue par Flant √† la suite de l'exploitation de dizaines de projets Kubernetes en production. <br><br><img src="https://habrastorage.org/webt/pm/o9/dm/pmo9dmnz9jf7b-yhej9shmir92q.jpeg"><br><br>  Par tradition, nous sommes heureux de pr√©senter une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>vid√©o avec un rapport</b></a> (environ une heure, <b>beaucoup plus</b> informatif <b>que l'</b> article) et la principale compression sous forme de texte.  C'est parti! <a name="habracut"></a><br><br><h2>  Qu'est-ce que la surveillance? </h2><br>  Il existe de nombreux syst√®mes de surveillance: <br><br><img src="https://habrastorage.org/webt/pa/07/i0/pa07i0ojuohdqwxbk6lvf86lgls.png"><br><br>  Il semblerait que la prise et l'installation de l'un d'entre eux - c'est tout, la question est close.  Mais la pratique montre que ce n'est pas le cas.  Et voici pourquoi: <br><br><ol><li>  <b>L'indicateur de vitesse indique la vitesse</b> .  Si nous mesurons la vitesse une fois par minute avec l'indicateur de vitesse, la vitesse moyenne, que nous calculons sur la base de ces donn√©es, ne co√Øncidera pas avec les donn√©es de l'odom√®tre.  Et si dans le cas d'une voiture, cela est √©vident, alors quand il s'agit de nombreux indicateurs pour le serveur, nous l'oublions souvent. <br><img src="https://habrastorage.org/webt/s9/13/fv/s913fvrbguhqbp3iuuobwrmazt8.png"><br>  <i>Ce que nous mesurons et comment nous avons r√©ellement voyag√©</i> </li><li>  <b>Plus de mesures</b> .  Plus nous obtiendrons d'indicateurs <i>diff√©rents</i> , plus le diagnostic des probl√®mes sera pr√©cis ... mais seulement √† condition que ce soient des indicateurs vraiment utiles, et pas seulement tout ce que vous avez r√©ussi √† collecter. </li><li>  <b>Alertes</b> .  L'envoi d'alertes n'a rien de compliqu√©.  Cependant, deux probl√®mes typiques: a) les fausses alarmes se produisent si souvent que nous cessons de r√©pondre aux alertes, b) les alertes arrivent √† un moment o√π il est trop tard (tout a d√©j√† explos√©).  Et r√©aliser en contr√¥lant que ces probl√®mes ne se sont pas pos√©s est un v√©ritable art! </li></ol><br>  La surveillance est une tarte de trois couches, chacune √©tant essentielle: <br><br><ol><li>  Tout d'abord, il s'agit d'un syst√®me qui vous permet de <b>pr√©venir les accidents</b> , de <b>signaler les accidents</b> (s'ils n'ont pas pu √™tre √©vit√©s) et d'effectuer un <b>diagnostic rapide des</b> probl√®mes. </li><li>  Que faut-il pour cela?  <b>Des donn√©es pr√©cises</b> , <b>des graphiques utiles</b> (regardez-les et comprenez o√π est le probl√®me), <b>des alertes pertinentes</b> (arrivez au bon moment et contiennent des informations claires). </li><li>  Et pour que tout cela fonctionne, un <b>syst√®me de surveillance est</b> n√©cessaire. </li></ol><br>  La configuration correcte d'un syst√®me de surveillance qui fonctionne vraiment n'est pas une t√¢che facile, n√©cessitant une approche r√©fl√©chie de la mise en ≈ìuvre m√™me sans Kubernetes.  Mais que se passe-t-il avec son apparence? <br><br><h2>  Sp√©cificit√©s de la surveillance Kubernetes </h2><br><h3>  N ¬∞ 1.  Plus grand et plus rapide </h3><br>  Kubernetes change beaucoup parce que l'infrastructure s'agrandit et devient plus rapide.  Si auparavant, avec des serveurs de fer ordinaires, leur nombre √©tait tr√®s limit√© et le processus d'ajout √©tait tr√®s long (prenait des jours ou des semaines), puis avec les machines virtuelles, le nombre d'entit√©s augmentait consid√©rablement et le temps de leur introduction dans la bataille √©tait r√©duit √† quelques secondes. <br><br>  Avec Kubernetes, le nombre d'entit√©s a augment√© d'un ordre de grandeur, leur ajout est compl√®tement automatis√© (la gestion de la configuration est n√©cessaire, car sans description, un nouveau pod ne peut tout simplement pas √™tre cr√©√©), toute l'infrastructure est devenue tr√®s dynamique (par exemple, les pods sont supprim√©s et lib√©r√©s √† chaque fois sont cr√©√©s √† nouveau). <br><br><img src="https://habrastorage.org/webt/01/fv/cf/01fvcfbc_i2roepw7nh0q6womsk.png"><br><br>  Qu'est-ce que cela change? <br><br><ol><li>  En principe, nous cessons de regarder des pods ou des conteneurs individuels - maintenant nous ne nous int√©ressons <b>qu'aux groupes d'objets</b> . </li><li>  <b>La d√©couverte du service devient strictement obligatoire</b> , car les "vitesses" sont d√©j√† telles que, en principe, nous ne pouvons pas d√©marrer / supprimer manuellement de nouvelles entit√©s, comme c'√©tait le cas auparavant, lors de l'achat de nouveaux serveurs. </li><li>  <b>La quantit√© de donn√©es augmente consid√©rablement</b> .  Si des mesures ant√©rieures √©taient collect√©es √† partir de serveurs ou de machines virtuelles, d√©sormais √† partir de pods, dont le nombre est beaucoup plus important. </li><li>  Le changement le plus int√©ressant que j'ai appel√© le ¬´ <b>flux de m√©tadonn√©es</b> ¬ª et je vais vous en dire plus. </li></ol><br>  Je vais commencer par cette comparaison: <br><br><ul><li>  Lorsque vous envoyez votre enfant √† la maternelle, on lui remet une bo√Æte personnelle, qui lui est attribu√©e pour la prochaine ann√©e (ou plus) et sur laquelle son nom est indiqu√©. </li><li>  Lorsque vous venez √† la piscine, votre casier n'est pas sign√© et il vous est d√©livr√© pour une ¬´s√©ance¬ª. </li></ul><br>  <b>Les syst√®mes de surveillance classiques pensent donc qu'ils sont un jardin d'enfants</b> , pas une piscine: ils supposent que l'objet de surveillance leur est venu pour toujours ou pour longtemps, et leur donnent des casiers en cons√©quence.  Mais les r√©alit√©s de Kubernetes sont diff√©rentes: un pod est venu dans la piscine (c'est-√†-dire a √©t√© cr√©√©), a nag√© dedans (jusqu'√† un nouveau d√©ploiement) et est parti (a √©t√© d√©truit) - tout cela se produit rapidement et r√©guli√®rement.  Ainsi, le syst√®me de surveillance doit comprendre que les objets qu'il surveille ont une courte dur√©e de vie et doit pouvoir l'oublier compl√®tement au bon moment. <br><br><h3>  N ¬∞ 2.  La r√©alit√© parall√®le existe </h3><br>  Autre point important - avec l'av√®nement de Kubernetes, nous avons simultan√©ment deux ¬´r√©alit√©s¬ª: <br><br><ol><li>  Monde Kubernetes dans lequel il y a des espaces de noms, des d√©ploiements, des pods, des conteneurs.  C'est un monde complexe, mais il est logique, structur√©. </li><li>  Le monde "physique", compos√© de nombreux (litt√©ralement - tas) de conteneurs sur chaque n≈ìud. </li></ol><br><img src="https://habrastorage.org/webt/1p/wc/xj/1pwcxjjt1xbgwqufldfm1upua10.png"><br>  <i>Un seul et m√™me conteneur dans la ¬´r√©alit√© virtuelle¬ª de Kubernetes (ci-dessus) et le monde physique des n≈ìuds (ci-dessous)</i> <br><br>  Et dans le processus de surveillance, nous devons constamment <b>comparer le monde physique des conteneurs avec la r√©alit√© de Kubernetes</b> .  Par exemple, lorsque nous regardons un espace de noms, nous voulons savoir o√π se trouvent tous ses conteneurs (ou les conteneurs de l'un de ses foyers).  Sans cela, les alertes ne seront pas visuelles et pratiques √† utiliser - car il est important pour nous de comprendre quels objets ils signalent. <br><br><img src="https://habrastorage.org/webt/2p/n7/3t/2pn73tojozunuxdnjiba8yqw7-y.png"><br>  <i>Diff√©rents types d'alertes - cette derni√®re est plus visuelle et pratique au travail que les autres</i> <br><br>  <b>Les conclusions</b> sont les suivantes: <br><br><ol><li>  Le syst√®me de surveillance doit utiliser les primitives int√©gr√©es de Kubernetes. </li><li>  Il y a plus d'une r√©alit√©: souvent, les probl√®mes ne se produisent pas avec le foyer, mais avec un n≈ìud particulier, et nous devons constamment comprendre dans quel type de ¬´r√©alit√©¬ª ils se trouvent. </li><li>  Dans un cluster, en r√®gle g√©n√©rale, il existe plusieurs environnements (en plus de la production), ce qui signifie que cela doit √™tre pris en compte (par exemple, pour ne pas recevoir d'alertes la nuit sur les probl√®mes de d√©veloppement). </li></ol><br>  Donc, nous avons trois conditions n√©cessaires pour que tout fonctionne: <br><br><ol><li>  Nous comprenons bien ce qu'est la surveillance. </li><li>  Nous connaissons ses fonctionnalit√©s, lesquelles apparaissent avec Kubernetes. </li><li>  Nous adoptons le Prom√©th√©e. </li></ol><br>  Et donc, pour vraiment s'entra√Æner, il ne reste plus qu'√† faire <i>vraiment beaucoup d'</i> efforts!  Au fait, pourquoi exactement Prom√©th√©e? .. <br><br><h2>  Prom√©th√©e </h2><br>  Il existe deux fa√ßons de r√©pondre √† la question concernant le choix de Prom√©th√©e: <br><br><ol><li>  D√©couvrez qui et quoi sont g√©n√©ralement utilis√©s pour surveiller Kubernetes. </li><li>  Consid√©rez ses avantages techniques. </li></ol><br>  Pour la premi√®re, j'ai utilis√© les donn√©es d'enqu√™te de The New Stack (du livre √©lectronique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">The State of the Kubernetes Ecosystem</a> ), selon lesquelles Prometheus est au moins plus populaire que les autres solutions (Open Source et SaaS), et si vous regardez, elle a un avantage statistique quintuple . <br><br>  Voyons maintenant comment Prometheus fonctionne, en parall√®le avec la fa√ßon dont ses capacit√©s se combinent avec Kubernetes et r√©solvent les d√©fis associ√©s. <br><br><h2>  Comment Prometheus est-il structur√©? </h2><br>  Prometheus est √©crit en Go et distribu√© comme un seul fichier binaire, dans lequel tout est int√©gr√©.  L'algorithme de base pour son fonctionnement est le suivant: <br><br><img src="https://habrastorage.org/webt/nh/xt/hp/nhxthp-dm3wveymrgbejbanainw.png"><br><br><ul><li>  <b>Le collecteur</b> lit la <b>table des cibles</b> , c.-√†-d.  une liste des objets √† surveiller et la fr√©quence de leur interrogation (par d√©faut - 60 secondes). </li><li>  Apr√®s cela, le collecteur envoie une demande HTTP √† chaque module dont vous avez <b>besoin</b> et re√ßoit une r√©ponse avec un ensemble de m√©triques - il peut y avoir cent, mille, dix mille ... Chaque m√©trique a un nom, une valeur et des <b>√©tiquettes</b> . </li><li>  La r√©ponse re√ßue est <b>stock√©e</b> dans la <b>base de</b> donn√©es <b>TSDB</b> , o√π l'horodatage de sa r√©ception et les √©tiquettes de l'objet dont elle provient ont √©t√© ajout√©es aux donn√©es m√©triques re√ßues. <br><br><div class="spoiler">  <b class="spoiler_title">En bref sur TSDB</b> <div class="spoiler_text">  <i>TSDB - base de donn√©es de s√©ries chronologiques (DB pour s√©ries chronologiques) sur Go, qui vous permet de stocker des donn√©es pendant un nombre de jours sp√©cifi√© et le fait tr√®s efficacement (en taille, en m√©moire et en entr√©e / sortie).</i>  <i>Les donn√©es sont stock√©es uniquement localement, sans clustering et r√©plication, ce qui est un plus (cela fonctionne simplement et de mani√®re garantie) et un moins (il n'y a pas de mise √† l'√©chelle horizontale du stockage), mais dans le cas du partage Prometheus, c'est bien fait, f√©d√©ration - plus √† ce sujet plus tard.</i> <br></div></div></li><li>  Pr√©sent√© dans le sch√©ma, <b>Service Discovery</b> est un moteur de d√©couverte de service int√©gr√© √† Prometheus qui vous permet de recevoir des donn√©es ¬´de la bo√Æte¬ª (via l'API Kubernetes) pour cr√©er une table d'objectifs. </li></ul><br>  √Ä quoi ressemble ce tableau?  Pour chaque entr√©e, il stocke l'URL utilis√©e pour obtenir les m√©triques, la fr√©quence des appels et les √©tiquettes. <br><br><img src="https://habrastorage.org/webt/xu/9m/c_/xu9mc_ikwk-sdzkrs_fjt6lsfj0.png"><br><br>  Les √©tiquettes sont utilis√©es pour la juxtaposition m√™me des ¬´mondes¬ª de Kubernetes avec le physique.  Par exemple, pour trouver un pod avec Redis, nous devons avoir l'espace de noms de valeurs, le service (utilis√© au lieu du d√©ploiement en raison des caract√©ristiques techniques d'un cas particulier) et le pod r√©el.  Par cons√©quent, ces 3 √©tiquettes sont stock√©es dans des entr√©es de table d'objectifs pour les m√©triques Redis. <br><br>  Ces entr√©es dans le tableau sont form√©es sur la base de la <code>scrape_configs</code> Prometheus dans laquelle les objets de surveillance sont d√©crits: dans la section <code>scrape_configs</code> , des <code>scrape_configs</code> d√©finis, qui indiquent par quelles √©tiquettes rechercher les objets √† surveiller, comment les filtrer et quelles √©tiquettes enregistrer. <br><br><h2>  Quelles donn√©es Kubernetes collecte-t-il? </h2><br><ul><li>  Premi√®rement, l' <b>assistant</b> dans Kubernetes est assez compliqu√© - et il est essentiel de surveiller l'√©tat de son travail (kube-apiserver, kube-controller-manager, kube-scheduler, kube-etcd3 ...), de plus, il est li√© au n≈ìud de cluster. </li><li>  Deuxi√®mement, il est important de savoir ce qui se passe √† l' <b>int√©rieur de Kubernetes</b> . Pour ce faire, nous obtenons des donn√©es de: <br><ul><li>  <i>kubelet</i> - ce composant Kubernetes s'ex√©cute sur chaque n≈ìud du cluster (et se connecte √† l'assistant K8s);  cAdvisor y est int√©gr√© (toutes les mesures par conteneurs), et il stocke √©galement des informations sur les volumes persistants connect√©s; </li><li>  <i>kube-state-metrics</i> - en fait, il s'agit de l'exportateur Prometheus pour l'API Kubernetes (il vous permet d'obtenir des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">informations sur les objets</a> stock√©s dans Kubernetes: pods, services, d√©ploiements, etc.; par exemple, nous ne le saurons pas sans lui √©tat du r√©cipient ou du foyer); </li><li>  <i>n≈ìud-exportateur</i> - fournit des informations sur le n≈ìud lui-m√™me, les mesures de base sur le syst√®me Linux (cpu, diskstats, meminfo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">etc.</a> ). </li></ul></li><li>  Viennent <b>ensuite les composants Kubernetes</b> , tels que kube-dns, kube-prometheus-operator et kube-prometheus, ingress-nginx-controller, etc. </li><li>  La prochaine cat√©gorie d'objets √† surveiller est en fait le <b>logiciel</b> lanc√© dans Kubernetes.  Ce sont des services de serveur typiques comme nginx, php-fpm, Redis, MongoDB, RabbitMQ ... Nous le faisons nous-m√™mes afin que lorsque nous ajoutons certaines √©tiquettes au service, il commence automatiquement √† collecter les donn√©es n√©cessaires, ce qui cr√©e le tableau de bord actuel dans Grafana. </li><li>  Enfin, la cat√©gorie pour tout le reste est <b>personnalis√©e</b> .  Les outils Prometheus vous permettent d'automatiser la collecte de mesures arbitraires (par exemple, le nombre de commandes) en ajoutant simplement une √©tiquette <code>prometheus-custom-target</code> √† la description du service. </li></ul><br><img src="https://habrastorage.org/webt/0s/e6/c3/0se6c3ygspys909x3ju6m9aq7uu.gif"><br><h2>  Graphiques </h2><br>  Les donn√©es re√ßues <i>(d√©crites ci-dessus) sont</i> utilis√©es pour envoyer des alertes et cr√©er des graphiques.  Nous <b>dessinons des</b> graphiques en utilisant <b>Grafana</b> .  Et un ¬´d√©tail¬ª important ici est <b>PromQL</b> , le langage de requ√™te Prometheus qui s'int√®gre parfaitement avec Grafana. <br><br><img src="https://habrastorage.org/webt/_a/sl/7w/_asl7wbfscz1eyxstacdij_liio.png"><br><br>  Il est assez simple et pratique pour la plupart des t√¢ches <i>(mais, par exemple, y joindre des jointures est d√©j√† g√™nant, mais vous devez quand m√™me le faire)</i> .  PromQL vous permet de r√©soudre toutes les t√¢ches n√©cessaires: s√©lectionnez rapidement les mesures n√©cessaires, comparez les valeurs, effectuez des op√©rations arithm√©tiques sur celles-ci, groupez, travaillez avec des intervalles de temps et bien plus encore.  Par exemple: <br><br><img src="https://habrastorage.org/webt/3h/1d/0v/3h1d0vskm__dosoxpx1rzd5jis8.png"><br><br>  De plus, Prometheus a un <b>√©valuateur</b> qui, en utilisant le m√™me PromQL, peut acc√©der √† TSDB avec la fr√©quence sp√©cifi√©e.  Pourquoi √ßa?  Exemple: commencez √† envoyer des alertes dans les cas o√π nous avons, selon les mesures disponibles, une erreur 500 sur le serveur Web au cours des 5 derni√®res minutes.  En plus des √©tiquettes qui √©taient dans la demande, l'√©valuateur ajoute des √©tiquettes suppl√©mentaires aux donn√©es pour les alertes (que nous configurons), apr√®s quoi elles sont envoy√©es au format JSON √† un autre composant Prometheus - <b>Alertmanager</b> . <br><br>  Prometheus envoie p√©riodiquement (une fois toutes les 30 secondes) des alertes √† Alertmanager, qui les d√©duplique (apr√®s avoir re√ßu la premi√®re alerte, il l'enverra et les suivantes ne seront plus envoy√©es). <br><br><img src="https://habrastorage.org/webt/ju/0e/lg/ju0elg1u57wtxfjopy6wz38vtfg.png"><br><br>  <i><b>Remarque</b> : Nous n'utilisons pas Alertmanager √† la maison, mais envoyons les donn√©es de Prometheus directement √† notre syst√®me, avec lequel nos assistants travaillent, mais cela n'a pas d'importance dans le sch√©ma g√©n√©ral.</i> <br><br><h2>  Prom√©th√©e √† Kubernetes: la vue d'ensemble </h2><br>  Voyons maintenant comment fonctionne l'ensemble de cet ensemble Prometheus dans Kubernetes: <br><br><img src="https://habrastorage.org/webt/w-/gu/ue/w-guue_2b8q12romg-qv7uw2hpi.png"><br><br><ul><li>  Kubernetes a son propre espace de noms pour Prom√©th√©e <i>(nous avons <code>kube-prometheus</code> dans l'illustration)</i> . </li><li>  Cet espace de noms h√©berge le pod avec l'installation de Prometheus, qui, toutes les 30 secondes, collecte les m√©triques de toutes les cibles re√ßues via Service Discovery dans le cluster. </li><li>  Il abrite √©galement un pod avec Alertmanager, qui re√ßoit des donn√©es de Prometheus et envoie des alertes <i>(par courrier, Slack, PagerDuty, WeChat, int√©gration tierce, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">etc.</a> )</i> . </li><li>  Prometheus fait face √† un √©quilibreur de charge - un service r√©gulier √† Kubernetes - et Grafana acc√®de √† Prometheus par son interm√©diaire.  Pour <b>garantir la tol√©rance aux pannes, Prometheus</b> utilise plusieurs modules avec des installations Prometheus, chacun collectant toutes les donn√©es et les stockant dans son TSDB.  Gr√¢ce √† l'√©quilibreur, Grafana frappe l'un d'eux. </li><li>  Le nombre de pods avec Prometheus est contr√¥l√© par le param√®tre <i>StatefulSet</i> - nous ne fabriquons g√©n√©ralement pas plus de deux pods, mais vous pouvez augmenter ce nombre.  De la m√™me mani√®re, Alertmanager est d√©ploy√© via StatefulSet, pour la tol√©rance de panne dont au moins 3 pods sont d√©j√† requis (puisqu'un quorum est n√©cessaire pour prendre des d√©cisions sur l'envoi d'alertes). <br></li></ul><br>  Qu'est-ce qui manque ici? .. <br><br><h2>  F√©d√©ration pour Prom√©th√©e </h2><br>  Lorsque les donn√©es sont collect√©es toutes les 30 (ou 60) secondes, l'endroit o√π les stocker se termine tr√®s rapidement, et pire encore, cela n√©cessite beaucoup de ressources informatiques (lors de la r√©ception et du traitement d'un si grand nombre de points de TSDB).  Mais nous voulons stocker et avoir la possibilit√© de t√©l√©charger des informations pour <b>des intervalles de temps importants <i>et</i> e</b> .  Comment y parvenir? <br><br>  Il suffit d'ajouter <b>une installation suppl√©mentaire de Prometheus</b> (nous l'appelons √† <i>long terme</i> ) au sch√©ma g√©n√©ral, dans lequel Service Discovery est d√©sactiv√©, et dans le tableau des objectifs, il existe le seul enregistrement statique menant au Prometheus <i>principal</i> ( <i>principal</i> ).  <b>C'est possible gr√¢ce √† la <a href="">f√©d√©ration</a></b> : Prometheus vous permet de renvoyer les derni√®res valeurs de toutes les m√©triques en une seule requ√™te.  Ainsi, la premi√®re installation de Prometheus fonctionne toujours (acc√®de toutes les 60 ou, par exemple, 30 secondes) √† toutes les cibles du cluster Kubernetes, et la seconde - une fois toutes les 5 minutes, re√ßoit les donn√©es de la premi√®re et les stocke pour pouvoir regarder les donn√©es pendant une longue p√©riode ( mais sans d√©tails approfondis). <br><br><img src="https://habrastorage.org/webt/zc/uj/k3/zcujk3s5oxler1lhwaaswadmiyy.png"><br>  <i>La deuxi√®me installation de Prometheus ne n√©cessite pas de d√©couverte de service, et le tableau des objectifs sera compos√© d'une ligne</i> <br><br><img src="https://habrastorage.org/webt/od/zr/ow/odzrowlvdyq3qmhfldvy085naou.png"><br>  <i>Le tout avec des installations Prometheus de deux types: principal (haut) et long terme</i> <br><br>  La touche finale consiste √† <b>connecter Grafana</b> aux deux installations de Prometheus et √† cr√©er des tableaux de bord d'une mani√®re sp√©ciale afin que vous puissiez basculer entre les sources de donn√©es ( <i>principales</i> ou √† <i>long terme</i> ).  Pour ce faire, √† l'aide du moteur de mod√®le, remplacez la variable <code>$prometheus</code> au lieu de la source de donn√©es dans tous les panneaux. <br><br><img src="https://habrastorage.org/webt/ju/v3/9u/juv39un0v2qdtwegrt07qpg-1yi.png"><br><br><h2>  Quoi d'autre est important dans les graphiques? </h2><br>  La prise en charge des primitives Kubernetes et la possibilit√© de <b>passer</b> rapidement de l'image globale (ou une "vue" inf√©rieure) √† un service sp√©cifique et vice versa sont deux points cl√©s √† prendre en compte lors de l'organisation des plannings. <br><br>  La prise en charge des primitives (espaces de noms, pods, etc.) a d√©j√† √©t√© mentionn√©e - c'est une condition n√©cessaire en principe pour un travail confortable dans les r√©alit√©s de Kubernetes.  Et voici un exemple de drill down: <br><br><ul><li>  Nous regardons les graphiques de consommation de ressources par trois projets (c'est-√†-dire, trois espaces de noms) - nous voyons que la partie principale du CPU (ou de la m√©moire, ou du r√©seau, ...) tombe sur le projet A. </li><li>  Nous regardons les m√™mes graphiques, mais d√©j√† pour les services du projet A: lequel consomme le plus de CPU? </li><li>  Nous nous tournons vers les cartes du service souhait√©: quel pod est ¬´√† bl√¢mer¬ª? </li><li>  Nous passons aux diagrammes du pod souhait√©: quel conteneur faut-il "bl√¢mer"?  C'est le but recherch√©! </li></ul><br><img src="https://habrastorage.org/webt/fq/vb/ly/fqvblyn0wdnoqqzqgwi0ublftjy.png"><br><h2>  R√©sum√© </h2><br><ul><li>  √ânoncez avec pr√©cision ce qu'est la surveillance.  <i>(Laissez le "g√¢teau √† trois couches" servir de rappel √† cela ... ainsi que le fait que le faire cuire avec comp√©tence n'est pas facile m√™me sans Kubernetes!)</i> </li><li>  N'oubliez pas que Kubernetes ajoute des sp√©cificit√©s obligatoires: regroupement de cibles, d√©couverte de services, grandes quantit√©s de donn√©es, flux de m√©tadonn√©es.  De plus: <br><ul><li>  oui, certains d'entre eux sont r√©solus comme par magie (¬´out of the box¬ª) dans Prom√©th√©e; </li><li>  cependant, il reste une autre partie qui doit √™tre surveill√©e de mani√®re ind√©pendante et r√©fl√©chie. </li></ul></li></ul><br>  Et rappelez-vous que le <b>contenu est plus important qu'un syst√®me</b> , c'est-√†-dire  les graphiques et alertes corrects sont principaux, et non Prometheus (ou tout autre logiciel similaire) en tant que tels. <br><br><img src="https://habrastorage.org/webt/ml/61/ou/ml61oub7wmavnyfdmjepkm7bd-y.png"><br><br><h2>  Vid√©os et diapositives </h2><br>  Vid√©o de la performance (environ une heure): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/zj6SlzzBRaA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Pr√©sentation du rapport: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h2>  PS </h2><br>  Autres reportages sur notre blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bases de donn√©es et Kubernetes</a> ";  <i>(Dmitry Stolyarov; 8 novembre 2018 √† HighLoad ++)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Meilleures pratiques CI / CD avec Kubernetes et GitLab</a> ¬ª;  <i>(Dmitry Stolyarov; 7 novembre 2017 √† HighLoad ++)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Notre exp√©rience avec Kubernetes dans les petits projets</a> ¬ª;  <i>(Dmitry Stolyarov; 6 juin 2017 √† RootConf)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nous collectons des images Docker pour CI / CD rapidement et facilement avec dapp</a> ¬ª <i>(Dmitry Stolyarov; 8 novembre 2016 sur HighLoad ++)</i> ; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pratiques de livraison continue avec Docker</a> ¬ª <i>(Dmitry Stolyarov; 31 mai 2016 √† RootConf)</i> . </li></ul><br>  Vous pouvez √©galement √™tre int√©ress√© par les publications suivantes: <br><br><ul><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le dispositif et le m√©canisme de fonctionnement de l'op√©rateur Prom√©th√©e √† Kubernetes</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Surveillance avec Prom√©th√©e √† Kubernetes en 15 minutes</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Infrastructure avec Kubernetes en tant que service abordable</a> .¬ª </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr412901/">https://habr.com/ru/post/fr412901/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr412891/index.html">Citrix XenServer 7.0 I / O non optimis√© Agent de gestion non install√©</a></li>
<li><a href="../fr412893/index.html">Pour atteindre un programmeur senior en quatre ans: la m√©thode "School 21"</a></li>
<li><a href="../fr412895/index.html">Vesta Matveeva: la lutte contre la cybercriminalit√© est un choix moral</a></li>
<li><a href="../fr412897/index.html">Surveillance des produits Atlassian avec Prometheus</a></li>
<li><a href="../fr412899/index.html">Week-end lecture: 30 documents sur le son, l'histoire des marques audio et l'industrie cin√©matographique</a></li>
<li><a href="../fr412903/index.html">Comment nous avons peint Habr</a></li>
<li><a href="../fr412905/index.html">√Ä propos de l'analyse LL: une approche de l'analyse √† travers le concept de coupe de cha√Æne</a></li>
<li><a href="../fr412911/index.html">Les d√©veloppeurs parlent de fonctionnalit√©s d√©coup√©es dans les jeux</a></li>
<li><a href="../fr412913/index.html">"Baikal-T1" a √©t√© mis en vente pour 3990 roubles</a></li>
<li><a href="../fr412915/index.html">D√©termination de la densit√© de gaz √† partir des r√©sultats de la mesure de la pression et de la temp√©rature avec des capteurs Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>