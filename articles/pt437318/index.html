<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßñ ü§ù üêÜ Migra√ß√£o perfeita (quase) entre as principais vers√µes do PostgreSQL usando replica√ß√£o l√≥gica üëéüèø ü•É üçø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em True Engineering, em um projeto, surgiu a necessidade de alterar a vers√£o do PostgreSQL de 9.6 para 11.1. 

 Porque O banco de dados no projeto j√° ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migra√ß√£o perfeita (quase) entre as principais vers√µes do PostgreSQL usando replica√ß√£o l√≥gica</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/437318/">  Em True Engineering, em um projeto, surgiu a necessidade de alterar a vers√£o do PostgreSQL de 9.6 para 11.1. <br><br>  Porque  O banco de dados no projeto j√° tem 1,5 Tb de tamanho e est√° crescendo.  O desempenho √© um dos principais requisitos do sistema.  E a pr√≥pria estrutura de dados est√° evoluindo: novas colunas s√£o adicionadas, as existentes s√£o alteradas.  A nova vers√£o do Postgres aprendeu a trabalhar eficientemente com a adi√ß√£o de novas colunas com um valor padr√£o, portanto, n√£o h√° necessidade de cercar muletas personalizadas no n√≠vel do aplicativo.  Mesmo na nova vers√£o, v√°rias novas maneiras de particionar tabelas foram adicionadas, o que tamb√©m √© extremamente √∫til em condi√ß√µes de uma grande quantidade de dados. <br><br>  Ent√£o, est√° decidido, estamos migrando.  Obviamente, voc√™ pode criar uma nova vers√£o do servidor PostgreSQL em paralelo com a antiga, interromper o aplicativo, usar dump / restore (ou pg_upgrade) para mover o banco de dados e iniciar o aplicativo novamente.  Essa solu√ß√£o n√£o nos convinha, devido ao grande tamanho da base; al√©m disso, o aplicativo funciona no modo de combate, e h√° apenas alguns minutos para o tempo de inatividade. <br><br>  Portanto, decidimos tentar a migra√ß√£o usando replica√ß√£o l√≥gica no PostgreSQL usando um plug-in de terceiros chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pglogical</a> . <br><br>  No processo de "julgamento", encontramos documenta√ß√£o muito fragmentada sobre esse processo (e em russo n√£o √© de todo), al√©m de algumas armadilhas e nuances n√£o √≥bvias.  Neste artigo, queremos apresentar nossa experi√™ncia na forma de um tutorial. <br><br><img src="https://habrastorage.org/webt/cp/i7/oi/cpi7oixtsenmioqdrcyyotgagyk.png"><br><br>  <b>TL; DR</b> <br><br><ul><li>  Tudo acabou (n√£o sem muletas, um artigo sobre elas). </li><li>  Voc√™ pode migrar na vers√£o PostgreSQL da 9.4 para a 11.x, de qualquer vers√£o para outra, para baixo ou para cima. </li><li>  O tempo de inatividade √© igual ao tempo que leva para o seu aplicativo se reconectar ao novo servidor de banco de dados (no nosso caso, foi uma reinicializa√ß√£o de todo o aplicativo, mas no estado selvagem, obviamente, ‚Äúop√ß√µes poss√≠veis‚Äù). </li></ul><a name="habracut"></a><br><h3>  Por que a solu√ß√£o "testa" n√£o se encaixava em n√≥s </h3><br>  Como j√° dissemos, a maneira mais f√°cil √© elevar a nova vers√£o do servidor PostgreSQL em paralelo com a antiga, interromper o aplicativo, usar dump / restore (ou pg_upgrade) para mover o banco de dados e iniciar o aplicativo novamente.  Para bancos de dados de pequeno volume, em princ√≠pio, essa √© uma op√ß√£o bastante adequada (ou, no caso geral, o volume n√£o √© importante quando voc√™ tem a op√ß√£o de tempo de inatividade do aplicativo durante o per√≠odo de "transfus√£o" do banco de dados do servidor antigo para o novo, n√£o importa quanto tempo seja).  Mas, no nosso caso, o banco de dados leva cerca de 1,5 TB no disco, e a movimenta√ß√£o n√£o √© quest√£o de minutos, mas de v√°rias horas.  O aplicativo, por sua vez, funciona no modo de combate, e eu realmente queria evitar o tempo de inatividade por mais de alguns minutos. <br><br>  Tamb√©m contra essa op√ß√£o foi o fato de usarmos a replica√ß√£o Master-Slave e n√£o podermos desligar com seguran√ßa o servidor Slave do fluxo de trabalho.  Portanto, para alternar o aplicativo da vers√£o antiga do PostgreSQL para a nova ap√≥s a migra√ß√£o do servidor Master, seria necess√°rio preparar um novo servidor Slave antes de iniciar o aplicativo.  E s√£o mais algumas horas de inatividade at√© que o Escravo seja criado (embora muito menos que a migra√ß√£o do Mestre). <br><br>  Portanto, decidimos tentar a migra√ß√£o usando replica√ß√£o l√≥gica no PostgreSQL usando um plug-in de terceiros chamado pglogical. <br><br><h3>  Informa√ß√£o geral </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O pglogical</a> √© um sistema de replica√ß√£o l√≥gica que utiliza a decodifica√ß√£o l√≥gica nativa no PostgreSQL e implementada como uma extens√£o do PostgreSQL.  Permite configurar a replica√ß√£o seletiva usando o modelo de assinatura / publica√ß√£o.  N√£o requer a cria√ß√£o de gatilhos no banco de dados ou o uso de utilit√°rios externos para replica√ß√£o. <br><br>  A extens√£o funciona em qualquer vers√£o do PostgreSQL, a partir do 9.4 (desde que o Logical Decoding apareceu pela primeira vez no 9.4) e permite migrar entre as vers√µes suportadas do PostgreSQL em qualquer dire√ß√£o. <br><br>  Configurar manualmente a replica√ß√£o usando pglogical manualmente n√£o √© muito trivial, embora, em princ√≠pio, seja bem poss√≠vel.  Felizmente, existe um utilit√°rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pgrepup</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">terceiros</a> para automatizar o processo de configura√ß√£o, que usaremos. <br><br><h3>  Memorando de espa√ßo em disco </h3><br>  Como planejamos elevar a nova vers√£o do PostgreSQL nos mesmos servidores em paralelo com a antiga, os requisitos de disco para o banco de dados nos servidores Mestre e Escravo s√£o duplicados.  Parece que isso √© √≥bvio, mas ... Apenas cuide de espa√ßo livre suficiente antes de iniciar a replica√ß√£o para n√£o se arrepender dos anos passados ‚Äã‚Äãsem rumo. <br><br>  No nosso caso, foram necess√°rias modifica√ß√µes no banco de dados, al√©m do formato de armazenamento durante a migra√ß√£o entre 9.6 e 11 "swells", n√£o a favor da vers√£o mais recente; portanto, o espa√ßo em disco teve que ser aumentado n√£o em 2, mas em cerca de 2,2 vezes.  Elogie o LVM, isso pode ser feito no processo de migra√ß√£o em tempo real. <br><br>  Em geral, cuide disso. <br><br><h3>  Instale o PostgreSQL 11 no Master </h3><br><blockquote>  Nota: Usamos o Oracle Linux e todos os itens a seguir ser√£o aprimorados para esta distribui√ß√£o.  √â poss√≠vel que outras distribui√ß√µes Linux exijam uma pequena revis√£o de um arquivo, mas √© improv√°vel que seja significativo. </blockquote><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-oraclelinux11-11-2.noarch.rpm #   postgresql11 yum install postgresql11 postgresql11-devel postgresql11-server postgresql11-contrib #   /usr/pgsql-11/bin/postgresql-11-setup initdb</span></span></code> </pre> <br>  O datadir antigo est√° localizado em <b>/var/lib/pgsql/9.6/data</b> , o novo, portanto, est√° em <b>/ var / lib / pgsql / 11 / data</b> <br><br>  Copie as configura√ß√µes de acesso ( <b>pg_hba.conf</b> ) e as configura√ß√µes do servidor ( <b>postgresql.conf</b> ) de 9.6 para 11. <br><br>  Para executar dois servidores PostgreSQL na mesma m√°quina, na configura√ß√£o do <b>postgresql.conf</b> 11, altere a porta para 15432 (port = 15432). <br><br>  Aqui voc√™ precisa pensar cuidadosamente no que mais voc√™ precisa fazer na nova vers√£o do PostgreSQL especificamente no seu caso, para que ele comece com o <b>postgresql.conf</b> (e seu aplicativo poder√° eventualmente funcionar com ele).  No nosso caso, foi necess√°rio instalar as extens√µes do PostgreSQL usadas por n√≥s na nova vers√£o.  Isso est√° al√©m do escopo do artigo, basta fazer o novo PostgreSQL iniciar, funcionar e se adequar a voc√™ :) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,  ,  shared libraries, whatever... # .... #  systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br>  Examinamos <b>/ var / lib / pgsql / 11 / data / pg_log /</b> .  Est√° tudo bem?  N√≥s continuamos! <br><br><h3>  Instale e configure o pgrepup </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  python yum install python yum install python2-pip #  pgrepup pip install pgrepup #   pgrepup config</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/zg/xz/9o/zgxz9oct5l-qglkxyeyrqejh4we.png"><br><br>  Nuances: <br><br><ol><li>  Como <b>app_owner,</b> especificamos o usu√°rio sob o qual os servidores PostgreSQL est√£o em execu√ß√£o. </li><li>  Para <b>Banco de Dados,</b> especifique <b>template1</b> . </li><li>  <b>Nome de usu√°rio</b> e <b>senha</b> - dados para acesso de superusu√°rio.  No nosso caso, o m√©todo <b>trust</b> foi especificado em <b>pg_hba.conf</b> para conex√µes locais do usu√°rio do <b>postgres</b> , para que voc√™ possa especificar uma senha arbitr√°ria. </li></ol><br><h3>  Configurar replica√ß√£o </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   pgrepup check</span></span></code> </pre><br>  Obtemos a sa√≠da de uma lista de muitos par√¢metros que devem ser configurados conforme necess√°rio. <br><br>  Resultados de verifica√ß√£o de exemplo: <br><br><img src="https://habrastorage.org/webt/h3/wu/zm/h3wuzmcevo7idf-xlyrz3ae8av8.png"><br><br><img src="https://habrastorage.org/webt/58/zh/bb/58zhbbubdbfvzzgat051bviywqy.png"><br><br>  Todos os erros durante a verifica√ß√£o precisar√£o ser eliminados.  Nas configura√ß√µes de ambos os servidores, deve-se definir <b>wal_level = LOGICAL</b> (para que a Decodifica√ß√£o l√≥gica funcione), as configura√ß√µes necess√°rias para o mecanismo de replica√ß√£o (n√∫mero de slots e <b>wal_senders</b> ).  As dicas do utilit√°rio pgrepup s√£o bastante informativas; as perguntas n√£o devem surgir na maioria dos pontos. <br><br>  N√≥s fazemos todas as configura√ß√µes necess√°rias que o pgrepup solicita. <br><br>  Nos dois arquivos <b>pg_hba.conf</b> , adicionamos permiss√µes para o usu√°rio que far√° a replica√ß√£o, tudo no prompt pgrepup: <br><br><pre> <code class="bash hljs">host replication pgrepup_replication 127.0.0.1/32 md5 host all pgrepup_replication 127.0.0.1/32 md5</code> </pre> <br><h3>  Adicionar chaves prim√°rias </h3><br>  Para que a replica√ß√£o funcione, uma Chave Prim√°ria deve ser definida em todas as tabelas. <br><br>  No nosso caso, o PK n√£o estava em todo lugar; portanto, no momento da replica√ß√£o, voc√™ deve adicion√°-lo e, no final da replica√ß√£o, se necess√°rio, exclu√≠-lo. <br><br>  Uma lista de tabelas sem PK, entre outras coisas, produz <code>pgrepup check</code> .  Para todas as tabelas desta lista, voc√™ precisa adicionar uma chave prim√°ria da maneira que melhor lhe convier.  No nosso caso, era algo como: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> %s <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> temporary_pk <span class="hljs-type"><span class="hljs-type">BIGSERIAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span></code> </pre> <br>  O utilit√°rio pgrepup possui um comando <code>pgrepup fix</code> para executar esta opera√ß√£o ( <code>pgrepup fix</code> ) e, quando usado, fica impl√≠cito que, ap√≥s uma replica√ß√£o bem-sucedida, essas colunas tempor√°rias ser√£o exclu√≠das automaticamente.  Mas, infelizmente, essa funcionalidade era t√£o ilus√≥ria e encantadora em bugs em bases grandes que decidimos n√£o us√°-la, mas fazer essa opera√ß√£o manualmente, pois √© conveniente para n√≥s. <br><br><h3>  Instalar extens√£o pglogical </h3><br>  Instru√ß√µes para instalar a extens√£o podem ser encontradas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  A extens√£o deve ser instalada nos dois servidores. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       curl https://access.2ndquadrant.com/api/repository/dl/default/release/9.6/rpm | bash curl https://access.2ndquadrant.com/api/repository/dl/default/release/11/rpm | bash #   yum install postgresql96-pglogical postgresql11-pglogical</span></span></code> </pre> <br>  Adicione a carga da biblioteca no <b>postgresql.conf dos</b> dois servidores: <br><br><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'pglogical'</span></span></code> </pre> <br><h3>  Instale a extens√£o pgl_ddl_deploy </h3><br>  Essa √© uma extens√£o auxiliar que o pgrepup usa para replica√ß√£o l√≥gica de DDL. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      git clone https://github.com/enova/pgl_ddl_deploy.git #       PATH=/usr/pgsql-9.6/bin/:$PATH USE_PGXS=1 make USE_PGXS=1 make install make clean #       PATH=/usr/pgsql-11/bin/:$PATH make CLANG=true make install</span></span></code> </pre> <br>  Adicione a carga da biblioteca no <b>postgresql.conf dos</b> dois servidores: <br><br><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'pglogical,pgl_ddl_deploy'</span></span></code> </pre> <br><h3>  Verificando altera√ß√µes </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   postgresql systemctl restart postgresql-11</span></span></code> </pre> <br>  Agora, usando o <code>pgrepup check</code> voc√™ precisa se certificar de que tudo ficou bem com o servidor de destino e que todos os coment√°rios sobre o servidor de destino foram completamente eliminados. <br><br>  Se tudo estiver bem, voc√™ poder√° reiniciar o servidor antigo.  Aqui voc√™ precisa pensar em como seu aplicativo reagir√° √† reinicializa√ß√£o do servidor de banco de dados, talvez voc√™ deva par√°-lo primeiro. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  systemctl restart postgresql-9.6 #  pgrepup check</span></span></code> </pre> <br>  Agora, na sa√≠da do comando, todos os itens devem estar marcados como OK. <br><br>  Parece que voc√™ pode iniciar a migra√ß√£o, mas ... <br><br><h3>  Corrigir erros do pgrepup </h3><br>  Existem v√°rios erros na vers√£o atual do pgrepup que tornam a migra√ß√£o imposs√≠vel.  As solicita√ß√µes pull foram enviadas, mas, infelizmente, elas s√£o ignoradas; portanto, voc√™ precisar√° fazer corre√ß√µes manualmente. <br><br>  Vamos para a pasta de instala√ß√£o do pgrepup (nosso caso √© <b>/usr/lib/python2.7/site-packages/pgrepup/commands/</b> ). <br><br>  Fa√ßa isso uma vez.  Em cada arquivo <b>* .py</b> , adicione os <code>**kwargs</code> ausentes na descri√ß√£o da fun√ß√£o.  Uma imagem √© melhor que mil palavras: <br><br><img src="https://habrastorage.org/webt/l3/zc/uo/l3zcuo2exe8lq_0u3gwv_nq8jty.png"><br><br>  Confirme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Fa√ßa dois.  No <b>setup.py</b> , fazemos uma busca por ‚Äúsh -c‚Äù, duas entradas, todos os comandos do shell de v√°rias linhas precisam ser feitos de linha √∫nica. <br><br>  Confirme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h3>  Iniciar a migra√ß√£o </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  pgrepup setup</span></span></code> </pre> <br>  Com este comando, o pgrepup prepara os dois servidores para iniciar a replica√ß√£o, cria um usu√°rio, configura o pglogical, transfere o esquema do banco de dados. <br><br><img src="https://habrastorage.org/webt/ww/km/jd/wwkmjdmmpmwyvgbdqyktohnhmmy.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   pgrepup start</span></span></code> </pre> <br>  Ele disse: "Vamos!"  e acenou com a m√£o: <br><br><img src="https://habrastorage.org/webt/3k/xc/_r/3kxc_rgde-t7q6yuhtvwkol5acs.png"><br><br>  A replica√ß√£o est√° em execu√ß√£o.  A situa√ß√£o atual pode ser vista usando o comando <code>pgrepup status</code> : <br><br><img src="https://habrastorage.org/webt/ig/gs/wb/iggswbqldii-c6cd5a1y7qyqawu.png"><br><br>  Aqui vemos que dois bancos de dados j√° foram movidos e a replica√ß√£o est√° em andamento, e um ainda est√° em processo de mudan√ßa.  Agora resta apenas tomar caf√© e aguardar at√© que todo o volume do banco de dados original seja bombeado. <br><br>  Ao longo do caminho, voc√™ pode olhar mais fundo na fachada do pgrepup e ver o que acontece sob o cap√¥.  Para mentes curiosas, aqui est√° uma lista de perguntas como ponto de partida: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_replication_origin_status <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> remote_lsn <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_xlog_location_diff(s.sent_location,s.replay_location) byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> query <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> application_name=<span class="hljs-string"><span class="hljs-string">'subscription_copy'</span></span></code> </pre> <br>  Tendo bastante caf√© (no servidor de teste ao escrever este artigo, a migra√ß√£o de ~ 700Gb de dados durou cerca de um dia), finalmente vemos a seguinte imagem: <br><br><img src="https://habrastorage.org/webt/ep/2e/q2/ep2eq2c_mtywxboftk4ocb0e_1c.png"><br><br>  E isso significa que √© hora de preparar um novo escravo. <br><br><h3>  Instale o PostgreSQL 11 no Slave </h3><br>  Aqui tudo √© simples e, de acordo com o livro, sem nuances. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-oraclelinux11-11-2.noarch.rpm #  postgresql 11 yum install postgresql11 postgresql11-devel postgresql11-server postgresql11-contrib #      su - postgres pg_basebackup -h db-master.hostname -p 15432 -D /var/lib/pgsql/11/data/ -R -P -U replication -X stream -c fast</span></span></code> </pre> <br>  Copie as configura√ß√µes de acesso ( <b>pg_hba.conf</b> ) e as configura√ß√µes do servidor ( <b>postgresql.conf</b> ) de 9.6 para 11. Na configura√ß√£o da vers√£o <b>postgresql.conf</b> 11, altere a porta para 15432 (port = 15432) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br><pre> <code class="pgsql hljs">#     Master <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s; #     Slave <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> now()-pg_last_xact_replay_timestamp();</code> </pre><br><h3>  Subtotais </h3><br>  Ap√≥s todos esses procedimentos, obtemos este esquema de replica√ß√£o complicado: <br><br><img src="https://habrastorage.org/webt/70/ns/ej/70nsejcslxlccih_yktvesptqjg.png"><br><br>  Aqui, como uma √∫ltima verifica√ß√£o (e, no final, √© simplesmente bonito), voc√™ pode fazer algumas atualiza√ß√µes no banco de dados 9.6 Master e observar como √© replicado nos outros tr√™s servidores. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c0/c42/89e/7c0c4289e8a00b100f58ce751bd9209e.png" alt="imagem"><br><br><h3>  Mudando o aplicativo para a nova vers√£o do PostgreSQL </h3><br>  At√© agora, nosso aplicativo n√£o suspeitava de nada sobre a nova vers√£o do PostgreSQL, √© hora de corrigi-lo.  As op√ß√µes aqui dependem fundamentalmente de apenas duas coisas: <br>  Voc√™ superar√° os novos servi√ßos nas mesmas portas em que os antigos trabalhavam, <br>  e se seu aplicativo requer uma reinicializa√ß√£o ao reiniciar o servidor de banco de dados. <br><br>  Por divers√£o, responderemos √†s duas perguntas ‚Äúsim‚Äù e prosseguiremos. <br><br>  Paramos a aplica√ß√£o. <br><br><pre> <code class="pgsql hljs"># ,   , : <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity;</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    #       sequences. pgrepup stop</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/cz/hc/2t/czhc2t8k6pjk-6ivvilidj5k9xq.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      pgrepup uninstall</span></span></code> </pre><br><img src="https://habrastorage.org/webt/2w/ud/dq/2wuddqovqbninwwz9rx9fia8psa.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  master: #    systemctl disable postgresql-9.6 #   ,  ,  . systemctl stop postgresql-9.6 systemctl stop postgresql-11 #  slave: #    systemctl disable postgresql-9.6 #   ,  ,  . systemctl stop postgresql-9.6 systemctl stop postgresql-11</span></span></code> </pre> <br>  Retornamos a porta padr√£o na configura√ß√£o <b>postgresql.conf</b> da nova vers√£o para Master e Slave. <br><br>  No novo escravo, tamb√©m alteramos a porta para a porta padr√£o no <b>recovery.conf</b> . <br><br>  Ao longo do caminho, h√° uma sugest√£o do pecado para alterar ainda mais a porta na vers√£o antiga se tornar inativa: <br>  N√≥s expomos a porta n√£o padr√£o no <b>postgresql.conf da</b> vers√£o antiga para Master e Slave. <br>  No antigo Slave, tamb√©m alteramos a porta para uma n√£o-padr√£o no <b>recovery.conf</b> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   master systemctl enable postgresql-11 systemctl start postgresql-11 #   slave: systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br>  Verifique os logs. <br><br>  Verifique o status da replica√ß√£o no mestre. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s;</code> </pre> <br>  Iniciamos o aplicativo.  Estamos felizes por meia hora. <br><br>  <b>E, finalmente, literatura √∫til sobre o tema:</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Instru√ß√µes de instala√ß√£o para pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documentos pol√≠ticos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Atualizando o PostgreSQL de 9.4 para 10.3 com o pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pgrepup - atualize o PostgreSQL usando replica√ß√£o l√≥gica</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pgrepup - PostgreSQL REPlicate e UPgrade</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Atualizando o PostgreSQL de 9,6 para 10 com tempo de inatividade m√≠nimo usando o pglogical</a> </li></ul><br>  Boa sorte </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt437318/">https://habr.com/ru/post/pt437318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt437308/index.html">Ciclo de aula do SDL 2.0: li√ß√£o 4 - manipula√ß√£o de eventos</a></li>
<li><a href="../pt437310/index.html">Bordas de gradiente CSS</a></li>
<li><a href="../pt437312/index.html">Implementando uma recarga quente de c√≥digo C ++ no Linux e macOS: aprofundando</a></li>
<li><a href="../pt437314/index.html">Enigma italiano: m√°quinas criptogr√°ficas OMI</a></li>
<li><a href="../pt437316/index.html">O Internet Development Institute nomeou sites que podem ser desconectados no RuNet desde 1¬∫ de fevereiro</a></li>
<li><a href="../pt437320/index.html">√çndice de desenvolvimento da esfera de m√≠dia de 2018: estagna√ß√£o da televis√£o, aumento da confian√ßa na m√≠dia informal</a></li>
<li><a href="../pt437322/index.html">O estado est√° envolvido no BigDate</a></li>
<li><a href="../pt437324/index.html">Beijo sangrento: propriedades de vasorelaxa√ß√£o da saliva de morcegos vampiros</a></li>
<li><a href="../pt437326/index.html">Sobre a quest√£o da multiplica√ß√£o, extra√ß√£o de raiz quadrada, substitui√ß√£o de importa√ß√µes e a empresa Milander</a></li>
<li><a href="../pt437330/index.html">devleads - fale sobre burnout</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>