<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧖🏿 🎬 💛 Client de test TON (Telegram Open Network) et le nouveau langage Fift pour les contrats intelligents 🌈 👩‍👧‍👦 👨🏾‍🤝‍👨🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a plus d'un an, il est devenu connu des projets du messager Telegram de publier son propre réseau décentralisé Telegram Open Network . Puis un vo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Client de test TON (Telegram Open Network) et le nouveau langage Fift pour les contrats intelligents</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453714/"><p>  Il y a plus d'un an, il est devenu connu des projets du messager Telegram de publier son propre réseau décentralisé <strong>Telegram Open Network</strong> .  Puis un volumineux document technique est devenu disponible, qui, vraisemblablement, a été écrit par Nikolai Durov et décrit la structure du futur réseau.  Pour ceux qui ont raté, je vous recommande de vous familiariser avec mon récit de ce document ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 2</a> ; la troisième partie, hélas, continue à accumuler de la poussière dans les ébauches). </p><br><p> Depuis lors, il n'y a eu aucune nouvelle significative sur l'état de développement de TON, jusqu'à il y a quelques jours (dans l'un des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">canaux non officiels</a> ) un lien vers la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://test.ton.org/download.html est apparu</a> , où sont: </p><br><p>  ◦ <a href="">ton-test-liteclient-full.tar.xz</a> - code source du client léger pour le réseau de test TON; <br>  ◦ <a href="">ton-lite-client-test1.config.json</a> - fichier de configuration pour la connexion à un réseau de test; <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">README</a> - informations sur la construction et le démarrage du client; <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HOWTO</a> - instructions étape par étape sur la création d'un contrat intelligent à l'aide d'un client; <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ton.pdf</a> - document mis à jour (daté du 2 mars 2019) avec un aperçu technique du réseau TON; <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tvm.pdf</a> - description technique de TVM (TON Virtual Machine, TON virtual machine); <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tblkch.pdf</a> - description technique de la blockchain TON; <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fiftbase.pdf</a> - une description du nouveau langage Fift, conçu pour créer des contrats intelligents dans TON. </p><br><p>  Je le répète, il n'y a pas eu de confirmation officielle de la page et de tous ces documents par le Télégramme, mais le volume de ces documents les rend tout à fait plausibles.  Exécutez un client publié <strong>à vos propres risques</strong> . </p><a name="habracut"></a><br><h2 id="sborka-testovogo-klienta">  Tester la génération du client </h2><br><p>  Tout d'abord, essayons de créer et d'exécuter un client de test - heureusement, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">README</a> décrit ce processus simple en détail.  Je vais le faire en utilisant l'exemple macOS 10.14.5, je ne peux pas garantir le succès de l'assemblage sur d'autres systèmes. </p><br><ol><li><p>  Téléchargez et décompressez l' <a href="">archive avec les codes sources</a> .  Il est important de télécharger la dernière version, car la compatibilité descendante n'est pas garantie à ce stade. </p><br></li><li><p>  Nous nous assurons que les dernières versions de make, cmake (version 3.0.2 ou supérieure), OpenSSL (y compris les fichiers d'en-tête C), g ++ ou clang sont installées sur le système.  Je n'ai pas eu à réinstaller quoi que ce soit, tout s'est rassemblé tout de suite. </p><br></li><li><p> Supposons que les sources soient décompressées dans le dossier <code>~/lite-client</code> .  Séparément, nous créons un dossier vide pour le projet assemblé (par exemple, <code>~/liteclient-build</code> ), et à partir de lui ( <code>cd ~/liteclient-build</code> ) nous <code>cd ~/liteclient-build</code> commandes: </p><br><pre> <code class="bash hljs">cmake ~/lite-client cmake --build . --target <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/sr/lx/j8/srlxj8au48yus3uuddlpenvika0.png" alt="Construction client réussie"><br><br>  Pour construire l'interpréteur de langue Fift pour les contrats intelligents (voir ci-dessous), nous appelons également </p><br><pre> <code class="plaintext hljs">cmake --build . --target fift</code> </pre> <br></li><li><p>  Téléchargez le <a href="">fichier de configuration</a> actuel pour vous connecter au réseau de test et placez-le dans le dossier avec le client assemblé. </p><br></li><li><p>  <strong>Terminé</strong> , vous pouvez démarrer le client: </p><br><pre> <code class="plaintext hljs">./test-lite-client -C ton-lite-client-test1.config.json</code> </pre> <br></li></ol><br><p>  Si tout est fait correctement, vous devriez voir quelque chose comme ceci: </p><br><p><img src="https://habrastorage.org/webt/gl/gg/d3/glggd35dzg4vwogf9woibu43zrk.png" alt="Client de lancement"></p><br><p>  Comme vous pouvez le voir, il existe peu de commandes disponibles: </p><br><p>  ◦ <strong><code>help</code></strong> - affiche cette liste de commandes; <br>  ◦ <strong><code>quit</code></strong> - quitter; <br>  ◦ <strong><code>time</code></strong> - affiche l'heure actuelle sur le serveur; <br>  ◦ <strong><code>status</code></strong> - affiche l'état de la connexion et de la base de données locale; <br>  ◦ <strong><code>last</code></strong> - met à jour l'état de la blockchain (charge le dernier bloc).  Il est important d'exécuter cette commande avant toute demande afin d'être sûr que vous voyez exactement l'état actuel du réseau. <br>  ◦ <strong><code>sendfile</code></strong> <code>&lt;filename&gt;</code> - téléchargez un fichier local sur le réseau TON.  Il s'agit de l'interaction avec le réseau - y compris, par exemple, la création de nouveaux contrats intelligents et les demandes de transfert de fonds entre les comptes; <br>  ◦ <strong><code>getaccount</code></strong> <code>&lt;address&gt;</code> - affiche l'état actuel du compte (au moment où la <strong><code>last</code></strong> commande a été exécutée) avec l'adresse spécifiée; <br>  ◦ <strong><code>privkey</code></strong> <code>&lt;filename&gt;</code> - charge la clé privée à partir du fichier local. </p><br><p>  Si au lancement du client, vous lui passez le dossier en utilisant l'option <code>-D</code> , il y ajoutera le dernier bloc de la chaîne principale: </p><br><pre> <code class="bash hljs">./<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client -C ton-lite-client-test1.config.json -D ~/ton-db-dir</code> </pre> <br><p>  Maintenant, nous pouvons passer à des choses plus intéressantes - apprendre la langue Fift, essayer de compiler un contrat intelligent (par exemple, créer un portefeuille de test), le télécharger sur le réseau et essayer de transférer des fonds entre les comptes. </p><br><h2 id="yazyk-fift">  Cinquante langue </h2><br><p>  À partir du document <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fiftbase.pdf,</a> vous pouvez découvrir que pour créer des contrats intelligents, l'équipe Telegram a créé un nouveau langage de pile <strong>Fift</strong> (apparemment, à partir du <em>cinquième</em> chiffre, par analogie avec Forth - un langage avec lequel Fift a beaucoup en commun). </p><br><p>  Le document est assez volumineux, avec 87 pages, et je ne reviendrai pas sur son contenu en détail dans le cadre de cet article (du moins parce que moi-même je n'ai pas fini de le lire :).  Je m'attarderai sur les points principaux et donnerai quelques exemples de code dans ce langage. </p><br><p>  Au niveau de base, la syntaxe de Fift est assez simple: son code est constitué de <em>mots</em> , généralement séparés par des espaces ou des sauts de ligne (cas particulier: certains mots ne nécessitent pas de délimiteur après eux).  Tout <em>mot</em> est une séquence de caractères sensible à la casse qui correspond à une certaine <em>définition</em> (grosso modo, ce que l'interprète doit faire lorsqu'il rencontre ce mot).  S'il n'y a pas de définition du mot, l'interpréteur essaie de l'analyser comme un nombre et de le mettre sur la pile.  Soit dit en passant, les nombres ici sont - tout à coup - des entiers de 257 bits, mais il n'y a aucun nombre fractionnaire - plus précisément, ils se transforment immédiatement en une paire d'entiers, formant le numérateur et le dénominateur d'une fraction rationnelle. </p><br><p>  Les mots interagissent généralement avec les significations en haut de la pile.  Un type distinct de mots - <em>préfixe</em> - n'utilise pas la pile, mais les caractères suivants du fichier source.  Par exemple, les littéraux de chaîne sont implémentés de cette manière - le caractère "guillemet" ( <code>"</code> ) est un mot préfixe qui recherche le guillemet suivant (fermant) et place la chaîne entre eux sur la pile. Une seule ligne ( <code>//</code> ) et plusieurs lignes ( <code>/*</code> ) se comportent de la même manière. commentaires. </p><br><p>  Sur cela, presque toute la structure interne de la langue se termine.  Tout le reste (y compris les structures de contrôle) est défini comme des mots (soit internes, tels que les opérations arithmétiques et la définition de nouveaux mots; soit définis dans la "bibliothèque standard" <code>Fift.fif</code> , qui se trouve dans le <code>crypto/fift</code> de la source). </p><br><p>  Un exemple simple d'un programme Fift: </p><br><pre> <code class="plaintext hljs">{ dup =: x dup * =: y } : setxy 3 setxy x . y . xy + . 7 setxy x . y . xy + .</code> </pre> <br><p>  La première ligne définit le nouveau mot <code>setxy</code> (notez le préfixe <code>{</code> , qui crée le bloc avant la fermeture <code>}</code> et le préfixe <code>setxy</code> qui définit en fait le mot).  <code>setxy</code> prend un nombre en haut de la pile, le définit (ou le redéfinit) comme une <em>constante</em> globale <code>x</code> , et le carré de ce nombre comme une constante <code>y</code> (étant donné que les valeurs des constantes peuvent être redéfinies, je préfère les appeler des variables, mais je respecte le nom dans la langue). </p><br><p>  Dans les deux lignes suivantes, un nombre est placé sur la pile, <code>setxy</code> est <code>setxy</code> , puis les valeurs des constantes <code>x</code> , <code>y</code> sont affichées (le mot est utilisé pour la sortie <code>.</code> ), Les deux constantes sont placées sur la pile, additionnées et le résultat est également affiché.  En conséquence, nous verrons: </p><br><pre> <code class="plaintext hljs">3 9 12 ok 7 49 56 ok</code> </pre> <br><p>  (L'interpréteur imprime la ligne «ok» lorsqu'il a fini de traiter la ligne actuelle en mode de saisie interactive) </p><br><p>  Eh bien, un exemple de code complet: </p><br><pre> <code class="plaintext hljs">"Asm.fif" include -1 constant wc // create a wallet in workchain -1 (masterchain) // Create new simple wallet &lt;{ SETCP0 DUP IFNOTRET INC 32 THROWIF // return if recv_internal, fail unless recv_external 512 INT LDSLICEX DUP 32 PLDU // sign cs cnt c4 PUSHCTR CTOS 32 LDU 256 LDU ENDS // sign cs cnt cnt' pubk s1 s2 XCPU // sign cs cnt pubk cnt' cnt EQUAL 33 THROWIFNOT // ( seqno mismatch? ) s2 PUSH HASHSU // sign cs cnt pubk hash s0 s4 s4 XC2PU // pubk cs cnt hash sign pubk CHKSIGNU // pubk cs cnt ? 34 THROWIFNOT // signature mismatch ACCEPT SWAP 32 LDU NIP DUP SREFS IF:&lt;{ 8 LDU LDREF // pubk cnt mode msg cs s0 s2 XCHG SENDRAWMSG // pubk cnt cs ; ( message sent ) }&gt; ENDS INC NEWC 32 STU 256 STU ENDC c4 POPCTR }&gt;c // code &lt;b 0 32 u, newkeypair swap dup constant wallet_pk "new-wallet.pk" B&gt;file B, b&gt; // data // no libraries &lt;bb{00110} s, rot ref, swap ref, b&gt; // create StateInit dup ."StateInit: " &lt;s csr. cr dup hash dup constant wallet_addr ."new wallet address = " wc . .": " dup x. cr wc over 7 smca&gt;$ type cr 256 u&gt;B "new-wallet.addr" B&gt;file &lt;b 0 32 u, b&gt; dup ."signing message: " &lt;s csr. cr dup hash wallet_pk ed25519_sign_uint rot &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, b{000010} s, swap &lt;ss, b{0} s, swap B, swap &lt;ss, b&gt; dup ."External message for initialization is " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "new-wallet-query.boc" tuck B&gt;file ."(Saved to file " type .")" cr</code> </pre> <br><p>  Ce fichier d'apparence effrayante est conçu pour créer un contrat intelligent - il sera placé dans le <code>new-wallet-query.boc</code> après exécution.  Veuillez noter qu'ici est utilisé un autre langage d'assemblage pour la machine virtuelle TON (je ne m'y attarderai pas en détail), dont les instructions seront placées sur la blockchain. </p><br><p>  Ainsi, l'assembleur pour TVM est écrit en Fift - les sources de cet assembleur sont dans le fichier <code>crypto/fift/Asm.fif</code> et sont connectées au début du morceau de code ci-dessus. </p><br><p>  Que puis-je dire, apparemment, Nikolai Durov aime juste créer de nouveaux langages de programmation :) </p><br><h2 id="sozdanie-smart-kontrakta-i-vzaimodeystvie-s-ton">  Créer un contrat intelligent et interagir avec TON </h2><br><p>  Supposons donc que nous ayons réuni un client TON et un interprète Fift, comme décrit ci-dessus, et que nous nous soyons familiarisés avec la langue.  Comment créer un contrat intelligent maintenant?  Ceci est décrit dans le fichier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HOWTO</a> joint à la source. </p><br><h3 id="akkaunty-v-ton">  Comptes TON </h3><br><p>  Comme je l'ai décrit dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la revue TON</a> , ce réseau contient plus d'une blockchain - il y a une commune, la soi-disant  «Chaîne principale», ainsi qu'un nombre arbitraire de «chaînes de travail» supplémentaires identifiées par un nombre de 32 bits.  La chaîne maître a un identifiant de -1, en plus de cela, une chaîne de travail «de base» avec l'identifiant 0 peut également être utilisée Chaque chaîne de travail peut avoir sa propre configuration.  En interne, chaque groupe de travail est divisé en chaînes de partage, mais c'est déjà un détail de l'implémentation, qui ne doit pas être gardé à l'esprit. </p><br><p>  De nombreux comptes sont stockés dans une même chaîne de travail, qui ont leurs propres identifiants account_id.  Pour la chaîne principale et la chaîne de travail zéro, ils ont une longueur de 256 bits.  Ainsi, l'identifiant de compte est écrit, par exemple, comme ceci: </p><br><pre> <code class="plaintext hljs">-1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Il s'agit d'un format «brut»: d'abord, l'identifiant de la chaîne de travail, puis les deux points et l'identifiant du compte en notation hexadécimale. </p><br><p>  De plus, il existe un format raccourci - le numéro de la chaîne de travail et l'adresse du compte sont codés sous forme binaire, une somme de contrôle leur est ajoutée et tout cela est codé en Base64: </p><br><pre> <code class="plaintext hljs">Ef+BVndbeTJeXWLnQtm5bDC2UVpc0vH2TF2ksZPAPwcODSkb</code> </pre> <br><p>  Connaissant ce format d'enregistrement, nous pouvons demander l'état actuel d'un compte via un client de test en utilisant la commande </p><br><pre> <code class="plaintext hljs">getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  Nous obtenons une réponse comme celle-ci: </p><br><pre> <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> -client.cpp: <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> pour -1: 8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D par rapport aux blocs (-1,8000000000000000,72355): F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296: 1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F et <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  Nous voyons la structure qui est stockée dans la DHT de la chaîne de travail spécifiée.  Par exemple, dans le champ <code>storage.balance</code> est le solde du compte courant, dans <code>storage.state.code</code> est le code de contrat intelligent et dans <code>storage.state.data</code> est ses données actuelles.  Notez que le magasin de données TON - Cellule, cellules - est un arbre, chaque cellule peut avoir ses propres données, ainsi que des cellules enfants.  Ceci est indiqué comme une indentation dans les dernières lignes. </p><br><h3 id="sborka-smart-kontrakta">  Assemblage de contrat intelligent </h3><br><p>  Créons maintenant une telle structure nous-mêmes (elle s'appelle BOC - <em>sac de cellules</em> ) en utilisant le langage Fift.  Heureusement, vous n'aurez pas à rédiger un contrat intelligent vous-même - dans le dossier <code>crypto/block</code> de l'archive source, il y a un fichier <code>new-wallet.fif</code> qui nous aidera à créer un nouveau portefeuille.  Copiez-le dans le dossier avec le client assemblé ( <code>~/liteclient-build</code> , si vous avez <code>~/liteclient-build</code> instructions ci-dessus).  J'ai cité son contenu ci-dessus comme un exemple de code sur Fift. </p><br><p>  Nous exécutons ce fichier comme suit: </p><br><pre> <code class="plaintext hljs">./crypto/fift -I"&lt;source-directory&gt;/crypto/fift" new-wallet.fif</code> </pre> <br><p>  Ici, <code>&lt;source-directory&gt;</code> doit être remplacé par le chemin d'accès aux sources décompressées (le symbole "~" ne peut pas être utilisé ici, malheureusement, vous avez besoin du chemin complet).  Au lieu d'utiliser le <code>-I</code> vous pouvez définir la <code>FIFTPATH</code> environnement <code>FIFTPATH</code> et y mettre ce chemin. </p><br><p>  Depuis que nous avons lancé Fift avec le nom de fichier <code>new-wallet.fif</code> , il l'exécutera et se terminera.  Si vous omettez le nom du fichier, vous pouvez jouer avec l'interpréteur en mode interactif. </p><br><p>  Après l'exécution, quelque chose comme ceci devrait s'afficher dans la console: </p><br><pre> <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> l' <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> } <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> </pre> <br><p>  Cela signifie que le portefeuille avec l'identificateur <code>-1:4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> (ou, qui est la même chose, <code>0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ</code> )  Le code correspondant <code>new-wallet-query.boc</code> dans le <code>new-wallet-query.boc</code> , son adresse dans <code>new-wallet.addr</code> et la clé privée dans <code>new-wallet.pk</code> (attention - le redémarrage du script écrasera ces fichiers). </p><br><p>  Bien sûr, le réseau TON ne connaît pas encore ce portefeuille, il n'est stocké que sous forme de ces fichiers.  Vous devez maintenant le télécharger sur le réseau.  Certes, le problème est que pour créer un contrat intelligent, vous devez payer une commission et le solde de votre compte est toujours nul. </p><br><p>  En mode de travail, ce problème sera résolu en achetant des grammes sur la bourse (ou en effectuant un transfert à partir d'un autre portefeuille).  Eh bien, dans le mode de test actuel, un contrat intelligent spécial a été institué, à partir duquel vous pouvez demander jusqu'à 20 grammes comme ça. </p><br><h3 id="formirovanie-zaprosa-k-chuzhomu-smart-kontraktu">  Formation d'une demande au contrat intelligent de quelqu'un d'autre </h3><br><p>  Demandez un contrat intelligent, distribuant des grammes à gauche et à droite, faites-le.  Dans le même dossier <code>crypto/block</code> , nous trouvons le fichier <code>testgiver.fif</code> : </p><br><pre> <code class="plaintext hljs">// "testgiver.addr" file&gt;B 256 B&gt;u@ 0x8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d dup constant wallet_addr ."Test giver address = " x. cr 0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 constant dest_addr -1 constant wc 0x00000011 constant seqno 1000000000 constant Gram { Gram swap */ } : Gram*/ 6.666 Gram*/ constant amount // bx --&gt; b' ( serializes a Gram amount ) { -1 { 1+ 2dup 8 * ufits } until rot over 4 u, -rot 8 * u, } : Gram, // create a message (NB: 01b00.., b = bounce) &lt;bb{010000100} s, wc 8 i, dest_addr 256 u, amount Gram, 0 9 64 32 + + 1+ 1+ u, "GIFT" $, b&gt; &lt;b seqno 32 u, 1 8 u, swap ref, b&gt; dup ."enveloping message: " &lt;s csr. cr &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, 0 Gram, b{00} s, swap &lt;ss, b&gt; dup ."resulting external message: " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "wallet-query.boc" B&gt;file</code> </pre> <br><p>  Nous l'enregistrons également dans le dossier avec le client assemblé, mais fixons la cinquième ligne - avant la ligne " <code>constant dest_addr</code> ".  Remplacez-le par l'adresse du portefeuille que vous avez créé auparavant (complet, non abrégé).  "-1:" vous n'avez pas besoin d'écrire au début, mettez plutôt "0x" au début. </p><br><p>  Vous pouvez également modifier la ligne <code>6.666 Gram*/ constant amount</code> - c'est la quantité en grammes que vous demandez (pas plus de 20).  Même si vous spécifiez un entier, laissez le point décimal. </p><br><p>  Enfin, vous devez corriger la ligne <code>0x00000011 constant seqno</code> .  Le premier numéro ici est le numéro de séquence actuel, qui est stocké dans le compte émettant les grammes.  D'où l'obtenir?  Comme mentionné ci-dessus, démarrez le client et exécutez: </p><br><pre> <code class="plaintext hljs">last getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p>  À la toute fin dans les données du contrat intelligent sera </p><br><pre> <code class="plaintext hljs">... x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p>  Le numéro 0000000D (vous en aurez plus) est le numéro de séquence, qui doit être substitué dans <code>testgiver.fif</code> . </p><br><p>  Voilà, enregistrez le fichier et exécutez ( <code>./crypto/fift testgiver.fif</code> ).  La sortie sera le <code>wallet-query.boc</code> .  C'est le <em>message</em> formé au contrat intelligent de quelqu'un d'autre - la demande est «transférer autant de grammes vers tel ou tel compte». </p><br><p>  En utilisant le client, nous le téléchargeons sur le réseau: </p><br><pre> <code class="plaintext hljs">&gt; sendfile wallet-query.boc [ 1][t 1][1558747399.456575155][test-lite-client.cpp:577][!testnode] sending query from file wallet-query.boc [ 3][t 2][1558747399.500236034][test-lite-client.cpp:587][!query] external message status is 1</code> </pre> <br><p>  Si nous appelons maintenant en <code>last</code> , puis demandons à nouveau le statut du compte à partir duquel nous avons demandé des grammes, nous devrions voir que son numéro de séquence a augmenté de un - cela signifie qu'il a envoyé de l'argent sur notre compte. </p><br><p>  La dernière étape reste - nous chargeons le code de notre portefeuille (son solde a déjà été réapprovisionné, mais sans le code de contrat intelligent nous ne pourrons pas le gérer).  <code>sendfile new-wallet-query.boc</code> - et c'est tout, vous avez votre propre portefeuille dans le réseau TON (mais pour l'instant seulement un test). </p><br><h3 id="sozdanie-ishodyaschih-tranzakciy">  Créer des transactions sortantes </h3><br><p>  Pour transférer de l'argent du solde du compte créé, il existe un <code>crypto/block/wallet.fif</code> , qui doit également être placé dans le dossier avec le client collecté. </p><br><p>  Comme pour les étapes précédentes, vous devez corriger le montant que vous transférez, l'adresse du destinataire (dest_addr) et le seqno de votre portefeuille (il est de 1 après l'initialisation du portefeuille et augmente de 1 après chaque transaction sortante - vous pouvez le voir en demandant le statut de votre compte) .  Pour les tests, vous pouvez utiliser, par exemple, mon portefeuille - <code>0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> . </p><br><p>  Lorsque vous exécutez ( <code>./crypto/fift wallet.fif</code> ), le script prendra l'adresse de votre portefeuille (d'où vous le transférez) et sa clé privée à partir des fichiers <code>new-wallet.addr</code> et <code>new-wallet.pk</code> , et <code>new-wallet.pk</code> le message reçu dans <code>new-wallet-query.boc</code> . </p><br><p>  Comme précédemment, pour exécuter directement la transaction, nous appelons <code>sendfile new-wallet-query.boc</code> dans le client.  Après cela, n'oubliez pas de mettre à jour l'état de la blockchain ( <code>last</code> ) et vérifiez que l'équilibre et le seqno de notre portefeuille ont changé ( <code>getaccount &lt;account_id&gt;</code> ). </p><br><p><img src="https://habrastorage.org/webt/fp/d1/is/fpd1is8dlh4_iz9rdbakflyeq5s.png" alt="Description du compte"></p><br><p>  C'est tout, maintenant nous pouvons créer des contrats intelligents dans TON et leur envoyer des demandes.  Comme vous pouvez le voir, la fonctionnalité actuelle est déjà suffisante pour, par exemple, créer un portefeuille plus convivial avec une interface graphique (cependant, il est prévu qu'elle deviendra disponible dans le cadre du messager). </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453714/">https://habr.com/ru/post/fr453714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453700/index.html">Leçons sur SDL 2: Leçon 1 - Bonjour, SDL 2</a></li>
<li><a href="../fr453706/index.html">Comment j'ai réussi l'examen de certification Google Cloud Professional Data Engineer</a></li>
<li><a href="../fr453708/index.html">Système d'exploitation en temps réel AQUA RTOS pour MK AVR dans l'environnement BASCOM AVR</a></li>
<li><a href="../fr453710/index.html">Pratique de développement dans les grands projets: mitap SberPractice iOS # 1</a></li>
<li><a href="../fr453712/index.html">Comment eBay a fait un scanner de codes-barres sur WebAssembly</a></li>
<li><a href="../fr453716/index.html">Coworking à la campagne pour les informaticiens familiaux - y a-t-il quelqu'un?</a></li>
<li><a href="../fr453720/index.html">Subtilités d'expressions lambda en C #</a></li>
<li><a href="../fr453722/index.html">À propos de la recherche de processus non stationnaires</a></li>
<li><a href="../fr453728/index.html">Bataille des hyperstars</a></li>
<li><a href="../fr453730/index.html">Dentisterie moderne: implantation dentaire simultanée et extension de l'os de la mâchoire à travers les yeux du directeur technique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>