<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>  猬锔 Escribimos transformadores personalizados AST en TypeScript   </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El equipo de TestMace est谩 de vuelta contigo. Esta vez estamos publicando una traducci贸n de un art铆culo sobre conversi贸n de c贸digo TypeScript usando e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escribimos transformadores personalizados AST en TypeScript</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457770/"><p>  <em>El equipo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TestMace est谩 de</a> vuelta contigo.</em>  <em>Esta vez estamos publicando una traducci贸n de un art铆culo sobre conversi贸n de c贸digo TypeScript usando el compilador.</em>  <em>Que tengas una buena lectura!</em> </p><br><h1 id="vvedenie">  Introduccion </h1><br><p>  Esta es mi primera publicaci贸n, y en ella me gustar铆a mostrar una soluci贸n a un problema usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la API del compilador</a> TypeScript.  Para encontrar esta soluci贸n, profundic茅 en numerosos blogs durante mucho tiempo y diger铆 las respuestas en StackOverflow, por lo que para protegerte del mismo destino, compartir茅 todo lo que aprend铆 sobre una caja de herramientas tan poderosa pero mal documentada. </p><a name="habracut"></a><br><h1 id="klyuchevye-ponyatiya">  Conceptos clave </h1><br><p>  Los conceptos b谩sicos de las API del compilador TypeScript (terminolog铆a del analizador, API de transformaci贸n, arquitectura en capas), 谩rbol de sintaxis abstracta (AST), patr贸n de dise帽o de visitante, generaci贸n de c贸digo. </p><br><h1 id="nebolshaya-rekomendaciya">  Peque帽a recomendaci贸n </h1><br><p>  Si es la primera vez que escuchas sobre el concepto AST, te recomiendo leer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este art铆culo</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@Vaidehi Joshi</a> .  Su serie completa de art铆culos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">basecs</a> sali贸 genial, te encantar谩. </p><br><h1 id="opisanie-zadachi">  Descripci贸n de la tarea </h1><br><p>  En <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Avero,</a> usamos GraphQL y nos gustar铆a agregar seguridad de tipos en los resolvers.  Una vez me encontr茅 con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">graphqlgen</a> , y con 茅l pude resolver muchos problemas relacionados con el concepto de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">modelos</a> en GraphQL.  No profundizar茅 en este tema aqu铆; para esto planeo escribir un art铆culo separado.  Brevemente, los modelos describen los valores de retorno de los resolvers, y en graphqlgen estos modelos se comunican con las interfaces a trav茅s de un tipo de configuraci贸n (YAML o TypeScript con declaraci贸n de tipo). </p><br><p>  Durante la operaci贸n, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejecutamos</a> microservicios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gRPC</a> , y GQL en su mayor parte sirve como fachada.  Ya hemos publicado interfaces TypeScript que est谩n de acuerdo con los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">contratos proto</a> , y quer铆a usar estos tipos como modelos, pero encontr茅 algunos problemas causados por el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">soporte para exportar tipos</a> y en la forma en que se implement贸 la descripci贸n de nuestras interfaces (acumulando espacios de nombres, una gran cantidad de enlaces). </p><br><p>  De acuerdo con las reglas de buen gusto para trabajar con c贸digo fuente abierto, mi primer paso fue refinar lo que ya se ha hecho en el repositorio de graphqlgen y, por lo tanto, hacer mi contribuci贸n significativa.  Para implementar el mecanismo de introspecci贸n, graphqlgen utiliza el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">analizador @ babel / parser</a> para leer un archivo y recopilar informaci贸n sobre nombres y declaraciones de interfaz (campos de interfaz). </p><br><p>  Cada vez que necesito hacer algo con AST, primero abro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">astexplorer.net</a> y luego empiezo a actuar.  Esta herramienta le permite analizar el AST creado por varios analizadores, incluidos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">babel</a> / parser y el compilador TypeScript.  Con astexplorer.net, puede visualizar las estructuras de datos con las que tiene que trabajar y familiarizarse con los tipos de nodos AST de cada analizador. </p><br><p>  Eche un vistazo al ejemplo del archivo de datos de origen y el AST creado sobre esta base utilizando babel-parser: </p><br><div class="spoiler">  <b class="spoiler_title">ejemplo.ts</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { protos } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'my_company_protos'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> type User = protos.user.User;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">ast.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Program"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">36</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"comments"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"sourceType"</span></span>: <span class="hljs-string"><span class="hljs-string">"module"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ImportDeclaration"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"specifiers"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ImportSpecifier"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"imported"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Identifier"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"identifierName"</span></span>: <span class="hljs-string"><span class="hljs-string">"protos"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"protos"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"Identifier"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"importKind"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Identifier"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">9</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"identifierName"</span></span>: <span class="hljs-string"><span class="hljs-string">"protos"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"protos"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"Identifier"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"ImportSpecifier"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"importKind"</span></span>: <span class="hljs-string"><span class="hljs-string">"value"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Literal"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">23</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"extra"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"rawValue"</span></span>: <span class="hljs-string"><span class="hljs-string">"my_company_protos"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"raw"</span></span>: <span class="hljs-string"><span class="hljs-string">"'my_company_protos'"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"my_company_protos"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"StringLiteral"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"raw"</span></span>: <span class="hljs-string"><span class="hljs-string">"'my_company_protos'"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"ImportDeclaration"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ExportNamedDeclaration"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">44</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">36</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"specifiers"</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exportKind"</span></span>: <span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"declaration"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"TypeAlias"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">7</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">36</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Identifier"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"identifierName"</span></span>: <span class="hljs-string"><span class="hljs-string">"User"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"User"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">56</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"Identifier"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"typeParameters"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"right"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"GenericTypeAnnotation"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">79</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">35</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"typeParameters"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"QualifiedTypeIdentifier"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">79</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">35</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"qualification"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"QualifiedTypeIdentifier"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">74</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">30</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"qualification"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Identifier"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: <span class="hljs-number"><span class="hljs-number">69</span></span>, <span class="hljs-attr"><span class="hljs-attr">"loc"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"end"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"column"</span></span>: <span class="hljs-number"><span class="hljs-number">25</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"identifierName"</span></span>: <span class="hljs-string"><span class="hljs-string">"protos"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"protos"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-number"><span class="hljs-number">69</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"Identifier"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-number"><span class="hljs-number">74</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"QualifiedTypeIdentifier"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-number"><span class="hljs-number">79</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"QualifiedTypeIdentifier"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">63</span></span>, <span class="hljs-number"><span class="hljs-number">79</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"GenericTypeAnnotation"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">51</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"TypeAlias"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"range"</span></span>: [ <span class="hljs-number"><span class="hljs-number">44</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"_babelType"</span></span>: <span class="hljs-string"><span class="hljs-string">"ExportNamedDeclaration"</span></span> } ] }</code> </pre> </div></div><br><p>  La ra铆z del 谩rbol (un nodo del tipo <strong>Programa</strong> ) contiene dos operadores en su cuerpo: <strong>ImportDeclaration</strong> y <strong>ExportNamedDeclaration</strong> . </p><br><p>  En <strong>ImportDeclaration,</strong> estamos particularmente interesados en dos propiedades: <strong>fuente</strong> y <strong>especificadores</strong> , que contienen informaci贸n sobre el texto fuente.  Por ejemplo, en nuestro caso, el valor de la fuente es igual a <em>my_company_protos</em> .  Es imposible entender por este valor si se trata de una ruta relativa a un archivo o un enlace a un m贸dulo externo.  Esto es exactamente lo que hace el analizador. </p><br><p>  Del mismo modo, la informaci贸n de origen est谩 contenida en <strong>ExportNamedDeclaration</strong> .  Los espacios de nombres solo complican esta estructura al agregarle anidamiento arbitrario, lo que resulta en m谩s y m谩s <strong>QualifiedTypeIdentifiers</strong> .  Esta es otra tarea que tenemos que resolver en el marco del enfoque elegido con el analizador. </p><br><p>  隆Pero a煤n no he llegado a la resoluci贸n de tipos de importaciones!  Dado que el analizador y el AST proporcionan de forma predeterminada una cantidad limitada de informaci贸n sobre el texto fuente, para agregar esta informaci贸n al 谩rbol final, es necesario analizar todos los archivos importados.  隆Pero cada archivo puede tener sus propias importaciones! </p><br><p>  Parece que al resolver las tareas con la ayuda del analizador, obtenemos demasiado c贸digo ... Retrocedamos y pensemos nuevamente. </p><br><p>  Las importaciones no son importantes para nosotros, as铆 como la estructura del archivo no es importante.  Queremos poder habilitar todas las propiedades del tipo <code>protos.user.User</code> e incrustarlas en lugar de utilizar referencias de importaci贸n.  驴Y d贸nde obtener la informaci贸n de tipo necesaria para crear un nuevo archivo? </p><br><h1 id="typechecker">  Typechecker </h1><br><p>  Como descubrimos que la soluci贸n con el analizador no es adecuada para obtener informaci贸n sobre los tipos de interfaces importadas, veamos el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proceso de compilaci贸n de</a> TypeScript e intentemos encontrar otra salida. </p><br><p>  Esto es lo que viene a la mente de inmediato: </p><br><blockquote>  TypeChecker es la base del sistema de tipos TypeScript, y se puede crear desde una instancia del Programa.  Es responsable de la interacci贸n de los caracteres de varios archivos entre s铆, configurando tipos de caracteres y realizando una verificaci贸n sem谩ntica (por ejemplo, detecci贸n de errores). <br>  Lo primero que hace TypeChecker es recopilar todos los caracteres de diferentes archivos de origen en una vista y luego crear una tabla de caracteres 煤nica, fusionando los mismos caracteres (por ejemplo, espacios de nombres encontrados en varios archivos diferentes). <br>  Despu茅s de inicializar el estado inicial, TypeChecker est谩 listo para proporcionar respuestas a cualquier pregunta sobre el programa.  Estas preguntas pueden incluir: <br>  驴Qu茅 s铆mbolo corresponde a este nodo? <br>  驴Qu茅 tipo de s铆mbolo es este? <br>  驴Qu茅 caracteres son visibles en esta parte del AST? <br>  驴Qu茅 firmas est谩n disponibles para declarar una funci贸n? <br>  驴Qu茅 errores se deben generar para este archivo? </blockquote><p>  <strong>隆TypeChecker</strong> es exactamente lo que necesit谩bamos!  Al tener acceso a la tabla de s铆mbolos y a la API, podemos responder las dos primeras preguntas: <em>驴Qu茅 s铆mbolo corresponde a este nodo?</em>  <em>驴Qu茅 tipo de s铆mbolo es este?</em>  隆Al fusionar todos los caracteres comunes, <strong>TypeChecker</strong> incluso podr谩 resolver el problema con la acumulaci贸n de espacios de nombres que se mencion贸 anteriormente! </p><br><p>  Entonces, 驴c贸mo llegas a esta API? </p><br><p>  Aqu铆 hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un</a> ejemplo que pude encontrar en la red.  Muestra que se puede acceder a <strong>TypeChecker</strong> a trav茅s del m茅todo de instancia del Programa.  Tiene dos m茅todos interesantes: <code>checker.getSymbolAtLocation</code> y <code>checker.getTypeOfSymbolAtLocation</code> , que se parecen mucho a lo que estamos buscando. </p><br><p>  Comencemos a trabajar en el c贸digo. </p><br><div class="spoiler">  <b class="spoiler_title">modelos.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { protos } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./my_company_protos'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> type User = protos.user.User;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">my_company_protos.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> namespace protos { <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> namespace user { <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface User { <span class="hljs-attr"><span class="hljs-attr">username</span></span>: string; info: protos.Info.User; } } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> namespace Info { <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface User { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: protos.Info.Name; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> interface Name { <span class="hljs-attr"><span class="hljs-attr">firstName</span></span>: string; lastName: string; } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">ts-alias.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ts <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"typescript"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// hardcode our input file const filePath = "./src/models.ts"; // create a program instance, which is a collection of source files // in this case we only have one source file const program = ts.createProgram([filePath], {}); // pull off the typechecker instance from our program const checker = program.getTypeChecker(); // get our models.ts source file AST const source = program.getSourceFile(filePath); // create TS printer instance which gives us utilities to pretty print our final AST const printer = ts.createPrinter(); // helper to give us Node string type given kind const syntaxToKind = (kind: ts.Node["kind"]) =&gt; { return ts.SyntaxKind[kind]; }; // visit each node in the root AST and log its kind ts.forEachChild(source, node =&gt; { console.log(syntaxToKind(node.kind)); });</span></span></code> </pre> </div></div><br><pre> <code class="bash hljs">$ ts-node ./src/ts-alias.ts prints ImportDeclaration TypeAliasDeclaration EndOfFileToken</code> </pre> <br><p>  Solo estamos interesados en declarar un alias de tipo, por lo que reescribimos el c贸digo un poco: </p><br><div class="spoiler">  <b class="spoiler_title">kind-printer.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs">ts.forEachChild(source, node =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ts.isTypeAliasDeclaration(node)) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(node.kind); } }) <span class="hljs-comment"><span class="hljs-comment">// prints TypeAliasDeclaration</span></span></code> </pre> </div></div><br><p>  TypeScript proporciona protecci贸n para cada tipo de nodo, con el que puede averiguar el tipo exacto de nodo: </p><br><p><img src="https://habrastorage.org/webt/rb/gk/oa/rbgkoakkvmpvkyiparz1wmuiohi.png"></p><br><p>  Ahora volvamos a las dos preguntas que se plantearon anteriormente: <em>驴Qu茅 s铆mbolo corresponde a este nodo?</em>  <em>驴Qu茅 tipo de s铆mbolo es este?</em> </p><br><p>  Entonces, obtuvimos los nombres ingresados por las declaraciones de la interfaz de alias de tipo al interactuar con la <strong>tabla de</strong> caracteres <strong>TypeChecker</strong> .  Aunque todav铆a estamos al comienzo del viaje, esta es una buena posici贸n de partida desde el punto de vista de la <em>introspecci贸n</em> . </p><br><div class="spoiler">  <b class="spoiler_title">checker-example.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs">ts.forEachChild(source, node =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ts.isTypeAliasDeclaration(node)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> symbol = checker.getSymbolAtLocation(node.name); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> type = checker.getDeclaredTypeOfSymbol(symbol); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> properties = checker.getPropertiesOfType(type); properties.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">declaration</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(declaration.name); <span class="hljs-comment"><span class="hljs-comment">// prints username, info }); } });</span></span></code> </pre> </div></div><br><p>  Ahora pensemos en la <em>generaci贸n de c贸digo</em> . </p><br><h1 id="api-transformacii">  API de transformaci贸n </h1><br><p>  Como se indic贸 anteriormente, nuestro objetivo es analizar e introspectar el archivo fuente de TypeScript y crear un nuevo archivo.  La conversi贸n <em>AST -&gt; AST se</em> usa con tanta frecuencia que el equipo de TypeScript incluso pens贸 en una API para crear <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">transformadores personalizados</a> . </p><br><p>  Antes de pasar a la tarea principal, intentaremos crear un transformador simple.  Un agradecimiento especial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">a James Garbutt</a> por la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">plantilla</a> original para 茅l. </p><br><p>  Hagamos que el transformador cambie los literales num茅ricos a los de cadena. </p><br><div class="spoiler">  <b class="spoiler_title">number-transformer.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> source = <span class="hljs-string"><span class="hljs-string">` const two = 2; const four = 4; `</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numberTransformer</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extends</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ts</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Node</span></span></span><span class="hljs-function">&gt;(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>): </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ts</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TransformerFactory</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> visit: ts.Visitor = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ts.isNumericLiteral(node)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ts.createStringLiteral(node.text); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ts.visitEachChild(node, child =&gt; visit(child), context); }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node</span></span></span><span class="hljs-function"> =&gt;</span></span> ts.visitNode(node, visit); }; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = ts.transpileModule(source, { <span class="hljs-attr"><span class="hljs-attr">compilerOptions</span></span>: { <span class="hljs-attr"><span class="hljs-attr">module</span></span>: ts.ModuleKind.CommonJS }, <span class="hljs-attr"><span class="hljs-attr">transformers</span></span>: { <span class="hljs-attr"><span class="hljs-attr">before</span></span>: [numberTransformer()] } }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(result.outputText); <span class="hljs-comment"><span class="hljs-comment">/* var two = "2"; var four = "4";</span></span></code> </pre></div></div><br><p>  La parte m谩s importante son las <code>VisitorResult</code> <code>Visitor</code> y <code>VisitorResult</code> : </p><br><pre> <code class="javascript hljs">type Visitor = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node: Node</span></span></span><span class="hljs-function">) =&gt;</span></span> VisitResult&lt;Node&gt;; type VisitResult&lt;T extends Node&gt; = T | T[] | <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>;</code> </pre> <br><p>  El objetivo principal al crear un transformador es escribir <strong>Visitor</strong> .  L贸gicamente, es necesario implementar un recorrido recursivo de cada nodo AST y devolver un resultado VisitResult (uno, varios o cero nodos AST).  Puede configurar el inversor para que solo los nodos seleccionados respondan al cambio. </p><br><div class="spoiler">  <b class="spoiler_title">input-output.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// input export namespace protos { // ModuleDeclaration export namespace user { // ModuleDeclaration // Module Block export interface User { // InterfaceDeclaration username: string; // username: string is PropertySignature info: protos.Info.User; // TypeReference } } export namespace Info { export interface User { name: protos.Info.Name; // TypeReference } export interface Name { firstName: string; lastName: string; } } } // this line is a TypeAliasDeclaration export type User = protos.user.User; // protos.user.User is a TypeReference // output export interface User { username: string; info: { // info: { .. } is a TypeLiteral name: { // name: { .. } is a TypeLiteral firstName: string; lastName: string; } } }</span></span></code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu铆</a> puede ver con qu茅 nodos trabajaremos. </p><br><p>  El visitante debe realizar dos acciones principales: </p><br><ol><li>  Reemplazo de <strong>declaraciones de tipo Alias</strong> con <strong>declaraciones</strong> de <strong>interfaz</strong> </li><li>  Conversi贸n de <strong>TypeReferences</strong> a <strong>TypeLiterals</strong> </li></ol><br><h1 id="reshenie">  Soluci贸n </h1><br><p>  As铆 es como se ve el c贸digo de visitante: </p><br><div class="spoiler">  <b class="spoiler_title">aliasTransformer.ts</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'path'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ts <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'typescript'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'lodash'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> fs <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'fs'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> filePath = path.resolve(_.first(process.argv.slice(<span class="hljs-number"><span class="hljs-number">2</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> program = ts.createProgram([filePath], {}); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> checker = program.getTypeChecker(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> source = program.getSourceFile(filePath); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> printer = ts.createPrinter(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> typeAliasToInterfaceTransformer: ts.TransformerFactory&lt;ts.SourceFile&gt; = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> visit: ts.Visitor = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">node</span></span></span><span class="hljs-function"> =&gt;</span></span> { node = ts.visitEachChild(node, visit, context); <span class="hljs-comment"><span class="hljs-comment">/* Convert type references to type literals interface IUser { username: string } type User = IUser &lt;--- IUser is a type reference interface Context { user: User &lt;--- User is a type reference } In both cases we want to convert the type reference to it's primitive literals. We want: interface IUser { username: string } type User = { username: string } interface Context { user: { username: string } } */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ts.isTypeReferenceNode(node)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> symbol = checker.getSymbolAtLocation(node.typeName); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> type = checker.getDeclaredTypeOfSymbol(symbol); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> declarations = _.flatMap(checker.getPropertiesOfType(type), property =&gt; { <span class="hljs-comment"><span class="hljs-comment">/* Type references declarations may themselves have type references, so we need to resolve those literals as well */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _.map(property.declarations, visit); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ts.createTypeLiteralNode(declarations.filter(ts.isTypeElement)); } <span class="hljs-comment"><span class="hljs-comment">/* Convert type alias to interface declaration interface IUser { username: string } type User = IUser We want to remove all type aliases interface IUser { username: string } interface User { username: string &lt;-- Also need to resolve IUser } */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ts.isTypeAliasDeclaration(node)) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> symbol = checker.getSymbolAtLocation(node.name); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> type = checker.getDeclaredTypeOfSymbol(symbol); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> declarations = _.flatMap(checker.getPropertiesOfType(type), property =&gt; { <span class="hljs-comment"><span class="hljs-comment">// Resolve type alias to it's literals return _.map(property.declarations, visit); }); // Create interface with fully resolved types return ts.createInterfaceDeclaration( [], [ts.createToken(ts.SyntaxKind.ExportKeyword)], node.name.getText(), [], [], declarations.filter(ts.isTypeElement) ); } // Remove all export declarations if (ts.isImportDeclaration(node)) { return null; } return node; }; return node =&gt; ts.visitNode(node, visit); }; // Run source file through our transformer const result = ts.transform(source, [typeAliasToInterfaceTransformer]); // Create our output folder const outputDir = path.resolve(__dirname, '../generated'); if (!fs.existsSync(outputDir)) { fs.mkdirSync(outputDir); } // Write pretty printed transformed typescript to output directory fs.writeFileSync( path.resolve(__dirname, '../generated/models.ts'), printer.printFile(_.first(result.transformed)) );</span></span></code> </pre> </div></div><br><p>  Me gusta c贸mo se ve mi soluci贸n.  Incorpora el poder de buenas abstracciones, un compilador inteligente, herramientas de desarrollo 煤tiles (VSCode de autocompletado, explorador AST, etc.) y un poco de experiencia de otros desarrolladores expertos.  Su c贸digo fuente completo con actualizaciones se puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆</a> .  No estoy seguro de lo 煤til que ser谩 para casos m谩s generales, aparte de mi privado.  Solo quer铆a mostrar las capacidades del kit de herramientas del compilador TypeScript, y tambi茅n poner mis pensamientos en papel para resolver un problema no est谩ndar que me molest贸 durante mucho tiempo. </p><br><p>  Espero que mi ejemplo ayude a alguien a simplificar sus vidas.  Si el tema de AST, compiladores y transformaciones no es completamente comprendido por usted, entonces siga los enlaces a recursos y plantillas de terceros que le proporcion茅, deber铆an ayudarlo.  Tuve que pasar mucho tiempo estudiando esta informaci贸n para finalmente encontrar una soluci贸n.  Mis primeros intentos de repositorios privados de Github, incluyendo 45 <code>// @ts-ignores</code> y afirmaciones, me hicieron sonrojar de verg眉enza. </p><br><h1 id="resursy-kotorye-mne-pomogli">  Recursos que me ayudaron: </h1><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Microsoft / TypeScript</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Crear un transformador de TypeScript</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API del compilador de TypeScript revisitada</a> </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Explorador AST</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/457770/">https://habr.com/ru/post/457770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457760/index.html">C贸mo hacer que los contenedores est茅n a煤n m谩s aislados: una revisi贸n de las tecnolog铆as de sandbox de contenedores</a></li>
<li><a href="../457762/index.html">Regla CCD: con qu茅 se come</a></li>
<li><a href="../457764/index.html">10 errores del joven PO (parte II)</a></li>
<li><a href="../457766/index.html">Generamos niveles de mosaico y ocultamos cuadrados del jugador</a></li>
<li><a href="../457768/index.html">C贸mo me volv铆 vulnerable: escaneando la infraestructura de TI con Qualys</a></li>
<li><a href="../457774/index.html">Estudiar como piloto privado en la Tierra Media: mudarse y vivir en una aldea de Nueva Zelanda</a></li>
<li><a href="../457776/index.html">Las minas en rendimiento est谩n esperando en las alas: parte 2</a></li>
<li><a href="../457784/index.html">Calibraci贸n personalizada de Eye-Tracker</a></li>
<li><a href="../457786/index.html">Anet A8 Plus actualizado. Grande y metal</a></li>
<li><a href="../457790/index.html">BuratinoPhone Mobile Phone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>