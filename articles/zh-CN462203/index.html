<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒ€ ğŸ§™ğŸ¾ ğŸ‘ğŸ¿ ä½¿ç”¨bashçš„ä¸€æ¬¡æ€§è™šæ‹Ÿæœºçš„KVMï¼ˆä½äºï¼‰VDI ğŸ•‰ï¸ ğŸ· ğŸ‘ğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ¬æ–‡é€‚ç”¨äºè°ï¼Ÿ 
 é¢å¯¹åˆ›å»ºâ€œä¸€æ¬¡æ€§â€å·¥ä½œæœåŠ¡è¿™ä¸€ä»»åŠ¡çš„ç³»ç»Ÿç®¡ç†å‘˜ï¼Œæœ¬æ–‡å¯èƒ½ä¼šæ„Ÿå…´è¶£ã€‚ 

 åºè¨€ 
 ä¸€ä¸ªå¹´è½»çš„ï¼ŒåŠ¨æ€å‘å±•çš„å…¬å¸ï¼ˆå…·æœ‰å°å‹åŒºåŸŸç½‘ç»œï¼‰çš„ITæ”¯æŒéƒ¨é—¨è¢«è¦æ±‚ç»„ç»‡â€œè‡ªåŠ©æœåŠ¡ç«™â€ï¼Œä»¥ä¾›å…¶å¤–éƒ¨å®¢æˆ·ä½¿ç”¨ã€‚ è¯¥ç«™æ•°æ®åº”è¯¥ç”¨äºåœ¨å…¬å¸çš„å¤–éƒ¨é—¨æˆ·ç½‘ç«™ä¸Šæ³¨å†Œï¼Œä»å¤–éƒ¨è®¾å¤‡ä¸‹è½½æ•°æ®ä»¥åŠä¸æ”¿åºœé—¨æˆ·ç½‘ç«™ä¸€èµ·ä½¿ç”¨...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä½¿ç”¨bashçš„ä¸€æ¬¡æ€§è™šæ‹Ÿæœºçš„KVMï¼ˆä½äºï¼‰VDI</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462203/"><h4> æœ¬æ–‡é€‚ç”¨äºè°ï¼Ÿ </h4><br> é¢å¯¹åˆ›å»ºâ€œä¸€æ¬¡æ€§â€å·¥ä½œæœåŠ¡è¿™ä¸€ä»»åŠ¡çš„ç³»ç»Ÿç®¡ç†å‘˜ï¼Œæœ¬æ–‡å¯èƒ½ä¼šæ„Ÿå…´è¶£ã€‚ <br><br><h4> åºè¨€ </h4><br> ä¸€ä¸ªå¹´è½»çš„ï¼ŒåŠ¨æ€å‘å±•çš„å…¬å¸ï¼ˆå…·æœ‰å°å‹åŒºåŸŸç½‘ç»œï¼‰çš„ITæ”¯æŒéƒ¨é—¨è¢«è¦æ±‚ç»„ç»‡â€œè‡ªåŠ©æœåŠ¡ç«™â€ï¼Œä»¥ä¾›å…¶å¤–éƒ¨å®¢æˆ·ä½¿ç”¨ã€‚ è¯¥ç«™æ•°æ®åº”è¯¥ç”¨äºåœ¨å…¬å¸çš„å¤–éƒ¨é—¨æˆ·ç½‘ç«™ä¸Šæ³¨å†Œï¼Œä»å¤–éƒ¨è®¾å¤‡ä¸‹è½½æ•°æ®ä»¥åŠä¸æ”¿åºœé—¨æˆ·ç½‘ç«™ä¸€èµ·ä½¿ç”¨ã€‚ <br><br> ä¸€ä¸ªé‡è¦çš„æ–¹é¢æ˜¯ï¼Œå¤§å¤šæ•°è½¯ä»¶åœ¨MS Windowsä¸‹ï¼ˆä¾‹å¦‚ï¼Œâ€œå£°æ˜â€ï¼‰å·²â€œé”åŒ–â€ï¼Œå°½ç®¡æœç€å¼€æ”¾æ ¼å¼è¿ˆè¿›ï¼ŒMS Officeä»ç„¶æ˜¯äº¤æ¢ç”µå­æ–‡æ¡£çš„ä¸»è¦æ ‡å‡†ã€‚ å› æ­¤ï¼Œè§£å†³æ­¤é—®é¢˜æ—¶æˆ‘ä»¬ä¸èƒ½æ‹’ç»MS Windowsã€‚ <br><a name="habracut"></a><br> ä¸»è¦é—®é¢˜æ˜¯æœ‰å¯èƒ½ä»ç”¨æˆ·ä¼šè¯ä¸­æ”¶é›†å„ç§æ•°æ®ï¼Œè¿™å¯èƒ½å¯¼è‡´å®ƒä»¬æ³„éœ²ç»™ç¬¬ä¸‰æ–¹ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™ç§æƒ…å†µå·²ç»è®©MFCå´©æºƒäº†</a> ã€‚ ä½†æ˜¯ä¸å‡†å¸æ³•ï¼ˆå›½å®¶è‡ªæ²»æœºæ„ï¼‰MFCä¸åŒï¼Œéå›½å®¶ç»„ç»‡å°†å› æ­¤ç±»ç¼ºé™·è€Œå—åˆ°æ›´å¤šçš„æƒ©ç½šã€‚ ä¸‹ä¸€ä¸ªå…³é”®é—®é¢˜æ˜¯éœ€è¦ä½¿ç”¨å¤–éƒ¨å­˜å‚¨ä»‹è´¨ï¼Œåœ¨è¿™äº›å­˜å‚¨ä»‹è´¨ä¸Šè‚¯å®šä¼šå­˜åœ¨å¤§é‡æ¶æ„è½¯ä»¶ã€‚ ç”±äºé€šè¿‡ç™½åå•è®¿é—®äº’è”ç½‘å—åˆ°é™åˆ¶ï¼Œå› æ­¤è®¤ä¸ºä»Internetè¿›å…¥æ¶æ„è½¯ä»¶çš„å¯èƒ½æ€§è¾ƒå°ï¼Œå…¶ä»–éƒ¨é—¨çš„å‘˜å·¥å…±åŒåˆ¶å®šäº†è¦æ±‚ï¼Œæå‡ºè¦æ±‚å’Œå¸Œæœ›ï¼Œæœ€ç»ˆè¦æ±‚å¦‚ä¸‹ï¼š <br><br>  <b>ISè¦æ±‚</b> <br><br><ul><li> ä½¿ç”¨åï¼Œåº”åˆ é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼ˆåŒ…æ‹¬ä¸´æ—¶æ–‡ä»¶å’Œæ³¨å†Œè¡¨é¡¹ï¼‰ã€‚ </li><li> ç”¨æˆ·å¯åŠ¨çš„æ‰€æœ‰è¿‡ç¨‹éƒ½åº”åœ¨å·¥ä½œç»“æŸæ—¶å®Œæˆã€‚ </li><li> é€šè¿‡ç™½åå•è®¿é—®Internetã€‚ </li><li> å¯¹è¿è¡Œç¬¬ä¸‰æ–¹ä»£ç çš„èƒ½åŠ›çš„é™åˆ¶ã€‚ </li><li> å¦‚æœä¼šè¯é—²ç½®è¶…è¿‡5åˆ†é’Ÿï¼Œåˆ™ä¼šè¯åº”è‡ªåŠ¨ç»“æŸï¼Œå·¥ä½œç«™åº”æ‰§è¡Œæ¸…ç†æ“ä½œã€‚ </li></ul><br>  <b>å®¢æˆ·è¦æ±‚</b> <br><br><ul><li> æ¯ä¸ªåˆ†æ”¯çš„å®¢æˆ·ç«™æ•°é‡ä¸è¶…è¿‡4ã€‚ </li><li> ä»æˆ‘â€œååœ¨æ¤…å­ä¸Šâ€åˆ°å¼€å§‹ä½¿ç”¨å®¢æˆ·ç«¯è½¯ä»¶çš„é‚£ä¸€åˆ»ï¼Œç³»ç»Ÿå°±ç»ªæ‰€éœ€çš„æœ€çŸ­ç­‰å¾…æ—¶é—´ã€‚ </li><li> å¯ä»¥ç›´æ¥ä»â€œè‡ªåŠ©æœåŠ¡ç«™â€çš„å®‰è£…ç«™ç‚¹è¿æ¥å¤–å›´è®¾å¤‡ï¼ˆæ‰«æä»ªï¼Œé—ªå­˜é©±åŠ¨å™¨ï¼‰ã€‚ </li><li> å®¢æˆ·çš„æ„¿æœ› </li><li> å¤§æ¥¼å…³é—­æ—¶çš„å¹¿å‘Šèµ„æ–™ï¼ˆå›¾ç‰‡ï¼‰æ¼”ç¤ºã€‚ </li></ul><cut></cut><br><h4> åˆ›æ„é¢ç²‰ </h4><br> åœ¨Windows livecdä¸Šç©äº†è¶³å¤Ÿçš„æ¸¸æˆåï¼Œæˆ‘ä»¬å¾—å‡ºäº†ä¸€ä¸ªä¸€è‡´çš„ç»“è®ºï¼Œå³æœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆè‡³å°‘ä¸èƒ½æ»¡è¶³3ä¸ªå…³é”®ç‚¹ã€‚ å®ƒä»¬è¦ä¹ˆåŠ è½½æ—¶é—´å¾ˆé•¿ï¼Œè¦ä¹ˆåŠ è½½æ—¶é—´ä¸é•¿ï¼Œæˆ–è€…å®ƒä»¬çš„è‡ªå®šä¹‰ä¼´éšç€ç‹‚é‡çš„ç—›è‹¦ã€‚ ä¹Ÿè®¸æˆ‘ä»¬æœç´¢ä¸åŠ›ï¼Œæ‚¨å¯ä»¥å»ºè®®ä¸€äº›å·¥å…·ï¼Œæˆ‘å°†ä¸èƒœæ„Ÿæ¿€ã€‚ <br><br> æ­¤å¤–ï¼Œæˆ‘ä»¬å¼€å§‹ç€çœ¼äºVDIï¼Œä½†æ˜¯å¯¹äºæ­¤ä»»åŠ¡ï¼Œå¤§å¤šæ•°è§£å†³æ–¹æ¡ˆè¦ä¹ˆå¤ªæ˜‚è´µï¼Œè¦ä¹ˆéœ€è¦å¯†åˆ‡å…³æ³¨ã€‚ æˆ‘æƒ³è¦ä¸€ä¸ªç®€å•çš„å·¥å…·ï¼Œåªéœ€å¾ˆå°‘çš„é­”åŠ›ï¼Œåªéœ€é‡æ–°å¯åŠ¨/é‡æ–°å¯åŠ¨æœåŠ¡å³å¯è§£å†³å¤§å¤šæ•°é—®é¢˜ã€‚ å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ä»é€€å½¹æœåŠ¡ä¸­è·å¾—äº†åˆ†æ”¯æœºæ„ä¸­ä½ç«¯çº§åˆ«çš„æœåŠ¡å™¨è®¾å¤‡ï¼Œå¯ä»¥å°†å…¶ç”¨ä½œæŠ€æœ¯åŸºç¡€ã€‚ <br><br> ç»“æœå¦‚ä½•ï¼Ÿ ä½†æ˜¯æˆ‘æ— æ³•å‘Šè¯‰æ‚¨æœ€ç»ˆå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Œå› ä¸ºNDAï¼Œä½†æ˜¯åœ¨æœç´¢è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªæœ‰è¶£çš„æ–¹æ¡ˆï¼Œå°½ç®¡æ²¡æœ‰è¿›è¡Œæ‰¹é‡è¯•éªŒï¼Œä½†å®ƒåœ¨å®éªŒå®¤æµ‹è¯•ä¸­è¡¨ç°å¾—å¾ˆå¥½ã€‚ <br><br> å‡ é¡¹å…è´£å£°æ˜ï¼šä½œè€…å¹¶æ²¡æœ‰å£°ç§°æ‰€æå‡ºçš„è§£å†³æ–¹æ¡ˆå®Œå…¨è§£å†³äº†æ‰€æœ‰ä»»åŠ¡ï¼Œå¹¶ä¸”è‡ªæ„¿å¹¶éšæ­Œæ›²ä¸€èµ·æ‰§è¡Œã€‚ ä½œè€…äº‹å…ˆåŒæ„â€œè‹±è¯­ï¼ˆSein Englishï¼‰spracheæ˜¯â€‹â€‹zehr schlechtâ€çš„è¯´æ³•ã€‚ ç”±äºè¯¥è§£å†³æ–¹æ¡ˆä¸å†å¼€å‘ï¼Œæ‚¨æ— æ³•æŒ‡æœ›é”™è¯¯ä¿®å¤æˆ–åŠŸèƒ½æ›´æ”¹ï¼Œä¸€åˆ‡éƒ½åœ¨æ‚¨çš„æ‰‹ä¸­ã€‚ ä½œè€…å‡è®¾æ‚¨è‡³å°‘å¯¹KVMæœ‰ç‚¹ç†Ÿæ‚‰ï¼Œå¹¶é˜…è¯»äº†æœ‰å…³Spiceåè®®çš„è¯„è®ºæ–‡ç« ï¼Œå¹¶ä¸”æ‚¨å¯¹Centosæˆ–å…¶ä»–GNU Linuxå‘è¡Œç‰ˆè¿›è¡Œäº†ä¸€äº›å·¥ä½œã€‚ <br><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘æƒ³åˆ†ææœ€ç»ˆè§£å†³æ–¹æ¡ˆçš„ä¸»å¹²ï¼Œå³å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’ä»¥åŠæ‰€è®¨è®ºè§£å†³æ–¹æ¡ˆæ¡†æ¶å†…è™šæ‹Ÿæœºç”Ÿå‘½å‘¨æœŸä¸­æµç¨‹çš„æœ¬è´¨ã€‚ å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹å…¬ä¼—æ„Ÿå…´è¶£ï¼Œæˆ‘å°†æè¿°ä¸ºåŸºäºFedoraåˆ›å»ºç˜¦å®¢æˆ·æœºè€Œå®ç°å®æ—¶æ˜ åƒçš„ç»†èŠ‚ï¼Œå¹¶ä»‹ç»è°ƒæ•´è™šæ‹Ÿæœºå’ŒKVMæœåŠ¡å™¨ä»¥ä¼˜åŒ–æ€§èƒ½å’Œå®‰å…¨æ€§çš„ç»†èŠ‚ã€‚ <br><br> å¦‚æœæ‚¨å¸¦å½©è‰²çº¸ï¼Œ <br> æ²¹æ¼†ï¼Œåˆ·å­å’Œèƒ¶æ°´ï¼Œ <br> è¿˜æœ‰æ›´å¤šçš„çµæ´»æ€§... <br> ä½ å¯ä»¥èµšä¸€ç™¾å¢å¸ƒï¼ <br><br><h4> æµ‹è¯•å°çš„æ–¹æ¡ˆå’Œè¯´æ˜ </h4><br><img src="https://habrastorage.org/webt/pu/tu/rk/puturkaiwqcpbp4wld7ezdk_lcw.png"><br><br> æ‰€æœ‰è®¾å¤‡éƒ½ä½äºåˆ†æ”¯ç½‘ç»œå†…éƒ¨ï¼Œåªæœ‰Interneté€šé“æ–­å¼€ã€‚ ä»å†å²ä¸Šçœ‹ï¼Œå·²ç»æœ‰ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œè¿™ä¸æ˜¯ä»€ä¹ˆç‰¹åˆ«çš„äº‹æƒ…ã€‚ ä½†æ˜¯ï¼Œé™¤å…¶ä»–å¤–ï¼Œæ¥è‡ªè™šæ‹Ÿæœºçš„æµé‡å°†è¢«è¿‡æ»¤æ‰ï¼ˆæœ¬æ–‡åé¢ç®€ç§°ä¸ºVMï¼‰ã€‚ æ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢å°†æ­¤æœåŠ¡æ”¾ç½®åœ¨KVMæœåŠ¡å™¨ä¸Šçš„ï¼Œæ‚¨å”¯ä¸€éœ€è¦æ³¨æ„çš„æ˜¯ç£ç›˜å­ç³»ç»Ÿä¸Šæ¥è‡ªè¯¥æœåŠ¡çš„è´Ÿè½½å¦‚ä½•å˜åŒ–ã€‚ <br><br> å®¢æˆ·ç«™-å®é™…ä¸Šæ˜¯æˆ‘ä»¬æœåŠ¡çš„â€œè‡ªåŠ©æœåŠ¡ç«™â€ï¼Œâ€œå‰ç«¯â€ã€‚ æ˜¯Lenovo IdeaCentreçš„ä¸Šç½‘æœ¬ã€‚ è¿™ä¸ªå•å…ƒæœ‰ä»€ä¹ˆç”¨ï¼Ÿ æ˜¯çš„ï¼Œå‡ ä¹æ¯ä¸ªäººéƒ½å¯¹å‰é¢æ¿ä¸Šçš„å¤§é‡USBè¿æ¥å™¨å’Œè¯»å¡å™¨æ„Ÿåˆ°ç‰¹åˆ«æ»¡æ„ã€‚ åœ¨æˆ‘ä»¬çš„æ–¹æ¡ˆä¸­ï¼Œå°†å…·æœ‰ç¡¬ä»¶å†™ä¿æŠ¤çš„SDå¡æ’å…¥è¯»å¡å™¨ä¸­ï¼Œä¸Šé¢è®°å½•äº†Fedora 28çš„ä¿®æ”¹åçš„å®æ—¶å›¾åƒï¼Œå½“ç„¶ï¼Œç›‘è§†å™¨ï¼Œé”®ç›˜å’Œé¼ æ ‡ä¹Ÿè¿æ¥åˆ°äº†ä¸Šç½‘æœ¬ä¸Šã€‚ <br><br> å¼€å…³-ç¬¬äºŒå±‚çš„ä¸èµ·çœ¼çš„ç¡¬ä»¶å¼€å…³ï¼Œå®ƒåœ¨æœåŠ¡å™¨æœºæˆ¿ä¸­ï¼Œå¹¶ä¸”é—ªçƒå¹¶å¸¦æœ‰æŒ‡ç¤ºç¯ã€‚ é™¤â€œè‡ªåŠ©æœåŠ¡ç«™â€çš„ç½‘ç»œå¤–ï¼Œå®ƒæœªè¿æ¥åˆ°ä»»ä½•ç½‘ç»œã€‚ <br><br>  KVM_Serveræ˜¯ç”µè·¯çš„æ ¸å¿ƒï¼Œåœ¨å°å¼æµ‹è¯•ä¸­ï¼Œå…·æœ‰8 GB RAMçš„Core 2 Quad Q9650å¯ä»¥è‡ªä¿¡åœ°å°†3ä¸ªWindows 10è™šæ‹Ÿæœºæ‹‰ä¸Šã€‚ ç£ç›˜å­ç³»ç»Ÿ-Adaptec 3405 2é©±åŠ¨å™¨RAID 1 + SSDã€‚ åœ¨è‡³å¼º1220çš„ç°åœºè¯•éªŒä¸­ï¼Œæ›´ä¸¥é‡çš„LSI 9260 + SSDè½»æ¾æ‹‰å‡º5-6ä¸ªVMã€‚ æˆ‘ä»¬å°†ä»é€€å½¹çš„æœåŠ¡ä¸­è·å–æœåŠ¡å™¨ï¼Œå› æ­¤ä¸ä¼šæœ‰å¾ˆå¤šèµ„æœ¬æˆæœ¬ã€‚ å…·æœ‰pool_Vmè™šæ‹Ÿæœºæ± çš„KVMè™šæ‹ŸåŒ–ç³»ç»Ÿå·²éƒ¨ç½²åœ¨è¯¥æœåŠ¡å™¨ä¸Šã€‚ <br><br>  Vmæ˜¯è™šæ‹Ÿæœºï¼Œæ˜¯æˆ‘ä»¬æœåŠ¡çš„åç«¯ã€‚ è¿™æ˜¯ç”¨æˆ·çš„å·¥ä½œã€‚ <br><br>  Enp5s0æ˜¯ä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œå®ƒé¢å‘â€œè‡ªåŠ©æœåŠ¡ç«™â€ï¼Œdhcpdï¼Œntpdï¼Œhttpdç”Ÿæ´»åœ¨å…¶ä¸Šçš„ç½‘ç»œï¼Œå¹¶ä¸”xinetdä¾¦å¬â€œä¿¡å·â€ç«¯å£ã€‚ <br><br>  Lo0æ˜¯å›é€ä¼ªæ¥å£ã€‚ æ ‡å‡†ã€‚ <br><br>  Spice_console-ä¸€ä¸ªéå¸¸æœ‰è¶£çš„äº‹æƒ…ï¼Œäº‹å®æ˜¯ï¼Œä¸ä¼ ç»Ÿçš„RDPä¸åŒï¼Œå½“æ‚¨æ‰“å¼€KVM + Spiceåè®®æ†ç»‘åŒ…æ—¶ï¼Œä¼šå‡ºç°ä¸€ä¸ªé™„åŠ å®ä½“-è™šæ‹Ÿæœºæ§åˆ¶å°ç«¯å£ã€‚ å®é™…ä¸Šï¼Œè¿æ¥åˆ°æ­¤TCPç«¯å£åï¼Œæˆ‘ä»¬å¾—åˆ°äº†Vmæ§åˆ¶å°ï¼Œè€Œæ— éœ€é€šè¿‡å…¶ç½‘ç»œæ¥å£è¿æ¥åˆ°Vmã€‚ ä¸Vmçš„æ‰€æœ‰äº¤äº’ç”¨äºä¿¡å·ä¼ è¾“ï¼ŒæœåŠ¡å™¨æ¥ç®¡ã€‚ åŠŸèƒ½ä¸Šæœ€æ¥è¿‘çš„æ¨¡æ‹Ÿæ˜¯IPKVMã€‚ å³  VMç›‘è§†å™¨çš„æ˜ åƒå·²ä¼ è¾“åˆ°æ­¤ç«¯å£ï¼Œé¼ æ ‡ç§»åŠ¨çš„æ•°æ®ä¹Ÿå·²ä¼ è¾“åˆ°è¯¥ç«¯å£ï¼Œå¹¶ä¸”ï¼ˆæœ€é‡è¦çš„æ˜¯ï¼‰é€šè¿‡Spiceåè®®è¿›è¡Œçš„äº¤äº’ä½¿æ‚¨å¯ä»¥å°†USBè®¾å¤‡æ— ç¼é‡å®šå‘åˆ°è™šæ‹Ÿæœºï¼Œå°±å¥½åƒè¯¥è®¾å¤‡å·²è¿æ¥åˆ°Vmæœ¬èº«ä¸€æ ·ã€‚ å·²æµ‹è¯•é—ªå­˜é©±åŠ¨å™¨ï¼Œæ‰«æä»ªï¼Œç½‘ç»œæ‘„åƒå¤´ã€‚ <br><br>  Vnet0ï¼Œvirbr0å’Œè™šæ‹Ÿç½‘å¡Vmå½¢æˆè™šæ‹Ÿæœºç½‘ç»œã€‚ <br><br><h4> å¦‚ä½•è¿ä½œ </h4><br> ä»å®¢æˆ·ç«™ <br><br> ä»Fedora 28çš„ä¿®æ”¹åçš„å®æ—¶æ˜ åƒä»¥å›¾å½¢æ–¹å¼åŠ è½½å®¢æˆ·ç«™ï¼Œå¹¶é€šè¿‡dhcpä»ç½‘ç»œåœ°å€ç©ºé—´169.254.24.0/24æ¥æ”¶IPåœ°å€ã€‚ åœ¨å¼•å¯¼è¿‡ç¨‹ä¸­ï¼Œå°†åˆ›å»ºé˜²ç«å¢™è§„åˆ™ï¼Œä»¥å…è®¸è¿æ¥â€œä¿¡å·â€å’Œâ€œé¦™æ–™â€æœåŠ¡å™¨ç«¯å£ã€‚ ä¸‹è½½å®Œæˆåï¼Œå·¥ä½œç«™å°†ç­‰å¾…å®¢æˆ·ç«¯ç”¨æˆ·çš„æˆæƒã€‚ ç”¨æˆ·æˆæƒåï¼Œå°†å¯åŠ¨â€œ openboxâ€æ¡Œé¢ç®¡ç†å™¨ï¼Œå¹¶ä»£è¡¨æˆæƒç”¨æˆ·æ‰§è¡Œè‡ªåŠ¨å¯åŠ¨è‡ªåŠ¨å¯åŠ¨è„šæœ¬ã€‚ é™¤å…¶ä»–å¤–ï¼Œè‡ªåŠ¨è¿è¡Œè„šæœ¬è¿è¡Œremote.shè„šæœ¬ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">$ HOME / .config / openbox /è„šæœ¬/ remote.sh</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh server_ip=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep "server_ip" \ |/usr/bin/cut -d "=" -f2) vdi_signal_port=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep "vdi_signal_port" \ |/usr/bin/cut -d "=" -f2) vdi_spice_port=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep "vdi_spice_port" \ |/usr/bin/cut -d "=" -f2) animation_folder=$(/usr/bin/cat /etc/client.conf |/usr/bin/grep "animation_folder" \ |/usr/bin/cut -d "=" -f2) process=/usr/bin/remote-viewer while true do if [ -z `/usr/bin/pidof feh` ] then /usr/bin/echo $animation_folder /usr/bin/feh -N -x -D1 $animation_folder &amp; else /usr/bin/echo fi /usr/bin/nc -i 1 $server_ip $vdi_signal_port |while read line do if /usr/bin/echo "$line" |/usr/bin/grep "RULE ADDED, CONNECT NOW!" then /usr/bin/killall feh pid_process=$($process "spice://$server_ip:$vdi_spice_port" \ "--spice-disable-audio" "--spice-disable-effects=animation" \ "--spice-preferred-compression=auto-glz" "-k" \ "--kiosk-quit=on-disconnect" | /bin/echo $!) /usr/bin/wait $pid_process /usr/bin/killall -u $USER exit else /usr/bin/echo $line &gt;&gt; /var/log/remote.log fi done done</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">/etc/client.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">server_ip=169.254.24.1 vdi_signal_port=5905 vdi_spice_port=5906 animation_folder=/usr/share/backgrounds/animation background_folder=/usr/share/backgrounds2/fedora-workstation</code> </pre><br></div></div><br>  client.confæ–‡ä»¶çš„å˜é‡è¯´æ˜ <br>  server_ip-åœ°å€KVM_Server <br>  vdi_signal_port-xinetdâ€œååœ¨â€çš„ç«¯å£KVM_Server <br>  vdi_spice_port-ç½‘ç»œç«¯å£KVM_Serverï¼Œè¿æ¥è¯·æ±‚å°†ä»ç½‘ç»œç«¯å£KVM_Serveré‡å®šå‘åˆ°è¿œç¨‹æŸ¥çœ‹å™¨å®¢æˆ·ç«¯åˆ°æ‰€é€‰Vmçš„spiceç«¯å£ï¼ˆè¯¦ç»†ä¿¡æ¯å¦‚ä¸‹ï¼‰ <br>  animation_folder-ç”¨äºæ¼”ç¤ºåºŸè¯åŠ¨ç”»çš„å›¾åƒçš„æ–‡ä»¶å¤¹ <br>  background_folder-å¤‡ç”¨æ¼”ç¤ºæ–‡ç¨¿ä»ä¸­è·å–å›¾åƒçš„æ–‡ä»¶å¤¹ã€‚ æœ¬æ–‡ä¸‹åŠéƒ¨åˆ†å°†è¯¦ç»†ä»‹ç»åŠ¨ç”»ã€‚ <br><br>  remote.shè„šæœ¬ä»é…ç½®æ–‡ä»¶/etc/client.confä¸­è·å–è®¾ç½®ï¼Œå¹¶ä½¿ç”¨ncè¿æ¥åˆ°KVMæœåŠ¡å™¨çš„â€œ vdi_signal_portâ€ç«¯å£ï¼Œå¹¶ä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®æµï¼Œå…¶ä¸­éœ€è¦å­—ç¬¦ä¸²â€œ RULE ADDEDï¼ŒCONNECT NOWâ€ã€‚ æ¥æ”¶åˆ°æ‰€éœ€çš„çº¿è·¯åï¼Œè¿œç¨‹æŸ¥çœ‹å™¨è¿›ç¨‹å°†ä»¥ä¿¡æ¯äº­æ¨¡å¼å¯åŠ¨ï¼Œå¹¶å»ºç«‹ä¸â€œ vdi_spice_portâ€æœåŠ¡å™¨ç«¯å£çš„è¿æ¥ã€‚ è„šæœ¬çš„æ‰§è¡Œè¢«æŒ‚èµ·ï¼Œç›´åˆ°è¿œç¨‹æŸ¥çœ‹å™¨æ‰§è¡Œç»“æŸã€‚ <br><br> ç”±äºæœåŠ¡å™¨ç«¯çš„é‡å®šå‘ï¼Œè¿æ¥åˆ°â€œ vdi_spice_portâ€ç«¯å£çš„è¿œç¨‹æŸ¥çœ‹å™¨åˆ°è¾¾lo0æ¥å£çš„â€œ spice_consoleâ€ç«¯å£ï¼Œå³ åˆ°è™šæ‹Ÿæœºçš„æ§åˆ¶å°ï¼Œç”¨æˆ·çš„å·¥ä½œå°±ç›´æ¥è¿›è¡Œäº†ã€‚ åœ¨ç­‰å¾…è¿æ¥æ—¶ï¼Œä»¥jpegæ–‡ä»¶çš„å¹»ç¯ç‰‡å½¢å¼å‘ç”¨æˆ·æ˜¾ç¤ºåºŸè¯åŠ¨ç”»ï¼Œå¸¦æœ‰å›¾ç‰‡çš„ç›®å½•çš„è·¯å¾„ç”±é…ç½®æ–‡ä»¶ä¸­çš„animation_folderå˜é‡çš„å€¼ç¡®å®šã€‚ <br><br> å¦‚æœä¸è™šæ‹Ÿæœºçš„â€œ spice_consoleâ€ç«¯å£çš„è¿æ¥ä¸¢å¤±ï¼Œè¿™è¡¨æ˜è™šæ‹Ÿæœºå·²å…³é—­/é‡æ–°å¯åŠ¨ï¼ˆå³ï¼Œç”¨æˆ·ä¼šè¯çš„å®é™…ç»“æŸï¼‰ï¼Œåˆ™ä»£è¡¨æˆæƒç”¨æˆ·è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹éƒ½å°†ç»ˆæ­¢ï¼Œè¿™å°†å¯¼è‡´lightdmé‡æ–°å¯åŠ¨å¹¶è¿”å›åˆ°æˆæƒå±å¹•ã€‚ <br><br><h4> ä»KVMæœåŠ¡å™¨çš„ä¾§é¢ </h4><br> åœ¨ç½‘å¡çš„â€œä¿¡å·â€ç«¯å£ä¸Šï¼Œenp5s0æ­£åœ¨ç­‰å¾…xinetdè¿æ¥ã€‚ è¿æ¥åˆ°â€œä¿¡å·â€ç«¯å£åï¼Œxinetdä¼šåœ¨ä¸ä¼ é€’ä»»ä½•è¾“å…¥å‚æ•°çš„æƒ…å†µä¸‹è¿è¡Œvm_manager.shè„šæœ¬ï¼Œå¹¶å°†è„šæœ¬ç»“æœé‡å®šå‘åˆ°Client Stationçš„ncä¼šè¯ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">/etc/xinetd.d/test-server</b> <div class="spoiler_text"><pre> <code class="bash hljs">service vdi_signal { port = 5905 socket_type = stream protocol = tcp <span class="hljs-built_in"><span class="hljs-built_in">wait</span></span> = no user = root server = /home/admin/scripts_vdi_new/vm_manager.sh }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_manager.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/sh #&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;# SRV_SCRIPTS_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_scripts_dir" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_SCRIPTS_DIR=$SRV_SCRIPTS_DIR" export SRV_SCRIPTS_DIR=$SRV_SCRIPTS_DIR SRV_POOL_SIZE=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_pool_size" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_POOL_SIZE=$SRV_POOL_SIZE" export "SRV_POOL_SIZE=$SRV_POOL_SIZE" SRV_START_PORT_POOL=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_start_port_pool" |/usr/bin/cut -d "=" -f2) /usr/bin/echo SRV_START_PORT_POOL=$SRV_START_PORT_POOL export SRV_START_PORT_POOL=$SRV_START_PORT_POOL SRV_TMP_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_tmp_dir" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_TMP_DIR=$SRV_TMP_DIR" export SRV_TMP_DIR=$SRV_TMP_DIR date=$(/usr/bin/date) #&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;# /usr/bin/echo "# $date START EXECUTE VM_MANAGER.SH #" make_connect_to_vm() { #&lt;READING CLEAR.LIST AND CHECK PORT FOR NETWORK STATE&gt;# /usr/bin/echo "READING CLEAN.LIST AND CHECK PORT STATE" #&lt;CHECK FOR NO ONE PORT IN CLEAR.LIST&gt;# if [ -z `/usr/bin/cat $SRV_TMP_DIR/clear.list` ] then /usr/bin/echo "NO AVALIBLE PORTS IN CLEAN.LIST FOUND" /usr/bin/echo "Will try to make housekeeper, and create new vm" make_housekeeper else #&lt;MINIMUN ONE PORT IN CLEAR.LIST FOUND&gt;# /usr/bin/cat $SRV_TMP_DIR/clear.list |while read line do clear_vm_port=$(($line)) /bin/echo "FOUND PORT $clear_vm_port IN CLEAN.LIST. TRY NETSTAT" \ "CHECK FOR PORT=$clear_vm_port" #&lt;NETSTAT LISTEN CHECK FOR PORT FROM CLEAN.LIST&gt;# if /usr/bin/netstat -lnt |/usr/bin/grep ":$clear_vm_port" &gt; /dev/null then /bin/echo "$clear_vm_port IS LISTEN" #&lt;PORT IS LISTEN. CHECK FOR IS CONNECTED NOW&gt;# if /usr/bin/netstat -nt |/usr/bin/grep ":$clear_vm_port" \ |/usr/bin/grep "ESTABLISHED" &gt; /dev/null then #&lt;PORT LISTEN AND ALREADY CONNECTED! MOVE PORT FROM CLEAR.LIST # TO WASTE.LIST&gt;# /bin/echo "$clear_vm_port IS ALREADY CONNECTED, MOVE PORT TO WASTE.LIST" /usr/bin/sed -i "/$clear_vm_port/d" $SRV_TMP_DIR/clear.list /usr/bin/echo $clear_vm_port &gt;&gt; $SRV_TMP_DIR/waste.list else #&lt;PORT LISTEN AND NO ONE CONNECT NOW. MOVE PORT FROM CLEAR.LIST TO # CONN_WAIT.LIST AND CREATE IPTABLES RULES&gt;## /usr/bin/echo "OK, $clear_vm_port IS NOT ALREADY CONNECTED" /usr/bin/sed -i "/$clear_vm_port/d" $SRV_TMP_DIR/clear.list /usr/bin/echo $clear_vm_port &gt;&gt; $SRV_TMP_DIR/conn_wait.list $SRV_SCRIPTS_DIR/vm_connect.sh $clear_vm_port #&lt;TRY TO CLEAN VM IN WASTE.LIST AND CREATE NEW WM&gt;# /bin/echo "TRY TO CLEAN VM IN WASTE.LIST AND CREATE NEW VM" make_housekeeper /usr/bin/echo "# $date STOP EXECUTE VM_MANAGER.SH#" exit fi else #&lt;PORT IS NOT A LISTEN. MOVE PORT FROM CLEAR.LIST TO WASTE.LIST&gt;# /bin/echo " "$clear_vm_port" is NOT LISTEN. REMOVE PORT FROM CLEAR.LIST" /usr/bin/sed -i "/$clear_vm_port/d" $SRV_TMP_DIR/clear.list /usr/bin/echo $clear_vm_port &gt;&gt; $SRV_TMP_DIR/waste.list make_housekeeper fi done fi } make_housekeeper() { /usr/bin/echo "=Execute housekeeper=" /usr/bin/cat $SRV_TMP_DIR/waste.list |while read line do /usr/bin/echo "$line" if /usr/bin/netstat -lnt |/usr/bin/grep ":$line" &gt; /dev/null then /bin/echo "port_alive, vm is running" if /usr/bin/netstat -nt |/usr/bin/grep ":$line" \ |/usr/bin/grep "ESTABLISHED" &gt; /dev/null then /bin/echo "port_in_use can't delete vm!!!" else /bin/echo "port_not in use. Deleting vm" /usr/bin/sed -i "/$line/d" $SRV_TMP_DIR/waste.list /usr/bin/echo $line &gt;&gt; $SRV_TMP_DIR/recycle.list $SRV_SCRIPTS_DIR/vm_delete.sh $line fi else /usr/bin/echo "posible vm is already off. Deleting vm" /usr/bin/echo "MOVE VM IN OFF STATE $line FROM WASTE.LIST TO" \ "RECYCLE.LIST AND DELETE VM" /usr/bin/sed -i "/$line/d" $SRV_TMP_DIR/waste.list /usr/bin/echo $line &gt;&gt; $SRV_TMP_DIR/recycle.list $SRV_SCRIPTS_DIR/vm_delete.sh "$line" fi done create_clear_vm } create_clear_vm() { /usr/bin/echo "=Create new VM=" while [ $SRV_POOL_SIZE -gt 0 ] do new_vm_port=$(($SRV_START_PORT_POOL+$SRV_POOL_SIZE)) /usr/bin/echo "new_vm_port=$new_vm_port" if /usr/bin/grep "$new_vm_port" $SRV_TMP_DIR/clear.list &gt; /dev/null then /usr/bin/echo "$new_vm_port port is already defined in clear.list" else if /usr/bin/grep "$new_vm_port" $SRV_TMP_DIR/waste.list &gt; /dev/null then /usr/bin/echo "$new_vm_port port is already defined in waste.list" else if /usr/bin/grep "$new_vm_port" $SRV_TMP_DIR/recycle.list &gt; /dev/null then /usr/bin/echo "$new_vm_port PORT IS ALREADY DEFINED IN RECYCLE LIST" else if /usr/bin/grep "$new_vm_port" $SRV_TMP_DIR/conn_wait.list &gt; /dev/null then /usr/bin/echo "$new_vm_port PORT IS ALREADY DEFINED IN CONN_WAIT LIST" else /usr/bin/echo "PORT IN NOT DEFINED IN NO ONE LIST WILL CREATE" \ "VM ON PORT $new_vm_port" /usr/bin/echo $new_vm_port &gt;&gt; $SRV_TMP_DIR/recycle.list $SRV_SCRIPTS_DIR/vm_create.sh $new_vm_port fi fi fi fi SRV_POOL_SIZE=$(($SRV_POOL_SIZE-1)) done /usr/bin/echo "# $date STOP EXECUTE VM_MANAGER.SH #" } make_connect_to_vm |/usr/bin/tee -a /var/log/vm_manager.log</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">/etc/vm_manager.conf</b> <div class="spoiler_text">  srv_scripts_dir = /ä¸»é¡µ/ç®¡ç†å‘˜/ scripts_vdi_new <br>  srv_pool_size = 4 <br>  srv_start_port_pool = 5920 <br>  srv_tmp_dir = / tmp / vm_state <br>  base_host = win10_2 <br>  input_iface = enp5s0 <br>  vdi_spice_port = 5906 <br>  count_conn_tryes = 10 <br></div></div><br><br> é…ç½®æ–‡ä»¶vm_manager.confçš„å˜é‡è¯´æ˜ <br>  srv_scripts_dir-è„šæœ¬ä½ç½®æ–‡ä»¶å¤¹vm_manager.shï¼Œvm_connect.shï¼Œvm_delete.shï¼Œvm_create.shï¼Œvm_clear.sh <br>  srv_pool_size-Vmæ± å¤§å° <br>  srv_start_port_pool-åˆå§‹ç«¯å£ï¼Œä¹‹åå°†å¯åŠ¨è™šæ‹Ÿæœºæ§åˆ¶å°çš„é¦™æ–™ç«¯å£ <br>  srv_tmp_dir-ä¸´æ—¶æ–‡ä»¶çš„æ–‡ä»¶å¤¹ <br>  base_host-åŸºæœ¬Vmï¼ˆé»„é‡‘æ˜ åƒï¼‰ï¼Œå°†ä»è¯¥åŸºæœ¬Vmå…‹éš†åˆ°æ± ä¸­ <br>  input_iface-æœåŠ¡å™¨çš„ç½‘ç»œæ¥å£ï¼Œé¢å‘å®¢æˆ·ç«¯å·¥ä½œç«™ <br>  vdi_spice_port-æœåŠ¡å™¨çš„ç½‘ç»œç«¯å£ï¼Œè¿æ¥è¯·æ±‚å°†ä»è¯¥æœåŠ¡å™¨çš„ç½‘ç»œç«¯å£ä»è¿œç¨‹æŸ¥çœ‹å™¨å®¢æˆ·ç«¯é‡å®šå‘åˆ°æ‰€é€‰Vmçš„spiceç«¯å£ <br>  count_conn_tryes-ç­‰å¾…è®¡æ—¶å™¨ï¼Œåœ¨æ­¤ä¹‹åè®¤ä¸ºå°šæœªä¸Vmå»ºç«‹è¿æ¥ï¼ˆæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…vm_connect.shï¼‰ <br><br>  vm_manager.shè„šæœ¬ä»vm_manager.confæ–‡ä»¶ä¸­è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¹¶æ ¹æ®å¤šä¸ªå‚æ•°è¯„ä¼°æ± ä¸­è™šæ‹Ÿæœºçš„çŠ¶æ€ï¼Œå³ï¼šå·²éƒ¨ç½²äº†å¤šå°‘ä¸ªVMï¼Œæ˜¯å¦æœ‰å…è´¹çš„å¹²å‡€VMã€‚ ä¸ºæ­¤ï¼Œä»–è¯»å–äº†clear.listæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«â€œæ–°åˆ›å»ºâ€ï¼ˆè¯·å‚è§ä¸‹é¢çš„VMåˆ›å»ºå‘¨æœŸï¼‰è™šæ‹Ÿæœºçš„â€œ spice_consoleâ€ç«¯å£å·ï¼Œå¹¶æ£€æŸ¥ä¸å®ƒä»¬çš„å·²å»ºç«‹è¿æ¥ã€‚ å¦‚æœæ£€æµ‹åˆ°å…·æœ‰å·²å»ºç«‹ç½‘ç»œè¿æ¥çš„ç«¯å£ï¼ˆç»å¯¹ä¸åº”ï¼‰ï¼Œåˆ™å°†æ˜¾ç¤ºè­¦å‘Šï¼Œå¹¶å°†è¯¥ç«¯å£è½¬ç§»åˆ°waste.listã€‚å¦‚æœä»clear.listæ–‡ä»¶ä¸­æ‰¾åˆ°å½“å‰æ²¡æœ‰è¿æ¥çš„ç¬¬ä¸€ä¸ªç«¯å£ï¼Œåˆ™vm_manager.shè°ƒç”¨vm_connect.shè„šæœ¬å¹¶é€šè¿‡ä»–ä½œä¸ºè¯¥ç«¯å£å·çš„å‚æ•°ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_connect.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh date=$(/usr/bin/date) /usr/bin/echo "#" "$date" "START EXECUTE VM_CONNECT.SH#" #&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;# free_port="$1" input_iface=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep "input_iface" \ |/usr/bin/cut -d "=" -f2) /usr/bin/echo "input_iface=$input_iface" vdi_spice_port=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "vdi_spice_port" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "vdi_spice_port=$vdi_spice_port" count_conn_tryes=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "count_conn_tryes" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "count_conn_tryes=$count_conn_tryes" #&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;# #&lt;CREATE IPTABLES RULES AND SEND SIGNAL TO CONNECT&gt;# /usr/bin/echo "create rule for port" $free_port /usr/sbin/iptables -I INPUT -i $input_iface -p tcp -m tcp --dport \ $free_port -j ACCEPT /usr/sbin/iptables -I OUTPUT -o $input_iface -p tcp -m tcp --sport \ $free_port -j ACCEPT /usr/sbin/iptables -t nat -I PREROUTING -p tcp -i $input_iface --dport \ $vdi_spice_port -j DNAT --to-destination 127.0.0.1:$free_port /usr/bin/echo "RULE ADDED, CONNECT NOW!" #&lt;/CREATE IPTABLES RULES AND SEND SIGNAL TO CONNECT&gt;# #&lt;WAIT CONNECT ESTABLISHED AND ACTIVATE CONNECT TIMER&gt;# while [ $count_conn_tryes -gt 0 ] do if /usr/bin/netstat -nt |/usr/bin/grep ":$free_port" \ |/usr/bin/grep "ESTABLISHED" &gt; /dev/null then /bin/echo "$free_port NOW in use!!!" /usr/bin/sleep 1s /usr/sbin/iptables -t nat -D PREROUTING -p tcp -i $input_iface --dport \ $vdi_spice_port -j DNAT --to-destination 127.0.0.1:$free_port /usr/sbin/iptables -D INPUT -i $input_iface -p tcp -m tcp --dport \ $free_port -j ACCEPT /usr/sbin/iptables -D OUTPUT -o $input_iface -p tcp -m tcp --sport \ $free_port -j ACCEPT /usr/bin/sed -i "/$free_port/d" $SRV_TMP_DIR/conn_wait.list /usr/bin/echo $free_port &gt;&gt; $SRV_TMP_DIR/waste.list return else /usr/bin/echo "$free_port NOT IN USE" /usr/bin/echo "RULE ADDED, CONNECT NOW!" /usr/bin/sleep 1s fi count_conn_tryes=$((count_conn_tryes-1)) done #&lt;/WAIT CONNECT ESTABLISED AND ACTIVATE CONNECT TIMER&gt;# #&lt;IF COUNT HAS EXPIRED. REMOVE IPTABLES RULE AND REVERT \ # VM TO CLEAR.LIST&gt;# /usr/bin/echo "REVERT IPTABLES RULE AND REVERT VM TO CLEAN \ LIST $free_port" /usr/sbin/iptables -t nat -D PREROUTING -p tcp -i $input_iface --dport \ $vdi_spice_port -j DNAT --to-destination 127.0.0.1:$free_port /usr/sbin/iptables -D INPUT -i $input_iface -p tcp -m tcp --dport $free_port \ -j ACCEPT /usr/sbin/iptables -D OUTPUT -o $input_iface -p tcp -m tcp --sport \ $free_port -j ACCEPT /usr/bin/sed -i "/$free_port/d" $SRV_TMP_DIR/conn_wait.list /usr/bin/echo $free_port &gt;&gt; $SRV_TMP_DIR/clear.list #&lt;/COUNT HAS EXPIRED. REMOVE IPTABLES RULE AND REVERT VM \ #TO CLEAR.LIST&gt;# /usr/bin/echo "#" "$date" "END EXECUTE VM_CONNECT.SH#" # Attention! Must Be! sysctl net.ipv4.conf.all.route_localnet=1</span></span></code> </pre><br></div></div><br>  vm_connect.shè„šæœ¬å¼•å…¥äº†é˜²ç«å¢™è§„åˆ™ï¼Œè¿™äº›è§„åˆ™åˆ›å»ºäº†enp5s0æ¥å£çš„æœåŠ¡å™¨ç«¯å£åˆ°ä½äºlo0æœåŠ¡å™¨æ¥å£ä¸Šçš„VMçš„â€œ spiceæ§åˆ¶å°ç«¯å£â€çš„é‡å®šå‘â€œ vdi_spice_portâ€ï¼Œå¹¶ä½œä¸ºå¯åŠ¨å‚æ•°ä¼ é€’ã€‚ è¯¥ç«¯å£å·²è½¬ç§»åˆ°conn_wait.listï¼Œè¯¥VMè¢«è§†ä¸ºæŒ‚èµ·è¿æ¥ã€‚ å·²å°†è§„åˆ™æ·»åŠ ï¼Œç«‹å³è¿æ¥è¡Œå‘é€åˆ°æœåŠ¡å™¨â€œä¿¡å·â€ç«¯å£ä¸Šçš„Client Stationä¼šè¯ï¼Œè¿™æ˜¯è¿è¡Œåœ¨å…¶ä¸Šçš„remote.shè„šæœ¬æ‰€æœŸæœ›çš„ã€‚ è¿æ¥ç­‰å¾…å‘¨æœŸä»¥å°è¯•æ¬¡æ•°å¼€å§‹ï¼Œå°è¯•æ¬¡æ•°ç”±é…ç½®æ–‡ä»¶ä¸­çš„å˜é‡â€œ count_conn_tryesâ€çš„å€¼ç¡®å®šã€‚ åœ¨ncä¼šè¯ä¸­ï¼Œæ¯ç§’é’Ÿéƒ½ä¼šç»™å‡ºå­—ç¬¦ä¸²â€œ RULE ADDEDï¼ŒCONNECT NOWâ€ï¼Œå¹¶æ£€æŸ¥ä¸â€œ spice_consoleâ€ç«¯å£å»ºç«‹çš„è¿æ¥ã€‚ <br><br> å¦‚æœç”±äºè®¾ç½®çš„å°è¯•æ¬¡æ•°è€Œè¿æ¥å¤±è´¥ï¼Œåˆ™å°†spice_consoleç«¯å£ä¼ é€å›clear.listã€‚vm_connect.shçš„æ‰§è¡Œå·²å®Œæˆï¼Œvm_manager.shçš„æ‰§è¡Œå·²æ¢å¤ï¼Œä»è€Œå¼€å§‹äº†æ¸…æ´å‘¨æœŸã€‚ <br><br> å¦‚æœå®¢æˆ·ç«¯å·¥ä½œç«™è¿æ¥åˆ°lo0æ¥å£ä¸Šçš„spice_consoleç«¯å£ï¼Œåˆ™å°†åˆ é™¤åœ¨spiceæœåŠ¡å™¨ç«¯å£å’Œspice_consoleç«¯å£ä¹‹é—´åˆ›å»ºé‡å®šå‘çš„é˜²ç«å¢™è§„åˆ™ï¼Œå¹¶é€šè¿‡ç¡®å®šé˜²ç«å¢™çŠ¶æ€çš„æœºåˆ¶è¿›ä¸€æ­¥ç»´æŠ¤è¯¥è¿æ¥ã€‚ å¦‚æœè¿æ¥æ–­å¼€ï¼Œåˆ™é‡æ–°è¿æ¥åˆ°spice_consoleç«¯å£å°†å¤±è´¥ã€‚  spice_consoleç«¯å£å·²è½¬ç§»åˆ°waste.listï¼Œè¯¥VMè¢«è®¤ä¸ºæ˜¯è„çš„ï¼Œå¹¶ä¸”å¦‚æœä¸è¿›è¡Œæ¸…ç†ï¼Œå°±æ— æ³•è¿”å›åˆ°å¹²å‡€çš„è™šæ‹Ÿæœºæ± ã€‚ å®Œæˆvm_connect.shçš„æ‰§è¡Œï¼Œæ¢å¤æ‰§è¡Œvm_manager.shï¼Œè¿™å°†å¯åŠ¨æ¸…ç†å‘¨æœŸã€‚ <br><br> æ¸…ç†å‘¨æœŸé€šè¿‡æŸ¥çœ‹waste.listæ–‡ä»¶å¼€å§‹ï¼Œå°†å»ºç«‹è¿æ¥çš„è™šæ‹Ÿæœºç«¯å£çš„spice_consoleç¼–å·ä¼ è¾“åˆ°è¯¥æ–‡ä»¶ä¸­ã€‚ ä»åˆ—è¡¨ä¸­çš„æ¯ä¸ªspice_consoleç«¯å£ç¡®å®šæ´»åŠ¨è¿æ¥çš„å­˜åœ¨ã€‚ å¦‚æœæ²¡æœ‰è¿æ¥ï¼Œåˆ™è®¤ä¸ºè¯¥è™šæ‹Ÿæœºå·²ä¸å†ä½¿ç”¨ï¼Œå¹¶ä¸”è¯¥ç«¯å£å·²è½¬ç§»åˆ°recycle.listï¼Œå¹¶ä¸”å¼€å§‹åˆ é™¤è¯¥ç«¯å£æ‰€å±çš„è™šæ‹Ÿæœºï¼ˆè¯·å‚è§ä¸‹æ–‡ï¼‰çš„è¿‡ç¨‹ã€‚ å¦‚æœåœ¨ç«¯å£ä¸Šæ£€æµ‹åˆ°æ´»åŠ¨çš„ç½‘ç»œè¿æ¥ï¼Œåˆ™å‡å®šæ­£åœ¨ä½¿ç”¨è™šæ‹Ÿæœºï¼Œåˆ™ä¸ä¼šå¯¹å…¶æ‰§è¡Œä»»ä½•æ“ä½œã€‚ å¦‚æœæœªæ•²å‡»è¯¥ç«¯å£ï¼Œåˆ™è®¤ä¸ºè¯¥VMå·²å…³é—­ä¸”ä¸å†éœ€è¦ã€‚ ç«¯å£å·²è½¬ç§»åˆ°recycle.listï¼Œå¹¶ä¸”åˆ é™¤è™šæ‹Ÿæœºçš„è¿‡ç¨‹å¼€å§‹ã€‚ ä¸ºæ­¤ï¼Œå°†è°ƒç”¨vm_delete.shè„šæœ¬ï¼Œå¹¶å°†â€œ spice_consoleâ€å·ä½œä¸ºå‚æ•°ä¼ è¾“åˆ°VMç«¯å£ï¼Œè¯¥è„šæœ¬å¿…é¡»åˆ é™¤ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_delete.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #&lt;Set local VARIABLES&gt;# port_to_delete="$1" date=$(/usr/bin/date) #&lt;/Set local VARIABLES&gt;# /usr/bin/echo "# $date START EXECUTE VM_DELETE.SH#" /usr/bin/echo "TRY DELETE VM ON PORT: $vm_port" #&lt;VM NAME SETUP&gt;# vm_name_part1=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep 'base_host' \ |/usr/bin/cut -d'=' -f2) vm_name=$(/usr/bin/echo "$vm_name_part1""-""$port_to_delete") #&lt;/VM NAME SETUP&gt;# #&lt;SHUTDOWN AND DELETE VM&gt;# /usr/bin/virsh destroy $vm_name /usr/bin/virsh undefine $vm_name /usr/bin/rm -f /var/lib/libvirt/images_write/$vm_name.qcow2 /usr/bin/sed -i "/$port_to_delete/d" $SRV_TMP_DIR/recycle.list #&lt;/SHUTDOWN AND DELETE VM&gt;# /usr/bin/echo "VM ON PORT $vm_port HAS BEEN DELETE AND REMOVE" \ "FROM RECYCLE.LIST. EXIT FROM VM_DELETE.SH" /usr/bin/echo "# $date STOP EXECUTE VM_DELETE.SH#" exit</span></span></code> </pre><br></div></div><br> åˆ é™¤è™šæ‹Ÿæœºæ˜¯ä¸€é¡¹éå¸¸ç®€å•çš„æ“ä½œï¼Œvm_delete.shè„šæœ¬ç¡®å®šæ‹¥æœ‰ä½œä¸ºå¯åŠ¨å‚æ•°ä¼ é€’çš„ç«¯å£çš„è™šæ‹Ÿæœºçš„åç§°ã€‚ å¼ºåˆ¶è™šæ‹Ÿæœºåœæ­¢ï¼Œå°†è™šæ‹Ÿæœºä»è™šæ‹Ÿæœºç®¡ç†ç¨‹åºä¸­åˆ é™¤ï¼Œå¹¶åˆ é™¤è¯¥è™šæ‹Ÿæœºçš„è™šæ‹Ÿç¡¬ç›˜ã€‚ ä»recycle.listä¸­åˆ é™¤äº†spice_consoleç«¯å£ã€‚ ç»“æŸvm_delete.shçš„æ‰§è¡Œï¼Œæ¢å¤æ‰§è¡Œvm_manager.sh <br><br> åœ¨ä»æ¸…å•waste.listæ¸…é™¤ä¸å¿…è¦çš„è™šæ‹Ÿæœºçš„æ“ä½œç»“æŸæ—¶ï¼Œè„šæœ¬vm_manager.shå¼€å§‹åœ¨æ± ä¸­åˆ›å»ºè™šæ‹Ÿæœºçš„å‘¨æœŸã€‚ <br><br> è¯¥è¿‡ç¨‹ä»ç¡®å®šå¯ç”¨äºæ‰˜ç®¡çš„spice_consoleç«¯å£å¼€å§‹ã€‚ ä¸ºæ­¤ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶â€œ srv_start_port_poolâ€çš„å‚æ•°ï¼ˆè¯¥å‚æ•°è®¾ç½®è™šæ‹Ÿæœºæ± â€œ spice_consoleâ€çš„èµ·å§‹ç«¯å£ï¼‰å’Œå‚æ•°â€œ srv_pool_sizeâ€ï¼ˆç¡®å®šè™šæ‹Ÿæœºæ•°é‡çš„é™åˆ¶ï¼‰ï¼Œä¾æ¬¡æšä¸¾æ‰€æœ‰å¯èƒ½çš„ç«¯å£å˜é‡ã€‚ å¯¹äºæ¯ä¸ªç‰¹å®šç«¯å£ï¼Œå°†åœ¨clear.listï¼Œwaste.listï¼Œconn_wait.listï¼Œrecycle.listä¸­è¿›è¡Œæœç´¢ã€‚ å¦‚æœåœ¨è¿™äº›æ–‡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªæ–‡ä»¶ä¸­éƒ½æ‰¾åˆ°äº†ç«¯å£ï¼Œåˆ™è¯¥ç«¯å£è¢«è®¤ä¸ºæ˜¯ç¹å¿™çš„å¹¶ä¸”è¢«è·³è¿‡ã€‚ å¦‚æœåœ¨æŒ‡å®šæ–‡ä»¶ä¸­æ‰¾ä¸åˆ°è¯¥ç«¯å£ï¼Œåˆ™å°†å…¶è¾“å…¥åˆ°recycle.listæ–‡ä»¶ä¸­ï¼Œç„¶åå¼€å§‹åˆ›å»ºæ–°è™šæ‹Ÿæœºçš„è¿‡ç¨‹ã€‚ ä¸ºæ­¤ï¼Œè°ƒç”¨vm_create.shè„šæœ¬ï¼Œæ‚¨è¦ä¸ºå…¶åˆ›å»ºVMçš„ç«¯å£çš„spice_consoleå·ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¯¥è„šæœ¬ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_create.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh /usr/bin/echo "#" "$date" "START RUNNING VM_CREATE.SH#" new_vm_port=$1 date=$(/usr/bin/date) a=0 /usr/bin/echo SRV_TMP_DIR=$SRV_TMP_DIR #&lt;SET LOCAL VARIABLES FOR SCRIPT&gt;# base_host=$(/usr/bin/cat /etc/vm_manager.conf |/usr/bin/grep "base_host" \ |/usr/bin/cut -d "=" -f2) /usr/bin/echo "base_host=$base_host" #&lt;/SET LOCAL VARIABLES FOR SCRIPT&gt;# hdd_image_locate() { /bin/echo "Run STEP 1 - hdd_image_locate" hdd_base_image=$(/usr/bin/virsh dumpxml $base_host \ |/usr/bin/grep "source file" |/usr/bin/grep "qcow2" |/usr/bin/head -n 1 \ |/usr/bin/cut -d "'" -f2) if [ -z "$hdd_base_image" ] then /bin/echo "base hdd image not found!" else /usr/bin/echo "hdd_base_image found is a $hdd_base_image. Run next step 2" #&lt; CHECK FOR SNAPSHOT ON BASE HDD &gt;# if [ 0 -eq `/usr/bin/qemu-img info "$hdd_base_image" | /usr/bin/grep -c "Snapshot"` ] then /usr/bin/echo "base image haven't snapshot, run NEXT STEP 3" else /usr/bin/echo "base hdd image have a snapshot, can't use this image" exit fi #&lt;/ CHECK FOR SNAPSHOT ON BASE HDD &gt;# #&lt; CHECK FOR HDD IMAGE IS LINK CLONE &gt;# if [ 0 -eq `/usr/bin/qemu-img info "$hdd_base_image" |/usr/bin/grep -c "backing file" then /usr/bin/echo "base image is not a linked clone, NEXT STEP 4" /usr/bin/echo "Base image check complete!" else /usr/bin/echo "base hdd image is a linked clone, can't use this image" exit fi fi #&lt;/ CHECK FOR HDD IMAGE IS LINK CLONE &gt;# cloning } cloning() { # &lt;Step_1 turn the base VM off &gt;# /usr/bin/virsh shutdown $base_host &gt; /dev/null 2&gt;&amp;1 # &lt;/Step_1 turn the base VM off &gt;# #&lt;Create_vm_config&gt;# /usr/bin/echo "Free port for Spice VM is $new_vm_port" #&lt;Setup_name_for_new_VM&gt;# new_vm_name=$(/bin/echo $base_host"-"$new_vm_port) #&lt;/Setup_name_for_new_VM&gt;# #&lt;Make_base_config_as_clone_base_VM&gt;# /usr/bin/virsh dumpxml $base_host &gt; $SRV_TMP_DIR/$new_vm_name.xml #&lt;Make_base_config_as_clone_base_VM&gt;# ##&lt;Setup_New_VM_Name_in_config&gt;## /usr/bin/sed -i "s%&lt;name&gt;$base_host&lt;/name&gt;%&lt;name&gt;$new_vm_name&lt;/name&gt;%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;/Setup_New_VM_Name_in_config&gt;# #&lt;UUID Changing&gt;# old_uuid=$(/usr/bin/cat $SRV_TMP_DIR/$new_vm_name.xml |/usr/bin/grep "&lt;uuid&gt;") /usr/bin/echo old UUID $old_uuid new_uuid_part1=$(/usr/bin/echo "$old_uuid" |/usr/bin/cut -d "-" -f 1,2) new_uuid_part2=$(/usr/bin/echo "$old_uuid" |/usr/bin/cut -d "-" -f 4,5) new_uuid=$(/bin/echo $new_uuid_part1"-"$new_vm_port"-"$new_uuid_part2) /usr/bin/echo $new_uuid /usr/bin/sed -i "s%$old_uuid%$new_uuid%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;/UUID Changing&gt;# #&lt;Spice port replace&gt;# old_spice_port=$(/usr/bin/cat $SRV_TMP_DIR/$new_vm_name.xml \ |/usr/bin/grep "graphics type='spice' port=") /bin/echo old spice port $old_spice_port new_spice_port=$(/usr/bin/echo "&lt;graphics type='spice' port='$new_vm_port' autoport='no' listen='127.0.0.1'&gt;") /bin/echo $new_spice_port /usr/bin/sed -i "s%$old_spice_port%$new_spice_port%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;/Spice port replace&gt;# #&lt;MAC_ADDR_GENERATE&gt;# mac_new=$(/usr/bin/hexdump -n6 -e '/1 ":%02X"' /dev/random|/usr/bin/sed s/^://g) /usr/bin/echo New Mac is $mac_new #&lt;/MAC_ADDR_GENERATE&gt;# #&lt;GET OLD MAC AND REPLACE&gt;# mac_old=$(/usr/bin/cat $SRV_TMP_DIR/$new_vm_name.xml |/usr/bin/grep "mac address=") /usr/bin/echo old mac is $mac_old /usr/bin/sed -i "s%$mac_old%$mac_new%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;GET OLD MAC AND REPLACE&gt;# #&lt;new_disk_create&gt;# /usr/bin/qemu-img create -f qcow2 -b $hdd_base_image /var/lib/libvirt/images_write/$new_vm_name.qcow2 #&lt;/new_disk_create&gt;# #&lt;attach_new_disk_in_confiig&gt;# /usr/bin/echo hdd base image is $hdd_base_image /usr/bin/sed -i "s%&lt;source file='$hdd_base_image'/&gt;%&lt;source file='/var/lib/libvirt/images_write/$new_vm_name.qcow2'/&gt;%g" $SRV_TMP_DIR/$new_vm_name.xml #&lt;/attach_new_disk_in_confiig&gt;# starting_vm #&lt;/Create_vm config&gt;# } starting_vm() { /usr/bin/virsh define $SRV_TMP_DIR/$new_vm_name.xml /usr/bin/virsh start $new_vm_name while [ $a -ne 1 ] do if /usr/bin/virsh list --all |/usr/bin/grep "$new_vm_name" |/usr/bin/grep "running" &gt; /dev/null 2&gt;&amp;1 then a=1 /usr/bin/sed -i "/$new_vm_port/d" $SRV_TMP_DIR/recycle.list /usr/bin/echo $new_vm_port &gt;&gt; $SRV_TMP_DIR/clear.list /usr/bin/echo "#" "$date" "VM $new_vm_name IS STARTED #" else /usr/bin/echo "#VM $new_vm_name is not ready#" a=0 /usr/bin/sleep 2s fi done /usr/bin/echo "#$date EXIT FROM VM_CREATE.SH#" exit } hdd_image_locate</span></span></code> </pre><br></div></div><br> åˆ›å»ºæ–°è™šæ‹Ÿæœºçš„è¿‡ç¨‹ <br><br>  vm_create.shè„šæœ¬ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–å˜é‡â€œ base_hostâ€çš„å€¼ï¼Œè¯¥å˜é‡ç¡®å®šå°†åŸºäºå…¶è¿›è¡Œå…‹éš†çš„ç¤ºä¾‹è™šæ‹Ÿæœºã€‚ å®ƒä»è™šæ‹Ÿæœºç›‘æ§ç¨‹åºæ•°æ®åº“ä¸­å¸è½½VMçš„xmlé…ç½®ï¼Œå¯¹VMç£ç›˜æ˜ åƒæ‰§è¡Œä¸€ç³»åˆ—æ£€æŸ¥qcowï¼Œå¹¶åœ¨æˆåŠŸå®Œæˆåä¸ºæ–°VMå’Œæ–°VMçš„â€œé“¾æ¥å…‹éš†â€ç£ç›˜æ˜ åƒåˆ›å»ºxmlé…ç½®æ–‡ä»¶ã€‚ ç„¶åï¼Œå°†æ–°VMçš„xmlé…ç½®åŠ è½½åˆ°ç®¡ç†ç¨‹åºæ•°æ®åº“ä¸­ï¼Œç„¶åVMå¯åŠ¨ã€‚  spice_consoleç«¯å£ä»recycle.listè½¬ç§»åˆ°clear.listã€‚  vm_create.shçš„æ‰§è¡Œç»“æŸï¼Œå¹¶ä¸”vm_manager.shçš„æ‰§è¡Œç»“æŸã€‚ <br> ä¸‹æ¬¡è¿æ¥æ—¶ï¼Œå°†ä»å¤´å¼€å§‹ã€‚ <br><br> å¯¹äºç´§æ€¥æƒ…å†µï¼Œè¯¥å·¥å…·åŒ…åŒ…å«è„šæœ¬vm_clear.shï¼Œè¯¥è„šæœ¬ä¼šå¼ºåˆ¶è¿è¡Œæ± ä¸­çš„æ‰€æœ‰VMï¼Œå¹¶é€šè¿‡å°†åˆ—è¡¨çš„å€¼æ¸…é›¶æ¥åˆ é™¤å®ƒä»¬ã€‚ åœ¨åŠ è½½é˜¶æ®µè°ƒç”¨å®ƒå¯ä»¥ä½¿æ‚¨ä»å¤´å¼€å§‹ï¼ˆåœ¨VDIä¸‹ï¼‰ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">/home/admin/scripts_vdi_new/vm_clear.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/sh #set VARIABLES# SRV_SCRIPTS_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_scripts_dir" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_SCRIPTS_DIR=$SRV_SCRIPTS_DIR" export SRV_SCRIPTS_DIR=$SRV_SCRIPTS_DIR SRV_TMP_DIR=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_tmp_dir" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_TMP_DIR=$SRV_TMP_DIR" export SRV_TMP_DIR=$SRV_TMP_DIR SRV_POOL_SIZE=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_pool_size" |/usr/bin/cut -d "=" -f2) /usr/bin/echo "SRV_POOL_SIZE=$SRV_POOL_SIZE" SRV_START_PORT_POOL=$(/usr/bin/cat /etc/vm_manager.conf \ |/usr/bin/grep "srv_start_port_pool" |/usr/bin/cut -d "=" -f2) /usr/bin/echo SRV_START_PORT_POOL=$SRV_START_PORT_POOL #Set VARIABLES# /usr/bin/echo "= Cleanup ALL VM=" /usr/bin/mkdir $SRV_TMP_DIR /usr/sbin/service iptables restart /usr/bin/cat /dev/null &gt; $SRV_TMP_DIR/clear.list /usr/bin/cat /dev/null &gt; $SRV_TMP_DIR/waste.list /usr/bin/cat /dev/null &gt; $SRV_TMP_DIR/recycle.list /usr/bin/cat /dev/null &gt; $SRV_TMP_DIR/conn_wait.list port_to_delete=$(($SRV_START_PORT_POOL+$SRV_POOL_SIZE)) while [ "$port_to_delete" -gt "$SRV_START_PORT_POOL" ] do $SRV_SCRIPTS_DIR/vm_delete.sh $port_to_delete port_to_delete=$(($port_to_delete-1)) done /usr/bin/echo "= EXIT FROM VM_CLEAR.SH="</span></span></code> </pre><br></div></div><br> åœ¨æ­¤ï¼Œæˆ‘æƒ³ç»“æŸæˆ‘çš„æ•…äº‹çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚ ä»¥ä¸Šå†…å®¹è¶³ä»¥è®©ç³»ç»Ÿç®¡ç†å‘˜å°è¯•åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨underVDIã€‚ å¦‚æœç¤¾åŒºè§‰å¾—è¿™ä¸ªè¯é¢˜å¾ˆæœ‰è¶£ï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘å°†è®¨è®ºlivecd Fedoraçš„ä¿®æ”¹åŠå…¶å‘è‡ªåŠ©æœåŠ¡äº­çš„è½¬å˜ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN462203/">https://habr.com/ru/post/zh-CN462203/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN462181/index.html">åœ¨ç¾¤èŠä¸­è¿›è¡Œæœ‰æ•ˆäº¤æµçš„è§„åˆ™</a></li>
<li><a href="../zh-CN462185/index.html">é©å‘½ç»“æŸäº†ã€‚ æœ‰é”‚ç¦»å­ç”µæ± çš„æ›¿ä»£å“å—ï¼Ÿ</a></li>
<li><a href="../zh-CN462189/index.html">ä½¿ç”¨travajsèš€åˆ»æ•°æ®</a></li>
<li><a href="../zh-CN462191/index.html">æ•°æ®è‰ºæœ¯åšç‰©é¦†ï¼šæ„å¤§åˆ©åŒ—éƒ¨ä¹‹æ—…</a></li>
<li><a href="../zh-CN462197/index.html">æœ‰å…³å¦‚ä½•è§£æ”¾æ€æƒ³å¹¶æé«˜åˆ›é€ åŠ›çš„æç¤º</a></li>
<li><a href="../zh-CN462205/index.html">èµ¢å¾—PHDays 9åƒµå±€ï¼šTrue0xA3å›¢é˜Ÿçš„ç¼–å¹´å²</a></li>
<li><a href="../zh-CN462209/index.html">å®åˆ©é€šè§†é¢‘ä¼šè®®è§£å†³æ–¹æ¡ˆã€‚ 6å¹´åçš„å›å¿†...ç¬¬2é˜¶æ®µã€‚ç¬¬1éƒ¨åˆ†ã€‚RMX1500</a></li>
<li><a href="../zh-CN462213/index.html">å­¦ä¹ å’Œå·¥ä½œï¼šä¿¡æ¯æŠ€æœ¯ä¸ç¼–ç¨‹å­¦é™¢çš„æœ¬ç§‘ç”Ÿç»éªŒ</a></li>
<li><a href="../zh-CN462221/index.html">æˆ‘å¯¹Google Playæ„Ÿåˆ°å¤šä¹ˆå¤±æœ›</a></li>
<li><a href="../zh-CN462227/index.html">è«æ–¯ç§‘ï¼Œ8æœˆ9æ—¥-åç«¯æ•…äº‹4.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>