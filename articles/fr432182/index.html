<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ˜€ ğŸ’…ğŸ½ ğŸ““ Nous rÃ©cupÃ©rons le courrier sans sms ni inscription ğŸ¤›ğŸ½ ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦ ğŸš³</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pas mÃªme un mois ne s'Ã©tait Ã©coulÃ© avant que nous dÃ©cidions qu'il Ã©tait temps d'Ã©crire des articles sur la base des rÃ©sultats de nos performances Ã  OF...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Nous rÃ©cupÃ©rons le courrier sans sms ni inscription</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432182/">  Pas mÃªme un mois ne s'Ã©tait Ã©coulÃ© avant que nous dÃ©cidions qu'il Ã©tait temps d'Ã©crire des articles sur la base des rÃ©sultats de nos performances Ã  OFFZONE-2018.  Le premier article sera exÃ©cutÃ© sur la base du rapport de FastTrack Â«Attaque du relais MS Exchange sans sms et enregistrementÂ». <br><br>  Lors de la conduite de RedTeam, l'utilisation du phishing est obligatoire - vous pouvez crÃ©er une excellente protection sur le pÃ©rimÃ¨tre, mais certains utilisateurs conduiront au phishing et donneront Ã  un attaquant la possibilitÃ© d'Ãªtre immÃ©diatement Ã  l'intÃ©rieur du rÃ©seau.  Tout le monde sait que pour le phishing, ils utilisent principalement des liens vers des sites tiers sur lesquels l'utilisateur doit cliquer ou un document avec une macro.  Les services de sÃ©curitÃ© menacÃ©s de sanctions "entraÃ®nent" les utilisateurs en leur disant qu'en aucun cas vous ne devez cliquer sur le bouton "activer le contenu".  Et en principe, il y a du succÃ¨s - les utilisateurs de ce type de mailing sont de moins en moins nombreux.  Mais les attaquants ne restent pas immobiles - le phishing devient de plus en plus intÃ©ressant.  Les clients ont Ã©galement besoin de certains mailings de phishing intÃ©ressants de notre part.  Et nous sommes nous-mÃªmes intÃ©ressÃ©s par le fait que les employÃ©s du Client sont menÃ©s Ã  l'hameÃ§onnage, et nous pourrions leur expliquer ce qu'il faut rechercher lors de la rÃ©ception d'une lettre. <br><a name="habracut"></a><br><h3>  Pourquoi exactement ces mÃ©thodes de phishing? </h3><br>  De nombreuses entreprises utilisent MS Exchange comme serveur de messagerie d'entreprise.  C'est pratique pour l'entreprise, mais aussi pour l'attaquant.  Un attaquant souhaite envoyer des messages Ã  partir du courrier de la victime, ainsi que tÃ©lÃ©charger des lettres.  Nous, en tant que RedTeam, voulons imiter complÃ¨tement les actions d'un attaquant et nous sommes intÃ©ressÃ©s Ã  faire les mÃªmes actions avec le courrier.  Naturellement, dans notre cas, le tÃ©lÃ©chargement du courrier n'est pas complet et le Client en est prÃ©alablement informÃ©.  Pour des informations confidentielles, toutes choses. <br><br>  Pour effectuer ce type d'action, nous avons besoin d'une session de messagerie utilisateur.  La premiÃ¨re chose Ã  penser est de savoir comment intercepter une telle session.  Nous avons dÃ©cidÃ© d'utiliser le bon vieux relais NTLM (car la plupart des entreprises utilisent toujours NTLM).  Oui, dans le cas de Kerberos, cela ne fonctionnera pas - vous pouvez fermer l'article et ne pas lire plus loin. <br><br>  Le relais NTLM est connu depuis longtemps et il existe suffisamment d'implÃ©mentations.  Nous n'avons pas non plus inventÃ© de vÃ©lo et nous avons pris l'une des implÃ©mentations avec GitHub d'Arno0x0x.  Cependant, tout n'Ã©tait pas si simple et j'ai dÃ» en ajouter un peu.  Ã€ savoir: <br><br><ul><li>  faire tout fonctionner avec toutes les versions modernes de Windows OS (ne fonctionne pas sur win10 et win server2016); </li><li>  faire fonctionner avec le dernier Impacket; </li><li>  ajouter un systÃ¨me de journalisation pratique. </li></ul><br>  Une version modifiÃ©e peut Ãªtre trouvÃ©e sur notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> . <br><br>  Les documents Microsoft Office ont Ã©tÃ© choisis comme conteneur de livraison, car ils sont le plus souvent envoyÃ©s par courrier d'entreprise et les utilisateurs les ouvrent.  Et il a Ã©tÃ© dÃ©cidÃ© d'utiliser des sous-documents (SubDocument), car il s'agit d'une opÃ©ration lÃ©gale avec un document, et aucun antivirus ne rÃ©pondra Ã  un tel fichier.  En tant que lien imbriquÃ©, vous pouvez inclure des ressources smb et http.  Les dÃ©tails seront discutÃ©s plus tard. <br><br><h3>  Comment crÃ©er un document de phishing? </h3><br>  Par exemple, considÃ©rons le document complÃ¨tement Â«propreÂ» mydoc3.docx, qui est le document Microsoft Word le plus courant. <br><br><img src="https://habrastorage.org/webt/qh/fz/u4/qhfzu4immrvbunyhhtkquijf_6w.jpeg"><br><br>  Tout document Microsoft Office est une archive zip composÃ©e de xml, qui forment finalement votre beau document.  Afin de crÃ©er un document joint, nous devons apporter des modifications aux fichiers avec l'extension .rels.  Selon la version de MS Office, les modifications doivent Ãªtre apportÃ©es soit dans document.xml.rels ou dans settings.xml.rels.  Cet article dÃ©crit Office 365 et apporte des modifications Ã  settings.xml.rels. <br><br><img src="https://habrastorage.org/webt/gv/l_/el/gvl_el9spieruf3-oi7ebyn8kum.jpeg"><br><br>  En tant que document joint, nous donnons un lien vers la ressource sur laquelle se trouve ce mÃªme document joint.  Dans notre cas, le document joint se trouve sur la ressource smb \\ 127.0.0.1 \ subdoctest \ <br><br><img src="https://habrastorage.org/webt/vo/8e/k6/vo8ek6cjbb3ujb25muzizw3dsis.jpeg"><br><br>  Nous enregistrons les modifications et ouvrons le document reÃ§u.  En cas de succÃ¨s, le document ressemblera Ã  ceci: <br><br><img src="https://habrastorage.org/webt/5s/rd/r6/5srdr6cwcqyckb-wa2hx5fdxfue.jpeg"><br><br>  Cependant, sous cette forme, cela provoque des soupÃ§ons parmi les utilisateurs.  Vous devez le changer un peu et essayer de masquer le lien en utilisant diffÃ©rents styles et couleurs de police blanches. <br><br><img src="https://habrastorage.org/webt/ss/xx/9q/ssxx9qy8acppddbgoxee3bjoi3q.jpeg"><br><br>  En consÃ©quence, nous avons reÃ§u un document complÃ¨tement non suspect, Ã  l'ouverture de lequel Word ira lui-mÃªme Ã  la ressource, qui est enregistrÃ© avec lui en tant que document joint. <br><br><h3>  Et d'oÃ¹ viendra tout? </h3><br>  Le document sera frappÃ© sur votre serveur (en fait, ils devraient lui donner un lien).  Le serveur peut Ãªtre un serveur SMB ou un serveur HTTP (voir les cas ci-dessous).  Cet article ne considÃ¨re qu'un exemple d'envoi d'un message Ã  partir du courrier d'un utilisateur dont nous avons interceptÃ© la session. <br><br>  Pour tout dÃ©marrer, un ensemble minimal suffit - le dernier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Impacket</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MSExchangeRelay</a> et Python2.7. <br>  Nous commenÃ§ons tout avec la commande: <br><br><pre><code class="plaintext hljs">python MsExchangeRelay.py -v -t https://exchange_addr/ews/exchange.asmx -r sendMail -d "example@email.com" -s Hello -m sampleMsg.html -o out.txt</code> </pre> <br><pre> <code class="plaintext hljs">exchange_addr â€“  exchange   example@email.com â€“           . -s Hello â€“   -m sampleMsg.html â€“  ,    -o out.txt â€“    .</code> </pre><br>  AprÃ¨s le dÃ©marrage, les serveurs SMB et HTTP montent sur le serveur, qui attendent une connexion avec eux. <br><br><img src="https://habrastorage.org/webt/fb/v_/gd/fbv_gdeuf-sslphsu7dgwcolhym.jpeg"><br><br>  AprÃ¨s une connexion rÃ©ussie, vous pouvez voir avec quelle connexion et Ã  partir de quelle adresse IP l'utilisateur s'est connectÃ©: <br><br><img src="https://habrastorage.org/webt/b5/ql/nc/b5qlncntglraiglm3ssvhtdactc.jpeg"><br><br><h3>  Comment l'appliquer maintenant? </h3><br>  Vous pouvez utiliser cette mÃ©thode dans diffÃ©rents cas. <br><br>  <b>Cas 1. Intrus externe, le client dispose d'un port 445 sortant</b> <br><br>  Dans ce cas, vous pouvez utiliser le lien vers la ressource smb.  Le charme d'un tel lien est que Windows ne veut plus dÃ©ranger l'utilisateur s'il peut le gÃ©rer lui-mÃªme.  Par consÃ©quent, lorsque vous ouvrez un document avec un lien vers la ressource smb, Windows lui-mÃªme envoie les crÃ©dits de domaine de l'utilisateur Ã  cette ressource.  Autrement dit, rien n'arrive Ã  l'utilisateur.  L'utilisateur ouvre le document.  Et c'est tout.  La suspicion ne cause rien.  Et nous avons dÃ©jÃ  une session de messagerie personnalisÃ©e. <br>  Le port ouvert 445, bien que rare, est toujours trouvÃ©.  Par consÃ©quent, nous le considÃ©rons Ã©galement et le laissons. <br><br>  <b>Cas 2. Intrus interne</b> <br><br><img src="https://habrastorage.org/webt/ua/-n/rt/ua-nrturlt8wmhhttmjpxmtozgq.jpeg" align="left" width="300" height="1000"><br>  Ici, nous appliquons Ã©galement le lien vers la ressource smb.  En cas d'interception rÃ©ussie de la session, la lettre que nous avons indiquÃ©e sera envoyÃ©e Ã  l'adresse postale indiquÃ©e. <br><br>  <b>Cas 3. L'intrus externe et le port sortant 445 sont fermÃ©s</b> <br><br><img src="https://habrastorage.org/webt/rk/hj/z7/rkhjz7iomq_a6g5wbtqeq65eh4q.jpeg" align="left" width="300" height="1000"><br>  Nous pouvons utiliser le lien vers le serveur HTTP.  Cependant, dans ce cas, tout ne sera pas aussi transparent pour l'utilisateur.  Lorsque vous ouvrez le document, l'utilisateur verra une fenÃªtre standard de Windows, qui demande le nom d'utilisateur et le mot de passe de l'utilisateur.  Le moment qui peut dÃ©router l'utilisateur est le nom de domaine evil_http_server - il doit Ãªtre aussi similaire que possible au nom de domaine d'Ã©change du client. <br><br><img src="https://habrastorage.org/webt/qg/mu/q1/qgmuq1qmzgin7fjeiwcrwjh-lug.jpeg" align="left" width="300">  Une fois que l'utilisateur a entrÃ© ses crÃ©dits, nous obtenons sa session et envoyons une lettre. <br><br><br><br><br><br><br><br><h3>  Au lieu d'une conclusion </h3><br>  NTLMRelay peut Ãªtre emballÃ© dans diffÃ©rents conteneurs et proposer des approches complÃ¨tement diffÃ©rentes pour les utilisateurs de phishing.  Alors que NTLM est vivant, ce type d'attaque est Ã©galement vivant.  Alors expÃ©rimentez! <br><br>  PS Merci aux organisateurs d'OFFZONE-2018 pour une excellente confÃ©rence! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432182/">https://habr.com/ru/post/fr432182/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432172/index.html">Invitation dangereuse ou Fonctionnement de la charge de combat pour un e-mail de phishing</a></li>
<li><a href="../fr432174/index.html">Comment dÃ©velopper avec compÃ©tence et efficacitÃ© un produit logiciel</a></li>
<li><a href="../fr432176/index.html">Comment nous avons doublÃ© la vitesse de travail avec Float en Mono</a></li>
<li><a href="../fr432178/index.html">... et une garantie pour les projecteurs - augmenter</a></li>
<li><a href="../fr432180/index.html">Comment pomper votre carriÃ¨re via GitHub</a></li>
<li><a href="../fr432184/index.html">IdentitÃ©s des problÃ¨mes chez les testeurs</a></li>
<li><a href="../fr432186/index.html">Utilisation de STP pour crÃ©er des canaux P2P</a></li>
<li><a href="../fr432188/index.html">Des pirates d'APT28 ont attaquÃ© les boÃ®tes de courrier Ã©lectronique de centaines d'employÃ©s du ministÃ¨re tchÃ¨que</a></li>
<li><a href="../fr432190/index.html">PrÃ©diction physique cÃ´tÃ© client dans Unity</a></li>
<li><a href="../fr432192/index.html">4 signes que vous n'Ãªtes pas prÃªt Ã  mettre en Å“uvre une solution de gestion de projet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>