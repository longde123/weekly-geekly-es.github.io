<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçè üíê üò¥ Crear una API REST con Node.js y una Base de datos Oracle. Parte 5 ‚ôêÔ∏è üë®üèª‚Äçüè´ ‚òùüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parte 5. Crear una API REST: paginaci√≥n, clasificaci√≥n manual y filtrado 

 En el art√≠culo anterior, complet√≥ la creaci√≥n de la funcionalidad principa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Crear una API REST con Node.js y una Base de datos Oracle. Parte 5</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473652/">  <b>Parte 5. Crear una API REST: paginaci√≥n, clasificaci√≥n manual y filtrado</b> <br><br>  En el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo anterior,</a> complet√≥ la creaci√≥n de la funcionalidad principal de la API CRUD. <br><br>  Y ahora, cuando se emite una solicitud HTTP GET en la ruta de los empleados, se devuelven todas las filas de la tabla.  Esto puede no importar mucho con solo 107 filas en la tabla HR.EMPLOYEES, pero imagine lo que suceder√≠a si la tabla contuviera miles o millones de filas.  Los clientes, como las aplicaciones m√≥viles y web, generalmente muestran solo una fracci√≥n de las filas disponibles en la base de datos y luego seleccionan m√°s filas cuando es necesario, tal vez cuando el usuario se desplaza hacia abajo o hace clic en el bot√≥n "Siguiente" en alg√∫n control de interrupci√≥n a p√°ginas en la interfaz de usuario. <br><br>  Para esto, las API REST deben admitir herramientas de paginaci√≥n para los resultados devueltos.  Una vez que se admite la paginaci√≥n, las capacidades de clasificaci√≥n se vuelven necesarias, ya que los datos generalmente se deben clasificar antes de aplicar la paginaci√≥n.  Adem√°s, la herramienta de filtrado de datos es muy importante para el rendimiento.  ¬øPor qu√© enviar datos desde la base de datos, a trav√©s de la capa intermedia y completamente al cliente, si esto no es necesario? <br><a name="habracut"></a><br>  Usar√© los par√°metros de cadena de consulta de URL para que los clientes puedan especificar c√≥mo se deben paginar, clasificar y filtrar los resultados.  Como siempre en la programaci√≥n, la implementaci√≥n puede variar seg√∫n sus requisitos, objetivos de rendimiento, etc. En esta publicaci√≥n le contar√© acerca de un enfoque manual para agregar estas funciones a la API. <br><br>  <b>Paginaci√≥n</b> <br><br>  Consultar los par√°metros de cadena que usar√© para la paginaci√≥n: omitir y limitar.  El par√°metro de omisi√≥n se usar√° para omitir el n√∫mero especificado de l√≠neas, mientras que el l√≠mite limitar√° el n√∫mero de l√≠neas devueltas.  Usar√© el valor predeterminado de 30 para el l√≠mite si el cliente no proporciona el valor. <br><br>  Comience actualizando la l√≥gica del controlador para extraer valores de la cadena de consulta y pasarlos a la API de la base de datos.  Abra el archivo <b>controllers / employee.js</b> y agregue las siguientes l√≠neas de c√≥digo a la funci√≥n get despu√©s de la l√≠nea que analiza el par√°metro req.params.id. <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.params.id is here *** context.skip = parseInt(req.query.skip, 10); context.limit = parseInt(req.query.limit, 10);</span></span></code> </pre> <br>  Ahora necesita actualizar la l√≥gica de la base de datos para tener en cuenta estos valores y actualizar la consulta SQL en consecuencia.  En SQL, la cl√°usula offset se usa para omitir filas, y la cl√°usula fetch se usa para limitar el n√∫mero de filas devueltas por la consulta.  Como de costumbre, los valores no se agregar√°n directamente a la consulta; en cambio, se agregar√°n como variables de enlace por razones de rendimiento y seguridad.  Abra <b>db_apis / employee.js</b> y agregue el siguiente c√≥digo despu√©s del bloque if en la funci√≥n find, que agrega la cl√°usula where a la solicitud. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** if block that appends where clause ends here *** if (context.skip) { binds.row_offset = context.skip; query += '\noffset :row_offset rows'; } const limit = (context.limit &gt; 0) ? context.limit : 30; binds.row_limit = limit; query += '\nfetch next :row_limit rows only';</span></span></code> </pre> <br>  ¬°Esto es todo lo que necesitas hacer para paginar!  Inicie la API y luego ejecute algunos comandos de URL en otra terminal para probarla.  Aqu√≠ hay algunos ejemplos que puede usar: <br><br><pre> <code class="javascript hljs"># use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> limit (<span class="hljs-number"><span class="hljs-number">30</span></span>) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees"</span></span> # set limit to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?limit=5"</span></span> # use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> limit and set skip to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?skip=5"</span></span> # set both skip and limit to <span class="hljs-number"><span class="hljs-number">5</span></span> curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?skip=5&amp;limit=5"</span></span></code> </pre> <br>  <b>Clasificaci√≥n</b> <br><br>  Como m√≠nimo, los clientes deben poder especificar una columna para ordenar y ordenar (ascendente o descendente).  La forma m√°s f√°cil de hacer esto es definir un par√°metro de consulta (usar√© sort), que le permite pasar una cadena como 'last_name: asc' o 'salario: desc'.  La √∫nica forma de garantizar el orden del conjunto de resultados devuelto por la consulta SQL es incluir el orden por cl√°usula.  Por esta raz√≥n, ser√≠a bueno tener una definici√≥n de orden predeterminada definida para garantizar la coherencia cuando el cliente no la especifica. <br><br>  Regrese a <b>controllers / employee.js</b> y agregue la siguiente l√≠nea de c√≥digo a la funci√≥n get despu√©s de la l√≠nea que analiza el par√°metro req.query.limit. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.query.limit is here *** context.sort = req.query.sort;</span></span></code> </pre> <br>  Luego abra <b>db_apis / employee.js</b> y agregue la siguiente l√≠nea debajo de las l√≠neas que declaran e inicializan baseQuery. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** lines that initalize baseQuery end here *** const sortableColumns = ['id', 'last_name', 'email', 'hire_date', 'salary'];</span></span></code> </pre> <br>  sortableColumns es una lista blanca de columnas que los clientes pueden usar para ordenar.  Luego, dentro de la funci√≥n de b√∫squeda, agregue el siguiente bloque if, que agrega el orden por cl√°usula.  Esto debe hacerse despu√©s de agregar la cl√°usula where, pero antes de las cl√°usulas offset y fetch. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** if block that appends where clause ends here *** if (context.sort === undefined) { query += '\norder by last_name asc'; } else { let [column, order] = context.sort.split(':'); if (!sortableColumns.includes(column)) { throw new Error('Invalid "sort" column'); } if (order === undefined) { order = 'asc'; } if (order !== 'asc' &amp;&amp; order !== 'desc') { throw new Error('Invalid "sort" order'); } query += `\norder by "${column}" ${order}`; }</span></span></code> </pre> <br>  La primera parte del bloque if verifica si el cliente pas√≥ el valor de clasificaci√≥n.  De lo contrario, el orden predeterminado por cl√°usula se agrega a la consulta SQL, que se ordena por apellido en orden ascendente.  Si se especifica un valor de clasificaci√≥n, primero se divide en valores de columna y orden, y cada valor se verifica antes de agregar el orden por a la consulta. <br><br>  Ahora puede ejecutar varios comandos de URL para validarlo.  Aqu√≠ hay algunos ejemplos para probar: <br><br><pre> <code class="javascript hljs"># use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> sort (last_name asc) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees"</span></span> # sort by id and use <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> direction (asc) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=id"</span></span> # sort by hire_date desc curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=hire_date:desc"</span></span> # use sort <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> limit and skip together curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?limit=5&amp;skip=5&amp;sort=salary:desc"</span></span> # should <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> an error because first_name is not whitelisted curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=first_name:desc"</span></span> # should <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> an error because <span class="hljs-string"><span class="hljs-string">'other'</span></span> is not a valid order curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?sort=last_name:other"</span></span></code> </pre> <br>  Los √∫ltimos dos ejemplos deber√≠an arrojar excepciones, porque contienen valores que no se hicieron en la lista blanca.  Utiliza el controlador de errores Express est√°ndar, por lo que el error se devuelve como una p√°gina web HTML. <br><br>  <b>Filtrado</b> <br><br>  La capacidad de filtrar datos es una caracter√≠stica importante que todas las API REST deben proporcionar.  Al igual que con la ordenaci√≥n, la implementaci√≥n puede ser simple o compleja seg√∫n lo que desee admitir.  El enfoque m√°s f√°cil es agregar soporte para filtros de coincidencia completa (por ejemplo, last_name = Doe).  Las implementaciones m√°s complejas pueden agregar soporte para operadores b√°sicos (por ejemplo, &lt;,&gt;, instr, etc.) y operadores l√≥gicos complejos (por ejemplo, y / o) que pueden agrupar varios filtros. <br><br>  En esta publicaci√≥n intentar√© simplificar la situaci√≥n y agregar soporte de filtro para solo dos columnas: department_id y manager_id.  Para cada columna, habilitar√© el par√°metro correspondiente en la cadena de consulta.  La l√≥gica de la base de datos que agrega la cl√°usula where cuando las solicitudes GET se env√≠an al punto final con un solo empleado debe actualizarse para tener en cuenta estos nuevos filtros. <br><br>  Abra <b>controllers / employee.js</b> y agregue las siguientes l√≠neas debajo de la l√≠nea que analiza el valor req.query.sort en la funci√≥n get. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that parses req.query.sort is here *** context.department_id = parseInt(req.query.department_id, 10); context.manager_id = parseInt(req.query.manager_id, 10);</span></span></code> </pre> <br>  Luego edite <b>db_apis / employee.js</b> para agregar la oraci√≥n 1 = 1 a la consulta base, como se muestra a continuaci√≥n. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> baseQuery = <span class="hljs-string"><span class="hljs-string">`select employee_id "id", first_name "first_name", last_name "last_name", email "email", phone_number "phone_number", hire_date "hire_date", job_id "job_id", salary "salary", commission_pct "commission_pct", manager_id "manager_id", department_id "department_id" from employees where 1 = 1`</span></span>;</code> </pre> <br>  Por supuesto, 1 = 1 siempre ser√° verdadero, por lo que el optimizador simplemente lo ignorar√°.  Sin embargo, este m√©todo simplificar√° la adici√≥n de predicados adicionales en el futuro. <br><br>  En la funci√≥n de b√∫squeda, reemplace el bloque if, que agrega la cl√°usula where al pasar context.id, con las siguientes l√≠neas. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// *** line that declares 'binds' is here *** if (context.id) { binds.employee_id = context.id; query += '\nand employee_id = :employee_id'; } if (context.department_id) { binds.department_id = context.department_id; query += '\nand department_id = :department_id'; } if (context.manager_id) { binds.manager_id = context.manager_id; query += '\nand manager_id = :manager_id'; }</span></span></code> </pre> <br>  Como puede ver, cada bloque if simplemente agrega el valor pasado al objeto binds, y luego agrega el predicado correspondiente a la cl√°usula where.  Guarde los cambios y reinicie la API.  Luego use estos comandos de URL para verificar esto: <br><br><pre> <code class="javascript hljs"># filter where department_id = <span class="hljs-number"><span class="hljs-number">90</span></span> (returns <span class="hljs-number"><span class="hljs-number">3</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?department_id=90"</span></span> # filter where manager_id = <span class="hljs-number"><span class="hljs-number">100</span></span> (returns <span class="hljs-number"><span class="hljs-number">14</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?manager_id=100"</span></span> # filter where department_id = <span class="hljs-number"><span class="hljs-number">90</span></span> and manager_id = <span class="hljs-number"><span class="hljs-number">100</span></span> (returns <span class="hljs-number"><span class="hljs-number">2</span></span> employees) curl <span class="hljs-string"><span class="hljs-string">"http://localhost:3000/api/employees?department_id=90&amp;manager_id=100"</span></span></code> </pre> <br>  Eso es todo: ¬°la API ahora admite paginaci√≥n, clasificaci√≥n y filtrado!  Un enfoque manual proporciona mucho control, pero requiere mucho c√≥digo.  La funci√≥n de b√∫squeda ahora tiene 58 l√≠neas y solo admite capacidades limitadas de clasificaci√≥n y filtrado.  Puede considerar usar un m√≥dulo, como el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">generador de</a> consultas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Knex.js</a> , para simplificar estas operaciones. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/473652/">https://habr.com/ru/post/473652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../473638/index.html">Shader no es m√°gico. Escribiendo sombreadores en Unity. Introduccion</a></li>
<li><a href="../473640/index.html">Big Data Sunset</a></li>
<li><a href="../473642/index.html">Cribble Crabble Gradle: Auto-Build Magic</a></li>
<li><a href="../473646/index.html">Hackathon en una peque√±a empresa: c√≥mo organizar sin tirar un tren de recursos</a></li>
<li><a href="../473648/index.html">El caballo est√° muerto - llora: transici√≥n de tslint a eslint</a></li>
<li><a href="../473654/index.html">PHP Composer: arregla las dependencias sin dolor</a></li>
<li><a href="../473656/index.html">Experiencia de generador de sitio est√°tico de Hugo</a></li>
<li><a href="../473658/index.html">Manejo de errores en Go 1.13</a></li>
<li><a href="../473660/index.html">Ingenier√≠a inversa de arcade: grabar Michael Jordan en NBA Jam</a></li>
<li><a href="../473664/index.html">Experiencia de aprendizaje de primera mano. Yandex.Practicum - Analista de datos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>