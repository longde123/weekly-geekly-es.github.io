<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÉè ‚ñ´Ô∏è üë®üèø‚Äçüç≥ Eliminar datos de una base de datos compartible üòæ üë©üèæ‚Äçü§ù‚Äçüë©üèΩ üë©üèæ‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un art√≠culo sobre c√≥mo resolver el problema de optimizar el proceso de eliminaci√≥n de archivos de un sistema fragmentado. Se trata de un proyecto para...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Eliminar datos de una base de datos compartible</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427895/"> Un art√≠culo sobre c√≥mo resolver el problema de optimizar el proceso de eliminaci√≥n de archivos de un sistema fragmentado.  Se trata de un proyecto para compartir y trabajar con archivos.  El sistema fue una startup hace unos 8 a√±os, luego se dispar√≥ con √©xito y se vendi√≥ varias veces.  El proyecto tiene 4 desarrolladores que est√°n con el proyecto desde el principio, lo cual es muy valioso.  La documentaci√≥n, tradicionalmente, no ten√≠a tiempo para escribir o no es muy relevante. <br><br>  ¬øPor qu√© leer√≠as esto y por qu√© escrib√≠ todo esto?  Me gustar√≠a hablar sobre un rastrillo que cuidadosamente se encuentra dentro del sistema y se golpea para que las estrellas se salgan de los ojos. <br><br>  Quiero agradecer a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Hanna_Hlushakova</a> por trabajar juntos, poner fin al proyecto y ayudar a preparar el art√≠culo.  B√°sicamente, encontrar√° descripciones del problema y el algoritmo para resolverlo, que utilizamos, no hay ejemplos de c√≥digo, estructuras de datos u otras cosas necesarias.  No s√© si mi experiencia te ayudar√° a evitar un rastrillo en casa, pero espero que obtengas algo √∫til.  Quiz√°s este art√≠culo sea una p√©rdida absolutamente irrevocable de tiempo valioso. <br><br><img src="https://habrastorage.org/webt/lb/p2/s5/lbp2s5dnlsusssfxqfd3zf9aoyk.png"><br><a name="habracut"></a><br><h3>  Sobre el proyecto </h3><br>  El proyecto es uno de los l√≠deres en la plaza Gartner, tiene empresas clientes con m√°s de 300 mil empleados en los EE. UU. Y Europa, y varios miles de millones de archivos para mantenimiento. <br><br>  Las siguientes tecnolog√≠as se utilizan en el proyecto: Microsoft, servidores C # .net, base de datos MS SQL, 14 servidores activos + 14 en modo de reflejo de datos. <br><br>  El volumen de bases de datos es de hasta 4 Tb, la carga constante en horario comercial es de aproximadamente 400 mil solicitudes por minuto. <br><br>  Hay mucha l√≥gica de negocios en la base de datos: <br>  450 mesas <br>  1000 procedimientos almacenados <br>  80,000 l√≠neas de c√≥digo SQL <br>  Tradicionalmente, o no ten√≠an tiempo para escribir la documentaci√≥n, o no es relevante. <br><br><h3>  Sobre la tarea </h3><br>  La tarea es rehacer la eliminaci√≥n de archivos del almacenamiento que ya han sido eliminados por los clientes, y el per√≠odo de almacenamiento de los archivos eliminados ha expirado, en caso de que quieran restaurarlos.  En la versi√≥n actual, de acuerdo con los c√°lculos de la propia empresa, los archivos que se eliminaron hace 1 a√±o se almacenaron en los servidores, aunque de acuerdo con las condiciones comerciales, deber√≠an haberse almacenado solo 1 mes.  Dado que algunos de los archivos se almacenan en S3, la compa√±√≠a pag√≥ por los datos adicionales, y los clientes que usaron el almacenamiento local se preguntaban por qu√© los archivos ocupaban m√°s espacio del que deber√≠an. <br><br>  Bases de datos shardovany para el cliente de la empresa. <br><br><h3>  ¬øC√≥mo funcion√≥ la eliminaci√≥n antes? </h3><br><br><img src="https://habrastorage.org/webt/wy/zx/dq/wyzxdqqakclb2u1kjmtbzl3v39y.png"><br><br>  En un servidor global con informaci√≥n sobre todos los archivos del sistema, se formaron rangos de 15 mil identificadores de archivos. <br><br>  Luego, de acuerdo con el cronograma, se lanz√≥ una encuesta de servidor para una variedad de identificadores de archivos. <br>  Los l√≠mites del rango se transmitieron a cada fragmento. <br><br>  Fragmento en respuesta envi√≥ archivos encontrados desde el rango. <br><br>  El servidor principal agreg√≥ los archivos que faltan a la tabla de cola para su eliminaci√≥n en su base de datos. <br>  Luego, desde la tabla de colas, el servicio de eliminaci√≥n de archivos f√≠sicos del almacenamiento recibi√≥ un grupo de identificadores para su eliminaci√≥n, despu√©s de lo cual envi√≥ una confirmaci√≥n de que iba a eliminar los archivos y se inici√≥ una verificaci√≥n para todos los fragmentos si estos archivos se usaron all√≠. <br>  Con un aumento en la cantidad de archivos, este enfoque comenz√≥ a funcionar muy lentamente, ya que hab√≠a varios miles de millones de archivos y la cantidad de rangos aument√≥ significativamente.  Los archivos eliminados a√∫n permanecen menos del 5% en comparaci√≥n con el n√∫mero total, respectivamente, es muy ineficiente clasificar miles de millones de archivos para encontrar varios millones de archivos eliminados. <br><br>  Por ejemplo, generalmente despu√©s de que un usuario elimina un archivo, debe almacenarse durante 1 mes, en caso de que deba restaurarse.  Despu√©s de este per√≠odo, el programa debe eliminar el archivo del repositorio.  Con el n√∫mero actual de archivos, el n√∫mero de rangos y la velocidad de omisi√≥n de rangos, el servidor tardar√≠a 1 a√±o en omitir completamente todos los rangos. <br>  Est√° claro que el lugar no fue liberado, y esto caus√≥ la insatisfacci√≥n de los usuarios, ya que sus servidores almacenaron muchas veces m√°s archivos de los que deber√≠an haber sido reportados.  La propia empresa de servicios pag√≥ un lugar adicional en S3, que fue una p√©rdida directa para √©l. <br><br>  Solo en S3 cuando comenz√≥ el trabajo, se almacenaron 2 petabytes de archivos eliminados, y esto solo est√° en la nube.  Adem√°s, hab√≠a clientes cuyos archivos estaban almacenados en sus servidores dedicados, que ten√≠an el mismo problema: el espacio del servidor estaba ocupado por archivos borrados por los usuarios pero no borrados del servidor. <br><br><h3>  ¬øQu√© decidiste hacer? </h3><br>  Decidimos rastrear los eventos de eliminaci√≥n: <br><br><ul><li>  el cliente elimin√≥ el archivo y luego expir√≥. </li><li>  el usuario elimin√≥ el archivo inmediatamente sin posibilidad de recuperaci√≥n. </li></ul><br>  Al eliminar un archivo de una base de datos fragmentada, decidimos utilizar un enfoque optimista y eliminar una de las comprobaciones de uso.  Sab√≠amos que el 99% de los archivos se usan solo dentro de un fragmento.  Decidimos agregar inmediatamente el archivo a la cola de eliminaci√≥n, y no verificamos el resto de los fragmentos para el uso de este archivo, ya que la verificaci√≥n se realizar√° nuevamente luego de la confirmaci√≥n del servicio de eliminaci√≥n del repositorio. <br><br>  Adem√°s, dejaron el TRABAJO actual que verific√≥ los archivos eliminados por rangos para agregar archivos que se eliminaron antes del lanzamiento de la nueva versi√≥n. <br><br>  Todo lo que se elimin√≥ en el fragmento se recopila en una tabla y luego se transfiere a un √∫nico servidor, con informaci√≥n sobre todos los archivos. <br><br>  En este servidor, se env√≠a a la tabla de eliminaci√≥n de colas. <br><br>  En la tabla de eliminaci√≥n antes de la eliminaci√≥n, se verifica que el archivo no se use en todos los fragmentos.  Esta parte de la verificaci√≥n estaba aqu√≠ antes del cambio de c√≥digo, y decidieron no tocarlo. <br><br><h4>  ¬øQu√© necesitabas cambiar en el c√≥digo? </h4><br>  En cada uno de los fragmentos, se agreg√≥ una tabla en la que se debe escribir el identificador del archivo eliminado. <br><br>  Encontramos todos los procedimientos para eliminar archivos de la base de datos, solo hubo 2. Despu√©s de que el usuario elimin√≥ el archivo, el archivo a√∫n permanece en la base de datos durante alg√∫n tiempo. <br><br>  En el procedimiento para eliminar un archivo de la base de datos, agregamos una entrada a esta tabla local con archivos eliminados. <br><br>  En el servidor global con archivos, hicieron un TRABAJO que descarga una lista de archivos de bases de datos de fragmentos.  Simplemente llamando a un procedimiento desde una base de datos shardable, hace un DELETE dentro y muestra una lista de archivos en OUTPUT.  En MS SQL Server, la extracci√≥n de un servidor remoto es mucho m√°s r√°pida que la inserci√≥n en un servidor remoto.  Todo esto se hace en bloques. <br>  Estos archivos se agregan a la tabla de eliminaci√≥n de colas en el servidor global. <br>  Se agreg√≥ una tabla con un identificador de fragmento a la tabla de cola para saber de d√≥nde vino el evento de eliminaci√≥n. <br><br><h3>  ¬øC√≥mo lo han probado todos? </h3><br>  Hay 3 ambientes: <br><br>  Dev es un entorno de desarrollo.  El c√≥digo se toma de la rama de desarrollo del gith.  Es posible implementar una versi√≥n diferente del c√≥digo en IIS y hacer varias versiones de orquestaci√≥n.  Se conectar√° al entorno de desarrollo desde el cliente dentro de vpn.  Hasta hace poco, el inconveniente era solo con las bases de datos, ya que todos los cambios en la base de datos pueden interrumpir el trabajo de otras partes del sistema.  Luego las bases se hicieron locales.  El c√≥digo que ya se est√° ejecutando se puede verter en servidores de desarrollo con bases de datos para no arruinar el trabajo de todos.  En un entorno de desarrollo, hay 3 fragmentos, en lugar de 12, que est√°n en la producci√≥n, pero esto suele ser suficiente para probar la interacci√≥n. <br><br>  Puesta en escena: el entorno es el mismo con el producto de acuerdo con la versi√≥n del c√≥digo (casi el mismo, ya que es raro, pero los administradores realizan cambios directamente en el producto).  Una copia del c√≥digo de la rama maestra.  A veces, algunas diferencias con el c√≥digo del producto se detectan en la base de datos, pero en general son id√©nticas.  Tambi√©n hay 3 fragmentos en la puesta en escena, as√≠ como en la doncella.  No hay carga en la puesta en escena, as√≠ como en el desarrollo.  Aqu√≠ puede ejecutar pruebas de integraci√≥n completamente, ya que el c√≥digo coincide con el producto.  Todas las pruebas deben pasar, este es un requisito previo antes de ir a la implementaci√≥n. <br><br>  Perf lab, donde las pruebas se realizan bajo carga.  La carga se crea usando jmeter, 10 veces menos que en el producto, y solo hay un fragmento, lo que a veces crea inconvenientes.  Se toman datos de ventas, luego se anonimizan y se usan en el laboratorio de perf.  Todos los servidores de la misma configuraci√≥n que en prod. <br><br>  La carga es 10 veces menor, porque se supone que esta es una carga aproximada que llega al producto por 1 fragmento.  La desventaja es que la base global est√° muy infrautilizada, a diferencia de las ventas.  Y, si los cambios se refieren principalmente a la base de datos global con archivos, entonces puede confiar en los resultados de la prueba solo aproximadamente; en el producto, esto puede no funcionar as√≠.  Aunque idealmente el laboratorio de rendimiento no coincide con la carga con el producto, la capacidad de realizar pruebas bajo la carga ya ayuda a detectar muchos errores antes de implementarlo en el producto. <br><br>  Tambi√©n hay un servidor de respaldo donde puede ver los datos de la venta para detectar algunos casos.  En general, la compa√±√≠a opera bajo una licencia que proh√≠be a los desarrolladores dar acceso a los datos de ventas y el acceso del equipo de administraci√≥n y soporte (Operaciones) al desarrollo, por lo que debe solicitar la ayuda de los administradores de la base de datos.  Los datos de ventas hacen que las pruebas sean muy f√°ciles, porque algunos casos surgen solo de datos de producci√≥n y es muy √∫til estudiar los datos en un sistema real para comprender c√≥mo funciona el sistema para el usuario. <br><br>  Durante las pruebas en el laboratorio de rendimiento, result√≥ que la carga de eliminar archivos del almacenamiento no se realiz√≥ de la palabra en absoluto.  Al implementar las pruebas de carga, elegimos solicitudes m√°s populares del software del cliente, algunas de las cuales no se incluyeron en la limpieza del almacenamiento.  Como se trata de una base de datos, result√≥ realizar una prueba simplificada para todos los objetos modificados con la llamada de los procedimientos modificados en diferentes datos de forma manual.  (sobre las opciones que conoc√≠a). <br>  Adem√°s, en las pruebas de integraci√≥n y rendimiento, el √©nfasis principal se puso en el tipo m√°s popular de almacenamiento de archivos. <br><br>  Una caracter√≠stica adicional del laboratorio de rendimiento, que no se descubri√≥ de inmediato, es la falta de coincidencia de la cantidad de datos en algunas tablas sobre el producto y el rendimiento.  En el sentido de que todos los JOB de ventas funcionan en el rendimiento, que generan datos, pero no siempre hay algo que procese los datos generados en la tabla.  Y, por ejemplo, la cola de tabla antes mencionada para la eliminaci√≥n en el rendimiento es mucho mayor que en el producto: 20 millones de registros en el rendimiento y 200 mil registros en pro <br><br><h4>  Proceso de implementaci√≥n </h4><br>  El proceso de implementaci√≥n es bastante est√°ndar.  No hubo cambios en el c√≥digo de la aplicaci√≥n para esta tarea, todos los cambios son solo en la base de datos.  Un DBA siempre se incluye en la base de datos; este proceso no est√° automatizado.  Se preparan 2 versiones de scripts: para aplicar cambios y para revertir los cambios, y se escribe una instrucci√≥n para DBA.  Siempre se realizan 2 versiones de los scripts, y necesariamente se prueban para la reversi√≥n y la reversi√≥n de los cambios.  Y estas mismas secuencias de comandos se utilizan para aplicar cambios a la puesta en escena y al laboratorio de rendimiento antes de iniciar la integraci√≥n y las pruebas de carga. <br><br><h3>  ¬øQu√© pas√≥ despu√©s del despliegue? </h3><br>  En las primeras 5 horas despu√©s de la implementaci√≥n, se produjo 1 mill√≥n de eventos en los que el software del cliente recibi√≥ un error al intentar descargar el archivo.  El evento "archivo da√±ado".  Significa que el cliente est√° intentando descargar el archivo, pero el archivo no se encontr√≥ en el repositorio.  Por lo general, estos eventos no son del todo, o se miden en 1 - 2 mil por d√≠a. <br><br>  Debo decir de inmediato que me llev√≥ al menos 1 semana encontrar la causa del fallo en un equipo de 3 y, a veces, 5 personas (incluido yo). <br><br>  Recopilamos la lista completa de archivos para los que se produjo el evento "Archivo da√±ado". <br><br>  A pesar del hecho de que hubo m√°s de 1 mill√≥n de eventos y todos fueron de diferentes usuarios, diferentes compa√±√≠as, solo hab√≠a 250 archivos √∫nicos en esta lista. <br><br>  El DBA en el servidor de respaldo fue generado para investigar los respaldos de la base de datos en el momento en que llegaron los eventos.  Hay bastantes tablas en las bases del proyecto con todo tipo de registros que ayudaron en el an√°lisis.  Incluso al eliminar informaci√≥n de la base de datos, se agrega un registro a lo que se elimin√≥ y por qu√© evento.  En el producto, dichos registros se almacenan durante 1 semana y luego se combinan en el servidor de archivo. <br><br>  Y tambi√©n lo son las tablas con registros que ayudaron mucho a analizar lo que sucedi√≥: <br>  Se mantiene un registro completo con los eventos del cliente en cada fragmento <br><br>  En el servidor global: <br><br><ul><li>  Registro de solicitudes para descargar todos los archivos por parte de los usuarios </li><li>  Registrar la carga de archivos al sistema por parte de los usuarios </li><li>  Registro de eventos de FileCorrupt </li><li>  Archivo de registro para cancelar la eliminaci√≥n del almacenamiento </li><li>  Registro de archivos borrados de la base de datos. </li></ul><br>  Adem√°s, un ELK con registros de aplicaciones estaba disponible. <br><br>  Logramos repetir el error en el entorno de desarrollo, lo que confirm√≥ la exactitud de la suposici√≥n.  Al principio, nadie se tom√≥ en serio esta hip√≥tesis, ya que era muy dif√≠cil creer que tantos factores coincidieran al mismo tiempo y que llegaran tantos usuarios en este momento en particular. <br><br><h3>  ¬øQu√© sali√≥ mal? </h3><br>  Result√≥ que el sistema ten√≠a alrededor de 250 (en comparaci√≥n, miles de millones de archivos en el sistema) super duper mega archivos populares.  250 si! <br><br>  Estos archivos a√∫n eran muy antiguos.  En el momento en que estos archivos se subieron al sistema, se utiliz√≥ otro sistema para generar la clave del archivo para el almacenamiento. <br><br>  Result√≥ que para este tipo de clave, el m√©todo de eliminaci√≥n f√≠sica del almacenamiento f√≠sico se comporta de manera diferente a otros archivos. <br><br>  En la clase con eliminaci√≥n, hay un bloque de c√≥digo con una condici√≥n espec√≠fica para archivos con la clave anterior.  El sistema, en el momento de la eliminaci√≥n, antes de comprobar que el archivo no est√° en fragmentos, mueve este archivo antiguo a otra ubicaci√≥n.  Bueno, eso no funcion√≥. <br><br>  Y result√≥ que en el momento en que se movi√≥ el archivo (y recordar√© que es muy popular), si uno de los usuarios intenta otorgarle un nuevo derecho de usuario, el software del cliente va al almacenamiento de este archivo, pero el archivo no est√° en el lugar correcto.  Como se mueve, eso no funciona.  Y el software del cliente env√≠a un mensaje de que el archivo est√° roto.  En la base de datos, est√° marcado como roto.  Y toda la informaci√≥n se elimina de la base de datos (bueno, casi toda). <br><br>  Mientras tanto, nuestra rutina de comprobaci√≥n de fragmentos descubre que se est√° utilizando el archivo.  Y env√≠a una respuesta que necesita devolverlo.  Pero toda la informaci√≥n ya se ha eliminado de la base de datos y es imposible devolverla. <br><br>  Divertido eh? <br><br>  Es decir, cuando se elimin√≥ el archivo, el usuario estaba en ese per√≠odo de tiempo cuando se movi√≥ el archivo, se verificaron los fragmentos, y fue en este momento que el usuario envi√≥ una solicitud de descarga. <br><br>  Aqu√≠ est√°: alta carga en acci√≥n, cuando coinciden los partidos m√°s incre√≠bles. <br><br><img src="https://habrastorage.org/webt/_y/m6/me/_ym6meu2s43ds32d1ngjzspn67k.png"><br><br>  Tras recuperarnos de la sorpresa y revertir todo, nos aseguramos de que los archivos de los usuarios est√©n vivos, ya que fueron restaurados de los discos de otros clientes. <br><br>  Naturalmente, todo estuvo bien en las pruebas, porque durante la prueba los archivos m√°s nuevos se eliminaron con un nuevo tipo de clave que se utiliz√≥ en los √∫ltimos 5 a√±os. Estos archivos no se transfieren a otra ubicaci√≥n de almacenamiento durante el tiempo de eliminaci√≥n. <br><br>  Nuestro optimismo disminuy√≥ y decidimos no seguir el camino m√°s optimista. <br><br><h3>  Retrospectiva </h3><br>  Decidimos que necesitamos agregar pruebas para diferentes tipos de almacenamientos <br>  Agregue una carga al laboratorio de rendimiento que utiliza llamadas cuando se elimina del almacenamiento <br>  Cerrar condiciones de carrera famosas <br>  Agregue monitoreo (aunque estar√≠a en los planes, pero no encaja en el alcance original) <br><br><h3>  Sobre el monitoreo </h3><br>  Decidieron hacer un monitoreo de inmediato, pero luego se desvaneci√≥ en el fondo, ya que era necesario implementarlo m√°s r√°pido. <br><br>  Para el monitoreo, el proyecto utiliz√≥ Zabbix, ELK, Grafana, NewRelic, SQL Sentry y una versi√≥n de prueba de AppDynamics. <br><br>  De esto, en pef lab estaba NewRelic y SQL Sentry. <br><br>  Ya medimos todas las m√©tricas del sistema y, por lo tanto, quer√≠amos medir las m√©tricas comerciales.  Ten√≠a experiencia organizando ese monitoreo a trav√©s de Zabbix; decidimos hacer lo mismo. <br><br>  El esquema es muy simple en la base de datos para crear una tabla en la que recopilar las m√©tricas necesarias por TRABAJO y un procedimiento que cargar√° las m√©tricas recopiladas en Zabbix. <br><br>  M√©tricas: <br><br><ul><li>  El n√∫mero de archivos en la cola para su eliminaci√≥n a nivel mundial </li><li>  N√∫mero de archivos en cola por servidor </li><li>  El n√∫mero de archivos enviados al programa de desinstalaci√≥n desde el repositorio </li><li>  Cantidad de archivos borrados </li><li>  N√∫mero de eventos de FileCorrupt </li><li>  El n√∫mero de archivos a eliminar en cada fragmento </li></ul><br>  El monitoreo se implement√≥ y se implement√≥ en el producto por separado, antes de que comenzaran a implementar una nueva implementaci√≥n de eliminaci√≥n. <br><br><h3>  Nueva soluci√≥n </h3><br>  En general, decidimos que era mejor comer en exceso que no dormir, e hicimos un nuevo plan. <br><br><ol><li>  compruebe el mismo fragmento en el que ya nadie usa el archivo con seguridad y transfiera solo los archivos no utilizados al servidor; </li><li>  al transferir al servidor, recopile todos los archivos de la tabla y verifique que los archivos no se usen en fragmentos antes de colocarlos en la tabla de cola de espera; </li><li>  cuando use un archivo y lo busque en el sistema, marque la cola de espera en la tabla como un archivo que requiere verificaci√≥n; </li><li>  devolver solo archivos para los que no hubo b√∫squedas; </li><li>  archivos que se buscaron, vuelva a verificar si hay fragmentos; </li><li>  en general, elimine la marca de verificaci√≥n en el procedimiento que elimina el archivo, ya que deber√≠a funcionar r√°pidamente, y el archivo usado no deber√≠a alcanzarlo en principio; </li><li>  tenga en cuenta en el procedimiento que todo lo eliminado por el archivo batido que est√° en proceso de eliminaci√≥n, y no elimine informaci√≥n sobre √©l. </li></ol><br>  El punto 6 durante el despliegue incluy√≥ la eliminaci√≥n del cheque en varias etapas.  Primero, dejaron el cheque, luego, una semana despu√©s, el cheque en los archivos de los empleados de la compa√±√≠a se apag√≥, despu√©s de 2 semanas, el cheque se apag√≥ por completo. <br><br><h3>  ¬øQu√© necesitabas cambiar en el c√≥digo? </h3><br>  Nuevamente, todos los cambios se aplican solo a la base de datos. <br><br>  La escala de los cambios fue la mayor en el servidor global: <br>  Agregue una tabla intermedia en la que agregar todos los archivos descargados de los fragmentos. <br>  Haga un TRABAJO que verifique los archivos en la tabla intermedia que no se usan en fragmentos. <br><br>  En la cola de archivos eliminados, agregue un campo con la fecha en que se accedi√≥ al archivo por √∫ltima vez y agregue un √≠ndice. <br><br>  Encuentre todos los procedimientos con acceso al archivo: result√≥ 5 procedimientos.  Agregue un bloque que cambie la fecha del √∫ltimo uso en la tabla de la cola.  La fecha cambia cada vez, independientemente de si se complet√≥ o no. <br><br>  Agregue el programa de eliminaci√≥n a los procedimientos de emisi√≥n de archivos para que muestre solo los archivos con una fecha de uso vac√≠a. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregue un TRABAJO que recopile todos los archivos con la fecha de uso y las comprobaciones (con un retraso de 10 minutos, lo cual es necesario para que el software del cliente pueda agregar el archivo al fragmento, generalmente demora hasta 2 minutos, pero decidi√≥ hacerlo de manera segura) use el archivo en todos los fragmentos. Una vez completada la verificaci√≥n, la fecha de uso se restablece si no se encuentra el archivo; de lo contrario, el archivo se elimina de la cola. Si la fecha de uso ha cambiado durante el proceso de verificaci√≥n, los datos no cambian ya que se supone que mientras la verificaci√≥n estaba en progreso, el archivo podr√≠a cargarse en el fragmento, en el que la verificaci√≥n ya se hab√≠a completado y se requer√≠a un nuevo ciclo de verificaci√≥n para el archivo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fragmentos:</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el procedimiento que elimina archivos de la tabla con archivos eliminados, tuvo que agregar una verificaci√≥n de que el archivo no se utiliz√≥. </font><font style="vertical-align: inherit;">El procedimiento ha perdido su simplicidad y belleza no mucho: en ELIMINAR con salida simplemente agregaron NO EXISTE. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregamos un TRABAJO, que en el fondo golpe√≥ desde los archivos de la tabla utilizados en el servidor.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pruebas </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se agregaron escenarios sobre el uso de todas las opciones de almacenamiento a las pruebas de integraci√≥n. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n escribieron nuevos casos para probar la nueva funcionalidad de eliminaci√≥n de archivos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perf Lab agreg√≥ carga al servidor global. </font><font style="vertical-align: inherit;">Adem√°s, agregamos una carga correspondiente a la eliminaci√≥n de archivos del almacenamiento.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Implementar </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se prepararon secuencias de comandos para la aplicaci√≥n y la reversi√≥n de cambios para la base de datos. </font><font style="vertical-align: inherit;">DBA lanz√≥ scripts y result√≥ que durante las pruebas de carga no prestaron atenci√≥n a los bloqueos en las tablas de colas para eliminar archivos. </font><font style="vertical-align: inherit;">Como resultado, no arreglamos el √≠ndice, que no era el m√°s √≥ptimo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debido a esto, era necesario deshabilitar las comprobaciones de TRABAJO por rangos y analizar y agregar identificadores de archivos eliminados manualmente, de acuerdo con los archivos que se eliminaron en el sistema antes de la implementaci√≥n del nuevo c√≥digo.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Resultados </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, como resultado de la implementaci√≥n, los nuevos archivos eliminados se eliminan del almacenamiento dentro de las 24 horas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los archivos eliminados antes del lanzamiento del nuevo sistema se crearon en la copia de seguridad y se agregaron a la cola para producci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, se elimin√≥ el exceso de datos en S3 en la cantidad de 2 petabytes. </font><font style="vertical-align: inherit;">Lo mismo sucedi√≥ con los archivos en servidores de clientes dedicados, y ahora su lugar en el servidor coincide con el lugar que se muestra en sus clientes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El √≠ndice curvo en la tabla de la cola todav√≠a vive en prod, la tarea de cambiar el √≠ndice en la cartera de pedidos, pero se pospuso ligeramente debido a tareas m√°s prioritarias.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427895/">https://habr.com/ru/post/es427895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427879/index.html">C√≥mo cambi√© de Python a Julia (y por qu√©)</a></li>
<li><a href="../es427883/index.html">Presentaci√≥n de virtualizaci√≥n, contenedores y Kubernetes: 18 recursos en la nube</a></li>
<li><a href="../es427889/index.html">¬°Incorrecto, incorrecto, INCORRECTO! m√©todos de mitigaci√≥n de DDoS</a></li>
<li><a href="../es427891/index.html">Millones de personas pueden ser atacadas a trav√©s de la vulnerabilidad en la plataforma de conferencia Cisco WebEx</a></li>
<li><a href="../es427893/index.html">Bloody Lola en Omega 2 o Python asfixiante en Halloween</a></li>
<li><a href="../es427897/index.html">An√°lisis de un generador de im√°genes de resonancia magn√©tica II: metamateriales en resonancia magn√©tica</a></li>
<li><a href="../es427899/index.html">JsonWriterSax: una biblioteca para crear JSON</a></li>
<li><a href="../es427901/index.html">C√≥mo no usar Node.js Stream API</a></li>
<li><a href="../es427905/index.html">Miner√≠a de alimentos o encrucijada a trav√©s de los ojos de un hacker</a></li>
<li><a href="../es427907/index.html">Tiro con drones, rastrillo, trucos de vida, autodesarrollo y carrera de un fot√≥grafo / camar√≥grafo: nuevo podcast GLPH</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>