<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíº ‚úîÔ∏è ‚ô•Ô∏è Cr√©ation d'une machine d'arcade d'√©mulation. 3e partie üÜô üë®üèæ üöñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Parties un et deux . 

 √âmulateur de processeur 8080 
 Coque d'√©mulateur 
 Vous devriez maintenant avoir toutes les connaissances n√©cessaires pour com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cr√©ation d'une machine d'arcade d'√©mulation. 3e partie</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/418699/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ec/e50/f3a/4ece50f3a555bfb39878326ec26addd5.jpg" alt="image"></div><br>  Parties <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deux</a> . <br><br><h1>  √âmulateur de processeur 8080 </h1><br><h1>  Coque d'√©mulateur </h1><br>  Vous devriez maintenant avoir toutes les connaissances n√©cessaires pour commencer √† cr√©er un √©mulateur de processeur 8080. <br><br>  <em>Je vais essayer de rendre mon code aussi clair que possible, chaque opcode est impl√©ment√© s√©par√©ment.</em>  <em>Lorsque vous vous sentirez √† l'aise avec celui-ci, vous voudrez peut-√™tre le r√©√©crire pour optimiser les performances ou r√©utiliser le code.</em> <br><br>  Pour commencer, je vais cr√©er une structure m√©moire qui contiendra des champs pour tout ce qui me paraissait n√©cessaire lors de l'√©criture d'un d√©sassembleur.  Il y aura √©galement une place pour un tampon de m√©moire, qui sera de la RAM. <br><a name="habracut"></a><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConditionCodes</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> z:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> s:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> p:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> cy:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> ac:<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> pad:<span class="hljs-number"><span class="hljs-number">3</span></span>; } ConditionCodes; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State8080</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> a; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> b; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> d; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> e; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> h; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> l; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sp; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> pc; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *memory; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConditionCodes</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cc</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> int_enable; } State8080;</code> </pre> <br>  Cr√©ez maintenant une proc√©dure avec un appel d'erreur qui mettra fin au programme avec une erreur.  Cela ressemblera √† ceci: <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnimplementedInstruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State8080* state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// pc    ,     printf ("Error: Unimplemented instruction\n"); exit(1); } int Emulate8080Op(State8080* state) { unsigned char *opcode = &amp;state-&gt;memory[state-&gt;pc]; switch(*opcode) { case 0x00: UnimplementedInstruction(state); break; case 0x01: UnimplementedInstruction(state); break; case 0x02: UnimplementedInstruction(state); break; case 0x03: UnimplementedInstruction(state); break; case 0x04: UnimplementedInstruction(state); break; /*....*/ case 0xfe: UnimplementedInstruction(state); break; case 0xff: UnimplementedInstruction(state); break; } state-&gt;pc+=1; //  }</span></span></code> </pre> <br>  Impl√©mentons quelques opcodes. <br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emulate8080Op</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State8080* state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *opcode = &amp;state-&gt;memory[state-&gt;pc]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(*opcode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">//NOP -  ! case 0x01: //LXI B, state-&gt;c = opcode[1]; state-&gt;b = opcode[2]; state-&gt;pc += 2; //   2  break; /*....*/ case 0x41: state-&gt;b = state-&gt;c; break; //MOV B,C case 0x42: state-&gt;b = state-&gt;d; break; //MOV B,D case 0x43: state-&gt;b = state-&gt;e; break; //MOV B,E } state-&gt;pc+=1; }</span></span></code> </pre> <br>  Voil√†.  Pour chaque opcode, nous changeons l'√©tat et la m√©moire, comme le ferait une commande ex√©cut√©e sur un vrai 8080. <br><br>  Le 8080 a environ 7 types, selon la fa√ßon dont vous les classifiez: <br><br><ul><li>  Transfert de donn√©es </li><li>  Arithm√©tique </li><li>  Logique </li><li>  Succursales </li><li>  Pile </li><li>  Entr√©e-sortie </li><li>  Sp√©cial </li></ul><br>  Examinons chacun d'eux individuellement. <br><br><h1>  Groupe arithm√©tique </h1><br>  Les instructions arithm√©tiques sont parmi les 256 opcodes du processeur 8080, qui incluent diff√©rents types d'addition et de soustraction.  La plupart des instructions arithm√©tiques fonctionnent avec le registre A et enregistrent le r√©sultat dans A. (Le registre A est √©galement appel√© accumulateur). <br><br>  Il est int√©ressant de noter que ces commandes affectent les codes de condition.  Les codes d'√©tat (√©galement appel√©s drapeaux) sont d√©finis en fonction du r√©sultat de la commande ex√©cut√©e.  Toutes les commandes n'affectent pas les drapeaux et toutes les √©quipes affectant les drapeaux n'affectent pas tous les drapeaux √† la fois. <br><br><h3>  Drapeaux 8080 </h3><br>  Dans un processeur 8080, les drapeaux sont appel√©s Z, S, P, CY et AC. <br><br><ul><li>  Z (z√©ro, z√©ro) prend la valeur 1 lorsque le r√©sultat est nul </li><li>  S (signe) prend la valeur 1 lorsque le bit 7 (le bit le plus significatif, le bit le plus significatif, MSB) de la commande math√©matique est donn√© </li><li>  P (parit√©, parit√©) est d√©fini lorsque le r√©sultat est pair et est r√©initialis√© lorsqu'il est impair </li><li>  CY (report) prend la valeur 1 lorsque, √† la suite de la commande, un transfert ou un emprunt dans un bit d'ordre √©lev√© est effectu√© </li><li>  AC (Auxillary carry) est principalement utilis√© pour les math√©matiques BCD (d√©cimal cod√© binaire).  Pour plus de d√©tails, consultez le manuel, dans Space Invaders, cet indicateur n'est pas utilis√©. </li></ul><br>  Les codes d'√©tat sont utilis√©s dans les commandes de branchement conditionnel, par exemple, JZ ex√©cute le branchement uniquement si l'indicateur Z est d√©fini. <br><br>  La plupart des instructions ont trois formes: pour les registres, pour les valeurs imm√©diates et pour la m√©moire.  Impl√©mentons quelques instructions pour comprendre leurs formulaires et voir √† quoi ressemble le travail avec les codes d'√©tat.  (Notez que je n'impl√©mente pas l'indicateur de transfert auxiliaire car il n'est pas utilis√©. Si je l'ai impl√©ment√©, je ne pourrais pas le tester.) <br><br><h4>  Formulaire d'inscription </h4><br>  Voici un exemple d'impl√©mentation de deux instructions avec un formulaire d'enregistrement;  dans le premier, j'ai d√©ploy√© le code pour en faciliter la compr√©hension et dans le second, une forme plus compacte qui fait la m√™me chose est pr√©sent√©e. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span>: <span class="hljs-comment"><span class="hljs-comment">//ADD B { //      , //      uint16_t answer = (uint16_t) state-&gt;a + (uint16_t) state-&gt;b; //  :    , //    , //      if ((answer &amp; 0xff) == 0) state-&gt;cc.z = 1; else state-&gt;cc.z = 0; //  :   7 , //    , //      if (answer &amp; 0x80) state-&gt;cc.s = 1; else state-&gt;cc.s = 0; //   if (answer &gt; 0xff) state-&gt;cc.cy = 1; else state-&gt;cc.cy = 0; //    state-&gt;cc.p = Parity( answer &amp; 0xff); state-&gt;a = answer &amp; 0xff; } //  ADD     case 0x81: //ADD C { uint16_t answer = (uint16_t) state-&gt;a + (uint16_t) state-&gt;c; state-&gt;cc.z = ((answer &amp; 0xff) == 0); state-&gt;cc.s = ((answer &amp; 0x80) != 0); state-&gt;cc.cy = (answer &gt; 0xff); state-&gt;cc.p = Parity(answer&amp;0xff); state-&gt;a = answer &amp; 0xff; }</span></span></code> </pre> <br>  J'√©mule des commandes math√©matiques 8 bits avec un nombre 16 bits.  Cela facilite le suivi des cas o√π les calculs g√©n√®rent un report. <br><br><h4>  Formulaire pour les valeurs imm√©diates </h4><br>  La forme des valeurs imm√©diates est presque la m√™me, sauf que l'octet apr√®s la commande est la source de l'ajout.  Puisque ¬´opcode¬ª est un pointeur vers la commande en cours en m√©moire, opcode [1] sera imm√©diatement l'octet suivant. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xC6</span></span>: <span class="hljs-comment"><span class="hljs-comment">//ADI  { uint16_t answer = (uint16_t) state-&gt;a + (uint16_t) opcode[1]; state-&gt;cc.z = ((answer &amp; 0xff) == 0); state-&gt;cc.s = ((answer &amp; 0x80) != 0); state-&gt;cc.cy = (answer &gt; 0xff); state-&gt;cc.p = Parity(answer&amp;0xff); state-&gt;a = answer &amp; 0xff; }</span></span></code> </pre> <br><h4>  Forme pour la m√©moire </h4><br>  Dans le formulaire pour la m√©moire, un octet sera ajout√© auquel l'adresse stock√©e dans une paire de registres HL indique. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x86</span></span>: <span class="hljs-comment"><span class="hljs-comment">//ADD M { uint16_t offset = (state-&gt;h&lt;&lt;8) | (state-&gt;l); uint16_t answer = (uint16_t) state-&gt;a + state-&gt;memory[offset]; state-&gt;cc.z = ((answer &amp; 0xff) == 0); state-&gt;cc.s = ((answer &amp; 0x80) != 0); state-&gt;cc.cy = (answer &gt; 0xff); state-&gt;cc.p = Parity(answer&amp;0xff); state-&gt;a = answer &amp; 0xff; }</span></span></code> </pre> <br><h3>  Remarques </h3><br>  Les instructions arithm√©tiques restantes sont impl√©ment√©es de mani√®re similaire.  Ajouts: <br><br><ul><li>  Dans diff√©rentes versions avec carry (ADC, ACI, SBB, SUI), conform√©ment au manuel de r√©f√©rence, nous utilisons des bits de carry dans les calculs. </li><li>  INX et DCX affectent les paires de registres; ces commandes n'affectent pas les indicateurs. </li><li>  DAD est une autre commande d'une paire de registres, elle n'affecte que le drapeau de report </li><li>  INR et DCR n'affectent pas l'indicateur de portage </li></ul><br><h1>  Groupe de succursales </h1><br>  Apr√®s avoir trait√© les codes d'√©tat, le groupe de succursales deviendra suffisamment clair pour vous.  Il existe deux types de branchement: les transitions (JMP) et les appels (CALL).  JMP d√©finit simplement le PC √† la valeur de la destination de saut.  CALL est utilis√© pour les routines, il √©crit l'adresse de retour dans la pile, puis attribue au PC l'adresse de destination.  RET revient de CALL, re√ßoit l'adresse de la pile et l'√©crit sur le PC. <br><br>  JMP et CALL vont uniquement aux adresses absolues cod√©es en octets apr√®s l'opcode. <br><br><h3>  Jmp </h3><br>  La commande JMP se branche inconditionnellement √† l'adresse de destination.  Il existe √©galement des commandes de branchement conditionnelles pour tous les codes d'√©tat (sauf pour AC): <br><br><ul><li>  JNZ et JZ pour z√©ro </li><li>  JNC et JC pour la migration </li><li>  JPO et JPE pour la parit√© </li><li>  JP (plus) et JM (moins) pour le signe </li></ul><br>  Voici une impl√©mentation de certains d'entre eux: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc2</span></span>: <span class="hljs-comment"><span class="hljs-comment">//JNZ  if (0 == state-&gt;cc.z) state-&gt;pc = (opcode[2] &lt;&lt; 8) | opcode[1]; else //    state-&gt;pc += 2; break; case 0xc3: //JMP  state-&gt;pc = (opcode[2] &lt;&lt; 8) | opcode[1]; break;</span></span></code> </pre> <br><h3>  APPEL et RET </h3><br>  CALL pousse l'adresse de l'instruction sur la pile apr√®s l'appel, puis saute √† l'adresse de destination.  RET re√ßoit l'adresse de la pile et l'enregistre sur le PC.  Des versions conditionnelles de CALL et RET existent pour tous les √©tats. <br><br><ul><li>  CZ, CNZ, RZ, RNZ pour z√©ro </li><li>  CNC, CC, RNC, RC pour le transfert </li><li>  CPO, CPE, RPO, RPE pour la parit√© </li><li>  CP, CM, RP, RM pour signe </li></ul><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xcd</span></span>: <span class="hljs-comment"><span class="hljs-comment">//CALL  { uint16_t ret = state-&gt;pc+2; state-&gt;memory[state-&gt;sp-1] = (ret &gt;&gt; 8) &amp; 0xff; state-&gt;memory[state-&gt;sp-2] = (ret &amp; 0xff); state-&gt;sp = state-&gt;sp - 2; state-&gt;pc = (opcode[2] &lt;&lt; 8) | opcode[1]; } break; case 0xc9: //RET state-&gt;pc = state-&gt;memory[state-&gt;sp] | (state-&gt;memory[state-&gt;sp+1] &lt;&lt; 8); state-&gt;sp += 2; break;</span></span></code> </pre> <br><h3>  Remarques </h3><br><ul><li>  La commande PCHL saute inconditionnellement √† une adresse dans une paire de registres HL. </li><li>  Je n'ai pas inclus le RST discut√© pr√©c√©demment dans ce groupe.  Il √©crit l'adresse de retour dans la pile, puis saute √† l'adresse pr√©d√©finie au bas de la m√©moire. </li></ul><br><h1>  Groupe logique </h1><br>  Ce groupe effectue des op√©rations logiques (voir le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">premier post du</a> tutoriel).  De par leur nature, ils sont similaires √† un groupe arithm√©tique dans la mesure o√π la plupart des op√©rations fonctionnent avec le registre A (lecteur) et la plupart des op√©rations affectent les indicateurs.  Toutes les op√©rations sont effectu√©es sur des valeurs 8 bits, dans ce groupe, il n'y a pas de commandes affectant les paires de registres. <br><br><h3>  Op√©rations bool√©ennes </h3><br>  ET, OU, NON (CMP) et "exclusif ou" (XOR) sont appel√©s op√©rations bool√©ennes.  OU et ET je l'ai expliqu√© plus t√¥t.  La commande NOT (pour le processeur 8080, elle est appel√©e CMA ou accumulateur compl√©mentaire) modifie simplement les valeurs de bits - toutes les unit√©s deviennent des z√©ros et les z√©ros deviennent des unit√©s. <br><br>  Je per√ßois XOR comme un ¬´identificateur de diff√©rence¬ª.  Sa table de v√©rit√© ressemble √† ceci: <br><br><table><tbody><tr><td>  x </td><td>  y </td><td>  R√©sultat </td></tr><tr><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  0 </td><td>  1 </td><td>  1 </td></tr><tr><td>  1 </td><td>  0 </td><td>  1 </td></tr><tr><td>  1 </td><td>  1 </td><td>  0 </td></tr></tbody></table><br>  AND, OR et XOR ont une forme pour les registres, la m√©moire et les valeurs imm√©diates.  (CMP n'a qu'une commande sensible √† la casse).  Voici une impl√©mentation d'une paire d'opcodes: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x2F</span></span>: <span class="hljs-comment"><span class="hljs-comment">//CMA (not) state-&gt;a = ~state-&gt;a //  ,  CMA     break; case 0xe6: //ANI  { uint8_t x = state-&gt;a &amp; opcode[1]; state-&gt;cc.z = (x == 0); state-&gt;cc.s = (0x80 == (x &amp; 0x80)); state-&gt;cc.p = parity(x, 8); state-&gt;cc.cy = 0; //  ,  ANI  CY state-&gt;a = x; state-&gt;pc++; //   } break;</span></span></code> </pre> <br><h3>  Commandes de changement cyclique </h3><br>  Ces commandes modifient l'ordre des bits dans les registres.  Un d√©calage vers la droite les d√©place d'un bit vers la droite, et un d√©calage vers la gauche - d'un bit vers la gauche: <br><br> <code>  (0b00010000) = 0b00001000</code> <br> <br> <code>  (0b00000001) = 0b00000010</code> <br> <br>  Ils semblent √™tre sans valeur, mais en r√©alit√© ce n'est pas le cas.  Ils peuvent √™tre utilis√©s pour se multiplier et se diviser par des puissances de deux.  Prenons l'exemple du d√©calage vers la gauche.  <code>0b00000001</code> est d√©cimal 1, et le d√©placer vers la gauche fait <code>0b00000010</code> , c'est-√†-dire d√©cimal 2. Si nous effectuons un autre d√©calage vers la gauche, nous obtenons <code>0b00000100</code> , soit 4. Un autre d√©calage vers la gauche, et nous multiplions par 8. Cela fonctionnera avec n'importe quel en chiffres: 5 ( <code>0b00000101</code> ) lorsqu'il est d√©cal√© vers la gauche donne 10 ( <code>0b00001010</code> ).  Un autre d√©calage vers la gauche donne 20 ( <code>0b00010100</code> ).  Un d√©calage vers la droite fait de m√™me, mais pour la division. <br><br>  Le 8080 n'a pas de commande de multiplication, mais il peut √™tre impl√©ment√© √† l'aide de ces commandes.  Si vous comprenez comment proc√©der, vous recevrez des points bonus.  Une fois une telle question m'a √©t√© pos√©e lors d'un entretien.  (Je l'ai fait, m√™me si cela m'a pris quelques minutes.) <br><br>  Ces commandes font tourner le lecteur de mani√®re cyclique et n'affectent que le drapeau de transport.  Voici quelques commandes: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x0f</span></span>: <span class="hljs-comment"><span class="hljs-comment">//RRC { uint8_t x = state-&gt;a; state-&gt;a = ((x &amp; 1) &lt;&lt; 7) | (x &gt;&gt; 1); state-&gt;cc.cy = (1 == (x&amp;1)); } break; case 0x1f: //RAR { uint8_t x = state-&gt;a; state-&gt;a = (state-&gt;cc.cy &lt;&lt; 7) | (x &gt;&gt; 1); state-&gt;cc.cy = (1 == (x&amp;1)); } break;</span></span></code> </pre> <br><h3>  Comparaison </h3><br>  La t√¢che de CMP et CPI est uniquement de d√©finir des drapeaux (pour la ramification).  Ils le font en soustrayant les drapeaux, mais pas en stockant le r√©sultat. <br><br><ul><li>  De m√™me: si deux nombres sont √©gaux, alors le drapeau Z est d√©fini, car leur soustraction l'un de l'autre donne z√©ro. </li><li>  Sup√©rieur √†: si A est sup√©rieur √† la valeur compar√©e, alors l'indicateur CY est effac√© (car la soustraction peut √™tre effectu√©e sans emprunter). </li><li>  Plus petit: si A est inf√©rieur √† la valeur compar√©e, alors l'indicateur CY est d√©fini (car A doit terminer l'emprunt pour terminer la soustraction). </li></ul><br>  Il existe des versions de ces commandes pour les registres, la m√©moire et les valeurs imm√©diates.  L'impl√©mentation est une simple soustraction sans enregistrer le r√©sultat: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xfe</span></span>: <span class="hljs-comment"><span class="hljs-comment">//CPI  { uint8_t x = state-&gt;a - opcode[1]; state-&gt;cc.z = (x == 0); state-&gt;cc.s = (0x80 == (x &amp; 0x80)); //  ,    p -   state-&gt;cc.p = parity(x, 8); state-&gt;cc.cy = (state-&gt;a &lt; opcode[1]); state-&gt;pc++; } break;</span></span></code> </pre> <br><h3>  CMC et STC </h3><br>  Ils compl√®tent le groupe logique.  Ils sont utilis√©s pour d√©finir et effacer le drapeau de transport. <br><br><h1>  Groupe d'entr√©es-sorties et commandes sp√©ciales </h1><br>  Ces commandes ne peuvent √™tre attribu√©es √† aucune autre cat√©gorie.  Je vais les mentionner par souci d'exhaustivit√©, mais il me semble que nous devrons y revenir lorsque nous commencerons √† √©muler le mat√©riel de Space Invaders. <br><br><ul><li>  EI et DI activent ou d√©sactivent la capacit√© du processeur √† g√©rer les interruptions.  J'ai ajout√© l'indicateur interrupt_enabled √† la structure d'√©tat du processeur et je l'ai d√©fini / r√©initialis√© √† l'aide de ces commandes. </li><li>  Il semble que RIM et SIM soient principalement utilis√©s pour les E / S s√©rie.  Si vous √™tes int√©ress√©, vous pouvez lire le manuel, mais ces commandes ne sont pas utilis√©es dans Space Invaders.  Je ne les imiterai pas. </li><li>  HLT est un arr√™t.  Je ne pense pas que nous ayons besoin de l'√©muler, mais vous pouvez appeler votre code quit (ou exit (0)) lorsque vous voyez cette commande. </li><li>  IN et OUT sont des commandes que l'√©quipement du processeur 8080 utilise pour communiquer avec un √©quipement externe.  Pendant que nous les impl√©mentons, mais ils ne feront que sauter leur octet de donn√©es.  (Plus tard, nous y reviendrons). </li><li>  NOP est ¬´aucune op√©ration¬ª.  Une des applications de NOP est de contr√¥ler la synchronisation du panneau (il faut quatre cycles CPU pour s'ex√©cuter). </li></ul><br>  Une autre application de NOP est la modification de code.  Disons que nous devons changer le code ROM du jeu.  Nous ne pouvons pas simplement supprimer les opcodes inutiles, car nous ne voulons pas modifier toutes les commandes CALL et JMP (elles seront incorrectes si au moins une partie du code se d√©place).  Avec NOP, nous pouvons nous d√©barrasser du code.  <em>Ajouter du code est beaucoup plus difficile!</em>  <em>Vous pouvez l'ajouter en trouvant de l'espace quelque part dans la ROM et en changeant la commande en JMP.</em> <br><br><h1>  Groupe de pile </h1><br>  Nous avons d√©j√† termin√© la m√©canique de la plupart des √©quipes du groupe stack.  Si vous avez fait le travail avec moi, ces commandes seront faciles √† impl√©menter. <br><br><h3>  PUSH et POP </h3><br>  PUSH et POP ne fonctionnent qu'avec des paires de registres.  PUSH √©crit une paire de registres dans la pile, et POP prend 2 octets du haut de la pile et les √©crit dans une paire de registres. <br><br>  Il existe quatre opcodes pour PUSH et POP, un pour chacune des paires: BC, DE, HL et PSW.  PSW est une paire sp√©ciale de registres d'indicateurs de lecteur et de codes d'√©tat.  Voici mon impl√©mentation de PUSH et POP pour BC et PSW.  Il n'y a pas de commentaires - je ne pense pas qu'il y ait quelque chose de particuli√®rement d√©licat ici. <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xc1</span></span>: <span class="hljs-comment"><span class="hljs-comment">//POP B { state-&gt;c = state-&gt;memory[state-&gt;sp]; state-&gt;b = state-&gt;memory[state-&gt;sp+1]; state-&gt;sp += 2; } break; case 0xc5: //PUSH B { state-&gt;memory[state-&gt;sp-1] = state-&gt;b; state-&gt;memory[state-&gt;sp-2] = state-&gt;c; state-&gt;sp = state-&gt;sp - 2; } break; case 0xf1: //POP PSW { state-&gt;a = state-&gt;memory[state-&gt;sp+1]; uint8_t psw = state-&gt;memory[state-&gt;sp]; state-&gt;cc.z = (0x01 == (psw &amp; 0x01)); state-&gt;cc.s = (0x02 == (psw &amp; 0x02)); state-&gt;cc.p = (0x04 == (psw &amp; 0x04)); state-&gt;cc.cy = (0x05 == (psw &amp; 0x08)); state-&gt;cc.ac = (0x10 == (psw &amp; 0x10)); state-&gt;sp += 2; } break; case 0xf5: //PUSH PSW { state-&gt;memory[state-&gt;sp-1] = state-&gt;a; uint8_t psw = (state-&gt;cc.z | state-&gt;cc.s &lt;&lt; 1 | state-&gt;cc.p &lt;&lt; 2 | state-&gt;cc.cy &lt;&lt; 3 | state-&gt;cc.ac &lt;&lt; 4 ); state-&gt;memory[state-&gt;sp-2] = psw; state-&gt;sp = state-&gt;sp - 2; } break;</span></span></code> </pre> <br><h3>  SPHL et XTHL </h3><br>  Il y a deux autres √©quipes dans le groupe de pile - SPHL et XTHL. <br><br><ul><li>  <code>SPHL</code> d√©place HL vers SP (for√ßant SP √† obtenir une nouvelle adresse). </li><li>  <code>XTHL</code> √©change ce qui se trouve au sommet de la pile avec ce qui se trouve dans une paire de registres HL.  Pourquoi auriez-vous besoin de faire cela?  Je ne sais pas. </li></ul><br><h1>  Un peu plus sur les nombres binaires </h1><br>  Lors de l'√©criture d'un programme informatique, l'une des d√©cisions que vous devez prendre est de choisir le type de donn√©es utilis√©es pour les nombres - si vous voulez qu'ils soient n√©gatifs et quelle devrait √™tre leur taille maximale.  Pour l'√©mulateur de CPU, nous avons besoin que le type de donn√©es corresponde au type de donn√©es du CPU cible. <br><br><h3>  Sign√© et non sign√© </h3><br>  Lorsque nous avons commenc√© √† parler de nombres hexad√©cimaux, nous les avons consid√©r√©s comme non sign√©s - c'est-√†-dire que chaque chiffre binaire du nombre hexad√©cimal avait une valeur positive, et chacun √©tait consid√©r√© comme une puissance de deux (unit√©s, deux, quatre, etc.). <br><br>  Nous avons trait√© la question du stockage informatique des nombres n√©gatifs.  Si vous savez que les donn√©es en question ont un signe, c'est-√†-dire qu'elles peuvent √™tre n√©gatives, alors vous pouvez reconna√Ætre un nombre n√©gatif par le bit le plus significatif du nombre (bit le plus significatif, MSB).  Si la taille des donn√©es est d'un octet, alors chaque nombre avec une valeur de bit MSB donn√©e est n√©gatif, et chacun avec un MSB z√©ro est positif. <br><br>  La valeur d'un nombre n√©gatif est stock√©e sous forme de code suppl√©mentaire.  Si nous avons un nombre sign√©, et que le MSB est √©gal √† un, et que nous voulons savoir ce qu'est ce nombre, alors nous pouvons le convertir comme suit: effectuez le "NON" binaire pour les nombres hexad√©cimaux, puis ajoutez-en un. <br><br>  Par exemple, pour un nombre hexad√©cimal 0x80, le bit MSB est d√©fini, c'est-√†-dire qu'il est n√©gatif.  Le ¬´NON¬ª binaire du nombre 0x80 est 0x7f, ou d√©cimal 127. 127 + 1 = 128. Autrement dit, 0x80 en d√©cimal est -128.  Deuxi√®me exemple: 0xC5.  Pas (0xC5) = 0x3A = d√©cimal 58 +1 = d√©cimal 59. Autrement dit, 0xC5 est d√©cimal -59. <br><br>  Ce qui est surprenant dans les nombres avec du code suppl√©mentaire, c'est que nous pouvons effectuer des calculs avec eux comme avec des nombres non sign√©s, et ils <em>fonctionneront</em> toujours.  L'ordinateur n'a rien √† faire de sp√©cial avec les panneaux.  Je vais montrer quelques exemples pour le prouver. <br><br><pre>  Exemple 1<font></font>
<font></font>
      d√©cimal hex binaire    
       -3 0xFD 1111 1101    
    + 10 0x0A +0000 1010    
    ----- -----------    
        7 0x07 1 0000 0111    
                        ^ Ceci est enregistr√© dans le bit de retenue<font></font>
<font></font>
    Exemple 2    <font></font>
<font></font>
      d√©cimal hex binaire    
      -59 0xC5 1100 0101    
    + 33 0x21 +0010 0001    
    ----- -----------    
      -26 0xE6 1110 0110 </pre><br><br>  Dans l'exemple 1, nous voyons que l'ajout de 10 et de -3 r√©sultats dans 7. Le r√©sultat de l'addition a √©t√© transf√©r√©, de sorte que l'indicateur C peut √™tre d√©fini. Dans l'exemple 2, le r√©sultat de l'addition √©tait n√©gatif, nous d√©codons donc ceci: Non (0xE6) = 0x19 = 25 + 1 = 26. <code>0xE6 = -26</code> Explosion du cerveau! <br><br>  Si vous le souhaitez, en savoir plus sur le code suppl√©mentaire sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Wikipedia</a> . <br><br><h3>  Types de donn√©es </h3><br>  En C, il existe une relation entre les types de donn√©es et le nombre d'octets utilis√©s pour ce type.  En fait, nous ne nous int√©ressons qu'aux entiers.  Les types de donn√©es C standard / old school sont char, int et long, ainsi que leurs amis unsigned char, unsigned int et unsigned long.  Le probl√®me est que sur diff√©rentes plates-formes et dans diff√©rents compilateurs, ces types peuvent avoir des tailles diff√©rentes. <br><br>  Par cons√©quent, il est pr√©f√©rable de s√©lectionner un type de donn√©es pour notre plateforme qui d√©clare explicitement la taille des donn√©es.  Si votre plate-forme poss√®de stdint.h, vous pouvez utiliser int8_t, uint8_t, etc. <br><br>  La taille d'un entier d√©termine le nombre maximum pouvant y √™tre stock√©.  Dans le cas d'entiers non sign√©s, vous pouvez stocker des nombres de 0 √† 255 en 8 bits. Si vous traduisez en hexad√©cimal, alors c'est de 0x00 √† 0xFF.  √âtant donn√© que 0xFF a "tous les bits d√©finis" et qu'il correspond √† 255 d√©cimal, il est tout √† fait logique que l'intervalle d'un entier non sign√© √† un octet soit 0-255.  Les intervalles nous indiquent que toutes les tailles d'entiers fonctionneront exactement de la m√™me mani√®re - les nombres correspondent au nombre obtenu lorsque tous les bits sont d√©finis. <br><br><table><tbody><tr><th>  Tapez </th><th>  Intervalle </th><th>  Hex </th></tr><tr><td>  8 bits non sign√© </td><td>  0-255 </td><td>  0x0-0xFF </td></tr><tr><td>  8 bits sign√© </td><td>  -128-127 </td><td>  0x80-0x7F </td></tr><tr><td>  16 bits non sign√© </td><td>  0-65535 </td><td>  0x0-0xFFFF </td></tr><tr><td>  16 bits sign√©s </td><td>  -32768-32767 </td><td>  0x8000-0x7FFF </td></tr><tr><td>  32 bits non sign√© </td><td>  0-4294967295 </td><td>  0x0-0xFFFFFFFFFF </td></tr><tr><td>  Sign√© 32 bits </td><td>  -2147483648-2147483647 </td><td>  0x80000000-0x7FFFFFFF </td></tr></tbody></table><br>  Encore plus int√©ressant, -1 dans chaque type de donn√©es sign√© est un nombre dont tous les bits sont d√©finis (0xFF pour l'octet sign√©, 0xFFFF pour le num√©ro sign√© 16 bits et 0xFFFFFFFF pour le num√©ro sign√© 32 bits).  Si les donn√©es sont consid√©r√©es comme non sign√©es, alors pour tous les bits donn√©s, le nombre maximum possible pour ce type de donn√©es est obtenu. <br><br>  Pour √©muler les registres du processeur, nous s√©lectionnons le type de donn√©es correspondant √† la taille de ce registre.  Il vaut probablement la peine de s√©lectionner les types non sign√©s par d√©faut et de les convertir lorsque vous devez les consid√©rer comme sign√©s.  Par exemple, nous utilisons le type de donn√©es uint8_t pour repr√©senter un registre 8 bits. <br><br><h3>  Astuce: utilisez un d√©bogueur pour convertir les types de donn√©es </h3><br>  Si gdb est install√© sur votre plateforme, il est tr√®s pratique de l'utiliser pour travailler avec des nombres binaires.  Ci-dessous, je vais montrer un exemple - dans la session ci-dessous, les lignes commen√ßant par # sont des commentaires que j'ai ajout√©s plus tard. <br><br> <code>#  /c,   gdb      <br> (gdb) print /c 0xFD <br> $1 = -3 '?' <br> <br> #  /x,   gdb    hex <br> #   "p"  "print" <br> (gdb) p /c 0xA <br> $2 = 10 '\n' <br> <br> #    2  " " <br> (gdb) p /c 0xC5 <br> $3 = -59 '?' <br> (gdb) p /c 0xC5+0x21 <br> $4 = -26 '?' <br> <br> #  print  ,  gdb    <br> (gdb) p 0x21 <br> $9 = 33 <br> <br> #     ,     gdb, <br> #  ,      <br> (gdb) p 0xc5 <br> $5 = 197 # <br> (gdb) p /c 0xc5 <br> $3 = -59 '?' # <br> (gdb) p 0xfd <br> $6 = 253 <br> <br> #        (   32- ) <br> (gdb) p /x -3 <br> $7 = 0xfffffffd <br> <br> #   1     <br> (gdb) print (char) 0xff <br> $1 = -1 '?' <br> #   1     <br> (gdb) print (unsigned char) 0xff <br> $2 = 255 '?'</code> <br> <br>  Lorsque je travaille avec des nombres hexad√©cimaux, je le fais toujours dans gdb - et cela arrive presque tous les jours.  Tellement plus facile que d'ouvrir la calculatrice d'un programmeur avec une interface graphique.  Sur les machines Linux (et Mac OS X), pour d√©marrer une session gdb, ouvrez simplement un terminal et entrez ¬´gdb¬ª.  Si vous utilisez Xcode sur OS X, apr√®s avoir d√©marr√© le programme, vous pouvez utiliser la console √† l'int√©rieur de Xcode (celle vers laquelle la sortie printf est sortie).<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sous Windows, le d√©bogueur gdb est disponible aupr√®s de Cygwin. </font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Terminaison de l'√©mulateur de CPU </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s avoir re√ßu toutes ces informations, vous √™tes pr√™t pour un long voyage. </font><font style="vertical-align: inherit;">Vous devez d√©cider comment impl√©menter l'√©mulateur - soit cr√©er une √©mulation 8080 compl√®te, soit impl√©menter uniquement les commandes n√©cessaires pour terminer le jeu. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous d√©cidez de faire une √©mulation compl√®te, vous aurez besoin de quelques outils suppl√©mentaires. </font><font style="vertical-align: inherit;">J'en parlerai dans la prochaine section. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une autre fa√ßon est d'√©muler uniquement les instructions utilis√©es par le jeu. </font><font style="vertical-align: inherit;">Nous continuerons √† remplir cette √©norme construction de commutateur que nous avons cr√©√©e dans la section Emulator Shell. </font><font style="vertical-align: inherit;">Nous r√©p√©terons le processus suivant jusqu'√† ce que nous ayons une seule commande non r√©alis√©e:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lancez l'√©mulateur avec ROM Space Invaders </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'appel se </font></font><code>UnimplementedInstruction()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">termine si la commande n'est pas pr√™te</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âmuler cette instruction </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Goto 1 </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La premi√®re chose que j'ai faite en commen√ßant √† √©crire mon √©mulateur a √©t√© d'ajouter du code √† partir de mon d√©sassembleur. </font><font style="vertical-align: inherit;">J'ai donc pu sortir une commande qui devrait √™tre ex√©cut√©e comme suit:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Emulate8080Op</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(State8080* state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *opcode = &amp;state-&gt;memory[state-&gt;pc]; Disassemble8080Op(state-&gt;memory, state-&gt;pc); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (*opcode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>: <span class="hljs-comment"><span class="hljs-comment">//NOP /* ... */ } /*    */ printf("\tC=%d,P=%d,S=%d,Z=%d\n", state-&gt;cc.cy, state-&gt;cc.p, state-&gt;cc.s, state-&gt;cc.z); printf("\tA $%02x B $%02x C $%02x D $%02x E $%02x H $%02x L $%02x SP %04x\n", state-&gt;a, state-&gt;b, state-&gt;c, state-&gt;d, state-&gt;e, state-&gt;h, state-&gt;l, state-&gt;sp); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai √©galement ajout√© du code √† la fin pour afficher tous les registres et drapeaux d'√©tat. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonne nouvelle: pour approfondir le programme de 50 000 √©quipes, nous n'avons besoin que d'un sous-ensemble des opcodes 8080. Je vais m√™me vous donner une liste des opcodes qui doivent √™tre impl√©ment√©s:</font></font><br><br><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Opcode </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L'√©quipe </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x00 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nop </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x01 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LXI B, D16 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x05 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DCR B </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x06 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI B, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x09 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Papa b </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x0d </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DCR C </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x0e </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI C, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x0f </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rrc </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x11 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LXI D, D16 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x13 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inx d </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x19 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Papa d </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x1a </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LDAX D </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x21 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LXI H, D16 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x23 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inx h </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x26 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI H, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x29 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Papa h </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x31 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LXI SP, D16 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x32 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> STA adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x36 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI M, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x3a </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lda adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x3e </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MVI A, D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x56 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV D, M </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x5e </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV E, M </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x66 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV H, M </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x6f </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV L, A </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x77 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV M, A </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x7a </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV A, D </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x7b </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV A, E </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x7c </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV A, H </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x7e </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MOV A, M </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xa7 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ANA A </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xaf </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> XRA A </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pop b </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc2 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jnz adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jmp adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc5 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH B </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc6 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ADI D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xc9 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ret </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xcd </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Appeler adr </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xd1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pop d </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xd3 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OUT D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xd5 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH D </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xe1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pop h </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xe5 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH H </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xe6 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ANI D8 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xeb </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Xchg </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xf1 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> POP PSW </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xf5 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PUSH PSW </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xfb </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ei </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0xfe </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPI D8 </font></font></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ce ne sont que 50 instructions, et 10 d'entre elles sont des mouvements qui sont mis en ≈ìuvre de mani√®re triviale. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> D√©bogage </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais j'ai de mauvaises nouvelles. </font><font style="vertical-align: inherit;">Votre √©mulateur ne fonctionnera certainement pas correctement et les bogues dans ce code sont tr√®s difficiles √† trouver. </font><font style="vertical-align: inherit;">Si vous savez quelle commande se comporte mal (par exemple, une transition ou un appel qui va vers du code sans signification), vous pouvez essayer de corriger l'erreur en examinant votre code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En plus d'examiner le code, il existe un autre moyen de r√©soudre le probl√®me - en comparant votre √©mulateur avec celui qui fonctionne exactement. </font><font style="vertical-align: inherit;">Nous supposons qu'un autre √©mulateur fonctionne toujours correctement, et toutes les diff√©rences sont des bogues dans votre √©mulateur. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez utiliser mon √©mulateur. </font><font style="vertical-align: inherit;">Vous pouvez les ex√©cuter manuellement en parall√®le. </font><font style="vertical-align: inherit;">Vous pouvez gagner du temps si vous int√©grez mon code dans votre projet pour obtenir le processus suivant:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©ez un √©tat pour votre √©mulateur </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cr√©er un √©tat pour le mien </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pour la prochaine √©quipe </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Appeler votre √©mulateur avec votre √©tat </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Appeler le mien avec ma fortune </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comparez nos deux √©tats </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Recherche d'erreurs dans les diff√©rences </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> goto 3 </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une autre fa√ßon consiste √† utiliser manuellement </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ce site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Il s'agit d'un √©mulateur de processeur Javascript 8080 qui comprend m√™me des ROM Space Invaders. </font><font style="vertical-align: inherit;">Voici le processus:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Red√©marrez l'√©mulation Space Invaders en cliquant sur le bouton Space Invaders </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Appuyez sur le bouton "Ex√©cuter 1" pour ex√©cuter la commande. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous ex√©cutons la commande suivante dans notre √©mulateur </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comparez l'√©tat du processeur avec le v√¥tre </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si les conditions correspondent, passez √† 2 </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si les conditions ne correspondent pas, votre √©mulation d'instructions est erron√©e. </font><font style="vertical-align: inherit;">Corrigez-le, puis recommencez √† partir de l'√©tape 1.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai utilis√© cette m√©thode au d√©but pour d√©boguer mon √©mulateur 8080. Je ne mentirai pas - le processus peut √™tre long. En cons√©quence, beaucoup de mes probl√®mes se sont r√©v√©l√©s √™tre des erreurs de frappe et de copier-coller, qui apr√®s la d√©tection √©taient tr√®s faciles √† r√©soudre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous ex√©cutez votre code √©tape par √©tape, la plupart des 30 000 premi√®res instructions sont ex√©cut√©es dans un cycle d'environ 1a5f $. Si vous regardez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">javascript</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans l' </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">√©mulateur</font></a><font style="vertical-align: inherit;"> , vous pouvez voir que ce code copie des donn√©es √† l'√©cran. Je suis s√ªr que ce code est appel√© souvent. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apr√®s le premier rendu de l'√©cran, apr√®s 50 000 commandes, le programme se retrouve coinc√© dans cette boucle sans fin:</font></font><br><br><pre> <code class="hljs pgsql"> <span class="hljs-number"><span class="hljs-number">0</span></span>ada LDA <span class="hljs-meta"><span class="hljs-meta">$20</span></span>c0 <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> ANA A <span class="hljs-number"><span class="hljs-number">0</span></span>ade JNZ <span class="hljs-meta"><span class="hljs-meta">$0</span></span>ada</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il attend que la valeur en m√©moire √† $ 20c0 passe √† z√©ro. </font><font style="vertical-align: inherit;">√âtant donn√© que le code de cette boucle ne change pas exactement $ 20c0, il doit s'agir d'un signal venant d'ailleurs. </font><font style="vertical-align: inherit;">Il est temps de parler d'√©muler le ¬´fer¬ª d'une machine d'arcade. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avant de passer √† la section suivante, assurez-vous que votre √©mulateur de processeur tombe dans cette boucle sans fin. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour r√©f√©rence, voir </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mes sources</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √âmulation compl√®te 8080 </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une le√ßon qui m'a co√ªt√© cher: ne mettez pas en place des √©quipes que vous ne pouvez pas tester. </font><font style="vertical-align: inherit;">Il s'agit d'une bonne r√®gle de base pour tout logiciel en cours de d√©veloppement. </font><font style="vertical-align: inherit;">Si vous ne v√©rifiez pas l'√©quipe, elle sera d√©finitivement cass√©e. </font><font style="vertical-align: inherit;">Et plus vous vous √©loignez de sa mise en ≈ìuvre, plus il sera difficile de trouver des probl√®mes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il existe une autre solution si vous souhaitez cr√©er un √©mulateur 8080 complet et vous assurer qu'il fonctionne. </font><font style="vertical-align: inherit;">J'ai d√©couvert un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code pour 8080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appel√© cpudiag.asm, con√ßu pour tester chaque commande de processeur 8080. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je vous pr√©sente ce processus apr√®s le premier pour plusieurs raisons:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je voulais que la description de ce processus soit r√©p√©t√©e pour un autre processeur. </font><font style="vertical-align: inherit;">Je ne pense pas que l'analogue de cpudiag.asm existe pour tous les processeurs.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme vous pouvez le voir, le processus est assez laborieux. </font><font style="vertical-align: inherit;">Je pense qu'un novice dans le d√©bogage du code assembleur rencontrera de grandes difficult√©s si ces √©tapes ne sont pas r√©pertori√©es.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est ainsi que j'ai utilis√© ce test avec mon √©mulateur. </font><font style="vertical-align: inherit;">Vous pouvez l'utiliser ou trouver une meilleure fa√ßon de l'int√©grer.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Assemblage de test </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai essay√© deux ou trois choses, mais j'ai donc d√©cid√© d'utiliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cette belle page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">J'ai coll√© le texte cpudiag.asm dans le volet gauche et la construction s'est termin√©e sans aucun probl√®me. </font><font style="vertical-align: inherit;">Il m'a fallu une minute pour comprendre comment t√©l√©charger le r√©sultat, mais en cliquant sur le bouton ¬´Make Beautiful Code¬ª en bas √† gauche, j'ai t√©l√©charg√© un fichier appel√© test.bin, qui est le code compil√© 8080. J'ai pu le v√©rifier √† l'aide de mon d√©sassembleur. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T√©l√©chargez cpudiag.asm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> depuis le miroir de mon site Web. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">T√©l√©chargez cpudiag.bin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (code compil√© 8080) depuis mon site.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> T√©l√©chargement d'un test sur mon √©mulateur </font></font></h3><br>    invaders.*     . <br><br>    . -,       <code>ORG 00100H</code> ,   ,      ,       0x100 hex.         8080,   ,    .    ,  ,          ,     0x100. <br><br> -,      ,           .       hex- <code>JMP $0100</code> ,    . (     PC   0x100.) <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Troisi√®mement, j'ai trouv√© un bogue dans le code compil√©. </font><font style="vertical-align: inherit;">Je pense que la raison est le traitement incorrect de la derni√®re ligne de code </font></font><code>STACK EQU TEMPP+256</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais je ne suis pas s√ªr. </font><font style="vertical-align: inherit;">Quoi qu'il en soit, la pile pendant la compilation √©tait situ√©e √† 6 $ US, et les premiers PUSH ont commenc√© √† r√©√©crire le code. </font><font style="vertical-align: inherit;">J'ai sugg√©r√© que la variable devrait √©galement √™tre d√©cal√©e de 0x100, comme le reste du code, donc je l'ai corrig√© en ins√©rant ¬´0x7¬ª dans la ligne de code qui initialise le pointeur de pile. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfin, comme je n'ai pas impl√©ment√© la migration DAA ou auxiliaire dans mon √©mulateur, je modifie le code pour ignorer cette v√©rification (nous l'avons simplement ignor√© en utilisant JMP).</font></font><br><br><pre> <code class="cpp hljs"> ReadFileIntoMemoryAt(state, <span class="hljs-string"><span class="hljs-string">"/Users/kpmiller/Desktop/invaders/cpudiag.bin"</span></span>, <span class="hljs-number"><span class="hljs-number">0x100</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  ,   JMP 0x100 state-&gt;memory[0]=0xc3; state-&gt;memory[1]=0; state-&gt;memory[2]=0x01; //Fix the stack pointer from 0x6ad to 0x7ad // this 0x06 byte 112 in the code, which is // byte 112 + 0x100 = 368 in memory state-&gt;memory[368] = 0x7; //  DAA state-&gt;memory[0x59c] = 0xc3; //JMP state-&gt;memory[0x59d] = 0xc2; state-&gt;memory[0x59e] = 0x05;</span></span></code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le test tente de tirer une conclusion </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âvidemment, ce test repose sur l'aide du syst√®me d'exploitation CP / M. J'ai d√©couvert que CP / M a du code √† 0005 $ qui imprime des messages sur la console et j'ai chang√© mon √©mulation CALL pour g√©rer ce comportement. Je ne sais pas si tout s'est bien pass√©, mais cela a fonctionn√© pour les deux messages que le programme essaie d'imprimer. Mon √©mulation CALL pour ex√©cuter ce test ressemble √† ceci:</font></font><br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0xcd</span></span>: <span class="hljs-comment"><span class="hljs-comment">//CALL  #ifdef FOR_CPUDIAG if (5 == ((opcode[2] &lt;&lt; 8) | opcode[1])) { if (state-&gt;c == 9) { uint16_t offset = (state-&gt;d&lt;&lt;8) | (state-&gt;e); char *str = &amp;state-&gt;memory[offset+3]; // - while (*str != '$') printf("%c", *str++); printf("\n"); } else if (state-&gt;c == 2) { //    ,   ,    printf ("print char routine called\n"); } } else if (0 == ((opcode[2] &lt;&lt; 8) | opcode[1])) { exit(0); } else #endif { uint16_t ret = state-&gt;pc+2; state-&gt;memory[state-&gt;sp-1] = (ret &gt;&gt; 8) &amp; 0xff; state-&gt;memory[state-&gt;sp-2] = (ret &amp; 0xff); state-&gt;sp = state-&gt;sp - 2; state-&gt;pc = (opcode[2] &lt;&lt; 8) | opcode[1]; } break;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec ce test, j'ai trouv√© plusieurs probl√®mes dans mon √©mulateur. Je ne sais pas lequel d'entre eux serait impliqu√© dans le jeu, mais s'ils l'√©taient, alors il serait tr√®s difficile de les trouver. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai continu√© et impl√©ment√© tous les opcodes (√† l'exception de DAA et de ses amis). Il m'a fallu 3 √† 4 heures pour r√©soudre les probl√®mes de mes d√©fis et en impl√©menter de nouveaux. Il √©tait nettement plus rapide que le processus manuel que j'ai d√©crit ci-dessus - avant de trouver ce test, j'ai pass√© plus de 4 heures sur le processus manuel. Si vous pouvez comprendre cette explication, je recommande d'utiliser cette m√©thode au lieu de comparer manuellement. Cependant, conna√Ætre le processus manuel est √©galement une grande comp√©tence, et si vous souhaitez √©muler un autre processeur, vous devez y revenir.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous ne pouvez pas effectuer ce processus ou si cela semble trop compliqu√©, alors il vaut vraiment la peine de choisir l'approche d√©crite ci-dessus avec deux √©mulateurs diff√©rents ex√©cut√©s √† l'int√©rieur de votre programme. </font><font style="vertical-align: inherit;">Lorsque plusieurs millions de commandes apparaissent dans le programme et que des interruptions sont ajout√©es, il sera impossible de comparer manuellement deux √©mulateurs.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418699/">https://habr.com/ru/post/fr418699/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418687/index.html">R√©volution 3,5 ": d√©tails d'un petit boom de disquettes avec vapeurs</a></li>
<li><a href="../fr418689/index.html">Comment cr√©er des biblioth√®ques de composants dans Figma, √©conomiser un budget, en utilisant l'exemple d'une vente aux ench√®res en ligne</a></li>
<li><a href="../fr418691/index.html">Rancher: Kubernetes en 5 minutes sur du m√©tal nu</a></li>
<li><a href="../fr418693/index.html">Pourquoi le bonheur est-il si difficile √† d√©tecter dans le cerveau</a></li>
<li><a href="../fr418695/index.html">Anti-Piracy Wars - L'Empire contre-attaque</a></li>
<li><a href="../fr418701/index.html">Nous √©tudions les analyseurs syntaxiques pour la langue russe</a></li>
<li><a href="../fr418705/index.html">Les bases de Futex</a></li>
<li><a href="../fr418707/index.html">KDispatcher - Eventbus l√©ger et pratique pour une utilisation quotidienne</a></li>
<li><a href="../fr418709/index.html">Besoin de vous forcer: pilotes et barri√®res d'interface</a></li>
<li><a href="../fr418711/index.html">Registres g√©r√©s par jeton 1.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>