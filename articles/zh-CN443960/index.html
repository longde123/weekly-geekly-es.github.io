<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥• ğŸ˜ƒ â­•ï¸ ä¸€æ¬¡æ€§æ¨¡å¼ï¼ˆä¸€æ¬¡æ€§è®¾è®¡åŸåˆ™ï¼‰ç¬¬2é¡µ ğŸ¤œ ğŸ‘©ğŸ½â€ğŸš€ ğŸ›‹ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SafeHandle / CriticalHandle / SafeBuffer /æ´¾ç”Ÿç±»å‹ 


 æˆ‘è§‰å¾—æˆ‘è¦ä¸ºæ‚¨æ‰“å¼€æ½˜å¤šæ‹‰ç›’å­ã€‚ è®©æˆ‘ä»¬è°ˆè°ˆç‰¹æ®Šç±»å‹ï¼šSafeHandleï¼ŒCriticalHandleåŠå…¶æ´¾ç”Ÿç±»å‹ã€‚ 


 è¿™æ˜¯æä¾›å¯¹éæ‰˜ç®¡èµ„æºçš„è®¿é—®çš„ç±»å‹æ¨¡å¼çš„æœ€åä¸€ä»¶äº‹ã€‚ ä½†æ˜¯é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ—å‡º...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¸€æ¬¡æ€§æ¨¡å¼ï¼ˆä¸€æ¬¡æ€§è®¾è®¡åŸåˆ™ï¼‰ç¬¬2é¡µ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/clrium/blog/443960/"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/nm/tj/eq/nmtjeqodhdjh27wvs0w6v8_0dhu.png"></a> </p><br><h2 id="safehandle--criticalhandle--safebuffer--derived-types">  SafeHandle / CriticalHandle / SafeBuffer /æ´¾ç”Ÿç±»å‹ </h2><br><p> æˆ‘è§‰å¾—æˆ‘è¦ä¸ºæ‚¨æ‰“å¼€æ½˜å¤šæ‹‰ç›’å­ã€‚ è®©æˆ‘ä»¬è°ˆè°ˆç‰¹æ®Šç±»å‹ï¼šSafeHandleï¼ŒCriticalHandleåŠå…¶æ´¾ç”Ÿç±»å‹ã€‚ </p><br><p> è¿™æ˜¯æä¾›å¯¹éæ‰˜ç®¡èµ„æºçš„è®¿é—®çš„ç±»å‹æ¨¡å¼çš„æœ€åä¸€ä»¶äº‹ã€‚ ä½†æ˜¯é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ—å‡º<em>é€šå¸¸</em>ä»ä¸å—ç®¡ç†çš„ä¸–ç•Œä¸­è·å¾—çš„ä¸€åˆ‡ï¼š </p><br><p> é¦–å…ˆï¼Œå¾ˆæ˜æ˜¾çš„æ˜¯æ‰‹æŸ„ã€‚ å¯¹äº.NETå¼€å‘äººå‘˜æ¥è¯´ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªæ¯«æ— æ„ä¹‰çš„è¯ï¼Œä½†å®ƒæ˜¯æ“ä½œç³»ç»Ÿä¸–ç•Œä¸­éå¸¸é‡è¦çš„ç»„æˆéƒ¨åˆ†ã€‚ å¥æŸ„æœ¬è´¨ä¸Šæ˜¯32ä½æˆ–64ä½æ•°å­—ã€‚ å®ƒæŒ‡å®šä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’çš„æ‰“å¼€çš„ä¼šè¯ã€‚ ä¾‹å¦‚ï¼Œå½“æ‚¨æ‰“å¼€æ–‡ä»¶æ—¶ï¼Œæ‚¨å°†ä»WinApiå‡½æ•°è·å¾—ä¸€ä¸ªå¥æŸ„ã€‚ ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒå¹¶æ‰§è¡Œ<em>æœç´¢</em> ï¼Œ <em>è¯»å–</em>æˆ–<em>å†™å…¥</em>æ“ä½œã€‚ æˆ–è€…ï¼Œæ‚¨å¯ä»¥æ‰“å¼€ç”¨äºç½‘ç»œè®¿é—®çš„å¥—æ¥å­—ã€‚ åŒæ ·ï¼Œæ“ä½œç³»ç»Ÿå°†ä¸ºæ‚¨ä¼ é€’ä¸€ä¸ªå¥æŸ„ã€‚ åœ¨.NETä¸­ï¼Œå¥æŸ„å­˜å‚¨ä¸º<em>IntPtr</em>ç±»å‹ã€‚ </p><br><blockquote><img src="https://habrastorage.org/webt/tu/qf/aq/tuqfaqcncvjtdmb_uxgcbbzyr9o.png" align="left"> æœ¬ç« ç”±ä½œè€…å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸“ä¸šç¿»è¯‘å‘˜</a>å…±åŒè¯‘è‡ªä¿„è¯­ã€‚ æ‚¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°†ä¿„è¯­æˆ–è‹±è¯­ç¿»è¯‘æˆä»»ä½•å…¶ä»–è¯­è¨€ï¼Œä¸»è¦æ˜¯ä¸­æ–‡æˆ–å¾·è¯­ã€‚ <br><br> å¦å¤–ï¼Œå¦‚æœæ‚¨æƒ³æ„Ÿè°¢æˆ‘ä»¬ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯åœ¨githubä¸Šç»™æˆ‘ä»¬åŠ æ˜Ÿå·æˆ–åˆ†æ”¯å­˜å‚¨åº“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/5n/wo/6u/5nwo6uvyk2eafkzdd0cdofjqm-0.png" width="22"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github / sidristij / dotnetbook</a> <br></blockquote><a name="habracut"></a><br><ul><li> ç¬¬äºŒä»¶äº‹æ˜¯æ•°æ®æ•°ç»„ã€‚ æ‚¨å¯ä»¥é€šè¿‡ä¸å®‰å…¨çš„ä»£ç ï¼ˆæ­¤å¤„ä¸å®‰å…¨æ˜¯å…³é”®å­—ï¼‰æ¥ä½¿ç”¨éæ‰˜ç®¡æ•°ç»„ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨SafeBufferæ¥å°†æ•°æ®ç¼“å†²åŒºåŒ…è£…åˆ°åˆé€‚çš„.NETç±»ä¸­ã€‚ è¯·æ³¨æ„ï¼Œç¬¬ä¸€ç§æ–¹æ³•æ›´å¿«ï¼ˆä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æå¤§åœ°ä¼˜åŒ–å¾ªç¯ï¼‰ï¼Œä½†æ˜¯ç¬¬äºŒç§æ–¹æ³•æ›´å®‰å…¨ï¼Œå› ä¸ºå®ƒåŸºäºSafeHandleã€‚ </li><li> ç„¶åå»å¼¦ã€‚ å­—ç¬¦ä¸²å¾ˆç®€å•ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ç¡®å®šæ•è·çš„å­—ç¬¦ä¸²çš„æ ¼å¼å’Œç¼–ç ã€‚ ç„¶åä¸ºæˆ‘ä»¬å¤åˆ¶å®ƒï¼ˆå­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªä¸å¯å˜çš„ç±»ï¼‰ï¼Œæˆ‘ä»¬ä¸å†æ‹…å¿ƒå®ƒã€‚ </li><li> æœ€åä¸€ä»¶äº‹æ˜¯ValueTypeï¼Œå®ƒä»¬åªæ˜¯è¢«å¤åˆ¶ï¼Œå› æ­¤æˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦è€ƒè™‘å®ƒä»¬ã€‚ </li></ul><br><p>  SafeHandleæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„.NET CLRç±»ï¼Œå®ƒç»§æ‰¿äº†CriticalFinalizerObjectå¹¶åº”ä»¥æœ€å®‰å…¨ï¼Œæœ€èˆ’é€‚çš„æ–¹å¼åŒ…è£…æ“ä½œç³»ç»Ÿçš„å¥æŸ„ã€‚ </p><br><pre><code class="plaintext hljs">[SecurityCritical, SecurityPermission(SecurityAction.InheritanceDemand, UnmanagedCode=true)] public abstract class SafeHandle : CriticalFinalizerObject, IDisposable { protected IntPtr handle; // The handle from OS private int _state; // State (validity, the reference counter) private bool _ownsHandle; // The flag for the possibility to release the handle. // It may happen that we wrap somebody else's handle // have no right to release. private bool _fullyInitialized; // The initialized instance [ReliabilityContract(Consistency.WillNotCorruptState, Cer.MayFail)] protected SafeHandle(IntPtr invalidHandleValue, bool ownsHandle) { } // The finalizer calls Dispose(false) with a pattern [SecuritySafeCritical] ~SafeHandle() { Dispose(false); } // You can set a handle manually or automatically with p/invoke Marshal [ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] protected void SetHandle(IntPtr handle) { this.handle = handle; } // This method is necessary to work with IntPtr directly. It is used to // determine if a handle was created by comparing it with one of the previously // determined known values. Pay attention that this method is dangerous because: // // â€“ if a handle is marked as invalid by SetHandleasInvalid, DangerousGetHandle // it will anyway return the original value of the handle. // â€“ you can reuse the returned handle at any place. This can at least // mean, that it will stop work without a feedback. In the worst case if // IntPtr is passed directly to another place, it can go to an unsafe code and become // a vector for application attack by resource substitution in one IntPtr [ResourceExposure(ResourceScope.None), ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] public IntPtr DangerousGetHandle() { return handle; } // The resource is closed (no more available for work) public bool IsClosed { [ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] get { return (_state &amp; 1) == 1; } } // The resource is not available for work. You can override the property by changing the logic. public abstract bool IsInvalid { [ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] get; } // Closing the resource through Close() pattern [SecurityCritical, ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] public void Close() { Dispose(true); } // Closing the resource through Dispose() pattern [SecuritySafeCritical, ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] public void Dispose() { Dispose(true); } [SecurityCritical, ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] protected virtual void Dispose(bool disposing) { // ... } // You should call this method every time when you understand that a handle is not operational anymore. // If you don't do it, you can get a leak. [SecurityCritical, ResourceExposure(ResourceScope.None)] [ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] [MethodImplAttribute(MethodImplOptions.InternalCall)] public extern void SetHandleAsInvalid(); // Override this method to point how to release // the resource. You should code carefully, as you cannot // call uncompiled methods, create new objects or produce exceptions from it. // A returned value shows if the resource was releases successfully. // If a returned value = false, SafeHandleCriticalFailure will occur // that will enter a breakpoint if SafeHandleCriticalFailure // Managed Debugger Assistant is activated. [ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)] protected abstract bool ReleaseHandle(); // Working with the reference counter. To be explained further. [SecurityCritical, ResourceExposure(ResourceScope.None)] [ReliabilityContract(Consistency.WillNotCorruptState, Cer.MayFail)] [MethodImplAttribute(MethodImplOptions.InternalCall)] public extern void DangerousAddRef(ref bool success); public extern void DangerousRelease(); }</code> </pre> <br><p> è¦äº†è§£ä»SafeHandleæ´¾ç”Ÿçš„ç±»çš„æœ‰ç”¨æ€§ï¼Œæ‚¨éœ€è¦è®°ä½.NETç±»å‹ä¸ºä½•å¦‚æ­¤å‡ºè‰²ï¼šGCå¯ä»¥è‡ªåŠ¨æ”¶é›†å…¶å®ä¾‹ã€‚ åœ¨ç®¡ç†SafeHandleæ—¶ï¼Œå®ƒåŒ…è£…çš„éæ‰˜ç®¡èµ„æºç»§æ‰¿äº†æ‰˜ç®¡ä¸–ç•Œçš„æ‰€æœ‰ç‰¹å¾ã€‚ å®ƒè¿˜åŒ…å«ä¸€ä¸ªå¤–éƒ¨å¼•ç”¨çš„å†…éƒ¨è®¡æ•°å™¨ï¼Œè€Œå¤–éƒ¨å¼•ç”¨å¯¹CLRä¸å¯ç”¨ã€‚ æˆ‘çš„æ„æ€æ˜¯å¼•ç”¨ä¸å®‰å…¨çš„ä»£ç ã€‚ æ‚¨æ ¹æœ¬ä¸éœ€è¦æ‰‹åŠ¨å¢åŠ æˆ–å‡å°‘è®¡æ•°å™¨ã€‚ å½“æ‚¨å°†æ´¾ç”Ÿè‡ªSafeHandleçš„ç±»å‹å£°æ˜ä¸ºä¸å®‰å…¨æ–¹æ³•çš„å‚æ•°æ—¶ï¼Œè®¡æ•°å™¨ä¼šåœ¨è¿›å…¥è¯¥æ–¹æ³•æ—¶å¢åŠ æˆ–åœ¨é€€å‡ºåå‡å°‘ã€‚ åŸå› æ˜¯ï¼Œå½“æ‚¨é€šè¿‡ä¼ é€’ä¸€ä¸ªå¥æŸ„è¿›å…¥ä¸å®‰å…¨çš„ä»£ç æ—¶ï¼Œå¯ä»¥é€šè¿‡åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­é‡ç½®å¯¹è¯¥å¥æŸ„çš„å¼•ç”¨æ¥è·å¾—GCæ”¶é›†çš„SafeHandleï¼ˆå¦‚æœæ‚¨ä»å¤šä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªå¥æŸ„ï¼‰ã€‚ ä½¿ç”¨å¼•ç”¨è®¡æ•°å™¨ï¼Œäº‹æƒ…å˜å¾—æ›´åŠ è½»æ¾ï¼šåœ¨è®¡æ•°å™¨å½’é›¶ä¹‹å‰ï¼Œä¸ä¼šåˆ›å»ºSafeHandleã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‚¨ä¸éœ€è¦æ‰‹åŠ¨æ›´æ”¹è®¡æ•°å™¨çš„åŸå› ã€‚ æˆ–è€…ï¼Œæ‚¨åº”è¯¥éå¸¸å°å¿ƒåœ°å°†å…¶è¿”å›ï¼ˆå¦‚æœå¯èƒ½ï¼‰ã€‚ </p><br><p> å¼•ç”¨è®¡æ•°å™¨çš„ç¬¬äºŒä¸ªç›®çš„æ˜¯è®¾ç½®äº’ç›¸å¼•ç”¨çš„<code>CriticalFinalizerObject</code>çš„å®Œæˆé¡ºåºã€‚ å¦‚æœä¸€ä¸ªåŸºäºSafeHandleçš„ç±»å‹å¼•ç”¨äº†å¦ä¸€ä¸ªï¼Œåˆ™æ‚¨éœ€è¦åœ¨å¼•ç”¨ç±»å‹çš„æ„é€ å‡½æ•°ä¸­å¦å¤–å¢åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå¹¶åœ¨ReleaseHandleæ–¹æ³•ä¸­å‡å°‘è¯¥è®¡æ•°å™¨ã€‚ å› æ­¤ï¼Œæ‚¨çš„å¯¹è±¡å°†ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æ‚¨çš„å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡æœªè¢«ç ´åä¸ºæ­¢ã€‚ ä½†æ˜¯ï¼Œæœ€å¥½é¿å…è¿™ç§å›°æƒ‘ã€‚ è®©æˆ‘ä»¬ä½¿ç”¨æœ‰å…³SafeHandlersçš„çŸ¥è¯†ï¼Œå¹¶ç¼–å†™ç±»çš„æœ€ç»ˆå˜ä½“ï¼š </p><br><pre> <code class="plaintext hljs">public class FileWrapper : IDisposable { SafeFileHandle _handle; bool _disposed; public FileWrapper(string name) { _handle = CreateFile(name, 0, 0, 0, 0, 0, IntPtr.Zero); } public void Dispose() { if(_disposed) return; _disposed = true; _handle.Dispose(); } [MethodImpl(MethodImplOptions.AggressiveInlining)] private void CheckDisposed() { if(_disposed) { throw new ObjectDisposedException(); } } [DllImport("kernel32.dll", EntryPoint = "CreateFile", SetLastError = true)] private static extern SafeFileHandle CreateFile(String lpFileName, UInt32 dwDesiredAccess, UInt32 dwShareMode, IntPtr lpSecurityAttributes, UInt32 dwCreationDisposition, UInt32 dwFlagsAndAttributes, IntPtr hTemplateFile); /// other methods }</code> </pre> <br><p> æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ å¦‚æœæ‚¨åœ¨DllImportæ–¹æ³•ä¸­å°†<strong>ä»»ä½•</strong>åŸºäºSafeHandleçš„ç±»å‹ï¼ˆåŒ…æ‹¬æ‚¨è‡ªå·±çš„ç±»å‹ï¼‰è®¾ç½®ä¸ºè¿”å›å€¼ï¼Œåˆ™Marshalå°†æ­£ç¡®åˆ›å»ºå¹¶åˆå§‹åŒ–æ­¤ç±»å‹å¹¶å°†è®¡æ•°å™¨è®¾ç½®ä¸º1ã€‚çŸ¥é“äº†è¿™ä¸€ç‚¹åï¼Œæˆ‘ä»¬å°†SafeFileHandleç±»å‹è®¾ç½®ä¸ºä»¥ä¸‹æƒ…å†µçš„è¿”å›ç±»å‹ï¼š CreateFileå†…æ ¸å‡½æ•°ã€‚ å½“æˆ‘ä»¬å¾—åˆ°å®ƒæ—¶ï¼Œæˆ‘ä»¬å°†ç²¾ç¡®åœ°ä½¿ç”¨å®ƒæ¥è°ƒç”¨ReadFileå’ŒWriteFileï¼ˆå› ä¸ºè°ƒç”¨æ—¶è®¡æ•°å™¨å€¼å¢åŠ ï¼Œé€€å‡ºæ—¶é€’å‡è®¡æ•°å™¨å€¼å°†ç¡®ä¿åœ¨è¯»å†™æ–‡ä»¶æ—¶è¯¥å¥æŸ„ä»ç„¶å­˜åœ¨ï¼‰ã€‚ è¿™æ˜¯ä¸€ç§è®¾è®¡æ­£ç¡®çš„ç±»å‹ï¼Œå¦‚æœçº¿ç¨‹ä¸­æ­¢ï¼Œå®ƒå°†å¯é åœ°å…³é—­æ–‡ä»¶å¥æŸ„ã€‚ è¿™æ„å‘³ç€æˆ‘ä»¬ä¸éœ€è¦å®ç°è‡ªå·±çš„ç»ˆç»“å™¨ä»¥åŠä¸æ­¤ç›¸å…³çš„æ‰€æœ‰ä¸œè¥¿ã€‚ æ•´ä¸ªç±»å‹è¢«ç®€åŒ–ã€‚ </p><br><h3 id="the-execution-of-a-finalizer-when-instance-methods-work"> å®ä¾‹æ–¹æ³•å·¥ä½œæ—¶ç»ˆç»“å™¨çš„æ‰§è¡Œ </h3><br><p> åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ä½¿ç”¨äº†ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œè¯¥æŠ€æœ¯æ—¨åœ¨åœ¨æ›´çŸ­çš„æ—¶é—´å†…æ”¶é›†æ›´å¤šçš„å¯¹è±¡ã€‚ è®©æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä»£ç ï¼š </p><br><pre> <code class="plaintext hljs">public void SampleMethod() { var obj = new object(); obj.ToString(); // ... // If GC runs at this point, it may collect obj // as it is not used anymore // ... Console.ReadLine(); }</code> </pre> <br><p> ä¸€æ–¹é¢ï¼Œä»£ç çœ‹èµ·æ¥å¾ˆå®‰å…¨ï¼Œè€Œä¸”æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜è¦åœ¨æ„å°šä¸æ¸…æ¥šã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨è®°å¾—æœ‰äº›ç±»åŒ…è£…äº†éæ‰˜ç®¡èµ„æºï¼Œæ‚¨å°†äº†è§£è®¾è®¡ä¸æ­£ç¡®çš„ç±»å¯èƒ½ä¼šå¯¼è‡´éæ‰˜ç®¡ä¸–ç•Œçš„å¼‚å¸¸ã€‚ æ­¤å¼‚å¸¸å°†æŠ¥å‘Šå…ˆå‰è·å–çš„å¥æŸ„æœªæ¿€æ´»ï¼š </p><br><pre> <code class="plaintext hljs">// The example of an absolutely incorrect implementation void Main() { var inst = new SampleClass(); inst.ReadData(); // inst is not used further } public sealed class SampleClass : CriticalFinalizerObject, IDisposable { private IntPtr _handle; public SampleClass() { _handle = CreateFile("test.txt", 0, 0, IntPtr.Zero, 0, 0, IntPtr.Zero); } public void Dispose() { if (_handle != IntPtr.Zero) { CloseHandle(_handle); _handle = IntPtr.Zero; } } ~SampleClass() { Console.WriteLine("Finalizing instance."); Dispose(); } public unsafe void ReadData() { Console.WriteLine("Calling GC.Collect..."); // I redirected it to the local variable not to // use this after GC.Collect(); var handle = _handle; // The imitation of full GC.Collect GC.Collect(); GC.WaitForPendingFinalizers(); GC.Collect(); Console.WriteLine("Finished doing something."); var overlapped = new NativeOverlapped(); // it is not important what we do ReadFileEx(handle, new byte[] { }, 0, ref overlapped, (a, b, c) =&gt; {;}); } [DllImport("kernel32.dll", SetLastError = true, CharSet = CharSet.Auto, BestFitMapping = false)] static extern IntPtr CreateFile(String lpFileName, int dwDesiredAccess, int dwShareMode, IntPtr securityAttrs, int dwCreationDisposition, int dwFlagsAndAttributes, IntPtr hTemplateFile); [DllImport("kernel32.dll", SetLastError = true)] static extern bool ReadFileEx(IntPtr hFile, [Out] byte[] lpBuffer, uint nNumberOfBytesToRead, [In] ref NativeOverlapped lpOverlapped, IOCompletionCallback lpCompletionRoutine); [DllImport("kernel32.dll", SetLastError = true)] static extern bool CloseHandle(IntPtr hObject); }</code> </pre> <br><p> æ‰¿è®¤è¿™æ®µä»£ç æˆ–å¤šæˆ–å°‘çœ‹èµ·æ¥ä¸é”™ã€‚ æ— è®ºå¦‚ä½•ï¼Œçœ‹èµ·æ¥å¥½åƒæ²¡æœ‰é—®é¢˜ã€‚ å®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ã€‚ ç±»ç»ˆç»“å™¨å¯èƒ½åœ¨è¯»å–æ–‡ä»¶æ—¶å°è¯•å…³é—­æ–‡ä»¶ï¼Œè¿™å‡ ä¹ä¸å¯é¿å…åœ°å¯¼è‡´é”™è¯¯ã€‚ å› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé”™è¯¯å·²æ˜ç¡®è¿”å›ï¼ˆ <code>IntPtr == -1</code> ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä¼šçœ‹åˆ°æ­¤é”™è¯¯ã€‚  <code>_handle</code>å°†è®¾ç½®ä¸ºé›¶ï¼Œä»¥ä¸‹<code>Dispose</code>å°†æ— æ³•å…³é—­æ–‡ä»¶ï¼Œå¹¶ä¸”èµ„æºå°†æ³„æ¼ã€‚ è¦è§£å†³æ­¤é—®é¢˜ï¼Œæ‚¨åº”è¯¥ä½¿ç”¨<code>SafeHandle</code> ï¼Œ <code>CriticalHandle</code> ï¼Œ <code>SafeBuffer</code>åŠå…¶æ´¾ç”Ÿç±»ã€‚ é™¤äº†è¿™äº›ç±»å…·æœ‰åœ¨éæ‰˜ç®¡ä»£ç ä¸­ä½¿ç”¨çš„è®¡æ•°å™¨å¤–ï¼Œè¿™äº›è®¡æ•°å™¨è¿˜ä¼šåœ¨å°†æ–¹æ³•çš„å‚æ•°ä¼ é€’ç»™éæ‰˜ç®¡ä¸–ç•Œæ—¶è‡ªåŠ¨é€’å¢ï¼Œå¹¶åœ¨ç¦»å¼€å®ƒæ—¶é€’å‡ã€‚ </p><br><blockquote><img src="https://habrastorage.org/webt/tu/qf/aq/tuqfaqcncvjtdmb_uxgcbbzyr9o.png" align="left"> è¯¥ç« ç¨‹ç”±<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸“ä¸šç¿»è¯‘äººå‘˜</a>ä»ä¿„è¯­è¯‘ä¸ºä½œè€…çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯­è¨€</a> ã€‚ æ‚¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä½¿ç”¨ä¿„è¯­å’Œè‹±è¯­ç‰ˆæœ¬çš„æ–‡æœ¬ä½œä¸ºæºæ¥åˆ›å»ºè¯¥æ–‡æœ¬åˆ°å…¶ä»–ä»»ä½•è¯­è¨€ï¼ˆåŒ…æ‹¬ä¸­æ–‡æˆ–å¾·è¯­ï¼‰çš„ç¿»è¯‘ç‰ˆæœ¬ã€‚ <br><br> å¦å¤–ï¼Œå¦‚æœæ‚¨æƒ³è¯´â€œè°¢è°¢â€ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥é€‰æ‹©çš„æœ€å¥½æ–¹æ³•æ˜¯åœ¨githubæˆ–forkåº“ä¸Šç»™æˆ‘ä»¬åŠ æ˜Ÿå· <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/5n/wo/6u/5nwo6uvyk2eafkzdd0cdofjqm-0.png" width="22"></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/sidristij/dotnetbook</a> <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN443960/">https://habr.com/ru/post/zh-CN443960/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN443950/index.html">ä¿¡ä»»ï¼Œå»ºè®®ï¼Œå»ºè®®-å¯»æ‰¾çœŸå®çš„è½¯ä»¶è¯„è®º</a></li>
<li><a href="../zh-CN443952/index.html">ä¸»æƒäº’è”ç½‘-ä¸ºäº†æˆ‘ä»¬çš„é’±</a></li>
<li><a href="../zh-CN443954/index.html">æŠ€æœ¯å¥‡å¼‚æ€§ï¼šä»¥è¿›æ­¥å‡è®¾ä¸ºå¹Œå­çš„ä¸–ç•Œæœ«æ—¥ç¥è¯</a></li>
<li><a href="../zh-CN443956/index.html">2019å¹´çš„ç¤¾äº¤ç½‘ç»œï¼šYandexæ¨å‡ºAura</a></li>
<li><a href="../zh-CN443958/index.html">ä¸€æ¬¡æ€§æ¨¡å¼ï¼ˆä¸€æ¬¡æ€§è®¾è®¡åŸåˆ™ï¼‰ç¬¬1é¡µ</a></li>
<li><a href="../zh-CN443962/index.html">ä¸€æ¬¡æ€§æ¨¡å¼ï¼ˆä¸€æ¬¡æ€§è®¾è®¡åŸåˆ™ï¼‰ç¬¬3é¡µ</a></li>
<li><a href="../zh-CN443964/index.html">Kolesa Confæ˜¯å“ˆè¨å…‹æ–¯å¦æœ€å¤§çš„ITä¼šè®®ã€‚ æŠ¥å‘Šå…¬å¸ƒ</a></li>
<li><a href="../zh-CN443966/index.html">Googleæ–‡æ¡£-å­¦ç”Ÿä»¬æœ€å–œæ¬¢çš„èŠå¤©</a></li>
<li><a href="../zh-CN443968/index.html">æˆ‘ä»¬å¦‚ä½•è´­ä¹°å¸¦æœ‰å¤ªé˜³èƒ½ç”µæ± æ¿çš„æˆ¿å­ä»¥åŠå®ƒçš„æ¥é¾™å»è„‰</a></li>
<li><a href="../zh-CN443972/index.html">Yandexå°†ä½¿ç”¨æœºå™¨äººæœç´¢æµ·ç›—</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>