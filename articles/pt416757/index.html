<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëêüèæ üèÇüèΩ üõãÔ∏è Testes escamosos ‚óæÔ∏è üë©üèΩ‚Äç‚öñÔ∏è üó®Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O que √© mais desagrad√°vel do que o "teste vermelho"? O teste √© verde ou vermelho, e n√£o est√° claro o porqu√™. Em nossa confer√™ncia Heisenbug 2017 em Mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testes escamosos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/416757/">  O que √© mais desagrad√°vel do que o "teste vermelho"?  O teste √© verde ou vermelho, e n√£o est√° claro o porqu√™.  Em nossa confer√™ncia Heisenbug 2017 em Moscou, <b>Andrei Solntsev</b> (Codeborne) falou sobre por que eles podem surgir e como reduzir seu n√∫mero.  Exemplos no relat√≥rio dele s√£o tais que voc√™ sente a dor diretamente na pele quando colide com eles.  E as dicas s√£o √∫teis - e vale a pena conhecer testadores e desenvolvedores.  H√° algo inesperado: voc√™ pode descobrir como √†s vezes pode descobrir um problema se se afastar da tela e jogar cubos com sua filha. <br><br>  Como resultado, o p√∫blico apreciou o relat√≥rio, e decidimos n√£o apenas publicar o v√≠deo, mas tamb√©m fazer uma vers√£o em texto do relat√≥rio para Habr. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/jLG3RXECQU8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  Na minha opini√£o, testes esquisitos s√£o o t√≥pico mais relevante no mundo da automa√ß√£o.  Porque a pergunta "o que est√° sendo feito no mundo, como voc√™ est√° fazendo com a automa√ß√£o?"  todas respondem: ‚ÄúN√£o h√° estabilidade!  Nossos testes caem periodicamente. ‚Äù <br><br>  Voc√™ fez um teste em sua casa, √© verde, outros dois dias verdes e, uma vez e de repente, caiu sobre Jenkins.  Voc√™ tenta repeti-lo, inici√°-lo e fica verde novamente.  E no final, voc√™ nunca sabe: √© um bug ou √© apenas um teste de glucana?  E toda vez que voc√™ precisa entender. <br><br>  Muitas vezes, ap√≥s o lan√ßamento noturno de testes no Jenkins, o testador v√™ pela primeira vez "30 testes ca√≠ram, voc√™ precisa estudar", mas todos sabem o que acontece a seguir ... <br><br><img src="https://habrastorage.org/webt/fz/vg/jh/fzvgjhfo6snzfs6qa0d9clltgcc.jpeg"><br><br>  Voc√™, claro, adivinhou qual palavra indecente disfar√ßava: "Vou reiniciar".  Como "hoje n√£o h√° relut√¢ncia em entender ..." √â assim que geralmente acontece e √© um verdadeiro desastre. <br><br>  N√£o h√° estat√≠sticas exatas, mas muitas vezes ouvi de pessoas diferentes que elas t√™m cerca de 30% dos testes - escamosos.  Grosso modo, eles lan√ßam mil, dos quais 300 s√£o periodicamente vermelhos e depois checam com as m√£os se realmente ca√≠ram. <br><br>  O Google publicou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo h√°</a> alguns anos: ele diz que eles t√™m 1,5% por cento de testes inadequados e conta como eles lutam para reduzir seu n√∫mero.  Posso me gabar um pouco e dizer que meu projeto em Codeborne agora √© de 0,1%.  Mas, de fato, tudo isso √© ruim, mesmo 0,1%.  Porque <br><br>  Tome 1,5%, esse n√∫mero parece pequeno, mas o que isso significa na pr√°tica?  Digamos que haja mil testes em um projeto.  Isso pode significar que 15 testes ca√≠ram em uma vers√£o, os pr√≥ximos 12 e depois 18. E isso √© muito ruim, porque nesse caso quase todas as vers√µes s√£o vermelhas e voc√™ precisa verificar constantemente com as m√£os se √© verdade ou n√£o. <br><br>  E at√© o nosso 1 ppm (0,1%) ainda √© ruim.  Suponha que tenhamos 1000 testes e, em seguida, 0,1% significa que regularmente uma em cada dez quedas cai com 1-2 testes em vermelho.  Aqui est√° a imagem real do nosso Jenkins, e acontece que: com uma corrida, um teste escamoso caiu, com outro come√ßo outro. <br><br><img src="https://habrastorage.org/webt/dv/gx/da/dvgxdacsvc67zygojg18pu50v-q.jpeg"><br><br>  Acontece que n√£o temos um dia sem uma constru√ß√£o vermelha.  Como h√° muito verde, tudo parece estar bem, mas o cliente tem o direito de nos perguntar: "Pessoal, pagamos dinheiro e voc√™ sempre nos fornece vermelho!"  O que voc√™ est√° fazendo? <br><br>  Eu ficaria insatisfeito no local do cliente, e explicar "em geral, isso √© normal no setor, tudo √© vermelho para todos" n√£o √© bom, certo?  Portanto, na minha opini√£o, esse √© um problema muito urgente, e vamos entender juntos como lidar com isso. <br><br>  O plano √© este: <br><br><ol><li>  Minha cole√ß√£o de testes inst√°veis ‚Äã‚Äã(da minha pr√°tica, casos absolutamente reais, hist√≥rias de detetive complexas e interessantes) </li><li>  Causas de instabilidade (alguns at√© levaram anos para pesquisar) </li><li>  Como lidar com eles?  (espero que seja a parte mais √∫til) </li></ol><br>  Ent√£o, vamos come√ßar com minha cole√ß√£o, que eu valorizo ‚Äã‚Äãmuito: me custou muitas horas noturnas de vida e depura√ß√£o.  Vamos come√ßar com um exemplo simples. <br><br><h2>  Exemplo 1: cl√°ssico </h2><br>  Para sementes - o cl√°ssico script Selenium: <br><br><pre><code class="java hljs">driver.navigate().to(<span class="hljs-string"><span class="hljs-string">"https://www.google.com/"</span></span>); driver.findElement(By.name(<span class="hljs-string"><span class="hljs-string">"q"</span></span>)).sendKeys(<span class="hljs-string"><span class="hljs-string">"selenide"</span></span>); driver.findElement(By.name(<span class="hljs-string"><span class="hljs-string">"btnK"</span></span>)).click(); assertEquals(<span class="hljs-number"><span class="hljs-number">9</span></span>, driver.findElements(By.cssSelector(<span class="hljs-string"><span class="hljs-string">"#ires .g"</span></span>)).size());</code> </pre> <br><ol><li>  Abrimos o WebDriver; </li><li>  Encontre o elemento q, dirija na palavra para pesquisar l√°; </li><li>  Encontre o elemento "Button" e clique; </li><li>  Verifique se a resposta √© nove resultados. </li></ol><br>  Pergunta: qual linha pode quebrar aqui? <br><br>  √â isso mesmo, todos sabemos bem que qualquer um!  Qualquer linha pode quebrar, por raz√µes completamente diferentes: <br><br>  A primeira linha √© a Internet lenta, o servi√ßo travou, os administradores n√£o configuraram nada. <br><br>  A segunda linha - o elemento ainda n√£o teve tempo para renderizar se for desenhado dinamicamente. <br>  O que poderia quebrar na terceira linha?  Aqui foi inesperado para mim: escrevi este teste para a confer√™ncia, executei-o localmente e caiu na terceira linha com este erro: <br><br><img src="https://habrastorage.org/webt/8n/qu/4l/8nqu4l-8byopdwjdkbcrcgkhery.jpeg"><br><br>  Isso indica que o elemento neste momento n√£o √© clic√°vel.  Parece um simples formul√°rio b√°sico do Google.  O segredo acabou sendo o de que atingimos a palavra na segunda linha e, enquanto a inser√≠amos, o Google j√° encontrou os primeiros resultados, mostrou os primeiros resultados em um pop-up e eles fecharam o bot√£o seguinte.  E isso n√£o acontece em todos os navegadores e nem sempre.  Isso aconteceu comigo com esse script uma vez em cada cinco. <br><br>  A quarta linha pode cair, por exemplo, porque esse elemento √© desenhado dinamicamente e ainda n√£o teve tempo para desenhar. <br><br>  Neste exemplo, quero dizer que, na minha experi√™ncia, 90% dos testes de falhas s√£o baseados nos mesmos motivos: <br><br><ul><li>  Velocidade de solicita√ß√£o do Ajax: √†s vezes eles correm mais devagar; </li><li>  A ordem dos pedidos do Ajax; </li><li>  Velocidade js. </li></ul><br>  Felizmente, h√° uma cura por esses motivos!  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Selenida</a> resolve esses problemas.  Como isso decide?  Reescrevemos nosso teste do Google no Selenide - quase tudo se parece, apenas os sinais de $ s√£o usados: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">userCanLogin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ open(‚Äúhttp:<span class="hljs-comment"><span class="hljs-comment">//localhost:8080/login‚Äù); $(By.name(‚Äúusername‚Äù).setValue(‚Äújohn‚Äù); $(‚Äú#submit‚Äù).click(); $(‚Äú.menu‚Äù).shouldHave(text(‚ÄúHello, John!‚Äù)); }</span></span></code> </pre><br>  Este teste sempre passa.  Devido ao fato de os m√©todos setValue (), click () e shouldHave () serem inteligentes: se algo n√£o tiver tempo para ser aplicado, eles esperam um pouco e tentam novamente (isso √© chamado de "expectativas inteligentes"). <br><br>  Se voc√™ olhar um pouco mais detalhadamente, todos esses m√©todos deveriam * s√£o inteligentes: <br><br><img src="https://habrastorage.org/webt/gq/x8/uq/gqx8uq3gjj6wudrx0n3uajntzdy.jpeg"><br><br>  Eles podem esperar, se necess√°rio.  Por padr√£o, eles esperam at√© 4 segundos, e esse tempo limite, √© claro, √© configur√°vel, voc√™ pode especificar qualquer outro.  Por exemplo, assim: mvn -Dselenide.timeout = 8000. <br><br><h2>  Exemplo 2: nbob </h2><br>  Assim, 90% dos problemas com testes escamosos s√£o resolvidos com Selenide.  Mas 10% dos casos muito mais sofisticados permanecem com raz√µes complexas e confusas.  √â precisamente sobre eles que quero falar hoje, porque √© uma "√°rea cinzenta".  Deixe-me dar um exemplo: um teste superficial, que me deparei imediatamente em um novo projeto.  √Ä primeira vista, isso simplesmente n√£o pode acontecer, mas isso √© algo interessante. <br><br>  Testamos o aplicativo do teclado para login em quiosques.  O teste queria efetuar login como o usu√°rio "bob", ou seja, digite tr√™s letras no campo "login": bob.  Para isso, foram utilizados os bot√µes na tela.  Como regra, isso funcionava, mas √†s vezes o teste falhava e o valor "nbob" permanecia no campo "login": <br><br><img src="https://habrastorage.org/webt/7u/hp/zs/7uhpzsf9wrppgubv_cra_ldg2ri.jpeg"><br><br>  Naturalmente, voc√™ est√° lutando para pesquisar pelo c√≥digo onde poder√≠amos ter escrito "nbob" - mas em todo o projeto isso n√£o √© de todo (nem no banco de dados, nem no c√≥digo, nem nos arquivos do Excel).  Como isso √© poss√≠vel? <br><br>  Examinamos o c√≥digo com mais detalhes - parece que tudo √© simples, sem enigmas: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loginKiosk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ open(‚Äúhttp:<span class="hljs-comment"><span class="hljs-comment">//localhost:9000/kiosk‚Äù); $(‚Äúbody‚Äù).click(); $(By.name(‚Äúusername‚Äù)).sendKeys(‚Äúbob‚Äù); $(‚Äú#login‚Äù).click(); }</span></span></code> </pre><br>  Come√ßamos a debater mais, passo a passo e com esse m√©todo conseguimos entender: esse erro √†s vezes aparece ap√≥s a linha $ ("body"). Clique em ().  Ou seja, nesta etapa, "n" aparece no campo "login" e, em seguida, "bob" √© adicionado nas etapas subsequentes.  Quem j√° adivinhou de onde vem "n"? <br><br>  Aconteceu que a letra N estava no meio da tela e a fun√ß√£o click () pelo menos no Chrome funciona assim: calcula a coordenada central de um elemento e clica nele.  Como corpo √© um elemento grande, ela clicou no centro de toda a tela. <br><br><img src="https://habrastorage.org/webt/56/xh/k_/56xhk_clrm85lqkyn-wqeaa5hg4.jpeg"><br><br>  E isso nem sempre caiu.  Quem sabe porque?  De fato, eu mesmo n√£o sei completamente.  Talvez devido ao fato de a janela do navegador ser aberta o tempo todo em tamanhos diferentes, e isso nem sempre cair na letra N. <br><br>  Voc√™ provavelmente tem uma pergunta: por que algu√©m ganhou $ ("body")? Clique em ()?  Tamb√©m n√£o sei at√© o fim, mas suponho remover o foco do campo.  Existe um problema no Selenium que √© clicar em (), mas desmarcar () n√£o.  Se houver um foco no campo, ele n√£o poder√° ser removido a partir da√≠, voc√™ poder√° clicar apenas em qualquer outro elemento.  E como n√£o havia outros elementos razo√°veis, eles clicaram no corpo e obtiveram esse efeito. <br><br>  Da√≠ a moral: n√£o insira nada que entre no &lt;corpo&gt;.  Em outras palavras, voc√™ n√£o precisa fazer nenhum movimento extra em p√¢nico.  De fato, isso geralmente acontece: desde que eu lido com o Selenide, muitas vezes recebo reclama√ß√µes de que "algo n√£o funciona" e, em seguida, verifica-se que em algum lugar nos m√©todos de configura√ß√£o havia 15 linhas extras que n√£o fazem nada √∫til e interferem .  N√£o h√° necessidade de mexer e inserir de qualquer maneira em testes como "de repente ser√° mais confi√°vel". <br><br>  Como resultado, expandimos a lista de raz√µes para testes inst√°veis: <br><br><ul><li>  Velocidade de solicita√ß√£o do Ajax; </li><li>  A ordem dos pedidos do Ajax; </li><li>  Velocidade js; </li><li>  Tamanho da janela do navegador; </li><li>  Vaidade! </li></ul><br>  E, ao mesmo tempo, minha recomenda√ß√£o √©: n√£o execute testes de forma maximizada (ou seja, n√£o abra o navegador em uma janela completa).  Como regra, todo mundo faz isso, e no Selenide era por padr√£o (ou ainda √©).  Em vez disso, aconselho que voc√™ sempre inicie um navegador com uma resolu√ß√£o de tela estritamente definida, porque esse fator aleat√≥rio √© exclu√≠do.  E aconselho que voc√™ defina o tamanho m√≠nimo que seu aplicativo suporta, de acordo com a especifica√ß√£o. <br><br><h2>  Exemplo 3: contas fantasmas </h2><br>  Um exemplo √© interessante, pois tudo o que s√≥ pode coincidir imediatamente coincide. <br><br>  Houve um teste que verificou se deveria haver 5 contas nessa tela. <br><br><img src="https://habrastorage.org/webt/td/hp/vl/tdhpvl7b-2ar4jxetsboygszf7m.jpeg"><br><br>  Como regra geral, era verde, mas √†s vezes n√£o estava claro em que condi√ß√µes ele caiu e disse que n√£o havia cinco, mas seis contagens na tela. <br><br>  Comecei a pesquisar de onde vem a conta extra.  Absolutamente incompreens√≠vel.  Surgiu a pergunta: talvez tenhamos outro teste, que durante o teste cria uma nova conta?  Descobriu-se que sim, existe um LoansTest.  E entre ele e o AccountsTest em queda (que espera cinco contas), pode haver um milh√£o de outros testes. <br><br>  Estamos tentando entender como √©: o LoansTest, que cria a conta, n√£o deve exclu√≠-lo no final?  N√≥s olhamos para o seu c√≥digo - sim, deveria, no final, h√° uma fun√ß√£o After para isso.  Ent√£o, em teoria, tudo deve ficar bem, qual √© o problema? <br><br>  Talvez o teste o remova, mas ele permanece em cache em algum lugar?  Observamos o c√≥digo de produ√ß√£o que carrega as contas - ele realmente possui a anota√ß√£o @CacheFor, ele armazena em cache as contas por cinco minutos. <br><br>  Surge a pergunta: mas o teste n√£o deveria limpar esse cache?  Seria l√≥gico, n√£o pode haver tal batente?  Analisamos seu c√≥digo - sim, ele realmente limpa o cache antes de cada teste.  O que houve?  Aqui voc√™ j√° est√° perdido, porque as hip√≥teses terminaram: o objeto foi exclu√≠do, o cache foi limpo, varas de √°rvores, o que mais poderia ser um problema?  Ent√£o ele come√ßou a escalar o c√≥digo, levou algum tempo, talvez at√© alguns dias.  At√© que finalmente olhei para essa classe e superclasse e encontrei uma coisa suspeita l√°: <br><br><img src="https://habrastorage.org/webt/ug/iz/qz/ugizqze3zr1gmexqfzgxfzqtb_o.jpeg"><br><br>  Algu√©m j√° percebeu, certo?  Isso mesmo: na classe filho e na classe pai, existe um m√©todo com o mesmo nome e ele n√£o chama super. <br><br>  E em Java, √© muito f√°cil: pressione Alt + Enter ou Ctrl + Insert no IntelliJ IDEA ou Eclipse; por padr√£o, ele cria o m√©todo setUp () para voc√™ e voc√™ n√£o percebe que ele substitui o m√©todo na superclasse.  Ou seja, o cache ainda n√£o foi chamado.  Quando vi isso, fiquei com muita raiva.  √â alegre para mim agora. <br><br>  Da√≠ a moral: <br><br><ol><li>  Nos testes, √© muito importante monitorar o c√≥digo limpo.  Se no c√≥digo de produ√ß√£o todos est√£o atentos a isso, eles realizam uma revis√£o de c√≥digo e, em seguida, nos testes - nem sempre. </li><li>  Se o c√≥digo de produ√ß√£o for verificado por testes, quem testar√° os testes?  Portanto, √© especialmente importante usar verifica√ß√µes no IDE. </li></ol><br>  Ap√≥s esse incidente, encontrei na IDEA uma inspe√ß√£o desse tipo, desativada por padr√£o, que verifica: se o m√©todo for substitu√≠do em algum lugar, mas n√£o houver anota√ß√£o @ Overrid, isso marca isso como um erro.  Agora eu sempre marquei histericamente esta caixa. <br><br>  Vamos resumir novamente: como isso aconteceu, por que o teste falhou nem sempre?  Primeiro, dependia da ordem desses dois testes; eles sempre s√£o executados em ordem aleat√≥ria.  Outro teste dependia de quanto tempo passou entre eles.  As contas s√£o armazenadas em cache por cinco minutos; se mais foram aprovadas, o teste ficou verde e, se menos, caiu, e isso raramente aconteceu. <br><br>  Expandimos a lista de por que os testes podem ser inst√°veis: <br><br><ul><li>  Velocidade de solicita√ß√£o do Ajax; </li><li>  A ordem dos pedidos do Ajax; </li><li>  Velocidade js; </li><li>  Tamanho da janela do navegador; </li><li>  Cache de aplicativos; </li><li>  Dados de testes anteriores; </li><li>  Hora. </li></ul><br><h2>  Exemplo 4: Hora do Java </h2><br>  Houve um teste que funcionou em todos os nossos computadores e no nosso Jenkins, mas √†s vezes trava em um cliente Jenkins.  N√≥s olhamos para o teste, entendemos o porqu√™.  Acontece que estava caindo, porque ao verificar "a data do pagamento deveria ser agora ou no passado", acabou sendo "no futuro". <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> payment.time &lt;= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date();</code> </pre><br>  Observamos o c√≥digo, de repente, sob algumas condi√ß√µes, podemos definir uma data no futuro?  N√£o podemos: no √∫nico local em que a hora do pagamento √© inicializada, nova data () √© usada e essa √© sempre a hora atual (em casos extremos, pode ser no passado se o teste for muito lento).  Como isso √© poss√≠vel?  Eles bateram de cabe√ßa por um longo tempo, eles n√£o conseguiram entender. <br><br>  E uma vez que eles examinaram o log do aplicativo.  Da√≠ a primeira moral - √© muito √∫til ao examinar testes para examinar o log do pr√≥prio aplicativo.  Levante suas m√£os, quem faz isso.  Em geral, n√£o a maioria, infelizmente.  E h√° informa√ß√µes √∫teis: por exemplo, o log de solicita√ß√µes, tal e qual URL foi executado naquele momento, deu tal e tal resposta. <br><br><img src="https://habrastorage.org/webt/z5/ca/cv/z5cacvqul4e4p9gw_lltdzoqk2c.jpeg"><br><br>  H√° algo suspeito aqui, percebe?  Observamos o momento: esse pedido foi processado menos tr√™s segundos.  Como isso pode ser?  Eles lutaram por um longo tempo, n√£o conseguiam entender.  Finalmente, quando ficamos sem teoria, tomamos uma decis√£o est√∫pida: Jenkins escreveu um script simples que registra a hora atual em um ciclo uma vez por segundo.  Lan√ßado.  No dia seguinte, quando esse teste superficial caiu uma vez √† noite, eles come√ßaram a assistir a um trecho desse arquivo para o momento em que ele caiu: <br><br><img src="https://habrastorage.org/webt/yn/et/wx/ynetwxiyv1bc7kzmcgfafqolso8.jpeg"><br><br>  Ent√£o: 34 segundos, 35, 36, 37, 35, 39 ... √â legal termos encontrado, mas como isso √© poss√≠vel?  As teorias terminaram novamente, mais dois dias co√ßando a cabe√ßa.  Este √© realmente o caso quando o Matrix est√° brincando com voc√™, certo? <br><br>  At√© que finalmente uma id√©ia me atingiu ... E isso acabou sendo.  O Linux possui um servi√ßo de sincroniza√ß√£o de tempo que √© executado em um servidor central e pergunta "quantos milissegundos s√£o agora?"  E acontece que dois servi√ßos diferentes foram lan√ßados nesse Jenkins espec√≠fico.  O teste come√ßou a falhar quando o Ubuntu foi atualizado neste servidor. <br><br>  L√°, um servi√ßo NTP era configurado anteriormente, que acessava um servidor banc√°rio especial e levava tempo a partir da√≠.  E com a nova vers√£o do Ubuntu, um novo servi√ßo leve foi inclu√≠do por padr√£o, por exemplo, systemd-timesyncd.  E ambos funcionaram.  Ningu√©m percebeu isso.  Por alguma raz√£o, o servidor do banco central e o servidor Ubuntu central emitiram uma resposta com uma diferen√ßa de 3 segundos.  Naturalmente, esses dois servi√ßos interferiram um no outro.  Em algum lugar profundo da documenta√ß√£o do Ubuntu, ele diz que, √© claro, n√£o permite essa situa√ß√£o ... Bem, obrigado pela informa√ß√£o :) <br><br>  A prop√≥sito, ao mesmo tempo, aprendi uma nuance interessante de Java, que antes disso, apesar de meus muitos anos de experi√™ncia, n√£o conhecia.  Um dos m√©todos mais b√°sicos em Java √© chamado System.currentTimeMillis (), com a ajuda do qual normalmente √© programado para chamar algo, muitos escreveram esse c√≥digo: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start = System.currentTimeMillis(); <span class="hljs-comment"><span class="hljs-comment">// ... long end = System.currentTimeMillis(); log.info("Loaded in {} ms", end-start);</span></span></code> </pre><br>  Esse c√≥digo est√° nas bibliotecas Apache Commons, Guava.  Ou seja, se voc√™ precisar detectar quantos milissegundos foram necess√°rios para chamar alguma coisa, eles geralmente o fazem.  E muitos provavelmente ouviram que isso n√£o deveria ser feito.  Eu tamb√©m ouvi, mas n√£o sabia o porqu√™, e com pregui√ßa de entender.  Eu pensei que a pergunta era exatamente porque System.nanoTime () apareceu em alguma vers√£o do Java - √© mais preciso, produz nanossegundos que s√£o um milh√£o de vezes mais precisos.  E, como regra, minhas chamadas duram um segundo ou meio segundo, essa precis√£o n√£o √© importante para mim e continuei a usar System.currentTimeMillis (), que vimos no log em que eram -3 segundos.  Ent√£o, de fato, a maneira correta √© essa, e agora eu descobri o porqu√™: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> start = System.nanoTime(); <span class="hljs-comment"><span class="hljs-comment">// ... long end = System.nanoTime(); log.info("Loaded in {} ms", (end-start)/1000000);</span></span></code> </pre><br>  Na verdade, isso est√° escrito na documenta√ß√£o dos m√©todos, mas eu nunca o li.  Durante toda a minha vida, pensei que System.currentTimeMillis () e System.nanoTime () s√£o a mesma coisa, mas com uma diferen√ßa de um milh√£o de vezes.  Mas aconteceu que essas s√£o coisas fundamentalmente diferentes. <br><br>  System.currentTimeMillis () retorna a data atual real - quantos milissegundos s√£o agora desde 1¬∫ de janeiro de 1970.  E System.nanoTime () √© um tipo de contador abstrato que n√£o est√° vinculado ao tempo real: sim, √© garantido que ele cres√ßa a cada nanossegundo por unidade, mas n√£o esteja conectado ao hor√°rio atual, pode at√© ser negativo.  No in√≠cio da JVM, um ponto no tempo √© de alguma forma selecionado aleatoriamente e come√ßa a crescer.  Foi uma surpresa para mim.  Para voc√™ tamb√©m?  Bem, n√£o foi em v√£o que ele chegou. <br><br><h2>  Exemplo 5: A maldi√ß√£o do bot√£o verde </h2><br>  Aqui, nosso teste preenche um determinado formul√°rio, clica no bot√£o verde Confirmar e, √†s vezes, n√£o vai mais longe.  Por que isso n√£o acontece √© incompreens√≠vel. <br><br><img src="https://habrastorage.org/webt/cb/wq/fe/cbwqfenxe6_sfzyescgepr5m8tg.png"><br><br>  Dirigimos quatro zeros e travamos, n√£o v√° para a pr√≥xima p√°gina.  Clicar ocorre sem erros.  Eu olhei para tudo: solicita√ß√µes do Ajax, espera, tempo limite, logs de aplicativos, cache - n√£o encontrei nada.  A biblioteca do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gravador de v√≠deo</a> escrita por Sergey Pirogov ainda n√£o apareceu.  Permite, adicionando uma anota√ß√£o ao c√≥digo, gravar v√≠deo.  Pude gravar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo</a> desse teste, assisti-lo em c√¢mera lenta e isso finalmente esclareceu a situa√ß√£o que eu n√£o conseguia resolver por v√°rios meses antes do v√≠deo. <br><br><img src="https://habrastorage.org/webt/i_/gz/_j/i_gz_jsw_vswjbeql9s2lwsefga.png"><br><br>  A barra de progresso bloqueou o bot√£o por uma fra√ß√£o de segundo e o clique funcionou exatamente naquele momento e atingiu essa barra de progresso.  Ou seja, a barra de progresso clicou e desapareceu!  E n√£o ser√° vis√≠vel em nenhuma captura de tela, em nenhum log, voc√™ nunca saber√° o que aconteceu. <br><br>  Em princ√≠pio, isso √©, de certa forma, um bug do aplicativo: uma barra de progresso apareceu porque o aplicativo realmente sai da borda da tela e, se voc√™ rolar, s√£o muitos dados √∫teis.  Mas os usu√°rios n√£o se queixaram disso, porque tudo se encaixava na tela grande, n√£o se encaixava apenas na tela pequena. <br><br><h2>  Exemplo 6: por que o Chrome congela? </h2><br>  Uma investiga√ß√£o de detetive de dois anos √© um caso absolutamente real.  A situa√ß√£o √© a seguinte: nossos testes muitas vezes eram escassos e ca√≠am, e nos rastros da pilha ficou claro que o Chrome congela: n√£o o nosso teste, ou seja, o Chrome.  Nos logs, era vis√≠vel "A constru√ß√£o est√° executando 36 horas ..." Eles come√ßaram a remover despejos de encadeamentos e rastreamentos de pilha - eles mostram que est√° tudo bem nos testes, a chamada para o Chromedriver trava e, como regra, no momento do fechamento (chamamos o m√©todo close, e esse m√©todo n√£o faz nada, demora 36 horas).  Se interessante, o rastreamento da pilha ficou assim: <br><br><img src="https://habrastorage.org/webt/fz/ew/1e/fzew1eu0u-e3oatl1age_oqhnso.jpeg"><br><br>  Tentamos fazer tudo o que s√≥ poderia vir √† mente: <br><br><ul><li>  Configure o tempo limite para abrir / fechar o navegador (se voc√™ n√£o conseguir abrir / fechar o navegador em 15 segundos, tente novamente ap√≥s 15 segundos, at√© tr√™s tentativas).  Abra e feche o navegador em um thread separado.  Resultado: as tr√™s tentativas foram suspensas da mesma maneira. </li><li>  Mate processos antigos do Chrome.  Eles criaram um trabalho separado no 'kill-chrome' de Jenkins, por exemplo, assim, voc√™ pode "matar" todos os processos anteriores a uma hora: <br><br>  killall --older-than 1h cromedriver <br>  killall - mais de 1h de cromo <br><br>  Isso pelo menos liberou mem√≥ria, mas n√£o deu uma resposta para a pergunta "o que est√° acontecendo?".  De fato, isso s√≥ nos atrasou no momento da decis√£o. </li><li>  Habilite os logs do aplicativo de depura√ß√£o. </li><li>  Habilite os logs de depura√ß√£o do WebDriver. </li><li>  Reabra o navegador ap√≥s cada 20 testes.  Pode parecer rid√≠culo, mas o pensamento era: "E se o Chrome congelar porque est√° cansado?"  Bem, um vazamento de mem√≥ria ou outra coisa. </li></ul><br>  O resultado da √∫ltima tentativa foi completamente inesperado: o problema come√ßou a se repetir com mais frequ√™ncia!  Esper√°vamos que isso ajudasse a estabilizar o Chrome para que funcionasse melhor.  Geralmente, esse √© um argumento do c√©rebro.  Mas, de fato, quando o problema come√ßa a se repetir com mais frequ√™ncia, n√£o se deve ficar triste, mas se alegrar!  Isso torna poss√≠vel estud√°-lo melhor.  Se ela come√ßar a repetir com mais frequ√™ncia, deve-se apegar a ela: "Sim, sim, agora vou adicionar outra coisa, logs, pontos de interrup√ß√£o ..." <br><br>  Estamos tentando repetir o problema: escrevemos um ciclo de 1 a 1000, no ciclo simplesmente abrimos o navegador e fechamos a primeira p√°gina em nosso aplicativo.  N√≥s escrevemos esse ciclo, e ... bingo!  Resultado: o problema come√ßou a se repetir de forma est√°vel (embora aproximadamente a cada 80 itera√ß√µes)!  Legal!  √â verdade que essa conquista n√£o deu nada por um longo tempo.  Voc√™ iniciou, esperou a 80¬™ itera√ß√£o, o Chrome travou ... e depois o que fazer?  Voc√™ olha para rastreamentos de pilha, lix√µes, logs - n√£o h√° nada √∫til l√°.  As Ferramentas do desenvolvedor no Chrome podem ajudar, mas at√© setembro de 2017 essas ferramentas n√£o funcionavam com o Selenium (as portas estavam em conflito: voc√™ inicia o Chrome a partir do Selenium e o DevTools n√£o abre).  Durante muito tempo, n√£o consegui pensar no que fazer. <br><br>  E aqui nesta hist√≥ria come√ßa um momento fabuloso.  Depois que, depois de um n√∫mero infinito de tentativas, executei esses testes novamente, ele travou novamente em algum tipo de itera√ß√£o como a 56. Acho que ‚Äúvamos cavar outra coisa‚Äù (embora eu n√£o saiba mais onde colocar o ponto de interrup√ß√£o ou o que adicione um log).  Neste momento, minha filha se oferece para jogar cubos, mas meu teste fica parado aqui.  Eu digo: "Espere", ela me disse: "O que voc√™ n√£o entende, eu tenho <b>um b e um</b> aqui!" <br><br>  O que fazer, infelizmente saiu do computador, foi jogar cubos ... E de repente, depois de cerca de 20 minutos, acidentalmente olho para a tela e vejo uma imagem completamente inesperada: <br><br><img src="https://habrastorage.org/webt/hm/7o/6p/hm7o6peoyj0zroryt-8g-osfvkc.jpeg"><br><br>  O que acontece: h√° uma contagem regressiva, ap√≥s quantos minutos a sess√£o expira, e eu construo uma torre de cubos, h√° dois, um ... a sess√£o expira, o teste continua, corre at√© o fim e cai (n√£o h√° mais nenhum elemento, a sess√£o expirou). <br><br>  O que acontece: o Chrome realmente n√£o congelou, como pens√°vamos durante todo esse tempo, estava esperando por algo o tempo todo.  Quando a sess√£o expirou, esperou, continuou.  O que exatamente o Chrome esperava - √© completamente incompreens√≠vel entender isso, eu tive que vasculhar todo o c√≥digo usando o m√©todo de pesquisa bin√°ria: jogar metade do JavaScript e HTML, tentar repetir 80 itera√ß√µes novamente - n√£o travou, oh, isso significa algum lugar l√° fora ... Em geral, entendemos experimentalmente que o problema est√° aqui: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout = setTimeout(sessionWatcher);</code> </pre><br>      JavaScript ‚Äî  ,   ,   . ,  JavaScript- ,      : ,     &lt;script&gt;  .  ,  , ,         ,    .     JavaScript ‚Äî   jQuery,   $,     function   ,      : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> timeout; $(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ timeout = setTimeout(...); });</code> </pre> <br>   -, , , .      ,    .         1000 ,   . <br><br> ,       : ,  ,    ,      .  ,   Chrome,   . ,        . <br><br>    ,     flaky-  , , ,         .  ,       ‚Äî ,       ,     (  ).    ,      .  ,     :   ? <br><br>     Chrome       flaky-:       -,   ,    ,    . <br><br>  UI-  :    ,             .    click(),          ,       . , ,  :  click()   ,       . -   , ?  :) <br><br>       .   ,    ,   ,       . ,     ,   ,    ,        Docker. <br><br>  ,    - ,    .     : <br><br><ul><li>  Ajax-; </li><li>  Ajax-; </li><li>  JS; </li><li>   ; </li><li>  ; </li><li>    ; </li><li> ; </li><li>  ; </li><li> UI-; </li><li>   ( ). </li></ul><br>    flaky-    ,     . ,   -,    :  ,   . <br><br>       .  ¬´¬ª .    ,  flaky- ,                 ID,  flaky-    .        . <br><br>   ,  :    ,   ,      . <br><br>  ,  flaky-     usability,   -,       flaky-  .            . <br><br>   ,       ,      ‚Ä¶      ,    , ,  flaky-  security-,     .     ,      ! <br><br>    ,    ,     flaky-: <br><br><ul><li>  ; </li><li> Selenide; </li><li>  ; </li><li>     . </li></ul><br>  ‚Äî   .     flaky- ,  unit-    ,  UI-?  ,    (   ),      ,     flaky. <br><br>  Selenide  . <br><br> .              (,   /   ).   ,     ¬´      ?¬ª.      ,  ,    .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ,   . <br><br>       ,    .    ,    ,    ,   ,      .      :     ¬´ ¬ª, ,         (10 , 20 ,   ‚Äî ,   ‚Äî  ).       ,   flaky -   . <br><br>     ,   flaky- : <br><br><ol><li>   ; </li><li> ; </li><li>  V√≠deo </li></ol><br>  ¬´   ¬ª    ,    ,   ,   : -         .      ¬´¬ª,  ¬´¬ª  ,  :   flaky-,      ,    flaky.  ,   ,   .     . ,    Jenkins pipeline,   Jenkins      : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { stage(<span class="hljs-string"><span class="hljs-string">"Reports"</span></span>) { junit <span class="hljs-string"><span class="hljs-string">'build/test-results/**/*.xml'</span></span> artifacts = <span class="hljs-string"><span class="hljs-string">'build./reports/**/*,build/test-results/**/*,logs/**/*'</span></span> archiveArtifacts artifacts: artifacts } }</code> </pre><br>  finally    ,    .   :    -  - .  Jenkins        ,  . ,   Jenkins       ,   .   ,  . <br><br>       (Selenide   ,     ).      flaky-.  ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Video Recorder</a> ,    :      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">video</a> ‚Äî  ,    ! <br><br>    ,      Docker:    TestContainers (    Heisenbug <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ).       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Rule</a> ,   ‚Äî      Docker    ,  ,     .           . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BrowserWebDriverContainer chrome = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BrowserWebDriverContainer() .withRecordingMode(RECORD_ALL, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"build"</span></span>)) .withDesiredCapabilities(chrome());</code> </pre><br>  . <br><br>     . , ,    ,   , ,     .      flaky-        . <br><br> ,   !  ,    :)        .     ,    ¬´     ,    ,  ¬ª,       ,      . <br><br>     ‚Äî , ,   ,   , -   .      ‚Äî    ,    ‚Ä¶ ! :)       flaky-  ‚Äî :    ! <br><br><blockquote>     ,  : 6-7  <b>Heisenbug</b>    .      ,   ,       .     (,  ,  )    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt416757/">https://habr.com/ru/post/pt416757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt416743/index.html">Bot para Starcraft em Rust, C e qualquer outro idioma</a></li>
<li><a href="../pt416745/index.html">Novo ASUS ROG na Computex 2018</a></li>
<li><a href="../pt416751/index.html">Coleta de informa√ß√µes contextuais para log</a></li>
<li><a href="../pt416753/index.html">O popular plugin Hola VPN comprometido</a></li>
<li><a href="../pt416755/index.html">Extreme Likes - Comit√™ de Investiga√ß√£o Contra</a></li>
<li><a href="../pt416759/index.html">Por que a intelig√™ncia artificial n√£o resolver√° todos os problemas</a></li>
<li><a href="../pt416761/index.html">Linguagem c√≥smica, parte 1: a gram√°tica universal √© universal?</a></li>
<li><a href="../pt416763/index.html">Puppet Salt Chef Ensemble: Compare Ansible, SaltStack, Chef e Puppet</a></li>
<li><a href="../pt416765/index.html">Empresa Foliplast: um ciclo completo de produ√ß√£o digital na R√∫ssia</a></li>
<li><a href="../pt416767/index.html">Um empate para voc√™ ou uma auditoria com hackers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>