<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎻 🐟 🗄️ Bagaimana kami mengoptimalkan Rumah Sakit Tema kami untuk platform yang berbeda 👃🏽 🍶 🎢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Project Hospital adalah permainan tentang mengelola bangunan rumah sakit dengan semua aspek standar genre: adegan dinamis yang dibuat oleh pemain, ban...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana kami mengoptimalkan Rumah Sakit Tema kami untuk platform yang berbeda</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459256/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d81/165/b28/d81165b28ad475a63a06e9d674be2bd7.png" alt="gambar"></div><br>  Project Hospital adalah permainan tentang mengelola bangunan rumah sakit dengan semua aspek standar genre: adegan dinamis yang dibuat oleh pemain, banyak karakter dan objek aktif, yang digunakan oleh sistem UI.  Untuk membuat gim bekerja pada peralatan yang berbeda, kami harus melakukan banyak upaya, dan ini adalah contoh yang bagus dari "kematian akibat ribuan pemotongan" yang terkenal - banyak langkah kecil yang memecahkan banyak masalah yang sangat spesifik dan banyak waktu yang dihabiskan untuk membuat profil. <br><br><h2>  Tingkat kinerja: apa yang ingin kita capai </h2><br>  Pada tahap awal pengembangan, kami memutuskan parameter utama: ukuran maksimum adegan, tingkat kinerja, dan persyaratan sistem. <br><br>  Kami menetapkan sendiri tugas memberikan dukungan untuk setidaknya seratus karakter aktif dan animasi penuh pada satu layar, total tiga ratus karakter aktif, peta ubin berukuran sekitar 100x100 dan hingga empat lantai di gedung. <br><br>  Kami sangat yakin bahwa permainan harus bekerja dalam 1080p dengan frame rate yang layak bahkan pada kartu grafis terintegrasi, dan tujuan itu sendiri tidak begitu sulit untuk dicapai: faktor pembatas utama adalah CPU, terutama dengan peningkatan volume rumah sakit.  Kartu grafis terintegrasi modern mulai mengalami masalah hanya pada resolusi sekitar 2560 x 1440. <br><br>  Untuk menyederhanakan dukungan mod, sebagian besar data dibuat terbuka, yaitu, kami harus mengorbankan kinerja yang dicapai dengan mengemas file, tetapi ini tidak memiliki dampak yang sangat kuat, kecuali untuk waktu pengunduhan yang sedikit lebih lama. <br><a name="habracut"></a><br><h2>  Grafik </h2><br>  Project Hospital adalah gim 2D isometrik "klasik", sehingga Anda dapat memahami bahwa semuanya ditarik kembali ke depan - di Unity ini dilakukan dengan menetapkan nilai yang sesuai di sepanjang sumbu Z (atau jarak ke kamera) untuk masing-masing objek grafis.  Jika memungkinkan, objek yang tidak berinteraksi satu sama lain diatur dalam lapisan, misalnya, lantai tidak tergantung pada objek dan karakter. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a5/951/079/8a59510793f4c7eb1be7b2dd206c1c17.png"></div><br>  Semua geometri dalam adegan yang dirender secara isometrik secara dinamis dibuat dalam C #, jadi salah satu dari dua aspek terpenting untuk kinerja grafis adalah frekuensi pembangunan kembali geometri.  Aspek kedua adalah jumlah panggilan undian. <br><br><h2>  Buat panggilan </h2><br>  Jumlah objek individu yang ditarik dalam satu bingkai, terlepas dari kesederhanaannya, adalah batasan utama, terutama pada peralatan yang buruk (di samping itu, mesin Unity sendiri menambah konsumsi sumber daya yang berlebihan).  Solusi yang jelas adalah mengelompokkan (batch) objek grafik sebanyak mungkin menjadi satu panggilan draw.  Jadi, Anda bisa mendapatkan beberapa hasil yang cukup menarik, misalnya, mengelompokkan objek yang berada pada jarak yang sama dari kamera sehingga sisa gambar ditampilkan dengan benar di belakang atau di depan mereka. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fde/96e/f3d/fde96ef3dd1e2f0f4b6972e8b947654b.png"></div><br>  Berikut adalah beberapa angka: pada ubin 96 x 96, Anda secara teoritis dapat menempatkan 9216 objek, yang akan membutuhkan 9216 panggilan draw.  Setelah batching, jumlah ini turun menjadi 192. <br><br>  Namun, dalam kehidupan nyata, semuanya sedikit lebih rumit, karena Anda hanya dapat mengelompokkan objek dengan tekstur yang sama, yang membuat hasilnya sedikit kurang optimal, tetapi sistem masih bekerja dengan cukup baik. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93d/306/134/93d3061341005108c6638c2ad67f17bd.png"></div><br>  Sebagian besar batch dilakukan secara manual untuk memiliki kendali atas hasil.  Selain itu, sebagai upaya terakhir, kami juga menggunakan batching dinamis Unity, tetapi ini adalah pedang bermata dua - ini sebenarnya membantu mengurangi jumlah panggilan draw, tetapi mengarah ke sumber daya yang tidak perlu di setiap frame, dan dalam beberapa kasus itu bisa tidak dapat diprediksi.  Sebagai contoh, dua sprite yang dilapiskan pada jarak yang sama dari kamera dalam bingkai yang berbeda dapat dirender dalam urutan yang berbeda, yang menyebabkan kerlipan yang tidak muncul saat batching manual. <br><br><h2>  Bertingkat </h2><br>  Pemain dapat membangun bangunan dengan beberapa lantai, dan ini meningkatkan kompleksitas, tetapi, yang mengejutkan, membantu kinerja.  Hanya karakter di lantai aktif dan di jalan yang harus dirender dan dianimasikan, dan semua yang ada di lantai lain rumah sakit dapat disembunyikan. <br><br><h2>  Shader </h2><br>  Rumah Sakit Proyek menggunakan shader yang ditulis sendiri yang relatif sederhana dengan trik-trik kecil, seperti pertukaran warna.  Misalkan karakter shader dapat menggantikan hingga lima warna (tergantung pada kondisi dalam kode shader), dan karenanya cukup mahal, tetapi ini sepertinya tidak menimbulkan masalah, karena karakter jarang menempati banyak ruang layar.  Shader membenarkan upaya yang dimasukkan ke dalamnya, karena kemampuan untuk menggunakan warna pakaian dalam jumlah tak terbatas dapat sangat meningkatkan variabilitas karakter dan lingkungan. <br><br>  Selain itu, kami cukup cepat belajar untuk menghindari menentukan parameter shader dan alih-alih menggunakan warna titik jika memungkinkan. <br><br><h2>  Kualitas tekstur </h2><br>  Fakta menarik - di Rumah Sakit Proyek kami tidak menggunakan kompresi tekstur: grafik dilakukan dalam gaya vektor, dan pada beberapa tekstur kompresi terlihat sangat buruk. <br><br>  Untuk menghemat memori CPU pada sistem dengan kurang dari 1 GB, kami secara otomatis mengurangi ukuran tekstur dalam game menjadi setengah resolusi (kecuali untuk tekstur antarmuka pengguna) - ini dapat dipahami dengan melihat parameter “kualitas tekstur: rendah” pada opsi.  Tekstur UI mempertahankan resolusi aslinya. <br><br><h2>  Optimalkan Kinerja CPU - Multithreading </h2><br>  Meskipun logika skrip Unity pada dasarnya adalah single-threaded, kami selalu memiliki kemampuan untuk menjalankan banyak utas secara langsung di C #.  Mungkin pendekatan ini tidak cocok untuk logika game, tetapi seringkali ada tugas-tugas penting yang dapat dilakukan dalam utas terpisah dengan mengatur sistem tugas.  Dalam kasus kami, utas digunakan untuk dua fungsi: <br><br>  1. Tugas menemukan jalur, terutama pada peta besar dengan pengaturan yang membingungkan, dapat memakan waktu hingga ratusan milidetik, jadi ini adalah kandidat utama untuk transfer dari aliran utama.  Tugas paralel memperhitungkan jumlah utas perangkat keras sebuah mesin. <br><br>  2. Kartu pencahayaan juga dapat diperbarui dalam aliran terpisah, tetapi hanya satu lantai pada satu waktu - ini bukan sistem yang kritis, dan lampu otomatis di kamar padam dengan kecepatan yang cukup sehingga pembaruan langka sudah cukup. <br><br><h2>  Animasi </h2><br>  Hampir di awal pengembangan, kami memutuskan untuk menggunakan sistem animasi kerangka dua dimensi.  Setelah mempelajari berbagai program animasi modern, kami akhirnya memutuskan untuk memodifikasi sistem sederhana yang saya buat beberapa tahun yang lalu (pada dasarnya sebagai proyek hobi), menyesuaikannya dengan kebutuhan Rumah Sakit Proyek - menyerupai Tulang Belakang yang disederhanakan dengan dukungan langsung untuk menciptakan variasi karakter.  Seperti Spine, ia menggunakan runtime C #, yang jelas lebih mahal daripada kode asli, jadi selama proses pengembangan kami melakukan beberapa siklus optimisasi.  Untungnya, rig kami cukup sederhana, hanya sekitar 20 tulang per karakter. <br><br>  Fakta yang aneh: peningkatan yang paling berguna dalam mengoptimalkan akses untuk mengubah tulang individu ternyata merupakan transisi dari pencarian peta ke pengindeksan array sederhana. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/462/f1e/440/462f1e440f6dbc3f7e77f4ff42986966.png"></div><br>  Selain fakta bahwa karakter tidak dianimasikan di luar kamera, ada trik lain: karakter yang tersembunyi di balik jendela UI utama juga tidak perlu dianimasikan.  Sayangnya, di versi final game, kami beralih ke UI yang tembus cahaya, jadi kami tidak bisa menggunakannya. <br><br><h2>  Caching </h2><br>  Jika memungkinkan, kami mencoba melakukan perhitungan paling mahal hanya dengan perubahan yang memengaruhi nilainya.  Contoh terbaik dari ini adalah kamar dan elevator: ketika pemain menempatkan lift atau membangun dinding, kami menjalankan algoritma pengisian yang menandai ubin tempat elevator dan kamar tersedia.  Ini mempercepat pencarian selanjutnya untuk jalur dan dapat digunakan untuk menunjukkan kepada pemain kamar mana yang belum tersedia. <br><br><h2>  Pembaruan yang tersebar dan ditangguhkan </h2><br>  Dalam beberapa kasus, logis untuk melakukan pembaruan tertentu hanya sebagian.  Berikut ini beberapa contohnya: <br><br>  Beberapa pembaruan dapat dilakukan di setiap bingkai hanya untuk sebagian karakter, misalnya, skrip perilaku setengah dari pasien diperbarui hanya dalam bingkai aneh, dan untuk paruh kedua - dalam bingkai genap (meskipun animasi dan gerakan dilakukan dengan lancar). <br><br>  Dalam kondisi tertentu, terutama ketika karakter dalam mode siaga, tetapi memanggil bagian mahal dari kode (misalnya, karyawan memeriksa apa yang perlu diisi dan mencari peralatan yang tidak dihuni), operasi hanya dilakukan pada interval tertentu, misalnya, sekali per detik. <br><br>  Salah satu tantangan umum yang paling mahal dan sekaligus adalah memeriksa tes mana yang tersedia untuk setiap pasien.  Pada saat yang sama, banyak faktor yang perlu dievaluasi - misalnya, personil departemen mana yang sedang sibuk dan peralatan apa yang dipesan.  Selain itu, informasi ini tidak umum untuk semua pasien karena dipengaruhi, misalnya, oleh dokter yang ditugaskan kepada mereka dan kemampuan mereka untuk berbicara.  Penting untuk memeriksa lusinan jenis analisis yang tersedia, oleh karena itu, dalam satu bingkai pembaruan dilakukan hanya untuk beberapa orang, dan berlanjut di yang berikutnya. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/014/1a6/e24/0141a6e2458e7edb58a0d96072faab8e.png"></div><br><h2>  Kesimpulan </h2><br>  Mengoptimalkan manajer permainan dengan banyak bagian yang berinteraksi telah terbukti menjadi proses yang panjang.  Saya secara teratur harus bekerja dengan profiler Unity dan memperbaiki masalah yang paling jelas, ini telah menjadi bagian integral dari proses pengembangan. <br><br>  Tentu saja, selalu ada ruang untuk perbaikan, tetapi kami cukup senang dengan hasilnya.  Gim ini mengatasi tugas kami, dan pemain terus-menerus membuat mod untuk itu, secara signifikan melebihi batas asli pada jumlah karakter. <br><br>  Perlu juga disebutkan bahwa bahkan dibandingkan dengan beberapa game AAA yang saya kerjakan, di Rumah Sakit Proyek saya bertemu dengan logika game paling kompleks dalam praktik saya, begitu banyak masalah khusus untuk proyek ini.  Meskipun demikian, saya tetap merekomendasikan untuk menyisihkan cukup waktu dalam proyek apa pun untuk pengoptimalan sesuai dengan kompleksitas permainan. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id459256/">https://habr.com/ru/post/id459256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id459246/index.html">Mengapa konversi situs menurun? Contoh 60 desain dan kesalahan penggunaan</a></li>
<li><a href="../id459248/index.html">Acara digital di Moskow dari 09 Juli hingga 14 Juli</a></li>
<li><a href="../id459250/index.html">WAL di PostgreSQL: 2. Prerecord log</a></li>
<li><a href="../id459252/index.html">Minggu Keamanan 28: meretas rumah pintar</a></li>
<li><a href="../id459254/index.html">Bom pos yang lebih baik</a></li>
<li><a href="../id459258/index.html">14.000 mil tidak terhubung</a></li>
<li><a href="../id459262/index.html">Pensiun pada 22</a></li>
<li><a href="../id459264/index.html">Keluar dari jaringan Tarantool. Sinkronisasi simpul saat memfilter lalu lintas</a></li>
<li><a href="../id459272/index.html">Menulis API untuk komponen Bereaksi, bagian 1: jangan membuat alat peraga yang bertentangan</a></li>
<li><a href="../id459274/index.html">Kerentanan Kunci Layar di Astra Linux Edisi Khusus (Smolensk)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>