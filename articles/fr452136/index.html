<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£üèΩ üåè ü•ö Tests de cod√©ception pour les backends PHP ‚ûø üìå üßëüèº‚Äçü§ù‚Äçüßëüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! Je m'appelle Pasha et je suis ing√©nieur QA pour l'√©quipe de traitement des commandes chez Lamoda. J'ai r√©cemment parl√© √† PHP Badoo Mee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tests de cod√©ception pour les backends PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/452136/">  Bonjour √† tous!  Je m'appelle Pasha et je suis ing√©nieur QA pour l'√©quipe de traitement des commandes chez Lamoda.  J'ai r√©cemment parl√© √† PHP Badoo Meetup.  Aujourd'hui, je veux fournir une transcription de mon rapport. <br><br>  Nous parlerons de Codeception, de la fa√ßon dont nous l'utilisons dans Lamoda et comment √©crire des tests dessus. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rg1h7mJrU7Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  Lamoda a de nombreux services.  Il existe des services clients qui interagissent directement avec nos utilisateurs, avec les utilisateurs du site, l'application mobile.  Nous n'en parlerons pas.  Et il y a ce que notre entreprise appelle des backends profonds - ce sont nos syst√®mes de back-office qui automatisent nos processus commerciaux.  Il s'agit notamment de la livraison, du stockage, de l'automatisation des studios photo et d'un centre d'appels.  La plupart de ces services sont d√©velopp√©s en PHP. <br><br>  En parlant bri√®vement de notre pile, voici PHP + Symfony.  Ici et l√†, il y a de vieux projets sur Zend'e.  PostgreSQL et MySQL sont utilis√©s comme bases de donn√©es, et Rabbit ou Kafka sont utilis√©s comme syst√®mes de messagerie. <br><br>  <b>Pourquoi les backends PHP?</b> <br><br>  Parce qu'ils ont g√©n√©ralement une API branch√©e - c'est soit REST, √† certains endroits, il y a un peu de SOAP.  S'ils ont une interface utilisateur, cette interface est plus une interface auxiliaire, que nos utilisateurs internes utilisent. <br><br>  <b>Pourquoi avons-nous besoin d'autotests chez Lamoda?</b> <br><br>  En g√©n√©ral, quand je suis venu travailler chez Lamoda, il y avait un tel slogan: ¬´D√©barrassons-nous de la r√©gression manuelle¬ª.  Nous ne testerons rien de r√©gression manuellement.  Et nous avons travaill√© sur cette t√¢che.  En fait, c'est l'une des principales raisons pour lesquelles nous avons besoin d'autotests - afin de ne pas conduire la r√©gression √† la main.  Pourquoi en avons-nous besoin?  Droit de lib√©rer rapidement.  Pour que nous puissions sans douleur, tr√®s rapidement d√©ployer nos versions et en m√™me temps avoir une sorte de grille d'auto-tests qu'ils nous diront, bonne ou mauvaise.  Ce sont probablement les objectifs les plus importants.  Mais il y a quelques auxiliaires, dont je veux √©galement parler. <br><br>  Pourquoi avons-nous besoin d'autotests? <br><br><ol><li>  Ne testez pas la r√©gression avec vos mains </li><li>  Lib√©ration rapide </li><li>  Utiliser comme documentation </li><li>  Acc√©l√©rez l'int√©gration de nouveaux employ√©s </li><li>  Les autotests sont commod√©ment utilis√©s (dans certains cas) comme documentation.  Parfois, il est plus facile d'entrer dans les tests, de voir quels cas sont couverts, comment ils fonctionnent et de comprendre comment telle ou telle fonctionnalit√© fonctionne, et d'acc√©l√©rer l'entr√©e de nouveaux employ√©s - d√©veloppeurs et testeurs - dans un nouveau projet.  Lorsque vous vous asseyez pour √©crire des autotests, il devient imm√©diatement clair comment fonctionne le syst√®me. </li></ol><br>  Ok, a expliqu√© pourquoi nous avons besoin d'autotests.  Parlons maintenant des tests que nous √©crivons dans Lamoda. <br><br><img src="https://habrastorage.org/webt/qx/ci/0f/qxci0fma8tivrntsz95gv-d802e.jpeg" alt="image"><br><br>  Il s'agit d'une pyramide de tests assez standard, des tests unitaires aux tests E2E, o√π certaines cha√Ænes commerciales sont d√©j√† test√©es.  Je ne parlerai pas des deux niveaux inf√©rieurs, ce n'est pas pour rien qu'ils sont peints d'une telle couleur blanche.  Ce sont des tests sur le code lui-m√™me, ils sont √©crits par nos d√©veloppeurs.  Dans les cas extr√™mes, le testeur peut acc√©der √† la demande de tirage, consulter le code et dire: "Eh bien, quelque chose ne suffit pas ici, couvrons autre chose."  Ceci termine le travail du testeur pour ces tests. <br><br>  Nous parlerons des niveaux ci-dessus, qui sont √©crits par des d√©veloppeurs et des testeurs.  Commen√ßons par les tests du syst√®me.  Ce sont des tests qui testent l'API (REST ou SOAP), testent la logique du syst√®me interne, diverses commandes, analysent les files d'attente dans Rabbit ou √©changent avec des syst√®mes externes.  En r√®gle g√©n√©rale, ces tests sont assez atomiques.  Ils ne v√©rifient aucune cha√Æne, mais v√©rifient une action.  Par exemple, une m√©thode API ou une commande.  Et ils v√©rifient autant de cas que possible, √† la fois positifs et n√©gatifs. <br><br>  Allez-y, tests E2E.  Je les ai divis√©s en 2 parties.  Nous avons des tests qui testent un tas d'interface utilisateur et de backend.  Et il y a des tests que nous appelons des tests de flux.  Ils testent la cha√Æne - la vie d'un objet du d√©but √† la fin. <br><br>  Par exemple, nous avons un syst√®me de gestion du traitement de nos commandes.  √Ä l'int√©rieur d'un tel syst√®me, il peut y avoir un test - une commande de la cr√©ation √† la livraison, c'est-√†-dire en passant par tous les statuts.  C'est sur de tels tests qu'il est alors tr√®s facile et simple de voir comment fonctionne le syst√®me.  Vous voyez imm√©diatement le flux entier de certains objets, avec quels syst√®mes externes tout cela interagit, quelles commandes sont utilis√©es pour cela. <br><br>  √âtant donn√© que cette interface utilisateur est utilis√©e par les utilisateurs internes, l'acc√®s inter-navigateur n'est pas important pour nous.  Nous ne r√©alisons ces tests sur aucune batterie de serveurs, il nous suffit de v√©rifier dans un navigateur, et parfois nous n'avons m√™me pas besoin d'utiliser un navigateur. <br><br>  "Pourquoi avons-nous choisi Codeception pour l'automatisation des tests?"  - vous demandez probablement. <br><br>  Pour √™tre honn√™te, je n'ai pas de r√©ponse √† cette question.  Quand je suis arriv√© √† Lamoda, Codeception √©tait d√©j√† s√©lectionn√© comme standard pour √©crire les autotests, et je l'ai rencontr√© en fait.  Mais apr√®s avoir travaill√© avec ce cadre pendant un certain temps, j'ai toujours compris pourquoi Codeception.  Voil√† ce que je veux partager avec vous. <br><br>  <b>Pourquoi codeception?</b> <br><br><ol><li>  Vous pouvez √©crire et ex√©cuter les m√™mes tests de toute nature (unitaires, fonctionnels, acceptation). </li><li>  De nombreux r√¢teaux ont d√©j√† √©t√© r√©solus, de nombreux modules ont d√©j√† √©t√© √©crits. </li><li>  Dans tous les projets, malgr√© des besoins l√©g√®rement diff√©rents, les tests seront identiques. </li><li>  Le concept de Codeception vous propose d'√©crire des tests sur ce framework: unit√©, int√©gration, fonctionnel, acceptation.  Et vous, au moins, ils seront lanc√©s √©galement. </li><li>  Codeception est un processeur assez puissant dans lequel de nombreux probl√®mes, de nombreuses questions, de nombreuses t√¢ches de tests ont d√©j√† √©t√© r√©solus.  Si quelque chose n'est pas d√©cid√©, vous trouverez tr√®s probablement quelque chose de l'ext√©rieur - un compl√©ment pour un travail sp√©cifique.  Vous n'avez pas besoin d'√©crire de wrappers de test pour les bases de donn√©es, pour autre chose.  Prenez et connectez simplement les modules √† Codeception et travaillez avec eux. </li><li>  Eh bien, un tel avantage (il est probablement plus adapt√© aux grandes entreprises lorsque vous avez de nombreux projets et services) - dans tous les projets, les tests seront plus ou moins les m√™mes.  C'est tr√®s cool. </li></ol><br>  Je vais dire bri√®vement √† quoi ressemble Codeception, car beaucoup y ont travaill√©. <br><br><img src="https://habrastorage.org/webt/bp/ac/nt/bpacntwtc_xvl52su3nh7-vvidi.jpeg" alt="image"><br><br>  Codeception fonctionne sur un mod√®le d'acteur.  Apr√®s l'avoir gliss√© dans le projet et initialis√©, une telle structure est g√©n√©r√©e. <br><br>  Nous avons des fichiers yml, ci-dessous - <i>fonctionnel.suite.yml</i> , <i>integration.suit.yml</i> , <i>unit.suite.yml</i> .  Ils cr√©ent la configuration de vos tests.  Il y a des papas pour chaque type de test, o√π ces tests sont, il y a 3 papas auxiliaires: <br><br>  _ <i>donn√©es</i> - pour les donn√©es de test; <br>  _ <i>sortie</i> - o√π les rapports sont plac√©s (xml, html); <br>  _ <i>support</i> - o√π certains assistants auxiliaires, fonctions et tout ce que vous √©crivez sont mis √† profit dans vos tests. <br><br>  Pour commencer, je vais vous dire ce que nous avons retir√© de Codeception et l'utiliser imm√©diatement, sans rien modifier, sans r√©soudre de t√¢ches ou de probl√®mes suppl√©mentaires. <br><br>  <b>Modules standard</b> <br><br><ol><li>  Phpbrowser </li><li>  REPOS </li><li>  Db </li><li>  Cli </li><li>  AMQP </li></ol><br>  Le premier de ces modules est PhpBrowser.  Ce module est un wrapper sur Guzzle qui vous permet d'interagir avec votre application: ouvrir des pages, remplir des formulaires, soumettre des formulaires.  Et si vous ne vous souciez pas des tests inter-navigateurs et des navigateurs, si vous testez soudainement l'interface utilisateur, vous pouvez utiliser PhpBrowser.  En r√®gle g√©n√©rale, nous l'utilisons dans nos tests d'interface utilisateur, car nous n'avons pas besoin de logique d'interaction compliqu√©e, nous devons simplement ouvrir la page et y faire quelque chose de petit. <br><br>  Le deuxi√®me module que nous utilisons est REST.  Je pense que le nom indique clairement ce qu'il fait.  Pour toute interaction http, vous pouvez utiliser ce module.  Il me semble que presque toutes les interactions y sont r√©solues: en-t√™tes, cookies, autorisation.  Tout ce dont vous avez besoin est dedans. <br><br>  Le troisi√®me module que nous utilisons hors de la bo√Æte est le module Db.  Dans les versions r√©centes de Codeception, la prise en charge non pas d'une, mais de plusieurs bases de donn√©es y a √©t√© ajout√©e.  Par cons√©quent, si vous avez soudainement plusieurs bases de donn√©es dans votre projet, cela fonctionne maintenant hors de la bo√Æte. <br><br>  Le module Cli, qui vous permet d'ex√©cuter <b>des</b> commandes <b>shell</b> et <b>bash √†</b> partir de tests, et nous l'utilisons √©galement. <br><br>  Il existe un module AMQP qui fonctionne avec tous les courtiers de messages bas√©s sur ce protocole.  Je veux noter qu'il est officiellement test√© sur RabbitMQ.  Puisque nous utilisons RabbitMQ, tout va bien avec lui. <br><br>  En fait, Codeception, du moins dans notre cas, couvre 80 √† 85% de toutes les t√¢ches dont nous avons besoin.  Mais je devais encore travailler sur quelque chose. <br><br>  Commen√ßons par SOAP. <br><img src="https://habrastorage.org/webt/c9/zy/bk/c9zybkm3eu-kvkxc_uvpcte_h0u.jpeg" alt="image"><br><br>  Dans nos services, il existe √† certains endroits des points de terminaison SOAP.  Ils doivent √™tre test√©s, tir√©s, quelque chose √† voir avec eux.  Mais vous direz que dans Codeception, il existe un tel module qui vous permet d'envoyer des demandes et ensuite de faire quelque chose avec les r√©ponses.  D'une mani√®re ou d'une autre pour analyser, ajouter des ch√®ques et tout va bien.  Mais le module SOAP ne fonctionne pas pr√™t √† l'emploi avec plusieurs points de terminaison SOAP. <br><img src="https://habrastorage.org/webt/uj/s_/zv/ujs_zvshqpzmecycdggm3mys4nq.jpeg" alt="image"><br><br>  Par exemple, nous avons des monolithes qui ont plusieurs WSDL, plusieurs points de terminaison SOAP.  Cela signifie qu'il est impossible dans le module Codeception de le configurer dans un fichier yml afin qu'il puisse fonctionner avec plusieurs. <br><img src="https://habrastorage.org/webt/uc/z-/ab/ucz-abgapgah_r9qo6uoitkstg8.jpeg" alt="image"><br><br>  Codeception a une reconfiguration de module dynamique, et vous pouvez √©crire une sorte d'adaptateur pour recevoir, par exemple, un module SOAP et le reconfigurer dynamiquement.  Dans ce cas, il est n√©cessaire de remplacer le point final et le sch√©ma utilis√©.  Ensuite, dans le test, si vous devez changer le point de terminaison auquel vous souhaitez envoyer une demande, nous obtenons notre adaptateur et le changeons en un nouveau point de terminaison, en un nouveau circuit et lui envoyons une demande. <br><img src="https://habrastorage.org/webt/68/iu/kl/68iuklk2oherxt4ov7odgrszyli.jpeg" alt="image"><br><br>  Dans Codeception, il n'y a pas de travail avec Kafka et il n'y a pas de modules compl√©mentaires plus ou moins officiels tiers pour travailler avec Kafka.  Il n'y a rien √† craindre, nous avons √©crit notre module. <br><img src="https://habrastorage.org/webt/es/gp/eg/esgpegswio_kwmtqer7gkqvjfgi.jpeg" alt="image"><br><br>  Il est donc configur√© dans un fichier yml.  Certains param√®tres sont d√©finis pour les courtiers, les consommateurs et les sujets.  Ces param√®tres, lorsque vous √©crivez votre module, vous pouvez ensuite le tirer dans des modules avec la fonction d'initialisation et initialiser ce module avec les m√™mes param√®tres.  Et, en fait, le module a toutes les autres m√©thodes √† impl√©menter - mettez le message dans la rubrique et lisez-le.  C'est tout ce dont vous avez besoin de ce module. <br><img src="https://habrastorage.org/webt/zo/5p/bo/zo5pbox8a8xxic2n8972phohhd0.jpeg" alt="image"><br><br>  <b>Conclusion</b> : les modules pour Codeception sont faciles √† √©crire. <br><br>  Allez-y.  Comme je l'ai dit, Codeception a un module Cli - un wrapper pour <i>les</i> commandes <i>shell</i> et travaillant avec leur sortie. <br><img src="https://habrastorage.org/webt/8c/gg/yr/8cggyrxinincflxsx2ti3o4klwq.jpeg" alt="image"><br><br>  Mais parfois, la commande <i>shell</i> doit √™tre ex√©cut√©e non pas dans les tests, mais dans l'application.  En g√©n√©ral, les tests et les applications sont des entit√©s l√©g√®rement diff√©rentes, elles peuvent se situer √† diff√©rents endroits.  Les tests peuvent √™tre ex√©cut√©s √† un endroit et l'application peut √™tre √† un autre. <br><br>  Alors, pourquoi devons-nous ex√©cuter <i>shell</i> dans les tests? <br><br>  Nous avons des commandes dans les applications qui, par exemple, analysent les files d'attente dans RabbitMQ et d√©placent les objets par statut.  Ces commandes en mode pro sont lanc√©es sous le superviseur.  Le superviseur surveille leur mise en ≈ìuvre.  S'ils tombent, alors il les recommence et ainsi de suite. <br><br>  Lorsque nous testons, le superviseur ne fonctionne pas.  Sinon, les tests deviennent instables, impr√©visibles.  Nous voulons nous-m√™mes contr√¥ler le lancement de ces commandes √† l'int√©rieur de l'application.  Par cons√©quent, nous devons ex√©cuter ces commandes √† partir des tests de l'application.  Nous utilisons deux options.  Celui-l√†, que l'autre - en principe, tout est pareil, et tout fonctionne. <br><br>  Comment ex√©cuter un <i>shell</i> dans une application? <br><br>  Tout d'abord: ex√©cutez les tests au m√™me endroit o√π se trouve l'application.  √âtant donn√© que toutes les applications que nous avons dans Docker, les tests peuvent √™tre ex√©cut√©s dans le m√™me conteneur o√π se trouve le service lui-m√™me. <br><br>  La deuxi√®me option: cr√©er un conteneur s√©par√© pour les tests, un certain <i>lanceur de test</i> , mais le rendre identique √† l'application.  Autrement dit, √† partir de la m√™me image Docker, puis tout fonctionnera de la m√™me mani√®re. <br><img src="https://habrastorage.org/webt/wm/hw/g0/wmhwg0-0xviw0be73xgrwfppsfi.jpeg" alt="image"><br><br>  Un autre probl√®me que nous avons rencontr√© lors des tests est de travailler avec diff√©rents syst√®mes de fichiers.  Vous trouverez ci-dessous un exemple de ce avec quoi vous pouvez et devez travailler.  Les trois premiers sont pertinents pour nous.  Ce sont Webdav, SFTP et le syst√®me de fichiers Amazon. <br><br>  Avec quoi avez-vous besoin de travailler? <br><br><ol><li>  Webdav </li><li>  FTP / SFTP </li><li>  AWS S3 </li><li>  Local </li><li>  Azure, Dropbox, Google Drive </li></ol><br>  Si vous fouillez dans Codeception, vous pouvez trouver des modules pour presque tous les syst√®mes de fichiers plus ou moins populaires. <br><br><img src="https://habrastorage.org/webt/84/kr/ol/84krold4wqwi4ckxe4trmr8u9oq.jpeg" alt="image"><br><br>  La seule chose que je n'ai pas trouv√©e est pour Webdav.  Mais ces syst√®mes de fichiers, plus ou moins, sont les m√™mes en termes de travail externe avec eux, et nous voulons travailler avec eux de la m√™me mani√®re. <br><br>  Nous avons √©crit notre module appel√© Flysystem.  Il se trouve sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github</a> dans le domaine public et prend en charge 2 syst√®mes de fichiers - SFTP et Webdav - et vous permet de travailler avec les deux en utilisant la m√™me API. <br><img src="https://habrastorage.org/webt/5a/w5/sm/5aw5smemb1fabsbsyvt5eit70r8.jpeg" alt="image"><br><br>  Obtenez une liste de fichiers, nettoyez le r√©pertoire, √©crivez un fichier, etc.  Si vous y ajoutez √©galement le syst√®me de fichiers Amazon, nos besoins seront certainement couverts. <br><br>  Le point suivant, je pense, est tr√®s important pour les autotests, en particulier au niveau du syst√®me, c'est de travailler avec des bases de donn√©es.  En g√©n√©ral, je veux que ce soit, comme dans l'image, - VZHUH et tout d√©marre, cela fonctionne, et ces bases de donn√©es devraient √™tre moins prises en charge dans les tests. <br><img src="https://habrastorage.org/webt/hb/-y/ul/hb-yulyfmetwazoatr4oukazpli.jpeg" alt="image"><br><br>  Quelles sont les principales t√¢ches que je vois ici: <br><br><ol><li>  Comment d√©ployer la base de donn√©es de la structure souhait√©e - Db </li><li>  Comment remplir la base de donn√©es avec des donn√©es de test - Db, Fixtures </li><li>  Comment faire des s√©lections et des contr√¥les - Db </li></ol><br>  Pour les 3 t√¢ches de Codeception, il y a 2 modules - Db, dont j'ai d√©j√† parl√©, un autre est appel√© Fixtures. <br><br>  De ces 2 modules et 3 t√¢ches, nous utilisons uniquement DB pour la troisi√®me t√¢che. <br><br>  Pour la premi√®re t√¢che, vous pouvez utiliser DB.  L√†, vous pouvez configurer le vidage SQL √† partir duquel la base de donn√©es sera d√©ploy√©e, eh bien, le module avec des accessoires, je pense que c'est clair pourquoi il est n√©cessaire. <br><br>  Il y aura des appareils sous forme de tableaux qui peuvent √™tre conserv√©s dans la base de donn√©es. <br><br>  Comme je l'ai dit, les 2 premi√®res t√¢ches que nous r√©solvons un peu diff√©remment, maintenant je vais vous dire comment nous le faisons. <br><br>  <b>D√©ploiement de la base de donn√©es</b> <br><br><ol><li>  Relever un conteneur avec PostgreSQL ou MySQL </li><li>  Nous roulons toutes les migrations avec des migrations de doctrine </li></ol><br>  Le premier concerne le d√©ploiement d'une base de donn√©es.  Comment cela se produit-il dans les tests.  Nous √©levons le conteneur avec la base de donn√©es souhait√©e - PostgreSQL ou MySQL, puis effectuons toutes les migrations n√©cessaires √† l'aide des <i>migrations de doctrine</i> .  Tout, la base de donn√©es de la structure souhait√©e est pr√™te, elle peut √™tre utilis√©e dans des tests. <br><br>  Pourquoi nous n'utilisons pas d'amortisseurs - car alors il n'a pas besoin d'√™tre pris en charge.  Il s'agit d'une sorte de vidage qui r√©side dans les tests, qui doit √™tre constamment mis √† jour si quelque chose change dans la base de donn√©es.  Il y a des migrations - pas besoin de maintenir un vidage. <br><br>  Le deuxi√®me point est la cr√©ation de donn√©es de test.  Nous n'utilisons pas le module Fixtures de Codeception, nous utilisons le bundle <i>Symfony</i> pour les fixtures. <br><img src="https://habrastorage.org/webt/kx/lf/m9/kxlfm9zppbdqmgj_i_ekaripjw4.jpeg" alt="image"><br><br>  Il y a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> vers celui-ci et un exemple de la fa√ßon dont vous pouvez cr√©er des appareils dans la base de donn√©es. <br><br>  Votre appareil sera alors cr√©√© en tant qu'objet du domaine, il pourra √™tre stock√© dans la base de donn√©es et les donn√©es de test seront pr√™tes. <br><br>  Pourquoi DoctrineFixtureBundle? <br><br><ol><li>  Plus facile de cr√©er des cha√Ænes d'objets associ√©s. </li><li>  Moins de duplication des donn√©es si les appareils pour diff√©rents tests sont similaires. </li><li>  Moins de modifications lors du changement de la structure de la base de donn√©es. </li><li>  Les classes de fixtures sont beaucoup plus visuelles que les tableaux. </li></ol><br>  Pourquoi l'utilisons-nous?  Oui, pour la m√™me raison - ces appareils sont beaucoup plus faciles √† entretenir que les appareils de Codeception.  Il est plus facile de cr√©er des cha√Ænes d'objets li√©s, car tout est dans le bundle symfony.  Moins de donn√©es doivent √™tre dupliqu√©es, car les appareils peuvent √™tre h√©rit√©s, ce sont des classes.  Si la structure de la base de donn√©es change, ces tableaux doivent toujours √™tre modifi√©s et les classes pas toujours.  Les luminaires sous forme d'objets de domaine sont toujours plus visibles que les tableaux. <br><br>  Nous avons parl√© de bases de donn√©es, parlons un peu de moki. <br><br>  Puisqu'il s'agit de tests d'un niveau suffisamment √©lev√© pour tester l'ensemble du syst√®me et que nos syst√®mes sont fortement interconnect√©s, il est clair qu'il y a des √©changes et des interactions.  Nous allons maintenant parler des mokeys sur l'interaction entre les syst√®mes. <br><br>  <b>R√®gles pour mok</b> <br><br><ol><li>  Pleurez toutes les interactions externes du service http </li><li>  V√©rification non seulement des sc√©narios positifs, mais aussi n√©gatifs </li></ol><br>  Les interactions sont des interactions REST ou SOAP http.  Toutes ces interactions dans le cadre des tests que nous mouillons.  Autrement dit, dans nos tests, il n'y a aucun appel r√©el aux syst√®mes externes nulle part.  Cela rend les tests stables.  Parce qu'un service externe peut fonctionner, peut ne pas fonctionner, peut r√©pondre lentement, peut rapidement, en g√©n√©ral, ne sait pas quel est son comportement.  Par cons√©quent, nous couvrons tout cela avec des moks. <br><br>  Nous avons √©galement une telle r√®gle.  Nous mouillons non seulement les interactions positives, mais nous essayons √©galement de v√©rifier certains cas n√©gatifs.  Par exemple, lorsqu'un service tiers r√©pond avec une 500e erreur ou produit une erreur plus significative, nous essayons de tout v√©rifier. <br><br>  Nous utilisons Wiremock pour les simulations, Codeception lui-m√™me prend en charge ..., il a un tel compl√©ment officiel Httpmock, mais nous avons aim√© Wiremock plus.  Comment √ßa marche? <br><br><br><br>  Wiremock se l√®ve en tant que conteneur Docker distinct pendant les tests, et toutes les demandes qui doivent √™tre envoy√©es au syst√®me externe sont envoy√©es √† Wiremock. <br><br><img src="https://habrastorage.org/webt/n9/cb/y8/n9cby8a1hoiicw5fqprvzsfxsae.jpeg" alt="image"><br><br>  Wiremock, si vous regardez la diapositive - il y a une telle bo√Æte, Request Mapping, elle a un ensemble de ces mappages qui disent que si une telle demande arrive, vous devez donner une telle r√©ponse.  Tout est tr√®s simple: une demande est venue - a re√ßu une maquette. <br><br>  Les mocks peuvent √™tre cr√©√©s statiquement, puis le conteneur, quand d√©j√† avec Wiremock monte, ces mocks seront disponibles, ils peuvent √™tre utilis√©s dans les tests manuels.  Vous pouvez cr√©er dynamiquement, directement dans le code, dans une sorte de test. <br><br>  Voici un exemple de la fa√ßon de cr√©er dynamiquement une maquette, vous voyez, la description est assez d√©clarative, il est imm√©diatement clair √† partir du code quel type de maquette que nous cr√©ons: une maquette pour la m√©thode GET qui vient √† une telle URL, et, en fait, quoi retourner. <br><br><img src="https://habrastorage.org/webt/d7/xu/2g/d7xu2gg75_-vjff1ejruhj2dvba.jpeg" alt="image"><br><br>  Outre le fait que cette maquette peut √™tre cr√©√©e, Wiremock a alors la possibilit√© de v√©rifier quelle requ√™te a √©t√© envoy√©e √† cette maquette.  Ceci est √©galement tr√®s utile dans les tests. <br><br>  √Ä propos de Codeception lui-m√™me, probablement, tout, et quelques mots sur la fa√ßon dont nos tests sont ex√©cut√©s, et un peu d'infrastructure. <br><br>  Qu'utilisons-nous? <br><br><img src="https://habrastorage.org/webt/qy/my/hj/qymyhjaocwm0apzi7orjlot7hnw.jpeg" alt="image"><br><br>  Eh bien, tout d'abord, nous avons tous les services dans Docker, donc le lancement d'un environnement de test soul√®ve les conteneurs n√©cessaires. <br><br>  Make est utilis√© pour les commandes internes, Bamboo est utilis√© comme CI. <br><br>  √Ä quoi ressemble le test CI? <br><br><img src="https://habrastorage.org/webt/hb/iq/jf/hbiqjftacif8wg-67x666c7l5yc.jpeg" alt="image"><br><br>  Tout d'abord, nous construisons la version souhait√©e de l'application, puis nous √©levons l'environnement - c'est l'application, tous les services dont elle a besoin, comme Kafka, Rabbit, la base de donn√©es, et nous roulons la migration vers la base de donn√©es. <br><br>  Tout cet environnement est cr√©√© √† l'aide de Docker Compose.  C'est en CI, sur prod que tous les conteneurs tournent sous Kubernetes.  Ex√©cutez ensuite les tests et ex√©cutez. <br><br>  Combien de temps cela prend-il? <br><br>  Tout d√©pend du service sp√©cifique, mais, en r√®gle g√©n√©rale, augmenter l'environnement avant d'ex√©cuter les tests est de 5 √† 10 minutes, les tests - de 6 √† 30 minutes. <br><br><img src="https://habrastorage.org/webt/nm/kh/n0/nmkhn0sdps-qtoowra4mrtgtu8m.jpeg" alt="image"><br><br>  Je vais imm√©diatement avertir cette question pendant que tous les tests se poursuivent dans un seul fil. <br><br>  Eh bien, une telle question.  √Ä quelle fr√©quence les tests doivent-ils √™tre ex√©cut√©s?  Bien s√ªr, le plus souvent, le mieux.  Plus t√¥t vous pouvez d√©tecter un probl√®me, plus vite vous pouvez le r√©soudre. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons 2 r√®gles principales. </font><font style="vertical-align: inherit;">Lorsqu'une t√¢che est soumise √† des tests, tous les tests doivent r√©ussir, √† la fois les tests unitaires et non les tests unitaires. </font><font style="vertical-align: inherit;">Si certains tests √©chouent, c'est l'occasion de transf√©rer la t√¢che vers la correction. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Naturellement, lorsque nous d√©ployons la version. </font><font style="vertical-align: inherit;">√Ä la sortie, tous les tests doivent r√©ussir. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En fin de compte, je voudrais dire quelque chose d'inspirant - √©crivez des tests, laissez-les √™tre verts, utilisez Codeception, faites du moki. </font><font style="vertical-align: inherit;">Je pense que vous comprenez tous parfaitement cela.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452136/">https://habr.com/ru/post/fr452136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452124/index.html">¬´Nous avons besoin de connaissances et de r√©alisations¬ª - √† quoi ressemble un testeur chez Alfa-Bank</a></li>
<li><a href="../fr452128/index.html">Id√©es re√ßues sur la r√©sistance aux radiations des microcircuits</a></li>
<li><a href="../fr452130/index.html">La lune se r√©tr√©cit, elle provoque des tremblements de lune</a></li>
<li><a href="../fr452132/index.html">Chemin de pigiste</a></li>
<li><a href="../fr452134/index.html">Comment tout a commenc√©: l'histoire du fer √† souder et l'av√®nement des outils modernes</a></li>
<li><a href="../fr452138/index.html">13. Check Point Getting Started R80.20. Licence</a></li>
<li><a href="../fr452140/index.html">Pourquoi les directeurs financiers passent-ils √† un mod√®le de co√ªt op√©rationnel en informatique</a></li>
<li><a href="../fr452142/index.html">Comment traitons-nous la copie de contenu, ou la premi√®re attaque contradictoire en prod</a></li>
<li><a href="../fr452146/index.html">Que se passera-t-il donc avec l'authentification et les mots de passe? Partie 2 du rapport d'√©tat de l'authentification forte Javelin</a></li>
<li><a href="../fr452152/index.html">Quelles solutions Rostelecom propose-t-il pour IIoT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>