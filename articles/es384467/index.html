<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¶üèº üòá üö± Watchdog basado en nano de Arduino üôá ‚è±Ô∏è üï¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Watchdog es un dispositivo dise√±ado para detectar y solucionar problemas de hardware. Por lo general, se utiliza un temporizador para esto, cuyo reini...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Watchdog basado en nano de Arduino</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384467/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Watchdog es un dispositivo dise√±ado para detectar y solucionar problemas de hardware. </font><font style="vertical-align: inherit;">Por lo general, se utiliza un temporizador para esto, cuyo reinicio peri√≥dico evita que se env√≠e una se√±al al reinicio. </font></font></i><br>
<br>
<img src="https://habrastorage.org/files/521/6a2/019/5216a20198774a66bbc61882047bfe8b.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yo utilizo el servidor principal de Gentoo principalmente para experimentos, sin embargo, ejecuta una serie de servicios que, si es posible, deber√≠an estar disponibles sin interrupci√≥n. </font><font style="vertical-align: inherit;">Desafortunadamente, las consecuencias de algunos experimentos conducen al p√°nico del kernel, el 100% de la carga de la CPU y otros problemas en el momento m√°s inoportuno. </font><font style="vertical-align: inherit;">Por lo tanto, la idea de agregar watchdog ha requerido atenci√≥n durante mucho tiempo y finalmente se materializ√≥ en este dispositivo.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de una inspecci√≥n minuciosa de lo que estaba disponible y una evaluaci√≥n del tiempo disponible, el perro guardi√°n montado sobre la base del Arduino Nano fue la mejor opci√≥n. </font><font style="vertical-align: inherit;">Una lista de requisitos apareci√≥ m√°s o menos igual:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iniciar y detener el demonio para que funcione con un temporizador, una herramienta normal del sistema operativo (OpenRC).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propio watchdog en el dispositivo, en ATmega es necesario usarlo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El registro de eventos en el dispositivo para arreglar el reinicio y el temporizador.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sincronice la hora del dispositivo con el host para registrar la hora correcta en el registro.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recibir y mostrar el estado del dispositivo y sus entradas de registro.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Borrar el registro y restablecer el dispositivo a su estado original.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, se encontr√≥ el "microscopio", se marca el "clavo" ... se puede martillar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hardware</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La base del dispositivo fue el clon chino Arduino Nano, hecho sobre la base del chip CH340. </font><font style="vertical-align: inherit;">Los nuevos n√∫cleos de Linux (probados desde 3.16) tienen un controlador adecuado, por lo que el dispositivo se detecta f√°cilmente como un puerto serie USB.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino reinicio no deseado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada vez que se conecta el terminal, el Arduino se reinicia. </font><font style="vertical-align: inherit;">La raz√≥n es que el terminal env√≠a una se√±al DTR (Data Terminal Ready), lo que hace que el dispositivo se reinicie. </font><font style="vertical-align: inherit;">Por lo tanto, el IDE de Arduino pone el dispositivo en un modo para cargar bocetos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay varias soluciones al problema, pero solo una funcion√≥: es necesario instalar un electrolito de 10 ¬µF (C1 en el diagrama a continuaci√≥n) entre los contactos RST y GND. </font><font style="vertical-align: inherit;">Desafortunadamente, esto tambi√©n bloquea la descarga de bocetos al dispositivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, el esquema es el siguiente: </font></font><br>
<br>
<img src="https://habrastorage.org/files/2e3/9f0/ac0/2e39f0ac019f42459a7d599306573f5c.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dibujado usando KiCad</font></font></i><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Explicaciones para el esquema.</font></font></b><div class="spoiler_text"><ul>
<li><b>R1</b> ‚Äî    ,      PC817: <nobr>(5V ‚Äî 1.2V / 0.02A) = 190Œ©</nobr>,    180Œ©.</li>
<li><b>U2</b> ‚Äî     Arduino  PC.    ,     ( USB ),    .</li>
<li><b>JP1</b> ‚Äî ,      .        .</li>
<li><b>1</b> ‚Äî ,        DTR.</li>
<li><b>MB_RST</b>, <b>MB_GND</b> ‚Äî RESET     ,    RST   (GND).    ,    .</li>
<li><b>BTN_RST</b>, <b>BTN_GND</b> ‚Äî   ,    , ,   ,   .</li>
</ul><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boot-loop (reinicio c√≠clico) cuando se trabaja con WDT</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los microcontroladores ATmega tienen un mecanismo de reinicio WDT (WatchDog Timer) incorporado. Sin embargo, todos los intentos de usar esta funci√≥n condujeron a un bucle de arranque, que solo se pod√≠a salir apagando la alimentaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No largas b√∫squedas revelaron que los cargadores de arranque de la mayor√≠a de los clones de Arduino no son compatibles con WDT. Afortunadamente, este problema se resolvi√≥ en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gestor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de arranque alternativo </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Optiboot</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para actualizar el gestor de arranque, necesita un programador que pueda trabajar en el protocolo SPI, tambi√©n es deseable que el IDE de Arduino conozca este dispositivo "en persona". En este caso, otro Arduino es ideal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tomamos Arduino UNO, como programador, y la √∫ltima versi√≥n de Arduino IDE v1.6.5, entonces el algoritmo ser√° el siguiente:</font></font><br>
<br>
<ol>
<li>   <b>boards-1.6.txt</b>   optiboot    <b><nobr>hardware/arduino/avr/boards.txt</nobr></b>    Arduino IDE.</li>
<li> Arduino Uno,    <b><nobr>File ‚Üí Examples ‚Üí ArduinoISP</nobr></b>.</li>
<li>    Arduino Nano  :<br>
<table>
<tbody><tr>
<th>Arduino Uno ()</th>
<th>Arduino Nano (ICSP )</th>
</tr>
<tr>
<td> <table>
<tbody><tr>
<td><b>5V</b> ‚Üí Vcc</td>
</tr>
<tr>
<td><b>GND</b> ‚Üí GND</td>
</tr>
<tr>
<td><b>D11</b> ‚Üí MOSI</td>
</tr>
<tr>
<td><b>D12</b> ‚Üí MISO</td>
</tr>
<tr>
<td><b>D13</b> ‚Üí SCK</td>
</tr>
<tr>
<td><b>D10</b> ‚Üí Reset</td>
</tr>
</tbody></table><br>
 </td>
<td> <table>
<tbody><tr>
<td><b>Pin1</b> (MISO) ‚Üê D12</td>
<td><b>Pin2</b> (Vcc) ‚Üê 5V</td>
</tr>
<tr>
<td><b>Pin3</b> (SCK) ‚Üê D13</td>
<td><b>Pin4</b> (MOSI) ‚Üê D11</td>
</tr>
<tr>
<td><b>Pin5</b> (Reset) ‚Üê D10</td>
<td><b>Pin6</b> (GND) ‚Üê GND</td>
</tr>
</tbody></table><br>
 </td>
</tr>
</tbody></table><br>
<div class="spoiler"><b class="spoiler_title">    </b><div class="spoiler_text"><img src="https://habrastorage.org/files/868/919/4fe/8689194fe6a94d9cbd22b6ec284cc7e3.jpg"><br>
</div></div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el IDE de Arduino, en el men√∫ Herramientas, configure los ajustes como en la captura de pantalla:</font></font><br>
<img src="https://habrastorage.org/files/699/f29/4af/699f294af6cc48179e44c65543a758c5.png"></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seleccione el elemento de men√∫ </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Herramientas ‚Üí Grabar cargador de arranque</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y aseg√∫rese de que el proceso se complete sin errores.</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de este procedimiento, debe cargar bocetos en Arduino Nano eligiendo la misma configuraci√≥n: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">placa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Optiboot en cpus de 32 pines, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">procesador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ATmega328p, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">velocidad de CPU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 16MHz.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soldadura</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, debe soldar todo, para que parezca una sola pieza. </font></font><br>
<br>
<img src="https://habrastorage.org/files/eab/32a/27c/eab32a27cc06458faf2589287cb886e4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ necesitaba un enchufe USB debido al hecho de que tengo una placa base mini-ITX con solo un conector para un par de USB2.0, que se necesitan en el panel frontal, y no hab√≠a nada que conectar a la almohadilla USB3.0. </font><font style="vertical-align: inherit;">Si es posible, dichos dispositivos deben conectarse directamente a la placa base para que los cables no sobresalgan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soldadura, por regla general, no causa problemas, pero en este caso se utiliza una placa de pruebas, y esto tiene sus propios detalles.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo soldar pistas en una placa de pruebas</font></font></b><div class="spoiler_text">      (  ,      ).             .<br>
<br>
   :<br>
<br>
<img src="https://habrastorage.org/files/847/e13/6d5/847e136d5af547abafdfcb4e40ced271.jpg"><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resultado: </font></font><br>
<br>
<img src="https://habrastorage.org/files/86b/5dc/95b/86b5dc95b0d142288c0a007826abcaa0.jpg"><br>
<br>
<img src="https://habrastorage.org/files/1ce/697/fa3/1ce697fa32f04962a5a9324fb365fe48.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
puede parecer que algunos contactos est√°n mal soldados, pero esto es solo un flujo. </font><font style="vertical-align: inherit;">El consumo de soldadura en el tablero es bastante grande, por lo que todo lo que es posible est√° manchado con un flujo aqu√≠. </font><font style="vertical-align: inherit;">De hecho, este es un buen ejemplo de c√≥mo no necesita dejar el producto despu√©s de soldar. </font><font style="vertical-align: inherit;">El fundente debe lavarse, de lo contrario puede haber problemas con la corrosi√≥n de los compuestos. </font><font style="vertical-align: inherit;">Agregar√© e ir√© a lavar ... Eso es mejor:</font></font><br>
<br>
<img src="https://habrastorage.org/files/a91/fd1/111/a91fd11110b348f2b9dcc8d9326d4f37.jpg"><br>
<br>
&nbsp;<br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte de software</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hablando objetivamente, el c√≥digo de este proyecto no es de particular inter√©s. </font><font style="vertical-align: inherit;">Las introductorias est√°n lejos de ser extremas, y la arquitectura se describe en una frase: env√≠e un comando - espere una respuesta. </font><font style="vertical-align: inherit;">En aras del orden, describir√© la funcionalidad principal aqu√≠ y me detendr√© brevemente en los puntos m√°s interesantes, desde mi punto de vista. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo el c√≥digo se publica en GitHub, por lo que si est√° familiarizado con Bash y C / C ++ (en el contexto de los bocetos de Arduino), la lectura en este punto puede finalizar. </font><font style="vertical-align: inherit;">Si est√° interesado, el resultado final se puede encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conexi√≥n de vigilancia</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando conecta el perro guardi√°n, se crea un archivo de dispositivo que contiene el n√∫mero de serie. </font><font style="vertical-align: inherit;">Si el sistema tiene otros dispositivos ttyUSB (en mi caso, un m√≥dem), entonces hay un problema con la numeraci√≥n. </font><font style="vertical-align: inherit;">Para identificar de forma exclusiva el dispositivo, debe crear un enlace simb√≥lico con un nombre √∫nico. </font><font style="vertical-align: inherit;">Para esto, se dise√±√≥ udev, que probablemente ya existe en el sistema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero necesita encontrar visualmente el perro guardi√°n conectado, por ejemplo, mirando el archivo de registro del sistema. </font><font style="vertical-align: inherit;">Luego, reemplazando / dev / ttyUSB0 con el dispositivo deseado, escriba en el terminal:</font></font><br>
<br>
<pre><code class="bash hljs">udevadm info -a -p <span class="hljs-string">"<span class="hljs-subst">$(udevadm info -q path -n /dev/ttyUSB0)</span>"</span>
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo de salida</font></font></b><div class="spoiler_text"><pre>  looking at device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0/ttyUSB0/tty/ttyUSB0':<font></font>
    KERNEL=="ttyUSB0"<font></font>
    SUBSYSTEM=="tty"<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0/ttyUSB0':<font></font>
    KERNELS=="ttyUSB0"<font></font>
    SUBSYSTEMS=="usb-serial"<font></font>
    DRIVERS=="ch341-uart"<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4/1-1.4:1.0':<font></font>
    ...<font></font>
    <font></font>
  looking at parent device '/devices/pci0000:00/0000:00:14.0/usb1/1-1/1-1.4':<font></font>
    SUBSYSTEMS=="usb"<font></font>
    DRIVERS=="usb"<font></font>
    ATTRS{idVendor}=="1a86"<font></font>
    ATTRS{idProduct}=="7523"<font></font>
    ATTRS{product}=="USB2.0-Serial"<font></font>
    ...<font></font>
</pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, la regla se ver√° as√≠: </font></font><pre><code class="hljs cs">ACTION==<span class="hljs-string">"add"</span>, KERNEL==<span class="hljs-string">"ttyUSB[0-9]*"</span>, SUBSYSTEM==<span class="hljs-string">"tty"</span>, SUBSYSTEMS==<span class="hljs-string">"usb"</span>, ATTRS{idVendor}==<span class="hljs-string">"1a86"</span>, ATTRS{idProduct}==<span class="hljs-string">"7523"</span>, SYMLINK+=<span class="hljs-string">"ttyrst-watchdog"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><nobr><font style="vertical-align: inherit;">Debe</font></nobr><font style="vertical-align: inherit;"> 
colocarlo en un archivo separado en el directorio </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/udev/rules.d</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , por ejemplo </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">51-ttyrst-watchdog.rules</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y decirle a udev que vuelva a cargar las reglas:</font></font><pre><code class="bash hljs">udevadm control --reload-rules</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir de este momento, al conectar watchdog, se </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crear√°</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un enlace </font><nobr><font style="vertical-align: inherit;">/ dev / ttyrst-</font></nobr><font style="vertical-align: inherit;"> watchdog </font><font style="vertical-align: inherit;">en el dispositivo deseado, que se utilizar√° m√°s adelante.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script Bash (ttyrst-watchdog.sh)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La comunicaci√≥n con el perro guardi√°n se realiza a una velocidad de 9600 baudios. </font><font style="vertical-align: inherit;">Arduino funciona sin problemas con terminales a altas velocidades, pero los comandos para trabajar con texto (cat, echo, etc.) reciben y env√≠an solo basura. </font><font style="vertical-align: inherit;">Es posible que esta sea una caracter√≠stica de solo mi copia del Arduino Nano. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el ciclo de reinicio del temporizador principal y para las funciones de l√≠nea de comandos, se utiliza un script. </font><font style="vertical-align: inherit;">La raz√≥n es que ambos componentes usan un recurso com√∫n: el archivo del dispositivo, y es necesario proporcionarle acceso sincr√≥nico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La sincronizaci√≥n consiste esencialmente en un ciclo de espera:</font></font><pre><code class="bash hljs"><span class="hljs-keyword">while</span> fuser <span class="hljs-variable">${DEVICE}</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">do</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">done</span></code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y capturar el dispositivo durante el tiempo requerido: </font></font><pre><code class="bash hljs">cat &lt;<span class="hljs-variable">${DEVICE}</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, tal esquema est√° sujeto a una condici√≥n de carrera. Puede lidiar con esto de una manera adulta (por ejemplo, para organizar una cola de mensajes), pero en este caso, es suficiente establecer correctamente los tiempos de espera para garantizar que obtenga el resultado en un tiempo aceptable. De hecho, todo el script est√° trabajando con tiempos de espera. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La demonizaci√≥n (que se ejecuta en segundo plano) se realiza utilizando el paquete OpenRC. Se supone que este script est√° en el archivo </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/usr/local/bin/ttyrst-watchdog.sh</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y el script OpenRC est√° en </font></font><nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/init.d/ttyrst-watchdog</font></font></nobr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando el demonio se detiene, se requiere la desactivaci√≥n correcta del watchdog. Para hacer esto, el script establece el controlador de se√±al que requiere finalizaci√≥n:</font></font><pre><code class="bash hljs"><span class="hljs-built_in">trap</span> deactivate SIGINT SIGTERM</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y aqu√≠ surge un problema: OpenRC no puede detener al demonio, o mejor dicho, pero no con frecuencia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El hecho es que el comando kill env√≠a una se√±al al script, y el programa de suspensi√≥n, que se usa para pausar el script, se ejecuta en otro proceso y no recibe la se√±al. Como resultado, la funci√≥n de desactivaci√≥n se inicia solo despu√©s de que se completa el sue√±o, que es demasiado largo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soluci√≥n es comenzar a dormir en segundo plano y esperar a que se complete el proceso en el script:</font></font><pre><code class="bash hljs">sleep <span class="hljs-variable">${SLEEP_TIME}</span> &amp; <span class="hljs-built_in">wait</span> $!  <span class="hljs-comment">#  $!  ID   </span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Constantes b√°sicas: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WATCHDOG_ACTIVE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : S√ç o NO, respectivamente, env√≠an una se√±al para reiniciar cuando el temporizador se activa o no. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WATCHDOG_TIMER</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : tiempo en segundos para el que est√° configurado el temporizador. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SLEEP_TIME</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : tiempo en segundos despu√©s del cual se debe reiniciar el temporizador. Debe ser mucho m√°s peque√±o que WATCHDOG_TIMER, pero no muy peque√±o, para no crear una carga excesiva en el sistema y el dispositivo. En los tiempos de espera actuales, un m√≠nimo razonable es de aproximadamente 5 segundos. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEFAULT_LOG_LINES</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : el n√∫mero de entradas de registro de dispositivo recientes devueltas por el comando de registro predeterminado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comandos de script: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inicio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Inicio del ciclo de reinicio del temporizador principal. </font><font style="vertical-align: inherit;">Puede agregar un c√≥digo de verificaci√≥n adicional a la funci√≥n is_alive, por ejemplo, para verificar la posibilidad de conectarse a trav√©s de ssh. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : muestra el estado del dispositivo. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reset</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : restablecer la EEPROM (datos de registro) y reiniciar el dispositivo para restaurar el watchdog a su estado original. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">log &lt;n√∫mero de entradas&gt;</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : muestra el n√∫mero especificado de entradas de registro recientes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boceto Arduino (ttyrst-watchdog.ino)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para compilar correctamente el boceto, necesita una biblioteca de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiempo de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> terceros </font><font style="vertical-align: inherit;">, que es necesaria para la sincronizaci√≥n de tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un boceto consta de dos archivos. Esto se debe al hecho de que Arduino IDE no acepta las estructuras (estructura) declaradas en el archivo principal, se deben mover a un archivo de encabezado externo. Adem√°s, la palabra clave typedef no es necesaria para declarar una estructura, probablemente sea incluso da√±ina ... despu√©s de verificar las opciones est√°ndar, no pude encontrar la sintaxis adecuada. El resto es m√°s o menos est√°ndar C ++. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las funciones wdt_enable y wdt_reset funcionan con el watchdog integrado en el microcontrolador. Despu√©s de inicializar el WDT, lo m√°s importante para recordar es restablecerlo en el bucle principal y dentro de los bucles de todas las operaciones largas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las entradas de registro se escriben en la memoria EEPROM no vol√°til, su tama√±o disponible se puede especificar en logrecord.h, en este caso es 1024. El registro se realiza en forma de anillo, el separador es una estructura con valores cero. </font><font style="vertical-align: inherit;">El n√∫mero m√°ximo de entradas para 1 KiB EEPROM es 203. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un registro sobre la carga del dispositivo llega al registro solo despu√©s de la sincronizaci√≥n horaria. </font><font style="vertical-align: inherit;">La sincronizaci√≥n se realiza al mismo tiempo que se reinicia el temporizador y antes de que se ejecute cualquier comando durante la inicializaci√≥n del dispositivo. </font><font style="vertical-align: inherit;">De otra manera, no ser√° posible comparar la hora correcta con este evento, y la informaci√≥n sobre reinicios del dispositivo, aislada del daemon de trabajo, no es muy interesante. </font></font><br>
<br>
<img src="https://habrastorage.org/files/11c/823/d3e/11c823d3eac445b6b543cec6ca061a95.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo, ¬°gracias por mirar! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los archivos fuente del proyecto se encuentran en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es384467/">https://habr.com/ru/post/es384467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es384457/index.html">El trabajo de los m√≥dulos Wi-Fi Master Kit en el sistema de control de automatizaci√≥n del hogar OpenHAB. Parte 2: conecte el termostato MP3502</a></li>
<li><a href="../es384459/index.html">Un error en el motor de Google Chrome con una ca√≠da de 16 caracteres ya se utiliza para crear juegos.</a></li>
<li><a href="../es384461/index.html">Cerebro. Memoria hologr√°fica. Biolog√≠a de la computaci√≥n cu√°ntica</a></li>
<li><a href="../es384463/index.html">¬°Atenci√≥n! Concurso de accesorios impresos en 3D para Apple iPhone 6s</a></li>
<li><a href="../es384465/index.html">Quadcopters construyen un puente de cuerda</a></li>
<li><a href="../es384471/index.html">El robot de construcci√≥n de Hadrian puede correr 20 veces m√°s r√°pido que los humanos</a></li>
<li><a href="../es384473/index.html">Hablando de cine en casa</a></li>
<li><a href="../es384475/index.html">La revisi√≥n no es un gadget. Elegir el mejor estuche de entrenamiento y otros accesorios para tel√©fonos inteligentes: ap√≥sitos, bolsos y bolsillo de silicona</a></li>
<li><a href="../es384477/index.html">La NASA probar√° la tecnolog√≠a de desarrollo de asteroides usando luz solar</a></li>
<li><a href="../es384479/index.html">Desarrollo de juegos en Procesamiento con control a trav√©s del tablero Arduino Uno</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>