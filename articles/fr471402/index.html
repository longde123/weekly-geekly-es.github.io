<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤭 🧑🏽‍🤝‍🧑🏻 🧑🏽 Iptables et filtrage du trafic des dissidents pauvres et paresseux 📍 🏾 🤙🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La pertinence de bloquer les visites de ressources interdites affecte tout administrateur qui peut être officiellement présenté pour non-respect de la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Iptables et filtrage du trafic des dissidents pauvres et paresseux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471402/">  La pertinence de bloquer les visites de ressources interdites affecte tout administrateur qui peut être officiellement présenté pour non-respect de la loi ou des ordres des autorités compétentes. <br><br><img src="https://habrastorage.org/webt/9e/uq/ev/9euqevswnrg1zv6jaq_0nwcdnzu.png"><br><br>  Pourquoi réinventer la roue quand il existe des programmes et des distributions spécialisés pour nos tâches, par exemple: Zeroshell, pfSense, ClearOS. <br><br>  Une autre question a été posée par les autorités: le produit utilisé a-t-il un certificat de sécurité de notre état? <br><a name="habracut"></a><br>  Nous avions de l'expérience avec les distributions suivantes: <br><br><ul><li>  Zeroshell - les développeurs ont même présenté une licence pour 2 ans, mais il s'est avéré que la répartition des intérêts était illogique pour nous de remplir une fonction critique pour nous; </li><li>  pfSense - le respect et l'honneur, en même temps ennuyeux, s'habituer à la ligne de commande du pare-feu FreeBSD n'est pas assez pratique pour nous (je pense que c'est une question d'habitude, mais il s'est avéré que ce n'était pas "de cette façon"); </li><li>  ClearOS - il s'est avéré être très lent sur notre matériel, nous n'avons pas pu passer à des tests sérieux, et pourquoi des interfaces si lourdes? </li><li>  Ideco SELECTA.  Il y a une conversation séparée sur le produit Aydeko, un produit intéressant, mais pour des raisons politiques ce n'est pas pour nous, mais je veux aussi les "mordre" à propos de la licence pour le même Linux, Roundcube, etc.  Pourquoi ont-ils obtenu cela après avoir "coupé" l'interface en <b>Python</b> et avoir sélectionné les droits de superutilisateur, ils peuvent vendre un produit fini composé de modules développés et améliorés de la communauté Internet distribués sous la GPL, etc. </li></ul><br>  Je comprends que maintenant des cris négatifs vont couler dans ma direction avec des exigences pour justifier mes sentiments subjectifs en détail, mais je veux dire que ce nœud de réseau est également un équilibreur de trafic vers 4 canaux externes vers Internet, et chaque canal a ses propres caractéristiques.  Une autre pierre angulaire était la nécessité de travailler sur l'une des nombreuses interfaces réseau dans différents espaces d'adressage, et je suis <b>prêt</b> à admettre que je <b>ne</b> suis <b>pas prêt</b> à utiliser les VLAN où j'en ai <b>besoin</b> .  En cours d'utilisation, il existe des appareils comme TP-Link TL-R480T + - ils ne se comportent pas parfaitement, en général avec leurs propres nuances.  Il s'est avéré responsable de configurer cette partie sous Linux grâce à l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">équilibrage IP</a> hors site Ubuntu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">: nous combinons plusieurs canaux Internet en un seul</a> .  De plus, chacun des canaux peut "tomber" à tout moment, ainsi que monter.  Si vous êtes intéressé par un script qui fonctionne pour le moment (et cela vaut la peine d'être publié séparément) - écrivez dans les commentaires. <br><br>  La solution en question ne prétend pas être unique, mais je veux poser une question: «Pourquoi l'entreprise s'adapte-t-elle à des produits tiers douteux avec des exigences matérielles sérieuses quand vous pouvez envisager une alternative? <br><br>  S'il y a en Russie une liste de Roskomnadzor, en Ukraine - une annexe à la décision du Conseil de sécurité nationale (par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ), alors les dirigeants ne dorment pas non plus sur le sol.  Par exemple, on nous a donné une liste de sites interdits, de l'avis de la direction qui aggrave la productivité du travail sur le lieu de travail. <br><br>  Communiquer avec des collègues dans d'autres entreprises où tous les sites sont interdits par défaut et uniquement sur demande avec l'autorisation du patron, vous pouvez accéder à un site spécifique, souriant respectueusement, pensant et «fumant un problème», il est devenu clair que la vie est toujours belle et nous a commencé votre recherche. <br><br>  Ayant la possibilité non seulement de voir analytiquement ce que les «livres de femmes au foyer» écrivent sur le filtrage du trafic, mais aussi de voir ce qui se passe sur les canaux de différents fournisseurs, nous avons remarqué les recettes suivantes (toutes les captures d'écran sont un peu recadrées, veuillez comprendre et pardonner): <br><div class="scrollable-table"><table><tbody><tr><td>  Fournisseur 1 </td><td>  - Ne dérange pas et impose son propre serveur DNS et son serveur proxy transparent.  Eh bien? .. mais nous avons accès là où nous en avons besoin (si nous en avons besoin :)) </td></tr><tr><td>  Fournisseur 2 </td><td>  - Il pense que son fournisseur principal devrait y penser, le support technique du fournisseur principal a même admis pourquoi je ne pouvais pas ouvrir le site non interdit nécessaire pour moi.  Je pense que la photo vous amusera :) <br><br><img src="https://habrastorage.org/webt/vm/qh/v2/vmqhv2z15q8rx7wo2hqmd62zlma.png"><br><br>  En fin de compte, ils traduisent les noms des sites interdits en adresses IP et bloquent IP (cela ne les dérange pas que 20 sites puissent être hébergés sur cette adresse IP). <br></td></tr><tr><td>  Fournisseur 3 </td><td>  - y passe du trafic, mais ne le permet pas de revenir le long de l'itinéraire. </td></tr><tr><td>  Fournisseur 4 </td><td>  - interdit toutes les manipulations avec des paquets dans la direction spécifiée. </td></tr></tbody></table></div>  Et que faire des VPN (respect du navigateur Opera) et des plug-ins de navigateur?  Tout d'abord, en jouant avec le hub Mikrotik, nous avons même eu une recette gourmande en ressources pour L7, que nous avons ensuite dû refuser (il peut y avoir plus de noms interdits, cela devient triste quand, en plus de ses fonctions directes sur les routes, sur 3 dizaines d'expressions, le processeur PPC460GT passe à 100 %). <br><br><img src="https://habrastorage.org/webt/mh/aa/5y/mhaa5y8mjctihnqzfcauqq8ctgc.png">  . <br><br>  Ce qui est devenu clair: <br>  CSN sur 127.0.0.1 n'est absolument pas une panacée, les versions modernes des navigateurs vous permettent toujours de contourner ces problèmes.  Il est impossible de limiter tous les utilisateurs avec des droits supprimés, et il ne faut pas oublier le grand nombre de DNS alternatifs.  Internet n'est pas statique et, en plus des nouvelles adresses DNS, les sites interdits achètent de nouvelles adresses, modifient les domaines de premier niveau et peuvent ajouter / supprimer des caractères dans leurs adresses.  Mais encore, il a le droit de vivre quelque chose comme ça (subjectivement: dans une telle protection, je vois comment le navigateur, à perte, attend toujours une réponse, et la page qui contient des éléments de contenu interdit prend beaucoup de temps à charger): <br><br><pre><code class="bash hljs">ip route add blackhole 1.2.3.4</code> </pre> <br>  Obtenir une liste d'adresses IP à partir de la liste des sites interdits serait assez efficace, mais pour les raisons ci-dessus, nous sommes passés à des considérations sur Iptables.  Il y avait déjà un équilibreur en direct sur CentOS Linux version 7.5.1804. <br><br>  L’Internet de l’utilisateur doit être rapide et le navigateur ne doit pas attendre une demi-minute, concluant que cette page n’est pas disponible.  Après une longue recherche de différentes options de verrouillage, nous sommes arrivés à ce modèle: <br>  Fichier 1 -&gt; <b>/ script / refuse_host</b> , liste des noms interdits: <br><br><pre> <code class="plaintext hljs">test.test blablabla.bubu torrent porno</code> </pre> <br>  Fichier 2 -&gt; <b>/ script / refuse_range</b> , une liste des espaces d'adressage interdits et des adresses: <br><br><pre> <code class="plaintext hljs">192.168.111.0/24 241.242.0.0/16</code> </pre> <br>  Fichier de script 3 -&gt; <b>ipt.sh</b> , qui fonctionne avec ipables: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       HOSTS=`cat /script/denied_host | grep -v '^#'` RANGE=`cat /script/denied_range | grep -v '^#'` echo "Stopping firewall and allowing everyone..." #    iptables,      sudo iptables -F sudo iptables -X sudo iptables -t nat -F sudo iptables -t nat -X sudo iptables -t mangle -F sudo iptables -t mangle -X sudo iptables -P INPUT ACCEPT sudo iptables -P FORWARD ACCEPT sudo iptables -P OUTPUT ACCEPT #     (  ) sudo sh rout.sh #          for i in $HOSTS; do sudo iptables -I FORWARD -m string --string $i --algo bm --from 1 --to 600 -p tcp -j REJECT --reject-with tcp-reset; sudo iptables -I FORWARD -m string --string $i --algo bm --from 1 --to 600 -p udp -j DROP; done #          for i in $RANGE; do sudo iptables -I FORWARD -p UDP -d $i -j DROP; sudo iptables -I FORWARD -p TCP -d $i -j REJECT --reject-with tcp-reset; done</span></span></code> </pre><br>  L'utilisation de sudo est due au fait que nous avons un petit hack à contrôler via l'interface WEB, mais comme l'expérience de l'utilisation d'un tel modèle depuis plus d'un an l'a montré, WEB n'est pas si nécessaire.  Après la mise en œuvre, il y avait un désir de faire une liste de sites dans la base de données, etc.  Le nombre d'hôtes bloqués est supérieur à 250 + une douzaine d'espaces d'adressage.  En effet, il y a un problème lors du passage au site via une connexion https, ainsi que l'administrateur système, j'ai des plaintes concernant les navigateurs :), mais ce sont des cas particuliers, la plupart des réponses au manque d'accès à la ressource sont toujours de notre côté, nous bloquons également avec succès Opera VPN, les plugins comme friGate et la télémétrie de Microsoft. <br><br><img src="https://habrastorage.org/webt/mm/_t/jy/mm_tjyvq1tpwumvwb3pezgfmixe.png"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471402/">https://habr.com/ru/post/fr471402/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471380/index.html">Les pentesters à la pointe de la cybersécurité</a></li>
<li><a href="../fr471384/index.html">Ligue d'Internet gratuit</a></li>
<li><a href="../fr471388/index.html">Quelques fonctionnalités du développement des compétences pour Alice</a></li>
<li><a href="../fr471394/index.html">Habr Weekly # 22 / Comment communiquer en équipe, nouvelles taxes pour les méga-corporations, TON sur les doigts, Amazon copie les produits</a></li>
<li><a href="../fr471396/index.html">Comment la grille CSS modifie la structure du contenu</a></li>
<li><a href="../fr471404/index.html">Est-il possible de gagner plus en travaillant comme ingénieur dans un autre pays?</a></li>
<li><a href="../fr471408/index.html">Une alternative aux onduleurs à phase vibrante: les lignes de transmission (TQWT, ALT)</a></li>
<li><a href="../fr471412/index.html">Un article sur un tas d'ordure sur le bureau</a></li>
<li><a href="../fr471414/index.html">Système de Help Desk leader. Comment obtenir les exigences et développer un service cloud?</a></li>
<li><a href="../fr471418/index.html">Que peut apprendre le marché de la réalité virtuelle à un concepteur de jeux?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>