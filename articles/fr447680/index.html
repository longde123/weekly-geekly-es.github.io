<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂ üßôüèø ‚ÑπÔ∏è Exercices d'√©mulation: manuel Xbox 360 FMA üï∫üèø üíÉ üòÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a plusieurs ann√©es, j'ai travaill√© dans le d√©partement Microsoft Xbox 360. Nous avons pens√© √† publier une nouvelle console et avons d√©cid√© que ce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exercices d'√©mulation: manuel Xbox 360 FMA</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447680/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1f1/67d/d5b/1f167dd5bb4c689b618efd55229627d8.jpg"></div><br>  Il y a plusieurs ann√©es, j'ai travaill√© dans le d√©partement Microsoft Xbox 360.  Nous avons pens√© √† publier une nouvelle console et avons d√©cid√© que ce serait g√©nial si cette console pouvait ex√©cuter des jeux de la console de la g√©n√©ration pr√©c√©dente. <br><br>  L'√©mulation est toujours difficile, mais elle l'est encore plus si vos chefs d'entreprise changent constamment les types de processeurs centraux.  La premi√®re Xbox (√† ne pas confondre avec la Xbox One) utilisait un processeur x86.  Dans la deuxi√®me Xbox, c'est-√†-dire, d√©sol√©, la Xbox <em>360</em> utilisait un processeur PowerPC.  La troisi√®me Xbox, c'est-√†-dire la Xbox <em>One</em> , utilisait le processeur x86 / x64.  De tels sauts entre les diff√©rents <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ISA</a> n'ont pas simplifi√© nos vies. <br><br>  J'ai particip√© au travail de l'√©quipe qui a appris √† la Xbox 360 √† √©muler de nombreux jeux de la premi√®re Xbox, c'est-√†-dire √† √©muler x86 sur PowerPC, et pour ce travail, j'ai re√ßu le titre d ' <em>¬´√©mulation ninja¬ª</em> .  Ensuite, on m'a demand√© d'√©tudier la question de l'√©mulation du processeur Xbox 360 PowerPC sur un processeur x64.  Je dirai √† l'avance que je n'ai pas trouv√© de solution satisfaisante. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3be/4d3/c4e/3be4d3c4e413e240333deba0635d05cb.png"></div><br><h2>  FMA! = MMA </h2><br>  L'une des choses qui m'a d√©rang√© a √©t√© la fusion d'ajouts multiples ou les instructions <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FMA</a> .  Ces instructions ont re√ßu trois param√®tres en entr√©e, multipli√© les deux premiers, puis ajout√© le troisi√®me.  Fusionn√© signifie que l'arrondi n'a pas √©t√© effectu√© avant la fin de l'op√©ration.  C'est-√†-dire que la multiplication est effectu√©e avec une pr√©cision totale, apr√®s quoi l'addition est effectu√©e, et seulement alors le r√©sultat est arrondi √† la r√©ponse finale. <br><br>  Pour montrer cela avec un exemple concret, imaginons que nous utilisons des nombres d√©cimaux √† virgule flottante et deux chiffres de pr√©cision.  Imaginez ce calcul, pr√©sent√© en fonction: <br><br><blockquote><code>FMA(8.1e1, 2.9e1, 4.1e1),  8.1e1 * 2.9e1 + 4.1e1,  81 * 29 + 41</code> </blockquote> <br>  <code>81*29</code> est √©gal √† <code>2349</code> et apr√®s avoir ajout√© 41, nous obtenons <code>2390</code> .  En arrondissant √† deux chiffres, nous obtenons <code>2400</code> ou <code>2.4e3</code> . <br><br>  Si nous n'avons pas de FMA, nous devrons d'abord effectuer la multiplication, obtenir <code>2349</code> , qui arrondira √† deux chiffres de pr√©cision et donnera <code>2300 (2.3e3)</code> .  Ensuite, nous ajoutons <code>41</code> et nous obtenons <code>2341</code> , qui <em>seront</em> √† <em>nouveau</em> arrondis et nous obtiendrons le r√©sultat final <code>2300 (2.3e3)</code> , qui est moins pr√©cis que la r√©ponse FMA. <br><br><blockquote>  Remarque 1: <code>FMA(a,b, -a*b)</code> calcule l'erreur dans <code>a*b</code> , qui est en fait cool. <br><br>  Remarque 2: L'un des effets secondaires de la note 1 est que <code>x = a * b ‚Äì a * b</code> peut ne pas retourner z√©ro si l'ordinateur g√©n√®re automatiquement des instructions FMA. </blockquote><br>  Donc, √©videmment, FMA donne des r√©sultats plus pr√©cis que les instructions de multiplication et d'addition individuelles.  Nous n'irons pas en profondeur, mais nous conviendrons que si nous devons multiplier deux nombres, puis ajouter le troisi√®me, le FMA sera plus pr√©cis que ses alternatives.  De plus, les instructions FMA ont souvent moins de latence que l'instruction de multiplication suivie de l'instruction d'addition.  Dans le processeur Xbox 360, la latence et la vitesse de traitement FMA √©taient √©gales √† celles de <em>fmul</em> ou <em>fadd</em> , donc utiliser FMA au lieu de <em>fmul</em> suivi de <em>fadd</em> d√©pendant <em>a</em> permis de r√©duire de moiti√© le retard. <br><br><h2>  √âmulation FMA </h2><br>  Le compilateur Xbox 360 <i>a toujours</i> g√©n√©r√© des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions FMA</a> , vectorielles et scalaires.  Nous n'√©tions pas s√ªrs que les processeurs x64 que nous avons s√©lectionn√©s prendraient en charge ces instructions, il √©tait donc essentiel de les √©muler rapidement et avec pr√©cision.  Il √©tait n√©cessaire que notre √©mulation de ces instructions devienne id√©ale, car d'apr√®s mon exp√©rience pr√©c√©dente d'√©mulation de calculs √† virgule flottante, je savais que des r√©sultats "assez proches" entra√Ænaient la chute de personnages √† travers le plancher, des voitures volant hors du monde, etc. <br><br>  Alors, que <em>faut-il</em> pour √©muler parfaitement les instructions FMA si le processeur x64 ne les prend pas en charge? <br><br>  Heureusement, la grande majorit√© des calculs en virgule flottante dans les jeux sont effectu√©s avec une pr√©cision flottante (32 bits), et je pourrais utiliser avec plaisir des instructions avec une double pr√©cision (64 bits) dans l'√©mulation FMA. <br><br>  Il semble que l'√©mulation d'instructions FMA avec une pr√©cision flottante √† l'aide de calculs avec une double pr√©cision devrait √™tre simple ( <em>voix du narrateur: mais ce n'est pas le cas; les op√©rations en virgule flottante ne sont jamais simples</em> ).  Float a une pr√©cision de 24 bits et double a une pr√©cision de 53 bits.  Cela signifie que si vous convertissez le flottant entrant en pr√©cision double (conversion sans perte), vous pouvez effectuer la multiplication sans erreur.  Autrement dit, pour stocker des r√©sultats compl√®tement pr√©cis, seulement 48 bits de pr√©cision suffisent, et nous en avons plus, c'est-√†-dire que tout est en ordre. <br><br>  Ensuite, nous devons faire l'ajout.  Il suffit de prendre le deuxi√®me terme au format flottant, de le convertir en double, puis de l'ajouter au r√©sultat de la multiplication.  √âtant donn√© que l'arrondi ne se produit pas dans le processus de multiplication et qu'il n'est effectu√© qu'apr√®s l'addition, cela suffit compl√®tement pour √©muler le FMA.  Notre logique est parfaite.  Vous pouvez d√©clarer la victoire et rentrer chez vous. <br><br><h2>  La victoire √©tait si proche ... </h2><br>  Mais √ßa ne marche pas.  Ou du moins, il √©choue pour certaines des donn√©es entrantes.  R√©fl√©chissez √† pourquoi cela peut arriver. <br><br><blockquote>  Appeler les sons de la musique en attente ... </blockquote><br>  L'√©chec se produit car, selon la d√©finition de FMA, la multiplication et l'addition sont effectu√©es avec une pr√©cision totale, apr√®s quoi le r√©sultat est arrondi avec un flotteur de pr√©cision.  Nous avons <em>presque</em> r√©ussi √† y parvenir. <br><br>  La multiplication se produit sans arrondi, puis, apr√®s l'ajout, l'arrondi est effectu√©.  C'est <em>semblable</em> √† ce que nous essayons de faire.  Mais l'arrondi apr√®s addition se fait avec une <em>double</em> pr√©cision.  Apr√®s cela, nous devons enregistrer le r√©sultat avec une pr√©cision flottante, c'est pourquoi l'arrondi se produit √† nouveau. <br><br>  Pooh  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Double arrondi</a> . <br><br>  Il sera difficile de le d√©montrer clairement, alors revenons √† nos formats d√©cimaux √† virgule flottante, o√π la pr√©cision simple est de deux d√©cimales et la double pr√©cision est de quatre chiffres.  Et imaginons que nous calculons <code>FMA(8.1e1, 2.9e1, 9.9e-1)</code> , ou <code>81 * 29 + .99</code> . <br><br>  La r√©ponse exacte √† cette expression serait <code>2349.99</code> ou <code>2.34999e3</code> .  Arrondi √† la pr√©cision simple (deux chiffres), nous obtenons <code>2.3e3</code> .  Voyons ce qui ne va pas lorsque nous essayons d'√©muler ces calculs. <br><br>  Lorsque nous multiplions <code>81</code> et <code>29</code> avec une pr√©cision du double, nous obtenons <code>2349</code> .  Jusqu'ici tout va bien. <br><br>  Ensuite, nous ajoutons <code>.99</code> et obtenons <code>2349.99</code> .  Tout va bien. <br><br>  Ce r√©sultat est arrondi √† la pr√©cision du double et nous obtenons <code>2350 (2.350e3)</code> .  Oups <br><br>  Nous l'arrondissons √† la pr√©cision simple et selon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">les</a> r√®gles d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arrondi</a> IEEE <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">au plus proche,</a> nous obtenons <code>2400 (2.4e3)</code> .  Ce n'est pas la bonne r√©ponse.  Il a une erreur l√©g√®rement plus grande que le r√©sultat correctement arrondi renvoy√© par l'instruction FMA. <br><br>  Vous pouvez indiquer que le probl√®me se trouve dans la r√®gle d'environnement IEEE jusqu'au pair le plus proche.  Cependant, quelle que soit la r√®gle d'arrondi que vous choisissez, il y aura toujours un cas o√π un double arrondi renvoie un r√©sultat diff√©rent du vrai FMA. <br><br><h2>  Comment tout cela s'est-il termin√©? </h2><br>  Je n'ai pas pu trouver de solution totalement satisfaisante √† ce probl√®me. <br><br>  J'ai quitt√© l'√©quipe Xbox bien avant la sortie de la Xbox One, et depuis lors je n'ai pas pr√™t√© beaucoup d'attention √† la console, donc je ne sais pas quelle d√©cision ils ont prise.  Les processeurs x64 modernes ont des instructions FMA qui peuvent parfaitement √©muler de telles op√©rations.  Vous pouvez √©galement utiliser le coprocesseur math√©matique x87 pour √©muler FMA - je ne me souviens pas √† quelle conclusion je suis arriv√© quand j'ai √©tudi√© cette question.  Ou peut-√™tre que les d√©veloppeurs ont simplement d√©cid√© que les r√©sultats sont assez proches et peuvent √™tre utilis√©s. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447680/">https://habr.com/ru/post/fr447680/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447670/index.html">La substitution des importations dans la pratique. Partie 2. Le d√©but. Hyperviseur</a></li>
<li><a href="../fr447672/index.html">Catalogue des syst√®mes informatiques de l'entreprise</a></li>
<li><a href="../fr447674/index.html">Le code est vivant et mort. Deuxi√®me partie Actions et propri√©t√©s</a></li>
<li><a href="../fr447676/index.html">Nouveau Mail.ru Mail et qu'est-ce que la pieuvre a √† voir avec √ßa</a></li>
<li><a href="../fr447678/index.html">Le concept d'une br√®ve encyclop√©die</a></li>
<li><a href="../fr447682/index.html">Space Data Center: 24 heures avant le lancement</a></li>
<li><a href="../fr447684/index.html">Comment afficher les valeurs de l'entreprise dans un bureau (sans affiches ni slogans)</a></li>
<li><a href="../fr447686/index.html">Un param√®tre tr√®s important des lampes LED, que peu de gens connaissent</a></li>
<li><a href="../fr447688/index.html">√Ä la question sur le bitset</a></li>
<li><a href="../fr447690/index.html">Configuration compilable d'un syst√®me distribu√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>