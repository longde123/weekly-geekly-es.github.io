<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ≥Ô∏è ü§ûüèº üõ∞Ô∏è Migrando para o Google Cloud Platform (Google Cloud Platform - GCP) üå´Ô∏è üë©üèª‚Äçü§ù‚Äçüë®üèº üë®üèæ‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[parte 2 de 2] 


 [parte 1 de 2] 





 Como fizemos 


 Decidimos mudar para o GCP para melhorar o desempenho do aplicativo - enquanto aumentamos a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migrando para o Google Cloud Platform (Google Cloud Platform - GCP)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/430874/"><h3 id="chast-2-iz-2">  [parte 2 de 2] </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">[parte 1 de 2]</a> </p><br><img src="https://habrastorage.org/webt/6m/2c/sx/6m2csxdumpxfx00xrft85x4vdng.png"><br><p><br></p><br><h2 id="kak-nam-eto-udalos">  Como fizemos </h2><br><p>  Decidimos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mudar para o GCP</a> para melhorar o desempenho do aplicativo - enquanto aumentamos a escala, mas sem custos significativos.  Todo o processo levou mais de 2 meses.  Para resolver esse problema, formamos um grupo especial de engenheiros. </p><br><p>  Nesta publica√ß√£o, falaremos sobre a abordagem escolhida e sua implementa√ß√£o, bem como sobre como conseguimos alcan√ßar o objetivo principal - realizar esse processo da maneira mais tranquila poss√≠vel e transferir toda a infraestrutura para o Google Cloud Platform, sem comprometer a qualidade do servi√ßo ao usu√°rio. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ee6/5d3/693/ee65d3693b51048de4322274109bd23d.png" alt="imagem"></p><a name="habracut"></a><br><h2 id="planirovanie">  Planejamento </h2><br><ol><li>  Uma lista de verifica√ß√£o detalhada foi preparada identificando cada etapa poss√≠vel.  Um fluxograma foi criado para descrever a sequ√™ncia. </li><li>  Foi desenvolvido um plano de redefini√ß√£o que, se houver, poder√≠amos usar. </li></ol><br><p> Algumas sess√µes de brainstorming - e identificamos a abordagem mais compreens√≠vel e simples para implementar o esquema ativo-ativo.  Consiste no fato de que um pequeno conjunto de usu√°rios est√° hospedado em uma nuvem e o restante em outra.  No entanto, essa abordagem causou problemas, especialmente no lado do cliente (relacionados ao gerenciamento de DNS) e levou a atrasos na replica√ß√£o do banco de dados.  Por isso, era quase imposs√≠vel implement√°-lo com seguran√ßa.  O m√©todo √≥bvio n√£o forneceu a solu√ß√£o necess√°ria e tivemos que desenvolver uma estrat√©gia especializada. </p><br><p>  Com base no diagrama de depend√™ncia e nos requisitos de seguran√ßa operacional, dividimos os servi√ßos de infraestrutura em 9 m√≥dulos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/290/5eb/c21/2905ebc2190ea9f8d480e5532a196a1f.jpg" alt="imagem"></p><br><p>  <em>(M√≥dulos b√°sicos para implanta√ß√£o da infraestrutura de hospedagem)</em> </p><br><p>  Cada grupo de infraestrutura gerenciava servi√ßos internos e externos comuns. </p><br><p>  Service <strong>Servi√ßo de mensagens de infraestrutura</strong> : MQTT, HTTPs, Thrift, servidor Gunicorn, m√≥dulo de fila, cliente Async, servidor Jetty, cluster Kafka. <br>  <strong>Warehouse Servi√ßos de Data Warehouse</strong> : cluster distribu√≠do MongoDB, Redis, Cassandra, Hbase, MySQL e MongoDB. <br>  Service <strong>Servi√ßo de an√°lise de infraestrutura</strong> : cluster Kafka, cluster de data warehouse (HDFS, HIVE). </p><br><h2 id="podgotovka-k-znamenatelnomu-dnyu">  Preparando-se para um dia significativo: </h2><br><p>  ‚úì Um plano detalhado para mudar para o GCP para cada servi√ßo: sequ√™ncia, data warehouse, plano de redefini√ß√£o. <br>  ‚úì Intera√ß√µes de rede entre projetos (nuvem privada virtual compartilhada VPC [XPN]) no GCP para isolar diferentes partes da infraestrutura, otimizar o gerenciamento, melhorar a seguran√ßa e a conectividade. <br>  ‚úì V√°rios t√∫neis VPN entre o GCP e a nuvem virtual privada (VPC) em execu√ß√£o para simplificar a transfer√™ncia de grandes quantidades de dados pela rede durante a replica√ß√£o, bem como para a poss√≠vel implanta√ß√£o subsequente de um sistema paralelo. <br>  ‚úì Automatize a instala√ß√£o e configura√ß√£o de toda a pilha usando o sistema Chef. <br>  ‚úì Scripts e ferramentas de automa√ß√£o para implanta√ß√£o, monitoramento, registro, etc. <br>  ‚úì Configure todas as sub-redes necess√°rias e regras de firewall gerenciado para o fluxo do sistema. <br>  ‚úì Replica√ß√£o em v√°rios data centers (Multi-DC) para todos os sistemas de armazenamento. <br>  ‚úì Configurar balanceadores de carga (GLB / ILB) e grupos de inst√¢ncias gerenciadas (MIG). <br>  ‚úì Scripts e c√≥digo para transferir o cont√™iner de armazenamento de objetos para o GCP Cloud Storage com pontos de verifica√ß√£o. </p><br><p>  Em breve, atendemos a todos os pr√©-requisitos necess√°rios e preparamos uma lista de verifica√ß√£o de elementos para mover a infraestrutura para a plataforma GCP.  Ap√≥s in√∫meras discuss√µes, al√©m de considerar o n√∫mero de servi√ßos e seus diagramas de depend√™ncia, decidimos transferir a infraestrutura de nuvem para o GCP em tr√™s noites para cobrir todos os servi√ßos de armazenamento de dados e do servidor. </p><br><h2 id="perehod">  Transi√ß√£o </h2><br><h3 id="strategiya-perenosa-balansirovschika-nagruzki">  Estrat√©gia de transfer√™ncia do balanceador de carga: </h3><br><p>  Substitu√≠mos o cluster gerenciado HAProxy usado anteriormente por um balanceador de carga global para processar diariamente dezenas de milh√µes de conex√µes de usu√°rios ativos. </p><br><p>  ‚äπ <strong>Etapa 1:</strong> </p><br><ul><li>  Os MIGs s√£o criados com regras de encaminhamento de pacotes para encaminhar todo o tr√°fego para os endere√ßos IP do MQTT na nuvem existente. </li><li>  Um balanceador SSL e Proxy TCP foi criado com o MIG como parte do servidor. </li><li>  Para o MIG, o HAProxy √© iniciado com os servidores MQTT como parte do servidor. </li><li>  No DNS, uma pol√≠tica de roteamento baseada em peso adicionou um endere√ßo IP GLB externo. </li></ul><br><p>  As conex√µes do usu√°rio s√£o implantadas gradualmente enquanto acompanha o desempenho delas. </p><br><p>  <strong>2 Etapa 2:</strong> transi√ß√£o de marco, comece a implantar servi√ßos no GCP. <br>  ‚äπ <strong>Etapa 3:</strong> Na etapa final da transi√ß√£o, todos os servi√ßos s√£o transferidos para o GCP. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebb/fcb/614/ebbfcb614345c40b20de5c9e8edd9a8e.png" alt="imagem"></p><br><p>  <em>(Est√°gios de transfer√™ncia do balanceador de carga)</em> </p><br><p>  Nesta fase, tudo funcionou como esperado.  Logo, chegou a hora de implantar v√°rios servi√ßos HTTP internos no GCP com roteamento - considerando o peso dos coeficientes.  Monitoramos de perto todos os indicadores.  Quando come√ßamos a aumentar gradualmente o tr√°fego, no dia anterior √† transi√ß√£o planejada, os atrasos na intera√ß√£o da VPC via VPN (atrasos de 40 ms a 100 ms foram registrados, embora anteriormente fossem inferiores a 10 ms) aumentaram. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b6c/af5/3bc/b6caf53bc304c2fd42c9342dd11faf82.png" alt="imagem"></p><br><p>  <em>(Instant√¢neo da verifica√ß√£o do atraso da rede quando duas VPCs interagem)</em> </p><br><p>  O monitoramento mostrou claramente: algo estava errado com os dois canais de rede na nuvem usando t√∫neis VPN.  Mesmo a taxa de transfer√™ncia do t√∫nel VPN n√£o atingiu a marca ideal.  Essa situa√ß√£o come√ßou a afetar negativamente alguns de nossos servi√ßos de usu√°rio.  Retornamos imediatamente todos os servi√ßos HTTP migrados anteriormente para seu estado original.  Entramos em contato com as equipes de suporte dos servi√ßos de nuvem e TAM, fornecemos os dados iniciais necess√°rios e come√ßamos a entender por que os atrasos estavam aumentando.  Os especialistas em suporte chegaram √† conclus√£o de que foi alcan√ßada a largura de banda m√°xima da rede no canal em nuvem entre dois provedores de servi√ßos em nuvem.  Da√≠ o crescimento de atrasos na rede durante a transfer√™ncia de sistemas internos. </p><br><p>  Este incidente for√ßado a suspender a transi√ß√£o para a nuvem.  Os provedores de servi√ßos em nuvem n√£o conseguiram dobrar a largura de banda com rapidez suficiente.  Portanto, voltamos ao est√°gio de planejamento e revisamos a estrat√©gia.  Decidimos transferir a infraestrutura de nuvem para o GCP em uma noite em vez de tr√™s e inclu√≠mos no plano todos os servi√ßos da parte do servidor e armazenamento de dados.  Quando a hora ‚ÄúX‚Äù chegou, tudo correu bem: as cargas de trabalho foram transferidas com sucesso para o Google Cloud despercebidas pelos nossos usu√°rios! </p><br><h2 id="strategiya-perenosa-bazy-dannyh">  Estrat√©gia de migra√ß√£o de banco de dados: </h2><br><p>  Era necess√°rio transferir mais de 50 pontos de extremidade do banco de dados para um DBMS relacional, armazenamento na mem√≥ria, bem como NoSQL e clusters distribu√≠dos e escalon√°veis ‚Äã‚Äãcom baixa lat√™ncia.  Colocamos r√©plicas de todos os bancos de dados no GCP.  Isso foi feito para todas as implanta√ß√µes, exceto o HBase. </p><br><p>  Replic Replica√ß√£o <strong>mestre-escravo:</strong> implementada para clusters MySQL, Redis, MongoDB e MongoS. <br>  <strong>Replica√ß√£o Multi Multi-DC:</strong> implementada para clusters Cassandra. <br>  ‚äπ <strong>Clusters duplos: um</strong> cluster paralelo foi configurado para Gbase no GCP.  Os dados existentes foram migrados, a entrada dupla foi configurada de acordo com a estrat√©gia de manter a consist√™ncia dos dados nos dois clusters. </p><br><p>  No caso do HBase, o problema estava sendo estabelecido com o Ambari.  Encontramos algumas dificuldades ao colocar clusters em v√°rios datacenters, por exemplo, houve problemas com o DNS, um script de reconhecimento de rack etc. </p><br><p>  As etapas finais (ap√≥s mover os servidores) inclu√≠ram a movimenta√ß√£o das r√©plicas para os servidores principais e o desligamento dos bancos de dados antigos.  Conforme planejado, determinando a prioridade da transfer√™ncia do banco de dados, usamos o Zookeeper para a configura√ß√£o necess√°ria dos clusters de aplicativos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/550/4e6/6d3/5504e66d3db5f8e35db7eccbfb1cfa6e.png" alt="imagem"></p><br><h2 id="strategiya-perenosa-sluzhb-prilozheniy">  Estrat√©gia de migra√ß√£o de servi√ßos de aplicativos </h2><br><p>  Para transferir as cargas de trabalho dos servi√ßos de aplicativos da hospedagem atual para a nuvem GCP, usamos a abordagem de eleva√ß√£o e mudan√ßa.  Para cada servi√ßo de aplicativo, criamos um grupo de inst√¢ncias gerenciadas (MIG) com dimensionamento autom√°tico. </p><br><p>  De acordo com um plano detalhado, come√ßamos a migrar servi√ßos para o GCP, levando em considera√ß√£o a sequ√™ncia e as depend√™ncias dos data warehouses.  Todos os servi√ßos da pilha de mensagens foram migrados para o GCP sem nenhum tempo de inatividade.  Sim, houve algumas pequenas falhas, mas lidamos com elas imediatamente. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b1b/70f/159/b1b70f159f2698731b5b6e166afa1079.png" alt="imagem"></p><br><p>  De manh√£, √† medida que a atividade do usu√°rio aumentava, seguimos cuidadosamente todos os pain√©is e indicadores para identificar rapidamente os problemas.  Algumas dificuldades realmente surgiram, mas conseguimos elimin√°-las rapidamente.  Um dos problemas ocorreu devido √†s limita√ß√µes do balanceador de carga interno (ILB), que pode lidar com n√£o mais de 20.000 conex√µes simult√¢neas.  E precis√°vamos de 8 vezes mais!  Portanto, adicionamos ILBs adicionais √† nossa camada de gerenciamento de conex√µes. </p><br><p>  Nas primeiras horas de pico de carga ap√≥s a transi√ß√£o, controlamos todos os par√¢metros com cuidado, pois toda a carga da pilha de mensagens foi transferida para o GCP.  Houve algumas pequenas falhas com as quais lidamos muito rapidamente.  Ao migrar outros servi√ßos, adotamos a mesma abordagem. </p><br><h2 id="perenos-hranilischa-obektov">  Migra√ß√£o de armazenamento de objetos: </h2><br><p>  Usamos o servi√ßo de armazenamento de objetos principalmente de tr√™s maneiras. </p><br><p>  ‚äπ Armazenamento de arquivos de m√≠dia enviados para um bate-papo pessoal ou em grupo.  O per√≠odo de reten√ß√£o √© determinado pela pol√≠tica de gerenciamento do ciclo de vida. <br>  ‚äπ Armazenamento de imagens e miniaturas do perfil do usu√°rio. <br>  ‚äπ Armazenamento de arquivos de m√≠dia das se√ß√µes "Hist√≥rico" e "Linha do tempo" e as miniaturas correspondentes. </p><br><p>  Usamos a ferramenta de transfer√™ncia de armazenamento do Google para copiar objetos antigos do S3 para o GCS.  Tamb√©m usamos um MIG personalizado baseado em Kafka para transferir objetos do S3 para o GCS quando uma l√≥gica especial era necess√°ria. </p><br><h3 id="perehod-s-s3-na-gcs-vklyuchal-sleduyuschie-shagi">  A transi√ß√£o do S3 para o GCS incluiu as seguintes etapas: </h3><br><p>  ‚óè Para o primeiro caso de uso do armazenamento de objetos, come√ßamos a gravar novos dados no S3 e no GCS e, ap√≥s a expira√ß√£o, come√ßamos a ler os dados do GCS usando a l√≥gica no lado do aplicativo.  A transfer√™ncia de dados antigos n√£o faz sentido e essa abordagem √© econ√¥mica. <br>  ‚óè No segundo e terceiro casos de uso, come√ßamos a gravar novos objetos no GCS e alteramos o caminho para a leitura de dados, para que a pesquisa seja realizada pela primeira vez no GCS e somente ent√£o, se o objeto n√£o for encontrado, no S3. <br>  Demorou <strong>meses para</strong> planejar, verificar a exatid√£o do conceito, preparar e prototipar, mas ent√£o decidimos a transi√ß√£o e a implementamos muito rapidamente.  Avaliamos os riscos e percebemos que a migra√ß√£o r√°pida √© prefer√≠vel e quase impercept√≠vel. <br>  Esse projeto em larga escala nos ajudou a ganhar uma posi√ß√£o forte e aumentar a produtividade da equipe em muitas √°reas, j√° que a maioria das opera√ß√µes manuais de gerenciamento da infraestrutura em nuvem est√° no passado. <br>  ‚óè Quanto aos usu√°rios, agora recebemos tudo o que √© necess√°rio para garantir a mais alta qualidade de seus servi√ßos.  O tempo de inatividade quase desapareceu e os novos recursos est√£o sendo implementados mais rapidamente. <br>  ‚óè Nossa equipe gasta menos tempo em tarefas de manuten√ß√£o e pode se concentrar em projetos de automa√ß√£o e na cria√ß√£o de novas ferramentas. <br>  ‚óè Tivemos acesso a um conjunto de ferramentas sem precedentes para trabalhar com big data, al√©m de funcionalidades prontas para aprendizado e an√°lise de m√°quinas.  Veja detalhes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui.</a> <br>  ‚óè O compromisso do Google Cloud em trabalhar com o projeto de c√≥digo aberto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubernetes</a> tamb√©m <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√°</a> alinhado com o nosso plano de desenvolvimento para este ano. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430874/">https://habr.com/ru/post/pt430874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430864/index.html">Jogos n√£o √© um brinquedo?</a></li>
<li><a href="../pt430866/index.html">Pequim introduzir√° uma classifica√ß√£o social para residentes em 2020</a></li>
<li><a href="../pt430868/index.html">O que lembrar ao comprar NGFW? Lista de verifica√ß√£o</a></li>
<li><a href="../pt430870/index.html">Instale o BigBlueButton no Ubuntu 16.04</a></li>
<li><a href="../pt430872/index.html">Quem vencer√° o debate de malha vs ESB</a></li>
<li><a href="../pt430876/index.html">Desenvolvimento atrav√©s de testes: aprimorando habilidades</a></li>
<li><a href="../pt430878/index.html">Dispon√≠vel PhpStorm 2018.3</a></li>
<li><a href="../pt430880/index.html">Outra implementa√ß√£o de processamento de dados</a></li>
<li><a href="../pt430882/index.html">Xiaomi Aqara Switch refaz de ZigBee para Z-Wave</a></li>
<li><a href="../pt430884/index.html">F√°brica de impress√£o: por que a "LANIT-Integration" abriu sua pr√≥pria "gr√°fica"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>