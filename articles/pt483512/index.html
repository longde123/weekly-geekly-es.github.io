<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚃 🚿 👩🏼‍🏫 Desenvolvendo o pacote pypi perfeito com suporte para diferentes versões do python 🙆🏿 🎵 💕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este é um pequeno manual / história sobre como criar um pacote pypi "perfeito" para python, que qualquer pessoa pode instalar com o comando estimado: ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desenvolvendo o pacote pypi perfeito com suporte para diferentes versões do python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483512/"><p>  Este é um pequeno manual / história sobre como criar um pacote pypi "perfeito" para python, que qualquer pessoa pode instalar com o comando estimado: </p><br><pre><code class="plaintext hljs">pip install my-perfect-package</code> </pre> <br><p>  Destina-se a iniciantes, mas exorto os profissionais a expressarem sua opinião sobre como melhorar o pacote "perfeito".  Portanto, eu peço gato. </p><a name="habracut"></a><br><h2 id="chto-znachit-idealnyy-paket">  O que significa um pacote "ideal"? </h2><br><p>  Vou prosseguir com os seguintes requisitos: </p><br><ul><li>  <strong>Código aberto no github;</strong> <br>  Todos devem poder contribuir para o desenvolvimento e agradecer ao autor. </li><li>  <strong>Suporte para todas as versões atuais / populares do python (2.7, 3.5, 3.6, 3.7, 3.8);</strong> <br>  Pythons são diferentes, e em algum lugar ainda escrevemos ativamente no 2.7. </li><li>  <strong>100% de cobertura com testes de unidade;</strong> <br><del>  Os testes de unidade melhoram a arquitetura e automatizam as verificações de regressão. </del><br>  Um crachá com um número estimado aumenta a FAQ e <a href="https://cmustrudel.github.io/papers/icse18badges.pdf" rel="nofollow">define os padrões para os outros</a> . </li><li>  <strong>Usando o CI:</strong> <br>  As verificações automáticas são muito convenientes! <del>  E um monte de emblemas legais </del><br><ul><li>  <strong>Executando testes de unidade em todas as plataformas e em todas as versões do python;</strong> <br>  Não acredite naqueles que afirmam que o python e os pacotes instalados são <a href="https://docs.python.org/2/library/os.html" rel="nofollow">multiplataforma</a> , porque você sempre pode encontrar um <a href="https://bugs.python.org/issue22587" rel="nofollow">bug</a> . </li><li>  <strong>Verificação de código de estilo;</strong> <br>  Um estilo uniforme melhora a legibilidade e reduz o número de discussões vazias em uma revisão. </li><li>  <strong>Analisador de código estático;</strong> <br>  Pesquisa automática por bugs no código?  Me dê dois! </li></ul></li><li>  <strong>Documentação real;</strong> <br>  Exemplos de trabalho com o pacote, descrição de métodos / classes e análise de erros típicos - a experiência documentada reduzirá o limite de entrada para iniciantes. </li><li>  <strong>Desenvolvimento multiplataforma;</strong> <br>  Infelizmente, é difícil fazer uma contribuição pessoal aos projetos simplesmente porque o desenvolvedor aprimorou as ferramentas do Unix.  Por exemplo, usei scripts bash para montagem. </li><li>  <strong>O pacote é útil e torna o mundo um lugar melhor.</strong> <br>  Um requisito difícil, já que, a julgar pelo número de pacotes em <a href="https://pypi.org/" rel="nofollow">pypi</a> <em>(~ 210k), os</em> desenvolvedores são altruístas e muito já foi escrito. </li></ul><br><h2 id="s-chego-nachat">  Por onde começar? </h2><br><p>  Como não havia boas idéias, escolhi um tópico muito popular e popular - trabalhar com sistemas de números.  A primeira versão deve ser capaz de traduzir números para romano e vice-versa.  Para o manual é mais complicado e não é necessário.  Ah, sim, o mais importante é o nome: <del>  numsys - como uma decodificação de sistemas numéricos. </del>  <em>sistema numeral-py</em> . </p><br><h2 id="kak-testirovat">  Como testar? </h2><br><p>  Peguei <em>python3.7</em> e primeiro escrevi testes com stubs de função (todos somos <a href="https://habr.com/ru/post/121162/">TDDs</a> ) usando o módulo <a href="https://habr.com/ru/post/121162/">unittests</a> padrão. </p><br><p>  Eu faço a seguinte estrutura de projeto: </p><br><pre> <code class="plaintext hljs">src/ numeral-system/ __init__.py roman.py tests __init__.py test_roman.py</code> </pre> <br><p>  Eu não colocarei testes no pacote, então separo <del>  palha </del>  .  Inicialmente, não criei a pasta <code>src/</code> , mas desenvolvimentos adicionais mostraram que é mais conveniente para mim operar.  Isso não é necessário, portanto, à vontade. </p><br><p>  Decidi usar o <a href="https://habr.com/ru/post/269759/">pytest</a> para o lançamento - ele sabe como funcionar perfeitamente com os testes do módulo padrão.  Pode parecer um pouco ilógico, mas o módulo padrão para testes para mim <del>  parece </del>  parecia um pouco mais confortável.  <em>Agora eu recomendaria o uso do estilo pytest de escrita.</em> </p><br><p>  Mas eles dizem que colocar <code>pytest</code> (como quaisquer outras dependências) no sistema python não é uma ideia muito inteligente ... </p><br><h2 id="kak-upravlyat-zavisimostyami">  Como gerenciar dependências? </h2><br><p>  Somente <a href="https://virtualenv.pypa.io/en/latest/" rel="nofollow">virtualenv</a> e <code>requirements.txt</code> podem ser usados.  Você pode ser progressivo e usar <a href="https://poetry.eustace.io/" rel="nofollow">poesia</a> .  Talvez eu use o <a href="https://tox.readthedocs.io/en/latest/" rel="nofollow">tox</a> - uma ferramenta para simplificar a automação e os testes, o que também me permitirá gerenciar dependências. </p><br><p>  Eu crio uma configuração simples do tox.ini e instalo o <code>pytest</code> : </p><br><pre> <code class="plaintext hljs">[tox] envlist = py37 ;     ,   python3.7 [testenv] ;     deps =  `deps`  ,   . -r requirements.txt ;     -r requirements-test.txt ; commands = pytest ;  </code> </pre> <br><p>  Inicialmente, indiquei explicitamente as dependências, mas a prática de integração com serviços de terceiros mostrou que a melhor maneira ainda seria armazenar as dependências no arquivo <code>requirements.txt</code> . </p><br><p>  Um momento muito sutil surge.  Corrigir a versão atual no momento do desenvolvimento ou sempre colocar a mais recente? </p><br><p>  Se você confirmar, durante a instalação poderá haver conflitos entre pacotes devido a diferentes versões das dependências usadas.  Se você não confirmar, o pacote poderá parar de funcionar repentinamente.  A última situação é muito desagradável para os produtos finais, quando todas as compilações podem "ficar vermelhas" em uma noite devido a uma pequena atualização da dependência implícita.  E de acordo <a href="https://en.wikipedia.org/wiki/Murphy%2527s_law" rel="nofollow">com a lei de Murphy,</a> isso acontecerá no dia do lançamento. </p><br><p>  Portanto, desenvolvi uma regra para mim: </p><br><ol><li>  Sempre corrija a versão dos produtos finais, pois as versões a serem usadas são de sua responsabilidade. </li><li>  Não corrija a versão usada para pacotes instalados.  Ou limite-o a um intervalo, se a funcionalidade do pacote exigir. </li></ol><br><h2 id="chto-dalshe">  O que vem a seguir? </h2><br><p>  Estou escrevendo testes! </p><br><p>  Preencho o corpo das funções, adiciono comentários e faço os testes executar corretamente. <br>  Neste ponto, a maioria dos desenvolvedores geralmente para (ainda acredito que todo mundo escreve testes =), publica o pacote e corrompe bugs.  Mas eu segui em frente <del>  e pular na toca do coelho </del>  . </p><br><h2 id="kak-rabotat-s-razlichnymi-versiyami-python">  Como trabalhar com diferentes versões do python? </h2><br><p>  Na configuração <code>tox</code> , <code>tox</code> especifico o lançamento de testes em todas as versões interessantes do python: </p><br><pre> <code class="plaintext hljs">[tox] envlist = py{27,35,36,37,38}</code> </pre> <br><p>  Usando <a href="https://khashtamov.com/ru/pyenv-python/" rel="nofollow">pyenv, eu</a> entrego as versões necessárias para mim localmente, para que o <code>tox</code> possa encontrá-las e criar ambientes de teste. </p><br><h2 id="gde-zavetnye-100">  Onde estão os 100% estimados? </h2><br><p>  Vou adicionar uma medida da cobertura do código - para isso, há um excelente pacote de <a href="https://coverage.readthedocs.io/en/v4.5.x/" rel="nofollow">cobertura</a> e uma integração não menos excelente com o pytest - <a href="https://github.com/pytest-dev/pytest-cov" rel="nofollow">pytest-cov</a> . <br>  <code>requirements-test.txt</code> agora se parece com isso: </p><br><pre> <code class="plaintext hljs">six=1.13.0 pytest=4.6.7 pytest-cov=2.8.1 parameterized=0.7.1</code> </pre> <br><p>  De acordo com a regra acima, eu corrijo versões de pacotes que são usados ​​para executar testes. </p><br><p>  Eu mudo o comando test run: </p><br><pre> <code class="plaintext hljs">deps = -r requirements.txt -r requirements-test.txt commands = pytest \ --cov=src/ \ --cov-config="{toxinidir}/tox.ini" \ --cov-append</code> </pre> <br><p>  Estou coletando estatísticas de cobertura para todo o código da pasta <code>src/</code> - o próprio pacote ( <em>numeral_system /</em> ) e necessário para o código de teste ( <em>tests /</em> ) - não quero que os testes contenham partes não executáveis? </p><br><p>  <code>--cov-append</code> comando <code>--cov-append</code> todas as estatísticas coletadas para cada chamada em uma versão diferente do python em uma, porque a cobertura para o segundo e o terceiro python pode ser diferente (código dependente da versão e módulo <a href="https://pypi.org/project/six/" rel="nofollow">seis</a> !), Mas, no total, dê 100 %  Um exemplo simples: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sys.version_info &gt; (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>): <span class="hljs-comment"><span class="hljs-comment"># Python 3 code in this block else: # Python 2 code in this block</span></span></code> </pre> <br><p>  Adicione um novo ambiente para criar um relatório de cobertura. </p><br><pre> <code class="plaintext hljs">[testenv:coverage_report] deps = coverage commands = coverage html ;   ,   coverage report --include="src/*" --fail-under=100 -m ;    100% </code> </pre> <br><p>  E adiciono à lista de ambientes depois de executar os testes em todas as versões do python. </p><br><pre> <code class="plaintext hljs">[tox] envlist = py{27,35,36,37,38} coverage_report</code> </pre> <br><p>  Após executar o comando <code>tox</code> , a pasta <code>tox</code> contém o arquivo <code>index.html</code> com um relatório bonito deve aparecer na raiz do projeto. </p><br><p>  Para o emblema cobiçado, <a href="https://codecov.io/" rel="nofollow">integro</a> 100% ao serviço <a href="https://codecov.io/" rel="nofollow">codecov</a> , que já se integra ao <code>github</code> e permite visualizar o histórico de alterações na cobertura do código.  Para fazer isso, é claro, você precisará criar uma conta lá. </p><br><p>  O ambiente de lançamento final é o seguinte: </p><br><pre> <code class="plaintext hljs">[testenv:coverage_report] deps = coverage==5.0.2 codecov==2.0.15 commands = coverage html coverage report --include="src/*" --fail-under=100 -m coverage xml codecov -f coverage.xml --token=2455dcfa-f9fc-4b3a-b94d-9765afe87f0f ;     codecov,   </code> </pre> <br><p>  Agora resta apenas adicionar um link ao emblema no <code>README.rst</code> : </p><br><pre> <code class="plaintext hljs">|Code Coverage| .. |Code Coverage| image:: https://codecov.io/gh/zifter/numeral-system-py/branch/master/graph/badge.svg :target: https://codecov.io/gh/zifter/numeral-system-py</code> </pre> <br><h2 id="kak-formatirovat-i-analizirovat-kod">  Como formatar e analisar o código? </h2><br><p>  Muitos analisadores não existem, porque, na maioria das vezes, se complementam.  Portanto, integrarei analisadores estáticos populares que verificarão a conformidade com o <a href="https://www.python.org/dev/peps/pep-0008/" rel="nofollow">PEP8</a> , encontrarão possíveis problemas e <del>  corrigir todos os erros </del>  formate uniformemente o código. </p><br><p>  Você deve considerar imediatamente onde especificar os parâmetros para o ajuste fino dos analisadores.  Para fazer isso, você pode usar o arquivo <code>setup.cfg</code> , <code>setup.cfg</code> , um único arquivo personalizado ou arquivos específicos para analisadores.  Decidi usar o <code>tox.ini</code> diretamente, pois você pode copiar o <code>tox.ini</code> para projetos futuros. </p><br><h2 id="isort">  Isort </h2><br><p>  <a href="https://github.com/timothycrosley/isort" rel="nofollow">O isort</a> é um utilitário para formatar importações. </p><br><p>  Eu crio o ambiente a seguir para executar o <code>isort</code> no modo de formato de código. </p><br><pre> <code class="plaintext hljs">[testenv:isort] changedir = {toxinidir}/src deps = isort==4.3.21 commands = isort -y -sp={toxinidir}/tox.ini</code> </pre> <br><p>  Infelizmente, o <code>isort</code> não pode especificar uma pasta para formatação.  Portanto, você deve alterar o diretório de inicialização via <code>changedir</code> e especificar o caminho para o arquivo com as configurações <code>-sp={toxinidir}/tox.ini</code> .  A opção <code>-y</code> é necessária para desativar o modo interativo. </p><br><p>  Para executar testes, você precisa de um modo de verificação - para isso, existe um sinalizador <code>--check-only</code> : </p><br><pre> <code class="plaintext hljs">[testenv:isort-check] changedir = {toxinidir}/src deps = isort==4.3.21 commands = isort --check-only -sp={toxinidir}/tox.ini</code> </pre> <br><h2 id="black">  preto </h2><br><p>  Em seguida, integro-me ao formatador de código <a href="https://black.readthedocs.io/en/stable/" rel="nofollow">preto</a> .  Eu faço isso por analogia com o <code>isort</code> : </p><br><pre> <code class="plaintext hljs">[testenv:black] deps = black==19.10b0 commands = black src/ [testenv:black-check] deps = black==19.10b0 commands = black --check src/</code> </pre> <br><p>  Tudo funciona bem, mas há um conflito com o <code>isort</code> - há uma diferença na <a href="https://github.com/psf/black/issues/127" rel="nofollow">formatação das importações</a> . </p><br><p>  Em <a href="https://github.com/timothycrosley/isort/issues/694" rel="nofollow">um dos comentários,</a> encontrei uma configuração <code>isort</code> minimamente compatível, que usei: </p><br><pre> <code class="plaintext hljs">[isort] multi_line_output=3 include_trailing_comma=True force_grid_wrap=0 use_parentheses=True line_length=88</code> </pre> <br><h2 id="flake8">  flake8 </h2><br><p>  Em seguida, <a href="http://flake8.pycqa.org/en/latest/" rel="nofollow">integro-</a> me aos analisadores estáticos <a href="http://flake8.pycqa.org/en/latest/" rel="nofollow">flake8</a> . </p><br><pre> <code class="plaintext hljs">[testenv:flake8-check] deps = flake8==3.7.9 commands = flake8 --config=tox.ini src/</code> </pre> <br><p>  Há <a href="https://github.com/psf/black/issues/113" rel="nofollow">problemas com a integração</a> com o <code>black</code> novamente.  Temos que adicionar um ajuste fino que, de fato, é <a href="https://github.com/psf/black" rel="nofollow">recomendado</a> pelo próprio <code>black</code> : </p><br><pre> <code class="plaintext hljs">[flake8] max-line-length=88 ignore=E203</code> </pre> <br><p>  Infelizmente, a primeira vez que não funcionou.  <code>E231 missing whitespace after ','</code> com o erro <code>E231 missing whitespace after ','</code> , tive que adicionar este erro para ignorar: </p><br><pre> <code class="plaintext hljs">[flake8] max-line-length=88 ignore=E203,E231</code> </pre> <br><h2 id="pylint">  pilão </h2><br><p>  Integrar com <a href="https://www.pylint.org/" rel="nofollow">analisadores de</a> código estático <a href="https://www.pylint.org/" rel="nofollow">pylint</a> </p><br><pre> <code class="plaintext hljs">[testenv:pylint-check] deps = {[testenv]deps} # pylint  ,     pylint==2.4.4 commands = pylint --rcfile=tox.ini src/</code> </pre> <br><p>  Imediatamente me deparei com restrições estranhas - nomes de funções de 30 caracteres (sim, escrevo nomes muito longos de métodos de teste) e avisos sobre a presença de <code>TODO</code> no código. <br>  Eu tenho que adicionar algumas exceções: </p><br><pre> <code class="plaintext hljs">[MESSAGES CONTROL] disable=fixme,invalid-name</code> </pre> <br><p>  Além disso, o momento desagradável é que os desenvolvedores do <code>pylint</code> já enterraram o <code>python2.7</code> e não estão mais desenvolvendo um pacote para ele.  Portanto, as verificações devem ser executadas no pacote atual do <code>python3.7</code> . <br>  Adicione a linha apropriada à configuração: </p><br><pre> <code class="plaintext hljs">[tox] envlist = isort-check black-check flake8-check pylint-check py{27,35,36,37,38} coverage_report basepython = python3.7</code> </pre> <br><p>  Também é importante para a execução de testes em plataformas diferentes, pois a versão padrão do python nos sistemas de CI é diferente. </p><br><h2 id="chto-tam-s-ci">  O que há com a CI? </h2><br><h3 id="appveyor">  Appveyor </h3><br><p>  Integre-se com o <a href="https://www.appveyor.com/" rel="nofollow">appveyor</a> - CI para Windows.  A configuração inicial é simples - tudo pode ser feito na interface, faça o download do arquivo yaml e o envie para o repositório. </p><br><pre> <code class="plaintext hljs">version: 0.0.{build} install: - cmd: &gt;- C:\\Python37\\python -m pip install --upgrade pip C:\\Python37\\pip install tox build: off test_script: - cmd: C:\\Python37\\tox</code> </pre> <br><p>  Aqui eu especifico explicitamente a versão do <code>python3.7</code> , já que o <code>python2.7</code> será usado por padrão (e o <code>tox</code> também usará essa versão, embora eu tenha especificado explicitamente o <code>python3.7</code> ). <br>  O link para o emblema, como de costume, é adicionado ao <code>README.rst</code> </p><br><pre> <code class="plaintext hljs">|Build status Appveyor| .. |Build status Appveyor| image:: https://ci.appveyor.com/api/projects/status/github/zifter/numeral-system-py?branch=master&amp;svg=true :target: https://ci.appveyor.com/project/zifter/numeral-system-py</code> </pre> <br><h3 id="travis-ci">  Travis ci </h3><br><p>  Depois disso, integro-me ao <a href="https://travis-ci.org/" rel="nofollow">Travis CI</a> -CI no Linux (e no MacOS com Windows, mas as <a href="https://docs.travis-ci.com/user/languages/python/" rel="nofollow"><code>Python builds are not available on the macOS and Windows environments</code></a> . A instalação é um pouco mais complicada, pois o arquivo de configuração será usado diretamente no repositório. Algumas iterações de tentativa e erro - a configuração está pronta, eu esmago em um belo commit e a solicitação de mesclagem está pronta. </p><br><pre> <code class="plaintext hljs">language: python python: 3.8 # dist: xenial # required for Python 3.7 (travis-ci/travis-ci#9069) sudo: required # required for Python 3.7 (travis-ci/travis-ci#9069) addons: apt: sources: - deadsnakes packages: - python3.5 - python3.6 - python3.7 - pypy install: - pip install tox script: - tox</code> </pre> <br><p>  ( <em>Pergunta retórica: E por que projetos de IC gostam tanto do formato yaml?</em> ) </p><br><p>  <code>python3.8</code> a versão do <code>python3.8</code> , uma vez que não funcionou corretamente através do <code>addon</code> , e o <code>Travis CI</code> cria <code>virtualenv</code> partir da versão especificada. </p><br><p>  Pessoas familiarizadas com o <code>Travis CI</code> podem perguntar: por que não especificar explicitamente as versões em python dessa maneira?  Afinal, o <code>Travis CI</code> cria automaticamente <code>virtualenv</code> e executa os comandos necessários. </p><br><p>  O motivo é que precisamos coletar dados de cobertura de código de todas as versões.  Mas os testes serão executados em diferentes trabalhos em paralelo, e é por isso que não funcionará para coletar um relatório de cobertura geral. </p><br><p>  Claro, tenho certeza de que um pouco mais de compreensão e isso pode ser corrigido. </p><br><p>  Por tradição, um link para um emblema também é adicionado ao <code>README.rst</code> </p><br><pre> <code class="plaintext hljs">|Build Status Travis CI| .. |Build Status Travis CI| image:: https://travis-ci.org/zifter/numeral-system-py.svg?branch=master :target: https://travis-ci.org/zifter/numeral-system-py</code> </pre> <br><h2 id="dokumentaciya">  A documentação </h2><br><p>  Eu acho que todos os desenvolvedores python usaram o serviço pelo menos uma vez - <a href="https://readthedocs.org/" rel="nofollow">readthedocs.org</a> .  Parece-me que este é o melhor serviço para hospedar sua documentação. <br>  Vou usar a ferramenta padrão para gerar a documentação do <a href="http://www.sphinx-doc.org/en/master/" rel="nofollow">Sphinx</a> .  Sigo as etapas do <a href="https://docs.readthedocs.io/en/stable/intro/getting-started-with-sphinx.html" rel="nofollow">manual inicial</a> e obtenho a seguinte estrutura: </p><br><pre> <code class="plaintext hljs">src/ docs/ build/ #      html  source/ #     _static/ #   , ,  _templates/ #     conf.py #    index.rst #    make.bat Makefile # make     make</code> </pre> <br><p>  Em seguida, você precisa executar as etapas mínimas para configurar: </p><br><ol><li>  <code>github</code> por padrão, sugere a criação de um arquivo <code>README.md</code> no formato <a href="https://en.wikipedia.org/wiki/Markdown" rel="nofollow">Markdown</a> , quando como <code>sphinx</code> por padrão, sugere o uso de <a href="https://en.wikipedia.org/wiki/ReStructuredText" rel="nofollow">ReStructuredText</a> . </li></ol><br><p>  Portanto, tive que reescrevê-lo no formato <code>.rst</code> . <del>  E se eu tivesse lido o manual de início até o fim pelo menos uma vez, percebi que a <code>sphinx</code> pode fazê-lo no Markdown </del>  . <br>  <code>README.rst</code> arquivo <code>README.rst</code> em <code>index.rst</code> </p><br><pre> <code class="plaintext hljs">.. include:: ../../README.rst</code> </pre> <br><ol><li>  Para gerar automaticamente a documentação dos comentários na fonte, adiciono a extensão <a href="http://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html" rel="nofollow">sphinx.ext.autodoc</a> . </li><li>  Eu <code>conf.py</code> pasta <code>conf.py</code> pacote ao <code>conf.py</code>  Isso permitirá que o <code>sphinx</code> importe nosso código para análise. <br><pre> <code class="plaintext hljs">import os import sys sys.path.insert(0, os.path.abspath('./../../src')) import numeral_system</code> </pre> </li><li>  Eu adiciono a pasta <code>docs/source/api-docs</code> e largo o arquivo de descrição para cada módulo lá.  A documentação deve ser gerada automaticamente a partir dos comentários: <br><pre> <code class="plaintext hljs">Roman numeral system ========================= .. automodule:: numeral_system.roman :members:</code> </pre> </li></ol><br><p>  Depois disso, o projeto está pronto para revelar sua descrição ao mundo.  Você precisa criar uma conta (de preferência através de uma conta no <code>github</code> ) e importar seu projeto. As etapas detalhadas estão descritas nas <a href="" rel="nofollow">instruções</a> . <br>  Por tradição, eu crio um ambiente em <code>tox</code> : </p><br><pre> <code class="plaintext hljs">[testenv:gen_docs] deps = -r docs/requirements.txt commands = sphinx-build -b html docs/source/ docs/build/</code> </pre> <br><p>  Eu uso o <code>sphinx-build</code> explicitamente, em vez de <code>make</code> , pois ele não existe no Windows.  E não quero violar o princípio do desenvolvimento de plataforma cruzada. </p><br><p>  Assim que as alterações forem congeladas, o <code>readthedocs.org</code> coletará automaticamente a documentação e a publicará. </p><br><p>  Mas ... A <a href="https://github.com/readthedocs/readthedocs.org/issues/2569" rel="nofollow"><code>Build failed</code></a> .  Não confirmei as <code>sphinx_rtd_theme</code> <code>sphinx</code> e <code>sphinx_rtd_theme</code> e esperava que o <code>readthedocs.org</code> as versões atuais.  Mas isso não é verdade.  Eu conserto: </p><br><pre> <code class="plaintext hljs">sphinx==2.3.1 sphinx_rtd_theme==0.4.3</code> </pre> <br><p>  E eu crio um arquivo de configuração especial <code>.readthedocs.yml</code> para <code>readthedocs.org</code> , no qual descrevo o ambiente para iniciar a compilação: </p><br><pre> <code class="plaintext hljs">python: version: 3.7 install: - requirements: docs/requirements.txt - requirements: requirements.txt</code> </pre> <br><p>  Foi aqui que o fato foi útil de que as dependências estão nos arquivos <code>requirements.txt</code> .  Estou aguardando a compilação e a <a href="https://numeral-system-py.readthedocs.io/en/latest/" rel="nofollow">documentação fica disponível</a> . </p><br><p>  Adicione o selo novamente: </p><br><pre> <code class="plaintext hljs">|Docs| .. |Docs| image:: https://readthedocs.org/projects/numeral-system-py/badge/?version=latest&amp;style=flat :target: https://numeral-system-py.readthedocs.io/en/latest/</code> </pre> <br><h2 id="licenzirovanie">  Licenciamento </h2><br><p>  Vale a pena considerar a escolha de uma licença para o pacote. <br>  Este é um tópico muito extenso, então eu li <a href="https://habr.com/ru/post/243091/">este artigo</a> .  Basicamente, a escolha é entre o <a href="http://directory.fsf.org/wiki/License:Expat" rel="nofollow">MIT</a> e o <a href="" rel="nofollow">Apache 2.0</a> .  Gostei da frase que foi retirada do contexto com sucesso: </p><br><pre> <code class="plaintext hljs">MIT      </code> </pre> <br><p>  Concordo plenamente, farei isso: se os planos mudarem, você poderá alterar facilmente a licença (embora as versões anteriores estejam sob a antiga). </p><br><p>  Mais uma vez, adicione um emblema <del>  crachá deus </del>  : </p><br><pre> <code class="plaintext hljs">|License| .. |License| image:: https://img.shields.io/badge/License-MIT-yellow.svg :target: https://opensource.org/licenses/MIT</code> </pre> <br><p>  <a href="https://gist.github.com/lukas-h/2a5d00690736b4c3a7ba" rel="nofollow">Aqui</a> você pode encontrar emblemas para todas as licenças. </p><br><h2 id="kak-zalit-na-pypi">  Como fazer upload para pypi? </h2><br><p>  Primeiro, você precisa criar uma conta no <a href="https://pypi.org/" rel="nofollow">pypi.org</a> .  Em seguida, prossiga com a preparação da embalagem. </p><br><h3 id="sozdayu-setupcfg">  Eu crio o setup.cfg </h3><br><p>  É necessário descrever corretamente a configuração para instalar / construir o pacote.  Eu segui as <a href="https://docs.python.org/3/distutils/introduction.html" rel="nofollow">instruções</a> .  É possível definir dados via <code>setup.py</code> , mas não há opções para definir alguns parâmetros.  Portanto, use o arquivo <code>setup.cfg</code> , no qual você pode especificar todas as nuances.  Encontrou um <a href="https://gist.github.com/althonos/6914b896789d3f2078d1e6237642c35c" rel="nofollow">pequeno modelo</a> sobre como preencher esse arquivo.  Como resultado, eu uso esse e aquele arquivo - é mais conveniente. </p><br><p>  Este arquivo também pode ser usado para definir <code>pylint</code> , <code>flake8</code> e outras configurações, mas não o fiz. </p><br><h3 id="kak-sobrat-paket">  Como montar um pacote? </h3><br><p>  Mais uma vez, estou escrevendo um ambiente que me ajudará a montar o pacote necessário: </p><br><pre> <code class="plaintext hljs">[testenv:build_wheel] skip_install = True deps = ;     wheel docutils pygments commands = python -c 'import shutil; (shutil.rmtree(p, ignore_errors=True) for p in ["build", "dist"]);' python setup.py sdist bdist_wheel</code> </pre> <br><p>  Por que estou excluindo pastas usando python?  Quero cumprir o requisito de desenvolvimento de plataforma cruzada, não há uma maneira conveniente de fazer isso no Windows e no Unix. </p><br><p>  Eu inicio o ambiente de teste: </p><br><pre> <code class="plaintext hljs">tox -e build_wheel</code> </pre> <br><p>  Como resultado, na pasta <code>dist</code> eu recebo: </p><br><pre> <code class="plaintext hljs">dist/ numeral-system_py-0.1.0.tar.gz numeral_system-py-0.1.0-py2.py3-none-any.whl</code> </pre> <br><h3 id="zalivayu">  Eu preencho! </h3><br><p>  Na verdade não. </p><br><p>  Para começar, vale a pena verificar se o pacote funciona corretamente.  Vou fazer o upload para o repositório de pacotes de teste.  Portanto, você precisa criar outra conta, mas já em <a href="https://test.pypi.org/" rel="nofollow">test.pypi.org</a> . </p><br><p>  Eu uso o pacote de <a href="https://pypi.org/project/twine/" rel="nofollow">cordéis</a> para isso - uma ferramenta para preencher artefatos no PyPi. </p><br><pre> <code class="plaintext hljs">[testenv:test_upload] skip_install = True deps = twine ;    commands = python -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*</code> </pre> <br><p>  Inicialmente, o projeto era chamado <code>numsys</code> , mas ao tentar preenchê-lo, percebi que já havia um pacote com o mesmo nome!  E o que é mais irritante - ele também sabe como converter em números romanos :) Ele não ficou muito chateado e renomeado para <code>numeral-system-py</code> numerais <code>numeral-system-py</code> . </p><br><p>  Agora você precisa instalar o pacote a partir do ambiente de teste.  A validação também deve ser automatizada: </p><br><pre> <code class="plaintext hljs">[testenv:test_venv] skip_install = True ;         deps = ;   commands = pip install -i https://test.pypi.org/simple/ numeral-system-py</code> </pre> <br><p>  Agora você só precisa executar: </p><br><pre> <code class="plaintext hljs">tox -e test_venv ... test_venv: commands_succeeded congratulations :)</code> </pre> <br><p>  Parece funcionar :) </p><br><h3 id="vot-teper-tochno-zalivayu">  Agora definitivamente derramar! </h3><br><p>  Sim </p><br><p>  Eu crio um ambiente para carregar no repositório de produção. </p><br><pre> <code class="plaintext hljs">[testenv:pypi_upload] skip_install = True deps = twine commands = python -m twine upload dist/*</code> </pre> <br><p>  E o ambiente para verificação da produção. </p><br><pre> <code class="plaintext hljs">[testenv:pypi_venv] skip_install = True deps = ;    commands = pip install numeral-system-py</code> </pre> <br><h3 id="a-vse-tochno-rabotaet">  Tudo funciona? </h3><br><p>  Verifico com comandos simples: </p><br><pre> <code class="plaintext hljs">&gt; virtualenv venv &gt; source venv/bin/activate (venv) &gt; pip install numeral-system-py (venv) &gt; python &gt;&gt;&gt; import numeral_system &gt;&gt;&gt; numeral_system.roman.encode(7) 'VII'</code> </pre> <br><p>  Está tudo ótimo! </p><br><p>  <a href="https://help.github.com/en/articles/creating-releases" rel="nofollow">Eu cortei o release no github</a> , colecionei o pacote e o preenchi no propi pypi. </p><br><h2 id="zamechaniya">  Observações </h2><br><h3 id="obnovleniya-zavisimostey">  Atualizações de dependência </h3><br><p>  Durante a preparação deste artigo, foi lançada uma nova versão do pytest, na qual, de fato, o suporte ao python 3.4 foi descartado (na <a href="https://github.com/tox-dev/tox/issues/1483" rel="nofollow">verdade,</a> no pacote <a href="https://github.com/tartley/colorama" rel="nofollow">colorama</a> ).  Havia duas opções: </p><br><ol><li>  Confirme a versão do colorama compatível com 3.4; </li><li>  Drop support 3.4 :) </li></ol><br><p>  A favor da segunda opção, o último argumento foi que o <code>pip</code> abandonou o suporte 3.4 na versão 19.1. </p><br><p>  Também existem dependências fixas na forma de analisadores, formatadores e outros serviços.  Essas dependências podem ser atualizadas ao mesmo tempo.  Se tiver sorte, você só sairá com a versão de atualização; caso contrário, terá que corrigir o código ou até mesmo adicionar as configurações. </p><br><h3 id="travisci">  TravisCI </h3><br><p>  Não suporta python para MacOS e Windows.  Há dificuldades em executar o <code>tox</code> para todas as versões do python no mesmo trabalho. </p><br><h3 id="versiya-paketa">  Versão do pacote </h3><br><p>  É necessário aderir ao <a href="https://semver.org/" rel="nofollow">controle de versão semântico</a> , a saber, o formato: </p><br><pre> <code class="plaintext hljs">MAJOR.MINOR.PATCH</code> </pre> <br><h3 id="dublirovanie-meta-informacii">  Duplicação de meta informações </h3><br><p>  A versão do pacote e alguns outros parâmetros devem ser especificados para instalar o pacote (em <code>setup.cfg</code> ou <code>setup.py</code> ) e na documentação.  Para evitar duplicação, ele fez uma indicação apenas no pacote <code>numeral_system/__init__.py</code> : </p><br><pre> <code class="plaintext hljs">__version__ = '0.2.0'</code> </pre> <br><p>  E então em <code>setup.py</code> uso explicitamente essa variável </p><br><pre> <code class="plaintext hljs">setup(version=numeral_system.__version__)</code> </pre> <br><p>  O mesmo vale para <code>docs/source/conf.py</code> </p><br><pre> <code class="plaintext hljs">release = numeral_system.__version__</code> </pre> <br><p>  O acima é válido para qualquer meta informação - <code>REAMDE.rst</code> , descrições de projetos, licenças, nomes de autores e muito mais. </p><br><p>  É verdade que isso leva ao fato de que o pacote está sendo importado no momento da montagem, o que pode ser indesejável. </p><br><h3 id="dublirovanie-zavisimostey">  Duplicação de Dependências </h3><br><p>      ,         <code>requirements.txt</code>  <code>setup.cfg</code> . <br>   <a href="https://caremad.io/posts/2013/07/setup-vs-requirement/" rel="nofollow"> </a> ,   —     <code>setup.cfg</code> . <br>      . ,      <code>requirements-dev.txt</code>  . </p><br><h3 id="organizaciya-ishodnikov">   </h3><br><p>    ,       <code>src/</code> .     : </p><br><ul><li>       ; </li><li>    ,             ,   ; </li></ul><br><p>     : </p><br><ul><li>    <code>PyCharm</code> (    ?) —   <code>src</code> ,   . </li></ul><br><h3 id="kommity-i-istoriya-izmeneniy">     </h3><br><p>           —   . <br>  <a href="https://github.com/zifter/numeral-system-py/commits/master" rel="nofollow"> </a>  ,     : </p><br><pre> <code class="plaintext hljs">Add badge with supported version Support for py38</code> </pre> <br><p>     : </p><br><pre> <code class="plaintext hljs">Try fix py38 env creating Try fix py38 env creating Try fix py38 env creating Fix check</code> </pre> <br><p> , 3       !        Travis CI. </p><br><p>  <a href="https://habr.com/ru/post/416887/"> </a>  ,    .     —     ,         . </p><br><p>         ,         .       <code>CHANGELOG</code> . </p><br><h3 id="dokumentaciya-1">  </h3><br><p>     ,   <code>Markdown</code> .     ,      <code>rst</code> . </p><br><h3 id="beydzhi">  Emblemas </h3><br><p>      —  ,  ,   ,      .    ,     <a href="https://cmustrudel.github.io/papers/icse18badges.pdf" rel="nofollow"> </a> . <br>     <a href="https://pypi.org/project/coverage/" rel="nofollow">coverage</a> . </p><br><h3 id="ogranicheniya-iz-za-ispolzovaniya-raznyh-versiy">  -    </h3><br><p>   ,     ,  , .   <code>six</code>    ,       ,  <code>type hint</code> , <code>asyncio</code>    — . <br>      <code>python2.7</code> ,   <a href="https://pythonclock.org/" rel="nofollow"> </a> .   ,    python3.5+,     . ,         ,      CI   .          . </p><br><h2 id="mozhno-li-sdelat-luchshe">    ? </h2><br><p>       ,    : </p><br><ul><li>   MacOS; </li><li>   python x64  x86; </li><li>   ; </li><li> 100%      ,    <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity" rel="nofollow">  </a> .     <a href="https://pypi.org/project/mccabe/" rel="nofollow">mccabe</a> ,      2017 .    ? </li><li>        <a href="https://pyup.io/" rel="nofollow">PyUp</a>  <a href="https://requires.io/" rel="nofollow">requires.io</a> .  ? </li><li>    .     <a href="https://github.com/PyCQA0" rel="nofollow">Python Code Quality Authority</a> , - ? <br><ul><li> <a href="http://mypy-lang.org/" rel="nofollow">mypy</a> —  ; </li><li> <a href="https://github.com/PyCQA/bandit" rel="nofollow">bandit</a> —       ; </li><li> <a href="https://github.com/PyCQA/pyflakes" rel="nofollow">Pyflakes</a> —      ; </li><li> <a href="https://github.com/PyCQA/prospector" rel="nofollow">prospector</a> — ,  <code>pylint</code> , <code>pep8</code> , <code>mccabe</code> . ,    ; </li></ul></li><li>   \   ? </li></ul><br><h2 id="zaklyuchenie">  Conclusão </h2><br><p>           open source ,     . <br>           ,    python   <code>github</code> ,       . <br>        <code>stackoverflow.com</code>  issues    <code>github</code>            . <br>           .      .      ?.. </p><br><p> ,  ,     <a href="https://habr.com/ru/company/ruvds/blog/444344/">   </a> . <br>       ,    <a href="https://sourcery.ai/blog/python-best-practices/" rel="nofollow"> </a> . </p><br><p> <a href="https://github.com/zifter/numeral-system-py" rel="nofollow">    github</a> . </p><br><p>  Obrigada </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt483512/">https://habr.com/ru/post/pt483512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt483500/index.html">Por que as luzes traseiras do Cadillac XLR podem custar mais do que o Corolla usado</a></li>
<li><a href="../pt483502/index.html">Sol, vento e água ver 0.2</a></li>
<li><a href="../pt483506/index.html">Sonhos de um vácuo profundo (parte 1). Bomba de difusão de óleo a vapor: ressuscitação e um pouco de teoria</a></li>
<li><a href="../pt483508/index.html">Os 10 principais documentos da conferência CoreHard Autumn 2019 de C ++</a></li>
<li><a href="../pt483510/index.html">Testador para uma pequena empresa como esta</a></li>
<li><a href="../pt483516/index.html">Pare de colocar o diodo 2</a></li>
<li><a href="../pt483518/index.html">O desenvolvedor do jogo VVVVVV em homenagem a sua década tornou o código fonte aberto</a></li>
<li><a href="../pt483520/index.html">Usando o observador de padrões de similaridade em C</a></li>
<li><a href="../pt483524/index.html">Análise Habra: quando é melhor publicar seu post?</a></li>
<li><a href="../pt483526/index.html">Gerenciando o estado do aplicativo com o RxJS / Immer como uma alternativa simples ao Redux / MobX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>