<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèø üßëüèΩ‚Äçü§ù‚Äçüßëüèª üïã Test Python avec pytest. Luminaires int√©gr√©s, Chapitre 4 üßó üöï üïå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Retour Suivant 


 Les appareils int√©gr√©s fournis avec pytest peuvent vous aider √† faire des choses assez utiles dans vos tests facilement et naturell...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Test Python avec pytest. Luminaires int√©gr√©s, Chapitre 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448792/"><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Retour</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Suivant</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p><br><p>  <em>Les appareils int√©gr√©s fournis avec pytest peuvent vous aider √† faire des choses assez utiles dans vos tests facilement et naturellement.</em>  <em>Par exemple, en plus de g√©rer les fichiers temporaires, pytest comprend des appareils int√©gr√©s pour acc√©der aux param√®tres de ligne de commande, la communication entre les sessions de test, la v√©rification des flux de sortie, la modification des variables d'environnement et les alertes d'interrogation.</em> </p><br><p><img src="https://habrastorage.org/webt/hd/--/9w/hd--9w134j0rxhmxftrflbbdopy.png"></p><a name="habracut"></a><br><blockquote> Le code source du projet T√¢ches, ainsi que pour tous les tests pr√©sent√©s dans ce livre, est disponible sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="https://pragprog.com/titles/bopytest/source_code">lien</a> sur la page Web du livre √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="https://pragprog.com/titles/bopytest">pragprog.com</a> .  Vous n'avez pas besoin de t√©l√©charger le code source pour comprendre le code de test;  le code de test est pr√©sent√© sous une forme pratique dans les exemples.  Mais afin de suivre les t√¢ches du projet ou d'adapter des exemples de test pour v√©rifier votre propre projet (vos mains sont d√©li√©es!), Vous devez vous rendre sur la page Web du livre pour t√©l√©charger le travail.  L√†, sur la page Web du livre, il y a un lien vers le message d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="https://pragprog.com/titles/bopytest/errata">errata</a> et le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" title="https://forums.pragprog.com/forums/438">forum de discussion</a> . </blockquote><p>  Sous le spoiler se trouve une liste d'articles de cette s√©rie. </p><br><div class="spoiler">  <b class="spoiler_title">Table des mati√®res</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Pr√©sentation</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 1: Premiers pas avec Pytest</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 2: √âcriture des fonctions de test</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 3: Appareils Pytest</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 4: Luminaires int√©gr√©s</strong></a> (cet article) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 5: Plugins</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 6: Configuration</strong></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Chapitre 7: Utilisation de pytest avec d'autres outils</strong></a> </li></ul></div></div><br><p>  Dans le chapitre pr√©c√©dent, vous avez examin√© ce que sont les appareils, comment les √©crire et comment les utiliser pour les donn√©es de test, ainsi que pour le code de configuration et de d√©montage. </p><br><p> Vous avez √©galement utilis√© conftest.py pour partager des appareils entre les tests dans plusieurs fichiers de test.  √Ä la fin du chapitre 3, les appareils suivants ont √©t√© install√©s dans les appareils pytest √† la page 49 du projet T√¢ches: <code>tasks_db_session</code> , <code>tasks_just_a_few</code> , <code>tasks_mult_per_owner</code> , <code>tasks_db</code> , <code>db_with_3_tasks</code> et <code>db_with_multi_per_owner</code> d√©fini dans conftest.py qui peut √™tre utilis√© par n'importe quelle fonction qui peut √™tre utilis√©e par test en a besoin. </p><br><p>  R√©utiliser des appareils r√©guliers est une si bonne id√©e que les d√©veloppeurs de pytest ont inclus certains appareils couramment requis dans pytest.  Vous avez d√©j√† vu comment tmpdir et tmpdir_factory sont utilis√©s par le projet T√¢ches dans la section de modification de l'√©tendue pour les appareils du projet T√¢ches √† la page 59. Vous en discuterez plus en d√©tail dans ce chapitre. </p><br><p>  Les appareils int√©gr√©s fournis avec pytest peuvent vous aider √† faire des choses assez utiles dans vos tests facilement et naturellement.  Par exemple, en plus de g√©rer les fichiers temporaires, pytest comprend des appareils int√©gr√©s pour acc√©der aux param√®tres de ligne de commande, la communication entre les sessions de test, la v√©rification des flux de sortie, la modification des variables d'environnement et les alertes d'interrogation.  Les luminaires int√©gr√©s sont des extensions de la fonctionnalit√© de base de Pytest.  Voyons maintenant quelques-uns des appareils en ligne les plus couramment utilis√©s dans l'ordre. </p><br><h2 id="ispolzovanie-tmpdir-i-tmpdir_factory">  Utilisation de tmpdir et tmpdir_factory </h2><br><p>  Si vous testez quelque chose qui lit, √©crit ou modifie des fichiers, vous pouvez utiliser tmpdir pour cr√©er des fichiers ou des r√©pertoires utilis√©s par un seul test, et vous pouvez utiliser <code>tmpdir_factory</code> lorsque vous souhaitez configurer un r√©pertoire pour plusieurs tests. </p><br><p>  Le <code>tmpdir</code> tmpdir a une port√©e de fonction, et le fixture <code>tmpdir_factory</code> a une port√©e de session.  Tout test unique qui n√©cessite un r√©pertoire ou un fichier temporaire pour un seul test peut utiliser <code>tmpdir</code> .  Cela est √©galement vrai pour les appareils qui personnalisent le r√©pertoire ou le fichier qui doit √™tre recr√©√© pour chaque fonction de test. </p><br><p>  Voici un exemple simple utilisant <code>tmpdir</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>ch4/test_tmpdir.py</code></a> </blockquote> <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_tmpdir</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># tmpdir    ,    # join()  ,    , #     a_file = tmpdir.join('something.txt') #    a_sub_dir = tmpdir.mkdir('anything') #      (  ) another_file = a_sub_dir.join('something_else.txt') #    'something.txt' a_file.write('contents may settle during shipping') #    'anything/something_else.txt' another_file.write('something different') #      assert a_file.read() == 'contents may settle during shipping' assert another_file.read() == 'something different'</span></span></code> </pre> <br><p>  La valeur renvoy√©e par <code>tmpdir</code> est un objet de type <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>py.path.local.1</code></a> qui semble √™tre tout ce dont nous avons besoin pour les r√©pertoires et fichiers temporaires.  Cependant, il y a une astuce.  √âtant donn√© que le dispositif <code>tmpdir</code> d√©fini comme une <em>√©tendue de fonction</em> , <code>tmpdir</code> ne peut pas √™tre utilis√© pour cr√©er des dossiers ou des fichiers qui doivent √™tre disponibles pendant plus d'une fonction de test.  Pour les appareils avec une port√©e autre qu'une fonction (classe, module, session), <code>tmpdir_factory</code> est disponible. </p><br><p>  Le <code>tmpdir_factory</code> tmpdir_factory <code>tmpdir_factory</code> tr√®s similaire √† <code>tmpdir</code> , mais a une interface diff√©rente.  Comme d√©crit dans la section ¬´Sp√©cification des fixations de l'oscilloscope¬ª, page 56, les luminaires de zone de fonction s'ex√©cutent une fois pour chaque fonction de test, les luminaires de r√©gion de module s'ex√©cutent une fois par module, les luminaires de classe une fois pour chaque classe et les tests de validation de zone travailler une fois par session.  Ainsi, les ressources cr√©√©es dans les enregistrements de zone de session ont une dur√©e de vie de la session enti√®re.  Pour montrer √† quel point <code>tmpdir</code> et <code>tmpdir_factory</code> , je vais <code>tmpdir</code> exemple <code>tmpdir</code> , o√π <code>tmpdir_factory</code> : </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4 / test_tmpdir.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_tmpdir_factory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir_factory)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      . a_dir   # ,    tmpdir a_dir = tmpdir_factory.mktemp('mydir') # base_temp    'mydir'    #  getbasetemp(),  # ,    base_temp = tmpdir_factory.getbasetemp() print('base:', base_temp) #       , #    ' test_tmpdir ()',   , #    a_dir  tmpdir a_file = a_dir.join('something.txt') a_sub_dir = a_dir.mkdir('anything') another_file = a_sub_dir.join('something_else.txt') a_file.write('contents may settle during shipping') another_file.write('something different') assert a_file.read() == 'contents may settle during shipping' assert another_file.read() == 'something different'</span></span></code> </pre> <br><p>  La premi√®re ligne utilise <code>mktemp('mydir')</code> pour cr√©er le r√©pertoire et le stocke dans <code>a_dir</code> .  Pour le reste de la fonction, vous pouvez utiliser <code>a_dir</code> de la m√™me mani√®re que <code>tmpdir</code> renvoy√© par le <code>tmpdir</code> . </p><br><p>  Dans la deuxi√®me ligne de l'exemple <code>tmpdir_factory</code> , la fonction <code>getbasetemp()</code> renvoie le r√©pertoire de base utilis√© pour cette session.  L'instruction <em>print</em> dans l'exemple est n√©cessaire pour que vous puissiez afficher le r√©pertoire sur votre syst√®me.  Voyons o√π c'est: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/code/ch4 $ pytest -q -s test_tmpdir.py::test_tmpdir_factory base: /private/var/folders/53/zv4j_zc506x2xq25l31qxvxm0000gn/T/pytest-of-okken/pytest-732 . 1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.04 seconds</code> </pre> <br><p>  Ce r√©pertoire de base d√©pend du syst√®me et de l'utilisateur, et <code>pytest - NUM</code> change pour chaque session avec un nombre croissant.  Le r√©pertoire de base est laiss√© seul apr√®s la session.  pytest le nettoie et seuls les quelques r√©pertoires de base temporaires les plus r√©cents restent sur le syst√®me, ce qui est bien si vous √™tes impatient de v√©rifier les fichiers apr√®s un test. </p><br><p>  Vous pouvez √©galement sp√©cifier votre propre r√©pertoire de base si vous en avez besoin avec <code>pytest --basetemp=mydir</code> . </p><br><h3 id="ispolzovanie-vremennyh-katalogov-dlya-drugih-oblastey">  Utilisation de r√©pertoires temporaires pour d'autres domaines </h3><br><p>  Nous obtenons des r√©pertoires temporaires et des fichiers de zone de <strong>session</strong> du <code>tmpdir_factory</code> , et <strong>des</strong> r√©pertoires de <strong>fonctions</strong> et des fichiers de r√©gion du <code>tmpdir</code> .  Mais qu'en est-il des autres domaines?  Et si nous avons besoin d'un r√©pertoire temporaire de la port√©e d'un module ou d'une classe?  Pour ce faire, nous cr√©ons un autre appareil de la r√©gion de la taille souhait√©e et pour cela, nous devons utiliser <code>tmpdir_factory</code> . </p><br><p>  Par exemple, supposons que nous ayons un module rempli de tests, et que beaucoup d'entre eux devraient pouvoir lire certaines donn√©es d'un fichier <em>json</em> .  Nous avons pu placer le volume du luminaire dans le module lui-m√™me, ou dans le fichier <em>conftest.py</em> , qui configure le fichier de donn√©es comme suit: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4 / auteurs / conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Demonstrate tmpdir_factory."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest @pytest.fixture(scope=<span class="hljs-string"><span class="hljs-string">'module'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">author_file_json</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir_factory)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     ."""</span></span> python_author_data = { <span class="hljs-string"><span class="hljs-string">'Ned'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Boston'</span></span>}, <span class="hljs-string"><span class="hljs-string">'Brian'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Portland'</span></span>}, <span class="hljs-string"><span class="hljs-string">'Luciano'</span></span>: {<span class="hljs-string"><span class="hljs-string">'City'</span></span>: <span class="hljs-string"><span class="hljs-string">'Sau Paulo'</span></span>} } file = tmpdir_factory.mktemp(<span class="hljs-string"><span class="hljs-string">'data'</span></span>).join(<span class="hljs-string"><span class="hljs-string">'author_file.json'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'file:{}'</span></span>.format(str(file))) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> file.open(<span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(python_author_data, f) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file</code> </pre> <br><p>  Le <code>author_file_json()</code> cr√©e un r√©pertoire temporaire appel√© <em>data</em> et cr√©e un fichier appel√© <em>author_file.json</em> dans le r√©pertoire data.  Ensuite, il √©crit le dictionnaire <code>python_author_data</code> en <em>json</em> .  Puisqu'il s'agit d'un module de fixture area, un fichier json sera cr√©√© une seule fois pour chaque module √† l'aide du test: </p><br><blockquote>  <strong>ch4 / auteurs / test_authors.py</strong> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" ,    ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_brian_in_portland</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(author_file_json)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""",   ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> author_file_json.open() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: authors = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> authors[<span class="hljs-string"><span class="hljs-string">'Brian'</span></span>][<span class="hljs-string"><span class="hljs-string">'City'</span></span>] == <span class="hljs-string"><span class="hljs-string">'Portland'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_all_have_cities</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(author_file_json)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""        ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> author_file_json.open() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: authors = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> authors: <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(authors[a][<span class="hljs-string"><span class="hljs-string">'City'</span></span>]) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Les deux tests utiliseront le m√™me fichier JSON.  Si un fichier de donn√©es de test fonctionne pour plusieurs tests, il est inutile de le recr√©er pour les deux tests. </p><br><h2 id="ispolzovanie-pytestconfig">  Utilisation de pytestconfig </h2><br><p>  √Ä l'aide du dispositif pytestconfig int√©gr√©, vous pouvez contr√¥ler le fonctionnement de pytest avec les arguments et les options de ligne de commande, les fichiers de configuration, les plugins et le r√©pertoire √† partir duquel vous avez lanc√© pytest.  Le fixture pytestconfig est un raccourci vers request.config, et est parfois appel√© dans la documentation pytest ¬´ <em>l'objet de configuration pytest</em> ¬ª (objet de configuration pytest). </p><br><p>  Pour savoir comment fonctionne <em>pytestconfig</em> , vous pouvez voir comment ajouter un param√®tre de ligne de commande personnalis√© et lire la valeur du param√®tre √† partir du test.  Vous pouvez lire la valeur des param√®tres de ligne de commande directement depuis pytestconfig, mais pour ajouter un param√®tre et l'analyser, vous devez ajouter une fonction hook.  Les fonctions de <em>hook</em> , que je d√©cris plus en d√©tail dans le Chapitre 5, ¬´Plugins¬ª, page 95, sont une autre fa√ßon de contr√¥ler le comportement de pytest et sont souvent utilis√©es dans les plugins.  Cependant, l'ajout d'une option de ligne de commande personnalis√©e et sa lecture √† partir de <em>pytestconfig est</em> assez r√©pandu, donc je veux couvrir cela ici. </p><br><p>  Nous allons utiliser le <em>crochet</em> <code>pytest_addoption</code> pour ajouter plusieurs param√®tres aux param√®tres d√©j√† disponibles sur la ligne de commande pytest: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4 / pytestconfig / conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pytest_addoption</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(parser)</span></span></span><span class="hljs-function">:</span></span> parser.addoption(<span class="hljs-string"><span class="hljs-string">"--myopt"</span></span>, action=<span class="hljs-string"><span class="hljs-string">"store_true"</span></span>, help=<span class="hljs-string"><span class="hljs-string">"some boolean option"</span></span>) parser.addoption(<span class="hljs-string"><span class="hljs-string">"--foo"</span></span>, action=<span class="hljs-string"><span class="hljs-string">"store"</span></span>, default=<span class="hljs-string"><span class="hljs-string">"bar"</span></span>, help=<span class="hljs-string"><span class="hljs-string">"foo: bar or baz"</span></span>)</code> </pre> <br><p>  L'ajout de param√®tres de ligne de commande via <code>pytest_addoption</code> doit √™tre effectu√© via des plugins ou dans le fichier <strong>conftest.py</strong> situ√© en haut de la structure du r√©pertoire du projet.  Vous ne devriez pas faire cela dans le sous-r√©pertoire test. </p><br><p>  Les <code>--myopt</code> et <code>--foo &lt;value&gt;</code> ont √©t√© ajout√©es au code pr√©c√©dent et la ligne d'aide a √©t√© modifi√©e comme indiqu√© ci-dessous: </p><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /path/to/code/ch4/pytestconfig $ pytest --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> usage: pytest [options] [file_or_dir] [file_or_dir] [...] ... custom options: --myopt some boolean option --foo=FOO foo: bar or baz ...</code> </pre> <br><p>  Maintenant, nous pouvons acc√©der √† ces options √† partir du test: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4 / pytestconfig / test_config.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_option</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pytestconfig)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'"foo" set to:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'foo'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'"myopt" set to:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'myopt'</span></span>))</code> </pre> <br><p>  Voyons comment cela fonctionne: </p><br><pre> <code class="bash hljs">$ pytest -s -q test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: bar <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: False .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds $ pytest -s -q --myopt test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: bar <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: True .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds $ pytest -s -q --myopt --foo baz test_config.py::test_option <span class="hljs-string"><span class="hljs-string">"foo"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: baz <span class="hljs-string"><span class="hljs-string">"myopt"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> to: True .1 passed <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.01 seconds</code> </pre> <br><p>  Puisque pytestconfig est un luminaire, il peut √©galement √™tre obtenu √† partir d'autres luminaires.  Vous pouvez cr√©er des fixations pour les noms d'options si vous le souhaitez, par exemple: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4 / pytestconfig / test_config.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture() def foo(pytestconfig): return pytestconfig.option.foo @pytest.fixture() def myopt(pytestconfig): return pytestconfig.option.myopt def test_fixtures_for_options(foo, myopt): print('"foo" set to:', foo) print('"myopt" set to:', myopt)</span></span></code> </pre> <br><p>  Vous pouvez √©galement acc√©der aux param√®tres int√©gr√©s, pas seulement ceux ajout√©s, ainsi qu'aux informations sur le lancement de pytest (r√©pertoire, arguments, etc.). </p><br><p>  Voici un exemple de plusieurs valeurs et options de configuration: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_pytestconfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pytestconfig)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'args :'</span></span>, pytestconfig.args) print(<span class="hljs-string"><span class="hljs-string">'inifile :'</span></span>, pytestconfig.inifile) print(<span class="hljs-string"><span class="hljs-string">'invocation_dir :'</span></span>, pytestconfig.invocation_dir) print(<span class="hljs-string"><span class="hljs-string">'rootdir :'</span></span>, pytestconfig.rootdir) print(<span class="hljs-string"><span class="hljs-string">'-k EXPRESSION :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'keyword'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-v, --verbose :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'verbose'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-q, --quiet :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'quiet'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'-l, --showlocals:'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'showlocals'</span></span>)) print(<span class="hljs-string"><span class="hljs-string">'--tb=style :'</span></span>, pytestconfig.getoption(<span class="hljs-string"><span class="hljs-string">'tbstyle'</span></span>))</code> </pre> <br><p>  Nous reviendrons sur pytestconfig lorsque je pr√©senterai les fichiers ini dans le chapitre 6, ¬´Configuration¬ª, page 113. </p><br><h2 id="using-cache">  Utilisation du cache </h2><br><p>  Habituellement, nous, les testeurs, pensons que chaque test est aussi ind√©pendant que possible des autres tests.  Vous devez vous assurer que les d√©pendances de la comptabilit√© des commandes ne se sont pas gliss√©es.  J'aimerais pouvoir ex√©cuter ou red√©marrer n'importe quel test dans n'importe quel ordre et obtenir le m√™me r√©sultat.  De plus, les sessions de test doivent √™tre r√©p√©tables et ne pas changer de comportement en fonction des sessions de test pr√©c√©dentes. </p><br><p>  Cependant, le transfert d'informations d'une session de test √† une autre peut parfois √™tre tr√®s utile.  Lorsque nous voulons transmettre des informations √† de futures sessions de test, nous pouvons le faire avec le dispositif de <code>cache</code> int√©gr√©. </p><br><p>  Le <code>cache</code> appareils <code>cache</code> con√ßu pour stocker des informations sur une session de test et les obtenir dans la suivante.  Un bon exemple d'utilisation des autorisations de <code>cache</code> au profit de l'affaire est la fonctionnalit√© int√©gr√©e <code>--last-failed</code> et <code>--failed-first</code> .  Voyons comment les donn√©es de ces indicateurs sont stock√©es dans le cache. </p><br><p>  Voici le texte d'aide pour les options <code>--last-failed</code> et <code>--failed-first</code> , ainsi que certaines options de <code>cache</code> : </p><br><pre> <code class="plaintext hljs">$ pytest --help ... --lf, --last-failed rerun only the tests that failed at the last run (or all if none failed) --ff, --failed-first run all tests but run the last failures first. This may re-order tests and thus lead to repeated fixture setup/teardown --cache-show show cache contents, don t perform collection or tests --cache-clear remove all cache contents at start of test run. ...</code> </pre> <br><p>  Pour les voir en action, nous allons utiliser ces deux tests: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=http://">ch4 / cache / test_pass_fail.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_this_passes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_this_fails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> == <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><p>  <code>--verbose</code> les en utilisant <code>--verbose</code> pour voir les noms des fonctions et <code>--tb=no</code> pour masquer la trace de la pile: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest --verbose --tb=no test_pass_fail.py ==================== test session starts ==================== collected 2 items test_pass_fail.py::test_this_passes PASSED test_pass_fail.py::test_this_fails FAILED ============ 1 failed, 1 passed in 0.05 seconds =============</code> </pre> <br><p>  Si vous les r√©ex√©cutez avec l' <code>--ff</code> ou <code>--failed-first</code> , les tests qui ont √©chou√© pr√©c√©demment seront ex√©cut√©s en premier, puis toute la session: </p><br><pre> <code class="plaintext hljs">$ pytest --verbose --tb=no --ff test_pass_fail.py ==================== test session starts ==================== run-last-failure: rerun last 1 failures first collected 2 items test_pass_fail.py::test_this_fails FAILED test_pass_fail.py::test_this_passes PASSED ============ 1 failed, 1 passed in 0.04 seconds =============</code> </pre> <br><p>  Ou vous pouvez utiliser <code>--lf</code> ou <code>--last-failed</code> pour simplement ex√©cuter les tests qui ont √©chou√© la derni√®re fois: </p><br><pre> <code class="plaintext hljs">$ pytest --verbose --tb=no --lf test_pass_fail.py ==================== test session starts ==================== run-last-failure: rerun last 1 failures collected 2 items test_pass_fail.py::test_this_fails FAILED ==================== 1 tests deselected ===================== ========== 1 failed, 1 deselected in 0.05 seconds ===========</code> </pre> <br><p>  Avant de voir comment les donn√©es de plantage sont stock√©es et comment vous pouvez utiliser le m√™me m√©canisme, regardons un autre exemple qui rend la valeur de <code>--lf</code> et <code>--ff</code> encore plus √©vidente. </p><br><p>  Voici un test param√©tr√© avec un √©chec: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4 / cache / test_few_failures.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""Demonstrate -lf and -ff with failing tests."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> approx testdata = [ <span class="hljs-comment"><span class="hljs-comment"># x, y, expected (1.01, 2.01, 3.02), (1e25, 1e23, 1.1e25), (1.23, 3.21, 4.44), (0.1, 0.2, 0.3), (1e25, 1e24, 1.1e25) ] @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y assert sum_ == approx(expected)</span></span></code> </pre> <br><p>  Et en sortie: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest -q test_few_failures.py .F... ====================== FAILURES ====================== _________________________ test_a[1e+25-1e+23-1.1e+25] _________________________ x = 1e+25, y = 1e+23, expected = 1.1e+25 @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y &gt; assert sum_ == approx(expected) E assert 1.01e+25 == 1.1e+25 ¬± 1.1e+19 E + where 1.1e+25 ¬± 1.1e+19 = approx(1.1e+25) test_few_failures.py:17: AssertionError 1 failed, 4 passed in 0.06 seconds</code> </pre> <br><p>  Vous pouvez peut-√™tre identifier le probl√®me tout de suite.  Mais imaginons que le test est plus long et plus compliqu√©, et ce qui ne va pas ici n'est pas si √©vident.  Ex√©cutons √† nouveau le test pour voir √† nouveau l'erreur.  Le sc√©nario de test peut √™tre sp√©cifi√© sur la ligne de commande: </p><br><pre> <code class="plaintext hljs">$ pytest -q "test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]"</code> </pre> <br><p>  Si vous ne voulez pas copier-coller <em>(copier / coller</em> ) ou si vous souhaitez red√©marrer plusieurs cas malheureux, alors <code>--lf</code> beaucoup plus facile.  Et si vous <code>--showlocals</code> vraiment un √©chec de test, un autre indicateur qui peut faciliter la situation est <code>--showlocals</code> , ou <code>-l</code> pour faire court: </p><br><pre> <code class="plaintext hljs">$ pytest -q --lf -l test_few_failures.py F ====================== FAILURES ====================== _________________________ test_a[1e+25-1e+23-1.1e+25] _________________________ x = 1e+25, y = 1e+23, expected = 1.1e+25 @pytest.mark.parametrize("x,y,expected", testdata) def test_a(x, y, expected): """Demo approx().""" sum_ = x + y &gt; assert sum_ == approx(expected) E assert 1.01e+25 == 1.1e+25 ¬± 1.1e+19 E + where 1.1e+25 ¬± 1.1e+19 = approx(1.1e+25) expected = 1.1e+25 sum_ = 1.01e+25 x = 1e+25 y = 1e+23 test_few_failures.py:17: AssertionError ================= 4 tests deselected ================= 1 failed, 4 deselected in 0.05 seconds</code> </pre><br><p>  La raison de l'√©chec devrait √™tre plus √©vidente. </p><br><p>  Afin de garder √† l'esprit que le test a √©chou√© la derni√®re fois, il y a une petite astuce.  pytest stocke les informations sur les erreurs de test de la derni√®re session de test et vous pouvez afficher les informations enregistr√©es avec <code>--cache-show</code> : </p><br><pre> <code class="plaintext hljs">$ pytest --cache-show ===================== test session starts ====================== ------------------------- cache values ------------------------- cache/lastfailed contains: {'test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]': True} ================= no tests ran in 0.00 seconds =================</code> </pre> <br><p>  Ou vous pouvez regarder dans le r√©pertoire cache: </p><br><pre> <code class="plaintext hljs">$ cat .cache/v/cache/lastfailed { "test_few_failures.py::test_a[1e+25-1e+23-1.1e+25]": true }</code> </pre> <br><p>  Le <code>--clear-cache</code> vous permet de vider le cache avant une session. </p><br><p>  Le cache peut √™tre utilis√© non seulement pour <code>--lf</code> et <code>--ff</code> .  √âcrivons un appareil qui enregistre le temps que prennent les tests, fait gagner du temps et la prochaine fois qu'il signale une erreur dans les tests qui prennent deux fois plus de temps que, disons, la derni√®re fois. </p><br><p>  L'interface du dispositif de cache est simple. </p><br><pre> <code class="plaintext hljs">cache.get(key, default) cache.set(key, value)</code> </pre> <br><p>  Par convention, les noms de cl√© commencent par le nom de votre application ou plug-in, suivi de <code>/</code> et continuent de s√©parer les sections de nom de cl√© par <code>/</code> .  La valeur que vous stockez peut √™tre toute valeur convertie en <em>json</em> , car elle est repr√©sent√©e dans le <code>.cache directory</code> . </p><br><p>  Voici notre appareil utilis√© pour fixer le temps de test: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4 / cache / test_slower.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture(autouse=True) def check_duration(request, cache): key = 'duration/' + request.node.nodeid.replace(':', '_') #   (nodeid)    #      .cache #    -     start_time = datetime.datetime.now() yield stop_time = datetime.datetime.now() this_duration = (stop_time - start_time).total_seconds() last_duration = cache.get(key, None) cache.set(key, this_duration) if last_duration is not None: errorstring = "       2-  " assert this_duration &lt;= last_duration * 2, errorstring</span></span></code> </pre> <br><p>  √âtant donn√© que le luminaire est <em>autouse</em> , il n'a pas besoin d'√™tre r√©f√©renc√© √† partir du test.  L'objet <em>request</em> est utilis√© pour obtenir le <em>nodeid</em> √† utiliser dans la cl√©.  <em>nodeid</em> est un identifiant unique qui fonctionne m√™me avec des tests param√©tr√©s.  Nous ajoutons une cl√© avec 'duration /' pour √™tre des r√©sidents respectables du cache.  Le code ci-dessus est ex√©cut√© avant la fonction de test;  le code apr√®s <em>rendement</em> est ex√©cut√© apr√®s la fonction de test. </p><br><p>  Maintenant, nous avons besoin de tests qui prennent des intervalles de temps diff√©rents: </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4 / cache / test_slower.py</a> </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.mark.parametrize('i', range(5)) def test_slow_stuff(i): time.sleep(random.random())</span></span></code> </pre> <br><p>  √âtant donn√© que vous ne voulez probablement pas √©crire un tas de tests pour cela, j'ai utilis√© <code>random</code> et le param√©trage pour g√©n√©rer facilement des tests qui dorment pendant une dur√©e al√©atoire, tous plus courts qu'une seconde.  Voyons quelques fois comment cela fonctionne: </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cache $ pytest -q --cache-clear test_slower.py ..... 5 passed in 2.10 seconds $ pytest -q --tb=line test_slower.py ...E..E =================================== ERRORS ==================================== ___________________ ERROR at teardown of test_slow_stuff[1] ___________________ E AssertionError: test duration over 2x last duration assert 0.35702 &lt;= (0.148009 * 2) ___________________ ERROR at teardown of test_slow_stuff[4] ___________________ E AssertionError: test duration over 2x last duration assert 0.888051 &lt;= (0.324019 * 2) 5 passed, 2 error in 3.17 seconds</code> </pre> <br><p>  Eh bien, c'√©tait amusant.  Voyons ce qu'il y a dans le cache: </p><br><pre> <code class="plaintext hljs">$ pytest -q --cache-show -------------------------------- cache values --------------------------------- cache\lastfailed contains: {'test_slower.py::test_slow_stuff[2]': True, 'test_slower.py::test_slow_stuff[4]': True} cache\nodeids contains: ['test_slower.py::test_slow_stuff[0]', 'test_slower.py::test_slow_stuff[1]', 'test_slower.py::test_slow_stuff[2]', 'test_slower.py::test_slow_stuff[3]', 'test_slower.py::test_slow_stuff[4]'] cache\stepwise contains: [] duration\test_slower.py__test_slow_stuff[0] contains: 0.958055 duration\test_slower.py__test_slow_stuff[1] contains: 0.214012 duration\test_slower.py__test_slow_stuff[2] contains: 0.19001 duration\test_slower.py__test_slow_stuff[3] contains: 0.725041 duration\test_slower.py__test_slow_stuff[4] contains: 0.836048 no tests ran in 0.03 seconds</code> </pre> <br><p>  Vous pouvez facilement voir les donn√©es de <code>duration</code> s√©par√©ment des donn√©es de cache en raison du pr√©fixe des noms de donn√©es de cache.  Cependant, il est int√©ressant de <code>lastfailed</code> que la fonctionnalit√© <code>lastfailed</code> peut fonctionner avec une seule entr√©e de cache.  Nos donn√©es de dur√©e occupent une entr√©e de cache pour chaque test.  Suivons l'exemple du dernier √©chec et mettons nos donn√©es dans un seul enregistrement. </p><br><p>  Nous lisons et mettons en cache pour chaque test.  Nous pouvons diviser le fixture en fixture de la port√©e de la fonction pour mesurer la dur√©e et la fixture de la port√©e de la session pour la lecture et l'√©criture dans le cache.  Cependant, si nous le faisons, nous ne pourrons pas utiliser le dispositif de cache car il a la port√©e de la fonction.  Heureusement, un rapide coup d'≈ìil √† l'impl√©mentation sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> montre que le dispositif de mise en cache renvoie simplement <code>request.config.cache</code> .  Il est disponible dans tous les domaines. </p><br><p>          : </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/cache/test_slower_2.py</a> </p><br><pre> <code class="python hljs">Duration = namedtuple(<span class="hljs-string"><span class="hljs-string">'Duration'</span></span>, [<span class="hljs-string"><span class="hljs-string">'current'</span></span>, <span class="hljs-string"><span class="hljs-string">'last'</span></span>]) @pytest.fixture(scope=<span class="hljs-string"><span class="hljs-string">'session'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">duration_cache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> key = <span class="hljs-string"><span class="hljs-string">'duration/testdurations'</span></span> d = Duration({}, request.config.cache.get(key, {})) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> d request.config.cache.set(key, d.current) @pytest.fixture(autouse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_duration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, duration_cache)</span></span></span><span class="hljs-function">:</span></span> d = duration_cache nodeid = request.node.nodeid start_time = datetime.datetime.now() <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> duration = (datetime.datetime.now() - start_time).total_seconds() d.current[nodeid] = duration <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> d.last.get(nodeid, <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: errorstring = <span class="hljs-string"><span class="hljs-string">"test duration over 2x last duration"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> duration &lt;= (d.last[nodeid] * <span class="hljs-number"><span class="hljs-number">2</span></span>), errorstring</code> </pre> <br><p>  <code>duration_cache</code>   .       ,     ,    - .        ,     <code>namedtuple</code>  <em>Duration</em>    <code>current</code>  <code>last</code> .     <code>namedtuple</code>  <code>test_duration</code> ,         .    ,   <code>namedtuple</code>    ,         <code>d.current</code> .          . </p><br><p>     ,     : </p><br><pre> <code class="plaintext hljs">$ pytest -q --cache-clear test_slower_2.py ..... 5 passed in 2.80 seconds $ pytest -q --tb=no test_slower_2.py ...EE.. 7 passed, 2 error in 3.21 seconds $ pytest -q --cache-show -------------------------------- cache values --------------------------------- cache\lastfailed contains: {'test_slower_2.py::test_slow_stuff[2]': True, 'test_slower_2.py::test_slow_stuff[3]': True} duration\testdurations contains: {'test_slower_2.py::test_slow_stuff[0]': 0.483028, 'test_slower_2.py::test_slow_stuff[1]': 0.198011, 'test_slower_2.py::test_slow_stuff[2]': 0.426024, 'test_slower_2.py::test_slow_stuff[3]': 0.762044, 'test_slower_2.py::test_slow_stuff[4]': 0.056003, 'test_slower_2.py::test_slow_stuff[5]': 0.18401, 'test_slower_2.py::test_slow_stuff[6]': 0.943054} no tests ran in 0.02 seconds</code> </pre> <br><p>  . </p><br><h2 id="ispolzovanie-capsys">  capsys </h2><br><p>  <code>capsys builtin</code>    :   stdout  stderr   ,     .     stdout  stderr. </p><br><p> ,         stdout: </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">greeting</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'Hi, {}'</span></span>.format(name))</code> </pre> <br><p>     ,   .   -  stdout.       capsys: </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_greeting</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> greeting(<span class="hljs-string"><span class="hljs-string">'Earthling'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">'Hi, Earthling\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> err == <span class="hljs-string"><span class="hljs-string">''</span></span> greeting(<span class="hljs-string"><span class="hljs-string">'Brian'</span></span>) greeting(<span class="hljs-string"><span class="hljs-string">'Nerd'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">'Hi, Brian\nHi, Nerd\n'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> err == <span class="hljs-string"><span class="hljs-string">''</span></span></code> </pre> <br><p>  <code>stdout</code>  <code>stderr</code>   <code>capsys.redouterr()</code> .   ‚Äî  ,      ,     . </p><br><p>      <code>stdout</code> .    ,   <code>stderr</code> : </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yikes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(problem)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'YIKES! {}'</span></span>.format(problem), file=sys.stderr) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_yikes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> yikes(<span class="hljs-string"><span class="hljs-string">'Out of coffee!'</span></span>) out, err = capsys.readouterr() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> out == <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-string"><span class="hljs-string">'Out of coffee!'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> err</code> </pre> <br><p> <em>pytest</em>        .     <em>print</em> .            .  <code>-s</code>   ,      stdout    .    ,        ,      .   ,             pytest  ,    ,   .      <em>capsys</em> .    <code>capsys.disabled()</code> ,       . </p><br><p>  Voici un exemple: </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/cap/test_capsys.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_capsys_disabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(capsys)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> capsys.disabled(): print(<span class="hljs-string"><span class="hljs-string">'\nalways print this'</span></span>) <span class="hljs-comment"><span class="hljs-comment">#    print('normal print, usually captured') #  ,  </span></span></code> </pre> <br><p> , <em>'always print this'</em>   : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/cap $ pytest -q test_capsys.py::test_capsys_disabled</code> </pre> <br><p>    ,  <code>always print this</code>        ,        <code>capys.disabled()</code> .   print ‚Äî     print,  <code>normal print, usually captured</code> ( ,  ),    ,     <code>-s</code> ,     <code>--capture=no</code> ,   . </p><br><h2 id="ispolzovanie-monkeypatch">  monkeypatch </h2><br><p> "monkey patch" ‚Äî         .    "monkey patching" ‚Äî                ,      ,     .   <code>monkeypatch</code>       .    ,   ,    ,  ,    .    ,       .   API  ,  monkeypatch    . </p><br><p>  <code>monkeypatch</code>   : </p><br><ul><li> <code>setattr(target, name, value=&lt;notset&gt;, raising=True)</code> :  . </li><li> <code>delattr(target, name=&lt;notset&gt;, raising=True)</code> :  . </li><li> <code>setitem(dic, name, value)</code> :    . </li><li> <code>delitem(dic, name, raising=True)</code> :    . </li><li> <code>setenv(name, value, prepend=None)</code> :    . </li><li> <code>delenv(name, raising=True)</code> :   . </li><li> <code>syspath_prepend(path)</code> :    sys.,       Python. </li><li> <code>chdir(path)</code> :    . </li></ul><br><p>  <code>raising</code>  pytest,    ,     .  <code>prepend</code>  <code>setenv()</code>   .   ,        <code>+ prepend + &lt;old value&gt;</code> . </p><br><p>   monkeypatch  ,    ,   dot- .           ,   dot-    .    ,     cheese-  : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/monkey/cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> full_path = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">'~/.cheese.json'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(full_path, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: prefs = json.load(f) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prefs <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(prefs)</span></span></span><span class="hljs-function">:</span></span> full_path = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">'~/.cheese.json'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(full_path, <span class="hljs-string"><span class="hljs-string">'w'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(prefs, f, indent=<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_default_cheese_preferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> write_cheese_preferences(_default_prefs) _default_prefs = { <span class="hljs-string"><span class="hljs-string">'slicing'</span></span>: [<span class="hljs-string"><span class="hljs-string">'manchego'</span></span>, <span class="hljs-string"><span class="hljs-string">'sharp cheddar'</span></span>], <span class="hljs-string"><span class="hljs-string">'spreadable'</span></span>: [<span class="hljs-string"><span class="hljs-string">'Saint Andre'</span></span>, <span class="hljs-string"><span class="hljs-string">'camembert'</span></span>, <span class="hljs-string"><span class="hljs-string">'bucheron'</span></span>, <span class="hljs-string"><span class="hljs-string">'goat'</span></span>, <span class="hljs-string"><span class="hljs-string">'humbolt fog'</span></span>, <span class="hljs-string"><span class="hljs-string">'cambozola'</span></span>], <span class="hljs-string"><span class="hljs-string">'salads'</span></span>: [<span class="hljs-string"><span class="hljs-string">'crumbled feta'</span></span>] }</code> </pre> <br><p>  ,      <code>write_default_cheese_preferences()</code> .  ,         .    ,    .        . </p><br><p>      ,          . ,       <code>read_cheese_preferences()</code> ,    ,        <code>write_default_cheese_preferences()</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_full</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>        ,  ,     ,    cheese- .     . </p><br><p>     <code>HOME set</code> , <code>os.path.expanduser()</code>  <code>~</code> ,       <code>HOME</code> .       <code>HOME</code> ,       : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_home</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> monkeypatch.setenv(<span class="hljs-string"><span class="hljs-string">'HOME'</span></span>, tmpdir.mkdir(<span class="hljs-string"><span class="hljs-string">'home'</span></span>)) cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>    ,  <code>HOME</code>      .     -  <code>expanduser()</code> ,     ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´On Windows, HOME and USERPROFILE will be used if set, otherwise a combination of‚Ä¶.¬ª</a>  .  Ouah!      ,    Windows.  ,     . </p><br><p>  ,     <code>HOME</code> ,   <code>expanduser</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_expanduser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> fake_home_dir = tmpdir.mkdir(<span class="hljs-string"><span class="hljs-string">'home'</span></span>) monkeypatch.setattr(cheese.os.path, <span class="hljs-string"><span class="hljs-string">'expanduser'</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x.replace(<span class="hljs-string"><span class="hljs-string">'~'</span></span>, str(fake_home_dir)))) cheese.write_default_cheese_preferences() expected = cheese._default_prefs actual = cheese.read_cheese_preferences() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> expected == actual</code> </pre> <br><p>    ,    <em>cheese</em>  <code>os.path.expanduser()</code>     -.         <code>re.sub</code>   <code>~</code>    .    <code>setenv()</code>  <code>setattr()</code>      . , <code>setitem()</code> . </p><br><p> ,   ,  ,    .    ,      ,   <code>write_default_cheese_preferences()</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/monkey/test_cheese.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_def_prefs_change_defaults</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tmpdir, monkeypatch)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#      fake_home_dir = tmpdir.mkdir('home') monkeypatch.setattr(cheese.os.path, 'expanduser', (lambda x: x.replace('~', str(fake_home_dir)))) cheese.write_default_cheese_preferences() defaults_before = copy.deepcopy(cheese._default_prefs) #     monkeypatch.setitem(cheese._default_prefs, 'slicing', ['provolone']) monkeypatch.setitem(cheese._default_prefs, 'spreadable', ['brie']) monkeypatch.setitem(cheese._default_prefs, 'salads', ['pepper jack']) defaults_modified = cheese._default_prefs #       cheese.write_default_cheese_preferences() #    actual = cheese.read_cheese_preferences() assert defaults_modified == actual assert defaults_modified != defaults_before</span></span></code> </pre> <br><p>  <code>_default_prefs</code> - ,    <code>monkeypatch.setitem()</code> ,        . </p><br><p>   <code>setenv()</code> , <code>setattr()</code>  <code>setitem()</code> .  <code>del</code>  .     ,      ,  - .    <code>monkeypatch</code>   . </p><br><p> <code>syspath_prepend(path)</code>    <code>sys.path</code> ,    ,            .          stub-.      <code>monkeypatch.syspath_prepend()</code> ,     ,      stub-. </p><br><p> <code>chdir(path)</code>       .            ,      .        ,      ,    <code>monkeypatch.chdir(the_tmpdir)</code> . </p><br><p>       monkeypatch    <code>unittest.mock</code> ,      .      7 " pytest   "  . 125. </p><br><h2 id="ispolzovanie-doctest_namespace">  doctest_namespace </h2><br><p>  <em>doctest</em>     Python         <em>docstrings</em>   ,  ,   .    pytest      <em>doctest</em>   Python    <code>--doctest-modules</code> .    <code>doctest_namespace</code> ,      <em>autouse</em> ,       <em>pytest</em>     doctest .   docstrings    . </p><br><p> <code>doctest_namespace</code>         ,    Python       . , <code>numpy</code>    <code>import numpy as np</code> . </p><br><p>    . ,       <code>unnecessary_math.py</code>   <code>multiply()</code>  <code>divide()</code> ,    .  ,        docstring ,    docstrings : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/dt/1/unnecessary_math.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" This module defines multiply(a, b) and divide(a, b). &gt;&gt;&gt; import unnecessary_math as um Here's how you use multiply: &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' Here's how you use divide: &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a multiplied by b. &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a * b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a divided by b. &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a / b</code> </pre><br><p>   <code>unnecessary_math</code> ,    <code>um</code>  ,  <code>import noecessary_math as um</code>   -.   docstrings     <code>import</code> ,     <code>um</code> .   ,  pytest   docstring    .    docstring    ,    docstrings    : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/dt/1 $ pytest -v --doctest-modules --tb=short unnecessary_math.py ============================= test session starts ============================= collected 3 items unnecessary_math.py::unnecessary_math PASSED unnecessary_math.py::unnecessary_math.divide FAILED unnecessary_math.py::unnecessary_math.multiply FAILED ================================== FAILURES =================================== ______________________ [doctest] unnecessary_math.divide ______________________ 034 035 Returns a divided by b. 036 037 &gt;&gt;&gt; um.divide(10, 5) UNEXPECTED EXCEPTION: NameError("name 'um' is not defined",) Traceback (most recent call last): ... File "&lt;doctest unnecessary_math.divide[0]&gt;", line 1, in &lt;module&gt; NameError: name 'um' is not defined ... _____________________ [doctest] unnecessary_math.multiply _____________________ 022 023 Returns a multiplied by b. 024 025 &gt;&gt;&gt; um.multiply(4, 3) UNEXPECTED EXCEPTION: NameError("name 'um' is not defined",) Traceback (most recent call last): ... File "&lt;doctest unnecessary_math.multiply[0]&gt;", line 1, in &lt;module&gt; NameError: name 'um' is not defined /path/to/code/ch4/dt/1/unnecessary_math.py:23: UnexpectedException ================ 2 failed, 1 passed in 0.03 seconds =================</code> </pre><br><p>     -  <code>import</code>   docstring: </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/dt/2/unnecessary_math.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-string"><span class="hljs-string">""" This module defines multiply(a, b) and divide(a, b). &gt;&gt;&gt; import unnecessary_math as um Here's how you use multiply: &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' Here's how you use divide: &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">multiply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a multiplied by b. &gt;&gt;&gt; import unnecessary_math as um &gt;&gt;&gt; um.multiply(4, 3) 12 &gt;&gt;&gt; um.multiply('a', 3) 'aaa' """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a * b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Returns a divided by b. &gt;&gt;&gt; import unnecessary_math as um &gt;&gt;&gt; um.divide(10, 5) 2.0 """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a / b</code> </pre> <br><p>    : </p><br><pre> <code class="plaintext hljs">$ cd /path/to/code/ch4/dt/2 $ pytest -v --doctest-modules --tb=short unnecessary_math.py ============================= test session starts ============================= collected 3 items unnecessary_math.py::unnecessary_math PASSED [ 33%] unnecessary_math.py::unnecessary_math.divide PASSED [ 66%] unnecessary_math.py::unnecessary_math.multiply PASSED [100%] ===================== 3 passed in 0.03 seconds ======================</code> </pre> <br><p>     docstrings        . </p><br><p>   <code>doctest_namespace</code> ,   <code>autouse</code>   <code>conftest.py</code>  ,      : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/dt/3/conftest.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unnecessary_math @pytest.fixture(autouse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add_um</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(doctest_namespace)</span></span></span><span class="hljs-function">:</span></span> doctest_namespace[<span class="hljs-string"><span class="hljs-string">'um'</span></span>] = unnecessary_math</code> </pre> <br><p>   pytest   <code>um</code>  <code>doctest_namespace</code> ,     <code>unnecessary_math</code> .     conftest.py,  doctests,     conftest.py    <code>um</code> . </p><br><p>     doctest  pytest   7 " pytest   "  . 125. </p><br><h2 id="ispolzovanie-recwarn">  recwarn </h2><br><p>   <code>recwarn</code>    ,   .  Python    ,     ,    ,      . , ,      ,         ,      .             : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> warnings <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lame_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> warnings.warn(<span class="hljs-string"><span class="hljs-string">"Please stop using this"</span></span>, DeprecationWarning) <span class="hljs-comment"><span class="hljs-comment"># rest of function</span></span></code> </pre> <br><p>   ,      : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_lame_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(recwarn)</span></span></span><span class="hljs-function">:</span></span> lame_function() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(recwarn) == <span class="hljs-number"><span class="hljs-number">1</span></span> w = recwarn.pop() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> w.category == DeprecationWarning <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> str(w.message) == <span class="hljs-string"><span class="hljs-string">'Please stop using this'</span></span></code> </pre> <br><p>  recwarn    ,        <code>category</code> (), <code>message</code> (), <code>filename</code> ( )  <code>lineno</code> ( ),    . </p><br><p>      .   ,     ,      ,     .      <code>recwarn.clear()</code> ,     ,      . </p><br><p>    <code>recwarn</code> , pytest      <code>pytest.warns()</code> : </p><br><blockquote> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ch4/test_warnings.py</a> </blockquote><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_lame_function_2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> pytest.warns(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> warning_list: lame_function() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> len(warning_list) == <span class="hljs-number"><span class="hljs-number">1</span></span> w = warning_list.pop() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> w.category == DeprecationWarning <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> str(w.message) == <span class="hljs-string"><span class="hljs-string">'Please stop using this'</span></span></code> </pre> <br><p>   <code>pytest.warns()</code>         .  <code>recwarn</code>    <code>pytest.warns()</code>   ,    ,  ,    . </p><br><h2 id="uprazhneniya">  Exercices </h2><br><ol><li>  <code>ch4/cache/test_slower.py</code>   <code>autouse</code> ,  <code>check_duration()</code> .    <code>ch3/tasks_proj/tests/conftest.py</code> . </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Effectuez les tests du chapitre 3. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour les tests vraiment tr√®s rapides, 2x vraiment rapide est toujours tr√®s rapide. </font><font style="vertical-align: inherit;">Au lieu de 2x, changez le luminaire pour v√©rifier 0,1 seconde plus 2x pour la derni√®re dur√©e.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ex√©cutez pytest avec le luminaire modifi√©. </font><font style="vertical-align: inherit;">Les r√©sultats semblent-ils raisonnables?</font></font></li></ol><br><h2 id="chto-dalshe">  Et ensuite </h2><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans ce chapitre, vous avez examin√© certains des appareils Pytest int√©gr√©s. </font><font style="vertical-align: inherit;">Ensuite, vous consid√©rerez les plugins plus en d√©tail. </font><font style="vertical-align: inherit;">Les nuances de l'√©criture de gros plugins peuvent devenir un livre en soi; </font><font style="vertical-align: inherit;">cependant, les petits plugins personnalis√©s font r√©guli√®rement partie de l'√©cosyst√®me pytest.</font></font></p><br><p><img src="https://habrastorage.org/webt/jl/jn/bb/jljnbbjr-ejh473xy_eccsmknpk.png">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Retour</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Suivant</a> <img src="https://habrastorage.org/webt/rw/dy/-g/rwdy-grsvbpcetjttrmecdkxtlk.png"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr448792/">https://habr.com/ru/post/fr448792/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr448780/index.html">Ce qui donne des logiciels pour recruter en argent</a></li>
<li><a href="../fr448782/index.html">Test Python avec pytest. Premiers pas avec pytest, Chapitre 1</a></li>
<li><a href="../fr448784/index.html">Nouvelles fonctionnalit√©s pour les auteurs d'extensions dans Visual Studio 2019 version 16.1</a></li>
<li><a href="../fr448786/index.html">Test Python avec pytest. CHAPITRE 3 Appareils pytest</a></li>
<li><a href="../fr448790/index.html">SpaceVIL - Framework GUI multiplateforme pour le d√©veloppement sur .Net Core, .Net Standard et JVM</a></li>
<li><a href="../fr448794/index.html">Test Python avec pytest. Plugins CHAPITRE 5</a></li>
<li><a href="../fr448796/index.html">Test Python avec pytest. Configuration, CHAPITRE 6</a></li>
<li><a href="../fr448798/index.html">Test Python avec pytest. Utilisation de pytest avec d'autres outils, CHAPITRE 7</a></li>
<li><a href="../fr448800/index.html">Configurer Visual Studio dans votre organisation avec .vsconfig</a></li>
<li><a href="../fr448802/index.html">Penser avec des portails: cr√©er des portails dans Unreal Engine 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>