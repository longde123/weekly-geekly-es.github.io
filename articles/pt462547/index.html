<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêû ü§í üë©‚Äçüë¶‚Äçüë¶ SGX Malvar: como os vil√µes exploram a nova tecnologia da Intel para prop√≥sitos errados üî† ‚ûø üòå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como voc√™ sabe, o c√≥digo executado no enclave √© seriamente limitado em sua funcionalidade. Ele n√£o pode fazer chamadas do sistema. N√£o pode executar o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SGX Malvar: como os vil√µes exploram a nova tecnologia da Intel para prop√≥sitos errados</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462547/"><p> Como voc√™ sabe, o c√≥digo executado no enclave √© seriamente limitado em sua funcionalidade.  Ele n√£o pode fazer chamadas do sistema.  N√£o pode executar opera√ß√µes de E / S.  Ele n√£o sabe o endere√ßo base do segmento de c√≥digo do host.  Ele n√£o pode jmp e chamar o c√≥digo do host.  Ele n√£o tem id√©ia da estrutura do espa√ßo de endere√ßo que guia o aplicativo host (por exemplo, quais p√°ginas s√£o promovidas ou que tipo de dados s√£o colocados nessas p√°ginas).  Ele n√£o pode pedir ao sistema operacional para anexar um peda√ßo de mem√≥ria ao aplicativo host (por exemplo, via / proc / pid / maps).  Tentativas ing√™nuas de ler uma √°rea de mem√≥ria arbitr√°ria cega do aplicativo host - para n√£o mencionar tentativas de grava√ß√£o - mais cedo ou mais tarde (antes a primeira) levar√£o √† conclus√£o for√ßada do programa de enclave.  Isso acontece sempre que a √°rea do espa√ßo de endere√ßo virtual solicitada pelo enclave estiver inacess√≠vel ao aplicativo host. </p><br><p>  Com realidades t√£o duras, o criador de v√≠rus poder√° usar os enclaves da SGX para realizar seus objetivos maliciosos? </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">- Hackear endere√ßos de sondagem para a possibilidade de l√™-los</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">- Hackear endere√ßos de sondagem para gravabilidade</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">- Corte para redirecionar o fluxo de controle</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">- O que d√° ao vil√£o os tr√™s hacks listados acima</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">- Como o vil√£o usa esses hacks para criar ranzomvari</a> </p><br><p><img src="https://habrastorage.org/webt/jw/ak/c1/jwakc1r2ic_hbeu3zaklnkev6po.jpeg"></p><a name="habracut"></a><br><p>  Com base no que foi dito acima, √© geralmente aceito que o enclave √© capaz apenas de atender ao aplicativo host e que o enclave n√£o pode tomar sua pr√≥pria iniciativa, inclusive maliciosa.  Isso significa que os enclaves n√£o representam um valor pr√°tico para os criadores de v√≠rus.  Essa suposi√ß√£o precipitada √© uma das raz√µes pelas quais a prote√ß√£o SGX √© assim√©trica: o c√≥digo do aplicativo host n√£o pode acessar a mem√≥ria do enclave, enquanto o c√≥digo do enclave pode ler e gravar em qualquer endere√ßo de mem√≥ria do aplicativo host. </p><br><p>  Portanto, se o c√≥digo malicioso do enclave conseguir fazer chamadas arbitr√°rias do sistema em nome do aplicativo host, executar c√≥digo arbitr√°rio em seu nome, varrer a mem√≥ria do aplicativo host e encontrar as cadeias de ROP adequadas para abuso, ele poder√° assumir o controle completo sobre aplicativo host no modo furtivo.  Ele pode n√£o apenas roubar e criptografar arquivos do usu√°rio, mas tamb√©m agir em nome do usu√°rio.  Por exemplo, envie e-mails de phishing em seu nome ou realize ataques de nega√ß√£o de servi√ßo.  Ao mesmo tempo, voc√™ n√£o tem medo nem dos mecanismos de prote√ß√£o mais modernos, como can√°rios de pilha e higieniza√ß√£o de endere√ßos. </p><br><p>  Mostraremos alguns hacks pelos quais os vil√µes superam as limita√ß√µes descritas acima, na tentativa de tirar proveito dos benef√≠cios do SGX para seus prop√≥sitos maliciosos: conduzir ataques ROP.  Executar c√≥digo arbitr√°rio disfar√ßado de processo de serragem de host (semelhante ao processo oco, que √© freq√ºentemente usado por malware) ou mascarar um malware j√° preparado (para salv√°-lo da persegui√ß√£o por antiv√≠rus e outros mecanismos de prote√ß√£o). </p><br><a name="a1"></a><br><h1 id="hak-dlya-zondirovaniya-adresov-na-predmet-vozmozhnosti-ih-schityvaniya">  Hackear endere√ßos de sondagem para a possibilidade de l√™-los </h1><br><p>  Como o enclave n√£o sabe quais intervalos do espa√ßo de endere√ßo virtual est√£o dispon√≠veis para o aplicativo host, e porque quando voc√™ tenta ler um endere√ßo inacess√≠vel, o enclave √© encerrado √† for√ßa, o vil√£o √© confrontado com a tarefa de encontrar uma maneira de verificar o espa√ßo de endere√ßo com seguran√ßa.  Encontre uma maneira de mapear os endere√ßos virtuais dispon√≠veis.  O vil√£o resolve esse problema usando mal a tecnologia TSX da Intel.  Ele usa um dos efeitos colaterais do TSX: se a fun√ß√£o de acesso √† mem√≥ria for colocada em uma transa√ß√£o TSX, as exce√ß√µes decorrentes do acesso a endere√ßos inv√°lidos ser√£o suprimidas pelo TSX antes de chegar ao sistema operacional.  Quando voc√™ tenta acessar um endere√ßo de mem√≥ria inv√°lido, apenas a transa√ß√£o atual √© interrompida, e n√£o o programa inteiro do enclave.  T.O.  O TSX permite que o enclave acesse com seguran√ßa qualquer endere√ßo da transa√ß√£o - sem o risco de colapso. </p><br><p>  Se o <em>endere√ßo especificado estiver dispon√≠vel para o</em> aplicativo host, a transa√ß√£o TSX geralmente ser√° bem-sucedida.  Em casos raros, pode falhar devido a influ√™ncias externas, como interrup√ß√µes (por exemplo, interrup√ß√µes do planejador), exclus√£o do cache ou altera√ß√µes simult√¢neas das c√©lulas da mem√≥ria por v√°rios processos.  Nesses casos raros, o TSX retorna um c√≥digo de erro indicando que a falha ocorreu √© tempor√°ria.  Nesses casos, voc√™ s√≥ precisa reiniciar a transa√ß√£o. </p><br><p>  Se o <em>endere√ßo especificado n√£o estiver dispon√≠vel para o</em> aplicativo host, o TSX suprime a exce√ß√£o (o sistema operacional n√£o √© notificado) e cancela a transa√ß√£o.  Um c√≥digo de erro √© retornado ao c√≥digo do enclave para que ele possa responder ao fato de que a transa√ß√£o foi cancelada.  Esses c√≥digos de erro indicam que o endere√ßo em quest√£o n√£o est√° dispon√≠vel para o aplicativo host. </p><br><p><img src="https://habrastorage.org/webt/ws/56/5m/ws565mbicysq6wpxoadwankb-6a.png"></p><br><p><img src="https://habrastorage.org/webt/uv/mw/jg/uvmwjgnn9ygxbaaof_cq0v0jdau.png"></p><br><p>  Essa manipula√ß√£o do TSX a partir do interior do enclave tem um bom recurso para o vil√£o: como no momento da execu√ß√£o do c√≥digo do enclave, a maioria dos contadores de desempenho de hardware n√£o √© atualizada, √© imposs√≠vel rastrear as transa√ß√µes TSX realizadas dentro do enclave usando-os.  Assim, as fraudes maliciosas com o TSX'om permanecem completamente invis√≠veis para o sistema operacional. </p><br><p>  Al√©m disso, como o hack descrito acima n√£o depende de nenhuma chamada do sistema, n√£o pode ser detectado ou impedido simplesmente bloqueando as chamadas do sistema;  o que geralmente d√° um resultado positivo na luta contra a "ca√ßa aos ovos". </p><br><p>  O vil√£o usa o hack descrito acima para procurar por gadgets no c√≥digo do aplicativo host que s√£o adequados para formar uma cadeia ROP.  No entanto, ele n√£o precisa investigar cada endere√ßo.  Basta examinar um endere√ßo de cada p√°gina do espa√ßo de endere√ßo virtual.  A detec√ß√£o de todos os 16 gigabytes de mem√≥ria leva cerca de 45 minutos (no Intel i7-6700K).  Como resultado, o vil√£o obt√©m uma lista de p√°ginas execut√°veis ‚Äã‚Äãadequadas para a constru√ß√£o de uma cadeia ROP. </p><br><a name="a2"></a><br><h1 id="hak-dlya-zondirovaniya-adresov-na-predmet-vozmozhnosti-zapisi">  Hackear endere√ßos de sondagem para gravabilidade </h1><br><p>  Para implementar uma vers√£o em enclave de um ataque ROP, o vil√£o precisa da capacidade de procurar por partes n√£o utilizadas grav√°veis ‚Äã‚Äãda mem√≥ria do aplicativo host.  O vil√£o usa essas se√ß√µes da mem√≥ria para injetar um quadro de pilha falso e injetar uma carga √∫til (c√≥digo de shell).  A conclus√£o √© que um enclave mal-intencionado n√£o pode exigir que o aplicativo host aloque mem√≥ria para si mesmo, mas pode usar para outros fins a mem√≥ria alocada pelo aplicativo host.  A menos, √© claro, que ele consiga encontrar esses sites sem desmoronar o enclave. </p><br><p>  O vil√£o realiza essa busca explorando outro efeito colateral do TSX.  Primeiro, ele, como no caso anterior, investiga o endere√ßo quanto √† sua exist√™ncia e depois verifica se a p√°gina correspondente a esse endere√ßo est√° acess√≠vel para grava√ß√£o.  Para fazer isso, o vil√£o usa o seguinte hack: coloca a fun√ß√£o de grava√ß√£o na transa√ß√£o TSX e, ap√≥s ser conclu√≠da, mas antes de ser conclu√≠da, interrompe for√ßosamente a transa√ß√£o (abortamento expl√≠cito). </p><br><p>  Olhando para o c√≥digo de retorno de uma transa√ß√£o TSX, o vil√£o percebe se √© grav√°vel.  Se for "abortamento expl√≠cito", o vil√£o percebe que a grava√ß√£o seria bem-sucedida se a trouxesse ao fim.  Se a p√°gina for somente leitura, a transa√ß√£o falhar√° com um erro diferente de "abortamento expl√≠cito". </p><br><p><img src="https://habrastorage.org/webt/yo/pg/iy/yopgiyrkws5wdk-nin_q2e3wpvy.png"></p><br><p>  Essa manipula√ß√£o do TSX tem outro recurso agrad√°vel para o vil√£o (al√©m da incapacidade de rastrear os contadores de desempenho de hardware): como todos os comandos de grava√ß√£o na mem√≥ria s√£o gravados apenas se a transa√ß√£o for bem-sucedida, for√ßar a conclus√£o da transa√ß√£o garante que a c√©lula de mem√≥ria sondada permane√ßa inalterada. </p><br><a name="a3"></a><br><h1 id="hak-dlya-perenapravleniya-potoka-upravleniya">  Corte de redirecionamento de fluxo de controle </h1><br><p>  Ao realizar um ataque ROP de um enclave - diferentemente dos ataques ROP tradicionais - o vil√£o pode obter o controle do registro RIP sem explorar nenhum bug no programa atacado (excesso de buffer ou algo parecido).  O vil√£o pode substituir diretamente o valor do registro RIP armazenado na pilha.  Em particular, ele pode substituir o valor desse registro por sua cadeia ROP. </p><br><p>  No entanto, se a cadeia ROP for longa, a reescrita de uma grande parte da pilha de aplicativos host pode causar corrup√ß√£o de dados e comportamento inesperado do programa.  Um vil√£o que procura conduzir seu ataque furtivamente, esse estado de coisas n√£o se adequa.  Portanto, ele cria um quadro de pilha tempor√°rio falso para si e armazena sua cadeia ROP nele.  Um quadro de pilha falso √© colocado em um local arbitr√°rio na mem√≥ria grav√°vel, para que a pilha verdadeira permane√ßa intocada. </p><br><p><img src="https://habrastorage.org/webt/w_/s-/qn/w_s-qnrj9fscjgiiz1q_xu6tz6m.png"></p><br><a name="a4"></a><br><h1 id="chto-dayut-zlodeyu-tri-perechislennye-vyshe-haka">  O que d√° ao vil√£o os tr√™s hacks listados acima </h1><br><p>  (1) Primeiro, um enclave malicioso, atrav√©s de um <em>hack para investigar endere√ßos quanto √† possibilidade de l√™-los</em> , pesquisa no aplicativo host por gadgets ROP que podem ser abusados. </p><br><p><img src="https://habrastorage.org/webt/9a/2z/p9/9a2zp9bhjuor86g3njvlsxetwcg.png"></p><br><p>  (2) Em seguida, usando um <em>hack para investigar os endere√ßos quanto √† capacidade de grava√ß√£o</em> , o enclave malicioso identifica nas √°reas de mem√≥ria do aplicativo host adequadas para injetar a carga √∫til. </p><br><p><img src="https://habrastorage.org/webt/es/t5/-2/est5-2k5ycrnhrgw_ma_2tkf6wi.png"></p><br><p>  (3) Em seguida, o enclave cria uma cadeia ROP a partir dos dispositivos encontrados na etapa (1) e injeta essa cadeia na pilha de aplicativos host. </p><br><p><img src="https://habrastorage.org/webt/do/54/bz/do54bzlimfouln6hun33s6k1aqg.png"></p><br><p>  (4) Finalmente, quando o aplicativo host encontra a cadeia ROP criada na etapa anterior, a carga maliciosa come√ßa a ser executada, com os privil√©gios do aplicativo host e a capacidade de fazer chamadas do sistema. </p><br><a name="a5"></a><br><h1 id="kak-zlodey-zadeystvuet-eti-haki-dlya-sozdaniya-ranzomvari">  Como o vil√£o usa esses hacks para criar ranzomvari </h1><br><p>  Depois que o aplicativo host transfere o controle para o enclave atrav√©s de qualquer um dos ECALLs (sem suspeitar que esse enclave seja malicioso), o enclave mal-intencionado procura espa√ßo livre na mem√≥ria do aplicativo host para inje√ß√£o de c√≥digo (nesses locais, s√£o necess√°rias as seq√º√™ncias de c√©lulas que preenchido com zeros).  Em seguida, usando um <em>hack para verificar a legibilidade dos endere√ßos</em> , o enclave pesquisa as p√°ginas execut√°veis ‚Äã‚Äãno aplicativo host e gera uma cadeia ROP que cria um novo arquivo chamado "RANSOM" no diret√≥rio atual (em um ataque real, o enclave criptografa os arquivos de usu√°rio existentes) e exibe uma mensagem de solicita√ß√£o de resgate.  Ao mesmo tempo, o aplicativo host acredita ingenuamente que o enclave simplesmente adiciona dois n√∫meros.  Como ele aparece no c√≥digo? </p><br><p>  Para facilitar a percep√ß√£o, apresentamos alguns mnem√¥nicos atrav√©s de define: </p><br><p><img src="https://habrastorage.org/webt/uu/fo/v_/uufov_dqhtly23sabyj6a4k8jik.png"></p><br><p>  Preservamos os valores iniciais dos registros RSP e RBP para restaurar a opera√ß√£o normal do aplicativo host ap√≥s executar a carga √∫til: </p><br><p><img src="https://habrastorage.org/webt/h1/nx/1x/h1nx1xpue_tb2tew4z0-kytjgr4.png"></p><br><p>  Estamos procurando por um quadro de pilha adequado (consulte o c√≥digo na se√ß√£o "hack para redirecionar o fluxo de controle"). </p><br><p>  Encontre gadgets ROP adequados: </p><br><p><img src="https://habrastorage.org/webt/r0/we/cf/r0wecfpdydx94xqv5zkkwmbgt4q.png"></p><br><p>  Encontre um local para injetar a carga √∫til: </p><br><p><img src="https://habrastorage.org/webt/0e/zk/7y/0ezk7yfmzak5oobrhqivpzd3jbe.png"></p><br><p>  Construindo uma cadeia ROP: </p><br><p><img src="https://habrastorage.org/webt/jh/2-/k9/jh2-k9yyt_2rts1oexzaore2qoc.png"></p><br><p>  √â assim que a tecnologia SGX da Intel, projetada para suportar programas maliciosos, √© explorada por vil√µes para atingir objetivos opostos. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt462547/">https://habr.com/ru/post/pt462547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt462537/index.html">Migra√ß√£o na nuvem</a></li>
<li><a href="../pt462539/index.html">Evite trigonometria</a></li>
<li><a href="../pt462541/index.html">Usando Condicional no Spring</a></li>
<li><a href="../pt462543/index.html">Meetup sobre Java em Raiffeisenbank</a></li>
<li><a href="../pt462545/index.html">Bloqueio de telegrama, sub-rede Hetzner / 16, experi√™ncia com ILV</a></li>
<li><a href="../pt462549/index.html">Blockchain de quorum: integra√ß√£o ao c√≥digo Java</a></li>
<li><a href="../pt462551/index.html">Perguntas populares do desenvolvedor sobre testes</a></li>
<li><a href="../pt462553/index.html">Um pouco sobre simples. Projeto de teste. Parte 1</a></li>
<li><a href="../pt462555/index.html">Discuss√£o: e se trabalhar sem cookies - informamos quais s√£o as alternativas</a></li>
<li><a href="../pt462563/index.html">Webinar "Como sobreviver √† conformidade?" A melhor abordagem para atender aos requisitos regulat√≥rios ‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>