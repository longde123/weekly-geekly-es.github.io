<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👃🏽 🤳 🛌🏼 Petites expériences multitâches dans un microcontrôleur 🗳️ 👷 👨🏼‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans l'une des notes précédentes, l'auteur a tenté de faire valoir que lors de la programmation du microcontrôleur, un simple changement de tâche sera...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Petites expériences multitâches dans un microcontrôleur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461121/"><p>  Dans l'une des notes précédentes, l'auteur a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tenté de faire</a> valoir que lors de la programmation du microcontrôleur, un simple changement de tâche sera utile dans les situations où l'utilisation du système d'exploitation en temps réel est trop importante et la boucle complète pour toutes les actions requises est trop petite ( Il a dit, tout comme le comte de La Fer).  Plus précisément, pas trop peu, mais trop confus. </p><br><p>  Dans une note ultérieure, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">il était prévu de</a> rationaliser l'accès aux ressources partagées par plusieurs tâches en utilisant des files d'attente basées sur des tampons en anneau (FIFO) et une tâche distincte spécialement affectée à cela.  Ayant dispersé pour différentes tâches ces actions qui ne sont pas liées les unes aux autres, nous sommes en droit d'attendre un code plus visible.  Et si en même temps nous obtenons une certaine commodité et simplicité, alors pourquoi ne pas l'essayer? </p><br><p>  De toute évidence, le microcontrôleur n'est pas conçu pour résoudre une tâche imaginable de l'utilisateur.  Alors, peut-être, un tel sélecteur de tâches s'avérera tout à fait suffisant dans de nombreuses situations.  En bref, une petite expérience ne risque pas de faire mal.  Par conséquent, afin de ne pas être infondé, votre humble serviteur a décidé d'écrire quelque chose et de tester ses gribouillis. </p><a name="habracut"></a><br><p>  Dans les microcontrôleurs, je dois dire que l'exigence de considérer le temps comme quelque chose d'important et de dur est plus courante que dans les ordinateurs à usage général.  Aller au-delà du cadre dans le premier cas équivaut à une inopérabilité, et dans le second cas, cela ne conduit qu'à une augmentation du temps d'attente, ce qui est tout à fait acceptable si les nerfs sont en ordre.  Il existe même deux termes «temps réel doux» et «temps réel dur». </p><br><p>  Permettez-moi de vous rappeler que nous parlions de contrôleurs avec le noyau Cortex-M3,4,7.  Aujourd'hui, c'est une famille très commune.  Dans les exemples ci-dessous, nous avons utilisé le microcontrôleur STM32F303, qui fait partie de la carte STM32F3DISCOVERY. </p><br><p>  Le commutateur est un fichier assembleur unique. <br>  L'assembleur n'a pas peur de l'auteur, mais au contraire inspire l'espoir que la vitesse maximale sera atteinte. </p><br><p>  Initialement, la logique la plus simple de l'opération de commutation était prévue, qui est présentée dans la figure 1 pour huit tâches. </p><br><p><img src="https://habrastorage.org/webt/ul/ot/pm/ulotpmeuad4zcxqcgroa_t92al0.jpeg"></p><br><p>  Dans ce schéma, les tâches prennent leur partie du temps une par une et ne peuvent donner que le reste de leur tick et, si nécessaire, sauter quelques-unes de leurs ticks.  Cette logique s'est avérée bonne, car la taille quantique peut être réduite.  Et c'est précisément ce qui est nécessaire pour ne pas soulever d'urgence une tâche pour laquelle une interruption vient de se produire, mais aussi pour augmenter puis diminuer sa priorité.  Le paquet qui vient d'être reçu attendra tranquillement 200-300 microsecondes jusqu'à ce que sa tâche reçoive son tick.  Et si nous avons un Cortex-M7 fonctionnant à une fréquence de 216 MHz, alors 20 microsecondes pour un tick sont tout à fait raisonnables, car il faudra moins d'une demi-microseconde pour basculer.  Et toute tâche de l'exemple ci-dessus ne sera jamais en retard de plus de 140 microsecondes. </p><br><p>  Cependant, avec une augmentation du nombre de tâches, même avec une taille extrêmement petite du quantum temporel, le retard dans le début de l'activité de la tâche requise peut cesser d'être agréable.  Sur cette base, et en tenant également compte du fait que seule une petite partie des tâches nécessite vraiment du temps réel dur, il a été décidé de modifier légèrement la logique du commutateur.  Il est illustré à la figure 2. </p><br><p><img src="https://habrastorage.org/webt/iq/gs/qi/iqgsqiqf4zigukr5vvrfi2sbgki.jpeg"></p><br><p>  Maintenant, nous sélectionnons seulement une partie des tâches qui reçoivent un quantum entier, et sélectionnons seulement un tick pour le reste, dans lequel elles se relaient dans le jeu.  Dans ce cas, le sous-programme d'initialisation reçoit un paramètre d'entrée, à savoir le numéro de position, à partir duquel toutes les tâches seront affectées en droits et partageront un tick.  Dans le même temps, l'ancien schéma restait disponible, pour cela il suffit de mettre la valeur du paramètre à zéro ou le nombre total de tâches.  Les coûts de commutation ont augmenté de quelques instructions d'assembleur. </p><br><p>  Deux schémas similaires sont utilisés pour permettre l'accès aux ressources partagées.  Le premier, mentionné dans une note précédente, utilise plusieurs FIFO (ou tampons circulaires selon le nombre de producteurs de messages) et une tâche de correspondance distincte.  Il est conçu pour communiquer avec le monde extérieur et ne nécessite pas d'attentes de tâches qui génèrent des messages.  Il suffit de s'assurer que les files d'attente ne sont pas bondées. </p><br><p>  Le deuxième schéma utilise également une tâche distincte pour autoriser l'accès, mais introduit des attentes car il gère la ressource interne dans les deux sens.  Ces actions ne peuvent pas être liées au temps.  La figure 3 montre les composants du deuxième circuit. </p><br><p><img src="https://habrastorage.org/webt/-m/fb/4r/-mfb4rum70winng8agin4yqbf3e.jpeg"></p><br><p>  Les principaux éléments sont un tampon de requêtes, en fonction du nombre de tâches souhaitées, et un indicateur d'accès.  Le fonctionnement de cette conception est assez simple.  La tâche de gauche envoie une demande d'accès à un endroit spécialement alloué pour elle (par exemple, la tâche 2 écrit 1 dans la demande 2).  Tâche - le répartiteur sélectionne qui autoriser et écrit le numéro de la tâche sélectionnée dans l'indicateur de résolution.  La tâche qui a reçu l'autorisation effectue ses actions et écrit le signe de fin d'accès à la demande, la valeur 0xFF.  Le planificateur, voyant que la demande est effacée, réinitialise l'indicateur d'autorisation, réinitialise la demande précédente et réinitialise la demande d'une autre tâche. </p><br><p>  Deux projets de test sous IAR et une description de la carte STM32F3DISCOVERY utilisée peuvent être consultés <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Dans le premier projet, l'ATS303 a simplement vérifié ses performances et l'a débogué.  Toutes les LED installées sur cette carte sont utiles.  Personne n'a été blessé. </p><br><p>  Le deuxième projet de BTS303 a testé les deux options d'allocation des ressources mentionnées.  Dans ce document, les tâches 1 et 2 génèrent des messages de test reçus par l'opérateur.  Pour communiquer avec l'opérateur, j'ai dû ajouter un foulard avec un port COM TTL, comme indiqué sur la photo ci-dessous. </p><br><p><img src="https://habrastorage.org/webt/za/hh/_c/zahh_cdcuabvgg-o92ukph_feji.jpeg"></p><br><p>  L'opérateur utilise un émulateur de terminal.  Je pense que le lecteur excusera l'auteur pour la couleur du tube doux.  Cela ressemble à ceci. </p><br><p><img src="https://habrastorage.org/webt/1r/wa/aj/1rwaajjm2zx_ue2tglhquc7suw4.jpeg"></p><br><p>  Pour démarrer le fonctionnement de l'ensemble du système, avant de résoudre les interruptions, des étapes préliminaires sont nécessaires dans le corps de la tâche zéro principale (), qui sont présentées ci-dessous. </p><br><pre><code class="plaintext hljs">void main_start_task_switcher(U8 border); U8 task_run_and_return_task_number((U32)t1_task); U8 task_run_and_return_task_number((U32)t2_task); U8 task_run_and_return_task_number((U32)t3_human_link); U8 task_run_and_return_task_number((U32)t4_human_answer); U8 task_run_and_return_task_number((U32)task_5); U8 task_run_and_return_task_number((U32)task_6); U8 task_run_and_return_task_number((U32)task_7);</code> </pre> <br><p>  Dans ces lignes, le commutateur démarre d'abord, puis, à son tour, les sept tâches restantes. </p><br><p>  Voici l'ensemble minimal d'appels requis pour le travail. </p><br><pre> <code class="plaintext hljs"> void task_wake_up_action(U8 taskNumber);</code> </pre> <br><p>  Cet appel est utilisé dans une interruption à partir d'un minuteur matériel utilisateur.  Les défis des tâches elles-mêmes parlent d'eux-mêmes. </p><br><pre> <code class="plaintext hljs"> void release_me_and_set_sleep_steps(U32 ticks); U8 get_my_number(void);</code> </pre><br><p>  Toutes ces fonctions se trouvent dans le fichier de commutateur d'assembleur.  Il existe plusieurs autres fonctions utiles pour les tests, mais non obligatoires. </p><br><p>  Dans le projet BTS303, la tâche 3 reçoit les commandes de l'opérateur de l'extérieur et lui envoie les réponses provenant de la tâche 4. La tâche 4 reçoit les commandes de l'opérateur de la tâche 3 et les exécute avec les réponses possibles.  La tâche 3 reçoit également des messages des tâches 1 et 2 et les envoie via UART à l'émulateur de terminal (par exemple, mastic). </p><br><p>  La tâche 0 (principale) effectue un travail auxiliaire, par exemple, vérifie le nombre de mots non affectés dans la zone empilée de chaque tâche.  Ces informations peuvent être demandées par l'opérateur et se faire une idée de l'utilisation de la pile.  Initialement, pour chaque tâche, une zone de pile de 512 octets (128 mots) est allouée et il est nécessaire de surveiller (au moins au stade du débogage) que ces zones ne se rapprochent pas du débordement. </p><br><p>  Les tâches 5 et 6 effectuent des calculs sur une variable à virgule flottante commune.  Pour ce faire, ils en demandent l'accès à la tâche 7. </p><br><p>  Il existe une autre fonctionnalité supplémentaire qui peut être vue dans les projets de test.  Il est conçu pour que vous puissiez réveiller la tâche non pas après l'expiration du nombre de ticks, mais après une durée spécifiée, et cela ressemble à ceci. </p><br><pre> <code class="plaintext hljs"> void wake_me_up_after_milliSeconds(U32 timeMS);</code> </pre> <br><p>  Pour sa mise en œuvre, un minuteur matériel supplémentaire est également requis, qui est également implémenté dans les cas de test. </p><br><p>  Comme vous pouvez le voir, la liste de tous les appels nécessaires tient sur une seule page. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461121/">https://habr.com/ru/post/fr461121/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461099/index.html">Jeu AirAttack! - notre première expérience de développement VR</a></li>
<li><a href="../fr461101/index.html">Android Jetpack Composer la première impression</a></li>
<li><a href="../fr461105/index.html">5 plugins webpack utiles</a></li>
<li><a href="../fr461107/index.html">Dosimètre pour Seryozha. Partie II Tubes du centenaire vs atome pacifique</a></li>
<li><a href="../fr461113/index.html">Cinq ans d'utilisation de C ++ pour des projets de microcontrôleurs en production</a></li>
<li><a href="../fr461125/index.html">La tâche de création de codes numériques séquentiels pour la numérotation des messages dans le code source dans Visual Studio (ex. C #)</a></li>
<li><a href="../fr461127/index.html">Analyse des performances des machines virtuelles dans VMware vSphere. Partie 3: Stockage</a></li>
<li><a href="../fr461129/index.html">À propos de Kote, de sa femme, de ses deux fils, de l'idée ... et pas seulement. Histoire avec suite</a></li>
<li><a href="../fr461131/index.html">Chariot à chariots ROS, partie 2. Logiciel</a></li>
<li><a href="../fr461133/index.html">Test du code SQL Server avec tSQLt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>