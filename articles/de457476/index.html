<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèº üç∂ üë®üèæ‚Äçüíº Reduzieren der Gr√∂√üe eines Docker-Images mit einer Spring-Boot-Anwendung üôÖüèæ ‚è™ üíô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag. 


 Vor kurzem stand ich vor der Aufgabe, Spring Boot 2-Anwendungen in einem Kubernetes-Cluster mithilfe eines Docker-Images zu starten. Di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reduzieren der Gr√∂√üe eines Docker-Images mit einer Spring-Boot-Anwendung</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457476/"><p>  Guten Tag. </p><br><p> Vor kurzem stand ich vor der Aufgabe, Spring Boot 2-Anwendungen in einem Kubernetes-Cluster mithilfe eines Docker-Images zu starten.  Dieses Problem ist nicht neu, schnell genug habe ich Beispiele in Google gefunden und meine Anwendung gepackt.  Ich war sehr √ºberrascht, das alpine Bild f√ºr jdk11 nicht zu finden und hoffte, dass schlank klein genug sein w√ºrde, aber als ich das Bild an die Docker-Registrierung schickte, bemerkte ich, dass es fast 422 Megabyte gro√ü war.  Unter der Katze finden Sie eine Beschreibung, wie ich das Docker-Image mit meinem Spring Boot und Java 11 auf 144 Megabyte reduziert habe. </p><br><p><img src="https://habrastorage.org/webt/zx/nk/bg/zxnkbgwnb8bdpshj6q1mypq6z0q.png"></p><a name="habracut"></a><br><h2 id="prilozhenie">  App </h2><br><p>  Wie bereits erw√§hnt, wird meine Anwendung mit Spring Boot 2 erstellt und ist ein REST-API-Wrapper √ºber eine relationale Datenbank (mithilfe von @RepositoryRestResource).  Meine Abh√§ngigkeiten umfassen: </p><br><pre><code class="plaintext hljs">org.springframework.boot:spring-boot-starter-data-rest org.springframework.boot:spring-boot-starter-data-jpa org.flywaydb:flyway-core org.postgresql:postgresql</code> </pre> <br><p>  Die gesammelte JAR-Datei hat eine Gr√∂√üe von 37,6 Megabyte. </p><br><p>  Dockerfile: </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim WORKDIR /home/demo ARG REVISION COPY target/spring-boot-app-${REVISION}.jar app.jar ENTRYPOINT ["java","-jar","app.jar"]</code> </pre> <br><p>  Als Ergebnis der Assembly erhalte ich ein Bild mit einer Gr√∂√üe von 422 MB gem√§√ü der Ausgabe des Befehls docker images.  Interessanterweise wird bei Verwendung des veralteten 8-JDK-Slim-Bilds die Gr√∂√üe auf 306 MB reduziert. </p><br><h2 id="popytka-1-drugoy-bazovyy-obraz">  Versuch 1: Ein weiteres Grundbild </h2><br><p>  Der erste logische Schritt war der Versuch, ein leichteres Bild zu finden, das vorzugsweise auf Alpen basiert.  Ich habe die beliebtesten Java-Repositorys gescannt: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://hub.docker.com/_/openjdk</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://hub.docker.com/r/adoptopenjdk/openjdk11</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://hub.docker.com/r/adoptopenjdk/openjdk11-openj9</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://hub.docker.com/r/adoptopenjdk/openjdk8</a> </li></ul><br><p>  (11 als aktuelle LTS-Version und 8 als noch gen√ºgend Anwendungen, die nicht auf modernere Versionen migriert werden konnten) </p><br><p>  Eine Tabelle mit Bildern und Tags (~ 2700), deren Gr√∂√üe zum Zeitpunkt des Schreibens angegeben ist, finden Sie <a href="">hier</a> </p><br><p>  Hier sind einige davon: </p><br><pre> <code class="plaintext hljs">openjdk 8 488MB openjdk 8-slim 269MB openjdk 8-alpine 105MB openjdk 8-jdk-slim 269MB openjdk 8-jdk-alpine 105MB openjdk 8-jre 246MB openjdk 8-jre-slim 168MB openjdk 8-jre-alpine 84.9MB openjdk 11 604MB openjdk 11-slim 384MB openjdk 11-jdk 604MB openjdk 11-jdk-slim 384MB openjdk 11-jre 479MB openjdk 11-jre-slim 273MB adoptopenjdk/openjdk8 alpine 221MB adoptopenjdk/openjdk8 alpine-slim 89.7MB adoptopenjdk/openjdk8 jre 200MB adoptopenjdk/openjdk8 alpine-jre 121MB adoptopenjdk/openjdk11 alpine 337MB adoptopenjdk/openjdk11 alpine-slim 246MB adoptopenjdk/openjdk11 jre 218MB adoptopenjdk/openjdk11 alpine-jre 140MB</code> </pre> <br><p>  Wenn Sie also das Basis-Image in adoptopenjdk / openjdk11: alpine-jre √§ndern, k√∂nnen Sie das Image mit der Anwendung auf 177 MB reduzieren. </p><br><h2 id="popytka-2-custom-runtime">  Versuch 2: Benutzerdefinierte Laufzeit </h2><br><p>  Seit der Ver√∂ffentlichung von jdk9 und der Modularisierung war es m√∂glich, eine eigene Laufzeit zu erstellen, die nur die Module enth√§lt, die f√ºr Ihre Anwendung erforderlich sind.  Weitere Informationen zu dieser Funktionalit√§t finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </p><br><p>  Versuchen wir, die erforderlichen Module f√ºr die Testfeder-Boot-Anwendung zu ermitteln: </p><br><pre> <code class="plaintext hljs">~/app ·êÖ jdeps -s target/app-1.0.0.jar app-1.0.0.jar -&gt; java.base app-1.0.0.jar -&gt; java.logging app-1.0.0.jar -&gt; not found</code> </pre> <br><p>  Ok, es scheint, dass jdeps nicht mit dem mit Spring Boot erstellten Fat-Jar umgehen kann, aber wir k√∂nnen das Archiv entpacken und den Klassenpfad schreiben: </p><br><pre> <code class="plaintext hljs">~/app ·êÖ jdeps -s -cp target/app-1.0.0/BOOT-INF/lib/*.jar target/app-1.0.0.jar.original Error: byte-buddy-1.9.12.jar is a multi-release jar file but --multi-release option is not set ~/app ·êÖ jdeps -s --multi-release 11 -cp target/app-1.0.0/BOOT-INF/lib/*.jar target/app-1.0.0.jar.original Error: aspectjweaver-1.9.2.jar is not a multi-release jar file but --multi-release option is set</code> </pre> <br><p>  Bei dieser Gelegenheit ist derzeit ein Fehler offen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://bugs.openjdk.java.net/browse/JDK-8207162</a> </p><br><p>  Ich habe versucht, jdk12 herunterzuladen, um diese Informationen zu erhalten, bin jedoch auf den folgenden Fehler gesto√üen: </p><br><pre> <code class="plaintext hljs">Exception in thread "main" com.sun.tools.classfile.Dependencies$ClassFileError ... Caused by: com.sun.tools.classfile.ConstantPool$InvalidEntry: unexpected tag at #1: 53</code> </pre> <br><p>  Durch Versuch, Irrtum und Modulsuche mit ClassNotFoundException habe ich festgestellt, dass meine Anwendung die folgenden Module ben√∂tigt: </p><br><ul><li>  java.base </li><li>  java.logging </li><li>  java.sql </li><li>  java.naming </li><li>  java.management </li><li>  java.instrument </li><li>  java.desktop </li><li>  java.security.jgss </li></ul><br><p>  Rantime f√ºr sie kann gesammelt werden mit: </p><br><pre> <code class="plaintext hljs">jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,java.logging,java.sql,java.naming,java.management,java.instrument,java.desktop,java.security.jgss --output /usr/lib/jvm/spring-boot-runtime</code> </pre> <br><p>  Versuchen wir, mit diesen Modulen ein einfaches Docker-Image zu erstellen: </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim RUN jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,java.logging,java.sql,java.naming,java.management,java.instrument,java.desktop,java.security.jgss --output /usr/lib/jvm/spring-boot-runtime FROM debian:stretch-slim COPY --from=0 /usr/lib/jvm/spring-boot-runtime /usr/lib/jvm/spring-boot-runtime RUN ln -s /usr/lib/jvm/spring-boot-runtime/bin/java /usr/bin/java</code> </pre> <br><p>  und sammle es: </p><br><pre> <code class="plaintext hljs">docker build . -t spring-boot-runtime:openjdk-11-slim</code> </pre> <br><p>  Infolgedessen betrug die Gr√∂√üe 106 Megabyte, was erheblich kleiner ist als bei den meisten mit openjdk gefundenen Basisimages.  Wenn Sie es f√ºr meine Anwendung verwenden, betr√§gt die resultierende Gr√∂√üe 144 Megabyte. </p><br><p>  Au√üerdem k√∂nnen wir <code>spring-boot-runtime:openjdk-11-slim</code> als Basis-Image f√ºr alle Spring-Boot-Anwendungen, wenn sie √§hnliche Abh√§ngigkeiten aufweisen.  Bei verschiedenen Abh√§ngigkeiten kann f√ºr jede Anwendung eine mehrstufige Image-Assembly verwendet werden, bei der in der ersten Phase die Java-Laufzeit erfasst und in der zweiten Phase das Archiv mit der Anwendung hinzugef√ºgt wird. </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim RUN jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,YOUR_MODULES --output /usr/lib/jvm/spring-boot-runtime FROM debian:stretch-slim COPY --from=0 /usr/lib/jvm/spring-boot-runtime /usr/lib/jvm/spring-boot-runtime WORKDIR /home/demo ARG REVISION COPY target/app-${REVISION}.jar app.jar ENTRYPOINT ["/usr/lib/jvm/spring-boot-runtime/bin/java","-jar","app.jar"]</code> </pre> <br><h2 id="vyvod">  Fazit </h2><br><p>  Derzeit haben die meisten Docker-Images f√ºr Java ein ausreichend gro√ües Volumen, was sich negativ auf die Startzeit der Anwendung auswirken kann, insbesondere wenn sich die erforderlichen Ebenen noch nicht auf dem Server befinden.  Mithilfe von Tags mit jre oder mithilfe der Java-Modularisierung k√∂nnen Sie Ihre eigene Laufzeit erstellen, wodurch die Gr√∂√üe des Anwendungsabbilds erheblich reduziert wird. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de457476/">https://habr.com/ru/post/de457476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de457462/index.html">Uber: √úberblick √ºber die wichtigsten Plattformverwaltungsalgorithmen</a></li>
<li><a href="../de457464/index.html">Deduplizierung von Anzeigen auf Yandex.Real Estate</a></li>
<li><a href="../de457466/index.html">Wie wir die IT bei Leroy Merlin entwickelt haben: Umbau eines Motors f√ºr unterwegs</a></li>
<li><a href="../de457468/index.html">Universeller Speicher: SRAM, DRAM und Flash-Speicher in einer Flasche</a></li>
<li><a href="../de457470/index.html">Blattmathematik: Wie ein ungew√∂hnlicher Busch die Gleichung eines Pflanzenwachstumsmodells ver√§nderte</a></li>
<li><a href="../de457480/index.html">Erstellen einer Abh√∂ranwendung zum Anzeigen des mobilen MMORPG-Verkehrs</a></li>
<li><a href="../de457490/index.html">Aisioshechka aus Zuckerberg - kurz und im Fall Waage</a></li>
<li><a href="../de457494/index.html">"Und wenn ich Mathe nicht kenne, bin ich dann hoffnungslos?" - Spezialisten beantworten h√§ufig gestellte Fragen zu Berufen in Data Science</a></li>
<li><a href="../de457496/index.html">"Finde die f√ºnf Unterschiede." Skalierbarer und Generierungsunterschied - Neue Testreihe</a></li>
<li><a href="../de457504/index.html">Warum sollten Sie Ihr React Data Grid im Jahr 2019 schreiben?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>