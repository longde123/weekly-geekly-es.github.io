<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚶🏿 🆚 🏻 «Class-fields-proposition» ou «Qu'est-ce qui s'est mal passé dans tc39 commit» 🎈 👆🏻 🗣️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a longtemps, nous voulons tous une encapsulation normale dans JS, qui pourrait être utilisée sans gestes inutiles. Nous voulons également des con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>«Class-fields-proposition» ou «Qu'est-ce qui s'est mal passé dans tc39 commit»</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428119/"><p>  Il y a longtemps, nous voulons tous une encapsulation normale dans JS, qui pourrait être utilisée sans gestes inutiles.  Nous voulons également des constructions pratiques pour déclarer les propriétés de classe.  Et enfin, nous voulons que toutes ces fonctionnalités du langage apparaissent de manière à ne pas casser les applications existantes. </p><br><p> Il semblerait qu'ici c'est le bonheur: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">classe-champs-proposition</a> , qui après de nombreuses années de tourments du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comité tc39 est</a> encore <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parvenue</a> à l' <code>stage 3</code> et a même été <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mise en œuvre en chrome</a> . </p><br><p>  Honnêtement, j'aimerais vraiment écrire un article expliquant pourquoi vous devriez utiliser la nouvelle fonctionnalité de langue et comment le faire, mais, malheureusement, l'article ne parlera pas du tout de cela. </p><a name="habracut"></a><br><h1 id="opisanie-tekuschego-propozala">  Description du courant manquant </h1><br><p>  Je ne répéterai pas ici la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">description d'origine</a> , la <a href="">FAQ</a> et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">modifications des spécifications</a> , mais je ne résumerai que brièvement les principaux points. </p><br><h2 id="polya-klassa">  Champs de classe </h2><br><p>  Déclarer des champs et les utiliser dans une classe: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ x = <span class="hljs-number"><span class="hljs-number">1</span></span>; method() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x); } }</code> </pre> <br><p>  Accès aux champs en dehors de la classe: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(ax);</code> </pre> <br><p>  Tout semblait évident et depuis de nombreuses années, nous utilisons cette syntaxe en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Babel</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">TypeScript</a> . </p><br><p>  Seulement, il y a une nuance.  Cette nouvelle syntaxe utilise <code>[[Define]]</code> , et non <code>[[Set]]</code> sémantique avec laquelle nous avons vécu tout ce temps. </p><br><p>  En pratique, cela signifie que le code ci-dessus n'est <strong>pas égal à</strong> ceci: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = <span class="hljs-number"><span class="hljs-number">1</span></span>; } method() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x); } }</code> </pre> <br><p>  Mais en fait, cela <strong>équivaut</strong> à ceci: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">configurable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">enumerable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">writable</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> }); } method() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x); } }</code> </pre> <br><p>  Et, bien que pour l'exemple ci-dessus, les deux approches font essentiellement la même chose, c'est une différence <strong>TRÈS GRAVE</strong> , et voici pourquoi: </p><br><p>  Disons que nous avons une classe parent comme celle-ci: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ x = <span class="hljs-number"><span class="hljs-number">1</span></span>; method() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x); } }</code> </pre> <br><p>  Sur cette base, nous en avons créé un autre: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ x = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p>  Et ils l'ont utilisé: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> b = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> B(); b.method(); <span class="hljs-comment"><span class="hljs-comment">//   2  </span></span></code> </pre> <br><p>  Ensuite, pour une raison quelconque, la classe <code>A</code> été modifiée d'une manière apparemment rétrocompatible: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ _x = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,   ,        get x() { return this._x; }; set x(val) { return this._x = val; }; method() { console.log(this._x); } }</span></span></code> </pre> <br><p>  Et pour la sémantique de <code>[[Set]]</code> , c'est vraiment un changement rétrocompatible, mais pas pour <code>[[Define]]</code> .  Maintenant, l'appel à <code>b.method()</code> sortira sur la console <code>1</code> au lieu de <code>2</code> .  Et cela se produira car <code>Object.defineProperty</code> redéfinit le descripteur de propriété et, par conséquent, getter / setter de la classe <code>A</code> ne sera pas appelé.  En fait, dans la classe enfant, nous avons <em>masqué la</em> propriété <code>x</code> du parent, de la même manière que nous pouvons le faire dans la portée lexicale: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> x = <span class="hljs-number"><span class="hljs-number">1</span></span>; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> x = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p>  Certes, dans ce cas, le linter avec ses règles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>no-shadow</code></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>no-shadowed-variable</code></a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>no-shadow</code></a> nous sauvera, mais la probabilité que quelqu'un crée un <code>no-shadowed-class-field</code> tend à zéro. </p><br><blockquote>  Soit dit en passant, je serai reconnaissant pour le terme russe plus réussi pour l' <code>shadowed</code> . </blockquote><p>  Malgré tout ce qui précède, je ne suis pas un adversaire inacceptable de la nouvelle sémantique (bien que j'en préfère une autre), car elle a ses propres aspects positifs.  Mais, malheureusement, ces avantages ne l'emportent pas sur les inconvénients les plus importants - nous utilisons la sémantique <code>[[Set]]</code> depuis de nombreuses années, car elle est utilisée par défaut dans <code>babel6</code> et <code>TypeScript</code> . </p><br><blockquote>  Certes, il convient de noter que dans <code>babel7</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">valeur par défaut a été modifiée</a> . </blockquote><p>  Des discussions plus originales sur ce sujet peuvent être lues <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><h2 id="privatnye-polya">  Champs privés </h2><br><p>  Et maintenant, nous allons passer à la partie la plus controversée de celle-ci.  Tellement controversé que: </p><br><ol><li>  bien qu'il soit déjà implémenté dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chrome Canary</a> et que les champs publics soient déjà activés par défaut, les champs privés sont toujours derrière le drapeau; </li><li>  bien que le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">profil initial pour les champs privés ait</a> été fusionné avec le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">profil</a> actuel, des demandes sont toujours en cours pour la séparation de ces deux caractéristiques (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deux</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">trois</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">quatre</a> ); </li><li>  même certains membres du comité (comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Allen Wirfs-Brock</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Kevin Smith</a> ) s'expriment et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">proposent des alternatives</a> , malgré l' <strong>étape3</strong> ; </li><li>  cette erreur a établi un record pour le nombre de problèmes - <strong>129</strong> dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">référentiel actuel</a> + <strong>96</strong> dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">original</a> , contre <strong>126</strong> pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BigInt</a> , et le détenteur du record a surtout <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des commentaires négatifs</a> ; </li><li>  J'ai dû créer un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fil séparé</a> avec une tentative de résumer en quelque sorte toutes les réclamations contre lui; </li><li>  J'ai dû écrire une <a href="">FAQ séparée</a> qui couvre cette partie <br><blockquote>  cependant, en raison d'une argumentation plutôt faible, de telles discussions sont apparues ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deux</a> ) <br></blockquote></li><li>  Personnellement, j'ai passé tout mon temps libre (et parfois travaillé) pendant une longue période pour tout comprendre et même <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">trouver une explication de la</a> raison pour laquelle il était comme ça ou proposer une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">alternative appropriée</a> ; </li><li>  à la fin, j'ai décidé d'écrire cet article de synthèse. </li></ol><br><p>  Les champs privés sont déclarés comme suit: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ #priv; }</code> </pre> <br><p>  Et leur accès est le suivant: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ #priv = <span class="hljs-number"><span class="hljs-number">1</span></span>; method() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.#priv); } }</code> </pre> <br><p>  Je ne soulèverai même pas le sujet selon lequel le modèle mental derrière cela n'est pas très intuitif ( <code>this.#priv !== this['#priv']</code> ), n'utilise pas les mots <code>private</code> / <code>protected</code> déjà réservés (ce qui causera nécessairement une douleur supplémentaire pour les développeurs TypeScript), il n'est pas clair comment l'étendre à d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">autres modificateurs d'accès</a> , et la syntaxe elle-même n'est pas très belle.  Bien que tout cela soit la raison originale qui m'a poussé à une étude plus approfondie et à une participation aux discussions. </p><br><p>  Tout cela concerne la syntaxe, où les préférences esthétiques subjectives sont très fortes.  Et on pourrait vivre avec et s'y habituer avec le temps.  Sinon pour une chose: il y a un problème très important de sémantique ... </p><br><h3 id="cemantika-weakmap">  Sémantique <code>WeakMap</code> </h3><br><p>  Voyons ce qui se cache derrière la proposition existante.  Nous pouvons réécrire l'exemple ci-dessus avec encapsulation et sans utiliser la nouvelle syntaxe, mais en préservant la sémantique de la syntaxe actuelle: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> privatesForA = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">WeakMap</span></span>(); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { privatesForA.set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, {}); privatesForA.get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).priv = <span class="hljs-number"><span class="hljs-number">1</span></span>; } method() { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(privatesForA.get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).priv); } }</code> </pre> <br><blockquote>  Soit dit en passant, sur la base de cette sémantique, l'un des membres du comité a même construit une petite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bibliothèque d'utilitaires</a> qui vous permet d'utiliser l'état privé en ce moment, afin de montrer que cette fonctionnalité est trop surfaite par le comité.  Le code formaté ne prend que 27 lignes. </blockquote><p>  En général, tout va bien, nous obtenons <code>hard-private</code> accès <code>hard-private</code> , qui ne peut en aucun cas être obtenu / intercepté / suivi à partir de code externe, et en même temps, nous pouvons accéder aux champs privés d'une autre instance de la même classe, par exemple comme ceci: </p><br><pre> <code class="javascript hljs">isEquals(obj) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> privatesForA.get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).id === privatesForA.get(obj).id; }</code> </pre> <br><p>  Eh bien, c'est très pratique, sauf que cette sémantique, en plus de l'encapsulation elle-même, comprend également la <code>brand-checking</code> (vous ne pouvez pas google ce que c'est - il est peu probable que vous trouviez des informations pertinentes). <br>  <code>brand-checking</code> est l'opposé de la <code>duck-typing</code> de <code>duck-typing</code> , en ce sens qu'elle ne vérifie pas l'interface publique de l'objet, mais le fait que l'objet a été construit à l'aide d'un code de confiance. <br>  Une telle vérification, en fait, a une certaine portée - elle est principalement associée à la sécurité de l'appel de code non approuvé dans un seul espace d'adressage avec un espace de confiance et à la possibilité d'échanger des objets directement sans sérialisation. </p><br><blockquote>  Bien que certains ingénieurs considèrent cela comme une partie nécessaire d'une bonne encapsulation. </blockquote><p>  Malgré le fait qu'il s'agit d'une opportunité plutôt curieuse, qui est étroitement liée au modèle de <code></code> (description <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">courte</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus longue</a> ), à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Realms</code> propagande</a> et travaux scientifiques dans le domaine de l'informatique, dans lesquels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mark Samuel Miller est</a> engagé (il est également membre du comité), selon mon expérience. , dans la pratique de la plupart des développeurs, cela ne se produit presque jamais. </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Soit dit en passant</a> , je suis toujours tombé sur une membrane (même si je ne savais pas ce que c'était alors) lorsque j'ai réécrit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vm2 pour</a> répondre à mes besoins. </blockquote><br><h3 id="problema-brand-checking">  Problème de <code>brand-checking</code> </h3><br><p>  Comme mentionné précédemment, la <code>brand-checking</code> est l'opposé de la <code>duck-typing</code> de <code>duck-typing</code> .  En pratique, cela signifie qu'avoir ce code: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> brands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">WeakMap</span></span>(); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { brands.set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, {}); } method() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } brandCheckedMethod() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!brands.has(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">'Brand-check failed'</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.method()); } }</code> </pre> <br><p>  <code>brandCheckedMethod</code> ne peut être appelé qu'avec une instance de classe <code>A</code> et même si la cible est un objet qui conserve les invariants de cette classe, cette méthode lèvera une exception: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> duckTypedObj = { <span class="hljs-attr"><span class="hljs-attr">method</span></span>: A.prototype.method.bind(duckTypedObj), <span class="hljs-attr"><span class="hljs-attr">brandCheckedMethod</span></span>: A.prototype.brandCheckedMethod.bind(duckTypedObj), }; duckTypedObj.method(); <span class="hljs-comment"><span class="hljs-comment">//        1 duckTypedObj.brandCheckedMethod(); //     </span></span></code> </pre> <br><p>  Évidemment, cet exemple est assez synthétique et l'utilisation de <code>duckTypedObj</code> comme celle-ci <code>duckTypedObj</code> douteuse, jusqu'à ce que nous pensions à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>Proxy</code></a> . <br>  La métaprogrammation est l'un des scénarios d'utilisation de proxy très importants.  Pour que le proxy fasse tout le travail utile nécessaire, les méthodes des objets encapsulés à l'aide d'un proxy doivent être exécutées dans le contexte du proxy, et non dans le contexte de la cible, à savoir: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> proxy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Proxy</span></span>(a, { get(target, p, receiver) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> property = <span class="hljs-built_in"><span class="hljs-built_in">Reflect</span></span>.get(target, p, receiver); doSomethingUseful(<span class="hljs-string"><span class="hljs-string">'get'</span></span>, retval, target, p, receiver); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> property === <span class="hljs-string"><span class="hljs-string">'function'</span></span>) ? property.bind(proxy) : property; } });</code> </pre> <br><p>  Appelez <code>proxy.method();</code>  fera un travail utile déclaré dans le proxy et retournera <code>1</code> , tout en appelant <code>proxy.brandCheckedMethod();</code>  au lieu de faire deux fois un travail utile à partir du proxy, il lèvera une exception, car <code>a !== proxy</code> , ce qui signifie que la <code>brand-check</code> n'a pas réussi. </p><br><p>  Oui, nous pouvons exécuter des méthodes / fonctions dans le contexte d'une cible réelle, pas d'un proxy, et pour certains scénarios cela suffit (par exemple, pour implémenter le modèle <code></code> ), mais cela ne suffit pas pour tous les cas (par exemple, pour implémenter des propriétés réactives: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MobX 5</a> utilise déjà un proxy pour cela, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vue.js</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Aurelia</a> expérimentent cette approche pour les futures versions). </p><br><p>  En général, tant que le <code>brand-check</code> de <code>brand-check</code> doit être fait explicitement, ce n'est pas un problème - le développeur doit juste consciemment décider quel compromis il fait et s'il en a besoin, de plus, dans le cas d'un <code>brand-check</code> explicite <code>brand-check</code> vous pouvez l'implémenter de telle manière que l'erreur ne serait pas renvoyée sur des proxys approuvés. </p><br><p>  Malheureusement, l'actuel nous a privé de cette flexibilité: </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ #priv; method() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.#priv; <span class="hljs-comment"><span class="hljs-comment">//    brand-check   } }</span></span></code> </pre> <br><p>  Une telle <code>method</code> lèvera toujours une exception si elle n'est pas appelée dans le contexte d'un objet construit à l'aide du constructeur <code>A</code>  Et le pire, c'est que la <code>brand-check</code> est implicite ici et est mélangée à une autre fonctionnalité - l'encapsulation. </p><br><p>  Alors que l' <code></code> presque nécessaire pour tout code, la <code>brand-check</code> a une portée plutôt étroite.  Et les combiner en une seule syntaxe entraînera le fait que de nombreuses <code>brand-check</code> involontaires apparaissent dans le code utilisateur, lorsque le développeur avait uniquement l'intention de masquer les détails de l'implémentation. <br>  Et le slogan qui est utilisé pour promouvoir cela était <code># is the new _</code> exacerbant seulement la situation. </p><br><blockquote>  Vous pouvez également lire une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">discussion détaillée sur la façon dont un proxy existant rompt un proxy</a> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'un des développeurs</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">auteur</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d'Aurelia</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vue.js est intervenu dans la discussion</a> . <br><br>  De plus, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon commentaire</a> , qui décrit plus en détail la différence entre les différents scénarios de proxy, peut sembler intéressant pour quelqu'un.  Dans son ensemble, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">toute la discussion sur la connexion des champs privés et des membranes</a> . </blockquote><br><h1 id="alternativy">  Alternatives </h1><br><p>  Toutes ces discussions auraient peu de sens s'il n'y avait pas d'alternatives.  Malheureusement, pas un seul remplaçant n'est même arrivé à l' <strong>étape 1</strong> , et, par conséquent, n'a même pas eu la chance d'être suffisamment élaboré.  Cependant, je vais énumérer ici des alternatives qui résolvent en quelque sorte les problèmes décrits ci-dessus. </p><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Symbol.private</strong></a> - un prozazil alternatif l'un des membres du comité. <br><ol><li>  Résout tous les problèmes ci-dessus (bien qu'il puisse avoir le sien, mais, compte tenu du manque de travail actif sur celui-ci, il est difficile de les trouver) </li><li>  il a de nouveau été rejeté lors de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dernière réunion du comité en</a> raison de l'absence d'un <code>brand-check</code> intégré, de problèmes avec le motif de la membrane (bien que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cela</a> + <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cela</a> offre une solution adéquate) et du manque de syntaxe pratique </li><li>  une syntaxe pratique peut être construite au-dessus de la réelle, comme je l'ai montré <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> </li></ol></li><li>  <a href=""><strong>Classes 1.1</strong></a> - posozal antérieur du même auteur </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Utilisation de <em>Private</em> comme objet</strong></a> </li></ol><br><h1 id="vmesto-zaklyucheniya">  Au lieu d'une conclusion </h1><br><p>  Par le ton de l'article, il peut probablement sembler que je condamne le comité - ce n'est pas le cas.  Il me semble qu'au fil des années (selon le point de départ, cela pourrait même être des décennies) que le comité a travaillé sur l'encapsulation dans JS, beaucoup de choses dans l'industrie ont changé, et l'apparence pourrait être floue, ce qui a conduit à un faux classement des priorités . </p><br><p>  De plus, en tant que communauté, nous <strong>poussons</strong> le <strong>tc39 à les</strong> forcer à publier des fonctionnalités plus rapidement, tout en donnant très peu de commentaires dans les premiers stades des prozos, ce qui ne fait baisser notre indignation qu'à un moment où peu de choses peuvent être modifiées. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">On pense</a> que dans ce cas, le processus a simplement échoué. </p><br><p>  Après l'avoir plongé dans ma tête et avoir discuté avec certains représentants, j'ai décidé que je ferais de mon mieux pour éviter la répétition d'une situation similaire - mais je peux faire un peu (écrire un article de revue, faire en sorte que la mise en œuvre de l' <code>stage1</code> ratée à <code>babel</code> et tout le <code>babel</code> ). </p><br><p>  Mais la chose la plus importante est la rétroaction - je vous demanderais donc de participer à cette petite enquête.  Et j'essaierai à mon tour de le transmettre au comité. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428119/">https://habr.com/ru/post/fr428119/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428109/index.html">Mur d'entreprise</a></li>
<li><a href="../fr428111/index.html">Arithmétique de précision arbitraire à Erlang</a></li>
<li><a href="../fr428113/index.html">À la question des courbes de Bézier, de la vitesse Arduino et d'un site intéressant, ou comment j'ai passé le week-end</a></li>
<li><a href="../fr428115/index.html">Développement Web pour le commerce électronique: 5 tendances technologiques pour 2019</a></li>
<li><a href="../fr428117/index.html">Processeurs tensoriels gratuits de Google dans le cloud collaboratif</a></li>
<li><a href="../fr428121/index.html">Stan Drapkin. Pièges de cryptographie de haut niveau dans .NET</a></li>
<li><a href="../fr428123/index.html">Semaine de la sécurité 41: Bonne nouvelle</a></li>
<li><a href="../fr428125/index.html">Qui sont les analyses de produits et pourquoi sont-elles nécessaires dans une équipe?</a></li>
<li><a href="../fr428127/index.html">Cache Nginx: tout nouveau - vieux bien oublié</a></li>
<li><a href="../fr428129/index.html">Une logique floue simple collée «de ce qui était» pour un moteur à turbine à gaz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>