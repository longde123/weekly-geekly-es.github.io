<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>锔   Gran hermano est谩 mirando ... a s铆 mismo o un mapa con la historia de los movimientos en HomeAssistant 葛  答</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entrada 
 Para mi automatizaci贸n del hogar, he estado usando HomeAssistant durante mucho tiempo. Una vez que un amigo me pregunt贸, me dijeron, 驴por qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gran hermano est谩 mirando ... a s铆 mismo o un mapa con la historia de los movimientos en HomeAssistant</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448656/"><h3>  Entrada </h3><br>  Para mi automatizaci贸n del hogar, he estado usando HomeAssistant durante mucho tiempo.  Una vez que un amigo me pregunt贸, me dijeron, 驴por qu茅 HomeAssistant tiene la capacidad de indicar solo la posici贸n actual del rastreador en el mapa, pero no es posible mostrar la ruta completa?  Desde entonces, esta idea me ha capturado.  Y una vez que me di cuenta de que realmente quiero tener esta funci贸n en este momento.  Todos los que est茅n interesados en lo que vino de esto, bienvenidos al gato ... <br><a name="habracut"></a><br><h3>  Inteligencia </h3><br>  En realidad, para mostrar la ruta necesita tener un conjunto de puntos con coordenadas, por lo que el primer paso fue averiguar d贸nde almacena HomeAssistant los datos necesarios (si es que los hay) y c贸mo sacarlos de all铆.  Un breve estudio de la fuente condujo inmediatamente a la decisi贸n: necesita el m贸dulo grabador incluido para registrar el estado de los sensores deseados en la base de datos en diferentes momentos, as铆 como el m贸dulo de historial, que le permite obtener datos de la base de datos de una manera hermosa.  El m贸dulo de historia tiene una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">API REST</a> bien documentada.  Lo que necesitas! <br><br>  A continuaci贸n, debe mostrar de alguna manera los datos recibidos en el mapa.  Existen muchos servicios diferentes que le permiten mostrar el historial de movimientos.  Probablemente prob茅 lejos de todos ellos, pero me permitir茅 algunas palabras sobre las que verifiqu茅: <br>  <b>A.</b>  Yandex y Google.  En realidad, para mis necesidades, hay de todo y a煤n m谩s, pero debido a los servicios pagos y las fuertes restricciones de las versiones gratuitas, no me conven铆an de inmediato.  Yandex, por ejemplo, permite el uso gratuito solo para proyectos abiertos (es decir, cualquiera deber铆a poder abrir su recurso en cualquier momento y aprovechar sus capacidades), sin mencionar otras restricciones en el n煤mero de solicitudes.  Solo los perezosos no escribieron sobre los cambios en las pol铆ticas de Google con respecto a la API.  Por el momento, seg煤n tengo entendido, cada solicitud de mapas api o direcciones api se paga, cuantas m谩s solicitudes, m谩s barato.  Sin embargo, cada usuario con una tarjeta bancaria conectada a su cuenta recibe un l铆mite gratuito de $ 200 por mes.  Todo en la parte superior se paga inmediatamente de su tarjeta.  Vincular una tarjeta a una cuenta no es nuestro camino. <br><br>  Corrija si comet铆 un error en alg煤n lugar sobre google y / o yandex. <br><br>  <b>B.</b>  Un mont贸n de mapas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OpenRouteService</a> y OpenRouteService.  En principio, las capacidades no son muy diferentes de google o yandex (en cualquier caso, no me di cuenta).  Completamente gratis (hay restricciones en la cantidad de solicitudes por d铆a y por minuto, si se excede, se recomienda contactar al soporte ... no hay una descripci贸n de ninguna tarifa pagada).  Sin embargo, el uso del recurso de mapas OpenRouteService result贸 ser un inconveniente (carga prolongada de la aplicaci贸n y el molesto men煤 ancho a la izquierda, que se abre de forma predeterminada y no est谩 deshabilitado por la API, adem谩s, el servicio no se abre correctamente desde dispositivos m贸viles).  Para ser justos, los mapas de OpenRouteService se pueden colocar en su servidor y es muy posible que all铆 pueda configurar todo usted mismo. <br><br>  <b>B.</b>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mapbbcode</a>  Me top茅 con una implementaci贸n interesante de tarjetas en un formato simple.  En principio, el proyecto es absolutamente adecuado para mi tarea, sin embargo, de este art铆culo aprend铆 sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Leaflet</a> y decid铆 recurrir a la fuente.  Al final, se detuvo en eso ... <br><br>  <b>G.</b>  Folleto  Muy buena biblioteca js de c贸digo abierto para mapas, f谩cil de aprender y bien documentada.  Desde los chips: le permite usar mosaicos de muchos servicios (openstreetmaps, yandex, google, mapbox, microsoft, etc., etc.).  Adem谩s, utilic茅 el complemento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">leaflet.polylineDecorator</a> para indicar la direcci贸n del movimiento en el mapa. <br><br>  Vale la pena mencionar que los dos 煤ltimos recursos considerados no admiten "rutas", es decir, no saben c贸mo conectar puntos a lo largo de carreteras y / o aceras existentes, sino que simplemente conectan los puntos con una l铆nea recta.  Para m铆 personalmente, esto no es un problema, sino un paso consciente.  Si necesita navegaci贸n en las carreteras, entonces debe mirar en la direcci贸n de google, yandex o servicio gratuito de openroutes. <br><br><h3>  Implementaci贸n </h3><br>  La solicitud al m贸dulo de historial a trav茅s de REST-API es bastante simple (en adelante, el c贸digo estar谩 en el lenguaje HomeAssistant, es decir, python) y le permite obtener la respuesta en forma de JSON simple para comprender: <br><br><pre><code class="python hljs">response = requests.get(self._haddr + <span class="hljs-string"><span class="hljs-string">'/api/history/period/'</span></span> + dayBegin + <span class="hljs-string"><span class="hljs-string">'?filter_entity_id='</span></span> + self._myid, headers={<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: <span class="hljs-string"><span class="hljs-string">'Bearer '</span></span> + self._token, <span class="hljs-string"><span class="hljs-string">'content-type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>}) data = response.json()[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br>  aqu铆 self._haddr es la direcci贸n de su HA igual a la especificada en la configuraci贸n de la interfaz, self._myid es la identificaci贸n del dispositivo de device_tracker, cuya ruta construiremos, dayBegin es el comienzo del per铆odo para mostrar la ruta, seleccion茅 el comienzo del d铆a actual de forma predeterminada, self._token es un token de larga duraci贸n para acceder a la API, que se puede obtener en la interfaz HomeAssistant. <br><br>  Cuando el objeto cuyo historial estamos tratando de mostrar en el mapa es estacionario durante mucho tiempo o se mueve extremadamente lento, obtendremos un mont贸n de puntos que se encuentran cerca y obstruir谩n el mapa.  Para corregir la situaci贸n, deje que la matriz de coordenadas resultante pase por el filtro: si la distancia entre el punto anterior y el siguiente es inferior a 100 metros, no muestre el punto en el mapa.  Para calcular las distancias entre dos puntos vecinos, utilizamos una f贸rmula simplificada con una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aproximaci贸n equiangular</a> .  La aproximaci贸n es aplicable cuando la distancia entre puntos vecinos no excede varios km: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, latA, lonA, latB, lonB)</span></span></span><span class="hljs-function">:</span></span> dst = <span class="hljs-number"><span class="hljs-number">0</span></span> latRadA = math.radians(latA) lonRadA = math.radians(lonA) latRadB = math.radians(latB) lonRadB = math.radians(lonB) x = latRadB - latRadA y = (lonRadB-lonRadA)*math.cos((latRadB+latRadA)*<span class="hljs-number"><span class="hljs-number">0.5</span></span>) dst = <span class="hljs-number"><span class="hljs-number">6371</span></span>*math.sqrt(x*x+y*y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dst</code> </pre> <br>  Aqu铆 dst es la distancia en km. <br><br>  Describir la API del folleto aqu铆 no ve el punto.  Para esto, en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sitio web oficial</a> .  El m贸dulo funciona de la siguiente manera: cada n segundos (lo configur茅 en 300) se realiza una solicitud al historial actual del objeto que me interesa.  La matriz resultante de coordenadas se ejecuta a trav茅s del filtro de distancia, reduciendo el n煤mero de puntos.  Adem谩s, en la carpeta con la configuraci贸n HomeAssistant en la carpeta www, se forman 2 archivos: index.html y route.html.  El archivo route.html contiene toda la l贸gica para crear un mapa.  Y el archivo index.html es un truco para evitar el almacenamiento en cach茅 de la p谩gina.  De manera predeterminada, HomeAssistant almacena en cach茅 todo lo que es posible, y solo restablecer el cach茅 ayud贸 a actualizar los datos en el mapa, lo que, por supuesto, es inaceptable.  En el archivo index.html, se llama al contenido de route.html, sin embargo, con un par谩metro aleatorio generado din谩micamente, que le permite solicitar siempre la versi贸n actual de route.html del servidor: <br><br><pre> <code class="xml hljs">src = 'route.html?datetime=' + (new Date()).getTime() + Math.floor(Math.random() * 1000000)</code> </pre> <br><h3>  Un poco sobre seguridad </h3><br>  HomeAssistant est谩 dise帽ado para que todos los archivos dentro del directorio www sean p煤blicos, es decir, cualquier archivo dentro del directorio www puede abrirse en cualquier navegador sin ninguna autorizaci贸n, conociendo el enlace directo.  En el caso de mi m贸dulo, este enlace es el siguiente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">your_address_homeassistant / local / route / index.html</a> .  Si esto no es cr铆tico para usted, puede omitir esta secci贸n.  Fui un poco m谩s lejos y atornill茅 la autorizaci贸n a la p谩gina con rutas.  Para esto, utilic茅 nginx (puede elegir otro servidor web con soporte de proxy inverso) como servidor proxy.  El sitio web HomeAssistant tiene <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instrucciones</a> oficiales para configurar esta configuraci贸n.  Despu茅s de configurar el proxy y la operaci贸n de verificaci贸n, debe agregar autorizaci贸n a las p谩ginas necesarias en la configuraci贸n de nginx: <br><br><pre> <code class="plaintext hljs">location /local/route/route.html { proxy_pass http://localhost:8123/local/route/route.html; proxy_set_header Host $host; proxy_redirect http:// https://; proxy_http_version 1.1; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; auth_basic "Unauthorized"; auth_basic_user_file /etc/nginx/.htpasswd; }</code> </pre> <br>  Luego cree el archivo "/etc/nginx/.htpasswd" y ejecute los siguientes comandos en la consola: <br><br><pre> <code class="bash hljs">sh -c <span class="hljs-string"><span class="hljs-string">"echo -n 'admin:' &gt;&gt; /etc/nginx/.htpasswd"</span></span> sh -c <span class="hljs-string"><span class="hljs-string">"openssl passwd -apr1 &gt;&gt; /etc/nginx/.htpasswd"</span></span></code> </pre> <br>  admin: reemplazar con el inicio de sesi贸n deseado. <br><br>  Despu茅s de eso, reinicie nginx y verifique: cuando intente abrir una p谩gina con una ruta, el navegador debe solicitar un nombre de usuario y contrase帽a.  Observo que esta es una autorizaci贸n separada que no tiene nada que ver con la autorizaci贸n de HomeAssistant. <br><br><h3>  Conclusi贸n </h3><br>  Quiz谩s todo lo que se pueda decir sobre este m贸dulo. <br>  Quienes est茅n interesados, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu铆 hay un enlace</a> al m贸dulo.  Coloque el archivo a lo largo de la ruta: config_folder_homeassistant / custom_components / route / sensor.py, no se olvide de los derechos. <br><br>  Si no existe, cree la carpeta config_folder_homeassistant / www y dele los derechos correspondientes. <br><br>  En el archivo de configuraci贸n configuration.yaml, escriba las siguientes l铆neas: <br><br><pre> <code class="plaintext hljs">sensor: - platform: route name: route entityid: your_device_tracker_entity_id haddr: your_address_homeassistant token: your_long_life_token</code> </pre> <br>  aqu铆 your_device_tracker_entity_id es la ID de su dispositivo device_tracker, your_address_homeassistant es la direcci贸n externa de su HomeAssistant, your_long_life_token es el token de acceso recibido previamente en la interfaz de HomeAssistant para utilizar la API REST. <br><br>  Despu茅s de eso, reinicie HomeAssistant y disfrute.  El mapa estar谩 disponible a trav茅s de un enlace directo: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">your_address_homeassistant / local / route / index.html</a> .  Si lo desea, puede agregarlo al men煤 HA utilizando panel_iframe o en cualquier ventana HA a trav茅s de la tarjeta lovelace "iframe". <br>  Eso es todo, gracias por su atenci贸n. <br><br>  <b>UPD:</b> <br>  Se agreg贸 un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> a GitHub.  Se modificaron algunos lugares (se elimin贸 de la configuraci贸n haddr, se obtuvo autom谩ticamente config_dir, se agreg贸 la capacidad de establecer mi zona horaria) <br><br><div class="spoiler">  <b class="spoiler_title">驴Y c贸mo se ve todo?</b>  <b class="spoiler_title">隆Cuidado, Bluer!</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tw/_v/2_/tw_v2_gufir0tcuzo02dt1e-zig.jpeg" alt="imagen"><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/448656/">https://habr.com/ru/post/448656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448642/index.html">Modelo obligatorio de distribuci贸n de derechos en FreeBSD</a></li>
<li><a href="../448644/index.html">Expresiones regulares aplicativas como functor alternativo gratuito</a></li>
<li><a href="../448648/index.html">C贸mo sentar a todos en la ciencia y no convertir la oficina en un hervidero de odio</a></li>
<li><a href="../448652/index.html">Mozilla WebThings en Raspberry Pi: c贸mo empezar</a></li>
<li><a href="../448654/index.html">Mozilla WebThings - Configuraci贸n de la puerta de enlace</a></li>
<li><a href="../448658/index.html">驴Qu茅 se puede hacer a trav茅s del conector OBD en el autom贸vil?</a></li>
<li><a href="../448662/index.html">"Rusia 404": una opci贸n no para mostrar</a></li>
<li><a href="../448664/index.html">Crear cartas como yesca en Swift</a></li>
<li><a href="../448666/index.html">C贸mo elegimos un servicio para la gesti贸n de documentos electr贸nicos con clientes</a></li>
<li><a href="../448668/index.html">gil: el mayor problema ideol贸gico en TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>