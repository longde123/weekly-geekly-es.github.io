<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“ ğŸ’…ğŸ» â³ æš‚åœé˜»æ­¢ ğŸ•µğŸ¿ ğŸ‘§ğŸ» ğŸ´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ¬æ–‡æ—¨åœ¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨Kotlinåç¨‹å¹¶åˆ é™¤Reaxtive eXtensionsï¼ˆRxï¼‰ ã€‚ 
 å¥½å¤„ 


 é¦–å…ˆï¼Œè®©æˆ‘ä»¬è€ƒè™‘åç¨‹ç›¸å¯¹äºRxçš„å››ä¸ªå¥½å¤„ï¼š 
 æš‚åœé˜»æ­¢ 


 è¦ä½¿ç”¨Rxè¿è¡Œéé˜»å¡ä»£ç ï¼Œæ‚¨éœ€è¦ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š 


Observable.interval(1, TimeUnit.SE...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æš‚åœé˜»æ­¢</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465529/"><p> æœ¬æ–‡æ—¨åœ¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kotlinåç¨‹</a>å¹¶åˆ é™¤<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Reaxtive eXtensionsï¼ˆRxï¼‰</a> ã€‚ </p><br><h2 id="benefits"> å¥½å¤„ </h2><br><p> é¦–å…ˆï¼Œè®©æˆ‘ä»¬è€ƒè™‘åç¨‹ç›¸å¯¹äºRxçš„å››ä¸ªå¥½å¤„ï¼š </p><br><h3 id="suspending-over-blocking"> æš‚åœé˜»æ­¢ </h3><br><p> è¦ä½¿ç”¨Rxè¿è¡Œéé˜»å¡ä»£ç ï¼Œæ‚¨éœ€è¦ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š </p><br><pre><code class="kotlin hljs">Observable.interval(<span class="hljs-number"><span class="hljs-number">1</span></span>, TimeUnit.SECONDS) .subscribe { textView.text = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$it</span></span></span><span class="hljs-string"> seconds have passed"</span></span> }</code> </pre> <br><p> è¿™å®é™…ä¸Šæ˜¯åœ¨åˆ›å»ºæ–°çº¿ç¨‹ã€‚ å°±å†…å­˜å’Œæ€§èƒ½è€Œè¨€ï¼Œçº¿ç¨‹æ˜¯æ²‰é‡çš„å¯¹è±¡ã€‚ </p><br><p> ä¸¤è€…åœ¨ç§»åŠ¨å¼€å‘é¢†åŸŸéƒ½è‡³å…³é‡è¦ã€‚ </p><br><p> æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç æ®µå®ç°ç›¸åŒçš„è¡Œä¸ºï¼š </p><br><pre> <code class="kotlin hljs">launch { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>){ textView.text = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${it++}</span></span></span><span class="hljs-string"> seconds have passed"</span></span> delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>) } }</code> </pre> <br><p> æœ¬è´¨ä¸Šï¼Œåç¨‹æ˜¯è½»é‡çº§çº¿ç¨‹ï¼Œä½†æˆ‘ä»¬ä¸åˆ›å»ºä»»ä½•å®é™…çº¿ç¨‹ã€‚ <br> è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯éé˜»å¡delayï¼ˆï¼‰å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æŒ‚èµ·å‡½æ•°ï¼Œå®ƒä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œè€Œæ˜¯æŒ‚èµ·Coroutineã€‚ <a name="habracut"></a></p><br><h3 id="natural-backpressure-handling-over-manual"> è‡ªç„¶èƒŒå‹å¤„ç†è¶…è¿‡æ‰‹åŠ¨ </h3><br><p> èƒŒå‹æ˜¯å¯è§‚å¯Ÿç‰©äº§ç”Ÿçš„ç‰©å“æ¯”è§‚å¯Ÿè€…æ¶ˆè€—ç‰©å“æ›´å¿«çš„é€Ÿåº¦ã€‚ <br> ä½¿ç”¨Rxæ—¶ï¼Œå¿…é¡»æ˜ç¡®æŒ‡å®šå¦‚ä½•å¤„ç†èƒŒå‹ã€‚ <br> æœ‰ä¸¤ç§åŸºæœ¬æ–¹æ³•ï¼š </p><br><ul><li> ä½¿ç”¨é™åˆ¶ï¼Œç¼“å†²åŒºæˆ–Windowsè¿ç®—ç¬¦ </li><li> ååº”æ‹‰åŠ›æ¨¡å‹ </li></ul><br><p> åç¨‹å¯ä»¥æš‚åœï¼Œè¿™ä¸ºåº”å¯¹èƒŒå‹æä¾›äº†è‡ªç„¶ç­”æ¡ˆã€‚ <br> å› æ­¤ï¼Œä¸éœ€è¦å…¶ä»–åŠ¨ä½œã€‚ </p><br><h3 id="sync-code-style-over-async"> é€šè¿‡å¼‚æ­¥åŒæ­¥ä»£ç æ ·å¼ </h3><br><p> ç§»åŠ¨åº”ç”¨ç¨‹åºçš„åŸºæœ¬æ€§è´¨æ˜¯å¯¹ç”¨æˆ·æ“ä½œåšå‡ºååº”ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆååº”å¼æ‰©å±•å°†æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ </p><br><p> ä½†æ˜¯ï¼Œæ‚¨å¿…é¡»ä»¥åŠŸèƒ½æ ·å¼ç¼–å†™ä»£ç ã€‚ å¦‚æœæ‚¨è¿‡å»ä¹ æƒ¯ä»¥å‘½ä»¤å¼çš„é£æ ¼ç¼–å†™ï¼Œå¯èƒ½ä¼šæœ‰äº›å›°éš¾ã€‚ </p><br><p> è€Œåç¨‹ä½¿æ‚¨å¯ä»¥åƒç¼–å†™é€šå¸¸çš„åŒæ­¥åŠŸèƒ½ä¸€æ ·ç¼–å†™å¼‚æ­¥ä»£ç ã€‚ ä¾‹å¦‚ </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showTextFromRemote</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> text = remote.getText() textView.text = text }</code> </pre> <br><p> å³ä½¿æˆ‘ä½¿ç”¨å‡½æ•°å¼æ ·å¼å·²ç»å¾ˆé•¿æ—¶é—´äº†ï¼Œé˜…è¯»å’Œè°ƒè¯•å‘½ä»¤æ€§ä»£ç ä»ç„¶æ›´åŠ å®¹æ˜“ã€‚ </p><br><h3 id="native-over-3rd-party-lib"> æœ¬åœ°è¶…è¿‡ç¬¬ä¸‰æ–¹åº“ </h3><br><p> åç¨‹æ˜¯Kotlinçš„æœ¬åœ°å†…ç½®åŠŸèƒ½ã€‚ </p><br><p> æ‚¨ä¸å¿…æ·»åŠ ä»»ä½•å…¶ä»–ä¾èµ–é¡¹ã€‚ å½“å‰ï¼Œæ‰€æœ‰ä¸»è¦åº“éƒ½å¯ä»¥å¤„ç†åç¨‹ã€‚ </p><br><p> ä¾‹å¦‚ </p><br><p> ç¿»æ–° </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Api</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Get(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"users"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> : List&lt;User&gt; }</code> </pre> <br><p> æˆ¿é—´ </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">UserEntity</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre> <br><p> å› æ­¤ï¼Œæ‚¨å¯ä»¥æ„å»ºä¸€ä¸ªå®Œå…¨æš‚åœçš„åº”ç”¨ç¨‹åº-é€šè¿‡åŸŸå¼€å§‹UIå±‚ï¼Œå¹¶åœ¨æ•°æ®å±‚ç»“æŸã€‚ </p><br><h2 id="app"> è¯¥åº”ç”¨ç¨‹åº </h2><br><p> è®©æˆ‘ä»¬å¼€å§‹åšç”Ÿæ„ã€‚ æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç»å…¸çš„ä¸»ä»åº”ç”¨ç¨‹åºã€‚ <br> ç¬¬ä¸€é¡µå°†åŒ…å«æ— é™çš„äº¤è´§æ¸…å•ã€‚ <br> å•å‡»é¡¹ç›®æ—¶ï¼Œæˆ‘ä»¬å°†æ‰“å¼€ä¸€ä¸ªè¯¦ç»†ä¿¡æ¯é¡µé¢ã€‚ <br> å¦å¤–ï¼Œæˆ‘ä»¬å°†æ”¯æŒç¦»çº¿æ¨¡å¼-æ‰€æœ‰æ•°æ®éƒ½å°†è¢«ç¼“å­˜ã€‚ <br> æ­¤å¤–ï¼Œæˆ‘å°†ä½¿ç”¨MVVMä½“ç³»ç»“æ„ï¼Œå…¶ä¸­Fragmentæ‰®æ¼”ViewModelè§’è‰²ï¼Œè€Œä¸æ˜¯AACæ‰®æ¼”ViewModelè§’è‰²ã€‚ æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š <br> ç‰‡æ®µé€šå¸¸éå¸¸ç§ƒé¡¶-åªéœ€å°†viewModelç»‘å®šåˆ°XMLã€‚ </p><br><p> è¯¸å¦‚è®¾ç½®çŠ¶æ€æ é¢œè‰²ä¹‹ç±»çš„åŠŸèƒ½æ— æ³•åœ¨AAC ViewModelä¸­å®Œæˆ-æ‚¨å¿…é¡»è§¦å‘ç‰‡æ®µçš„æ–¹æ³•ã€‚ å°†ç‰‡æ®µç”¨ä½œViewModelå°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†æ‰€æœ‰ç›¸å…³åŠŸèƒ½ï¼ˆç®¡ç†ä¸€ä¸ªç»™å®šçš„å±å¹•ï¼‰å­˜å‚¨åœ¨ä¸€ä¸ªç±»ä¸­ã€‚ </p><br><p> é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºBaseViewModelï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseViewModel</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">B : BaseBindings, V : ViewDataBinding</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Fragment</span></span></span></span>(), CoroutineScope <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> CoroutineScope(Dispatchers.IO){ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> layoutId: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> bindings: B <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> viewBinding: V <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState) retainInstance = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateView</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(inflater: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LayoutInflater</span></span></span></span><span class="hljs-function"><span class="hljs-params">, container: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ViewGroup</span></span></span></span><span class="hljs-function"><span class="hljs-params">?, savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span>: View? { viewBinding = DataBindingUtil.inflate(inflater, layoutId, container, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> viewBinding.root } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(view: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onViewCreated(view, savedInstanceState) viewBinding.lifecycleOwner = viewLifecycleOwner viewBinding.setVariable(BR.bindings, bindings) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { cancel() <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onDestroy() } }</code> </pre> <br><p> æˆ‘ä»¬å°†ViewModelæ ‡è®°ä¸ºCoroutineScopeï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨è§†å›¾æ¨¡å‹ä¸­å¯åŠ¨åç¨‹ï¼Œå¹¶ä¸”ä»»ä½•å¯åŠ¨çš„åç¨‹éƒ½å°†é™äºç‰‡æ®µçš„ç”Ÿå‘½å‘¨æœŸã€‚ </p><br><p> æˆ‘ä»¬å¿…é¡»æ˜¾å¼æŒ‡å®šä½œç”¨åŸŸç”Ÿå‘½å‘¨æœŸçš„ç»“å°¾ï¼Œè°ƒç”¨<code>cancel()</code>æ–¹æ³•æ¥å–æ¶ˆæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¯·æ±‚ï¼Œä»¥é¿å…å†…å­˜æ³„æ¼ã€‚ </p><br><p> æˆ‘ä»¬è®¾ç½®<code>retainInstance = true</code>ä»¥ä¾¿åœ¨é…ç½®æ›´æ”¹ä¸­ä¸é‡æ–°åˆ›å»ºç‰‡æ®µï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å®Œæˆæ‰€æœ‰é•¿æ—¶é—´è¿è¡Œçš„è¯·æ±‚ã€‚ </p><br><p> å¦å¤–ï¼Œæˆ‘ä»¬å¿…é¡»å°†lifecycleOwnerè®¾ç½®ä¸ºbindingæ‰èƒ½æ‰“å¼€<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åŒå‘æ•°æ®ç»‘å®š</a> ã€‚ </p><br><h2 id="exception-handling"> å¼‚å¸¸å¤„ç† </h2><br><p> æ ¹æ®åç¨‹çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£</a> ï¼š </p><br><pre> <code class="plaintext hljs">Coroutine builders come in two flavors: propagating exceptions automatically (launch and actor) or exposing them to users (async and produce). The former treat exceptions as unhandled, similar to Java's Thread.uncaughtExceptionHandler</code> </pre> <br><p> ç”±äºå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ä½¿ç”¨å¯åŠ¨ç”Ÿæˆå™¨ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æŒ‡å®š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CoroutineExceptionHandler</a> <br>  CoroutineExceptionHandleræ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CoroutineContext.Element</a> ï¼Œå¯ä»¥ä½¿ç”¨åŠ å·è¿ç®—ç¬¦æ¥æ„å»ºä¸€ä¸ªåç¨‹ä¸Šä¸‹æ–‡ã€‚ <br> æˆ‘å°†å£°æ˜é™æ€å¤„ç†ç¨‹åºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> exceptionHandler = CoroutineExceptionHandler { _, throwable -&gt; Timber.e(throwable) }</code> </pre> <br><p> å¹¶æ›´æ”¹BaseViewModelï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseViewModel</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">B : BaseBindings, V : ViewDataBinding</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Fragment</span></span></span></span>(), CoroutineScope <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> CoroutineScope(Dispatchers.IO + exceptionHandler)</code> </pre> <br><p> ä»è¿™é‡Œå¼€å§‹ï¼ŒViewModelèŒƒå›´å†…å¯åŠ¨çš„åç¨‹ä¸­å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸éƒ½å°†ä¼ é€’ç»™ç»™å®šçš„å¤„ç†ç¨‹åºã€‚ <br> æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦å£°æ˜æˆ‘çš„APIå’ŒDAOï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeliveriesApi</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"deliveries"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDeliveries</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"offset"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Query(</span></span></span><span class="hljs-meta-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta"><span class="hljs-meta-string">"limit"</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> limit: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: List&lt;DeliveryResponse&gt; } <span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeliveryDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Query(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SELECT * FROM </span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${DeliveryEntity.TABLE_NAME}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: DataSource.Factory&lt;<span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>, DeliveryEntity&gt; <span class="hljs-meta"><span class="hljs-meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(delivery: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">DeliveryEntity</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘å°†æ–¹æ³•æ ‡è®°ä¸ºå·²æš‚åœï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å£°æ˜é¢„æœŸçš„å“åº”å¯¹è±¡ã€‚ æ­¤å¤–ï¼Œå–æ¶ˆçˆ¶åç¨‹ä¹Ÿä¼šåŒæ—¶å–æ¶ˆç½‘ç»œé€šè¯ã€‚ <br> å¯¹äºDAOä¹Ÿæ˜¯ä¸€æ ·ã€‚ <br> å”¯ä¸€çš„åŒºåˆ«æ˜¯æˆ‘ä»¬è¦æä¾›è§‚å¯Ÿæ•°æ®åº“çš„åŠŸèƒ½ã€‚ <br> æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨å†…ç½®çš„å®æ—¶æ•°æ®æ”¯æŒã€‚ ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å°†getAllï¼ˆï¼‰æ ‡è®°ä¸ºæš‚åœï¼Œåˆ™ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ <br> é”™è¯¯ï¼š </p><br><pre> <code class="plaintext hljs">Not sure how to convert a Cursor to this method's return type ...</code> </pre> <br><p> åœ¨è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦æš‚åœï¼Œå› ä¸ºï¼š </p><br><ul><li> é»˜è®¤æƒ…å†µä¸‹ï¼Œdbè¯·æ±‚åœ¨åå°æ‰§è¡Œ </li><li> ç»“æœLiveDataå…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„è¯†ï¼Œå› æ­¤æˆ‘ä»¬æ— éœ€æ‰‹åŠ¨å–æ¶ˆå®ƒ </li></ul><br><p> æˆ‘ä»¬å¿…é¡»ä»¥æŸç§æ–¹å¼ç»„åˆè¿œç¨‹å’Œæœ¬åœ°æ•°æ®æºã€‚ <br> å€¼å¾—è®°ä½çš„æ˜¯-åº”è¯¥åªæœ‰ä¸€ä¸ªäº‹å®çœŸç›¸ã€‚ <br> æ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¦»çº¿ä¼˜å…ˆè®¾è®¡</a> ï¼Œå®ƒå°†æ˜¯æœ¬åœ°å­˜å‚¨ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†è§‚å¯Ÿæ•°æ®åº“çŠ¶æ€ã€‚ å½“æ²¡æœ‰ä»€ä¹ˆå¯æ£€ç´¢çš„æ—¶ï¼Œæˆ‘ä»¬ä¼šä»è¿œç¨‹è¯¢é—®æ•°æ®å¹¶å°†å…¶æ’å…¥æ•°æ®åº“ã€‚ <br> æˆ‘ä»¬å°†ä»‹ç»Listingç±» </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Listing</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> pagedList: LiveData&lt;PagedList&lt;T&gt;&gt;, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataState: LiveData&lt;DataState&gt;, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> refreshState: LiveData&lt;DataState&gt;, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> refresh: () -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> retry: () -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span> )</code> </pre> <br><p> è®©æˆ‘ä»¬é€ä¸ªå¾ªç¯ï¼š </p><br><ul><li>  pagedList-æ„å»ºä¸ºPagedListçš„ä¸»æ•°æ®ï¼Œä»¥å®ç°æ— é™æ»šåŠ¨ï¼Œå¹¶ä¸LiveDataæ‰“åŒ…åœ¨ä¸€èµ·ä»¥å®ç°æ•°æ®è§‚å¯Ÿ </li><li>  dataState-æˆ‘ä»¬çš„æ•°æ®å¯èƒ½å¤„äºä»¥ä¸‹ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼šæˆåŠŸï¼Œè¿è¡Œï¼Œé”™è¯¯ã€‚ è¿˜åŒ…è£…åˆ°LiveDataä¸­ä»¥è§‚å¯Ÿæ›´æ”¹ </li><li>  refreshState-å½“æˆ‘ä»¬é€šè¿‡åˆ·å¡åˆ·æ–°è§¦å‘æ•°æ®åˆ·æ–°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›å·¥å…·æ¥åŒºåˆ†åˆ·æ–°è¯·æ±‚åé¦ˆå’Œä¸‹ä¸€é¡µè¯·æ±‚åé¦ˆã€‚ å¯¹äºå‰ä¸€ä¸ªï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨åˆ—è¡¨çš„æœ«å°¾æ˜¾ç¤ºä¸€ä¸ªé”™è¯¯ï¼Œä½†æ˜¯å¯¹äºåˆ·æ–°é”™è¯¯ï¼Œæˆ‘ä»¬å¸Œæœ›æ˜¾ç¤ºä¸€ä¸ªåå¸æ¶ˆæ¯å¹¶éšè—ä¸€ä¸ªåŠ è½½å™¨ã€‚ </li><li>  refreshï¼ˆï¼‰-å›è°ƒä»¥åœ¨åˆ·å¡åˆ·æ–°æ—¶è§¦å‘ </li><li><p> é‡è¯•ï¼ˆï¼‰-å›è°ƒä»¥è§¦å‘pagedListåŠ è½½é”™è¯¯ <br> æ¥ä¸‹æ¥ï¼Œåˆ—å‡ºè§†å›¾æ¨¡å‹ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeliveryListViewModel</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseViewModel</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeliveryListBindings, DeliveryListBinding</span></span></span><span class="hljs-class">&gt;</span></span>(), DeliveryListBindings, DeliveryListItemBindings, DeliveryListErrorBindings { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> layoutId: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> = R.layout.delivery_list <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> bindings: DeliveryListBindings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deliveryGateway: DeliveryGateway <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> inject { parametersOf(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> listing = deliveryGateway.getDeliveries() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataState = listing.dataState <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> isRefreshing = Transformations.switchMap(listing.refreshState) { MutableLiveData(it == DataState.Loading) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(view: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onViewCreated(view, savedInstanceState) setupList() setupRefresh() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> adapter = DeliveriesAdapter(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) viewBinding.deliveries.adapter = adapter viewBinding.deliveries.setHasFixedSize(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) listing.pagedList.observe(viewLifecycleOwner, Observer { adapter.submitList(it) }) listing.dataState.observe(viewLifecycleOwner, Observer { adapter.updateDataState(it) }) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupRefresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { listing.refreshState.observe(viewLifecycleOwner, Observer { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> DataState.Error) { Toast.makeText(context, it.message, LENGTH_SHORT).show() } }) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { listing.refresh() } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDeliveryClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(delivery: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Delivery</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { view?.findNavController()?.navigate(DeliveryListViewModelDirections.toDetails(delivery)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onRetryClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { listing.retry() } }</code> </pre> <br><p> è®©æˆ‘ä»¬ä»ç±»å£°æ˜å¼€å§‹ã€‚ </p><br></li></ul><br><p> é¦–å…ˆæ˜¯DeliveryListBindingså’ŒDeliveryListBindingã€‚ é¦–å…ˆæ˜¯æˆ‘ä»¬å£°æ˜çš„æ¥å£ï¼Œç”¨äºå°†è§†å›¾æ¨¡å‹ä¸XMLè§†å›¾ç²˜åˆåœ¨ä¸€èµ·ã€‚ å…¶æ¬¡æ˜¯åŸºäºXMLçš„è‡ªåŠ¨ç”Ÿæˆçš„ç±»ã€‚ æˆ‘ä»¬éœ€è¦ç¬¬äºŒä¸ªå°†ç»‘å®šæ¥å£å’Œç”Ÿå‘½å‘¨æœŸè®¾ç½®ä¸ºXMLã€‚ </p><br><p> æ­¤å¤–ï¼Œä¼˜è‰¯ä½œæ³•æ˜¯ä½¿ç”¨è¿™ç§è‡ªåŠ¨ç”Ÿæˆçš„ç»‘å®šè€Œä¸æ˜¯ä½¿ç”¨Kotlinçš„åˆæˆæ¥å¼•ç”¨è§†å›¾ã€‚ </p><br><p> åœ¨å½“å‰è§†å›¾ä¸­å¯èƒ½ä¸å­˜åœ¨é€šè¿‡ç»¼åˆè§†å›¾å¼•ç”¨çš„æƒ…å†µã€‚ ä½¿ç”¨æ•°æ®ç»‘å®šï¼Œå³ä½¿åœ¨ç¼–è¯‘é˜¶æ®µï¼Œæ‚¨ä¹Ÿä¼šå¿«é€Ÿå¤±è´¥ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œä¸‰ä¸ªæ¥å£ï¼šDeliveryListBindingsï¼ŒDeliveryListItemBindingsï¼ŒDeliveryListErrorBindingsã€‚ </p><br><ol><li>  <em>DeliveryListBindings-</em>å±å¹•æœ¬èº«çš„ç»‘å®šã€‚ ä¾‹å¦‚ï¼Œå®ƒåŒ…å«åœ¨å‚ç›´æ»‘åŠ¨æ—¶è°ƒç”¨çš„refreshï¼ˆï¼‰æ–¹æ³•ã€‚ </li><li>  <em>DeliveryListItemBindings-</em>åˆ—è¡¨ä¸­é¡¹ç›®çš„ç»‘å®šã€‚ ä¾‹å¦‚onClickedï¼ˆï¼‰ </li><li>  <em>DeliveryListErrorBindings-</em>é”™è¯¯è§†å›¾çš„ç»‘å®šï¼Œå®ƒä¹Ÿæ˜¯é”™è¯¯çŠ¶æ€ä¸Šæ˜¾ç¤ºçš„åˆ—è¡¨é¡¹ã€‚ ä¾‹å¦‚ï¼Œå®ƒåŒ…å«retryï¼ˆï¼‰æ–¹æ³• </li></ol><br><p> å› æ­¤ï¼Œæˆ‘ä»¬åœ¨å•è§†å›¾æ¨¡å‹ä¸­å¤„ç†æ‰€æœ‰å†…å®¹ï¼Œå› ä¸ºå®ƒæ˜¯å•ä¸ªå±å¹•ï¼Œä½†ä¹Ÿéµå¾ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ¥å£éš”ç¦»</a>åŸåˆ™ </p><br><p> è®©æˆ‘ä»¬ç‰¹åˆ«æ³¨æ„è¿™ä¸€è¡Œï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deliveryGateway: DeliveryGateway <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> inject { parametersOf(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) }</code> </pre> <br><p>  <em>DeliveryGateway</em>éœ€è¦åœ¨ä¸»çº¿ç¨‹ä¹‹å¤–æ‰§è¡Œè¯·æ±‚ã€‚ å› æ­¤ï¼Œå®ƒéœ€è¦å°†æ–¹æ³•å£°æ˜ä¸ºsuspendedæˆ–CoroutineScopeæ‰èƒ½åœ¨æ­¤èŒƒå›´å†…å¯åŠ¨æ–°çš„åç¨‹ã€‚ æˆ‘ä»¬å°†é€‰æ‹©ç¬¬äºŒç§æ–¹æ³•ï¼Œå› ä¸ºä»ä¸€å¼€å§‹å°±éœ€è¦LiveDataï¼Œç„¶åæˆ‘ä»¬å°†ç­‰å¾…å®ƒçš„æ›´æ–°ã€‚ å½“æˆ‘ä»¬ä¼ é€’lifecycleOwnerï¼ˆé€šå¸¸æŒ‡â€œ thisâ€ï¼‰æ—¶ï¼Œå®ƒä¸è®¢é˜…liveDataå®ä¾‹éå¸¸ç›¸ä¼¼ã€‚ è¿™ä¸æˆ‘ä»¬é€šè¿‡CoroutineScopeä¼ é€’â€œ thisâ€çš„æ–¹å¼ç›¸åŒ </p><br><p>  CoroutineScopeæ¥å£åŒ…å«ä¸€ä¸ªå”¯ä¸€å­—æ®µ-CoroutineContextã€‚ æœ¬è´¨ä¸Šï¼ŒèŒƒå›´å’Œä¸Šä¸‹æ–‡æ˜¯ç›¸åŒçš„ä¸œè¥¿ã€‚ ä¸Šä¸‹æ–‡å’ŒèŒƒå›´ä¹‹é—´çš„åŒºåˆ«åœ¨äºå®ƒä»¬çš„é¢„æœŸç›®çš„ã€‚ </p><br><p> è¦äº†è§£æœ‰å…³æ­¤å†…å®¹çš„æ›´å¤šä¿¡æ¯ï¼Œæˆ‘å°†æ¨èRoman Elizarovçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a> ã€‚ å› æ­¤ï¼Œå‘<em>DeliveryGateway</em>æä¾›èŒƒå›´ä¹Ÿå°†å¯¼è‡´ä½¿ç”¨ç›¸åŒçš„ä¸Šä¸‹æ–‡ã€‚ ç‰¹åˆ«æ˜¯çº¿ç¨‹ï¼Œä½œä¸šå’Œå¼‚å¸¸å¤„ç†ç¨‹åºã€‚ <br> ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹DeliveryGatewayæœ¬èº«ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeliveryBoundGateway</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db: DataBase, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> api: DeliveriesApi, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deliveryDao: DeliveryDao, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> coroutineScope: CoroutineScope ) : DeliveryGateway { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> boundaryCallback = DeliveriesBoundaryCallback( api = api, coroutineScope = coroutineScope, handleResponse = { insertIntoDatabase(it) } ) <span class="hljs-meta"><span class="hljs-meta">@MainThread</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDeliveries</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Listing&lt;Delivery&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> refreshTrigger = MutableLiveData&lt;<span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span>&gt;() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> refreshState = Transformations.switchMap(refreshTrigger) { refresh() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> pagingConfig = Config( initialLoadSizeHint = PAGE_SIZE, pageSize = PAGE_SIZE, prefetchDistance = PAGE_SIZE ) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deliveries = deliveryDao.getAll() .toLiveData( config = pagingConfig, boundaryCallback = boundaryCallback ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Listing( pagedList = deliveries, dataState = boundaryCallback.dataState, retry = { boundaryCallback.helper.retryAllFailed() }, refresh = { refreshTrigger.value = <span class="hljs-literal"><span class="hljs-literal">null</span></span> }, refreshState = refreshState ) } <span class="hljs-comment"><span class="hljs-comment">/** * When refresh is called, we simply run a fresh network request and when it arrives, clear * the database table and insert all new items in a transaction. * &lt;p&gt; * Since the PagedList already uses a database bound data source, it will automatically be * updated after the database transaction is finished. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@MainThread</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: LiveData&lt;DataState&gt; { boundaryCallback.refresh() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataState = MutableLiveData&lt;DataState&gt;() dataState.value = DataState.Loading coroutineScope.launch { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deliveries = api.getDeliveries(<span class="hljs-number"><span class="hljs-number">0</span></span>, PAGE_SIZE) db.withTransaction { deliveryDao.clear() insertIntoDatabase(deliveries) } dataState.postValue(DataState.Loaded) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (throwable: Throwable) { Timber.w(throwable) dataState.postValue(DataState.Error(throwable.message)) } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataState } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertIntoDatabase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(deliveries: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">List</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">DeliveryResponse</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { deliveries.forEach { delivery -&gt; <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> entity = deliveryConverter.fromNetwork(delivery) deliveryDao.insert(entity) } } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> PAGE_SIZE = <span class="hljs-number"><span class="hljs-number">20</span></span> } }</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»å¤´å¼€å§‹æ„å»ºLiveDataç»“æ„ï¼Œç„¶åä½¿ç”¨åç¨‹åŠ è½½æ•°æ®å¹¶å°†å…¶å‘å¸ƒåˆ°LiveDataã€‚ å¦å¤–ï¼Œæˆ‘ä»¬ä½¿ç”¨<em>PagedList.BoundaryCallbackï¼ˆï¼‰</em>çš„å®ç°<em>æ¥ç²˜åˆæœ¬åœ°æ•°æ®åº“å’Œè¿œç¨‹APIã€‚</em>  <em>å½“æˆ‘ä»¬åˆ°è¾¾é¡µé¢åˆ—è¡¨çš„æœ«å°¾æ—¶ï¼Œä¼šè§¦å‘borderCallbackå¹¶åŠ è½½ä¸‹ä¸€ä¸ªæ•°æ®å—ã€‚</em> <br></p><p> å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨coroutineScopeå¯åŠ¨æ–°çš„åç¨‹ã€‚ </p><br><p> ç”±äºæ­¤ä½œç”¨åŸŸç­‰äºç‰‡æ®µçš„ç”Ÿå‘½å‘¨æœŸ-æ‰€æœ‰å¾…å¤„ç†çš„è¯·æ±‚éƒ½å°†åœ¨ç‰‡æ®µçš„<code>onDestroy()</code>å›è°ƒä¸­è¢«å–æ¶ˆã€‚ </p><br><p> äº¤ä»˜è¯¦ç»†ä¿¡æ¯é¡µé¢éå¸¸ç®€å•-æˆ‘ä»¬åªéœ€ä½¿ç”¨å¯¼èˆªç»„ä»¶save argsæ’ä»¶ä»ä¸»å±å¹•ä¼ é€’ä¸€ä¸ªParcelableäº¤ä»˜å¯¹è±¡ã€‚ åœ¨è¯¦ç»†ä¿¡æ¯å±å¹•ä¸Šï¼Œåªéœ€å°†ç»™å®šçš„å¯¹è±¡ç»‘å®šåˆ°XMLã€‚ </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeliveryViewModel</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseViewModel</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DeliveryBindings, DeliveryBinding</span></span></span><span class="hljs-class">&gt;</span></span>(), DeliveryBindings { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> layoutId: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> = R.layout.delivery <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> bindings: DeliveryBindings = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> args: DeliveryViewModelArgs <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> navArgs() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onViewCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(view: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">View</span></span></span></span><span class="hljs-function"><span class="hljs-params">, savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onViewCreated(view, savedInstanceState) viewBinding.delivery = args.delivery viewBinding.image.clipToOutline = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> <br><h2 id="contact-me"> ä¸æˆ‘è”ç»œ </h2><br><p> è¿™æ˜¯githubæºä»£ç çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é“¾æ¥</a> ã€‚ </p><br><p> æ¬¢è¿æ‚¨å‘è¡¨è¯„è®ºå’Œæå‡ºé—®é¢˜ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN465529/">https://habr.com/ru/post/zh-CN465529/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN465519/index.html">å±•è§ˆPRO // Movement.Expo</a></li>
<li><a href="../zh-CN465521/index.html">é£èŠ±ç“£...æˆ–å…³äºUXè®¾è®¡å¸ˆå¦‚ä½•åœ¨Instagramä¸Šæ¨å¹¿å…¶äº§å“çš„æ•…äº‹</a></li>
<li><a href="../zh-CN465523/index.html">å¦ä¸€ä¸ªå¸¦æœ‰Kivyï¼ŒPythonçš„Androidè›‡</a></li>
<li><a href="../zh-CN465525/index.html">å…³äºOracle BI EE 12cçš„ç§»åŠ¨æŠ¥å‘Š-ä¸€ï¼ŒäºŒï¼Œä¸‰ã€‚ Oracle BI EE 12c CADè¯¾ç¨‹ä¸­çš„æ–¹æ³•è®º</a></li>
<li><a href="../zh-CN465527/index.html">ä»RFC 4357åˆ°RFC 8645çš„æ¼«é•¿æ—…ç¨‹æˆ–å¦‚ä½•ç®¡ç†åŠ å¯†å¯†é’¥</a></li>
<li><a href="../zh-CN465531/index.html">è§£å¼€ä¸ç¡®å®šæ·±åº¦çš„åµŒå¥—åˆ—è¡¨</a></li>
<li><a href="../zh-CN465535/index.html">è°å®æ–½IPv6ï¼Œä»€ä¹ˆé˜»ç¢äº†IPv6çš„å‘å±•</a></li>
<li><a href="../zh-CN465537/index.html">Yandexï¼šæˆäººæ™ºèƒ½å®¶å±…</a></li>
<li><a href="../zh-CN465539/index.html">766å…¬é‡Œ-LoRaWANçš„æ–°é‡Œç¨‹è®°å½•</a></li>
<li><a href="../zh-CN465541/index.html">ä»ä¼ä¸šåˆ°ä¸­å°å‹ä¼ä¸šï¼šæˆ‘ä»¬åˆ†äº«ä½¿ç”¨SaaSæ¨¡å‹é€šè¿‡è´§å¸åŒ–ä¸ºä¸­å°ä¼ä¸šè°ƒæ•´ä¼ä¸šè§£å†³æ–¹æ¡ˆçš„ç»éªŒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>