<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💰 🙇 🌨️ PVS-Studio passe aux nuages ​​- lancement de l'analyse sur Travis CI 👴🏻 🍓 👚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="À l'heure actuelle, les systèmes cloud CI sont un service très populaire. Dans cet article, nous expliquerons comment, en utilisant les outils existan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PVS-Studio passe aux nuages ​​- lancement de l'analyse sur Travis CI</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/458072/">  À l'heure actuelle, les systèmes cloud CI sont un service très populaire.  Dans cet article, nous expliquerons comment, en utilisant les outils existants disponibles dans PVS-Studio, vous pouvez intégrer l'analyse de code source à la plate-forme cloud CI, en utilisant le service Travis CI à titre d'exemple. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ee1/252/191/ee125219104f0ff7d27f8c9dfc2db8bf.png" alt="Image 1"></div><br><a name="habracut"></a><br>  Pourquoi examinons-nous des clouds tiers et ne créons-nous pas les nôtres?  Il existe un certain nombre de raisons, et la principale est que le SaaS est une procédure assez coûteuse et difficile.  En fait, l'intégration directe de l'analyse PVS-Studio avec une plate-forme cloud tierce (qu'il s'agisse de plates-formes ouvertes comme CircleCI, Travis CI, GitLab ou d'une solution d'entreprise spécialisée utilisée dans une seule entreprise spécifique) est une tâche assez simple et triviale.  Autrement dit, nous pouvons dire que <i>PVS-Studio est déjà disponible «dans les nuages»</i> .  Un problème complètement différent est l'organisation et la fourniture d'infrastructures pour un tel travail 24/7.  Il s'agit d'une tâche complètement différente, et PVS-Studio n'a pas l'intention de fournir sa propre plate-forme cloud directement pour exécuter une analyse sur celle-ci. <br><br>
<h2>  Informations sur le logiciel utilisé </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Travis CI</a> est un service de création et de test de logiciels qui utilise GitHub comme stockage.  Travis CI ne nécessite pas de changer le code du programme pour utiliser le service, tous les paramètres se produisent dans le fichier <i>.travis.yml</i> situé à la racine du référentiel. <br><br>  Nous prendrons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LXC</a> (Linux Containers) comme projet de test pour tester avec PVS-Studio.  Il s'agit d'un système de virtualisation au niveau du système d'exploitation pour exécuter plusieurs instances du système d'exploitation Linux sur un seul nœud. <br><br>  Le projet est petit, mais plus que suffisant pour le démontrer.  La sortie de la commande cloc: <br><div class="scrollable-table"><table><tbody><tr><td>  La langue <br></td><td>  les fichiers <br></td><td>  vierge <br></td><td>  commenter <br></td><td>  code <br></td></tr><tr><td>  C <br></td><td>  124 <br></td><td>  11937 <br></td><td>  6758 <br></td><td>  50836 <br></td></tr><tr><td>  En-tête C / C ++ <br></td><td>  65 <br></td><td>  1117 <br></td><td>  3676 <br></td><td>  3774 <br></td></tr></tbody></table></div>  <b>Remarque: Les</b> développeurs LXC utilisent déjà Travis CI, nous allons donc prendre leur fichier de configuration comme base et le modifier pour nos besoins. <br><br><h2>  Personnalisation </h2><br>  Pour commencer avec Travis CI, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">suivez le lien</a> et authentifiez-vous en utilisant un compte GitHub. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1ba/8fc/c5a/1ba8fcc5a0caf41da255093cf4feaa8e.png" alt="Image 17"></div><br>  Dans la fenêtre qui s'ouvre, vous devez autoriser Travis CI. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d7/aec/13d/2d7aec13dec45022c952ff0498a6acae.png" alt="Image 16"></div><br>  Après autorisation, une redirection vers la page d'accueil «Première fois ici?  Permet de commencer! ”  <b>,</b> qui décrit brièvement ce qui doit être fait ensuite pour commencer: <br><br><ul><li>  activer les référentiels; </li><li>  ajoutez le fichier .travis.yml au référentiel; </li><li>  exécutez la première version. </li></ul><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/29c/17f/c83/29c17fc830db9fad9d6d9dcb7fa047d7.png" alt="Image 18"></div><br>  Nous allons commencer à réaliser ces points. <br><br>  Pour ajouter notre référentiel à Travis CI, accédez aux paramètres du profil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">via le lien</a> et cliquez sur le bouton "Activer". <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab8/1f7/75e/ab81f775edc51c92b3238bf30b40527d.png" alt="Image 19"></div><br>  Après avoir cliqué, une fenêtre s'ouvre avec un choix de référentiels auxquels l'application Travis CI aura accès. <br>  <b>Remarque:</b> pour donner accès au référentiel, le compte doit disposer de droits d'administrateur sur celui-ci. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1e8/4fe/351/1e84fe351a57fcff37b5b70ec77e9cc5.png" alt="Image 38"></div><br>  Nous sélectionnons le référentiel souhaité, confirmons la sélection avec le bouton "Approuver et installer", et nous serons redirigés vers la page des paramètres de profil. <br><br>  Créez immédiatement les variables que nous utiliserons pour créer le fichier de licence de l'analyseur et envoyer ses rapports.  Pour ce faire, accédez à la page des paramètres - le bouton «Paramètres» à droite du référentiel souhaité. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d35/f44/907/d35f449074bd079c1b35140dd8336173.png" alt="Image 39"></div><br>  La fenêtre des paramètres s'ouvre. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cfe/c5f/1a8/cfec5f1a8ea19bf2c6e9e63c7af4c68c.png" alt="Image 41"></div><br>  Brève description des paramètres: <br><br><ul><li>  Section "Général" - définition des déclencheurs pour les tâches d'exécution automatique; </li><li>  Section "Annulation automatique" - vous permet de configurer l'assemblage d'annulation automatique; </li><li>  Section "Variables d'environnement" - vous permet de définir des variables d'environnement contenant à la fois des informations publiques et confidentielles, telles que les informations d'identification, les clés ssh; </li><li>  Section «Cron Jobs» - définition du calendrier de lancement des tâches. </li></ul><br>  Dans la section "Variables d'environnement", nous créons les variables <i>PVS_USERNAME</i> et <i>PVS_KEY</i> contenant respectivement le nom d'utilisateur et la clé de licence pour l'analyseur statique.  Si vous ne disposez pas d'une licence PVS-Studio permanente, vous pouvez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">demander une licence d'essai</a> . <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8aa/731/483/8aa731483fc391273980c7de338f83be.png" alt="Image 5"></div><br>  Créez immédiatement les variables <i>MAIL_USER</i> et <i>MAIL_PASSWORD</i> contenant le nom d'utilisateur et le mot de passe de la boîte aux lettres, que nous utiliserons pour envoyer des rapports. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/37d/a42/9b4/37da429b49812239ab900e3b6fe5a90d.png" alt="Image 4"></div><br>  Lorsque la tâche est lancée, Travis CI prend les instructions du fichier .travis.yml situé à la racine du référentiel. <br><br>  À l'aide de Travis CI, nous pouvons exécuter une analyse statique directement dans la machine virtuelle, ou utiliser un conteneur préconfiguré pour cela.  Les résultats de ces approches ne sont pas différents les uns des autres, mais l'utilisation d'un conteneur préconfiguré peut être utile, par exemple, si nous avons déjà un conteneur avec un environnement spécifique dans lequel le produit logiciel est construit et testé, et qu'il n'y a pas de désir de restaurer cet environnement dans Travis CI . <br><br>  Créons une configuration pour exécuter l'analyseur dans une machine virtuelle. <br><br>  Pour l'assemblage et les tests, nous utiliserons une machine virtuelle basée sur Ubuntu Trusty, sa description peut être trouvée <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Tout d'abord, nous indiquons que le projet est écrit en C et nous listons les compilateurs que nous utiliserons pour l'assemblage: <br><br><pre><code class="cpp hljs">language: c compiler: - gcc - clang</code> </pre> <br>  <b>Remarque</b> : si vous spécifiez plusieurs compilateurs, les tâches seront lancées en parallèle pour chacun d'entre eux.  En savoir plus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dans la documentation</a> . <br><br>  Avant de commencer la construction, nous devons ajouter le référentiel d'analyseur, installer les dépendances et les packages supplémentaires: <br><br><pre> <code class="cpp hljs">before_install: - sudo add-apt-repository ppa:ubuntu-lxc/daily -y - wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - - sudo wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list - sudo apt-get update -qq - sudo apt-get install -qq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates</span></span></code> </pre> <br>  Avant de construire le projet, vous devez préparer l'environnement: <br><br><pre> <code class="cpp hljs">script: - ./coccinelle/run-coccinelle.sh -i - git diff --<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>-code - <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> CFLAGS=<span class="hljs-string"><span class="hljs-string">"-Wall -Werror"</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LDFLAGS=<span class="hljs-string"><span class="hljs-string">"-pthread -lpthread"</span></span> - ./autogen.sh - rm -Rf build - mkdir build - cd build - ../configure --enable-tests --with-distro=unknown</code> </pre> <br>  Ensuite, nous devons créer un fichier avec une licence et exécuter une analyse de projet. <br><br>  La première commande crée un fichier de licence pour l'analyseur.  Les données des variables <i>$ PVS_USERNAME</i> et <i>$ PVS_KEY</i> sont extraites des paramètres du projet. <br><br><pre> <code class="cpp hljs">- pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic</code> </pre> <br>  La commande suivante démarre la trace de l'assembly du projet: <br><br><pre> <code class="cpp hljs">- pvs-studio-analyzer trace -- make -j4</code> </pre> <br>  Après avoir commencé l'analyse statique. <br>  <b>Remarque:</b> lorsque vous utilisez une licence d'essai, vous devez spécifier le paramètre <i>--disableLicenseExpirationCheck</i> . <br><br><pre> <code class="cpp hljs"> - pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> –-disableLicenseExpirationCheck</code> </pre> <br>  Avec la dernière commande, le fichier de résultats de l'analyseur est converti en rapport html. <br><br><pre> <code class="cpp hljs">- plog-converter -t html PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> -o PVS-Studio-${CC}.html</code> </pre> <br>  Étant donné que TravisCI ne permet pas de modifier le format des notifications par e-mail, nous utiliserons le package sendemail pour envoyer des rapports à la dernière étape: <br><br><pre> <code class="cpp hljs">- sendemail -t mail@domain.com -u <span class="hljs-string"><span class="hljs-string">"PVS-Studio $CC report, commit:$TRAVIS_COMMIT"</span></span> -m <span class="hljs-string"><span class="hljs-string">"PVS-Studio $CC report, commit:$TRAVIS_COMMIT"</span></span> -s smtp.gmail.com:<span class="hljs-number"><span class="hljs-number">587</span></span> -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> PVS-Studio-${CC}.html</code> </pre> <br>  Texte complet du fichier de configuration pour exécuter l'analyseur dans une machine virtuelle: <br><br><pre> <code class="cpp hljs">language: c compiler: - gcc - clang before_install: - sudo add-apt-repository ppa:ubuntu-lxc/daily -y - wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - - sudo wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list - sudo apt-get update -qq - sudo apt-get install -qq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates script: - ./coccinelle/run-coccinelle.sh -i - git diff --exit-code - export CFLAGS="-Wall -Werror" - export LDFLAGS="-pthread -lpthread" - ./autogen.sh - rm -Rf build - mkdir build - cd build - ../configure --enable-tests --with-distro=unknown - pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic - pvs-studio-analyzer trace -- make -j4 - pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-${CC}.log --disableLicenseExpirationCheck - plog-converter -t html PVS-Studio-${CC}.log -o PVS-Studio-${CC}.html - sendemail -t mail@domain.com -u "PVS-Studio $CC report, commit:$TRAVIS_COMMIT" -m "PVS-Studio $CC report, commit:$TRAVIS_COMMIT" -s smtp.gmail.com:587 -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.log PVS-Studio-${CC}.html</span></span></code> </pre> <br>  Pour exécuter un analyseur statique dans un conteneur, créez-le d'abord à l'aide du Dockerfile suivant: <br><br><pre> <code class="cpp hljs">FROM docker.io/ubuntu:trusty ENV CFLAGS=<span class="hljs-string"><span class="hljs-string">"-Wall -Werror"</span></span> ENV LDFLAGS=<span class="hljs-string"><span class="hljs-string">"-pthread -lpthread"</span></span> RUN apt-get update &amp;&amp; apt-get install -y software-properties-common wget \ &amp;&amp; wget -q -O - https:<span class="hljs-comment"><span class="hljs-comment">//files.viva64.com/etc/pubkey.txt | sudo apt-key add - \ &amp;&amp; wget -O /etc/apt/sources.list.d/viva64.list https://files.viva64.com/etc/viva64.list \ &amp;&amp; apt-get update \ &amp;&amp; apt-get install -yqq coccinelle parallel libapparmor-dev libcap-dev libseccomp-dev python3-dev python3-setuptools docbook2x libgnutls-dev libselinux1-dev linux-libc-dev pvs-studio git libtool autotools-dev automake pkg-config clang make libio-socket-ssl-perl libnet-ssleay-perl sendemail ca-certificates \ &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span></code> </pre> <br>  Dans ce cas, le fichier de configuration peut ressembler à ceci: <br><br><pre> <code class="cpp hljs">before_install: - docker pull docker.io/oandreev/lxc env: - CC=gcc - CC=clang script: - docker run --rm --cap-add SYS_PTRACE -v $(pwd):/pvs -w /pvs docker.io/oandreev/lxc /bin/bash -c <span class="hljs-string"><span class="hljs-string">" ./coccinelle/run-coccinelle.sh -i &amp;&amp; git diff --exit-code &amp;&amp; ./autogen.sh &amp;&amp; mkdir build &amp;&amp; cd build &amp;&amp; ../configure CC=$CC &amp;&amp; pvs-studio-analyzer credentials $PVS_USERNAME $PVS_KEY -o PVS-Studio.lic &amp;&amp; pvs-studio-analyzer trace -- make -j4 &amp;&amp; pvs-studio-analyzer analyze -j2 -l PVS-Studio.lic -o PVS-Studio-$CC.log --disableLicenseExpirationCheck &amp;&amp; plog-converter -t html -o PVS-Studio-$CC.html PVS-Studio-$CC.log &amp;&amp; sendemail -t mail@domain.com -u 'PVS-Studio $CC report, commit:$TRAVIS_COMMIT' -m 'PVS-Studio $CC report, commit:$TRAVIS_COMMIT' -s smtp.gmail.com:587 -xu $MAIL_USER -xp $MAIL_PASSWORD -o tls=yes -f $MAIL_USER -a PVS-Studio-${CC}.log PVS-Studio-${CC}.html"</span></span></code> </pre> <br>  Comme vous pouvez le voir, dans ce cas, nous ne faisons rien à l'intérieur de la machine virtuelle, et absolument toutes les actions d'assemblage et de test du projet ont lieu à l'intérieur du conteneur. <br><br>  <b>Remarque</b> : lors du démarrage du conteneur, vous devez spécifier le <i>paramètre --cap-add SYS_PTRACE</i> ou <i>--security-opt seccomp: unconfined</i> , car l'appel système ptrace est utilisé pour compiler la trace. <br><br>  Nous chargeons le fichier de configuration à la racine du référentiel et constatons que Travis CI a reçu une notification de la présence de modifications dans le projet et a automatiquement démarré l'assemblage. <br><br>  Des informations détaillées sur la progression de l'assemblage et la vérification par l'analyseur peuvent être consultées dans la console. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/00a/846/95d/00a84695de9e00013c89760219f5292e.png" alt="Image 2"></div><br>  Une fois les tests terminés, nous recevrons 2 lettres par la poste: l'une contenant les résultats de l'analyse statique pour la construction du projet à l'aide de gcc et la seconde avec clang, respectivement. <br><br><h2>  En bref sur les résultats des tests </h2><br>  En général, le projet est assez propre, l'analyseur n'a émis que 24 avertissements critiques et 46 avertissements moyens.  Pour démontrer le travail, considérez quelques notifications intéressantes: <br><br><h3>  Conditions redondantes dans if </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V590</a> Envisagez d'inspecter l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">expression</a> «ret! = (- 1) &amp;&amp; ret == 1».  L'expression est excessive ou contient une erreur d'impression.  attach.c 107 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> EOF -1 static struct lxc_proc_context_info *lxc_proc_get_context_info(pid_t pid) { .... while (getline(&amp;</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">, &amp;line_bufsz, proc_file) != -1) { ret = sscanf(</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CapBnd: %llx"</span></span></span><span class="hljs-meta">, &amp;info-&gt;capability_mask); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ret != EOF &amp;&amp; ret == 1) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// &lt;= { found = true; break; } } .... }</span></span></span></span></code> </pre> <br>  Si <i>ret == 1</i> , alors il n'est certainement pas égal à -1 (EOF).  Validation excessive, <i>ret! = EOF</i> peut être supprimé. <br><br>  Deux autres avertissements ont été émis: <br><br><ul><li>  V590 Envisagez d'inspecter l'expression «ret! = (- 1) &amp;&amp; ret == 1».  L'expression est excessive ou contient une erreur d'impression.  attach.c 579 </li><li>  V590 Envisagez d'inspecter l'expression «ret! = (- 1) &amp;&amp; ret == 1».  L'expression est excessive ou contient une erreur d'impression.  attach.c 583 </li></ul><br><h3>  Perte de bits hauts </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V784</a> La taille du masque de bits est inférieure à la taille du premier opérande.  Cela entraînera la perte de bits supérieurs.  conf.c 1879 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mount_opt</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *name; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> clear; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> flag; }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_mntopt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *opt, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mount_opt</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* If opt is found in mount_opt, set or clear flags. * Otherwise append it to data. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (mo = &amp;mount_opt[<span class="hljs-number"><span class="hljs-number">0</span></span>]; mo-&gt;name != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; mo++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span>(opt, mo-&gt;name, <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(mo-&gt;name)) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mo-&gt;clear) { *flags &amp;= ~mo-&gt;flag; <span class="hljs-comment"><span class="hljs-comment">// &lt;= } else { *flags |= mo-&gt;flag; } return; } } .... }</span></span></code> </pre> <br>  Sous Linux, <i>long</i> est une variable entière 64 bits, <i>mo-&gt; flag</i> est une variable entière 32 bits.  L'utilisation de l' <i>indicateur mo-&gt;</i> comme masque de bits entraînera la perte des 32 bits les plus significatifs.  La conversion implicite du masque binaire en une variable entière 64 bits après l'inversion au niveau du bit est effectuée.  Les bits hauts de ce masque seront nuls. <br><br>  Démontrez avec un exemple: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> y; .... x &amp;= ~y;</code> </pre> <br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1a3/59f/a71/1a359fa7163d8a99c8632ffc17cf7eb0.png" alt="Image 3"></div><br><br>  Le bon code est: <br><br><pre> <code class="cpp hljs">*flags &amp;= ~(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(mo-&gt;flag);</code> </pre> <br>  L'analyseur a émis un autre avertissement similaire: <br><br><ul><li>  V784 La taille du masque de bits est inférieure à la taille du premier opérande.  Cela entraînera la perte de bits supérieurs.  conf.c 1933 </li></ul><br><h3>  Cycle suspect </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V612</a> Un «retour» inconditionnel dans une boucle.  conf.c 3477 <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> lxc_list_for_each(__iterator, __list) \ for (__iterator = (__list)-&gt;next; __iterator != __list; \ __iterator = __iterator-&gt;next) static bool verify_start_hooks(struct lxc_conf *conf) { char path[PATH_MAX]; struct lxc_list *it; lxc_list_for_each (it, &amp;conf-&gt;hooks[LXCHOOK_START]) { int ret; char *hookname = it-&gt;elem; ret = snprintf(path, PATH_MAX, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s%s"</span></span></span><span class="hljs-meta">, conf-&gt;rootfs.path ? conf-&gt;rootfs.mount : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">, hookname); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ret </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; 0 || ret &gt;= PATH_MAX) return false; ret = access(path, X_OK); if (ret &lt; 0) { SYSERROR("Start hook \"%s\" not found in container", hookname); return false; } return true; // &lt;= } return true; }</span></span></span></span></code> </pre> <br>  Le cycle démarre et à la première itération il est interrompu.  Peut-être que c'était prévu, mais alors le cycle peut être omis. <br><br><h3>  Hors limites </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V557 Le</a> sous-ensemble de la baie est possible.  La valeur de l'index «octets - 1» pourrait atteindre -1.  network.c 2570 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lxc_create_network_unpriv_exec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lxcpath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lxcname, struct lxc_netdev *netdev, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hooks_version)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytes; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buffer[PATH_MAX] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; .... bytes = lxc_read_nointr(pipefd[<span class="hljs-number"><span class="hljs-number">0</span></span>], &amp;buffer, PATH_MAX); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { SYSERROR(<span class="hljs-string"><span class="hljs-string">"Failed to read from pipe file descriptor"</span></span>); close(pipefd[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { buffer[bytes - <span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; } .... }</code> </pre> <br>  Les octets sont lus du tube dans le tampon.  En cas d'erreur, la fonction <i>lxc_read_nointr</i> retournera une valeur négative.  Si tout s'est bien passé, le terminal nul est écrit comme dernier élément.  Cependant, si 0 octet est lu, le tampon sortira des limites, ce qui entraînera un comportement indéfini. <br><br>  L'analyseur a émis un autre avertissement similaire: <br><br><ul><li>  V557 Le sous-ensemble de la baie est possible.  La valeur de l'index «octets - 1» pourrait atteindre -1.  network.c 2725 </li></ul><br><h3>  Débordement de tampon </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">V576</a> Format incorrect.  Pensez à vérifier le troisième argument réel de la fonction 'sscanf'.  Il est dangereux d'utiliser un spécificateur de chaîne sans spécification de largeur.  Un débordement de tampon est possible.  lxc_unshare.c 205 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lookup_user</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *oparg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *uid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> name[PATH_MAX]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(oparg, <span class="hljs-string"><span class="hljs-string">"%u"</span></span>, uid) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* not a uid -- perhaps a username */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(oparg, <span class="hljs-string"><span class="hljs-string">"%s"</span></span>, name) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { free(buf); return false; } .... } .... }</span></span></code> </pre> <br>  L'utilisation de <i>sscanf</i> dans ce cas peut être dangereuse, car si la longueur du tampon <i>oparq</i> est supérieure à la longueur du tampon de <i>nom</i> , il ira à l'étranger lorsque le tampon de <i>nom</i> sera formé. <br><br><h2>  Conclusion </h2><br>  Comme nous l'avons vu, la mise en place d'une vérification d'analyseur de code statique de notre projet dans le cloud est une tâche assez simple.  Pour ce faire, il vous suffit d'ajouter un fichier au référentiel et de passer le minimum de temps à configurer le système CI.  Par conséquent, nous obtenons un outil qui vous permet d'identifier le code problématique au stade de l'écriture et ne permet pas aux erreurs de passer aux étapes suivantes du test, où leur correction prendra plus de temps et de ressources. <br><br>  Bien sûr, l'utilisation de PVS-Studio avec des plates-formes cloud n'est pas limitée à Travis CI.  Par analogie avec la méthode décrite dans l'article, avec des différences minimes, l'analyse PVS-Studio peut être intégrée à d'autres solutions CI populaires basées sur le cloud, telles que CircleCI, GitLab, etc. <br><br><h2>  Liens utiles </h2><br><ul><li>  Des informations supplémentaires sur le lancement de PVS-Studio sur Linux et MacOS peuvent être trouvées <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </li><li>  Vous pouvez lire ici comment créer, configurer et utiliser des conteneurs avec l'analyseur statique PVS-Studio installé. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation TravisCI</a> . </li></ul><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/898/3b6/5a7/8983b65a74adb29a2113eba12fbec3f1.png" align="left"></a> </p><br><br>  Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: Oleg Andreev.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PVS-Studio dans les nuages ​​- Exécution de l'analyse sur Travis CI</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458072/">https://habr.com/ru/post/fr458072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458060/index.html">Création d'un shader d'herbe dans le moteur Unity</a></li>
<li><a href="../fr458062/index.html">Présentation de la plateforme UserGate</a></li>
<li><a href="../fr458064/index.html">PVS-Studio dans les nuages ​​- Exécution de l'analyse sur Travis CI</a></li>
<li><a href="../fr458068/index.html">PVS-Studio pour Visual Studio</a></li>
<li><a href="../fr458070/index.html">PVS-Studio pour Visual Studio</a></li>
<li><a href="../fr458074/index.html">Aller langue: sélection ORM</a></li>
<li><a href="../fr458076/index.html">Marketing avec prise de décision ML</a></li>
<li><a href="../fr458080/index.html">25 juillet, Moscou - Meetup QIWI iOS</a></li>
<li><a href="../fr458084/index.html">50 matériaux sélectionnés sur les gains des musiciens, le son dans les jeux et les films, les instruments inhabituels et les vieux oubliés</a></li>
<li><a href="../fr458088/index.html">Meilleures distributions Linux pour les ordinateurs plus anciens</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>