<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â˜˜ï¸ âš°ï¸ ğŸ˜± .NETå¤šçº¿ç¨‹ï¼šç¼ºä¹æ€§èƒ½æ—¶ ğŸ¦‘ ğŸ¤±ğŸ¼ ğŸ“±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=".NETå¹³å°æä¾›äº†è®¸å¤šé¢„æ„å»ºçš„åŒæ­¥åŸè¯­å’Œçº¿ç¨‹å®‰å…¨çš„é›†åˆã€‚ ä¾‹å¦‚ï¼Œå¦‚æœåœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶éœ€è¦å®ç°çº¿ç¨‹å®‰å…¨çš„ç¼“å­˜æˆ–è¯·æ±‚é˜Ÿåˆ—ï¼Œåˆ™é€šå¸¸ä½¿ç”¨è¿™äº›ç°æˆçš„è§£å†³æ–¹æ¡ˆï¼Œæœ‰æ—¶ä¸€æ¬¡ä½¿ç”¨å¤šä¸ªè§£å†³æ–¹æ¡ˆã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼šé•¿æ—¶é—´ç­‰å¾…é”ï¼Œè¿‡å¤šçš„å†…å­˜æ¶ˆè€—å’Œæ¼«é•¿çš„åƒåœ¾å›æ”¶ã€‚ 

 å¦‚æœè€ƒè™‘åˆ°æ ‡å‡†è§£å†³æ–¹æ¡ˆçš„é€šç”¨æ€§ï¼Œåˆ™å¯ä»¥...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>.NETå¤šçº¿ç¨‹ï¼šç¼ºä¹æ€§èƒ½æ—¶</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/468611/"><img src="https://habrastorage.org/webt/rn/su/tj/rnsutjjvg7sllluahknu8brlnbc.jpeg"><br><br>  .NETå¹³å°æä¾›äº†è®¸å¤šé¢„æ„å»ºçš„åŒæ­¥åŸè¯­å’Œçº¿ç¨‹å®‰å…¨çš„é›†åˆã€‚ ä¾‹å¦‚ï¼Œå¦‚æœåœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶éœ€è¦å®ç°çº¿ç¨‹å®‰å…¨çš„ç¼“å­˜æˆ–è¯·æ±‚é˜Ÿåˆ—ï¼Œåˆ™é€šå¸¸ä½¿ç”¨è¿™äº›ç°æˆçš„è§£å†³æ–¹æ¡ˆï¼Œæœ‰æ—¶ä¸€æ¬¡ä½¿ç”¨å¤šä¸ªè§£å†³æ–¹æ¡ˆã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼šé•¿æ—¶é—´ç­‰å¾…é”ï¼Œè¿‡å¤šçš„å†…å­˜æ¶ˆè€—å’Œæ¼«é•¿çš„åƒåœ¾å›æ”¶ã€‚ <br><br> å¦‚æœè€ƒè™‘åˆ°æ ‡å‡†è§£å†³æ–¹æ¡ˆçš„é€šç”¨æ€§ï¼Œåˆ™å¯ä»¥è§£å†³è¿™äº›é—®é¢˜-åœ¨æˆ‘ä»¬çš„æ–¹æ¡ˆä¸­ï¼Œå®ƒä»¬å¯èƒ½ä¼šæœ‰å¤šä½™çš„å¼€é”€ã€‚ å› æ­¤ï¼Œæ‚¨å¯ä»¥é’ˆå¯¹ç‰¹å®šæƒ…å†µç¼–å†™ä¾‹å¦‚è‡ªå·±çš„æœ‰æ•ˆçº¿ç¨‹å®‰å…¨é›†åˆã€‚ <br><br> è¿‡åœºåŠ¨ç”»æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DotNext</a>ä¼šè®®æŠ¥å‘Šçš„è§†é¢‘å’ŒæŠ„æœ¬ï¼Œåœ¨å…¶ä¸­ï¼Œæˆ‘åˆ†æäº†ä½¿ç”¨æ ‡å‡†.NETåº“ä¸­çš„å·¥å…·ï¼ˆTask.Delayï¼ŒSemaphoreSlimï¼ŒConcurrentDictionaryï¼‰å¯¼è‡´æ€§èƒ½ä¸‹é™çš„ä¸€äº›ç¤ºä¾‹ï¼Œæˆ‘æå‡ºäº†é’ˆå¯¹ç‰¹å®šä»»åŠ¡é‡èº«å®šåˆ¶çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™äº›ç¼ºç‚¹ã€‚ <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/-tNeYjRNJtY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br> åœ¨æ’°å†™æŠ¥å‘Šæ—¶ï¼Œä»–æ›¾åœ¨Konturå·¥ä½œã€‚  Konturå¼€å‘äº†å„ç§ä¸šåŠ¡åº”ç”¨ç¨‹åºï¼Œè€Œæˆ‘å·¥ä½œçš„å›¢é˜Ÿä¸åŸºç¡€æ¶æ„æ‰“äº¤é“ï¼Œå¹¶å¼€å‘äº†å„ç§æ”¯æŒæœåŠ¡å’Œåº“ï¼Œä»¥å¸®åŠ©å…¶ä»–å›¢é˜Ÿçš„å¼€å‘äººå‘˜åˆ›å»ºäº§å“æœåŠ¡ã€‚ <br><br> åŸºç¡€æ¶æ„å›¢é˜Ÿæ„å»ºå…¶æ•°æ®ä»“åº“ï¼Œç”¨äºWindowsçš„åº”ç”¨ç¨‹åºæ‰˜ç®¡ç³»ç»Ÿä»¥åŠç”¨äºå¼€å‘å¾®æœåŠ¡çš„å„ç§åº“ã€‚ æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåŸºäºå¾®æœåŠ¡ä½“ç³»ç»“æ„-æ‰€æœ‰æœåŠ¡éƒ½é€šè¿‡ç½‘ç»œç›¸äº’äº¤äº’ï¼Œå½“ç„¶ï¼Œå®ƒä»¬ä½¿ç”¨å¤§é‡å¼‚æ­¥å’Œå¤šçº¿ç¨‹ä»£ç ã€‚ å…¶ä¸­ä¸€äº›åº”ç”¨ç¨‹åºå¯¹æ€§èƒ½è‡³å…³é‡è¦ï¼›å®ƒä»¬éœ€è¦èƒ½å¤Ÿå¤„ç†è®¸å¤šè¯·æ±‚ã€‚ <br><br> ä»Šå¤©æˆ‘ä»¬è¦è°ˆä»€ä¹ˆï¼Ÿ <br><br><ul><li>  .NETä¸­çš„å¤šçº¿ç¨‹å’Œå¼‚æ­¥ï¼› </li><li> å¡«å……åŒæ­¥åŸè¯­å’Œé›†åˆï¼› </li><li> å¦‚æœæ ‡å‡†æ–¹æ³•æ— æ³•åº”ä»˜è´Ÿè½½æ€ä¹ˆåŠï¼Ÿ </li></ul><br> è®©æˆ‘ä»¬åˆ†æåœ¨.NETä¸­ä½¿ç”¨å¤šçº¿ç¨‹å’Œå¼‚æ­¥ä»£ç çš„ä¸€äº›åŠŸèƒ½ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€äº›åŒæ­¥åŸè¯­å’Œå¹¶å‘é›†åˆï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•å®‰æ’åœ¨å†…éƒ¨çš„ã€‚ æˆ‘ä»¬å°†è®¨è®ºå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ€§èƒ½ï¼Œæ ‡å‡†ç±»æ— æ³•åº”ä»˜è´Ÿè½½ä»¥åŠåœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯å¦å¯ä»¥è§£å†³é—®é¢˜æ—¶è¯¥æ€ä¹ˆåŠã€‚ <br><br> æˆ‘å°†å‘Šè¯‰æ‚¨æˆ‘ä»¬ç”Ÿäº§ç°åœºå‘ç”Ÿçš„å››ä¸ªæ•…äº‹ã€‚ <br><br><h2> å†å²è®°å½•1ï¼šTask.Delayå’ŒTimerQueue </h2><br> è¿™ä¸ªæ•…äº‹å·²ç»å¾ˆå¹¿ä¸ºäººçŸ¥ï¼ŒåŒ…æ‹¬åœ¨ä»¥å‰çš„DotNextä¸Šæœ‰å…³å®ƒçš„æ•…äº‹ã€‚ ä½†æ˜¯ï¼Œå®ƒæœ‰ä¸€ä¸ªç›¸å½“æœ‰è¶£çš„ç»­é›†ï¼Œå› æ­¤æˆ‘æ·»åŠ äº†å®ƒã€‚ é‚£æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ <br><br><h3>  1.1è½®è¯¢å’Œé•¿æ—¶é—´è½®è¯¢ </h3><br> æœåŠ¡å™¨æ‰§è¡Œé•¿æ—¶é—´çš„æ“ä½œï¼Œå®¢æˆ·ç«¯ç­‰å¾…å®ƒä»¬ã€‚ <br>  <b>è½®è¯¢ï¼š</b>å®¢æˆ·ç«¯å®šæœŸå‘æœåŠ¡å™¨è¯¢é—®ç»“æœã€‚ <br>  <b>é•¿è½®è¯¢ï¼š</b>å®¢æˆ·ç«¯å‘é€è¶…æ—¶è¯·æ±‚ï¼ŒæœåŠ¡å™¨åœ¨æ“ä½œå®Œæˆååšå‡ºå“åº”ã€‚ <br><br> ä¼˜ç‚¹ï¼š <br><br><ul><li> äº¤é€šå‡å°‘ </li><li> å®¢æˆ·æ›´å¿«åœ°äº†è§£ç»“æœ </li></ul><br> æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯ä»¥å¤„ç†ä¸€äº›é•¿è¯·æ±‚çš„æœåŠ¡å™¨ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå°†XMLæ–‡ä»¶è½¬æ¢ä¸ºPDFçš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”æœ‰ä¸€äº›å®¢æˆ·ç«¯è¿è¡Œè¿™äº›ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå¹¶å¸Œæœ›å¼‚æ­¥ç­‰å¾…å…¶ç»“æœã€‚ å¦‚ä½•å®ç°è¿™ç§æœŸæœ›ï¼Ÿ <br><br> ç¬¬ä¸€ç§æ–¹æ³•æ˜¯<b>è½®è¯¢</b> ã€‚ å®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨ä»»åŠ¡ï¼Œç„¶åå®šæœŸæ£€æŸ¥æ­¤ä»»åŠ¡çš„çŠ¶æ€ï¼Œè€ŒæœåŠ¡å™¨åˆ™è¿”å›ä»»åŠ¡çš„çŠ¶æ€ï¼ˆâ€œå·²å®Œæˆâ€ /â€œæœªå®Œæˆâ€ /â€œå·²å®Œæˆä½†æœ‰é”™è¯¯â€ï¼‰ã€‚ å®¢æˆ·ç«¯å®šæœŸå‘é€è¯·æ±‚ï¼Œç›´åˆ°ç»“æœå‡ºç°ã€‚ <br><br> ç¬¬äºŒç§æ–¹æ³•æ˜¯<b>é•¿æ—¶é—´è½®è¯¢</b> ã€‚ æ­¤å¤„çš„åŒºåˆ«åœ¨äºå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚è¶…æ—¶ã€‚ æ¥æ”¶åˆ°æ­¤ç±»è¯·æ±‚çš„æœåŠ¡å™¨å°†ä¸ä¼šç«‹å³æŠ¥å‘Šè¯¥ä»»åŠ¡å°šæœªå®Œæˆï¼Œè€Œæ˜¯ä¼šå°è¯•ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰èƒ½æ˜¾ç¤ºç»“æœã€‚ <br> é‚£ä¹ˆé•¿è½®è¯¢æ¯”å¸¸è§„è½®è¯¢æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ é¦–å…ˆï¼Œäº§ç”Ÿçš„æµé‡è¾ƒå°‘ã€‚ æˆ‘ä»¬å‘å‡ºè¾ƒå°‘çš„ç½‘ç»œè¯·æ±‚-é€šè¿‡ç½‘ç»œè¿½è¸ªçš„æµé‡å‡å°‘ã€‚ è€Œä¸”ï¼Œä¸å¸¸è§„è½®è¯¢ç›¸æ¯”ï¼Œå®¢æˆ·ç«¯å°†èƒ½å¤Ÿæ›´å¿«åœ°æ‰¾åˆ°ç»“æœï¼Œå› ä¸ºå®¢æˆ·ç«¯æ— éœ€ç­‰å¾…å¤šä¸ªè½®è¯¢è¯·æ±‚ä¹‹é—´çš„é—´éš”ã€‚ æˆ‘ä»¬æƒ³è¦å¾—åˆ°çš„æ˜¯å¯ä»¥ç†è§£çš„ã€‚ æˆ‘ä»¬å°†å¦‚ä½•åœ¨ä»£ç ä¸­å®ç°å‘¢ï¼Ÿ <br><blockquote> ä»»åŠ¡ï¼šè¶…æ—¶ <br> æˆ‘ä»¬æƒ³ç­‰å¾…ä»»åŠ¡è¶…æ—¶ <br> ç­‰å¾…SendAsyncï¼ˆï¼‰; </blockquote> ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªTaskå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œæˆ‘ä»¬æƒ³ç­‰å¾…è¶…æ—¶çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦ä¹ˆè¿”å›æ­¤Taskçš„ç»“æœï¼Œè¦ä¹ˆå‘é€æŸç§é”™è¯¯ã€‚  Cï¼ƒä»£ç å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sendTask = SendAsync(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> delayTask = Task.Delay(timeout); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> task = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.WhenAny(sendTask, delayTask); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (task == delayTask) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Timeout;</code> </pre> <br> è¿™æ®µä»£ç å¯åŠ¨äº†æˆ‘ä»¬è¦ç­‰å¾…å…¶ç»“æœçš„Taskå’ŒTask.Delayã€‚ æ¥ä¸‹æ¥ï¼Œä½¿ç”¨Task.WhenAnyï¼Œæˆ‘ä»¬æ­£åœ¨ç­‰å¾…Taskæˆ–Task.Delayã€‚ å¦‚æœäº‹å®è¯æ˜Task.Delayé¦–å…ˆæ‰§è¡Œï¼Œé‚£ä¹ˆæ—¶é—´åˆ°äº†ï¼Œæˆ‘ä»¬è¶…æ—¶äº†ï¼Œæˆ‘ä»¬å¿…é¡»è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚ <br><br> å½“ç„¶ï¼Œæ­¤ä»£ç ä¸æ˜¯å®Œç¾çš„ï¼Œå¯ä»¥æ”¹è¿›ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœSendAsyncè¾ƒæ—©è¿”å›ï¼Œå–æ¶ˆTask.Delayä¸ä¼šæœ‰ä»€ä¹ˆåå¤„ï¼Œä½†æ˜¯ç°åœ¨å¯¹äºæˆ‘ä»¬æ¥è¯´è¿™ä¸æ˜¯å¾ˆæœ‰è¶£ã€‚ åº•çº¿æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ç¼–å†™è¿™æ ·çš„ä»£ç å¹¶å°†å…¶åº”ç”¨äºé•¿æ—¶é—´è¶…æ—¶çš„é•¿æ—¶é—´è½®è¯¢ï¼Œåˆ™ä¼šé‡åˆ°ä¸€äº›æ€§èƒ½é—®é¢˜ã€‚ <br><br><h3>  1.2é•¿è½®è¯¢é—®é¢˜ </h3><br><ul><li> å¤§è¶…æ—¶ </li><li> è®¸å¤šå¹¶å‘æŸ¥è¯¢ </li><li>  =&gt;é«˜CPUä½¿ç”¨ç‡ </li></ul><br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé—®é¢˜åœ¨äºå¤„ç†å™¨èµ„æºçš„é«˜æ¶ˆè€—ã€‚ å¯èƒ½ä¼šå‘ç”Ÿå¤„ç†å™¨100ï¼…æ»¡è½½çš„æƒ…å†µï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºé€šå¸¸ä¼šåœæ­¢è¿è¡Œã€‚ ä¼¼ä¹æˆ‘ä»¬æ ¹æœ¬ä¸æ¶ˆè€—å¤„ç†å™¨èµ„æºï¼šæˆ‘ä»¬æ‰§è¡Œä¸€äº›å¼‚æ­¥æ“ä½œï¼Œç­‰å¾…æœåŠ¡å™¨çš„å“åº”ï¼Œå¹¶ä¸”å¤„ç†å™¨ä»è¢«åŠ è½½ã€‚ <br><br> é‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬ä»åº”ç”¨ç¨‹åºä¸­åˆ é™¤äº†å†…å­˜è½¬å‚¨ï¼š <br><br><pre> <code class="cs hljs"> ~*e!clrstack System.Threading.Monitor.Enter(System.Object) System.Threading.TimerQueueTimer.Change(â€¦) System.Threading.Timer.TimerSetup(â€¦) System.Threading.Timer..ctor(â€¦) System.Threading.Tasks.Task.Delay(â€¦)</code> </pre> <br> ä¸ºäº†åˆ†æè½¬å‚¨ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†WinDbgå·¥å…·ã€‚ æˆ‘ä»¬è¾“å…¥äº†ä¸€ä¸ªæ˜¾ç¤ºæ‰€æœ‰æ‰˜ç®¡çº¿ç¨‹çš„å †æ ˆè·Ÿè¸ªçš„å‘½ä»¤ï¼Œå¹¶çœ‹åˆ°äº†è¿™æ ·çš„ç»“æœã€‚ æˆ‘ä»¬æœ‰å¾ˆå¤šçº¿ç¨‹æ­£åœ¨ç­‰å¾…é”ã€‚  Monitor.Enteræ–¹æ³•æ˜¯Cï¼ƒä¸­çš„é”æ„é€ æ‰©å±•åˆ°çš„æ–¹æ³•ã€‚ è¯¥é”åœ¨ç§°ä¸ºTimerå’ŒTimerQueueTimerçš„ç±»ä¸­æ•è·ã€‚ åœ¨Timerä¸­ï¼Œå½“æˆ‘ä»¬å°è¯•åˆ›å»ºå®ƒä»¬æ—¶ï¼Œæˆ‘ä»¬æ¥è‡ªTask.Delayã€‚ æ€ä¹ˆäº†  Task.Delayå¯åŠ¨æ—¶ï¼Œå°†æ•è·TimerQueueå†…éƒ¨çš„é”ã€‚ <br><br><h3>  1.3é”è½¦é˜Ÿ </h3><br><ul><li> è®¸å¤šçº¿ç¨‹è¯•å›¾é”å®šä¸€ä¸ªé” </li><li> åœ¨é”ä¸‹ï¼Œå¾ˆå°‘æ‰§è¡Œä»£ç  </li><li> æ—¶é—´èŠ±è´¹åœ¨çº¿ç¨‹åŒæ­¥ä¸Šï¼Œè€Œä¸æ˜¯ä»£ç æ‰§è¡Œä¸Šã€‚ </li><li> çº¿ç¨‹å—è¢«é˜»æ­¢-å®ƒä»¬ä¸æ˜¯æ— é™çš„ </li></ul><br> åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé”è½¦é˜Ÿã€‚ è®¸å¤šçº¿ç¨‹è¯•å›¾æ•è·ç›¸åŒçš„é”ã€‚ åœ¨æ­¤é”ä¸‹ï¼Œå°†æ‰§è¡Œå¤§é‡ä»£ç ã€‚ æ­¤å¤„çš„å¤„ç†å™¨èµ„æºä¸æ˜¯èŠ±åœ¨åº”ç”¨ç¨‹åºä»£ç æœ¬èº«ä¸Šï¼Œè€Œæ˜¯èŠ±åœ¨åœ¨æ­¤é”ä¸ŠåŒæ­¥å®ƒä»¬ä¹‹é—´çš„çº¿ç¨‹çš„æ“ä½œä¸Šã€‚ è¿˜åº”æ³¨æ„ä¸.NETç›¸å…³çš„åŠŸèƒ½ï¼šå‚ä¸é”ä¿æŠ¤çš„çº¿ç¨‹æ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚ <br><br> å› æ­¤ï¼Œå¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è¢«é˜»å¡ï¼Œå®ƒä»¬å¯èƒ½ä¼šç»ˆæ­¢-çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°å—åˆ°é™åˆ¶ã€‚ å¯ä»¥é…ç½®ï¼Œä½†æ˜¯ä»ç„¶æœ‰ä¸Šé™ã€‚ åˆ°è¾¾çº¿ç¨‹æ± ä¹‹åï¼Œæ‰€æœ‰çº¿ç¨‹æ± çº¿ç¨‹éƒ½å°†å‚ä¸é”å®šè¿›ç¨‹ï¼Œå¹¶ä¸”æ¶‰åŠçº¿ç¨‹æ± çš„ä»»ä½•ä»£ç éƒ½å°†åœ¨åº”ç”¨ç¨‹åºä¸­åœæ­¢æ‰§è¡Œã€‚ è¿™å¤§å¤§æ¶åŒ–äº†å±€åŠ¿ã€‚ <br><br><h3>  1.4 TimerQueue </h3><br><ul><li> ç®¡ç†.NETåº”ç”¨ç¨‹åºä¸­çš„è®¡æ—¶å™¨ã€‚ </li><li> è®¡æ—¶å™¨ç”¨äºï¼š <br>  -Task.Delay <br>  -CancellationTocken.CancelAfter <br>  -HttpClient </li></ul><br>  TimerQueueæ˜¯ä¸€ä¸ªç±»ï¼Œç”¨äºç®¡ç†.NETåº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰è®¡æ—¶å™¨ã€‚ å¦‚æœæ‚¨æ›¾ç»åœ¨WinFormsä¸­ç¼–ç¨‹è¿‡ï¼Œåˆ™å¯èƒ½æ˜¯æ‰‹åŠ¨åˆ›å»ºäº†è®¡æ—¶å™¨ã€‚ å¯¹äºé‚£äº›ä¸çŸ¥é“è®¡æ—¶å™¨æ˜¯ä»€ä¹ˆçš„äººï¼šå®ƒä»¬åœ¨Task.Delayä¸­ä½¿ç”¨ï¼ˆè¿™åªæ˜¯æˆ‘ä»¬çš„æƒ…å†µï¼‰ï¼Œå®ƒä»¬ä¹Ÿåœ¨CancellationTokenæ–¹æ³•çš„CancelAfteræ–¹æ³•ä¸­ä½¿ç”¨ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨CancellationToken.CancelAfteræ›¿æ¢Task.Delayä¸ä¼šå¯¹æˆ‘ä»¬æœ‰ä»»ä½•å¸®åŠ©ã€‚ æ­¤å¤–ï¼Œè®¸å¤šå†…éƒ¨.NETç±»ï¼ˆä¾‹å¦‚HttpClientï¼‰ä¸­éƒ½ä½¿ç”¨äº†è®¡æ—¶å™¨ã€‚ <br><br> æ®æˆ‘æ‰€çŸ¥ï¼ŒHttpClientå¤„ç†ç¨‹åºçš„æŸäº›å®ç°éƒ½æœ‰è®¡æ—¶å™¨ã€‚ å³ä½¿æ‚¨æ²¡æœ‰æ˜ç¡®ä½¿ç”¨å®ƒä»¬ï¼Œä¹Ÿä¸è¦å¯åŠ¨Task.Delayï¼Œå¾ˆå¯èƒ½ä»ç„¶ä»ç„¶ä½¿ç”¨å®ƒä»¬ã€‚ <br><br> ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹TimerQueueçš„å†…éƒ¨æ’åˆ—æ–¹å¼ã€‚ <br><br><ul><li> å…¨å±€çŠ¶æ€ï¼ˆæ¯ä¸ªåº”ç”¨ç¨‹åºåŸŸï¼‰ï¼š <br>  -TimerQueueTimerçš„åŒé“¾è¡¨ <br>  -é”å®šå¯¹è±¡ </li><li> å¸¸è§„è®¡æ—¶å™¨å›è°ƒ </li><li> è®¡æ—¶å™¨æœªæŒ‰å“åº”æ—¶é—´æ’åº </li><li> æ·»åŠ è®¡æ—¶å™¨ï¼šOï¼ˆ1ï¼‰+é”å®š </li><li> ç§»é™¤è®¡æ—¶å™¨ï¼šOï¼ˆ1ï¼‰+é”å®š </li><li> å¯åŠ¨è®¡æ—¶å™¨ï¼šOï¼ˆNï¼‰+é”å®š </li></ul><br> åœ¨TimerQueueå†…éƒ¨æœ‰ä¸€ä¸ªå…¨å±€çŠ¶æ€ï¼Œå®ƒæ˜¯TimerQueueTimerç±»å‹çš„å¯¹è±¡çš„åŒå‘é“¾æ¥åˆ—è¡¨ã€‚  TimerQueueTimeråŒ…å«ä¸€ä¸ªåˆ°å…¶ä»–TimerQueueTimerçš„é“¾æ¥ï¼Œè¯¥é“¾æ¥åœ¨é“¾è¡¨ä¸­ç›¸é‚»ï¼Œè¿˜åŒ…å«è®¡æ—¶å™¨å’Œå›è°ƒçš„æ—¶é—´ï¼Œå½“è®¡æ—¶å™¨å¯åŠ¨æ—¶å°†è°ƒç”¨è¯¥æ—¶é—´ã€‚ è¿™ä¸ªåŒé‡é“¾æ¥åˆ—è¡¨å—ä¸€ä¸ªé”å¯¹è±¡çš„ä¿æŠ¤ï¼Œè€Œè¯¥é”å¯¹è±¡åªæ˜¯åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å‘ç”Ÿé”æŠ¤å«çš„å¯¹è±¡ã€‚ åœ¨TimerQueueä¸­ä¹Ÿæœ‰ä¸€ä¸ªä¾‹ç¨‹ï¼Œè¯¥ä¾‹ç¨‹å¯åŠ¨ä¸æˆ‘ä»¬çš„è®¡æ—¶å™¨ç›¸å…³çš„å›è°ƒã€‚ <br><br> è®¡æ—¶å™¨å†³ä¸ä¼šæŒ‰å“åº”æ—¶é—´æ’åºï¼Œæ•´ä¸ªç»“æ„å·²é’ˆå¯¹æ·»åŠ /åˆ é™¤æ–°è®¡æ—¶å™¨è¿›è¡Œäº†ä¼˜åŒ–ã€‚  Routineå¯åŠ¨æ—¶ï¼Œå®ƒå°†éå†æ•´ä¸ªåŒå‘é“¾è¡¨ï¼Œé€‰æ‹©åº”è¯¥å·¥ä½œçš„è®¡æ—¶å™¨ï¼Œç„¶åå°†å…¶å›è°ƒã€‚ <br><br> æ“ä½œçš„å¤æ‚æ€§å°±æ˜¯è¿™æ ·ã€‚ æ·»åŠ å’Œåˆ â€‹â€‹é™¤è®¡æ—¶å™¨ä¼šåœ¨æ¯ä¸ªå•å…ƒä¸­å‘ç”ŸOï¼Œè®¡æ—¶å™¨çš„å¯åŠ¨ä¼šåœ¨æ¯è¡Œä¸­å‘ç”Ÿã€‚ è€Œä¸”ï¼Œå¦‚æœåœ¨ç®—æ³•å¤æ‚æ€§æ–¹é¢ä¸€åˆ‡éƒ½å¯ä»¥æ¥å—ï¼Œåˆ™å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šæ‰€æœ‰è¿™äº›æ“ä½œéƒ½æ•è·äº†é”ï¼Œè¿™ä¸æ˜¯å¾ˆå¥½ã€‚ <br><br> ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ æˆ‘ä»¬åœ¨TimerQueueä¸­ç§¯ç´¯äº†å¤ªå¤šçš„è®¡æ—¶å™¨ï¼Œå› æ­¤ï¼Œå½“Routineå¯åŠ¨æ—¶ï¼Œå®ƒå°†é”å®šå…¶é•¿æ—¶é—´çš„çº¿æ€§æ“ä½œï¼Œé‚£æ—¶é‚£äº›å°è¯•å¯åŠ¨æˆ–ä»TimerQueueä¸­åˆ é™¤è®¡æ—¶å™¨çš„äººæ— æ³•å¯¹å…¶è¿›è¡Œä»»ä½•æ“ä½œã€‚ å› æ­¤ï¼Œå°†å‘ç”Ÿé”å®šè½¦é˜Ÿã€‚  .NET Coreä¸­å·²è§£å†³æ­¤é—®é¢˜ã€‚ <br><blockquote> å‡å°‘è®¡æ—¶å™¨é”å®šäº‰ç”¨ï¼ˆcoreclrï¼ƒ14527ï¼‰ <br><ul><li> é”å®šåˆ†ç‰‡ <br>  -Environment.ProcessorCount TimerQueueçš„TimerQueueTimer </li><li> çŸ­/é•¿å¯¿å‘½è®¡æ—¶å™¨çš„å•ç‹¬é˜Ÿåˆ— </li><li> çŸ­è®¡æ—¶å™¨ï¼šæ—¶é—´&lt;= 1/3ç§’ </li></ul><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/dotnet/coreclr/issues/14462</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/dotnet/coreclr/pull/14527</a> <br></blockquote> å®ƒæ˜¯å¦‚ä½•å›ºå®šçš„ï¼Ÿ ä»–ä»¬çªå‡»äº†TimerQueueï¼šè€Œä¸æ˜¯ä¸€ä¸ªTimerQueueï¼ˆå¯¹äºæ•´ä¸ªAppDomainéƒ½æ˜¯é™æ€çš„ï¼‰ï¼Œå¯¹äºæ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œåˆ›å»ºäº†å¤šä¸ªTimerQueueã€‚ å½“çº¿ç¨‹åˆ°è¾¾é‚£é‡Œå¹¶å°è¯•å¯åŠ¨å®ƒä»¬çš„è®¡æ—¶å™¨æ—¶ï¼Œè¿™äº›è®¡æ—¶å™¨å°†è½å…¥éšæœºçš„TimerQueueä¸­ï¼Œå¹¶ä¸”çº¿ç¨‹ç¢°æ’ä¸€æ¬¡é”çš„æœºä¼šè¾ƒå°ã€‚ <br><br> è¿˜åœ¨.NET Coreä¸­åº”ç”¨äº†ä¸€äº›ä¼˜åŒ–ã€‚ è®¡æ—¶å™¨åˆ†ä¸ºé•¿å¯¿å‘½å’ŒçŸ­å¯¿å‘½ï¼Œç°åœ¨åˆ†åˆ«ä¸ºå®ƒä»¬ä½¿ç”¨TimerQueueã€‚ çŸ­æ—¶è®¡æ—¶å™¨é€‰æ‹©ä¸ºå°äº1/3ç§’ã€‚ æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆé€‰æ‹©äº†è¿™æ ·ä¸€ä¸ªå¸¸æ•°ã€‚ åœ¨.NET Coreä¸­ï¼Œæˆ‘ä»¬æ— æ³•æ•è·è®¡æ—¶å™¨é—®é¢˜ã€‚ <br><br><img src="https://habrastorage.org/webt/f_/am/cv/f_amcv6bohiq54ciyuunvtrr0ei.jpeg"><br><br>  <a href="">https://github.com/Microsoft/dotnet-framework-early-access/blob/master/release-notes/NET48/dotnet-48-changes.md</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/dotnet/coreclr/labels/netfx-port-consider</a> <br><br> æ­¤ä¿®å¤ç¨‹åºå·²åå‘ç§»æ¤åˆ°.NET Framework 4.8ç‰ˆã€‚ ä¸Šé¢çš„é“¾æ¥ä¸­æŒ‡ç¤ºäº†netfx-port-consideræ ‡è®°ï¼Œå¦‚æœè½¬åˆ°.NET Coreï¼ŒCoreCLRï¼ŒCoreFXå­˜å‚¨åº“ï¼Œåˆ™å¯ä»¥æœç´¢å°†è¢«åå‘ç§»æ¤åˆ°.NET Frameworkçš„é—®é¢˜ï¼Œç°åœ¨å¤§çº¦æœ‰äº”åä¸ªã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¼€æº.NETèµ·åˆ°äº†å¾ˆå¤§çš„ä½œç”¨ï¼Œä¿®å¤äº†è®¸å¤šé”™è¯¯ã€‚ æ‚¨å¯ä»¥é˜…è¯»changelog .NET Framework 4.8ï¼šå·²ä¿®å¤äº†è®¸å¤šé”™è¯¯ï¼Œæ¯”å…¶ä»–.NETç‰ˆæœ¬ä¸­çš„é”™è¯¯è¦å¤šå¾—å¤šã€‚ æœ‰è¶£çš„æ˜¯ï¼Œæ­¤ä¿®è¡¥ç¨‹åºåœ¨.NET Framework 4.8ä¸­é»˜è®¤ä¸ºå…³é—­ã€‚ å®ƒåŒ…å«åœ¨æ‚¨ç§°ä¸ºApp.configçš„æ•´ä¸ªæ–‡ä»¶ä¸­ <br><br>  App.configä¸­å¯ç”¨æ­¤ä¿®å¤ç¨‹åºçš„è®¾ç½®ç§°ä¸ºUseNetCoreTimerã€‚ åœ¨.NET Framework 4.8å‘è¡Œä¹‹å‰ï¼Œä¸ºäº†ä½¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ­£å¸¸å·¥ä½œè€Œä¸è¿›å…¥é”å®šçŠ¶æ€ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨Task.Delayçš„å®ç°ã€‚ åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨äºŒè¿›åˆ¶å †æ¥æ›´æœ‰æ•ˆåœ°äº†è§£ç°åœ¨åº”è¯¥è°ƒç”¨å“ªä¸ªè®¡æ—¶å™¨ã€‚ <br><br><h3>  1.5 Task.Delayï¼šæœ¬æœºå®ç° </h3><br><ul><li> äºŒè¿›åˆ¶å † </li><li> åˆ†ç‰‡ </li><li> å®ƒæœ‰æ‰€å¸®åŠ©ï¼Œä½†å¹¶éåœ¨æ‰€æœ‰æƒ…å†µä¸‹ </li></ul><br> ä½¿ç”¨äºŒè¿›åˆ¶å †ä½¿æ‚¨å¯ä»¥ä¼˜åŒ–è°ƒç”¨å›è°ƒçš„ä¾‹ç¨‹ï¼Œä½†ä¼šä½¿ä»é˜Ÿåˆ—ä¸­åˆ é™¤ä»»æ„è®¡æ—¶å™¨æ‰€éœ€çš„æ—¶é—´æ›´ç³Ÿ-ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦é‡å»ºå †ã€‚ è¿™å¾ˆå¯èƒ½å°±æ˜¯.NETä½¿ç”¨åŒå‘é“¾è¡¨çš„åŸå› ã€‚ å½“ç„¶ï¼Œä»…ä½¿ç”¨äºŒè¿›åˆ¶å †å¯¹æˆ‘ä»¬æ²¡æœ‰å¸®åŠ©ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»è®¡ç®—TimerQueueã€‚ è¯¥è§£å†³æ–¹æ¡ˆå·¥ä½œäº†ä¸€æ®µæ—¶é—´ï¼Œä½†ç”±äºè®¡æ—¶å™¨ä¸ä»…åœ¨ä»£ç ä¸­æ˜¾å¼è¿è¡Œçš„åœ°æ–¹ä½¿ç”¨ï¼Œè€Œä¸”åœ¨ç¬¬ä¸‰æ–¹åº“å’Œ.NETä»£ç ä¸­ä¹Ÿä½¿ç”¨ï¼Œå› æ­¤ï¼Œå®ƒä»ç„¶å†æ¬¡é™·å…¥é”å®šå›°å¢ƒã€‚ è‹¥è¦å®Œå…¨è§£å†³æ­¤é—®é¢˜ï¼Œæ‚¨å¿…é¡»å‡çº§åˆ°.NET Framework 4.8ç‰ˆå¹¶å¯ç”¨.NETå¼€å‘äººå‘˜çš„ä¿®å¤ç¨‹åºã€‚ <br><br><h3>  1.6 Task.Delayï¼šç»“è®º </h3><br><ul><li> åˆ°å¤„éƒ½æ˜¯é™·é˜±-å³ä½¿æ˜¯æœ€å¸¸ç”¨çš„ä¸œè¥¿ </li><li> åšå‹åŠ›æµ‹è¯• </li><li> åˆ‡æ¢åˆ°æ ¸å¿ƒï¼Œé¦–å…ˆè·å–é”™è¯¯ä¿®å¤ï¼ˆå’Œæ–°é”™è¯¯ï¼‰:) </li></ul><br> æ•´ä¸ªæ•…äº‹çš„ç»“è®ºæ˜¯ä»€ä¹ˆï¼Ÿ é¦–å…ˆï¼Œé™·é˜±å®é™…ä¸Šå¯ä»¥æ‘†åœ¨ä»»ä½•åœ°æ–¹ï¼Œå³ä½¿åœ¨æ‚¨æ¯å¤©éƒ½åœ¨ä¸åŠ æ€è€ƒçš„ç±»ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼Œç›¸åŒçš„Taskï¼ŒTask.Delayã€‚ <br><br> æˆ‘å»ºè®®å¯¹æ‚¨çš„ææ¡ˆè¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚ æˆ‘ä»¬åˆšåˆšåœ¨è´Ÿè½½æµ‹è¯•é˜¶æ®µå‘ç°äº†è¿™ä¸ªé—®é¢˜ã€‚ ç„¶åï¼Œæˆ‘ä»¬åœ¨å…¶ä»–åº”ç”¨ç¨‹åºçš„ç”Ÿäº§ä¸­å°†å…¶æ‹æ‘„äº†æ•°æ¬¡ï¼Œä½†æ˜¯ï¼Œå‹åŠ›æµ‹è¯•å¸®åŠ©æˆ‘ä»¬å»¶è¿Ÿäº†åœ¨å®é™…é‡åˆ°æ­¤é—®é¢˜ä¹‹å‰çš„æ—¶é—´ã€‚ <br><br> åˆ‡æ¢åˆ°.NET Core-æ‚¨å°†æ˜¯ç¬¬ä¸€ä¸ªæ¥æ”¶bugä¿®å¤ï¼ˆå’Œæ–°bugï¼‰çš„äººã€‚ å“ªé‡Œæ²¡æœ‰æ–°é”™è¯¯ï¼Ÿ <br><br> å…³äºè®¡æ—¶å™¨çš„æ•…äº‹å·²ç»ç»“æŸï¼Œæˆ‘ä»¬ç»§ç»­è¿›è¡Œä¸‹ä¸€ä¸ªã€‚ <br><br><h2> æ•…äº‹2ï¼šSemaphoreSlim </h2><br> ä»¥ä¸‹æ˜¯æœ‰å…³è‘—åçš„SemaphoreSlimçš„æ•…äº‹ã€‚ <br><br><h3>  2.1æœåŠ¡å™¨é™åˆ¶ </h3><br><ul><li> éœ€è¦é™åˆ¶æœåŠ¡å™¨ä¸Šå¹¶å‘å¤„ç†çš„è¯·æ±‚æ•° </li></ul><br> æˆ‘ä»¬æƒ³åœ¨æœåŠ¡å™¨ä¸Šå®ç°é™åˆ¶ã€‚ è¿™æ˜¯ä»€ä¹ˆ ä¹Ÿè®¸å¤§å®¶éƒ½çŸ¥é“CPUçš„èŠ‚æµé˜€ï¼šå½“å¤„ç†å™¨è¿‡çƒ­æ—¶ï¼Œå®ƒä¼šé™ä½å†·å´é¢‘ç‡ï¼Œè¿™ä¼šé™åˆ¶å…¶æ€§èƒ½ã€‚ å°±åœ¨è¿™é‡Œã€‚ æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„æœåŠ¡å™¨å¯ä»¥å¹¶è¡Œå¤„ç†Nä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå¤±è´¥ã€‚ æˆ‘ä»¬æƒ³åšä»€ä¹ˆï¼Ÿ å°†åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°é™åˆ¶ä¸ºè¯¥å¸¸æ•°ï¼Œå¹¶ä½¿å…¶ä¿æŒä¸å˜ï¼Œä»¥ä¾¿åœ¨æœ‰æ›´å¤šè¯·æ±‚æ—¶ï¼Œå®ƒä»¬æ’é˜Ÿå¹¶ç­‰å¾…ç›´åˆ°æ‰§è¡Œè¾ƒæ—©çš„é‚£äº›è¯·æ±‚ã€‚ è¿™ä¸ªé—®é¢˜æ€ä¹ˆè§£å†³ï¼Ÿ æœ‰å¿…è¦ä½¿ç”¨æŸç§åŒæ­¥åŸè¯­ã€‚ <br><br>  Semaphoreæ˜¯ä¸€ä¸ªåŒæ­¥åŸè¯­ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸Šç­‰å¾…Næ¬¡ï¼Œæ­¤åé¦–å…ˆåˆ°è¾¾N +çš„äººå°†ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°æ›´æ—©è¿›å…¥å®ƒçš„äººé‡Šæ”¾Semaphoreã€‚ äº‹å®è¯æ˜æ˜¯è¿™æ ·çš„ï¼šä¸¤ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œä¸¤ä¸ªå·¥ä½œäººå‘˜è¿›å…¥äº†ä¿¡å·é‡ç®¡ç†ç³»ç»Ÿï¼Œå…¶ä½™äººå‘˜æ’é˜Ÿã€‚ <br><br><img src="https://habrastorage.org/webt/6s/bu/h7/6sbuh77p4temzi5yiofjlh-rxoi.png"><br><br> å½“ç„¶ï¼Œåªæ˜¯Semaphoreä¸é€‚åˆæˆ‘ä»¬ï¼Œå®ƒåœ¨.NETåŒæ­¥ä¸­ï¼Œå› æ­¤æˆ‘ä»¬é‡‡ç”¨SemaphoreSlimå¹¶ç¼–å†™äº†ä»¥ä¸‹ä»£ç ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> semaphore = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SemaphoreSlim(N); â€¦ <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> semaphore.WaitAsync(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HandleRequestAsync(request); semaphore.Release();</code> </pre> <br> æˆ‘ä»¬åˆ›å»ºSemaphoreSlimï¼Œç„¶åç­‰å¾…ï¼Œåœ¨Semaphoreä¸‹å¤„ç†æ‚¨çš„è¯·æ±‚ï¼Œç„¶åé‡Šæ”¾Semaphoreã€‚ çœ‹æ¥è¿™æ˜¯æœåŠ¡å™¨é™åˆ¶çš„ç†æƒ³å®ç°ï¼Œå¹¶ä¸”å†ä¹Ÿä¸èƒ½åšå¾—æ›´å¥½ã€‚ ä½†æ˜¯ï¼Œä¸€åˆ‡éƒ½æ›´åŠ å¤æ‚ã€‚ <br><br><h3>  2.2æœåŠ¡å™¨é™åˆ¶ï¼šå¤æ‚ </h3><br><ul><li> æŒ‰LIFOé¡ºåºå¤„ç†è¯·æ±‚ </li><li> ä¿¡å·é‡ </li><li> å¹¶å‘å †æ ˆ </li><li>  TaskCompletionSource </li></ul><br> æˆ‘ä»¬å¿˜è®°äº†ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚ èŠ‚æµçš„è¯·æ±‚æ˜¯çœŸå®çš„httpè¯·æ±‚ã€‚ é€šå¸¸ï¼Œä»–ä»¬æœ‰ä¸€äº›è¶…æ—¶æ—¶é—´ï¼ˆç”±è‡ªåŠ¨å‘é€æ­¤è¯·æ±‚çš„ç”¨æˆ·è®¾ç½®ï¼‰ï¼Œæˆ–è€…æ˜¯ä¸€æ®µæ—¶é—´åæŒ‰F5çš„ç”¨æˆ·è®¾ç½®çš„è¶…æ—¶æ—¶é—´ã€‚ å› æ­¤ï¼Œå¦‚æœæ‚¨æŒ‰ç…§å¸¸è§„ä¿¡å·é‡ä¹‹ç±»çš„é˜Ÿåˆ—é¡ºåºå¤„ç†è¯·æ±‚ï¼Œåˆ™é¦–å…ˆå¯èƒ½å·²ç»å¤„ç†äº†æ¥è‡ªé˜Ÿåˆ—çš„æ‰€æœ‰é‚£äº›è¶…æ—¶è¯·æ±‚ã€‚ å¦‚æœæŒ‰å †æ ˆé¡ºåºå·¥ä½œ-é¦–å…ˆå¤„ç†æœ€åå‡ºç°çš„æ‰€æœ‰è¯·æ±‚ï¼Œåˆ™ä¸ä¼šå‡ºç°æ­¤ç±»é—®é¢˜ã€‚ <br><br> é™¤äº†SemaphoreSlimä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»ä½¿ç”¨ConcurrentStackï¼ŒTaskCompletionSourceå›´ç»•è¿™äº›å†…å®¹åŒ…è£…å¾ˆå¤šä»£ç ï¼Œä»¥ä¾¿æ‰€æœ‰å†…å®¹éƒ½èƒ½æŒ‰æˆ‘ä»¬éœ€è¦çš„é¡ºåºå·¥ä½œã€‚  TaskCompletionSourceå°±æ˜¯è¿™æ ·ï¼Œå®ƒä¸CancellationTokenSourceç±»ä¼¼ï¼Œä½†ä¸CancellationTokenæ— å…³ï¼Œä½†ä¸Taskç›¸ä¼¼ã€‚ æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªTaskCompletionSourceï¼Œä»ä¸­æå–ä¸€ä¸ªTaskï¼Œåˆ†å‘å‡ºå»ï¼Œç„¶åå‘Šè¯‰TaskCompletionSourceæ‚¨éœ€è¦ä¸ºè¯¥Taskè®¾ç½®ç»“æœï¼Œç­‰å¾…è¯¥Taskçš„äººå°†äº†è§£æ­¤ç»“æœã€‚ <br><br> æˆ‘ä»¬éƒ½å®ç°äº†å®ƒã€‚ ä»£ç å¤ªç³Ÿç³•äº†ã€‚ æœ€ç³Ÿç³•çš„æ˜¯ï¼Œç»“æœè¯æ˜å®ƒæ— æ³•æ­£å¸¸å·¥ä½œã€‚ <br><br> åœ¨ç›¸å½“é‡çš„åº”ç”¨ç¨‹åºä¸­å¼€å§‹ä½¿ç”¨å®ƒçš„å‡ ä¸ªæœˆåï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ã€‚ ä¸ä»¥å‰çš„æƒ…å†µç›¸åŒï¼ŒCPUæ¶ˆè€—å·²å¢åŠ åˆ°100ï¼…ã€‚ æˆ‘ä»¬è¿›è¡Œäº†ç›¸åŒçš„æ“ä½œï¼Œåˆ é™¤äº†è½¬å‚¨ï¼Œåœ¨WinDbgä¸­å¯¹å…¶è¿›è¡Œäº†æŸ¥çœ‹ï¼Œç„¶åå†æ¬¡æ‰¾åˆ°äº†é”è½¦é˜Ÿã€‚ <br><br><img src="https://habrastorage.org/webt/h_/ef/as/h_efasuul34r0fm7vwopo2hm1bc.jpeg"><br><br> è¿™æ¬¡ï¼ŒLockè½¦é˜Ÿå‘ç”Ÿåœ¨SemaphoreSlim.WaitAsyncå’ŒSemaphoreSlim.Releaseå†…éƒ¨ã€‚ äº‹å®è¯æ˜ï¼ŒSemaphoreSlimå†…éƒ¨æœ‰ä¸€ä¸ªé”ï¼Œå®ƒä¸æ˜¯æ— é”çš„ã€‚ äº‹å®è¯æ˜ï¼Œè¿™å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸€ä¸ªç›¸å½“ä¸¥é‡çš„ç¼ºç‚¹ã€‚ <br><br><img src="https://habrastorage.org/webt/0h/-k/qq/0h-kqqxojlujm3dglokmacabvwq.jpeg"><br><br> åœ¨SemaphoreSlimå†…éƒ¨ï¼Œå­˜åœ¨ä¸€ä¸ªå†…éƒ¨çŠ¶æ€ï¼ˆä¸€ä¸ªè®¡æ•°å™¨ï¼Œè¯¥è®¡æ•°å™¨ä»å¯ä»¥æŸ¥çœ‹æœ‰å¤šå°‘å·¥ä½œäººå‘˜ï¼‰ï¼Œä»¥åŠç­‰å¾…è¯¥ä¿¡å·ç¯çš„äººå‘˜çš„åŒé“¾è¡¨ã€‚ è¿™é‡Œçš„æƒ³æ³•æ˜¯ç›¸åŒçš„ï¼šæ‚¨å¯ä»¥åœ¨æ­¤ä¿¡å·é‡ä¸Šç­‰å¾…ï¼Œå¯ä»¥å–æ¶ˆæœŸæœ›-ç¦»å¼€æ­¤é˜Ÿåˆ—ã€‚ æœ‰ä¸€æŠŠé”åˆšåˆšæ¯äº†æˆ‘ä»¬çš„ç”Ÿæ´»ã€‚ <br><br>  :    ,    . <br><br><img src="https://habrastorage.org/webt/ax/ls/3i/axls3iseuxmgjt-vqkeiqs7hvtq.jpeg"><br><br>    Semaphore,    lock-free        .       . <br><br><img src="https://habrastorage.org/webt/rv/rg/wv/rvrgwv8apebibtiymhxpvm5giti.jpeg"><br><br>   .    currentCount â€”       Semaphore.    Semaphore  ,        ,     .   ConcurrentStack,   TaskCompletionSource' â€”     waiter',       .   WaitAsync. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> decrementedCount = Interlocked.Decrement(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> currentCount); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (decrementedCount &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.CompletedTask; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> waiter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskCompletionSource&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;(); waiters.Push(waiter); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> waiter.Task;</code> </pre> <br>    ,      Semaphore,      ,   : Â«,    SemaphoreÂ». <br><br>    Semaphore  ,   TaskCompletionSource,     waiter'      Task'.   ,  Task' ,          Semaphore. <br><br>    Release. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> countBefore = Interlocked.Increment(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> currentCount) - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (countBefore &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waiters.TryPop(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> waiter)) waiter.TrySetResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  Release   : <br><br><ul><li>     Semaphore </li><li>  currentCount </li></ul><br>   currentCount  ,     waiter',    ,   waiter'     .  waiter â€”  TaskCompletionSource.    :    ,    ?    ?  ,   ,   continuation'  TaskCompletionSource'. <br><br><img src="https://habrastorage.org/webt/_1/zo/hu/_1zohu07rqeiemrkwrcubv7gwhe.png"><br><br>   .   TaskCompletionSource    Task'.  Task  ,    TaskCompletionSource,      .  Task    TaskCompletionSource,   Task',        . <br><br>   ? Task 2      ,    â€” continuation,  Thread.Sleep.    TaskCompletionSource,  continuation     ,     Task. ,   Task'   ,       . <br><br>  ,     ,        , continuation         .    continuation      ,    â€”    â€”   . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tcs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskCompletionSource&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;( TaskCreationOptions.RunContinuationsAsynchronously); <span class="hljs-comment"><span class="hljs-comment">/* OR */</span></span> Task.Run(() =&gt; tcs.TrySetResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>));</code> </pre> <br>         TaskCompletionSource    RunContinuationsAsynchronously,    TrySetResult  Task.Run/ThreadPool.QueueUserWorkItem,       .       ,      side effect'.     ,    . <br><br><img src="https://habrastorage.org/webt/m9/x8/gx/m9x8gxz7x5tw3mjcps7nygdmkjs.jpeg"><br><br>    WaitAsync  Release      Release   . <br><br>  ,     .   . <br><br><img src="https://habrastorage.org/webt/cs/1e/4q/cs1e4q3yaz4d3084_24z2ucsd6y.jpeg"><br><br>    ,    WaitAsync    .         waiter'  .   ,  Release     ,    ,       .   ,    Release   waiter'  . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> countBefore = Interlocked.Increment(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> currentCount) - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (countBefore &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Waiter waiter; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spinner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpinWait(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!waiter.TryPop(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> waiter)) spinner.SpinOnce(); waiter.TrySetResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>      ,       .       ,   SpinWait. <br><br>         .    , waiter    ,      Thread.Sleep,       CPU. <br><br>   , Semaphore  LIFO- â€”     . <br><blockquote> <b>LowLevelLifoSemaphore</b> <br><ul><li>  </li><li>  Windows     Windows IO Completion port </li></ul><br> <a href="">https://github.com/dotnet/corert/blob/master/src/System.Private.CoreLib/src/System/Threading/LowLevelLifoSemaphore.cs</a> </blockquote>  Semaphore    .NET,    CoreCLR,   CoreFX,   CoreRT.        .NET.   Semaphore   LowLevelLifoSemaphore.  Semaphore      :  . <br><br>  ,  Windows    IO Completion-.    ,      ,         LIFO-.    ,   LowLevel. <br><br><h3> 2.3 : </h3><br><ul><li>  ,        </li><li>    ,    </li><li>      </li><li>   </li></ul><br>      ? -,  ,  -   ,      ,    .    ,  SemaphoreSlim ,        . <br><br>       Semaphore   . ,     .      SemaphoreSlim,    ,     . <br><br>  ,    ,     . <br><br> .NET  ,           â€”   .        lock,  : Â«    ?Â»     CPU 100%,     lock', , ,   -  .NET.      . <br><br>    . <br><br><h2>  3: (A)sync IO </h2><br>    /,      . <br><br><img src="https://habrastorage.org/webt/84/qh/sz/84qhsz9je7twmgbswt5so0dfx2q.jpeg"><br><br>    lock convoy,    stack trace     Overlapped  PinnableBufferCache.   lock.     : Overlapped  PinnableBufferCache? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">OVERLAPPED</a> â€”    Windows,      /.      ,        .        ,  .       ,     lock convoy.   ,      lock convoy,    ,   . <br><br><img src="https://habrastorage.org/webt/if/j_/fc/ifj_fclqmvkfgfff7zedxpj63mo.jpeg"><br><br>  ,       ,   .NET 4.5.1  4.5.2.     .NET 4.5.2,     ,    .NET 4.5.2.  .NET 4.5.1     OverlappedDataCache,      Overlapped â€” ,       ,   .    ,  lock-free,   ConcurrentStack,       .  .NET 4.5.2     :  OverlappedDataCache   PinnableBufferCache. <br><br>   ? PinnableBufferCache     ,   Overlapped     ,    ,       â€”      . ,     ,      . PinnableBufferCache     .   , lock-free,   ConcurrentStack.     ,      .        ,        ,  -    lock-free    list  lock'. <br><br><h3> 3.1 PinnableBufferCache </h3><br> LockConvoy: <br><br><ul><li>    </li><li>      </li></ul><br>  lock convoy  ,   -     .        list      ,     lock   ,  ,                . <br><br>     PinnableBufferCache  ,         .    : <br><br><pre> <code class="plaintext hljs">PinnableBufferCache_System.ThreadingOverlappedData_MinCount</code> </pre> <br>      ,      .  : Â« !         -  Â».         -: <br><br><pre> <code class="cs hljs">Environment.SetEnvironmentVariable( <span class="hljs-string"><span class="hljs-string">"PinnableBufferCache_System.Threading.OverlappedData_MinCount"</span></span>, <span class="hljs-string"><span class="hljs-string">"10000"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Overlapped().GetHashCode(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; i++) GC.Collect(GC.MaxGeneration, GCCollectionMode.Forced);</code> </pre> <br>    ?     ,    Overlapped  ,   ,        .     ,   ,     ,     ,  PinnableBufferCache      lock convoy'.    ,           . <br><br>  .NET Core  PinnableBufferCache <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ,   OverlappedData   . ,        , Garbage collector     ,      .     .NET Core  .  .NET Framework,   ,     . <br><br><h3> 3.2 : </h3><br><ul><li>      </li><li>      </li><li>   .NET Core </li></ul><br>      ,     .   ,   .NET            ,       . ,  ,  .NET Core. ,     ,         -. <br><br>    key-value . <br><br><h2>  4: Concurrent key-value collections </h2><br>  .NET   concurrent-.  lock-free  ConcurrentStack  ConcurrentQueu,       .   ConcurrentDictionary,    .   lock-free  ,   ,      .    ConcurrentDictionary? <br><br><h3> 4.1 ConcurrentDictionary </h3><br> : <br><br><ul><li>  </li><li>  </li></ul><br> ä¼˜ç‚¹ï¼š <br><br><ul><li>     </li><li>   (TryAdd/TryUpdate/AddOrUpdate) </li><li> Lock-free  </li><li> Lock-free enumeration </li></ul><br>      , memory-,  ,        .    ,    ,    .NET Framework.            . ,  ,      (enumeration) lock-free. ,   . <br><br>  ,   ,   -  .NET.  key-value    -    : <br><br><img src="https://habrastorage.org/webt/ff/9f/g_/ff9fg_qzzuzvafep8c-p3seyigm.jpeg"><br><br>  -,     bucket'.      bucket',    .   ,    bucket   ,       . <br><br>    â€”   ,  ConcurrentDictionary.  ConcurrentDictionary    Â«-Â»   .    ,      ,   ,       memory traffic.     ConcurrentDictionary,   lock'.   â€”   . <br><br>    ,    Dictionary. <br><br><img src="https://habrastorage.org/webt/-_/dw/jo/-_dwjoxswmd1kecoi3aln8m7bow.jpeg"><br><br>  Dictionary  ,  Concurrent,      .     :  buckets,  entries.   buckets       bucket'   entries.   Â«-Â»    entries.          .      Â«-Â»   int,     bucket'. <br><br>   memory overhead,     ConcurrentDictionary   Dictionary. <br><br><img src="https://habrastorage.org/webt/em/aa/ch/emaachor-z_xxt7m_1wc7ntqupm.jpeg"><br><br>    Dictionary. Memory overhea'    ,       .    Dictionary  overhead  -    ,  int'.  8 . <br><br>    ConcurrentDictionary.  ConcurrentDictionary     ConcurrentDictionary.Node.   , .     int hashCode        .       ,    table (  16 ),  int hashCode     .      ,   64-    28  overhead'.       Dictionary. <br><br>  memory overhead', ConcurrentDictionary     GC   ,       .     Benchmark.   ConcurrentDictionary  ,       GC.Collect.    ? <br><br><img src="https://habrastorage.org/webt/on/yj/uq/onyjuq1rqgfkv8iav5x4z8nrnq8.jpeg"><br><br>     .       ConcurrentDictionary  10  ,        ,             ,      .   Dictionary   .      ,   ,  ,    .       . <br><br>     ,     ConcurrentDictionary? <br><br><h3> 4.2   </h3><br><ul><li>    </li><li> TTL </li><li> Dictionary+lock </li><li> Sharding </li></ul><br>     .      ConcurrentDictionary.        10  .   ,     .   TTL  ,    .        Dictionary  lock'. ,  ,  lock    .       Dictionary  lock'      ,   -     ,           lock.      ,     . <br><br><h3> 4.3  </h3><br><ul><li>   in-memory  &lt;Guid,Guid&gt; </li><li>   &gt;10 <sup>6</sup>  </li><li>       </li><li>   </li><li>        </li></ul><br>     .      â€”      ,       in-memory   Guid'  Guid,     .       .     - - ,     .  ,            15    .   .     Semaphore     ConcurrentDictionary. <br><br><img src="https://habrastorage.org/webt/u4/kw/kt/u4kwkttmxwpyelqlqoqp9zxahaa.jpeg"><br><br> ,    lock-free    ,    overhead      GC.   ,          .      ,    ,       ,   .   ,     -  ,       ,    .  ,  ,      Large Object Heap.    ? <br><br>       ,     ,     Dictionary   . <br><br><img src="https://habrastorage.org/webt/kx/yn/oi/kxynoiatsy8zcyrc5dei-xohlk4.jpeg"><br><br>   Dictionary   bucket',  Entry.  Entry  , ,   ,   . <br><br><img src="https://habrastorage.org/webt/n8/7a/5r/n87a5rlkgdk62nw82qysi3fmi18.png"><br><br>  Dictionary   ,   ,      . ,     - . <br><br>      ,  -     ? -,  ,       ,     ,      .     .    Dictionary,     , buckets, entries,              Interlocked. ,         . <br><blockquote> <b>Dictionary</b> <br><ul><li>   ,    </li><li>     ,   ? <br> â€”  Resize  buckets  entries   <br> â€”      - <br> â€”    Dictionary.Entry <br> â€”   -   </li></ul><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://blogs.msdn.microsoft.com/tess/2009/12/21/high-cpu-in-net-app-using-a-static-generic-dictionary/</a> </blockquote>     ,       Dictionary       -  bucket'.       ,      .    ,     ,        .       ,       ,    . <br><br>      Entry  Dictionary.     - -    .  ,     . <br><br><img src="https://habrastorage.org/webt/4p/xb/aq/4pxbaqil2cd4jaxnayxjqz-5yae.jpeg"><br><br>    .NET Framework  1.1.     Hashtable,   Dictionary,    object'.     MSDN ,      .  ,             -.   .  ,  Hashtable  .  ,      . <br><br><h3> 4.4    Dictionary.Entry </h3><br><img src="https://habrastorage.org/webt/y2/ww/rs/y2wwrslyuqpioqcalmpnt8dh6cw.jpeg"><br>    ? Dictionary.Entry ,  ,  8 , ,  ,   ,     .   ? <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> writing; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> version; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.writing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; buckets[index] = â€¦; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.version++; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.writing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>   :  (    ,    )  int-.   ,  .   ,     , ,  ,  . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> writing; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> version; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> version = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.version; bucket = bickets[index]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.writing || version != <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.version) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre> <br>    ,     ,         .       ,   .       ,  8 . <br><br><h3> 4.5   -   </h3><br>  ,   . <br><br><img src="https://habrastorage.org/webt/hh/bp/0l/hhbp0leb95qndz4bmg-2gtvmeue.jpeg"><br><br>  Dictionary     bucket    ,     . <br><br>  Dictionary,    .      : 0  2.   bucket, 1       2.   ?     0.   ,       ,    2.     .   ,  2,       , , 1. 1       2 â€”     bucket.   ,      ,   .    1 â€” ,     bucket.  Hashtable     ,     bucket'  -.        â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">double hashing</a> . <br><br><h3> 4.6   </h3><br><ul><li>     </li><li>      </li></ul><br> <b></b> <br><br><ul><li>        </li><li>    ,  resize </li></ul><br> <b></b> <br><br><ul><li>     ,      </li></ul><br>        .         ,       Buckets,     Entries (   Buckets,     Entries).   -  ,       ,   ,          ,    . <br><br>             .    ,    . <br><br>  :     ,      ,    ,     ,     . ,       ,   . <br><br><img src="https://habrastorage.org/webt/pm/lo/ah/pmloah0wlfbq7ilvlnrvbh3pyuu.png"><br><br>     ,   , â€”  . <br><br>   ?   ,  -    2.   -   Capacity  ,            .    â€” 2.       ,   .      2.    ?  ,  ,     ,   .    -  ,        ,       3. ,    ,  ,    ,  ,  . <br><br>  ,    Hashtable,  .   ,     double hashing.     ,       ,   ,     . <br><br>   ,      ,     â€”   ,            .     Hashtable.   ,    â€”     â€”       .                 .  ,     bucket',       -  ,       .  . <br><br>     ,  ,   lock-free      LOH. <br><br><img src="https://habrastorage.org/webt/pg/2b/6b/pg2b6bbfkm_3nnkds27g2krziz8.jpeg"><br><br>   lock-free ?  MSDN    Hashtable ,      .    ,            ,            . <br><br><img src="https://habrastorage.org/webt/yu/sg/he/yusghe0crfu9ywaic0aozpr7wri.jpeg"><br><br>      ,     ,        ,   bucket'.         Dictionary  bucket',  -,   bucket'      .    -    bucket,  bucket  .      ,     . <br><br>  ,       Large Object Heap. <br><br><img src="https://habrastorage.org/webt/wf/po/8o/wfpo8ou1_fpzhdkgcdbjzw-7u9q.jpeg"><br><br>      .  CustomDictionary  CustomDictionarySegment    .   Dictionary,    ,      .   â€”   Dictionary,      .       ,      Large Object Heap.        ,   bucket'   . ,      ,    ,   bucket,     - - . <br><br>           .       ConcurrentDictionary,     .NET,        ,      . <br><br><h3> 4.7  </h3><br><ul><li> .NET   </li><li>    </li><li>   </li><li> ,     </li><li>   </li><li>   </li></ul><br>     ? .NET  .   .   ,     ,       .    -   â€”   - .   ,  , ,     . <br><br>  -   , ,   ,     ,   .   ,   ,   ,        , ,          .   â€”   , ,   . <br><br><h3>   </h3><br><ul><li>   ConcurrentDictionary: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://habr.com/ru/company/skbkontur/blog/348508/</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/vostok/commons.threading</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/epeshk/dotnext-2019-threading</a> </li></ul><br>   â€”          ConcurrentDictionary. ,      ,   ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Diafilm</a> ),       . <br><br>      GitHub.   â€”     ,    ,    LIFO-Semaphore,    .       ,    . <br><blockquote> 6-7     <b>DotNext 2019 Moscow</b>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Â«.NET:  Â»</a>    ,        .NET Framework  .NET Core,  ,        . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN468611/">https://habr.com/ru/post/zh-CN468611/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN468601/index.html">é¡¹ç›®æœŸé™ä¼°ç®—ã€‚ ä¸ºä»€ä¹ˆå‡ ä¹æ€»æ˜¯ä½ä¼°äº†å®ƒä»¥åŠå¦‚ä½•å¤„ç†</a></li>
<li><a href="../zh-CN468603/index.html">Rutrackerå·²åŒ…å«eSNIã€‚ DPIæ—¶ä»£çš„ç»ˆç»“å’Œé”çš„ç»ˆç»“</a></li>
<li><a href="../zh-CN468605/index.html">æŒ‡å‘æŒ‡é’ˆçš„å¸¸é‡æŒ‡é’ˆ...</a></li>
<li><a href="../zh-CN468607/index.html">é¢å‘æ— çº¿ç”µå·¥ç¨‹å¸ˆçš„Androidï¼ˆç¬¬äºŒéƒ¨åˆ†ï¼‰</a></li>
<li><a href="../zh-CN468609/index.html">å¤šé‡è°ƒåº¦çš„éš¾ä»¥ç†è§£çš„è¡¨ç°</a></li>
<li><a href="../zh-CN468615/index.html">åº”ç”¨ç¨‹å¼æœ¬åœ°åŒ–çš„åå¤§è¯­è¨€</a></li>
<li><a href="../zh-CN468621/index.html">æˆ‘ä»¬å°†å®¶åº­ç½‘ç»œè½¬æ¢ä¸ºDoHï¼Œæˆ–å†æ¬¡å•å‡»è¿‡æ»¤é¼»å­</a></li>
<li><a href="../zh-CN468623/index.html">æˆ‘è¦åœ¨Habrä¸Šå‘è¡¨è¯„è®º</a></li>
<li><a href="../zh-CN468625/index.html">æ— æœåŠ¡å™¨ï¼šé€Ÿåº¦é™ä½15ï¼…ï¼Œä»·æ ¼æé«˜8å€</a></li>
<li><a href="../zh-CN468627/index.html">ADAM-6200 I / Oæ¨¡å—</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>