<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñêüèø üåÅ ‚ú¥Ô∏è Exploration des formats binaires en utilisant le bytecode du fichier .class comme exemple. üò° üöè üåº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si vous n'avez pas peur de l'image ci-dessus, si vous savez comment big-endian diff√®re de little-endian, si vous avez toujours √©t√© int√©ress√© par la fa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exploration des formats binaires en utilisant le bytecode du fichier .class comme exemple.</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481260/"><p><img src="https://habrastorage.org/webt/2-/ht/7w/2-ht7w15prc6owrbxqrljbxmq0g.png" alt="image"></p><br><p>  Si vous n'avez pas peur de l'image ci-dessus, si vous savez comment big-endian diff√®re de little-endian, si vous avez toujours √©t√© int√©ress√© par la fa√ßon dont les fichiers binaires sont "arrang√©s", alors cet article est pour VOUS! </p><a name="habracut"></a><br><h1 id="vvedenie">  Pr√©sentation </h1><br><p>  Sur Habr√©, il y avait d√©j√† plusieurs articles sur la r√©tro-ing√©nierie des formats binaires et sur l'√©tude de la structure bytecode d'un fichier .class: <br>  <a href="https://habr.com/ru/post/222519/">Pool de constantes</a> <br>  <a href="https://habr.com/ru/post/111456/">Fondamentaux Java Bytecode</a> , <br>  <a href="https://habr.com/ru/post/264919/">Bytecode Java "Bonjour tout le monde"</a> , <br>  <a href="https://habr.com/ru/post/480550/">Hello World de bytecode pour JVM</a> etc. <br>  Le chercheur a pour t√¢che soit de traiter un protocole binaire inconnu, soit de creuser une structure binaire pour laquelle il existe une sp√©cification. </p><br><p>  Mon int√©r√™t pour les formats binaires s'est manifest√© m√™me lorsque j'√©tais √©tudiant et j'ai √©crit un article sur le d√©veloppement du pilote du syst√®me de fichiers Linux.  Quelques ann√©es plus tard, j'ai donn√© des conf√©rences sur les bases de Linux pour les experts en m√©decine l√©gale - dans le temps, Linux √©tait une nouveaut√© et un jeune sp√©cialiste apr√®s l'universit√© pouvait dire beaucoup de nouvelles choses aux experts adultes.  En me disant comment supprimer un vidage d'un disque √† l'aide de dd, et apr√®s avoir connect√© l'image √† un autre ordinateur pour √©tude, j'ai r√©alis√© que l'image du disque contient beaucoup d'informations int√©ressantes.  Ces informations pourraient √™tre extraites m√™me sans monter l'image (hein, montage -o loop ...) si vous connaissiez les sp√©cifications du format du syst√®me de fichiers et disposiez des outils appropri√©s.  Malheureusement, je n'avais pas de tels outils. </p><br><p>  Apr√®s quelques ann√©es, j'avais besoin de d√©compiler la biblioth√®que Java.  Il n'y avait pas d'interface graphique JD √† cette √©poque, ainsi qu'un d√©compilateur id√©ologique, mais il y avait JAD.  Pour ma biblioth√®que, le JAD a produit un m√©lange d'opcodes Java avec des messages d'erreur.  De plus, JAD ne prenait pas en charge les annotations et dans Java 6, qui apparaissait alors, elles √©taient pleinement utilis√©es.  Arm√© de la sp√©cification de la machine virtuelle Java, j'ai commenc√© ... </p><br><h1 id="ideya">  Id√©e </h1><br><p>  J'avais besoin d'un m√©canisme universel pour d√©crire les structures binaires et d'un chargeur universel.  Le chargeur, en utilisant la description, lira les donn√©es binaires en m√©moire.  Vous devez g√©n√©ralement g√©rer des nombres, des cha√Ænes, des tableaux de donn√©es et des structures compos√©es.  Tout est simple avec des nombres - ils ont une longueur fixe - 1, 2, 4 ou 8 octets et peuvent √™tre imm√©diatement mapp√©s aux types de donn√©es disponibles dans la langue.  Par exemple: octet, court, int, long pour Java.  Pour les types num√©riques de plus d'un octet, un marqueur d'ordre d'octets (la repr√©sentation dite BigEndian / LittleEndiang) doit √™tre fourni. </p><br><p>  Les cha√Ænes sont plus compliqu√©es - elles peuvent √™tre dans diff√©rents encodages (ASCII, UNICODE), avoir une longueur fixe ou variable.  Une cha√Æne de longueur fixe peut √™tre consid√©r√©e comme un tableau d'octets.  Pour les cha√Ænes de longueur variable, vous pouvez utiliser deux options d'enregistrement - indiquer la longueur de la cha√Æne au d√©but de la cha√Æne (Pascal ou cha√Ænes pr√©fix√©es par la longueur) ou mettre un caract√®re sp√©cial √† la fin de la cha√Æne pour indiquer la fin de la cha√Æne.  En tant que tel signe, un octet avec une valeur de z√©ro est utilis√© (les soi-disant srings √† terminaison nulle).  Les deux options ont des avantages et des inconv√©nients, dont une discussion d√©passe le cadre de cet article.  Si la taille est sp√©cifi√©e au d√©but, alors lors du d√©veloppement du format, vous devez d√©terminer la longueur maximale de la cha√Æne: le nombre d'octets que nous devons allouer au marqueur de longueur en d√©pend: 2 <sup>8</sup> - 1 pour un octet, 2 <sup>16</sup> - 1 pour deux octets, etc. </p><br><p>  Nous distinguerons les structures de donn√©es composites en classes distinctes, en poursuivant la d√©composition en nombres et en cha√Ænes. </p><br><h1 id="struktura-class-fayla">  Structure du fichier .class </h1><br><p>  Nous devons en quelque sorte d√©crire la structure du fichier Java .class.  En cons√©quence, je voudrais avoir un ensemble de classes Java, o√π chaque classe ne contient que des champs qui correspondent √† la structure de donn√©es √† l'√©tude et, √©ventuellement, des m√©thodes auxiliaires pour afficher l'objet sous une forme lisible par l'homme lorsque la m√©thode toString () est appel√©e.  De mani√®re cat√©gorique, je ne voudrais pas avoir la logique √† l'int√©rieur qui est responsable de la lecture ou de l'√©criture d'un fichier. </p><br><p>  Nous prenons la sp√©cification de la machine virtuelle Java, <br>  <a href="https://docs.oracle.com/javase/specs/jvms/se12/jvms12.pdf" rel="nofollow">Sp√©cification JVM, Java SE 12 Edition</a> . <br>  Nous nous int√©resserons √† la section 4 "Le format de fichier de la classe". </p><br><p>  Afin de d√©terminer quels champs dans quel ordre charger, nous introduisons l'annotation @FieldOrder (index = ...).  Nous devons indiquer explicitement l'ordre des champs pour le chargeur, car la sp√©cification ne nous donne aucune garantie sur l'ordre dans lequel ils seront enregistr√©s dans un fichier binaire. </p><br><p>  Le fichier Java .class commence par 4 octets de nombre magique, deux octets de la version mineure de Java et deux octets de la version principale.  Nous emballons le nombre magique dans la variable int, et le num√©ro de version mineur et majeur en bref: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> magic; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> minorVersion; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> majorVersion;</code> </pre> <br><p>  Plus loin dans le fichier .class se trouve la taille du pool constant (variable √† deux octets) et du pool constant lui-m√™me.  Nous introduisons l'annotation @ContainerSize pour d√©clarer la taille des tableaux et des structures de liste.  La taille peut √™tre fixe (nous la d√©finirons via l'attribut value) ou avoir une longueur variable, d√©termin√©e par la variable pr√©c√©demment lue.  Dans ce cas, nous utiliserons l'attribut "fieldName", qui indique √† partir de quelle variable nous lirons la taille du conteneur.  Selon la sp√©cification (section 4.1, <br>  "La structure ClassFile"), la taille r√©elle du pool constant diff√®re de 1 de la valeur <br>  qui est √©crit dans constant_pool_count: </p><br><pre> <code class="plaintext hljs">u2 constant_pool_count; cp_info constant_pool[constant_pool_count-1];</code> </pre> <br><p>  Pour tenir compte de ces corrections, nous introduisons un attribut correcteur suppl√©mentaire dans les annotations @ContainerSize. <br>  Maintenant, nous pouvons ajouter une description du pool constant: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> constantPoolCount; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"constantPoolCount"</span></span>, corrector = -<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ConstantPoolItem&gt; constantPoolList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;();</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Dans le cas de calculs plus complexes, vous pouvez simplement ajouter une m√©thode get qui retournera la valeur souhait√©e:</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> containerSize; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(filed=<span class="hljs-string"><span class="hljs-string">"actualContainerSize"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;ContainerItem&gt; containerItems; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getActualContainerSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> containerSize * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> </div></div><br><h1 id="constant-pool">  Piscine constante </h1><br><p>  Chaque √©l√©ment du pool de constantes est soit une description de la constante correspondante de type int, long, float, double, String, soit une description de l'un des composants de la classe Java - champs de classe (champs), m√©thodes, signatures de m√©thode, etc.  Le terme "constante" signifie ici une valeur sans nom utilis√©e dans le code: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (intValue &gt; <span class="hljs-number"><span class="hljs-number">100500</span></span>)</code> </pre> <br><p>  Une valeur de 100500 sera repr√©sent√©e dans le pool constant sous la forme d'une instance de CONSTANT_Integer.  La sp√©cification JVM pour Java 12 d√©finit 17 types qui peuvent √™tre dans un pool constant. </p><br><div class="spoiler">  <b class="spoiler_title">Instances possibles d'√©l√©ments de pool de const</b> <div class="spoiler_text"><div class="scrollable-table"><table><thead><tr><th>  Type constant </th><th>  Tag </th></tr></thead><tbody><tr><td>  CONSTANT_Class </td><td>  7 </td></tr><tr><td>  CONSTANT_Fieldref </td><td>  9 </td></tr><tr><td>  CONSTANT_Methodref </td><td>  10 </td></tr><tr><td>  CONSTANT_InterfaceMethodref </td><td>  11 </td></tr><tr><td>  CONSTANT_String </td><td>  8 </td></tr><tr><td>  CONSTANT_Integer </td><td>  3 </td></tr><tr><td>  CONSTANT_Float </td><td>  4 </td></tr><tr><td>  CONSTANT_Long </td><td>  5 </td></tr><tr><td>  CONSTANT_Double </td><td>  6 </td></tr><tr><td>  CONSTANT_NameAndType </td><td>  12 </td></tr><tr><td>  CONSTANT_Utf8 </td><td>  1 </td></tr><tr><td>  CONSTANT_MethodHandle </td><td>  15 </td></tr><tr><td>  CONSTANT_MethodType </td><td>  16 </td></tr><tr><td>  CONSTANT_Dynamic </td><td>  17 </td></tr><tr><td>  CONSTANT_InvokeDynamic </td><td>  18 </td></tr><tr><td>  CONSTANT_Module </td><td>  19 </td></tr><tr><td>  CONSTANT_Package </td><td>  20 </td></tr></tbody></table></div></div></div><br><p>  Dans notre impl√©mentation, nous allons cr√©er une classe ConstantPoolItem dans laquelle il y aura une balise de champ √† un octet, qui d√©termine la structure que nous lisons en ce moment.  Pour chaque √©l√©ment du tableau ci-dessus, cr√©ez une classe Java, un descendant de ConstantPoolItem.  Un chargeur de fichiers binaires universel devrait √™tre en mesure de d√©terminer la classe √† utiliser en fonction d'une balise d√©j√† lue. <br>  (en g√©n√©ral, une balise peut √™tre une variable de tout type).  Pour cela, d√©finissez l'interface HasInheritor et impl√©mentez cette interface dans la classe ConstantPoolItem: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasInheritor</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends T&gt; getInheritor() <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> InheritorNotFoundException; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Collection&lt;Class&lt;? extends T&gt;&gt; getInheritors(); }</code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstantPoolItem</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HasInheritor</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstantPoolItem</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Map&lt;Byte, Class&lt;? extends ConstantPoolItem&gt;&gt; m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">7</span></span>, ClassInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span>, FieldRefInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">10</span></span>, MethodRefInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">11</span></span>, InterfaceMethodRefInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">8</span></span>, StringInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">3</span></span>, IntegerInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span>, FloatInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">5</span></span>, LongInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span>, DoubleInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">12</span></span>, NameAndTypeInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span>, Utf8Info.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">15</span></span>, MethodHandleInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">16</span></span>, MethodTypeInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">17</span></span>, DynamicInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">18</span></span>, InvokeDynamicInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">19</span></span>, ModuleInfo.class); m.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) <span class="hljs-number"><span class="hljs-number">20</span></span>, PackageInfo.class); } <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> tag; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;? extends ConstantPoolItem&gt; getInheritor() <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> InheritorNotFoundException { Class&lt;? extends ConstantPoolItem&gt; clazz = m.get(tag); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clazz == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InheritorNotFoundException(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getClass().getName(), String.valueOf(tag)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> clazz; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Collection&lt;Class&lt;? extends ConstantPoolItem&gt;&gt; getInheritors() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> m.values(); } }</code> </pre> <br><p>  Le chargeur universel instanciera la classe requise et continuera la lecture.  Seule condition: les index des classes successives doivent avoir une num√©rotation de bout en bout avec la classe parente.  Cela signifie que dans toutes les classes constantes de ConstantPoolItem, FieldOrder, l'annotation doit avoir un index sup√©rieur √† un, car dans la classe parente, nous lisons d√©j√† le champ de balise avec le num√©ro "1". </p><br><h1 id="struktura-class-fayla-prodolzhenie">  Structure du fichier .class (suite) </h1><br><p>  Apr√®s la liste des √©l√©ments du pool constant dans le fichier .class, il y a un identifiant √† deux octets qui d√©finit les d√©tails de cette classe - la classe est-elle une annotation, une interface, une classe abstraite, a-t-elle un drapeau final, etc.  Ceci est suivi d'un identifiant √† deux octets (une r√©f√©rence √† un √©l√©ment dans le pool constant) qui d√©finit cette classe.  Cet identifiant doit pointer vers un √©l√©ment de type ClassInfo.  La superclasse pour une classe donn√©e est d√©finie de mani√®re similaire (ce qui est indiqu√© apr√®s le mot "√©tend" dans la d√©finition de classe).  Pour les classes qui n'ont pas de superclasses d√©finies explicitement, ce champ contient une r√©f√©rence √† la classe Object. </p><br><p>  En Java, toute classe ne peut avoir qu'une seule superclasse, mais le nombre <br>  Il peut y avoir plusieurs interfaces que cette classe impl√©mente: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> interfacesCount; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"interfacesCount"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Short&gt; interfaceIndexList;</code> </pre> <br><p>  Chaque √©l√©ment dans interfaceIndexList repr√©sente un lien vers un √©l√©ment dans le pool constant (comme sp√©cifi√© <br>  l'index doit √™tre un √©l√©ment de type ClassInfo). <br>  Les variables de classe (propri√©t√©s, champs) et les m√©thodes sont repr√©sent√©es par les listes correspondantes: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> fieldsCount; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"fieldsCount"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Field&gt; fieldList; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> methodsCount; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"methodsCount"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Method&gt; methodList;</code> </pre> <br><p>  Le dernier √©l√©ment de la description du fichier Java .class est la liste des attributs de classe.  Les attributs d√©crivant le fichier source li√© √† la classe, les classes imbriqu√©es, etc. peuvent √™tre r√©pertori√©s ici. </p><br><p>  Le bytecode Java fonctionne avec des donn√©es num√©riques dans une repr√©sentation big-endian, nous utiliserons cette repr√©sentation par d√©faut.  Pour les formats binaires avec des nombres little-endian, nous utiliserons l'annotation <a href="https://habr.com/ru/users/littleendian/" class="user_link">LittleEndian</a> .  Pour les cha√Ænes qui n'ont pas de longueur pr√©d√©finie, mais <br>  sont lus avant le caract√®re terminal (comme les cha√Ænes terminales nulles de type C), nous utiliserons <br>  Annotation @StringTerminator: </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@StringTerminator</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String nullTerminatedString;</code> </pre> <br><p>  Parfois, dans les classes sous-jacentes, vous devez transmettre des informations d'un niveau sup√©rieur.  L'objet Method dans methodList ne contient pas d'informations sur le nom de la classe dans laquelle il se trouve; en outre, l'objet m√©thode ne contient pas son nom et sa liste de param√®tres.  Toutes ces informations sont pr√©sent√©es sous forme d'indices sur les √©l√©ments du pool constant.  Cela suffit pour une machine virtuelle, mais nous aimerions impl√©menter les m√©thodes toString () afin qu'elles affichent les informations sur la m√©thode sous une forme conviviale, et non sous la forme d'index sur les √©l√©ments du pool constant.  Pour ce faire, la classe Method doit obtenir une r√©f√©rence √† ConstantPoolList et √† une variable avec la valeur de thisClassIndex.  Pour pouvoir transmettre des liens vers les niveaux d'imbrication sous-jacents, nous utiliserons l'annotation <a href="https://habr.com/ru/users/inject/" class="user_link">Inject</a> : </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ContainerSize</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"methodsCount"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"constantPoolList"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span>(fieldName = <span class="hljs-string"><span class="hljs-string">"thisClassIndex"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Method&gt; methodList;</code> </pre> <br><p>  Dans la classe actuelle (ClassFile), les m√©thodes getter seront appel√©es pour les variables constantPoolList et thisClassIndex, et dans la classe r√©ceptrice (dans ce cas, Method), les m√©thodes setter seront appel√©es (si elles sont pr√©sentes). </p><br><h1 id="universalnyy-zagruzchik">  Chargeur de d√©marrage universel </h1><br><p>  Nous avons donc une interface HasInheritor et cinq annotations @FieldOrder, @ContainerSize, <a href="https://habr.com/ru/users/littleendian/" class="user_link">LittleEndian</a> , <a href="https://habr.com/ru/users/inject/" class="user_link">Inject</a> et @StringTerminator, qui nous permettent de d√©crire les structures binaires √† un niveau d'abstraction √©lev√©.  Ayant une description formelle, nous pouvons la transmettre au chargeur universel, qui peut instancier la structure d√©crite, analyser le fichier binaire et le lire en m√©moire. </p><br><p>  Par cons√©quent, nous devrions pouvoir utiliser ce code: </p><br><pre> <code class="java hljs"> ClassFile classFile; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (InputStream is = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(inputFileName)) { Loader loader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamLoader(is); classFile = (ClassFile) loader.load(); }</code> </pre> <br><p>  Malheureusement, les d√©veloppeurs de plates-formes Java sont un peu trop sophistiqu√©s pour les valeurs de huit octets dans le pool. <br>  des constantes sont fournies pour deux cellules, la premi√®re cellule doit contenir une valeur et la seconde reste <br>  vide.  Cela s'applique aux constantes longues et doubles. </p><br><div class="spoiler">  <b class="spoiler_title">Description de la sp√©cification JVM</b> <div class="spoiler_text"><p>  Toutes les constantes de 8 octets occupent deux entr√©es dans la table constant_pool de la classe <br>  fichier.  Si une structure CONSTANT_Long_info ou CONSTANT_Double_info est l'entr√©e <br>  √† l'index n dans la table constant_pool, la prochaine entr√©e utilisable dans la table est <br>  situ√© √† l'indice n + 2.  L'index constant_pool n + 1 doit √™tre valide mais est consid√©r√© <br>  inutilisable. </p></div></div><br>  Apparemment, les d√©veloppeurs Java voulaient appliquer une sorte d'optimisation de bas niveau, mais plus tard <br>  il a √©t√© reconnu que cette d√©cision de conception a tourn√© <br><div class="spoiler">  <b class="spoiler_title">infructueux.</b> <div class="spoiler_text"><p>  R√©trospectivement, faire des constantes de 8 octets prendre deux entr√©es de pool constantes √©tait un mauvais choix. </p></div></div><br><p>  Pour g√©rer ces cas sp√©cifiques, nous allons ajouter l'annotation @EntrySize, que nous utiliserons, <br>  pour baliser les constantes √† huit octets: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@EntrySize</span></span>(value = <span class="hljs-number"><span class="hljs-number">2</span></span>, index = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EightByteNumberInfo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstantPoolItem</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> highBytes; <span class="hljs-meta"><span class="hljs-meta">@FieldOrder</span></span>(index = <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lowBytes; }</code> </pre> <br><p>  L'attribut value indique le nombre de cellules que l'√©l√©ment occupera, index - l'index de l'√©l√©ment, <br>  qui contient la valeur.  les classes LongInfo et DoubleInfo √©tendront la classe EightByteNumberInfo. <br>  Le chargeur de d√©marrage universel devra √™tre √©tendu avec une fonctionnalit√© prenant en charge l'annotation @EntrySize. </p><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClassFileLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fileName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { File f = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(fileName); FileInputStream fis = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(f); loader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntrySizeSupportLoader(fis); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FileNotFoundException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } }</code> </pre> <br><p>  Apr√®s avoir charg√© la classe avec ClassFileLoader, vous pouvez arr√™ter le d√©bogueur et examiner la classe charg√©e dans l'inspecteur de variables dans l'EDI. </p><br><p>  Le fichier de classe ressemblera √† ceci: <br><img src="https://habrastorage.org/webt/s6/jg/p_/s6jgp_an_ouz-lfdtc39d8gxd88.png" alt="image"></p><br><p>  Et Constant Pool est comme √ßa: <br><img src="https://habrastorage.org/webt/5f/u4/sk/5fu4skrhx-jxhjjyiju4nc_apj0.png" alt="image"></p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  Quiconque peut lire jusqu'√† la fin peut vouloir choisir le bytecode Java de ses propres mains.  N'h√©sitez pas √† acc√©der au github et √† t√©l√©charger la description du fichier de classe Java en tant qu'ensemble de classes Java: <a href="https://github.com/esavin/annotate4j-classfile" rel="nofollow">https://github.com/esavin/annotate4j-classfile</a> .  Le chargeur universel et les annotations sont ici: <a href="https://github.com/esavin/annotate4j-core" rel="nofollow">https://github.com/esavin/annotate4j-core</a> . </p><br><p>  Pour t√©l√©charger un fichier de classe compil√©, utilisez le chargeur annotate4j.classfile.loader.ClassFileLoader. </p><br><p>  La plupart du code a √©t√© √©crit pour Java 6, j'ai adapt√© uniquement le pool constant aux versions modernes.  Je n'avais pas la force et le d√©sir d'impl√©menter compl√®tement le chargeur Java pour les opcodes Java, il n'y a donc que de petits d√©veloppements dans cette partie. </p><br><p>  En utilisant cette biblioth√®que (partie principale), j'ai r√©ussi √† restaurer le fichier binaire avec les donn√©es de surveillance Holter (√©tude ECG de l'activit√© cardiaque quotidienne).  En revanche, je n'ai pas pu d√©crypter le protocole binaire d'un syst√®me comptable √©crit en Delphi.  Je ne comprenais pas comment les dates sont transmises, et parfois une situation survient lorsque les donn√©es r√©elles ne correspondent pas √† la structure construite sur les valeurs pr√©c√©dentes. </p><br><p>  J'ai essay√© de construire un mod√®le similaire au fichier de classe Java pour le format ELF (format ex√©cutable sur Unix / Linux), mais je ne pouvais pas comprendre pleinement la sp√©cification - cela s'est av√©r√© trop vague pour moi.  Le m√™me sort est arriv√© aux formats JPEG et BMP - tout le temps, je rencontrais des difficult√©s pour comprendre les sp√©cifications. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481260/">https://habr.com/ru/post/fr481260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481250/index.html">AI vs testeurs, Brandashmyg, canards: comment s'est pass√© Heisenbug 2019 Moscou</a></li>
<li><a href="../fr481252/index.html">Nous activons le support NVMe sur les anciennes cartes m√®res en utilisant l'Asus P9X79 WS comme exemple</a></li>
<li><a href="../fr481254/index.html">Programmeur fanatique. Synopsis partie 1. Pourquoi vous devez √™tre pire et ne pas √©couter les conseils des parents</a></li>
<li><a href="../fr481256/index.html">Quelle startup dois-je lancer demain?</a></li>
<li><a href="../fr481258/index.html">Nous collons le cadre de la go√©lette sans inscription et SMS</a></li>
<li><a href="../fr481264/index.html">Combien de personnes voient votre ic√¥ne dans l'App Store pendant l'application ¬´App du jour¬ª</a></li>
<li><a href="../fr481272/index.html">Gel ou modernisation - que faisons-nous en vacances?</a></li>
<li><a href="../fr481276/index.html">Comment j'ai cr√©√© mon PJ et mon compilateur pendant 12 ans</a></li>
<li><a href="../fr481280/index.html">Comment nous avons pr√©par√© l'√©tape de qualification de CTFZone-2020</a></li>
<li><a href="../fr481282/index.html">Que vaut l'id√©e et comment la transformer en concept: des outils de game designer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>