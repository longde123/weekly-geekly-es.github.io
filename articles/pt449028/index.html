<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò´ ü•õ üëßüèø Raiva, barganha e depress√£o ao trabalhar com o InfluxDB üìõ üë®üèø‚Äçüî¨ üë®üèº‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se voc√™ usar o banco de dados de s√©ries temporais (timeseries db, wiki ) como o reposit√≥rio principal de um site com estat√≠sticas, em vez de resolver ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Raiva, barganha e depress√£o ao trabalhar com o InfluxDB</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449028/"><img src="https://habrastorage.org/webt/t2/ck/io/t2ckiopr9_xbq3n4mbrhs868k1g.png" alt="Influxdb"><br><br>  Se voc√™ usar o banco de dados de s√©ries temporais (timeseries db, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wiki</a> ) como o reposit√≥rio principal de um site com estat√≠sticas, em vez de resolver o problema, poder√° sentir muita dor de cabe√ßa.  Estou trabalhando em um projeto em que esse banco de dados √© usado e, algumas vezes, o InfluxDB, que ser√° discutido, apresentou surpresas inesperadas em geral. <br><a name="habracut"></a><br>  <b>Isen√ß√£o de responsabilidade</b> : Esses problemas s√£o para o InfluxDB 1.7.4. <br><br><h3>  Por que s√©ries temporais? </h3><br>  O projeto √© rastrear transa√ß√µes em v√°rias cadeias de blocos e exibir estat√≠sticas.  Especificamente, analisamos a emiss√£o e queima de moedas est√°veis ‚Äã‚Äã( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">wiki</a> ).  Com base nessas transa√ß√µes, voc√™ precisa criar gr√°ficos e mostrar tabelas din√¢micas. <br><br>  Ao analisar as transa√ß√µes, surgiu a id√©ia: usar o banco de dados de s√©ries temporais do InfluxDB como armazenamento principal.  As transa√ß√µes s√£o pontos no tempo e se encaixam bem no modelo de s√©rie temporal. <br><br>  Al√©m disso, as fun√ß√µes de agrega√ß√£o pareciam muito convenientes - elas s√£o ideais para processar gr√°ficos por um longo per√≠odo.  O usu√°rio precisa de um gr√°fico para o ano e o banco de dados cont√©m um conjunto de dados com um per√≠odo de cinco minutos.  N√£o faz sentido enviar-lhe cem mil pontos - exceto pelo processamento longo, eles n√£o caber√£o na tela.  Voc√™ pode escrever sua pr√≥pria implementa√ß√£o para aumentar o per√≠odo ou usar as fun√ß√µes de agrega√ß√£o criadas no Influx.  Com a ajuda deles, voc√™ pode agrupar dados por dia e enviar os 365 pontos desejados. <br><br>  Foi um pouco embara√ßoso que geralmente esses bancos de dados sejam usados ‚Äã‚Äãpara coletar m√©tricas.  Servidores de monitoramento, dispositivos iot, todos dos quais milh√µes de pontos da forma "fluem": [&lt;time&gt; - &lt;valor m√©trico&gt;].  Mas se o banco de dados funciona bem com um grande fluxo de dados, por que uma pequena quantidade causa problemas?  Com isso em mente, eles levaram o InfluxDB para trabalhar. <br><br><h3>  O que mais √© conveniente no InfluxDB </h3><br>  Al√©m das fun√ß√µes de agrega√ß√£o mencionadas, h√° outra grande coisa - <b>consultas cont√≠nuas</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">doc</a> ).  Este √© um planejador embutido no banco de dados que pode processar dados em um planejamento.  Por exemplo, voc√™ pode agrupar todos os registros de um dia a cada 24 horas, calcular a m√©dia e escrever um novo ponto em outra tabela sem escrever suas pr√≥prias bicicletas. <br><br>  Tamb√©m h√° <b>pol√≠ticas de reten√ß√£o</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">doc</a> ) - configurando a exclus√£o de dados ap√≥s um per√≠odo.  √â √∫til quando, por exemplo, voc√™ precisa armazenar a carga na CPU por uma semana com medi√ß√µes uma vez por segundo, mas a uma dist√¢ncia de alguns meses essa precis√£o n√£o √© necess√°ria.  Nessa situa√ß√£o, voc√™ pode fazer o seguinte: <br><br><ol><li>  crie uma consulta cont√≠nua para agregar dados em outra tabela; </li><li>  Para a primeira tabela, defina uma pol√≠tica para excluir m√©tricas anteriores √† semana. </li></ol><br>  E o Influx reduzir√° independentemente o tamanho dos dados e excluir√° desnecessariamente. <br><br><h3>  Sobre dados armazenados </h3><br>  Poucos dados s√£o armazenados: cerca de 70 mil transa√ß√µes e outro milh√£o de pontos com informa√ß√µes de mercado.  Adicionando novas entradas - n√£o mais que 3000 pontos por dia.  Tamb√©m existem m√©tricas no site, mas existem poucos dados e, pela pol√≠tica de reten√ß√£o, eles s√£o armazenados por n√£o mais que um m√™s. <br><br><h3>  Os problemas </h3><br>  Durante o desenvolvimento e os testes subsequentes do servi√ßo, surgiram problemas cada vez mais cr√≠ticos durante a opera√ß√£o do InfluxDB. <br><br><h4>  1. Exclus√£o de dados </h4><br>  H√° uma s√©rie de dados com transa√ß√µes: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>, amount, <span class="hljs-keyword"><span class="hljs-keyword">block</span></span>, symbol <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> transactions <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> symbol=<span class="hljs-string"><span class="hljs-string">'USDT'</span></span></code> </pre> <br>  Resultado: <br><br><img src="https://habrastorage.org/webt/lg/1m/us/lg1musgntnlnrlps2vpswkph5z0.png"><br><br>  Eu envio um comando para excluir dados: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> transactions <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> symbol=<span class="hljs-string"><span class="hljs-string">'USDT'</span></span></code> </pre> <br>  Em seguida, solicito o recebimento de dados j√° exclu√≠dos.  E o Influx, em vez de uma resposta vazia, retorna parte dos dados que devem ser exclu√≠dos. <br><br>  Eu tento excluir a tabela inteira: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> MEASUREMENT transactions</code> </pre> <br>  Verifico a exclus√£o da tabela: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SHOW</span></span> MEASUREMENTS</code> </pre> <br>  N√£o assisto √† tabela na lista, mas uma nova solicita√ß√£o de dados ainda retorna o mesmo conjunto de transa√ß√µes. <br><br>  O problema me ocorreu apenas uma vez, pois o caso de exclus√£o √© um caso isolado.  Mas esse comportamento do banco de dados claramente n√£o se enquadra na estrutura do trabalho "correto".  Mais tarde, no github, encontrei um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ticket</a> aberto h√° quase um ano sobre esse t√≥pico. <br><br>  Como resultado, a remo√ß√£o e a restaura√ß√£o subsequente de todo o banco de dados ajudaram. <br><br><h4>  2. N√∫meros de ponto flutuante </h4><br>  C√°lculos matem√°ticos usando as fun√ß√µes internas do InfluxDB fornecem erros de precis√£o.  N√£o que fosse algo incomum, mas desagrad√°vel. <br><br>  No meu caso, os dados t√™m um componente financeiro e eu gostaria de process√°-los com alta precis√£o.  Por esse motivo, os planos de abandonar consultas cont√≠nuas. <br><br><h4>  3. As consultas cont√≠nuas n√£o podem ser adaptadas a diferentes fusos hor√°rios </h4><br>  O servi√ßo possui uma tabela com estat√≠sticas di√°rias sobre transa√ß√µes.  Para cada dia, voc√™ precisa agrupar todas as transa√ß√µes para esse dia.  Mas o dia para cada usu√°rio come√ßar√° em um hor√°rio diferente, portanto, o conjunto de transa√ß√µes √© diferente.  O UTC possui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">37 op√ß√µes de</a> turno para as quais voc√™ precisa agregar dados. <br><br>  Ao agrupar por hora no InfluxDB, voc√™ tamb√©m pode especificar um turno, por exemplo, para a hora de Moscou (UTC + 3): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MEAN(<span class="hljs-string"><span class="hljs-string">"supply"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> transactions <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> symbol, <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>d, <span class="hljs-number"><span class="hljs-number">3</span></span>h) fill(previous)</code> </pre> <br>  Mas o resultado da consulta estar√° incorreto.  Por alguma raz√£o, os dados agrupados por dia come√ßar√£o em 1677 (o InfluxDB suporta oficialmente o per√≠odo deste ano): <br><br><img src="https://habrastorage.org/webt/ze/cw/oz/zecwoz4n2fxfpsugncvgydiyhvy.png"><br><br>  Para contornar esse problema, o servi√ßo foi temporariamente transferido para o UTC + 0. <br><br><h4>  4. Desempenho </h4><br>  Existem muitos benchmarks na Internet com compara√ß√µes do InfluxDB e outros bancos de dados.  No primeiro contato, eles pareciam materiais de marketing, mas agora acho que h√° alguma verdade neles. <br><br>  Vou lhe contar o meu caso. <br><br>  O servi√ßo fornece um m√©todo de API que retorna estat√≠sticas para o √∫ltimo dia.  Durante os c√°lculos, o m√©todo consulta o banco de dados tr√™s vezes com as seguintes consultas: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> coins_info <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &lt;= <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> symbol <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dominance_info <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> transactions <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt;= <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>() - <span class="hljs-number"><span class="hljs-number">24</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br>  Explica√ß√£o <br><br><ol><li>  Na primeira consulta, obtemos os √∫ltimos pontos para cada moeda com dados de mercado.  Oito pontos por oito moedas no meu caso. <br></li><li>  A segunda solicita√ß√£o recebe um o ponto mais novo. <br></li><li>  O terceiro solicita uma lista de transa√ß√µes para o √∫ltimo dia, pode haver v√°rias centenas. <br></li></ol><br>  Esclarecemos que, no InfluxDB, um √≠ndice √© criado automaticamente por tags e por tempo, o que acelera as consultas.  Na primeira consulta, o <i>s√≠mbolo</i> √© a tag. <br><br>  Fiz um teste de estresse para esse m√©todo API.  Para 25 RPS, o servidor mostrou uma carga completa de seis CPUs: <br><br><img src="https://habrastorage.org/webt/t2/ck/io/t2ckiopr9_xbq3n4mbrhs868k1g.png"><br><br>  Ao mesmo tempo, o processo NodeJs n√£o forneceu nenhuma carga. <br><br>  A velocidade de execu√ß√£o j√° foi reduzida em 7 a 10 RPS: se um cliente puder receber uma resposta em 200 ms, 10 clientes dever√£o esperar um segundo.  25 RPS - a fronteira com a qual a estabilidade sofreu, foram devolvidos 500 erros aos clientes. <br><br>  Com esse desempenho, √© imposs√≠vel usar o Influx em nosso projeto.  Al√©m disso: em um projeto em que voc√™ precisa demonstrar o monitoramento para muitos clientes, problemas semelhantes podem aparecer e o servidor de m√©tricas ser√° sobrecarregado. <br><br><h3>  Conclus√£o </h3><br>  A conclus√£o mais importante da experi√™ncia obtida √© que voc√™ n√£o pode levar uma tecnologia desconhecida para o projeto sem an√°lise suficiente.  Uma simples triagem de tickets abertos no github pode fornecer informa√ß√µes para n√£o levar o InfluxDB como o principal data warehouse. <br><br>  O InfluxDB deveria ter sido bem adequado para as tarefas do meu projeto, mas, como a pr√°tica demonstrou, esse banco de dados n√£o atende √†s necessidades e atrapalha muito. <br><br>  Voc√™ j√° pode encontrar a vers√£o 2.0.0-beta no reposit√≥rio do projeto, espera-se que na segunda vers√£o haja melhorias significativas.  Enquanto isso, vou estudar a documenta√ß√£o do TimescaleDB. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt449028/">https://habr.com/ru/post/pt449028/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt449016/index.html">Esteganografia no sistema de arquivos de disco √≥ptico</a></li>
<li><a href="../pt449020/index.html">Analisando o c√≥digo da plataforma CUBA com o PVS-Studio</a></li>
<li><a href="../pt449022/index.html">An√°lise de c√≥digo da plataforma CUBA usando o PVS-Studio</a></li>
<li><a href="../pt449024/index.html">"O Segredo do Terceiro Planeta" com gr√°ficos aprimorados de redes neurais</a></li>
<li><a href="../pt449026/index.html">Sistemas operacionais: tr√™s pe√ßas f√°ceis. Parte 4: Introdu√ß√£o ao Agendador (tradu√ß√£o)</a></li>
<li><a href="../pt449032/index.html">Projetamos um sistema de extin√ß√£o de inc√™ndios por aspers√£o</a></li>
<li><a href="../pt449034/index.html">Citymobil - um manual para melhorar a disponibilidade em meio ao crescimento dos neg√≥cios para startups. Parte 1</a></li>
<li><a href="../pt449036/index.html">E novamente o lobo em pele de cordeiro</a></li>
<li><a href="../pt449038/index.html">Gerenciando cont√™ineres do Docker no Go</a></li>
<li><a href="../pt449040/index.html">Semana 17 de seguran√ßa: ataques √† cadeia de suprimentos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>