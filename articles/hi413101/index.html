<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯзФЁЯП╛ тШБя╕П ЁЯТм рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИ рдлреЙрд░реНрдо рдлреИрдХреНрдЯрд░ рдореЗрдВ рдПрд╕рдЯреАрдПрдо 32 рдПрдл 4 рдбрд┐рдмрдЧ рдмреЛрд░реНрдб ЁЯФ│ ЁЯР╢ ЁЯТк</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рд╢реБрдн рджреЛрдкрд╣рд░, рдкреНрд░рд┐рдп рдЦрд╛рдмрд░реЛрд╡рд┐рддреНрд╕! рдореИрдВ рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ рдЬрдирддрд╛ рдХреЗ рд╕рд╛рдордиреЗ рд▓рд╛рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ - STM32 рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛ рдбрд┐рдмрдЧ рдмреЛрд░реНрдб, рд▓реЗрдХрд┐рди рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИ рдлреЙрд░реНрдо рдлреИрдХреН...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИ рдлреЙрд░реНрдо рдлреИрдХреНрдЯрд░ рдореЗрдВ рдПрд╕рдЯреАрдПрдо 32 рдПрдл 4 рдбрд┐рдмрдЧ рдмреЛрд░реНрдб</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413101/"><p><img src="https://habrastorage.org/webt/m_/xs/9t/m_xs9tnnhio8gxliqrjhdj3zxxw.jpeg" alt="рдЫрд╡рд┐" align="left">  рд╢реБрдн рджреЛрдкрд╣рд░, рдкреНрд░рд┐рдп рдЦрд╛рдмрд░реЛрд╡рд┐рддреНрд╕!  рдореИрдВ рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ рдЬрдирддрд╛ рдХреЗ рд╕рд╛рдордиреЗ рд▓рд╛рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВ - STM32 рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛ рдбрд┐рдмрдЧ рдмреЛрд░реНрдб, рд▓реЗрдХрд┐рди рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИ рдлреЙрд░реНрдо рдлреИрдХреНрдЯрд░ рдореЗрдВред  рдпрд╣ рдЕрдиреНрдп рдбрд┐рдмрдЧ рдмреЛрд░реНрдбреЛрдВ рд╕реЗ рднрд┐рдиреНрди рд╣реИ рдХрд┐ рдЗрд╕рдореЗрдВ рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИ рдорд╛рдорд▓реЛрдВ рдХреЗ рд╕рд╛рде рд╕рдВрдЧрдд рдПрдХ рдЬреНрдпрд╛рдорд┐рддрд┐ рдФрд░ рдПрдХ рд╡рд╛рдпрд░рд▓реЗрд╕ рдореЙрдбреЗрдо рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рдИрдПрд╕рдкреА 8266 рдореЙрдбреНрдпреВрд▓ рд╣реИред  рдФрд░ рдорд╛рдЗрдХреНрд░реЛ-рдПрд╕рдбреА рдХрд╛рд░реНрдб рдФрд░ рдПрдХ рд╕реНрдЯреАрд░рд┐рдпреЛ рдПрдореНрдкрд▓реАрдлрд╛рдпрд░ рдХреЗ рд▓рд┐рдП рдХрдиреЗрдХреНрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЕрдЪреНрдЫрд╛ рдЬреЛрдбрд╝ред  рдЗрд╕ рд╕рднреА рдзрди рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдПрдХ рдЙрдЪреНрдЪ-рд╕реНрддрд░реАрдп рдкреБрд╕реНрддрдХрд╛рд▓рдп рдФрд░ рдПрдХ рдбреЗрдореЛ рдкреНрд░реЛрдЧреНрд░рд╛рдо (C ++ 11 рдореЗрдВ) рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ред  рд▓реЗрдЦ рдореЗрдВ рдореИрдВ рдЗрд╕ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдФрд░ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рджреЛрдиреЛрдВ рд╣рд┐рд╕реНрд╕реЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡рд░реНрдгрди рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВред </p><a name="habracut"></a><br><p>  рдЗрд╕ рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕реЗ рдХреМрди рд▓рд╛рднрд╛рдиреНрд╡рд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ?  рд╢рд╛рдпрдж, рдХреЗрд╡рд▓ рдЙрди рд▓реЛрдЧреЛрдВ рдХреЛ рдЬреЛ рдЗрд╕ рдмреЛрд░реНрдб рдХреЛ рдЦреБрдж рдХреЛ рдорд┐рд▓рд╛рдк рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рдореИрдВ рдЫреЛрдЯреЗ рдкреИрдорд╛рдиреЗ рдкрд░ рдЙрддреНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рднреА рдХреЛрдИ рд╡рд┐рдХрд▓реНрдк рдирд╣реАрдВ рдорд╛рдирддрд╛ рд╣реВрдВред  рдпрд╣ рдПрдХ рд╢реБрджреНрдз рд╢реМрдХ рд╣реИред  рдореЗрд░реА рд░рд╛рдп рдореЗрдВ, рдмреЛрд░реНрдб рдХрд╛рд░реНрдпреЛрдВ рдХреА рдПрдХ рд╡рд┐рд╕реНрддреГрдд рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╡рд╛рдИрдлрд╛рдИ рдФрд░ рдзреНрд╡рдирд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЫреЛрдЯреЗ рдШрд░ рдХреЗ рд╢рд┐рд▓реНрдк рдХреЗ рдврд╛рдВрдЪреЗ рдореЗрдВ рдЙрддреНрдкрдиреНрди рд╣реЛ рд╕рдХрддрд╛ рд╣реИред </p><br><p>  рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВ рдЗрд╕ рд╕рд╡рд╛рд▓ рдХрд╛ рдЬрд╡рд╛рдм рджреЗрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реВрдВрдЧрд╛ рдХрд┐ рдпрд╣ рд╕рдм рдХреНрдпреЛрдВ рд╣реИред  рдЗрд╕ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рдореБрдЦреНрдп рдкреНрд░реЗрд░рдХ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИрдВ: </p><br><ul><li>  STM32 рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдХрд╛ рд╡рд┐рдХрд▓реНрдк рд╡рд┐рд╢реБрджреНрдз рд░реВрдк рд╕реЗ рд╕реМрдВрджрд░реНрдп рд╕рдВрдмрдВрдзреА рд╡рд┐рдЪрд╛рд░реЛрдВ рдХреЗ рдХрд╛рд░рдг рд╣реИ - рдореБрдЭреЗ рдореВрд▓реНрдп / рдкреНрд░рджрд░реНрд╢рди рдЕрдиреБрдкрд╛рдд, рдкреНрд▓рд╕ рдмрд╛рд╣реНрдп рдЙрдкрдХрд░рдгреЛрдВ рдХреА рдПрдХ рд╡рд┐рд╕реНрддреГрдд рд╢реНрд░реГрдВрдЦрд▓рд╛, рдкреНрд▓рд╕ рдирд┐рдпрдВрддреНрд░рдХ рдирд┐рд░реНрдорд╛рддрд╛ (sw4stm, cubeMX, HAL рдкреБрд╕реНрддрдХрд╛рд▓рдп) рд╕реЗ рдПрдХ рдмрдбрд╝рд╛ рдФрд░ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╡рд┐рдХрд╛рд╕ рдкрд╛рд░рд┐рд╕реНрдерд┐рддрд┐рдХреА рддрдВрддреНрд░ рдкрд╕рдВрдж рд╣реИред </li><li>  рдмреЗрд╢рдХ, рдирд┐рдпрдВрддреНрд░рдХ рдирд┐рд░реНрдорд╛рддрд╛ рд╕реНрд╡рдпрдВ (рдбрд┐рд╕реНрдХрд╡рд░реА, рдиреНрдпреВрдХреНрд▓рд┐рдпреЛ) рд╕реЗ рдХрдИ рдбрд┐рдмрдЧ рдмреЛрд░реНрдб рд╣реИрдВ, рд╕рд╛рде рд╣реА рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреЗ рдирд┐рд░реНрдорд╛рддрд╛рдУрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдУрд▓реАрдореЗрдХреНрд╕) рд╕реЗред  рд▓реЗрдХрд┐рди рдЕрдкрдиреЗ рдлреЙрд░реНрдо рдлреИрдХреНрдЯрд░ рдореЗрдВ рдШрд░ рдкрд░ рдЙрдирдореЗрдВ рд╕реЗ рдХрдИ рдХреЛ рджреЛрд╣рд░рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдо рд╕реЗ рдХрдо рдореЗрд░реЗ рд▓рд┐рдП рд╕рдорд╕реНрдпрд╛рдЧреНрд░рд╕реНрдд рд╣реИред  рдореЗрд░реЗ рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рд╕рд░рд▓ рджреЛ-рдкрд░рдд рдЯреЛрдкреЛрд▓реЙрдЬреА рдФрд░ рдШрдЯрдХ рд╣реИрдВ рдЬреЛ рдореИрдиреБрдЕрд▓ рд╕реЛрд▓реНрдбрд░рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИрдВред </li><li>  рдЙрдирдХреЗ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП, рдореИрдВ рдЕрдВрджрд░ рдЗрд▓реЗрдХреНрдЯреНрд░реЙрдирд┐рдХреНрд╕ рдХреА рдирд┐рдореНрди рдЧреБрдгрд╡рддреНрддрд╛ рдХреЗ рдореБрдЦреМрдЯреЗ рдХреЗ рд▓рд┐рдП рд╕рднреНрдп рдорд╛рдорд▓реЛрдВ рдХреЛ рд░рдЦрдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реВрдВред  рдХрдо рд╕реЗ рдХрдо рджреЛ рд▓реЛрдХрдкреНрд░рд┐рдп рдордВрдЪ рд╣реИрдВ рдЬрд┐рдирдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рд╡рд┐рд╡рд┐рдз рдорд╛рдорд▓реЛрдВ рдХреА рдПрдХ рдмрдбрд╝реА рд╕рдВрдЦреНрдпрд╛ рд╣реИ: рдЕрд░реБрдбрд┐рдиреЛ рдФрд░ рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИред  рдХрдиреЗрдХреНрдЯрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдХрдЯрдЖрдЙрдЯ рдХреЗ рд╕реНрдерд╛рди рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдЙрдирдореЗрдВ рд╕реЗ рджреВрд╕рд░рд╛ рдореБрдЭреЗ рдЕрдзрд┐рдХ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд▓рдЧ рд░рд╣рд╛ рдерд╛ред  рдЗрд╕рд▓рд┐рдП, рдмреЛрд░реНрдб рдХреА рдЬреНрдпрд╛рдорд┐рддрд┐ рдХреЗ рд▓рд┐рдП рдПрдХ рджрд╛рддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ, рдореИрдВрдиреЗ рдЗрд╕реЗ рдЪреБрдирд╛ред </li><li>  рдмреЛрд░реНрдб рдкрд░ рдЪрдпрдирд┐рдд рдирд┐рдпрдВрддреНрд░рдХ рдореЗрдВ USB, SDIO, I2S, рдиреЗрдЯрд╡рд░реНрдХ рд╣реИред  рджреВрд╕рд░реА рдУрд░, рдпреЗ рд╡рд╣реА рдЗрдВрдЯрд░рдлреЗрд╕ рдШрд░ рдХреЗ рд╢реМрдХ рдХреЗ рд▓рд┐рдП рднреА рдЙрдкрдпреЛрдЧреА рд╣реИрдВред  рдпрд╣реА рдХрд╛рд░рдг рд╣реИ, рдПрдХ рдорд╛рдирдХ рдмрдВрдзрди рдХреЗ рд╕рд╛рде рдирд┐рдпрдВрддреНрд░рдХ рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдореИрдВрдиреЗ рдПрдХ рдпреВрдПрд╕рдмреА рдХрдиреЗрдХреНрдЯрд░, рдПрдХ рдПрд╕рдбреА рдХрд╛рд░реНрдб, рдПрдХ рдСрдбрд┐рдпреЛ рдкрде (рдбрд┐рдЬрд┐рдЯрд▓-рд╕реЗ-рдПрдирд╛рд▓реЙрдЧ рдХрдирд╡рд░реНрдЯрд░ рдФрд░ рдПрдореНрдкрд▓реАрдлрд╛рдпрд░), рд╕рд╛рде рд╣реА рд╕рд╛рде рдИрдПрд╕рдкреА 8266 рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдПрдХ рд╡рд╛рдпрд░рд▓реЗрд╕ рдореЙрдбреНрдпреВрд▓ рднреА рдЬреЛрдбрд╝рд╛ред </li></ul><br><h2 id="shema-i-komponenty">  рд╕рд░реНрдХрд┐рдЯ рдФрд░ рдШрдЯрдХ </h2><br><p>  рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдФрд░ рдШрдЯрдХреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ рдмреЛрд░реНрдб рдирд┐рдХрд▓рд╛ рд╣реИ: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">STM32F405RG</a> рдирд┐рдпрдВрддреНрд░рдХ: рдПрдЖрд░рдПрдо 32-рдмрд┐рдЯ рдХреЙрд░реНрдЯреЗрдХреНрд╕-рдПрдо 4 рдПрдХ рдЧрдгрд┐рддреАрдп рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд╕рд╛рде, 168 рдореЗрдЧрд╛рд╣рд░реНрдЯреНрдЬ рддрдХ рдЖрд╡реГрддреНрддрд┐, 1 рдПрдордмреА рдлреНрд▓реИрд╢ рдореЗрдореЛрд░реА, 196 рдЬреАрдмреА рд░реИрдоред <br><img src="https://habrastorage.org/webt/w1/je/fb/w1jefbi3tuwerk7nyio5awywiky.png" alt="рдкреНрд░рдпреБрдХреНрдд рдирд┐рдпрдВрддреНрд░рдХ рдкрд┐рди"><br><img src="https://habrastorage.org/webt/-a/ta/sr/-atasrnz4pajsqagowftqvzok5q.png" alt="рдирд┐рдпрдВрддреНрд░рдХ рдмрд╛рдИрдВрдбрд┐рдВрдЧ"></li><li>  рдирд┐рдпрдВрддреНрд░рдХ (6 рдкрд┐рди) рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдХреЗ рд▓рд┐рдП SWD рдХрдиреЗрдХреНрдЯрд░ред </li><li>  рд░рд┐рдмреВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдЯрди рд░реАрд╕реЗрдЯ рдХрд░реЗрдВред </li><li>  рддреАрди рд░рдВрдЧ рдХреА рдПрд▓рдИрдбреАред  рдПрдХ рддрд░рдл, рддреАрди рдирд┐рдпрдВрддреНрд░рдХ рдкрд┐рди рдЦреЛ рдЬрд╛рддреЗ рд╣реИрдВред  рджреВрд╕рд░реА рдУрд░, рд╡реЗ рдЕрднреА рднреА GPIO рдХрдиреЗрдХреНрдЯрд░реНрд╕ рдкрд░ рд╕реАрдорд┐рдд рд╕рдВрдкрд░реНрдХреЛрдВ рдХреЗ рдХрд╛рд░рдг рдЦреЛ рдЬрд╛рдПрдВрдЧреЗ, рдФрд░ рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрд▓рдИрдбреА рдХреЛ рдбреАрдмрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╛рдд рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рд╣реИред </li><li>  рдЙрдЪреНрдЪ-рдЖрд╡реГрддреНрддрд┐ рдПрдЪрдПрд╕рдИ (рдХреЛрд░ рдШрдбрд╝реА рдХреЗ рд▓рд┐рдП 16 рдореЗрдЧрд╛рд╣рд░реНрдЯреНрдЬ) рдФрд░ рдХрдо-рдЖрд╡реГрддреНрддрд┐ рдПрд▓рдПрд╕рдИ (рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдХреА рдШрдбрд╝реА рдХреЗ рд▓рд┐рдП 32.7680 kHz) рдХреНрд╡рд╛рд░реНрдЯреНрдЬред </li><li>  2.54 рдорд┐рдореА рдХреА рдкрд┐рдЪ рд╡рд╛рд▓реА GPIO рдкрд┐рди рдмреНрд░реЗрдбрдмреЛрд░реНрдб рдореЙрдбрд▓ рдХреЗ рд╕рд╛рде рд╕рдВрдЧрдд рд╣реИред </li><li>  рд░рд╛рд╕реНрдкрдмреЗрд░реА рдкрд╛рдИ рдХреЗ 3.5 рдорд┐рдореА рдСрдбрд┐рдпреЛ рдЬреИрдХ рдХреЗ рд╕реНрдерд╛рди рдкрд░, рдореИрдВрдиреЗ 5-рд╡реЛрд▓реНрдЯ рдкрд╛рд╡рд░ рдХрдиреЗрдХреНрдЯрд░ рдХреЛ рддреИрдирд╛рдд рдХрд┐рдпрд╛ред  рдкрд╣рд▓реА рдирдЬрд╝рд░ рдореЗрдВ, рдпрд╣ рдирд┐рд░реНрдгрдп рд╡рд┐рд╡рд╛рджрд╛рд╕реНрдкрдж рд╣реИред  рд▓реЗрдХрд┐рди рд╡рд╣рд╛рдБ рдкреЗрд╢реЗрд╡рд░реЛрдВ рд░рд╣реЗ рд╣реИрдВред  рдпреВрдПрд╕рдмреА рдХрдиреЗрдХреНрдЯрд░ рд╕реЗ рдкрд╛рд╡рд░ рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ рдореМрдЬреВрдж рд╣реИ (рдиреАрдЪреЗ рд╡рд┐рд╡рд░рдг), рд▓реЗрдХрд┐рди рдпрд╣ рд╕рд░реНрдХрд┐рдЯ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдПрдХ рдмреБрд░рд╛ рд╡рд┐рдХрд▓реНрдк рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдХрдВрдкреНрдпреВрдЯрд░ рдХреЗ рдпреВрдПрд╕рдмреА рдкреЛрд░реНрдЯ рдХреЛ рдЬрд▓рд╛рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдХрд╛ рд╕рдордп рдХрд╛рдлреА рдХрдо рд╣реЛ рд╕рдХрддрд╛ рд╣реИред </li></ul><br><p><img src="https://habrastorage.org/webt/0s/qk/mk/0sqkmkrm5j1lt5bhkaiftrpz-y8.png" alt="рдкрд╛рд╡рд░ рд╕рд░реНрдХрд┐рдЯ"></p><br><ul><li>  рдорд┐рдиреА-рдпреВрдПрд╕рдмреА рдкреЛрд░реНрдЯ  рдПрдХ рдУрд░, рдпрд╣ рдирд┐рдпрдВрддреНрд░рдХ рдХреЗ рдпреВрдПрд╕рдмреА-рдУрдЯреАрдЬреА рдкреЛрд░реНрдЯ рдХреЗ рд╕рдВрд░рдХреНрд╖рдг рдЪрд┐рдк <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">STF203-22.TCT рдХреЗ</a> рдорд╛рдзреНрдпрдо рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╣реИред  рджреВрд╕рд░реА рдУрд░, VBUS рдкрд╛рд╡рд░ рдкрд┐рди GPIO рдХрдиреЗрдХреНрдЯрд░ рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реИред  рдпрджрд┐ рдЖрдк рдЗрд╕реЗ + 5V рдкрд┐рди рд╕реЗ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ, рддреЛ рдмреЛрд░реНрдб рдпреВрдПрд╕рдмреА рдкреЛрд░реНрдЯ рд╕реЗ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрдЧрд╛ред </li></ul><br><p><img src="https://habrastorage.org/webt/4q/te/om/4qteom17ikstddtnjafa78pqpme.png" alt="USB рд╕рд░реНрдХрд┐рдЯ"></p><br><ul><li>  рдХрдареЛрд░рддрд╛ рдХреЗ рд╕рд╛рде рдорд╛рдЗрдХреНрд░реЛ-рдПрд╕рдбреА рдореЗрдореЛрд░реА рдХрд╛рд░реНрдб рдХреЗ рд▓рд┐рдП рдХрдиреЗрдХреНрдЯрд░: 47 k-рдкреБрд▓-рдЕрдк <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд░реЗрд╕рд┐рд╕реНрдЯрд░реНрд╕</a> , рдкрд╛рд╡рд░ рдореИрдиреЗрдЬрдореЗрдВрдЯ рдЯреНрд░рд╛рдВрдЬрд┐рд╕реНрдЯрд░ ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">P-рдЪреИрдирд▓ MOSFET BSH205</a> ) рдФрд░ рдкрд╛рд╡рд░ рд▓рд╛рдЗрди рдкрд░ рдПрдХ рдЫреЛрдЯрд╛ рдЧреНрд░реАрди рдПрд▓рдИрдбреАред </li></ul><br><p><img src="https://habrastorage.org/webt/qb/3x/el/qb3xelfstpguacjkqhnss45nlxk.png" alt="рдорд╛рдЗрдХреНрд░реЛ рдПрд╕рдбреА рдХрд╛рд░реНрдб рдХреА рд╕реЗрдЯрд┐рдВрдЧ"></p><br><p>  рдЯреНрд░рд╛рдВрдЬрд┐рд╕реНрдЯрд░ рдЧреЗрдЯ рдирд┐рдпрдВрддреНрд░рдХ рдХреЗ PA15 рдкрд┐рди рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реИред  рдпрд╣ рдЬреЗрдЯреАрдбреАрдЖрдИ рдирд┐рдпрдВрддреНрд░рдХ рдХрд╛ рд╕рд┐рд╕реНрдЯрдо рд╕рдВрдкрд░реНрдХ рд╣реИ, рдЬреЛ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдХрд┐ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдпрд╣ рд╡реЛрд▓реНрдЯреЗрдЬ рдХреЗ рдЙрдЪреНрдЪ рд╕реНрддрд░ (рдкреБрд▓-рдЕрдк) рдХреЗ рд╕рд╛рде рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдЪреВрдВрдХрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдХреЗ рд▓рд┐рдП JTAG рдХреЗ рдмрдЬрд╛рдп SWD рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрдкрд░реНрдХ рдореБрдХреНрдд рд░рд╣рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдиреНрдп рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдЯреНрд░рд╛рдВрдЬрд┐рд╕реНрдЯрд░ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛ред  рдпрд╣ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИ - рдЬрдм рдмреЛрд░реНрдб рдореЗрдВ рдмрд┐рдЬрд▓реА рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИ, рддреЛ рдореЗрдореЛрд░реА рдХрд╛рд░реНрдб рдбреА-рдПрдирд░реНрдЬреЗрдЯрд┐рдХ рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ PA15 рдХреЛ рдкрд┐рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдирд┐рдореНрди рд╕реНрддрд░ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">UDA1334</a> рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдбрд┐рдЬрд┐рдЯрд▓-рд╕реЗ-рдПрдирд╛рд▓реЙрдЧ рдХрдирд╡рд░реНрдЯрд░ред  рдЗрд╕ рдЪрд┐рдк рдХреЛ рдмрд╛рд╣рд░реА рдШрдбрд╝реА рд╕рдВрдХреЗрдд рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдЬреЛ рдЗрд╕рдХреЗ рдЙрдкрдпреЛрдЧ рдХреА рд╕реБрд╡рд┐рдзрд╛ рджреЗрддрд╛ рд╣реИред  рдбреЗрдЯрд╛ I2S рдмрд╕ рдХреЗ рдКрдкрд░ рдкреНрд░реЗрд╖рд┐рдд рд╣реЛрддрд╛ рд╣реИред  рджреВрд╕рд░реА рдУрд░, рдбреЗрдЯрд╢реАрдЯ 47 ╬╝F рдкрд░ 5 рдзреНрд░реБрд╡реАрдп рдХреИрдкреЗрд╕рд┐рдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рд┐рдлрд╛рд░рд┐рд╢ рдХрд░рддреА рд╣реИред  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдХрд╛рд░ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред  рд╕рдмрд╕реЗ рдЫреЛрдЯреЗ рдЬреЛ рдЦрд░реАрджреЗ рдЧрдП рдереЗ рд╡реЗ 1411 рдХреЗ рдЖрдХрд╛рд░ рдХреЗ рд╕рд╛рде рдЯреИрдВрдЯрд▓рдо рд╣реИрдВ, рдЬреЛ рд╕рд╕реНрддреЗ рднреА рдирд╣реАрдВ рд╣реИрдВред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рдореИрдВ рдХреАрдордд рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд▓рд┐рдЦреВрдВрдЧрд╛ред  рдПрдирд╛рд▓реЙрдЧ рдкрд╛рд╡рд░ рдХреЗ рд▓рд┐рдП, рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рд░реИрдЦрд┐рдХ рд╕реНрдЯреЗрдмрд▓рд╛рдЗрдЬрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдбрд┐рдЬрд┐рдЯрд▓ рд╣рд┐рд╕реНрд╕реЗ рдХреА рд╢рдХреНрддрд┐ рдХреЛ рдбрдмрд▓ рдЯреНрд░рд╛рдВрдЬрд┐рд╕реНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рдЪрд╛рд▓реВ / рдмрдВрдж рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </li></ul><br><p><img src="https://habrastorage.org/webt/4f/rh/ea/4frheacnbm39nin0t79ubdatfy8.png" alt="рдбреАрдПрд╕реА рд╕рд░реНрдХрд┐рдЯ"></p><br><ul><li>  рджреЛ рдЪреИрдирд▓ рдПрдореНрдкрд▓реАрдлрд╛рдпрд░ рджреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">31AP2005</a> рдЪрд┐рдкреНрд╕ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИред  рдЙрдирдХрд╛ рдореБрдЦреНрдп рд▓рд╛рдн рд╕реНрдЯреНрд░реЗрдкрд┐рдВрдЧ рдШрдЯрдХреЛрдВ (рдХреЗрд╡рд▓ рдкрд╛рд╡рд░ рдлрд┐рд▓реНрдЯрд░ рдФрд░ рдПрдХ рдЗрдирдкреБрдЯ рдлрд┐рд▓реНрдЯрд░) рдХреА рдПрдХ рдЫреЛрдЯреА рд╕рдВрдЦреНрдпрд╛ рд╣реИред  рдСрдбрд┐рдпреЛ рдЖрдЙрдЯрдкреБрдЯ - 2.54 рдорд┐рдореА рдХреА рдкрд┐рдЪ рдХреЗ рд╕рд╛рде 4 рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдоред  рдЦреБрдж рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдЕрднреА рддрдХ рдпрд╣ рддрдп рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ рдХрд┐ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рдХреНрдпрд╛ рд╣реИ - рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрдХ рдореЗрдХрд╢рд┐рдлреНрдЯ рд╡рд┐рдХрд▓реНрдк рдпрд╛, рдЬреИрд╕реЗ рдХрд┐ рд░рд╛рд╕реНрдкрдмреЗрд░реА, рдПрдХ 3.5 рдорд┐рдореА рдкреНрд▓рдЧред  рдПрдХ рдирд┐рдпрдо рдХреЗ рд░реВрдк рдореЗрдВ, 3.5 рдорд┐рдореА рд╣реЗрдбрдлрд╝реЛрди рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╣реИ, рд╣рдорд╛рд░реЗ рдорд╛рдорд▓реЗ рдореЗрдВ рд╣рдо рд╡рдХреНрддрд╛рдУрдВ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВред </li></ul><br><p><img src="https://habrastorage.org/webt/ke/ge/qa/kegeqak09asea0z1npbr7u9clyw.png" alt="рдПрдорд┐рдорд┐рдЯрд╛рдпрд░ рд╕рд░реНрдХрд┐рдЯ"></p><br><ul><li>  рдЕрдВрддрд┐рдо рдореЙрдбреНрдпреВрд▓ рдПрдХ рдИрдПрд╕рдкреА 11 рд╢рд╛рд▓ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рд╡рд╛рдИрдлрд╛рдИ рдореЙрдбреЗрдо рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдЯреНрд░реИрдкрд┐рдВрдЧ (рдкрд╛рд╡рд░, рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рд╕реЙрдХреЗрдЯ) рд╣реИред  UART рдмреЛрд░реНрдб рдХреЗ рдирд┐рд╖реНрдХрд░реНрд╖ рдирд┐рдпрдВрддреНрд░рдХ рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рд╕рд╛рде рд╣реА рд╕рд╛рде рдПрдХ рдмрд╛рд╣рд░реА рдХрдиреЗрдХреНрдЯрд░ (рдЯрд░реНрдорд┐рдирд▓ рдФрд░ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рд╕реЗ рд╕реАрдзреЗ рдмреЛрд░реНрдб рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП) рдХреЗ рд▓рд┐рдП рдЖрдЙрдЯрдкреБрдЯ рд╣реЛрддреЗ рд╣реИрдВред  рдПрдХ рдкрд╛рд╡рд░ рд╕реНрд╡рд┐рдЪ (рдПрдХ рдорд╛рдЗрдХреНрд░реЛрдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реЗ рд╕реНрдерд╛рдпреА рдмрд╛рд╣рд░реА рдпрд╛ рдирд┐рдпрдВрддреНрд░рдг) рд╣реИред  рдмреЛрд░реНрдб рдХреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдореЛрдб рдореЗрдВ рдбрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╛рд╡рд░ рдФрд░ "рдлреНрд▓реИрд╢" рдХрдиреЗрдХреНрдЯрд░ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдПрд▓рдИрдбреА рд╣реИред </li></ul><br><p><img src="https://habrastorage.org/webt/3d/cq/1d/3dcq1dpb4u-iog9jbnix9icc1ac.png" alt="рдИрдПрд╕рдкреА рд╕рд░реНрдХрд┐рдЯ"></p><br><p>  рдмреЗрд╢рдХ, ESP8266 рдЕрдкрдиреЗ рдЖрдк рдореЗрдВ рдПрдХ рдЕрдЪреНрдЫрд╛ рдирд┐рдпрдВрддреНрд░рдХ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЕрднреА рднреА рдкреНрд░рджрд░реНрд╢рди рдФрд░ рдмрд╛рд╣реНрдп рдЙрдкрдХрд░рдгреЛрдВ рджреЛрдиреЛрдВ рдореЗрдВ STM32F4 рд╕реЗ рд╣реАрди рд╣реИред  рд╣рд╛рдВ, рдФрд░ рдЗрд╕ рдореЙрдбреНрдпреВрд▓ рдХреА рдХреАрдордд рдХреЗ рд╕рд╛рде рдЖрдХрд╛рд░ рдиреЗ рд╕рдВрдХреЗрдд рджрд┐рдпрд╛ рдХрд┐ рдпрд╣ рдЕрдкрдиреЗ рдмрдбрд╝реЗ рднрд╛рдИ рдХреЗ рд▓рд┐рдП рдПрдХ рдЧрд┐рд░рд╛ рд╣реБрдЖ рдореЙрдбреЗрдо рдЗрдХрд╛рдИ рдерд╛ред  рдореЙрдбреНрдпреВрд▓ USRT рджреНрд╡рд╛рд░рд╛ рдПрдХ рдкрд╛рда <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">AT</a> рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </p><br><p>  рдХреБрдЫ рддрд╕реНрд╡реАрд░реЗрдВ: <br> <a href=""><img src="https://habrastorage.org/webt/if/zv/di/ifzvdi77bc5vhkauczq8kwfa6mg.jpeg"></a> <br> <a href=""><img src="https://habrastorage.org/webt/dg/go/lz/dggolzrzpwxghtqnwtdyf_plogo.jpeg"></a> </p><br><h2 id="podgotovka-modulya-esp11">  ESP11 рдореЙрдбреНрдпреВрд▓ рддреИрдпрд╛рд░ рдХрд░рдирд╛ </h2><br><p>  ESP8266 рдПрдХ рдкреНрд░рд╕рд┐рджреНрдз рдЪреАрдЬ рд╣реИред  рдореБрдЭреЗ рдпрдХреАрди рд╣реИ рдХрд┐ рдХрдИ рд▓реЛрдЧ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрд░рд┐рдЪрд┐рдд рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдПрдХ рд╡рд┐рд╕реНрддреГрдд рдорд╛рд░реНрдЧрджрд░реНрд╢рд┐рдХрд╛ рдпрд╣рд╛рдВ рдмрд╣реБрдд рд╣реА рд╢рд╛рдирджрд╛рд░ рд╣реЛрдЧреАред  рдИрдПрд╕рдкреА 11 рдореЙрдбреНрдпреВрд▓ рдХреЛ рдмреЛрд░реНрдб рд╕реЗ рдЬреЛрдбрд╝рдиреЗ рдХреА рдпреЛрдЬрдирд╛рдмрджреНрдз рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЗ рдХрд╛рд░рдг, рдореИрдВ рдХреЗрд╡рд▓ рдЙрди рд▓реЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рдорд╛рд░реНрдЧрджрд░реНрд╢рд┐рдХрд╛ рджреВрдВрдЧрд╛ рдЬреЛ рдЗрд╕реЗ рдмрджрд▓рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ: </p><br><ul><li>  рдореИрдВ рдИрдПрд╕рдкреА рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдПрд╕реНрдкрдЯреВрд▓</a> рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдХрд░реВрдВрдЧрд╛</a> ред  рдирд┐рд░реНрдорд╛рддрд╛ рд╕реЗ рдорд╛рдирдХ рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХреЗ рд╡рд┐рдкрд░реАрдд, рдПрдХреНрдЯрдкреБрд▓ рдкреНрд▓реЗрдЯрдлреЙрд░реНрдо рд╕реНрд╡рддрдВрддреНрд░ рд╣реИред </li><li>  рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдИрдПрд╕рдкреА-рдкреАрдбрдмреНрд▓реВрдЖрд░ рдЬрдореНрдкрд░ (рд╣рдо рдирд┐рдХрдЯ рд╕рдВрдкрд░реНрдХ 1 рдФрд░ 2) рдХреЗ рд╕рд╛рде рдмрд╛рд╣рд░реА рдкрд╛рд╡рд░ рдореЛрдб рдЪрд╛рд▓реВ рдХрд░реЗрдВ, рдФрд░ рдХрд┐рд╕реА рднреА рдпреВрдПрд╕рдПрдЖрд░рдЯреА-рдпреВрдПрд╕рдмреА рдПрдбрд╛рдкреНрдЯрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрдВрдкреНрдпреВрдЯрд░ рд╕реЗ рдореЙрдбреНрдпреВрд▓ рдХреЛ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВред  рдПрдбрд╛рдкреНрдЯрд░ рдЬреАрдЖрд░рдбреА / рдЖрд░рдПрдХреНрд╕ / рдЯреАрдбреА рдкрд┐рди рд╕реЗ рдЬреБрдбрд╝рддрд╛ рд╣реИред  рд╣рдо рдмреЛрд░реНрдб рдХреЛ рдмрд┐рдЬрд▓реА рдХреА рдЖрдкреВрд░реНрддрд┐ рдХрд░рддреЗ рд╣реИрдВ: <br> <a href=""><img src="https://habrastorage.org/webt/qk/sg/_u/qksg_updoacqtvh5a_bmczc_poe.jpeg"></a> </li><li>  рд╣рдо рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдПрдбрд╛рдкреНрдЯрд░ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рджреНрд╡рд╛рд░рд╛ рдорд╛рдиреНрдпрддрд╛ рдкреНрд░рд╛рдкреНрдд рд╣реИред  рдореЗрд░реЗ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдореИрдВ FT232 рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рдПрдбрд╛рдкреНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ, рдЗрд╕рд▓рд┐рдП рдЙрдкрдХрд░рдгреЛрдВ рдХреА рд╕реВрдЪреА рдХреЗ рд╕рд╛рде рдЗрд╕реЗ FT232 рд╕реАрд░рд┐рдпрд▓ (UART) рдЖрдИрд╕реА рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдП: <br><pre><code class="bash hljs">&gt; lsusb ... Bus 001 Device 010: ID 0483:3748 STMicroelectronics ST-LINK/V2 Bus 001 Device 009: ID 0403:6001 Future Technology Devices International, Ltd FT232 Serial (UART) IC ...</code> </pre> </li><li>  ESP8266 рд╕реНрд╡рдпрдВ рдлреНрд▓реИрд╢ рдореЗрдореЛрд░реА рдХреА рдорд╛рддреНрд░рд╛ рдореЗрдВ рднрд┐рдиреНрди рд╣реЛрддрд╛ рд╣реИред  рд╡реНрдпрд╡рд╣рд╛рд░ рдореЗрдВ, рдПрдХ рд╣реА ESP11 рдореЙрдбреНрдпреВрд▓ рдореЗрдВ, рдореБрдЭреЗ 512 KB (4 Mbit) рдФрд░ 1 MB (8 Mbit) рджреЛрдиреЛрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝рд╛ред  рддреЛ рдкрд╣рд▓реА рдмрд╛рдд рдпрд╣ рдЬрд╛рдВрдЪрдирд╛ рд╣реИ рдХрд┐ рдореЙрдбреНрдпреВрд▓ рдХреЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдореЗрдореЛрд░реА рдХрд┐рддрдиреА рд╣реИред  рдмреЛрд░реНрдб рд╕реЗ рдмрд┐рдЬрд▓реА рдмрдВрдж рдХрд░реЗрдВ, рдФрд░ рдореЙрдбреНрдпреВрд▓ рдХреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдореЛрдб рдореЗрдВ рдбрд╛рд▓реЗрдВ, рдЬрдореНрдкрд░ "рдлреНрд▓реИрд╢" рдХреЛ рдмрдВрдж рдХрд░реЗрдВред </li></ul><br><p> <a href=""><img src="https://habrastorage.org/webt/dr/i8/8p/dri88pfduzkumw9u2_euqtz2_va.jpeg"></a> </p><br><ul><li>  рдмрд┐рдЬрд▓реА рдЪрд╛рд▓реВ рдХрд░реЗрдВ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд╕рд╛рде рдПрд╕реНрдкреНрдЯреВрд▓ рдЪрд▓рд╛рдПрдВ </li></ul><br><pre> <code class="bash hljs">&gt; esptool.py --port /dev/ttyUSB0 flash_id Connecting.... Detecting chip <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>... ESP8266 Chip is ESP8266EX Uploading stub... Running stub... Stub running... Manufacturer: e0 Device: 4014 Detected flash size: 1MB Hard resetting...</code> </pre> <br><ul><li>  esptool рдХреА рд░рд┐рдкреЛрд░реНрдЯ рд╣реИ рдХрд┐, рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╣рдо 1 рдПрдордмреА рдореЗрдореЛрд░реА рд╡рд╛рд▓реЗ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░ рд░рд╣реЗ рд╣реИрдВред </li><li>  1 рдПрдордмреА рд╡рд╛рд▓реЗ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рдирд╡реАрдирддрдо рдлрд░реНрдорд╡реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдИрдПрд╕рдкреА 8266 рдПрдЯреА рдмрд┐рди рд╡реА 1.6.1</a> ред  рд▓реЗрдХрд┐рди рдпрд╣ 4 Mbit рд╡рд╛рд▓реЗ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдирд╣реАрдВ рд╣реИ, рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдХреБрдЫ рдкреБрд░рд╛рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдпрд╣ рдПрдХ</a> ред  рдлрд░реНрдорд╡реЗрдпрд░ рдореЗрдВ рдХрдИ рдлрд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВ, рдкреНрд░рддреНрдпреЗрдХ рдлрд╝рд╛рдЗрд▓ рдХреЗ рд╢реБрд░реБрдЖрддреА рдкрддреЗ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рджрд╕реНрддрд╛рд╡реЗрдЬ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">ESP8266 AT рдирд┐рд░реНрджреЗрд╢ рд╕реЗрдЯ</a> рдореЗрдВ рдЗрдВрдЧрд┐рдд рдХрд┐рдП <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬрд╛рддреЗ рд╣реИрдВ</a> ред  рдЗрди рдкреНрд░рд╛рд░рдВрдн рдкрддреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрд╕реНрдкреНрдЯреВрд▓ рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХреЗ рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, 1 рдПрдордмреА рдХреЗ рд╕рд╛рде рдПрдХ рдореЙрдбреНрдпреВрд▓ рдХреЗ рд▓рд┐рдП, рдПрд╕реНрдХрд╛рдкреБрд▓ рдХреЗ рдкреИрд░рд╛рдореАрдЯрд░ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрд╛рдИ рджреЗрдВрдЧреЗ (рд╕рднреА рдЖрд╡рд╢реНрдпрдХ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдкрд╣рд▓реЗ рдлрд░реНрдорд╡реЗрдпрд░ рд╕рдВрдЧреНрд░рд╣ рд╕реЗ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рдХрд╛рд░реНрдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдПрдХрддреНрд░ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП) <br><pre> <code class="bash hljs">&gt; esptool.py --port /dev/ttyUSB0 write_flash 0x00000 boot.bin 0x01000 user1.1024.new.2.bin 0x7E000 blank.bin 0xFB000 blank.bin 0xFC000 esp_init_data_default.bin 0xFE000 blank.bin</code> </pre> </li><li>  рд╣рдо рдмреЛрд░реНрдб рдХреЛ рдмрд┐рдЬрд▓реА рдХреА рдЖрдкреВрд░реНрддрд┐ рдХрд░рддреЗ рд╣реИрдВ, рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд╕рд╛рде рдПрд╕реНрдкреНрдЯреВрд▓ рдЪрд▓рд╛рддреЗ рд╣реИрдВред </li><li>  рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдмреЛрд░реНрдб рд╕реЗ рдмрд┐рдЬрд▓реА рдмрдВрдж рдХрд░реЗрдВ, "рдлреНрд▓реИрд╢" рдЬрдореНрдкрд░ рдЦреЛрд▓реЗрдВ, рдорд╛рдЗрдХреНрд░реЛрдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реЗ рдкрд╛рд╡рд░ рдХрдВрдЯреНрд░реЛрд▓ рдЪрд╛рд▓реВ рдХрд░реЗрдВред  рдореЙрдбреНрдпреВрд▓ рдХрд╛рдо рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИред </li></ul><br><h2 id="programmnoe-obespechenie">  рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬреАрдердм</a> рдкрд░ рдПрдХ рдкрд░реАрдХреНрд╖рдг рдХрд╛рд░реНрдпрдХреНрд░рдо рд╣реИред  рд╡рд╣ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд░рддреА рд╣реИ: </p><br><ul><li>  рдЕрдзрд┐рдХрддрдо рдЖрд╡реГрддреНрддрд┐ (168 рдореЗрдЧрд╛рд╣рд░реНрдЯреНрдЬ) рдкрд░ рдирд┐рдпрдВрддреНрд░рдХ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ </li><li>  рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдШрдбрд╝реА рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░рддрд╛ рд╣реИ </li><li>  рдПрд╕рдбреА рдХрд╛рд░реНрдб рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рд╕реЗ рдиреЗрдЯрд╡рд░реНрдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкрдврд╝рддрд╛ рд╣реИред  рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП FatFS рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </li><li>  рдирд┐рд░реНрджрд┐рд╖реНрдЯ WLAN рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ </li><li>  рдирд┐рд░реНрджрд┐рд╖реНрдЯ NTP рд╕рд░реНрд╡рд░ рд╕реЗ рдЬреБрдбрд╝рддрд╛ рд╣реИ рдФрд░ рдЙрд╕рд╕реЗ рд╡рд░реНрддрдорд╛рди рд╕рдордп рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИред  рдШрдбрд╝реА рдЫреЛрдбрд╝ рджреЗрддрд╛ рд╣реИред </li><li>  рдХрдИ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдмрдВрджрд░рдЧрд╛рд╣реЛрдВ рдХреА рд╕реНрдерд┐рддрд┐ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░рддрд╛ рд╣реИред  рдпрджрд┐ рдЙрдирдХреА рд╕реНрдерд┐рддрд┐ рдмрджрд▓ рдЧрдИ рд╣реИ, рддреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдЯреАрд╕реАрдкреА рд╕рд░реНрд╡рд░ рдкрд░ рдПрдХ рдкрд╛рда рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИред </li><li>  рдЬрдм рдЖрдк рдмрд╛рд╣рд░реА рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдПрд╕рдбреА рдХрд╛рд░реНрдб рд╕реЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ * .wav рдлрд╝рд╛рдЗрд▓ рдХреЛ рдкрдврд╝рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдПрд╕рд┐рдВрдХреНрд░реЛрдирд╕ рдореЛрдб (рдбреАрдПрдордП рдирд┐рдпрдВрддреНрд░рдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ I2S) рдореЗрдВ рдЦреЗрд▓рддрд╛ рд╣реИред </li><li>  ESP11 рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХреЛ рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдореЛрдб рдореЗрдВ рднреА рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЕрдм рддрдХ DMA рдХреЗ рдмрд┐рдирд╛, рдХреЗрд╡рд▓ рд╡реНрдпрд╡рдзрд╛рди рдкрд░) </li><li>  USART1 (рдкрд┐рди PB6 / PB7) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд▓реЙрдЧ рдЗрди рдХрд░реЗрдВ </li><li>  рдФрд░, рдмреЗрд╢рдХ, рдПрд▓рдИрдбреА рдЭрдкрдХреАред </li></ul><br><p>  Habr├й рдкрд░ рдХрдИ рд▓реЗрдЦ рдереЗ рдЬреЛ STM32 рдХреЛ рдПрдХ рдирд┐рдореНрди рд╕реНрддрд░ рдкрд░ (рдХреЗрд╡рд▓ рд░рдЬрд┐рд╕реНрдЯрд░ рдкреНрд░рдмрдВрдзрди рдпрд╛ CMSIS рджреНрд╡рд╛рд░рд╛) рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдкрд┐рдд рдереЗред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рдЕрдВрддрд┐рдо рд╕реЗ: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдПрдХ</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рджреЛ</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рддреАрди</a> ред  рд▓реЗрдЦ, рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ, рдмрд╣реБрдд рдЙрдЪреНрдЪ рдЧреБрдгрд╡рддреНрддрд╛ рд╡рд╛рд▓реЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдореЗрд░реА рд╡реНрдпрдХреНрддрд┐рдкрд░рдХ рд░рд╛рдп рдпрд╣ рд╣реИ рдХрд┐ рдХрд┐рд╕реА рдЙрддреНрдкрд╛рдж рдХреЗ рдПрдХ рдмрд╛рд░ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдХреЗ рд▓рд┐рдП, рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг, рд╢рд╛рдпрдж, рдЦреБрдж рдХреЛ рд╕рд╣реА рдард╣рд░рд╛рддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рдПрдХ рд▓рдВрдмреА рдЕрд╡рдзрд┐ рдХреЗ рд╢реМрдХ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд▓рд┐рдП, рдЬрдм рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рд╕рдм рдХреБрдЫ рд╕реБрдВрджрд░ рдФрд░ рдПрдХреНрд╕реНрдЯреЗрдВрд╕рд┐рдмрд▓ рд╣реЛ, рддреЛ рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдмрд╣реБрдд рдХрдо рд╣реИред  Arduino рдХреА рд▓реЛрдХрдкреНрд░рд┐рдпрддрд╛ рдХреЗ рдХрд╛рд░рдгреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдХреЗ рд░реВрдк рдореЗрдВ, рдореЗрд░реА рд░рд╛рдп рдореЗрдВ, рдпрд╣ рд╣реИ рдХрд┐ Arduino рдХреЗ рд▓реЗрдЦрдХреЛрдВ рдиреЗ рдСрдмреНрдЬреЗрдХреНрдЯ-рдУрд░рд┐рдПрдВрдЯреЗрдб рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рд▓рд┐рдП рдЗрддрдирд╛ рдирд┐рдореНрди рд╕реНрддрд░ рдЫреЛрдбрд╝рд╛ рд╣реИред  рдЗрд╕рд▓рд┐рдП, рдореИрдВрдиреЗ рдЙрд╕реА рджрд┐рд╢рд╛ рдореЗрдВ рдЬрд╛рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ рдФрд░ рдПрдЪрдПрдПрд▓ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рдКрдкрд░ рдПрдХ рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рд╡рд╕реНрддреБ-рдЙрдиреНрдореБрдЦ рдкрд░рдд рдХреЛ рдЬреЛрдбрд╝рд╛ред </p><br><p>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЗ рддреАрди рд╕реНрддрд░ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВ: </p><br><ul><li>  рдирд┐рд░реНрдорд╛рддрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА (HAL, FatFS, рднрд╡рд┐рд╖реНрдп рдХреЗ USB-OTG рдореЗрдВ) рдЖрдзрд╛рд░ рдмрдирд╛рддреЗ рд╣реИрдВ </li><li>  рдореЗрд░реА StmPlusPlus рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЗрд╕реА рдЖрдзрд╛рд░ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИред  рдЗрд╕рдореЗрдВ рдмреЗрд╕ рдХрдХреНрд╖рд╛рдУрдВ (рдЬреИрд╕реЗ рд╕рд┐рд╕реНрдЯрдо, IOPort, IOPin, рдЯрд╛рдЗрдорд░, RealTimeClock, Usart, Spi, I2S) рдХрд╛ рдПрдХ рд╕реЗрдЯ рд╢рд╛рдорд┐рд▓ рд╣реИ, рдмрд╛рд╣рд░реА рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдбреНрд░рд╛рдЗрд╡рд░ рд╡рд░реНрдЧреЛрдВ рдХрд╛ рдПрдХ рд╕реЗрдЯ (рдЬреИрд╕реЗ SdCard, Esp11, DcfReceiver, Dac_MCP49x1, AudioDac_UDA1334 рдФрд░ рдЬреИрд╕реЗ рдЕрдиреНрдп) рдПрдХ WAV рдЕрддреБрд▓реНрдпрдХрд╛рд▓рд┐рдХ рдЦрд┐рд▓рд╛рдбрд╝реА рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрд╡рд╛ рд╡рд░реНрдЧред </li><li>  StmPlusPlus рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реНрд╡рдпрдВ рдмрдирд╛рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред </li></ul><br><p>  рднрд╛рд╖рд╛ рдХреА рдмреЛрд▓реА рдХреЗ рд▓рд┐рдП рдХреЗ рд░реВрдк рдореЗрдВред  рдЬрдмрдХрд┐ рдореИрдВ рдХреБрдЫ рдкреБрд░рд╛рдиреЗ рдЬрдорд╛рдиреЗ рдХрд╛ рд╣реВрдВ, рдореИрдВ C ++ 11 рдореЗрдВ рд░рд╣рддрд╛ рд╣реВрдВред  рдЗрд╕ рдорд╛рдирдХ рдореЗрдВ рдХрдИ рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ рд╣реИрдВ рдЬреЛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдлрд░реНрдорд╡реЗрдпрд░ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИрдВ: рдПрдирдо рд╡рд░реНрдЧ, рдкрд╛рд╕ рдХрд┐рдП рдЧрдП рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдШреБрдВрдШрд░рд╛рд▓реЗ рдмреНрд░реЗрд╕рд┐рдЬрд╝ рдХреЗ рд╕рд╛рде рдирд┐рд░реНрдорд╛рдгрдХрд░реНрддрд╛, рдФрд░ рд╕реНрдЯреИрдб :: рд╕рд░рдгреА рдЬреИрд╕реЗ рд╕реНрдерд┐рд░ рдХрдВрдЯреЗрдирд░ред  рд╡реИрд╕реЗ, рд╣реИрдмреЗ рдкрд░ рдЗрд╕ рд╡рд┐рд╖рдп рдкрд░ рдПрдХ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЕрджреНрднреБрдд рд▓реЗрдЦ рд╣реИ</a> ред </p><br><h3 id="biblioteka-stmplusplus">  StmPlusPlus рд▓рд╛рдЗрдмреНрд░реЗрд░реА </h3><br><p>  рдкреВрд░реНрдг рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛрдб рдХреЛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЬреАрдердм</a> рдкрд░ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  рдпрд╣рд╛рдВ рдореИрдВ рдЗрд╕ рд╡рд┐рдЪрд╛рд░ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рд╕рдВрд░рдЪрдирд╛, рд╡рд┐рдЪрд╛рд░ рдФрд░ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ рдХреБрдЫ рдЫреЛрдЯреЗ рдЙрджрд╛рд╣рд░рдг рджреВрдВрдЧрд╛ред </p><br><p>  <strong>рдкрд╣рд▓рд╛ рдЙрджрд╛рд╣рд░рдг</strong> рд╕рдордп-рд╕рдордп рдкрд░ рдПрдХ рдкрд┐рди рд░рд╛рдЬреНрдп (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдмрдЯрди) рдХреЛ рдорддрджрд╛рди рдХрд░рдиреЗ рдФрд░ рдЗрд╕ рд░рд╛рдЬреНрдп рдХреЗ рдмрджрд▓рдиреЗ рдкрд░ рдПрдХ рд╣реИрдВрдбрд▓рд░ рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд░реНрдЧ рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Button</span></span></span><span class="hljs-class"> :</span></span> IOPin { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventHandler</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onButtonPressed</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Button *, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numOccured)</span></span></span><span class="hljs-function"> </span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; }; Button (PortName name, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pull, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RealTimeClock &amp; _rtc, duration_ms _pressDelay = <span class="hljs-number"><span class="hljs-number">50</span></span>, duration_ms _pressDuration = <span class="hljs-number"><span class="hljs-number">300</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setHandler</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EventHandler * _handler)</span></span></span><span class="hljs-function"> </span></span>{ handler = _handler; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">periodic</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RealTimeClock &amp; rtc; duration_ms pressDelay, pressDuration; time_ms pressTime; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> currentState; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> numOccured; EventHandler * handler; };</code> </pre> <br><p>  рдирд┐рд░реНрдорд╛рддрд╛ рд╕рднреА рдмрдЯрди рдорд╛рдкрджрдВрдбреЛрдВ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs">Button::Button (PortName name, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pull, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RealTimeClock &amp; _rtc, duration_ms _pressDelay, duration_ms _pressDuration): IOPin{name, pin, GPIO_MODE_INPUT, pull, GPIO_SPEED_LOW}, rtc{_rtc}, pressDelay{_pressDelay}, pressDuration{_pressDuration}, pressTime{INFINITY_TIME}, currentState{<span class="hljs-literal"><span class="hljs-literal">false</span></span>}, numOccured{<span class="hljs-number"><span class="hljs-number">0</span></span>}, handler{<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>} { <span class="hljs-comment"><span class="hljs-comment">// empty }</span></span></code> </pre> <br><p>  рдпрджрд┐ рдРрд╕реА рдШрдЯрдирд╛рдУрдВ рдХреЛ рд╕рдВрднрд╛рд▓рдирд╛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рддреЛ рд╡реНрдпрд╡рдзрд╛рдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╢рд╛рдирджрд╛рд░ рд╣реИред  рдЗрд╕рд▓рд┐рдП, рд╡рд┐рднрд┐рдиреНрди рджрдмрд╛рд╡ рд╡рд╛рд▓реЗ рдкрд░рд┐рджреГрд╢реНрдп (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХрд▓ рдкреНрд░реЗрд╕ рдпрд╛ рд╣реЛрд▓реНрдб) рдЖрд╡рдзрд┐рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рдЬрд┐рдиреНрд╣реЗрдВ рд╕рдордп-рд╕рдордп рдкрд░ рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЛрдб рд╕реЗ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  рд╕рдордп-рд╕рдордп рдкрд░ рд░рд╛рдЬреНрдп рдкрд░рд┐рд╡рд░реНрддрди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕рдордХрд╛рд▓рд┐рдХ рд░реВрдк рд╕реЗ onButtonPressed рд╡рд░реНрдЪреБрдЕрд▓ рд╣реИрдВрдбрд▓рд░ рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдореЗрдВ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Button::periodic () { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handler == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> newState = (gpioParameters.Pull == GPIO_PULLUP)? !getBit() : getBit(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentState == newState) { <span class="hljs-comment"><span class="hljs-comment">// state is not changed: check for periodical press event if (currentState &amp;&amp; pressTime != INFINITY_TIME) { duration_ms d = rtc.getUpTimeMillisec() - pressTime; if (d &gt;= pressDuration) { handler-&gt;onButtonPressed(this, numOccured); pressTime = rtc.getUpTimeMillisec(); ++numOccured; } } } else if (!currentState &amp;&amp; newState) { pressTime = rtc.getUpTimeMillisec(); numOccured = 0; } else { duration_ms d = rtc.getUpTimeMillisec() - pressTime; if (d &lt; pressDelay) { // nothing to do } else if (numOccured == 0) { handler-&gt;onButtonPressed(this, numOccured); } pressTime = INFINITY_TIME; } currentState = newState; }</span></span></code> </pre> <br><p>  рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХрд╛ рдореБрдЦреНрдп рд▓рд╛рдн рдЕрдкрдиреЗ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рд╕реЗ рдХрд┐рд╕реА рдШрдЯрдирд╛ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рддрд░реНрдХ рдФрд░ рдХреЛрдб рдХреА рд╡рд┐рд╡рд┐рдзрддрд╛ рд╣реИред  рдпрд╣ HAL_GetTick рдирд╣реАрдВ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЧрд┐рдирддреА рдХреЗ рд╕рдордп рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдХрд┐ рдЗрд╕рдХреЗ рдкреНрд░рдХрд╛рд░ (uint32_t) рдХреЗ рдХрд╛рд░рдг, рдкреНрд░рддреНрдпреЗрдХ 2 ^ 32 рдорд┐рд▓реАрд╕реЗрдХрдВрдб (рдкреНрд░рддреНрдпреЗрдХ 49 рджрд┐рди) рдкрд░ рдЕрддрд┐рдкреНрд░рд╡рд╛рд╣ рджреНрд╡рд╛рд░рд╛ рд░реАрд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдореИрдВрдиреЗ рдЕрдкрдирд╛ рд╕реНрд╡рдпрдВ рдХрд╛ рд╡рд░реНрдЧ RealTimeClock рд▓рд╛рдЧреВ рдХрд┐рдпрд╛, рдЬреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗ рдорд┐рд▓реАрд╕реЗрдХрдВрдб рдХреА рдЧрдгрдирд╛ рдХрд░рддрд╛ рд╣реИ, рдпрд╛ uint64_t рдЬреИрд╕реЗ рдирд┐рдпрдВрддреНрд░рдХ рдХреЛ рдЪрд╛рд▓реВ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд▓рдЧрднрдЧ 5 ^ 8 рд╡рд░реНрд╖ рджреЗрддрд╛ рд╣реИред </p><br><p>  <strong>рджреВрд╕рд░рд╛ рдЙрджрд╛рд╣рд░рдг</strong> рдПрдХ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рд╕реЗ рдирд┐рдпрдВрддреНрд░рдХ рдореЗрдВ рдХрдИ рд╣реИрдВред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрд╕рдкреАрдЖрдИред  рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЗ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╕реЗ, рдХреЗрд╡рд▓ рд╡рд╛рдВрдЫрд┐рдд рдЗрдВрдЯрд░рдлрд╝реЗрд╕ (SPI1 / SPI2 / SPI3) рдХрд╛ рдЪрдпрди рдХрд░рдирд╛ рдмрд╣реБрдд рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд╣реИ, рдФрд░ рдЗрд╕ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдЕрдиреНрдп рд╕рднреА рдкреИрд░рд╛рдореАрдЯрд░ рд╡рд░реНрдЧ рдирд┐рд░реНрдорд╛рддрд╛ рджреНрд╡рд╛рд░рд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spi</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> TIMEOUT = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeviceName</span></span></span><span class="hljs-class"> {</span></span> SPI_1 = <span class="hljs-number"><span class="hljs-number">0</span></span>, SPI_2 = <span class="hljs-number"><span class="hljs-number">1</span></span>, SPI_3 = <span class="hljs-number"><span class="hljs-number">2</span></span>, }; Spi (DeviceName _device, IOPort::PortName sckPort, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> sckPin, IOPort::PortName misoPort, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> misoPin, IOPort::PortName mosiPort, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> mosiPin, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pull = GPIO_NOPULL); <span class="hljs-function"><span class="hljs-function">HAL_StatusTypeDef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> direction, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> prescaler, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dataSize = SPI_DATASIZE_8BIT, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CLKPhase = SPI_PHASE_1EDGE)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">HAL_StatusTypeDef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> HAL_StatusTypeDef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeBuffer</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pSize)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HAL_SPI_Transmit(hspi, pData, pSize, TIMEOUT); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: DeviceName device; IOPin sck, miso, mosi; SPI_HandleTypeDef *hspi; SPI_HandleTypeDef spiParams; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enableClock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableClock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; };</code> </pre> <br><p>  рдкрд┐рди рдкреИрд░рд╛рдореАрдЯрд░ рдФрд░ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдкреИрд░рд╛рдореАрдЯрд░ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рдХрдХреНрд╖рд╛ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред  рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рдореИрдВрдиреЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕рдлрд▓ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╡рд┐рдХрд▓реНрдк рдирд╣реАрдВ рдЪреБрдирд╛, рдЬрдм рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдкреИрд░рд╛рдореАрдЯрд░ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рд╕реАрдзреЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs">Spi::Spi (DeviceName _device, IOPort::PortName sckPort, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> sckPin, IOPort::PortName misoPort, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> misoPin, IOPort::PortName mosiPort, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> mosiPin, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pull): device(_device), sck(sckPort, sckPin, GPIO_MODE_AF_PP, pull, GPIO_SPEED_HIGH, <span class="hljs-literal"><span class="hljs-literal">false</span></span>), miso(misoPort, misoPin, GPIO_MODE_AF_PP, pull, GPIO_SPEED_HIGH, <span class="hljs-literal"><span class="hljs-literal">false</span></span>), mosi(mosiPort, mosiPin, GPIO_MODE_AF_PP, pull, GPIO_SPEED_HIGH, <span class="hljs-literal"><span class="hljs-literal">false</span></span>), hspi(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (device) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DeviceName::SPI_1: <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> SPI1 sck.setAlternate(GPIO_AF5_SPI1); miso.setAlternate(GPIO_AF5_SPI1); mosi.setAlternate(GPIO_AF5_SPI1); spiParams.Instance = SPI1; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> break; ... case DeviceName::SPI_3: #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> SPI3 sck.setAlternate(GPIO_AF6_SPI3); miso.setAlternate(GPIO_AF6_SPI3); mosi.setAlternate(GPIO_AF6_SPI3); spiParams.Instance = SPI3; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> break; } spiParams.Init.Mode = SPI_MODE_MASTER; spiParams.Init.DataSize = SPI_DATASIZE_8BIT; spiParams.Init.CLKPolarity = SPI_POLARITY_HIGH; spiParams.Init.CLKPhase = SPI_PHASE_1EDGE; spiParams.Init.FirstBit = SPI_FIRSTBIT_MSB; spiParams.Init.TIMode = SPI_TIMODE_DISABLE; spiParams.Init.CRCCalculation = SPI_CRCCALCULATION_DISABLE; spiParams.Init.CRCPolynomial = 7; spiParams.Init.NSS = SPI_NSS_SOFT; }</span></span></code> </pre> <br><p>  рд╕рдорд╛рди рдпреЛрдЬрдирд╛ рд╕рдХреНрд╖рдордХреЙрд▓ рдФрд░ рдбрд┐рд╕рдХреЙрд▓рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддреА рд╣реИ, рдЬреЛ рдЕрдиреНрдп рдирд┐рдпрдВрддреНрд░рдХреЛрдВ рдХреЗ рд▓рд┐рдП рдЦрд░рд╛рдм рдПрдХреНрд╕реНрдЯреЗрдВрд╕рд┐рдмрд▓ рдФрд░ рдЦрд░рд╛рдм рдкреЛрд░реНрдЯреЗрдмрд▓ рд╣реИрдВред  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЙрди рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдмреЗрд╣рддрд░ рд╣реЛрддрд╛ рд╣реИ рдЬрд╣рд╛рдБ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкреИрд░рд╛рдореАрдЯрд░ HAL рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдирд╛рдо (SPI1, SPI2, SPI3), рдкрд┐рди рдкреИрд░рд╛рдореАрдЯрд░ (GPIO_AF5_SPI1) рдФрд░ рдХреБрдЫ рдРрд╕рд╛ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдХреНрд▓реЙрдХрд┐рдВрдЧ рдХреЗ рдЪрд╛рд▓реВ / рдмрдВрдж рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред  рдЗрд╕ рд╡рд┐рд╖рдп рдкрд░ рдПрдХ рджрд┐рд▓рдЪрд╕реНрдк рд▓реЗрдЦ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпрд╣ рдПрд╡реАрдЖрд░ рдирд┐рдпрдВрддреНрд░рдХреЛрдВ рдХреА рд╕рдореАрдХреНрд╖рд╛ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рдореМрд▓рд┐рдХ рдЕрдВрддрд░ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред </p><br><p>  рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рдХрд╛ рдкреНрд░рд╛рд░рдВрдн рдФрд░ рдЕрдВрдд рджреЛ рд╕реНрдЯрд╛рд░реНрдЯ / рд╕реНрдЯреЙрдк рд╡рд┐рдзрд┐рдпреЛрдВ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs">HAL_StatusTypeDef Spi::start (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> direction, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> prescaler, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> dataSize, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> CLKPhase) { hspi = &amp;spiParams; enableClock(); spiParams.Init.Direction = direction; spiParams.Init.BaudRatePrescaler = prescaler; spiParams.Init.DataSize = dataSize; spiParams.Init.CLKPhase = CLKPhase; HAL_StatusTypeDef status = HAL_SPI_Init(hspi); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != HAL_OK) { USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Can not initialize SPI "</span></span> &lt;&lt; (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)device &lt;&lt; <span class="hljs-string"><span class="hljs-string">": "</span></span> &lt;&lt; status); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } <span class="hljs-comment"><span class="hljs-comment">/* Configure communication direction : 1Line */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (spiParams.Init.Direction == SPI_DIRECTION_1LINE) { SPI_1LINE_TX(hspi); } <span class="hljs-comment"><span class="hljs-comment">/* Check if the SPI is already enabled */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((spiParams.Instance-&gt;CR1 &amp; SPI_CR1_SPE) != SPI_CR1_SPE) { <span class="hljs-comment"><span class="hljs-comment">/* Enable SPI peripheral */</span></span> __HAL_SPI_ENABLE(hspi); } USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Started SPI "</span></span> &lt;&lt; (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)device &lt;&lt; <span class="hljs-string"><span class="hljs-string">": BaudRatePrescaler = "</span></span> &lt;&lt; spiParams.Init.BaudRatePrescaler &lt;&lt; <span class="hljs-string"><span class="hljs-string">", DataSize = "</span></span> &lt;&lt; spiParams.Init.DataSize &lt;&lt; <span class="hljs-string"><span class="hljs-string">", CLKPhase = "</span></span> &lt;&lt; spiParams.Init.CLKPhase &lt;&lt; <span class="hljs-string"><span class="hljs-string">", Status = "</span></span> &lt;&lt; status); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } HAL_StatusTypeDef Spi::stop () { USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Stopping SPI "</span></span> &lt;&lt; (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)device); HAL_StatusTypeDef retValue = HAL_SPI_DeInit(&amp;spiParams); disableClock(); hspi = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retValue; }</code> </pre> <br><p>  <strong>рдЗрдВрдЯрд░рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░реЗрдВ</strong> ред  рд╡рд░реНрдЧ рдбреАрдПрдордП рдирд┐рдпрдВрддреНрд░рдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ I2S рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред  I2S (рдЗрдВрдЯрд░-рдЖрдИрд╕реА рд╕рд╛рдЙрдВрдб) рдПрд╕рдкреАрдЖрдИ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░-рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдРрдб-рдСрди рд╣реИ, рдЬреЛ рд╕реНрд╡рдпрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдСрдбрд┐рдпреЛ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдФрд░ рдмрд┐рдЯ рджрд░ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдШрдбрд╝реА рдЪрдпрди рдФрд░ рдЪреИрдирд▓ рдирд┐рдпрдВрддреНрд░рдг рдХрд░рддрд╛ рд╣реИред </p><br><p>  рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдореЗрдВ, I2S рд╡рд░реНрдЧ "рдкреЛрд░реНрдЯ" рд╡рд░реНрдЧ рд╕реЗ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓рд╛ рд╣реИ, рдЕрд░реНрдерд╛рдд, I2S рд╡рд┐рд╢реЗрд╖ рдЧреБрдгреЛрдВ рд╡рд╛рд▓рд╛ рдПрдХ рдмрдВрджрд░рдЧрд╛рд╣ рд╣реИред  рдХреБрдЫ рдбреЗрдЯрд╛ рдПрдЪрдПрдПрд▓ рд╕рдВрд░рдЪрдирд╛рдУрдВ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдкреНрд▓рд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП, рдбреЗрдЯрд╛ рдХреА рдорд╛рддреНрд░рд╛ рдХреЗ рд▓рд┐рдП рд╢реВрдиреНрдп)ред  рдХреБрдЫ рдбреЗрдЯрд╛ рд▓рд┐рдВрдХ рджреНрд╡рд╛рд░рд╛ рдореБрдЦреНрдп рдХреЛрдб рд╕реЗ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, irqPrio рд╕рдВрд░рдЪрдирд╛)ред </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">I2S</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IOPort { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IRQn_Type I2S_IRQ = SPI2_IRQn; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> IRQn_Type DMA_TX_IRQ = DMA1_Stream4_IRQn; I2S (PortName name, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> InterruptPriority &amp; prio); <span class="hljs-function"><span class="hljs-function">HAL_StatusTypeDef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> standard, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> audioFreq, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dataFormat)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> HAL_StatusTypeDef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transmit</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * pData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HAL_I2S_Transmit_DMA(&amp;i2s, pData, size); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processI2SInterrupt</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HAL_I2S_IRQHandler(&amp;i2s); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDmaTxInterrupt</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HAL_DMA_IRQHandler(&amp;i2sDmaTx); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: I2S_HandleTypeDef i2s; DMA_HandleTypeDef i2sDmaTx; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> InterruptPriority &amp; irqPrio; };</code> </pre> <br><p>  рдЗрд╕рдХрд╛ рдирд┐рд░реНрдорд╛рддрд╛ рд╕рднреА рд╕реНрдерд┐рд░ рдкреИрд░рд╛рдореАрдЯрд░ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs">I2S::I2S (PortName name, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> pin, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> InterruptPriority &amp; prio): IOPort{name, GPIO_MODE_INPUT, GPIO_NOPULL, GPIO_SPEED_FREQ_LOW, pin, <span class="hljs-literal"><span class="hljs-literal">false</span></span>}, irqPrio{prio} { i2s.Instance = SPI2; i2s.Init.Mode = I2S_MODE_MASTER_TX; i2s.Init.Standard = I2S_STANDARD_PHILIPS; <span class="hljs-comment"><span class="hljs-comment">// will be re-defined at communication start i2s.Init.DataFormat = I2S_DATAFORMAT_16B; // will be re-defined at communication start i2s.Init.MCLKOutput = I2S_MCLKOUTPUT_DISABLE; i2s.Init.AudioFreq = I2S_AUDIOFREQ_44K; // will be re-defined at communication start i2s.Init.CPOL = I2S_CPOL_LOW; i2s.Init.ClockSource = I2S_CLOCK_PLL; i2s.Init.FullDuplexMode = I2S_FULLDUPLEXMODE_DISABLE; i2sDmaTx.Instance = DMA1_Stream4; i2sDmaTx.Init.Channel = DMA_CHANNEL_0; i2sDmaTx.Init.Direction = DMA_MEMORY_TO_PERIPH; i2sDmaTx.Init.PeriphInc = DMA_PINC_DISABLE; i2sDmaTx.Init.MemInc = DMA_MINC_ENABLE; i2sDmaTx.Init.PeriphDataAlignment = DMA_PDATAALIGN_HALFWORD; i2sDmaTx.Init.MemDataAlignment = DMA_MDATAALIGN_HALFWORD; i2sDmaTx.Init.Mode = DMA_NORMAL; i2sDmaTx.Init.Priority = DMA_PRIORITY_LOW; i2sDmaTx.Init.FIFOMode = DMA_FIFOMODE_ENABLE; i2sDmaTx.Init.FIFOThreshold = DMA_FIFO_THRESHOLD_FULL; i2sDmaTx.Init.MemBurst = DMA_PBURST_SINGLE; i2sDmaTx.Init.PeriphBurst = DMA_PBURST_SINGLE; }</span></span></code> </pre> <br><p>  рдбреЗрдЯрд╛ рдЯреНрд░рд╛рдВрд╕рдлрд░ рдХреА рд╢реБрд░реБрдЖрдд рд╕реНрдЯрд╛рд░реНрдЯ рд╡рд┐рдзрд┐рдпреЛрдВ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИ, рдЬреЛ рдкреЛрд░реНрдЯ рдорд╛рдкрджрдВрдбреЛрдВ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ, рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рдХреНрд▓реЙрдХ рдХрд░рдиреЗ, рд╡реНрдпрд╡рдзрд╛рди рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ, рдбреАрдПрдордП рд╢реБрд░реВ рдХрд░рдиреЗ, рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдЯреНрд░рд╛рдВрд╕рдорд┐рд╢рди рдорд╛рдкрджрдВрдбреЛрдВ рдХреЗ рд╕рд╛рде рд╕реНрд╡рдпрдВ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИрдВред </p><br><pre> <code class="cpp hljs">HAL_StatusTypeDef I2S::start (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> standard, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> audioFreq, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> dataFormat) { i2s.Init.Standard = standard; i2s.Init.AudioFreq = audioFreq; i2s.Init.DataFormat = dataFormat; setMode(GPIO_MODE_AF_PP); setAlternate(GPIO_AF5_SPI2); __HAL_RCC_SPI2_CLK_ENABLE(); HAL_StatusTypeDef status = HAL_I2S_Init(&amp;i2s); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != HAL_OK) { USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Can not start I2S: "</span></span> &lt;&lt; status); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HAL_ERROR; } __HAL_RCC_DMA1_CLK_ENABLE(); __HAL_LINKDMA(&amp;i2s, hdmatx, i2sDmaTx); status = HAL_DMA_Init(&amp;i2sDmaTx); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status != HAL_OK) { USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Can not initialize I2S DMA/TX channel: "</span></span> &lt;&lt; status); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HAL_ERROR; } HAL_NVIC_SetPriority(I2S_IRQ, irqPrio.first, irqPrio.second); HAL_NVIC_EnableIRQ(I2S_IRQ); HAL_NVIC_SetPriority(DMA_TX_IRQ, irqPrio.first + <span class="hljs-number"><span class="hljs-number">1</span></span>, irqPrio.second); HAL_NVIC_EnableIRQ(DMA_TX_IRQ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HAL_OK; }</code> </pre> <br><p>  рд╕реНрдЯреЙрдк рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрд╕рдХреЗ рд╡рд┐рдкрд░реАрдд рдХрд░рддреА рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> I2S::stop () { HAL_NVIC_DisableIRQ(I2S_IRQ); HAL_NVIC_DisableIRQ(DMA_TX_IRQ); HAL_DMA_DeInit(&amp;i2sDmaTx); __HAL_RCC_DMA1_CLK_DISABLE(); HAL_I2S_DeInit(&amp;i2s); __HAL_RCC_SPI2_CLK_DISABLE(); setMode(GPIO_MODE_INPUT); }</code> </pre> <br><p>  рдпрд╣рд╛рдБ рдХрдИ рджрд┐рд▓рдЪрд╕реНрдк рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ рд╣реИрдВ: </p><br><ul><li>  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдкреНрд░рдпреБрдХреНрдд рд╡реНрдпрд╡рдзрд╛рдиреЛрдВ рдХреЛ рд╕реНрдереИрддрд┐рдХ рд╕реНрдерд┐рд░рд╛рдВрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рдпрд╣ рдЕрдиреНрдп рдирд┐рдпрдВрддреНрд░рдХреЛрдВ рдХреЗ рд▓рд┐рдП рд╕реБрд╡рд╛рд╣реНрдпрддрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдЛрдг рд╣реИред </li><li>  рдХреЛрдб рдХрд╛ рдРрд╕рд╛ рд╕рдВрдЧрдарди рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдкреЛрд░реНрдЯ рдкрд┐рди рд╣рдореЗрд╢рд╛ GPIO_MODE_INPUT рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╣реЛ рдЬрдм рдХреЛрдИ рдЯреНрд░рд╛рдВрд╕рдорд┐рд╢рди рди рд╣реЛред  рдпрд╣ рдПрдХ рдкреНрд▓рд╕ рд╣реИред </li><li>  рдЗрдВрдЯрд░рдкреНрдЯ рдХреА рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдХреЛ рдмрд╛рд╣рд░ рд╕реЗ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЕрд░реНрдерд╛рдд, рдореБрдЦреНрдп рдХреЛрдб рдХреЗ рдПрдХ рд╕реНрдерд╛рди рдкрд░ рдПрдХ рдмрд╛рдзрд╛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдорд╛рдирдЪрд┐рддреНрд░ рд╕реЗрдЯ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рдЕрд╡рд╕рд░ рд╣реИред  рдпрд╣ рднреА рдПрдХ рдкреНрд▓рд╕ рд╣реИред </li><li>  рд░реЛрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ DMA1 рдХреНрд▓реЙрдХрд┐рдВрдЧ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рддреА рд╣реИред  рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдЗрд╕ рд╕рд░рд▓реАрдХрд░рдг рдХреЗ рдмрд╣реБрдд рдирдХрд╛рд░рд╛рддреНрдордХ рдкрд░рд┐рдгрд╛рдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рдХреЛрдИ рдФрд░ рд╡реНрдпрдХреНрддрд┐ рдбреАрдПрдордП 1 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЬрд╛рд░реА рд░рдЦрддрд╛ рд╣реИред  рдЗрд╕ рддрд░рд╣ рдХреЗ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдЙрдкрднреЛрдХреНрддрд╛рдУрдВ рдХрд╛ рдПрдХ рдХреЗрдВрджреНрд░реАрдХреГрдд рд░рдЬрд┐рд╕реНрдЯрд░ рдмрдирд╛рдХрд░ рд╕рдорд╕реНрдпрд╛ рдХрд╛ рд╕рдорд╛рдзрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдХрд┐ рдХреНрд▓реЙрдХрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрдЧрд╛ред </li><li>  рдПрдХ рдФрд░ рд╕рд░рд▓реАрдХрд░рдг - рдкреНрд░рд╛рд░рдВрдн рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдПрдХ рддреНрд░реБрдЯрд┐ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рдЕрдкрдиреА рдореВрд▓ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдирд╣реАрдВ рд▓рд╛рддреА рд╣реИ (рдпрд╣ рдПрдХ рдЛрдг рд╣реИ, рд▓реЗрдХрд┐рди рдЖрд╕рд╛рдиреА рд╕реЗ рдлрд┐рдХреНрд╕рд┐рдВрдЧ рд╣реИ)ред  рдЙрд╕реА рд╕рдордп, рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреЛ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд▓реЙрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдПрдХ рдкреНрд▓рд╕ рд╣реИред </li><li>  рдЗрд╕ рд╡рд░реНрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдореБрдЦреНрдп рдХреЛрдб рдХреЛ SPI2_IRQn рдФрд░ DMA1_Stream4_IRQn рдХреЛ рдмреАрдЪ рдореЗрдВ рд░реЛрдХрдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рд╕рдВрдмрдВрдзрд┐рдд processI2SInterrupt рдФрд░ processDmaTxInterrupt рд╣реИрдВрдбрд▓рд░ рдХрд╣рд▓рд╛рддреЗ рд╣реИрдВред </li></ul><br><h3 id="osnovnaya-programma">  рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо </h3><br><p>  рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдХреЛ рдХрд╛рдлреА рд╕рд░рд▓рддрд╛ рд╕реЗ рд╡рд░реНрдгрд┐рдд рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ HAL_Init(); <span class="hljs-function"><span class="hljs-function">IOPort </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultPortA</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IOPort::PortName::A, GPIO_MODE_INPUT, GPIO_PULLDOWN)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">IOPort </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultPortB</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IOPort::PortName::B, GPIO_MODE_INPUT, GPIO_PULLDOWN)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">IOPort </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultPortC</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IOPort::PortName::C, GPIO_MODE_INPUT, GPIO_PULLDOWN)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// System frequency 168MHz System::ClockDiv clkDiv; clkDiv.PLLM = 16; clkDiv.PLLN = 336; clkDiv.PLLP = 2; clkDiv.PLLQ = 7; clkDiv.AHBCLKDivider = RCC_SYSCLK_DIV1; clkDiv.APB1CLKDivider = RCC_HCLK_DIV8; clkDiv.APB2CLKDivider = RCC_HCLK_DIV8; clkDiv.PLLI2SN = 192; clkDiv.PLLI2SR = 2; do { System::setClock(clkDiv, FLASH_LATENCY_3, System::RtcType::RTC_EXT); } while (System::getMcuFreq() != 168000000L); MyApplication app; appPtr = &amp;app; app.run(); }</span></span></code> </pre> <br><p>  рдпрд╣рд╛рдВ рд╣рдо HAL рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рдЗрдирд┐рд╢рд┐рдпрд▓рд╛рдЗрдЬрд╝ рдХрд░рддреЗ рд╣реИрдВ, рд╕рднреА рдХрдВрдЯреНрд░реЛрд▓рд░ рдкрд┐рдиреНрд╕ рдХреЛ рдЗрдирдкреБрдЯ (GPIO_MODE_INPUT / PULLDOWN) рджреНрд╡рд╛рд░рд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рддреЗ рд╣реИрдВред  рд╣рдо рдирд┐рдпрдВрддреНрд░рдХ рдХреА рдЖрд╡реГрддреНрддрд┐ рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ, рдШрдбрд╝реА рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ (рдмрд╛рд╣рд░реА рдХреНрд╡рд╛рд░реНрдЯреНрдЬ рд╕реЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдХреА рдШрдбрд╝реА рд╕рд╣рд┐рдд)ред  рдЙрд╕рдХреЗ рдмрд╛рдж, рдЬрд╛рд╡рд╛ рдХреА рд╢реИрд▓реА рдореЗрдВ рдереЛрдбрд╝рд╛, рд╣рдо рдЕрдкрдиреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдмрдирд╛рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХреА рд░рди рд╡рд┐рдзрд┐ рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ рд╕рднреА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓реЙрдЬрд┐рдХ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред </p><br><p>  рдПрдХ рдЕрд▓рдЧ рдЕрдиреБрднрд╛рдЧ рдореЗрдВ, рд╣рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рднреА рд╡реНрдпрд╡рдзрд╛рдиреЛрдВ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред  рдЪреВрдБрдХрд┐ рд╣рдо C ++ рдореЗрдВ рд▓рд┐рдЦрддреЗ рд╣реИрдВ, рдФрд░ рд╡реНрдпрд╡рдзрд╛рди C рдХреА рджреБрдирд┐рдпрд╛ рдХреА рдЪреАрдЬреЗрдВ рд╣реИрдВ, рд╣рдореЗрдВ рдЙрдирдХреЗ рдЕрдиреБрд╕рд╛рд░ рдорд╛рд╕реНрдХ рд▓рдЧрд╛рдирд╛ рд╣реЛрдЧрд╛: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SysTick_Handler</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ HAL_IncTick(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (appPtr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { appPtr-&gt;getRtc().onMilliSecondInterrupt(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DMA2_Stream3_IRQHandler</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ Devices::SdCard::getInstance()-&gt;processDmaRxInterrupt(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DMA2_Stream6_IRQHandler</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ Devices::SdCard::getInstance()-&gt;processDmaTxInterrupt(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SDIO_IRQHandler</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ Devices::SdCard::getInstance()-&gt;processSdIOInterrupt(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SPI2_IRQHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ appPtr-&gt;getI2S().processI2SInterrupt(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DMA1_Stream4_IRQHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ appPtr-&gt;getI2S().processDmaTxInterrupt(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HAL_I2S_TxCpltCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(I2S_HandleTypeDef *channel)</span></span></span><span class="hljs-function"> </span></span>{ appPtr-&gt;processDmaTxCpltCallback(channel); } ... }</code> </pre> <br><p>  MyApplication рд╡рд░реНрдЧ рдЗрди рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рднреА рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдЙрдкрдХрд░рдгреЛрдВ, рдХреЙрд▓ рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░реЛрдВ рдХреА рдШреЛрд╖рдгрд╛ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЖрд╡рд╢реНрдпрдХ рдИрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рднреА рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyApplication</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RealTimeClock::EventHandler, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyApplication</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RealTimeClock::EventHandler, WavStreamer::EventHandler, Devices::Button::EventHandler { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> INPUT_PINS = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Number of monitored input pins private: UsartLogger log; RealTimeClock rtc; IOPin ledGreen, ledBlue, ledRed; PeriodicalEvent heartbeatEvent; IOPin mco; // Interrupt priorities InterruptPriority irqPrioI2S; InterruptPriority irqPrioEsp; InterruptPriority irqPrioSd; InterruptPriority irqPrioRtc; // SD card IOPin pinSdPower, pinSdDetect; IOPort portSd1, portSd2; SdCard sdCard; bool sdCardInserted; // Configuration Config config; // ESP Esp11 esp; EspSender espSender; // Input pins std::array&lt;IOPin, INPUT_PINS&gt; pins; std::array&lt;bool, INPUT_PINS&gt; pinsState; // I2S2 Audio I2S i2s; AudioDac_UDA1334 audioDac; WavStreamer streamer; Devices::Button playButton; ...</span></span></code> </pre> <br><p>  рдпрд╣реА рд╣реИ, рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд╕рднреА рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ рд╕рд╛рдВрдЦреНрдпрд┐рдХреАрдп рд░реВрдк рд╕реЗ рдШреЛрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдкреНрд░рдпреБрдХреНрдд рдореЗрдореЛрд░реА рдореЗрдВ рд╡реГрджреНрдзрд┐ рдХреА рдУрд░ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдмрд╣реБрдд рд╕рд░рд▓ рдХрд░рддрд╛ рд╣реИред  MyApplication рд╡рд░реНрдЧ рдХреЗ рдирд┐рд░реНрдорд╛рддрд╛ рдореЗрдВ, рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдбрд┐рдЬрд╛рдЗрдирд░реЛрдВ рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдмрд╛рдж, рдЬрдм рддрдХ рд░рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╢реБрд░реВ рд╣реЛ рдЬрд╛рддреА рд╣реИ, рддрдм рддрдХ рд╕рднреА рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдорд╛рдЗрдХреНрд░реЛрдХрдВрдЯреНрд░реЛрд▓рд░ рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛: </p><br><pre> <code class="cpp hljs"> MyApplication::MyApplication () : <span class="hljs-comment"><span class="hljs-comment">// logging log(Usart::USART_1, IOPort::B, GPIO_PIN_6, GPIO_PIN_7, 115200), // RTC rtc(), ledGreen(IOPort::C, GPIO_PIN_1, GPIO_MODE_OUTPUT_PP), ledBlue(IOPort::C, GPIO_PIN_2, GPIO_MODE_OUTPUT_PP), ledRed(IOPort::C, GPIO_PIN_3, GPIO_MODE_OUTPUT_PP), heartbeatEvent(rtc, 10, 2), mco(IOPort::A, GPIO_PIN_8, GPIO_MODE_AF_PP), // Interrupt priorities irqPrioI2S(6, 0), // I2S DMA interrupt priority: 7 will be also used irqPrioEsp(5, 0), irqPrioSd(3, 0), // SD DMA interrupt priority: 4 will be also used irqPrioRtc(2, 0), // SD card pinSdPower(IOPort::A, GPIO_PIN_15, GPIO_MODE_OUTPUT_PP, GPIO_PULLDOWN, GPIO_SPEED_HIGH, true, false), pinSdDetect(IOPort::B, GPIO_PIN_3, GPIO_MODE_INPUT, GPIO_PULLUP), portSd1(IOPort::C, /* mode = */GPIO_MODE_OUTPUT_PP, /* pull = */GPIO_PULLUP, /* speed = */GPIO_SPEED_FREQ_VERY_HIGH, /* pin = */GPIO_PIN_8 | GPIO_PIN_9 | GPIO_PIN_10 | GPIO_PIN_11 | GPIO_PIN_12, /* callInit = */false), portSd2(IOPort::D, /* mode = */GPIO_MODE_OUTPUT_PP, /* pull = */GPIO_PULLUP, /* speed = */GPIO_SPEED_FREQ_VERY_HIGH, /* pin = */GPIO_PIN_2, /* callInit = */false), sdCard(pinSdDetect, portSd1, portSd2), sdCardInserted(false), // Configuration config(pinSdPower, sdCard, "conf.txt"), //ESP esp(rtc, Usart::USART_2, IOPort::A, GPIO_PIN_2, GPIO_PIN_3, irqPrioEsp, IOPort::A, GPIO_PIN_1), espSender(rtc, esp, ledRed), // Input pins pins { { IOPin(IOPort::A, GPIO_PIN_4, GPIO_MODE_INPUT, GPIO_PULLUP), IOPin(IOPort::A, GPIO_PIN_5, GPIO_MODE_INPUT, GPIO_PULLUP), IOPin(IOPort::A, GPIO_PIN_6, GPIO_MODE_INPUT, GPIO_PULLUP), IOPin(IOPort::A, GPIO_PIN_7, GPIO_MODE_INPUT, GPIO_PULLUP), IOPin(IOPort::C, GPIO_PIN_4, GPIO_MODE_INPUT, GPIO_PULLUP), IOPin(IOPort::C, GPIO_PIN_5, GPIO_MODE_INPUT, GPIO_PULLUP), IOPin(IOPort::B, GPIO_PIN_0, GPIO_MODE_INPUT, GPIO_PULLUP), IOPin(IOPort::B, GPIO_PIN_1, GPIO_MODE_INPUT, GPIO_PULLUP) } }, // I2S2 Audio Configuration // PB10 --&gt; I2S2_CK // PB12 --&gt; I2S2_WS // PB15 --&gt; I2S2_SD i2s(IOPort::B, GPIO_PIN_10 | GPIO_PIN_12 | GPIO_PIN_15, irqPrioI2S), audioDac(i2s, /* power = */ IOPort::B, GPIO_PIN_11, /* mute = */ IOPort::B, GPIO_PIN_13, /* smplFreq = */ IOPort::B, GPIO_PIN_14), streamer(sdCard, audioDac), playButton(IOPort::B, GPIO_PIN_2, GPIO_PULLUP, rtc) { mco.activateClockOutput(RCC_MCO1SOURCE_PLLCLK, RCC_MCODIV_5); }</span></span></code> </pre> <br><p>  рдПрдХ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ, рдПрдХ рдмрдЯрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдИрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдЬреЛ WAV рдлрд╝рд╛рдЗрд▓ рдЦреЗрд▓рдирд╛ рд╢реБрд░реВ / рдмрдВрдж рдХрд░рддрд╛ рд╣реИ: </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MyApplication::onButtonPressed (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Devices::Button * b, <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> numOccured) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b == &amp;playButton) { USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"play button pressed: "</span></span> &lt;&lt; numOccured); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (streamer.isActive()) { USART_DEBUG(<span class="hljs-string"><span class="hljs-string">" Stopping WAV"</span></span>); streamer.stop(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { USART_DEBUG(<span class="hljs-string"><span class="hljs-string">" Starting WAV"</span></span>); streamer.start(AudioDac_UDA1334::SourceType:: STREAM, config.getWavFile()); } } }</code> </pre> <br><p>  рдФрд░ рдЕрдВрдд рдореЗрдВ, рдореБрдЦреНрдп рд░рди рд╡рд┐рдзрд┐ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдкреВрд░рд╛ рдХрд░рддреА рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдШрдЯрдирд╛ рд╣реИрдВрдбрд▓рд░ рдХреЗ рд░реВрдк рдореЗрдВ MyApplication рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ), рдФрд░ рдПрдХ рдЕрдВрддрд╣реАрди рд▓реВрдк рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдпрд╣ рд╕рдордп-рд╕рдордп рдкрд░ рдЙрди рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рд╕рдордп-рд╕рдордп рдкрд░ рдзреНрдпрд╛рди рджреЗрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MyApplication::run () { <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.initInstance(); USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Oscillator frequency: "</span></span> &lt;&lt; System::getExternalOscillatorFreq() &lt;&lt; <span class="hljs-string"><span class="hljs-string">", MCU frequency: "</span></span> &lt;&lt; System::getMcuFreq()); HAL_StatusTypeDef status = HAL_TIMEOUT; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { status = rtc.start(<span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">2047</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span>, RTC_WAKEUPCLOCK_RTCCLK_DIV2, irqPrioRtc, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"RTC start status: "</span></span> &lt;&lt; status); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (status != HAL_OK); sdCard.setIrqPrio(irqPrioSd); sdCard.initInstance(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sdCard.isCardInserted()) { updateSdCardState(); } USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Input pins: "</span></span> &lt;&lt; pins.size()); pinsState.fill(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Pin state: "</span></span> &lt;&lt; fillMessage()); esp.assignSendLed(&amp;ledGreen); streamer.stop(); streamer.setHandler(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); streamer.setVolume(<span class="hljs-number"><span class="hljs-number">1.0</span></span>); playButton.setHandler(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> reportState = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { updateSdCardState(); playButton.periodic(); streamer.periodic(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isInputPinsChanged()) { USART_DEBUG(<span class="hljs-string"><span class="hljs-string">"Input pins change detected"</span></span>); ledBlue.putBit(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); reportState = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } espSender.periodic(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (espSender.isOutputMessageSent()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reportState) { espSender.sendMessage(config, <span class="hljs-string"><span class="hljs-string">"TCP"</span></span>, config.getServerIp(), config.getServerPort(), fillMessage()); reportState = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!reportState) { ledBlue.putBit(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (heartbeatEvent.isOccured()) { ledGreen.putBit(heartbeatEvent.occurance() == <span class="hljs-number"><span class="hljs-number">1</span></span>); } } }</code> </pre> <br><h3 id="nemnogo-eksperimentov">  рдереЛрдбрд╝рд╛ рд╕рд╛ рдкреНрд░рдпреЛрдЧ </h3><br><p>   тАФ    .    тАФ 168 MHz. ,   ,      172 MHz   180 MHz,          ,      ,         MCO.     ,   USART  I2S, ,  ,      HAL. </p><br><h2 id="cena">  </h2><br><p>        .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=http://htmlpreview.github.io/%3F">github</a>     .    - ,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">Mouser</a> (   ).     37      .            .  ,        STM  Olimex,      . </p><br><h2 id="problemy-i-perspektivy">    </h2><br><p>        .       ,   : </p><br><ul><li>        (   ).  ,       ,            .       :     4  8 .        PLL,         . </li><li>    ,       .      47 ╬╝F  . ,    . </li><li>   SWD      .    -  ,     .     . </li><li>     .     SMD ,    .       3       . </li></ul><br><h2 id="dokumentaciya">  рдкреНрд░рд▓реЗрдЦрди </h2><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">github</a>   GPL v3: </p><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://docs.google.com/viewer%3Furl%3D"></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://docs.google.com/viewer%3Furl%3D"></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://docs.google.com/viewer%3Furl%3D"> </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=https://docs.google.com/viewer%3Furl%3D"> </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=http://htmlpreview.github.io/%3F"> </a> </li></ul><br><p>  рдЖрдкрдХрд╛ рдзреНрдпрд╛рди рдХреЗ рд▓рд┐рдП рдзрдиреНрдпрд╡рд╛рдж! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi413101/">https://habr.com/ru/post/hi413101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi413091/index.html">SpringBoot + Log4j2 + рдорд╛рд╡реЗрди рдореЗрдВ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рд▓реЙрдЧрд┐рдВрдЧ</a></li>
<li><a href="../hi413093/index.html">рд╕рдВрдпреБрдХреНрдд рд░рд╛рдЬреНрдп рдЕрдореЗрд░рд┐рдХрд╛ рдФрд░ рдЪреАрди рдореЗрдВ рдЕрдВрддрд░рд┐рдХреНрд╖ рд╡реНрдпрд╛рдкрд╛рд░рд┐рдпреЛрдВ рдХреА рджреМрдбрд╝ рдХреА рдкреНрд░рддреНрдпрд╛рд╢рд╛ рдореЗрдВ</a></li>
<li><a href="../hi413095/index.html">рддрдВрддреНрд░рд┐рдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рдХрд╛ рдЕрдиреБрдкреНрд░рдпреЛрдЧ: рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рд╡рд┐рдХрд╛рд╕</a></li>
<li><a href="../hi413097/index.html">рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬрд╝-рд╕реНрддрд░ рдХреЗ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рд▓рд╛рдЦреЛрдВ рдмрд╛рд░ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЧрдпрд╛: рдУрдкрдирд╕рд╕ рд▓реАрдк 15 рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛</a></li>
<li><a href="../hi413099/index.html">рдореИрдХрдмреБрдХ рдкрд░ рдбрд╛рдЙрдирдХреНрд▓реЙрдХрд┐рдВрдЧ рд░реИрдо</a></li>
<li><a href="../hi413103/index.html">3CX v15.5 рдЕрджреНрдпрддрди 5 рдмреАрдЯрд╛ рдФрд░ рдмрд╛рдХреА рдПрдХреАрдХрд░рдг AmoCRM рдХреЗ рд╕рд╛рде рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛</a></li>
<li><a href="../hi413105/index.html">IoT рдкреНрд░рджрд╛рддрд╛ рдХреЗ рдиреЛрдЯреНрд╕ред рд▓реЛрд░рд╛рд╡рди рдореЗрдВ рд╕рдХреНрд░рд┐рдпрддрд╛ рдФрд░ рд╕реБрд░рдХреНрд╖рд╛</a></li>
<li><a href="../hi413107/index.html">Svelto.ECS рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╡рд┐рдХрд┐ рдХрд╛ рдЕрдиреБрд╡рд╛рджред рдпреВрдирд┐рдЯреА 3 рдбреА рдХреЗ рд▓рд┐рдП рдИрд╕реАрдПрд╕ рдлреНрд░реЗрдорд╡рд░реНрдХ</a></li>
<li><a href="../hi413109/index.html">рд╕рд╛рд╕ рдЙрддреНрдкрд╛рдж рдПрдХреАрдХрд░рдг рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдо рдХреИрд╕реЗ рдмрдирд╛рдПрдВ: рдкреЛрд╕реНрдЯрд░ рдХреНрд▓рд╛рдЙрдб рдЪреЗрдХрдЖрдЙрдЯ рдЕрдиреБрднрд╡</a></li>
<li><a href="../hi413111/index.html">STM32 + NetBeans =?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>