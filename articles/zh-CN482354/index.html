<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘¨ğŸ¼ ğŸ® â‡ï¸ ConfigureAwaitï¼šå¸¸è§é—®é¢˜ â™ï¸ ğŸŒ‘ ğŸ‘©ğŸ¼â€ğŸ¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å“ˆHaï¼ æˆ‘å‘æ‚¨ä»‹ç»Stephen Taubæ’°å†™çš„ConfigureAwait FAQæ–‡ç« çš„ç¿»è¯‘ã€‚ 



 Async / awaitæ·»åŠ åˆ°ä¸ƒå¹´å‰çš„.NETä¸­ã€‚ è¿™ä¸€å†³å®šä¸ä»…å¯¹.NETç”Ÿæ€ç³»ç»Ÿäº§ç”Ÿäº†é‡å¤§å½±å“-è¿˜åæ˜ åœ¨è®¸å¤šå…¶ä»–è¯­è¨€å’Œæ¡†æ¶ä¸­ã€‚ å½“å‰ï¼Œ.NETå·²åœ¨ä½¿ç”¨å¼‚æ­¥çš„å…¶ä»–è¯­è¨€æ„é€ æ–¹é¢å®ç°äº†è®¸å¤šæ”¹è¿›...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ConfigureAwaitï¼šå¸¸è§é—®é¢˜</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482354/">å“ˆHaï¼ æˆ‘å‘æ‚¨ä»‹ç»Stephen Taubæ’°å†™<a href="https://devblogs.microsoft.com/dotnet/configureawait-faq/" rel="nofollow">çš„ConfigureAwait FAQ</a>æ–‡ç« çš„ç¿»è¯‘ã€‚ <br><br><img src="https://habrastorage.org/webt/ps/pj/sm/pspjsmmgsimr2lachonj6idmnj8.png" alt="å›¾ç‰‡"><br><br>  <code>Async</code> / <code>await</code>æ·»åŠ åˆ°ä¸ƒå¹´å‰çš„.NETä¸­ã€‚ è¿™ä¸€å†³å®šä¸ä»…å¯¹.NETç”Ÿæ€ç³»ç»Ÿäº§ç”Ÿäº†é‡å¤§å½±å“-è¿˜åæ˜ åœ¨è®¸å¤šå…¶ä»–è¯­è¨€å’Œæ¡†æ¶ä¸­ã€‚ å½“å‰ï¼Œ.NETå·²åœ¨ä½¿ç”¨å¼‚æ­¥çš„å…¶ä»–è¯­è¨€æ„é€ æ–¹é¢å®ç°äº†è®¸å¤šæ”¹è¿›ï¼Œå·²å®ç°äº†å…·æœ‰å¼‚æ­¥æ”¯æŒçš„APIï¼Œå¯¹åŸºç¡€æ¶æ„ä¹Ÿè¿›è¡Œäº†æ ¹æœ¬æ€§çš„æ”¹è¿›ï¼Œå› æ­¤<code>async</code> / <code>await</code>å·¥ä½œåŸç†ç±»ä¼¼äºæ—¶é’Ÿï¼ˆç‰¹åˆ«æ˜¯æ€§èƒ½å’Œè¯Šæ–­åŠŸèƒ½å·²å¾—åˆ°æ”¹è¿›ï¼‰åœ¨.NET Coreä¸­ï¼‰ã€‚ <br><br>  <code>ConfigureAwait</code>æ˜¯<code>async</code> / <code>await</code>ä¸€ä¸ªæ–¹é¢ï¼Œä¸æ–­å¼•èµ·é—®é¢˜ã€‚ æˆ‘å¸Œæœ›æˆ‘èƒ½å›ç­”å…¶ä¸­çš„è®¸å¤šé—®é¢˜ã€‚ æˆ‘å°†å°è¯•ä½¿æœ¬æ–‡ä»å¤´åˆ°å°¾éƒ½å…·æœ‰å¯è¯»æ€§ï¼ŒåŒæ—¶ä»¥å¯¹å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰çš„å›ç­”çš„æ–¹å¼æ‰§è¡Œè¯¥æ–‡ç« ï¼Œä»¥ä¾¿å°†æ¥å¯ä»¥å¼•ç”¨ã€‚ <a name="habracut"></a><br><br> ä¸ºäº†å®é™…å¤„ç†<code>ConfigureAwait</code> ï¼Œæˆ‘ä»¬å°†å›é¡¾ä¸€ä¸‹ã€‚ <br><br><h3> ä»€ä¹ˆæ˜¯SynchronizationContextï¼Ÿ </h3><br> æ ¹æ®<a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.synchronizationcontext%3Fview%3Dnetframework-4.8" rel="nofollow">System.Threading.SynchronizationContext</a>æ–‡æ¡£ï¼Œâ€œæä¾›äº†ç”¨äºåœ¨å„ç§åŒæ­¥æ¨¡å‹ä¸­åˆ†å‘åŒæ­¥ä¸Šä¸‹æ–‡çš„åŸºæœ¬åŠŸèƒ½ã€‚â€ è¿™ä¸ªå®šä¹‰ä¸æ˜¯å¾ˆæ˜æ˜¾ã€‚ <br><br> åœ¨99.9ï¼…çš„æƒ…å†µä¸‹ï¼Œ <code>SynchronizationContext</code>ä»…ç”¨ä½œå¸¦æœ‰è™šæ‹Ÿ<code>Post</code>æ–¹æ³•çš„ç±»å‹ï¼Œè¯¥æ–¹æ³•æ¥å—å§”æ‰˜ä»¥è¿›è¡Œå¼‚æ­¥æ‰§è¡Œï¼ˆ <code>SynchronizationContext</code>è¿˜æœ‰å…¶ä»–è™šæ‹Ÿæˆå‘˜ï¼Œä½†å®ƒä»¬ä¸é‚£ä¹ˆå¸¸è§ï¼Œå› æ­¤åœ¨æœ¬æ–‡ä¸­å°†ä¸å†è®¨è®ºï¼‰ã€‚ åŸºæœ¬ç±»å‹çš„<code>Post</code>æ–¹æ³•å®é™…ä¸Š<a href="" rel="nofollow">åªæ˜¯è°ƒç”¨</a> <code>ThreadPool.QueueUserWorkItem</code>ä»¥å¼‚æ­¥æ‰§è¡Œæä¾›çš„å§”æ‰˜ã€‚ æ´¾ç”Ÿç±»å‹å°†è¦†ç›–<code>Post</code>ä»¥ä¾¿å§”æ‰˜å¯ä»¥åœ¨æ­£ç¡®çš„æ—¶é—´åœ¨æ­£ç¡®çš„ä½ç½®æ‰§è¡Œã€‚ <br><br> ä¾‹å¦‚ï¼ŒWindowsçª—ä½“å…·æœ‰SynchronizationContextæ´¾ç”Ÿçš„<a href="" rel="nofollow">ç±»å‹</a> ï¼Œè¯¥<a href="" rel="nofollow">ç±»å‹</a>é‡æ–°å®šä¹‰äº†<code>Post</code>ä»¥ä½¿å…¶ç­‰æ•ˆäº<code>Control.BeginInvoke</code> ã€‚ è¿™æ„å‘³ç€å¯¹è¯¥<code>Post</code>æ–¹æ³•çš„ä»»ä½•è°ƒç”¨éƒ½å°†å¯¼è‡´åœ¨ç¨åé˜¶æ®µä¸å¯¹åº”çš„Controlç›¸å…³è”çš„çº¿ç¨‹ï¼ˆå³æ‰€è°“çš„UIçº¿ç¨‹ï¼‰ä¸­å¯¹å§”æ‰˜çš„è°ƒç”¨ã€‚  Windowsçª—ä½“çš„æ ¸å¿ƒæ˜¯Win32æ¶ˆæ¯å¤„ç†ã€‚ æ¶ˆæ¯å¾ªç¯åœ¨UIçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè¯¥çº¿ç¨‹ä»…ç­‰å¾…å¤„ç†æ–°æ¶ˆæ¯ã€‚ è¿™äº›æ¶ˆæ¯æ˜¯ç”±é¼ æ ‡ç§»åŠ¨ï¼Œå•å‡»ï¼Œé”®ç›˜è¾“å…¥ï¼Œå¯ç”±å§”æ‰˜æ‰§è¡Œçš„ç³»ç»Ÿäº‹ä»¶ç­‰è§¦å‘çš„ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨åœ¨Windows Formsåº”ç”¨ç¨‹åºä¸­å…·æœ‰UIçº¿ç¨‹çš„<code>SynchronizationContext</code>å®ä¾‹ï¼Œåˆ™å¿…é¡»å°†å§”æ‰˜ä¼ é€’ç»™<code>Post</code>æ–¹æ³•æ‰èƒ½åœ¨å…¶ä¸­æ‰§è¡Œæ“ä½œã€‚ <br><br>  Windows Presentation Foundationï¼ˆWPFï¼‰ä¹Ÿå…·æœ‰ä»<code>SynchronizationContext</code>æ´¾ç”Ÿçš„<a href="" rel="nofollow">ç±»å‹</a> ï¼Œè¯¥<a href="" rel="nofollow">ç±»å‹</a>å…·æœ‰é‡å†™çš„<code>Post</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç±»ä¼¼åœ°ä½¿ç”¨WPF Dispatcheræ§ä»¶ï¼ˆè€Œä¸æ˜¯Windows Forms Controlï¼‰å°†å§”æ‰˜â€œå®šå‘â€åˆ°UIæµï¼ˆä½¿ç”¨<code>Dispatcher.BeginInvoke</code> ï¼‰ã€‚ <br><br>  Windows RunTimeï¼ˆWinRTï¼‰å…·æœ‰è‡ªå·±çš„<code>SynchronizationContext</code>æ´¾ç”Ÿ<a href="" rel="nofollow">ç±»å‹</a> ï¼Œè¯¥<a href="" rel="nofollow">ç±»å‹</a>è¿˜ä½¿ç”¨<code>CoreDispatcher</code>å°†å§”æ‰˜æ”¾å…¥UIçº¿ç¨‹<code>CoreDispatcher</code>ä¸­ã€‚ <br><br> è¿™å°±æ˜¯çŸ­è¯­â€œ UIçº¿ç¨‹ä¸­çš„è¿è¡Œå§”æ‰˜â€çš„èƒŒåã€‚ æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<code>Post</code>æ–¹æ³•å’ŒæŸäº›å®ç°æ¥å®ç°<code>SynchronizationContext</code> ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä¸å¿…æ‹…å¿ƒå§”æ‰˜åœ¨å“ªä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼Œä½†æ˜¯æˆ‘æƒ³ç¡®ä¿<code>SynchronizationContext</code>ä¸­çš„ä»»ä½•<code>Post</code>æ–¹æ³•å§”æ‰˜éƒ½ä»¥ä¸€å®šç¨‹åº¦çš„å¹¶è¡Œåº¦è¿è¡Œã€‚ æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°è‡ªå®šä¹‰<code>SynchronizationContext</code> ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MaxConcurrencySynchronizationContext</span></span> : <span class="hljs-title"><span class="hljs-title">SynchronizationContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> SemaphoreSlim _semaphore; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MaxConcurrencySynchronizationContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxConcurrencyLevel</span></span></span><span class="hljs-function">)</span></span> =&gt; _semaphore = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SemaphoreSlim(maxConcurrencyLevel); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SendOrPostCallback d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state</span></span></span><span class="hljs-function">)</span></span> =&gt; _semaphore.WaitAsync().ContinueWith(<span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { d(state); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _semaphore.Release(); } }, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, TaskContinuationOptions.None, TaskScheduler.Default); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Send</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SendOrPostCallback d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state</span></span></span><span class="hljs-function">)</span></span> { _semaphore.Wait(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { d(state); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _semaphore.Release(); } } }</code> </pre> <br>  xUnitæ¡†æ¶å…·æœ‰ç±»ä¼¼<a href="" rel="nofollow">çš„</a> SynchronizationContext <a href="" rel="nofollow">å®ç°</a> ã€‚ åœ¨è¿™é‡Œï¼Œå®ƒç”¨äºå‡å°‘ä¸å¹¶è¡Œæµ‹è¯•å…³è”çš„ä»£ç é‡ã€‚ <br><br> æ­¤å¤„çš„ä¼˜åŠ¿ä¸ä»»ä½•æŠ½è±¡éƒ½ç›¸åŒï¼šæä¾›äº†ä¸€ä¸ªAPIï¼Œè¯¥APIå¯ç”¨äºæŒ‰ç…§ç¼–ç¨‹äººå‘˜å¸Œæœ›çš„æ–¹å¼å°†å§”æ‰˜æ’é˜Ÿä»¥ä¾¿æ‰§è¡Œï¼Œè€Œæ— éœ€äº†è§£å®ç°ç»†èŠ‚ã€‚ å‡è®¾æˆ‘å†™äº†ä¸€ä¸ªåº“ï¼Œæˆ‘éœ€è¦åœ¨å…¶ä¸­åšä¸€äº›å·¥ä½œï¼Œç„¶åå°†å§”æ‰˜æ’é˜Ÿå›åˆ°åŸå§‹ä¸Šä¸‹æ–‡ã€‚ ä¸ºæ­¤ï¼Œæˆ‘éœ€è¦æ•è·å…¶<code>SynchronizationContext</code> ï¼Œå®Œæˆæ‰€éœ€çš„æ“ä½œåï¼Œåªéœ€è°ƒç”¨æ­¤ä¸Šä¸‹æ–‡çš„<code>Post</code>æ–¹æ³•å¹¶å°†å…¶ä¼ é€’ç»™å§”æ‰˜å³å¯æ‰§è¡Œã€‚ æˆ‘ä¸éœ€è¦çŸ¥é“å¯¹äºWindowsçª—ä½“ï¼Œæ‚¨éœ€è¦<code>Control</code>å¹¶ä½¿ç”¨å…¶<code>BeginInvoke</code> ï¼›å¯¹äºWPFï¼Œè¯·ä½¿ç”¨<code>Dispatcher</code> <code>BeginInvoke</code> ï¼Œæˆ–è€…ä»¥æŸç§æ–¹å¼è·å–xUnitçš„ä¸Šä¸‹æ–‡åŠå…¶é˜Ÿåˆ—ã€‚ æˆ‘éœ€è¦åšçš„å°±æ˜¯è·å–å½“å‰çš„<code>SynchronizationContext</code>å¹¶åœ¨ä»¥åä½¿ç”¨ã€‚ ä¸ºæ­¤ï¼Œ <code>SynchronizationContext</code>å…·æœ‰<code>Current</code>å±æ€§ã€‚ å¯ä»¥å¦‚ä¸‹å®ç°ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoWork</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action worker, Action completion</span></span></span><span class="hljs-function">)</span></span> { SynchronizationContext sc = SynchronizationContext.Current; ThreadPool.QueueUserWorkItem(_ =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { worker(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { sc.Post(_ =&gt; completion(), <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } }); }</code> </pre> <br> æ‚¨å¯ä»¥ä½¿ç”¨<code>SynchronizationContext.SetSynchronizationContext</code>æ–¹æ³•ä»<code>Current</code>å±æ€§ä¸­è®¾ç½®ç‰¹æ®Šä¸Šä¸‹æ–‡ã€‚ <br><br><h3> ä»€ä¹ˆæ˜¯ä»»åŠ¡è®¡åˆ’ç¨‹åºï¼Ÿ </h3><br>  <code>SynchronizationContext</code>æ˜¯â€œè°ƒåº¦ç¨‹åºâ€çš„é€šç”¨æŠ½è±¡ã€‚ ä¸€äº›æ¡†æ¶ä¸ºæ­¤ä½¿ç”¨å®ƒä»¬è‡ªå·±çš„æŠ½è±¡ï¼Œå¹¶ä¸”<code>System.Threading.Tasks</code>ä¹Ÿä¸ä¾‹å¤–ã€‚ å½“<code>Task</code>æœ‰å¯ä»¥æ’é˜Ÿå’Œæ‰§è¡Œçš„å§”æ‰˜æ—¶ï¼Œå®ƒä»¬ä¸<code>System.Threading.Tasks.TaskScheduler</code>å…³è”ã€‚ è¿˜æœ‰ä¸€ä¸ªç”¨äºæ’é˜Ÿå§”æ‰˜çš„è™šæ‹Ÿ<code>Post</code>æ–¹æ³•ï¼ˆä½¿ç”¨æ ‡å‡†æœºåˆ¶å®ç°å§”æ‰˜è°ƒç”¨ï¼‰ï¼Œ <code>TaskScheduler</code>æä¾›æŠ½è±¡çš„<code>QueueTask</code>æ–¹æ³•ï¼ˆä½¿ç”¨<code>ExecuteTask</code>æ–¹æ³•å®ç°ä»»åŠ¡è°ƒç”¨ï¼‰ã€‚ <br><br> è¿”å›<code>TaskScheduler.Default</code>çš„é»˜è®¤è°ƒåº¦ç¨‹åºã€‚é»˜è®¤ä¸ºçº¿ç¨‹æ± ã€‚ ä»<code>TaskScheduler</code> ï¼Œè¿˜å¯ä»¥è·å–å’Œè¦†ç›–ç”¨äºè®¾ç½®<code>Task</code>è°ƒç”¨æ—¶é—´å’Œåœ°ç‚¹çš„æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œæ ¸å¿ƒåº“åŒ…æ‹¬<code>System.Threading.Tasks.ConcurrentExclusiveSchedulerPair</code>ç±»å‹ã€‚ æ­¤ç±»çš„å®ä¾‹æä¾›ä¸¤ä¸ª<code>TaskScheduler</code>å±æ€§ï¼š <code>ExclusiveScheduler</code>å’Œ<code>ConcurrentScheduler</code> ã€‚ å¯ä»¥å¹¶è¡Œæ‰§è¡Œåœ¨<code>ConcurrentScheduler</code>è°ƒåº¦çš„ä»»åŠ¡ï¼Œä½†è¦è€ƒè™‘åˆ°<code>ConcurrentExclusiveSchedulerPair</code>åˆ›å»ºæ—¶è®¾ç½®çš„é™åˆ¶ï¼ˆç±»ä¼¼äº<code>MaxConcurrencySynchronizationContext</code> ï¼‰ã€‚ å¦‚æœåœ¨<code>ExclusiveScheduler</code>æ‰§è¡Œä»»åŠ¡å¹¶ä¸”ä¸€æ¬¡ä»…å…è®¸è¿è¡Œä¸€ä¸ªç‹¬å ä»»åŠ¡ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œ<code>ConcurrentScheduler</code>ä»»åŠ¡ã€‚ æ­¤è¡Œä¸ºä¸è¯»/å†™é”éå¸¸ç›¸ä¼¼ã€‚ <br><br> ä¸<code>SynchronizationContext</code>ä¸€æ ·ï¼Œ <code>TaskScheduler</code>å…·æœ‰<code>Current</code>å±æ€§ï¼Œè¯¥å±æ€§è¿”å›å½“å‰<code>TaskScheduler</code> ã€‚ ä½†æ˜¯ï¼Œä¸<code>SynchronizationContext</code>ä¸åŒï¼Œå®ƒç¼ºå°‘ä¸€ç§ç”¨äºè®¾ç½®å½“å‰è°ƒåº¦ç¨‹åºçš„æ–¹æ³•ã€‚ è€Œæ˜¯ï¼Œè°ƒåº¦ç¨‹åºä¸å½“å‰ä»»åŠ¡ç›¸å…³è”ã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œè¯¥ç¨‹åºå°†æ˜¾ç¤º<code>True</code> ï¼Œå› ä¸º<code>StartNew</code>ä½¿ç”¨çš„lambdaåœ¨<code>ConcurrentExclusiveSchedulerPair</code>çš„<code>ExclusiveScheduler</code>å®ä¾‹ä¸­æ‰§è¡Œï¼Œè€Œ<code>TaskScheduler.Current</code>å®‰è£…åœ¨æ­¤è°ƒåº¦ç¨‹åºä¸Šï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cesp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentExclusiveSchedulerPair(); Task.Factory.StartNew(() =&gt; { Console.WriteLine(TaskScheduler.Current == cesp.ExclusiveScheduler); }, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, TaskCreationOptions.None, cesp.ExclusiveScheduler).Wait(); } }</code> </pre> <br> æœ‰è¶£çš„æ˜¯ï¼Œ <code>TaskScheduler</code>æä¾›äº†ä¸€ä¸ªé™æ€çš„<code>FromCurrentSynchronizationContext</code>æ–¹æ³•ã€‚ è¯¥æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„<code>TaskScheduler</code>å¹¶ä½¿ç”¨<code>Post</code>æ–¹æ³•åœ¨è¿”å›çš„<code>SynchronizationContext.Current</code>ä¸Šä¸‹æ–‡ä¸­å°†è¦æ‰§è¡Œçš„ä»»åŠ¡<code>TaskScheduler</code> ã€‚ <br><br><h3>  SynchronizationContextå’ŒTaskSchedulerä¸awaitæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ </h3><br> å‡è®¾æ‚¨éœ€è¦ç¼–å†™ä¸€ä¸ªå¸¦æœ‰æŒ‰é’®çš„UIåº”ç”¨ç¨‹åºã€‚ æŒ‰ä¸‹æŒ‰é’®å°†å¯åŠ¨ä»ç½‘ç«™çš„æ–‡æœ¬ä¸‹è½½å¹¶å°†å…¶è®¾ç½®ä¸ºâ€œ <code>Content</code>æŒ‰é’®ã€‚ è¯¥æŒ‰é’®åªèƒ½ä»å…¶æ‰€åœ¨çš„æµçš„UIä¸­è¿›è¡Œè®¿é—®ï¼Œå› æ­¤ï¼Œå½“æˆ‘ä»¬æˆåŠŸåŠ è½½æ—¥æœŸå’Œæ—¶é—´å¹¶å°†å…¶æ”¾ç½®åœ¨æŒ‰é’®çš„<code>Content</code> ï¼Œæˆ‘ä»¬éœ€è¦ä»å¯¹å…¶è¿›è¡Œæ§åˆ¶çš„æµä¸­è¿›è¡Œæ“ä½œã€‚ å¦‚æœä¸æ»¡è¶³æ­¤æ¡ä»¶ï¼Œæˆ‘ä»¬å°†è·å¾—å¼‚å¸¸ï¼š <br><br><pre> <code class="cs hljs">System.InvalidOperationException: <span class="hljs-string"><span class="hljs-string">'        ,     .'</span></span></code> </pre><br> æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ä½¿ç”¨<code>SynchronizationContext</code>åœ¨æºä¸Šä¸‹æ–‡ä¸­è®¾ç½®<code>Content</code> ï¼Œä¾‹å¦‚é€šè¿‡<code>TaskScheduler</code> ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HttpClient s_httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { s_httpClient.GetStringAsync(<span class="hljs-string"><span class="hljs-string">"http://example.com/currenttime"</span></span>).ContinueWith(downloadTask =&gt; { downloadBtn.Content = downloadTask.Result; }, TaskScheduler.FromCurrentSynchronizationContext()); }</code> </pre> <br> æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨<code>SynchronizationContext</code> ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HttpClient s_httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { SynchronizationContext sc = SynchronizationContext.Current; s_httpClient.GetStringAsync(<span class="hljs-string"><span class="hljs-string">"http://example.com/currenttime"</span></span>).ContinueWith(downloadTask =&gt; { sc.Post(<span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> { downloadBtn.Content = downloadTask.Result; }, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }); }</code> </pre> <br> ä½†æ˜¯ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹éƒ½æ˜ç¡®ä½¿ç”¨å›è°ƒã€‚ ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>async</code> / <code>await</code> ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HttpClient s_httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> s_httpClient.GetStringAsync(<span class="hljs-string"><span class="hljs-string">"http://example.com/currenttime"</span></span>); downloadBtn.Content = text; }</code> </pre> <br> æ‰€æœ‰è¿™ä¸€åˆ‡éƒ½â€œèµ·ä½œç”¨â€å¹¶æˆåŠŸåœ¨UIçº¿ç¨‹ä¸­é…ç½®<code>Content</code> ï¼Œå› ä¸ºåœ¨ä¸Šè¿°æ‰‹åŠ¨å®ç°çš„ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç­‰å¾…ä»»åŠ¡æ˜¯æŒ‡<code>SynchronizationContext.Current</code>å’Œ<code>TaskScheduler.Current</code> ã€‚ å½“æ‚¨â€œæœŸæœ›â€ Cï¼ƒä¸­çš„æŸäº›å†…å®¹æ—¶ï¼Œç¼–è¯‘å™¨å°†ç”¨äºè½®è¯¢ï¼ˆé€šè¿‡è°ƒç”¨<code>GetAwaiter</code> ï¼‰çš„â€œé¢„æœŸâ€ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºTaskï¼‰çš„ä»£ç è½¬æ¢ä¸ºâ€œ waitingâ€ï¼ˆ <code>TaskAwaiter</code> ï¼‰ã€‚  â€œç­‰å¾…â€è´Ÿè´£é™„åŠ ä¸€ä¸ªå›è°ƒï¼ˆé€šå¸¸ç§°ä¸ºâ€œç»§ç»­â€ï¼‰ï¼Œå½“ç­‰å¾…å®Œæˆæ—¶ï¼Œè¯¥å›è°ƒå°†è¿”å›çŠ¶æ€æœºã€‚ ä»–ä½¿ç”¨åœ¨å›è°ƒæ³¨å†ŒæœŸé—´æ•è·çš„ä¸Šä¸‹æ–‡/è°ƒåº¦ç¨‹åºæ¥å®ç°æ­¤ç›®çš„ã€‚ æˆ‘ä»¬å°†è¿›è¡Œä¸€äº›ä¼˜åŒ–å’Œé…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> scheduler = SynchronizationContext.Current; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scheduler <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; TaskScheduler.Current != TaskScheduler.Default) { scheduler = TaskScheduler.Current; }</code> </pre> <br> åœ¨è¿™é‡Œï¼Œé¦–å…ˆæ£€æŸ¥æ˜¯å¦<code>SynchronizationContext</code>äº†<code>SynchronizationContext</code> ï¼Œå¦‚æœæ²¡æœ‰<code>SynchronizationContext</code> ï¼Œåˆ™æ£€æŸ¥æ˜¯å¦<code>TaskScheduler</code>éæ ‡å‡†<code>TaskScheduler</code> ã€‚ å¦‚æœæœ‰ä¸€ä¸ªï¼Œåˆ™å½“å›è°ƒå‡†å¤‡å¥½è¿›è¡Œå‘¼å«æ—¶ï¼Œå°†ä½¿ç”¨æ•è·çš„è°ƒåº¦ç¨‹åºï¼›å¦åˆ™ï¼Œå°†ä½¿ç”¨æ•è·çš„è°ƒåº¦ç¨‹åºã€‚ å¦‚æœä¸æ˜¯ï¼Œåˆ™å›è°ƒå°†ä½œä¸ºå®Œæˆé¢„æœŸä»»åŠ¡çš„æ“ä½œçš„ä¸€éƒ¨åˆ†æ‰§è¡Œã€‚ <br><br><h3>  ConfigureAwaitçš„ä½œç”¨ï¼ˆå‡ï¼‰ </h3><br>  <code>ConfigureAwait</code>æ–¹æ³•ä¸æ˜¯ç‰¹æ®Šçš„ï¼šç¼–è¯‘å™¨æˆ–è¿è¡Œæ—¶ä¸ä¼šä»¥ä»»ä½•ç‰¹å®šæ–¹å¼è¯†åˆ«å®ƒã€‚ è¿™æ˜¯è¿”å›ç»“æ„çš„å¸¸è§„æ–¹æ³•ï¼ˆ <code>ConfiguredTaskAwaitable</code>åŒ…è£…åŸå§‹ä»»åŠ¡ï¼‰å¹¶é‡‡ç”¨å¸ƒå°”å€¼ã€‚ è¯·è®°ä½ï¼Œå¯ä»¥å°†<code>await</code>ä¸å®ç°æ­£ç¡®æ¨¡å¼çš„ä»»ä½•ç±»å‹ä¸€èµ·ä½¿ç”¨ã€‚ å¦‚æœè¿”å›å¦ä¸€ç§ç±»å‹ï¼Œåˆ™æ„å‘³ç€ç¼–è¯‘å™¨å¯ä»¥è®¿é—®å®ä¾‹çš„<code>GetAwaiter</code>æ–¹æ³•ï¼ˆæ¨¡å¼çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œä½†ä½¿ç”¨çš„æ˜¯<code>ConfigureAwait</code>è¿”å›çš„ç±»å‹ï¼Œè€Œä¸æ˜¯ç›´æ¥ä»ä»»åŠ¡æ‰§è¡Œã€‚ è¿™ä½¿æ‚¨å¯ä»¥æ›´æ”¹æ­¤ç‰¹æ®Š<code>await</code>è¡Œä¸ºã€‚ <br><br> ç­‰å¾…è€Œä¸æ˜¯ç­‰å¾…<code>Task</code>ç”±<code>ConfigureAwait(continueOnCapturedContext: false)</code>è¿”å›çš„ç±»å‹<code>ConfigureAwait(continueOnCapturedContext: false)</code>ä¼šç›´æ¥å½±å“ä¸Šè¿°çš„ä¸Šä¸‹æ–‡/è°ƒåº¦ç¨‹åºæ•è·å®ç°ã€‚ é€»è¾‘å˜æˆè¿™æ ·ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> scheduler = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (continueOnCapturedContext) { scheduler = SynchronizationContext.Current; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scheduler <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; TaskScheduler.Current != TaskScheduler.Default) { scheduler = TaskScheduler.Current; } }</code> </pre> <br> æ¢å¥è¯è¯´ï¼Œå³ä½¿å­˜åœ¨å›è°ƒçš„å½“å‰ä¸Šä¸‹æ–‡æˆ–è°ƒåº¦ç¨‹åºï¼Œä¹Ÿå°†å…¶æŒ‡å®šä¸º<code>false</code>æ„å‘³ç€å®ƒä¸å­˜åœ¨ã€‚ <br><br><h3> ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ConfigureAwaitï¼ˆfalseï¼‰ï¼Ÿ </h3><br>  <code>ConfigureAwait(continueOnCapturedContext: false)</code>ç”¨äºé˜²æ­¢å¼ºåˆ¶åœ¨æºä¸Šä¸‹æ–‡æˆ–è°ƒåº¦ç¨‹åºä¸­è°ƒç”¨å›è°ƒã€‚ è¿™ç»™æˆ‘ä»¬å¸¦æ¥äº†å‡ ä¸ªä¼˜ç‚¹ï¼š <br><br>  <b>æ€§èƒ½æå‡ã€‚</b> ä¸ä»…è°ƒç”¨é˜Ÿåˆ—ä¸åŒï¼Œæ’é˜Ÿå›è°ƒå­˜åœ¨å¼€é”€ï¼Œå› ä¸ºè¿™éœ€è¦é¢å¤–çš„å·¥ä½œï¼ˆé€šå¸¸æ˜¯é¢å¤–çš„åˆ†é…ï¼‰ã€‚ æ­¤å¤–ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨è¿è¡Œæ—¶ä½¿ç”¨ä¼˜åŒ–ï¼ˆå½“æˆ‘ä»¬ç¡®åˆ‡çŸ¥é“å›è°ƒå°†å¦‚ä½•è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œæ›´å¤šä¼˜åŒ–ï¼Œä½†æ˜¯å¦‚æœå°†å…¶ä¼ é€’ç»™æŠ½è±¡çš„ä»»æ„å®ç°ï¼Œåˆ™æœ‰æ—¶ä¼šæ–½åŠ é™åˆ¶ï¼‰ã€‚ å¯¹äºè´Ÿè½½è¾ƒé‡çš„éƒ¨åˆ†ï¼Œç”šè‡³æ£€æŸ¥å½“å‰<code>SynchronizationContext</code>å’Œå½“å‰<code>TaskScheduler</code>çš„é¢å¤–æˆæœ¬ï¼ˆå‡æš—ç¤ºç€è¦è®¿é—®é™æ€æµï¼‰ä¹Ÿä¼šæ˜¾ç€å¢åŠ å¼€é”€ã€‚ å¦‚æœ<code>await</code>ä¹‹åçš„ä»£ç ä¸éœ€è¦åœ¨åŸå§‹ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>ConfigureAwait(false)</code>é¿å…æ‰€æœ‰è¿™äº›å¼€é”€ï¼Œå› ä¸ºå®ƒä¸éœ€è¦ä¸å¿…è¦åœ°æ’é˜Ÿï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„ä¼˜åŒ–æ–¹æ³•ï¼Œå¹¶ä¸”è¿˜å¯ä»¥é¿å…ä¸å¿…è¦åœ°è®¿é—®æµé™æ€å˜é‡ã€‚ <br><br>  <b>é˜²æ­¢æ­»é”ã€‚</b> è€ƒè™‘<code>await</code>ç”¨äºä»ç½‘ç»œä¸‹è½½å†…å®¹çš„åº“æ–¹æ³•ã€‚ æ‚¨è°ƒç”¨æ­¤æ–¹æ³•å¹¶åŒæ­¥é˜»å¡ï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨<code>.GetAwaiter()</code>æˆ–<code>.GetAwaiter()</code>æˆ–<code>.GetAwaiter()</code> <code>.GetResult()</code> ã€‚ ç°åœ¨è€ƒè™‘å¦‚æœè°ƒç”¨å‘ç”Ÿåœ¨å½“å‰<code>SynchronizationContext</code>ä½¿ç”¨<code>MaxConcurrencySynchronizationContext</code>æ˜¾å¼åœ°å°†å…¶ä¸­çš„æ“ä½œæ•°é™åˆ¶ä¸º1æ—¶å‘ç”Ÿï¼Œæˆ–è€…éšå¼ï¼ˆå¦‚æœå®ƒæ˜¯å…·æœ‰å•ä¸ªçº¿ç¨‹ï¼ˆä¾‹å¦‚ï¼ŒUIçº¿ç¨‹ï¼‰ä½¿ç”¨çš„ä¸Šä¸‹æ–‡ï¼‰æ—¶å‘ç”Ÿçš„ã€‚ å› æ­¤ï¼Œæ‚¨å¯ä»¥åœ¨å•ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨è¯¥æ–¹æ³•ï¼Œç„¶åå°†å…¶é˜»å¡ï¼Œç­‰å¾…æ“ä½œå®Œæˆã€‚ ä¸‹è½½é€šè¿‡ç½‘ç»œå¼€å§‹ï¼Œå¹¶ç­‰å¾…å…¶å®Œæˆã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç­‰å¾…<code>Task</code>æ•è·å½“å‰çš„<code>SynchronizationContext</code> ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼‰ï¼Œå¹¶ä¸”ä»ç½‘ç»œä¸‹è½½å®Œæˆåï¼Œå®ƒå°†æ’é˜Ÿå›åˆ°<code>SynchronizationContext</code>å›è°ƒä¸­ï¼Œè¯¥å›è°ƒå°†è°ƒç”¨å…¶ä½™æ“ä½œã€‚ ä½†æ˜¯ï¼Œåœ¨ç­‰å¾…æ“ä½œå®Œæˆæ—¶ï¼Œå½“å‰å”¯ä¸€å¯ä»¥å¤„ç†é˜Ÿåˆ—ä¸­å›è°ƒçš„çº¿ç¨‹å·²è¢«é˜»å¡ã€‚ å¹¶ä¸”ï¼Œåªæœ‰åœ¨å¤„ç†å®Œå›è°ƒä¹‹åï¼Œè¯¥æ“ä½œæ‰èƒ½å®Œæˆã€‚ æ­»é”ï¼ å³ä½¿ä¸Šä¸‹æ–‡æœªå°†å¹¶å‘é™åˆ¶ä¸º1ï¼Œä½†æ˜¯èµ„æºä»¥æŸç§æ–¹å¼å—åˆ°é™åˆ¶ï¼Œä¹Ÿä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ æƒ³è±¡åŒæ ·çš„æƒ…å†µï¼Œ <code>MaxConcurrencySynchronizationContext</code>çš„å€¼ä¸º4ã€‚ è€Œä¸æ˜¯ä¸€æ¬¡æ‰§è¡Œè¯¥æ“ä½œï¼Œæˆ‘ä»¬å°†å¯¹ä¸Šä¸‹æ–‡çš„4ä¸ªè°ƒç”¨æ’é˜Ÿã€‚ è¿›è¡Œæ¯ä¸ªå‘¼å«å¹¶é”å®šå…¶å®Œæˆçš„é¢„æœŸã€‚ ç°åœ¨ï¼Œæ‰€æœ‰èµ„æºéƒ½è¢«é˜»å¡ï¼Œç­‰å¾…å¼‚æ­¥æ–¹æ³•å®Œæˆï¼Œå¹¶ä¸”å”¯ä¸€å…è®¸å®ƒä»¬å®Œæˆçš„äº‹æƒ…æ˜¯å¦‚æœæ­¤å›è°ƒå¤„ç†äº†æ­¤ä¸Šä¸‹æ–‡ã€‚ ä½†æ˜¯ï¼Œä»–å·²ç»å®Œå…¨å¿™ç¢Œäº†ã€‚ å†æ¬¡é™·å…¥åƒµå±€ã€‚ å¦‚æœåº“æ–¹æ³•æ”¹ä¸ºä½¿ç”¨<code>ConfigureAwait(false)</code> ï¼Œåˆ™å®ƒå°†ä¸ä¼šå°†å›è°ƒæ’é˜Ÿåˆ°åŸå§‹ä¸Šä¸‹æ–‡ï¼Œè¿™æ ·å¯ä»¥é¿å…æ­»é”è„šæœ¬ã€‚ <br><br><h3> æˆ‘æ˜¯å¦éœ€è¦ä½¿ç”¨ConfigureAwaitï¼ˆtrueï¼‰ï¼Ÿ </h3><br> å¦ï¼Œé™¤éæ‚¨éœ€è¦æ˜ç¡®è¡¨æ˜æ‚¨æ²¡æœ‰ä½¿ç”¨<code>ConfigureAwait(false)</code> ï¼ˆä¾‹å¦‚ï¼Œéšè—é™æ€åˆ†æè­¦å‘Šç­‰ï¼‰ã€‚  <code>ConfigureAwait(true)</code>æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ã€‚ å¦‚æœæ¯”è¾ƒ<code>await task</code>å’Œ<code>await task.ConfigureAwait(true)</code> ï¼Œåˆ™å®ƒä»¬åœ¨åŠŸèƒ½ä¸Šæ˜¯ç›¸åŒçš„ã€‚ å› æ­¤ï¼Œå¦‚æœä»£ç ä¸­å­˜åœ¨<code>ConfigureAwait(true)</code> ï¼Œåˆ™å¯ä»¥åˆ é™¤å®ƒè€Œä¸ä¼šäº§ç”Ÿä»»ä½•è´Ÿé¢å½±å“ã€‚ <br><br>  <code>ConfigureAwait</code>æ–¹æ³•é‡‡ç”¨å¸ƒå°”å€¼ï¼Œå› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½éœ€è¦ä¼ é€’å˜é‡æ¥æ§åˆ¶é…ç½®ã€‚ ä½†æ˜¯åœ¨99ï¼…çš„æƒ…å†µä¸‹ï¼Œè¯¥å€¼è®¾ç½®ä¸ºfalseï¼Œ <code>ConfigureAwait(false)</code> ã€‚ <br><br><h3> ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ConfigureAwaitï¼ˆfalseï¼‰ï¼Ÿ </h3><br> è¿™å–å†³äºæ‚¨æ˜¯å®ç°åº”ç”¨ç¨‹åºçº§ä»£ç è¿˜æ˜¯é€šç”¨åº“ä»£ç ã€‚ <br><br> åœ¨ç¼–å†™åº”ç”¨ç¨‹åºæ—¶ï¼Œé€šå¸¸éœ€è¦ä¸€äº›é»˜è®¤è¡Œä¸ºã€‚ å¦‚æœåº”ç”¨ç¨‹åºæ¨¡å‹/ç¯å¢ƒï¼ˆä¾‹å¦‚Windowsçª—ä½“ï¼ŒWPFï¼ŒASP.NET Coreï¼‰å‘å¸ƒäº†ç‰¹æ®Šçš„<code>SynchronizationContext</code> ï¼Œåˆ™å‡ ä¹å¯ä»¥è‚¯å®šæœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç†ç”±ï¼šè¿™æ„å‘³ç€ä»£ç å…è®¸æ‚¨å¤„ç†åŒæ­¥ä¸Šä¸‹æ–‡ï¼Œä»¥ä¸åº”ç”¨ç¨‹åºæ¨¡å‹/ç¯å¢ƒè¿›è¡Œæ­£ç¡®çš„äº¤äº’ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åœ¨Windows Formsåº”ç”¨ç¨‹åºä¸­ç¼–å†™äº‹ä»¶å¤„ç†ç¨‹åºï¼Œåœ¨xUnitä¸­è¿›è¡Œæµ‹è¯•ï¼Œæˆ–è€…åœ¨ASP.NET MVCæ§åˆ¶å™¨ä¸­ç¼–å†™ä»£ç ï¼Œåˆ™ä¸ç®¡åº”ç”¨ç¨‹åºæ¨¡å‹æ˜¯å¦å·²å‘å¸ƒ<code>SynchronizationContext</code> ï¼Œå¦‚æœéƒ½å­˜åœ¨ï¼Œéƒ½éœ€è¦ä½¿ç”¨<code>SynchronizationContext</code> ã€‚ è¿™æ„å‘³ç€ï¼Œå¦‚æœåŒæ—¶ä½¿ç”¨<code>ConfigureAwait(true)</code>å’Œ<code>await</code> ï¼Œåˆ™å°†å›è°ƒ/ç»§ç»­å‘é€å›åŸå§‹ä¸Šä¸‹æ–‡-ä¸€åˆ‡æŒ‰é¢„æœŸè¿›è¡Œã€‚ ä»è¿™é‡Œå¯ä»¥åˆ¶å®šä¸€æ¡é€šç”¨è§„åˆ™ï¼š <b>å¦‚æœç¼–å†™åº”ç”¨ç¨‹åºçº§ä»£ç ï¼Œ <i>è¯·ä¸è¦ä½¿ç”¨</i> <code>ConfigureAwait(false)</code></b> ã€‚ è®©æˆ‘ä»¬å›åˆ°ç‚¹å‡»å¤„ç†ç¨‹åºï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HttpClient s_httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> s_httpClient.GetStringAsync(<span class="hljs-string"><span class="hljs-string">"http://example.com/currenttime"</span></span>); downloadBtn.Content = text; }</code> </pre> <br>  <code>downloadBtn.Content = text</code>åº”åœ¨åŸå§‹ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œã€‚ å¦‚æœä»£ç è¿åäº†æ­¤è§„åˆ™ï¼Œè€Œæ˜¯ä½¿ç”¨äº†<code>ConfigureAwait (false)</code> ï¼Œé‚£ä¹ˆå®ƒå°†ä¸ä¼šåœ¨åŸå§‹ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ï¼š <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HttpClient s_httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> s_httpClient.GetStringAsync(<span class="hljs-string"><span class="hljs-string">"http://example.com/currenttime"</span></span>).ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  downloadBtn.Content = text; }</span></span></code> </pre> <br> è¿™å°†å¯¼è‡´ä¸å½“è¡Œä¸ºã€‚ è¿™åŒæ ·é€‚ç”¨äºä¾èµ–äº<code>HttpContext.Current</code>çš„ç»å…¸ASP.NETåº”ç”¨ç¨‹åºä¸­çš„ä»£ç ã€‚ å½“ä½¿ç”¨<code>ConfigureAwait(false)</code>éšåå°è¯•ä½¿ç”¨<code>Context.Current</code>å‡½æ•°å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚ <br><br> è¿™å°±æ˜¯é€šç”¨åº“çš„åŒºåˆ«ã€‚ å®ƒä»¬ä¹‹æ‰€ä»¥å…·æœ‰é€šç”¨æ€§ï¼Œéƒ¨åˆ†åŸå› æ˜¯å®ƒä»¬ä¸å…³å¿ƒä½¿ç”¨å®ƒä»¬çš„ç¯å¢ƒã€‚ æ‚¨å¯ä»¥ä»Webåº”ç”¨ç¨‹åºï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºæˆ–æµ‹è¯•ä¸­ä½¿ç”¨å®ƒä»¬-æ²¡å…³ç³»ï¼Œå› ä¸ºåº“ä»£ç å¯¹äºå¯ä»¥ä½¿ç”¨å®ƒçš„åº”ç”¨ç¨‹åºæ¨¡å‹æ˜¯ä¸å¯çŸ¥çš„ã€‚ ä¸å¯çŸ¥è®ºè¿˜æ„å‘³ç€è¯¥åº“å°†ä¸åšä»»ä½•äº‹æƒ…æ¥ä¸åº”ç”¨ç¨‹åºæ¨¡å‹è¿›è¡Œäº¤äº’ï¼Œä¾‹å¦‚ï¼Œå®ƒå°†æ— æ³•è®¿é—®ç”¨æˆ·ç•Œé¢æ§ä»¶ï¼Œå› ä¸ºé€šç”¨åº“å¯¹æ­¤ä¸€æ— æ‰€çŸ¥ã€‚ ç”±äºä¸éœ€è¦åœ¨ä»»ä½•ç‰¹å®šç¯å¢ƒä¸­è¿è¡Œä»£ç ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é¿å…å°†å¼ºåˆ¶æ‰§è¡Œ/å›è°ƒå¼ºåˆ¶åˆ°åŸå§‹ä¸Šä¸‹æ–‡ï¼Œè€Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ConfigureAwait(false)</code>æ¥æ‰§è¡Œæ­¤æ“ä½œï¼Œè¿™å°†ä¸ºæˆ‘ä»¬å¸¦æ¥æ€§èƒ½ä¼˜åŠ¿å¹¶æé«˜å¯é æ€§ã€‚ è¿™å°†å¯¼è‡´ä»¥ä¸‹æƒ…å†µï¼š <b>å¦‚æœè¦ç¼–å†™é€šç”¨åº“ä»£ç ï¼Œè¯·ä½¿ç”¨<code>ConfigureAwait(false)</code></b> ã€‚ è¿™å°±æ˜¯.NET Coreè¿è¡Œæ—¶åº“ä¸­æ¯ä¸ªï¼ˆæˆ–å‡ ä¹æ¯ä¸ªï¼‰ç­‰å¾…éƒ½ä½¿ç”¨ConfigureAwaitï¼ˆfalseï¼‰çš„åŸå› ã€‚ é™¤å°‘æ•°ä¾‹å¤–ï¼ˆå¾ˆå¯èƒ½æ˜¯é”™è¯¯ï¼‰å¤–ï¼Œå®ƒä»¬å°†å¾—åˆ°ä¿®å¤ã€‚ , <a href="https://github.com/dotnet/corefx/pull/38610" rel="nofollow"> PR</a>    <code>ConfigureAwait(false)</code>  <code>HttpClient</code> . <br><br>      . ,     (,   , ,   )      ,     API,     .   ,         ,       â€ "  . , ,    Where LINQ: <code>public static async IAsyncEnumerable&lt;T&gt; WhereAsync(this IAsyncEnumerable&lt;T&gt; source, Func&lt;T, bool&gt; predicate)</code> .   <code>predicate</code>    <code>SynchronizationContext</code>  ?     <code>WhereAsync</code> ,   ,        <code>ConfigureAwait(false)</code> . <br><br>       :  <code>ConfigureAwait(false)</code>      /app-model-agnostic . <br><br><h3>   ConfigureAwait (false),         ? </h3><br> ,  ,          .    ,    <code>await</code>      .    ,      ,      . ,    ,      ,   ,   <code>ConfigureAwait(false)</code> ,            ,     . <br><br><h3>    ConfigureAwait (false)       ,    â€” ? </h3><br>  , .   FAQ.  <code>await task.ConfigureAwait(false)</code>  ,       (      ),   <code>ConfigureAwait(false)</code>  ,           -    ,    . <br><br>     ,   <code>await</code>    ,         ,    <code>SynchronizationContext</code>  <code>TaskScheduler</code> . , <code>CryptoStream</code>     .NET ,                 .      <code><a href="" rel="nofollow">awaiter</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¡®ä¿ç¬¬ä¸€æ¬¡ç­‰å¾…åçš„ä»£ç åœ¨çº¿ç¨‹æ± çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œå³ä½¿åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨ä¹Ÿä¼šæ³¨æ„åˆ°ä¸‹æ¬¡ç­‰å¾…ä»åœ¨ä½¿ç”¨</font></font><code>ConfigureAwait(false)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†æ˜¯ç”±äºä¸éœ€è¦äº†è§£ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å®ƒï¼Œå› æ­¤å¯ä»¥å¤§å¤§ç®€åŒ–ä»£ç å®¡æŸ¥</font></font><code>ConfigureAwait(false)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æ˜¯å¦å¯ä»¥ä½¿ç”¨Task.Runé¿å…ä½¿ç”¨ConfigureAwaitï¼ˆfalseï¼‰ï¼Ÿ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> æ˜¯çš„ï¼Œå¦‚æœæ‚¨å†™ï¼š </font></font><br><br><pre> <code class="cs hljs">Task.Run(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> SomethingAsync(); <span class="hljs-comment"><span class="hljs-comment">//     });</span></span></code> </pre> <br>  <code>ConfigureAwait(false)</code>  <code>SomethingAsync()</code>  ,   ,   <code>Task.Run</code>      ,       , <code>SynchronizationContext.Current</code>   <code>null</code> .  , <code>Task.Run</code>   <code>TaskScheduler.Default</code> ,  <code>TaskScheduler.Current</code>      <code>Default</code> .  ,  <code>await</code>        ,    <code>ConfigureAwait(false)</code> .        ,       .     : <br><br><pre> <code class="cs hljs">Task.Run(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delegate</span></span> { SynchronizationContext.SetSynchronizationContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeCoolSyncCtx()); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> SomethingAsync(); <span class="hljs-comment"><span class="hljs-comment">//    SomeCoolSyncCtx });</span></span></code> </pre> <br>    <code>SomethingAsync</code>   <code>SynchronizationContext.Current</code>  <code>SomeCoolSyncCtx</code> .   <code>await</code> ,       SomethingAsync     .  ,    ,  ,        ,     ,       . <br><br>        /     .         /      . <br><br>    ,        ,  ,     . ,       ,    <code>ConfigureAwait(false)</code> <a href="https://docs.microsoft.com/en-us/visualstudio/code-quality/ca2007%3Fview%3Dvs-2019" rel="nofollow">CA2007</a> .    ,         <code>ConfigureAwait</code> ,   ,    .        , ,      -  ,            ,       <code>ConfigureAwait(false)</code> . <br><br><h3>    SynchronizationContext.SetSynchronizationContext,    ConfigureAwait (false)? </h3><br> ä¸è¡Œ , .      <br><br>    : <br><br><pre> <code class="cs hljs">Task t; SynchronizationContext old = SynchronizationContext.Current; SynchronizationContext.SetSynchronizationContext(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { t = CallCodeThatUsesAwaitAsync(); <span class="hljs-comment"><span class="hljs-comment">// await'      } finally { SynchronizationContext.SetSynchronizationContext(old); } await t; //  -    </span></span></code> </pre> <br><br>  ,      <code>CallCodeThatUsesAwaitAsync</code>     <code>null</code> .   .       ,  <code>await</code>  <code>TaskScheduler.Current</code> .       <code>TaskScheduler</code> , <code>await</code> '  <code>CallCodeThatUsesAwaitAsync</code>          <code>TaskScheduler</code> . <br><br>    <code>Task.Run</code> FAQ,      :     ,     <code>try</code>     ,    (       ). <br><br>          : <br><br><pre> <code class="cs hljs">SynchronizationContext old = SynchronizationContext.Current; SynchronizationContext.SetSynchronizationContext(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> t; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { SynchronizationContext.SetSynchronizationContext(old); }</code> </pre><br>    ?   ,   .  ,       /   .  ,   <code>SynchronizationContext</code>        ,     ,          .   ,    ,    ,  ,            .        ,    ,          .       ,       . ä¾æ­¤ç±»æ¨ã€‚    . <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å¦‚æœæˆ‘ä½¿ç”¨GetAwaiterï¼ˆï¼‰.GetResultï¼ˆï¼‰ï¼Œæ˜¯å¦éœ€è¦ä½¿ç”¨ConfigureAwaitï¼ˆfalseï¼‰ï¼Ÿ </font></font></h3><br> ä¸è¡Œ <code>ConfigureAwait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»…å½±å“å›è°ƒã€‚</font><font style="vertical-align: inherit;">ç‰¹åˆ«æ˜¯ï¼Œæ¨¡æ¿</font></font><code>awaiter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¦æ±‚æ‚¨</font></font><code>awaiter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æä¾›å±æ€§</font></font><code>IsCompleted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæ–¹æ³•</font></font><code>GetResult</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å’Œ</font></font><code>OnCompleted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆå¯é€‰åœ°æä¾›UnsafeOnCompletedæ–¹æ³•ï¼‰ã€‚</font></font><code>ConfigureAwait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»…å½±å“è¡Œä¸º</font></font><code>{Unsafe}OnCompleted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå› æ­¤ï¼Œå¦‚æœæ‚¨ç›´æ¥è°ƒç”¨</font></font><code>GetResult()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œæ— è®ºæ‚¨æ˜¯é€šè¿‡</font><font style="vertical-align: inherit;">è¡Œä¸º</font></font><code>TaskAwaiter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿˜æ˜¯</font></font><code>ConfiguredTaskAwaitable.ConfiguredTaskAwaiter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¡Œä¸ºæ–¹å¼</font><font style="vertical-align: inherit;">éƒ½</font><font style="vertical-align: inherit;">æ²¡æœ‰åŒºåˆ«ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œå¦‚æœçœ‹åˆ°</font></font><code>task.ConfigureAwait(false).GetAwaiter().GetResult()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯ä»¥å°†å…¶æ›¿æ¢ä¸º</font></font><code>task.GetAwaiter().GetResult()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼ˆæ­¤å¤–ï¼Œè¯·è€ƒè™‘æ˜¯å¦ç¡®å®éœ€è¦è¿™æ ·çš„å®ç°ï¼‰ã€‚</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘çŸ¥é“ä»£ç åœ¨ä¸ä¼šæœ‰ç‰¹æ®Šçš„SynchronizationContextæˆ–ç‰¹æ®Šçš„TaskSchedulerçš„ç¯å¢ƒä¸­è¿è¡Œã€‚</font><font style="vertical-align: inherit;">æˆ‘å¯ä»¥ä¸ä½¿ç”¨ConfigureAwaitï¼ˆfalseï¼‰å—ï¼Ÿ</font></font></h3><br> å¯èƒ½å§    ,      Â«Â».     ,  ,   ,    ,    <code>SynchronizationContext</code>        <code>TaskScheduler</code> ,  ,         .       ,     ,    . <br><br><h3>  ,   .NET Core    ConfigureAwait (false).   ? </h3><br> ä¸æ˜¯é‚£æ ·çš„<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨.NET Coreä¸­å·¥ä½œçš„åŸå› ä¸åœ¨.NET Frameworkä¸­å·¥ä½œçš„åŸå› ç›¸åŒæ˜¯å¿…è¦çš„ã€‚åœ¨è¿™æ–¹é¢æ²¡æœ‰ä»»ä½•æ”¹å˜ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ˜¯å¦æŸäº›ç¯å¢ƒå‘å¸ƒè‡ªå·±å·²ç»æ”¹å˜äº†</font></font><code>SynchronizationContext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚ç‰¹åˆ«æ˜¯ï¼Œè™½ç„¶.NET Frameworkä¸­çš„ç»å…¸ASP.NETå…·æœ‰å…¶è‡ªå·±çš„</font></font><code><a href="" rel="nofollow">SynchronizationContext</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œä½†ASP.NET Coreæ²¡æœ‰ã€‚è¿™æ„å‘³ç€é»˜è®¤æƒ…å†µä¸‹</font></font><code>SynchronizationContext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œ</font><font style="vertical-align: inherit;">ASP.NET Coreåº”ç”¨ç¨‹åºä¸­è¿è¡Œçš„ä»£ç å°†çœ‹ä¸åˆ°ç‰¹æ®Šä»£ç </font><font style="vertical-align: inherit;">ï¼Œä»è€Œå‡å°‘äº†</font></font><code>ConfigureAwait(false)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹æ­¤ç¯å¢ƒçš„éœ€æ±‚ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€æ°¸è¿œä¸ä¼šæœ‰ä¹ æƒ¯</font></font><code>SynchronizationContext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ–</font></font><code>TaskScheduler</code> .  -   (   ,  )             ,     ,  <code>await</code> '  ASP.NET Core      ,       <code>ConfigureAwait(false)</code> . ,  ,      (       -)             ,      <code>ConfigureAwait(false)</code> . <br><br><h3>     ConfigureAwait,  Â«  foreachÂ»  IAsyncEnumerable? </h3><br> æ˜¯çš„  .  <a href="https://docs.microsoft.com/en-us/archive/msdn-magazine/2019/november/csharp-iterating-with-async-enumerables-in-csharp-8" rel="nofollow"> MSDN</a> . <br><br> <code>Await foreach</code>   ,  ,      <code>IAsyncEnumerable&lt;T&gt;</code> .       ,     API.    .NET   <a href="" rel="nofollow"></a> <code>ConfigureAwait</code>  <code>IAsyncEnumerable&lt;T&gt;</code> ,    ,   <code>IAsyncEnumerable&lt;T&gt;</code>  <code>Boolean</code>    .      <code>MoveNextAsync</code>  <code>DisposeAsync</code> .         ,    ,    . <br><br><h3>    ConfigureAwait,  'await using' IAsyncDisposable? </h3><br> ,     . <br><br>    <code>IAsyncEnumerable&lt;T&gt;</code> , .NET       <code>ConfigureAwait</code>  <code>IAsyncDisposable</code>  <code>await using</code> ,   ,      ( ,    <code>DisposeAsync</code> ): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyAsyncDisposableClass().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { ... }</code> </pre> <br>     ,   <code>c</code> â€”   <code>MyAsyncDisposableClass</code> ,   <code>System.Runtime.CompilerServices.ConfiguredAsyncDisposable</code> ,      <code>ConfigureAwait</code>  <code>IAsyncDisposable</code> . <br><br>   ,   : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyAsyncDisposableClass(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (c.ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { ... }</code> </pre> <br>   <code>c</code>    <code>MyAsyncDisposableClass</code> .         <code>c</code> ;  ,        . <br><br><h3>   ConfigureAwait (false),   AsyncLocal       .  ? </h3><br> ,   .   <code>AsyncLocal&lt;T&gt;</code>   <code>ExecutionContext</code> ,    <code>SynchronizationContext</code> .       <code>ExecutionContext</code>   <code>ExecutionContext.SuppressFlow()</code> , <code>ExecutionContext</code> (,  ,  <code>AsyncLocal &lt;T&gt;</code> )     <code>awaits</code> ,   ,   <code>ConfigureAwait</code>     <code>SynchronizationContext</code> .      <a href="https://devblogs.microsoft.com/pfxteam/executioncontext-vs-synchronizationcontext/" rel="nofollow"></a> . <br><br><h3>           ConfigureAwait(false)   ? </h3><br>        <code>ConfigureAwait(false)</code>     . <br><br>     ,   ,     // .      ,    , : <a href="https://github.com/dotnet/csharplang/issues/645" rel="nofollow">1</a> , <a href="https://github.com/dotnet/csharplang/issues/2542" rel="nofollow">2</a> , <a href="https://github.com/dotnet/csharplang/issues/2649" rel="nofollow">3</a> , <a href="https://github.com/dotnet/csharplang/issues/2746" rel="nofollow">4</a> . <br><br>     ,        ,  <a href="https://devblogs.microsoft.com/dotnet/configureawait-faq/" rel="nofollow"> </a>    . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482354/">https://habr.com/ru/post/zh-CN482354/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482340/index.html">ä»åˆçº§åˆ°ä¸­çº§ï¼šè§£æå™¨</a></li>
<li><a href="../zh-CN482344/index.html">å‡†å¤‡åœ¨ä¿„ç½—æ–¯å¼•å…¥ç¤¾ä¼šè¯„çº§</a></li>
<li><a href="../zh-CN482346/index.html">ASP.NET MVC-é€šè¿‡ADO.NETä½¿ç”¨MySQL</a></li>
<li><a href="../zh-CN482348/index.html">æ¯«ä¸æ€€ç–‘çš„æ¸¸æˆå¼€å‘è€…çš„æ‹“æ‰‘å’Œç»¼åˆåˆ†æï¼šå‹ç¼©å•ä¸ª3Då‘é‡</a></li>
<li><a href="../zh-CN482352/index.html">å½“æˆ‘å·®ç‚¹å°†150kæŠ•å‘é£æˆ–è€…å…¬å¯“ä¸­å¼ºåˆ¶é€šé£çš„å®‰è£…å†å²æ—¶</a></li>
<li><a href="../zh-CN482356/index.html">ä»å¸¸è§„Windowsç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨æ²¡æœ‰èµ„æºç®¡ç†å™¨çš„æƒ…å†µä¸‹ä½¿ç”¨Windows Server</a></li>
<li><a href="../zh-CN482358/index.html">æƒŠæ…Œå¦‚ä½•åœ¨Rustä¸­å‘æŒ¥ä½œç”¨</a></li>
<li><a href="../zh-CN482362/index.html">å‡ ä¹æ— æ”¿åºœçŠ¶æ€ï¼šFidonetçš„ç®€è¦å†å²ï¼Œè¯¥é¡¹ç›®ä¸å…³å¿ƒé€šè¿‡äº’è”ç½‘è·èƒœ</a></li>
<li><a href="../zh-CN482366/index.html">æœºå™¨äººä¸“å®¶å¯¹ç‰¹æ–¯æ‹‰è‡ªåŠ¨é©¾é©¶ä»ªæœ‰ä½•çœ‹æ³•</a></li>
<li><a href="../zh-CN482370/index.html">nodejsï¼šæµç¨‹ç®¡ç†å™¨å’ŒES6æ¨¡å—</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>