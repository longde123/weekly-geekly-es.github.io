<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèê üöÄ üç∞ Testes de codecep√ß√£o para back-ends PHP üññ üèüÔ∏è üßóüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Meu nome √© Pasha e sou engenheiro de controle de qualidade da equipe de processamento de pedidos da Lamoda. Eu falei recentemente no PHP ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testes de codecep√ß√£o para back-ends PHP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/452136/">  Ol√° pessoal!  Meu nome √© Pasha e sou engenheiro de controle de qualidade da equipe de processamento de pedidos da Lamoda.  Eu falei recentemente no PHP Badoo Meetup.  Hoje eu quero fornecer uma transcri√ß√£o do meu relat√≥rio. <br><br>  Falaremos sobre a codecep√ß√£o, sobre como a usamos no Lamoda e como escrever testes nela. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rg1h7mJrU7Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  Lamoda tem muitos servi√ßos.  Existem servi√ßos de clientes que interagem diretamente com nossos usu√°rios, com usu√°rios do site, aplicativo m√≥vel.  N√≥s n√£o vamos falar sobre eles.  E existe o que nossa empresa chama de back-end profundo - esses s√£o nossos sistemas de back-office que automatizam nossos processos de neg√≥cios.  Isso inclui entrega, armazenamento, automa√ß√£o de est√∫dios de fotografia e um call center.  A maioria desses servi√ßos √© desenvolvida em PHP. <br><br>  Falando brevemente sobre nossa pilha, este √© o PHP + Symfony.  Aqui e h√° projetos antigos no Zend'e.  PostgreSQL e MySQL s√£o usados ‚Äã‚Äãcomo bancos de dados, e Rabbit ou Kafka s√£o usados ‚Äã‚Äãcomo sistemas de mensagens. <br><br>  <b>Por que o back-end do PHP?</b> <br><br>  Como eles geralmente t√™m uma API ramificada - √© REST, em alguns lugares h√° um pouco de SOAP.  Se eles tiverem uma interface do usu√°rio, essa interface ser√° mais auxiliar, usada por nossos usu√°rios internos. <br><br>  <b>Por que precisamos de autotestes em Lamoda?</b> <br><br>  Em geral, quando cheguei ao trabalho na Lamoda, havia um slogan: "Vamos nos livrar da regress√£o manual".  N√£o testaremos manualmente nada de regress√£o.  E n√≥s trabalhamos nessa tarefa.  Na verdade, essa √© uma das principais raz√µes pelas quais precisamos de autotestes - para n√£o conduzir a regress√£o manualmente.  Por que precisamos disso?  Direito de liberar rapidamente.  Para que possamos lan√ßar nossos lan√ßamentos sem problemas, com muita rapidez e, ao mesmo tempo, ter algum tipo de grade de autoteste que eles nos dir√£o, bom ou ruim.  Estes s√£o provavelmente os objetivos mais importantes.  Mas h√° alguns auxiliares sobre os quais tamb√©m quero dizer. <br><br>  Por que precisamos de autoteste? <br><br><ol><li>  N√£o teste a regress√£o com as m√£os </li><li>  Libera√ß√£o r√°pida </li><li>  Use como documenta√ß√£o </li><li>  Acelere a integra√ß√£o de novos funcion√°rios </li><li>  Os autotestes s√£o convenientemente usados ‚Äã‚Äã(em alguns casos) como documenta√ß√£o.  √Äs vezes, √© mais f√°cil entrar nos testes, ver quais casos s√£o cobertos, como eles funcionam e entender como essa ou aquela funcionalidade funciona e acelerar a entrada de novos funcion√°rios - desenvolvedores e testadores - em um novo projeto.  Quando voc√™ se senta para escrever autotestes, fica imediatamente claro como o sistema funciona. </li></ol><br>  Ok, conversamos sobre por que precisamos de autotestes.  Agora vamos falar sobre os testes que escrevemos em Lamoda. <br><br><img src="https://habrastorage.org/webt/qx/ci/0f/qxci0fma8tivrntsz95gv-d802e.jpeg" alt="imagem"><br><br>  Essa √© uma pir√¢mide de teste bastante padr√£o, desde testes de unidade at√© testes E2E, onde algumas cadeias de neg√≥cios j√° foram testadas.  N√£o falarei sobre os dois n√≠veis inferiores; n√£o √© √† toa que eles s√£o pintados com a cor branca.  Estes s√£o testes no pr√≥prio c√≥digo, eles s√£o escritos por nossos desenvolvedores.  Em casos extremos, o testador pode acessar a solicita√ß√£o de solicita√ß√£o, examinar o c√≥digo e dizer: "Bem, algo n√£o √© suficiente aqui, vamos cobrir outra coisa".  Isso conclui o trabalho do testador para esses testes. <br><br>  Falaremos sobre os n√≠veis acima, escritos por desenvolvedores e testadores.  Vamos come√ßar com os testes do sistema.  Estes s√£o testes que testam a API (REST ou SOAP), testam alguma l√≥gica interna do sistema, v√°rios comandos, analisam filas no Rabbit ou trocam com sistemas externos.  Como regra, esses testes s√£o bastante at√¥micos.  Eles n√£o verificam nenhuma cadeia, mas verificam uma a√ß√£o.  Por exemplo, um m√©todo de API ou um comando.  E eles verificam o maior n√∫mero poss√≠vel de casos, positivos e negativos. <br><br>  V√° em frente, testes E2E.  Dividi-os em 2 partes.  Temos testes que testam v√°rias UI e back-end.  E existem testes que chamamos de testes de fluxo.  Eles testam a cadeia - a vida de um objeto do come√ßo ao fim. <br><br>  Por exemplo, temos um sistema para gerenciar o processamento de nossos pedidos.  Dentro desse sistema, pode haver um teste - um pedido da cria√ß√£o √† entrega, ou seja, passando por todos os status.  √â nesses testes que √© muito f√°cil e simples observar como o sistema funciona.  Voc√™ v√™ imediatamente todo o fluxo de certos objetos, com quais sistemas externos tudo isso interage, quais comandos s√£o usados ‚Äã‚Äãpara isso. <br><br>  Como temos essa interface do usu√°rio usada por usu√°rios internos, o acesso entre navegadores n√£o √© importante para n√≥s.  N√£o realizamos esses testes em nenhum farms, basta fazer o check-in em um navegador e, √†s vezes, nem precisamos usar um navegador. <br><br>  "Por que escolhemos o Codeception para automa√ß√£o de testes?"  - voc√™ provavelmente pergunta. <br><br>  Para ser sincero, n√£o tenho resposta para essa pergunta.  Quando cheguei a Lamoda, o Codeception j√° estava selecionado como padr√£o para escrever autotestes, e me deparei com isso de fato.  Mas depois de trabalhar com essa estrutura por algum tempo, eu ainda entendia o porqu√™ da codecep√ß√£o.  √â isso que quero compartilhar com voc√™. <br><br>  <b>Por que co-concep√ß√£o?</b> <br><br><ol><li>  Voc√™ pode escrever e executar os mesmos testes de qualquer tipo (unidade, funcional, aceita√ß√£o). </li><li>  Muitos ancinhos j√° foram resolvidos, muitos m√≥dulos j√° foram escritos. </li><li>  Em todos os projetos, apesar das necessidades um pouco diferentes, os testes ter√£o a mesma apar√™ncia. </li><li>  O conceito de codecep√ß√£o sugere que voc√™ escreva quaisquer testes nesta estrutura: unidade, integra√ß√£o, funcional, aceita√ß√£o.  E voc√™, pelo menos, eles ser√£o lan√ßados igualmente. </li><li>  A co-recep√ß√£o √© um processador poderoso o suficiente no qual muitos problemas, muitas perguntas e muitas tarefas para testes j√° foram resolvidos.  Se algo n√£o for decidido, provavelmente voc√™ encontrar√° algo de fora - algum complemento para algum trabalho espec√≠fico.  Voc√™ n√£o precisa escrever nenhum wrapper de teste para bancos de dados, para outra coisa.  Basta pegar e conectar os m√≥dulos ao Codeception e trabalhar com eles. </li><li>  Bem, essa vantagem (provavelmente √© mais adequada para grandes empresas quando voc√™ tem muitos projetos e servi√ßos) - em todos os projetos, os testes ter√£o a apar√™ncia mais ou menos a mesma.  Isso √© muito legal. </li></ol><br>  Vou dizer brevemente como √© a codecep√ß√£o, j√° que muitos trabalharam com ela. <br><br><img src="https://habrastorage.org/webt/bp/ac/nt/bpacntwtc_xvl52su3nh7-vvidi.jpeg" alt="imagem"><br><br>  A co-concep√ß√£o funciona em um modelo de ator.  Depois de arrast√°-lo para o projeto e inicializar, essa estrutura √© gerada. <br><br>  Temos os arquivos yml, aqui abaixo - <i>functional.suite.yml</i> , <i>integration.suit.yml</i> , <i>unit.suite.yml</i> .  Eles criam a configura√ß√£o dos seus testes.  Existem pais para cada tipo de teste, onde est√£o esses testes, existem 3 pais auxiliares: <br><br>  _ <i>dados</i> - para dados de teste; <br>  _ <i>output</i> - onde os relat√≥rios s√£o colocados (xml, html); <br>  _ <i>suporte</i> - onde alguns auxiliares auxiliares, fun√ß√µes e tudo o que voc√™ escreve s√£o utilizados em seus testes. <br><br>  Para come√ßar, vou lhe dizer o que tiramos da codecep√ß√£o e us√°-lo imediatamente, sem modificar nada, sem resolver tarefas ou problemas adicionais. <br><br>  <b>M√≥dulos padr√£o</b> <br><br><ol><li>  Phpbrowser </li><li>  REST </li><li>  Db </li><li>  Cli </li><li>  AMQP </li></ol><br>  O primeiro desses m√≥dulos √© o PhpBrowser.  Este m√≥dulo √© um inv√≥lucro do Guzzle que permite interagir com seu aplicativo: abrir p√°ginas, preencher formul√°rios, enviar formul√°rios.  E se voc√™ n√£o se importa com os testes entre navegadores e navegadores, se estiver repentinamente testando a interface do usu√°rio, poder√° usar o PhpBrowser.  Como regra, usamos em nossos testes de interface do usu√°rio, porque n√£o precisamos de nenhuma l√≥gica de intera√ß√£o complicada, precisamos apenas abrir a p√°gina e fazer algo pequeno l√°. <br><br>  O segundo m√≥dulo que usamos √© REST.  Eu acho que o nome deixa claro o que ele est√° fazendo.  Para qualquer intera√ß√£o http, voc√™ pode usar este m√≥dulo.  Parece-me que quase todas as intera√ß√µes s√£o resolvidas: cabe√ßalhos, cookies, autoriza√ß√£o.  Tudo o que voc√™ precisa est√° nele. <br><br>  O terceiro m√≥dulo que usamos imediatamente √© o m√≥dulo Db.  Nas vers√µes recentes do Codeception, suporte para n√£o um, mas v√°rios bancos de dados foram adicionados l√°.  Portanto, se voc√™ repentinamente tiver v√°rios bancos de dados em seu projeto, agora ele funciona imediatamente. <br><br>  O m√≥dulo Cli, que permite executar <b>comandos shell</b> e <b>bash a</b> partir de testes, e n√≥s o usamos tamb√©m. <br><br>  Existe um m√≥dulo AMQP que funciona com qualquer agente de mensagens baseado neste protocolo.  Quero observar que √© oficialmente testado no RabbitMQ.  Desde que usamos RabbitMQ, est√° tudo bem com ele. <br><br>  De fato, a codecep√ß√£o, pelo menos no nosso caso, cobre 80 a 85% de todas as tarefas de que precisamos.  Mas eu ainda tinha que trabalhar em alguma coisa. <br><br>  Vamos come√ßar com SOAP. <br><img src="https://habrastorage.org/webt/c9/zy/bk/c9zybkm3eu-kvkxc_uvpcte_h0u.jpeg" alt="imagem"><br><br>  Em nossos servi√ßos, em alguns lugares existem pontos de extremidade SOAP.  Eles precisam ser testados, puxados, algo a ver com eles.  Mas voc√™ dir√° que no Codeception existe um m√≥dulo que permite enviar solicita√ß√µes e fazer alguma coisa com as respostas.  De alguma forma para analisar, adicionar cheques e est√° tudo bem.  Mas o m√≥dulo SOAP n√£o funciona imediatamente com v√°rios pontos de extremidade SOAP. <br><img src="https://habrastorage.org/webt/uj/s_/zv/ujs_zvshqpzmecycdggm3mys4nq.jpeg" alt="imagem"><br><br>  Por exemplo, temos mon√≥litos que possuem v√°rios WSDLs, v√°rios pontos de extremidade SOAP.  Isso significa que √© imposs√≠vel no m√≥dulo Codeception configurar isso em um arquivo yml para que ele possa trabalhar com v√°rios. <br><img src="https://habrastorage.org/webt/uc/z-/ab/ucz-abgapgah_r9qo6uoitkstg8.jpeg" alt="imagem"><br><br>  A codecep√ß√£o possui uma reconfigura√ß√£o de m√≥dulo din√¢mico e voc√™ pode gravar algum tipo de adaptador para receber, por exemplo, um m√≥dulo SOAP e reconfigur√°-lo dinamicamente.  Nesse caso, √© necess√°rio substituir o terminal e o esquema usado.  Em seguida, no teste, se voc√™ precisar alterar o terminal para o qual deseja enviar uma solicita√ß√£o, obtemos nosso adaptador e o alteramos para um novo terminal, para um novo circuito e enviamos uma solicita√ß√£o para ele. <br><img src="https://habrastorage.org/webt/68/iu/kl/68iuklk2oherxt4ov7odgrszyli.jpeg" alt="imagem"><br><br>  Em Codeception, n√£o h√° trabalho com Kafka e n√£o h√° complementos mais ou menos oficiais de terceiros para trabalhar com Kafka.  N√£o h√° com o que se preocupar, escrevemos nosso m√≥dulo. <br><img src="https://habrastorage.org/webt/es/gp/eg/esgpegswio_kwmtqer7gkqvjfgi.jpeg" alt="imagem"><br><br>  Portanto, ele est√° configurado em um arquivo yml.  Algumas configura√ß√µes s√£o definidas para corretores, consumidores e t√≥picos.  Essas configura√ß√µes, quando voc√™ escreve seu m√≥dulo, pode pux√°-lo para os m√≥dulos com a fun√ß√£o de inicializa√ß√£o e inicializar este m√≥dulo com as mesmas configura√ß√µes.  E, de fato, o m√≥dulo possui todos os outros m√©todos para implementar - coloque a mensagem no t√≥pico e leia-a.  √â tudo o que voc√™ precisa deste m√≥dulo. <br><img src="https://habrastorage.org/webt/zo/5p/bo/zo5pbox8a8xxic2n8972phohhd0.jpeg" alt="imagem"><br><br>  <b>Conclus√£o</b> : os m√≥dulos para codecep√ß√£o s√£o f√°ceis de escrever. <br><br>  V√° em frente.  Como eu disse, o Codeception possui um m√≥dulo Cli - um inv√≥lucro para comandos do <i>shell</i> e trabalhando com sua sa√≠da. <br><img src="https://habrastorage.org/webt/8c/gg/yr/8cggyrxinincflxsx2ti3o4klwq.jpeg" alt="imagem"><br><br>  Mas, √†s vezes, o comando <i>shell</i> precisa ser executado n√£o nos testes, mas no aplicativo.  Em geral, testes e aplicativos s√£o entidades ligeiramente diferentes, podem estar em lugares diferentes.  Os testes podem ser executados em um local e o aplicativo em outro. <br><br>  Ent√£o, por que precisamos executar o <i>shell</i> nos testes? <br><br>  Temos comandos em aplicativos que, por exemplo, analisam filas no RabbitMQ e movem objetos por status.  Esses comandos no modo pro s√£o iniciados no supervisor.  O supervisor monitora sua implementa√ß√£o.  Se eles ca√≠rem, ele os inicia novamente e assim por diante. <br><br>  Quando testamos, o supervisor n√£o est√° sendo executado.  Caso contr√°rio, os testes se tornam inst√°veis, imprevis√≠veis.  N√≥s mesmos queremos controlar o lan√ßamento desses comandos dentro do aplicativo.  Portanto, precisamos executar esses comandos a partir dos testes no aplicativo.  N√≥s usamos duas op√ß√µes.  Aquele, aquele outro - em princ√≠pio, tudo √© o mesmo e tudo funciona. <br><br>  Como executar um <i>shell</i> em um aplicativo? <br><br>  Primeiro: execute os testes no mesmo local em que o aplicativo est√° localizado.  Como todos os aplicativos que temos no Docker, os testes podem ser executados no mesmo cont√™iner em que o servi√ßo est√° localizado. <br><br>  A segunda op√ß√£o: fa√ßa um cont√™iner separado para testes, algum <i>executor de testes</i> , mas fa√ßa o mesmo que o aplicativo.  Ou seja, da mesma imagem do Docker e tudo funcionar√° da mesma maneira. <br><img src="https://habrastorage.org/webt/wm/hw/g0/wmhwg0-0xviw0be73xgrwfppsfi.jpeg" alt="imagem"><br><br>  Outro problema que encontramos nos testes est√° trabalhando com v√°rios sistemas de arquivos.  Abaixo est√° um exemplo do que voc√™ pode e deve trabalhar.  Os tr√™s primeiros s√£o relevantes para n√≥s.  Estes s√£o Webdav, SFTP e o sistema de arquivos da Amazon. <br><br>  Com o que voc√™ precisa trabalhar? <br><br><ol><li>  Webdav </li><li>  FTP / SFTP </li><li>  AWS S3 </li><li>  Local </li><li>  Azure, Dropbox, Google Drive </li></ol><br>  Se voc√™ vasculhar o Codeception, poder√° encontrar alguns m√≥dulos para quase qualquer sistema de arquivos mais ou menos popular. <br><br><img src="https://habrastorage.org/webt/84/kr/ol/84krold4wqwi4ckxe4trmr8u9oq.jpeg" alt="imagem"><br><br>  A √∫nica coisa que n√£o encontrei √© para o Webdav.  Mas esses sistemas de arquivos, mais ou menos, s√£o os mesmos em termos de trabalho externo com eles, e queremos trabalhar com eles da mesma maneira. <br><br>  N√≥s escrevemos nosso m√≥dulo chamado Flysystem.  Encontra-se no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Github</a> em dom√≠nio p√∫blico e suporta 2 sistemas de arquivos - SFTP e Webdav - e permite trabalhar com os dois usando a mesma API. <br><img src="https://habrastorage.org/webt/5a/w5/sm/5aw5smemb1fabsbsyvt5eit70r8.jpeg" alt="imagem"><br><br>  Obtenha uma lista de arquivos, limpe o diret√≥rio, escreva um arquivo e assim por diante.  Se voc√™ tamb√©m adicionar o sistema de arquivos da Amazon, nossas necessidades ser√£o definitivamente atendidas. <br><br>  O pr√≥ximo ponto, eu acho, √© muito importante para autotestes, especialmente no n√≠vel do sistema, para trabalhar com bancos de dados.  Em geral, eu quero que seja, como na figura, - VZHUH e tudo inicia, funciona, e esses bancos de dados devem ter menos suporte nos testes. <br><img src="https://habrastorage.org/webt/hb/-y/ul/hb-yulyfmetwazoatr4oukazpli.jpeg" alt="imagem"><br><br>  Quais s√£o as principais tarefas que eu vejo aqui: <br><br><ol><li>  Como implantar o banco de dados da estrutura desejada - Db </li><li>  Como preencher o banco de dados com dados de teste </li><li>  Como fazer sele√ß√µes e verifica√ß√µes - Db </li></ol><br>  Para todas as 3 tarefas em Codeception, existem 2 m√≥dulos - Db, sobre o qual eu j√° falei, outro √© chamado Fixtures. <br><br>  Desses 2 m√≥dulos e 3 tarefas, usamos apenas DB para a terceira tarefa. <br><br>  Para a primeira tarefa, voc√™ pode usar o DB.  L√° voc√™ pode configurar o dump SQL a partir do qual o banco de dados ser√° implantado, bem, o m√≥dulo com dispositivos el√©tricos, acho que est√° claro por que √© necess√°rio. <br><br>  Haver√° acess√≥rios na forma de matrizes que podem ser mantidas no banco de dados. <br><br>  Como eu disse, nas 2 primeiras tarefas resolvemos um pouco diferente, agora vou lhe dizer como fazemos. <br><br>  <b>Implanta√ß√£o de banco de dados</b> <br><br><ol><li>  Criando um cont√™iner com PostgreSQL ou MySQL </li><li>  Rolamos todas as migra√ß√µes com migra√ß√µes de doutrina </li></ol><br>  O primeiro √© sobre a implanta√ß√£o de um banco de dados.  Como isso acontece nos testes.  N√≥s aumentamos o cont√™iner com o banco de dados desejado - PostgreSQL ou MySQL, depois rolamos todas as migra√ß√µes necess√°rias usando as migra√ß√µes de <i>doutrina</i> .  Tudo, o banco de dados da estrutura desejada est√° pronto, pode ser usado em testes. <br><br>  Por que n√£o usamos amortecedores - porque n√£o precisa ser suportado.  Esse √© algum tipo de despejo que reside nos testes, que precisa ser constantemente atualizado se algo mudar no banco de dados.  Existem migra√ß√µes - n√£o h√° necessidade de manter um despejo. <br><br>  O segundo ponto √© a cria√ß√£o de dados de teste.  N√£o usamos o m√≥dulo Fixtures da Codeception, usamos o pacote <i>Symfony</i> para fixtures. <br><img src="https://habrastorage.org/webt/kx/lf/m9/kxlfm9zppbdqmgj_i_ekaripjw4.jpeg" alt="imagem"><br><br>  H√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> para ele e um exemplo de como voc√™ pode criar acess√≥rios no banco de dados. <br><br>  Seu equipamento ser√° criado como um objeto do dom√≠nio, poder√° ser armazenado no banco de dados e os dados de teste estar√£o prontos. <br><br>  Por que DoctrineFixtureBundle? <br><br><ol><li>  Mais f√°cil criar cadeias de objetos relacionados. </li><li>  Menos duplica√ß√£o de dados se acess√≥rios para testes diferentes forem semelhantes. </li><li>  Menos edi√ß√µes ao alterar a estrutura do banco de dados. </li><li>  As aulas de fixa√ß√£o s√£o muito mais visuais que as matrizes. </li></ol><br>  Por que usamos?  Sim, pelo mesmo motivo - esses equipamentos s√£o muito mais f√°ceis de manter do que os da Codeception.  √â mais f√°cil criar cadeias de objetos relacionados, porque est√° tudo no pacote symfony.  Menos dados precisam ser duplicados, porque os equipamentos podem ser herdados, s√£o classes.  Se a estrutura do banco de dados mudar, essas matrizes sempre precisam ser editadas e as classes nem sempre.  As lumin√°rias na forma de objetos de dom√≠nio s√£o sempre mais vis√≠veis que matrizes. <br><br>  N√≥s conversamos sobre bancos de dados, vamos falar um pouco sobre moki. <br><br>  Como esses s√£o testes de n√≠vel suficientemente alto que testam todo o sistema e como nossos sistemas s√£o altamente interconectados, fica claro que existem algumas trocas e intera√ß√µes.  Agora vamos falar sobre mokeys na intera√ß√£o entre sistemas. <br><br>  <b>Regras para mok</b> <br><br><ol><li>  Chorar todas as intera√ß√µes externas de servi√ßo http </li><li>  Verificando n√£o apenas cen√°rios positivos, mas tamb√©m negativos </li></ol><br>  Intera√ß√µes s√£o algumas intera√ß√µes http REST ou SOAP.  Todas essas intera√ß√µes dentro da estrutura dos testes que estamos molhando.  Ou seja, em nossos testes n√£o h√° apelo real para sistemas externos em nenhum lugar.  Isso torna os testes est√°veis.  Porque um servi√ßo externo pode funcionar, pode n√£o funcionar, pode responder lentamente, pode rapidamente, em geral, n√£o saber qual √© o seu comportamento.  Portanto, cobrimos tudo com moks. <br><br>  N√≥s tamb√©m temos essa regra.  Estamos molhando n√£o apenas intera√ß√µes positivas, mas tamb√©m tentando verificar alguns casos negativos.  Por exemplo, quando um servi√ßo de terceiros responde com um erro 500 ou produz um erro mais significativo, tentamos verificar tudo. <br><br>  Usamos o Wiremock para zombarias, o pr√≥prio Codeception suporta ..., ele tem um complemento oficial Httpmock, mas gostamos mais do Wiremock.  Como isso funciona? <br><br><br><br>  O Wiremock surge como um cont√™iner do Docker separado durante os testes e todas as solicita√ß√µes que devem ser enviadas ao sistema externo v√£o para o Wiremock. <br><br><img src="https://habrastorage.org/webt/n9/cb/y8/n9cby8a1hoiicw5fqprvzsfxsae.jpeg" alt="imagem"><br><br>  Wiremock, se voc√™ olhar para o slide - existe uma caixa, Mapeamento de Solicita√ß√µes, que possui um conjunto de mapeamentos que afirmam que, se uma solicita√ß√£o chegar, voc√™ precisar√° fornecer uma resposta.  Tudo √© muito simples: um pedido chegou - recebeu uma farsa. <br><br>  As simula√ß√µes podem ser criadas estaticamente e, em seguida, o cont√™iner, quando j√° estiver com a Wiremock, essas simula√ß√µes estar√£o dispon√≠veis e poder√£o ser usadas em testes manuais.  Voc√™ pode criar dinamicamente, diretamente no c√≥digo, em algum tipo de teste. <br><br>  Aqui est√° um exemplo de como criar uma simula√ß√£o dinamicamente, veja bem, a descri√ß√£o √© bastante declarativa, fica imediatamente claro a partir do c√≥digo que tipo de simula√ß√£o estamos criando: uma simula√ß√£o para o m√©todo GET que chega a esse URL e, de fato, o que retornar. <br><br><img src="https://habrastorage.org/webt/d7/xu/2g/d7xu2gg75_-vjff1ejruhj2dvba.jpeg" alt="imagem"><br><br>  Al√©m do fato de que esse mock pode ser criado, a Wiremock tem a oportunidade de verificar qual solicita√ß√£o foi enviada para esse mock.  Isso tamb√©m √© muito √∫til em testes. <br><br>  Sobre a codecep√ß√£o em si, provavelmente, tudo, e algumas palavras sobre como nossos testes s√£o executados, e um pouco de infraestrutura. <br><br>  O que estamos usando? <br><br><img src="https://habrastorage.org/webt/qy/my/hj/qymyhjaocwm0apzi7orjlot7hnw.jpeg" alt="imagem"><br><br>  Bem, primeiro, todos os servi√ßos que temos no Docker, portanto, o lan√ßamento de um ambiente de teste est√° aumentando os cont√™ineres certos. <br><br>  Make √© usado para comandos internos, Bamboo √© usado como IC. <br><br>  Como √© a execu√ß√£o do teste de IC? <br><br><img src="https://habrastorage.org/webt/hb/iq/jf/hbiqjftacif8wg-67x666c7l5yc.jpeg" alt="imagem"><br><br>  Primeiro, criamos a vers√£o desejada do aplicativo, depois aumentamos o ambiente - esse √© o aplicativo, todos os servi√ßos necess√°rios, como Kafka, Rabbit, o banco de dados e rolamos a migra√ß√£o para o banco de dados. <br><br>  Todo esse ambiente √© criado com a ajuda do Docker Compose.  √â no CI, no prod que todos os cont√™ineres giram sob o Kubernetes.  Em seguida, execute os testes e execute. <br><br>  Quanto tempo isso leva? <br><br>  Tudo depende do servi√ßo espec√≠fico, mas, como regra, elevar o ambiente antes de executar os testes √© de 5 a 10 minutos, testes - de 6 a 30 minutos. <br><br><img src="https://habrastorage.org/webt/nm/kh/n0/nmkhn0sdps-qtoowra4mrtgtu8m.jpeg" alt="imagem"><br><br>  Avisarei imediatamente essa pergunta enquanto todos os testes estiverem em um √∫nico thread. <br><br>  Bem, essa pergunta.  Com que frequ√™ncia os testes devem ser executados?  Obviamente, quanto mais frequentemente, melhor.  Quanto mais cedo voc√™ conseguir detectar um problema, mais r√°pido poder√° resolv√™-lo. <br><br>    2  .     ,      ,  unit,   unit-.  -   ,      . <br><br> ,    .       . <br><br>       -  ‚Äî  ,    ,  Codeception,  . ,     . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt452136/">https://habr.com/ru/post/pt452136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt452124/index.html">‚ÄúPrecisamos ter fome de conhecimento e realiza√ß√µes‚Äù - como √© ser um testador no Alfa-Bank</a></li>
<li><a href="../pt452128/index.html">Equ√≠vocos populares sobre a resist√™ncia √† radia√ß√£o de microcircuitos</a></li>
<li><a href="../pt452130/index.html">A lua est√° encolhendo, causa terremotos</a></li>
<li><a href="../pt452132/index.html">Caminho do freelancer</a></li>
<li><a href="../pt452134/index.html">Como tudo come√ßou: a hist√≥ria do ferro de soldar e o advento das ferramentas modernas</a></li>
<li><a href="../pt452138/index.html">13. Introdu√ß√£o ao Ponto de Verifica√ß√£o R80.20. Licenciamento</a></li>
<li><a href="../pt452140/index.html">Por que os CFOs mudam para um modelo de custo operacional em TI</a></li>
<li><a href="../pt452142/index.html">Como lidamos com a c√≥pia de conte√∫do ou com o primeiro ataque advers√°rio em prod</a></li>
<li><a href="../pt452146/index.html">Ent√£o, o que acontecer√° com autentica√ß√£o e senhas? Parte 2 do Relat√≥rio de Status de Autentica√ß√£o Forte do Javelin</a></li>
<li><a href="../pt452152/index.html">Que solu√ß√µes a Rostelecom possui para o IIoT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>