<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê¥ ü§õüèø ü§ú C√≥mo hacemos la automatizaci√≥n de una gran red heredada üòß üë©‚Äçüë©‚Äçüë¶‚Äçüë¶ üëÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Tenemos m√°s de 15,260 objetos y 38,000 dispositivos de red que deben configurarse, actualizarse y verificarse para que funcionen. Mantener tal fl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo hacemos la automatizaci√≥n de una gran red heredada</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/468197/">  Hola  Tenemos m√°s de 15,260 objetos y 38,000 dispositivos de red que deben configurarse, actualizarse y verificarse para que funcionen.  Mantener tal flota de equipos es bastante dif√≠cil y requiere mucho tiempo, esfuerzo y personas.  Por lo tanto, necesit√°bamos automatizar el trabajo con equipos de red y decidimos adaptar el concepto de Red como C√≥digo para administrar la red en nuestra empresa.  Debajo del corte, lea nuestro historial de automatizaci√≥n, los errores cometidos y un plan adicional para construir sistemas. <br><br><img src="https://habrastorage.org/webt/tq/6w/po/tq6wposkryjnbyoqfcpv6qgj-q8.png"><br><a name="habracut"></a><br><h2>  Larga historia corta, queremos automatizar la red </h2><br>  Hola  Mi nombre es Alexander Prokhorov y, junto con el equipo de ingenieros de redes de nuestro departamento, estamos <b>trabajando</b> en una red en <b>#IT</b> <b><font color="#FFA500">X5</font></b> .  Nuestro departamento desarrolla infraestructura de red, monitoreo, automatizaci√≥n de red y la direcci√≥n moderna de Network as a Code. <br><br>  Inicialmente, en realidad no cre√≠a en ninguna automatizaci√≥n en nuestra red.  Quedaban muchos errores heredados y de configuraci√≥n: no en todas partes hab√≠a una autorizaci√≥n central, no todo el hardware soportaba SSH, no todo <abbr title="Protocolo simple de administraci√≥n de red">SNMP</abbr> estaba configurado.  Todo esto min√≥ en gran medida la creencia en la automatizaci√≥n.  Por lo tanto, en primer lugar, arreglamos lo que se necesita para iniciar la automatizaci√≥n, a saber: estandarizaci√≥n de la conexi√≥n SSH, autorizaci√≥n √∫nica ( <abbr title="Autenticaci√≥n, Autorizaci√≥n, Contabilidad">AAA</abbr> ) y perfiles SNMP.  Toda esta base le permite escribir una herramienta para la entrega masiva de configuraciones a un dispositivo, pero surge la pregunta: ¬øpuedo obtener m√°s?  Entonces llegamos a la necesidad de elaborar un plan para el desarrollo de la automatizaci√≥n y, en particular, el concepto de Red como C√≥digo. <br><br>  El concepto de red como c√≥digo, seg√∫n Cisco, significa los siguientes principios: <br><br><ul><li>  Almacene configuraciones de destino en el repositorio, control de origen </li><li>  Los cambios de configuraci√≥n pasan por el repositorio, Fuente √∫nica de verdad </li><li>  Incrustar configuraciones a trav√©s de la <abbr title="Interfaz de programaci√≥n de aplicaciones">API</abbr> </li></ul><br><img src="https://habrastorage.org/webt/bw/wi/6u/bwwi6us89ipickqukqdgd1zkvk0.jpeg" align="right" width="240"><br><br>  Los primeros dos puntos le permiten aplicar el enfoque DevOps o NetDevOps para administrar su infraestructura de red.  Con el tercer p√°rrafo hay dificultades, por ejemplo, ¬øqu√© hacer si no hay API?  ¬°Por supuesto, SSH y CLI, somos networkers! <br><br><div class="spoiler">  <b class="spoiler_title">¬øY eso es todo lo que necesitamos?</b> <div class="spoiler_text">  La aplicaci√≥n de estos principios por s√≠ sola no resuelve todos los problemas de la infraestructura de red, as√≠ como su aplicaci√≥n requiere una cierta base con los datos de la red. <br><br>  Preguntas que surgieron cuando pensamos en esto: <br><br><ul><li>  OK, guardo la configuraci√≥n como c√≥digo, ¬øc√≥mo debo aplicarla en un objeto espec√≠fico? </li><li>  Ok, tengo una plantilla de configuraci√≥n en el repositorio, pero ¬øc√≥mo puedo configurar autom√°ticamente una configuraci√≥n para un objeto basado en √©l? </li><li>  ¬øC√≥mo averiguar qu√© modelo y qu√© proveedor debe estar en este objeto?  ¬øPuedo hacerlo autom√°ticamente? </li><li>  ¬øC√≥mo puedo verificar si la configuraci√≥n actual del objeto coincide con los par√°metros en el repositorio? </li><li>  ¬øC√≥mo trabajar con cambios en el repositorio y replicarlos en una red productiva? </li><li>  ¬øQu√© conjunto de datos y sistemas necesito para pensar en el aprovisionamiento Zero Touch? </li><li>  ¬øQu√© pasa con las diferencias en los proveedores, e incluso los modelos del mismo proveedor? </li><li>  ¬øC√≥mo almacenar subredes para la configuraci√≥n autom√°tica? </li></ul><br>  En base a todas las preguntas anteriores, qued√≥ claro que necesitamos un conjunto de sistemas que resuelvan varios problemas, trabajen en conjunto y nos brinden informaci√≥n completa sobre la infraestructura de la red. <br><br><img src="https://habrastorage.org/webt/iz/us/cx/izuscxapcn5-6ync8yexgqlxs0u.jpeg"><br></div></div><br>  Adem√°s de tratar de aplicar nuevos enfoques para la gesti√≥n de la red, quer√≠amos resolver algunos problemas m√°s graves en la infraestructura de la red, como la integridad de los datos, la actualizaci√≥n y, por supuesto, la automatizaci√≥n.  Por automatizaci√≥n nos referimos no solo a la entrega masiva de configuraciones a los equipos, sino tambi√©n a la configuraci√≥n autom√°tica, la recopilaci√≥n autom√°tica de datos de inventario de equipos de red y la integraci√≥n con los sistemas de monitoreo.  Pero lo primero es lo primero. <br><br>  La funcionalidad a la que apuntamos es: <br><br><ul><li>  Base de datos de equipos de red (+ descubrimiento, + actualizaci√≥n autom√°tica) </li><li>  Direcciones de red base (IPAM + verificaciones de validaci√≥n) </li><li>  Integraci√≥n de sistemas de monitoreo con datos de inventario. </li><li>  Almacenamiento de est√°ndares de configuraci√≥n en el sistema de control de versiones. </li><li>  Formaci√≥n autom√°tica de configuraciones de destino para un objeto. </li><li>  Entrega masiva de configuraciones a equipos de red </li><li>  Implemente un proceso de CI / CD para administrar los cambios de configuraci√≥n de red </li><li>  Probar configuraciones de red con CI / CD </li><li>  ZTP (Zero Touch Provisioning): configuraci√≥n autom√°tica de equipos para un objeto </li></ul><br><div class="spoiler">  <b class="spoiler_title">Larga historia, intentamos la automatizaci√≥n</b> <div class="spoiler_text">  Comenzamos a intentar automatizar el trabajo de configuraci√≥n de la red hace 2 a√±os.  ¬øPor qu√© ahora vuelve a surgir esta pregunta y necesita atenci√≥n? <br><br>  Es aburrido y aburrido configurar m√°s de una docena de dispositivos con las manos.  A veces la mano del ingeniero se contrae, y √©l comete errores.  Para varias docenas, una secuencia de comandos escrita por un ingeniero suele ser suficiente, lo que transfiere la configuraci√≥n actualizada al equipo de red. <br><br>  ¬øPor qu√© no parar all√≠?  De hecho, muchos ingenieros de redes ya saben c√≥mo hacer todo tipo de pitones, y aquellos que no saben c√≥mo hacerlo ya podr√°n hacerlo muy pronto (Natalya Samoilenko, sin embargo, ha publicado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un excelente trabajo en Python</a> , especialmente para los networkers).  Cualquiera que tenga la tarea de configurar n + 1 enrutadores puede escribir un script y desplegar la configuraci√≥n muy r√°pidamente.  Mucho m√°s r√°pido que entonces capaz de recuperar todo.  Seg√∫n la experiencia de la automatizaci√≥n "cada hombre por s√≠ mismo", se producen errores cuando puede restablecer la comunicaci√≥n solo con las manos y con un gran sufrimiento de todo el equipo. <br><br><img src="https://habrastorage.org/webt/rp/ts/ie/rptsiexeli86bdhhumak_d1z7eo.jpeg"><br><br><h5>  Ejemplo </h5><br><img src="https://habrastorage.org/webt/ow/q8/tk/owq8tkmg8p5xeorxn0ypbwqudw0.png" align="right" width="240">  Una vez, uno de los ingenieros decidi√≥ realizar una tarea importante: restablecer el orden en las configuraciones de los enrutadores.  Como resultado de la auditor√≠a en varios objetos, se encontr√≥ una <i><font color="#008080">lista de prefijos</font></i> obsoleta con subredes espec√≠ficas, que ya no necesit√°bamos.  Anteriormente, se usaba para filtrar las direcciones de <i><font color="#008080">bucle</font></i> de <i><font color="#008080">retorno</font></i> de los sitios centrales para que pasaran por un solo canal, y pudimos probar la conexi√≥n en este canal.  Pero el mecanismo fue optimizado y dejaron de usar un esquema de prueba de canal.  El empleado decidi√≥ eliminar esta <i><font color="#008080">lista de prefijos</font></i> para que no aparezca en la configuraci√≥n y cause confusi√≥n en el futuro.  Todos acordaron eliminar la <i><font color="#008080">lista de prefijos</font></i> no utilizada, la tarea es simple, se olvidaron de inmediato.  Pero eliminar la misma <i><font color="#008080">lista de prefijos</font></i> con tus manos en docenas de objetos es bastante aburrido y requiere mucho tiempo.  Y el ingeniero escribi√≥ un gui√≥n que pasar√° r√°pidamente por el equipo, har√° <i><font color="#008080">"ninguna lista de prefijos pl-cisco-primer"</font></i> y guardar√° solemnemente la configuraci√≥n. <br><br>  Alg√∫n tiempo despu√©s de la discusi√≥n, unas pocas horas o un d√≠a, no recuerdo, cay√≥ un objeto.  Despu√©s de un par de minutos, otro similar.  El n√∫mero de objetos inaccesibles continu√≥ creciendo, en media hora a 10, y cada 2-3 minutos se agreg√≥ uno nuevo.  Todos los ingenieros estaban conectados para el diagn√≥stico.  40-50 minutos despu√©s del inicio del accidente, todos fueron interrogados sobre los cambios y el empleado detuvo el gui√≥n.  En ese momento, ya hab√≠a unos 20 objetos con canales rotos.  Una restauraci√≥n completa tom√≥ 7 ingenieros durante varias horas. <br><br><h5>  Lado t√©cnico </h5><br>  <i><font color="#008080">La lista de prefijos se</font></i> us√≥ para filtrar <i><font color="#008080">bucles de retroceso</font></i> : uno se filtr√≥ en un canal, el segundo en la copia de seguridad.  Esto se us√≥ para probar la comunicaci√≥n sin cambiar el tr√°fico productivo entre canales.  Por lo tanto, la primera regla de un <i><font color="#008080">mapa de ruta</font></i> entrante en un vecino <i><font color="#008080">BGP</font></i> era <i><font color="#008080">NEGAR</font></i> con <i><font color="#008080">"lista de prefijos de direcci√≥n IP de coincidencia"</font></i> .  El resto de las reglas en <i><font color="#008080">el mapa de ruta</font></i> eran <i><font color="#008080">PERMISO</font></i> . <br><br>  Hay varios matices que vale la pena se√±alar: <br><br><ul><li>  La regla del <i><font color="#008080">mapa de ruta</font></i> en la que no hay <i><font color="#008080">coincidencia</font></i> : omite todo </li><li>  Al final de la <i><font color="#008080">lista de prefijos est√°</font></i> <i><font color="#008080">impl√≠citamente negar</font></i> , pero solo si no est√° vac√≠a </li><li>  Una <i><font color="#008080">lista de prefijos</font></i> vac√≠a es un <i><font color="#008080">permiso impl√≠cito</font></i> </li></ul><br>  Todo lo anterior es cierto para <b>Cisco IOS</b> .  Puede aparecer <i><font color="#008080">una lista de prefijos</font></i> vac√≠a cuando declara un <i><font color="#008080">mapa de ruta</font></i> , haga que <i><font color="#008080">"coincida con la lista de prefijos de direcciones IP pl-test-cisco"</font></i> .  Esta <i><font color="#008080">lista de prefijos</font></i> no se declarar√° expl√≠citamente en la configuraci√≥n (adem√°s de la l√≠nea con <i><font color="#008080">coincidencia</font></i> ), pero se puede encontrar en <i><font color="#008080">show ip prefix-list</font></i> . <br><br><pre><code class="plaintext hljs">2901-NOC-4.2(config)#route-map rm-test-in 2901-NOC-4.2(config-route-map)#match ip address prefix-list pl-test-in 2901-NOC-4.2(config-route-map)#do sh run | i prefix match ip address prefix-list pl-test-in 2901-NOC-4.2(config-route-map)#do sh ip prefix ip prefix-list pl-test-in: 0 entries 2901-NOC-4.2(config-route-map)#</code> </pre> <br>  Volviendo a lo que sucedi√≥, cuando el script elimin√≥ la <i><font color="#008080">lista de prefijos</font></i> , qued√≥ vac√≠a, porque todav√≠a estaba en la primera regla <i><font color="#008080">DENY</font></i> en el <i><font color="#008080">mapa de ruta</font></i> .  Una <i><font color="#008080">lista de prefijos</font></i> vac√≠a permite todas las subredes, por lo que todo lo que nos pas√≥ un par <i><font color="#008080">BGP</font></i> cay√≥ en la primera regla <i><font color="#008080">DENY</font></i> . <br>  ¬øPor qu√© el ingeniero no se dio cuenta de inmediato de que hab√≠a roto la conexi√≥n?  Aqu√≠ jug√≥ el papel de temporizadores <i><font color="#008080">BGP</font></i> en Cisco. <br>  <i><font color="#008080">BGP en</font></i> s√≠ no intercambia rutas en un horario, y si actualiz√≥ la pol√≠tica de enrutamiento de <i><font color="#008080">BGP</font></i> , debe restablecer la sesi√≥n de BGP para aplicar los cambios, <i><font color="#008080">"clear ip bgp &lt;peer-ip&gt;"</font></i> a Cisco. <br><br>  Para no restablecer la sesi√≥n, hay dos mecanismos: <br><br><ul><li>  Cisco <b>Soft-Reconfiguration</b> </li><li>  <b>Actualizaci√≥n de ruta</b> como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RFC2918</a> </li></ul><br>  <b>La reconfiguraci√≥n suave</b> contiene la informaci√≥n recibida en <i><font color="#008080">ACTUALIZACI√ìN</font></i> del vecino sobre las rutas hasta que las pol√≠ticas se apliquen en la tabla <i><font color="#008080">adj-RIB-in</font></i> local.  Al actualizar las pol√≠ticas, es posible emular la <i><font color="#008080">ACTUALIZACI√ìN</font></i> de un vecino. <br>  <b>La actualizaci√≥n de ruta</b> es la "capacidad" de los pares para enviar <i><font color="#008080">ACTUALIZACI√ìN</font></i> a pedido.  La disponibilidad de esta oportunidad se acuerda al establecer un vecindario.  Pros: no es necesario almacenar una copia de <i><font color="#008080">ACTUALIZACI√ìN</font></i> localmente.  Contras: en la pr√°ctica, despu√©s de una solicitud de <i><font color="#008080">ACTUALIZACI√ìN</font></i> de un vecino, debe esperar hasta que √©l la env√≠e.  Por cierto, puede deshabilitar la funci√≥n en Cisco con un comando oculto: <br><br><pre> <code class="plaintext hljs">neighbor &lt;peer-ip&gt; dont-capability-negotiate</code> </pre><br>  Hay una caracter√≠stica no documentada de Cisco: un temporizador de 30 segundos, que se activa por un cambio en <i><font color="#008080">las</font></i> pol√≠ticas de <i><font color="#008080">BGP</font></i> .  Despu√©s de cambiar las pol√≠ticas, en 30 segundos comenzar√° el proceso de actualizaci√≥n de rutas utilizando una de las tecnolog√≠as anteriores.  No pude encontrar una descripci√≥n documentada de este temporizador, pero hay una menci√≥n de √©l en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BUG CSCvi91270</a> .  Puede conocer su disponibilidad en la pr√°ctica, <img src="https://habrastorage.org/webt/mk/tm/7s/mktm7sjydraauxoeajhyzkm9lyc.png" align="right" width="400">  despu√©s de realizar cambios en el laboratorio y buscar en <i><font color="#008080">depuraci√≥n las</font></i> solicitudes de <i><font color="#008080">ACTUALIZACI√ìN</font></i> para el vecino o el <i><font color="#008080">proceso de reconfiguraci√≥n de software</font></i> .  (Si hay informaci√≥n adicional sobre el tema, puede dejarla en los comentarios) <br><br>  Para <b>la reconfiguraci√≥n suave</b> , el temporizador funciona as√≠: <br><br><pre> <code class="plaintext hljs">2901-NOC-4.2(config)#no ip prefix-list pl-test seq 10 permit 10.5.5.0/26 2901-NOC-4.2(config)#do sh clock 16:53:31.117 Tue Sep 24 2019 Sep 24 16:53:59.396: BGP(0): start inbound soft reconfiguration for Sep 24 16:53:59.396: BGP(0): process 10.5.5.0/26, next hop 10.0.0.1, metric 0 from 10.0.0.1 Sep 24 16:53:59.396: BGP(0): Prefix 10.5.5.0/26 rejected by inbound route-map. Sep 24 16:53:59.396: BGP(0): update denied, previous used path deleted Sep 24 16:53:59.396: BGP(0): no valid path for 10.5.5.0/26 Sep 24 16:53:59.396: BGP(0): complete inbound soft reconfiguration, ran for 0ms Sep 24 16:53:59.396: BGP: topo global:IPv4 Unicast:base Remove_fwdroute for 10.5.5.0/26 2901-NOC-4.2(config)#</code> </pre><br>  Para <b>la actualizaci√≥n</b> de <b>ruta</b> desde el lado del vecino as√≠: <br><br><pre> <code class="plaintext hljs">2801-RTR (config-router)# *Sep 24 20:57:29.847 MSK: BGP: 10.0.0.2 rcv REFRESH_REQ for afi/sfai: 1/1 *Sep 24 20:57:29.847 MSK: BGP: 10.0.0.2 start outbound soft reconfig for afi/safi: 1/1</code> </pre><br>  Si <i><font color="#008080">Route-Refresh</font></i> no <i><font color="#008080">es</font></i> compatible con uno de los pares y la <i><font color="#008080">entrada de reconfiguraci√≥n suave</font></i> no <i><font color="#008080">est√°</font></i> habilitada, entonces la actualizaci√≥n de rutas por la nueva pol√≠tica no se realizar√° autom√°ticamente. <br><br>  Entonces, <i><font color="#008080">la lista de prefijos</font></i> se elimin√≥, la conexi√≥n permaneci√≥, despu√©s de 30 segundos desapareci√≥.  El script logr√≥ cambiar la configuraci√≥n, verificar la conexi√≥n y guardar la configuraci√≥n.  La ca√≠da del gui√≥n no se conect√≥ de inmediato, en el contexto de una gran cantidad de objetos. <br><br>  Todo esto podr√≠a evitarse f√°cilmente mediante la prueba, la replicaci√≥n parcial de la configuraci√≥n. Se entendi√≥ que la automatizaci√≥n deber√≠a centralizarse y controlarse. <br><br><img src="https://habrastorage.org/webt/du/ew/zc/duewzcojsasaegoufuir8jymcz0.jpeg"><br></div></div><br><h2>  Los sistemas que necesitamos y sus conexiones. </h2><br>  Una breve conclusi√≥n del spoiler: es mejor sistematizar y controlar el proceso de entrega masiva de configuraciones para no llegar a la entrega masiva de errores en las configuraciones. <br><br><pre> <code class="plaintext hljs">- DevOps:    50ms     4    -     : ", !@#$%"</code> </pre><br>  El esquema al que llegamos consiste en bloques de datos maestros "comerciales", bloques de datos maestros "red", sistemas de monitoreo de infraestructura de red, sistemas de entrega de configuraci√≥n, sistemas de control de versiones con una unidad de prueba. <br><br><img src="https://habrastorage.org/webt/ft/sc/wl/ftscwlfa_zs4afvfwkeybwo7et0.jpeg"><br><br><h3>  Todo lo que necesitamos son datos </h3><br>  Primero necesitamos saber qu√© objetos hay en la empresa. <br><br>  <b>SAP</b> - Sistema de empresa <abbr title="Planificaci√≥n de recursos empresariales">ERP</abbr> .  Los datos sobre casi todas las instalaciones est√°n all√≠, y m√°s precisamente en todas las tiendas y centros de distribuci√≥n.  Adem√°s, hay datos sobre equipos que pasaron por un almac√©n de TI con n√∫meros de inventario, que tambi√©n nos ser√°n √∫tiles en el futuro.  Solo faltan oficinas, no se inician en el sistema.  Estamos tratando de resolver este problema como un proceso separado, comenzando desde el momento de la apertura, necesitamos una conexi√≥n en cada objeto y seleccionamos las configuraciones para la comunicaci√≥n, por lo que en alg√∫n momento en este momento necesitamos crear datos maestros.  Pero la insuficiencia de datos es un tema separado, es mejor poner esta descripci√≥n en un art√≠culo separado si hay inter√©s en esto. <br><br>  <b><abbr title="Gerente de servicio de HP">HPSM</abbr></b> : un sistema que contiene un <abbr title="Base de datos de gesti√≥n de configuraci√≥n">CMDB</abbr> com√∫n para TI, gesti√≥n de incidentes, gesti√≥n de cambios.  Dado que el sistema es com√∫n a todas las TI, debe tener todos los equipos de TI, incluidos los equipos de red.  Este es el lugar donde agregaremos todos los datos finales a trav√©s de la red.  Con la gesti√≥n de incidentes y cambios, planeamos interactuar desde los sistemas de monitoreo en el futuro. <br><br>  Sabemos qu√© objetos tenemos, los enriquecemos con datos a trav√©s de la red.  Para este prop√≥sito, tenemos dos sistemas: <abbr title="Administraci√≥n de direcciones IP">IPAM</abbr> de <i>SolarWinds</i> y nuestro propio sistema CMDB.noc. <br><br>  <b>IPAM</b> es un repositorio de subredes IP, los datos m√°s correctos y correctos sobre la propiedad de las direcciones IP en la empresa deben estar aqu√≠. <br><br>  <b>CMDB.noc</b> es una base de datos con una interfaz WEB donde se almacenan datos est√°ticos en equipos de red: enrutadores, conmutadores, puntos de acceso, as√≠ como proveedores y sus caracter√≠sticas.  Bajo est√°tico significa que su cambio se lleva a cabo solo con la participaci√≥n del hombre.  En otras palabras, la detecci√≥n autom√°tica no realiza cambios en esta base de datos; necesitamos que comprenda qu√© "deber√≠a" instalarse en el objeto.  Su base es necesaria como un amortiguador entre los sistemas productivos con los que trabaja toda la empresa y las herramientas de red internas.  Acelera el desarrollo, agregando los campos necesarios, nuevas relaciones, ajustando par√°metros, etc.  Adem√°s, esta soluci√≥n no solo est√° en la velocidad de desarrollo, sino tambi√©n en la presencia de esas relaciones entre los datos que necesitamos, sin compromiso.  Como mini-ejemplo, utilizamos varios <abbr title="Identificaci√≥n externa">exid</abbr> en la base de datos para la comunicaci√≥n entre IPAM, SAP y HPSM. <br><br>  Como resultado, recibimos datos completos de todos los objetos, con equipos de red y direcciones IP conectados.  Ahora necesitamos plantillas de configuraci√≥n o servicios de red que proporcionamos en estos sitios. <br><br><img src="https://habrastorage.org/webt/uy/qp/7f/uyqp7fxlkyf4rluokbotmtg5wvy.jpeg"><br><br><h3>  Fuente √∫nica de verdad </h3><br>  Aqu√≠, acabamos de llegar a la aplicaci√≥n del primer principio NaaC: almacenar configuraciones de destino en el repositorio.  En nuestro caso, este es Gitlab.  La elecci√≥n para nosotros fue simple: <br><br><ul><li>  En primer lugar, ya tenemos esta herramienta en nuestra empresa, no tuvimos que implementarla desde cero </li><li>  En segundo lugar, es bastante adecuado para todas nuestras tareas actuales y futuras en infraestructura de red </li></ul><br>  La principal parte interesante de la automatizaci√≥n suceder√° en Gitlab: el proceso de cambiar el est√°ndar de configuraci√≥n o, m√°s simplemente, la plantilla. <br><br><h5>  Ejemplo de proceso de cambio est√°ndar </h5>  Uno de los tipos de objetos que tenemos es la tienda Pyaterochka.  All√≠, una topolog√≠a t√≠pica consiste en un enrutador y uno / dos conmutadores.  El archivo de configuraci√≥n de la plantilla se almacena en Gitlab, en esta parte todo es simple.  Pero esto no es del todo NaaC. <br><br>  Ahora digamos que nos llega un nuevo proyecto.  Las tareas para el nuevo proyecto de TI son hacer un piloto en un cierto volumen de tiendas.  De acuerdo con los resultados del piloto: si tiene √©xito, realice una replicaci√≥n para todos los objetos de este tipo;  de lo contrario, colapsar el piloto sin realizar una replicaci√≥n. <br><br>  Este proceso encaja muy bien en la l√≥gica de Git: <br><br><ol><li>  Para un nuevo proyecto, creamos una Rama, donde hacemos cambios a las configuraciones. </li><li>  En Branch tambi√©n mantenemos una lista de objetos en los que se est√° probando este proyecto. </li><li>  Si tiene √©xito, hacemos una solicitud de fusi√≥n en la rama maestra, que deber√° replicarse en la red prod </li><li>  En caso de falla, deje Branch para el historial o simplemente elimine </li></ol><br><img src="https://habrastorage.org/webt/lx/o1/hu/lxo1hulupq0mzqe37qcodnutxno.png" align="right" width="240"><br>  En una primera aproximaci√≥n, incluso sin automatizaci√≥n, es una herramienta muy conveniente para trabajar juntos en una configuraci√≥n de red.  Especialmente si imagina que se presentaron tres o m√°s proyectos al mismo tiempo.  Cuando llegue el momento del lanzamiento de proyectos en prod, deber√° resolver todos los conflictos de configuraci√≥n en las solicitudes de fusi√≥n y verificar que los cambios en la configuraci√≥n no sean mutuamente excluyentes.  Y esto es muy conveniente de hacer en git. <br><br>  Adem√°s, este enfoque nos agrega la flexibilidad para usar las herramientas Gitlab CI / CD para probar configuraciones virtualmente, para automatizar la entrega de configuraciones a un banco de pruebas o un grupo piloto de objetos.  // E incluso en prod si quieres. <br><br><h3>  Implementaci√≥n de la configuraci√≥n en cualquier entorno. </h3><br>  Inicialmente, el objetivo principal era precisamente la entrega masiva de configuraciones, como una herramienta que claramente le permite ahorrar tiempo a los ingenieros y acelerar la ejecuci√≥n de las tareas de configuraci√≥n.  Para hacer esto, incluso antes del comienzo de la gran actividad "Red como un c√≥digo", escribimos una soluci√≥n de <i>Python</i> para conectarse al equipo, ya sea para recopilar configuraciones de equipos o para configurarlo.  Esto es <i>netmiko</i> , esto es <i>pysnmp</i> , esto es <i>jinja2</i> , etc. <br><br>  Pero es hora de que dividamos la configuraci√≥n masiva en varias subespecies: <br><br><ol><li><div class="spoiler">  <b class="spoiler_title">Entrega de configuraciones a zonas de prueba y piloto.</b> <div class="spoiler_text">  Este elemento se basa en Gitlab CI, que le permite habilitar la entrega de configuraci√≥n a las zonas piloto y de prueba en la tuber√≠a. <br></div></div></li><li><div class="spoiler">  <b class="spoiler_title">Duplicaci√≥n de configuraciones en prod</b> <div class="spoiler_text"><ul><li>  Un elemento separado, la mayor√≠a de las veces, la replicaci√≥n a dispositivos de 38k se lleva a cabo en varias ondas, aumentando el volumen, para monitorear la situaci√≥n en producci√≥n.  Adem√°s, el trabajo de esta magnitud requiere la coordinaci√≥n del trabajo, por lo tanto, es mejor comenzar este proceso a mano.  Para esto, es conveniente usar Ansible + -AWX y ajustar la compilaci√≥n din√°mica del inventario de nuestros sistemas de datos maestros. </li><li>  Adem√°s, esta es una soluci√≥n conveniente cuando necesita darle a la segunda l√≠nea el lanzamiento de libros de jugadas preconfigurados que realizan operaciones complejas e importantes, como cambiar el tr√°fico entre sitios. </li></ul></div></div></li><li><div class="spoiler">  <b class="spoiler_title">Recogida de datos</b> <div class="spoiler_text"><ul><li>  Detecci√≥n autom√°tica de dispositivos de red </li><li>  Configuraciones de respaldo </li><li>  Verificar conectividad </li></ul><br>  Asignamos esta tarea en un bloque separado, ya que hay momentos en que alguien desmantel√≥ repentinamente un interruptor o instal√≥ un nuevo dispositivo, pero no lo sab√≠amos de antemano.  En consecuencia, este dispositivo no estar√° en nuestros datos maestros y quedar√° fuera del proceso de entrega de configuraci√≥n, monitoreo y, en general, trabajo operativo.  Sucede que el equipo se instal√≥ leg√≠timamente, pero la configuraci√≥n se "verti√≥" incorrectamente all√≠ y, por alguna raz√≥n, las contrase√±as <i>ssh</i> , <i>snmp</i> , <i>aaa</i> o no est√°ndar para el acceso no funcionan all√≠.  Para hacer esto, tenemos Python para probar todos los m√©todos de conexi√≥n <i>heredados</i> posibles que podr√≠amos tener en la empresa, hacer fuerza bruta para todas las contrase√±as antiguas, y todo para llegar al trozo de hierro y prepararlo para trabajar con <i>Ansible</i> y monitorear . <br><br>  Hay una manera simple: hacer varios archivos de <i>inventario</i> para ansible, donde describir todos los datos posibles para las conexiones (todos los tipos de proveedores con todos los pares posibles de nombre de usuario / contrase√±a) y ejecutar un <i>libro</i> de <i>jugadas</i> para cada variante de <i>inventario</i> .  Esper√°bamos una mejor soluci√≥n, pero en la conferencia de RedHat, el arquitecto de Ansible aconsej√≥ lo mismo.  En general, se supone que sabe de antemano a qu√© se est√° conectando. <br>  Quer√≠amos una soluci√≥n universal: cuando elimine una copia de seguridad, busque nuevos equipos y, si los encuentra, agr√©guelos a todos los sistemas necesarios.  Por lo tanto, elegimos una soluci√≥n en python: sepa qu√© podr√≠a ser m√°s hermoso que un programa que puede detectar una pieza de hardware de red para conectarse, independientemente de lo que est√© configurado en √©l (dentro de l√≠mites razonables, por supuesto), configurar seg√∫n sea necesario, eliminar la configuraci√≥n y, al mismo tiempo, Agregue datos de API a los sistemas requeridos. <br></div></div></li></ol><br><h3>  Verificaci√≥n como Monitoreo </h3><br>  Una de las tareas de la automatizaci√≥n es, por supuesto, averiguar qu√© se cay√≥ de esta automatizaci√≥n.  No todos los 38k est√°n configurados perfectamente la primera vez, incluso sucede que alguien configura el equipo con sus manos.  Y es necesario rastrear estos cambios y restaurar la <s>justicia en la</s> configuraci√≥n de destino. <br><br>  Existen tres enfoques para verificar el cumplimiento de la configuraci√≥n con el est√°ndar: <br><br><ul><li>  Haga una verificaci√≥n una vez por per√≠odo: descargue el estado actual, verifique el objetivo y corrija las deficiencias identificadas. </li><li>  Sin verificar nada, una vez al per√≠odo: despliegue las configuraciones de destino.  Es cierto que existe el riesgo de romper algo, tal vez no haya todo en la configuraci√≥n de destino. </li><li>  Un enfoque conveniente es cuando las diferencias de la configuraci√≥n de destino en <i>Single Source of Truth</i> se consideran alertas y son monitoreadas por el sistema de monitoreo.  Esto incluye: un desajuste con el est√°ndar de configuraci√≥n actual, una diferencia entre el hardware y el especificado en los datos maestros, un desajuste con los datos en <i>IPAM</i> . </li></ul><br>  En el tercer caso, una opci√≥n parece transferir este trabajo a la gesti√≥n de incidentes (SO), de modo que las inconsistencias se eliminan en peque√±as porciones durante todo el tiempo que una vez por emergencia. <br><br>  <b>Zabbix</b> , sobre el que escrib√≠ anteriormente en el art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"C√≥mo monitoreamos 14,000 objetos",</a> es nuestro sistema de monitoreo de objetos distribuidos donde podemos hacer cualquier disparador y alerta que podamos pensar.  Desde que escribimos el √∫ltimo art√≠culo, hemos actualizado a Zabbix 4.0 <abbr title="Soporte a largo plazo">LTS</abbr> . <br><br>  Basado en <i>Web Zabbix,</i> realizamos una actualizaci√≥n de nuestro portal de soporte de red, donde ahora puede encontrar toda la informaci√≥n sobre un objeto de todos nuestros sistemas en una pantalla, as√≠ como ejecutar scripts para verificar si ocurren problemas frecuentes. <br><br><img src="https://habrastorage.org/webt/o_/65/ha/o_65haiskiyx5jvmofs1wwmy9a8.png"><br><br>  Tambi√©n presentamos una nueva caracter√≠stica: para nosotros, Zabbix se convirti√≥ de alguna manera en un <i>CRON</i> para el lanzamiento de scripts programados, como scripts de integraci√≥n de sistemas, scripts de detecci√≥n autom√°tica.  Esto es realmente conveniente cuando necesita ver los scripts actuales y cu√°ndo y d√≥nde se ejecutan sin verificar todos los servidores.  Es cierto que para los scripts que se ejecutan durante m√°s de 30 segundos, necesitar√° un <i>lanzador</i> que los inicie sin esperar el final.  Afortunadamente, es simple: <br><br><div class="spoiler">  <b class="spoiler_title">launcher.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash nohup $* &gt; /dev/null 2&gt;/dev/null &amp; echo $(date) Started job for $*</span></span></code> </pre><br></div></div><br><img src="https://habrastorage.org/webt/gu/vp/ww/guvpwwbg0scnt8ngqkhuy7keey8.png"><br><br>  <b>Splunk</b> es una soluci√≥n que le permite recopilar registros de eventos de equipos de red, y esto tambi√©n se puede utilizar para monitorear la automatizaci√≥n.  Por ejemplo, al recopilar una copia de seguridad de la configuraci√≥n, un script de <i>Python</i> genera un mensaje de <i>REGISTRO</i> <i>CFG-5-BACKUP</i> , un enrutador o conmutador env√≠a un mensaje a Splunk, en el que contamos el n√∫mero de mensajes de este tipo del equipo de red.  Esto nos permite rastrear la cantidad de equipo que el script ha detectado.  Y vemos cu√°ntas piezas de hierro pudieron informar esto a <i>Splunk</i> y verificar que llegaron mensajes de todas las piezas de hierro. <br>  <b>Spectrum</b> es un sistema integral que utilizamos para monitorear objetos cr√≠ticos, una herramienta bastante poderosa que nos ayuda mucho a resolver incidentes cr√≠ticos de la red.  En automatizaci√≥n, lo usamos solo extrayendo datos de √©l, no es <i>de c√≥digo abierto</i> , por lo que las posibilidades son algo limitadas. <br><br><h3>  La guinda del pastel </h3><br><img src="https://habrastorage.org/webt/-a/g_/qk/-ag_qktnw97gq5edbpbswa1h_xa.png" align="right" width="240">  Al usar sistemas con datos maestros en el equipo, podemos pensar en crear ZTP o Zero Touch Provisioning.  Como un bot√≥n de "autoajuste", pero solo sin un bot√≥n. <br><br>  Tenemos todos los datos necesarios de los bloques anteriores: conocemos el objeto, su tipo, qu√© equipo hay (proveedor y modelo), cu√°les son las direcciones (IPAM), cu√°l es el est√°ndar de configuraci√≥n actual (Git).  Al unirlos todos, al menos podemos preparar una plantilla de configuraci√≥n para cargarla en el dispositivo, ser√° m√°s como One Touch Provisioning, pero a veces no se requiere m√°s. <br><br>  True Zero Touch necesita una forma de entregar autom√°ticamente la configuraci√≥n al hardware no configurado.  Adem√°s, es deseable independientemente del proveedor.  Hay varias opciones de trabajo: un servidor de consola, si todo el equipo pasa por el almac√©n central, soluciones de consola m√≥vil, si el equipo llega de inmediato.  Solo estamos trabajando en estas soluciones, pero tan pronto como haya una opci√≥n de trabajo, podemos compartirla. <br><br><h3>  Conclusi√≥n </h3><br>  En total, en nuestro concepto de <b>Red como C√≥digo</b> , hubo 5 hitos principales: <br><br><ul><li>  Datos maestros (comunicaci√≥n de sistemas y datos entre s√≠, API de sistemas, suficiencia de datos para soporte y lanzamiento) </li><li>  Monitoreo de datos y configuraciones (detecci√≥n autom√°tica de dispositivos de red, verificaci√≥n de la relevancia de la configuraci√≥n en la instalaci√≥n) </li><li>  Control de versiones, pruebas y configuraciones piloto (Gitlab CI / CD aplicado a la red, herramientas de prueba de configuraci√≥n de red) </li><li>  Entrega de configuraci√≥n (Ansible, AWX, scripts de python para conectar) </li><li>  Aprovisionamiento Zero Touch (qu√© datos se necesitan, c√≥mo construir un proceso para que sea as√≠, c√≥mo conectarse a una pieza de hardware no configurada) </li></ul><br>  No funcion√≥ para encajar todo en un art√≠culo, cada elemento merece una discusi√≥n separada, podemos hablar de algo ahora, de algo cuando verificamos las soluciones en la pr√°ctica.  Si est√° interesado en alguno de los temas, al final habr√° una encuesta en la que podr√° votar por el pr√≥ximo art√≠culo.  Si el tema no est√° incluido en la lista, pero es interesante leerlo, deje un comentario lo antes posible, aseg√∫rese de compartir nuestra experiencia. <br><br><hr><br>  Un agradecimiento especial a Virilin Alexander ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">xscrew</a> ) y Sibgatulin Marat ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">eucariot</a> ) por la visita de referencia en el oto√±o de 2018 a la nube de yandex y la historia sobre la automatizaci√≥n en la infraestructura de red de la nube.  Despu√©s de √©l, obtuvimos inspiraci√≥n y muchas ideas sobre el uso de la automatizaci√≥n y NetDevOps en la infraestructura del X5 Retail Group. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468197/">https://habr.com/ru/post/468197/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468185/index.html">Servicio AWS EC2 y trabaje con √©l</a></li>
<li><a href="../468189/index.html">Mejore las habilidades de depuraci√≥n de JavaScript utilizando trucos de consola</a></li>
<li><a href="../468191/index.html">RubyRussia 2019: Nikolay Sverchkov sobre sin servidor</a></li>
<li><a href="../468193/index.html">Partes internas de JVM, Parte 1 - Cargador de clases</a></li>
<li><a href="../468195/index.html">¬øPor qu√© mis finanzas dependen de Beeline?</a></li>
<li><a href="../468203/index.html">Acertijos en la b√∫squeda de la oportunidad perfecta</a></li>
<li><a href="../468205/index.html">GIT desde adentro: introducci√≥n (traducci√≥n)</a></li>
<li><a href="../468207/index.html">C√≥mo actualizamos Zabbix</a></li>
<li><a href="../468211/index.html">"Solo quer√≠a hacer una broma, pero nadie entendi√≥" o c√≥mo no enterrarme en la presentaci√≥n del proyecto</a></li>
<li><a href="../468213/index.html">tinc-boot - red de malla completa sin dolor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>