<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚ÄçüöÄ üë®üèº ‚õ∞Ô∏è D√©veloppement d'une carte de d√©bogage pour K1986BE1QI (air) ü§µüèæ üÉè üë¶üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelques ann√©es, j'ai rencontr√© les microcontr√¥leurs russes de Milander. C'√©tait en 2013, lorsque les ing√©nieurs ont discut√© vigoureusement des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©veloppement d'une carte de d√©bogage pour K1986BE1QI (air)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482716/"><img src="https://habrastorage.org/webt/xa/8d/4m/xa8d4m3m5jgwavt_34l7oj8abfi.jpeg" alt="Debug Board MDB1986"><br><br>  Il y a quelques ann√©es, j'ai rencontr√© les microcontr√¥leurs russes de Milander.  C'√©tait en 2013, lorsque les ing√©nieurs ont discut√© vigoureusement des premiers r√©sultats du programme cible f√©d√©ral ¬´D√©veloppement de la base de composants √©lectroniques et de l'√©lectronique radio¬ª pour 2008-2015.  √Ä cette √©poque, le contr√¥leur K1986BE9x (noyau Cortex-M3) √©tait d√©j√† sorti et le contr√¥leur 1986BE1T (noyau Cortex-M1) venait d'appara√Ætre.  Il dans le bo√Ætier en plastique LQFP-144 avait la d√©signation K1986BE1QI (aviation), et sur la puce elle-m√™me la d√©signation MDR32F1QI.  Sur le site Internet du constructeur, il porte le suffixe ¬´avia¬ª, car il poss√®de des interfaces sp√©cifiques √† l'industrie a√©ronautique (ARINC 429, MIL_STD_1553). <a name="habracut"></a><br><br>  √âtonnamment, au moment de la distribution de ces contr√¥leurs, la soci√©t√© Milander a pr√©par√© des kits de d√©bogage et une biblioth√®que de sous-programmes pour travailler avec les p√©riph√©riques ", mais sans aucune garantie ni obligation suppl√©mentaire concernant l'exactitude de la biblioth√®que".  La biblioth√®que est similaire √† la biblioth√®que p√©riph√©rique standard STMicroelectronics.  En g√©n√©ral, tous les contr√¥leurs ARM construits sur le noyau Cortex-M ont beaucoup en commun.  Pour cette raison, la connaissance des nouveaux contr√¥leurs russes est all√©e rapidement.  Et pour ceux qui ont achet√© des kits de d√©bogage de marque, un support technique a √©t√© fourni pendant l'utilisation. <br><br><img src="https://habrastorage.org/webt/36/-5/cu/36-5cuhduqbdylqea5diodzri2o.png"><br>  <i>Kit de d√©bogage pour le microcontr√¥leur 1986BE1T, ¬© Milander</i> <br><br>  Cependant, au fil du temps, des ¬´maladies infantiles¬ª de nouveaux microcircuits et biblioth√®ques ont commenc√© √† appara√Ætre.  Des exemples de test de firmware ont fonctionn√© sans probl√®mes visibles, mais avec une modification importante, des plantages et des erreurs ont plu.  La premi√®re "d√©glutition" dans ma pratique a √©t√© des d√©faillances inexpliqu√©es dans le fonctionnement du contr√¥leur CAN.  Un an plus tard, sur le contr√¥leur d'audit pr√©coce 1986BE1T (air), un probl√®me a √©t√© d√©tect√© avec le module <a href="https://ru.wikipedia.org/wiki/MIL-STD-1553" rel="nofollow">MKIO (canal d'√©change d'informations multiplex√©)</a> .  En g√©n√©ral, toutes les r√©visions de ces microcontr√¥leurs jusqu'en 2016 √©taient d'une utilit√© limit√©e.  Il a fallu beaucoup de temps et de nerfs pour identifier ces probl√®mes, dont la confirmation se trouve d√©sormais dans les <a href="https://ic.milandr.ru/upload/iblock/352/352a1573c08c406a94b976ed95fe4506.pdf" rel="nofollow">listes d'erreurs (Errata)</a> . <br><br>  Une caract√©ristique d√©sagr√©able √©tait qu'il √©tait n√©cessaire de travailler et de traiter les erreurs non pas sur les cartes de d√©bogage, mais sur les cartes prototypes des appareils pr√©vus pour la production en s√©rie.  √Ä part le connecteur JTAG, il n'y avait g√©n√©ralement rien l√†-bas.  La connexion avec un analyseur logique √©tait difficile et peu pratique, et il n'y avait g√©n√©ralement ni LED ni √©cran.  Pour cette raison, j'ai pens√© √† cr√©er mon propre tableau de d√©bogage. <br><br>  D'une part, il y avait des kits de d√©bogage de marque sur le march√©, ainsi que de magnifiques cartes de LDM-Systems de Zelenograd.  D'un autre c√¥t√©, les prix de ces produits sont plong√©s dans la stupeur et les fonctionnalit√©s de base sans cartes d'extension ne r√©pondent pas aux attentes.  Une carte avec un contr√¥leur soud√© et un connecteur √† broches ne m'int√©resse pas.  Et les planches plus int√©ressantes co√ªtent cher. <br><br><img src="https://habrastorage.org/webt/6u/ob/ww/6uobww_tvc36dmyyhcmemgkedhg.jpeg"><br>  <i>Carte de d√©bogage MILANDR LDM-HELPER-K1986BE1QI-FULL, ¬© LDM Systems</i> <br><br>  La tarification et la commercialisation de la soci√©t√© "Milander" sont particuli√®res.  Ainsi, il est possible d'obtenir des √©chantillons gratuits de certains microcircuits, mais cela n'est disponible que pour les personnes morales et est associ√© √† une qu√™te bureaucratique.  En g√©n√©ral, les microcircuits dans un bo√Ætier m√©tal-c√©ramique sont de l'or au sens direct et figur√©.  Par exemple, le contr√¥leur 1986BE1T co√ªte de 14 √† 24 mille roubles √† Moscou.  La puce de m√©moire statique 1645RU6U co√ªte √† partir de 15 000 roubles.  Et un tel ordre de prix pour tous les produits.  En cons√©quence, m√™me les instituts de recherche sp√©cialis√©s avec des commandes de l'√âtat √©conomisent et √©vitent ces prix.  Les microcircuits dans un bo√Ætier en plastique √† usage civil sont nettement moins chers, mais ils ne sont pas disponibles aupr√®s de fournisseurs populaires.  De plus, la qualit√© des microcircuits dans un bo√Ætier plastique, me semble-t-il, est pire que celle des ¬´or¬ª.  Par exemple, je n'ai pas pu d√©marrer le contr√¥leur K1986BE1QI √† une fr√©quence de 128 MHz sans augmenter le param√®tre de latence du flash.  Dans le m√™me temps, la temp√©rature de ce contr√¥leur est mont√©e √† 40-50C.  Mais le contr√¥leur 1986BE1T ("gold") a √©t√© lanc√© √† 128 MHz sans r√©glages suppl√©mentaires et est rest√© froid.  Il est vraiment bon. <br><br><img src="https://habrastorage.org/webt/hm/hd/vm/hmhdvmzvhpvw7ujz09cw5ol49ou.png"><br>  <i>Microcontr√¥leur "Golden" 1986BE1T, (c) Milander</i> <br><br>  J'ai eu la chance qu'un microcontr√¥leur dans un bo√Ætier en plastique puisse encore √™tre achet√© au d√©tail chez LDM Systems, et toutes les cartes de circuits imprim√©s sont disponibles gratuitement.  La mauvaise chose est que sur le site sur la photo du contr√¥leur il y a un marquage qui indique qu'il s'agit de la 4√®me r√©vision de 2014, c'est-√†-dire  avec des d√©fauts.  J'ai longtemps pens√© - acheter ou ne pas acheter.  Alors plusieurs ann√©es se sont √©coul√©es ... <hr><br><br>  L'id√©e de cr√©er un tableau de d√©bogage n'a pas disparu.  Peu √† peu, j'ai form√© toutes les exigences et j'ai pens√© comment mettre tout cela sur une seule planche, pour qu'elle soit compacte et pas ch√®re.  En parall√®le, j'ai command√© les composants manquants aux Chinois.  Je n'√©tais pas press√© - j'ai tout fait pour moi.  Les fournisseurs chinois sont r√©put√©s pour leur n√©gligence - j'ai d√ª commander la m√™me chose √† diff√©rents endroits afin d'obtenir tout ce dont j'avais besoin.  De plus, certains des microcircuits de m√©moire se sont av√©r√©s √™tre utilis√©s - manifestement √©vapor√©s des appareils cass√©s.  Cela m'est revenu plus tard. <br><br>  Acheter un microcontr√¥leur Milander K1986BE1QI (avia) n'est pas une t√¢che facile.  Dans le m√™me magasin Chip and Dip, dans la section "Commander des articles", je n'ai trouv√© que le K1986BE92QI pour 740 roubles, mais cela ne me convenait pas.  La seule option est d'acheter chez LDM-Systems pour 2000 roubles, pas une nouvelle r√©vision.  Comme je ne pouvais pas trouver de rempla√ßant ailleurs, j'ai d√©cid√© d'acheter ce qui √©tait.  √Ä ma grande surprise, ils m'ont vendu un tout nouveau contr√¥leur de version de d√©cembre 2018, r√©vision 6+ (1820).  Et le site a toujours une vieille photo, et au moment de la r√©daction, le contr√¥leur n'est pas disponible ... <br><br><img src="https://habrastorage.org/webt/cr/p3/eu/crp3euoxhtfbkqo_pzet4vjencs.jpeg"><br>  <i>Microcontr√¥leur K1986be1qi (avia) dans un emballage technologique, (c) - Image de</i> <br><br>  Les principales <b>caract√©ristiques</b> techniques de ma <b>carte de</b> d√©bogage <b>MDB1986 sont</b> les suivantes: <br><br><ul><li>  d√©bogueur-programmateur int√©gr√© compatible avec J-Link et CMSIS-DAP; </li><li>  M√©moire statique 4Mbit (256k x 16, 10 ns); </li><li>  Puce de m√©moire flash 64Mbit, Winbond 25Q64FVSIG; </li><li>  √âmetteur-r√©cepteur d'interface RS-232 avec lignes RTS et CTS; </li><li>  interfaces et connecteurs pour Ethernet, USB, CAN; </li><li>  Contr√¥leur d'affichage √† 7 segments MAX7221 </li><li>  connecteur √† broches pour travailler avec MKIO (MIL_STD_1553) et ARINC429; </li><li>  Phototransistor Everlight PT17-21C; </li><li>  cinq LED de couleur, un bouton de r√©initialisation et deux boutons d'utilisateur; </li><li>  aliment√© par port USB 5 volts; </li><li>  Dimensions du PCB 100 x 80 mm </li></ul><br>  J'ai aim√© les cartes de la s√©rie STM-Discovery car il y a un programmeur de d√©bogueur int√©gr√© - ST-Link.  Le ST-Link de marque ne fonctionne qu'avec les contr√¥leurs STMicroelectronics, mais il y a quelques ann√©es, il est devenu possible de mettre √† jour le firmware dans ST-Link et d'obtenir un d√©bogueur SEGGER J-Link OB (embarqu√©).  L√©galement, l'utilisation d'un tel d√©bogueur est limit√©e uniquement avec les cartes STMicroelectronics, mais en fait le potentiel n'est pas limit√©.  Ainsi, ayant un OB J-Link, vous pouvez avoir un d√©bogueur int√©gr√© sur la carte de d√©bogage.  Je note que dans les produits de "LDM-Systems" on utilise le convertisseur CP2102 (Usb2Uart), qui ne peut que flasher. <br><br><img src="https://habrastorage.org/webt/fq/yd/6z/fqyd6z1yxuwig0mw46du7l0pu8y.jpeg"><br>  <i>Microcontr√¥leurs STM32F103C8T6, r√©els et non, (c) Photo de</i> <br><br>  Il √©tait donc n√©cessaire d'acheter le STM32F103C8T6 d'origine, car le micrologiciel propri√©taire ne fonctionnera pas correctement avec le clone.  J'ai dout√© de cette th√®se et j'ai d√©cid√© d'essayer le contr√¥leur CS32F103C8T6 de la soci√©t√© chinoise CKS en fonctionnement.  Je n'ai rien √† redire sur le contr√¥leur lui-m√™me, mais le firmware ST-Link ne fonctionnait pas.  J-Link a fonctionn√© partiellement - le p√©riph√©rique USB a √©t√© d√©tect√©, mais le programmeur n'a pas rempli ses fonctions et a constamment rappel√© qu'il √©tait "d√©fectueux". <br><br><img src="https://habrastorage.org/webt/sh/dp/zs/shdpzs1rrvs4ndpodfxgykmxoqk.png"><br>  <i>Erreur lors de l'utilisation du d√©bogueur sur un contr√¥leur non d'origine</i> <br><br>  Je ne me suis pas calm√© et j'ai d'abord √©crit le firmware pour que la LED clignote, puis j'ai r√©alis√© la requ√™te IDCODE en utilisant le protocole JTAG.  Le programmeur ST-Link que j'avais sur la carte Discovery et le programme utilitaire ST-Link clignotaient sans probl√®me CS32F103C8T6. Par cons√©quent, je me suis assur√© que ma carte fonctionnait.  √Ä ma grande joie, le contr√¥leur cible K1986BE1QI (avia) a joyeusement √©mis son IDCODE via la ligne TDO. <br><br><img src="https://habrastorage.org/webt/mg/cd/6b/mgcd6bodfiolhoncf0dqpy_ztyi.png"><br>  <i>Oscillogramme de ligne de signal tdo avec r√©ponse cod√©e idcode, (c) - Image de</i> <br><br><img src="https://habrastorage.org/webt/ls/9b/hk/ls9bhkuow-fz1gir-e48kwyld2i.png"><br>  <i>Le port SWD s'est donc av√©r√© utile pour d√©boguer le d√©bogueur lui-m√™me et v√©rifier l'IDCODE</i> <br><br>  Il y avait une variante avec le d√©bogueur <a href="https://arm-software.github.io/CMSIS_5/DAP/html/index.html" rel="nofollow">CMSIS-DAP (Debug Access Port)</a> .  Construire un projet √† partir du code source d'ARM n'est pas une t√¢che facile, j'ai pris le projet √† partir de <a href="https://habr.com/ru/users/x893/" class="user_link">X893</a> , puis j'ai essay√© DAP42.  Malheureusement, Keil uVision a raccroch√© et n'a pas voulu travailler avec eux.  En cons√©quence, j'ai remplac√© la puce du d√©bogueur par la STM32F103C8T6 propri√©taire et je ne suis plus revenu √† ce probl√®me. <br><br><img src="https://habrastorage.org/webt/qd/ry/fs/qdryfsbagp3hggtvmrl0tiym-dg.png"><br>  <i>D√©bogueur J-Link STLink V2 r√©ussi</i> <br><br>  Lorsque tous les composants cl√©s de la future carte de d√©bogage √©taient en stock, je suis mont√© dans Eagle CAD et j'ai d√©couvert qu'ils n'√©taient pas dans la biblioth√®que d'√©l√©ments.  Nulle part o√π aller - ils devaient se dessiner.  Dans le m√™me temps, j'ai fait des empreintes pour la m√©moire, le connecteur HanRun pour Ethernet et ajout√© des trames pour les r√©sistances et les condensateurs.  Le fichier de projet et la biblioth√®que de composants se trouvent <a href="https://github.com/makbit/MDB1986" rel="nofollow">sur mon GitHub</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Sch√©ma de principe de la carte de d√©bogage MDB1986</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hx/44/jy/hx44jyp0pkskpjgb1zh-1tf6hfu.png"></div></div><br><br>  La carte est aliment√©e par une source CC de 5 volts, obtenue √† partir du port USB.  Il y a deux ports USB Type-B sur la carte.  L'un est pour le programmeur, le second est pour le contr√¥leur K1986BE1QI.  La carte peut fonctionner √† partir de n'importe laquelle de ces sources ou avec les deux en m√™me temps.  Le contr√¥le de charge et la protection des lignes √©lectriques les plus simples sont mis en ≈ìuvre sur les diodes Schottky, sur les circuits D2 et D3 (SS24).  Sur le sch√©ma, vous pouvez √©galement voir les fusibles auto-r√©parateurs F1 et F2 √† 500mA.  Les lignes de signal du port USB sont prot√©g√©es par un ensemble de diodes USBLC6-2SC6. <br><br>  Le circuit du d√©bogueur-programmeur ST-Link est connu de beaucoup, il peut √™tre trouv√© dans la documentation des cartes STM32-Discovery et d'autres sources.  Pour le firmware initial du clone ST-Link / J-Link-OB / DAP (en option), j'ai sorti les lignes SWDIO (PA13), SWCLK (PA14), GND.  Beaucoup de gens utilisent UART pour le firmware et sont oblig√©s de tirer les cavaliers BOOT.  Mais SWD est plus pratique pour moi, d'ailleurs, ce protocole permet le d√©bogage. <br><br>  Presque tous les composants de la carte sont aliment√©s par 3,3 volts, qui proviennent du r√©gulateur de tension AMS1117-3.3.  Pour supprimer les interf√©rences √©lectromagn√©tiques et les courants d'appel, des filtres LC des condensateurs et selfs de la s√©rie BLM31PG sont utilis√©s. <br><br>  Il convient √©galement de mentionner le pilote de l'√©cran 7 segments MAX7221.  Selon les sp√©cifications, l'alimentation recommand√©e est de 4 √† 5,5 volts et le niveau de signal √©lev√© (unit√© logique) est d'au moins 3,5 V (0,7 x VCC), avec une alimentation de 5 V.  Pour le contr√¥leur K1986BE1QI (avia), la sortie d'une unit√© logique correspond √† une tension de 2,8 √† 3,3V.  De toute √©vidence, il existe une inad√©quation des niveaux de signal qui peut interf√©rer avec le fonctionnement normal.  J'ai d√©cid√© d'alimenter le MAX7221 √† partir de 4V et d'abaisser les niveaux de signal √† 2,8V (0,7 x 4 = 2,8).  Pour ce faire, la diode D4 (RS1A ou FR103) est install√©e en s√©rie avec le circuit d'alimentation du driver.  La chute de tension totale est de 0,9 V (diode Schottky 0,3 V et diode 0,6 V), et tout fonctionne. <br><br>  La plupart des ports du microcontr√¥leur K1986BE1QI (avia) sont compatibles avec des signaux jusqu'√† 5V.  Par cons√©quent, l'utilisation de l'√©metteur-r√©cepteur CAN MCP2551, qui fonctionne √©galement sur 5 V, ne pose aucun probl√®me.  La puce MAX3232 est indiqu√©e sur le sch√©ma comme un √©metteur-r√©cepteur RS-232, mais en fait j'ai utilis√© SN65C3232D de Texas Instruments, car  Il fonctionne √† partir de 3,3 V et fournit des vitesses allant jusqu'√† 1 Mbit / s. <br><br>  Il y a 4 r√©sonateurs √† quartz sur la carte - un pour le d√©bogueur (8 MHz) et trois pour le microcontr√¥leur cible K1986BE1QI (avia) avec des valeurs de 32,768 kHz, 16 MHz, 25 MHz.  Ce sont des composants n√©cessaires, comme  Les param√®tres du g√©n√©rateur RC int√©gr√© sont dans une large plage de 6 √† 10 MHz.  Une fr√©quence de 25 MHz est n√©cessaire pour le fonctionnement du contr√¥leur Ethernet int√©gr√©.  Sur le site de Milander (peut-√™tre par erreur) pour une raison quelconque, il est indiqu√© qu'il n'y a pas d'Ethernet dans le bo√Ætier en plastique.  Mais nous nous appuierons sur les sp√©cifications et les faits. <br><br>  Une incitation importante pour cr√©er votre propre carte de d√©bogage √©tait la possibilit√© de travailler avec le bus syst√®me externe EBC (contr√¥leur de bus externe), qui est essentiellement un port parall√®le.  Le microcontr√¥leur K1986BE1QI (avia) vous permet de vous connecter et de travailler avec des puces de m√©moire externes et des p√©riph√©riques, par exemple, ADC, FPGA, etc.  Les capacit√©s du bus syst√®me externe sont assez grandes - vous pouvez travailler avec de la RAM statique 8 bits, 16 bits et 32 ‚Äã‚Äãbits, une ROM et une m√©moire flash NAND.  Pour lire / √©crire des donn√©es 32 bits, le contr√¥leur peut effectuer automatiquement 2 op√©rations correspondantes pour les circuits 16 bits et pour les op√©rations 8 bits - 4.  De toute √©vidence, une op√©ration d'E / S 32 bits sera la plus rapide avec le bus de donn√©es 32 bits.  Les inconv√©nients incluent la n√©cessit√© pour le programme de fonctionner avec des donn√©es 32 bits, et 32 ‚Äã‚Äãpistes doivent √™tre pos√©es sur la carte. <br><br><img src="https://habrastorage.org/webt/oh/sf/n8/ohsfn8vpr98krnms8rohx6l-bjs.jpeg"><br>  <i>Puces RAM statiques utilis√©es (devinez laquelle est d√©fectueuse)</i> <br><br>  Une solution √©quilibr√©e consiste √† utiliser des puces de m√©moire 16 bits.  J'ai Integrated Silicon Solutions Inc.  (ISSI IS61LV25616AL, 16 x 256k, 10 ns, 3,3 V).  Bien s√ªr, la soci√©t√© Milander poss√®de sa propre <a href="https://ic.milandr.ru/products/mikroskhemy_pamyati/" rel="nofollow">s√©rie de puces de</a> m√©moire statique <a href="https://ic.milandr.ru/products/mikroskhemy_pamyati/" rel="nofollow">1645RU</a> , mais elles sont trop ch√®res et inaccessibles.  Alternativement, il existe des broches compatibles Samsung K6R4016V1D.  Plus t√¥t, j'ai mentionn√© que les microcircuits se sont av√©r√©s √™tre utilis√©s et que l'instance que j'ai install√©e initialement a donn√© des √©checs et des valeurs chaotiques dans la 15e ligne de donn√©es.  Il a fallu plusieurs jours pour rechercher des erreurs mat√©rielles, et le plus grand √©tait le sentiment de satisfaction lorsque j'ai remplac√© la puce endommag√©e par une puce fonctionnelle.  Quoi qu'il en soit, la vitesse de travail avec la m√©moire externe laisse beaucoup √† d√©sirer. <br><br><div class="spoiler">  <b class="spoiler_title">Bus externe et mode autonome</b> <div class="spoiler_text">  Le microcontr√¥leur K1986BE1QI (aviation) dispose d'un mode StandAlone unique, con√ßu pour un acc√®s externe direct aux contr√¥leurs Ethernet et MKIO (MIL_STD_1553) via un bus externe, et le c≈ìur est dans un √©tat de r√©initialisation, c'est-√†-dire  non utilis√©.  Ce mode est pratique pour les processeurs et FPGA dans lesquels il n'y a pas d'Ethernet et / ou MKIO. </div></div><br>  Le sch√©ma de connexion est le suivant: <br><br><ul><li>  Bus de donn√©es MCU (D0-D15) =&gt; SRAM (I / O0-I / O15), </li><li>  bus d'adresse MCU (A1-A18) =&gt; SRAM (A0-A17), </li><li>  Contr√¥le MCU (nWR, nRD, PortC2) =&gt; SRAM (WE, OE, CE), </li><li>  SRAM (UB, LB) connect√© ou tir√© √† la masse via une r√©sistance. </li></ul><br>  La ligne CE est aliment√©e via une r√©sistance; les broches pour la s√©lection d'octets MCU (BE0-BE3) ne sont pas utilis√©es.  Sous le spoiler, je cite le code d'initialisation du port et le contr√¥leur de bus externe. <br><br><div class="spoiler">  <b class="spoiler_title">Initialisation des ports et contr√¥leur EBC (contr√¥leur de bus externe)</b> <div class="spoiler_text"><pre><code class="plaintext hljs">void SRAM_Init (void) { EBC_InitTypeDef EBC_InitStruct = { 0 }; EBC_MemRegionInitTypeDef EBC_MemRegionInitStruct = { 0 }; PORT_InitTypeDef initStruct = { 0 }; RST_CLK_PCLKcmd (RST_CLK_PCLK_EBC, ENABLE); PORT_StructInit (&amp;initStruct); //--------------------------------------------// // DATA PA0..PA15 (D0..D15) // //--------------------------------------------// initStruct.PORT_MODE = PORT_MODE_DIGITAL; initStruct.PORT_PD_SHM = PORT_PD_SHM_ON; initStruct.PORT_SPEED = PORT_SPEED_FAST; initStruct.PORT_FUNC = PORT_FUNC_MAIN; initStruct.PORT_Pin = PORT_Pin_All; PORT_Init (MDR_PORTA, &amp;initStruct); //--------------------------------------------// // Address PF3-PF15 (A0..A12), A0 - not used. // //--------------------------------------------// initStruct.PORT_FUNC = PORT_FUNC_ALTER; initStruct.PORT_Pin = PORT_Pin_4 | PORT_Pin_5 | PORT_Pin_6 | PORT_Pin_7 | PORT_Pin_8 | PORT_Pin_9 | PORT_Pin_10 | PORT_Pin_11 | PORT_Pin_12 | PORT_Pin_13 | PORT_Pin_14 | PORT_Pin_15; PORT_Init (MDR_PORTF, &amp;initStruct); //--------------------------------------------// // Address PD3..PD0 (A13..A16) // //--------------------------------------------// initStruct.PORT_FUNC = PORT_FUNC_OVERRID; initStruct.PORT_Pin = PORT_Pin_0 | PORT_Pin_1 | PORT_Pin_2 | PORT_Pin_3; PORT_Init (MDR_PORTD, &amp;initStruct); //--------------------------------------------// // Address PE3, PE4 (A17, A18) // //--------------------------------------------// initStruct.PORT_FUNC = PORT_FUNC_ALTER; initStruct.PORT_Pin = PORT_Pin_3 | PORT_Pin_4; PORT_Init (MDR_PORTE, &amp;initStruct); //--------------------------------------------// // Control PC0,PC1 (nWE,nOE) // //--------------------------------------------// initStruct.PORT_FUNC = PORT_FUNC_MAIN; initStruct.PORT_Pin = PORT_Pin_0 | PORT_Pin_1; PORT_Init (MDR_PORTC, &amp;initStruct); //--------------------------------------------// // Control PC2 (nCE) // //--------------------------------------------// initStruct.PORT_PD = PORT_PD_DRIVER; initStruct.PORT_OE = PORT_OE_OUT; initStruct.PORT_FUNC = PORT_FUNC_PORT; initStruct.PORT_Pin = MDB_SRAM_CE; PORT_Init (MDR_PORTC, &amp;initStruct); //--------------------------------------------// // Initialize EBC controler // //--------------------------------------------// EBC_DeInit(); EBC_StructInit(&amp;EBC_InitStruct); EBC_InitStruct.EBC_Mode = EBC_MODE_RAM; EBC_InitStruct.EBC_WaitState = EBC_WAIT_STATE_3HCLK; EBC_InitStruct.EBC_DataAlignment = EBC_EBC_DATA_ALIGNMENT_16; EBC_Init(&amp;EBC_InitStruct); EBC_MemRegionStructInit(&amp;EBC_MemRegionInitStruct); EBC_MemRegionInitStruct.WS_Active = 2; EBC_MemRegionInitStruct.WS_Setup = EBC_WS_SETUP_CYCLE_1HCLK; EBC_MemRegionInitStruct.WS_Hold = EBC_WS_HOLD_CYCLE_1HCLK; EBC_MemRegionInitStruct.Enable_Tune = ENABLE; EBC_MemRegionInit (&amp;EBC_MemRegionInitStruct, EBC_MEM_REGION_60000000); EBC_MemRegionCMD(EBC_MEM_REGION_60000000, ENABLE); // Turn ON RAM (nCE) PORT_ResetBits (MDR_PORTC, MDB_SRAM_CE); }</code> </pre> </div></div><br>  Le microcontr√¥leur du bo√Ætier LQFP-144 et la m√©moire du bo√Ætier TSOP-44 ont de nombreuses broches connect√©es et occupent beaucoup d'espace sur la carte de circuit imprim√©.  Ayant une exp√©rience dans la r√©solution de probl√®mes d'optimisation dans le domaine de l'√©conomie, il √©tait √©vident pour moi qu'il √©tait n√©cessaire de placer ces microcircuits sur la carte en premier lieu.  Dans diverses sources, j'ai vu des √©loges pour <a href="https://www.eremex.ru/products/delta-design/topor/" rel="nofollow">TopoR CAD (Topological Router)</a> .  J'ai t√©l√©charg√© la version d'essai et j'ai pu exporter mon projet depuis Eagle CAD uniquement lorsque j'ai supprim√© presque tous les composants.  Malheureusement, m√™me 10 √©l√©ments du programme TopoR ne m'ont pas aid√© √† placer sur le tableau.  Tout d'abord, tous les composants ont √©t√© plac√©s dans un coin, puis plac√©s le long du bord.  Cette option ne m'a pas satisfait, et pendant longtemps j'ai trac√© la carte en mode manuel dans l'environnement de CAO Eagle familier. <br><br>  Un √©l√©ment important de la carte de circuit imprim√© est la s√©rigraphie.  La carte de d√©bogage doit non seulement avoir des signatures pour les composants √©lectroniques, mais tous les connecteurs doivent √™tre sign√©s.  Au dos de la carte, j'ai plac√© des tableaux de m√©mo avec les fonctions des ports du contr√¥leur (principal, alternatif, red√©fini, r√©el).  J'ai command√© la fabrication de circuits imprim√©s en Chine dans le bureau bien connu de PCBWay.  Je ne louerai pas, car la qualit√© est bonne.  Ils peuvent faire mieux, avec moins de tol√©rances, mais <a href="https://www.pcbway.com/HighQualityOrderOnline.aspx" rel="nofollow">moyennant des frais</a> . <br><br><img src="https://habrastorage.org/webt/8q/gh/2w/8qgh2wsaofz5p2lat7gcoqc4km4.jpeg"><br>  <i>Cartes de circuits imprim√©s manufactur√©s MDB1986, (c) Photo par l'auteur</i> <br><br>  J'ai d√ª souder les composants ¬´sur mon genou¬ª avec un fer √† souder de 40 watts et une soudure POS-61, car je la soudais rarement, 1 √† 2 fois par an, et la p√¢te √† souder √©tait s√®che.  J'ai d√ª changer le contr√¥leur chinois CS32F103 en STM32F103 d'origine, puis remplacer la m√©moire.  En g√©n√©ral, maintenant le r√©sultat me convient parfaitement, m√™me si je n'ai pas encore v√©rifi√© le fonctionnement de RS-232 et CAN. <br><br><img src="https://habrastorage.org/webt/-h/il/8v/-hil8vgd1228zqjk7ig090eurpq.jpeg"><br>  <i>Conseil de d√©bogage MDB1986 au travail - brille et chauffe, (c) Photo de</i> <br><br>  Vous pouvez trouver suffisamment de <a href="https://edu.milandr.ru/library/" rel="nofollow">mat√©riel de formation sur</a> le site Web de Milander <a href="https://edu.milandr.ru/library/" rel="nofollow">pour √©tudier</a> les contr√¥leurs de la s√©rie 1986BE9 (noyau Cortex-M3), mais je ne vois rien pour le microcontr√¥leur K1986BE1QI (avia).  Apr√®s avoir examin√© les documents publi√©s l√†-bas, les manuels et les travaux de laboratoire pour les universit√©s, je suis heureux que le personnel soit form√© √† travers le pays pour travailler avec des contr√¥leurs russes.  La plupart des supports de formation sont pr√©par√©s pour fonctionner avec les ports d'E / S, les minuteries, les ADC, les DAC, SPI, UART.  Diff√©rents environnements de d√©veloppement IDE sont utilis√©s (Keil, IAR, CodeMaster).  Quelque part ils programment en utilisant les registres CMSIS, et quelque part ils utilisent la biblioth√®que MDR.  Il est n√©cessaire de mentionner la ressource <a href="https://startmilandr.ru/" rel="nofollow">Start Milandr</a> , qui contient de nombreux articles de programmeurs pratiques.  Et, bien s√ªr, il ne faut pas oublier <a href="https://forum.milandr.ru/" rel="nofollow">le forum Milander</a> . <br><br><div class="spoiler">  <b class="spoiler_title">La pens√©e de Milander</b> <div class="spoiler_text">  La micro√©lectronique se d√©veloppe en Russie et Milander joue un r√¥le de premier plan dans ce processus.  Il existe de nouveaux microcontr√¥leurs int√©ressants, par exemple, 198681 et "Power" avec les interfaces SpaceWire et MKIO (les m√™mes qu'en 1986BE1 et, √©ventuellement, avec les m√™mes probl√®mes), etc.  Mais les √©tudiants ordinaires, les enseignants et les ing√©nieurs civils pour acheter de telles puces ne sont pas r√©alistes.  Ainsi, la communaut√© des ing√©nieurs ne sera pas en mesure d'identifier rapidement les erreurs et les probl√®mes de cette puce.  Il me semble qu'au d√©but, il est n√©cessaire de produire des microcircuits dans un bo√Ætier en plastique, de le distribuer √† toutes les parties int√©ress√©es, et seulement apr√®s des tests (approbation latine - approbation, reconnaissance), les sp√©cialistes peuvent pr√©parer un audit dans un bo√Ætier en m√©tal-c√©ramique avec protection contre tous les facteurs terribles.  J'esp√®re que dans un avenir proche, nous serons tous satisfaits des nouveaux projets annonc√©s lors des expositions. </div></div><br>  Toute personne d√©velopp√©e par moi, le tableau de d√©bogage, peut r√©p√©ter, modifier et utiliser dans le processus √©ducatif.  Tout d'abord, je me suis fait une planche, mais √ßa s'est tellement bien pass√© que <a href="https://github.com/makbit/MDB1986" rel="nofollow">j'ai d√©cid√© de la partager avec tout le monde</a> . <br><br>  K1986BE1QI (avia) est un contr√¥leur tr√®s int√©ressant avec des interfaces uniques qui peuvent √™tre utilis√©es dans les universit√©s pour √©duquer les √©tudiants.  Je pense qu'apr√®s avoir corrig√© les erreurs d√©tect√©es dans le contr√¥leur et r√©ussi les tests de certification, le contr√¥leur volera dans le sens litt√©ral du terme! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr482716/">https://habr.com/ru/post/fr482716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr482704/index.html">Synchronisation du cache Redis pour le service Go</a></li>
<li><a href="../fr482706/index.html">Recommandations pour la mise en ≈ìuvre de la comptabilit√© parall√®le RAS + IFRS sur la plateforme 1C</a></li>
<li><a href="../fr482708/index.html">Une caract√©ristique de la culture d'entreprise n√©cessaire au bien-√™tre de la base de code</a></li>
<li><a href="../fr482712/index.html">Antiquit√©s: Sony MZ-1 ou l'histoire d'un prototype mis en production</a></li>
<li><a href="../fr482714/index.html">La colonne radio Internet la plus simple "Kodi" ou le sauvetage de la brique "Raspberry"</a></li>
<li><a href="../fr482718/index.html">Pyramide invers√©e comme fin de votre projet</a></li>
<li><a href="../fr482722/index.html">Histoire fantastique "Projet C. Vanit√© des vanit√©s" (10 min.)</a></li>
<li><a href="../fr482726/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 328 (23 - 29 d√©cembre)</a></li>
<li><a href="../fr482728/index.html">Jpeg. Algorithme de compression</a></li>
<li><a href="../fr482730/index.html">Sondage des F√™tes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>